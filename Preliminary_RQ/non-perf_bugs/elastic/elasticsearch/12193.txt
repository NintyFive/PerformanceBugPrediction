{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12193","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12193/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12193/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12193/events","html_url":"https://github.com/elastic/elasticsearch/issues/12193","id":94506498,"node_id":"MDU6SXNzdWU5NDUwNjQ5OA==","number":12193,"title":"NoClassDefFoundError w/shaded 2.0.0.beta1 jar","user":{"login":"aleph-zero","id":452273,"node_id":"MDQ6VXNlcjQ1MjI3Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/452273?v=4","gravatar_id":"","url":"https://api.github.com/users/aleph-zero","html_url":"https://github.com/aleph-zero","followers_url":"https://api.github.com/users/aleph-zero/followers","following_url":"https://api.github.com/users/aleph-zero/following{/other_user}","gists_url":"https://api.github.com/users/aleph-zero/gists{/gist_id}","starred_url":"https://api.github.com/users/aleph-zero/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aleph-zero/subscriptions","organizations_url":"https://api.github.com/users/aleph-zero/orgs","repos_url":"https://api.github.com/users/aleph-zero/repos","events_url":"https://api.github.com/users/aleph-zero/events{/privacy}","received_events_url":"https://api.github.com/users/aleph-zero/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"aleph-zero","id":452273,"node_id":"MDQ6VXNlcjQ1MjI3Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/452273?v=4","gravatar_id":"","url":"https://api.github.com/users/aleph-zero","html_url":"https://github.com/aleph-zero","followers_url":"https://api.github.com/users/aleph-zero/followers","following_url":"https://api.github.com/users/aleph-zero/following{/other_user}","gists_url":"https://api.github.com/users/aleph-zero/gists{/gist_id}","starred_url":"https://api.github.com/users/aleph-zero/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aleph-zero/subscriptions","organizations_url":"https://api.github.com/users/aleph-zero/orgs","repos_url":"https://api.github.com/users/aleph-zero/repos","events_url":"https://api.github.com/users/aleph-zero/events{/privacy}","received_events_url":"https://api.github.com/users/aleph-zero/received_events","type":"User","site_admin":false},"assignees":[{"login":"aleph-zero","id":452273,"node_id":"MDQ6VXNlcjQ1MjI3Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/452273?v=4","gravatar_id":"","url":"https://api.github.com/users/aleph-zero","html_url":"https://github.com/aleph-zero","followers_url":"https://api.github.com/users/aleph-zero/followers","following_url":"https://api.github.com/users/aleph-zero/following{/other_user}","gists_url":"https://api.github.com/users/aleph-zero/gists{/gist_id}","starred_url":"https://api.github.com/users/aleph-zero/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aleph-zero/subscriptions","organizations_url":"https://api.github.com/users/aleph-zero/orgs","repos_url":"https://api.github.com/users/aleph-zero/repos","events_url":"https://api.github.com/users/aleph-zero/events{/privacy}","received_events_url":"https://api.github.com/users/aleph-zero/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2015-07-11T20:47:01Z","updated_at":"2020-11-11T22:00:05Z","closed_at":"2015-07-12T23:49:01Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I am consistently getting the following stack trace when attempting to create a node from a simple application:\n\n```\n--- Start Example ---\nJul 11, 2015 1:37:24 PM org.elasticsearch.node.Node <init>\nINFO: [The Blank] version[2.0.0.beta1-SNAPSHOT], pid[18006], build[0b27ded/2015-07-11T20:22:54Z]\nJul 11, 2015 1:37:24 PM org.elasticsearch.node.Node <init>\nINFO: [The Blank] initializing ...\nJul 11, 2015 1:37:24 PM org.elasticsearch.plugins.PluginsService <init>\nINFO: [The Blank] loaded [], sites []\nJul 11, 2015 1:37:24 PM org.elasticsearch.env.NodeEnvironment maybeLogPathDetails\nINFO: [The Blank] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable_space [79.6gb], net total_space [464.7gb], spins? [unknown], types [hfs]\nTests run: 1, Failures: 0, Errors: 1, Skipped: 0, Time elapsed: 0.337 sec <<< FAILURE!\nx(org.primer.stupid.TestFoo)  Time elapsed: 0.301 sec  <<< ERROR!\njava.lang.NoClassDefFoundError: org/elasticsearch/common/util/concurrent/jsr166e/LongAdder\n    at org.elasticsearch.common.metrics.CounterMetric.<init>(CounterMetric.java:28)\n    at org.elasticsearch.common.util.concurrent.EsAbortPolicy.<init>(EsAbortPolicy.java:31)\n    at org.elasticsearch.common.util.concurrent.EsExecutors.newCached(EsExecutors.java:70)\n    at org.elasticsearch.threadpool.ThreadPool.rebuild(ThreadPool.java:339)\n    at org.elasticsearch.threadpool.ThreadPool.build(ThreadPool.java:296)\n    at org.elasticsearch.threadpool.ThreadPool.<init>(ThreadPool.java:134)\n    at org.elasticsearch.node.Node.<init>(Node.java:159)\n    at org.elasticsearch.node.NodeBuilder.build(NodeBuilder.java:157)\n    at org.elasticsearch.node.NodeBuilder.node(NodeBuilder.java:164)\n    at org.primer.stupid.TestFoo.x(TestFoo.java:50)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:483)\n    at org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\n    at org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\n    at org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\n    at org.junit.internal.runners.statements.InvokeMethod.evaluate(InvokeMethod.java:17)\n    at org.junit.runners.ParentRunner.runLeaf(ParentRunner.java:325)\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:78)\n    at org.junit.runners.BlockJUnit4ClassRunner.runChild(BlockJUnit4ClassRunner.java:57)\n    at org.junit.runners.ParentRunner$3.run(ParentRunner.java:290)\n    at org.junit.runners.ParentRunner$1.schedule(ParentRunner.java:71)\n    at org.junit.runners.ParentRunner.runChildren(ParentRunner.java:288)\n    at org.junit.runners.ParentRunner.access$000(ParentRunner.java:58)\n    at org.junit.runners.ParentRunner$2.evaluate(ParentRunner.java:268)\n    at org.junit.runners.ParentRunner.run(ParentRunner.java:363)\n    at org.apache.maven.surefire.junit4.JUnit4Provider.execute(JUnit4Provider.java:252)\n    at org.apache.maven.surefire.junit4.JUnit4Provider.executeTestSet(JUnit4Provider.java:141)\n    at org.apache.maven.surefire.junit4.JUnit4Provider.invoke(JUnit4Provider.java:112)\n    at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:483)\n    at org.apache.maven.surefire.util.ReflectionUtils.invokeMethodWithArray(ReflectionUtils.java:189)\n    at org.apache.maven.surefire.booter.ProviderFactory$ProviderProxy.invoke(ProviderFactory.java:165)\n    at org.apache.maven.surefire.booter.ProviderFactory.invokeProvider(ProviderFactory.java:85)\n    at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:115)\n    at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:75)\nCaused by: java.lang.ClassNotFoundException: org.elasticsearch.common.util.concurrent.jsr166e.LongAdder\n    at java.net.URLClassLoader$1.run(URLClassLoader.java:372)\n    at java.net.URLClassLoader$1.run(URLClassLoader.java:361)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:360)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)\n    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:308)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)\n    ... 39 more\n```\n\nNote that this _only_ happens when using the shaded jar. \n\nA simple test program to reproduce is:\n\n``` java\npublic class TestFoo {\n\n    @Test\n    public void x() throws Exception {\n\n        System.out.println(\"--- Start Example ---\");\n\n        File home = Files.createTempDir();\n        home.deleteOnExit();\n        Settings settings = Settings.builder()\n                .put(\"path.home\", home.getAbsolutePath()).build();\n        Node node = nodeBuilder().settings(settings).local(false).data(true).clusterName(\"test-cluster\").node();\n        node.close();\n\n        System.out.println(\"--- Finished ---\");\n    }\n}\n```\n\nFrom what I can tell, the jsr166e classes are not getting shaded to the correct location. If I look at the shaded jar I can see the actual location of the jsr166e classes:\n\n```\n[ gnocchi 2.0.0.beta1-SNAPSHOT ] [ 01:42:39 ] > jar tvf elasticsearch-2.0.0.beta1-SNAPSHOT-shaded.jar | grep LongAdder\n  3422 Sat Jul 11 13:23:58 PDT 2015 org/elasticsearch/common/cache/LongAdder.class\n```\n\nHowever, the pom.xml for core has this:\n\n``` xml\n<relocation>\n    <pattern>com.twitter.jsr166e</pattern>\n    <shadedPattern>org.elasticsearch.common.util.concurrent.jsr166e</shadedPattern>\n</relocation>\n```\n","closed_by":{"login":"aleph-zero","id":452273,"node_id":"MDQ6VXNlcjQ1MjI3Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/452273?v=4","gravatar_id":"","url":"https://api.github.com/users/aleph-zero","html_url":"https://github.com/aleph-zero","followers_url":"https://api.github.com/users/aleph-zero/followers","following_url":"https://api.github.com/users/aleph-zero/following{/other_user}","gists_url":"https://api.github.com/users/aleph-zero/gists{/gist_id}","starred_url":"https://api.github.com/users/aleph-zero/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aleph-zero/subscriptions","organizations_url":"https://api.github.com/users/aleph-zero/orgs","repos_url":"https://api.github.com/users/aleph-zero/repos","events_url":"https://api.github.com/users/aleph-zero/events{/privacy}","received_events_url":"https://api.github.com/users/aleph-zero/received_events","type":"User","site_admin":false},"performed_via_github_app":null}