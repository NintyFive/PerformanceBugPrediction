{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27841/events","html_url":"https://github.com/elastic/elasticsearch/issues/27841","id":282442470,"node_id":"MDU6SXNzdWUyODI0NDI0NzA=","number":27841,"title":"Anonymous filters aggregation returns a named result when filters contain a bool query","user":{"login":"TrustNoOne","id":1575319,"node_id":"MDQ6VXNlcjE1NzUzMTk=","avatar_url":"https://avatars3.githubusercontent.com/u/1575319?v=4","gravatar_id":"","url":"https://api.github.com/users/TrustNoOne","html_url":"https://github.com/TrustNoOne","followers_url":"https://api.github.com/users/TrustNoOne/followers","following_url":"https://api.github.com/users/TrustNoOne/following{/other_user}","gists_url":"https://api.github.com/users/TrustNoOne/gists{/gist_id}","starred_url":"https://api.github.com/users/TrustNoOne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrustNoOne/subscriptions","organizations_url":"https://api.github.com/users/TrustNoOne/orgs","repos_url":"https://api.github.com/users/TrustNoOne/repos","events_url":"https://api.github.com/users/TrustNoOne/events{/privacy}","received_events_url":"https://api.github.com/users/TrustNoOne/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":654494999,"node_id":"MDU6TGFiZWw2NTQ0OTQ5OTk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.1.0","name":"v6.1.0","color":"dddddd","default":false,"description":null},{"id":758151235,"node_id":"MDU6TGFiZWw3NTgxNTEyMzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.2.0","name":"v6.2.0","color":"DDDDDD","default":false,"description":null},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2017-12-15T14:23:36Z","updated_at":"2019-02-07T08:40:37Z","closed_at":"2017-12-19T18:56:13Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.1.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** : 1.8.0_152\r\n\r\n**OS version** : Mac OS X 10.13.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAnonymous filters aggregation returns a named result using integers as keys when a bool query is specified in the filters. The result should contained an array of buckets when using anonymous filters.\r\n\r\n**Steps to reproduce**:\r\nThis query\r\n```json\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test\": {\r\n      \"filters\": {\r\n        \"filters\": [ { \"match_all\": {} } ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\ncorrectly returns an anonymous array of buckets:\r\n```json\r\n{\r\n    \"took\": 10,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 207,\r\n        \"successful\": 207,\r\n        \"skipped\": 0,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 1942637,\r\n        \"max_score\": 0,\r\n        \"hits\": []\r\n    },\r\n    \"aggregations\": {\r\n        \"test\": {\r\n            \"buckets\": [\r\n                {\r\n                    \"doc_count\": 1942637\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nWhile this query:\r\n```\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test\": {\r\n      \"filters\": {\r\n        \"filters\": [ { \"bool\": { } } ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nreturns a named result using array indexes as keys:\r\n\r\n```json\r\n{\r\n    \"took\": 7,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 207,\r\n        \"successful\": 207,\r\n        \"skipped\": 0,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 1942637,\r\n        \"max_score\": 0,\r\n        \"hits\": []\r\n    },\r\n    \"aggregations\": {\r\n        \"test\": {\r\n            \"buckets\": {\r\n                \"0\": {\r\n                    \"doc_count\": 1942637\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n``` \r\n\r\nIn general, if a bool query is specified in the filters, I get a map having \"0\", \"1\", ... , \"n\" as keys instead of an array. \r\nThe content of the bool query doesn't seem to matter, as longs as there's at least one bool query in the array of filters, the result is wrong. I used an empty bool as an example for the sake of shortness\r\n\r\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}