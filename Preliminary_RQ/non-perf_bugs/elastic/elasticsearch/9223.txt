{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9223","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9223/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9223/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9223/events","html_url":"https://github.com/elastic/elasticsearch/issues/9223","id":53889735,"node_id":"MDU6SXNzdWU1Mzg4OTczNQ==","number":9223,"title":"Indices using _timestamp are being dropped on cluster restart","user":{"login":"meash-nrel","id":7649432,"node_id":"MDQ6VXNlcjc2NDk0MzI=","avatar_url":"https://avatars1.githubusercontent.com/u/7649432?v=4","gravatar_id":"","url":"https://api.github.com/users/meash-nrel","html_url":"https://github.com/meash-nrel","followers_url":"https://api.github.com/users/meash-nrel/followers","following_url":"https://api.github.com/users/meash-nrel/following{/other_user}","gists_url":"https://api.github.com/users/meash-nrel/gists{/gist_id}","starred_url":"https://api.github.com/users/meash-nrel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/meash-nrel/subscriptions","organizations_url":"https://api.github.com/users/meash-nrel/orgs","repos_url":"https://api.github.com/users/meash-nrel/repos","events_url":"https://api.github.com/users/meash-nrel/events{/privacy}","received_events_url":"https://api.github.com/users/meash-nrel/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2015-01-09T17:02:08Z","updated_at":"2015-01-13T09:04:58Z","closed_at":"2015-01-13T09:04:58Z","author_association":"NONE","active_lock_reason":null,"body":"**EDIT: turns out templates aren't the issue - it's _timestamp -- see later comments.**\n\nOn my 3 node ES 1.4.1 cluster, I had bulk imported data into several hundred per-day indexes, whose type mappings were created from templates.  These indexes were all missing upon restarting the cluster.  Only one index remained - one that I had created manually (not from a template).  I lost a significant amount of data that was bulk imported over last 2 weeks.\n\nI verified that when indexes are created in advance or on-the-fly from a template, they behave normally and are persisted to disk -- but once the cluster is restarted, **they no longer appear in ES**.  Underlying files (Lucene shards etc) are all still there -- but ES refuses to see them.\n\nBottom line -\n- Creating an index from a template (either on-the-fly or in advance), that index will permanently disappear upon restart.  \n- Underlying files are all still there.  ES refuses to load the index.  Any further loading into that same index will clear the existing files and start the index anew.\n\nI installed ES 1.4.2 locally on my Mac and replicated the issue on a single node cluster, using all default settings.\n- First create a template test-type, using wildcard it to allow it to affect multiple indices (any index that starts with \"test-\" with a dash).\n\n```\nPUT http://localhost:9200/_template/test-type\n{\n    \"template\" : \"test-*\",\n    \"order\" : 0,\n    \"settings\" : {\n        \"number_of_shards\" : 4,\n        \"number_of_replicas\" : 0, \n        \"refresh_interval\": \"1s\"\n    },\n    \"mappings\" : {\n        \"test-type\": {\n                \"_timestamp\" : {\n                    \"enabled\" : true,\n                    \"store\": true,\n                    \"index\": \"not_analyzed\",\n                    \"format\" : \"date_time\",\n                    \"default\": null, \n                    \"path\" : \"timestamp\"\n                },\n\n                \"_all\": {\n                    \"enabled\": false\n                },\n                \"_source\": {\n                    \"enabled\": false\n                },\n                \"properties\": {\n                    \"node\": {\n                        \"type\": \"string\",\n                        \"store\": true,\n                        \"index\": \"not_analyzed\"\n                    },\n                    \"power\": {\n                        \"type\": \"integer\",\n                        \"store\": true,\n                        \"index\": \"not_analyzed\"\n                    }\n                }\n            }\n    }\n}\n```\n- I created an index in advance, from my test-type template (index begins \"with test-\").\n\n```\nPUT http://localhost:9200/test-template\n{}\n```\n- Insert a document into index created in advance, plus create 2 new indices on the fly (one from template, one not).\n\n```\nPUT http://localhost:9200/test-template/test-type/1\n {\n    \"timestamp\": 1420748020000,\n    \"node\": \"n1111\",\n    \"power\": 200\n}\n\nPUT http://localhost:9200//test-template-onfly/test-type/1\n {\n    \"timestamp\": 1420748020000,\n    \"node\": \"n1111\",\n    \"power\": 200\n}\n\nPUT http://localhost:9200//test_notemplate_onfly/test-type/1\n {\n    \"timestamp\": 1420748020000,\n    \"node\": \"n1111\",\n    \"power\": 200\n}\n```\n- List indexes\n\n```\nGET http://localhost:9200/_cat/indices\n\nyellow open test_notemplate_onfly 5 1 1 0 3.4kb 3.4kb \ngreen  open test-template-onfly   4 0 1 0 2.9kb 2.9kb \ngreen  open test-template         4 0 1 0 2.9kb 2.9kb \n```\n\n(test_notemplate_onfly shows as yellow since by default replication=1, but this is a single node cluster)\n- Shut down cluster\n\n```\nPOST http://localhost:9200/_cluster/nodes/_all/_shutdown\n```\n- Restart cluster and view indexes.\n\n```\nGET http://localhost:9200/_cat/indices\n\nyellow open test_notemplate_onfly 5 1 1 0 3.4kb 3.4kb \n```\n\nWhere'd the indices go?  Files are all still there - and there is nothing out of the ordinary in the log file when starting ES back up that would indicate failure to load those indexes, etc.\n\nBeyond fixing the issue, would love to know how to get my existing couple hundred ES indexes that still exist on disk back into ES's index metadata, if you have any way to get ES to re-recognize an index it already created but dropped.   Really unfortunate to hit this bug after several weeks of bulk importing, only to find them all magically gone upon restarting cluster.\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}