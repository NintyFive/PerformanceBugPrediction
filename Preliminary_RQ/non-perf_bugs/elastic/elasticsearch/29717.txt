{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29717","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29717/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29717/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29717/events","html_url":"https://github.com/elastic/elasticsearch/issues/29717","id":317447170,"node_id":"MDU6SXNzdWUzMTc0NDcxNzA=","number":29717,"title":"Use AbstractLifecycleComponent in xpack services","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-02-10T17:38:52Z","updated_at":"2018-07-27T13:46:14Z","closed_at":"2018-07-27T13:46:14Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @jaymode:*\n\nIn LINK REDACTED @s1monw asked why we do not use `AbstractLifecycleComponent` and roll our own lifecycle. I did not recall the exact reasoning but when I went to cutover the classes to use `AbstractLifecycleComponent`, I began to see the issues.\n\nThe first issue is that these services must wait for specific conditions to be met until they are started. For example, the index audit trail does the following:\n- ensure there is no `STATE_NOT_RECOVERED_BLOCK`\n- ensure the audit log template exists (if not the master)\n- ensure the mappings on an index we index into are up to date if it already exists (if not the master)\n- ensure all primary shards are active if the index exists\n\nIn order to add these checks in, the `start()` method must be overridden and the class must have access to the cluster state. Additionally, we need a method to trigger the check; right now the checks are executed as part of a `ClusterStateListener`. Because we use a cluster state listener, we should not block the cluster update thread when starting so the code submits a runnable to the generic threadpool; this means that there could be concurrent attempts to start the service unless we track starting of the service being in progress etc.\n\nOverall this work began to grow in scope (at least in my mind), so I decided that we should open up a issue and figure out the best way to address this.\n\n\n","closed_by":{"login":"tomcallahan","id":15988488,"node_id":"MDQ6VXNlcjE1OTg4NDg4","avatar_url":"https://avatars1.githubusercontent.com/u/15988488?v=4","gravatar_id":"","url":"https://api.github.com/users/tomcallahan","html_url":"https://github.com/tomcallahan","followers_url":"https://api.github.com/users/tomcallahan/followers","following_url":"https://api.github.com/users/tomcallahan/following{/other_user}","gists_url":"https://api.github.com/users/tomcallahan/gists{/gist_id}","starred_url":"https://api.github.com/users/tomcallahan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomcallahan/subscriptions","organizations_url":"https://api.github.com/users/tomcallahan/orgs","repos_url":"https://api.github.com/users/tomcallahan/repos","events_url":"https://api.github.com/users/tomcallahan/events{/privacy}","received_events_url":"https://api.github.com/users/tomcallahan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}