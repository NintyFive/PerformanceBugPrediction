{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26585","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26585/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26585/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26585/events","html_url":"https://github.com/elastic/elasticsearch/issues/26585","id":256828434,"node_id":"MDU6SXNzdWUyNTY4Mjg0MzQ=","number":26585,"title":"Bug: Suggest request for a CustomSuggester fail with \"ReduceSearchPhaseException\" in Multi-DataNode scenarios.","user":{"login":"updixit","id":26333155,"node_id":"MDQ6VXNlcjI2MzMzMTU1","avatar_url":"https://avatars2.githubusercontent.com/u/26333155?v=4","gravatar_id":"","url":"https://api.github.com/users/updixit","html_url":"https://github.com/updixit","followers_url":"https://api.github.com/users/updixit/followers","following_url":"https://api.github.com/users/updixit/following{/other_user}","gists_url":"https://api.github.com/users/updixit/gists{/gist_id}","starred_url":"https://api.github.com/users/updixit/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/updixit/subscriptions","organizations_url":"https://api.github.com/users/updixit/orgs","repos_url":"https://api.github.com/users/updixit/repos","events_url":"https://api.github.com/users/updixit/events{/privacy}","received_events_url":"https://api.github.com/users/updixit/received_events","type":"User","site_admin":false},"labels":[{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"assignees":[{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2017-09-11T20:16:05Z","updated_at":"2018-08-07T20:38:43Z","closed_at":"2018-08-07T20:38:43Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version (**bin/elasticsearch --version): 1.7 and above\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (java -version): Jdk 1.8\r\n\r\n**OS version** (uname -a if on a Unix-like system): Windows\r\n\r\n**Description of the problem including expected versus actual behavior:**\r\nCalling 'suggest' requests for a CustomSuggester works as expected when all shards are present on a single data Node. If there are >1 Data Node, the suggest fails with the following error in the reduce phase.\r\n_\"Can't merge suggest result, this might be caused by suggest calls across multiple indices with different analysis chains. Suggest entries have different sizes actual [0] expected [1]);\"_\r\n\r\n**Reason:**\r\nDefine a CustomSuggester which returns suggestions of 'CustomSuggestions' type(derived from Suggest.Suggestions class).\r\nIn the 'SearcPhaseController.java' when the suggest results from different shards are merged, the results from the coordinating DataNode are of type 'CustomSuggestion' but the results from all other data nodes are **down-casted** to Suggest.Suggestion type. This causes the reduce phase to fail.\r\n\r\n**Steps to reproduce:**\r\n1. Define CustomSuggestion class( extends Suggestion class). The 'Option' of the CustomSuggestion.Entry should have an additional attribute ( This can be any attribute. string, int float. eg: int 'randomAttribute'. Let's say this has a constant value =1).\r\n2. Register the Custom Suggester in the Suggest Module.\r\n3. Create a cluster with a single Data node.\r\n      Issue request against the 'CustomSuggester'. All request succeed. The Options in the returned   response contain the 'randomAttribute' as well.\r\n4. Create a cluster with a >1 Data node.\r\n      Issue request against the 'CustomSuggester'. Request fail with ReduceSearchPhaseException, while merging the results in the co-ordinating node.\r\n5. On Debugging, you will notice that some results are of type \"CustomSuggestion\" and some are of type \"Suggestion\".\r\n\r\n**Questions**\r\nWhy does this down casting happen?\r\nHow can I register the suggester so that the response is not downcasted to the Base Suggestion class?\r\n\r\n**Provide logs (if relevant):**\r\n2017-09-11 10:14:13,318][WARN ][transport.netty ] [localhost-1] Message not fully read (response) for [96] handler org.elasticsearch.search.action.SearchServiceTransportAction$6@35c82c9d, error [false], resetting\r\n[2017-09-11 10:14:13,319][WARN ][transport.netty ] [localhost-1] Message not fully read (response) for [93] handler org.elasticsearch.search.action.SearchServiceTransportAction$6@5bcb6480, error [false], resetting\r\n[2017-09-11 10:14:13,319][DEBUG][action.search.type ] [localhost-1] failed to reduce search\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: Failed to execute phase [fetch], [reduce]\r\nat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.onFailure(TransportSearchQueryThenFetchAction.java:159)\r\nat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:41)\r\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\nat java.lang.Thread.run(Thread.java:745)\r\nCaused by: org.elasticsearch.ElasticsearchIllegalStateException: Can't merge suggest result, this might be caused by suggest calls across multiple indices with different analysis chains. Suggest entries have different sizes actual [0] expected [1]\r\nat org.elasticsearch.search.suggest.Suggest$Suggestion.reduce(Suggest.java:256)\r\nat org.elasticsearch.search.suggest.Suggest.reduce(Suggest.java:185)\r\nat org.elasticsearch.search.controller.SearchPhaseController.merge(SearchPhaseController.java:396)\r\nat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.doRun(TransportSearchQueryThenFetchAction.java:147)\r\nat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\r\n... 3 more","closed_by":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"performed_via_github_app":null}