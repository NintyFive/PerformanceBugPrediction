[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/503720574","html_url":"https://github.com/elastic/elasticsearch/issues/43392#issuecomment-503720574","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43392","id":503720574,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMzcyMDU3NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-19T19:47:42Z","updated_at":"2019-06-19T19:47:42Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/503963361","html_url":"https://github.com/elastic/elasticsearch/issues/43392#issuecomment-503963361","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43392","id":503963361,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMzk2MzM2MQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-20T09:59:23Z","updated_at":"2019-06-20T09:59:23Z","author_association":"CONTRIBUTOR","body":"The test is using `LongGCDisruption`, which suspends threads using `Thread.suspend()`. The nodes properly detect that `node_t1` is unavailable, but do not succeed in electing a new leader amongst themselves as they look to be unable to communicate with each other. It looks like pausing `node_t1` is blocking the event loop threads on the other nodes. @original-brownbear @tbrooks8 thoughts?\r\n\r\nRelevant log lines:\r\n\r\n```\r\n1> [2019-06-19T12:43:15,274][INFO ][o.e.d.StableMasterDisruptionIT] [testStaleMasterNotHijackingMajority] --> freezing node [node_t1]\r\n...\r\n1> [2019-06-19T12:43:22,698][WARN ][o.e.t.n.MockNioTransport ] [node_t0] Potentially blocked execution on network thread [elasticsearch[node_t0][transport_worker][T#2]] [1400 milliseconds]: \r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:533)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:285)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory$$Lambda$1656/0x0000000100731c40.run(Unknown Source)\r\n  1> java.base@11.0.3/java.security.AccessController.doPrivileged(Native Method)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.accept(ChannelFactory.java:223)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.acceptNioChannel(ChannelFactory.java:180)\r\n  1> app//org.elasticsearch.nio.ChannelFactory.acceptNioChannel(ChannelFactory.java:55)\r\n  1> app//org.elasticsearch.nio.ServerChannelContext.acceptChannels(ServerChannelContext.java:47)\r\n  1> app//org.elasticsearch.nio.EventHandler.acceptChannel(EventHandler.java:45)\r\n  1> app//org.elasticsearch.transport.nio.TestEventHandler.acceptChannel(TestEventHandler.java:51)\r\n  1> app//org.elasticsearch.nio.NioSelector.processKey(NioSelector.java:227)\r\n  1> app//org.elasticsearch.nio.NioSelector.singleLoop(NioSelector.java:172)\r\n  1> app//org.elasticsearch.nio.NioSelector.runLoop(NioSelector.java:129)\r\n  1> app//org.elasticsearch.nio.NioSelectorGroup$$Lambda$1589/0x00000001006f1840.run(Unknown Source)\r\n  1> java.base@11.0.3/java.lang.Thread.run(Thread.java:834)\r\n  1> [2019-06-19T12:43:22,947][WARN ][o.e.t.n.MockNioTransport ] [node_t2] Potentially blocked execution on network thread [elasticsearch[node_t2][transport_worker][T#2]] [1600 milliseconds]: \r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:533)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:285)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory$$Lambda$1656/0x0000000100731c40.run(Unknown Source)\r\n  1> java.base@11.0.3/java.security.AccessController.doPrivileged(Native Method)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.accept(ChannelFactory.java:223)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.acceptNioChannel(ChannelFactory.java:180)\r\n  1> app//org.elasticsearch.nio.ChannelFactory.acceptNioChannel(ChannelFactory.java:55)\r\n  1> app//org.elasticsearch.nio.ServerChannelContext.acceptChannels(ServerChannelContext.java:47)\r\n  1> app//org.elasticsearch.nio.EventHandler.acceptChannel(EventHandler.java:45)\r\n  1> app//org.elasticsearch.transport.nio.TestEventHandler.acceptChannel(TestEventHandler.java:51)\r\n  1> app//org.elasticsearch.nio.NioSelector.processKey(NioSelector.java:227)\r\n  1> app//org.elasticsearch.nio.NioSelector.singleLoop(NioSelector.java:172)\r\n  1> app//org.elasticsearch.nio.NioSelector.runLoop(NioSelector.java:129)\r\n  1> app//org.elasticsearch.nio.NioSelectorGroup$$Lambda$1589/0x00000001006f1840.run(Unknown Source)\r\n  1> java.base@11.0.3/java.lang.Thread.run(Thread.java:834)\r\n1> [2019-06-19T12:43:23,190][DEBUG][o.e.d.FileBasedSeedHostsProvider] [node_t0] seed addresses: [127.0.0.1:37605, 127.0.0.1:37675]\r\n  1> [2019-06-19T12:43:23,193][DEBUG][o.e.d.FileBasedSeedHostsProvider] [node_t2] seed addresses: [127.0.0.1:45615, 127.0.0.1:37605]\r\n  1> [2019-06-19T12:43:24,190][DEBUG][o.e.d.FileBasedSeedHostsProvider] [node_t0] seed addresses: [127.0.0.1:37605, 127.0.0.1:37675]\r\n  1> [2019-06-19T12:43:24,193][DEBUG][o.e.d.FileBasedSeedHostsProvider] [node_t2] seed addresses: [127.0.0.1:45615, 127.0.0.1:37605]\r\n  1> [2019-06-19T12:43:24,699][WARN ][o.e.t.n.MockNioTransport ] [node_t0] Potentially blocked execution on network thread [elasticsearch[node_t0][transport_worker][T#2]] [3445 milliseconds]: \r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:533)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:285)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory$$Lambda$1656/0x0000000100731c40.run(Unknown Source)\r\n  1> java.base@11.0.3/java.security.AccessController.doPrivileged(Native Method)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.accept(ChannelFactory.java:223)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.acceptNioChannel(ChannelFactory.java:180)\r\n  1> app//org.elasticsearch.nio.ChannelFactory.acceptNioChannel(ChannelFactory.java:55)\r\n  1> app//org.elasticsearch.nio.ServerChannelContext.acceptChannels(ServerChannelContext.java:47)\r\n  1> app//org.elasticsearch.nio.EventHandler.acceptChannel(EventHandler.java:45)\r\n  1> app//org.elasticsearch.transport.nio.TestEventHandler.acceptChannel(TestEventHandler.java:51)\r\n  1> app//org.elasticsearch.nio.NioSelector.processKey(NioSelector.java:227)\r\n  1> app//org.elasticsearch.nio.NioSelector.singleLoop(NioSelector.java:172)\r\n  1> app//org.elasticsearch.nio.NioSelector.runLoop(NioSelector.java:129)\r\n  1> app//org.elasticsearch.nio.NioSelectorGroup$$Lambda$1589/0x00000001006f1840.run(Unknown Source)\r\n  1> java.base@11.0.3/java.lang.Thread.run(Thread.java:834)\r\n  1> [2019-06-19T12:43:24,948][WARN ][o.e.t.n.MockNioTransport ] [node_t2] Potentially blocked execution on network thread [elasticsearch[node_t2][transport_worker][T#2]] [3601 milliseconds]: \r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept0(Native Method)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:533)\r\n  1> java.base@11.0.3/sun.nio.ch.ServerSocketChannelImpl.accept(ServerSocketChannelImpl.java:285)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory$$Lambda$1656/0x0000000100731c40.run(Unknown Source)\r\n  1> java.base@11.0.3/java.security.AccessController.doPrivileged(Native Method)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.accept(ChannelFactory.java:223)\r\n  1> app//org.elasticsearch.nio.ChannelFactory$RawChannelFactory.acceptNioChannel(ChannelFactory.java:180)\r\n  1> app//org.elasticsearch.nio.ChannelFactory.acceptNioChannel(ChannelFactory.java:55)\r\n  1> app//org.elasticsearch.nio.ServerChannelContext.acceptChannels(ServerChannelContext.java:47)\r\n  1> app//org.elasticsearch.nio.EventHandler.acceptChannel(EventHandler.java:45)\r\n  1> app//org.elasticsearch.transport.nio.TestEventHandler.acceptChannel(TestEventHandler.java:51)\r\n  1> app//org.elasticsearch.nio.NioSelector.processKey(NioSelector.java:227)\r\n  1> app//org.elasticsearch.nio.NioSelector.singleLoop(NioSelector.java:172)\r\n  1> app//org.elasticsearch.nio.NioSelector.runLoop(NioSelector.java:129)\r\n  1> app//org.elasticsearch.nio.NioSelectorGroup$$Lambda$1589/0x00000001006f1840.run(Unknown Source)\r\n  1> java.base@11.0.3/java.lang.Thread.run(Thread.java:834)\r\n  1> [2019-06-19T12:43:25,190][DEBUG][o.e.d.FileBasedSeedHostsProvider] [node_t0] seed addresses: [127.0.0.1:37605, 127.0.0.1:37675]\r\n  1> [2019-06-19T12:43:25,193][DEBUG][o.e.d.FileBasedSeedHostsProvider] [node_t2] seed addresses: [127.0.0.1:45615, 127.0.0.1:37605]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/503991274","html_url":"https://github.com/elastic/elasticsearch/issues/43392#issuecomment-503991274","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43392","id":503991274,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMzk5MTI3NA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-20T11:36:40Z","updated_at":"2019-06-20T11:36:40Z","author_association":"CONTRIBUTOR","body":"Relates https://github.com/elastic/elasticsearch/issues/43387","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504002642","html_url":"https://github.com/elastic/elasticsearch/issues/43392#issuecomment-504002642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43392","id":504002642,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDAwMjY0Mg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-06-20T12:16:04Z","updated_at":"2019-06-20T12:17:49Z","author_association":"MEMBER","body":"@ywelsch yea it certainly looks like suspending the node threads is to blame here most likely. It seems to me like that's the only action we take that could affect multiple selectors at once. I'll look into this shortly, if I remember correctly there were some issues with suspending threads and socket channels in JDK8.\r\nOne second thought: I'm not 100% sure that's true actually ... if you look at the log #43387 you can find the selector loop getting slower and slower until it finally blocks for at least 30s (then it gets interrupted by the test). The slower and slower there could be a coincidence, but it looks suspicious as well. Regardless, on it :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504015454","html_url":"https://github.com/elastic/elasticsearch/issues/43392#issuecomment-504015454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43392","id":504015454,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDAxNTQ1NA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-06-20T12:57:52Z","updated_at":"2019-06-20T12:57:52Z","author_association":"MEMBER","body":"I think the added logging of the stuck thread's state in #43424 should suffice to figure out if this is a result of the thread suspend call.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504945272","html_url":"https://github.com/elastic/elasticsearch/issues/43392#issuecomment-504945272","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43392","id":504945272,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDk0NTI3Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-24T10:02:26Z","updated_at":"2019-06-24T10:02:26Z","author_association":"CONTRIBUTOR","body":"Failure tracked in #43387","performed_via_github_app":null}]