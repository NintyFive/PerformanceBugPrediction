{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19138","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19138/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19138/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19138/events","html_url":"https://github.com/elastic/elasticsearch/issues/19138","id":162851082,"node_id":"MDU6SXNzdWUxNjI4NTEwODI=","number":19138,"title":"High CPU usage","user":{"login":"iokays","id":2617357,"node_id":"MDQ6VXNlcjI2MTczNTc=","avatar_url":"https://avatars1.githubusercontent.com/u/2617357?v=4","gravatar_id":"","url":"https://api.github.com/users/iokays","html_url":"https://github.com/iokays","followers_url":"https://api.github.com/users/iokays/followers","following_url":"https://api.github.com/users/iokays/following{/other_user}","gists_url":"https://api.github.com/users/iokays/gists{/gist_id}","starred_url":"https://api.github.com/users/iokays/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iokays/subscriptions","organizations_url":"https://api.github.com/users/iokays/orgs","repos_url":"https://api.github.com/users/iokays/repos","events_url":"https://api.github.com/users/iokays/events{/privacy}","received_events_url":"https://api.github.com/users/iokays/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-06-29T06:35:47Z","updated_at":"2016-06-29T12:54:22Z","closed_at":"2016-06-29T06:53:25Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,  I encountered a problem when I insert data, the following specific information.\n(Elasticsearch 2.3.1, JVM version 1.7.0_80x, CentOS release 6.6 (Final))\n\n100.6% (502.7ms out of 500ms) cpu usage by thread 'elasticsearch[Pressure][index][T#8]'\n     3/10 snapshots sharing following 30 elements\n       java.lang.invoke.LambdaForm$DMH/1697384030.invokeSpecial_LL_L(LambdaForm$DMH)\n       java.lang.invoke.LambdaForm$BMH/1674119038.reinvoke(LambdaForm$BMH)\n       java.lang.invoke.LambdaForm$MH/5369010.invokeExact_MT(LambdaForm$MH)\n       java.lang.invoke.MethodHandleImpl$GuardWithCatch.invoke_L1(MethodHandleImpl.java:619)\n       java.lang.invoke.LambdaForm$DMH/1697384030.invokeSpecial_LL_L(LambdaForm$DMH)\n       java.lang.invoke.LambdaForm$BMH/1674119038.reinvoke(LambdaForm$BMH)\n       java.lang.invoke.LambdaForm$DMH/1697384030.invokeSpecial_LL_L(LambdaForm$DMH)\n       java.lang.invoke.LambdaForm$MH/688130558.guard(LambdaForm$MH)\n       java.lang.invoke.LambdaForm$DMH/1697384030.invokeSpecial_LL_L(LambdaForm$DMH)\n       java.lang.invoke.LambdaForm$MH/1319810003.guard(LambdaForm$MH)\n       java.lang.invoke.LambdaForm$MH/303157806.linkToCallSite(LambdaForm$MH)\n       2057dd62e69d7b398105d17365a0e4fffae8cc18.run(2057dd62e69d7b398105d17365a0e4fffae8cc18:1)\n       org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript$1.run(GroovyScriptEngineService.java:313)\n       java.security.AccessController.doPrivileged(Native Method)\n       org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:310)\n       org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:252)\n       org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:197)\n       org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:80)\n       org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:174)\n       org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:168)\n       org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:66)\n       org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$ShardTransportHandler.messageReceived(TransportInstanceSingleOperationAction.java:244)\n       org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$ShardTransportHandler.messageReceived(TransportInstanceSingleOperationAction.java:240)\n       org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n       org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:75)\n       org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.doRun(MessageChannelHandler.java:300)\n       org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n       java.lang.Thread.run(Thread.java:745)\n\n**This is the code:** \n\n`public void run() {\n        while (true) {\n            final long start = System.currentTimeMillis();\n            int max = 0;\n            for (int j = 0; j < 1024; j++) {\n                max = ATOMIC.incrementAndGet();\n                final String id = Integer.toString(max);\n                final IndexTest entity = new IndexTest();\n                entity.setId(id);\n                repository.save(\"index_test\", \"type\", id, id, entity, false);\n            }\n            final long end = System.currentTimeMillis();\n            long cost = end - start;\n            long avgCost = cost / 1024;\n            LOGGER.info(\"thread index: {},\\t run: {},\\t cost: {}ms,\\t average cost: {}ms, maxValue: {}\", this.index,\n                    1024, cost, avgCost, max);\n        }\n    }`\n\n**logger**\n2016-06-29 04:01:58 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 6,    run: 1024,  cost: 9971ms,   average cost: 9ms, maxValue: 29784947\n2016-06-29 04:01:58 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 3,    run: 1024,  cost: 9833ms,   average cost: 9ms, maxValue: 29785724\n2016-06-29 04:01:59 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 2,    run: 1024,  cost: 9844ms,   average cost: 9ms, maxValue: 29786615\n2016-06-29 04:02:01 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 7,    run: 1024,  cost: 9754ms,   average cost: 9ms, maxValue: 29787929\n2016-06-29 04:02:02 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 8,    run: 1024,  cost: 9655ms,   average cost: 9ms, maxValue: 29789595\n2016-06-29 04:02:02 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 4,    run: 1024,  cost: 9641ms,   average cost: 9ms, maxValue: 29789704\n2016-06-29 04:02:03 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 5,    run: 1024,  cost: 9759ms,   average cost: 9ms, maxValue: 29790382\n2016-06-29 08:48:06 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 9,    run: 1024,  cost: 17170973ms,   average cost: 16768ms, maxValue: 29792325\n2016-06-29 08:48:06 INFO [com.chinatime.datacenter.test.elastic.InsertES2]:71 Line - thread index: 3,    run: 1024,  cost: 17167821ms,   average cost: 16765ms, maxValue: 29796080\nException in thread \"pool-1-thread-6\" ElasticsearchTimeoutException[Timeout waiting for task.]\n    at org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:70)\n    at org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:62)\n    at org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:52)\n    at com.chinatime.common.elasticsearch.utils.AbstractElasticRepository.save(AbstractElasticRepository.java:120)\n    at com.chinatime.datacenter.test.elastic.InsertES2.run(InsertES2.java:60)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Work\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}