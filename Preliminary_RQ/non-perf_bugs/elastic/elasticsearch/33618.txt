{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33618","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33618/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33618/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33618/events","html_url":"https://github.com/elastic/elasticsearch/issues/33618","id":359299151,"node_id":"MDU6SXNzdWUzNTkyOTkxNTE=","number":33618,"title":"Elasticsearch master node was suddenly down","user":{"login":"wyukawa","id":125312,"node_id":"MDQ6VXNlcjEyNTMxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/125312?v=4","gravatar_id":"","url":"https://api.github.com/users/wyukawa","html_url":"https://github.com/wyukawa","followers_url":"https://api.github.com/users/wyukawa/followers","following_url":"https://api.github.com/users/wyukawa/following{/other_user}","gists_url":"https://api.github.com/users/wyukawa/gists{/gist_id}","starred_url":"https://api.github.com/users/wyukawa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wyukawa/subscriptions","organizations_url":"https://api.github.com/users/wyukawa/orgs","repos_url":"https://api.github.com/users/wyukawa/repos","events_url":"https://api.github.com/users/wyukawa/events{/privacy}","received_events_url":"https://api.github.com/users/wyukawa/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-09-12T03:12:46Z","updated_at":"2018-09-12T03:22:45Z","closed_at":"2018-09-12T03:15:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.4.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_151\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentOS 7.4\r\n```\r\n# uname -a\r\nLinux ... 3.10.0-693.5.2.el7.x86_64 #1 SMP Fri Oct 20 20:32:50 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe have 3 master nodes.\r\nOne of  them was suddenly down but there is no meaningful log.\r\nI guess ```ExitOnOutOfMemoryError``` worked.\r\n\r\njvm argument\r\n```\r\n/usr/java/latest/bin/java -Xms12g -Xmx12g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -XX:-OmitStackTraceInFastThrow -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -XX:+HeapDumpOnOutOfMemoryError -XX:+ExitOnOutOfMemoryError -XX:HeapDumpPath=/var/lib/elasticsearch -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -Xloggc:/var/log/elasticsearch/gc_%p_%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=32 -XX:GCLogFileSize=128M -Des.path.home=/usr/share/elasticsearch -Des.path.conf=/etc/elasticsearch -Des.distribution.flavor=default -Des.distribution.type=rpm -cp /usr/share/elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch -p /var/run/elasticsearch/elasticsearch.pid --quiet\r\n```\r\n\r\nI analyze heap dump with MAT.\r\n\r\nHere is the result.\r\n\r\n[![Image from Gyazo](https://i.gyazo.com/38cac37ef5eeb34e8e5c1dc3744b4d96.jpg)](https://gyazo.com/38cac37ef5eeb34e8e5c1dc3744b4d96)\r\n\r\n```\r\n  at org.apache.lucene.util.UnicodeUtil.UTF8toUTF16([BII[C)I (UnicodeUtil.java:612)\r\n  at org.apache.lucene.util.BytesRef.utf8ToString()Ljava/lang/String; (BytesRef.java:140)\r\n  at org.elasticsearch.search.DocValueFormat$1.format(Lorg/apache/lucene/util/BytesRef;)Ljava/lang/String; (DocValueFormat.java:100)\r\n  at org.elasticsearch.search.DocValueFormat$1.format(Lorg/apache/lucene/util/BytesRef;)Ljava/lang/Object; (DocValueFormat.java:77)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.StringTerms$Bucket.getKeyAsString()Ljava/lang/String; (StringTerms.java:83)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.StringTerms$Bucket.getKey()Ljava/lang/Object; (StringTerms.java:64)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalTerms.java:274)\r\n  at org.elasticsearch.search.aggregations.InternalAggregation.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalAggregation.java:135)\r\n  at org.elasticsearch.search.aggregations.InternalAggregations.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (InternalAggregations.java:77)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms$Bucket.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/bucket/terms/InternalTerms$Bucket; (InternalTerms.java:142)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalTerms.java:286)\r\n  at org.elasticsearch.search.aggregations.InternalAggregation.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalAggregation.java:135)\r\n  at org.elasticsearch.search.aggregations.InternalAggregations.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (InternalAggregations.java:77)\r\n  at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(Ljava/util/List;Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (SearchPhaseController.java:525)\r\n  at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(Ljava/util/Collection;Ljava/util/List;Ljava/util/List;Lorg/elasticsearch/action/search/SearchPhaseController$TopDocsStats;IZ)Lorg/elasticsearch/action/search/SearchPhaseController$ReducedQueryPhase; (SearchPhaseController.java:502)\r\n  at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(Ljava/util/Collection;ZZ)Lorg/elasticsearch/action/search/SearchPhaseController$ReducedQueryPhase; (SearchPhaseController.java:419)\r\n  at org.elasticsearch.action.search.SearchPhaseController$1.reduce()Lorg/elasticsearch/action/search/SearchPhaseController$ReducedQueryPhase; (SearchPhaseController.java:738)\r\n  at org.elasticsearch.action.search.FetchSearchPhase.innerRun()V (FetchSearchPhase.java:101)\r\n  at org.elasticsearch.action.search.FetchSearchPhase.access$000(Lorg/elasticsearch/action/search/FetchSearchPhase;)V (FetchSearchPhase.java:44)\r\n  at org.elasticsearch.action.search.FetchSearchPhase$1.doRun()V (FetchSearchPhase.java:86)\r\n  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun()V (ThreadContext.java:723)\r\n  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run()V (AbstractRunnable.java:37)\r\n  at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun()V (TimedRunnable.java:41)\r\n  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run()V (AbstractRunnable.java:37)\r\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V (ThreadPoolExecutor.java:1149)\r\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run()V (ThreadPoolExecutor.java:624)\r\n  at java.lang.Thread.run()V (Thread.java:748)\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1.\r\n 2.\r\n 3.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nelasticsearch log\r\n```\r\n[2018-09-10T16:06:49,468][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][young][355198][16325] duration [756ms], collections [1]/[1.5s], total [756ms]/[22.4m], memory [6.7gb]->[8.4gb]/[11.7gb], all_pools {[young] [14.3mb]->[9.3mb]/[1.8gb]}{[survivor] [111.3mb]->[232.9mb]/[232.9mb]}{[old] [6.5gb]->[8.2gb]/[9.7gb]}\r\n[2018-09-10T16:06:49,468][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355198] overhead, spent [762ms] collecting in the last [1.5s]\r\n[2018-09-10T16:06:53,406][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355199] overhead, spent [3.5s] collecting in the last [3.9s]\r\n[2018-09-10T16:06:54,410][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355200] overhead, spent [547ms] collecting in the last [1s]\r\n[2018-09-10T16:06:55,411][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355201] overhead, spent [678ms] collecting in the last [1s]\r\n[2018-09-10T16:07:02,914][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355204][472] duration [5.2s], collections [1]/[5.5s], total [5.2s]/[1.5m], memory [11.3gb]->[10.3gb]/[11.7gb], all_pools {[young] [1.7gb]->[603.1mb]/[1.8gb]}{[survivor] [232.9mb]->[0b]/[232.9mb]}{[old] [9.3gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:02,914][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355204] overhead, spent [5.2s] collecting in the last [5.5s]\r\n[2018-09-10T16:07:10,402][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355207][474] duration [5.3s], collections [1]/[5.4s], total [5.3s]/[1.5m], memory [11.7gb]->[11gb]/[11.7gb], all_pools {[young] [1.8gb]->[1.3gb]/[1.8gb]}{[survivor] [216.2mb]->[0b]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:10,402][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355207] overhead, spent [5.3s] collecting in the last [5.4s]\r\n[2018-09-10T16:07:16,591][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355208][475] duration [5.3s], collections [1]/[6.1s], total [5.3s]/[1.6m], memory [11gb]->[11.4gb]/[11.7gb], all_pools {[young] [1.3gb]->[1.7gb]/[1.8gb]}{[survivor] [0b]->[0b]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:16,591][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355208] overhead, spent [5.3s] collecting in the last [6.1s]\r\n[2018-09-10T16:07:22,326][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355209][476] duration [5.1s], collections [1]/[5.7s], total [5.1s]/[1.7m], memory [11.4gb]->[11.2gb]/[11.7gb], all_pools {[young] [1.7gb]->[1.5gb]/[1.8gb]}{[survivor] [0b]->[0b]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:22,327][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355209] overhead, spent [5.1s] collecting in the last [5.7s]\r\n[2018-09-10T16:07:28,249][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355210][477] duration [5.3s], collections [1]/[5.9s], total [5.3s]/[1.8m], memory [11.2gb]->[11.5gb]/[11.7gb], all_pools {[young] [1.5gb]->[1.7gb]/[1.8gb]}{[survivor] [0b]->[0b]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:28,249][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355210] overhead, spent [5.3s] collecting in the last [5.9s]\r\n[2018-09-10T16:07:34,723][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355212][478] duration [5.4s], collections [1]/[5.4s], total [5.4s]/[1.9m], memory [11.7gb]->[11.5gb]/[11.7gb], all_pools {[young] [1.8gb]->[1.7gb]/[1.8gb]}{[survivor] [227.2mb]->[0b]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:34,724][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355212] overhead, spent [5.4s] collecting in the last [5.4s]\r\n[2018-09-10T16:07:41,275][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355214] overhead, spent [5.1s] collecting in the last [5.2s]\r\n[2018-09-10T16:07:46,401][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355215] overhead, spent [4.5s] collecting in the last [5.1s]\r\n[2018-09-10T16:07:51,502][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355216] overhead, spent [4.6s] collecting in the last [5.1s]\r\n[2018-09-10T16:07:58,418][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355217][483] duration [6.4s], collections [1]/[6.9s], total [6.4s]/[2.3m], memory [11.7gb]->[11.7gb]/[11.7gb], all_pools {[young] [1.8gb]->[1.8gb]/[1.8gb]}{[survivor] [180.2mb]->[164.5mb]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:07:58,418][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355217] overhead, spent [6.4s] collecting in the last [6.9s]\r\n[2018-09-10T16:08:04,162][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355218] overhead, spent [4.9s] collecting in the last [5.7s]\r\n[2018-09-10T16:08:10,420][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355219][485] duration [5.8s], collections [1]/[6.2s], total [5.8s]/[2.4m], memory [11.7gb]->[11.7gb]/[11.7gb], all_pools {[young] [1.8gb]->[1.8gb]/[1.8gb]}{[survivor] [182.4mb]->[209mb]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:08:10,425][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355219] overhead, spent [5.8s] collecting in the last [6.2s]\r\n[2018-09-10T16:08:15,655][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355220] overhead, spent [4.9s] collecting in the last [5.2s]\r\n[2018-09-10T16:08:21,066][INFO ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][old][355221][487] duration [5.2s], collections [1]/[5.2s], total [5.2s]/[2.6m], memory [11.7gb]->[11.7gb]/[11.7gb], all_pools {[young] [1.8gb]->[1.8gb]/[1.8gb]}{[survivor] [219.2mb]->[221.2mb]/[232.9mb]}{[old] [9.7gb]->[9.7gb]/[9.7gb]}\r\n[2018-09-10T16:08:21,072][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355221] overhead, spent [5.2s] collecting in the last [5.2s]\r\n[2018-09-10T16:08:25,926][WARN ][o.e.m.j.JvmGcMonitorService] [SOMEHOST] [gc][355222] overhead, spent [4.7s] collecting in the last [5s]\r\n```\r\n\r\nAny suggestions?","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}