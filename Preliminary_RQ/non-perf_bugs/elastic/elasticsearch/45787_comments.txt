[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/523446726","html_url":"https://github.com/elastic/elasticsearch/issues/45787#issuecomment-523446726","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45787","id":523446726,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzQ0NjcyNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-21T13:02:07Z","updated_at":"2019-08-21T13:02:07Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/523821126","html_url":"https://github.com/elastic/elasticsearch/issues/45787#issuecomment-523821126","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45787","id":523821126,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzgyMTEyNg==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-08-22T09:12:03Z","updated_at":"2019-08-22T09:13:10Z","author_association":"CONTRIBUTOR","body":"I tried to reproduce this failure locally, with no success.\r\n\r\nFTR, these are the steps I've taken:\r\n\r\n1. I've run this test multiple times:\r\na) using -Dtests.iter:\r\n```\r\n./gradlew :x-pack:plugin:integtest -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT -Dtests.method=\"test {p0=ml/data_frame_analytics_memory_usage_estimation/*}\" -Dtests.iters=10000\r\n```\r\nb) using bash for-loop (as I was unsure whether -Dtests.iters really does what I thought it should do):\r\n```\r\n for i in `seq 1 100`; do ./gradlew :x-pack:plugin:integtest -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT -Dtests.method=\"test {p0=ml/data_frame_analytics_memory_usage_estimation/*}\" 1>/tmp/test_${i}.out 2>&1; done\r\n```\r\n\r\n2. I've started the server and flooded it with requests:\r\na) start server locally:\r\n```\r\n./gradlew run -Dtests.es.xpack.license.self_generated.type=trial -Dtests.es.xpack.security.enabled=false -Dtests.heap.size=4g | tee /tmp/es_logs_1\r\n```\r\n\r\nb) populate index:\r\n```\r\nfor i in `seq 1 1000`; do curl -X PUT -H Content-Type:application/json localhost:9200/my-index/_doc/${i} -d '{\"a\": 10, \"b\": 20 }'| json_pp; done\r\n```\r\n\r\nc) issue requests:\r\n```\r\nfor i in `seq 1 10000`; do curl -X POST -H Content-Type:application/json localhost:9200/_ml/data_frame/analytics/_estimate_memory_usage -d '{ \"source\": { \"index\": [\"my-index\"] }, \"analysis\": { \"outlier_detection\" :{} } }' | json_pp --json_opt=canonical,pretty; done\r\n```\r\n\r\n100% of test runs and requests were successful, no errors in the logs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525705020","html_url":"https://github.com/elastic/elasticsearch/issues/45787#issuecomment-525705020","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45787","id":525705020,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTcwNTAyMA==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-08-28T11:35:50Z","updated_at":"2019-08-28T11:36:35Z","author_association":"CONTRIBUTOR","body":"Update:\r\nI was able to reproduce the issue locally after adding `Thread.sleep(10000);` right before `process.isProcessAlive()` check.\r\nThis basically means that the process closes as soon as it produces output and it *does not* wait  until its output is read by Java code. The reason why memory estimation is the only C++ process that behaves like this is because we do not provide an input pipe to it.\r\nOne possible solution would be to provide input pipe just like every other C++ process gets.\r\nI'd like to explore other options though as memory estimation process does not need to receive any input from Java pipe so adding an input pipe only to control when the process stops feels overly complex.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/526138553","html_url":"https://github.com/elastic/elasticsearch/issues/45787#issuecomment-526138553","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45787","id":526138553,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNjEzODU1Mw==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-08-29T11:08:17Z","updated_at":"2019-08-29T11:08:17Z","author_association":"CONTRIBUTOR","body":"I'll monitor build-stats console to verify that the failures did not reoccur:\r\nhttps://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-6M,mode:quick,to:now))&_a=(columns:!(test.failed-testcases),index:b646ed00-7efc-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'memory_usage_estimation_*'),sort:!(process.time-start,desc))","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/529340879","html_url":"https://github.com/elastic/elasticsearch/issues/45787#issuecomment-529340879","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45787","id":529340879,"node_id":"MDEyOklzc3VlQ29tbWVudDUyOTM0MDg3OQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-09-09T07:46:31Z","updated_at":"2019-09-09T07:46:31Z","author_association":"CONTRIBUTOR","body":"The failures did not reoccur since 30th of August which suggests the fix worked properly.","performed_via_github_app":null}]