[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/683658636","html_url":"https://github.com/elastic/elasticsearch/issues/61704#issuecomment-683658636","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61704","id":683658636,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MzY1ODYzNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-08-31T09:02:12Z","updated_at":"2020-08-31T09:02:12Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/683667631","html_url":"https://github.com/elastic/elasticsearch/issues/61704#issuecomment-683667631","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61704","id":683667631,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MzY2NzYzMQ==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2020-08-31T09:20:32Z","updated_at":"2020-08-31T09:20:32Z","author_association":"CONTRIBUTOR","body":"Muted in master and 7.x in #61705 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/683843622","html_url":"https://github.com/elastic/elasticsearch/issues/61704#issuecomment-683843622","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61704","id":683843622,"node_id":"MDEyOklzc3VlQ29tbWVudDY4Mzg0MzYyMg==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2020-08-31T15:16:20Z","updated_at":"2020-08-31T15:16:20Z","author_association":"MEMBER","body":"Two issues:\r\n\r\n1. The native process is checking the memory limit on start still. It shouldn't do this.\r\n2. There is a race condition if the process crashes REALLY early (i.e. failing to start). \r\n\r\nThe race condition is here:\r\n- https://github.com/elastic/elasticsearch/blob/de3107a949dba1961ee6689b3d38fc349184e9e9/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java#L324\r\n- https://github.com/elastic/elasticsearch/blob/de3107a949dba1961ee6689b3d38fc349184e9e9/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java#L317\r\n\r\nBasically, the onCrash callback is being called, but then we are raising that the on start failed. \r\n\r\nLogs:\r\n```\r\n[2020-08-31T11:06:13,881][DEBUG][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-0] [low_memory_analysis] creating analytics process with config [{\"job_id\":\"low_memory_analysis\",\"rows\":10000,\"cols\":8,\"memory_limit\":1024,\"threads\":1,\"results_field\":\"ml\",\"categorical_fields\":[\"text-field\",\"keyword-field\",\"outer-field.inner-field\",\"alias-to-nested-field\",\"alias-to-keyword-field\"],\"analysis\":{\"name\":\"classification\",\"parameters\":{\"prediction_field_type\":\"string\",\"num_classes\":2,\"dependent_variable\":\"outer-field.inner-field\",\"num_top_classes\":2,\"training_percent\":100.0,\"class_assignment_objective\":\"maximize_minimum_recall\",\"prediction_field_name\":\"outer-field.inner-field_prediction\"}}}]\r\n[2020-08-31T11:06:13,980][FATAL][o.e.x.m.p.l.CppLogMessageHandler] [integTest-0] [low_memory_analysis] [data_frame_analyzer/14993] [CLogger.cc@399] Input error: memory limit 0MB is too low to perform analysis. You need to give the process at least 26MB, but preferably more.\r\n[2020-08-31T11:06:13,981][INFO ][o.e.x.m.p.AbstractNativeProcess] [integTest-0] [low_memory_analysis] State output finished\r\n[2020-08-31T11:06:13,982][ERROR][o.e.x.m.p.AbstractNativeProcess] [integTest-0] [low_memory_analysis] analytics process stopped unexpectedly: Input error: memory limit 0MB is too low to perform analysis. You need to give the process at least 26MB, but preferably more.\r\n\r\n[2020-08-31T11:06:13,982][WARN ][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-0] [low_memory_analysis] crashed with a process context with reason [[low_memory_analysis] analytics process stopped unexpectedly: Input error: memory limit 0MB is too low to perform analysis. You need to give the process at least 26MB, but preferably more.\r\n]\r\n[2020-08-31T11:06:13,981][ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-0] [low_memory_analysis] failed to start native process\r\norg.elasticsearch.ElasticsearchException: Failed to start data frame analytics process\r\n\tat org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper.serverError(ExceptionsHelper.java:51) ~[x-pack-core-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.createProcess(AnalyticsProcessManager.java:325) ~[x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager$ProcessContext.startProcess(AnalyticsProcessManager.java:486) ~[x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.lambda$runJob$2(AnalyticsProcessManager.java:147) [x-pack-ml-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:647) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\n[2020-08-31T11:06:13,983][DEBUG][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-0] [low_memory_analysis] Stopping process\r\n[2020-08-31T11:06:13,983][DEBUG][o.e.x.m.d.e.DataFrameDataExtractor] [integTest-0] [low_memory_analysis] Data extractor was cancelled\r\n[2020-08-31T11:06:13,983][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [integTest-0] uncaught exception in thread [elasticsearch[integTest-0][generic][T#2]]\r\norg.elasticsearch.ElasticsearchException: Failed to start data frame analytics process\r\n\tat org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper.serverError(ExceptionsHelper.java:51) ~[?:?]\r\n\tat org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.createProcess(AnalyticsProcessManager.java:325) ~[?:?]\r\n\tat org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager$ProcessContext.startProcess(AnalyticsProcessManager.java:486) ~[?:?]\r\n\tat org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.lambda$runJob$2(AnalyticsProcessManager.java:147) ~[?:?]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:647) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\n[2020-08-31T11:06:14,002][WARN ][o.e.x.m.p.l.CppLogMessageHandler] [integTest-0] [controller/14807] [CDetachedProcessSpawner.cc@193] Child process with PID 14993 has exited with exit code 1\r\n[2020-08-31T11:06:42,352][INFO ][o.e.x.m.a.TransportSetUpgradeModeAction] [integTest-0] Upgrade mode noop\r\n[2020-08-31T11:06:42,530][INFO ][o.e.x.m.a.TransportStopDataFrameAnalyticsAction] [integTest-0] [low_memory_analysis] Stopping task with force [false]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/683843763","html_url":"https://github.com/elastic/elasticsearch/issues/61704#issuecomment-683843763","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61704","id":683843763,"node_id":"MDEyOklzc3VlQ29tbWVudDY4Mzg0Mzc2Mw==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2020-08-31T15:16:32Z","updated_at":"2020-08-31T15:16:32Z","author_association":"MEMBER","body":"@dimitris-athanasiou ^^ ping on the race","performed_via_github_app":null}]