{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998/events","html_url":"https://github.com/elastic/elasticsearch/issues/5998","id":32531001,"node_id":"MDU6SXNzdWUzMjUzMTAwMQ==","number":5998,"title":"Significant terms misses some terms","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2014-04-30T12:41:48Z","updated_at":"2014-05-13T08:01:54Z","closed_at":"2014-05-07T16:04:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When defining a \"min_doc_count\" and a \"size\", significant terms might fail to return the right significant terms. The scenario is as follows:\n1. There are at least size \\* 2 terms that have a subsetDF < min_doc_count \n2. There are terms that have a subsetDF > min_doc_count \n3. Terms in 1. score higher than terms in 2.\n\nUnder these circumstances no significant term is returned at all (test is in the branches below). This makes it hard to use significant terms for processing natural text which contains many low frequent terms.\n\nI think the reason for this behavior is that internally a priority queue is maintained that has a maximum of 2*size entries. This queue uses the score as criterion to determine if a bucket is kept or not. Because terms in 1. score higher than terms in 2., only documents with subsetDF < min_doc_count  will be kept and therefore finally no terms are returned at all.\n\nIt is unclear to me how to fix this. I prepared two potential ways to fix this (not nearly ready for a pr, more proof of concept):\n\nA. assign score -MAX_FLOAT if subsetDf < minDocCount\nThis would cause terms with a too low subsetDF to be added with a very low score. These terms still would get a chance to be returned if by [merging](https://github.com/elasticsearch/elasticsearch/blob/master/src/main/java/org/elasticsearch/search/aggregations/bucket/significant/InternalSignificantTerms.java#L151) their subsetDf increases. However, they might be thrown out of the priority queue before that by terms with a higher score and never be merged at all.\n\nBranch: https://github.com/brwe/elasticsearch/tree/missing-sig-terms-1\n\nB. Do not add terms to priority queue if subsetDf < minDocCount\nEasier to code but unfortunately this means that terms that might match the minDocCount criterion after merging would not be added in the first place.\n\nBranch: https://github.com/brwe/elasticsearch/tree/missing-sig-terms-2\n\nBoth ways do not guarantee that the \"correct\" significant terms are returned. \nI would prefer B.\n","closed_by":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"performed_via_github_app":null}