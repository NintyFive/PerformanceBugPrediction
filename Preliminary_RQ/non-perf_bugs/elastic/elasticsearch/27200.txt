{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27200","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27200/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27200/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27200/events","html_url":"https://github.com/elastic/elasticsearch/issues/27200","id":270201891,"node_id":"MDU6SXNzdWUyNzAyMDE4OTE=","number":27200,"title":"stats REST API call under-counts 'get's (queries by ID)","user":{"login":"buildlackey","id":1577925,"node_id":"MDQ6VXNlcjE1Nzc5MjU=","avatar_url":"https://avatars3.githubusercontent.com/u/1577925?v=4","gravatar_id":"","url":"https://api.github.com/users/buildlackey","html_url":"https://github.com/buildlackey","followers_url":"https://api.github.com/users/buildlackey/followers","following_url":"https://api.github.com/users/buildlackey/following{/other_user}","gists_url":"https://api.github.com/users/buildlackey/gists{/gist_id}","starred_url":"https://api.github.com/users/buildlackey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/buildlackey/subscriptions","organizations_url":"https://api.github.com/users/buildlackey/orgs","repos_url":"https://api.github.com/users/buildlackey/repos","events_url":"https://api.github.com/users/buildlackey/events{/privacy}","received_events_url":"https://api.github.com/users/buildlackey/received_events","type":"User","site_admin":false},"labels":[{"id":146836529,"node_id":"MDU6TGFiZWwxNDY4MzY1Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Stats","name":":Core/Features/Stats","color":"0e8a16","default":false,"description":"Statistics tracking and retrieval APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-11-01T05:51:46Z","updated_at":"2017-11-01T18:41:34Z","closed_at":"2017-11-01T18:41:34Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n  \"version\" : {\r\n    \"number\" : \"5.4.1\",\r\n    \"build_hash\" : \"2cfe0df\",\r\n    \"build_date\" : \"2017-05-29T16:05:51.443Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"6.5.1\"\r\n  },\r\n\r\n\r\n**Plugins installed**: []\r\n\r\n$ ls /apps/elasticsearch/plugins/\r\nanalysis-icu  analysis-kuromoji  mapper-murmur3  raigad-discovery  repository-s3\r\n\r\n\r\n**JVM version** (`java -version`):\r\n\r\n  java version \"1.8.0_131\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n    4.4.0-81-generic #104-Ubuntu SMP Wed Jun 14 08:17:06 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n\r\nMy assumption in reporting this issue is that the _stats API call will return \r\na JSON attribute that corresponds to the number of times a particular index was \r\nqueried directly by object ID, and that this attribute has the following coordinates \r\n(in the returned JSON): \r\n\r\n        <root>\r\n            <indices>\r\n                <index-name>\r\n                    <primaries>\r\n                        <get>   \r\n                            <total>\r\n\r\nIf that assumption is correct, then it is easy to reproduce a failure where \r\nthe number of 'gets' reported by _stats does not match the number of requests issued,\r\neven after a number of minutes pass to let the metrics be published to the latest values.\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n(These steps assume you have the tool 'jq' installed to parse JSON responses.)\r\n\r\nThe script below queries an index 10 times directly by id (with a sleep just in case\r\nthe count is thrown off by requests arriving too closely spaced between each other).\r\n\r\nThen it sleeps another minute to let metrics be published, then it issues a _stats \r\ncall to get the number of 'gets' in the index 'pest'.\r\n\r\nThe result I get is 3, even though I issue 10 gets.  Even after 5 minutes elapses \r\nwhen I check again the result is still 3.\r\n\r\n\r\ncluster=http://localhost:9200\r\ncurl -X PUT $cluster/pest/mouse/1 -d '{ \"sound\": \"squeak\" }'\r\n\r\n \r\ncurl $cluster/pest/mouse/1    # get 10 times\r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\nsleep 1\r\ncurl $cluster/pest/mouse/1 \r\n\r\n\r\nsleep 60    # sleep to give time for metrics to be published\r\n \r\ncurl -X GET $cluster/_all/_stats?pretty | jq \".indices.pest.primaries.get.total\"\r\n\r\n","closed_by":{"login":"buildlackey","id":1577925,"node_id":"MDQ6VXNlcjE1Nzc5MjU=","avatar_url":"https://avatars3.githubusercontent.com/u/1577925?v=4","gravatar_id":"","url":"https://api.github.com/users/buildlackey","html_url":"https://github.com/buildlackey","followers_url":"https://api.github.com/users/buildlackey/followers","following_url":"https://api.github.com/users/buildlackey/following{/other_user}","gists_url":"https://api.github.com/users/buildlackey/gists{/gist_id}","starred_url":"https://api.github.com/users/buildlackey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/buildlackey/subscriptions","organizations_url":"https://api.github.com/users/buildlackey/orgs","repos_url":"https://api.github.com/users/buildlackey/repos","events_url":"https://api.github.com/users/buildlackey/events{/privacy}","received_events_url":"https://api.github.com/users/buildlackey/received_events","type":"User","site_admin":false},"performed_via_github_app":null}