[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271806662","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-271806662","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":271806662,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTgwNjY2Mg==","user":{"login":"timbaer","id":5097986,"node_id":"MDQ6VXNlcjUwOTc5ODY=","avatar_url":"https://avatars1.githubusercontent.com/u/5097986?v=4","gravatar_id":"","url":"https://api.github.com/users/timbaer","html_url":"https://github.com/timbaer","followers_url":"https://api.github.com/users/timbaer/followers","following_url":"https://api.github.com/users/timbaer/following{/other_user}","gists_url":"https://api.github.com/users/timbaer/gists{/gist_id}","starred_url":"https://api.github.com/users/timbaer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timbaer/subscriptions","organizations_url":"https://api.github.com/users/timbaer/orgs","repos_url":"https://api.github.com/users/timbaer/repos","events_url":"https://api.github.com/users/timbaer/events{/privacy}","received_events_url":"https://api.github.com/users/timbaer/received_events","type":"User","site_admin":false},"created_at":"2017-01-11T08:23:08Z","updated_at":"2017-01-11T08:37:07Z","author_association":"NONE","body":"Hi @nik9000 ,\r\n\r\nfirst of all, I really appreciate your work on es5. The changes look promising! Because of that, I'm currently looking for what needs to be done to migrate my 2.4.x setup to elasticsearch 5. \r\n\r\nOne of my findings so far is that you no longer support running es in embedded mode. However, I have like hundreds of integration tests for my client functionality which are based on starting and stopping an embedded node for each test suite. After some investigation and playing around with changed Node Java Api and the [es5 test framework](https://www.elastic.co/guide/en/elasticsearch/reference/current/integration-tests.html), I found this issue and the one you linked and was somewhat shocked that neither the embedded node, nor the testing framework are the desired way by you guys to write integration tests. \r\nWhat worked for me so far is using the maven-elasticsearch-plugin, however I'm missing the control of when to start / stop a cluster, e.g. if I want to run tests simultaneously. \r\n\r\nSo, I just want to ask if there is something I missed and simply moved into the wrong direction because of the lack of documentation. Or if using a maven/gradle plugin is the best I can do right now. \r\n\r\nBest regards and thanks for the work!!!\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271871683","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-271871683","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":271871683,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTg3MTY4Mw==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-01-11T13:44:44Z","updated_at":"2017-01-11T13:44:44Z","author_association":"CONTRIBUTOR","body":"> What worked for me so far is using the maven-elasticsearch-plugin, however I'm missing the control of when to start / stop a cluster, e.g. if I want to run tests simultaneously.\r\n\r\nYou can't really do that with the maven plugin. One at a time, sadly.\r\n\r\nI think the maven plugin is the way to go because it is \"more real\" but it does sadly lose a few things like parallel test runs. Running ES was never really supported. It worked and folks would help with it but it was a maintenance nightmare and requires poking holes in the security which was bad.\r\n\r\nESIntegTestCase works and we use it when we need to be able to reach into the running cluster and mess with it but we try not write new tests that use that unless we need it because we're worried about how much fakery in injects. The loss of parallel tests is sad, but maybe worth it. At least for now we think it is. For us, at least.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272151206","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-272151206","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":272151206,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE1MTIwNg==","user":{"login":"timbaer","id":5097986,"node_id":"MDQ6VXNlcjUwOTc5ODY=","avatar_url":"https://avatars1.githubusercontent.com/u/5097986?v=4","gravatar_id":"","url":"https://api.github.com/users/timbaer","html_url":"https://github.com/timbaer","followers_url":"https://api.github.com/users/timbaer/followers","following_url":"https://api.github.com/users/timbaer/following{/other_user}","gists_url":"https://api.github.com/users/timbaer/gists{/gist_id}","starred_url":"https://api.github.com/users/timbaer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timbaer/subscriptions","organizations_url":"https://api.github.com/users/timbaer/orgs","repos_url":"https://api.github.com/users/timbaer/repos","events_url":"https://api.github.com/users/timbaer/events{/privacy}","received_events_url":"https://api.github.com/users/timbaer/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T12:28:13Z","updated_at":"2017-01-12T12:35:46Z","author_association":"NONE","body":"> ESIntegTestCase works and we use it when we need to be able to reach into the running cluster and mess with it but we try not write new tests that use that unless we need it because we're worried about how much fakery in injects.\r\n\r\nThe problem with ESIntegTestCase for me is, that it brings in way too many dependencies which heavily interfere with mine, e.g. mockito vs securemock, log4j2 vs slf4j and many more...I tried the shading of those dependencies [as described here](https://www.elastic.co/blog/to-shade-or-not-to-shade), but then I'm running into even more worse problems. \r\n\r\nActually, I would love to use these test utilities. If you have some more hints about what I can change in order to use the lib, I would be really happy. I bet the community would love to see a testing-library with  minimal side-effects (almost no dependencies). \r\n\r\nBtw, [there is a solution out there](http://stackoverflow.com/questions/41298467/how-to-start-elasticsearch-5-1-embedded-in-my-java-application/41299436#41299436) on how to work with embedded Node in es 5. Works for me so far, and I'm still arguing whether to use it, or the maven plugin. Maybe it would be good to show your point (the one of the core devs) to the outer world by commenting on threads like this, so that frustration about it keeps at a minimum. :-)\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272197538","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-272197538","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":272197538,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5NzUzOA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:45:12Z","updated_at":"2017-01-12T15:45:12Z","author_association":"CONTRIBUTOR","body":"> The problem with ESIntegTestCase for me is, that it brings in way too many dependencies which heavily interfere with mine\r\n\r\nYeah, it really is for testing Elasticsearch plugins and Elasticsearch plugins have to suffer through stuff like securemock and live with log4j2 because we depend on it directly (though I don't feel [that bad](http://stackoverflow.com/questions/41498021/is-it-worth-to-use-slf4j-with-log4j2/41500347#41500347) about it).\r\n\r\n> I bet the community would love to see a testing-library with minimal side-effects (almost no dependencies).\r\n\r\n[I do too](https://github.com/elastic/elasticsearch/issues/21119) but I think it is more I don't think there is any willingness from the Elasticsearch team to make something like you are describing. On the whole we're of the opinion that you should use an external Elasticsearch node, maybe started by maven or gradle or [esvm](https://github.com/elastic/esvm) or Vagrant or something. As I said, this loses parallel test runs which is bad but the \"realness\" you get from depending on a node started with real configs is worth the price. We think. We've moved many of our tests to this model and liked it for the most part. I think @alexcojocaru is working getting the maven plugin to support Elasticsearch 5.0: https://github.com/alexcojocaru/elasticsearch-maven-plugin/tree/es5\r\n\r\n> Btw, there is a solution out there on how to work with embedded Node in es 5.\r\n\r\nI expect there are ways to get it to work but I wouldn't trust them not to break on upgrade. Like, minor or even patch version upgrade. \r\n\r\n> Maybe it would be good to show your point (the one of the core devs)\r\n\r\n@dadoonet commented. I'll comment again.\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272241104","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-272241104","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":272241104,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjI0MTEwNA==","user":{"login":"alexcojocaru","id":479131,"node_id":"MDQ6VXNlcjQ3OTEzMQ==","avatar_url":"https://avatars1.githubusercontent.com/u/479131?v=4","gravatar_id":"","url":"https://api.github.com/users/alexcojocaru","html_url":"https://github.com/alexcojocaru","followers_url":"https://api.github.com/users/alexcojocaru/followers","following_url":"https://api.github.com/users/alexcojocaru/following{/other_user}","gists_url":"https://api.github.com/users/alexcojocaru/gists{/gist_id}","starred_url":"https://api.github.com/users/alexcojocaru/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexcojocaru/subscriptions","organizations_url":"https://api.github.com/users/alexcojocaru/orgs","repos_url":"https://api.github.com/users/alexcojocaru/repos","events_url":"https://api.github.com/users/alexcojocaru/events{/privacy}","received_events_url":"https://api.github.com/users/alexcojocaru/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T18:23:46Z","updated_at":"2017-01-12T18:23:46Z","author_association":"NONE","body":"Just a comment on the Elasticsearch maven plugin: I finished rewriting it to work with ES 5; the code is in the master branch and the artifact was deployed to maven central:  https://search.maven.org/#artifactdetails|com.github.alexcojocaru|elasticsearch-maven-plugin|5.3|maven-plugin","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272277611","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-272277611","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":272277611,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjI3NzYxMQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T20:42:28Z","updated_at":"2017-01-12T20:42:28Z","author_association":"CONTRIBUTOR","body":"> I finished rewriting it to work with ES 5\r\n\r\n❤️ ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296432789","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-296432789","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":296432789,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjQzMjc4OQ==","user":{"login":"jillesvangurp","id":819187,"node_id":"MDQ6VXNlcjgxOTE4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/819187?v=4","gravatar_id":"","url":"https://api.github.com/users/jillesvangurp","html_url":"https://github.com/jillesvangurp","followers_url":"https://api.github.com/users/jillesvangurp/followers","following_url":"https://api.github.com/users/jillesvangurp/following{/other_user}","gists_url":"https://api.github.com/users/jillesvangurp/gists{/gist_id}","starred_url":"https://api.github.com/users/jillesvangurp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jillesvangurp/subscriptions","organizations_url":"https://api.github.com/users/jillesvangurp/orgs","repos_url":"https://api.github.com/users/jillesvangurp/repos","events_url":"https://api.github.com/users/jillesvangurp/events{/privacy}","received_events_url":"https://api.github.com/users/jillesvangurp/received_events","type":"User","site_admin":false},"created_at":"2017-04-23T10:08:22Z","updated_at":"2017-04-23T10:08:22Z","author_association":"CONTRIBUTOR","body":"An alternative approach to using maven or gradle plugins is using docker. I implemented some integration tests last week using docker-java. I wrote a simple Junit rule called EsRule for this that pulls and launches a docker container with elasticsearch. Works great whether you are running tests from an IDE or a build and you can launch whatever you need with this approach. I made it so that it reuses any running elasticsearch if it is already up and running and added  a simple jvm shut down hook to ensure the docker container gets killed. We run our CI builds with travis ci where all I had to do to make this work was add docker support to the services section.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/371986468","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-371986468","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":371986468,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MTk4NjQ2OA==","user":{"login":"jeacott1","id":16600100,"node_id":"MDQ6VXNlcjE2NjAwMTAw","avatar_url":"https://avatars3.githubusercontent.com/u/16600100?v=4","gravatar_id":"","url":"https://api.github.com/users/jeacott1","html_url":"https://github.com/jeacott1","followers_url":"https://api.github.com/users/jeacott1/followers","following_url":"https://api.github.com/users/jeacott1/following{/other_user}","gists_url":"https://api.github.com/users/jeacott1/gists{/gist_id}","starred_url":"https://api.github.com/users/jeacott1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeacott1/subscriptions","organizations_url":"https://api.github.com/users/jeacott1/orgs","repos_url":"https://api.github.com/users/jeacott1/repos","events_url":"https://api.github.com/users/jeacott1/events{/privacy}","received_events_url":"https://api.github.com/users/jeacott1/received_events","type":"User","site_admin":false},"created_at":"2018-03-10T00:51:13Z","updated_at":"2018-03-10T00:51:13Z","author_association":"NONE","body":"@jillesvangurp care to share your EsRule?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/371987199","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-371987199","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":371987199,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MTk4NzE5OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-03-10T00:56:58Z","updated_at":"2018-03-10T00:56:58Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/372296433","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-372296433","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":372296433,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MjI5NjQzMw==","user":{"login":"jillesvangurp","id":819187,"node_id":"MDQ6VXNlcjgxOTE4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/819187?v=4","gravatar_id":"","url":"https://api.github.com/users/jillesvangurp","html_url":"https://github.com/jillesvangurp","followers_url":"https://api.github.com/users/jillesvangurp/followers","following_url":"https://api.github.com/users/jillesvangurp/following{/other_user}","gists_url":"https://api.github.com/users/jillesvangurp/gists{/gist_id}","starred_url":"https://api.github.com/users/jillesvangurp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jillesvangurp/subscriptions","organizations_url":"https://api.github.com/users/jillesvangurp/orgs","repos_url":"https://api.github.com/users/jillesvangurp/repos","events_url":"https://api.github.com/users/jillesvangurp/events{/privacy}","received_events_url":"https://api.github.com/users/jillesvangurp/received_events","type":"User","site_admin":false},"created_at":"2018-03-12T12:42:10Z","updated_at":"2018-03-12T12:42:10Z","author_association":"CONTRIBUTOR","body":"@jeacott1 here you go, not perfect but it works. I'd prefer to use something using docker compose long term so we can also run other dependencies but this was good enough last year.\r\n\r\nNote this also includes some dependencies on our internal client that you probably want to swap out for the official one at this point. Also includes some logic for creating indicices that you may want to skip.\r\n\r\n```\r\npackage com.matmatch.search.testutils;\r\n\r\nimport com.fasterxml.jackson.databind.ObjectMapper;\r\nimport com.github.dockerjava.api.DockerClient;\r\nimport com.github.dockerjava.api.command.CreateContainerResponse;\r\nimport com.github.dockerjava.api.command.StartContainerCmd;\r\nimport com.github.dockerjava.api.model.ExposedPort;\r\nimport com.github.dockerjava.api.model.Ports;\r\nimport com.github.dockerjava.core.DefaultDockerClientConfig;\r\nimport com.github.dockerjava.core.DockerClientBuilder;\r\nimport com.github.dockerjava.core.DockerClientConfig;\r\nimport com.github.dockerjava.core.command.PullImageResultCallback;\r\nimport com.matmatch.search.IndexMapping;\r\nimport com.matmatch.search.ObjectMapperService;\r\nimport com.matmatch.search.esclient.EsClientService;\r\nimport com.matmatch.search.esclient.EsRestClientService;\r\nimport com.matmatch.search.esclient.exceptions.EsNotFoundException;\r\nimport lombok.extern.slf4j.Slf4j;\r\nimport okhttp3.OkHttpClient;\r\nimport org.apache.commons.lang3.RandomStringUtils;\r\nimport org.apache.commons.lang3.StringUtils;\r\nimport org.junit.rules.ExternalResource;\r\n\r\nimport java.util.ArrayList;\r\nimport java.util.List;\r\nimport java.util.Locale;\r\nimport java.util.concurrent.locks.ReentrantLock;\r\n\r\nimport static org.assertj.core.api.Assertions.assertThat;\r\n\r\n/**\r\n * Simple @{@link org.junit.ClassRule} for ensuring elasticsearch is running.\r\n *\r\n * Note, if something is already running on the assigned port, it will skip starting the docker container\r\n * and use that instead. Useful if you want to run in an IDE.\r\n *\r\n * TODO logging, error handling, config, etc.\r\n */\r\n@Slf4j\r\npublic class EsRule extends ExternalResource {\r\n    // lets not bind to the standard port so we never 'accidentally' let tests write to an existing es cluster unintentionally\r\n    public static final int ES_TEST_PORT = 9600;\r\n\r\n    private final ReentrantLock lock = new ReentrantLock();\r\n    private boolean running=false;\r\n    private EsClientService esClientService;\r\n    private EsRestClientService esRestClientService;\r\n    private List<String> temporaryIndices = new ArrayList<>();\r\n\r\n\r\n    private void startEs() {\r\n        DockerClientConfig config = DefaultDockerClientConfig.createDefaultConfigBuilder()\r\n                .build();\r\n        DockerClient docker = DockerClientBuilder.getInstance(config).build();\r\n\r\n        ExposedPort tcp9200 = ExposedPort.tcp(9200);\r\n\r\n        Ports portBindings = new Ports();\r\n        portBindings.bind(tcp9200, Ports.Binding.bindPort(ES_TEST_PORT));\r\n\r\n\r\n        PullImageResultCallback callback = new PullImageResultCallback();\r\n        docker.pullImageCmd(\"elasticsearch:5.1.2\").exec(callback);\r\n        callback.awaitSuccess();\r\n\r\n        CreateContainerResponse containerResponse = docker\r\n                .createContainerCmd(\"elasticsearch:5.1.2\")\r\n                .withPortBindings(portBindings)\r\n                .exec();\r\n\r\n        String containerId = containerResponse.getId();\r\n        log.info(\"container id: {}\", containerId);\r\n\r\n        StartContainerCmd startContainerCmd = docker.startContainerCmd(containerId);\r\n        startContainerCmd.exec();\r\n\r\n        log.info(\"STARTING DOCKER CONTAINER FOR ES - note you can run your own ES on port \" + ES_TEST_PORT + \" in development to skip this and save some time\");\r\n\r\n        esClientService.awaitStarted();\r\n        assertThat(esClientService.isUp()).isTrue();\r\n        log.info(\"ES IS UP\");\r\n        running=true;\r\n\r\n        // FIXME figure out if there's a more elegant way to do this\r\n        Runtime.getRuntime().addShutdownHook(new Thread(){\r\n            @Override\r\n            public void run() {\r\n                docker.stopContainerCmd(containerId).exec();\r\n                log.info(\"STOPPED CONTAINER\");\r\n            }\r\n        });\r\n    }\r\n\r\n    @Override\r\n    protected void before() throws Throwable {\r\n        super.before();\r\n        ObjectMapperService objectMapperService = new ObjectMapperService(new ObjectMapper());\r\n        esRestClientService = new EsRestClientService(objectMapperService, new OkHttpClient(), \"http://localhost:\"+ES_TEST_PORT);\r\n        esClientService = new EsClientService(objectMapperService, esRestClientService);\r\n        // check if we are running a usable es already; this allows you to run from the IDE without having to wait for es to start\r\n        running = esClientService.isUp();\r\n        if(!isRunning()) {\r\n            lock.lock();\r\n            try {\r\n                if(!isRunning()) {\r\n                    startEs();\r\n                }\r\n            } finally {\r\n                lock.unlock();\r\n            }\r\n        }\r\n    }\r\n\r\n    public String createTemporaryIndex(IndexMapping mapping) {\r\n        return createTemporaryIndexWithAlias(mapping,null);\r\n    }\r\n\r\n    public String createTemporaryIndexWithAlias(IndexMapping mapping, String alias) {\r\n        String index = \"testindex_\" + RandomStringUtils.randomAlphanumeric(10).toLowerCase(Locale.ENGLISH);\r\n        esClientService().createIndex(index, mapping);\r\n        temporaryIndices.add(index);\r\n        if(StringUtils.isNotBlank(alias)) {\r\n            esClientService().addAlias(index,alias);\r\n        }\r\n        return index;\r\n    }\r\n\r\n    public void deleteIndicesAfterTest(String...indexes) {\r\n        for(String index: indexes) {\r\n            temporaryIndices.add(index);\r\n        }\r\n    }\r\n\r\n    @Override\r\n    protected void after() {\r\n        super.after();\r\n        if(temporaryIndices.size()>0) {\r\n            temporaryIndices.forEach(indexName -> {\r\n                try {\r\n                    esClientService().deleteIndex(indexName);\r\n                } catch (EsNotFoundException e) {\r\n                    // ignore, the index we wanted delete did not exist\r\n                }\r\n            });\r\n            esClientService().refresh();\r\n        }\r\n    }\r\n\r\n    public boolean isRunning() {\r\n        return running;\r\n    }\r\n\r\n    public EsRestClientService esRestClientService() {\r\n        return esRestClientService;\r\n    }\r\n\r\n    public EsClientService esClientService() {\r\n        return esClientService;\r\n    }\r\n}\r\n\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/372351876","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-372351876","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":372351876,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MjM1MTg3Ng==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2018-03-12T15:32:09Z","updated_at":"2018-03-12T15:32:09Z","author_association":"MEMBER","body":"@jeacott1 @jillesvangurp FYI I wrote this test-containers module for Elasticsearch: https://github.com/dadoonet/testcontainers-java-module-elasticsearch\r\n\r\nMight help as well.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/372482936","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-372482936","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":372482936,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MjQ4MjkzNg==","user":{"login":"jeacott1","id":16600100,"node_id":"MDQ6VXNlcjE2NjAwMTAw","avatar_url":"https://avatars3.githubusercontent.com/u/16600100?v=4","gravatar_id":"","url":"https://api.github.com/users/jeacott1","html_url":"https://github.com/jeacott1","followers_url":"https://api.github.com/users/jeacott1/followers","following_url":"https://api.github.com/users/jeacott1/following{/other_user}","gists_url":"https://api.github.com/users/jeacott1/gists{/gist_id}","starred_url":"https://api.github.com/users/jeacott1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeacott1/subscriptions","organizations_url":"https://api.github.com/users/jeacott1/orgs","repos_url":"https://api.github.com/users/jeacott1/repos","events_url":"https://api.github.com/users/jeacott1/events{/privacy}","received_events_url":"https://api.github.com/users/jeacott1/received_events","type":"User","site_admin":false},"created_at":"2018-03-12T22:24:27Z","updated_at":"2018-03-12T22:24:27Z","author_association":"NONE","body":"@dadoonet I have tried your test-containers module, but unfortunately until test-containers itself is fixed its unusable for me.  ref https://github.com/dadoonet/testcontainers-java-module-elasticsearch/issues/2","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413759124","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-413759124","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":413759124,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzc1OTEyNA==","user":{"login":"nitishgoyal13","id":12368831,"node_id":"MDQ6VXNlcjEyMzY4ODMx","avatar_url":"https://avatars3.githubusercontent.com/u/12368831?v=4","gravatar_id":"","url":"https://api.github.com/users/nitishgoyal13","html_url":"https://github.com/nitishgoyal13","followers_url":"https://api.github.com/users/nitishgoyal13/followers","following_url":"https://api.github.com/users/nitishgoyal13/following{/other_user}","gists_url":"https://api.github.com/users/nitishgoyal13/gists{/gist_id}","starred_url":"https://api.github.com/users/nitishgoyal13/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nitishgoyal13/subscriptions","organizations_url":"https://api.github.com/users/nitishgoyal13/orgs","repos_url":"https://api.github.com/users/nitishgoyal13/repos","events_url":"https://api.github.com/users/nitishgoyal13/events{/privacy}","received_events_url":"https://api.github.com/users/nitishgoyal13/received_events","type":"User","site_admin":false},"created_at":"2018-08-17T05:09:25Z","updated_at":"2018-08-17T05:09:25Z","author_association":"NONE","body":"Embedded elasticsearch is not supported anymore\r\n\r\nYou can use this maven dependency, it will start elasticsearch 6 cluster for you\r\n\r\n`<dependency>\r\n     <groupId>org.elasticsearch-6</groupId>\r\n     <artifactId>elasticsearch-embedded-cluster</artifactId>\r\n     <version>1.0-SNAPSHOT</version>\r\n</dependency>`\r\n\r\nYou can read more details on\r\nhttps://github.com/nitishgoyal13/elasticsearch-6-embedded-cluster","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/548913075","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-548913075","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":548913075,"node_id":"MDEyOklzc3VlQ29tbWVudDU0ODkxMzA3NQ==","user":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"created_at":"2019-11-01T19:04:17Z","updated_at":"2019-11-01T19:04:17Z","author_association":"CONTRIBUTOR","body":"[docs issue triage]","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/628864547","html_url":"https://github.com/elastic/elasticsearch/issues/21544#issuecomment-628864547","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21544","id":628864547,"node_id":"MDEyOklzc3VlQ29tbWVudDYyODg2NDU0Nw==","user":{"login":"debadair","id":362578,"node_id":"MDQ6VXNlcjM2MjU3OA==","avatar_url":"https://avatars1.githubusercontent.com/u/362578?v=4","gravatar_id":"","url":"https://api.github.com/users/debadair","html_url":"https://github.com/debadair","followers_url":"https://api.github.com/users/debadair/followers","following_url":"https://api.github.com/users/debadair/following{/other_user}","gists_url":"https://api.github.com/users/debadair/gists{/gist_id}","starred_url":"https://api.github.com/users/debadair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/debadair/subscriptions","organizations_url":"https://api.github.com/users/debadair/orgs","repos_url":"https://api.github.com/users/debadair/repos","events_url":"https://api.github.com/users/debadair/events{/privacy}","received_events_url":"https://api.github.com/users/debadair/received_events","type":"User","site_admin":false},"created_at":"2020-05-14T20:16:57Z","updated_at":"2020-05-14T20:16:57Z","author_association":"CONTRIBUTOR","body":"Fixed by: #55270","performed_via_github_app":null}]