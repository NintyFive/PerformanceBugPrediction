{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5324","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5324/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5324/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5324/events","html_url":"https://github.com/elastic/elasticsearch/issues/5324","id":28638484,"node_id":"MDU6SXNzdWUyODYzODQ4NA==","number":5324,"title":"Add support for \"missing\" to all bucket aggregations","user":{"login":"roytmana","id":2524911,"node_id":"MDQ6VXNlcjI1MjQ5MTE=","avatar_url":"https://avatars0.githubusercontent.com/u/2524911?v=4","gravatar_id":"","url":"https://api.github.com/users/roytmana","html_url":"https://github.com/roytmana","followers_url":"https://api.github.com/users/roytmana/followers","following_url":"https://api.github.com/users/roytmana/following{/other_user}","gists_url":"https://api.github.com/users/roytmana/gists{/gist_id}","starred_url":"https://api.github.com/users/roytmana/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roytmana/subscriptions","organizations_url":"https://api.github.com/users/roytmana/orgs","repos_url":"https://api.github.com/users/roytmana/repos","events_url":"https://api.github.com/users/roytmana/events{/privacy}","received_events_url":"https://api.github.com/users/roytmana/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":61,"created_at":"2014-03-03T17:18:28Z","updated_at":"2018-03-26T09:22:03Z","closed_at":"2015-07-23T08:16:36Z","author_association":"NONE","active_lock_reason":null,"body":"NEED: In many (if not majority cases) when present users with business analytics, the user would want to see numbers for complete data set. No matter how you aggregate it should present the same data with the same number of documents. Inability to handle \"missing\" values exclude those from analysis making analyzed data set incomplete and grand totals dependent on which field(s) the aggregation is done. It is impossible to explain to the users why the lower level totals do not add up to the upper level ones!  \n\nWORKAROUND: Currently field based bucket aggregations (term, range etc) have no way to aggregate missing values. The only way is to use missing aggregation on the same level and the same field as the term aggregation itself. It is easy enough when dealing with one level aggregations but if you have 2-3 level aggregation number of \"missing\" aggregations (and complete lower level aggregation to be repeated in them) mushrooms very quickly to the point that the query is huge, convoluted and not debuggable. It may affect performance  as well. Also fetched date needs to be heavily post-processed to extract multiple levels aggregation buckets from under various \"missing\" elements and put them inline with the regular aggregation values. Below please see a simple query to do 2 level aggregation with just one sum metrics\n\nPROPOSAL: I would suggest that any aggregation operating on a field should have a missing option. If missing config is specified, aggregation should accumulate missing values under that value and honor any nested aggregations within. It should never assume any value like 0 or _missing since it may clash with actual keys. If it is not specified the aggregation should skip missing values as it does now.\n\nThis approach makes it entirely compatible with existing logic and give developers complete control over whether to aggregate missing and under what key. In cases when it is not needed (and not specified) there will be no performance overhead. But when it needed it will work faster as we would not need to do missing aggregation and aggregations under it separately (same goes for \"other\" aggregation)\n\nTo be honest, I would love to see the same handling for \"other\" - documents that have not been included in aggregation due to the aggregation size constraints. Again the same rationale - ability to slice complete data set regardless of aggregation structure. It is just as needed as \"missing\" and just as troublesome to calculate but \nI could understand if you did not add it as it may be not compatible with your algorithms but  PLEASE PLEASE add \"missing\" handling at least\n\n```\n{\n      \"total\": {\n        \"sum\": {\n          \"field\": \"money.totals.obligationTotal\"\n        }\n      },\n      \"missing\": {\n        \"missing\": {\n          \"field\": \"division\"\n        },\n        \"aggs\": {\n          \"total\": {\n            \"sum\": {\n              \"field\": \"money.totals.obligationTotal\"\n            }\n          },\n          \"missing\": {\n            \"missing\": {\n              \"field\": \"fy\"\n            }\n          },\n          \"group\": {\n            \"terms\": {\n              \"field\": \"fy\",\n              \"order\": { \"_term\": \"asc\" }\n            },\n            \"aggs\": {\n              \"total\": {\n                \"sum\": {\n                  \"field\": \"money.totals.obligationTotal\"\n                }\n              }\n            }\n          }\n        }\n      },\n      \"group\": {\n        \"terms\": {\n          \"field\": \"division\",\n          \"order\": { \"_term\": \"asc\" },\n          size:100\n        },\n        \"aggs\": {\n          \"total\": {\n            \"sum\": {\n              \"field\": \"money.totals.obligationTotal\"\n            }\n          },\n          \"missing\": {\n            \"missing\": {\n              \"field\": \"fy\"\n            },\n            \"aggs\": {\n              \"total\": {\n                \"sum\": {\n                  \"field\": \"money.totals.obligationTotal\"\n                }\n              }\n            }\n          },\n          \"group\": {\n            \"terms\": {\n              \"field\": \"fy\",\n              \"order\": { \"_term\": \"asc\" }\n            },\n            \"aggs\": {\n              \"total\": {\n                \"sum\": {\n                  \"field\": \"money.totals.obligationTotal\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n```\n\ncc @uboness, @jpountz   \n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}