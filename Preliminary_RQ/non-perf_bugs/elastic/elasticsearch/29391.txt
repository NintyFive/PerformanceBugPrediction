{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29391","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29391/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29391/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29391/events","html_url":"https://github.com/elastic/elasticsearch/issues/29391","id":311559471,"node_id":"MDU6SXNzdWUzMTE1NTk0NzE=","number":29391,"title":"bucket_selector not working with bucket_script or derivative as variable","user":{"login":"aurimasplu","id":33485896,"node_id":"MDQ6VXNlcjMzNDg1ODk2","avatar_url":"https://avatars0.githubusercontent.com/u/33485896?v=4","gravatar_id":"","url":"https://api.github.com/users/aurimasplu","html_url":"https://github.com/aurimasplu","followers_url":"https://api.github.com/users/aurimasplu/followers","following_url":"https://api.github.com/users/aurimasplu/following{/other_user}","gists_url":"https://api.github.com/users/aurimasplu/gists{/gist_id}","starred_url":"https://api.github.com/users/aurimasplu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aurimasplu/subscriptions","organizations_url":"https://api.github.com/users/aurimasplu/orgs","repos_url":"https://api.github.com/users/aurimasplu/repos","events_url":"https://api.github.com/users/aurimasplu/events{/privacy}","received_events_url":"https://api.github.com/users/aurimasplu/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-04-05T10:41:18Z","updated_at":"2018-04-05T13:05:13Z","closed_at":"2018-04-05T13:05:13Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version** : 6.1.1-1\r\n\r\n**Plugins installed**: X-pack\r\n\r\n**JVM version** : java-1.8.0-openjdk-1.8.0.151-5.b12.el7_4.x86_64\r\n\r\n**OS version** : RHEL 7.4\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI want to use **bucket_selector** to remove buckets from the output based on the value generated by **bucket_script**. But it seems that **bucket_selector** does not find values in script. Using avg from same bucket works fine. Using **derivative** in **bucket_script** also works fine, which I suppose should be the same because derivative, bucket_script and bucket_selector all are parent pipeline aggregations.\r\nUsing derivative in bucket_selector also is not working and produces same error. \r\n\r\n**Steps to reproduce**:\r\n\r\nI make this query:\r\n\r\n```\r\n{\r\n\t\"size\": 0,\r\n\t\"_source\": [],\r\n\t\"query\": {\r\n\t\t\"bool\": {\r\n\t\t\t\"filter\": [{\r\n\t\t\t\t\t\"range\": {\r\n\t\t\t\t\t\t\"@timestamp\": {\r\n\t\t\t\t\t\t\t\"gte\": \"1522850000000\",\r\n\t\t\t\t\t\t\t\"lte\": \"1522850400000\",\r\n\t\t\t\t\t\t\t\"format\": \"epoch_millis\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}, {\r\n\t\t\t\t\t\"query_string\": {\r\n\t\t\t\t\t\t\"analyze_wildcard\": true,\r\n\t\t\t\t\t\t\"query\": \"_exists_:interface.ifHCInOctets\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t]\r\n\t\t}\r\n\t},\r\n\t\"aggs\": {\r\n\t\t\"DBF_Device\": {\r\n\t\t\t\"terms\": {\r\n\t\t\t\t\"field\": \"tag.agent_host\",\r\n\t\t\t\t\"size\": 100,\r\n\t\t\t\t\"order\": {\r\n\t\t\t\t\t\"_term\": \"desc\"\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\"aggs\": {\r\n\t\t\t\t\"DBF_Interface\": {\r\n\t\t\t\t\t\"terms\": {\r\n\t\t\t\t\t\t\"field\": \"tag.ifDescr\",\r\n\t\t\t\t\t\t\"size\": 100,\r\n\t\t\t\t\t\t\"order\": {\r\n\t\t\t\t\t\t\t\"_term\": \"desc\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"aggs\": {\r\n\t\t\t\t\t\t\"DBF_Metric\": {\r\n\t\t\t\t\t\t\t\"date_histogram\": {\r\n\t\t\t\t\t\t\t\t\"interval\": \"5m\",\r\n\t\t\t\t\t\t\t\t\"field\": \"@timestamp\"\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"aggs\": {\r\n\t\t\t\t\t\t\t\t\"DBF_Metric_AVG\": {\r\n\t\t\t\t\t\t\t\t\t\"avg\": {\r\n\t\t\t\t\t\t\t\t\t\t\"field\": \"interface.ifHCInOctets\",\r\n\t\t\t\t\t\t\t\t\t\t\"script\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\"inline\": \"(_value*8)/300\"\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"DBF_Metric_DER\": {\r\n\t\t\t\t\t\t\t\t\t\"derivative\": {\r\n\t\t\t\t\t\t\t\t\t\t\"buckets_path\": \"DBF_Metric_AVG\"\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"DBF_Speed\": {\r\n\t\t\t\t\t\t\t\t\t\"max\": {\r\n\t\t\t\t\t\t\t\t\t\t\"field\": \"interface.ifHighSpeed\",\r\n\t\t\t\t\t\t\t\t\t\t\"script\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\"inline\": \"_value*1000000\"\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"DBF_Metric_Percent\": {\r\n\t\t\t\t\t\t\t\t\t\"bucket_script\": {\r\n\t\t\t\t\t\t\t\t\t\t\"buckets_path\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\"my_var1\": \"DBF_Metric_DER\",\r\n\t\t\t\t\t\t\t\t\t\t\t\"my_var2\": \"DBF_Speed\"\r\n\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\"script\": \"(params.my_var1 * 100)/ params.my_var2\"\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\"DBF_Bucket_filter\": {\r\n\t\t\t\t\t\t\t\t\t\t\"bucket_selector\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\"buckets_path\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\"my_var3\": \"DBF_Metric_Percent\"\r\n\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\t\"script\": \"params.my_var3 > 100000000\"\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n\r\nAnd I get this output:\r\n\r\n```\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [],\r\n        \"type\": \"search_phase_execution_exception\",\r\n        \"reason\": \"\",\r\n        \"phase\": \"fetch\",\r\n        \"grouped\": true,\r\n        \"failed_shards\": [],\r\n        \"caused_by\": {\r\n            \"type\": \"script_exception\",\r\n            \"reason\": \"runtime error\",\r\n            \"script_stack\": [\r\n                \"params.my_var3 > 100000000\",\r\n                \"      ^---- HERE\"\r\n            ],\r\n            \"script\": \"params.my_var3 > 100000000\",\r\n            \"lang\": \"painless\",\r\n            \"caused_by\": {\r\n                \"type\": \"null_pointer_exception\",\r\n                \"reason\": null\r\n            }\r\n        }\r\n    },\r\n    \"status\": 503\r\n}\r\n```\r\n\r\n\r\nQuery works fine if I remove bucket_selector part. If in bucket_selector I replace DBF_Metric_Percent with DBF_Speed query also works fine.","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}