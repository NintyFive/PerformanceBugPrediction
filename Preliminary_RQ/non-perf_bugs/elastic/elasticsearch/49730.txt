{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49730","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49730/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49730/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49730/events","html_url":"https://github.com/elastic/elasticsearch/issues/49730","id":530469566,"node_id":"MDU6SXNzdWU1MzA0Njk1NjY=","number":49730,"title":"Transform job messages broken after rolling upgrade","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1524022086,"node_id":"MDU6TGFiZWwxNTI0MDIyMDg2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.5.0","name":"v7.5.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-11-29T19:31:07Z","updated_at":"2019-12-12T09:09:21Z","closed_at":"2019-12-02T14:17:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**affected version:** Elasticsearch version 7.5.0\r\n\r\nIf a cluster is upgraded to 7.5.0 using rolling upgrade while a transform is in `STARTED` state, it's possible that after the upgrade audit logging seems to disappear. Audit logs, called \"job messages\" in the Transform UI, are not shown due to a broken mapping. Because the broken mapping happens on the backend, this is a backend issue. For further details look below.\r\n\r\n**Note: This bug does not affect transform functionality.**\r\n\r\n## Quick Fix\r\n\r\n### Solution 1 \r\n\r\nUpgrade to 7.5.1 when available. 7.5.1 permanently fixes the problem and creates `.transform-notifications-000002`with proper mappings to repair broken 7.5.0 installations.\r\n\r\n### Solution 2\r\n\r\nDelete the audit index, so it gets recreated automatically: `curl -XDELETE \"http://localhost:9200/.transform-notifications-000001\"` or `DELETE .transform-notifications-000001` (kibana dev console)\r\n\r\nNote: audit logs for the time of the upgrade till the deletion of the audit index get lost. You might want to inspect the index and/or re-index it before deletion.\r\n\r\n## Details\r\n\r\nThe transform audit index uses an index template so that the audit index gets created at the 1st write. Due to the rename to transform the audit index got renamed from ` .data-frame-notifications-1` to `.transform-notifications-000001`. The index template gets installed by a TemplateUpgradeService used in the plugin. The upgrade service however only upgrades templates when running on the master node. In a rolling upgrade scenario the master node might get upgraded in the middle or as it's suggested: last. In case a transform writes a audit message in a mixed cluster running on a node that is already upgraded to 7.5 the template might not be available yet, in which case the audit index gets created with defaults. Additionally the read alias used by the UI does not get installed. Due to the incompatible mapping however, it's not sufficient to only add the alias.\r\n\r\n## Code fix\r\n\r\nFor 7.5.1 we will ensure that the index template gets installed before a transform task can write to the audit index. When a job gets re-assigned to an upgraded node > 7.5.1 we already do a check for the transform internal index. This working solution needs to be applied to the audit index, too.","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}