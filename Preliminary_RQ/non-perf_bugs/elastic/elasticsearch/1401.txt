{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1401","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1401/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1401/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1401/events","html_url":"https://github.com/elastic/elasticsearch/issues/1401","id":1928486,"node_id":"MDU6SXNzdWUxOTI4NDg2","number":1401,"title":"Synonym filter not working correctly for multi-term synonyms.","user":{"login":"lukas-vlcek","id":205174,"node_id":"MDQ6VXNlcjIwNTE3NA==","avatar_url":"https://avatars2.githubusercontent.com/u/205174?v=4","gravatar_id":"","url":"https://api.github.com/users/lukas-vlcek","html_url":"https://github.com/lukas-vlcek","followers_url":"https://api.github.com/users/lukas-vlcek/followers","following_url":"https://api.github.com/users/lukas-vlcek/following{/other_user}","gists_url":"https://api.github.com/users/lukas-vlcek/gists{/gist_id}","starred_url":"https://api.github.com/users/lukas-vlcek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukas-vlcek/subscriptions","organizations_url":"https://api.github.com/users/lukas-vlcek/orgs","repos_url":"https://api.github.com/users/lukas-vlcek/repos","events_url":"https://api.github.com/users/lukas-vlcek/events{/privacy}","received_events_url":"https://api.github.com/users/lukas-vlcek/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2011-10-17T13:39:13Z","updated_at":"2013-02-18T22:41:12Z","closed_at":"2013-02-18T22:41:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I was trying to get my head around new multi term synonyms (LUCENE-3233) but it does not seem to work correctly based on my expectations. It seems that both synonym forms **[a b,c]** and **[a b => c]** suffer from specific issues. Both cases are discussed in detail below.\n# Type of synonym rule: [a b => c]\n\nLet's start with script that defines one simple multi-term synonym: \"application server => eap\". So whenever `application server` multi-term is found it is replaced with `eap`:\n\n```\ncat <ES_HOME>/config/analysis/synonym.txt\napplication server => eap\n```\n\nNow, let's use the following repro script:\n\n```\ncurl -X DELETE 'localhost:9200/test/'\ncurl -X PUT 'localhost:9200/test/' -d '\n{\n  \"settings\" : {\n    \"index\" : {\n      \"number_of_shards\" : 1,\n      \"number_of_replicas\" : 0,\n      \"analysis\" : {\n        \"analyzer\" : {\n          \"ta\" : {\n            \"type\" : \"custom\",\n            \"tokenizer\" : \"standard\",\n            \"filter\" : [ \"standard\", \"word_delimiter\", \"lowercase\", \"synonym\", \"stop\", \"kstem\" ]\n          }\n        },\n        \"filter\" : {\n          \"synonym\" : {\n            \"type\" : \"synonym\",\n            \"synonyms_path\" : \"analysis/synonym.txt\"\n          }\n        }\n      }\n    }\n  }\n}'\n\ncurl -X PUT 'localhost:9200/test/test/_mapping' -d '\n{\n  \"test\" : {\n    \"properties\" : {\n      \"plain\" : { \"type\" : \"string\", \"store\" : \"yes\", \"term_vector\" : \"no\", \"analyzer\" : \"ta\" },\n      \"fvh\" : { \"type\" : \"string\", \"store\" : \"yes\", \"term_vector\" : \"with_positions_offsets\", \"analyzer\" : \"ta\" }\n    },\n    \"_all\" : { \"analyzer\" : \"ta\" }\n  }\n}'\n\ncurl -X GET 'localhost:9200/_cluster/health?wait_for_status=green&timeout=5s'\n\ncurl -X POST 'localhost:9200/test/test' -d '{\"plain\":\"Hello EAP World!\",\"fvh\":\"Hello EAP World!\"}'\ncurl -X POST 'localhost:9200/test/test' -d '{\"plain\":\"This is one really nice application server.\",\"fvh\":\"This is one really nice application server.\"}'\ncurl -X POST 'localhost:9200/test/test' -d '{\"plain\":\"Tomcat server is down.\",\"fvh\":\"Tomcat server is down.\"}'\ncurl -X POST 'localhost:9200/test/test' -d '{\"plain\":\"Application of drugs.\",\"fvh\":\"Application of drugs.\"}'\ncurl -X POST 'localhost:9200/test/test' -d '{\"plain\":\"This is ApplicationServer and EAP world.\",\"fvh\":\"This is ApplicationServer and EAP world.\"}'\n\ncurl -X POST 'localhost:9200/test/_refresh'\n\necho \"=======================\"\necho \"application server\"\ncurl 'localhost:9200/test/_search?pretty=1' -d '\n{\n  \"query\":{\"query_string\":{\"query\":\"application server\"}},\n  \"fields\" : [ \"plain\",\"fvh\"],\n  \"highlight\" : { \"fields\" : { \"plain\" : {}, \"fvh\" : { \"number_of_fragments\":0 }}}\n}'\n\necho \"=======================\"\necho \"eap\"\ncurl 'localhost:9200/test/_search?pretty=1' -d '\n{\n  \"query\":{\"query_string\":{\"query\":\"eap\"}},\n  \"fields\" : [\"plain\",\"fvh\"],\n  \"highlight\" : { \"fields\" : { \"plain\" : {}, \"fvh\" : { \"number_of_fragments\":0 }}}\n}'\n\necho \"=======================\"\necho \"server\"\ncurl 'localhost:9200/test/_search?pretty=1' -d '\n{\n  \"query\":{\"query_string\":{\"query\":\"server\"}},\n  \"fields\" : [\"plain\",\"fvh\"],\n  \"highlight\" : { \"fields\" : { \"plain\" : {}, \"fvh\" : { \"number_of_fragments\":0 }}}\n}'\n```\n## Problematic Queries\n### Query: application server\n\nNo documents containing `application server` match. Instead I get only documents matching individual terms `application` or `server`. Analyzer itself works correctly, see:\n    curl 'localhost:9200/test/_analyze?pretty=1&text=application+server&analyzer=ta'\n\nCan the problem be in query parsing then?\n### Query: eap\n\nI am getting incorrect highlighting for two documents.\n\nOriginal text: `This is ApplicationServer and EAP world.`\nHighlighted text: `This is <em>Application</em>Server and <em>EAP</em> world.`\n\nOriginal text: `This is one really nice application server.`\nHighlighted text: `This is one really nice <em>application</em> server.`\n\n**Problem:** In both cases the word `server` should have been highlighted as well.\n# Type of synonym rule: [a b, c]\n\nLet's take the same script except modify definition of `synonym` analysis.\n\n```\n....\n        \"filter\" : {\n          \"synonym\" : {\n            \"type\" : \"synonym\",\n            \"synonyms\" : [ \"application server, eap\" ]\n          }\n        }\n....\n```\n\nOr change content of the `<ES_HOME>/conf/analysis/synonym.txt` file accordingly.\n\nRun the same repro script.\n## Problematic Queries\n### Query: application server\n\nOriginal text: `This is ApplicationServer and EAP world.`\nHighlighted text: `This is <em>Application</em><em>Server</em> and <em>EAP</em> <em>world</em>.`\n\nOriginal text: `Hello EAP World!`\nHighlighted text: `Hello <em>EAP</em> <em>World</em>!`\n\nIn both cases the word `world` should not be highlighted.\n\nAlso both documents containing only individual terms from the multi-term synonym match as well (`application` or 'server'). But this time it is probably correct according to analyzer output:\n\n```\ncurl 'localhost:9200/test/_analyze?pretty=1&text=application+server&analyzer=ta'\n```\n\nHowever, it would be great if there is an option how to avoid matching documents having partial synonym phrases only.\n### Query: eap\n\nThe same output (and issues) as for the previous query.\n### Query: server\n\nOriginal text: `This is ApplicationServer and EAP world.`\nHighlighted text: `This is Application<em>Server</em> and EAP <em>world</em>.`\n\nOriginal text: `Hello EAP World!`\nHighlighted text: `Hello EAP <em>World</em>!`\n\n**Problem**: the word `world` should not he highlighted.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}