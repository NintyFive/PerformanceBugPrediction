{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19900","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19900/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19900/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19900/events","html_url":"https://github.com/elastic/elasticsearch/issues/19900","id":170297442,"node_id":"MDU6SXNzdWUxNzAyOTc0NDI=","number":19900,"title":"ES 2.3.3 geo_polygon query across the prime meridian cannot find points near the prime meridian","user":{"login":"laoyaosniper","id":3031664,"node_id":"MDQ6VXNlcjMwMzE2NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/3031664?v=4","gravatar_id":"","url":"https://api.github.com/users/laoyaosniper","html_url":"https://github.com/laoyaosniper","followers_url":"https://api.github.com/users/laoyaosniper/followers","following_url":"https://api.github.com/users/laoyaosniper/following{/other_user}","gists_url":"https://api.github.com/users/laoyaosniper/gists{/gist_id}","starred_url":"https://api.github.com/users/laoyaosniper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/laoyaosniper/subscriptions","organizations_url":"https://api.github.com/users/laoyaosniper/orgs","repos_url":"https://api.github.com/users/laoyaosniper/repos","events_url":"https://api.github.com/users/laoyaosniper/events{/privacy}","received_events_url":"https://api.github.com/users/laoyaosniper/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-08-09T23:47:47Z","updated_at":"2018-06-13T15:39:17Z","closed_at":"2018-06-13T15:39:16Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.3\n\n**Plugins installed**: nothing\n\n**JVM version**: 1.8.0_77\n\n**OS version**: OS X El Captain 10.11.5 \n\n**Description of the problem including expected versus actual behavior**:\nI found a bug when testing geo polygon search across the prime meridian (the 0 longitude). It cannot find the geo point inside the polygon whose longitude is smaller than 1.4 on the eastern hemisphere (positive longitude). Also, it's a regression because those points can be found on ES 1.4.4.\n\n**Steps to reproduce**:\n1. Create an index with mapping:\n   \n   ```\n   PUT /geo_polygon\n   {\n       \"settings\" : {\n           \"index\" : {\n               \"number_of_shards\" : 1, \n               \"number_of_replicas\" : 0\n           }\n       },\n   \n     \"mappings\": {\n       \"my_type\": {\n         \"properties\": {\n           \"location\": {\n             \"type\": \"geo_point\"\n           }\n         }\n       }\n     }\n   }\n   ```\n2. Put a list of points on the map. I put all the points on the north hemisphere to eliminate the possible affect from latitude. \n   \n   ```\n   PUT /geo_polygon/my_type/1\n   {\n     \"text\": \"Point on the prime meridian\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": 0\n     }\n   }\n   \n   PUT /geo_polygon/my_type/2\n   {\n     \"text\": \"Point very close to the prime meridian, eastern hemisphere\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": 0.1\n     }\n   }\n   \n   PUT /geo_polygon/my_type/3\n   {\n     \"text\": \"Point very close to the prime meridian, western hemisphere\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": -0.1\n     }\n   }\n   \n   PUT /geo_polygon/my_type/4\n   {\n     \"text\": \"Point close to the prime meridian, eastern hemisphere\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": 1.4\n     }\n   }\n   \n   PUT /geo_polygon/my_type/5\n   {\n     \"text\": \"Point close to the prime meridian, western hemisphere\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": -1.4\n     }\n   }\n   \n   PUT /geo_polygon/my_type/6\n   {\n     \"text\": \"Point close to the prime meridian on eastern hemisphere, different latitude\",\n     \"location\": { \n       \"lat\": 25,\n       \"lon\": 1.4\n     }\n   }\n   \n   PUT /geo_polygon/my_type/7\n   {\n     \"text\": \"Point close to the prime meridian on western hemisphere, different latitude\",\n     \"location\": { \n       \"lat\": 25,\n       \"lon\": -1.4\n     }\n   }\n   \n   PUT /geo_polygon/my_type/8\n   {\n     \"text\": \"Point not too far from the prime meridian\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": 1.5\n     }\n   }\n   \n   PUT /geo_polygon/my_type/9\n   {\n     \"text\": \"Point far from the prime meridian\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": 20\n     }\n   }\n   \n   PUT /geo_polygon/my_type/10\n   {\n     \"text\": \"Point quite far from the prime meridian\",\n     \"location\": { \n       \"lat\": 30,\n       \"lon\": 90\n     }\n   }\n   ```\n3. Search in the following polygon:\n   \n   ```\n   GET /geo_polygon\n   {\n       \"query\": {\n           \"bool\" : {\n               \"filter\" : {\n                   \"geo_polygon\" : {\n                       \"location\" : {\n                           \"points\" : [\n                               {\"lat\" : 45, \"lon\" : 45},\n                               {\"lat\" : 45, \"lon\" : -45},\n                               {\"lat\" : 10, \"lon\" : 0}\n                           ]\n                       }\n                   }\n               }\n           }\n       }\n   }\n   ```\n\nExpected: points 1~9 should be found. The very far point 10 shouldn't be returned.\nActual: only point 3, 5, 7, 8, 9 are found, which have the following characteristic:\n1. On the western hemisphere (lon < 0)\n2. Or, the longitude is larger than 1.5.\n\nTried the same thing on ES 1.4 cluster and it could find point 1~9 correctly. \n\nCurrently I could mitigate this problem by splitting the polygon along the prime meridian and do a conjunctive search like the request below. It could find point 1~9 on ES 2.3.3 stack.\n\n``````\n```\n{\n    \"query\": {\n        \"bool\" : {\n            \"should\" : [\n                {\n                    \"bool\": {\n                        \"filter\" : {\n                            \"geo_polygon\" : {\n                                \"location\" : {\n                                    \"points\" : [\n                                        {\"lat\" : 45, \"lon\" : 45},\n                                        {\"lat\" : 45, \"lon\" : 0},\n                                        {\"lat\" : 10, \"lon\" : 0}\n                                    ]\n                                }\n                            }\n                        }\n                    }\n                },\n                {\n                    \"bool\": {\n                        \"filter\" : {\n                            \"geo_polygon\" : {\n                                \"location\" : {\n                                    \"points\" : [\n                                        {\"lat\" : 45, \"lon\" : 0},\n                                        {\"lat\" : 45, \"lon\" : -45},\n                                        {\"lat\" : 10, \"lon\" : 0}\n                                    ]\n                                }\n                            }\n                        }\n                    }\n                }\n            ]\n        }\n    }\n}\n```\n``````\n\nInterestingly, I tried to mirror the polygon above to the south hemisphere and search in the mirrored hemisphere. Instead of find nothing, I found points 1, 2, 4, 6, 8 and 9, which are all the points on non-western hemisphere.\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}