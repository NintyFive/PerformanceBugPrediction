{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28793","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28793/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28793/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28793/events","html_url":"https://github.com/elastic/elasticsearch/issues/28793","id":299522644,"node_id":"MDU6SXNzdWUyOTk1MjI2NDQ=","number":28793,"title":"Terms Aggregation: Java client returns different result from HTTP API","user":{"login":"mvreijn","id":8568697,"node_id":"MDQ6VXNlcjg1Njg2OTc=","avatar_url":"https://avatars3.githubusercontent.com/u/8568697?v=4","gravatar_id":"","url":"https://api.github.com/users/mvreijn","html_url":"https://github.com/mvreijn","followers_url":"https://api.github.com/users/mvreijn/followers","following_url":"https://api.github.com/users/mvreijn/following{/other_user}","gists_url":"https://api.github.com/users/mvreijn/gists{/gist_id}","starred_url":"https://api.github.com/users/mvreijn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvreijn/subscriptions","organizations_url":"https://api.github.com/users/mvreijn/orgs","repos_url":"https://api.github.com/users/mvreijn/repos","events_url":"https://api.github.com/users/mvreijn/events{/privacy}","received_events_url":"https://api.github.com/users/mvreijn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-02-22T21:55:29Z","updated_at":"2018-02-22T22:49:13Z","closed_at":"2018-02-22T22:49:13Z","author_association":"NONE","active_lock_reason":null,"body":"\r\nFor reference, I have an open question on Stackoverflow regarding this issue: https://stackoverflow.com/questions/48885306/elastic-java-client-returns-different-result-from-http-api\r\n\r\n<!-- Bug report -->\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 5.6.7, Build: 4669214/2018-01-25T21:14:50.776Z, JVM: 1.8.0_162\r\n\r\n**Plugins installed**: []\r\nnone\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_162\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_162-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.162-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): \r\nLinux nivo-a-idv 4.4.114-94.11-default #1 SMP Thu Feb 1 19:28:26 UTC 2018 (4309ff9) x86_64 x86_64 x86_64 GNU/Linux (SLES12SP3)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nExecuting a term aggregation search using the Java client yields a result without buckets, while the same query executed using the HTTP API (via curl) yields a result which does contain buckets. \r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Indexes are created by logstash using default settings\r\n 2. Execute a terms aggregation query (content below) using curl -XPOST http://localhost:9200/logstash-*/logs/_search -d'{...}'\r\n 3. Result contains one or more buckets for different loglevels\r\n 4. Execute the same query using the Java client (using SearchTemplateBuilder)\r\n 5. Result does not contain any buckets\r\n\r\n**Provide logs (if relevant)**:\r\nQuery content:\r\n`{\r\n  \"from\" : 0,\r\n  \"size\" : 0,\r\n  \"sort\" : [\r\n    {\r\n      \"@timestamp\" : {\r\n        \"order\" : \"desc\"\r\n      }\r\n    }\r\n  ],\r\n  \"aggregations\" : {\r\n    \"level\" : {\r\n      \"terms\" : {\r\n        \"field\" : \"level.keyword\",\r\n        \"size\" : 10,\r\n        \"min_doc_count\" : 1,\r\n        \"shard_min_doc_count\" : 0,\r\n        \"show_term_doc_count_error\" : false,\r\n        \"order\" : [\r\n          {\r\n            \"_count\" : \"desc\"\r\n          },\r\n          {\r\n            \"_term\" : \"asc\"\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}`\r\n\r\nQuery result from curl:\r\n`{\"took\":1,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"skipped\":0,\"failed\":0},\"hits\":{\"total\":11194,\"max_score\":0.0,\"hits\":[]},\"aggregations\":{\"level\":{\"doc_count_error_upper_bound\":0,\"sum_other_doc_count\":0,\"buckets\":[{\"key\":\"INFO\",\"doc_count\":9069},{\"key\":\"ERROR\",\"doc_count\":1117},{\"key\":\"WARN\",\"doc_count\":1008}]}}}`\r\n\r\nQuery result from Java:\r\n`{\"took\":2,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"skipped\":0,\"failed\":0},\"hits\":{\"total\":11194,\"max_score\":0.0,\"hits\":[]},\"aggregations\":{\"level\":{\"doc_count_error_upper_bound\":0,\"sum_other_doc_count\":0,\"buckets\":[]}}}`","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}