{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10948","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10948/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10948/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10948/events","html_url":"https://github.com/elastic/elasticsearch/issues/10948","id":72977060,"node_id":"MDU6SXNzdWU3Mjk3NzA2MA==","number":10948,"title":"Function score query fails with field_value_factor on not (yet) existing field","user":{"login":"tschubotz","id":1380529,"node_id":"MDQ6VXNlcjEzODA1Mjk=","avatar_url":"https://avatars1.githubusercontent.com/u/1380529?v=4","gravatar_id":"","url":"https://api.github.com/users/tschubotz","html_url":"https://github.com/tschubotz","followers_url":"https://api.github.com/users/tschubotz/followers","following_url":"https://api.github.com/users/tschubotz/following{/other_user}","gists_url":"https://api.github.com/users/tschubotz/gists{/gist_id}","starred_url":"https://api.github.com/users/tschubotz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tschubotz/subscriptions","organizations_url":"https://api.github.com/users/tschubotz/orgs","repos_url":"https://api.github.com/users/tschubotz/repos","events_url":"https://api.github.com/users/tschubotz/events{/privacy}","received_events_url":"https://api.github.com/users/tschubotz/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2015-05-04T09:54:39Z","updated_at":"2018-02-14T13:39:33Z","closed_at":"2015-09-01T09:05:30Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nMy ES function score query contains several different functions based on a set of different fields. I'm having problems with field_value_factor on not existing fields. \nI'm not sure if that's expected behavior or a bug in ES. \nOn the elasticsearch Google group, nobody had an idea, so any help is appreciated.\n\nA minimal example on how to reproduce the problem:\n\nExample document:\n\n```\ncurl -XPOST \"http://localhost:9200/blog/page/1?pretty\" -d '\n{\n  \"author\": \"tobias\",\n  \"content\": \"Great\",\n  \"views\": 1\n}'\n```\n\nA search request, that boosts based on the function score looks like that:\n\n```\ncurl -XPOST \"http://localhost:9200/blog/_search\" -d '\n{\n  \"query\": {\n    \"function_score\": {\n      \"functions\": [\n        {\n          \"field_value_factor\": {\n            \"field\": \"views\",\n            \"modifier\": \"log2p\"\n          }\n        }\n      ]\n    }\n  }\n}'\n```\n\nEverything is fine until this point.\nWhen I change the \"field\" param to \"likes\", the requests fails:\n\n```\ncurl -XPOST \"http://localhost:9200/blog/_search\" -d '\n{\n  \"query\": {\n    \"function_score\": {\n      \"functions\": [\n        {\n          \"field_value_factor\": {\n            \"field\": \"likes\",\n            \"modifier\": \"log2p\"\n          }\n        }\n      ]\n    }\n  }\n}'\n```\n\n-> `ElasticsearchException[Unable to find a field mapper for field [likes]`\n\n\"likes\" doesn't exist yet in the \"page\" document type, but it might exist in the future. Or there could be another type \"page2\", where the \"likes\" field exists, and I need to query both \"page\" and \"page2\" in 1 request.\n\nWhat I tried, is to put an exist filter beforehand, however, the error remains the same.\n\n```\ncurl -XPOST \"http://localhost:9200/blog/_search\" -d '\n{\n    \"query\": {\n        \"function_score\": {\n            \"functions\": [\n                {\n                    \"filter\": {\n                        \"exists\": {\n                            \"field\": \"likes\"\n                        }\n                    },\n                    \"field_value_factor\": {\n                        \"field\": \"likes\"\n                    }\n                }\n            ]\n        }\n    }\n}'\n```\n\n-> `ElasticsearchException[Unable to find a field mapper for field [likes]`\n\nIs this a bug or expected bahavior?\nI would expect ES to just skip the function, in case the \"exists\" filter evaluates to False or the field doesn't exist. \n\nThe error originates from `FieldValueFactorFunctionParser.java` (line 89), in `FieldValueFactorFunctionParser.parse`. \nIs there really a need to check for the existence of all fields during parsing? \n\nWith other function types, there is no problem, so apparently this parsing is not performed. E.g. the following works without an error:\n\n```\ncurl -XPOST \"http://localhost:9200/blog/_search\" -d '\n{\n  \"query\": {\n    \"function_score\": {\n      \"functions\": [\n        {\n            \"filter\": {\n                \"range\": {\"likes\": {\"from\": 1}}\n            }, \n            \"weight\": 1.5\n        }\n      ]\n    }\n  }\n}'\n```\n\nAny ideas?\n\nPlease let me know, if you need further information.\n\nBest regards,\nTobias\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}