[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/458937657","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-458937657","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":458937657,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1ODkzNzY1Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-30T13:10:01Z","updated_at":"2019-01-30T13:10:01Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/458948861","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-458948861","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":458948861,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1ODk0ODg2MQ==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2019-01-30T13:46:24Z","updated_at":"2019-01-30T13:46:24Z","author_association":"CONTRIBUTOR","body":"relevant logs\r\n```\r\nCaused by: org.elasticsearch.client.ResponseException: method [DELETE], host [http://127.0.0.1:9200], URI [/someindex], status line [HTTP/1.1 400 Bad Request]\r\n{\"error\":{\"root_cause\":[{\"type\":\"snapshot_in_progress_exception\",\"reason\":\"Cannot delete indices that are being snapshotted: [[someindex/TYlngLbTQXWFygHGb5qQGA]]. Try again after snapshot finishes or cancel the currently running snapshot.\"}],\"type\":\"snapshot_in_progress_exception\",\"reason\":\"Cannot delete indices that are being snapshotted: [[someindex/TYlngLbTQXWFygHGb5qQGA]]. Try again after snapshot finishes or cancel the currently running snapshot.\"},\"status\":400}\r\n\tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:309)\r\n\tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:294)\r\n\tat org.apache.http.concurrent.BasicFuture.completed(BasicFuture.java:119)\r\n\tat org.apache.http.impl.nio.client.DefaultClientExchangeHandlerImpl.responseCompleted(DefaultClientExchangeHandlerImpl.java:177)\r\n\tat org.apache.http.nio.protocol.HttpAsyncRequestExecutor.processResponse(HttpAsyncRequestExecutor.java:436)\r\n\tat org.apache.http.nio.protocol.HttpAsyncRequestExecutor.inputReady(HttpAsyncRequestExecutor.java:326)\r\n\tat org.apache.http.impl.nio.DefaultNHttpClientConnection.consumeInput(DefaultNHttpClientConnection.java:265)\r\n\tat org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:81)\r\n\tat org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:39)\r\n\tat org.apache.http.impl.nio.reactor.AbstractIODispatch.inputReady(AbstractIODispatch.java:114)\r\n\tat org.apache.http.impl.nio.reactor.BaseIOReactor.readable(BaseIOReactor.java:162)\r\n\tat org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvent(AbstractIOReactor.java:337)\r\n\tat org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvents(AbstractIOReactor.java:315)\r\n\tat org.apache.http.impl.nio.reactor.AbstractIOReactor.execute(AbstractIOReactor.java:276)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480720413","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-480720413","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":480720413,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDcyMDQxMw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T07:41:56Z","updated_at":"2019-04-08T07:46:14Z","author_association":"MEMBER","body":"This is still happening in `master` and easily reproducible with:\r\n\r\n```\r\n  2> REPRODUCE WITH: ./gradlew :x-pack:plugin:security:unitTest -Dtests.seed=3BD2CC63823C26E0 -Dtests.class=org.elasticsearch.integration.ClusterPrivilegeTests -Dtests.method=\"testThatSnapshotAndRestore\" -Dtests.security.manager=true -Dtests.locale=ewo -Dtests.timezone=America/St_Thomas -Dcompiler.java=12 -Druntime.java=12\r\nERROR   6.09s | ClusterPrivilegeTests.testThatSnapshotAndRestore <<< FAILURES!\r\n   > Throwable #1: org.elasticsearch.client.ResponseException: method [PUT], host [http://127.0.0.1:9200], URI [/_snapshot/my-repo/my-snapshot-d], status line [HTTP/1.1 503 Service Unavailable]\r\n   > {\"error\":{\"root_cause\":[{\"type\":\"concurrent_snapshot_execution_exception\",\"reason\":\"[my-repo:my-snapshot-d]  a snapshot is already running\"}],\"type\":\"concurrent_snapshot_execution_exception\",\"reason\":\"[my-repo:my-snapshot-d]  a snapshot is already running\"},\"status\":503}\r\n   >    at __randomizedtesting.SeedInfo.seed([3BD2CC63823C26E0:9E55B86B524C705F]:0)\r\n   >    at org.elasticsearch.client.RestClient.convertResponse(RestClient.java:260)\r\n   >    at org.elasticsearch.client.RestClient.performRequest(RestClient.java:238)\r\n   >    at org.elasticsearch.client.RestClient.performRequest(RestClient.java:212)\r\n   >    at org.elasticsearch.integration.AbstractPrivilegeTestCase.assertAccessIsAllowed(AbstractPrivilegeTestCase.java:34)\r\n   >    at org.elasticsearch.integration.AbstractPrivilegeTestCase.assertAccessIsAllowed(AbstractPrivilegeTestCase.java:45)\r\n   >    at org.elasticsearch.integration.ClusterPrivilegeTests.testThatSnapshotAndRestore(ClusterPrivilegeTests.java:170)\r\n   >    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n   >    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n   >    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n   >    at java.base/java.lang.reflect.Method.invoke(Method.java:567)\r\n   >    at java.base/java.lang.Thread.run(Thread.java:835)\r\n```\r\n\r\ntakes like 10 runs on average with this seed. I'm looking into this now, seems like it could be a race between the cluster state check and what the transport API returns where the transport reports SUCCESS before the snapshot is fully cleared from the CS.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480726957","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-480726957","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":480726957,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDcyNjk1Nw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T08:01:36Z","updated_at":"2019-04-08T08:01:36Z","author_association":"MEMBER","body":"Yea the above seems about right, the state reported is success but the CS still has the success entry in it in some cases which leads to this failure.\r\n\r\n```diff\r\nindex 257a0b77692..3a754c7f333 100644\r\n--- a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\r\n+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\r\n@@ -275,7 +275,7 @@ public class SnapshotsService extends AbstractLifecycleComponent implements Clus\r\n                         \"cannot snapshot while a snapshot deletion is in-progress\");\r\n                 }\r\n                 SnapshotsInProgress snapshots = currentState.custom(SnapshotsInProgress.TYPE);\r\n-                if (snapshots == null || snapshots.entries().isEmpty()) {\r\n+                if (snapshots == null || snapshots.entries().stream().noneMatch(e -> e.state().completed() == false)) {\r\n                     // Store newSnapshot here to be processed in clusterStateProcessed\r\n                     List<String> indices = Arrays.asList(indexNameExpressionResolver.concreteIndexNames(currentState,\r\n                                                         request.indicesOptions(), request.indices()));\r\n```\r\n\r\nfixes it practically. I'll open a PR with it shortly as soon as I have worked through the implications and made sure it can't get us into a broken state.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480771413","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-480771413","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":480771413,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDc3MTQxMw==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T10:13:29Z","updated_at":"2019-04-08T10:13:29Z","author_association":"MEMBER","body":"Another instance with the same error:\r\n\r\n```\r\norg.elasticsearch.client.ResponseException: method [PUT], host [http://127.0.0.1:9200], URI [/_snapshot/my-repo/my-snapshot-d], status line [HTTP/1.1 503 Service Unavailable]\r\n\r\n{\"error\":{\"root_cause\":[{\"type\":\"concurrent_snapshot_execution_exception\",\"reason\":\"[my-repo:my-snapshot-d]  a snapshot is already running\"}],\"type\":\"concurrent_snapshot_execution_exception\",\"reason\":\"[my-repo:my-snapshot-d]  a snapshot is already running\"},\"status\":503}\r\n```\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+release-tests/653/console\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480771758","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-480771758","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":480771758,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDc3MTc1OA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T10:14:36Z","updated_at":"2019-04-08T10:14:36Z","author_association":"MEMBER","body":"Fix incoming in #40943 :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/480828810","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-480828810","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":480828810,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDgyODgxMA==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-04-08T13:21:01Z","updated_at":"2019-04-08T13:21:14Z","author_association":"MEMBER","body":"The test has failed a number of times in intake builds so I muted it in 02c3b1d8e3f66e29b9b8cceaaed0b754559f95d7 (master) even though the fix is imminent ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/487467138","html_url":"https://github.com/elastic/elasticsearch/issues/38030#issuecomment-487467138","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38030","id":487467138,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzQ2NzEzOA==","user":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"created_at":"2019-04-29T06:46:31Z","updated_at":"2019-04-29T06:46:56Z","author_association":"CONTRIBUTOR","body":"The test failed in 7.x intake build, so I muted it on 7.x (1a6ffb26444)","performed_via_github_app":null}]