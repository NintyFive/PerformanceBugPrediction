{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13242","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13242/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13242/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13242/events","html_url":"https://github.com/elastic/elasticsearch/issues/13242","id":104249810,"node_id":"MDU6SXNzdWUxMDQyNDk4MTA=","number":13242,"title":"Percolator with groovy script fails when doc_values are enabled","user":{"login":"WellingR","id":4014179,"node_id":"MDQ6VXNlcjQwMTQxNzk=","avatar_url":"https://avatars1.githubusercontent.com/u/4014179?v=4","gravatar_id":"","url":"https://api.github.com/users/WellingR","html_url":"https://github.com/WellingR","followers_url":"https://api.github.com/users/WellingR/followers","following_url":"https://api.github.com/users/WellingR/following{/other_user}","gists_url":"https://api.github.com/users/WellingR/gists{/gist_id}","starred_url":"https://api.github.com/users/WellingR/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/WellingR/subscriptions","organizations_url":"https://api.github.com/users/WellingR/orgs","repos_url":"https://api.github.com/users/WellingR/repos","events_url":"https://api.github.com/users/WellingR/events{/privacy}","received_events_url":"https://api.github.com/users/WellingR/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2015-09-01T12:00:52Z","updated_at":"2016-03-24T15:26:22Z","closed_at":"2016-03-24T15:26:22Z","author_association":"NONE","active_lock_reason":null,"body":"Tested on Elasticsearch 1.7.1.\n\nPrepare the mapping and percolator as follows:\n\n```\ncurl -XPUT localhost:9200/test -d '{\n  \"mappings\" : {\n    \"test\" : {\n      \"properties\" : {\n        \"name\" : {\n          \"type\" : \"string\",\n          \"index\" : \"not_analyzed\",\n          \"doc_values\": true\n        }\n      }\n    }\n  }\n}'\ncurl -XPUT localhost:9200/test/.percolator/1 -d '{\n  \"type\": \"test\",\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n        \"script\": {\n          \"script\": \"doc[\\\"name\\\"].value.contains(\\\"a\\\")\",\n          \"lang\": \"groovy\"\n        }\n      }\n    }\n  }\n}'\n```\n\nThis script tests for a match, it keeps looping silently as long as the expected result arrives. When an unexpected result arrives it's printed and the loop terminates:\n\n```\nwhile ! curl -s localhost:9200/test/test/_percolate -d '{ \"doc\": { \"name\": \"a\" } }' | grep -v '\"failed\":0},\"total\":1'; do :; done\n```\n\nUnfortunately the script fails instantly.\n\n```\n{\"took\":5,\"_shards\":{\"total\":5,\"successful\":4,\"failed\":1,\"failures\":[{\"index\":\"test\",\"shard\":2,\"status\":400,\"reason\":\"BroadcastShardOperationFailedException[[test][2] ]; nested: PercolateException[failed to percolate]; nested: PercolateException[failed to execute]; nested: GroovyScriptExecutionException[NullPointerException[Cannot invoke method contains() on null object]]; \"}]},\"total\":0,\"matches\":[]}\n```\n\nElasticsearch logs the following stacktrace\n\n```\n[2015-09-01 13:51:02,378][DEBUG][action.percolate         ] [esnode-r] [test][2], node[rbfvveU3R3GjVtXyTzQp9g], [P], s[STARTED]: failed to execute [org.elasticsearch.action.percolate.PercolateRequest@d53bdf0]\norg.elasticsearch.percolator.PercolateException: failed to percolate\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:195)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:56)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction$1.run(TransportBroadcastOperationAction.java:170)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.percolator.PercolateException: failed to execute\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:564)\n    at org.elasticsearch.percolator.PercolatorService.percolate(PercolatorService.java:242)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:192)\n    ... 5 more\nCaused by: org.elasticsearch.script.groovy.GroovyScriptExecutionException: NullPointerException[Cannot invoke method contains() on null object]\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:274)\n    at org.elasticsearch.index.query.ScriptFilterParser$ScriptFilter$ScriptDocSet.matchDoc(ScriptFilterParser.java:187)\n    at org.elasticsearch.common.lucene.docset.MatchDocIdSet$NoAcceptDocsIterator.nextDoc(MatchDocIdSet.java:96)\n    at org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.nextDoc(ConstantScoreQuery.java:257)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:192)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163)\n    at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:309)\n    at org.elasticsearch.common.lucene.Lucene.countWithEarlyTermination(Lucene.java:320)\n    at org.elasticsearch.common.lucene.Lucene.countWithEarlyTermination(Lucene.java:308)\n    at org.elasticsearch.common.lucene.Lucene.exists(Lucene.java:299)\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:560)\n    ... 7 more\n\n```\n\nThis issue does not occur when the line `\"doc_values\": true` is not included in the mapping (it defaults to false in elasticsearch 1.7.1).\nWhat perhaps is worse, if that the wrong result (no result) is returned when the percolator script is changed to `\"doc[\\\"name\\\"].value == \\\"a\\\"\"`.\n\nI discovered this issue because we use the workaround mentioned in #8879 to avoid percolator concurrency issues. Since elasticsearch uses doc_values by default, we were investigating what the performance inpact is of using docvalues, however we discovered this unexpected problem.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}