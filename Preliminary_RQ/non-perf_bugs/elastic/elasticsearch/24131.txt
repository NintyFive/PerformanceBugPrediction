{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24131","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24131/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24131/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24131/events","html_url":"https://github.com/elastic/elasticsearch/issues/24131","id":222115777,"node_id":"MDU6SXNzdWUyMjIxMTU3Nzc=","number":24131,"title":"elasticsearch 5.3.0 scroll slice api has unexpected results","user":{"login":"pinguo-gongjunheng","id":19701039,"node_id":"MDQ6VXNlcjE5NzAxMDM5","avatar_url":"https://avatars2.githubusercontent.com/u/19701039?v=4","gravatar_id":"","url":"https://api.github.com/users/pinguo-gongjunheng","html_url":"https://github.com/pinguo-gongjunheng","followers_url":"https://api.github.com/users/pinguo-gongjunheng/followers","following_url":"https://api.github.com/users/pinguo-gongjunheng/following{/other_user}","gists_url":"https://api.github.com/users/pinguo-gongjunheng/gists{/gist_id}","starred_url":"https://api.github.com/users/pinguo-gongjunheng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pinguo-gongjunheng/subscriptions","organizations_url":"https://api.github.com/users/pinguo-gongjunheng/orgs","repos_url":"https://api.github.com/users/pinguo-gongjunheng/repos","events_url":"https://api.github.com/users/pinguo-gongjunheng/events{/privacy}","received_events_url":"https://api.github.com/users/pinguo-gongjunheng/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2017-04-17T11:28:14Z","updated_at":"2018-02-14T13:31:09Z","closed_at":"2017-04-19T05:49:42Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.3.0\r\n\r\n**Plugins installed**: [x-pack, es-discovery]\r\n\r\n**JVM version**: oracle jdk8\r\n\r\n**OS version**: ubuntu 16.04\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n* count on entire index\r\n```\r\nGET some_index_with_12_shards/event/_count\r\n```\r\nresult:\r\n```\r\n{\r\n  \"count\": 26269522,\r\n  \"_shards\": {\r\n    \"total\": 12,\r\n    \"successful\": 12,\r\n    \"failed\": 0\r\n  }\r\n}\r\n```\r\n* count on on shard 0\r\n```\r\nGET some_index_with_12_shards/event/_count?preference=_shards:0|_local\r\n```\r\nresult:\r\n```\r\n{\r\n  \"count\": 2188043,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  }\r\n}\r\n```\r\n* create slice scroll with shard 0:\r\n```\r\nGET some_index_with_12_shards/event/_search?scroll=10m&sort=_doc&preference=_shards:0|_local\r\n{\r\n  \"slice\": {\r\n    \"id\": 0,\r\n    \"max\": 21\r\n  }\r\n}\r\n```\r\nresult:\r\n![image](https://cloud.githubusercontent.com/assets/19701039/25087695/5cbc2c10-23a3-11e7-9fdd-4d20b81493d7.png)\r\n\r\nscreen shot show the slice result is for entire index not just shard 0. \r\n\r\n* create scroll without shard 0 preference\r\n```\r\nGET some_index_with_12_shards/event/_search?scroll=10m&sort=_doc\r\n{\r\n  \"slice\": {\r\n    \"id\": 0,\r\n    \"max\": 21\r\n  }\r\n}\r\n```\r\nresult\r\n![image](https://cloud.githubusercontent.com/assets/19701039/25087770/f10100c6-23a3-11e7-880c-d92f8b39b291.png)\r\n\r\n* try to consume the scroll with preference shard 0, it possible no data, cause we are using elasticsearch generate _uid and in a time sequence index.\r\n\r\n* and we are using elasticsearch-hadoop to access those indices, the elasticsearch-hadoop use shard based slice create spark partition, it will cause empty partitions and multi time re-create scrolls on entire scroll.\r\n\r\nfollow attachment is temporary patch let elasticsearch-hadoop 5.3.0 work with elasticsearch cluster 5.3.0.\r\nsimply avoid shard related partition replace it with slice on entire index.\r\n\r\n[fix_scroll_slice_issues.patch.zip](https://github.com/elastic/elasticsearch/files/925421/fix_scroll_slice_issues.patch.zip)\r\n","closed_by":{"login":"pinguo-gongjunheng","id":19701039,"node_id":"MDQ6VXNlcjE5NzAxMDM5","avatar_url":"https://avatars2.githubusercontent.com/u/19701039?v=4","gravatar_id":"","url":"https://api.github.com/users/pinguo-gongjunheng","html_url":"https://github.com/pinguo-gongjunheng","followers_url":"https://api.github.com/users/pinguo-gongjunheng/followers","following_url":"https://api.github.com/users/pinguo-gongjunheng/following{/other_user}","gists_url":"https://api.github.com/users/pinguo-gongjunheng/gists{/gist_id}","starred_url":"https://api.github.com/users/pinguo-gongjunheng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pinguo-gongjunheng/subscriptions","organizations_url":"https://api.github.com/users/pinguo-gongjunheng/orgs","repos_url":"https://api.github.com/users/pinguo-gongjunheng/repos","events_url":"https://api.github.com/users/pinguo-gongjunheng/events{/privacy}","received_events_url":"https://api.github.com/users/pinguo-gongjunheng/received_events","type":"User","site_admin":false},"performed_via_github_app":null}