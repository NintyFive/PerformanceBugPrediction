{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11582","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11582/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11582/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11582/events","html_url":"https://github.com/elastic/elasticsearch/issues/11582","id":87004039,"node_id":"MDU6SXNzdWU4NzAwNDAzOQ==","number":11582,"title":"ES waiting for observer timeout before failing consistency check","user":{"login":"drewr","id":6202,"node_id":"MDQ6VXNlcjYyMDI=","avatar_url":"https://avatars3.githubusercontent.com/u/6202?v=4","gravatar_id":"","url":"https://api.github.com/users/drewr","html_url":"https://github.com/drewr","followers_url":"https://api.github.com/users/drewr/followers","following_url":"https://api.github.com/users/drewr/following{/other_user}","gists_url":"https://api.github.com/users/drewr/gists{/gist_id}","starred_url":"https://api.github.com/users/drewr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/drewr/subscriptions","organizations_url":"https://api.github.com/users/drewr/orgs","repos_url":"https://api.github.com/users/drewr/repos","events_url":"https://api.github.com/users/drewr/events{/privacy}","received_events_url":"https://api.github.com/users/drewr/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2015-06-10T15:15:47Z","updated_at":"2018-03-20T12:43:09Z","closed_at":"2018-03-20T12:43:09Z","author_association":"MEMBER","active_lock_reason":null,"body":"When consistency policy isn't satisfied, rather than bail out in the precheck, we are waiting the default cluster state observer timeout (60s) before sending the error response.  The only way to tell this is happening if you don't have the response is the timeout getting logged, in `DEBUG`:\n\n```\n[2015-06-10 09:44:35,628][DEBUG][action.index             ] [Scaleface] observer: timeout notification from cluster service. timeout setting [1m], time since start [1m]\n```\n\nOn a busy cluster with lots of writes, you will start to see metadata operations slow down even though CPU and memory aren't necessarily getting any pressure.\n\nTo reproduce, start a single 1.5.2 node and create an index with more than one replica (so there isn't quorum):\n\n```\ncurl -s -XPUT localhost:9200/foo -d'---\nnumber_of_shards: 1\nnumber_of_replicas: 2\n'\n```\n\nVerify topology:\n\n```\n% es shards\nfoo 0 p STARTED    0 115b 10.0.1.200 Scaleface \nfoo 0 r UNASSIGNED                             \nfoo 0 r UNASSIGNED                             \n```\n\nIndex a doc:\n\n```\ncurl -s -XPUT localhost:9200/foo/t/1 -d'{\"f\": 1}'\n```\n\nAfter a minute you'll get:\n\n```\nerror: \"UnavailableShardsException[[foo][0] Not enough active copies to meet write\\\n  \\ consistency of [QUORUM] (have 1, needed 2). Timeout: [1m], request: index {[foo][t][1],\\\n  \\ source[{\\\"f\\\":1}]}]\"\nstatus: 503\n```\n\nIt looks like the great refactoring in 5bdfdc42d99b12e7999fb36c8f1a72d43d7b5606 may have switched the behavior?  If that's the correct behavior, maybe we can log something in `ERROR` after `N` indexing requests have failed consistency check?\n\nHere's the same operation with `TRACE`:\n\n```\n[2015-06-10 10:08:39,271][TRACE][action.index             ] [Impossible Man] primary shard [[foo][0]] is not yet active or we do not know the node it is assigned to [null], scheduling a retry.\n[2015-06-10 10:08:39,279][TRACE][action.index             ] [Impossible Man] observer: sampled state rejected by predicate (version [2], status [APPLIED]). adding listener to ClusterService\n[2015-06-10 10:08:39,279][TRACE][action.index             ] [Impossible Man] observer: postAdded - predicate rejected state (version [2], status [APPLIED])\n[2015-06-10 10:09:39,272][DEBUG][action.index             ] [Impossible Man] observer: timeout notification from cluster service. timeout setting [1m], time since start [1m]\n[2015-06-10 10:09:39,274][TRACE][action.index             ] [Impossible Man] primary shard [[foo][0]] is not yet active or we do not know the node it is assigned to [null], scheduling a retry.\n```\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}