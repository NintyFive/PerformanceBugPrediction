{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42997","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42997/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42997/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42997/events","html_url":"https://github.com/elastic/elasticsearch/issues/42997","id":453616091,"node_id":"MDU6SXNzdWU0NTM2MTYwOTE=","number":42997,"title":"Add null check for ParentJoinFieldMapper in ChildrenAggregationBuilder.joinFieldResolveConfig","user":{"login":"ebadyano","id":26631211,"node_id":"MDQ6VXNlcjI2NjMxMjEx","avatar_url":"https://avatars0.githubusercontent.com/u/26631211?v=4","gravatar_id":"","url":"https://api.github.com/users/ebadyano","html_url":"https://github.com/ebadyano","followers_url":"https://api.github.com/users/ebadyano/followers","following_url":"https://api.github.com/users/ebadyano/following{/other_user}","gists_url":"https://api.github.com/users/ebadyano/gists{/gist_id}","starred_url":"https://api.github.com/users/ebadyano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ebadyano/subscriptions","organizations_url":"https://api.github.com/users/ebadyano/orgs","repos_url":"https://api.github.com/users/ebadyano/repos","events_url":"https://api.github.com/users/ebadyano/events{/privacy}","received_events_url":"https://api.github.com/users/ebadyano/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":15,"created_at":"2019-06-07T17:21:46Z","updated_at":"2020-07-06T13:54:12Z","closed_at":"2020-07-06T13:54:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"A user received a NPE. It was reproduced on 6.3.1 with the following stack trace:\r\n```\r\n2019-06-06T13:26:49,963][DEBUG][o.e.a.s.TransportSearchAction] [hamilton] [mi_indice][2], node[ABwM3KQJQdWuKfnzwJ8pxw], [P], s[STARTED], a[id=cRQiXG2DTmijJ2IMjtYq5g]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[mi_indice], indicesOptions=IndicesOptions[id=38, ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_aliases_to_multiple_indices=true, forbid_closed_indices=true, ignore_aliases=false], types=[], routing='null', preference='null', requestCache=null, scroll=null, maxConcurrentShardRequests=15, batchedReduceSize=512, preFilterShardSize=128, allowPartialSearchResults=true, source={\"query\":{\"bool\":{\"must\":[{\"bool\":{\"must\":[{\"bool\":{\"should\":[{\"range\":{\"posting_date\":{\"from\":\"1900-01-01T00:00:00.000Z\",\"to\":\"2019-05-30T18:25:49.967Z\",\"include_lower\":true,\"include_upper\":true,\"boost\":1.0}}}],\"adjust_pure_negative\":true,\"boost\":1.0}},{\"term\":{\"externaljob_to_child_fields.name\":{\"value\":\"externaljob\",\"boost\":1.0}}}],\"adjust_pure_negative\":true,\"boost\":1.0}}],\"adjust_pure_negative\":true,\"boost\":1.0}},\"aggregations\":{\"POSTING_DATES\":{\"date_range\":{\"field\":\"posting_date\",\"ranges\":[{\"key\":\"ORA_LT07\",\"from\":\"2019-05-23T18:25:50.006Z\",\"to\":\"2019-05-30T18:25:50.006Z\"},{\"key\":\"ORA_LT30\",\"from\":\"2019-04-30T18:25:50.006Z\",\"to\":\"2019-05-30T18:25:50.006Z\"},{\"key\":\"ORA_GT30\",\"from\":\"1900-01-01T00:00:00.000Z\",\"to\":\"2019-04-30T18:25:50.006Z\"}],\"keyed\":false}},\"LOCATIONS\":{\"children\":{\"type\":\"externaljob_locs\"}}}}}] lastShard [true]\r\norg.elasticsearch.transport.RemoteTransportException: [washington][127.0.0.1:9302][indices:data/read/search[phase/query]]\r\nCaused by: java.lang.NullPointerException\r\n\tat org.elasticsearch.join.aggregations.ChildrenAggregationBuilder.joinFieldResolveConfig(ChildrenAggregationBuilder.java:122) ~[?:?]\r\n\tat org.elasticsearch.join.aggregations.ChildrenAggregationBuilder.resolveConfig(ChildrenAggregationBuilder.java:113) ~[?:?]\r\n\tat org.elasticsearch.search.aggregations.support.ValuesSourceAggregationBuilder.doBuild(ValuesSourceAggregationBuilder.java:311) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.aggregations.support.ValuesSourceAggregationBuilder.doBuild(ValuesSourceAggregationBuilder.java:38) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.aggregations.AbstractAggregationBuilder.build(AbstractAggregationBuilder.java:139) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.aggregations.AggregatorFactories$Builder.build(AggregatorFactories.java:329) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService.parseSource(SearchService.java:766) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService.createContext(SearchService.java:575) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n```\r\n\r\nin `ChildrenAggregationBuilder.joinFieldResolveConfig`\r\n\r\n```\r\nprivate void joinFieldResolveConfig(SearchContext context, ValuesSourceConfig<WithOrdinals> config) {\r\n        ParentJoinFieldMapper parentJoinFieldMapper = ParentJoinFieldMapper.getMapper(context.mapperService()); \r\n        ParentIdFieldMapper parentIdFieldMapper = parentJoinFieldMapper.getParentIdFieldMapper(childType, false);\r\n        if (parentIdFieldMapper != null) {\r\n...\r\n        } else {\r\n            config.unmapped(true);\r\n        }\r\n\r\n```\r\n`ParentJoinFieldMapper.getMapper` returns null when there is no parent-join field in the mapping. We already check to see if `parentIdFieldMapper` is null and use an unmapped. Should probably be doing the same for `parentJoinFieldMapper` as well.","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}