{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20917","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20917/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20917/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20917/events","html_url":"https://github.com/elastic/elasticsearch/issues/20917","id":182826680,"node_id":"MDU6SXNzdWUxODI4MjY2ODA=","number":20917,"title":"v5.0.0rc1 - reduce_params is not being recognised as a valid key in scripted_metric aggregation","user":{"login":"nishant-tomer","id":15999657,"node_id":"MDQ6VXNlcjE1OTk5NjU3","avatar_url":"https://avatars2.githubusercontent.com/u/15999657?v=4","gravatar_id":"","url":"https://api.github.com/users/nishant-tomer","html_url":"https://github.com/nishant-tomer","followers_url":"https://api.github.com/users/nishant-tomer/followers","following_url":"https://api.github.com/users/nishant-tomer/following{/other_user}","gists_url":"https://api.github.com/users/nishant-tomer/gists{/gist_id}","starred_url":"https://api.github.com/users/nishant-tomer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nishant-tomer/subscriptions","organizations_url":"https://api.github.com/users/nishant-tomer/orgs","repos_url":"https://api.github.com/users/nishant-tomer/repos","events_url":"https://api.github.com/users/nishant-tomer/events{/privacy}","received_events_url":"https://api.github.com/users/nishant-tomer/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":442569761,"node_id":"MDU6TGFiZWw0NDI1Njk3NjE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0","name":"v5.0.0","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-10-13T15:44:31Z","updated_at":"2017-05-09T08:14:53Z","closed_at":"2016-10-17T17:31:50Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: v5.0.0rc1\n**Plugins installed**: [mapper-murmur3]\n**OpenJDK version** : 1.8.0_91\n**JVM_version** : OpenJDK 64-Bit Server VM (build 25.91-b14, mixed mode)\n**OS version**: Ubuntu 16.04 LTS / Ubuntu 14.04 LTS\n\n**Description of the problem including expected versus actual behavior**:\n`reduce_params` is not being recognised as a valid key in scripted_metric aggregation but [docs for v5.0.0rc1 mention](https://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-aggregations-metrics-scripted-metric-aggregation.html#_other_parameters) that it should be recognised.\n\n**Steps to reproduce**:\ni have some docs in an index with following mapping \n\n```\n   \"sales\": {  \"type\": \"double\" }\n```\n\ni am using following query to test `scripted_metric` aggregation which involves only `sales` field\n\n```\n{\n   \"size\": 0,\n   \"aggregations\": {\n      \"sum_test\": {\n         \"scripted_metric\": {\n            \"params\": {\n               \"_agg\": {}\n            },\n            \"reduce_params\":{},\n            \"init_script\": \"params._agg['transactions'] = []\",\n            \"map_script\": \"if (!doc['sales'].empty) { params._agg.transactions.add(doc['sales'].value) } else { params._agg.transactions.add(0.0) }\",\n            \"combine_script\": \"double sales = 0; for (t in params._agg.transactions) { sales += t } return sales\",\n            \"reduce_script\": \"double sales = 0;  for (t in params._aggs) { sales += t } return sales\"\n         }\n      }\n   }\n}\n```\n\nThis query is throwing a `400` error with type `parsing_exception`.\n\n**Provide logs (if relevant)**:\nES response for test query above\n\n```\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"parsing_exception\",\n            \"reason\": \"Unknown key for a START_OBJECT in [sum_test]: [reduce_params].\",\n            \"line\": 9,\n            \"col\": 29\n         }\n      ],\n      \"type\": \"parsing_exception\",\n      \"reason\": \"Unknown key for a START_OBJECT in [sum_test]: [reduce_params].\",\n      \"line\": 9,\n      \"col\": 29\n   },\n   \"status\": 400\n}\n```\n\nES Response after removing `reduce_params` key from `scripted_metric` object in the test query above\n\n```\n{\n   \"took\": 34,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 6145,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"sum_test\": {\n         \"value\": 1802900.2899999975\n      }\n   }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}