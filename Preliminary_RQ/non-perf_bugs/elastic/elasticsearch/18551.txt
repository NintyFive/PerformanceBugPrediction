{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18551","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18551/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18551/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18551/events","html_url":"https://github.com/elastic/elasticsearch/issues/18551","id":156550008,"node_id":"MDU6SXNzdWUxNTY1NTAwMDg=","number":18551,"title":"Potential race condition with snapshot naming","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-05-24T16:18:36Z","updated_at":"2019-07-20T12:57:38Z","closed_at":"2019-07-20T12:57:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In very rare cases, it is possible to have two snapshots of the same name exist in a repository, one found in the cluster state as a snapshot in progress, and the other found in the repository.  This can happen when a snapshot (lets call it `snap`) exists in the repository, and we try to create another snapshot with the same name `snap`.  When trying to create the second `snap`, `SnapshotsService#createSnapshot` first updates the cluster state to include the second 'snap' snapshot as a snapshot in progress, and then calls `SnapshotsService#beginSnapshot`, which checks if a snapshot by the same name already exists.  If a snapshot by the same name does exist, an exception is thrown, which results in calling `SnapshotsService#removeSnapshotFromClusterState`.  However, this call to remove the snapshot from the cluster state simply submits a cluster state update task for the cluster service to execute in its own update thread, and so there is a tiny window when the cluster state could have a snapshot in progress with the name `snap` and the repository could have the original snapshot named 'snap' in its storage.\n\nThis affects the `SnapshotsService#deleteSnapshot` call, which looks through both the current snapshots and the snapshots in the repository storage, and it also affects `TransportGetSnapshotsAction` and `TransportSnapshotsStatusAction`, which have a very tiny window of time in which its possible to return two snapshots of the same name, or to return the current (soon-to-be-removed from the cluster state) snapshot when the snapshot in the repository storage is what was meant.\n\nFor those wondering why we don't check if the snapshot name already exists before adding the new snapshot to the cluster state's snapshots in progress, the reason is because it can present race conditions of its own.  If two requests arrive to create a snapshot of the same name at the same time, because neither has yet to be added to the cluster state, it is possible that both pass the check and subsequently both eventually get created by the snapshots service.\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}