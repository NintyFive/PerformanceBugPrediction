{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5141","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5141/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5141/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5141/events","html_url":"https://github.com/elastic/elasticsearch/issues/5141","id":27709252,"node_id":"MDU6SXNzdWUyNzcwOTI1Mg==","number":5141,"title":"Delete by query doesn't work in persistent http connection","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2014-02-17T11:44:22Z","updated_at":"2014-03-13T08:33:57Z","closed_at":"2014-03-11T18:42:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This is probably connected with #2665.\n\nHere's test-case in php:\n\n``` php\n<?php\n\n$conn = curl_init();\n$host = 'http://127.0.0.1:9200';\n\nfunction send($conn, $host, $method, $path, $query = array(), $body = null) {\n    // uncomment the next line to make new connection for every request\n    // $conn = curl_init();\n\n    $url = $host . $path . '?' . http_build_query($query);\n\n    curl_setopt($conn, CURLOPT_URL, $url);\n\n    if ($body) {\n        curl_setopt($conn, CURLOPT_POSTFIELDS, $body);\n    }\n\n    curl_setopt($conn, CURLOPT_CUSTOMREQUEST, $method);\n\n    ob_start();\n    curl_exec($conn);\n    $result = ob_get_clean();\n\n    echo $method . ' ' . $url . ' ' . $body.\"\\n\";\n    echo '> ' . $result . \"\\n\";\n\n    return $result;\n}\n\nsend($conn, $host, \"DELETE\", '/elastica_test/');\nsend($conn, $host, \"PUT\", '/elastica_test/', array(), '{\"index\":{\"number_of_shards\":1,\"number_of_replicas\":0}}');\nsend($conn, $host, \"PUT\", '/elastica_test/test/1', array(), '{\"name\":\"ruflin nicolas\"}');\nsend($conn, $host, \"PUT\", '/elastica_test/test/2', array(), '{\"name\":\"ruflin\"}');\nsend($conn, $host, \"PUT\", '/elastica_test/test/3', array(), '{\"name\":\"ian\"}');\nsend($conn, $host, \"POST\", '/elastica_test/_refresh');\nsend($conn, $host, \"POST\", '/elastica_test/_search', array(), '{\"query\":{\"query_string\":{\"query\":\"ruflin*\"}}}');\nsend($conn, $host, \"POST\", '/elastica_test/_search', array(), '{\"query\":{\"query_string\":{\"query\":\"nicolas\"}}}');\n// comment the next request to fix everything\nsend($conn, $host, \"POST\", '/elastica_test/_search', array(), '{\"query\":{\"query_string\":{\"query\":\"ian\"}}}');\nsend($conn, $host, \"DELETE\", '/elastica_test/_query', array('q' => 'nicolas'));\nsend($conn, $host, \"POST\", '/elastica_test/_refresh');\nsend($conn, $host, \"POST\", '/elastica_test/_search', array(), '{\"query\":{\"query_string\":{\"query\":\"ruflin*\"}}}');\n```\n\nThe last query should respond with just one hit, but it returns document that was removed. This works as it should if new connection is made for every request (see function `send`), it also works if I comment search (sic!) request before delete-by-query.\n\nI'm sorry for php, I couldn't make it work with curl or nc.\n","closed_by":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"performed_via_github_app":null}