[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/245700512","html_url":"https://github.com/elastic/elasticsearch/issues/20369#issuecomment-245700512","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20369","id":245700512,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTcwMDUxMg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-09-08T18:49:47Z","updated_at":"2016-09-08T18:49:47Z","author_association":"CONTRIBUTOR","body":"> This issue is a duplicate of #3125. \n\nActually this is quite different.  Issue 3125 is about having many occurrences of the correct term and few occurrences of an incorrectly spelled term, and having the incorrectly spelled term rank over the correct term.\n\nThe problem with your  example is this: combining fuzziness with an edge-ngram field is a bad idea.  Here's why:\n\n```\nPUT t\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"analysis\": {\n      \"filter\": {\n        \"edge_ngram\": {\n          \"type\": \"edgeNGram\",\n          \"min_gram\": 1,\n          \"max_gram\": 15\n        }\n      },\n      \"analyzer\": {\n        \"my_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"standard\",\n          \"filter\": [\n            \"lowercase\",\n            \"edge_ngram\"\n          ]\n        },\n        \"my_search_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"standard\",\n          \"filter\": [\n            \"lowercase\"\n          ]\n        }\n      }\n    }\n  },\n  \"mappings\": {\n    \"user\": {\n      \"properties\": {\n        \"username\": {\n          \"type\": \"string\",\n          \"analyzer\": \"my_analyzer\",\n          \"search_analyzer\": \"my_search_analyzer\"\n        }\n      }\n    }\n  }\n}\n\nPOST t/user\n{\"username\":\"user100\"}\nPOST t/user\n{\"username\":\"user1001\"}\n\nPOST t/_validate/query?explain&rewrite\n{\n  \"query\": {\n    \"match\": {\n      \"username\": {\n        \"query\": \"user100\",\n        \"fuzziness\": \"1\"\n      }\n    }\n  }\n}\n```\n\nThis query is rewritten (based on the terms in the index) as:\n\n```\n(username:user10)^0.8333333 username:user100 (username:user1001)^0.85714287\n```\n\nThe doc with `user100` matches the first two clauses, while `user1001` matches all three, and so scores higher.\n\nif you tried the same experiment with `user1000`, `, user1001`, `user1002` and searched for `user1000` then you would get the right result.\n","performed_via_github_app":null}]