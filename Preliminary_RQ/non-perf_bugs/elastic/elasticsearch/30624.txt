{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624/events","html_url":"https://github.com/elastic/elasticsearch/issues/30624","id":323306148,"node_id":"MDU6SXNzdWUzMjMzMDYxNDg=","number":30624,"title":"Field-level security with inner_hits can cause index out-of-bounds exception","user":{"login":"james-uffindell-granta","id":27734625,"node_id":"MDQ6VXNlcjI3NzM0NjI1","avatar_url":"https://avatars3.githubusercontent.com/u/27734625?v=4","gravatar_id":"","url":"https://api.github.com/users/james-uffindell-granta","html_url":"https://github.com/james-uffindell-granta","followers_url":"https://api.github.com/users/james-uffindell-granta/followers","following_url":"https://api.github.com/users/james-uffindell-granta/following{/other_user}","gists_url":"https://api.github.com/users/james-uffindell-granta/gists{/gist_id}","starred_url":"https://api.github.com/users/james-uffindell-granta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james-uffindell-granta/subscriptions","organizations_url":"https://api.github.com/users/james-uffindell-granta/orgs","repos_url":"https://api.github.com/users/james-uffindell-granta/repos","events_url":"https://api.github.com/users/james-uffindell-granta/events{/privacy}","received_events_url":"https://api.github.com/users/james-uffindell-granta/received_events","type":"User","site_admin":false},"labels":[{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-05-15T17:08:23Z","updated_at":"2018-05-22T11:53:36Z","closed_at":"2018-05-22T11:53:36Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.2.4, Build: ccec39f/2018-04-12T20:37:28.497551Z\r\n\r\n**Plugins installed**:\r\nx-pack\r\n        x-pack-core\r\n        x-pack-deprecation\r\n        x-pack-graph\r\n        x-pack-logstash\r\n        x-pack-ml\r\n        x-pack-monitoring\r\n        x-pack-security\r\n        x-pack-upgrade\r\n        x-pack-watcher\r\n\r\n**JVM version** (`java -version`):\r\njava 9\r\nJava(TM) SE Runtime Environment (build 9+181)\r\nJava HotSpot(TM) 64-Bit Server VM (build 9+181, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nWindows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning a query with field-level security on a subfield of a nested array field and asking for inner_hits can cause an index out of bounds exception.\r\n\r\nExpected behavior: no error. (If this is a known limitation of either inner_hits or field-level security then I couldn't see it in the documentation.)\r\n\r\n**Steps to reproduce**:\r\n```\r\n# create a new index\r\ncurl -XPUT localhost:9200/test\r\n\r\n# define a mapping\r\ncurl -XPUT localhost:9200/test/_mapping/document -d '{\r\n    \"properties\": {\r\n        \"document_name\": {\r\n            \"type\": \"text\"\r\n        },\r\n        \"metadata\": {\r\n            \"type\": \"nested\",\r\n            \"properties\": {\r\n                \"name\": {\"type\": \"text\"},\r\n                \"sv\": {\"type\": \"text\"},\r\n                \"nv\": {\"type\": \"double\"}\r\n            }\r\n        }\r\n    }\r\n}'\r\n\r\n# index a document:\r\n# it has one 'metadata' value where nv is populated and another where sv is populated\r\ncurl -XPOST localhost:9200/test/document -d '{\r\n    \"document_name\": \"testing\",\r\n    \"metadata\": [\r\n        {\r\n            \"name\": \"numeric\",\r\n            \"nv\": 0.2\r\n        },\r\n        {\r\n            \"name\": \"string\",\r\n            \"sv\": \"problem\"\r\n        }\r\n    ]\r\n}'\r\n\r\n# run this query; it should retrieve the document okay including the inner_hits\r\n# metadata[1] is the inner hit which matches; metadata[0] doesn't match\r\ncurl -XPOST localhost:9200/test/_search -d '{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"nested\": {\r\n                        \"path\": \"metadata\",\r\n                        \"inner_hits\":{},\r\n                        \"score_mode\": \"avg\",\r\n                        \"query\": {\r\n                            \"bool\": {\r\n                                \"must\": [\r\n                                    {\r\n                                        \"match\": {\r\n                                            \"metadata.sv\": \"problem\"\r\n                                        }\r\n                                    }\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}'\r\n\r\n# create a role which can only see metadata.sv\r\ncurl -XPUT localhost:9200/_xpack/security/role/reproduce -d '{\r\n    \"indices\": [\r\n        {\r\n            \"names\": [ \"test\" ],\r\n            \"privileges\": [ \"read\" ],\r\n            \"field_security\" : {\r\n                \"grant\": [ \"metadata.sv\" ]\r\n            }\r\n        }    \r\n    ]\r\n}'\r\n\r\n# create a user in that role\r\ncurl -XPUT localhost:9200/_xpack/security/user/repro-user -d '{\r\n    \"roles\": [\"reproduce\"],\r\n    \"password\": \"whatever\",\r\n    \"full_name\": \"Repro User\",\r\n    \"email\": \"blah@blah.blah\"\r\n}'\r\n```\r\n\r\nNow, if you rerun the previous query but authenticating as this new user, instead of getting results, it fails:\r\n```\r\n\"failures\": [\r\n    {\r\n        ...\r\n        \"reason\": {\r\n            \"type\": \"index_out_of_bounds_exception\",\r\n            \"reason\": \"Index 1 out-of-bounds for length 1\"\r\n        }\r\n    }\r\n]\r\n```\r\n\r\nRemoving `\"inner_hits\":{}` from the query will make it work.\r\n\r\nMy guess is that it figures out that `metadata[1]` is the inner hit which matches, then strips out the fields you aren't allowed to see, which removes `metadata[0]` since it doesn't have a `metadata.sv` field, which leaves the `metadata` array one element long instead of two, so when it then looks up `metadata[1]` to put it in the inner hits node, it goes bang?\r\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}