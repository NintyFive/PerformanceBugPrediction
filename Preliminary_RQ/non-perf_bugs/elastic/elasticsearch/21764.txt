{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21764","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21764/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21764/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21764/events","html_url":"https://github.com/elastic/elasticsearch/issues/21764","id":191377762,"node_id":"MDU6SXNzdWUxOTEzNzc3NjI=","number":21764,"title":"crashed elasticsearch with bad painless scripted field","user":{"login":"LeeDr","id":13542669,"node_id":"MDQ6VXNlcjEzNTQyNjY5","avatar_url":"https://avatars1.githubusercontent.com/u/13542669?v=4","gravatar_id":"","url":"https://api.github.com/users/LeeDr","html_url":"https://github.com/LeeDr","followers_url":"https://api.github.com/users/LeeDr/followers","following_url":"https://api.github.com/users/LeeDr/following{/other_user}","gists_url":"https://api.github.com/users/LeeDr/gists{/gist_id}","starred_url":"https://api.github.com/users/LeeDr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LeeDr/subscriptions","organizations_url":"https://api.github.com/users/LeeDr/orgs","repos_url":"https://api.github.com/users/LeeDr/repos","events_url":"https://api.github.com/users/LeeDr/events{/privacy}","received_events_url":"https://api.github.com/users/LeeDr/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-11-23T20:54:45Z","updated_at":"2018-02-14T13:22:40Z","closed_at":"2016-11-23T22:18:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**:\r\n\"number\": \"6.0.0-alpha1\",\r\n\"build_hash\": \"32e6fcf\",\r\n\"build_date\": \"2016-11-23T15:57:31.884Z\",\r\n\"build_snapshot\": true,\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\njava version \"1.8.0_91\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_91-b15)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.91-b15, mixed mode)\r\n\r\n**OS version**:\r\nWindows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI'm automating tests for scripted fields in Kibana.  While deciding what kind of painless string type result script to use I tried this;\r\n`if (doc['response.raw'].value == 200) { return 'good'} else { return 'bad'}`\r\n\r\nbut results with a response of 200 still said 'bad'.   So I tried with the `===` thinking it was like a javascript \r\n`if (doc['response.raw'].value === 200) { return 'good'} else { return 'bad'}`\r\n\r\nMy understanding is that `==` does type conversions and `===` doesn't.  So if the `doc['response.raw'].value` is treated as a string, I was trying to compare it to a number and perhaps this caused the crash?\r\n\r\n**Steps to reproduce**:\r\n 1. I'm using dummy logstash data which is created using makelogs tool\r\n 2. In Kibana, I create an index pattern for logstash-*\r\n 3. Create a scripted field with the following settings;\r\n     1. Name: pain2\r\n     1. Language: painless\r\n     1. Type: string (I'm assuming this is the output type from the script)\r\n     1. Format: String\r\n     1. Transform: Title Case\r\n     1. Popularity: 0 (only impacts Kibana UI)\r\n     1. Script: `if (doc['response.raw'].value === 200) { return 'good'} else { return 'bad'}`\r\n\r\nHere's a screen shot of the Kibana page for creating the scripted field with these values populated:\r\n![image](https://cloud.githubusercontent.com/assets/13542669/20578260/1a4ef8aa-b18c-11e6-8fbd-03044d5bff26.png)\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\nINFO - ? - ? - [2016-11-23T14:28:14,850][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[K59JG6z][search][T#9]], exiting\r\nINFO - ? - ? - java.lang.VerifyError: Bad type on operand stack\r\nINFO - ? - ? - Exception Details:\r\nINFO - ? - ? - Location:\r\nINFO - ? - ? - org/elasticsearch/painless/Executable$Script.execute(Ljava/util/Map;Lorg/apache/lucene/search/Scorer;Lorg/elasticsearch/search/lookup/LeafDocLookup;Ljava/lang/Object;)Ljava/lang/Object; @16: if_acmpeq\r\nINFO - ? - ? - Reason:\r\nINFO - ? - ? - Type integer (current frame, stack[1]) is not assignable to reference type\r\nINFO - ? - ? - Current Frame:\r\nINFO - ? - ? - bci: @16\r\nINFO - ? - ? - flags: { }\r\nINFO - ? - ? - locals: { 'org/elasticsearch/painless/Executable$Script', 'java/util/Map', 'org/apache/lucene/search/Scorer', 'org/elasticsearch/search/lookup/LeafDocLookup', 'java/lang/Object' }\r\nINFO - ? - ? - stack: { 'java/lang/Object', integer }\r\nINFO - ? - ? - Bytecode:\r\nINFO - ? - ? - 0x0000000: 2d12 0db9 0013 0200 ba00 1f00 0011 00c8\r\nINFO - ? - ? - 0x0000010: a500 0703 a700 0404 9900 0612 21b0 1223\r\nINFO - ? - ? - 0x0000020: b0\r\nINFO - ? - ? - Stackmap Table:\r\nINFO - ? - ? - same_frame(@23)\r\nINFO - ? - ? - same_locals_1_stack_item_frame(@24,Integer)\r\nINFO - ? - ? - same_frame(@30)\r\nINFO - ? - ? - at java.lang.Class.getDeclaredConstructors0(Native Method) ~[?:1.8.0_73]\r\nINFO - ? - ? - at java.lang.Class.privateGetDeclaredConstructors(Class.java:2671) ~[?:1.8.0_73]\r\nINFO - ? - ? - at java.lang.Class.getConstructor0(Class.java:3075) ~[?:1.8.0_73]\r\nINFO - ? - ? - at java.lang.Class.getConstructor(Class.java:1825) ~[?:1.8.0_73]\r\nINFO - ? - ? - at org.elasticsearch.painless.Compiler.compile(Compiler.java:110) ~[?:?]\r\nINFO - ? - ? - at org.elasticsearch.painless.PainlessScriptEngineService$2.run(PainlessScriptEngineService.java:171) ~[?:?]\r\nINFO - ? - ? - at org.elasticsearch.painless.PainlessScriptEngineService$2.run(PainlessScriptEngineService.java:168) ~[?:?]\r\nINFO - ? - ? - at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_73]\r\nINFO - ? - ? - at org.elasticsearch.painless.PainlessScriptEngineService.compile(PainlessScriptEngineService.java:168) ~[?:?]\r\nINFO - ? - ? - at org.elasticsearch.script.ScriptService.compileInternal(ScriptService.java:335) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.script.ScriptService.compile(ScriptService.java:231) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.script.ScriptService.search(ScriptService.java:486) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.search.SearchService.parseSource(SearchService.java:773) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.search.SearchService.createContext(SearchService.java:553) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:529) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:364) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.action.search.SearchTransportService$9.messageReceived(SearchTransportService.java:324) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.action.search.SearchTransportService$9.messageReceived(SearchTransportService.java:321) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:572) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:527) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\nINFO - ? - ? - at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[?:1.8.0_73]\r\nINFO - ? - ? - at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[?:1.8.0_73]\r\nINFO - ? - ? - at java.lang.Thread.run(Thread.java:745) [?:1.8.0_73]\r\nserver    log   [20:28:15.212] [error][elasticsearch] Request error, retrying\r\nHEAD http://localhost:9220/ => read ECONNRESET\r\nserver    log   [20:28:15.228] [warning][elasticsearch] Unable to revive connection: http://localhost:9220/\r\nserver    log   [20:28:15.228] [warning][elasticsearch] No living connections\r\nserver    log   [20:28:15.234] [error][status][plugin:elasticsearch@6.0.0-alpha1] Status changed from green to red - \r\n```","closed_by":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}