[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296103004","html_url":"https://github.com/elastic/elasticsearch/issues/24231#issuecomment-296103004","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24231","id":296103004,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjEwMzAwNA==","user":{"login":"tback","id":83432,"node_id":"MDQ6VXNlcjgzNDMy","avatar_url":"https://avatars0.githubusercontent.com/u/83432?v=4","gravatar_id":"","url":"https://api.github.com/users/tback","html_url":"https://github.com/tback","followers_url":"https://api.github.com/users/tback/followers","following_url":"https://api.github.com/users/tback/following{/other_user}","gists_url":"https://api.github.com/users/tback/gists{/gist_id}","starred_url":"https://api.github.com/users/tback/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tback/subscriptions","organizations_url":"https://api.github.com/users/tback/orgs","repos_url":"https://api.github.com/users/tback/repos","events_url":"https://api.github.com/users/tback/events{/privacy}","received_events_url":"https://api.github.com/users/tback/received_events","type":"User","site_admin":false},"created_at":"2017-04-21T07:14:42Z","updated_at":"2017-04-21T07:16:19Z","author_association":"CONTRIBUTOR","body":"This is also easily reproduced on the vagrant base box debian/jessie64.\r\n\r\nI suspect this is related to aufs.\r\n\r\n**Elasticsearch version:**\r\n5.3.1\r\n\r\n**Plugins installed:** [x-pack]\r\n\r\n**JVM version**:\r\n(Same base image, same jvm version)\r\n```docker run -ti --rm --name es docker.elastic.co/elasticsearch/elasticsearch:5.3.1 /usr/lib/jvm/java-1.8-openjdk/bin/java -version\r\nopenjdk version \"1.8.0_121\"\r\nOpenJDK Runtime Environment (IcedTea 3.3.0) (Alpine 8.121.13-r0)\r\nOpenJDK 64-Bit Server VM (build 25.121-b13, mixed mode)\r\n```\r\n\r\n**OS version:**\r\ndebian jessie 64bit\r\n```\r\nuname -a\r\nLinux jessie 3.16.0-4-amd64 #1 SMP Debian 3.16.39-1 (2016-12-30) x86_64 GNU/Linux\r\ndocker version\r\nClient:\r\n Version:      17.03.1-ce\r\n API version:  1.27\r\n Go version:   go1.7.5\r\n Git commit:   c6d412e\r\n Built:        Mon Mar 27 17:07:28 2017\r\n OS/Arch:      linux/amd64\r\n\r\nServer:\r\n Version:      17.03.1-ce\r\n API version:  1.27 (minimum version 1.12)\r\n Go version:   go1.7.5\r\n Git commit:   c6d412e\r\n Built:        Mon Mar 27 17:07:28 2017\r\n OS/Arch:      linux/amd64\r\n Experimental: false\r\n```\r\n\r\n**Steps to reproduce**\r\n```\r\nvagrant init debian/jessie64\r\nvagrant up\r\nvagrant ssh\r\n```\r\n\r\nThen, on the machine\r\ninstall docker\r\n```\r\nsudo apt-get install \\\r\n     apt-transport-https \\\r\n     ca-certificates \\\r\n     curl \\\r\n     gnupg2 \\\r\n     software-properties-common\r\ncurl -fsSL https://download.docker.com/linux/debian/gpg | sudo apt-key add -\r\nsudo add-apt-repository \\\r\n   \"deb [arch=amd64] https://download.docker.com/linux/debian \\\r\n   $(lsb_release -cs) \\\r\n   stable\"\r\nsudo apt-get update\r\nsudo apt-get install docker-ce\r\nsudo adduser vagrant docker\r\n```\r\nlogout && login again (so the new group becomes effective\r\n\r\nCreate Dockerfile with same contents as above:\r\n```\r\nFROM docker.elastic.co/elasticsearch/elasticsearch:5.3.1\r\n\r\nRUN eval ${ES_JAVA_OPTS:-} && \\\r\n    elasticsearch-plugin remove --silent x-pack\r\n```\r\n\r\nRun the docker build\r\n```\r\nvagrant@jessie:~$ docker build .\r\n```\r\nAnd get the trace:\r\n```\r\nSending build context to Docker daemon 13.31 kB\r\nStep 1/2 : FROM docker.elastic.co/elasticsearch/elasticsearch:5.3.1\r\n5.3.1: Pulling from elasticsearch/elasticsearch\r\nec37562cf8fa: Pull complete\r\n3f5b02e577c3: Pull complete\r\ne4c7c0eb9289: Pull complete\r\ne8008e68933d: Pull complete\r\n1cfca4b45f64: Pull complete\r\n77148a7a523b: Pull complete\r\nc93eabd5eff3: Pull complete\r\nd82d8a15579f: Pull complete\r\n0f2b8d9540a0: Pull complete\r\n5c9aa0d9a460: Pull complete\r\nDigest: sha256:94ebca9d6316902596ceef6934161be39cca04885fcf07c8ab3feb04c02b4933\r\nStatus: Downloaded newer image for docker.elastic.co/elasticsearch/elasticsearch:5.3.1\r\n ---> 94062e7e850e\r\nStep 2/2 : RUN eval ${ES_JAVA_OPTS:-} &&     elasticsearch-plugin remove --silent x-pack\r\n ---> Running in b6e5800a9b42\r\nException in thread \"main\" java.nio.file.DirectoryNotEmptyException: /usr/share/elasticsearch/plugins/x-pack\r\n\tat sun.nio.fs.UnixCopyFile.move(UnixCopyFile.java:498)\r\n\tat sun.nio.fs.UnixFileSystemProvider.move(UnixFileSystemProvider.java:262)\r\n\tat java.nio.file.Files.move(Files.java:1395)\r\n\tat org.elasticsearch.plugins.RemovePluginCommand.execute(RemovePluginCommand.java:91)\r\n\tat org.elasticsearch.plugins.RemovePluginCommand.execute(RemovePluginCommand.java:56)\r\n\tat org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:58)\r\n\tat org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:122)\r\n\tat org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:69)\r\n\tat org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:122)\r\n\tat org.elasticsearch.cli.Command.main(Command.java:88)\r\n\tat org.elasticsearch.plugins.PluginCli.main(PluginCli.java:47)\r\nThe command '/bin/sh -c eval ${ES_JAVA_OPTS:-} &&     elasticsearch-plugin remove --silent x-pack' returned a non-zero code: 1\r\n```\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296237518","html_url":"https://github.com/elastic/elasticsearch/issues/24231#issuecomment-296237518","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24231","id":296237518,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjIzNzUxOA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-04-21T16:24:33Z","updated_at":"2017-04-21T16:27:08Z","author_association":"MEMBER","body":"Thanks for the report @tback. I've found the source of the issue; it's a combination of renaming not working on the lower layer of a union filesystem and a bug in the JDK. Briefly the JDK tries to do the following:\r\n - if it's an atomic move, try to rename the source to target and if that fails with `EXDEV`, throw atomic move not supported\r\n - if it's not an atomic move, try to rename the source except this time do not fail if `EXDEV` occurred\r\n - when the previous rename fails, copy source to target and now try to `rmdir` the source; the bug is that `rmdir` requires the source to be empty but the JDK never cleans up the source so this will fail 100% of the time\r\n\r\n>I'd much rather get an official image without x-pack altogether, but thats a business decision I guess. Making x-pack hard to uninstall will drive me to community images for sure.\r\n\r\nYour feedback here is very much appreciated. I want you to know that we are not intentionally making it difficult to uninstall X-Pack, we will prepare a fix for this for 5.4.0.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296269019","html_url":"https://github.com/elastic/elasticsearch/issues/24231#issuecomment-296269019","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24231","id":296269019,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjI2OTAxOQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-04-21T18:33:57Z","updated_at":"2017-04-21T18:33:57Z","author_association":"MEMBER","body":"> We will prepare a fix for this for 5.4.0.\r\n\r\nI've opened #24252. We are going to try to get this into a 5.3.2 release (do not take that as a guarantee). I've built a new Docker image locally based off this change and the issue no longer reproduces.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296446050","html_url":"https://github.com/elastic/elasticsearch/issues/24231#issuecomment-296446050","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24231","id":296446050,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjQ0NjA1MA==","user":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"created_at":"2017-04-23T14:12:06Z","updated_at":"2017-04-23T14:12:06Z","author_association":"CONTRIBUTOR","body":"Thanks for taking care of this @jasontedor and reporting it @tback. I've taken a note to add an acceptance test for removing plugins in our docker image building acceptance tests. This will most likely land in 5.4.0 where we have introduced a [more flexible acceptance test framework](https://github.com/elastic/elasticsearch-docker/tree/switch-to-centosbase/tests).","performed_via_github_app":null}]