[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/639623701","html_url":"https://github.com/elastic/elasticsearch/issues/57749#issuecomment-639623701","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57749","id":639623701,"node_id":"MDEyOklzc3VlQ29tbWVudDYzOTYyMzcwMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-06-05T16:47:19Z","updated_at":"2020-06-05T16:47:19Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security (:Security/Authentication)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/639636724","html_url":"https://github.com/elastic/elasticsearch/issues/57749#issuecomment-639636724","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57749","id":639636724,"node_id":"MDEyOklzc3VlQ29tbWVudDYzOTYzNjcyNA==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2020-06-05T17:07:00Z","updated_at":"2020-06-05T17:07:00Z","author_association":"MEMBER","body":"Some possible causes could be https://bugs.openjdk.java.net/browse/JDK-8160818 and/or https://bugs.openjdk.java.net/browse/JDK-8239385.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/666047846","html_url":"https://github.com/elastic/elasticsearch/issues/57749#issuecomment-666047846","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57749","id":666047846,"node_id":"MDEyOklzc3VlQ29tbWVudDY2NjA0Nzg0Ng==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-07-30T02:30:51Z","updated_at":"2020-07-30T13:59:52Z","author_association":"MEMBER","body":"**TLDR**: This is *not* really a Kerberos issue, but mainly an issue about localised DateFormat. It manifests itself in this particular test and version due to interactions among Java 15, Apache Kerby library and our test setup.\r\n\r\nI spent quite some time digging into this and here are the details:\r\n\r\n1. JDK 9 introduced [i18n enhancements](https://docs.oracle.com/javase/9/intl/internationalization-enhancements-jdk-9.htm#JSINT-GUID-AF5AECA7-07C1-4E7D-BC10-BC7E73DC6C7F) which makes [`CLRD`](http://cldr.unicode.org/index) the default locale data. It was previously `JRE`. This broke some of our date related code and was addressed by passing `java.locale.providers=COMPAT` (#28080). This is in effect since v6.2. But it does not affect tests as it was added into `jvm.options` file.\r\n2. #48209 added the above setting to tests and this change is for `v7.6+`, so `v6.8` is left out. (The PR also added `SPI` as a provider but it does not impact the behaviour we are discussing here)\r\n3. But so far the test still worked because`java.time.format.DateTimeFormatter` did not honor the default locale values. But JDK 15 [b23](https://jdk.java.net/15/release-notes) fixed it with [JDK-8244245](https://bugs.openjdk.java.net/browse/JDK-8244245). This means if numbers have different representations other than ASCII digits, i.e. 0-9, they will be honored when a date string is formatted. For an example, `2020` is `২০২০` with Locale `mni-Beng-IN` (Manipuri India Bangla).\r\n4. When prepare the Kerberos response, the Apache Kerby library [uses system locale for date string, but then asks for bytes in `US_ASCII` encoding](https://github.com/apache/directory-kerby/blob/trunk/kerby-common/kerby-asn1/src/main/java/org/apache/kerby/asn1/type/Asn1GeneralizedTime.java#L83-L91). The result bytes will be incorrect when the date representation is an unicode string like `২০২০`. The Kerberos response will hence be mal-formatted.\r\n5. JDK's [`sun.security.krb5.internal.KerberosTime`](https://github.com/openjdk/jdk15/blob/master/src/java.base/share/classes/sun/security/util/DerInputBuffer.java#L290-L308) only supports ASCII encoded date strings, e.g. `20200730020307Z`, it breaks when it sees the above mal-formatted Kerberos response. This in turn leads to the symptom of this test failure, i.e. `java.io.IOException: Parse Generalized time, invalid format`.\r\n\r\n**So in summary, item 2 from above list is the critical piece that is missing from `v6.8`**. This can be fixed by adding `java.locale.providers=SPI,COMPAT` to the specific [gradle file](https://github.com/elastic/elasticsearch/blob/6.8/x-pack/qa/evil-tests/build.gradle) of this test. However, I wonder whether it's better to add it for all tests so they are consistent with production code and `v7.6+`. I am a bit surprised we haven't seen more failures similar to this for the `v6.8` branch. Maybe because we still use Joda time for this branch and it works differently? I'll talk to @elastic/es-core-infra to formulate a solution.\r\n\r\nI am also thinking raising an issue for Apache Kerby to always encode the date string in an ASCII compatible way regardless of the system locale. Since JDK's Kerberos implementation does not support anything other than ASCII, it makes more sense to ensure it. Also the Kerberos spec itself does [recognise](https://tools.ietf.org/html/rfc4120#section-5.2.1) it has issues in supporting full i18n. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/666885397","html_url":"https://github.com/elastic/elasticsearch/issues/57749#issuecomment-666885397","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57749","id":666885397,"node_id":"MDEyOklzc3VlQ29tbWVudDY2Njg4NTM5Nw==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-07-31T02:57:21Z","updated_at":"2020-07-31T02:57:21Z","author_association":"MEMBER","body":"Fixed by #60447 \r\nAlso raised an [issue](https://issues.apache.org/jira/browse/DIRKRB-747) for Apach Kerby.","performed_via_github_app":null}]