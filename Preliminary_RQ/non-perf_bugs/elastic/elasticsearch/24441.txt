{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24441","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24441/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24441/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24441/events","html_url":"https://github.com/elastic/elasticsearch/issues/24441","id":225817723,"node_id":"MDU6SXNzdWUyMjU4MTc3MjM=","number":24441,"title":"Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect fails in CI","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"labels":[{"id":146854632,"node_id":"MDU6TGFiZWwxNDY4NTQ2MzI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Network","name":":Distributed/Network","color":"0e8a16","default":false,"description":"Http and internode communication implementations"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-05-02T20:52:20Z","updated_at":"2017-08-11T23:41:13Z","closed_at":"2017-08-01T10:47:49Z","author_association":"MEMBER","active_lock_reason":null,"body":"It seems to be a very rare (once a month) failure. \r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=debian/915/console\r\n\r\n```\r\nHEARTBEAT J0 PID(2364@slave-0839e2b7606980b02.build.us-west-2a.elasticnet.co): 2017-05-02T20:05:14, stalled for 10.7s at: Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect\r\nHEARTBEAT J0 PID(2364@slave-0839e2b7606980b02.build.us-west-2a.elasticnet.co): 2017-05-02T20:05:24, stalled for 20.7s at: Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect\r\nHEARTBEAT J0 PID(2364@slave-0839e2b7606980b02.build.us-west-2a.elasticnet.co): 2017-05-02T20:05:34, stalled for 30.7s at: Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect\r\nHEARTBEAT J0 PID(2364@slave-0839e2b7606980b02.build.us-west-2a.elasticnet.co): 2017-05-02T20:05:44, stalled for 40.7s at: Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect\r\nHEARTBEAT J0 PID(2364@slave-0839e2b7606980b02.build.us-west-2a.elasticnet.co): 2017-05-02T20:05:54, stalled for 50.7s at: Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect\r\nSuite: org.elasticsearch.transport.netty4.Netty4TransportMultiPortIntegrationIT\r\n  1> [2017-05-03T04:05:04,043][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] [testThatTransportClientCanConnect]: before test\r\n  1> [2017-05-03T04:05:04,045][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] [Netty4TransportMultiPortIntegrationIT#testThatTransportClientCanConnect]: setting up test\r\n  1> [2017-05-03T04:05:04,047][INFO ][o.e.t.InternalTestCluster] Setup InternalTestCluster [SUITE-CHILD_VM=[0]-CLUSTER_SEED=[-8360166899008743675]-HASH=[7A680CFBE5624]-cluster] with seed [8BFAB87FD99AD705] using [0] dedicated masters, [1] (data) nodes and [0] coord only nodes (min_master_nodes are [auto-managed])\r\n  1> [2017-05-03T04:05:04,052][INFO ][o.e.n.Node               ] [node_s0] initializing ...\r\n  1> [2017-05-03T04:05:04,056][INFO ][o.e.e.NodeEnvironment    ] [node_s0] using [1] data paths, mounts [[/ (rootfs)]], net usable_space [368.4gb], net total_space [492gb], spins? [unknown], types [rootfs]\r\n  1> [2017-05-03T04:05:04,056][INFO ][o.e.e.NodeEnvironment    ] [node_s0] heap size [491mb], compressed ordinary object pointers [true]\r\n  1> [2017-05-03T04:05:04,057][INFO ][o.e.n.Node               ] [node_s0] node name [node_s0], node ID [r1bYfe5XTdesisdNlVnssA]\r\n  1> [2017-05-03T04:05:04,057][INFO ][o.e.n.Node               ] [node_s0] version[6.0.0-alpha1-SNAPSHOT], pid[2364], build[6fcd24d/2017-05-02T19:35:56.330Z], OS[Linux/3.16.0-4-amd64/amd64], JVM[Oracle Corporation/OpenJDK 64-Bit Server VM/1.8.0_121/25.121-b13]\r\n  1> [2017-05-03T04:05:04,057][WARN ][o.e.n.Node               ] [node_s0] version [6.0.0-alpha1-SNAPSHOT] is a pre-release version of Elasticsearch and is not suitable for production\r\n  1> [2017-05-03T04:05:04,058][INFO ][o.e.p.PluginsService     ] [node_s0] no modules loaded\r\n  1> [2017-05-03T04:05:04,058][INFO ][o.e.p.PluginsService     ] [node_s0] loaded plugin [org.elasticsearch.index.MockEngineFactoryPlugin]\r\n  1> [2017-05-03T04:05:04,058][INFO ][o.e.p.PluginsService     ] [node_s0] loaded plugin [org.elasticsearch.node.NodeMocksPlugin]\r\n  1> [2017-05-03T04:05:04,058][INFO ][o.e.p.PluginsService     ] [node_s0] loaded plugin [org.elasticsearch.test.ESIntegTestCase$TestSeedPlugin]\r\n  1> [2017-05-03T04:05:04,058][INFO ][o.e.p.PluginsService     ] [node_s0] loaded plugin [org.elasticsearch.test.discovery.TestZenDiscovery$TestPlugin]\r\n  1> [2017-05-03T04:05:04,058][INFO ][o.e.p.PluginsService     ] [node_s0] loaded plugin [org.elasticsearch.transport.Netty4Plugin]\r\n  1> [2017-05-03T04:05:04,083][INFO ][o.e.d.DiscoveryModule    ] [node_s0] using discovery type [test-zen]\r\n  1> [2017-05-03T04:05:04,147][INFO ][o.e.n.Node               ] [node_s0] initialized\r\n  1> [2017-05-03T04:05:04,148][INFO ][o.e.n.Node               ] [node_s0] starting ...\r\n  1> [2017-05-03T04:05:04,159][INFO ][o.e.t.TransportService   ] [node_s0] publish_address {127.0.0.1:9420}, bound_addresses {127.0.0.1:9420}\r\n  1> [2017-05-03T04:05:04,159][INFO ][o.e.t.TransportService   ] [node_s0] profile [client1]: publish_address {127.0.0.7:4321}, bound_addresses {127.0.0.1:49842}\r\n  1> [2017-05-03T04:05:04,161][INFO ][o.e.t.d.MockZenPing      ] [node_s0] pinging using mock zen ping\r\n  1> [2017-05-03T04:05:04,168][INFO ][o.e.c.s.MasterService    ] [node_s0] zen-disco-elected-as-master ([0] nodes joined), reason: new_master {node_s0}{r1bYfe5XTdesisdNlVnssA}{fG9GAd_uRBKQKSnUH8ubUw}{127.0.0.1}{127.0.0.1:9420}\r\n  1> [2017-05-03T04:05:04,168][INFO ][o.e.c.s.ClusterApplierService] [node_s0] new_master {node_s0}{r1bYfe5XTdesisdNlVnssA}{fG9GAd_uRBKQKSnUH8ubUw}{127.0.0.1}{127.0.0.1:9420}, reason: apply cluster state (from master [master {node_s0}{r1bYfe5XTdesisdNlVnssA}{fG9GAd_uRBKQKSnUH8ubUw}{127.0.0.1}{127.0.0.1:9420} committed version [1] source [zen-disco-elected-as-master ([0] nodes joined)]])\r\n  1> [2017-05-03T04:05:04,170][INFO ][o.e.n.Node               ] [node_s0] started\r\n  1> [2017-05-03T04:05:04,172][INFO ][o.e.p.PluginsService     ] [transport_client_node_s0] no modules loaded\r\n  1> [2017-05-03T04:05:04,172][INFO ][o.e.p.PluginsService     ] [transport_client_node_s0] loaded plugin [org.elasticsearch.transport.MockTcpTransportPlugin]\r\n  1> [2017-05-03T04:05:04,172][INFO ][o.e.p.PluginsService     ] [transport_client_node_s0] loaded plugin [org.elasticsearch.transport.Netty4Plugin]\r\n  1> [2017-05-03T04:05:04,185][INFO ][o.e.g.GatewayService     ] [node_s0] recovered [0] indices into cluster_state\r\n  1> [2017-05-03T04:05:04,232][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] test using _default_ mappings: [{\"_default_\":{}}]\r\n  1> [2017-05-03T04:05:04,251][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] [Netty4TransportMultiPortIntegrationIT#testThatTransportClientCanConnect]: all set up test\r\n  1> [2017-05-03T04:05:04,252][INFO ][o.e.p.PluginsService     ] [_client_] no modules loaded\r\n  1> [2017-05-03T04:05:04,252][INFO ][o.e.p.PluginsService     ] [_client_] loaded plugin [org.elasticsearch.transport.MockTcpTransportPlugin]\r\n  1> [2017-05-03T04:05:04,252][INFO ][o.e.p.PluginsService     ] [_client_] loaded plugin [org.elasticsearch.transport.Netty4Plugin]\r\n  1> [2017-05-03T04:06:04,284][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] [Netty4TransportMultiPortIntegrationIT#testThatTransportClientCanConnect]: cleaning up after test\r\n  1> [2017-05-03T04:06:04,298][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] [Netty4TransportMultiPortIntegrationIT#testThatTransportClientCanConnect]: cleaned up after test\r\n  1> [2017-05-03T04:06:04,298][INFO ][o.e.t.n.Netty4TransportMultiPortIntegrationIT] [testThatTransportClientCanConnect]: after test\r\n  2> REPRODUCE WITH: gradle :modules:transport-netty4:integTestRunner -Dtests.seed=B4AE4510293F228B -Dtests.class=org.elasticsearch.transport.netty4.Netty4TransportMultiPortIntegrationIT -Dtests.method=\"testThatTransportClientCanConnect\" -Dtests.security.manager=true -Dtests.locale=ca-ES -Dtests.timezone=Asia/Irkutsk\r\nERROR   60.3s | Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect <<< FAILURES!\r\n   > Throwable #1: NoNodeAvailableException[None of the configured nodes are available: [{#transport#-1}{9K55aiuUS9-vLxxhs1AXDg}{127.0.0.1}{127.0.0.1:49841}]]\r\n   > \tat __randomizedtesting.SeedInfo.seed([B4AE4510293F228B:50041AA92CBCDAF1]:0)\r\n   > \tat org.elasticsearch.client.transport.TransportClientNodesService.ensureNodesAreAvailable(TransportClientNodesService.java:347)\r\n   > \tat org.elasticsearch.client.transport.TransportClientNodesService.execute(TransportClientNodesService.java:245)\r\n   > \tat org.elasticsearch.client.transport.TransportProxyClient.execute(TransportProxyClient.java:59)\r\n   > \tat org.elasticsearch.client.transport.TransportClient.doExecute(TransportClient.java:357)\r\n   > \tat org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:405)\r\n   > \tat org.elasticsearch.client.support.AbstractClient$ClusterAdmin.execute(AbstractClient.java:727)\r\n   > \tat org.elasticsearch.action.ActionRequestBuilder.execute(ActionRequestBuilder.java:77)\r\n   > \tat org.elasticsearch.action.ActionRequestBuilder.execute(ActionRequestBuilder.java:51)\r\n   > \tat org.elasticsearch.action.ActionRequestBuilder.get(ActionRequestBuilder.java:59)\r\n   > \tat org.elasticsearch.transport.netty4.Netty4TransportMultiPortIntegrationIT.testThatTransportClientCanConnect(Netty4TransportMultiPortIntegrationIT.java:80)\r\n   > \tat java.lang.Thread.run(Thread.java:745)\r\nIGNOR/A 0.00s | Netty4TransportMultiPortIntegrationIT.testThatInfosAreExposed\r\n   > Assumption #1: 'network' test group is disabled (@Network())\r\n  1> [2017-05-03T04:06:04,312][INFO ][o.e.n.Node               ] [node_s0] stopping ...\r\n  1> [2017-05-03T04:06:04,319][INFO ][o.e.n.Node               ] [node_s0] stopped\r\n  1> [2017-05-03T04:06:04,320][INFO ][o.e.n.Node               ] [node_s0] closing ...\r\n  1> [2017-05-03T04:06:04,322][INFO ][o.e.n.Node               ] [node_s0] closed\r\n  2> NOTE: leaving temporary files on disk at: /var/lib/jenkins/workspace/elastic+elasticsearch+master+multijob-unix-compatibility/os/debian/modules/transport-netty4/build/testrun/integTestRunner/J0/temp/org.elasticsearch.transport.netty4.Netty4TransportMultiPortIntegrationIT_B4AE4510293F228B-001\r\n  2> May 02, 2017 8:06:04 PM com.carrotsearch.randomizedtesting.ThreadLeakControl checkThreadLeaks\r\n  2> WARNING: Will linger awaiting termination of 2 leaked thread(s).\r\n  2> NOTE: test params are: codec=Asserting(Lucene70): {}, docValues:{}, maxPointsInLeafNode=266, maxMBSortInHeap=7.273224578077655, sim=RandomSimilarity(queryNorm=true): {}, locale=ca-ES, timezone=Asia/Irkutsk\r\n  2> NOTE: Linux 3.16.0-4-amd64 amd64/Oracle Corporation 1.8.0_121 (64-bit)/cpus=4,threads=1,free=281663728,total=520093696\r\n  2> NOTE: All tests run in this JVM: [Netty4PipeliningDisabledIT, Netty4TransportMultiPortIntegrationIT]\r\n```\r\n\r\nWhen I ran it locally with the same seed it I noticed that the clien1 binds to port 49841, but in case of the failure it binds to the port 49842:\r\nsuccessful run:\r\n```\r\n  1> [2017-05-03T04:38:21,503][INFO ][o.e.t.TransportService   ] [node_s0] profile [client1]: publish_address {127.0.0.7:4321}, bound_addresses {127.0.0.1:49841}\r\n```\r\nfailed run:\r\n```\r\n  1> [2017-05-03T04:05:04,159][INFO ][o.e.t.TransportService   ] [node_s0] profile [client1]: publish_address {127.0.0.7:4321}, bound_addresses {127.0.0.1:49842}\r\n```\r\n\r\nIt seems that if the randomly selected port is not available, the client binds to the next available port and the test fails. \r\n\r\nI was able to reproduce the issue locally by running the test with the seed while running another server on port `49841`.\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}