{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32661","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32661/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32661/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32661/events","html_url":"https://github.com/elastic/elasticsearch/issues/32661","id":348113942,"node_id":"MDU6SXNzdWUzNDgxMTM5NDI=","number":32661,"title":"handling changes in the structure of path.data when upgrading from 2.x to 5.x to 6.x","user":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"assignees":[{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":16,"created_at":"2018-08-06T23:22:57Z","updated_at":"2019-01-02T19:06:36Z","closed_at":"2019-01-02T19:06:35Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When a 2.x cluster is created, the structure of `path.data` has all contents for a node inside a directory named after the cluster name. This was changed in 5.x (https://github.com/elastic/elasticsearch/pull/18554) to remove the directory with the cluster name and move its contents up a level. A 5.x cluster will still read the 2.x structure correctly. In 6.x this backwards compatible behavior is removed (https://github.com/elastic/elasticsearch/pull/20433), and if a 6.x node is started with a data directory using the old 2.x structure, it will see it as if it was empty and ignore the existing data.\r\n\r\nThis change is mentioned [in the 5.0 breaking change docs](https://github.com/elastic/elasticsearch/blame/56318153c8cdac28c86e7d72f18194e2f7e0b7e4/docs/reference/migration/migrate_5_0/fs.asciidoc#L12-L25) and [in the 6.0 breaking change docs](https://github.com/elastic/elasticsearch/blame/6.x/docs/reference/migration/migrate_6_0/cluster.asciidoc#L4-L27). The 6.0 breaking change docs say\r\n\r\n```\r\n# Assuming path.data is /tmp/mydata\r\n# No longer supported:\r\n\r\n$ tree /tmp/mydata\r\n/tmp/mydata\r\n├── <cluster_name>\r\n│   └── nodes\r\n│       └── 0\r\n│           └── <etc>\r\n\r\n# Should be changed to:\r\n\r\n$ tree /tmp/mydata\r\n/tmp/mydata\r\n├── nodes\r\n│   └── 0\r\n│       └── <etc>\r\n```\r\n\r\nIt would be reasonable for a user to read this and not take away from it \"you will need to manually move the `nodes` directory up a level inside `path.data` and remove the cluster name directory\"\r\n\r\nIt doesn't look like the migration plugin for 2.x to 5.x checks for this. The upgrade assistant for 5.x to 6.x does warn you if you have your cluster name in `path.data`, but doesn't warn about your `path.data` contents using the 2.x and earlier structure. \r\n\r\nThe outcome of this is that users upgrading from 2.x to 5.x to 6.x may reasonably not understand they have to manually make changes to the contents of `path.data`, and end up with a failed 5.x -> 6.x upgrade. It seems like users would benefit from\r\n\r\n1. It being made explicit how they are expected to handle this change when upgrading. For example, the relevant breaking changes doc (should this be in the 5.0 or 6.0 docs?) could read something like \"before upgrading you will need to move the `nodes` directory up one level so it is directly inside `path.data`, and remove the now-empty directory named after your cluster\" and include some example commands\r\n\r\n2. (This ship maybe already sailed) The 5.x to 6.x upgrade assistant warning if it finds that the contents of `path.data` are organized with the old 2.x structure - I also realize now that the upgrade assistant may not actually be able to do this since it's running in kibana\r\n\r\n3. (Maybe excessive) 6.x and later nodes refusing to start if they find the old 2.x structure inside their `path.data`","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}