{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22766","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22766/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22766/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22766/events","html_url":"https://github.com/elastic/elasticsearch/issues/22766","id":202796084,"node_id":"MDU6SXNzdWUyMDI3OTYwODQ=","number":22766,"title":"Combining template queries with aggregations do not work as expected","user":{"login":"jomarl","id":2825496,"node_id":"MDQ6VXNlcjI4MjU0OTY=","avatar_url":"https://avatars3.githubusercontent.com/u/2825496?v=4","gravatar_id":"","url":"https://api.github.com/users/jomarl","html_url":"https://github.com/jomarl","followers_url":"https://api.github.com/users/jomarl/followers","following_url":"https://api.github.com/users/jomarl/following{/other_user}","gists_url":"https://api.github.com/users/jomarl/gists{/gist_id}","starred_url":"https://api.github.com/users/jomarl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jomarl/subscriptions","organizations_url":"https://api.github.com/users/jomarl/orgs","repos_url":"https://api.github.com/users/jomarl/repos","events_url":"https://api.github.com/users/jomarl/events{/privacy}","received_events_url":"https://api.github.com/users/jomarl/received_events","type":"User","site_admin":false},"labels":[{"id":146829143,"node_id":"MDU6TGFiZWwxNDY4MjkxNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Transport%20API","name":":Core/Infra/Transport API","color":"0e8a16","default":false,"description":"Transport client API"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"assignees":[{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2017-01-24T11:46:03Z","updated_at":"2018-02-14T13:42:32Z","closed_at":"2018-01-10T14:45:08Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**:\r\n5.1.2\r\n\r\n**Plugins installed**: [Phonetic Analysis, X-Pack] \r\n\r\n**JVM version**:\r\n1.8.0_101-b13\r\n\r\n**OS version**:\r\nLinux Mint 17\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nAggregations added to a SearchRequest are ignored when used in combination with SearchTemplateRequestBuilder. The same go for any size/from parameters.\r\n\r\nWe use a lot of templates in combination with some common aggregations that are added to many of our searches, and in the process of migrating to ES 5.1.2 from ES 1.6 we are unable to use this combination. Is this not longer possible in ES 5.1.2 or are we doing this the wrong way? We do not want to duplicate the aggregations to every search template we use - or is that the only way?\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\nSearchRequestBuilder builder = esClient.prepareSearch(\"xx\")) .setTypes(\"xx\").builder.setSize(200);\r\n\r\nbuilder.addAggregation(\r\n      AggregationBuilders.terms(\"country\")\r\n                    .field(\"country.raw\")\r\n                    .order(Terms.Order.term(true))\r\n                    .size(100)\r\n                    .valueType(ValueType.STRING)\r\n);\r\n\r\nSearchTemplateRequestBuilder templateBuilder = new SearchTemplateRequestBuilder(esClient)\r\n                        .setRequest(builder.request())\r\n                        .setScript(templateName)\r\n                        .setScriptType(ScriptType.FILE)\r\n                        .setScriptParams(templateParams);\r\n\r\nresponse = templateBuilder.get();\r\n\r\nassertNotNull(templateBuilder.get().getAggregations()); //fails \r\nassertEquals(response.getHits().getHits().length, 200); //fails - give 10/default\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n\r\n**Describe the feature**:\r\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}