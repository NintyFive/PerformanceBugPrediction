{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44474","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44474/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44474/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44474/events","html_url":"https://github.com/elastic/elasticsearch/issues/44474","id":469015039,"node_id":"MDU6SXNzdWU0NjkwMTUwMzk=","number":44474,"title":"False positives/Unexpected results using percolation with search","user":{"login":"karlbanke","id":6724482,"node_id":"MDQ6VXNlcjY3MjQ0ODI=","avatar_url":"https://avatars3.githubusercontent.com/u/6724482?v=4","gravatar_id":"","url":"https://api.github.com/users/karlbanke","html_url":"https://github.com/karlbanke","followers_url":"https://api.github.com/users/karlbanke/followers","following_url":"https://api.github.com/users/karlbanke/following{/other_user}","gists_url":"https://api.github.com/users/karlbanke/gists{/gist_id}","starred_url":"https://api.github.com/users/karlbanke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/karlbanke/subscriptions","organizations_url":"https://api.github.com/users/karlbanke/orgs","repos_url":"https://api.github.com/users/karlbanke/repos","events_url":"https://api.github.com/users/karlbanke/events{/privacy}","received_events_url":"https://api.github.com/users/karlbanke/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-07-17T06:40:22Z","updated_at":"2020-02-25T12:28:56Z","closed_at":"2020-02-25T12:28:56Z","author_association":"NONE","active_lock_reason":null,"body":"We are running Elasticsearch 6.2 as an AWS managed service. Configuration has 3 data nodes and 2 dedicated master nodes but the same condition can be observed using a single elasticsearch node only. \r\n\r\nAfter indexing items, we run percolations against user stored queries passing in the item as a datastructure. We are sorting the documents using the following code in order to use search after for large number of results. \r\n\r\n`  \"sort\": [\r\n    {\r\n      \"_id\": {\r\n        \"order\": \"asc\"\r\n      }\r\n    }\r\n  ],\r\n`\r\nWhen the sort condition is present, we observe that sometimes we get a very large number of matched percolators.\r\n\r\nThe percolator query is performed as as shown below. Note that this behaviour is intermittent and only observed for some documents. Once it has been observed for one document it can be reproduced with the same document.\r\n\r\n`\r\n{\r\n  \"size\": \"1000\",\r\n  \"sort\": [\r\n    {\r\n      \"_id\": {\r\n        \"order\": \"asc\"\r\n      }\r\n    }\r\n  ],\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"document\": {\r\n        \"select_feeds\": [\r\n          \"sel_Greenpeaceplattform\",\r\n          \"sel_VolkswagenAG\"\r\n        ],\r\n        \"category\": [\r\n          \"http://g2.dpa.com/cv/category/pl\"\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\r\n`\r\n\r\nIn the returned result we get back 18 out of 21 indexed percolator queries. However for most of these the snippet\r\n\r\n`\r\n\"fields\": {\r\n                    \"_percolator_document_slot\": [\r\n                        0\r\n                    ]\r\n                }\r\n`\r\n\r\nis entirely missing. On short, when we sort\r\n\r\n- 13 matching and non matching results out of 21 queries are returned\r\n- Only five have the _percolator_document_slot set\r\n- _score is null (expected)\r\n\r\nWhen we do not sort \r\n\r\n- 5 matching results are returned\r\n- All have the _percolator_document_slot set\r\n- _score is set\r\n\r\nWhen we sort and use \"track_scores\": true\r\n\r\n- 5 matching results are returned\r\n- All have the _percolator_document_slot set\r\n- _score is set\r\n\r\nWhen we query only a single \"select_feed\" item.\r\n\r\n- Only matching items are returned\r\n- All have the _percolator_document_slot set\r\n- _score is null (expected)\r\n\r\nFron my understanding, from the documentation of the percolator query, it should never return queries that do not match the document. When percolating a single document using the \"_percolator_document_slot\" is neither required nor expected. (\"The _percolator_document_slot field indicates which document has matched with this query. Useful when percolating multiple document simultaneously.\").\r\n\r\nBelow find the full result list\r\n\r\n`\r\n{\r\n    \"took\": 6,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"skipped\": 0,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 2,\r\n        \"max_score\": null,\r\n        \"hits\": [\r\n            {\r\n                \"_index\": \"filterbadges\",\r\n                \"_type\": \"newsitem\",\r\n                \"_id\": \"https://devel.dpa-select.de/filters/api/v1/27fcf210-a7d2-11e9-a970-819ba8e9b221\",\r\n                \"_score\": null,\r\n                \"_source\": {\r\n                    \"meta\": {\r\n                        \"owner\": \"banke@mecom.de\",\r\n                        \"name\": \"Politik\",\r\n                        \"link\": \"https://devel.dpa-select.de/filters/api/v1/27fcf210-a7d2-11e9-a970-819ba8e9b221\",\r\n                        \"isPublic\": false\r\n                    },\r\n                    \"query\": {\r\n                        \"bool\": {\r\n                            \"must\": [\r\n                                {\r\n                                    \"bool\": {\r\n                                        \"must\": [\r\n                                            {\r\n                                                \"bool\": {\r\n                                                    \"adjust_pure_negative\": true,\r\n                                                    \"boost\": 1\r\n                                                }\r\n                                            },\r\n                                            {\r\n                                                \"bool\": {\r\n                                                    \"should\": [\r\n                                                        {\r\n                                                            \"terms\": {\r\n                                                                \"category\": [\r\n                                                                    \"http://g2.dpa.com/cv/category/pl\"\r\n                                                                ],\r\n                                                                \"boost\": 1\r\n                                                            }\r\n                                                        }\r\n                                                    ],\r\n                                                    \"adjust_pure_negative\": true,\r\n                                                    \"boost\": 1\r\n                                                }\r\n                                            }\r\n                                        ],\r\n                                        \"adjust_pure_negative\": true,\r\n                                        \"boost\": 1\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"terms\": {\r\n                                        \"select_feeds\": [\r\n                                            \"sel_SpringerFachmedien\",\r\n                                            \"sel_VolkswagenAG\"\r\n                                        ],\r\n                                        \"boost\": 1\r\n                                    }\r\n                                }\r\n                            ],\r\n                            \"adjust_pure_negative\": true,\r\n                            \"boost\": 1\r\n                        }\r\n                    }\r\n                },\r\n                \"fields\": {\r\n                    \"_percolator_document_slot\": [\r\n                        0\r\n                    ]\r\n                },\r\n                \"sort\": [\r\n                    \"https://devel.dpa-select.de/filters/api/v1/27fcf210-a7d2-11e9-a970-819ba8e9b221\"\r\n                ]\r\n            },\r\n            {\r\n                \"_index\": \"filterbadges\",\r\n                \"_type\": \"newsitem\",\r\n                \"_id\": \"https://devel.dpa-select.de/filters/api/v1/a5180380-4f16-11e9-9db3-219dda5eaa59\",\r\n                \"_score\": null,\r\n                \"_source\": {\r\n                    \"meta\": {\r\n                        \"owner\": \"andrew@factorial.io\",\r\n                        \"name\": \"Politik\",\r\n                        \"link\": \"https://devel.dpa-select.de/filters/api/v1/a5180380-4f16-11e9-9db3-219dda5eaa59\",\r\n                        \"isPublic\": false\r\n                    },\r\n                    \"query\": {\r\n                        \"bool\": {\r\n                            \"must\": [\r\n                                {\r\n                                    \"bool\": {\r\n                                        \"must\": [\r\n                                            {\r\n                                                \"bool\": {\r\n                                                    \"should\": [\r\n                                                        {\r\n                                                            \"terms\": {\r\n                                                                \"category\": [\r\n                                                                    \"http://g2.dpa.com/cv/category/pl\"\r\n                                                                ],\r\n                                                                \"boost\": 1\r\n                                                            }\r\n                                                        }\r\n                                                    ],\r\n                                                    \"adjust_pure_negative\": true,\r\n                                                    \"boost\": 1\r\n                                                }\r\n                                            }\r\n                                        ],\r\n                                        \"adjust_pure_negative\": true,\r\n                                        \"boost\": 1\r\n                                    }\r\n                                },\r\n                                {\r\n                                    \"terms\": {\r\n                                        \"select_feeds\": [\r\n                                            \"sel_Greenpeaceplattform\",\r\n                                            \"sel_IHKBerlin\",\r\n                                            \"sel_VolkswagenAG\",\r\n                                            \"select_afx_test\"\r\n                                        ],\r\n                                        \"boost\": 1\r\n                                    }\r\n                                }\r\n                            ],\r\n                            \"adjust_pure_negative\": true,\r\n                            \"boost\": 1\r\n                        }\r\n                    }\r\n                },\r\n                \"fields\": {\r\n                    \"_percolator_document_slot\": [\r\n                        0\r\n                    ]\r\n                },\r\n                \"sort\": [\r\n                    \"https://devel.dpa-select.de/filters/api/v1/a5180380-4f16-11e9-9db3-219dda5eaa59\"\r\n                ]\r\n            }\r\n        ]\r\n    }\r\n}\r\n`\r\n","closed_by":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}