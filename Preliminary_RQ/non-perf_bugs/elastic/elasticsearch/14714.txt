{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14714","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14714/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14714/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14714/events","html_url":"https://github.com/elastic/elasticsearch/issues/14714","id":116578344,"node_id":"MDU6SXNzdWUxMTY1NzgzNDQ=","number":14714,"title":"[Before 2.0.0] QueryParsingException - not of nested type","user":{"login":"JustinHook","id":195578,"node_id":"MDQ6VXNlcjE5NTU3OA==","avatar_url":"https://avatars0.githubusercontent.com/u/195578?v=4","gravatar_id":"","url":"https://api.github.com/users/JustinHook","html_url":"https://github.com/JustinHook","followers_url":"https://api.github.com/users/JustinHook/followers","following_url":"https://api.github.com/users/JustinHook/following{/other_user}","gists_url":"https://api.github.com/users/JustinHook/gists{/gist_id}","starred_url":"https://api.github.com/users/JustinHook/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JustinHook/subscriptions","organizations_url":"https://api.github.com/users/JustinHook/orgs","repos_url":"https://api.github.com/users/JustinHook/repos","events_url":"https://api.github.com/users/JustinHook/events{/privacy}","received_events_url":"https://api.github.com/users/JustinHook/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-11-12T15:54:38Z","updated_at":"2015-11-17T14:19:22Z","closed_at":"2015-11-17T14:19:22Z","author_association":"NONE","active_lock_reason":null,"body":"The below steps cause a query to fail with a `QueryParsingException` that seems to be fixed by either restarting elasticsearch or reindexing the data.\n\nI've tested on all versions from 1.4.2 to 2.0.0. Only on version 2.0.0 does step 4 not throw an exception.\n\n**1. Create mappings (2 nested fields)**\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/product' -d '\n{\n  \"mappings\": {\n    \"release\": {\n      \"properties\": {\n        \"formats\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"format_id\": {\n              \"type\": \"integer\"\n            }\n          }\n        },\n        \"prices\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"supplier_short_name\": {\n              \"type\": \"string\",\n              \"index\": \"not_analyzed\"\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n\n`{\"acknowledged\":true}`\n\n**2. Insert document**\n\n```\ncurl -XPUT 'http://127.0.0.1:9200/product/release/MUS-REL-0003017001' -d '\n{\n    \"formats\": [\n        {\n            \"format_id\": 17\n        }\n    ],\n    \"prices\": [\n        {\n            \"supplier_short_name\": \"digital\"\n        }\n    ]\n}'\n```\n\n`{\"_index\":\"product\",\"_type\":\"release\",\"_id\":\"MUS-REL-0003017001\",\"_version\":1,\"created\":true}`\n\n**3. Try to update nested `formats` field with a string**\nUpdate will fail which is expected as we are trying to update a nested field with a string.\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/product/release/MUS-REL-0003017001/_update' -d '\n{\n  \"doc\": {\n    \"formats\": \"MP3 320\",\n    \"prices\": [\n      {\n        \"supplier_short_name\": \"digital\"\n      }\n    ]\n  }\n}'\n```\n\n`MapperParsingException[object mapping for [release] tried to parse as object, but got EOF, has a concrete value been provided to it?]`\n\n**4. Run the query**\nStep 3 causes this query to fail which is not expected. To get the query to run you can restart elasticsearch or reindex the data.\n\n```\ncurl -XPOST 'http://127.0.0.1:9200/product/release/_search' -d '\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"and\": [\n          {\n            \"nested\": {\n              \"path\": \"prices\",\n              \"filter\": {\n                \"and\": [\n                  {\n                    \"exists\": {\n                      \"field\": \"prices\"\n                    }\n                  }\n                ]\n              }\n            }\n          }\n        ]\n      }\n    }\n  }\n}'\n```\n\n`nested: QueryParsingException[[product] [nested] nested object under path [prices] is not of nested type]`\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}