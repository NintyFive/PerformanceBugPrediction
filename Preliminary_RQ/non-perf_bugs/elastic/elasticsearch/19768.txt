{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19768","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19768/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19768/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19768/events","html_url":"https://github.com/elastic/elasticsearch/issues/19768","id":169050763,"node_id":"MDU6SXNzdWUxNjkwNTA3NjM=","number":19768,"title":"scripted_metric _agg parameter disappears if params are provided","user":{"login":"consulthys","id":1280019,"node_id":"MDQ6VXNlcjEyODAwMTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1280019?v=4","gravatar_id":"","url":"https://api.github.com/users/consulthys","html_url":"https://github.com/consulthys","followers_url":"https://api.github.com/users/consulthys/followers","following_url":"https://api.github.com/users/consulthys/following{/other_user}","gists_url":"https://api.github.com/users/consulthys/gists{/gist_id}","starred_url":"https://api.github.com/users/consulthys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/consulthys/subscriptions","organizations_url":"https://api.github.com/users/consulthys/orgs","repos_url":"https://api.github.com/users/consulthys/repos","events_url":"https://api.github.com/users/consulthys/events{/privacy}","received_events_url":"https://api.github.com/users/consulthys/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-08-03T05:27:49Z","updated_at":"2017-11-08T08:45:48Z","closed_at":"2017-11-08T08:45:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When running a `scripted_metric` aggregation (in 2.3.x and 5.0.0-alpha4), if the user needs to specify some parameters in the  `params` section, the implicit `_agg` hashmap disappears.\n\nWhen running the following dummy query:\n\n```\nPOST index/type/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"testAgg\": {\n      \"scripted_metric\": {\n        \"params\": {\n          \"param1\": 10,\n          \"param2\": 20\n        },\n        \"init_script\": \"_agg['max'] = []\",\n        \"map_script\": \";\",\n        \"combine_script\": \";\",\n        \"reduce_script\": \";\"\n      }\n    }\n  }\n}\n```\n\nOne gets an error stating  `No such property: _agg for class: b0b7ce0d2dbb5254a703a6f4d048654c3f84857b`. There are obviously no errors without the `params` section.\n\nIn order for this to work, one needs to re-specify the `_agg` implicit parameter in the `params` section like this:\n\n```\nPOST index/type/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"testAgg\": {\n      \"scripted_metric\": {\n        \"params\": {\n          \"_agg\": {},\n          \"param1\": 10,\n          \"param2\": 20\n        },\n        \"init_script\": \"_agg['max'] = []\",\n        \"map_script\": \";\",\n        \"combine_script\": \";\",\n        \"reduce_script\": \";\"\n      }\n    }\n  }\n}\n```\n\nI'm not sure if this is done on purpose, but it feels a bit counterintuitive. The [official documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-scripted-metric-aggregation.html#_other_parameters) (see below) states that `_agg` is an implicit hashmap, but doesn't state that `_agg` needs to be explicitly re-defined if other parameters are defined in `params` .\n\n> If this is not specified, the default is the equivalent of providing:\n> \n> ```\n> \"params\" : {\n>    \"_agg\" : {}\n> }\n> ```\n\nI think this could be easily fixed by modifying [`ScriptedMetricAggregatorFactory.createInternal()`](https://github.com/elastic/elasticsearch/blob/0f00c14afc8428a2a72c0b766d2171029dc8f6e1/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregatorFactory.java#L64-L70) like this:\n\n```\n    Map<String, Object> params = this.params;\n    if (params != null) {\n        params = deepCopyParams(params, context.searchContext());\n    } else {\n        params = new HashMap<>();\n    }\n    if (!params.containsKey(\"_agg\")) {\n        params.put(\"_agg\", new HashMap<String, Object>());\n    }\n```\n\nNote: If this is deemed worthy, I can gladly submit a PR.\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}