{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16391","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16391/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16391/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16391/events","html_url":"https://github.com/elastic/elasticsearch/issues/16391","id":130846404,"node_id":"MDU6SXNzdWUxMzA4NDY0MDQ=","number":16391,"title":"ArrayIndexOutOfBoundsException with nested aggregations","user":{"login":"bwebster","id":441162,"node_id":"MDQ6VXNlcjQ0MTE2Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/441162?v=4","gravatar_id":"","url":"https://api.github.com/users/bwebster","html_url":"https://github.com/bwebster","followers_url":"https://api.github.com/users/bwebster/followers","following_url":"https://api.github.com/users/bwebster/following{/other_user}","gists_url":"https://api.github.com/users/bwebster/gists{/gist_id}","starred_url":"https://api.github.com/users/bwebster/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bwebster/subscriptions","organizations_url":"https://api.github.com/users/bwebster/orgs","repos_url":"https://api.github.com/users/bwebster/repos","events_url":"https://api.github.com/users/bwebster/events{/privacy}","received_events_url":"https://api.github.com/users/bwebster/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2016-02-02T22:56:48Z","updated_at":"2018-02-14T13:26:52Z","closed_at":"2016-05-12T11:54:20Z","author_association":"NONE","active_lock_reason":null,"body":"We are running a query that has nested aggregations.  We are experiencing sporadic failures with our test suite around this query.  \n\nWe are running 2.1.1.  Here is the version info:\n\n```\n{\n  number: \"2.1.1\",\n  build_hash: \"40e2c53a6b6c2972b3d13846e450e66f4375bd71\",\n  build_timestamp: \"2015-12-15T13:05:55Z\",\n  build_snapshot: false,\n  lucene_version: \"5.3.1\"\n}\n```\n\nWe are using a time-based index strategy (one index per month), controlled by a template.  The issue seems to be related to time.  If we mock out the current time in our tests so that all data is created in a single monthly index, the issue goes away.  \n\nThe query we are running looks like this:\n\n```\n{\n  \"size\" : 0,\n  \"query\" : {\n    \"filtered\" : {\n      \"filter\" : {\n        \"and\" : [\n          {\n            \"terms\" : {\n              \"newsroom_id\" : [\n                \"2165011d66f4115cca001815\"\n              ]\n            }\n          },\n          {\n            \"range\" : {\n              \"timestamp\" : {\n                \"gte\" : \"2016-01-03T22:47:03.000Z\",\n                \"lte\" : \"2016-02-02T22:47:03.000+00:00\"\n              }\n            }\n          }\n        ]\n      }\n    }\n  },\n  \"aggs\" : {\n    \"post_id\" : {\n      \"terms\" : {\n        \"field\" : \"post_id\",\n        \"order\" : [\n          {\n            \"opportunities_ae220c23>value.sum\" : \"desc\"\n          },\n          {\n            \"all_stats.sum\" : \"desc\"\n          }\n        ],\n        \"size\" : 0\n      },\n      \"aggs\" : {\n        \"opportunities_ae220c23\" : {\n          \"filter\" : {\n            \"term\" : {\n              \"stage\" : \"ae220c23\"\n            }\n          },\n          \"aggs\" : {\n            \"value\" : {\n              \"stats\" : {\n                \"field\" : \"stats.opportunities\"\n              }\n            }\n          }\n        },\n        \"all_stats\" : {\n          \"stats\" : {\n            \"field\" : \"stats.opportunities\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nIn our test suite, we do the following:\n- delete all the documents in the index\n- create a bunch of new documents\n- refresh the indexes\n- run the query\n\nThis test seems to fail 5 out of 10 times, and we get different failures.  Sometimes we get some data back, but not all the data we are expecting.  Other times we get a `500` response back from ElasticSearch.\n\nI turned up logging and here are a few samples of what I'm seeing:\n\n```\n[2016-02-02 15:47:04,003][DEBUG][action.search.type       ] [George Stacy] [analytics_test_201602][0], node[OcKoG1smQ0a__zSHxix33A], [P], v[2], s[STARTED], a[id=_-rGSdgvTtyeXZ1yynsypA]: Failed to execute [org.elasticsearch.action.search.SearchRequest@793d7235]\nRemoteTransportException[[George Stacy][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException;\nCaused by: java.lang.ArrayIndexOutOfBoundsException\n[2016-02-02 15:47:04,003][DEBUG][action.search.type       ] [George Stacy] [analytics_test_201601][0], node[OcKoG1smQ0a__zSHxix33A], [P], v[2], s[STARTED], a[id=ynufly_CRLGMmPEfk0Q1pA]: Failed to execute [org.elasticsearch.action.search.SearchRequest@793d7235] lastShard [true]\nRemoteTransportException[[George Stacy][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException;\nCaused by: java.lang.ArrayIndexOutOfBoundsException\n[2016-02-02 15:47:04,003][DEBUG][action.search.type       ] [George Stacy] All shards failed for phase: [query]\nRemoteTransportException[[George Stacy][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException;\nCaused by: java.lang.ArrayIndexOutOfBoundsException\n[2016-02-02 15:47:04,004][INFO ][rest.suppressed          ] /analytics_test_201601,analytics_test_201602/_search Params: {routing=2165011d66f4115cca001815, index=analytics_test_201601,analytics_test_201602}\nFailed to execute phase [query], all shards failed; shardFailures {[OcKoG1smQ0a__zSHxix33A][analytics_test_201601][0]: RemoteTransportException[[George Stacy][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException; }{[OcKoG1smQ0a__zSHxix33A][analytics_test_201602][0]: RemoteTransportException[[George Stacy][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException; }\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAction.java:228)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onFailure(TransportSearchTypeAction.java:174)\n    at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:46)\n    at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:821)\n    at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:799)\n    at org.elasticsearch.transport.TransportService$4.onFailure(TransportService.java:361)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:42)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: ; nested: ArrayIndexOutOfBoundsException;\n    at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:382)\n    at org.elasticsearch.action.search.SearchPhaseExecutionException.guessRootCauses(SearchPhaseExecutionException.java:152)\n    at org.elasticsearch.action.search.SearchPhaseExecutionException.getCause(SearchPhaseExecutionException.java:99)\n    at java.lang.Throwable.printStackTrace(Throwable.java:665)\n    at java.lang.Throwable.printStackTrace(Throwable.java:721)\n    at org.apache.log4j.DefaultThrowableRenderer.render(DefaultThrowableRenderer.java:60)\n    at org.apache.log4j.spi.ThrowableInformation.getThrowableStrRep(ThrowableInformation.java:87)\n    at org.apache.log4j.spi.LoggingEvent.getThrowableStrRep(LoggingEvent.java:413)\n    at org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:313)\n    at org.apache.log4j.WriterAppender.append(WriterAppender.java:162)\n    at org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:251)\n    at org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:66)\n    at org.apache.log4j.Category.callAppenders(Category.java:206)\n    at org.apache.log4j.Category.forcedLog(Category.java:391)\n    at org.apache.log4j.Category.log(Category.java:856)\n    at org.elasticsearch.common.logging.log4j.Log4jESLogger.internalInfo(Log4jESLogger.java:125)\n    at org.elasticsearch.common.logging.support.AbstractESLogger.info(AbstractESLogger.java:90)\n    at org.elasticsearch.rest.BytesRestResponse.convert(BytesRestResponse.java:131)\n    at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:96)\n    at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:87)\n    at org.elasticsearch.rest.action.support.RestActionListener.onFailure(RestActionListener.java:60)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.raiseEarlyFailure(TransportSearchTypeAction.java:316)\n    ... 10 more\nCaused by: java.lang.ArrayIndexOutOfBoundsException\n```\n\n```\nRemoteTransportException[[George Stacy][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException[1];\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 1\n    at org.elasticsearch.common.util.BigArrays$DoubleArrayWrapper.get(BigArrays.java:260)\n    at org.elasticsearch.search.aggregations.metrics.stats.StatsAggegator.metric(StatsAggegator.java:135)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$Aggregation$2.compare(InternalOrder.java:200)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$Aggregation$2.compare(InternalOrder.java:197)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$CompoundOrder$CompoundOrderComparator.compare(InternalOrder.java:280)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$CompoundOrder$CompoundOrderComparator.compare(InternalOrder.java:266)\n    at org.elasticsearch.search.aggregations.bucket.terms.support.BucketPriorityQueue.lessThan(BucketPriorityQueue.java:37)\n    at org.elasticsearch.search.aggregations.bucket.terms.support.BucketPriorityQueue.lessThan(BucketPriorityQueue.java:26)\n    at org.apache.lucene.util.PriorityQueue.upHeap(PriorityQueue.java:258)\n    at org.apache.lucene.util.PriorityQueue.add(PriorityQueue.java:135)\n    at org.apache.lucene.util.PriorityQueue.insertWithOverflow(PriorityQueue.java:151)\n    at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.buildAggregation(GlobalOrdinalsStringTermsAggregator.java:176)\n    at org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:142)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:112)\n    at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:363)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:375)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:368)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:365)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n```\n\nI'm also seeing this in the logs:\n\n```\n[2016-02-02 16:05:12,166][DEBUG][cluster.action.shard     ] [George Stacy] [analytics_test_201602][4] sending shard started for [analytics_test_201602][4], node[OcKoG1smQ0a__zSHxix33A], [P], v[1], s[INITIALIZING], a[id=ZgJoAG_vRGO6pVamLpHOHg], unassigned_info[[reason=INDEX_CREATED], at[2016-02-02T23:05:12.087Z]], expected_shard_size[7404], indexUUID [_WBlFe96TRO0kbG7S3ZgDg], message [after recovery from store], failure [Unknown]\n```\n\nIs anybody experiencing similar issues?\n\nFor reference, the data we create for this test looks like this:\n\n```\n{\n  \"took\": 1,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 10,\n    \"successful\": 10,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 5,\n    \"max_score\": 1,\n    \"hits\": [\n      {\n        \"_index\": \"analytics_test_201601\",\n        \"_type\": \"content_scoring_stats\",\n        \"_id\": \"8e1db69dd42f8eece90b97f129537cdca7eabfd0e4110d9a5cfa9c3703bf0708\",\n        \"_score\": 1,\n        \"_routing\": \"2165011d66f4115cca001815\",\n        \"_source\": {\n          \"created_at\": \"2016-02-02T22:47:06.990Z\",\n          \"updated_at\": \"2016-02-02T22:47:06.990Z\",\n          \"job_id\": \"2bc0c0dd-5a38-42d5-8961-22510ae6fdeb\",\n          \"request_id\": null,\n          \"timestamp\": \"2016-01-31T22:47:06.990Z\",\n          \"recorded_at\": \"2016-02-02T22:47:00.548+00:00\",\n          \"newsroom_id\": \"2165011d66f4115cca001815\",\n          \"post_id\": \"d0c672a0e5f0f66e906ccd90\",\n          \"stage\": \"11494a78\",\n          \"stats\": {\n            \"opportunities\": 5.5,\n            \"revenue\": 100.5\n          }\n        }\n      },\n      {\n        \"_index\": \"analytics_test_201601\",\n        \"_type\": \"content_scoring_stats\",\n        \"_id\": \"0e6e49d68abe67150cee093c38fe2acdcec88a6491b862a3a80adcf348a4df1b\",\n        \"_score\": 1,\n        \"_routing\": \"2165011d66f4115cca001815\",\n        \"_source\": {\n          \"created_at\": \"2016-02-02T22:47:06.992Z\",\n          \"updated_at\": \"2016-02-02T22:47:06.992Z\",\n          \"job_id\": \"3a19c4e6-8446-43c4-a6b6-ed471411129f\",\n          \"request_id\": null,\n          \"timestamp\": \"2016-01-31T22:47:06.992Z\",\n          \"recorded_at\": \"2016-02-02T22:47:00.548+00:00\",\n          \"newsroom_id\": \"2165011d66f4115cca001815\",\n          \"post_id\": \"bd2b0c5993413414f1f92f3d\",\n          \"stage\": \"f89d57cb\",\n          \"stats\": {\n            \"opportunities\": 10.2,\n            \"revenue\": 24.3\n          }\n        }\n      },\n      {\n        \"_index\": \"analytics_test_201602\",\n        \"_type\": \"content_scoring_stats\",\n        \"_id\": \"2982db4c6f50ca5611f331f51474a882d32ea40b628db51eca1f8beed8484e35\",\n        \"_score\": 1,\n        \"_routing\": \"2165011d66f4115cca001815\",\n        \"_source\": {\n          \"created_at\": \"2016-02-02T22:47:06.995Z\",\n          \"updated_at\": \"2016-02-02T22:47:06.995Z\",\n          \"job_id\": \"406b92b1-2b05-4cb1-93af-7651021d25d5\",\n          \"request_id\": null,\n          \"timestamp\": \"2016-02-01T22:47:06.995Z\",\n          \"recorded_at\": \"2016-02-02T22:47:00.548+00:00\",\n          \"newsroom_id\": \"2165011d66f4115cca001815\",\n          \"post_id\": \"d0c672a0e5f0f66e906ccd90\",\n          \"stage\": \"11494a78\",\n          \"stats\": {\n            \"opportunities\": 0.3,\n            \"revenue\": 43.1\n          }\n        }\n      },\n      {\n        \"_index\": \"analytics_test_201602\",\n        \"_type\": \"content_scoring_stats\",\n        \"_id\": \"c7140c8a6ebb4422b5ab1c495c6afca517ccbd5ea284e3aa0d6755320cba0426\",\n        \"_score\": 1,\n        \"_routing\": \"2165011d66f4115cca001815\",\n        \"_source\": {\n          \"created_at\": \"2016-02-02T22:47:06.997Z\",\n          \"updated_at\": \"2016-02-02T22:47:06.997Z\",\n          \"job_id\": \"3ca37f8c-b143-46f7-916b-5fbd2f06c653\",\n          \"request_id\": null,\n          \"timestamp\": \"2016-02-01T22:47:06.997Z\",\n          \"recorded_at\": \"2016-02-02T22:47:00.548+00:00\",\n          \"newsroom_id\": \"2165011d66f4115cca001815\",\n          \"post_id\": \"c766f88321f126c2309ce791\",\n          \"stage\": \"f89d57cb\",\n          \"stats\": {\n            \"opportunities\": 0.5,\n            \"revenue\": 1.8\n          }\n        }\n      },\n      {\n        \"_index\": \"analytics_test_201602\",\n        \"_type\": \"content_scoring_stats\",\n        \"_id\": \"4b1cd5c7df3aa55879253021ef59ac73975736652763eef8f798ea50ac004ef5\",\n        \"_score\": 1,\n        \"_routing\": \"e2d34791522c86d9210673f2\",\n        \"_source\": {\n          \"created_at\": \"2016-02-02T22:47:06.999Z\",\n          \"updated_at\": \"2016-02-02T22:47:06.999Z\",\n          \"job_id\": \"56e1a19d-b8be-42ba-8912-aff1084bf347\",\n          \"request_id\": null,\n          \"timestamp\": \"2016-02-01T22:47:06.999Z\",\n          \"recorded_at\": \"2016-02-02T22:47:00.548+00:00\",\n          \"newsroom_id\": \"e2d34791522c86d9210673f2\",\n          \"post_id\": \"c766f88321f126c2309ce791\",\n          \"stage\": \"f89d57cb\",\n          \"stats\": {\n            \"opportunities\": 10,\n            \"revenue\": 30\n          }\n        }\n      }\n    ]\n  }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}