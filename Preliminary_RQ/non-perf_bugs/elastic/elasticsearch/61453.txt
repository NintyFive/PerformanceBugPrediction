{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/61453","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61453/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61453/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61453/events","html_url":"https://github.com/elastic/elasticsearch/issues/61453","id":684294205,"node_id":"MDU6SXNzdWU2ODQyOTQyMDU=","number":61453,"title":"Security_exception: action [indices:admin/rollover] is unauthorized for user","user":{"login":"hendry-lim","id":48344515,"node_id":"MDQ6VXNlcjQ4MzQ0NTE1","avatar_url":"https://avatars1.githubusercontent.com/u/48344515?v=4","gravatar_id":"","url":"https://api.github.com/users/hendry-lim","html_url":"https://github.com/hendry-lim","followers_url":"https://api.github.com/users/hendry-lim/followers","following_url":"https://api.github.com/users/hendry-lim/following{/other_user}","gists_url":"https://api.github.com/users/hendry-lim/gists{/gist_id}","starred_url":"https://api.github.com/users/hendry-lim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendry-lim/subscriptions","organizations_url":"https://api.github.com/users/hendry-lim/orgs","repos_url":"https://api.github.com/users/hendry-lim/repos","events_url":"https://api.github.com/users/hendry-lim/events{/privacy}","received_events_url":"https://api.github.com/users/hendry-lim/received_events","type":"User","site_admin":false},"labels":[{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""},{"id":2040343033,"node_id":"MDU6TGFiZWwyMDQwMzQzMDMz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.9.0","name":"v7.9.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2020-08-24T01:05:12Z","updated_at":"2020-11-18T08:31:17Z","closed_at":"2020-09-04T02:57:32Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.9.0 (Docker)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Alpine\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nEncountered error: `Security_exception: action [indices:admin/rollover] is unauthorized for user`.\r\nAdding `manage` or `all` privilege on the index level for the role does not seem to work, because the error still appears from time to time.\r\nAlso noticed that the error may resolve itself, but it will re-appear again.\r\n[Discuss thread](https://discuss.elastic.co/t/security-exception-action-indices-admin-rollover-is-unauthorized-for-user)\r\nI even changed the user to `beats_writer` in `Heartbeat`, but I am still receiving the same error for `beats_system_custom` user.\r\n\r\n<details>\r\n<summary>Screenshots</summary>\r\n\r\n![image](https://user-images.githubusercontent.com/48344515/90993718-8f71e180-e5e8-11ea-85ed-c45245d06ffd.png)\r\n![image (1)](https://user-images.githubusercontent.com/48344515/90993720-913ba500-e5e8-11ea-81b2-395d9b92f7e5.png)\r\n![image (2)](https://user-images.githubusercontent.com/48344515/90993724-926cd200-e5e8-11ea-8c1d-794da6e8a083.png)\r\n![image (3)](https://user-images.githubusercontent.com/48344515/90993726-94369580-e5e8-11ea-970c-db8e6e0006c6.png)\r\n\r\n</details>\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem,\r\nincluding (e.g.) index creation, mappings, settings, query etc.  The easier\r\nyou make for us to reproduce it, the more likely that somebody will take the\r\ntime to look at it.\r\n\r\n 1. Setup Beats custom role to setup and ingest data\r\n 2. Run either `Auditbeat`, `Heartbeat`, or `Winlogbeat` (error seems to only occur for these 3 Beats indices)\r\n 3. Observe the exception appears in Elasticsearch log\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n<details>\r\n<summary>Error</summary>\r\n\r\n```\r\n{\r\n    \"type\": \"server\",\r\n    \"timestamp\": \"2020-08-19T12:08:46,690Z\",\r\n    \"level\": \"WARN\",\r\n    \"component\": \"o.e.i.s.IndexShard\",\r\n    \"cluster.name\": \"docker-cluster\",\r\n    \"node.name\": \"es01\",\r\n    \"message\": \" [apm-7.9.0-transaction-000001][0] onPreFetchPhase listener [org.elasticsearch.xpack.security.authz.SecuritySearchOperationListener@ccd1c8b] failed\",\r\n    \"cluster.uuid\": \"D8swAaZPTDeLax90eETYwg\",\r\n    \"node.id\": \"6a3KukJsTrqiibIoFlOQ8A\",\r\n    \"stacktrace\": [\"org.elasticsearch.ElasticsearchSecurityException: [[FAOfBnQBQcojp3HWI0Vd][23968]] expected scroll indices access control [IndicesAccessControl{granted=true, indexPermissions={apm-7.9.0-error=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-span=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-metric=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-onboarding-2020.08.18=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-transaction-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-metric-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-onboarding=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-profile-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-error-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-span-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-profile=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-transaction=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}}}] but found [IndicesAccessControl{granted=true, indexPermissions={apm-7.9.0-error=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-span=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-metric=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-onboarding-2020.08.18=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-transaction-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-metric-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-onboarding=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-profile-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-error-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-span-000001=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-profile=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}, apm-7.9.0-transaction=IndexAccessControl{granted=true, fieldPermissions=org.elasticsearch.xpack.core.security.authz.permission.FieldPermissions@1, documentPermissions=DocumentPermissions [queries=null, scopedByQueries=null]}}}] in thread context\",\r\n        \"at org.elasticsearch.xpack.security.authz.SecuritySearchOperationListener.ensureIndicesAccessControlForScrollThreadContext(SecuritySearchOperationListener.java:111) ~[?:?]\",\r\n        \"at org.elasticsearch.xpack.security.authz.SecuritySearchOperationListener.onPreFetchPhase(SecuritySearchOperationListener.java:95) ~[?:?]\",\r\n        \"at org.elasticsearch.index.shard.SearchOperationListener$CompositeListener.onPreFetchPhase(SearchOperationListener.java:166) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.search.SearchService$SearchOperationListenerExecutor.<init>(SearchService.java:1272) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.search.SearchService.lambda$executeFetchPhase$4(SearchService.java:584) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.action.ActionRunnable.lambda$supply$0(ActionRunnable.java:58) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:710) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.9.0.jar:7.9.0]\",\r\n        \"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]\",\r\n        \"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]\",\r\n        \"at java.lang.Thread.run(Thread.java:832) [?:?]\"]\r\n}\r\n```\r\n</details>\r\n\r\n","closed_by":{"login":"hendry-lim","id":48344515,"node_id":"MDQ6VXNlcjQ4MzQ0NTE1","avatar_url":"https://avatars1.githubusercontent.com/u/48344515?v=4","gravatar_id":"","url":"https://api.github.com/users/hendry-lim","html_url":"https://github.com/hendry-lim","followers_url":"https://api.github.com/users/hendry-lim/followers","following_url":"https://api.github.com/users/hendry-lim/following{/other_user}","gists_url":"https://api.github.com/users/hendry-lim/gists{/gist_id}","starred_url":"https://api.github.com/users/hendry-lim/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendry-lim/subscriptions","organizations_url":"https://api.github.com/users/hendry-lim/orgs","repos_url":"https://api.github.com/users/hendry-lim/repos","events_url":"https://api.github.com/users/hendry-lim/events{/privacy}","received_events_url":"https://api.github.com/users/hendry-lim/received_events","type":"User","site_admin":false},"performed_via_github_app":null}