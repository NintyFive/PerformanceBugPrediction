{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/55893","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55893/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55893/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55893/events","html_url":"https://github.com/elastic/elasticsearch/issues/55893","id":608582308,"node_id":"MDU6SXNzdWU2MDg1ODIzMDg=","number":55893,"title":"Stackoverflow and too many open files","user":{"login":"ItamarBenjamin","id":7209981,"node_id":"MDQ6VXNlcjcyMDk5ODE=","avatar_url":"https://avatars0.githubusercontent.com/u/7209981?v=4","gravatar_id":"","url":"https://api.github.com/users/ItamarBenjamin","html_url":"https://github.com/ItamarBenjamin","followers_url":"https://api.github.com/users/ItamarBenjamin/followers","following_url":"https://api.github.com/users/ItamarBenjamin/following{/other_user}","gists_url":"https://api.github.com/users/ItamarBenjamin/gists{/gist_id}","starred_url":"https://api.github.com/users/ItamarBenjamin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ItamarBenjamin/subscriptions","organizations_url":"https://api.github.com/users/ItamarBenjamin/orgs","repos_url":"https://api.github.com/users/ItamarBenjamin/repos","events_url":"https://api.github.com/users/ItamarBenjamin/events{/privacy}","received_events_url":"https://api.github.com/users/ItamarBenjamin/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"}],"state":"closed","locked":false,"assignee":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"assignees":[{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2020-04-28T20:08:48Z","updated_at":"2020-05-03T11:28:15Z","closed_at":"2020-04-30T12:02:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** 6.8.6 docker\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\n**OS version** ubuntu 16\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\na cluster with 6 data nodes, 3 master nodes and 2 coordinating - total of 7.5K shards\r\neach data node with 30GB of RAM, and max open files 65536\r\n\r\ngetting Too many open files errors and then stackoverflow exception.\r\nnot sure why getting the Too many open files exception...\r\n\r\nseeing many nested exceptions like:\r\n\r\n`\r\n[2020-04-28T12:34:49,649][WARN ][o.e.i.e.Engine           ] [fmyinf7113-1] [mars_storage-directories_history_4b895ae4-c01d-4904-88b9-d11090dea4c6-000001][0] giving up looking for fatal errors\r\njava.nio.file.FileSystemException: /usr/share/elasticsearch/data/nodes/0/indices/2E5BQgAiQ_u_EBSxl-JZlA/0/translog/translog-2167182483755916320.ckp: Too many open files\r\n        at sun.nio.fs.UnixException.translateToIOException(UnixException.java:100) ~[?:?]\r\n        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111) ~[?:?]\r\n        at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116) ~[?:?]\r\n        at sun.nio.fs.UnixCopyFile.copyFile(UnixCopyFile.java:248) ~[?:?]\r\n        at sun.nio.fs.UnixCopyFile.copy(UnixCopyFile.java:603) ~[?:?]\r\n        at sun.nio.fs.UnixFileSystemProvider.copy(UnixFileSystemProvider.java:258) ~[?:?]\r\n        at java.nio.file.Files.copy(Files.java:1298) ~[?:?]\r\n        at org.elasticsearch.index.translog.Translog.copyCheckpointTo(Translog.java:285) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.index.translog.Translog.rollGeneration(Translog.java:1709) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.index.engine.InternalEngine.flush(InternalEngine.java:1818) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.index.shard.IndexShard.flush(IndexShard.java:1117) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.indices.flush.SyncedFlushService.performPreSyncedFlush(SyncedFlushService.java:507) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.indices.flush.SyncedFlushService.access$500(SyncedFlushService.java:74) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.indices.flush.SyncedFlushService$PreSyncedFlushTransportHandler.messageReceived(SyncedFlushService.java:817) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.indices.flush.SyncedFlushService$PreSyncedFlushTransportHandler.messageReceived(SyncedFlushService.java:813) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:692) [elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.6.jar:6.8.6]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n        at java.lang.Thread.run(Thread.java:830) [?:?]\r\n        Suppressed: org.apache.lucene.store.AlreadyClosedException: translog [39] is already closed (path [/usr/share/elasticsearch/data/nodes/0/indices/2E5BQgAiQ_u_EBSxl-JZlA/0/translog/translog-39.tlog]\r\n                at org.elasticsearch.index.translog.TranslogWriter.closeIntoReader(TranslogWriter.java:305) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.index.translog.Translog.rollGeneration(Translog.java:1706) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.index.engine.InternalEngine.flush(InternalEngine.java:1818) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.index.shard.IndexShard.flush(IndexShard.java:1117) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.indices.flush.SyncedFlushService.performPreSyncedFlush(SyncedFlushService.java:507) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.indices.flush.SyncedFlushService.access$500(SyncedFlushService.java:74) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.indices.flush.SyncedFlushService$PreSyncedFlushTransportHandler.messageReceived(SyncedFlushService.java:817) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.indices.flush.SyncedFlushService$PreSyncedFlushTransportHandler.messageReceived(SyncedFlushService.java:813) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:692) [elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-6.8.6.jar:6.8.6]\r\n                at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.6.jar:6.8.6]\r\n                at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n                at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n                at java.lang.Thread.run(Thread.java:830) [?:?]\r\n        Caused by: java.nio.file.FileSystemException: /usr/share/elasticsearch/data/nodes/0/indices/2E5BQgAiQ_u_EBSxl-JZlA/0/translog/translog-2167182483755916320.ckp: Too many open files\r\n                at sun.nio.fs.UnixException.translateToIOException(UnixException.java:100) ~[?:?]\r\n                at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111) ~[?:?]\r\n                at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116) ~[?:?]\r\n                at sun.nio.fs.UnixCopyFile.copyFile(UnixCopyFile.java:248) ~[?:?]\r\n                at sun.nio.fs.UnixCopyFile.copy(UnixCopyFile.java:603) ~[?:?]\r\n`\r\n\r\nand in the end \r\n`\r\n at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:987) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.common.io.stream.StreamOutput.writeException(StreamOutput.java:985) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n        at org.elasticsearch.ElasticsearchException.writeStackTraces(ElasticsearchException.java:743) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\r\n`\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"performed_via_github_app":null}