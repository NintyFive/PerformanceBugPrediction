{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16139","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16139/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16139/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16139/events","html_url":"https://github.com/elastic/elasticsearch/issues/16139","id":127855536,"node_id":"MDU6SXNzdWUxMjc4NTU1MzY=","number":16139,"title":"Mapping conflicts cause the infinite shard allocation loop","user":{"login":"sombut","id":11056237,"node_id":"MDQ6VXNlcjExMDU2MjM3","avatar_url":"https://avatars0.githubusercontent.com/u/11056237?v=4","gravatar_id":"","url":"https://api.github.com/users/sombut","html_url":"https://github.com/sombut","followers_url":"https://api.github.com/users/sombut/followers","following_url":"https://api.github.com/users/sombut/following{/other_user}","gists_url":"https://api.github.com/users/sombut/gists{/gist_id}","starred_url":"https://api.github.com/users/sombut/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sombut/subscriptions","organizations_url":"https://api.github.com/users/sombut/orgs","repos_url":"https://api.github.com/users/sombut/repos","events_url":"https://api.github.com/users/sombut/events{/privacy}","received_events_url":"https://api.github.com/users/sombut/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2016-01-21T06:22:58Z","updated_at":"2016-01-27T07:13:19Z","closed_at":"2016-01-26T16:48:01Z","author_association":"NONE","active_lock_reason":null,"body":"I'm using the latest elasticsearch 2.1.1 as a part of ELK stack in the environment that difficult to control the consistency of the field type and mapping. \n\nI noticed the mapping breaking change from 1.x version. I tried testing this to ensure the stability in 2.x cluster and found this unexpected behaviour. \n\nI started the fresh elasticsearch 2.1.1 cluster with no data. I got the infinite loop of shard allocation failed and it kept retrying but never success when indexing data below using the bulk API.\n\nReproduce step:\n1) Using the logstash template in attached.\n2) run curl to elasticsearch using below data. Sometime it's success but sometime it failed with infinite loop of shard allocation failure. (I'm usually found this issue 1 in 3 times)\n\ncurl -s -XPOST localhost:9200/_bulk --data-binary \"@/tmp/a\"\n\nthe /tmp/a contains\n{ \"index\" : { \"_index\" : \"logstash-2016.02.01\", \"_type\" : \"tweet\" } }\n{ \"message\" : 0, \"test\" : 20, \"status\" : 0 }\n{ \"index\" : { \"_index\" : \"logstash-2016.02.01\", \"_type\" : \"tweet\" } }\n{ \"message\" : \"value1\", \"test\" : \"test\", \"status\" : \"0\" }\n{ \"index\" : { \"_index\" : \"logstash-2016.02.01\", \"_type\" : \"twoot\" } }\n{ \"message\" : \"value1\", \"test\" : \"test\", \"status\" : \"0\" }\n{ \"index\" : { \"_index\" : \"logstash-2016.02.01\", \"_type\" : \"twaat\" } }\n{ \"message\" : \"value1\", \"test\" : \"test\", \"status\" : \"0\" }\n\nOnce run you will get the error like this\n\n![image](https://cloud.githubusercontent.com/assets/11056237/12473071/5700c04a-c041-11e5-8cdd-d3fb867f62af.png)\n\nI've also attached \n1)  error from elasticsearch log [error.txt](https://github.com/elastic/elasticsearch/files/98769/error.txt)\n2) logstash template [logstash_template.txt](https://github.com/elastic/elasticsearch/files/98766/logstash_template.txt) \n3) logstash-2016.02.01 index mapping after run the command [logstash-2016.02.01_mapping.txt](https://github.com/elastic/elasticsearch/files/98767/logstash-2016.02.01_mapping.txt)\n\nI noticed something wrong in the mapping as follows:\n1) The tweet type have the correct mapping ( all fields are having type: long) \n2) Somehow the mapping of twaat type for all fields became string and this is the cause I got the infinite loop of shard recovering.\n\n![image](https://cloud.githubusercontent.com/assets/11056237/12472955/3c8e9288-c040-11e5-990a-841eab1f6d19.png)\n\nOnce it happened the only way to resolve this is to delete that index which means if this happened in production environment, I need to delete the index and lose all data?\n\nYour earliest help on this issue would be highly appreciated.\n\nThank you.\nSombut\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}