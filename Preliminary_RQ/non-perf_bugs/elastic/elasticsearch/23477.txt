{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23477","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23477/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23477/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23477/events","html_url":"https://github.com/elastic/elasticsearch/issues/23477","id":211665786,"node_id":"MDU6SXNzdWUyMTE2NjU3ODY=","number":23477,"title":"Wrong sum aggregation result elastic 5.2","user":{"login":"nivrozen","id":8383009,"node_id":"MDQ6VXNlcjgzODMwMDk=","avatar_url":"https://avatars3.githubusercontent.com/u/8383009?v=4","gravatar_id":"","url":"https://api.github.com/users/nivrozen","html_url":"https://github.com/nivrozen","followers_url":"https://api.github.com/users/nivrozen/followers","following_url":"https://api.github.com/users/nivrozen/following{/other_user}","gists_url":"https://api.github.com/users/nivrozen/gists{/gist_id}","starred_url":"https://api.github.com/users/nivrozen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nivrozen/subscriptions","organizations_url":"https://api.github.com/users/nivrozen/orgs","repos_url":"https://api.github.com/users/nivrozen/repos","events_url":"https://api.github.com/users/nivrozen/events{/privacy}","received_events_url":"https://api.github.com/users/nivrozen/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-03-03T11:38:18Z","updated_at":"2017-03-04T14:06:26Z","closed_at":"2017-03-04T14:06:26Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n\r\n\r\n**Elasticsearch version**:\r\n5.2\r\n**Plugins installed**: \r\n[x-pack]\r\n\r\n**JVM version**:\r\njava version \"1.8.0_65\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_65-b17)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.65-b01, mixed mode)\r\n\r\n**OS version**:\r\nCentOS Linux release 7.2.1511\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\n\r\nI have the following query which returns wrong result (all the sum buckets =175!), and I don't have a clue why.. assistance will be appreciated. I'm 99% sure that it didn't happen with Elastic 1.7 (we have just upgraded)\r\n\r\n```\r\nGET org_aggregations...*/.../_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"ids\": {\r\n            \"values\": [\r\n              \"AVqE7pJdCQ_f2txT8s4x\"\r\n            ]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"create_date\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"create_date\",\r\n        \"interval\": \"d⁠⁠⁠<code>?ay\"\r\n      },\r\n      \"aggs\": {\r\n        \"greater_than_val_time\": {\r\n          \"terms\": {\r\n            \"script\": {\r\n              \"lang\": \"groovy\",\r\n              \"inline\": \"_source.histogram_time_distribution.histogram_timegreater_than_val\"\r\n            },\r\n            \"size\": 20\r\n          },\r\n          \"aggs\": {\r\n            \"recurrences\": {\r\n              \"sum\": {\r\n                \"field\": \"histogram_time_distribution.histogram_timedoc_count22\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nthe only doc retrieved from the bool filter is:\r\n\r\n```\r\n  {\r\n    \"_index\": \"..\",\r\n    \"_type\": \"...\",\r\n    \"_id\": \"AVqE7pJdCQ_f2txT8s4x\",\r\n    \"_source\": {\r\n      \"doc_count11\": 175,\r\n      \"page_views\": 88,\r\n      \"histogram_dns_time_distribution\": [\r\n        {\r\n          \"histogram_dns_timegreater_than_val\": 0,\r\n          \"histogram_dns_timedoc_count22\": 175,\r\n          \"avg\": 0\r\n        }\r\n      ],\r\n      \"histogram_time_distribution\": [\r\n        {\r\n          \"histogram_timegreater_than_val\": 0,\r\n          \"histogram_timedoc_count22\": 161,\r\n          \"avg\": 193.17391304347825\r\n        },\r\n        {\r\n          \"histogram_timegreater_than_val\": 1000,\r\n          \"histogram_timedoc_count22\": 7,\r\n          \"avg\": 1323.142857142857\r\n        },\r\n        {\r\n          \"histogram_timegreater_than_val\": 2000,\r\n          \"histogram_timedoc_count22\": 4,\r\n          \"avg\": 2270\r\n        },\r\n        {\r\n          \"histogram_timegreater_than_val\": 3000,\r\n          \"histogram_timedoc_count22\": 0,\r\n          \"avg\": null\r\n        },\r\n       ...\r\n      ],\r\n      \"resource_domain\": \"stats.g.doubleclick.net\",\r\n      \"resource_path\": \"/r/collect\",\r\n      \"create_date\": \"2017-02-25T00:00:00\"\r\n    }\r\n  }\r\n\r\n```\r\nthe strange result is: (all the sum buckets =175!)\r\n\r\n```\r\n\"aggregations\": {\r\n\"create_date\": {\r\n  \"buckets\": [\r\n    {\r\n      \"key_as_string\": \"2017-02-25T00:00:00.000Z\",\r\n      \"key\": 1487980800000,\r\n      \"doc_count\": 1,\r\n      \"greater_than_val_time\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 6,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": \"0\",\r\n            \"doc_count\": 1,\r\n            \"recurrences\": {\r\n              \"value\": 175\r\n            }\r\n          },\r\n          {\r\n            \"key\": \"1000\",\r\n            \"doc_count\": 1,\r\n            \"recurrences\": {\r\n              \"value\": 175\r\n            }\r\n          },\r\n          {\r\n            \"key\": \"10000\",\r\n            \"doc_count\": 1,\r\n            \"recurrences\": {\r\n              \"value\": 175\r\n            }\r\n          },\r\n\r\n          ....\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\n}\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}