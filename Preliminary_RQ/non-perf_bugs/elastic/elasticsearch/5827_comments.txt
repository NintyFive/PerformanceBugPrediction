[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/40599486","html_url":"https://github.com/elastic/elasticsearch/issues/5827#issuecomment-40599486","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5827","id":40599486,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNTk5NDg2","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-04-16T13:40:48Z","updated_at":"2014-04-16T13:40:48Z","author_association":"CONTRIBUTOR","body":"This is interesting: your sub-aggregation is missing a name and I'm wondering that this might make the parser go crazy and see the cardinality aggregation but ignore its configuration (the field parameter). When you don't define the field to use in a cardinality aggregation, it uses the field of the parent aggregation, which is a timestamp in your case so likely has a very high cardinality.\n\nCould you verify this is the case by running the following aggregation (the same as yours, but with a name given to the cardinality aggregation).\n\n``` yaml\n  aggregations: {\n                      by_month: {\n                          date_histogram: {\n                              field:    \"time_stamp\",\n                              interval: \"1M\",\n                              format:   \"yyyy-MM-dd HH:mm\"\n                          },\n                          aggregations:   {\n                              by_node_mac: {\n                                  terms:        {\n                                      field: \"node_mac\"\n                                  },\n                                  aggregations: {\n                                      device_mac_count: {\n                                          cardinality: {field: 'device_mac'}\n                                      }\n                                  }\n                              }\n                          }\n                      }\n                  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/40682601","html_url":"https://github.com/elastic/elasticsearch/issues/5827#issuecomment-40682601","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5827","id":40682601,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjgyNjAx","user":{"login":"timuckun","id":101559,"node_id":"MDQ6VXNlcjEwMTU1OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/101559?v=4","gravatar_id":"","url":"https://api.github.com/users/timuckun","html_url":"https://github.com/timuckun","followers_url":"https://api.github.com/users/timuckun/followers","following_url":"https://api.github.com/users/timuckun/following{/other_user}","gists_url":"https://api.github.com/users/timuckun/gists{/gist_id}","starred_url":"https://api.github.com/users/timuckun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timuckun/subscriptions","organizations_url":"https://api.github.com/users/timuckun/orgs","repos_url":"https://api.github.com/users/timuckun/repos","events_url":"https://api.github.com/users/timuckun/events{/privacy}","received_events_url":"https://api.github.com/users/timuckun/received_events","type":"User","site_admin":false},"created_at":"2014-04-17T05:35:12Z","updated_at":"2014-04-17T05:35:12Z","author_association":"NONE","body":"Ok I input the same data into postgres and ran some comparisons.\n\nThe numbers are closer when I name the bottom level aggregation but not quite the same.  What's odd is that it's not really consistent. Some values are pretty close to pg others are twice as much.  \n\nOn another note the date format isn't working this is the output I am getting\n\n``` bash\n{\"took\"=>11135,\n \"timed_out\"=>false,\n \"_shards\"=>{\"total\"=>15, \"successful\"=>15, \"failed\"=>0},\n \"hits\"=>{\"total\"=>50100313, \"max_score\"=>0.0, \"hits\"=>[]},\n \"aggregations\"=>\n  {\"by_month\"=>\n    {\"buckets\"=>\n      [{\"key\"=>0,\n        \"doc_count\"=>17500,\n        \"by_node_mac\"=>\n         {\"buckets\"=>\n           [{\"key\"=>\"00606487F197\\n\",\n             \"doc_count\"=>13306,\n             \"device_mac_count\"=>{\"value\"=>3}},\n            {\"key\"=>\"00606488148F\\n\",\n             \"doc_count\"=>3359,\n             \"device_mac_count\"=>{\"value\"=>58}},\n            {\"key\"=>\"006064881467\\n\",\n             \"doc_count\"=>835,\n             \"device_mac_count\"=>{\"value\"=>2}}]}},\n       {\"key\"=>1391212800000,\n        \"doc_count\"=>50082500,\n        \"by_node_mac\"=>\n         {\"buckets\"=>\n           [{\"key\"=>\"00606487EED7\\n\",\n             \"doc_count\"=>11195953,\n             \"device_mac_count\"=>{\"value\"=>1227}},\n            {\"key\"=>\"00606488139F\\n\",\n             \"doc_count\"=>6862796,\n             \"device_mac_count\"=>{\"value\"=>24867}},\n            {\"key\"=>\"006064880FA7\\n\",\n             \"doc_count\"=>4714424,\n             \"device_mac_count\"=>{\"value\"=>18571}},\n            {\"key\"=>\"00606487F137\\n\",\n             \"doc_count\"=>4566781,\n             \"device_mac_count\"=>{\"value\"=>6914}},\n            {\"key\"=>\"00606487F317\\n\",\n             \"doc_count\"=>2988669,\n             \"device_mac_count\"=>{\"value\"=>4397}},\n            {\"key\"=>\"00606487EE47\\n\",\n             \"doc_count\"=>1788288,\n             \"device_mac_count\"=>{\"value\"=>4226}},\n            {\"key\"=>\"00606487F58F\\n\",\n             \"doc_count\"=>1671451,\n             \"device_mac_count\"=>{\"value\"=>1728}},\n            {\"key\"=>\"006064881467\\n\",\n             \"doc_count\"=>1657192,\n             \"device_mac_count\"=>{\"value\"=>445}},\n            {\"key\"=>\"00606487ED8F\\n\",\n             \"doc_count\"=>1609941,\n             \"device_mac_count\"=>{\"value\"=>2633}},\n            {\"key\"=>\"006064880E5F\\n\",\n             \"doc_count\"=>1532838,\n             \"device_mac_count\"=>{\"value\"=>14916}}]}}]}}}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/40693457","html_url":"https://github.com/elastic/elasticsearch/issues/5827#issuecomment-40693457","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5827","id":40693457,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjkzNDU3","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-04-17T08:46:58Z","updated_at":"2014-04-17T08:46:58Z","author_association":"CONTRIBUTOR","body":"I am not surprised that there are slight differences since the cardinality aggregation returns approximate results (see http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-metrics-cardinality-aggregation.html for more information). However, these approximations are supposed to be quite good so I'm worried about the x2 difference (it is supposed to be in the order of a few percents).\n\nThe output of this aggregation is indeed very surprising. I don't even know how this output has been formatted (could it be milliseconds since Epoch in hexadecimal?).\n\nCan you share your mappings (and potentially your index)?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/40798614","html_url":"https://github.com/elastic/elasticsearch/issues/5827#issuecomment-40798614","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5827","id":40798614,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNzk4NjE0","user":{"login":"timuckun","id":101559,"node_id":"MDQ6VXNlcjEwMTU1OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/101559?v=4","gravatar_id":"","url":"https://api.github.com/users/timuckun","html_url":"https://github.com/timuckun","followers_url":"https://api.github.com/users/timuckun/followers","following_url":"https://api.github.com/users/timuckun/following{/other_user}","gists_url":"https://api.github.com/users/timuckun/gists{/gist_id}","starred_url":"https://api.github.com/users/timuckun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timuckun/subscriptions","organizations_url":"https://api.github.com/users/timuckun/orgs","repos_url":"https://api.github.com/users/timuckun/repos","events_url":"https://api.github.com/users/timuckun/events{/privacy}","received_events_url":"https://api.github.com/users/timuckun/received_events","type":"User","site_admin":false},"created_at":"2014-04-18T09:45:59Z","updated_at":"2014-04-18T09:45:59Z","author_association":"NONE","body":"I can't share you the index as it's over five gigs in size. Here is the mapping though\n\n``` ruby\n{\n        probe: {\n            properties: {\n\n                time_stamp:      {type: 'date'},\n                node_mac:        {type: 'string', index: 'not_analyzed'},\n                device_mac:      {type:   'string', index:  'not_analyzed' },\n                signal_strength: {type: 'float'},\n            }\n        }\n    }\n```\n\nOn another note...\n\nI reloaded the data into postgres and ran the same group by query. The query took fifty minutes on my laptop . I  re adjusted the threshold to be 100 and re-ran the ES query which took seven seconds.  Here is the results. The third column is the count reported by postgres, the fourth column is the count reported by ES\n\nNote that for the values that did come back they are in the same ballpark but lots of data didn't come in at all.  I am very curious about that.\n\n``` csv\n\"1970-01-01 00:00:00\",  \"00606487F197\", 4,     4\n\"1970-01-01 00:00:00\",  \"006064881467\", 2,     2\n\"1970-01-01 00:00:00\",  \"00606488148F\", 61,    61\n\"2014-02-01 00:00:00\",  \"00606487ED8F\", 1914,   1955\n\"2014-02-01 00:00:00\",  \"00606487ED9F\", 235 ,\n\"2014-02-01 00:00:00\",  \"00606487EE47\", 3806,   3819\n\"2014-02-01 00:00:00\",  \"00606487EECF\", 11  \n\"2014-02-01 00:00:00\",  \"00606487EED7\", 1720,   1727\n\"2014-02-01 00:00:00\",  \"00606487EEEF\", 381  \n\"2014-02-01 00:00:00\",  \"00606487F137\", 6149,   6176\n\"2014-02-01 00:00:00\",  \"00606487F197\", 105  \n\"2014-02-01 00:00:00\",  \"00606487F20F\", 4032  \n\"2014-02-01 00:00:00\",  \"00606487F2A7\", 1339  \n\"2014-02-01 00:00:00\",  \"00606487F317\", 3997,   3937\n\"2014-02-01 00:00:00\",  \"00606487F51F\", 143  \n\"2014-02-01 00:00:00\",  \"00606487F58F\", 1665,   1607\n\"2014-02-01 00:00:00\",  \"006064880E5F\", 7234,   7286\n\"2014-02-01 00:00:00\",  \"006064880E67\", 6956  \n\"2014-02-01 00:00:00\",  \"006064880E87\", 383  \n\"2014-02-01 00:00:00\",  \"006064880FA7\", 18807,  18778\n\"2014-02-01 00:00:00\",  \"0060648811FF\", 194  \n\"2014-02-01 00:00:00\",  \"006064881237\", 61  \n\"2014-02-01 00:00:00\",  \"00606488139F\", 23475,  24232\n\"2014-02-01 00:00:00\",  \"006064881467\", 440,    447\n\"2014-02-01 00:00:00\",  \"00606488148F\", 1940 \n\"2014-02-01 00:00:00\",  \"0060648814BF\", 146  \n\"2014-02-01 00:00:00\",  \"006064881527\", 668  \n\"2014-02-01 00:00:00\",  \"undefined\",    80  \n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/40813188","html_url":"https://github.com/elastic/elasticsearch/issues/5827#issuecomment-40813188","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5827","id":40813188,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODEzMTg4","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-04-18T14:37:13Z","updated_at":"2014-04-18T14:37:13Z","author_association":"CONTRIBUTOR","body":"Oh, sorry, I was so worried about a bug in the cardinality aggregation that I missed the obvious: there is a limitation with the terms aggregation that it computes the top terms per shard, and only merges these top terms in the reduce phase. As a consequence, if might introduce precision loss since a term might be in the top terms on one shard but not on another (the mac addresses on this shard will be completely ignored on this shard).\n\nCan you try to run the aggregation again and set [size=0](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_size_amp_shard_size) on the terms aggregation (or just a very high value if you are not on 1.1 yet). This will force Elasticsearch to consider all buckets.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/40859411","html_url":"https://github.com/elastic/elasticsearch/issues/5827#issuecomment-40859411","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5827","id":40859411,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODU5NDEx","user":{"login":"timuckun","id":101559,"node_id":"MDQ6VXNlcjEwMTU1OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/101559?v=4","gravatar_id":"","url":"https://api.github.com/users/timuckun","html_url":"https://github.com/timuckun","followers_url":"https://api.github.com/users/timuckun/followers","following_url":"https://api.github.com/users/timuckun/following{/other_user}","gists_url":"https://api.github.com/users/timuckun/gists{/gist_id}","starred_url":"https://api.github.com/users/timuckun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timuckun/subscriptions","organizations_url":"https://api.github.com/users/timuckun/orgs","repos_url":"https://api.github.com/users/timuckun/repos","events_url":"https://api.github.com/users/timuckun/events{/privacy}","received_events_url":"https://api.github.com/users/timuckun/received_events","type":"User","site_admin":false},"created_at":"2014-04-19T03:19:03Z","updated_at":"2014-04-19T03:19:03Z","author_association":"NONE","body":"Thanks that worked in terms of getting all the results.  I fiddled with the threshold a bit but I could not get the counts to match exactly.  They were pretty close in most cases but I am not sure if that's good enough for this project.  \n","performed_via_github_app":null}]