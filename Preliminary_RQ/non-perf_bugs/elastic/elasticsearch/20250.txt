{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250/events","html_url":"https://github.com/elastic/elasticsearch/issues/20250","id":174240858,"node_id":"MDU6SXNzdWUxNzQyNDA4NTg=","number":20250,"title":"Request Circuit Breaker not limiting memory usage","user":{"login":"sarathrs","id":15686537,"node_id":"MDQ6VXNlcjE1Njg2NTM3","avatar_url":"https://avatars0.githubusercontent.com/u/15686537?v=4","gravatar_id":"","url":"https://api.github.com/users/sarathrs","html_url":"https://github.com/sarathrs","followers_url":"https://api.github.com/users/sarathrs/followers","following_url":"https://api.github.com/users/sarathrs/following{/other_user}","gists_url":"https://api.github.com/users/sarathrs/gists{/gist_id}","starred_url":"https://api.github.com/users/sarathrs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sarathrs/subscriptions","organizations_url":"https://api.github.com/users/sarathrs/orgs","repos_url":"https://api.github.com/users/sarathrs/repos","events_url":"https://api.github.com/users/sarathrs/events{/privacy}","received_events_url":"https://api.github.com/users/sarathrs/received_events","type":"User","site_admin":false},"labels":[{"id":166507771,"node_id":"MDU6TGFiZWwxNjY1MDc3NzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Circuit%20Breakers","name":":Core/Infra/Circuit Breakers","color":"0e8a16","default":false,"description":"Track estimates of memory consumption to prevent overload"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2016-08-31T10:40:40Z","updated_at":"2019-09-06T11:04:12Z","closed_at":"2019-09-06T10:46:58Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.4\n\n**Plugins installed**: []\n\n**JVM version**: 1.7.0\n\n**OS version**: Ubuntu 12.04.5 LTS, Also reproduced in Centos\n\n**Description of the problem including expected versus actual behavior**:\nWe are using elasticsearch 2.3.4 with 1GB of heap allocated. When we execute elasticsearch dismaxquery which has 200K multimatch queries memory usage of elasticsearch inreases to 40%. So we updated circuit breaker configuration in yml to limit memory usage for the request but that didn't fix the memory usage. \nConfiguration change:\n  indices.breaker.fielddata.limit: 20%\n  indices.breaker.request.limit: 5%\n  indices.breaker.total.limit: 25%\n\nNote: We have only one record in elasticsearch. Elasticsearch query will not match to any document.\nWe also noticed that there is no memory usage by fielddata. Same issue is reproduced in our production cluster with 19GB of heap allocated for elasticsearch\n\n**Expected Output:**  \"indices.breaker.request.limit\" should limit the memory usage of elasticsearch\n\n**Steps to reproduce**:\n1. Execute Dismax query with 200K multimatch queries\n\n**Elasticsearch**\n\n`PUT /user\nPUT /user/profile/1\n{\n  \"name\" : \"sarath\",\n  \"location\" : \"chennai\"\n}`\n\n**Java Code**\n\n`Builder builder = Settings.settingsBuilder();\n    builder.put(\"cluster.name\", \"sarath-es-tv\");\n    TransportClient client = TransportClient.builder().settings(builder.build()).build();\n    client.addTransportAddress(new InetSocketTransportAddress(new InetSocketAddress(\"localhost\", 9302)));\n        DisMaxQueryBuilder dqb = QueryBuilders.disMaxQuery();\n        for(int i = 0; i<100000; i++){\n             MultiMatchQueryBuilder nameQueryBuilder = QueryBuilders.multiMatchQuery(\n                    \"\"+i, \"name\");\n             dqb.add(nameQueryBuilder);\n             MultiMatchQueryBuilder locationQueryBuilder = QueryBuilders.multiMatchQuery(\n                    \"\"+i, \"location\");\n             dqb.add(locationQueryBuilder);              \n            dqb.add(nameQueryBuilder);\n            dqb.add(locationQueryBuilder);\n         }\n         SearchRequestBuilder searchQuery = client.prepareSearch(\"user\")\n                .setTypes(\"profile\")\n                .setQuery(dqb)\n                .setSearchType(SearchType.QUERY_THEN_FETCH)\n                .setSize(10);\n         SearchHits sh = searchQuery.execute().actionGet(new TimeValue(1, TimeUnit.MINUTES)).getHits();`\n\n**Provide logs (if relevant)**:\nAttached the screenshots of node stats with and without circuit breaker. In both cases memory usage increases.\n**Without Circuit Breaker**\n![withoutcircuitbreaker](https://cloud.githubusercontent.com/assets/15686537/18126608/883f93fe-6f99-11e6-9c8e-2265bda2e2b0.png)\n\n**With Circuit Breaker**\n![withcircuitbreaker](https://cloud.githubusercontent.com/assets/15686537/18126607/883c2e12-6f99-11e6-8538-b98bd29f6a76.png)\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}