{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9275","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9275/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9275/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9275/events","html_url":"https://github.com/elastic/elasticsearch/issues/9275","id":54209790,"node_id":"MDU6SXNzdWU1NDIwOTc5MA==","number":9275,"title":"Restore snapshot leaves shards unassigned and with CorruptIndexException","user":{"login":"richtmat","id":3274293,"node_id":"MDQ6VXNlcjMyNzQyOTM=","avatar_url":"https://avatars1.githubusercontent.com/u/3274293?v=4","gravatar_id":"","url":"https://api.github.com/users/richtmat","html_url":"https://github.com/richtmat","followers_url":"https://api.github.com/users/richtmat/followers","following_url":"https://api.github.com/users/richtmat/following{/other_user}","gists_url":"https://api.github.com/users/richtmat/gists{/gist_id}","starred_url":"https://api.github.com/users/richtmat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/richtmat/subscriptions","organizations_url":"https://api.github.com/users/richtmat/orgs","repos_url":"https://api.github.com/users/richtmat/repos","events_url":"https://api.github.com/users/richtmat/events{/privacy}","received_events_url":"https://api.github.com/users/richtmat/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":20,"created_at":"2015-01-13T15:53:11Z","updated_at":"2015-02-04T10:21:16Z","closed_at":"2015-02-04T10:21:16Z","author_association":"NONE","active_lock_reason":null,"body":"I'm doing a snapshot on a regular basis which just works fine. But when restoring these snapshots some shards fail:\n\n```\n{\n  \"snapshot\" : {\n    \"snapshot\" : \"snapshot-2015-01-13-2\",\n    \"indices\" : [ \"dev_cloud_asset_data\", \"dev_cloud_app_data\" ],\n    \"shards\" : {\n      \"total\" : 10,\n      \"failed\" : 8,\n      \"successful\" : 2\n    }\n  }\n}\n```\n\nand the log has some CorruptIndexExceptions:\n\n```\n[2015-01-13 15:51:56,678][WARN ][cluster.action.shard     ] [finderbox-dev-1-elasticsearch-dev] [dev_cloud_app_data][4] received shard failed for [dev_cloud_app_data][4], node[LCb28ckARa2IsGnJ7_v-Yg], [P], restoring[backup-dev:snapshot-2015-01-13-2], s[INITIALIZING], indexUUID [kc9un2LMQkeCBopB6MxvQw], reason [Failed to start shard, message [IndexShardGatewayRecoveryException[[dev_cloud_app_data][4] failed recovery]; nested: IndexShardRestoreFailedException[[dev_cloud_app_data][4] restore failed]; nested: IndexShardRestoreFailedException[[dev_cloud_app_data][4] failed to restore snapshot [snapshot-2015-01-13-2]]; nested: IndexShardRestoreFailedException[[dev_cloud_app_data][4] Can't restore corrupted shard]; nested: CorruptIndexException[[dev_cloud_app_data][4] Preexisting corrupted index [corrupted_m4IDHs94TFa-8FqzXlfa7A] caused by: CorruptIndexException[checksum failed (hardware problem?) : expected=pp1w1u actual=br96ym (resource=name [_1.cfs], length [4165], checksum [pp1w1u], writtenBy [4.10.2])]\norg.apache.lucene.index.CorruptIndexException: checksum failed (hardware problem?) : expected=pp1w1u actual=br96ym (resource=name [_1.cfs], length [4165], checksum [pp1w1u], writtenBy [4.10.2])\n        at org.elasticsearch.index.store.Store$VerifyingIndexOutput.readAndCompareChecksum(Store.java:882)\n        at org.elasticsearch.index.store.Store$VerifyingIndexOutput.writeBytes(Store.java:894)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$RestoreContext.restoreFile(BlobStoreIndexShardRepository.java:834)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$RestoreContext.restore(BlobStoreIndexShardRepository.java:784)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.restore(BlobStoreIndexShardRepository.java:162)\n        at org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.restore(IndexShardSnapshotAndRestoreService.java:124)\n        at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:127)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n]; ]]\n[2015-01-13 15:51:56,679][WARN ][index.snapshots.blobstore] [finderbox-dev-1-elasticsearch-dev] [dev_cloud_asset_data][1] Can't read metadata from store\norg.apache.lucene.index.CorruptIndexException: [dev_cloud_asset_data][1] Preexisting corrupted index [corrupted_YJZCTeR0SD6vMEQUGCphpQ] caused by: CorruptIndexException[verification failed (hardware problem?) : expected=lni6fe actual=null writtenLength=106 expectedLength=11473 (resource=name [_2i.cfs], length [11473], checksum [lni6fe], writtenBy [4.10.2])]\norg.apache.lucene.index.CorruptIndexException: verification failed (hardware problem?) : expected=lni6fe actual=null writtenLength=106 expectedLength=11473 (resource=name [_2i.cfs], length [11473], checksum [lni6fe], writtenBy [4.10.2])\n        at org.elasticsearch.index.store.Store$VerifyingIndexOutput.verify(Store.java:866)\n        at org.elasticsearch.index.store.Store.verify(Store.java:345)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$RestoreContext.restoreFile(BlobStoreIndexShardRepository.java:842)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$RestoreContext.restore(BlobStoreIndexShardRepository.java:784)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.restore(BlobStoreIndexShardRepository.java:162)\n        at org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.restore(IndexShardSnapshotAndRestoreService.java:124)\n        at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:127)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n\n        at org.elasticsearch.index.store.Store.failIfCorrupted(Store.java:411)\n        at org.elasticsearch.index.store.Store.failIfCorrupted(Store.java:392)\n        at org.elasticsearch.index.store.Store.getMetadata(Store.java:181)\n        at org.elasticsearch.index.store.Store.getMetadataOrEmpty(Store.java:147)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$RestoreContext.restore(BlobStoreIndexShardRepository.java:718)\n        at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.restore(BlobStoreIndexShardRepository.java:162)\n        at org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.restore(IndexShardSnapshotAndRestoreService.java:124)\n        at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:127)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n[2015-01-13 15:51:56,679][WARN ][indices.cluster          ] [finderbox-dev-1-elasticsearch-dev] [dev_cloud_asset_data][1] failed to start shard\n```\n\nI have done successful restores before, though. I'm on elasticsearch 1.4.0 .\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}