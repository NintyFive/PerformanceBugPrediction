{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50109","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50109/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50109/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50109/events","html_url":"https://github.com/elastic/elasticsearch/issues/50109","id":536679343,"node_id":"MDU6SXNzdWU1MzY2NzkzNDM=","number":50109,"title":"date_histogram of date_range with null end points triggers a circuit breaker","user":{"login":"jcrapuchettes","id":4846109,"node_id":"MDQ6VXNlcjQ4NDYxMDk=","avatar_url":"https://avatars3.githubusercontent.com/u/4846109?v=4","gravatar_id":"","url":"https://api.github.com/users/jcrapuchettes","html_url":"https://github.com/jcrapuchettes","followers_url":"https://api.github.com/users/jcrapuchettes/followers","following_url":"https://api.github.com/users/jcrapuchettes/following{/other_user}","gists_url":"https://api.github.com/users/jcrapuchettes/gists{/gist_id}","starred_url":"https://api.github.com/users/jcrapuchettes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcrapuchettes/subscriptions","organizations_url":"https://api.github.com/users/jcrapuchettes/orgs","repos_url":"https://api.github.com/users/jcrapuchettes/repos","events_url":"https://api.github.com/users/jcrapuchettes/events{/privacy}","received_events_url":"https://api.github.com/users/jcrapuchettes/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false}],"milestone":null,"comments":15,"created_at":"2019-12-11T23:58:06Z","updated_at":"2020-07-13T20:43:12Z","closed_at":"2020-07-13T20:43:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 7.4.2\r\n\r\n**Plugins installed**: [repository-s3, discovery-ec2]\r\n\r\n**JVM version**: Bundled version\r\n\r\n**OS version**: 4.14.138-114.102.amzn2.x86_64 (Amazon Linux 2)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning a date_histogram on a date_range field with document values that have null \"lte\" appears to cause the aggregation to create an infinite number of buckets and I get an out of memory error. The aggregation works well for fully defined date ranges (the first document in my example), but I have a large number of documents that have an undefined end point (value is null, second document in my example). I have been looking for a way to limit the buckets created in the query, but without luck. I've also tried to use a date_range aggregation on the fields to attempt to limit the potential buckets, but that caused cast exceptions.\r\n\r\nBasically I'm attempting to find all of the months up to now that these documents cover/touch. I'd like to see buckets from 2017-10-01 to 2019-12-01 (as of the time of this issue being written).\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create index:\r\n```\r\nPUT test\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 1\r\n  },\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"active_range\": {\r\n        \"type\": \"date_range\",\r\n        \"format\": \"yyyy-MM-dd\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n2. Add documents:\r\n```\r\nPOST test/_doc/\r\n{\r\n  \"active_range\": {\r\n    \"gte\": \"2017-10-10\",\r\n    \"lte\": \"2018-10-10\"\r\n  }\r\n}\r\n\r\nPOST test/_doc/\r\n{\r\n  \"active_range\": {\r\n    \"gte\": \"2017-10-10\",\r\n    \"lte\": null\r\n  }\r\n}\r\n```\r\n\r\n3. Run aggregation:\r\n```\r\nGET test/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"active\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"active_range\",\r\n        \"calendar_interval\": \"month\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}