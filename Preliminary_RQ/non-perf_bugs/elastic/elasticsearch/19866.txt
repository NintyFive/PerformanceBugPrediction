{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866/events","html_url":"https://github.com/elastic/elasticsearch/issues/19866","id":169937467,"node_id":"MDU6SXNzdWUxNjk5Mzc0Njc=","number":19866,"title":"Docs missing from a replica","user":{"login":"rtkmhart","id":2601414,"node_id":"MDQ6VXNlcjI2MDE0MTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/2601414?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkmhart","html_url":"https://github.com/rtkmhart","followers_url":"https://api.github.com/users/rtkmhart/followers","following_url":"https://api.github.com/users/rtkmhart/following{/other_user}","gists_url":"https://api.github.com/users/rtkmhart/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkmhart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkmhart/subscriptions","organizations_url":"https://api.github.com/users/rtkmhart/orgs","repos_url":"https://api.github.com/users/rtkmhart/repos","events_url":"https://api.github.com/users/rtkmhart/events{/privacy}","received_events_url":"https://api.github.com/users/rtkmhart/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2016-08-08T14:30:46Z","updated_at":"2017-10-28T16:23:56Z","closed_at":"2017-10-28T16:23:56Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.3\n**Plugins installed**: cloud-aws\n**JVM version**: 1.8.0_25\n**OS version**: Ubuntu 12.04 LTS\n**Description of the problem including expected versus actual behavior**:\n\nI have a document that exists in one replica of a shard but not in the other replica. The initial symptom is that an update on a document id failed, further investigation showed that some nodes could search for the id and some failed. For example (all identifiers changed to protect the innocent):\n\n`GET /myindex/_search?q=doc1234`\n\nreturns this when the query hits the shard where the doc doesn't exist:\n\n```\n\"hits\" : {\n\"total\" : 1,\n\"max_score\" : 1.0,\n\"hits\" : [ {\n  \"_index\" : \"myindex\",\n  \"_type\" : \"mydoctype\",\n  \"_id\" : \"doc1234\"\n  \"_score\" : 1.0,\n  \"_source\" : {\n    \"explain\" : true\n  }\n} ]\n```\n\nBut when it hits the shard where the doc does exist, I get the full document back.\n\nWhen I add the 'explain' parameter I can figure out which shard instance it is, and turns out that the primary has 3 fewer documents than the replica (out of 2.3M docs)\n\nThe document in question above is in the replica, but not the primary. I restored a snapshot of the index to another cluster, and I guess because it only restores the primary shard, the document is missing from there as well in both replica and primary.\n\nAfter further investigation I see that the document count between primary and replicas are different in 469 of my 8662 shards. I suspect there's more but short of comparing doc id's between the primary/replica of each shard (not really possible given the size) that's all I can go by for now. So this is not an isolated problem but quite a bit more widespread.\n\nOf those shards, some were created and brought over from 1.7. Others were created in 2.3.3 very recently. There's no pattern for age of index. The document in question was created on August 4, 2016 on an older index, but other time-based indices created in the past few days suffer the same document mismatch.\n\nI have started a discussion here: https://discuss.elastic.co/t/docs-missing-from-a-replica/57382\nThis does smell like a much older discussion over here: https://discuss.elastic.co/t/how-to-fix-primary-replica-inconsistency/9016/18\n\nLooking for ideas on how to troubleshoot this further.\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}