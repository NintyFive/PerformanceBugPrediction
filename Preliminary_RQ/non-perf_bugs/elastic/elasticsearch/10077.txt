{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10077","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10077/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10077/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10077/events","html_url":"https://github.com/elastic/elasticsearch/issues/10077","id":60903221,"node_id":"MDU6SXNzdWU2MDkwMzIyMQ==","number":10077,"title":"Bug in PageCacheRecycler?","user":{"login":"prog8","id":6692291,"node_id":"MDQ6VXNlcjY2OTIyOTE=","avatar_url":"https://avatars0.githubusercontent.com/u/6692291?v=4","gravatar_id":"","url":"https://api.github.com/users/prog8","html_url":"https://github.com/prog8","followers_url":"https://api.github.com/users/prog8/followers","following_url":"https://api.github.com/users/prog8/following{/other_user}","gists_url":"https://api.github.com/users/prog8/gists{/gist_id}","starred_url":"https://api.github.com/users/prog8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prog8/subscriptions","organizations_url":"https://api.github.com/users/prog8/orgs","repos_url":"https://api.github.com/users/prog8/repos","events_url":"https://api.github.com/users/prog8/events{/privacy}","received_events_url":"https://api.github.com/users/prog8/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2015-03-12T21:10:08Z","updated_at":"2015-03-16T16:14:12Z","closed_at":"2015-03-16T03:29:42Z","author_association":"NONE","active_lock_reason":null,"body":"I hit a problem where PageCacheRecycler seems to be too big. I have an impression this is bigger than the limit. Default page.limit.heap is 10% and default weights for byte/long/int/float/double are 1/1/1/1/1. This implies that for 30G heap NONE of pages should be bigger than 600MB if I'm not wrong.\n\nLooking into PageCacheRecycler.maxCount method calculates higher values for bigger data types. If for float maxCount is 1000 for double it is 2000. I think this is not correct because (later in PageCacheRecycler class) I can see this:\n\n```\nreturn new byte[BigArrays.BYTE_PAGE_SIZE];\nreturn new int[BigArrays.INT_PAGE_SIZE];\nreturn new long[BigArrays.LONG_PAGE_SIZE];\nreturn new float[BigArrays.FLOAT_PAGE_SIZE];\nreturn new double[BigArrays.DOUBLE_PAGE_SIZE];\nreturn new Object[BigArrays.OBJECT_PAGE_SIZE];\n```\n\nAll of those arrays seems to have by default the same size 16kB.\n\nMy intuition says that all calls like:\n\n```\nbytePage = build(type, maxCount(limit, BigArrays.BYTE_PAGE_SIZE, bytesWeight, totalWeight), searchThreadPoolSize, availableProcessors, new AbstractRecyclerC<byte[]>() {\ndoublePage = build(type, maxCount(limit, BigArrays.DOUBLE_PAGE_SIZE, doubleWeight, totalWeight), searchThreadPoolSize, availableProcessors, new AbstractRecyclerC<double[]>() {\n```\n\nshould be\n\n```\nbytePage = build(type, maxCount(limit, BigArrays.PAGE_SIZE_IN_BYTES, bytesWeight, totalWeight), searchThreadPoolSize, availableProcessors, new AbstractRecyclerC<byte[]>() {\ndoublePage = build(type, maxCount(limit, BigArrays.PAGE_SIZE_IN_BYTES, doubleWeight, totalWeight), searchThreadPoolSize, availableProcessors, new AbstractRecyclerC<double[]>() {\n```\n\nI'll simulate maxSize of double[] with current calls of maxCount, 30G heap and 10% limit for recycled pages size.\n\nmaxCount(3'000'000'000, 2048, 1, 4.1) -> 1 / 4.1 \\* 3'000'000'000 / 2048 = 357278\nEach page size is 16kB so ... 16kB \\* 357278 implies **5.7GB** (only for doubles). Isn't it too much? Can anyone take a look and verify?\n\nMoreover i see another - minor bug\n\n```\nfinal double totalWeight = bytesWeight + intsWeight + longsWeight + doublesWeight + objectsWeight;\n```\n\nIt seems that floatWeight is missing\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}