{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51780","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51780/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51780/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51780/events","html_url":"https://github.com/elastic/elasticsearch/issues/51780","id":558437187,"node_id":"MDU6SXNzdWU1NTg0MzcxODc=","number":51780,"title":"Transforms mapping deduction fails for scailed_float types for min and max aggregation","user":{"login":"jeffvestal","id":53237856,"node_id":"MDQ6VXNlcjUzMjM3ODU2","avatar_url":"https://avatars0.githubusercontent.com/u/53237856?v=4","gravatar_id":"","url":"https://api.github.com/users/jeffvestal","html_url":"https://github.com/jeffvestal","followers_url":"https://api.github.com/users/jeffvestal/followers","following_url":"https://api.github.com/users/jeffvestal/following{/other_user}","gists_url":"https://api.github.com/users/jeffvestal/gists{/gist_id}","starred_url":"https://api.github.com/users/jeffvestal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeffvestal/subscriptions","organizations_url":"https://api.github.com/users/jeffvestal/orgs","repos_url":"https://api.github.com/users/jeffvestal/repos","events_url":"https://api.github.com/users/jeffvestal/events{/privacy}","received_events_url":"https://api.github.com/users/jeffvestal/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"}],"state":"closed","locked":false,"assignee":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"assignees":[{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-02-01T00:06:38Z","updated_at":"2020-02-06T16:26:45Z","closed_at":"2020-02-06T16:26:45Z","author_association":"NONE","active_lock_reason":null,"body":"**Affected versions**:7.2 ->\r\n\r\n**Problem**: Transform deducts the mapping for the destination index based on the configuration, for certain aggregations like min, max transforms takes the mapping of the source index. If the source index uses scaled_float and you configure min and/or max, the transform will fail.\r\n\r\n**Mitigation**: If you run into this issue:\r\n\r\n1. create the transform\r\n2. Create the destination index manually with the appropriate mappings\r\n3. start the transform\r\n\r\n## Original report\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** : 7.5.2\r\n**JVM version** : openjdk version \"1.8.0_222\" / and ESS\r\n**OS version** : Mac and on ESS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen I create a new Transform and I use and aggregation max `scaled_float` field, I hit 2 issues\r\n1. The mapping for the new index is not correctly created throwing an error` Field [max] misses required parameter [scaling_factor]` and it wonâ€™t create the index\r\n2. After manually creating the mapping, it starts but eventually fails with `Caused by: com.fasterxml.jackson.core.JsonParseException: Current token (START_OBJECT) not numeric, can not use numeric value accessors`\r\n\r\nThis happens on both ESS and local Mac install\r\n\r\n**Steps to reproduce**:\r\n\r\n## Create source index mapping\r\n```\r\nPUT test_source\r\n{\r\n    \"mappings\" : {\r\n      \"properties\" : {\r\n        \"trace\" : {\r\n          \"properties\" : {\r\n            \"id\" : {\r\n              \"type\" : \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"labels\" : {\r\n          \"dynamic\" : \"true\",\r\n          \"properties\" : {\r\n            \"step\" : {\r\n              \"type\" : \"scaled_float\",\r\n              \"scaling_factor\" : 1000000.0\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n}\r\n```\r\n## Put a few source docs abc,1 abc,2 abc,3 def,1 def2\r\n```\r\nPOST test_source/_doc\r\n{\r\n  \"trace.id\": \"abc\",\r\n  \"labels.step\": 3\r\n}\r\n```\r\n##Create transform\r\n```\r\nPUT _transform/test_dest_01\r\n{\r\n  \"source\": {\r\n    \"index\": [\r\n      \"test_source\"\r\n    ],\r\n    \"query\": {\r\n      \"match_all\": {}\r\n    }\r\n  },\r\n  \"pivot\": {\r\n    \"group_by\": {\r\n      \"trace.id\": {\r\n        \"terms\": {\r\n          \"field\": \"trace.id\"\r\n        }\r\n      }\r\n    },\r\n    \"aggregations\": {\r\n            \"labels.step.max\": {\r\n        \"max\": {\r\n          \"field\": \"labels.step\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"test_dest_01\"\r\n  }\r\n}\r\n```\r\n## attempt to start but fail\r\n```\r\nPOST _transform/test_dest_01/_start\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"Failed to parse mapping [_doc]: Field [max] misses required parameter [scaling_factor]\"\r\n      }\r\n    ],\r\n    \"type\": \"runtime_exception\",\r\n    \"reason\": \"runtime_exception: Could not create destination index [test_dest_01] for transform [test_dest_01]\",\r\n    \"caused_by\": {\r\n      \"type\": \"mapper_parsing_exception\",\r\n      \"reason\": \"Failed to parse mapping [_doc]: Field [max] misses required parameter [scaling_factor]\",\r\n      \"caused_by\": {\r\n        \"type\": \"illegal_argument_exception\",\r\n        \"reason\": \"Field [max] misses required parameter [scaling_factor]\"\r\n      }\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n## Put dest mapping manually\r\n```\r\nPUT test_dest_01\r\n{\r\n    \"mappings\" : {\r\n      \"_meta\" : {\r\n        \"created_by\" : \"transform\",\r\n        \"_transform\" : {\r\n          \"transform\" : \"thtest_dest_012\",\r\n          \"version\" : {\r\n            \"created\" : \"7.5.2\"\r\n          }\r\n        }\r\n      },\r\n      \"properties\" : {\r\n        \"trace\" : {\r\n          \"properties\" : {\r\n            \"id\" : {\r\n              \"type\" : \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"labels\" : {\r\n          \"dynamic\" : \"true\",\r\n          \"properties\" : {\r\n            \"step\" : {\r\n              \"type\" : \"scaled_float\",\r\n              \"scaling_factor\" : 1000000.0\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n}\r\n```\r\n\r\n## Response\r\n```\r\n{\r\n  \"acknowledged\" : true,\r\n  \"shards_acknowledged\" : true,\r\n  \"index\" : \"test_dest_01\"\r\n}\r\n```\r\n\r\n## Start again\r\n```\r\nPOST _transform/test_dest_01/_start`\r\n`\r\n{\r\n  \"acknowledged\" : true\r\n}\r\n```\r\n\r\n## Status\r\n`GET _transform/test_dest_01/_stats`\r\n-> starts but never completes\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n## Eventually fails after 10 bulk exceptions\r\n```\r\n[2020-01-31T16:03:38,130][DEBUG][o.e.a.b.TransportShardBulkAction] [critter.lan] [test_dest_01][0] failed to execute bulk item (index) index {[test_dest_01][_doc][ZLnd4QnTNZcP1r6XC5Q9jaEAAAAAAAAA], source[{\"trace\":{\"id\":\"def\"},\"labels\":{\"step\":{\"max\":2.0}}}]}\r\norg.elasticsearch.index.mapper.MapperParsingException: failed to parse field [labels.step] of type [scaled_float] in document with id 'ZLnd4QnTNZcP1r6XC5Q9jaEAAAAAAAAA'. Preview of field's value: '{max=2.0}'\r\n    at org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:299) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:488) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseObject(DocumentParser.java:505) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.innerParseObject(DocumentParser.java:418) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrNested(DocumentParser.java:395) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:485) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseObject(DocumentParser.java:505) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.innerParseObject(DocumentParser.java:418) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrNested(DocumentParser.java:395) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.internalParseDocument(DocumentParser.java:112) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentParser.parseDocument(DocumentParser.java:71) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:267) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShard.prepareIndex(IndexShard.java:791) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShard.applyIndexOperation(IndexShard.java:768) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShard.applyIndexOperationOnPrimary(IndexShard.java:740) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:258) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.bulk.TransportShardBulkAction$2.doRun(TransportShardBulkAction.java:161) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.performOnPrimary(TransportShardBulkAction.java:193) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:118) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:79) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:917) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:108) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.runWithPrimaryShardReference(TransportReplicationAction.java:394) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.lambda$doRun$0(TransportReplicationAction.java:316) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShard.lambda$wrapPrimaryOperationPermitListener$22(IndexShard.java:2796) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.ActionListener$3.onResponse(ActionListener.java:113) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShardOperationPermits.acquire(IndexShardOperationPermits.java:285) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShardOperationPermits.acquire(IndexShardOperationPermits.java:237) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationPermit(IndexShard.java:2770) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryOperationPermit(TransportReplicationAction.java:858) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:312) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.action.support.replication.TransportReplicationAction.handlePrimaryRequest(TransportReplicationAction.java:275) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:257) [x-pack-security-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:315) [x-pack-security-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:63) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:752) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:773) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.5.2.jar:7.5.2]\r\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n    at java.lang.Thread.run(Thread.java:830) [?:?]\r\nCaused by: com.fasterxml.jackson.core.JsonParseException: Current token (START_OBJECT) not numeric, can not use numeric value accessors\r\n at [Source: org.elasticsearch.common.bytes.BytesReference$MarkSupportingStreamInputWrapper@6b657c5c; line: 1, column: 41]\r\n    at com.fasterxml.jackson.core.JsonParser._constructError(JsonParser.java:1702) ~[jackson-core-2.8.11.jar:2.8.11]\r\n    at com.fasterxml.jackson.core.base.ParserMinimalBase._reportError(ParserMinimalBase.java:558) ~[jackson-core-2.8.11.jar:2.8.11]\r\n    at com.fasterxml.jackson.core.base.ParserBase._parseNumericValue(ParserBase.java:837) ~[jackson-core-2.8.11.jar:2.8.11]\r\n    at com.fasterxml.jackson.core.base.ParserBase.getDoubleValue(ParserBase.java:751) ~[jackson-core-2.8.11.jar:2.8.11]\r\n    at org.elasticsearch.common.xcontent.json.JsonXContentParser.doDoubleValue(JsonXContentParser.java:176) ~[elasticsearch-x-content-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.common.xcontent.support.AbstractXContentParser.doubleValue(AbstractXContentParser.java:243) ~[elasticsearch-x-content-7.5.2.jar:7.5.2]\r\n    at org.elasticsearch.index.mapper.ScaledFloatFieldMapper.parse(ScaledFloatFieldMapper.java:474) ~[?:?]\r\n    at org.elasticsearch.index.mapper.ScaledFloatFieldMapper.parseCreateField(ScaledFloatFieldMapper.java:396) ~[?:?]\r\n    at org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:277) ~[elasticsearch-7.5.2.jar:7.5.2]\r\n```\r\n","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}