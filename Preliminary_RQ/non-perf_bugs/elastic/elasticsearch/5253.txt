{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5253","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5253/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5253/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5253/events","html_url":"https://github.com/elastic/elasticsearch/issues/5253","id":28244314,"node_id":"MDU6SXNzdWUyODI0NDMxNA==","number":5253,"title":"Sorting on SingleBucketAggregation's should be possible","user":{"login":"thanodnl","id":273145,"node_id":"MDQ6VXNlcjI3MzE0NQ==","avatar_url":"https://avatars2.githubusercontent.com/u/273145?v=4","gravatar_id":"","url":"https://api.github.com/users/thanodnl","html_url":"https://github.com/thanodnl","followers_url":"https://api.github.com/users/thanodnl/followers","following_url":"https://api.github.com/users/thanodnl/following{/other_user}","gists_url":"https://api.github.com/users/thanodnl/gists{/gist_id}","starred_url":"https://api.github.com/users/thanodnl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thanodnl/subscriptions","organizations_url":"https://api.github.com/users/thanodnl/orgs","repos_url":"https://api.github.com/users/thanodnl/repos","events_url":"https://api.github.com/users/thanodnl/events{/privacy}","received_events_url":"https://api.github.com/users/thanodnl/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-02-25T12:44:34Z","updated_at":"2017-08-11T11:14:24Z","closed_at":"2014-03-05T23:22:03Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Aggregations are a really great feature to create tableviews of analytics with ease. And the support for sorting on sub-aggregations gives the user the freedom to sort on any given column like he/she is used to. Although not every metric thinkable of can be used in sorts.\n\nFor example, if you have two columns where you show the number of males and females occuring with a term you would get a facet like this:\n\n```\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"someterm\": {\n      \"terms\": {\n        \"field\": \"somefield\"\n      },\n      \"aggs\": {\n        \"male\": {\n          \"filter\": {\n            \"term\": {\n              \"gender\": \"male\"\n            }\n          }\n        },\n        \"female\": {\n          \"filter\": {\n            \"term\": {\n              \"gender\": \"female\"\n            }\n          }\n        }\n      }\n    }\n  }   \n}\n```\n\nUnfortunately as soon as you want to sort the terms on a specific gender you get a message that it is unable to do so since the filter aggregation is not of a metric type.\n\nLooking in to the code I think it would be technically possible to sort on the count of a filtered aggregation but is not yet implemented. I purpose a way to sort on sub aggregations of terms by its path.\n\nTake the following aggregation:\n\n```\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"someterm\": {\n      \"terms\": {\n        \"field\": \"somefield\",\n        \"order\": {\n          \"male._count\": \"desc\" // would count on the doc_count of the 'male' sub-aggregation in a descending way\n        }\n      },\n      \"aggs\": {\n        \"male\": {\n          \"filter\": {\n            \"term\": {\n              \"gender\": \"male\"\n            }\n          }\n        },\n        \"female\": {\n          \"filter\": {\n            \"term\": {\n              \"gender\": \"female\"\n            }\n          }\n        }\n      }\n    }\n  }   \n}\n```\n\nCurrently it responds with an error explaining the sort can only be on metric aggregations. This seems a limitation which is not technical. The only limitation is that comparators for `MetricsAggregation` are implemented in `InternalOrder`, and for that matter in `MultiBucketsAggregation`.\n\nBy implementing a sorter for instances of `SingleBucketAggregation` we can sort not only on the count, but also on aggregations within this filtered aggregation (eg. an average of a filtered aggregation) by specifying a path to the aggregation the same way a path is provided now but with an extra element in the path.\n\n```\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"some_agg\": {\n      \"terms\": {\n        \"field\": \"some_field\",\n        \"order\": {\n          \"count_of_a.again_some_field.avg\": \"desc\"\n        }\n      },\n      \"aggs\": {\n        \"count_of_a\": {\n          \"filter\": {\n            \"term\": {\n              \"some_other_field\": \"a\"\n            }\n          },\n          \"aggs\": {\n            \"again_some_field\": {\n              \"stats\": {\n                \"field\": \"again_some_field\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nIn this example you would sort on the average value of `again_some_field` filtered where `some_other_field` has a value of `a`.\n\nTo show that it is possible I [hacked together](https://github.com/thanodnl/elasticsearch/commit/61993a33a7073b94b3f813478630a72a11c01c17) a POC, but it turned out to be more complex than I imagened at first. It supports atleast the sorting on the count of a filter-aggregation, and even the sub-metrics of such a filter. I hope you can pick this up in the roadmap of Elasticsearch v1.*\n","closed_by":{"login":"uboness","id":211019,"node_id":"MDQ6VXNlcjIxMTAxOQ==","avatar_url":"https://avatars3.githubusercontent.com/u/211019?v=4","gravatar_id":"","url":"https://api.github.com/users/uboness","html_url":"https://github.com/uboness","followers_url":"https://api.github.com/users/uboness/followers","following_url":"https://api.github.com/users/uboness/following{/other_user}","gists_url":"https://api.github.com/users/uboness/gists{/gist_id}","starred_url":"https://api.github.com/users/uboness/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uboness/subscriptions","organizations_url":"https://api.github.com/users/uboness/orgs","repos_url":"https://api.github.com/users/uboness/repos","events_url":"https://api.github.com/users/uboness/events{/privacy}","received_events_url":"https://api.github.com/users/uboness/received_events","type":"User","site_admin":false},"performed_via_github_app":null}