{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46727","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46727/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46727/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46727/events","html_url":"https://github.com/elastic/elasticsearch/issues/46727","id":493724667,"node_id":"MDU6SXNzdWU0OTM3MjQ2Njc=","number":46727,"title":"ElasticSearch - Spring Boot - Upsert is throwing DocumentMissingException","user":{"login":"yatendragoel","id":1221759,"node_id":"MDQ6VXNlcjEyMjE3NTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1221759?v=4","gravatar_id":"","url":"https://api.github.com/users/yatendragoel","html_url":"https://github.com/yatendragoel","followers_url":"https://api.github.com/users/yatendragoel/followers","following_url":"https://api.github.com/users/yatendragoel/following{/other_user}","gists_url":"https://api.github.com/users/yatendragoel/gists{/gist_id}","starred_url":"https://api.github.com/users/yatendragoel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yatendragoel/subscriptions","organizations_url":"https://api.github.com/users/yatendragoel/orgs","repos_url":"https://api.github.com/users/yatendragoel/repos","events_url":"https://api.github.com/users/yatendragoel/events{/privacy}","received_events_url":"https://api.github.com/users/yatendragoel/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-09-15T11:10:33Z","updated_at":"2019-09-20T09:41:40Z","closed_at":"2019-09-19T08:06:17Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: Version: 6.4.3, Build: default/tar/fe40335/2018-10-30T23:17:19.084789Z, JVM: 1.8.0_191\r\n\r\n**Plugins installed**: None\r\n\r\n**JVM version**: java version \"1.8.0_191\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_191-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)\r\n\r\n**OS version**: Darwin Yatendras-MacBook-Pro.local 18.5.0 Darwin Kernel Version 18.5.0: Mon Mar 11 20:40:32 PDT 2019; root:xnu-4903.251.3~3/RELEASE_X86_64 x86_64\r\n\r\n**Issue Description**:\r\nI am using Spring Boot and ElasticSearch. When I am trying to upsert using Spring, it is throwing `DocumentMissingException` when there is no document present in the ElasticSearch. The same code works fine when there is a document present in the ElasticSearch.\r\n\r\n**Code**:\r\n\r\n    public <S extends Company> void saveAllCustom(Iterable<S> companies) {\r\n\r\n        List<UpdateQuery> updateQueries = new ArrayList<UpdateQuery>();\r\n\r\n        ObjectMapper oMapper = new ObjectMapper();\r\n\r\n        for (S company : companies) {\r\n\r\n            Map<String, Object> companyJsonMap = (Map<String, Object>) oMapper.convertValue(company, Map.class);\r\n\r\n            Map<String, Object> paramsDocument = new HashMap<String, Object>();\r\n            paramsDocument.put(\"doc\", companyJsonMap);\r\n\r\n            Script script = new Script(\r\n                ScriptType.INLINE\r\n                , \"painless\"\r\n                , \"if (ctx._source.dataAsOf < params.doc.dataAsOf) {ctx._source = params.doc}\"\r\n                , paramsDocument);\r\n\r\n            UpdateRequest updateRequest = new UpdateRequest()\r\n                .index(\"company\")\r\n                .type(\"_doc\")\r\n                .id(company.cin)\r\n                .script(script) // Conditional Update\r\n                .upsert(companyJsonMap);\r\n\r\n            UpdateQuery updateQuery = new UpdateQueryBuilder()\r\n                .withIndexName(\"company\")\r\n                .withType(\"_doc\")\r\n                .withId(company.cin)\r\n                .withDoUpsert(true)\r\n                .withClass(Company.class)\r\n                .withUpdateRequest(updateRequest)\r\n                .build();\r\n\r\n            updateQueries.add(updateQuery);\r\n\r\n        }\r\n\r\n        elasticsearchTemplate.bulkUpdate(updateQueries);\r\n    }\r\n\r\n**Logs**:\r\norg.springframework.data.elasticsearch.ElasticsearchException: Bulk indexing has failures. Use ElasticsearchException.getFailedDocuments() for detailed messages [{U65929AR1978SGC001748=[company/vteSxfKoRF-k4g982vissw][[company][2]] DocumentMissingException[[_doc][U65929AR1978SGC001748]: document missing], U45309AR2000PTC006288=[company/vteSxfKoRF-k4g982vissw][[company][3]] DocumentMissingException[[_doc][U45309AR2000PTC006288]: document missing],...\r\n\r\n**But a similar upsert command is working using CURL:**\r\n\r\n    curl -X POST \"localhost:9200/company/_doc/10001/_update\" -H 'Content-Type: application/json' -d'\r\n    {\r\n        \"script\": {\r\n            \"lang\": \"painless\",\r\n            \"source\": \"ctx._source = params.doc\",\r\n            \"params\": {\r\n                \"doc\": {\r\n                    \"name\": \"XYZ LIMITED - updated\",\r\n                    \"cin\": \"10001\"\r\n                }\r\n            }\r\n        },\r\n        \"upsert\" : {\r\n            \"name\": \"XYZ LIMITED - newly created\",\r\n            \"cin\": \"10001\"\r\n        }\r\n    }'\r\n\r\nAs per my understanding, when there is no document present in the ElasticSearch, it shouldn't throw a `DocumentMissingException` because I have added `upsert(...)` as well in the query.\r\n\r\nPlease let me know if anything else is needed from my end.","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}