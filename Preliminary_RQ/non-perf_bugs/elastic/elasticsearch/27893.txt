{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893/events","html_url":"https://github.com/elastic/elasticsearch/issues/27893","id":283188859,"node_id":"MDU6SXNzdWUyODMxODg4NTk=","number":27893,"title":"Aggregations do not always operate within the scope of the query for nested fields","user":{"login":"valdemarrolfsen","id":8336948,"node_id":"MDQ6VXNlcjgzMzY5NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/8336948?v=4","gravatar_id":"","url":"https://api.github.com/users/valdemarrolfsen","html_url":"https://github.com/valdemarrolfsen","followers_url":"https://api.github.com/users/valdemarrolfsen/followers","following_url":"https://api.github.com/users/valdemarrolfsen/following{/other_user}","gists_url":"https://api.github.com/users/valdemarrolfsen/gists{/gist_id}","starred_url":"https://api.github.com/users/valdemarrolfsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/valdemarrolfsen/subscriptions","organizations_url":"https://api.github.com/users/valdemarrolfsen/orgs","repos_url":"https://api.github.com/users/valdemarrolfsen/repos","events_url":"https://api.github.com/users/valdemarrolfsen/events{/privacy}","received_events_url":"https://api.github.com/users/valdemarrolfsen/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2017-12-19T11:07:03Z","updated_at":"2017-12-19T16:31:29Z","closed_at":"2017-12-19T15:24:28Z","author_association":"NONE","active_lock_reason":null,"body":"# Bug report\r\n\r\n**Elasticsearch version**:\r\n6.1.0\r\n\r\n**JVM version**:\r\n9.0.1\r\n\r\n**OS version**:\r\nDarwin Kernel Version 17.0.0\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAggregations do not always operate within the scope of the query for nested fields.\r\n\r\nExpected behavior:\r\nWhen aggregating using the date_histogram aggregation the expected behavior is that only nested fields with date values contained within the ranges specified in the query scope are used for the aggregation.\r\n\r\nActual behavior:\r\nValues outside the specified range is used for the aggregations\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create a new index with nested field\r\n```\r\ncurl -XPUT 'localhost:9200/test-index?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"number_of_shards\" : 1\r\n    },\r\n    \"mappings\" : {\r\n        \"test\" : {\r\n            \"properties\" : {\r\n                \"name\" : { \"type\" : \"text\" },\r\n                \"nested_field\": {\r\n                \t\"type\": \"nested\",\r\n                \t\"properties\": {\r\n                \t\t\"date\": {\"type\": \"date\"}\r\n                \t}\r\n                \t\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n2. Send some data to the index\r\n\r\n```\r\ncurl -XPUT 'localhost:9200/test-index/test/1?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n\t\"name\": \"Hello\",\r\n\t\"nested_field\": [\r\n\t\t{\"date\": \"2013-01-01T00:00:00.000Z\"},\r\n\t\t{\"date\": \"2013-02-01T00:00:00.000Z\"},\r\n\t\t{\"date\": \"2013-03-01T00:00:00.000Z\"},\r\n\t\t{\"date\": \"2014-03-01T00:00:00.000Z\"},\r\n\t\t{\"date\": \"2014-08-01T00:00:00.000Z\"},\r\n\t\t{\"date\": \"2015-03-01T00:00:00.000Z\"}\r\n\t]\r\n}\r\n```\r\n\r\n3. Do a histogram aggregation that should only include values from 2013 and 2014\r\n\r\n```\r\ncurl -XGET 'localhost:9200/test-index/_search?size=0&pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n    \"query\": {\r\n        \"nested\": {\r\n            \"path\": \"nested_field\",\r\n            \"query\": {\r\n                \"range\": {\r\n                    \"nested_field.date\": {\r\n                        \"gte\": \"2013\",\r\n                        \"lte\": \"2014\",\r\n                        \"format\": \"yyyy\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"aggs\" : {\r\n        \"nested_field\": {\r\n            \"nested\": {\r\n                \"path\": \"nested_field\"\r\n            },\r\n            \"aggs\": {\r\n                \"count_per_year\": {\r\n                    \"date_histogram\": {\r\n                        \"field\": \"nested_field.date\",\r\n                        \"interval\": \"year\"\r\n                    }\r\n                }   \r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\nThe result of the query:\r\n```\r\n{\r\n    \"took\": 43,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"skipped\": 0,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 1,\r\n        \"max_score\": 0,\r\n        \"hits\": []\r\n    },\r\n    \"aggregations\": {\r\n        \"nested_field\": {\r\n            \"doc_count\": 6,\r\n            \"count_per_year\": {\r\n                \"buckets\": [\r\n                    {\r\n                        \"key_as_string\": \"2013-01-01T00:00:00.000Z\",\r\n                        \"key\": 1356998400000,\r\n                        \"doc_count\": 3\r\n                    },\r\n                    {\r\n                        \"key_as_string\": \"2014-01-01T00:00:00.000Z\",\r\n                        \"key\": 1388534400000,\r\n                        \"doc_count\": 2\r\n                    },\r\n                    {\r\n                        \"key_as_string\": \"2015-01-01T00:00:00.000Z\",\r\n                        \"key\": 1420070400000,\r\n                        \"doc_count\": 1\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n    }\r\n}\r\n```","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}