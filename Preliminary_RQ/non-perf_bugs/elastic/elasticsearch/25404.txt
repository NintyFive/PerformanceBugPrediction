{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25404","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25404/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25404/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25404/events","html_url":"https://github.com/elastic/elasticsearch/issues/25404","id":238645189,"node_id":"MDU6SXNzdWUyMzg2NDUxODk=","number":25404,"title":"Suggester context is null for path with index not_analyzed","user":{"login":"ofiesh","id":735357,"node_id":"MDQ6VXNlcjczNTM1Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/735357?v=4","gravatar_id":"","url":"https://api.github.com/users/ofiesh","html_url":"https://github.com/ofiesh","followers_url":"https://api.github.com/users/ofiesh/followers","following_url":"https://api.github.com/users/ofiesh/following{/other_user}","gists_url":"https://api.github.com/users/ofiesh/gists{/gist_id}","starred_url":"https://api.github.com/users/ofiesh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ofiesh/subscriptions","organizations_url":"https://api.github.com/users/ofiesh/orgs","repos_url":"https://api.github.com/users/ofiesh/repos","events_url":"https://api.github.com/users/ofiesh/events{/privacy}","received_events_url":"https://api.github.com/users/ofiesh/received_events","type":"User","site_admin":false},"labels":[{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-06-26T19:29:24Z","updated_at":"2017-07-24T15:45:02Z","closed_at":"2017-07-24T15:45:02Z","author_association":"NONE","active_lock_reason":null,"body":"**Edit:**\r\n\r\nOn 5.3.1 the context is:\r\n````            \r\n\"contexts\": {\r\n  \"theContext\": [\r\n    \"null\"\r\n  ]\r\n}\r\n````\r\non 5.4.2 the context is:\r\n````\r\n\"contexts\": {\r\n  \"theContext\": [\r\n    \"bar\",\r\n    \"null\"\r\n  ]\r\n}\r\n````\r\nThe context should be:\r\n````            \r\n\"contexts\": {\r\n  \"theContext\": [\r\n    \"bar\"\r\n  ]\r\n}\r\n````\r\n\r\n<hr />\r\n\r\nPerhaps this isn't a bug, but I can't find any documentation that suggests this shouldn't work.\r\n\r\nWhen setting a document field `index` to `not_analyzed`, a suggester context using `path` for that document field is null.\r\n\r\nI have a user id that's a UUID which I use a term query search on, but I also use the same user id for context in a suggest. I need to set the index to not_analyzed on the UUID so that I can use the term query, but when setting the index to not_analyzed the context the path is null in the suggest and never matches.\r\n\r\nThe work around is to set the context separately when uploading the document. This causes an extra field in the request (ohmy) and presumably an increase in storage space.\r\n\r\nHere's an example showing that the context path works when not specifying an index, but when setting the index to not_analyzed, the context is null.\r\n\r\n-----\r\nMapping without specifying index for `theContext`;\r\n````\r\ncurl -XPUT localhost:9200/analyzed -d '{\r\n     \"mappings\": {\r\n         \"indexed\" : {\r\n             \"properties\": {\r\n                 \"suggest\": {\r\n                     \"type\": \"completion\",\r\n                     \"contexts\": [\r\n                        {\r\n                            \"name\": \"theContext\",\r\n                            \"type\": \"category\",\r\n                            \"path\": \"theContext\"\r\n                         }\r\n                     ]\r\n                 },\r\n                 \"theContext\": {\r\n                   \"type\": \"string\"\r\n                 }\r\n             }\r\n         }\r\n     }\r\n }'\r\n````\r\nMapping for `\"index\": \"not_analyzed\"` for `theContext`:\r\n````\r\ncurl -XPUT localhost:9200/not_analyzed -d '{\r\n     \"mappings\": {\r\n         \"indexed\" : {\r\n             \"properties\": {\r\n                 \"suggest\": {\r\n                     \"type\": \"completion\",\r\n                     \"contexts\": [\r\n                        {\r\n                            \"name\": \"theContext\",\r\n                            \"type\": \"category\",\r\n                            \"path\": \"theContext\"\r\n                         }\r\n                     ]\r\n                 },\r\n                 \"theContext\": {\r\n                   \"type\": \"string\",\r\n                   \"index\": \"not_analyzed\"\r\n                 }\r\n             }\r\n         }\r\n     }\r\n }'\r\n````\r\nAdding the document to both:\r\n````\r\ncurl -XPOST localhost:9200/analyzed/indexed/foo -d '{\r\n\t\"suggest\": {\r\n\t\t\"input\": [\"foo\"]\r\n\t},\r\n\t\"theContext\": \"bar\"\r\n}'\r\ncurl -XPOST localhost:9200/not_analyzed/indexed/foo -d '{\r\n\t\"suggest\": {\r\n\t\t\"input\": [\"foo\"]\r\n\t},\r\n\t\"theContext\": \"bar\"\r\n}'\r\n````\r\nSearching `analyzed` shows `contexts.theContext = bar`:\r\n````\r\ncurl -XPOST localhost:9200/analyzed/indexed/_search -d '{\r\n  \"suggest\" : {\r\n    \"foo\" : {\r\n      \"prefix\" : \"foo\",\r\n      \"completion\" : {\r\n        \"field\" : \"suggest\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n````\r\n````\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 0,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"suggest\": {\r\n    \"foo\": [\r\n      {\r\n        \"text\": \"foo\",\r\n        \"offset\": 0,\r\n        \"length\": 3,\r\n        \"options\": [\r\n          {\r\n            \"text\": \"foo\",\r\n            \"_index\": \"analyzed\",\r\n            \"_type\": \"indexed\",\r\n            \"_id\": \"foo\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n              \"suggest\": {\r\n                \"input\": [\r\n                  \"foo\"\r\n                ]\r\n              },\r\n              \"theContext\": \"bar\"\r\n            },\r\n            \"contexts\": {\r\n              \"theContext\": [\r\n                \"bar\"\r\n              ]\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n````\r\n\r\nThe same search on `not_analyzed` shows `contexts.theContext = null`:\r\n````\r\ncurl -XPOST localhost:9200/not_analyzed/indexed/_search -d '{\r\n  \"suggest\" : {\r\n    \"foo\" : {\r\n      \"prefix\" : \"foo\",\r\n      \"completion\" : {\r\n        \"field\" : \"suggest\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n````\r\n````\r\n{\r\n  \"took\": 2,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 0,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"suggest\": {\r\n    \"foo\": [\r\n      {\r\n        \"text\": \"foo\",\r\n        \"offset\": 0,\r\n        \"length\": 3,\r\n        \"options\": [\r\n          {\r\n            \"text\": \"foo\",\r\n            \"_index\": \"not_analyzed\",\r\n            \"_type\": \"indexed\",\r\n            \"_id\": \"foo\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n              \"suggest\": {\r\n                \"input\": [\r\n                  \"foo\"\r\n                ]\r\n              },\r\n              \"theContext\": \"bar\"\r\n            },\r\n            \"contexts\": {\r\n              \"theContext\": [\r\n                \"null\"\r\n              ]\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n````","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}