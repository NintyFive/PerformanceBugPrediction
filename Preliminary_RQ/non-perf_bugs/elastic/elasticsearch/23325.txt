{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23325","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23325/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23325/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23325/events","html_url":"https://github.com/elastic/elasticsearch/issues/23325","id":209770217,"node_id":"MDU6SXNzdWUyMDk3NzAyMTc=","number":23325,"title":"exists query doesn't work against a property which is nested below two levels ","user":{"login":"vikasdp","id":1795964,"node_id":"MDQ6VXNlcjE3OTU5NjQ=","avatar_url":"https://avatars3.githubusercontent.com/u/1795964?v=4","gravatar_id":"","url":"https://api.github.com/users/vikasdp","html_url":"https://github.com/vikasdp","followers_url":"https://api.github.com/users/vikasdp/followers","following_url":"https://api.github.com/users/vikasdp/following{/other_user}","gists_url":"https://api.github.com/users/vikasdp/gists{/gist_id}","starred_url":"https://api.github.com/users/vikasdp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vikasdp/subscriptions","organizations_url":"https://api.github.com/users/vikasdp/orgs","repos_url":"https://api.github.com/users/vikasdp/repos","events_url":"https://api.github.com/users/vikasdp/events{/privacy}","received_events_url":"https://api.github.com/users/vikasdp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-02-23T14:07:03Z","updated_at":"2017-03-01T16:39:56Z","closed_at":"2017-03-01T15:57:16Z","author_association":"NONE","active_lock_reason":null,"body":"ElasticSearch version 2.3.2\r\n\r\nI have following schema\r\n\r\n```   \r\n{\r\n    \"dsi2\": {\r\n        \"mappings\": {\r\n            \"dsi2\": {\r\n                \"_all\": {\r\n                    \"enabled\": true\r\n                }, \r\n                \"properties\": {\r\n\r\n                    \"instance\": {\r\n                     \"type\" : \"object\",\r\n                        \"properties\": {\r\n                            \"assignee\": {\r\n                               \"type\": \"string\"\r\n                            }, \r\n                            \"createdTs\": {\r\n                                \"type\": \"long\"\r\n                            }, \r\n                            \"dataSourceId\": {\r\n                                \"type\": \"integer\"\r\n                            }, \r\n                            \"dsTypeId\": {\r\n                                \"type\": \"integer\"\r\n                            }, \r\n                            \"entitlements\": {\r\n                                \"properties\": {\r\n                                    \"create\": {\r\n                                        \"type\": \"boolean\"\r\n                                }, \r\n                                \"delete\": {\r\n                                    \"type\": \"boolean\"\r\n                                }, \r\n                                \"edit\": {\r\n                                    \"type\": \"boolean\"\r\n                                }, \r\n                                \"read\": {\r\n                                    \"type\": \"boolean\"\r\n                                }, \r\n                                \"roleId\": {\r\n                                    \"type\": \"integer\"\r\n                                }\r\n                            }, \r\n                            \"type\": \"nested\"\r\n                        }, \r\n                        \"formDefinitionId\": {\r\n                            \"type\": \"long\"\r\n                        }, \r\n                        \"formTypeId\": {\r\n                            \"type\": \"long\"\r\n                        }, \r\n                        \"id\": {\r\n                            \"fields\": {\r\n                                \"raw\": {\r\n                                    \"type\": \"integer\"\r\n                                }\r\n                            }, \r\n                            \"type\": \"integer\"\r\n                        }, \r\n                        \"instFields\": {\r\n                            \"properties\": {\r\n                                \"fieldBoolean\": {\r\n                                    \"type\": \"boolean\"\r\n                                }, \r\n                                \"fieldDate\": {\r\n                                    \"format\": \"strict_date_optional_time||epoch_millis\", \r\n                                    \"type\": \"date\"\r\n                                }, \r\n                                \"fieldDouble\": {\r\n                                    \"fields\": {\r\n                                        \"raw\": {\r\n                                            \"type\": \"double\"\r\n                                        }\r\n                                    }, \r\n                                    \"type\": \"double\"\r\n                                }, \r\n                                \"fieldLong\": {\r\n                                    \"fields\": {\r\n                                        \"raw\": {\r\n                                            \"type\": \"long\"\r\n                                        }\r\n                                    }, \r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"fieldString\": {\r\n                                    \"fields\": {\r\n                                        \"raw\": {\r\n                                            \"index\": \"not_analyzed\", \r\n                                            \"type\": \"string\"\r\n                                        }\r\n                                    }, \r\n                                    \"type\": \"string\"\r\n                                }, \r\n                                \"fieldValue\": {\r\n                                    \"fields\": {\r\n                                        \"raw\": {\r\n                                            \"index\": \"not_analyzed\", \r\n                                            \"type\": \"string\"\r\n                                        }\r\n                                    }, \r\n                                    \"type\": \"string\"\r\n                                }, \r\n                                \"isKey\": {\r\n                                    \"type\": \"boolean\"\r\n                                }, \r\n                                \"referredInstKeyData\": {\r\n                                    \"properties\": {\r\n                                        \"fieldValue\": {\r\n                                            \"fields\": {\r\n                                                \"raw\": {\r\n                                                    \"index\": \"not_analyzed\", \r\n                                                    \"type\": \"string\"\r\n                                                }\r\n                                            }, \r\n                                            \"type\": \"string\"\r\n                                        }, \r\n                                        \"sortOrder\": {\r\n                                            \"type\": \"integer\"\r\n                                        }, \r\n                                        \"sourceFieldId\": {\r\n                                            \"type\": \"integer\"\r\n                                        }\r\n                                    }, \r\n                                    \"type\": \"nested\"\r\n                                }, \r\n                                \"sortOrder\": {\r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"sourceFieldId\": {\r\n                                    \"type\": \"integer\"\r\n                                }\r\n                            }, \r\n                            \"type\": \"nested\"\r\n                        }, \r\n                        \"instanceId\": {\r\n                            \"type\": \"integer\"\r\n                        }, \r\n                        \"modifiedTs\": {\r\n                            \"type\": \"long\"\r\n                        }, \r\n                        \"parentEntityId\": {\r\n                            \"type\": \"integer\"\r\n                        }, \r\n                        \"processId\": {\r\n                            \"type\": \"string\"\r\n                        }, \r\n                        \"processName\": {\r\n                            \"type\": \"string\"\r\n                        }, \r\n                        \"relatedInstances\": {\r\n                            \"properties\": {\r\n                                \"createdTs\": {\r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"dataSourceId\": {\r\n                                    \"type\": \"integer\"\r\n                                }, \r\n                                \"dsTypeId\": {\r\n                                    \"type\": \"integer\"\r\n                                }, \r\n                                \"entitlements\": {\r\n                                    \"properties\": {\r\n                                        \"create\": {\r\n                                            \"type\": \"boolean\"\r\n                                        }, \r\n                                        \"delete\": {\r\n                                            \"type\": \"boolean\"\r\n                                        }, \r\n                                        \"edit\": {\r\n                                            \"type\": \"boolean\"\r\n                                        }, \r\n                                        \"read\": {\r\n                                            \"type\": \"boolean\"\r\n                                        }, \r\n                                        \"roleId\": {\r\n                                            \"type\": \"long\"\r\n                                        }\r\n                                    }\r\n                                }, \r\n                                \"formDefinitionId\": {\r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"formTypeId\": {\r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"id\": {\r\n                                    \"type\": \"integer\"\r\n                                }, \r\n                                \"instFields\": {\r\n                                    \"properties\": {\r\n                                        \"fieldBoolean\": {\r\n                                            \"type\": \"boolean\"\r\n                                        }, \r\n                                        \"fieldDate\": {\r\n                                            \"format\": \"strict_date_optional_time||epoch_millis\", \r\n                                            \"type\": \"date\"\r\n                                        }, \r\n                                        \"fieldDouble\": {\r\n                                            \"fields\": {\r\n                                                \"raw\": {\r\n                                                    \"type\": \"double\"\r\n                                                }\r\n                                            }, \r\n                                            \"type\": \"double\"\r\n                                        }, \r\n                                        \"fieldLong\": {\r\n                                            \"fields\": {\r\n                                                \"raw\": {\r\n                                                    \"type\": \"long\"\r\n                                                }\r\n                                            }, \r\n                                            \"type\": \"long\"\r\n                                        }, \r\n                                        \"fieldString\": {\r\n                                            \"fields\": {\r\n                                                \"raw\": {\r\n                                                    \"index\": \"not_analyzed\", \r\n                                                    \"type\": \"string\"\r\n                                                }\r\n                                            }, \r\n                                            \"type\": \"string\"\r\n                                        }, \r\n                                        \"fieldValue\": {\r\n                                            \"fields\": {\r\n                                                \"raw\": {\r\n                                                    \"index\": \"not_analyzed\", \r\n                                                    \"type\": \"string\"\r\n                                                }\r\n                                            }, \r\n                                            \"type\": \"string\"\r\n                                        }, \r\n                                        \"isKey\": {\r\n                                            \"type\": \"boolean\"\r\n                                        }, \r\n                                        \"referredInstKeyData\": {\r\n                                            \"properties\": {\r\n                                                \"fieldString\": {\r\n                                                    \"fields\": {\r\n                                                        \"raw\": {\r\n                                                            \"index\": \"not_analyzed\", \r\n                                                            \"type\": \"string\"\r\n                                                        }\r\n                                                    }, \r\n                                                    \"type\": \"string\"\r\n                                                }, \r\n                                                \"fieldValue\": {\r\n                                                    \"fields\": {\r\n                                                        \"raw\": {\r\n                                                            \"index\": \"not_analyzed\", \r\n                                                            \"type\": \"string\"\r\n                                                        }\r\n                                                    }, \r\n                                                    \"type\": \"string\"\r\n                                                }, \r\n                                                \"sortOrder\": {\r\n                                                    \"type\": \"integer\"\r\n                                                }, \r\n                                                \"sourceFieldId\": {\r\n                                                    \"type\": \"integer\"\r\n                                                }\r\n                                            }, \r\n                                            \"type\": \"nested\"\r\n                                        }, \r\n                                        \"sortOrder\": {\r\n                                            \"type\": \"long\"\r\n                                        }, \r\n                                        \"sourceFieldId\": {\r\n                                            \"type\": \"integer\"\r\n                                        }\r\n                                    }, \r\n                                    \"type\": \"nested\"\r\n                                }, \r\n                                \"instanceId\": {\r\n                                    \"type\": \"integer\"\r\n                                }, \r\n                                \"modifiedTs\": {\r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"parentEntityId\": {\r\n                                    \"type\": \"integer\"\r\n                                }, \r\n                                \"status\": {\r\n                                    \"type\": \"long\"\r\n                                }, \r\n                                \"tenantId\": {\r\n                                    \"type\": \"long\"\r\n                                }\r\n                            }, \r\n                            \"type\": \"nested\"\r\n                        }, \r\n                        \"status\": {\r\n                            \"type\": \"long\"\r\n                        }, \r\n                        \"taskAssignees\": {\r\n                            \"properties\": {\r\n                                \"role\": {\r\n                                    \"type\": \"integer\"\r\n                                }, \r\n                                \"user\": {\r\n                                    \"type\": \"integer\"\r\n                                }\r\n                            }, \r\n                            \"type\": \"nested\"\r\n                        }, \r\n                        \"taskCompleted\": {\r\n                            \"format\": \"strict_date_optional_time||epoch_millis\", \r\n                            \"type\": \"date\"\r\n                        }, \r\n                        \"taskCompletedBy\": {\r\n                            \"type\": \"string\"\r\n                        }, \r\n                        \"taskCreated\": {\r\n                            \"format\": \"strict_date_optional_time||epoch_millis\", \r\n                            \"type\": \"date\"\r\n                        }, \r\n                        \"taskName\": {\r\n                            \"type\": \"string\"\r\n                        }, \r\n                        \"tenantId\": {\r\n                            \"type\": \"long\"\r\n                        }\r\n                    }\r\n                }, \r\n                \"status\": {\r\n                    \"type\": \"integer\"\r\n                }, \r\n                \"tenantId\": {\r\n                    \"type\": \"integer\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n}\r\n```\r\n\r\nwhen using following query - it doesn't return documents matching \"exists\" criteria. note- `referredInstKeyData` is a second level nested element.\r\n\r\n```\r\n{\r\n\"query\": {\r\n      \"nested\": {\r\n        \"path\": \"instance.instFields\",\r\n        \"query\": {\r\n          \"bool\": {\r\n            \"must\": [\r\n                {    \r\n                   \"term\": {\r\n                        \"instance.instFields.fieldValue\": \"120656\"\r\n                    }\r\n                },\r\n                {\r\n                    \"exists\": {\r\n                        \"field\": \"instance.instFields.referredInstKeyData\"\r\n                    }\r\n                }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n}\r\n```\r\n\r\nIf I search for documents WITHOUT \"exists\" clause it returns correct document as shown below\r\n\r\n```{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 1,\r\n    \"max_score\": 10.130359,\r\n    \"hits\": [\r\n      {\r\n        \"_shard\": 0,\r\n        \"_node\": \"_FohF7-YRyCSh82NmYVslQ\",\r\n        \"_index\": \"dsi2\",\r\n        \"_type\": \"dsi2\",\r\n        \"_id\": \"120655\",\r\n        \"_score\": 10.130359,\r\n        \"_source\": {\r\n          \"instance\": {\r\n            \"entitlements\": [\r\n          {\r\n            \"read\": true,\r\n            \"edit\": false,\r\n            \"roleId\": 169,\r\n            \"create\": false,\r\n            \"delete\": false\r\n          }\r\n\r\n        ],\r\n        \"formTypeId\": 3,\r\n        \"parentEntityId\": 23589,\r\n        \"createdTs\": 1487701846526,\r\n        \"dataSourceId\": 22,\r\n        \"dsTypeId\": 5,\r\n        \"modifiedTs\": 1487783663308,\r\n        \"instanceId\": 17790,\r\n        \"instFields\": [\r\n          {\r\n            \"fieldDouble\": 120658,\r\n            \"sourceFieldId\": 1594,\r\n            \"sortOrder\": 0,\r\n            \"referredInstKeyData\": [\r\n              {\r\n                \"sourceFieldId\": 1233,\r\n                \"sortOrder\": 0,\r\n                \"fieldValue\": \"Depot Transport\"\r\n              },\r\n              {\r\n                \"sourceFieldId\": 1232,\r\n                \"sortOrder\": 1,\r\n                \"fieldValue\": \"LONDON\"\r\n              },\r\n              {\r\n                \"sourceFieldId\": 1336,\r\n                \"sortOrder\": 2,\r\n                \"fieldValue\": \"f8892e61-983b-429c-9d69-97a21cb6e556\"\r\n              },\r\n              {\r\n                \"sourceFieldId\": 1236,\r\n                \"sortOrder\": 4,\r\n                \"fieldValue\": \"513069\"\r\n              },\r\n              {\r\n                \"sourceFieldId\": 1658,\r\n                \"sortOrder\": 5,\r\n                \"fieldValue\": \"7378\"\r\n              }\r\n            ],\r\n            \"isKey\": false,\r\n            \"fieldValue\": \"120658\",\r\n            \"fieldString\": \"120658\"\r\n          },\r\n          {\r\n            \"fieldDouble\": 120656,\r\n            \"sourceFieldId\": 1593,\r\n            \"sortOrder\": 0,\r\n            \"referredInstKeyData\": [\r\n              {\r\n                \"sourceFieldId\": 1233,\r\n                \"sortOrder\": 0,\r\n                \"fieldValue\": \"Joe Cadillac Ii Ltd\"\r\n              },\r\n              \r\n              {\r\n                \"sourceFieldId\": 1236,\r\n                \"sortOrder\": 4,\r\n                \"fieldValue\": \"518508\"\r\n              },\r\n              {\r\n                \"sourceFieldId\": 1658,\r\n                \"sortOrder\": 5,\r\n                \"fieldValue\": \"7376\"\r\n              }\r\n            ],\r\n            \"isKey\": false,\r\n            \"fieldValue\": \"120656\",\r\n            \"fieldString\": \"120656\"\r\n          },\r\n          {\r\n                \"sourceFieldId\": 2580,\r\n                \"sortOrder\": 0,\r\n                \"isKey\": false,\r\n                \"fieldValue\": \"52fe850d-fc17-4dd9-a3a2-257485a9eb27\",\r\n                \"fieldString\": \"52fe850d-fc17-4dd9-a3a2-257485a9eb27\"\r\n              }\r\n            ],\r\n            \"processName\": \"Vehicle Delivery\",\r\n            \"tenantId\": 3,\r\n            \"formDefinitionId\": 729,\r\n            \"id\": 120655,\r\n            \"assignee\": \"none\",\r\n            \"status\": 4\r\n          },\r\n          \"formTypeId\": 3,\r\n          \"tenantId\": 3,\r\n          \"status\": 4\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nappears `exists` clause doesn't work if element is more than one level deep (nested). \r\n\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}