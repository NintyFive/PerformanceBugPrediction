{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26669","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26669/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26669/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26669/events","html_url":"https://github.com/elastic/elasticsearch/issues/26669","id":258098134,"node_id":"MDU6SXNzdWUyNTgwOTgxMzQ=","number":26669,"title":"ES 5.4.3 unexpectedly removes indexes","user":{"login":"Daniel314","id":1891142,"node_id":"MDQ6VXNlcjE4OTExNDI=","avatar_url":"https://avatars0.githubusercontent.com/u/1891142?v=4","gravatar_id":"","url":"https://api.github.com/users/Daniel314","html_url":"https://github.com/Daniel314","followers_url":"https://api.github.com/users/Daniel314/followers","following_url":"https://api.github.com/users/Daniel314/following{/other_user}","gists_url":"https://api.github.com/users/Daniel314/gists{/gist_id}","starred_url":"https://api.github.com/users/Daniel314/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Daniel314/subscriptions","organizations_url":"https://api.github.com/users/Daniel314/orgs","repos_url":"https://api.github.com/users/Daniel314/repos","events_url":"https://api.github.com/users/Daniel314/events{/privacy}","received_events_url":"https://api.github.com/users/Daniel314/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-09-15T16:37:05Z","updated_at":"2017-09-18T14:10:56Z","closed_at":"2017-09-18T14:10:56Z","author_association":"NONE","active_lock_reason":null,"body":"ES: Version: 5.4.3, Build: eed30a8/2017-06-22T00:34:03.743Z, JVM: 1.8.0_144\r\nPlugins: none\r\nJava: 1.8.0_144\r\nOS: Linux es-archival1 3.13.0-129-generic #178-Ubuntu SMP Fri Aug 11 12:48:20 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\nI have experienced an issue with two versions of ElasticSearch (5.4.3 and 2.4.1), where ElasticSearch deletes indicies that it should not delete.  My environment is a multi-mode cluster with Logstash indexes being routed to three different groups: ingestion, warm, and cold (this last one is named 'crypt' in my environment).  The logstash indexes (Logstash-YYYY.MM.DD) are created on the ingestion nodes, routed/moved to the 'warm' node a day later, and then routed/moved to the cold nodes about three days later.\r\n\r\nThe 'warm' node (there is only one in my environment) developed a filesystem/SAN issue where some blocks became unaccessible (ES would time out trying to read those blocks), and this was causing ElasticSearch on this node to get hung up when trying to route/move shards to the cold nodes.  When this happened, after a ~12 hour attempt/timeout/failure, ElasticSearch would remove **ALL** Logstash indexes at or older than the index that it was trying to move to the cold nodes (i.e. all Logstash indexes that were in good shape on the cold nodes [about 30 indexes in my case], in addition to the Logstash index that it couldn't move because of the filesystem errors).\r\n\r\n\r\nFixing the filesystem error resolved the issue where indexes were being unexpectedly deleted.\r\nNone of the Elasticsearch logfiles (on all of the systems that I spot-checked) showed any indication of why all of the extra indexes were removed.  Interestingly enough, other indexes on the cold nodes that didn't have the Logstash-YYYY.MM.DD name format were not affected.\r\n\r\nMy issues are resolved now (the filesystem/device issues are fixed), but the unexpected deletion of other indexes (particularly since none of their shards were stored on this server any more) is why I'm reporting this issue.\r\n\r\nThis is how I create my indicies:\r\n  curl -XPUT 'http://localhost:9200/logstash-2017.09.16' -H 'Content-Type: application/json' -d '{ \"settings\" : { \"index.routing.allocation.include.category\": \"ingestion\", \"index.mapping.total_fields.limit\": 3000, \"number_of_shards\": 6, \"number_of_replicas\": 0, \"index.unassigned.node_left.delayed_timeout\": \"5m\" } }'\r\n\r\nThis is the command that would (eventually) result in the loss of all Logstash indexes prior to Sep 10:\r\n   curl -XPUT 'http://localhost:9200/logstash-2017.09.10/_settings' -H 'Content-Type: application/json' -d '{ \"index.routing.allocation.include.category\": \"crypt\", \"number_of_replicas\": 1 }'\r\n\r\nThanks,\r\n\r\n    - Daniel\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}