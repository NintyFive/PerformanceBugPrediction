{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48893","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48893/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48893/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48893/events","html_url":"https://github.com/elastic/elasticsearch/issues/48893","id":519096125,"node_id":"MDU6SXNzdWU1MTkwOTYxMjU=","number":48893,"title":"[Aggregation] Wrong doc_count on Children Aggregation","user":{"login":"DeeeFOX","id":3414019,"node_id":"MDQ6VXNlcjM0MTQwMTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3414019?v=4","gravatar_id":"","url":"https://api.github.com/users/DeeeFOX","html_url":"https://github.com/DeeeFOX","followers_url":"https://api.github.com/users/DeeeFOX/followers","following_url":"https://api.github.com/users/DeeeFOX/following{/other_user}","gists_url":"https://api.github.com/users/DeeeFOX/gists{/gist_id}","starred_url":"https://api.github.com/users/DeeeFOX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DeeeFOX/subscriptions","organizations_url":"https://api.github.com/users/DeeeFOX/orgs","repos_url":"https://api.github.com/users/DeeeFOX/repos","events_url":"https://api.github.com/users/DeeeFOX/events{/privacy}","received_events_url":"https://api.github.com/users/DeeeFOX/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-11-07T07:42:07Z","updated_at":"2019-11-07T15:40:32Z","closed_at":"2019-11-07T15:40:32Z","author_association":"NONE","active_lock_reason":null,"body":"request:\r\n\r\n    POST /test_tsdb_alias/_search?routing=ms_nginxgas3_count&track_total_hits=true\r\n    {\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"filter\": [\r\n            {\r\n              \"has_parent\": {\r\n                \"parent_type\": \"t\",\r\n                \"query\": {\r\n                  \"bool\": {\r\n                    \"filter\": [\r\n                      {\r\n                        \"term\": {\r\n                          \"metric\": \"ms_nginxgas3_count\"\r\n                        }\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              }\r\n            },\r\n            {\r\n              \"range\": {\r\n                \"ts\": {\r\n                  \"gte\": \"2019-10-30T13:00:00+0800\",\r\n                  \"lte\": \"2019-10-30T13:30:00+0800\"\r\n                }\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"ff\": {\r\n          \"aggs\": {\r\n            \"to_p\": {\r\n              \"parent\": {\r\n                \"type\": \"p\"\r\n              },\r\n              \"aggs\": {\r\n                \"tag\": {\r\n                  \"terms\": {\r\n                    \"field\": \"tag._type\"\r\n                  },\r\n                  \"aggs\": {\r\n                    \"to_c\": {\r\n                      \"children\": {\r\n                        \"type\": \"p\"\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"filters\": {\r\n            \"filters\": {\r\n              \"ts\": {\r\n                \"range\": {\r\n                  \"ts\": {\r\n                    \"gte\": \"2019-10-30T13:00:00+0800\",\r\n                    \"lte\": \"2019-10-30T13:30:00+0800\"\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"size\": 0\r\n    }\r\n\r\nresponse:\r\n\r\n    {\r\n      \"took\" : 1048,\r\n      \"timed_out\" : false,\r\n      \"_shards\" : {\r\n        \"total\" : 1,\r\n        \"successful\" : 1,\r\n        \"skipped\" : 0,\r\n        \"failed\" : 0\r\n      },\r\n      \"hits\" : {\r\n        \"total\" : {\r\n          \"value\" : 64714,\r\n          \"relation\" : \"eq\"\r\n        },\r\n        \"max_score\" : null,\r\n        \"hits\" : [ ]\r\n      },\r\n      \"aggregations\" : {\r\n        \"ff\" : {\r\n          \"buckets\" : {\r\n            \"ts\" : {\r\n              \"doc_count\" : 64714,\r\n              \"to_p\" : {\r\n                \"doc_count\" : 1714,\r\n                \"tag\" : {\r\n                  \"doc_count_error_upper_bound\" : 0,\r\n                  \"sum_other_doc_count\" : 0,\r\n                  \"buckets\" : [\r\n                    {\r\n                      \"key\" : \"formal\",\r\n                      \"doc_count\" : 1624,\r\n                      \"to_c\" : {\r\n                        \"doc_count\" : 6568272\r\n                      }\r\n                    },\r\n                    {\r\n                      \"key\" : \"test\",\r\n                      \"doc_count\" : 90,\r\n                      \"to_c\" : {\r\n                        \"doc_count\" : 52343\r\n                      }\r\n                    }\r\n                  ]\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n\r\n\r\n=> The filter doesn't correspond to the children aggregation,\r\n\r\n```\r\nhits = 64714\r\nvs\r\nagg doc_count = 6568272 + 52343.\r\n```","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}