{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35987","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35987/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35987/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35987/events","html_url":"https://github.com/elastic/elasticsearch/issues/35987","id":385198882,"node_id":"MDU6SXNzdWUzODUxOTg4ODI=","number":35987,"title":"doc_count_error_upper_bound is under-estimated for the Terms Aggregation and therefore is not an upper bound","user":{"login":"diogoholanda","id":11463487,"node_id":"MDQ6VXNlcjExNDYzNDg3","avatar_url":"https://avatars2.githubusercontent.com/u/11463487?v=4","gravatar_id":"","url":"https://api.github.com/users/diogoholanda","html_url":"https://github.com/diogoholanda","followers_url":"https://api.github.com/users/diogoholanda/followers","following_url":"https://api.github.com/users/diogoholanda/following{/other_user}","gists_url":"https://api.github.com/users/diogoholanda/gists{/gist_id}","starred_url":"https://api.github.com/users/diogoholanda/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diogoholanda/subscriptions","organizations_url":"https://api.github.com/users/diogoholanda/orgs","repos_url":"https://api.github.com/users/diogoholanda/repos","events_url":"https://api.github.com/users/diogoholanda/events{/privacy}","received_events_url":"https://api.github.com/users/diogoholanda/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"},{"id":176784422,"node_id":"MDU6TGFiZWwxNzY3ODQ0MjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/won't%20fix","name":"won't fix","color":"f7c6c7","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-11-28T10:26:12Z","updated_at":"2020-06-24T17:35:56Z","closed_at":"2020-06-24T17:35:56Z","author_association":"NONE","active_lock_reason":null,"body":"This bug report is based on the documentation of the current Elasticsearch version (6.5).\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI the documentation for how \"doc_count_error_upper_bound\" is calculated (https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-aggregations-bucket-terms-aggregation.html#_calculating_document_count_error) it is said that \" This is calculated as the sum of the document count from the last term returned from each shard. For the example given above the value would be 46 (2 + 15 + 29).\"\r\n\r\nIf you look at the numeric example given (https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-approximate-counts), you can see that the error could actually be above 46.\r\n\r\nTake Product F, for instance. It was not returned by shard A, so its value is at most 2. It was returned by shard B with a value of 17. It was not returned by shard C, so its value is at most 29. Therefore, its largest possible doc count is 2 + 17 + 29 = 48.\r\n\r\nIt seems that, to calculate the real \"doc_count_error_upper_bound\", we should consider both:\r\n- The maximum possible doc_count for terms not returned by any bucket (this is currently considered)\r\n- The maximum possible doc_count for terms returned by some buckets but that did not make the final list (this is not currently considered)","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}