[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296322567","html_url":"https://github.com/elastic/elasticsearch/issues/24259#issuecomment-296322567","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24259","id":296322567,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjMyMjU2Nw==","user":{"login":"winstonewert","id":858493,"node_id":"MDQ6VXNlcjg1ODQ5Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/858493?v=4","gravatar_id":"","url":"https://api.github.com/users/winstonewert","html_url":"https://github.com/winstonewert","followers_url":"https://api.github.com/users/winstonewert/followers","following_url":"https://api.github.com/users/winstonewert/following{/other_user}","gists_url":"https://api.github.com/users/winstonewert/gists{/gist_id}","starred_url":"https://api.github.com/users/winstonewert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/winstonewert/subscriptions","organizations_url":"https://api.github.com/users/winstonewert/orgs","repos_url":"https://api.github.com/users/winstonewert/repos","events_url":"https://api.github.com/users/winstonewert/events{/privacy}","received_events_url":"https://api.github.com/users/winstonewert/received_events","type":"User","site_admin":false},"created_at":"2017-04-21T22:48:24Z","updated_at":"2017-04-21T22:48:24Z","author_association":"CONTRIBUTOR","body":"I went ahead an attached a debug to my elasticsearch instance, and I believe I've found the problem:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregator.java#L66\r\n\r\nThe mapScript parameter should be leafMapScript. The LeafBucketCollectorBase ignore the values parameter unless it implements ScorerAware. LeafMapScript implements it, but mapScript does not. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296708332","html_url":"https://github.com/elastic/elasticsearch/issues/24259#issuecomment-296708332","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24259","id":296708332,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjcwODMzMg==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-04-24T15:33:24Z","updated_at":"2017-04-24T15:33:24Z","author_association":"MEMBER","body":"Could you explain your use-case a bit? Combining scores in an aggregation is not generally that useful as the value of a document's score is not meaningful outside of being compared to another document's scores. \r\n\r\nAlso, in your case it seems like you could use the sum aggregation with a script returning the score to achieve the same result as you are trying to do with the scripted_metric aggregation here. Something like:\r\n```\r\n\"total_score\": {\r\n  \"sum\": {\r\n    \"script\": \"_score\"\r\n  }\r\n}\r\n```\r\n\r\nI'm hesitant to enable the score to be accessed in this aggregation since its not clear to me why it would be useful to aggregate on the score in any aggregation least of all this one?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296715814","html_url":"https://github.com/elastic/elasticsearch/issues/24259#issuecomment-296715814","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24259","id":296715814,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NjcxNTgxNA==","user":{"login":"winstonewert","id":858493,"node_id":"MDQ6VXNlcjg1ODQ5Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/858493?v=4","gravatar_id":"","url":"https://api.github.com/users/winstonewert","html_url":"https://github.com/winstonewert","followers_url":"https://api.github.com/users/winstonewert/followers","following_url":"https://api.github.com/users/winstonewert/following{/other_user}","gists_url":"https://api.github.com/users/winstonewert/gists{/gist_id}","starred_url":"https://api.github.com/users/winstonewert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/winstonewert/subscriptions","organizations_url":"https://api.github.com/users/winstonewert/orgs","repos_url":"https://api.github.com/users/winstonewert/repos","events_url":"https://api.github.com/users/winstonewert/events{/privacy}","received_events_url":"https://api.github.com/users/winstonewert/received_events","type":"User","site_admin":false},"created_at":"2017-04-24T15:52:10Z","updated_at":"2017-04-24T15:52:10Z","author_association":"CONTRIBUTOR","body":"Obviously, the aggregation presented in the example is really silly. Its a bug report, I'm showing the simplest case that fails.\r\n\r\nMy actual case involves aggregating the score into different buckets (possibly multiple per document) based on the other fields in the document.\r\n\r\nYou can already aggregate over the scores using the non-scripted metrics, so it makes little sense to me to object to doing so in a scripted metric. \r\n\r\nAs you can see from my diagnosis above and my pull request fixing the bug, it looks like the code is trying to make scores in script metric works, but fails to do so because of a typo.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/296748192","html_url":"https://github.com/elastic/elasticsearch/issues/24259#issuecomment-296748192","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24259","id":296748192,"node_id":"MDEyOklzc3VlQ29tbWVudDI5Njc0ODE5Mg==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-04-24T17:07:35Z","updated_at":"2017-04-24T17:07:47Z","author_association":"MEMBER","body":"> Obviously, the aggregation presented in the example is really silly. Its a bug report, I'm showing the simplest case that fails.\r\n\r\nOk, fair enough. I was asking because I am interested to know of a use case that aggregates scores and in that use case what those aggregated scores represent which is useful/meaningful.\r\n\r\n> You can already aggregate over the scores using the non-scripted metrics, so it makes little sense to me to object to doing so in a scripted metric.\r\n\r\nThis is true. I guess my point here was whether it actually makes sense for aggregations on scores to be supported in any aggregation, but thats probably better left for a separate issue. \r\n\r\n> As you can see from my diagnosis above and my pull request fixing the bug, it looks like the code is trying to make scores in script metric works, but fails to do so because of a typo.\r\n\r\nI hadn't seen your [PR](https://github.com/elastic/elasticsearch/pull/24295), thanks for raising one. Looking at the history of the file it looks like https://github.com/elastic/elasticsearch/commit/967a4e2a861b703706540b5c61b54d659b5a3e58 may have stopped the scores from being accessible from the scripted_metric aggregator but wasn't picked up because as we did not see the score being useful for this aggregation so it was never considered/tested. I'll review your PR and hopefully we can get it in.\r\n","performed_via_github_app":null}]