[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259496228","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-259496228","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":259496228,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ5NjIyOA==","user":{"login":"dwo","id":131652,"node_id":"MDQ6VXNlcjEzMTY1Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/131652?v=4","gravatar_id":"","url":"https://api.github.com/users/dwo","html_url":"https://github.com/dwo","followers_url":"https://api.github.com/users/dwo/followers","following_url":"https://api.github.com/users/dwo/following{/other_user}","gists_url":"https://api.github.com/users/dwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwo/subscriptions","organizations_url":"https://api.github.com/users/dwo/orgs","repos_url":"https://api.github.com/users/dwo/repos","events_url":"https://api.github.com/users/dwo/events{/privacy}","received_events_url":"https://api.github.com/users/dwo/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T19:02:14Z","updated_at":"2016-11-09T19:02:14Z","author_association":"NONE","body":"FWIW: I searched a bunch through previous issues and the forums, but couldn't see anything like this.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259666121","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-259666121","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":259666121,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTY2NjEyMQ==","user":{"login":"dwo","id":131652,"node_id":"MDQ6VXNlcjEzMTY1Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/131652?v=4","gravatar_id":"","url":"https://api.github.com/users/dwo","html_url":"https://github.com/dwo","followers_url":"https://api.github.com/users/dwo/followers","following_url":"https://api.github.com/users/dwo/following{/other_user}","gists_url":"https://api.github.com/users/dwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwo/subscriptions","organizations_url":"https://api.github.com/users/dwo/orgs","repos_url":"https://api.github.com/users/dwo/repos","events_url":"https://api.github.com/users/dwo/events{/privacy}","received_events_url":"https://api.github.com/users/dwo/received_events","type":"User","site_admin":false},"created_at":"2016-11-10T11:22:35Z","updated_at":"2016-11-10T11:22:35Z","author_association":"NONE","body":"I looked through subsequent (to 2.2.0) release notes this morning and wondered if these resolved issues might be related: \n- #15678 \"Speed improvements for BalancedShardsAllocator\" (in 2.3.0)\n- #16926 \"Speed up shard balancer by reusing shard model while moving shards that can no longer be allocated to a node\" (in 2.3.0)\n- #17106 \"IndicesStore checks for `allocated elsewhere` for every shard not alocated on the local node\" (in 2.2.2)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259667327","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-259667327","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":259667327,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTY2NzMyNw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-11-10T11:29:00Z","updated_at":"2016-11-10T11:29:00Z","author_association":"CONTRIBUTOR","body":"@ywelsch any ideas?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259713683","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-259713683","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":259713683,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTcxMzY4Mw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-11-10T15:07:15Z","updated_at":"2016-11-10T15:07:15Z","author_association":"CONTRIBUTOR","body":"> Anything else I could share: let me know.\n- Could you make the heap dump available? Could you also provide a heap dump under normal operations to use as a baseline? The top classes show 10 million ShardRouting instances and I would like to know what's keeping those references (I suspect InternalClusterInfoService).\n- Interesting would also be to know the pending tasks on the master as well as to have a graph for the number of pending tasks on the master over time (similar to the \"JVM heap used\" graph).\n- The `hot_threads` output might also be useful to figure out what's happening here.\n\nThe PRs you linked above help to speed up calculation of cluster state updates, which in turn helps the master in processing its queue of pending tasks. This will definitely help the master in processing a large queue of pending tasks but I'm not sure whether that's the root cause here.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260124777","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-260124777","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":260124777,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDEyNDc3Nw==","user":{"login":"dwo","id":131652,"node_id":"MDQ6VXNlcjEzMTY1Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/131652?v=4","gravatar_id":"","url":"https://api.github.com/users/dwo","html_url":"https://github.com/dwo","followers_url":"https://api.github.com/users/dwo/followers","following_url":"https://api.github.com/users/dwo/following{/other_user}","gists_url":"https://api.github.com/users/dwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwo/subscriptions","organizations_url":"https://api.github.com/users/dwo/orgs","repos_url":"https://api.github.com/users/dwo/repos","events_url":"https://api.github.com/users/dwo/events{/privacy}","received_events_url":"https://api.github.com/users/dwo/received_events","type":"User","site_admin":false},"created_at":"2016-11-12T14:23:20Z","updated_at":"2016-11-12T14:23:20Z","author_association":"NONE","body":"Hey, just getting around to digging into these for you. I'm not sure whether I can make the heap dump available, but I can do my best to answer your questions.\n\n> Could you also provide a heap dump under normal operations to use as a baseline?\n\nHere is a sampled heap of a healthy master (sorted by instances):\n\n<img width=\"919\" alt=\"screen shot 2016-11-12 at 2 12 03 pm\" src=\"https://cloud.githubusercontent.com/assets/131652/20238387/3aade1f4-a8e2-11e6-9158-e8546d010afd.png\">\n\nSame again, filtered to `org.elasticsearch.*`:\n\n<img width=\"919\" alt=\"screen shot 2016-11-12 at 2 12 35 pm\" src=\"https://cloud.githubusercontent.com/assets/131652/20238392/5b9bfebe-a8e2-11e6-855f-0082278d3b03.png\">\n\n> The top classes show 10 million ShardRouting instances and I would like to know what's keeping those references (I suspect InternalClusterInfoService).\n\nLet me post about this when my computer has stopped sounding like a jet engine. VisualVM is crunching through those instances in the dump as I type up the rest of this...\n\n> Interesting would also be to know the pending tasks on the master as well as to have a graph for the number of pending tasks on the master over time (similar to the \"JVM heap used\" graph).\n\nHere you go. Orange = master that OOM'd, Yellow = master that took over (same one I just got the sampled heap dumps above from):\n\n<img width=\"617\" alt=\"screen shot 2016-11-12 at 2 02 28 pm\" src=\"https://cloud.githubusercontent.com/assets/131652/20238399/99448650-a8e2-11e6-8d8e-67dd2b4b652c.png\">\n\n> The `hot_threads` output might also be useful to figure out what's happening here.\n\nI hit a dead end here, I don't think we have been harvesting these stats. Maybe I'm wrong, I'll ask around on Monday.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260127300","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-260127300","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":260127300,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDEyNzMwMA==","user":{"login":"dwo","id":131652,"node_id":"MDQ6VXNlcjEzMTY1Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/131652?v=4","gravatar_id":"","url":"https://api.github.com/users/dwo","html_url":"https://github.com/dwo","followers_url":"https://api.github.com/users/dwo/followers","following_url":"https://api.github.com/users/dwo/following{/other_user}","gists_url":"https://api.github.com/users/dwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwo/subscriptions","organizations_url":"https://api.github.com/users/dwo/orgs","repos_url":"https://api.github.com/users/dwo/repos","events_url":"https://api.github.com/users/dwo/events{/privacy}","received_events_url":"https://api.github.com/users/dwo/received_events","type":"User","site_admin":false},"created_at":"2016-11-12T15:09:43Z","updated_at":"2016-11-12T15:09:43Z","author_association":"NONE","body":"Any tips on how to go about exploring the references to `ShardRouting` instances? Clicking around in VisualVM, I can't see any reference to `InternalClusterInfoService` like you suspected.\n\n<img width=\"991\" alt=\"screen shot 2016-11-12 at 2 59 59 pm\" src=\"https://cloud.githubusercontent.com/assets/131652/20238709/8ebf73c8-a8e9-11e6-83c7-5d79fa9c303c.png\">\n\nOn `hot_threads`: is there any way to inspect that retroactively if you aren't for eg. logging the output of the response from `<elastic_host:port>/_nodes/<master_id>/hot_threads` periodically? I can see some `HotThreads` instances in the heap dump, but they don't seem to hold much information (or I just don't know where to look).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260146171","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-260146171","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":260146171,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDE0NjE3MQ==","user":{"login":"dwo","id":131652,"node_id":"MDQ6VXNlcjEzMTY1Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/131652?v=4","gravatar_id":"","url":"https://api.github.com/users/dwo","html_url":"https://github.com/dwo","followers_url":"https://api.github.com/users/dwo/followers","following_url":"https://api.github.com/users/dwo/following{/other_user}","gists_url":"https://api.github.com/users/dwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwo/subscriptions","organizations_url":"https://api.github.com/users/dwo/orgs","repos_url":"https://api.github.com/users/dwo/repos","events_url":"https://api.github.com/users/dwo/events{/privacy}","received_events_url":"https://api.github.com/users/dwo/received_events","type":"User","site_admin":false},"created_at":"2016-11-12T20:26:09Z","updated_at":"2016-11-13T21:07:16Z","author_association":"NONE","body":"I got a better picture of where the `ShardRouting` instances are coming from with [MAT](https://www.eclipse.org/mat/).\n\n<img width=\"1392\" alt=\"screen shot 2016-11-12 at 8 13 11 pm\" src=\"https://cloud.githubusercontent.com/assets/131652/20240615/cf547c32-a914-11e6-9d43-04590af1d730.png\">\n\nThere are a lot more of those `java.util.HashMap$Node`s making up the 4.8GB total for `InternalClusterService`, but there's also `org.elasticsearch.cluster.ClusterState` in there too.\n\n<img width=\"1392\" alt=\"screen shot 2016-11-12 at 8 25 04 pm\" src=\"https://cloud.githubusercontent.com/assets/131652/20240667/1ff1e70a-a916-11e6-91e2-8c6f745133a3.png\">\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260198627","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-260198627","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":260198627,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDE5ODYyNw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-11-13T17:09:45Z","updated_at":"2016-11-13T17:09:45Z","author_association":"CONTRIBUTOR","body":"Thanks for providing the heap analysis pictures. With the last batch I have figured out what's going on: Some response listeners that are used for cluster state update tasks (e.g. index creation) keep a reference to state that is completely unnecessary to later run the listeners (one of these thing they hold on to is the last cluster state that was applied when the update task was submitted). If the master has a large pending queue of such tasks, it possibly keeps references to many old cluster states. I'll look at options to fix this.\n\nExample showing the issue:\n\n<img width=\"1233\" alt=\"screen shot 2016-11-13 at 12 00 23\" src=\"https://cloud.githubusercontent.com/assets/3718355/20245114/a282e498-a999-11e6-996c-35e1084ffb24.png\">\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260213540","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-260213540","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":260213540,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDIxMzU0MA==","user":{"login":"dwo","id":131652,"node_id":"MDQ6VXNlcjEzMTY1Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/131652?v=4","gravatar_id":"","url":"https://api.github.com/users/dwo","html_url":"https://github.com/dwo","followers_url":"https://api.github.com/users/dwo/followers","following_url":"https://api.github.com/users/dwo/following{/other_user}","gists_url":"https://api.github.com/users/dwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dwo/subscriptions","organizations_url":"https://api.github.com/users/dwo/orgs","repos_url":"https://api.github.com/users/dwo/repos","events_url":"https://api.github.com/users/dwo/events{/privacy}","received_events_url":"https://api.github.com/users/dwo/received_events","type":"User","site_admin":false},"created_at":"2016-11-13T21:17:20Z","updated_at":"2016-11-13T21:17:20Z","author_association":"NONE","body":"Nice one, let me know if you need anything else from the heap dump.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261721264","html_url":"https://github.com/elastic/elasticsearch/issues/21439#issuecomment-261721264","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21439","id":261721264,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTcyMTI2NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-11-19T15:45:49Z","updated_at":"2016-11-19T15:45:49Z","author_association":"CONTRIBUTOR","body":"Closing in favour of https://github.com/elastic/elasticsearch/issues/21568\n","performed_via_github_app":null}]