{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48398","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48398/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48398/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48398/events","html_url":"https://github.com/elastic/elasticsearch/issues/48398","id":511332838,"node_id":"MDU6SXNzdWU1MTEzMzI4Mzg=","number":48398,"title":"Half-deleted snapshot causes the backup repository to be unusable","user":{"login":"centic9","id":548322,"node_id":"MDQ6VXNlcjU0ODMyMg==","avatar_url":"https://avatars0.githubusercontent.com/u/548322?v=4","gravatar_id":"","url":"https://api.github.com/users/centic9","html_url":"https://github.com/centic9","followers_url":"https://api.github.com/users/centic9/followers","following_url":"https://api.github.com/users/centic9/following{/other_user}","gists_url":"https://api.github.com/users/centic9/gists{/gist_id}","starred_url":"https://api.github.com/users/centic9/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/centic9/subscriptions","organizations_url":"https://api.github.com/users/centic9/orgs","repos_url":"https://api.github.com/users/centic9/repos","events_url":"https://api.github.com/users/centic9/events{/privacy}","received_events_url":"https://api.github.com/users/centic9/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-10-23T13:42:41Z","updated_at":"2019-10-24T07:15:31Z","closed_at":"2019-10-24T07:15:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.8.1\r\n\r\n**Plugins installed**: Happened with s3 repository installed, but could be reproduced locally with only the file-system repository.\r\n\r\n**JVM version** (`java -version`): OpenJDK 8_222\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux and Windows\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nA backup repository suddenly reports an error when iterating snapshots:\r\n\r\nSnapshotException[[backup123:snapshot_2018-11-12-18-01-utc/oKPG3J7YS5GTT3K1LtleFg] Snapshot could not be read]; nested: SnapshotMissingException[[backup123:snapshot_2018-11-12-18-01-utc/oKPG3J7YS5GTT3K1LtleFg] is missing]; nested: NoSuchFileException[Blob object [snap-oKPG3J7YS5GTT3K1LtleFg.dat] not found: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: X; S3 Extended Request ID: X)];\r\n\r\nWe did not succeed in getting the repository back to be usable with any of the APIs which Elasticsearch offers.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Set up a local filesystem snapshot repository\r\n2. Create a few snapshots of a few indices\r\n3. Remove at least on \"snap-\" file in the backup repository folder\r\n4. Looking at snapshots via REST will now return a \"NoSuchFileException\"\r\n5. Try to delete the failing snapshot via REST DELETE _snapshot/<repo>/<snap-name> => it will fail\r\n6. Try to iterate existing snapshots via REST GET _snapshot/<repo>/_all => it will fail\r\n\r\nSo we cannot remove the broken snapshot any more and we also cannot iterate existing snapshots any more, so the backup repository is broken unless I manually edit some of the index-files of the repository.\r\n\r\nIdeally I would need a \"force\" parameter for the SNAPSHOT DELETE operation to get rid of this one broken snapshot entry, this would make the other snapshots available again.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n[2019-10-23T13:24:48,923][WARN ][r.suppressed             ] [ES] path: /_snapshot/my_fs_backup/snapshot_dev-cluster-any_1571829538238, params: {repository=my_fs_backup, snapshot=snapshot_dev-cluster-any_1571829538238}\r\norg.elasticsearch.snapshots.SnapshotException: [my_fs_backup:snapshot_dev-cluster-any_1571829538238/paKPNiXJTm-YdkFpQhB_mQ] Snapshot could not be read\r\n        at org.elasticsearch.snapshots.SnapshotsService.snapshots(SnapshotsService.java:212) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.action.admin.cluster.snapshots.get.TransportGetSnapshotsAction.masterOperation(TransportGetSnapshotsAction.java:136) [elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.action.admin.cluster.snapshots.get.TransportGetSnapshotsAction.masterOperation(TransportGetSnapshotsAction.java:55) [elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:124) [elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:211) [elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.1.jar:6.8.1]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n        at java.lang.Thread.run(Thread.java:834) [?:?]\r\nCaused by: org.elasticsearch.snapshots.SnapshotMissingException: [my_fs_backup:snapshot_dev-cluster-any_1571829538238/paKPNiXJTm-YdkFpQhB_mQ] is missing\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.getSnapshotInfo(BlobStoreRepository.java:558) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.snapshots.SnapshotsService.snapshots(SnapshotsService.java:206) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        ... 9 more\r\nCaused by: java.nio.file.NoSuchFileException: c:\\temp\\backup1\\snap-paKPNiXJTm-YdkFpQhB_mQ.dat\r\n        at sun.nio.fs.WindowsException.translateToIOException(WindowsException.java:85) ~[?:?]\r\n        at sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:103) ~[?:?]\r\n        at sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:108) ~[?:?]\r\n        at sun.nio.fs.WindowsFileSystemProvider.newByteChannel(WindowsFileSystemProvider.java:231) ~[?:?]\r\n        at java.nio.file.Files.newByteChannel(Files.java:370) ~[?:?]\r\n        at java.nio.file.Files.newByteChannel(Files.java:421) ~[?:?]\r\n        at java.nio.file.spi.FileSystemProvider.newInputStream(FileSystemProvider.java:420) ~[?:?]\r\n        at java.nio.file.Files.newInputStream(Files.java:155) ~[?:?]\r\n        at org.elasticsearch.common.blobstore.fs.FsBlobContainer.readBlob(FsBlobContainer.java:120) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.readBlob(ChecksumBlobStoreFormat.java:101) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreFormat.read(BlobStoreFormat.java:90) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.getSnapshotInfo(BlobStoreRepository.java:556) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        at org.elasticsearch.snapshots.SnapshotsService.snapshots(SnapshotsService.java:206) ~[elasticsearch-6.8.1.jar:6.8.1]\r\n        ... 9 more\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}