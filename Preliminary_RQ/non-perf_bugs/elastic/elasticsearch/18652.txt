{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18652","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18652/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18652/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18652/events","html_url":"https://github.com/elastic/elasticsearch/issues/18652","id":157643305,"node_id":"MDU6SXNzdWUxNTc2NDMzMDU=","number":18652,"title":"AWS IAM role not working with Elasticsearch 5.0.0-alpha2, but works with 2.3 version","user":{"login":"randhirkr","id":6437358,"node_id":"MDQ6VXNlcjY0MzczNTg=","avatar_url":"https://avatars1.githubusercontent.com/u/6437358?v=4","gravatar_id":"","url":"https://api.github.com/users/randhirkr","html_url":"https://github.com/randhirkr","followers_url":"https://api.github.com/users/randhirkr/followers","following_url":"https://api.github.com/users/randhirkr/following{/other_user}","gists_url":"https://api.github.com/users/randhirkr/gists{/gist_id}","starred_url":"https://api.github.com/users/randhirkr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/randhirkr/subscriptions","organizations_url":"https://api.github.com/users/randhirkr/orgs","repos_url":"https://api.github.com/users/randhirkr/repos","events_url":"https://api.github.com/users/randhirkr/events{/privacy}","received_events_url":"https://api.github.com/users/randhirkr/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-05-31T10:52:06Z","updated_at":"2018-02-13T19:49:56Z","closed_at":"2016-07-22T22:47:57Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**:  5.0.0-alpha2\n\n**JVM version**: 1.8.0_91(1.8.0_91-b14)\n\n**OS version**: Red Hat Enterprise Linux 7.2 (3.10.0-327.18.2.el7.x86_64)\n\n**Description of the problem including expected versus actual behavior**:\nI am trying to use AWS IAM role with Elasticsearch 5.0.0-alpha2 and EC2 discovery plug-in, but it does not seem to be working and I am getting below error:\n\n> \"Exception while retrieving instance list from AWS API: Authorization header or parameters are not formatted correctly. (Service: AmazonEC2; Status Code: 401; Error Code: AuthFailure\"\n\nI am using below configuration with jdk8:\n\n> cluster.name: \"test-cluster\"\n> cloud.aws.region: \"us-west-2\"\n> cloud.aws.ec2.region: \"us-west-2\"\n> cloud.aws.ec2.protocol: \"http\"\n> discovery.type: \"ec2\"\n> # bootstrap.mlockall: true\n> \n> node.master: true\n> node.data: false\n> node.name: ${HOSTNAME}-Master\n> discovery.zen.minimum_master_nodes: 1\n> network.host: ec2:privateIp\n> discovery.ec2.any_group: true\n> discovery.ec2.groups : sg-9d856tfe\n\nAnd, below is IAM role permission that I have configured with elasticsearch instance:\n\n```\n{\n    \"Version\": \"2012-10-17\",\n    \"Statement\": [\n        {\n            \"Action\": [\n                \"ec2:Describe*\"\n            ],\n            \"Effect\": \"Allow\",\n            \"Resource\": [\n                \"*\"\n            ]\n        }\n    ]\n}\n```\n\nHowever, same configuration works fine with with Elasticsearch 2.3 version. Has anyone faced the same issue with the latest Elasticsearch version 5.0.0-alpha2?\n\nAlso, today I enabled the debug mode of AWS call and I could notice(see below) that its loading credentials from **StaticCredentialsProvider** - its wrong behavior. As access and secret key is absent in the config(elasticsearch.yml) file, so ideally it should load credential from **InstanceProfileCredentialsProvider**.\n\n> [DEBUG][com.amazonaws.auth.AWSCredentialsProviderChain] Loading credentials from com.amazonaws.internal.StaticCredentialsProvider@40bf7b26\n\n**Steps to reproduce**:\n1. Start elasticsearch master data node with the above mentioned configuration.\n\n**Provide logs (if relevant)**:\n\n```\ncom.amazonaws.AmazonServiceException: Authorization header or parameters are not formatted correctly. (Service: AmazonEC2; Status Code: 401; Error Code: AuthFailure; Request ID: )\n        at com.amazonaws.http.AmazonHttpClient.handleErrorResponse(AmazonHttpClient.java:1239)\n        at com.amazonaws.http.AmazonHttpClient.executeOneRequest(AmazonHttpClient.java:823)\n        at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:506)\n        at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:318)\n        at com.amazonaws.services.ec2.AmazonEC2Client.invoke(AmazonEC2Client.java:11901)\n        at com.amazonaws.services.ec2.AmazonEC2Client.describeInstances(AmazonEC2Client.java:5940)\n        at org.elasticsearch.discovery.ec2.AwsEc2UnicastHostsProvider.fetchDynamicNodes(AwsEc2UnicastHostsProvider.java:117)\n        at org.elasticsearch.discovery.ec2.AwsEc2UnicastHostsProvider$DiscoNodesCache.refresh(AwsEc2UnicastHostsProvider.java:232)\n        at org.elasticsearch.discovery.ec2.AwsEc2UnicastHostsProvider$DiscoNodesCache.refresh(AwsEc2UnicastHostsProvider.java:217)\n        at org.elasticsearch.common.util.SingleObjectCache.getOrRefresh(SingleObjectCache.java:54)\n        at org.elasticsearch.discovery.ec2.AwsEc2UnicastHostsProvider.buildDynamicNodes(AwsEc2UnicastHostsProvider.java:103)\n        at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.sendPings(UnicastZenPing.java:344)\n        at org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.ping(UnicastZenPing.java:249)\n        at org.elasticsearch.discovery.zen.ping.ZenPingService.ping(ZenPingService.java:106)\n        at org.elasticsearch.discovery.zen.ping.ZenPingService.pingAndWait(ZenPingService.java:84)\n        at org.elasticsearch.discovery.zen.ZenDiscovery.findMaster(ZenDiscovery.java:845)\n        at org.elasticsearch.discovery.zen.ZenDiscovery.innerJoinCluster(ZenDiscovery.java:376)\n        at org.elasticsearch.discovery.zen.ZenDiscovery.access$4500(ZenDiscovery.java:89)\n        at org.elasticsearch.discovery.zen.ZenDiscovery$JoinThreadControl$1.run(ZenDiscovery.java:1166)\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:392)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n```\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}