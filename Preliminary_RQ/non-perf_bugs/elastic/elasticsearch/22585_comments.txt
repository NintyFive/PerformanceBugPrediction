[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272165741","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272165741","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272165741,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE2NTc0MQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T13:42:04Z","updated_at":"2017-01-12T13:42:04Z","author_association":"CONTRIBUTOR","body":"I think for this you should use `FilterClient` and override `doExecute` like this:\r\n\r\n```Java\r\nvoid doExecute(action, request, listener) {\r\n        final ThreadContext threadContext = threadPool().getThreadContext();\r\n        final ThreadContext.StoredContext storedContext = threadContext.newStoredContext();\r\n        try (ThreadContext.StoredContext ctx = threadContext.stashContext()) {\r\n            threadContext.putHeader(\"foo\", \"bar\"); // add your header...\r\n            super.doExecute(action, request, listener);\r\n        }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272182340","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272182340","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272182340,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE4MjM0MA==","user":{"login":"pkalinkina","id":20440606,"node_id":"MDQ6VXNlcjIwNDQwNjA2","avatar_url":"https://avatars3.githubusercontent.com/u/20440606?v=4","gravatar_id":"","url":"https://api.github.com/users/pkalinkina","html_url":"https://github.com/pkalinkina","followers_url":"https://api.github.com/users/pkalinkina/followers","following_url":"https://api.github.com/users/pkalinkina/following{/other_user}","gists_url":"https://api.github.com/users/pkalinkina/gists{/gist_id}","starred_url":"https://api.github.com/users/pkalinkina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkalinkina/subscriptions","organizations_url":"https://api.github.com/users/pkalinkina/orgs","repos_url":"https://api.github.com/users/pkalinkina/repos","events_url":"https://api.github.com/users/pkalinkina/events{/privacy}","received_events_url":"https://api.github.com/users/pkalinkina/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T14:50:31Z","updated_at":"2017-01-12T14:50:31Z","author_association":"NONE","body":"But if I want to define all functionality in plugin an use client like this:\r\n`TransportClient client = new PreBuiltTransportClient(settings, AuthenticationPlugin.class)`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272187677","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272187677","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272187677,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE4NzY3Nw==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:09:54Z","updated_at":"2017-01-12T15:09:54Z","author_association":"CONTRIBUTOR","body":"> But if I want to define all functionality in plugin an use client like this:\r\nTransportClient client = new PreBuiltTransportClient(settings, AuthenticationPlugin.class)\r\n\r\nyou can also get the ThreadPool in the plugin from `createComponents` and then use is with a transport interceptor.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272188262","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272188262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272188262,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE4ODI2Mg==","user":{"login":"pkalinkina","id":20440606,"node_id":"MDQ6VXNlcjIwNDQwNjA2","avatar_url":"https://avatars3.githubusercontent.com/u/20440606?v=4","gravatar_id":"","url":"https://api.github.com/users/pkalinkina","html_url":"https://github.com/pkalinkina","followers_url":"https://api.github.com/users/pkalinkina/followers","following_url":"https://api.github.com/users/pkalinkina/following{/other_user}","gists_url":"https://api.github.com/users/pkalinkina/gists{/gist_id}","starred_url":"https://api.github.com/users/pkalinkina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkalinkina/subscriptions","organizations_url":"https://api.github.com/users/pkalinkina/orgs","repos_url":"https://api.github.com/users/pkalinkina/repos","events_url":"https://api.github.com/users/pkalinkina/events{/privacy}","received_events_url":"https://api.github.com/users/pkalinkina/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:12:09Z","updated_at":"2017-01-12T15:12:09Z","author_association":"NONE","body":"But `createComponents ` is not used inside of `TransportClient `","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272189657","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272189657","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272189657,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE4OTY1Nw==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:17:18Z","updated_at":"2017-01-12T15:17:18Z","author_association":"CONTRIBUTOR","body":"oh true, then you have to go through FilterClient. that is the intended way to solve this. that's what it was added for","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272190032","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272190032","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272190032,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5MDAzMg==","user":{"login":"Gordiychuk","id":10699594,"node_id":"MDQ6VXNlcjEwNjk5NTk0","avatar_url":"https://avatars3.githubusercontent.com/u/10699594?v=4","gravatar_id":"","url":"https://api.github.com/users/Gordiychuk","html_url":"https://github.com/Gordiychuk","followers_url":"https://api.github.com/users/Gordiychuk/followers","following_url":"https://api.github.com/users/Gordiychuk/following{/other_user}","gists_url":"https://api.github.com/users/Gordiychuk/gists{/gist_id}","starred_url":"https://api.github.com/users/Gordiychuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Gordiychuk/subscriptions","organizations_url":"https://api.github.com/users/Gordiychuk/orgs","repos_url":"https://api.github.com/users/Gordiychuk/repos","events_url":"https://api.github.com/users/Gordiychuk/events{/privacy}","received_events_url":"https://api.github.com/users/Gordiychuk/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:18:44Z","updated_at":"2017-01-12T15:18:44Z","author_association":"NONE","body":"@s1monw offered solution looks like work around, the main problem that  `TransportInterceptor` not support DI, it's lead to many problem when whole dependency located inside DI but one of class required it an can't access without static hacks. I have example of this hack:\r\nhttps://github.com/floragunncom/search-guard/blob/5.1.1/src/main/java/com/floragunn/searchguard/SearchGuardPlugin.java#L252\r\nhttps://github.com/floragunncom/search-guard/blob/5.1.1/src/main/java/com/floragunn/searchguard/transport/SearchGuardInterceptor.java#L74\r\n\r\nMaybe we can provide ability loockup interceprots from DI?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272191011","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272191011","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272191011,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5MTAxMQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:22:24Z","updated_at":"2017-01-12T15:22:24Z","author_association":"CONTRIBUTOR","body":"Google Guice is about to removed and TransportClient will be removed in upcomeing versions. We won't add stuff like TransportInterceptors to guice. There is a clear way forward by using FilterClient for this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272192360","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272192360","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272192360,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5MjM2MA==","user":{"login":"Gordiychuk","id":10699594,"node_id":"MDQ6VXNlcjEwNjk5NTk0","avatar_url":"https://avatars3.githubusercontent.com/u/10699594?v=4","gravatar_id":"","url":"https://api.github.com/users/Gordiychuk","html_url":"https://github.com/Gordiychuk","followers_url":"https://api.github.com/users/Gordiychuk/followers","following_url":"https://api.github.com/users/Gordiychuk/following{/other_user}","gists_url":"https://api.github.com/users/Gordiychuk/gists{/gist_id}","starred_url":"https://api.github.com/users/Gordiychuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Gordiychuk/subscriptions","organizations_url":"https://api.github.com/users/Gordiychuk/orgs","repos_url":"https://api.github.com/users/Gordiychuk/repos","events_url":"https://api.github.com/users/Gordiychuk/events{/privacy}","received_events_url":"https://api.github.com/users/Gordiychuk/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:27:02Z","updated_at":"2017-01-12T15:27:02Z","author_association":"NONE","body":"What will be use instead of guice for provide DI? What will be official way to create client that provide access to elaticsearch? Right now FilterClient looks like delegator. As a result our clients should create manually some wrapper class instead of specify list plugins. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272193433","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272193433","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272193433,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5MzQzMw==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:30:59Z","updated_at":"2017-01-12T15:30:59Z","author_association":"CONTRIBUTOR","body":"you can just subclass FilterClient and automatically install your plugin there. then you have a dedicated client. We won't use DI in the future it's a disaster from SW engineering perspective and makes encapsulation impossible. We will work towards providing relevant abstractions and extensions points. Most of the plugins don't use DI anymore.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272198198","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272198198","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272198198,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5ODE5OA==","user":{"login":"Gordiychuk","id":10699594,"node_id":"MDQ6VXNlcjEwNjk5NTk0","avatar_url":"https://avatars3.githubusercontent.com/u/10699594?v=4","gravatar_id":"","url":"https://api.github.com/users/Gordiychuk","html_url":"https://github.com/Gordiychuk","followers_url":"https://api.github.com/users/Gordiychuk/followers","following_url":"https://api.github.com/users/Gordiychuk/following{/other_user}","gists_url":"https://api.github.com/users/Gordiychuk/gists{/gist_id}","starred_url":"https://api.github.com/users/Gordiychuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Gordiychuk/subscriptions","organizations_url":"https://api.github.com/users/Gordiychuk/orgs","repos_url":"https://api.github.com/users/Gordiychuk/repos","events_url":"https://api.github.com/users/Gordiychuk/events{/privacy}","received_events_url":"https://api.github.com/users/Gordiychuk/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:47:28Z","updated_at":"2017-01-12T15:47:28Z","author_association":"NONE","body":"It's future plans or we already rewrites this code? I thinks it will required a lot of rewrite code inside elasticsearch and for all clients. If it's takes much time, maybe fix this problem for current version instead of add WA for plugin owners? I can provide PR. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272198772","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272198772","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272198772,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjE5ODc3Mg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T15:49:20Z","updated_at":"2017-01-12T15:49:20Z","author_association":"CONTRIBUTOR","body":"@Gordiychuk what problem are you talking about? I don't see why you can't use a FilterClient?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272210313","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272210313","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272210313,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjIxMDMxMw==","user":{"login":"Gordiychuk","id":10699594,"node_id":"MDQ6VXNlcjEwNjk5NTk0","avatar_url":"https://avatars3.githubusercontent.com/u/10699594?v=4","gravatar_id":"","url":"https://api.github.com/users/Gordiychuk","html_url":"https://github.com/Gordiychuk","followers_url":"https://api.github.com/users/Gordiychuk/followers","following_url":"https://api.github.com/users/Gordiychuk/following{/other_user}","gists_url":"https://api.github.com/users/Gordiychuk/gists{/gist_id}","starred_url":"https://api.github.com/users/Gordiychuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Gordiychuk/subscriptions","organizations_url":"https://api.github.com/users/Gordiychuk/orgs","repos_url":"https://api.github.com/users/Gordiychuk/repos","events_url":"https://api.github.com/users/Gordiychuk/events{/privacy}","received_events_url":"https://api.github.com/users/Gordiychuk/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T16:28:22Z","updated_at":"2017-01-12T16:28:22Z","author_association":"NONE","body":"Because API looks not consistent, users should specify list of plugins, but instead of that user will specify list of plugin plus our implementation of FilterClient. \r\n\r\nIt will not work, when i have an application that is configured outside by user and if user decides to omit security for ealsticsearch. Now all we have to do is omit our plugin from the list of plugins. But if we use FilterClient that acts as our plugin(intercepts requests) and has Client that has all others plugins, this looks strange.\r\n\r\nOffered solution with override `doExecute` does not cover case when it's necessary too intercept each request because delegated client does not execute overriden method(doExecute), it out case it means that all regular request will works correctly because execute flow looks like `User->AuthPlugin(extends FilterClient)->doAction->doExecute(plus our logic)->TransportClient->TransportService->Netty` in doExecute we inject all required headers, but internal request like health check etc will fail because internal request go through TransportService or TransportClient directly.  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272262412","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272262412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272262412,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjI2MjQxMg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-12T19:44:53Z","updated_at":"2017-01-12T19:44:53Z","author_association":"CONTRIBUTOR","body":"if you want to inject a set of headers with every request you can do this via settings. like this:\r\n\r\n```Java\r\n\r\nSettings settings = Settings.builder().put(\"request.headers.your.custom.auth.header\", authHeader).build();\r\n```\r\n\r\nyour plugin can do that as well there is no need to intercept requests.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272368559","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272368559","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272368559,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjM2ODU1OQ==","user":{"login":"pkalinkina","id":20440606,"node_id":"MDQ6VXNlcjIwNDQwNjA2","avatar_url":"https://avatars3.githubusercontent.com/u/20440606?v=4","gravatar_id":"","url":"https://api.github.com/users/pkalinkina","html_url":"https://github.com/pkalinkina","followers_url":"https://api.github.com/users/pkalinkina/followers","following_url":"https://api.github.com/users/pkalinkina/following{/other_user}","gists_url":"https://api.github.com/users/pkalinkina/gists{/gist_id}","starred_url":"https://api.github.com/users/pkalinkina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkalinkina/subscriptions","organizations_url":"https://api.github.com/users/pkalinkina/orgs","repos_url":"https://api.github.com/users/pkalinkina/repos","events_url":"https://api.github.com/users/pkalinkina/events{/privacy}","received_events_url":"https://api.github.com/users/pkalinkina/received_events","type":"User","site_admin":false},"created_at":"2017-01-13T06:05:21Z","updated_at":"2017-01-13T06:05:21Z","author_association":"NONE","body":"But if I want to change this header later I still will have to use `ThreadContext` and `FilterClient`?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272454706","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272454706","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272454706,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjQ1NDcwNg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-13T14:25:56Z","updated_at":"2017-01-13T14:25:56Z","author_association":"CONTRIBUTOR","body":"> But if I want to change this header later I still will have to use ThreadContext and FilterClient?\r\n\r\ncorrect. what is your usecase for this?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272464380","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272464380","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272464380,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjQ2NDM4MA==","user":{"login":"pkalinkina","id":20440606,"node_id":"MDQ6VXNlcjIwNDQwNjA2","avatar_url":"https://avatars3.githubusercontent.com/u/20440606?v=4","gravatar_id":"","url":"https://api.github.com/users/pkalinkina","html_url":"https://github.com/pkalinkina","followers_url":"https://api.github.com/users/pkalinkina/followers","following_url":"https://api.github.com/users/pkalinkina/following{/other_user}","gists_url":"https://api.github.com/users/pkalinkina/gists{/gist_id}","starred_url":"https://api.github.com/users/pkalinkina/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkalinkina/subscriptions","organizations_url":"https://api.github.com/users/pkalinkina/orgs","repos_url":"https://api.github.com/users/pkalinkina/repos","events_url":"https://api.github.com/users/pkalinkina/events{/privacy}","received_events_url":"https://api.github.com/users/pkalinkina/received_events","type":"User","site_admin":false},"created_at":"2017-01-13T15:05:30Z","updated_at":"2017-01-13T15:05:30Z","author_association":"NONE","body":"Usecase for updating authorization header: \r\nWe are implementing OAuth2 with client credentials authorization flow.\r\nWe specify client credentials in Settings for `TransportClient `and  our plugin aquares token from Identity Provider, stores it and inserts token in header of each outcoming request. If token is no longer valid, it is updated via Identity Provider.\r\nTo do so, we have to be able to intercept and change headers of all the outcoming request from Client inside the installed plugin.  And for that we need to have some dependecies from DI (`ThreadContext` and our custom dependenies) in `TransportInterceptor `class (in 5.1.1 version of elasticsearch we don't have this ability)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272476448","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272476448","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272476448,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjQ3NjQ0OA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-13T15:53:03Z","updated_at":"2017-01-13T15:53:03Z","author_association":"CONTRIBUTOR","body":"one think I think that makes sense is to make a change like this:\r\n```diff\r\n\r\ndiff --git a/core/src/main/java/org/elasticsearch/plugins/NetworkPlugin.java b/core/src/main/java/org/elasticsearch/plugins/NetworkPlugin.java\r\nindex 991a21f..eb89daa 100644\r\n--- a/core/src/main/java/org/elasticsearch/plugins/NetworkPlugin.java\r\n+++ b/core/src/main/java/org/elasticsearch/plugins/NetworkPlugin.java\r\n@@ -27,6 +27,7 @@ import org.elasticsearch.common.io.stream.NamedWriteableRegistry;\r\n import org.elasticsearch.common.network.NetworkService;\r\n import org.elasticsearch.common.settings.Settings;\r\n import org.elasticsearch.common.util.BigArrays;\r\n+import org.elasticsearch.common.util.concurrent.ThreadContext;\r\n import org.elasticsearch.common.xcontent.NamedXContentRegistry;\r\n import org.elasticsearch.http.HttpServerTransport;\r\n import org.elasticsearch.indices.breaker.CircuitBreakerService;\r\n@@ -43,7 +44,7 @@ public interface NetworkPlugin {\r\n      * Returns a list of {@link TransportInterceptor} instances that are used to intercept incoming and outgoing\r\n      * transport (inter-node) requests. This must not return <code>null</code>\r\n      */\r\n-    default List<TransportInterceptor> getTransportInterceptors(NamedWriteableRegistry namedWriteableRegistry) {\r\n+    default List<TransportInterceptor> getTransportInterceptors(NamedWriteableRegistry namedWriteableRegistry, ThreadContext context) {\r\n         return Collections.emptyList();\r\n     }\r\n```\r\n\r\nthat way you have the thread context in the interceptor and can set headers as you like?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272539048","html_url":"https://github.com/elastic/elasticsearch/issues/22585#issuecomment-272539048","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22585","id":272539048,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjUzOTA0OA==","user":{"login":"Gordiychuk","id":10699594,"node_id":"MDQ6VXNlcjEwNjk5NTk0","avatar_url":"https://avatars3.githubusercontent.com/u/10699594?v=4","gravatar_id":"","url":"https://api.github.com/users/Gordiychuk","html_url":"https://github.com/Gordiychuk","followers_url":"https://api.github.com/users/Gordiychuk/followers","following_url":"https://api.github.com/users/Gordiychuk/following{/other_user}","gists_url":"https://api.github.com/users/Gordiychuk/gists{/gist_id}","starred_url":"https://api.github.com/users/Gordiychuk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Gordiychuk/subscriptions","organizations_url":"https://api.github.com/users/Gordiychuk/orgs","repos_url":"https://api.github.com/users/Gordiychuk/repos","events_url":"https://api.github.com/users/Gordiychuk/events{/privacy}","received_events_url":"https://api.github.com/users/Gordiychuk/received_events","type":"User","site_admin":false},"created_at":"2017-01-13T20:25:18Z","updated_at":"2017-01-13T20:25:18Z","author_association":"NONE","body":"Yes, this solution will works for us. Thanks.  ","performed_via_github_app":null}]