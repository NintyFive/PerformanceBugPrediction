{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30288","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30288/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30288/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30288/events","html_url":"https://github.com/elastic/elasticsearch/issues/30288","id":319138276,"node_id":"MDU6SXNzdWUzMTkxMzgyNzY=","number":30288,"title":"[CI] IllegalReferenceCountException in FullClusterRestartIT","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":146854632,"node_id":"MDU6TGFiZWwxNDY4NTQ2MzI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Network","name":":Distributed/Network","color":"0e8a16","default":false,"description":"Http and internode communication implementations"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":753477051,"node_id":"MDU6TGFiZWw3NTM0NzcwNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.3.0","name":"v6.3.0","color":"DDDDDD","default":false,"description":null},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2018-05-01T07:41:41Z","updated_at":"2018-05-02T17:52:25Z","closed_at":"2018-05-02T17:52:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"A failure in the BWC tests of 6.3 vs 5.0.2:\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.3+bwc-tests/19/console\r\n\r\n```\r\nFAILURE  253s | FullClusterRestartIT.testSecurityNativeRealm <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: there are still running tasks:\r\n   > {time_in_queue=28ms, time_in_queue_millis=28, source=_add_listener_, executing=true, priority=HIGH, insert_order=765}\r\n   > {time_in_queue=18ms, time_in_queue_millis=18, source=cluster_reroute(async_shard_fetch), executing=false, priority=HIGH, insert_order=767}\r\n   > {time_in_queue=28ms, time_in_queue_millis=28, source=delayed_allocation_reroute, executing=false, priority=NORMAL, insert_order=766}\r\n   >  at __randomizedtesting.SeedInfo.seed([3CA270480BA6CAFB:B75A8C1B31106AE3]:0)\r\n   >  at org.elasticsearch.test.rest.ESRestTestCase.lambda$waitForClusterStateUpdatesToFinish$0(ESRestTestCase.java:347)\r\n   >  at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:754)\r\n   >  at org.elasticsearch.test.rest.ESRestTestCase.waitForClusterStateUpdatesToFinish(ESRestTestCase.java:338)\r\n   >  at org.elasticsearch.test.rest.ESRestTestCase.cleanUpCluster(ESRestTestCase.java:151)\r\n   >  at java.lang.Thread.run(Thread.java:748)\r\n   >  Suppressed: java.lang.AssertionError: there are still running tasks:\r\n   > {time_in_queue=40ms, time_in_queue_millis=40, source=cluster_reroute(async_shard_fetch), executing=true, priority=HIGH, insert_order=637}\r\n...\r\nTests with failures:\r\n  - org.elasticsearch.xpack.restart.FullClusterRestartIT.testSecurityNativeRealm\r\n  - org.elasticsearch.xpack.restart.FullClusterRestartIT.testWatcher\r\n```\r\n\r\nHowever, other tests in this fixture also seemed very slow:\r\n\r\n```\r\nHEARTBEAT J0 PID(7616@worker-099a6b92441027ab0.build.us-west-2c.elasticnet.co): 2018-05-01T05:33:54, stalled for  252s at: FullClusterRestartIT.testSecurityNativeRealm\r\nHEARTBEAT J0 PID(7616@worker-099a6b92441027ab0.build.us-west-2c.elasticnet.co): 2018-05-01T05:37:46, stalled for  231s at: FullClusterRestartIT.testWatcher\r\nHEARTBEAT J0 PID(7616@worker-099a6b92441027ab0.build.us-west-2c.elasticnet.co): 2018-05-01T05:41:02, stalled for  190s at: FullClusterRestartIT.testSingleDoc\r\nHEARTBEAT J0 PID(7616@worker-099a6b92441027ab0.build.us-west-2c.elasticnet.co): 2018-05-01T05:44:40, stalled for  211s at: FullClusterRestartIT.testSqlFailsOnIndexWithTwoTypes\r\n```\r\n\r\nDigging into the logs a bit, I find this which doesn't look right:\r\n\r\n```\r\n[2018-05-01T05:29:46,598][DEBUG][o.e.c.s.ClusterService   ] [node-0] processing [zen-disco-receive(from master [master {node-1}{-Wjuwb5sSUiVnV5ldBENqA}{qs8hEUgARRul6e9hCQ6Vog}{127.0.0.1}{127.0.0.1:53625}{testattr=test} committed version [119]])]:\r\n[2018-05-01T05:29:46,627][WARN ][o.e.x.s.t.n.SecurityNetty4Transport] [node-0] exception caught on transport layer [[id: 0xd86dc7ea, L:/127.0.0.1:39843 - R:/127.0.0.1:60615]], closing connection\r\nio.netty.handler.codec.DecoderException: io.netty.util.IllegalReferenceCountException: refCnt: 0, decrement: 1\r\n        at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:442) ~[netty-codec-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:248) ~[netty-codec-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:372) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:358) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:350) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1334) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:372) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:358) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:926) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:129) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:610) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:513) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:467) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:437) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:873) [netty-common-4.1.5.Final.jar:4.1.5.Final]\r\n        at java.base/java.lang.Thread.run(Thread.java:844) [?:?]\r\nCaused by: io.netty.util.IllegalReferenceCountException: refCnt: 0, decrement: 1\r\n        at io.netty.buffer.AbstractReferenceCountedByteBuf.release(AbstractReferenceCountedByteBuf.java:111) ~[?:?]\r\n        at io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1068) ~[?:?]\r\n        at io.netty.handler.ssl.SslHandler.decode(SslHandler.java:900) ~[?:?]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:411) ~[?:?]\r\n        ... 15 more\r\n[2018-05-01T05:29:46,638][DEBUG][i.n.h.s.SslHandler       ] [id: 0x2280b8e2, L:/127.0.0.1:39843 - R:/127.0.0.1:60618] Swallowing a harmless 'connection reset by peer / broken pipe' error that occurred while writing close_notify in response to the\r\njava.io.IOException: Connection reset by peer\r\n        at java.base/sun.nio.ch.FileDispatcherImpl.read0(Native Method) ~[?:?]\r\n        at java.base/sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39) ~[?:?]\r\n        at java.base/sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:283) ~[?:?]\r\n        at java.base/sun.nio.ch.IOUtil.read(IOUtil.java:250) ~[?:?]\r\n        at java.base/sun.nio.ch.IOUtil.read(IOUtil.java:226) ~[?:?]\r\n        at java.base/sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:382) ~[?:?]\r\n        at io.netty.buffer.PooledHeapByteBuf.setBytes(PooledHeapByteBuf.java:261) ~[netty-buffer-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.buffer.AbstractByteBuf.writeBytes(AbstractByteBuf.java:1100) ~[netty-buffer-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.socket.nio.NioSocketChannel.doReadBytes(NioSocketChannel.java:367) ~[netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:118) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:610) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:513) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:467) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:437) [netty-transport-4.1.5.Final.jar:4.1.5.Final]\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:873) [netty-common-4.1.5.Final.jar:4.1.5.Final]\r\n        at java.base/java.lang.Thread.run(Thread.java:844) [?:?]\r\n```\r\n\r\nThis is on the 5.0.2 node (running on JVM 10):\r\n\r\n```\r\n[2018-05-01T05:28:21,514][INFO ][o.e.n.Node               ] [node-0] version[5.0.2], pid[7422], build[f6b4951/2016-11-24T10:07:18.101Z], OS[Linux/3.13.0-137-generic/amd64], JVM[\"Oracle Corporation\"/Java HotSpot(TM) 64-Bit Server VM/10/10+46]\r\n```\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}