{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33867","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33867/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33867/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33867/events","html_url":"https://github.com/elastic/elasticsearch/issues/33867","id":361813585,"node_id":"MDU6SXNzdWUzNjE4MTM1ODU=","number":33867,"title":"[CI] IndexAuditUpgradeIT.testAuditLogs fails ","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"labels":[{"id":912837734,"node_id":"MDU6TGFiZWw5MTI4Mzc3MzQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Audit","name":":Security/Audit","color":"0e8a16","default":false,"description":"X-Pack Audit logging"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1056536047,"node_id":"MDU6TGFiZWwxMDU2NTM2MDQ3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.2","name":"v6.4.2","color":"Dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"assignees":[{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false}],"milestone":null,"comments":15,"created_at":"2018-09-19T15:50:38Z","updated_at":"2020-02-03T19:53:03Z","closed_at":"2020-02-03T19:53:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.4+bwc-tests/8/console\r\n\r\n## Reproduction line\r\ndoes not reproduce locally\r\n```\r\n ./gradlew :x-pack:qa:rolling-upgrade:with-system-key:v6.3.1#upgradedClusterTestRunner \\\r\n  -Dtests.seed=57D936B12E792F96 \\\r\n  -Dtests.class=org.elasticsearch.upgrades.IndexAuditUpgradeIT \\\r\n  -Dtests.method=\"testAuditLogs\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=bg \\\r\n  -Dtests.timezone=Pacific/Marquesas\r\n```\r\n\r\n## Example relevant log:\r\n```\r\n00:00:46    > Throwable #1: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2343, key=upgraded-node-0}, {doc_count=2175, key=node-1}, {doc_count=2106, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \tat __randomizedtesting.SeedInfo.seed([57D936B12E792F96:300A75E395A08B0D]:0)\r\n00:00:46    > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:830)\r\n00:00:46    > \tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:804)\r\n00:00:46    > \tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.testAuditLogs(IndexAuditUpgradeIT.java:68)\r\n00:00:46    > \tat java.lang.Thread.run(Thread.java:748)\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46   2> NOTE: leaving temporary files on disk at: /var/lib/jenkins/workspace/elastic+elasticsearch+6.4+bwc-tests/x-pack/qa/rolling-upgrade/with-system-key/build/testrun/v6.3.1#upgradedClusterTestRunner/J0/temp/org.elasticsearch.upgrades.IndexAuditUpgradeIT_57D936B12E792F96-001\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46   2> NOTE: test params are: codec=Asserting(Lucene70): {}, docValues:{}, maxPointsInLeafNode=174, maxMBSortInHeap=7.47073894872366, sim=RandomSimilarity(queryNorm=true): {}, locale=bg, timezone=Pacific/Marquesas\r\n00:00:46   2> NOTE: Linux 4.4.0-1061-aws amd64/Oracle Corporation 1.8.0_181 (64-bit)/cpus=16,threads=1,free=433534592,total=514850816\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46   2> NOTE: All tests run in this JVM: [IndexingIT, RollupIDUpgradeIT, TokenBackwardsCompatibilityIT, IndexAuditUpgradeIT]\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=1983, key=upgraded-node-0}, {doc_count=1794, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=2025, key=upgraded-node-0}, {doc_count=1841, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2175, key=node-1}, {doc_count=2141, key=upgraded-node-0}, {doc_count=1933, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46    > \tSuppressed: java.lang.AssertionError: Found node buckets [{doc_count=2431, key=node-2}, {doc_count=2212, key=upgraded-node-0}, {doc_count=2175, key=node-1}, {doc_count=2000, key=upgraded-node-1}, {doc_count=891, key=node-0}]\r\n00:00:46    > Expected: a collection with size <6>\r\n00:00:46    >      but: collection size was <5>\r\n00:00:46    > \t\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.assertNumUniqueNodeNameBuckets(IndexAuditUpgradeIT.java:126)\r\n00:00:46    > \t\tat org.elasticsearch.upgrades.IndexAuditUpgradeIT.lambda$testAuditLogs$0(IndexAuditUpgradeIT.java:70)\r\n00:00:46    > \t\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:818)\r\n00:00:46    > \t\t... 39 more\r\n00:00:46 Completed [4/6] in 10.40s, 1 test, 1 failure <<< FAILURES!\r\n```\r\n\r\n## Frequency\r\n\r\nIt happened 8 times in August, not super frequent but seems consistent.","closed_by":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"performed_via_github_app":null}