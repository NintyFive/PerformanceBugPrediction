{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6438","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6438/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6438/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6438/events","html_url":"https://github.com/elastic/elasticsearch/issues/6438","id":35250993,"node_id":"MDU6SXNzdWUzNTI1MDk5Mw==","number":6438,"title":"Indexing ampersands","user":{"login":"shaneiseminger","id":843313,"node_id":"MDQ6VXNlcjg0MzMxMw==","avatar_url":"https://avatars0.githubusercontent.com/u/843313?v=4","gravatar_id":"","url":"https://api.github.com/users/shaneiseminger","html_url":"https://github.com/shaneiseminger","followers_url":"https://api.github.com/users/shaneiseminger/followers","following_url":"https://api.github.com/users/shaneiseminger/following{/other_user}","gists_url":"https://api.github.com/users/shaneiseminger/gists{/gist_id}","starred_url":"https://api.github.com/users/shaneiseminger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shaneiseminger/subscriptions","organizations_url":"https://api.github.com/users/shaneiseminger/orgs","repos_url":"https://api.github.com/users/shaneiseminger/repos","events_url":"https://api.github.com/users/shaneiseminger/events{/privacy}","received_events_url":"https://api.github.com/users/shaneiseminger/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-06-08T23:45:26Z","updated_at":"2014-06-09T08:54:58Z","closed_at":"2014-06-09T08:54:58Z","author_association":"NONE","active_lock_reason":null,"body":"I have a situation where I need to keep ampersands as a token in my index, and ideally, they should be converted to \"and\". I'm using a char filter to do this. It's working fine on searches, as when I run a search through the Validate API that includes an ampersand, I can see \"and\" as a token. But for some reason it's not working on the index side.\n\nIn one case in particular, I have an item titled \"Terms & Conditions\" and I want it to match searches for \"terms and conditions.\" (Searches are a multi_match with boolean AND.) I've included my index definition below (it's in PHP format, not JSON, because I'm using the Elastica library.)\n\n```\n        'analysis' => array(\n            \"char_filter\"  => array(\n                // Collapses \"H.M.S.\" or \"H. M. S.\" into HMS\n                \"abbreviations\" => array(\n                    \"type\" => \"pattern_replace\",\n                    \"pattern\" => \"\\b([A-Z])[\\.\\, ]+(?=[A-Z]\\b)\",\n                    \"replacement\" => \"$1\"\n                ),\n                \"punctuation\" => array(\n                    \"type\" => \"pattern_replace\",\n                    \"pattern\" => \"[^a-zA-Z\\d\\s]\",\n                    \"replacement\" => \"\"\n                ),\n                \"&_to_and\" => array(\n                    \"type\" =>  \"mapping\",\n                    \"mappings\" => [ \"&=>and\"]\n                )\n            ),\n            \"filter\"  => array(\n                [ ... filters ... ]\n            ),\n            'analyzer' => array(\n                'default_index' => array(\n                    'type' => 'custom',\n                    'tokenizer' => 'standard',\n                    \"char_filter\" => array('&_to_and', \"abbreviations\", 'punctuation'),\n                    'filter' => array('standard', 'lowercase', 'elision', 'kstem', 'shingle_filter')\n                ),\n                'default_search' => array(\n                    'type' => 'custom',\n                    'tokenizer' => 'standard',\n                    \"char_filter\" => array('&_to_and', \"abbreviations\", 'punctuation'),\n                    'filter' => array('standard', 'lowercase', 'elision', 'word_synonym_filter', 'kstem')\n                ),\n                [ ... other analyzers ... ]\n                'variants' => array(\n                    'type' => 'custom',\n                    'tokenizer' => 'standard',\n                    \"char_filter\" => array('&_to_and', \"abbreviations\", 'punctuation'),\n                    'filter' => array('standard', 'lowercase', 'elision', 'name_synonym_filter', 'word_synonym_filter')\n                ),\n                [ ... other analyzers ... ]\n            )\n        )\n```\n\nThis should, to my understanding, cause instances of \"&\" to become \"and\" in the index for any field that doesn't specify an analyzer, or one that uses the \"variants\" analyzer. But when I specifically index a document with an ampersand, then query it, it still shows an ampersand.\n\nWhere am I going wrong here? I'm using ElasticSearch 1.1.2. \n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}