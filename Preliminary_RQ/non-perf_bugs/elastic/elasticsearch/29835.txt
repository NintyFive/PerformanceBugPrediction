{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29835","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29835/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29835/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29835/events","html_url":"https://github.com/elastic/elasticsearch/issues/29835","id":317448461,"node_id":"MDU6SXNzdWUzMTc0NDg0NjE=","number":29835,"title":"New Monitoring tests are failing","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912834056,"node_id":"MDU6TGFiZWw5MTI4MzQwNTY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Monitoring","name":":Core/Features/Monitoring","color":"0e8a16","default":false,"description":""},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"assignees":[{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2017-11-10T08:53:06Z","updated_at":"2018-04-26T15:32:47Z","closed_at":"2018-04-26T15:32:47Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @ywelsch:*\n\nRelates LINK REDACTED\r\n\r\nSee LINK REDACTED\r\n\r\nRelevant log lines:\r\n\r\n```\r\n08:12:52   1> [2017-11-10T02:12:51,177][INFO ][o.e.u.UpgradeClusterClientYamlTestSuiteIT] [test {p0=old_cluster/60_monitoring/Index monitoring data and search on the old cluster}]: after test\r\n08:12:52   1> [2017-11-10T02:12:51,179][INFO ][o.e.u.UpgradeClusterClientYamlTestSuiteIT] Stash dump on failure [{\r\n08:12:52   1>   \"stash\" : {\r\n08:12:52   1>     \"body\" : {\r\n08:12:52   1>       \"took\" : 0,\r\n08:12:52   1>       \"timed_out\" : false,\r\n08:12:52   1>       \"_shards\" : {\r\n08:12:52   1>         \"total\" : 0,\r\n08:12:52   1>         \"successful\" : 0,\r\n08:12:52   1>         \"skipped\" : 0,\r\n08:12:52   1>         \"failed\" : 0\r\n08:12:52   1>       },\r\n08:12:52   1>       \"hits\" : {\r\n08:12:52   1>         \"total\" : 0,\r\n08:12:52   2> REPRODUCE WITH: gradle :x-pack-elasticsearch:qa:rolling-upgrade:with-system-key:v5.6.5-SNAPSHOT#oldClusterTestRunner -Dtests.seed=74B035F2BA325802 -Dtests.class=org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT -Dtests.method=\"test {p0=old_cluster/60_monitoring/Index monitoring data and search on the old cluster}\" -Dtests.security.manager=true -Dtests.locale=ar-AE -Dtests.timezone=Canada/Saskatchewan -Dtests.rest.suite=old_cluster\r\n08:12:52   1>         \"max_score\" : 0.0,\r\n08:12:52   1>         \"hits\" : [ ]\r\n08:12:52   1>       }\r\n08:12:52   1>     }\r\n08:12:52   1>   }\r\n08:12:52   1> }]\r\n08:12:52 FAILURE 30.3s | UpgradeClusterClientYamlTestSuiteIT.test {p0=old_cluster/60_monitoring/Index monitoring data and search on the old cluster} <<< FAILURES!\r\n08:12:52    > Throwable LINK REDACTED: java.lang.AssertionError: Failure at [old_cluster/60_monitoring:30]: hits.total didn't match expected value:\r\n08:12:52    >                     hits.total: expected [2] but was [0]\r\n08:12:52    > \tat __randomizedtesting.SeedInfo.seed([74B035F2BA325802:FCE40A2814CE35FA]:0)\r\n08:12:52    > \tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:352)\r\n08:12:52    > \tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.test(ESClientYamlSuiteTestCase.java:332)\r\n08:12:52    > \tat java.lang.Thread.run(Thread.java:748)\r\n08:12:52    > Caused by: java.lang.AssertionError: hits.total didn't match expected value:\r\n08:12:52    >                     hits.total: expected [2] but was [0]\r\n08:12:52    > \tat org.elasticsearch.test.rest.yaml.section.MatchAssertion.doAssert(MatchAssertion.java:87)\r\n08:12:52    > \tat org.elasticsearch.test.rest.yaml.section.Assertion.execute(Assertion.java:76)\r\n08:12:52    > \tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:348)\r\n08:12:52    > \t... 38 more\r\n```\r\n\r\nIt looks to me as the test has no condition to wait for the `.monitoring-kibana-*` to be created.\r\n\r\ni.e. something like\r\n\r\n```\r\n - do:\r\n      cluster.health:\r\n        index: \".monitoring-kibana-*\"\r\n        wait_for_active_shards: 2 # 1 primary and 1 replica since we have two nodes\r\n```","closed_by":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}