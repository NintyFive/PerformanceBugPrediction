{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19774","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19774/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19774/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19774/events","html_url":"https://github.com/elastic/elasticsearch/issues/19774","id":169098005,"node_id":"MDU6SXNzdWUxNjkwOTgwMDU=","number":19774,"title":"Restoring a snapshot can leave cluster state in broken state","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2016-08-03T10:23:01Z","updated_at":"2016-10-12T07:06:37Z","closed_at":"2016-10-12T07:06:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"After a failed restore, the restore state in the cluster state is not properly cleaned up, blocking future restores from starting. Only a full cluster restart cleans the restore state.\n\nSource: https://discuss.elastic.co/t/cannot-restore-snapshot-process-already-running/56746\nEnvironment: 10 node cluster / elasticsearch 2.3.4 / Debian Jessie / NFS repository type\n\nThe cluster state shows that there are indices (e.g. index-a) which exist in snapshot state but donâ€™t exist in metadata. Then there are indices (e.g. index-b) that are marked as INIT in snapshot state but shard routings are all marked as STARTED.\n\nExcerpts from the anonymized cluster state:\n\n```\n  \"restore\" : {\n    \"snapshots\" : [ {\n      \"snapshot\" : \"backup\",\n      \"repository\" : \"backup\",\n      \"state\" : \"STARTED\",\n      \"indices\" : [ \"index-a\", \"index-b\", ... ],\n      \"shards\" : [  {\n        \"index\" : \"index-a\",\n        \"shard\" : 0,\n        \"state\" : \"SUCCESS\"\n      }, {\n        \"index\" : \"index-a\",\n        \"shard\" : 1,\n        \"state\" : \"FAILURE\"\n      }, ...\n\n     ..., {\n        \"index\" : \"index-b\",\n        \"shard\" : 0,\n        \"state\" : \"INIT\"\n      }, {\n        \"index\" : \"index-b\",\n        \"shard\" : 1,\n        \"state\" : \"INIT\"\n      }, {\n        \"index\" : \"index-b\",\n        \"shard\" : 2,\n        \"state\" : \"SUCCESS\"\n      },\n\n```\n\nthere is no indexmetadata/shardroutings for index-a in the cluster state but for index-b:\n\nIndexMetaData:\n\n```\n      ...,\n      \"index-b\" : {\n        \"state\" : \"open\",\n        \"settings\" : {\n          \"index\" : {\n            \"creation_date\" : \"...\",\n            ...\n          }\n        },\n        \"mappings\" : {\n          ...\n        },\n        \"aliases\" : ...\n      },\n```\n\nand\n\nShardRoutings:\n\n```\n      ...,\n      \"index-b\" : {\n        \"shards\" : {\n          \"2\" : [ {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"HHYUOZZ7TqeapIamJeYU8w\",\n            \"relocating_node\" : null,\n            \"shard\" : 2,\n            \"index\" : \"index-b\",\n            \"version\" : 47,\n            \"allocation_id\" : {\n              \"id\" : \"2GELW1i0S7i8KPf_moWugg\"\n            }\n          }, {\n            \"state\" : \"STARTED\",\n            \"primary\" : true,\n            \"node\" : \"r-kHLyr8Q3SlTt6ToVlq1A\",\n            \"relocating_node\" : null,\n            \"shard\" : 2,\n            \"index\" : \"index-b\",\n            \"version\" : 47,\n            \"allocation_id\" : {\n              \"id\" : \"S_O2zIM_ShG9g1oNCfeVew\"\n            }\n          }, {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"_7WX9LH2TYyHEMykc-1s9w\",\n            \"relocating_node\" : null,\n            \"shard\" : 2,\n            \"index\" : \"index-b\",\n            \"version\" : 47,\n            \"allocation_id\" : {\n              \"id\" : \"-61Vup2mSnOrRKG2GfrY5Q\"\n            }\n          } ],\n          \"1\" : [ {\n            \"state\" : \"STARTED\",\n            \"primary\" : true,\n            \"node\" : \"vfw5y4jDTh-tiI2Gqc5fyA\",\n            \"relocating_node\" : null,\n            \"shard\" : 1,\n            \"index\" : \"index-b\",\n            \"version\" : 45,\n            \"allocation_id\" : {\n              \"id\" : \"N4mQmap3TfGZWVsD8B7f3Q\"\n            }\n          }, {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"HHYUOZZ7TqeapIamJeYU8w\",\n            \"relocating_node\" : null,\n            \"shard\" : 1,\n            \"index\" : \"index-b\",\n            \"version\" : 45,\n            \"allocation_id\" : {\n              \"id\" : \"6EJtCi5uR8aRzDcow69yQQ\"\n            }\n          }, {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"6IFVYG3ZT7iS0CZR6hhUsw\",\n            \"relocating_node\" : null,\n            \"shard\" : 1,\n            \"index\" : \"index-b\",\n            \"version\" : 45,\n            \"allocation_id\" : {\n              \"id\" : \"ufHda_oUQ6qm5jHSV50Crw\"\n            }\n          } ],\n          \"0\" : [ {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"h6XBV034RL-psP0qXW9vmw\",\n            \"relocating_node\" : null,\n            \"shard\" : 0,\n            \"index\" : \"index-b\",\n            \"version\" : 60,\n            \"allocation_id\" : {\n              \"id\" : \"9QFXNtkqQYCkYfJ_HJ7mbA\"\n            }\n          }, {\n            \"state\" : \"STARTED\",\n            \"primary\" : true,\n            \"node\" : \"lm1ClSoQT561rp7xvgmFbg\",\n            \"relocating_node\" : null,\n            \"shard\" : 0,\n            \"index\" : \"index-b\",\n            \"version\" : 60,\n            \"allocation_id\" : {\n              \"id\" : \"YrCTXmZ6RVm07a7d5UYPVg\"\n            }\n          }, {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"xmuJY7BYRO6893-XTpTnTQ\",\n            \"relocating_node\" : null,\n            \"shard\" : 0,\n            \"index\" : \"index-b\",\n            \"version\" : 60,\n            \"allocation_id\" : {\n              \"id\" : \"x2u628VdSHS3p8vl9e7ufA\"\n            }\n          } ]\n        }\n      }, ...\n```\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}