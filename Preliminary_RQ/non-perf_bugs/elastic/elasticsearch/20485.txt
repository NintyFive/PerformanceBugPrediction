{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20485","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20485/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20485/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20485/events","html_url":"https://github.com/elastic/elasticsearch/issues/20485","id":176968329,"node_id":"MDU6SXNzdWUxNzY5NjgzMjk=","number":20485,"title":"deb init script PATH overwrite - cant find java","user":{"login":"MrMarvin","id":100136,"node_id":"MDQ6VXNlcjEwMDEzNg==","avatar_url":"https://avatars3.githubusercontent.com/u/100136?v=4","gravatar_id":"","url":"https://api.github.com/users/MrMarvin","html_url":"https://github.com/MrMarvin","followers_url":"https://api.github.com/users/MrMarvin/followers","following_url":"https://api.github.com/users/MrMarvin/following{/other_user}","gists_url":"https://api.github.com/users/MrMarvin/gists{/gist_id}","starred_url":"https://api.github.com/users/MrMarvin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MrMarvin/subscriptions","organizations_url":"https://api.github.com/users/MrMarvin/orgs","repos_url":"https://api.github.com/users/MrMarvin/repos","events_url":"https://api.github.com/users/MrMarvin/events{/privacy}","received_events_url":"https://api.github.com/users/MrMarvin/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-09-14T17:22:51Z","updated_at":"2020-11-11T21:58:27Z","closed_at":"2016-09-15T13:37:36Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.4.0 (from packages.elastic.co Ubuntu repos)\n\n**JVM version**: 1.8 sun JRE\n\n**OS version**: Ubuntu 14.04\n\n**Description of the problem including expected versus actual behavior**:\n\nWhen starting ElasticSearch (installed in the above mentioned fashion) via the supported way using the `system` command, the invoked init script fails to detect an installed JavaRE if it is not in a (seemingly arbitrary chosen) shortened PATH.\n\nThe script contains the [following line](https://github.com/elastic/elasticsearch/blob/master/distribution/deb/src/main/packaging/init.d/elasticsearch#L15):\n\n```\nPATH=/bin:/usr/bin:/sbin:/usr/sbin\n```\n\nwhich might, in fact, not contain the actual path to java. **Why the PATH is overwritten from what the system provides in something I'd like to understand and discuss in this issue.** \n\nIn most cases it is advised to set system wide additions to path via a `/etc/profile` setting, which is what we did [with the Saltstack salt sun-java formula.](https://github.com/saltstack-formulas/sun-java-formula)\n\nThe actual logic checking for java is to [see if `$JAVA_HOME` is set ](https://github.com/elastic/elasticsearch/blob/master/distribution/deb/src/main/packaging/init.d/elasticsearch#L94) before using `which` to check the `short-$PATH`. However, as we invoke the script via `service elasticsearch start` instead of directly (`/etc/init.d/elasticsearch start`), the `JAVA_HOME` variable is not set. [This is due to `service` stripping all non `TERM`, `PATH` or `LANG` variables. ](http://unix.stackexchange.com/questions/44370/how-to-make-unix-service-see-environment-variables). So we 'fall back' to looking for java in $PATH, which is okay, I guess.\n\n**Why does the debian init script shortens its `$PATH` before checking for java?**\n\n**Steps to reproduce**:\n1. install java in a non-systen default way (say SUN JRE instead of OpenJDK from packages)\n2. install ElasticSearch from deb\n3. run `service elasticsearch start`\n\n**Provide logs (if relevant)**:\n\n```\nroot@master1-salt1:~# service elasticsearch start\n+ PATH=/bin:/usr/bin:/sbin:/usr/sbin\n+ NAME=elasticsearch\n+ DESC=Elasticsearch Server\n+ DEFAULT=/etc/default/elasticsearch\n+ id -u\n+ [ 0 -ne 0 ]\n+ . /lib/lsb/init-functions\n+ run-parts --lsbsysinit --list /lib/lsb/init-functions.d\n+ [ -r /lib/lsb/init-functions.d/01-upstart-lsb ]\n+ . /lib/lsb/init-functions.d/01-upstart-lsb\n+ unset UPSTART_SESSION\n+ _RC_SCRIPT=/etc/init.d/elasticsearch\n+ [ -r /etc/init//etc/init.d/elasticsearch.conf ]\n+ _UPSTART_JOB=elasticsearch\n+ [ -r /etc/init/elasticsearch.conf ]\n+ [ -r /lib/lsb/init-functions.d/20-left-info-blocks ]\n+ . /lib/lsb/init-functions.d/20-left-info-blocks\n+ [ -r /lib/lsb/init-functions.d/50-ubuntu-logging ]\n+ . /lib/lsb/init-functions.d/50-ubuntu-logging\n+ LOG_DAEMON_MSG=\n+ FANCYTTY=\n+ [ -e /etc/lsb-base-logging.sh ]\n+ true\n+ [ -r /etc/default/rcS ]\n+ . /etc/default/rcS\n+ UTC=yes\n+ ES_USER=elasticsearch\n+ ES_GROUP=elasticsearch\n+ ES_HOME=/usr/share/elasticsearch\n+ MAX_OPEN_FILES=65536\n+ LOG_DIR=/var/log/elasticsearch\n+ DATA_DIR=/var/lib/elasticsearch\n+ CONF_DIR=/etc/elasticsearch\n+ MAX_MAP_COUNT=262144\n+ PID_DIR=/var/run/elasticsearch\n+ [ -f /etc/default/elasticsearch ]\n+ . /etc/default/elasticsearch\n+ ES_HEAP_SIZE=1024m\n+ MAX_LOCKED_MEMORY=unlimited\n+ [ ! -z  ]\n+ PID_FILE=/var/run/elasticsearch/elasticsearch.pid\n+ DAEMON=/usr/share/elasticsearch/bin/elasticsearch\n+ DAEMON_OPTS=-d -p /var/run/elasticsearch/elasticsearch.pid --default.path.home=/usr/share/elasticsearch --default.path.logs=/var/log/elasticsearch --default.path.data=/var/lib/elasticsearch --default.path.conf=/etc/elasticsearch\n+ export ES_HEAP_SIZE\n+ export ES_HEAP_NEWSIZE\n+ export ES_DIRECT_SIZE\n+ export ES_JAVA_OPTS\n+ export ES_GC_LOG_FILE\n+ export JAVA_HOME\n+ export ES_INCLUDE\n+ test -x /usr/share/elasticsearch/bin/elasticsearch\n+ checkJava\n+ [ -x /bin/java ]\n+ which java\n+ JAVA=\n+ [ ! -x  ]\n+ echo Could not find any executable java binary. Please install java in your PATH or set JAVA_HOME\nCould not find any executable java binary. Please install java in your PATH or set JAVA_HOME\n+ exit 1\n```\n\nvs.\n\n```\nroot@master1-salt1:~# /etc/init.d/elasticsearch start\n+ PATH=/bin:/usr/bin:/sbin:/usr/sbin\n+ NAME=elasticsearch\n+ DESC=Elasticsearch Server\n+ DEFAULT=/etc/default/elasticsearch\n+ id -u\n+ [ 0 -ne 0 ]\n+ . /lib/lsb/init-functions\n+ run-parts --lsbsysinit --list /lib/lsb/init-functions.d\n+ [ -r /lib/lsb/init-functions.d/01-upstart-lsb ]\n+ . /lib/lsb/init-functions.d/01-upstart-lsb\n+ unset UPSTART_SESSION\n+ _RC_SCRIPT=/etc/init.d/elasticsearch\n+ [ -r /etc/init//etc/init.d/elasticsearch.conf ]\n+ _UPSTART_JOB=elasticsearch\n+ [ -r /etc/init/elasticsearch.conf ]\n+ [ -r /lib/lsb/init-functions.d/20-left-info-blocks ]\n+ . /lib/lsb/init-functions.d/20-left-info-blocks\n+ [ -r /lib/lsb/init-functions.d/50-ubuntu-logging ]\n+ . /lib/lsb/init-functions.d/50-ubuntu-logging\n+ LOG_DAEMON_MSG=\n+ FANCYTTY=\n+ [ -e /etc/lsb-base-logging.sh ]\n+ true\n+ [ -r /etc/default/rcS ]\n+ . /etc/default/rcS\n+ UTC=yes\n+ ES_USER=elasticsearch\n+ ES_GROUP=elasticsearch\n+ ES_HOME=/usr/share/elasticsearch\n+ MAX_OPEN_FILES=65536\n+ LOG_DIR=/var/log/elasticsearch\n+ DATA_DIR=/var/lib/elasticsearch\n+ CONF_DIR=/etc/elasticsearch\n+ MAX_MAP_COUNT=262144\n+ PID_DIR=/var/run/elasticsearch\n+ [ -f /etc/default/elasticsearch ]\n+ . /etc/default/elasticsearch\n+ ES_HEAP_SIZE=1024m\n+ MAX_LOCKED_MEMORY=unlimited\n+ [ ! -z  ]\n+ PID_FILE=/var/run/elasticsearch/elasticsearch.pid\n+ DAEMON=/usr/share/elasticsearch/bin/elasticsearch\n+ DAEMON_OPTS=-d -p /var/run/elasticsearch/elasticsearch.pid --default.path.home=/usr/share/elasticsearch --default.path.logs=/var/log/elasticsearch --default.path.data=/var/lib/elasticsearch --default.path.conf=/etc/elasticsearch\n+ export ES_HEAP_SIZE\n+ export ES_HEAP_NEWSIZE\n+ export ES_DIRECT_SIZE\n+ export ES_JAVA_OPTS\n+ export ES_GC_LOG_FILE\n+ export JAVA_HOME\n+ export ES_INCLUDE\n+ test -x /usr/share/elasticsearch/bin/elasticsearch\n+ checkJava\n+ [ -x /usr/lib/java/bin/java ]\n+ JAVA=/usr/lib/java/bin/java\n+ [ ! -x /usr/lib/java/bin/java ]\n+ [ -n unlimited -a -z 1024m ]\n+ log_daemon_msg Starting Elasticsearch Server\n+ [ -z Starting Elasticsearch Server ]\n+ log_use_fancy_output\n+ TPUT=/usr/bin/tput\n+ EXPR=/usr/bin/expr\n+ [ -t 1 ]\n+ [ xxterm != x ]\n+ [ xxterm != xdumb ]\n+ [ -x /usr/bin/tput ]\n+ [ -x /usr/bin/expr ]\n+ /usr/bin/tput hpa 60\n+ /usr/bin/tput setaf 1\n+ [ -z ]\n+ FANCYTTY=1\n+ true\n+ /usr/bin/tput xenl\n+ /usr/bin/tput cols\n+ COLS=179\n+ [ 179 ]\n+ [ 179 -gt 6 ]\n+ /usr/bin/expr 179 - 7\n+ COL=172\n+ log_use_plymouth\n+ [ n = y ]\n+ plymouth --ping\n+ printf  * Starting Elasticsearch Server\n * Starting Elasticsearch Server       + /usr/bin/expr 179 - 1\n+ /usr/bin/tput hpa 178\n                                                                                                                                                                                  + printf\n + pidofproc -p /var/run/elasticsearch/elasticsearch.pid elasticsearch\n+ local pidfile base status specified pid OPTIND\n+ pidfile=\n+ specified=\n+ OPTIND=1\n+ getopts p: opt\n+ pidfile=/var/run/elasticsearch/elasticsearch.pid\n+ specified=specified\n+ getopts p: opt\n+ shift 2\n+ [ 1 -ne 1 ]\n+ base=elasticsearch\n+ [ ! specified ]\n+ [ -n /var/run/elasticsearch/elasticsearch.pid -a -r /var/run/elasticsearch/elasticsearch.pid ]\n+ read pid\n+ [ -n 9145 ]\n+ kill -0 9145\n+\n+ ps 9145\n+ return 1\n+ pid=\n+ [ -n  ]\n+ mkdir -p /var/log/elasticsearch /var/lib/elasticsearch\n+ chown elasticsearch:elasticsearch /var/log/elasticsearch /var/lib/elasticsearch\n+ [ -n /var/run/elasticsearch ]\n+ [ ! -e /var/run/elasticsearch ]\n+ [ -n /var/run/elasticsearch/elasticsearch.pid ]\n+ [ ! -e /var/run/elasticsearch/elasticsearch.pid ]\n+ [ -n 65536 ]\n+ ulimit -n 65536\n+ [ -n unlimited ]\n+ ulimit -l unlimited\n+ [ -n 262144 -a -f /proc/sys/vm/max_map_count ]\n+ sysctl -q -w vm.max_map_count=262144\n+ start-stop-daemon -d /usr/share/elasticsearch --start -b --user elasticsearch -c elasticsearch --pidfile /var/run/elasticsearch/elasticsearch.pid --exec /usr/share/elasticsearch/bin/elasticsearch -- -d -p /var/run/elasticsearch/elasticsearch.pid --default.path.home=/usr/share/elasticsearch --default.path.logs=/var/log/elasticsearch --default.path.data=/var/lib/elasticsearch --default.path.conf=/etc/elasticsearch\n+ return=0\n+ [ 0 -eq 0 ]\n+ i=0\n+ timeout=10\n+ sleep 1\n[...]\n```\n\nvs. with commented out `PATH` overwrite:\n\n```\nroot@master1-salt1:~# service elasticsearch start\n+ NAME=elasticsearch\n+ DESC=Elasticsearch Server\n+ DEFAULT=/etc/default/elasticsearch\n+ id -u\n+ [ 0 -ne 0 ]\n+ . /lib/lsb/init-functions\n+ run-parts --lsbsysinit --list /lib/lsb/init-functions.d\n+ [ -r /lib/lsb/init-functions.d/01-upstart-lsb ]\n+ . /lib/lsb/init-functions.d/01-upstart-lsb\n+ unset UPSTART_SESSION\n+ _RC_SCRIPT=/etc/init.d/elasticsearch\n+ [ -r /etc/init//etc/init.d/elasticsearch.conf ]\n+ _UPSTART_JOB=elasticsearch\n+ [ -r /etc/init/elasticsearch.conf ]\n+ [ -r /lib/lsb/init-functions.d/20-left-info-blocks ]\n+ . /lib/lsb/init-functions.d/20-left-info-blocks\n+ [ -r /lib/lsb/init-functions.d/50-ubuntu-logging ]\n+ . /lib/lsb/init-functions.d/50-ubuntu-logging\n+ LOG_DAEMON_MSG=\n+ FANCYTTY=\n+ [ -e /etc/lsb-base-logging.sh ]\n+ true\n+ [ -r /etc/default/rcS ]\n+ . /etc/default/rcS\n+ UTC=yes\n+ ES_USER=elasticsearch\n+ ES_GROUP=elasticsearch\n+ ES_HOME=/usr/share/elasticsearch\n+ MAX_OPEN_FILES=65536\n+ LOG_DIR=/var/log/elasticsearch\n+ DATA_DIR=/var/lib/elasticsearch\n+ CONF_DIR=/etc/elasticsearch\n+ MAX_MAP_COUNT=262144\n+ PID_DIR=/var/run/elasticsearch\n+ [ -f /etc/default/elasticsearch ]\n+ . /etc/default/elasticsearch\n+ ES_HEAP_SIZE=1024m\n+ MAX_LOCKED_MEMORY=unlimited\n+ [ ! -z  ]\n+ PID_FILE=/var/run/elasticsearch/elasticsearch.pid\n+ DAEMON=/usr/share/elasticsearch/bin/elasticsearch\n+ DAEMON_OPTS=-d -p /var/run/elasticsearch/elasticsearch.pid --default.path.home=/usr/share/elasticsearch --default.path.logs=/var/log/elasticsearch --default.path.data=/var/lib/elasticsearch --default.path.conf=/etc/elasticsearch\n+ export ES_HEAP_SIZE\n+ export ES_HEAP_NEWSIZE\n+ export ES_DIRECT_SIZE\n+ export ES_JAVA_OPTS\n+ export ES_GC_LOG_FILE\n+ export JAVA_HOME\n+ export ES_INCLUDE\n+ test -x /usr/share/elasticsearch/bin/elasticsearch\n+ checkJava\n+ [ -x /bin/java ]\n+ which java\n+ JAVA=/usr/lib/java/bin/java\n+ [ ! -x /usr/lib/java/bin/java ]\n+ [ -n unlimited -a -z 1024m ]\n+ log_daemon_msg Starting Elasticsearch Server\n+ [ -z Starting Elasticsearch Server ]\n+ log_use_fancy_output\n+ TPUT=/usr/bin/tput\n+ EXPR=/usr/bin/expr\n+ [ -t 1 ]\n+ [ xxterm != x ]\n+ [ xxterm != xdumb ]\n+ [ -x /usr/bin/tput ]\n+ [ -x /usr/bin/expr ]\n+ /usr/bin/tput hpa 60\n+ /usr/bin/tput setaf 1\n+ [ -z ]\n+ FANCYTTY=1\n+ true\n+ /usr/bin/tput xenl\n+ /usr/bin/tput cols\n+ COLS=179\n+ [ 179 ]\n+ [ 179 -gt 6 ]\n+ /usr/bin/expr 179 - 7\n+ COL=172\n+ log_use_plymouth\n+ [ n = y ]\n+ plymouth --ping\n+ printf  * Starting Elasticsearch Server\n * Starting Elasticsearch Server       + /usr/bin/expr 179 - 1\n+ /usr/bin/tput hpa 178\n                                                                                                                                                                                  + printf\n + pidofproc -p /var/run/elasticsearch/elasticsearch.pid elasticsearch\n+ local pidfile base status specified pid OPTIND\n+ pidfile=\n+ specified=\n+ OPTIND=1\n+ getopts p: opt\n+ pidfile=/var/run/elasticsearch/elasticsearch.pid\n+ specified=specified\n+ getopts p: opt\n+ shift 2\n+ [ 1 -ne 1 ]\n+ base=elasticsearch\n+ [ ! specified ]\n+ [ -n /var/run/elasticsearch/elasticsearch.pid -a -r /var/run/elasticsearch/elasticsearch.pid ]\n+ read pid\n+ [ -n 9196 ]\n+ kill -0 9196\n+\n+ ps 9196\n+ return 1\n+ pid=\n+ [ -n  ]\n+ mkdir -p /var/log/elasticsearch /var/lib/elasticsearch\n+ chown elasticsearch:elasticsearch /var/log/elasticsearch /var/lib/elasticsearch\n+ [ -n /var/run/elasticsearch ]\n+ [ ! -e /var/run/elasticsearch ]\n+ [ -n /var/run/elasticsearch/elasticsearch.pid ]\n+ [ ! -e /var/run/elasticsearch/elasticsearch.pid ]\n+ [ -n 65536 ]\n+ ulimit -n 65536\n+ [ -n unlimited ]\n+ ulimit -l unlimited\n+ [ -n 262144 -a -f /proc/sys/vm/max_map_count ]\n+ sysctl -q -w vm.max_map_count=262144\n+ start-stop-daemon -d /usr/share/elasticsearch --start -b --user elasticsearch -c elasticsearch --pidfile /var/run/elasticsearch/elasticsearch.pid --exec /usr/share/elasticsearch/bin/elasticsearch -- -d -p /var/run/elasticsearch/elasticsearch.pid --default.path.home=/usr/share/elasticsearch --default.path.logs=/var/log/elasticsearch --default.path.data=/var/lib/elasticsearch --default.path.conf=/etc/elasticsearch\n+ return=0\n+ [ 0 -eq 0 ]\n+ i=0\n+ timeout=10\n+ sleep 1\n[...]\n```\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}