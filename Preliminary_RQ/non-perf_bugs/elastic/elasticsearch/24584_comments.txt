[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300555422","html_url":"https://github.com/elastic/elasticsearch/issues/24584#issuecomment-300555422","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24584","id":300555422,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDU1NTQyMg==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2017-05-10T17:30:47Z","updated_at":"2017-05-10T17:30:47Z","author_association":"MEMBER","body":"In case you are looking for another way to reproduce this:\r\n\r\n```\r\ngradle :qa:backwards-5.0:integTestRunner -Dtests.seed=1AD9A34C15808120 -Dtests.class=org.elasticsearch.backwards.IndexingIT -Dtests.method=\"testSeqNoCheckpoints\" -Dtests.security.manager=true -Dtests.locale=el-CY -Dtests.timezone=America/Chicago\r\n```\r\n\r\nreproduces the AssertionError every time for me","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300558394","html_url":"https://github.com/elastic/elasticsearch/issues/24584#issuecomment-300558394","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24584","id":300558394,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDU1ODM5NA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-05-10T17:38:52Z","updated_at":"2017-05-10T17:39:01Z","author_association":"MEMBER","body":"I have a seed `8EDEFF2FB626DA09` that I'm using for RelocationIT that reproduces it reliably for me.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300602815","html_url":"https://github.com/elastic/elasticsearch/issues/24584#issuecomment-300602815","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24584","id":300602815,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDYwMjgxNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-05-10T20:28:14Z","updated_at":"2017-05-10T20:28:14Z","author_association":"MEMBER","body":"Here's an explanation of what is happening:\r\n\r\n1. primary relocation is taking place\r\n\r\nthe cluster state looks like this:\r\n\r\n```\r\nversion: 8\r\nstate uuid: otVyR4vtSHudMtHuFANsNA\r\nfrom_diff: false\r\nmeta data version: 5\r\n   [test/yYo6C-u_QsmZUXhga1ZF8Q]: v[4]\r\n      0: p_term [1], isa_ids [OZ-wRD9hSPqdnjMpBx5G0Q]\r\nnodes: \r\n   {node_t0}{5aITFQiaRWuewPHxcH6JAg}{LQfasJgLSvGQNEwRlVZuzA}{127.0.0.1}{127.0.0.1:9400}, master\r\n   {node_t1}{rjWSeOQ9T92KbzoGaLXIlg}{yJlBzhGhS6mQLI4mP1a3Zg}{127.0.0.1}{127.0.0.1:9401}, local\r\nrouting_table (version 4):\r\n-- index [[test/yYo6C-u_QsmZUXhga1ZF8Q]]\r\n----shard_id [test][0]\r\n--------[test][0], node[5aITFQiaRWuewPHxcH6JAg], relocating [rjWSeOQ9T92KbzoGaLXIlg], [P], s[RELOCATING], a[id=OZ-wRD9hSPqdnjMpBx5G0Q, rId=7tew_CiPStWhpG7QaDOBcg], expected_shard_size[197]\r\n\r\nrouting_nodes:\r\n-----node_id[5aITFQiaRWuewPHxcH6JAg][V]\r\n--------[test][0], node[5aITFQiaRWuewPHxcH6JAg], relocating [rjWSeOQ9T92KbzoGaLXIlg], [P], s[RELOCATING], a[id=OZ-wRD9hSPqdnjMpBx5G0Q, rId=7tew_CiPStWhpG7QaDOBcg], expected_shard_size[197]\r\n-----node_id[rjWSeOQ9T92KbzoGaLXIlg][V]\r\n--------[test][0], node[rjWSeOQ9T92KbzoGaLXIlg], relocating [5aITFQiaRWuewPHxcH6JAg], [P], recovery_source[peer recovery], s[INITIALIZING], a[id=7tew_CiPStWhpG7QaDOBcg, rId=OZ-wRD9hSPqdnjMpBx5G0Q], expected_shard_size[197]\r\n---- unassigned\r\n```\r\n\r\n2. a new cluster state removing the relocation source arrives on relocation target who starts applying it:\r\n\r\n```\r\nversion: 9\r\nstate uuid: I_4joS0zS9aDYw8GfPGuRw\r\nfrom_diff: false\r\nmeta data version: 6\r\n   [test/yYo6C-u_QsmZUXhga1ZF8Q]: v[5]\r\n      0: p_term [1], isa_ids [7tew_CiPStWhpG7QaDOBcg]\r\nnodes: \r\n   {node_t0}{5aITFQiaRWuewPHxcH6JAg}{LQfasJgLSvGQNEwRlVZuzA}{127.0.0.1}{127.0.0.1:9400}, local, master\r\n   {node_t1}{rjWSeOQ9T92KbzoGaLXIlg}{yJlBzhGhS6mQLI4mP1a3Zg}{127.0.0.1}{127.0.0.1:9401}\r\nrouting_table (version 5):\r\n-- index [[test/yYo6C-u_QsmZUXhga1ZF8Q]]\r\n----shard_id [test][0]\r\n--------[test][0], node[rjWSeOQ9T92KbzoGaLXIlg], [P], s[STARTED], a[id=7tew_CiPStWhpG7QaDOBcg]\r\n\r\nrouting_nodes:\r\n-----node_id[5aITFQiaRWuewPHxcH6JAg][V]\r\n-----node_id[rjWSeOQ9T92KbzoGaLXIlg][V]\r\n--------[test][0], node[rjWSeOQ9T92KbzoGaLXIlg], [P], s[STARTED], a[id=7tew_CiPStWhpG7QaDOBcg]\r\n---- unassigned\r\n```\r\n\r\n3. in the course of applying that cluster state, the primary removes the relocation source from its in-sync IDs, the global checkpoint is now based only on the relocation target\r\n4. the relocation target is not yet done applying the cluster state\r\n5. an indexing request arrives, it can go to the relocation source or to the relocation target, either way it lands on the relocation target who has not yet finished applying the cluster state\r\n6. since the relocation target has not yet finished applying the cluster state, the relocation target will replicate this request to the relocation source\r\n7. remember, the relocation source is no longer in the in-sync IDs\r\n8. when the relocation target completes the indexing request locally, it advances its local checkpoint which advances the global checkpoint\r\n9. the replication request to the relocation source carries with it the now advanced global checkpoint\r\n10. the relocation source proceeds to update its knowledge of the global checkpoint based on the inlined global checkpoint from the replication request\r\n11. the global checkpoint has advanced past the local checkpoint on the relocation source, the assertion explodes\r\n\r\nLogs that support this hypothesis:\r\n\r\nIndexing request arrives on relocation source:\r\n\r\n```\r\n[2017-05-11T07:49:49,159][TRACE][o.e.a.b.TransportShardBulkAction] [node_t0] send action [indices:data/write/bulk[s][p]] to local primary [[test][0]][{node_t0}{5aITFQiaRWuewPHxcH6JAg}{LQfasJgLSvGQNEwRlVZuzA}{127.0.0.1}{127.0.0.1:9400}] for request [BulkShardRequest [[test][0]] containing [index {[test][type1][840], source[{\"test\":\"value840\",\"text\":\" êêêê ᗧᑠᗋᐄᙕᗶᑙᙘᑲ \\uD800\\uDFB3\\uD800\\uDFBB\\uD800\\uDFA5\\uD800\\uDFBE ⯻⮥⮃⯝⭘⬛⭄⮓⭋ ⅘ ℔ ê ᳯ᳢᳗᳸ ἯἨῼἡᾛ ģĞĉħĐĪŌ ⟵⟷⟴ ﹭﹢﹘﹢﹕﹕﹥ \\uDB8D\\uDE7C\",\"id\":840}]}]] with cluster state version [8] to [5aITFQiaRWuewPHxcH6JAg] \r\n```\r\n\r\nIndexing request is rerouted to relocation garget\r\n\r\n```\r\n[2017-05-11T07:49:49,160][TRACE][o.e.a.b.TransportShardBulkAction] [node_t1] [[test][0]] op [indices:data/write/bulk[s]] completed on primary for request [BulkShardRequest [[test][0]] containing [index {[test][type1][838], source[{\"test\":\"value838\",\"text\":\" êêê ⇤⇅⇨ ︩︡︢ Ǌ ⴮⴯ⴡⴛⴢⴀⴙⴜⴏⴋ ᦋᦾᦗ ၞာ ﶻﶩ \\uD809\\uDC76\\uD809\\uDC03\\uD809\\uDC5E\\uD809\\uDC68\\uD809\\uDC08\\uD809\\uDC1B\\uD809\\uDC1C\\uD809\\uDC19 ১ ㆕㆓㆝ ႆငအ႖ဋံကႀၮၘ ᏷ ▔▍▒▝▀▍▜ ⶷ⷊ \\uD802\\uDC0A\\uD802\\uDC11\",\"id\":838}]} and 1 more items]]\r\n```\r\n\r\nRelocation target executes the index operation acting as primary:\r\n\r\n```\r\n[2017-05-11T07:49:49,162][TRACE][o.e.i.s.IndexShard       ] [node_t1] [test][0] index [type1][840] (seq# [-2])\r\n```\r\n\r\nIt was in the middle of applying a new cluster state:\r\n\r\n```\r\n[2017-05-11T07:49:49,163][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.ingest.PipelineStore@556da757] with change to version [9]\r\n[2017-05-11T07:49:49,163][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.ingest.PipelineExecutionService@75d80884] with change to version [9]\r\n[2017-05-11T07:49:49,164][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.gateway.GatewayAllocator$$Lambda$1046/562476091@6472f09e] with change to version [9]\r\n[2017-05-11T07:49:49,164][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.repositories.RepositoriesService@d2d01f5] with change to version [9]\r\n[2017-05-11T07:49:49,164][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.action.ingest.IngestActionForwarder@35425818] with change to version [9]\r\n[2017-05-11T07:49:49,164][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.snapshots.RestoreService@6bfa1c] with change to version [9]\r\n[2017-05-11T07:49:49,164][TRACE][o.e.c.s.ClusterApplierService] [node_t1] calling [org.elasticsearch.tasks.TaskManager@73ee0c8f] with change to version [9]\r\n```\r\n\r\nIt can advance the global checkpoint because it is now only tracking one allocation ID (the relocation target, itself):\r\n\r\n```\r\n[2017-05-11T07:49:49,164][TRACE][o.e.i.s.GlobalCheckpointTracker] [node_t1] [test][0] global checkpoint updated to [839]\r\n```\r\n\r\nThe operation completes on the relocation target:\r\n\r\n```\r\n[2017-05-11T07:49:49,164][TRACE][o.e.a.b.TransportShardBulkAction] [node_t1] [[test][0]] op [indices:data/write/bulk[s]] completed on primary for request [BulkShardRequest [[test][0]] containing [index {[test][type1][840], source[{\"test\":\"value840\",\"text\":\" êêêê ᗧᑠᗋᐄᙕᗶᑙᙘᑲ \\uD800\\uDFB3\\uD800\\uDFBB\\uD800\\uDFA5\\uD800\\uDFBE ⯻⮥⮃⯝⭘⬛⭄⮓⭋ ⅘ ℔ ê ᳯ᳢᳗᳸ ἯἨῼἡᾛ ģĞĉħĐĪŌ ⟵⟷⟴ ﹭﹢﹘﹢﹕﹕﹥ \\uDB8D\\uDE7C\",\"id\":840}]}]]\r\n```\r\n\r\nThe relocation target sends the request to the relocation source:\r\n\r\n```\r\n[2017-05-11T07:49:49,166][TRACE][o.e.a.b.TransportShardBulkAction] [node_t1] [[test][0]] sending op [indices:data/write/bulk[s]] to replica [test][0], node[5aITFQiaRWuewPHxcH6JAg], relocating [rjWSeOQ9T92KbzoGaLXIlg], [P], s[RELOCATING], a[id=OZ-wRD9hSPqdnjMpBx5G0Q, rId=7tew_CiPStWhpG7QaDOBcg], expected_shard_size[197] for request [BulkShardRequest [[test][0]] containing [index {[test][type1][840], source[{\"test\":\"value840\",\"text\":\" êêêê ᗧᑠᗋᐄᙕᗶᑙᙘᑲ \\uD800\\uDFB3\\uD800\\uDFBB\\uD800\\uDFA5\\uD800\\uDFBE ⯻⮥⮃⯝⭘⬛⭄⮓⭋ ⅘ ℔ ê ᳯ᳢᳗᳸ ἯἨῼἡᾛ ģĞĉħĐĪŌ ⟵⟷⟴ ﹭﹢﹘﹢﹕﹕﹥ \\uDB8D\\uDE7C\",\"id\":840}]}]]\r\n```\r\n\r\nConfirmation that the relocation target is no longer tracking the relocation source:\r\n\r\n```\r\n[2017-05-11T07:49:49,167][TRACE][o.e.i.s.GlobalCheckpointTracker] [node_t1] [test][0] ignored local checkpoint [838] of [OZ-wRD9hSPqdnjMpBx5G0Q], allocation ID is not tracked\r\n```\r\n\r\nAnd now the assertion can explode:\r\n\r\n```\r\n[2017-05-11T07:49:49,167][TRACE][o.e.i.s.IndexShard       ] [node_t0] [test][0] expected recovery stage [TRANSLOG] but was [DONE], global checkpoint [839], local checkpoint [838]\r\n```\r\n\r\nI will discuss with @bleskes and @ywelsch the situation here, but for now this assertion has to go.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300602882","html_url":"https://github.com/elastic/elasticsearch/issues/24584#issuecomment-300602882","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24584","id":300602882,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDYwMjg4Mg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-05-10T20:28:30Z","updated_at":"2017-05-10T20:28:30Z","author_association":"MEMBER","body":"Closed by fbf532a626935b70da005fffdd8e5a14f5e97739","performed_via_github_app":null}]