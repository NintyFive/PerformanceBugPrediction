{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5828","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5828/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5828/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5828/events","html_url":"https://github.com/elastic/elasticsearch/issues/5828","id":31634717,"node_id":"MDU6SXNzdWUzMTYzNDcxNw==","number":5828,"title":"index corruption through delete_by_query of child documents","user":{"login":"morus","id":400031,"node_id":"MDQ6VXNlcjQwMDAzMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/400031?v=4","gravatar_id":"","url":"https://api.github.com/users/morus","html_url":"https://github.com/morus","followers_url":"https://api.github.com/users/morus/followers","following_url":"https://api.github.com/users/morus/following{/other_user}","gists_url":"https://api.github.com/users/morus/gists{/gist_id}","starred_url":"https://api.github.com/users/morus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/morus/subscriptions","organizations_url":"https://api.github.com/users/morus/orgs","repos_url":"https://api.github.com/users/morus/repos","events_url":"https://api.github.com/users/morus/events{/privacy}","received_events_url":"https://api.github.com/users/morus/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2014-04-16T11:50:35Z","updated_at":"2014-08-26T21:50:20Z","closed_at":"2014-04-28T13:13:30Z","author_association":"NONE","active_lock_reason":null,"body":"we experienced index corruption (indices having UNASSIGNED shards)\nduring incremental indexing.\n\nThe index contains one main document type and three other document\ntypes for child documents.\n\nThe corruption is related to delete by query requests for the child\ndocuments.\nWe had cases where the index was recovered on ES restart and cases \nwhere ES could not fix the index any more. This might be related to\nthe number of replicas (in cases where recovery worked we only had\none index copy on one instance) but we did not do an exhaustive \nanalysis on that.\n\nAfter we changed the delete by query requests into a client side\ndelete by query (search the child documents, send bulk requests for\ndelete by document id then) the issues stopped.\n\nElastic search version is 1.0.2, client operates through the ruby\nbindings using http (should not matter). OS is linux, the index\nhad 6 shards, ~ 12 mio documents (1.7 mio \"main\" documents,\nthe rest is child documents of three different types) in ~ 7.3GB.\nThe server has 16 GB memory, ES runs with 8 GB heap memory and \n65535 file descriptors.\n\nSorry, we could not try ES 1.1 because of an error regarding empty\ngeo points (seems to be fixed in master but not released).\n\nPart of the problem might be, that we are not too strict to ensure\nreferential integrity between parent and child documents.\nMy - perhaps naive - expectation was, that this should not matter. \nSo there might be child documents naming a parent, where the\nparent document does not exist.\n\nWhen we ran the incremental updates on a partial index containing\nonly a handful of documents (while the incremental stream was on\nchanges in all data) the issue did not show up.\nSo it's either related to the index size or (more probably (?)) to \nthe question if the delete by query finds something to delete or not.\n\nWe only had one process working on the updates strictly sequential.\nSo it should not be a race condition between serveral changes the same\ntime. There were parallel updates to other indices though.\n\nThe error itself is not too enlightening (at least for a pure\nes user): the indexer dies from a http timeout in an indexing request.\n\nThe ES log shows an error stating\nfailed to merge\nand\norg.apache.lucene.store.AlreadyClosedException: this IndexReader is closed\nsee full stack trace below.\nRaising ES log level to debug did not provide additional information,\nwhy the index reader was closed.\n\nI'm afraid I cannot provide a full sample, how to reproduce the\nproblem.\n\nbest\n  Morus\n\nPS:\nThe initial error messages look like\n[WARN ][index.merge.scheduler    ] [pjpp-production mas\nter] [candidates_v0004][5] failed to merge\norg.apache.lucene.store.AlreadyClosedException: this IndexReader is closed\n        at org.apache.lucene.index.IndexReader.ensureOpen(IndexReader.java:252)\n        at org.apache.lucene.index.CompositeReader.getContext(CompositeReader.ja\nva:102)\n        at org.apache.lucene.index.CompositeReader.getContext(CompositeReader.ja\nva:56)\n        at org.apache.lucene.index.IndexReader.leaves(IndexReader.java:502)\n        at org.elasticsearch.index.search.child.DeleteByQueryWrappingFilter.cont\nains(DeleteByQueryWrappingFilter.java:122)\n        at org.elasticsearch.index.search.child.DeleteByQueryWrappingFilter.getD\nocIdSet(DeleteByQueryWrappingFilter.java:81)\n        at org.elasticsearch.common.lucene.search.ApplyAcceptedDocsFilter.getDoc\nIdSet(ApplyAcceptedDocsFilter.java:45)\n        at org.apache.lucene.search.ConstantScoreQuery$ConstantWeight.scorer(Con\nstantScoreQuery.java:142)\n        at org.apache.lucene.search.FilteredQuery$RandomAccessFilterStrategy.fil\nteredScorer(FilteredQuery.java:533)\n        at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:13\n3)\n        at org.apache.lucene.search.QueryWrapperFilter$1.iterator(QueryWrapperFi\nlter.java:59)\n        at org.apache.lucene.index.BufferedUpdatesStream.applyQueryDeletes(Buffe\nredUpdatesStream.java:546)\n        at org.apache.lucene.index.BufferedUpdatesStream.applyDeletesAndUpdates(\nBufferedUpdatesStream.java:284)\n        at org.apache.lucene.index.IndexWriter._mergeInit(IndexWriter.java:3844)\n        at org.apache.lucene.index.IndexWriter.mergeInit(IndexWriter.java:3806)\n        at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3659)\n        at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMe\nrgeScheduler.java:405)\n        at org.apache.lucene.index.TrackingConcurrentMergeScheduler.doMerge(Trac\nkingConcurrentMergeScheduler.java:107)\n        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(Conc\nurrentMergeScheduler.java:482)\n[WARN ][index.engine.internal    ] [pjpp-production mas\nter] [candidates_v0004][5] failed engine\norg.apache.lucene.index.MergePolicy$MergeException: org.apache.lucene.store.Alre\nadyClosedException: this IndexReader is closed\n        at org.elasticsearch.index.merge.scheduler.ConcurrentMergeSchedulerProvi\nder$CustomConcurrentMergeScheduler.handleMergeException(ConcurrentMergeScheduler\nProvider.java:109)\n        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(Conc\nurrentMergeScheduler.java:518)\nCaused by: org.apache.lucene.store.AlreadyClosedException: this IndexReader is closed\n        at org.apache.lucene.index.IndexReader.ensureOpen(IndexReader.java:252)\n        at org.apache.lucene.index.CompositeReader.getContext(CompositeReader.java:102)\n        at org.apache.lucene.index.CompositeReader.getContext(CompositeReader.java:56)\n        at org.apache.lucene.index.IndexReader.leaves(IndexReader.java:502)\n        at org.elasticsearch.index.search.child.DeleteByQueryWrappingFilter.contains(DeleteByQueryWrappingFilter.java:122)\n        at org.elasticsearch.index.search.child.DeleteByQueryWrappingFilter.getDocIdSet(DeleteByQueryWrappingFilter.java:81)\n        at org.elasticsearch.common.lucene.search.ApplyAcceptedDocsFilter.getDocIdSet(ApplyAcceptedDocsFilter.java:45)\n        at org.apache.lucene.search.ConstantScoreQuery$ConstantWeight.scorer(ConstantScoreQuery.java:142)\n        at org.apache.lucene.search.FilteredQuery$RandomAccessFilterStrategy.filteredScorer(FilteredQuery.java:533)\n        at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:133)\n        at org.apache.lucene.search.QueryWrapperFilter$1.iterator(QueryWrapperFilter.java:59)\n        at org.apache.lucene.index.BufferedUpdatesStream.applyQueryDeletes(BufferedUpdatesStream.java:546)\n        at org.apache.lucene.index.BufferedUpdatesStream.applyDeletesAndUpdates(BufferedUpdatesStream.java:284)\n        at org.apache.lucene.index.IndexWriter._mergeInit(IndexWriter.java:3844)\n        at org.apache.lucene.index.IndexWriter.mergeInit(IndexWriter.java:3806)\n        at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3659)\n        at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:405)\n        at org.apache.lucene.index.TrackingConcurrentMergeScheduler.doMerge(TrackingConcurrentMergeScheduler.java:107)\n        at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:482)\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}