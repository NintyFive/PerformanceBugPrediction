[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/407709352","html_url":"https://github.com/elastic/elasticsearch/issues/32358#issuecomment-407709352","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358","id":407709352,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNzcwOTM1Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-25T10:28:15Z","updated_at":"2018-07-25T10:28:15Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410675182","html_url":"https://github.com/elastic/elasticsearch/issues/32358#issuecomment-410675182","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358","id":410675182,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDY3NTE4Mg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-08-06T11:17:44Z","updated_at":"2018-08-06T11:19:32Z","author_association":"CONTRIBUTOR","body":"I looked into this. `RecoveryFromGatewayIT#testRecoveryDifferentNodeOrderStartup` starts two nodes, one after the other, and then stops them one after the other in the same order. It's the second `stopRandomNode` call that fails, in the process of updating `minimum_master_nodes` (from 1 to 1, a no-op update). The stopping of the first node causes the second node to elect itself as master which, as far as I can tell, happens concurrently with the settings update. The `MasterNotDiscoveredException` exception here is thrown from `TransportMasterNodeAction.AsyncSingleAction.retry` which indicates that something failed during the settings update, causing a retry, but then the retry doesn't fire when the cluster state is updated, and eventually it times out.\r\n\r\nThe logs from between the call to stopRandomNode() and the timeout are fairly sparse:\r\n\r\n```\r\n  1> [2018-07-25T20:25:22,550][INFO ][o.e.t.InternalTestCluster] Closing filtered random node [node_t1] \r\n  1> [2018-07-25T20:25:25,532][INFO ][o.e.c.s.MasterService    ] [node_t1] zen-disco-elected-as-master ([0] nodes joined)[, ], reason: new_master {node_t1}{gEOhkCThQWW4H0xiigwMGw}{amlOqG1bQDeNdGY50XOV1A}{127.0.0.1}{127.0.0.1:36908}\r\n  1> [2018-07-25T20:25:25,533][WARN ][o.e.d.z.PublishClusterStateAction] [node_t1] publishing cluster state with version [13] failed for the following nodes: [[{node_t0}{7e7GNnI5ROy2fs_BATut1A}{yD2oWXSOS5SiG2Uwij1qKQ}{127.0.0.1}{127.0.0.1:34419}]]\r\n  1> [2018-07-25T20:25:25,533][INFO ][o.e.c.s.ClusterApplierService] [node_t1] new_master {node_t1}{gEOhkCThQWW4H0xiigwMGw}{amlOqG1bQDeNdGY50XOV1A}{127.0.0.1}{127.0.0.1:36908}, reason: apply cluster state (from master [master {node_t1}{gEOhkCThQWW4H0xiigwMGw}{amlOqG1bQDeNdGY50XOV1A}{127.0.0.1}{127.0.0.1:36908} committed version [13] source [zen-disco-elected-as-master ([0] nodes joined)[, ]]])\r\n  1> [2018-07-25T20:25:52,552][INFO ][o.e.g.RecoveryFromGatewayIT] [RecoveryFromGatewayIT#testRecoveryDifferentNodeOrderStartup]: cleaning up after test\r\n```\r\n\r\nI tried sleeping in various positions to try and see if I could find a race here but could not. I will enable some more detailed logging and wait for the next occurrence.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410964574","html_url":"https://github.com/elastic/elasticsearch/issues/32358#issuecomment-410964574","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358","id":410964574,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDk2NDU3NA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-08-07T07:40:41Z","updated_at":"2018-08-07T07:40:41Z","author_association":"CONTRIBUTOR","body":"I've had a quick look at the logs. This is actually duplicates #32552. What's happening is that the current master node is shut down, which results in a cluster state update on the remaining node to elect itself as master. That new master will publish a cluster state update that contains both itself and the node that went down (we only remove the previous master node in a follow-up cluster state update task). The cluster state update task that elects the new master (and still has the two nodes in it) takes more than 30 seconds to be applied on the remaining node, because it tries to reestablish a connection to the shut down node, reflected in the following two log lines:\r\n\r\n```\r\n[2018-07-25T20:25:58,431][WARN ][o.e.c.NodeConnectionsService] [node_t1] failed to connect to node {node_t0}{7e7GNnI5ROy2fs_BATut1A}{yD2oWXSOS5SiG2Uwij1qKQ}{127.0.0.1}{127.0.0.1:34419} (tried [1] times)\r\n\r\n[2018-07-25T20:25:58,433][WARN ][o.e.c.s.ClusterApplierService] [node_t1] cluster state applier task [apply cluster state (from master [master {node_t1}{gEOhkCThQWW4H0xiigwMGw}{amlOqG1bQDeNdGY50XOV1A}{127.0.0.1}{127.0.0.1:36908} committed version [13] source [zen-disco-elected-as-master ([0] nodes joined)[, ]]])] took [32.9s] above the warn threshold of 30s\r\n```\r\n\r\nThis results in the queued settings update task to time out.","performed_via_github_app":null}]