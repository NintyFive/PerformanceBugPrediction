{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22306","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22306/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22306/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22306/events","html_url":"https://github.com/elastic/elasticsearch/issues/22306","id":196954813,"node_id":"MDU6SXNzdWUxOTY5NTQ4MTM=","number":22306,"title":"Support for eu-west-2 (London) cloud-aws plugin","user":{"login":"nicpalmer","id":8338333,"node_id":"MDQ6VXNlcjgzMzgzMzM=","avatar_url":"https://avatars2.githubusercontent.com/u/8338333?v=4","gravatar_id":"","url":"https://api.github.com/users/nicpalmer","html_url":"https://github.com/nicpalmer","followers_url":"https://api.github.com/users/nicpalmer/followers","following_url":"https://api.github.com/users/nicpalmer/following{/other_user}","gists_url":"https://api.github.com/users/nicpalmer/gists{/gist_id}","starred_url":"https://api.github.com/users/nicpalmer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicpalmer/subscriptions","organizations_url":"https://api.github.com/users/nicpalmer/orgs","repos_url":"https://api.github.com/users/nicpalmer/repos","events_url":"https://api.github.com/users/nicpalmer/events{/privacy}","received_events_url":"https://api.github.com/users/nicpalmer/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-12-21T15:06:05Z","updated_at":"2018-02-14T13:56:33Z","closed_at":"2016-12-21T16:02:13Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n\r\n**Elasticsearch version**: All\r\n\r\n**Plugins installed**: [discovery-ec2]\r\n\r\n**JVM version**: JDK8\r\n\r\n**OS version**: Docker (Alpine)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIt is a reasonable expectation that all AWS regions be usable with the cloud-aws plugins. \r\n\r\nCurrently the new eu-west-2 region is not supported and errors with the following:\r\n\r\n```bash\r\n[2016-12-21 10:48:34,342][DEBUG][http.netty               ] [Hydro-Man] using max_chunk_size[8kb], max_header_size[8kb], max_initial_line_length[4kb], max_content_length[100mb], receive_predictor[512kb->512kb], pipelining[true], pipelining_max_events[10000]\r\n[2016-12-21 10:48:34,370][DEBUG][indices.recovery         ] [Hydro-Man] using max_bytes_per_sec[40mb], concurrent_streams [3], file_chunk_size [512kb], translog_size [512kb], translog_ops [1000], and compress [true]\r\n[2016-12-21 10:48:34,378][DEBUG][indices.store            ] [Hydro-Man] using indices.store.throttle.type [NONE], with index.store.throttle.max_bytes_per_sec [10gb]\r\n[2016-12-21 10:48:34,379][DEBUG][indices.memory           ] [Hydro-Man] using indexing buffer size [100.7mb], with indices.memory.min_shard_index_buffer_size [4mb], indices.memory.max_shard_index_buffer_size [512mb], indices.memory.shard_inactive_time [5m], indices.memory.interval [30s]\r\n[2016-12-21 10:48:34,385][DEBUG][indices.cache.query      ] [Hydro-Man] using [node] query cache with size [10%], actual_size [100.7mb], max filter count [1000]\r\n[2016-12-21 10:48:34,393][DEBUG][indices.fielddata.cache  ] [Hydro-Man] using size [-1] [-1b]\r\nException in thread \"main\" java.lang.IllegalArgumentException: No automatic endpoint could be derived from region [eu-west-2]\r\n\tat org.elasticsearch.cloud.aws.AwsEc2ServiceImpl.client(AwsEc2ServiceImpl.java:198)\r\n\tat org.elasticsearch.discovery.ec2.AwsEc2UnicastHostsProvider.<init>(AwsEc2UnicastHostsProvider.java:75)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n\tat java.lang.reflect.Constructor.newInstance(Constructor.java:423)\r\n\tat <<<guice>>>\r\n\tat org.elasticsearch.node.Node.<init>(Node.java:213)\r\n\tat org.elasticsearch.node.Node.<init>(Node.java:140)\r\n\tat org.elasticsearch.node.NodeBuilder.build(NodeBuilder.java:143)\r\n\tat org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:178)\r\n\tat org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:270)\r\n\tat org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:35)\r\n```\r\n\r\n**Steps to reproduce**:\r\n 1. Set the cloud.aws.region value in the `elasticsearch.yml` config file to `eu-west-2`. \r\n 2. Start the cluster\r\n 3. Follow log and see error\r\n\r\n**Relevant files**:\r\n`elasticsearch.yml`\r\n\r\n```yaml\r\n#Network host \r\nnetwork.host: 0.0.0.0\r\nnetwork.publish_host: _ec2_\r\n\r\n# AWS Discovery\r\ncloud.aws.region: eu-west-2\r\ncloud.aws.access_key: <ACCESS KEY>\r\ncloud.aws.secret_key: <SECRET KEY>\r\ndiscovery.type: ec2\r\ndiscovery.zen.minimum_master_nodes: 2\r\n```\r\n\r\nFrom my limited understanding of Java and the elasticsearch code base; I believe that the following change should fix the issues I am experiencing and am happy to raise a PR. \r\nI have ran the test suite against my local repo with this change and did not receive any failures. With some guidance I'd like to compile everything and do some proper testing. \r\n\r\n```java\r\n    protected static String findEndpoint(Logger logger, Settings settings) {\r\n        String endpoint = null;\r\n        if (CLOUD_EC2.ENDPOINT_SETTING.exists(settings)) {\r\n            endpoint = CLOUD_EC2.ENDPOINT_SETTING.get(settings);\r\n            logger.debug(\"using explicit ec2 endpoint [{}]\", endpoint);\r\n        } else if (REGION_SETTING.exists(settings) || CLOUD_EC2.REGION_SETTING.exists(settings)) {\r\n            final String region = CLOUD_EC2.REGION_SETTING.get(settings);\r\n            switch (region) {\r\n                case \"us-east-1\":\r\n                case \"us-east\":\r\n                    endpoint = \"ec2.us-east-1.amazonaws.com\";\r\n                    break;\r\n                case \"us-east-2\":\r\n                    endpoint = \"ec2.us-east-2.amazonaws.com\";\r\n                    break;\r\n                case \"us-west\":\r\n                case \"us-west-1\":\r\n                    endpoint = \"ec2.us-west-1.amazonaws.com\";\r\n                    break;\r\n                case \"us-west-2\":\r\n                    endpoint = \"ec2.us-west-2.amazonaws.com\";\r\n                    break;\r\n                case \"ap-southeast\":\r\n                case \"ap-southeast-1\":\r\n                    endpoint = \"ec2.ap-southeast-1.amazonaws.com\";\r\n                    break;\r\n                case \"ap-south\":\r\n                case \"ap-south-1\":\r\n                    endpoint = \"ec2.ap-south-1.amazonaws.com\";\r\n                    break;\r\n                case \"us-gov-west\":\r\n                case \"us-gov-west-1\":\r\n                    endpoint = \"ec2.us-gov-west-1.amazonaws.com\";\r\n                    break;\r\n                case \"ap-southeast-2\":\r\n                    endpoint = \"ec2.ap-southeast-2.amazonaws.com\";\r\n                    break;\r\n                case \"ap-northeast\":\r\n                case \"ap-northeast-1\":\r\n                    endpoint = \"ec2.ap-northeast-1.amazonaws.com\";\r\n                    break;\r\n                case \"ap-northeast-2\":\r\n                    endpoint = \"ec2.ap-northeast-2.amazonaws.com\";\r\n                    break;\r\n                case \"eu-west\":\r\n                case \"eu-west-1\":\r\n                    endpoint = \"ec2.eu-west-1.amazonaws.com\";\r\n                    break;\r\n                case \"eu-west-2\":\r\n                    endpoint = \"ec2.eu-west-2.amazonaws.com\";\r\n                    break;\r\n                case \"eu-central\":\r\n                case \"eu-central-1\":\r\n                    endpoint = \"ec2.eu-central-1.amazonaws.com\";\r\n                    break;\r\n                case \"sa-east\":\r\n                case \"sa-east-1\":\r\n                    endpoint = \"ec2.sa-east-1.amazonaws.com\";\r\n                    break;\r\n                case \"cn-north\":\r\n                case \"cn-north-1\":\r\n                    endpoint = \"ec2.cn-north-1.amazonaws.com.cn\";\r\n                    break;\r\n                default:\r\n                    throw new IllegalArgumentException(\"No automatic endpoint could be derived from region [\" + region + \"]\");\r\n            }\r\n            logger.debug(\"using ec2 region [{}], with endpoint [{}]\", region, endpoint);\r\n        }\r\n        return endpoint;\r\n    }\r\n```\r\n\r\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}