{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31732","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31732/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31732/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31732/events","html_url":"https://github.com/elastic/elasticsearch/issues/31732","id":337523299,"node_id":"MDU6SXNzdWUzMzc1MjMyOTk=","number":31732,"title":"Take action to stop the temporary directory being deleted due to lack of use","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-07-02T13:39:49Z","updated_at":"2018-08-07T15:59:57Z","closed_at":"2018-08-07T15:59:57Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Since #27609 Elasticsearch defaults to a per-run temporary directory.  On Linux this is a directory created by the startup script under `/tmp`.\r\n\r\nLinux `systemd` has functionality that can remove files and directories from `/tmp` that have not been used for a certain length of time.  This functionality is described in `man tmpfiles.d`.\r\n\r\nRHEL and CentOS 7 ship with a configuration for this functionality in `/usr/lib/tmpfiles.d/tmp.conf` that deletes files and directories that have not been touched for 10 days:\r\n\r\n```\r\nv /tmp 1777 root root 10d\r\n```\r\n\r\n(Note: If you read the man page you might think this _doesn't_ delete old files, as the man page says:\r\n\r\n>       The age field only applies to lines starting with d, D, and x. If omitted or set to \"-\", no automatic clean-up is done.\r\n\r\nHowever, the man page is wrong.  Cleanup by age also applies to other configuration entries, including v.  There are 7 letters it applies to in the code: https://github.com/systemd/systemd/blob/2479c4fe3fc3d0b631b93debbc2a83aa40a5f379/src/tmpfiles/tmpfiles.c#L1904\r\n\r\nv is `CREATE_SUBVOLUME` in that `switch`.)\r\n\r\nCurrently the only part of Elasticsearch that uses `java.io.tmpdir` more than a few seconds after startup is ML.  As a result, if someone does not start an ML job on a particular node that is running on RHEL or CentOS 7 then 10 days after ES startup the temporary directory is removed by `tmpfiles.d` functionality.  If an ML job is run on the node after this then it fails because the temporary directory does not exist.\r\n\r\nDue to security manager the ES JVM cannot recreate the temporary directory.  Therefore the best solution would seem to be to periodically create and remove a file in the temporary directory.  If we created and removed a file every 22 hours then this would keep the directory modification time within the last day, even for days when daylight saving time starting reduces the day length to 23 hours.  So this would keep the directory alive even for a user who configured `tmpfiles.d` to clean after 1 day.\r\n\r\nSince ML is currently the only affected component this periodic touching of the temporary directory could be done in the ML code.  However, this problem could also affect 3rd party plugins that use `java.io.tmpdir`, so it would be nicer if the functionality to keep the temporary directory alive was in core Elasticsearch.  The ML team can implement it if we can get some advice on the best place in the code to put it.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}