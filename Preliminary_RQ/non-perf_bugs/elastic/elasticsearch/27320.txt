{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27320","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27320/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27320/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27320/events","html_url":"https://github.com/elastic/elasticsearch/issues/27320","id":272213093,"node_id":"MDU6SXNzdWUyNzIyMTMwOTM=","number":27320,"title":"Bug with _termvectors query on a field contains normalizer","user":{"login":"deveArt","id":20946161,"node_id":"MDQ6VXNlcjIwOTQ2MTYx","avatar_url":"https://avatars3.githubusercontent.com/u/20946161?v=4","gravatar_id":"","url":"https://api.github.com/users/deveArt","html_url":"https://github.com/deveArt","followers_url":"https://api.github.com/users/deveArt/followers","following_url":"https://api.github.com/users/deveArt/following{/other_user}","gists_url":"https://api.github.com/users/deveArt/gists{/gist_id}","starred_url":"https://api.github.com/users/deveArt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/deveArt/subscriptions","organizations_url":"https://api.github.com/users/deveArt/orgs","repos_url":"https://api.github.com/users/deveArt/repos","events_url":"https://api.github.com/users/deveArt/events{/privacy}","received_events_url":"https://api.github.com/users/deveArt/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2017-11-08T14:15:02Z","updated_at":"2018-02-14T13:44:04Z","closed_at":"2017-12-04T20:32:16Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version**: 5.6.2\r\n\r\n**Plugins installed**: x-pack\r\n\r\n**JVM version**: 1.8.0_144\r\n\r\n**OS version**: Linux centos7 3.10.0-327.28.3.el7.x86_64\r\n\r\n**Description**: \r\n\r\nI used custom normalizer with some char_filter and lowercase filter. And when I perfom search with sorting I see that it is actually works! But I don't see any changes in terms via _termvectors query by my normalized field.\r\n\r\nMy current index setting:\r\n```\r\nPUT tender-search\r\n{\r\n  \"settings\": {\r\n    \"number_of_replicas\": 0,\r\n    \"index.mapping.single_type\": true,\r\n    \"analysis\": {\r\n      \"char_filter\": {\r\n        \"garbage_filter\": {\r\n          \"type\": \"pattern_replace\",\r\n          \"pattern\": \"^([^\\\\p{L}\\\\d]+)(.*)\",\r\n          \"replacement\": \"$2\"\r\n        },\r\n        \"ua_sort_filter\": {\r\n          \"type\": \"mapping\",\r\n          \"mappings\": [\r\n            \"і => ия\",\r\n            \"І => ИЯ\",\r\n            \"є => ея\",\r\n            \"Є => ЕЯ\",\r\n            \"ґ => гя\",\r\n            \"Ґ => ГЯ\"\r\n          ]\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"default\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"default_search\": {\r\n          \"type\": \"standard\"\r\n        }\r\n      },\r\n      \"normalizer\": {\r\n        \"title_clean\": {\r\n          \"type\": \"custom\",\r\n          \"char_filter\": [\"garbage_filter\", \"ua_sort_filter\"],\r\n          \"filter\": [\"lowercase\"]\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"tenderSearch\": {\r\n      \"properties\": {\r\n        \"title\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"standard\",\r\n          \"fields\": {\r\n            \"raw\": {\r\n              \"type\": \"keyword\",\r\n              \"normalizer\": \"title_clean\"\r\n            }\r\n          }\r\n        },\r\n        \"description\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"standard\"\r\n        },\r\n        \"procuringEntityName\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"standard\",\r\n          \"fields\": {\r\n            \"raw\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"amount\": {\r\n          \"type\": \"double\"\r\n        },\r\n        \"lots\": {\r\n          \"properties\": {\r\n            \"amount\": {\r\n              \"type\": \"double\"\r\n            },\r\n            \"title\": {\r\n              \"type\": \"text\",\r\n              \"analyzer\": \"standard\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI make _termvectors query for newely created document:\r\n\r\n```\r\nGET tender-search/tenderSearch/d9669b3b22dd4a11ae581b31a5802a13/_termvectors\r\n{\r\n  \"fields\" : [\"title.raw\"],\r\n  \"offsets\" : true,\r\n  \"payloads\" : true,\r\n  \"positions\" : true,\r\n  \"term_statistics\" : true,\r\n  \"field_statistics\" : true\r\n}\r\n```\r\n\r\nAnd I'm getting the response:\r\n\r\n```\r\n{\r\n  \"_index\": \"tender-search\",\r\n  \"_type\": \"tenderSearch\",\r\n  \"_id\": \"d9669b3b22dd4a11ae581b31a5802a13\",\r\n  \"_version\": 4,\r\n  \"found\": true,\r\n  \"took\": 0,\r\n  \"term_vectors\": {\r\n    \"title.raw\": {\r\n      \"field_statistics\": {\r\n        \"sum_doc_freq\": 30201,\r\n        \"doc_count\": 30201,\r\n        \"sum_ttf\": -1\r\n      },\r\n      \"terms\": {\r\n        \"[ТЕСТУВАННЯ] Займати біда з неціновими показниками викот робак.\": {\r\n          \"term_freq\": 1,\r\n          \"tokens\": [\r\n            {\r\n              \"position\": 0,\r\n              \"start_offset\": 0,\r\n              \"end_offset\": 63\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nBut when I test title_clean normalizer with:\r\n\r\n```\r\nGET tender-search/_analyze \r\n{\r\n  \"field\": \"title.raw\", \r\n  \"text\":  \"[ТЕСТУВАННЯ] Займати біда з неціновими показниками викот робак.\"\r\n}\r\n```\r\n\r\nI'm getting the response which is that I expected to see in terms above:\r\n\r\n```\r\n{\r\n  \"tokens\": [\r\n    {\r\n      \"token\": \"тестування] займати бияда з нецияновими показниками викот робак.\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 63,\r\n      \"type\": \"word\",\r\n      \"position\": 0\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nIt's a bug report of this issue: https://discuss.elastic.co/t/using-normalizer-for-sorting/106704/4?u=arturklb","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}