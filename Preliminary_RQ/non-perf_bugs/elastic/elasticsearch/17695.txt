{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17695","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17695/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17695/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17695/events","html_url":"https://github.com/elastic/elasticsearch/issues/17695","id":147889808,"node_id":"MDU6SXNzdWUxNDc4ODk4MDg=","number":17695,"title":"Shadow Replica indexes do not delete properly","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2016-04-12T22:16:10Z","updated_at":"2017-09-22T15:47:39Z","closed_at":"2017-09-22T15:47:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This issue is to document deletion problems with shadow replica indices that were found while working on #17265.  A separate PR #17638 that improves the naming of methods in the `IndicesService` also contains tests or added assertions to existing tests that reveal the issues below and must be enabled as part of any PR that fixes the issues.\n\n**No. 1**\nThe index file deletion logic that is triggered in `IndicesService#deleteIndexStore(String reason, Index index, IndexSettings indexSettings` checks before deleting files to see if the index is not a shadow replica, or if it is, ensure that it has been closed before (so that no other nodes are holding resources to it).  An issue with this is that it is too strict of a check, so that if a shadow replica index is deleted, if it was not previously closed, the index folder itself is not deleted and remains on the file system (an empty folder).   So one of the issues that needs fixing is to ensure index directories are deleted even on shadow replica index deletes.  The following tests have commented out assertions to test this behavior once fixed:\n- `IndexWithShadowReplicaIT#testIndexWithShadowReplicasCleansUp` \n- `IndexWithShadowReplicaIT#testShadowReplicaNaturalRelocation` \n\nNote that shared shard data is cleaned up properly in a shadow replica index that is not closed, as the shard data is deleted by the `StoreCloseListener`.  This is verified in the tests with the `assertPathHasBeenCleared` assert.\n\n**No. 2**\nThe issue with deleting a shadow replica index that was previously closed is that all of the index and shard data are potentially deleted simultaneously by each node that receives the delete operation and invokes `NodeEnvironment#deleteIndexDirectorySafe`.  This can lead to race conditions where a node is trying to delete a file that was deleted by another node as both are walking the file system simultaneously (using Lucene's `IOUtils.rm`).  This ends up logged as a warning in `IndicesService#deleteIndexStore(String reason, Index index, IndexSettings indexSettings` and the deletion is put on the pending queue.  \n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}