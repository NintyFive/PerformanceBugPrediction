[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/313293749","html_url":"https://github.com/elastic/elasticsearch/issues/25555#issuecomment-313293749","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25555","id":313293749,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMzI5Mzc0OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-07-06T04:45:07Z","updated_at":"2017-07-06T04:46:35Z","author_association":"MEMBER","body":"## It's a bug\r\n\r\nThanks, the bug affects only the default `shingle` filter so the workaround is to force a custom `shingle` filter in the mapping and use it instead.\r\nThe following restores the 2.x behavior:\r\n\r\n````\r\nPUT brand\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"filter\": {\r\n    \t\"my_shingle\": {\r\n        \t\"type\": \"shingle\"\r\n    \t}\r\n      },\r\n      \"analyzer\": {\r\n        \"my_analyzer_keyword\": {\r\n          \"type\": \"custom\",\r\n          \"tokenizer\": \"keyword\",\r\n          \"filter\": [\r\n            \"asciifolding\",\r\n            \"lowercase\"\r\n          ]\r\n        },\r\n        \"my_analyzer_shingle\": {\r\n          \"type\": \"custom\",\r\n          \"tokenizer\": \"standard\",\r\n          \"filter\": [\r\n            \"asciifolding\",\r\n            \"lowercase\",\r\n            \"my_shingle\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"brand\": {\r\n      \"properties\": {\r\n        \"keyword\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"my_analyzer_keyword\",\r\n          \"search_analyzer\": \"my_analyzer_shingle\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n`````\r\n\r\n## The default setting for the `shingle` filter are not sane\r\n\r\nThough this issue hides a bigger problem,  `shingles` of different size should not be mixed in the same field.\r\nIn 5.3 we introduced graph analysis at query time and this reveals this kind of problem where users are mixing unigrams and bi-grams on the same field (totally not your fault though since this is the default ;) ). \r\nThen in 5.3.1 we restored the old behavior automatically for analyzer that defines a graph `shingle` filter but this fix has not been applied to the already registered default `shingle` filter.\r\nSo I think we should also remove the ability to create such fields in 6, which means changing the default to not output unigrams and replace `min_gram`, `max_gram` with `gram_size`.\r\nWe discussed this is FixItFriday some times ago but I did not had time to work on it.\r\n\r\nI'll work on a fix for 5.x (we should also disable graph analysis for the already registered default shingle filter) and I'll open a new issue if needed for 6.\r\nIn the mean time you can use the work around described or try another approach with two queries, one that search for bi-grams and one for unigram. In your case you don't even have to reindex since the goal is to find exact matches in the document from partial queries.","performed_via_github_app":null}]