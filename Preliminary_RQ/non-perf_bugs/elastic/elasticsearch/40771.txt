{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40771","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40771/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40771/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40771/events","html_url":"https://github.com/elastic/elasticsearch/issues/40771","id":428681850,"node_id":"MDU6SXNzdWU0Mjg2ODE4NTA=","number":40771,"title":"Rollover action fails when user has index privilege only on alias","user":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"assignees":[{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-04-03T10:12:32Z","updated_at":"2019-04-16T08:29:14Z","closed_at":"2019-04-16T08:29:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.6.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRollover action fails with unauthorized access when the user does \r\nnot have access to concrete index but only to alias.\r\n\r\nIn `TransportRolloverAction` before doing rollover we resolve\r\nsource index name (write index) from the alias in the rollover request..\r\nBefore evaluating the conditions and executing rollover action, we\r\nretrieve stats, but to do so we used the source index name\r\nresolved from the alias instead of what is in the request.\r\nhttps://github.com/elastic/elasticsearch/blob/fcc715818fc1b9b13c5b76c8c7b86e5b5ed2f42e/server/src/main/java/org/elasticsearch/action/admin/indices/rollover/TransportRolloverAction.java#L111-L123\r\n**Expected behavior:**\r\nThe rollover action should succeed.\r\n\r\n**Actual behavior:**\r\nFails with \r\n```\r\naction [indices:monitor/stats] is unauthorized for user [ufoo]\r\n```\r\n\r\n**Steps to reproduce**:\r\n- Create an index with alias\r\n```\r\nPUT /foo-index-00001 '{ \"aliases\" : { \"foo_alias\" : {} } }'\r\n```\r\n- Create a user with a role\r\n```\r\nPUT /_xpack/security/user/ufoo '{ \"password\": \"foobar\", \"roles\" : [ \"foo_role\" ]  }'\r\n\r\nPUT /_xpack/security/role/foo_role '{ \"cluster\": [ \"all\" ], \"indices\": [ { \"names\": [\"foo_alias\"], \"privileges\": [\"all\"] } ] }'\r\n```\r\n- Index some documents using created user (`ufoo`)\r\n```\r\nPOST /foo_alias/_doc '{ \"field\" : \"foo\" }'\r\nPOST /foo_alias/_doc '{ \"field\" : \"foo\" }'\r\n```\r\n- try rollover\r\n```\r\nPOST /foo_alias/_rollover '{ \"conditions\": { \"max_docs\": 1 } }'\r\n```","closed_by":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"performed_via_github_app":null}