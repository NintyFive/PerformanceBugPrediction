{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19707","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19707/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19707/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19707/events","html_url":"https://github.com/elastic/elasticsearch/issues/19707","id":168504898,"node_id":"MDU6SXNzdWUxNjg1MDQ4OTg=","number":19707,"title":"Reopening issue #19657: ES 2.3.4: same query being run several times","user":{"login":"doron-logzio","id":20183290,"node_id":"MDQ6VXNlcjIwMTgzMjkw","avatar_url":"https://avatars3.githubusercontent.com/u/20183290?v=4","gravatar_id":"","url":"https://api.github.com/users/doron-logzio","html_url":"https://github.com/doron-logzio","followers_url":"https://api.github.com/users/doron-logzio/followers","following_url":"https://api.github.com/users/doron-logzio/following{/other_user}","gists_url":"https://api.github.com/users/doron-logzio/gists{/gist_id}","starred_url":"https://api.github.com/users/doron-logzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/doron-logzio/subscriptions","organizations_url":"https://api.github.com/users/doron-logzio/orgs","repos_url":"https://api.github.com/users/doron-logzio/repos","events_url":"https://api.github.com/users/doron-logzio/events{/privacy}","received_events_url":"https://api.github.com/users/doron-logzio/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-07-31T06:44:46Z","updated_at":"2016-07-31T15:08:32Z","closed_at":"2016-07-31T15:08:32Z","author_association":"NONE","active_lock_reason":null,"body":"Thanks for your response however:\n\nAs stated there are only two shards per node (one of them even a replica of _another_ index) and still I get 3(!!!) slowquery logs.\n\nWould there be any other possible reason?\n\nElasticsearch version: 2.3.4\n\nJVM version: 1.7.0_101\n\nOS version: Ubuntu 14.04\n\nDescription of the problem including expected versus actual behavior:\n\nOur setup is as follows:\nAn index over 11 nodes each of them holding 2 shards one primary and one replica (not of the same shard).\nWhen running a slow query of search_type QUERY_THEN_FETCH and looking at the elasticsearch slow query logs we see that on each of the nodes we are getting 3 calls of the exact same query with timestamps miliseconds apart.\nWe were wondering whether this is a \"feature\" of the slow query logging or whether there are really 3 distinct calls of the same query performed on the index and if the latter, what would be an explanation for this.\n\nThe query we are running is:\n{\"index\":[\"index-****************_\"],\"search_type\":\"count\",\"ignore_unavailable\":true}\n{\"size\":0,\"aggs\":{\"2\":{\"date_histogram\":{\"field\":\"@timestamp\",\"interval\":\"30m\",\"time_zone\":\"+03:00\",\"min_doc_count\":1,\"extended_bounds\":{\"min\":1469318400000,\"max\":1469393384478}},\"aggs\":{\"3\":{\"terms\":{\"field\":\"level\",\"size\":5,\"order\":{\"_count\":\"desc\"}}}}}},\"query\":{\"filtered\":{\"query\":{\"query_string\":{\"analyze_wildcard\":true,\"query\":\"\"}},\"filter\":{\"bool\":{\"must\":[{\"query\":{\"match\":{\"type\":{\"query\":\"mainlog\",\"type\":\"phrase\"}}}},{\"range\":{\"@timestamp\":{\"gte\":1469318400000,\"lte\":1469393384478}}}],\"must_not\":[]}}}},\"highlight\":{\"pre_tags\":[\"@kibana-highlighted-field@\"],\"post_tags\":[\"@/kibana-highlighted-field@\"],\"fields\":{\"_\":{}},\"fragment_size\":2147483647}}\n\nAnd the slow query log (after some processing on our end) is:\n[2016-07-28 07:53:00,561][INFO ][index.search.slowlog.query] [index-****************_]took[5.2s], took_millis[5209], types[], stats[], search_type[QUERY_THEN_FETCH], total_shards[11], source[{\"size\":0,\"aggs\":{\"2\":{\"date_histogram\":{\"field\":\"@timestamp\",\"interval\":\"30m\",\"time_zone\":\"+03:00\",\"min_doc_count\":1,\"extended_bounds\":{\"min\":1469318400000,\"max\":1469393384478}},\"aggs\":{\"3\":{\"terms\":{\"field\":\"level\",\"size\":5,\"order\":{\"_count\":\"desc\"}}}}}},\"query\":{\"filtered\":{\"query\":{\"query_string\":{\"analyze_wildcard\":true,\"query\":\"\"}},\"filter\":{\"bool\":{\"must\":[{\"query\":{\"match\":{\"type\":{\"query\":\"mainlog\",\"type\":\"phrase\"}}}},{\"range\":{\"@timestamp\":{\"gte\":1469318400000,\"lte\":1469393384478}}}],\"must_not\":[]}}}},\"highlight\":{\"pre_tags\":[\"@kibana-highlighted-field@\"],\"post_tags\":[\"@/kibana-highlighted-field@\"],\"fields\":{\"_\":{}},\"fragment_size\":2147483647}}], extra_source[],\n\n(the other two instances are exactly the same with a slight variance on the time taken)\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}