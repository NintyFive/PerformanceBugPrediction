[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48050382","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-48050382","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":48050382,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MDUwMzgy","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2014-07-04T14:29:58Z","updated_at":"2014-07-04T14:29:58Z","author_association":"MEMBER","body":"Did you see any error in your logs? I quickly tried out a mvel script in a script filter and that works out.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48173497","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-48173497","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":48173497,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MTczNDk3","user":{"login":"petchema","id":1211431,"node_id":"MDQ6VXNlcjEyMTE0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/1211431?v=4","gravatar_id":"","url":"https://api.github.com/users/petchema","html_url":"https://github.com/petchema","followers_url":"https://api.github.com/users/petchema/followers","following_url":"https://api.github.com/users/petchema/following{/other_user}","gists_url":"https://api.github.com/users/petchema/gists{/gist_id}","starred_url":"https://api.github.com/users/petchema/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petchema/subscriptions","organizations_url":"https://api.github.com/users/petchema/orgs","repos_url":"https://api.github.com/users/petchema/repos","events_url":"https://api.github.com/users/petchema/events{/privacy}","received_events_url":"https://api.github.com/users/petchema/received_events","type":"User","site_admin":false},"created_at":"2014-07-07T12:47:29Z","updated_at":"2014-07-07T12:47:29Z","author_association":"NONE","body":"No, there's nothing in the logs.\n\nWe switched to native scripting after some issues implementing the same logic with mvel scripts; Again it works for searching, but not for percolation (NullPointerException this time):\n\ncurl -XPOST 'http://localhost:9200/index1/mytype/_search' -d '{\n  \"filter\": {\n    \"script\": {\n      \"script\": \"foreach (String value : _source[field]) { boolean ok = true; foreach (String word: words) { if (!value.contains(word)) { ok = false; }} if (ok) return true; } return false;\",\n      \"params\": {\n        \"field\": \"source_field\",\n        \"words\": [\n          \"a\"\n        ]\n      }\n    }\n  }\n}'\nResult:\n{\"took\":4,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":4,\"failed\":1,\"failures\":[{\"index\":\"index1\",\"shard\":0,\"status\":500,\"reason\":\"QueryPhaseExecutionException[[index1][0]: query[ConstantScore(cache(_type:mytype))],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: NullPointerException; \"}]},\"hits\":{\"total\":1,\"max_score\":1.0,\"hits\":[{\"_index\":\"index1\",\"_type\":\"mytype\",\"_id\":\"9I9u4oh0SomkXvzaM-KmEg\",\"_score\":1.0,\"_source\":{\n  \"source_field\" : [ \"this a that\" ]\n}}]}}\n\ncurl -XPUT \"http://localhost:9200/index1/.percolator/1\" -d '{\n  \"query\": {\n    \"constant_score\": {\n      \"filter\": {\n    \"script\": {\n      \"script\": \"foreach (String value : _source[field]) { boolean ok = true; foreach (String word: words) { if (!value.contains(word)) { ok = false; }} if (ok) return true; } return false;\",\n      \"params\": {\n            \"field\": \"source_field\",\n        \"words\": [\"a\"]\n      },\n          \"lang\": \"mvel\"\n    }\n      }\n    }\n  }\n}'\n\ncurl -XPOST \"http://localhost:9200/index1/mytype/_percolate\" -d '\n{\n  \"doc\" : {\n    \"source_field\" : [ \"this a that\" ]\n  }\n}'\nResult:\n{\"took\":3,\"_shards\":{\"total\":5,\"successful\":4,\"failed\":1,\"failures\":[{\"index\":\"index1\",\"shard\":2,\"reason\":\"BroadcastShardOperationFailedException[[index1][2] ]; nested: PercolateException[failed to percolate]; nested: PercolateException[failed to execute]; nested: NullPointerException; \"}]},\"total\":0,\"matches\":[]}\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48174033","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-48174033","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":48174033,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MTc0MDMz","user":{"login":"petchema","id":1211431,"node_id":"MDQ6VXNlcjEyMTE0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/1211431?v=4","gravatar_id":"","url":"https://api.github.com/users/petchema","html_url":"https://github.com/petchema","followers_url":"https://api.github.com/users/petchema/followers","following_url":"https://api.github.com/users/petchema/following{/other_user}","gists_url":"https://api.github.com/users/petchema/gists{/gist_id}","starred_url":"https://api.github.com/users/petchema/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petchema/subscriptions","organizations_url":"https://api.github.com/users/petchema/orgs","repos_url":"https://api.github.com/users/petchema/repos","events_url":"https://api.github.com/users/petchema/events{/privacy}","received_events_url":"https://api.github.com/users/petchema/received_events","type":"User","site_admin":false},"created_at":"2014-07-07T12:53:16Z","updated_at":"2014-07-07T12:53:16Z","author_association":"NONE","body":"Log for the latter:\n[2014-07-07 14:46:08,561][DEBUG][action.percolate         ] [Greer Grant Nelson] [index1][2], node[XkBXnyiRSZ6UhEoEDnXpHg], [P], s[STARTED]: failed to executed [org.elasticsearch.action.percolate.PercolateRequest@2d7281bf]\norg.elasticsearch.percolator.PercolateException: failed to percolate\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:198)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:55)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction$1.run(TransportBroadcastOperationAction.java:170)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:724)\nCaused by: org.elasticsearch.percolator.PercolateException: failed to execute\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:551)\n    at org.elasticsearch.percolator.PercolatorService.percolate(PercolatorService.java:233)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:194)\n    ... 5 more\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.common.mvel2.ast.ForEachNode.getReducedValueAccelerated(ForEachNode.java:109)\n    at org.elasticsearch.common.mvel2.MVELRuntime.execute(MVELRuntime.java:86)\n    at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getDirectValue(CompiledExpression.java:123)\n    at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getValue(CompiledExpression.java:119)\n    at org.elasticsearch.script.mvel.MvelScriptEngineService$MvelSearchScript.run(MvelScriptEngineService.java:196)\n    at org.elasticsearch.index.query.ScriptFilterParser$ScriptFilter$ScriptDocSet.matchDoc(ScriptFilterParser.java:184)\n    at org.elasticsearch.common.lucene.docset.MatchDocIdSet$NoAcceptDocsIterator.nextDoc(MatchDocIdSet.java:96)\n    at org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.nextDoc(ConstantScoreQuery.java:257)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:184)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163)\n    at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:309)\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:548)\n    ... 7 more\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/49271134","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-49271134","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":49271134,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MjcxMTM0","user":{"login":"petchema","id":1211431,"node_id":"MDQ6VXNlcjEyMTE0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/1211431?v=4","gravatar_id":"","url":"https://api.github.com/users/petchema","html_url":"https://github.com/petchema","followers_url":"https://api.github.com/users/petchema/followers","following_url":"https://api.github.com/users/petchema/following{/other_user}","gists_url":"https://api.github.com/users/petchema/gists{/gist_id}","starred_url":"https://api.github.com/users/petchema/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petchema/subscriptions","organizations_url":"https://api.github.com/users/petchema/orgs","repos_url":"https://api.github.com/users/petchema/repos","events_url":"https://api.github.com/users/petchema/events{/privacy}","received_events_url":"https://api.github.com/users/petchema/received_events","type":"User","site_admin":false},"created_at":"2014-07-17T08:13:13Z","updated_at":"2014-07-17T08:13:13Z","author_association":"NONE","body":"Up?\nCan you reproduce the issue?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/52472254","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-52472254","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":52472254,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNDcyMjU0","user":{"login":"petchema","id":1211431,"node_id":"MDQ6VXNlcjEyMTE0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/1211431?v=4","gravatar_id":"","url":"https://api.github.com/users/petchema","html_url":"https://github.com/petchema","followers_url":"https://api.github.com/users/petchema/followers","following_url":"https://api.github.com/users/petchema/following{/other_user}","gists_url":"https://api.github.com/users/petchema/gists{/gist_id}","starred_url":"https://api.github.com/users/petchema/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petchema/subscriptions","organizations_url":"https://api.github.com/users/petchema/orgs","repos_url":"https://api.github.com/users/petchema/repos","events_url":"https://api.github.com/users/petchema/events{/privacy}","received_events_url":"https://api.github.com/users/petchema/received_events","type":"User","site_admin":false},"created_at":"2014-08-18T09:57:06Z","updated_at":"2014-08-18T09:57:06Z","author_association":"NONE","body":"Anything else I can try?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/52584013","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-52584013","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":52584013,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTg0MDEz","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2014-08-19T02:46:26Z","updated_at":"2014-08-19T02:46:26Z","author_association":"MEMBER","body":"@petchema as a workaround you can try adding mapping for `source_field` as `not_analyzed` field and then access it using `_doc[field].values` instead of `_source[field]`.\n\n`_source` seems to be populated only if highlighting is [turned on](https://github.com/elasticsearch/elasticsearch/blob/master/src/main/java/org/elasticsearch/percolator/PercolatorService.java#L350) and even then there seem to be some issues accessing it through source lookup. Not really sure how to address this issue. We can extract and populate source every time for every record, but this will slow everything down. Alternatively, we can add some kind of `add_source` flag or replace source lookup with some lazy loading version. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/52941061","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-52941061","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":52941061,"node_id":"MDEyOklzc3VlQ29tbWVudDUyOTQxMDYx","user":{"login":"petchema","id":1211431,"node_id":"MDQ6VXNlcjEyMTE0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/1211431?v=4","gravatar_id":"","url":"https://api.github.com/users/petchema","html_url":"https://github.com/petchema","followers_url":"https://api.github.com/users/petchema/followers","following_url":"https://api.github.com/users/petchema/following{/other_user}","gists_url":"https://api.github.com/users/petchema/gists{/gist_id}","starred_url":"https://api.github.com/users/petchema/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petchema/subscriptions","organizations_url":"https://api.github.com/users/petchema/orgs","repos_url":"https://api.github.com/users/petchema/repos","events_url":"https://api.github.com/users/petchema/events{/privacy}","received_events_url":"https://api.github.com/users/petchema/received_events","type":"User","site_admin":false},"created_at":"2014-08-21T15:57:32Z","updated_at":"2014-08-21T15:57:32Z","author_association":"NONE","body":"Thanks, tests using this workaround seem to work fine, we need more tests to see if they're any drawbacks or limitations for our needs but we're making progress.\nRegards,\nPierre.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/158656994","html_url":"https://github.com/elastic/elasticsearch/issues/6709#issuecomment-158656994","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6709","id":158656994,"node_id":"MDEyOklzc3VlQ29tbWVudDE1ODY1Njk5NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-21T15:49:21Z","updated_at":"2015-11-21T15:49:21Z","author_association":"CONTRIBUTOR","body":"Accessing the `_source` in a percolator is a really bad idea, for performance (and thus cluster stability) reasons.  Closing\n","performed_via_github_app":null}]