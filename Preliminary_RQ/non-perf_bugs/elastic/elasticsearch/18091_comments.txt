[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216478088","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-216478088","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":216478088,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjQ3ODA4OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-03T09:29:54Z","updated_at":"2016-05-03T09:29:54Z","author_association":"CONTRIBUTOR","body":"@martijnvg could you take a look at this please?\n\n@mattweber any chance you could add the test you're running?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216521679","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-216521679","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":216521679,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjUyMTY3OQ==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2016-05-03T13:09:28Z","updated_at":"2016-05-03T13:09:28Z","author_association":"CONTRIBUTOR","body":"@clintongormley It has some code that belongs to a client I am working with so I can't post it directly.  I will work on writing an isolated test that essentially does the same thing though.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216574412","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-216574412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":216574412,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjU3NDQxMg==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2016-05-03T15:54:23Z","updated_at":"2016-05-03T15:54:23Z","author_association":"CONTRIBUTOR","body":"@clintongormley @martijnvg \n\nhttps://gist.github.com/mattweber/19c37d9b8a01fd305afa782bc38f9d2f\n\nHere is a quick and dirty test.  Add this file as `core/src/test/java/org/elasticsearch/search/innerhits/InnerHitsIssueIT.java` to a checkout of the 2.2 branch.  The test failure reproduces for me consistently with:\n\n`mvn clean verify -Pdev -Dskip.unit.tests -pl org.elasticsearch:elasticsearch -Dtests.seed=C293056A17C37DCE -Dtests.class=org.elasticsearch.search.innerhits.InnerHitsIssueIT -Dtests.method=\"testIssue18091\" -Des.logger.level=ERROR -Dtests.assertion.disabled=false -Dtests.security.manager=true -Dtests.heap.size=512m -Dtests.locale=sv_SE -Dtests.timezone=Portugal`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216601388","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-216601388","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":216601388,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjYwMTM4OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-03T17:18:54Z","updated_at":"2016-05-03T17:18:54Z","author_association":"CONTRIBUTOR","body":"thanks @mattweber \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216711053","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-216711053","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":216711053,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjcxMTA1Mw==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2016-05-04T00:44:17Z","updated_at":"2016-05-04T00:44:37Z","author_association":"CONTRIBUTOR","body":"Reproducible against `2.x` with following:\n\n`mvn verify -Pdev -Dskip.unit.tests -pl org.elasticsearch:elasticsearch -Dtests.seed=7AA0546C9A7151D7 -Dtests.class=org.elasticsearch.search.innerhits.InnerHitsIssueIT -Dtests.method=\"testIssue18091\" -Des.logger.level=ERROR -Dtests.assertion.disabled=false -Dtests.security.manager=true -Dtests.heap.size=512m -Dtests.locale=mk -Dtests.timezone=Etc/GMT+9`\n\nSame test \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/216886145","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-216886145","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":216886145,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNjg4NjE0NQ==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2016-05-04T14:41:00Z","updated_at":"2016-05-04T14:41:00Z","author_association":"CONTRIBUTOR","body":"Also reproducible against current master (5.x) using the new multi-level inner hit functionality inside of the nested queries vs. a top-level request. \n\nHere is the test for master:\nhttps://gist.github.com/mattweber/578c77e1c5f148e13a3a9c238d169fea\n\nHere is my reproduce command:\n`gradle :core:integTest -Dtests.seed=98F2AB350B0F5BF2 -Dtests.class=org.elasticsearch.search.innerhits.InnerHitsIssueIT -Dtests.method=\"testIssue18091\" -Des.logger.level=WARN -Dtests.security.manager=true -Dtests.locale=zh-CN -Dtests.timezone=Etc/GMT-8`\n\nNote, I run this test in a loop until it fails.  It usually takes less than 5 runs before I hit the failure.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/219674357","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-219674357","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":219674357,"node_id":"MDEyOklzc3VlQ29tbWVudDIxOTY3NDM1Nw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-05-17T10:05:39Z","updated_at":"2016-05-17T10:05:39Z","author_association":"MEMBER","body":"@mattweber @clintongormley If I recall correctly during node to node serialization the `_index` key was not included for nested inner hits, since it isn't really needed, because the `_index` key is always the same as the parent search hit. The inconsistency here is that when search hits aren't serialized then the `_index` key is included. (which happens in test with a single node)\n\nI think the inconsistency should be fixed or the `_index` key should always be included in inner hits. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/226773954","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-226773954","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":226773954,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNjc3Mzk1NA==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2016-06-17T13:51:18Z","updated_at":"2016-06-17T13:51:18Z","author_association":"CONTRIBUTOR","body":"Thanks @martijnvg!  Is index/type/id even needed here?  It will always be the same as the parent document right?  Plus we have the `_nested` object that gives us the offsets inside source nested array.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/226821137","html_url":"https://github.com/elastic/elasticsearch/issues/18091#issuecomment-226821137","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18091","id":226821137,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNjgyMTEzNw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-06-17T16:48:20Z","updated_at":"2016-06-17T16:48:20Z","author_association":"MEMBER","body":"@mattweber I agree. index/type/id are not needed for nested inner hits.\n","performed_via_github_app":null}]