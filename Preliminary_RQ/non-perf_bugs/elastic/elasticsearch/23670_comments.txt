[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/288024099","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-288024099","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":288024099,"node_id":"MDEyOklzc3VlQ29tbWVudDI4ODAyNDA5OQ==","user":{"login":"sbocconi","id":3026280,"node_id":"MDQ6VXNlcjMwMjYyODA=","avatar_url":"https://avatars3.githubusercontent.com/u/3026280?v=4","gravatar_id":"","url":"https://api.github.com/users/sbocconi","html_url":"https://github.com/sbocconi","followers_url":"https://api.github.com/users/sbocconi/followers","following_url":"https://api.github.com/users/sbocconi/following{/other_user}","gists_url":"https://api.github.com/users/sbocconi/gists{/gist_id}","starred_url":"https://api.github.com/users/sbocconi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbocconi/subscriptions","organizations_url":"https://api.github.com/users/sbocconi/orgs","repos_url":"https://api.github.com/users/sbocconi/repos","events_url":"https://api.github.com/users/sbocconi/events{/privacy}","received_events_url":"https://api.github.com/users/sbocconi/received_events","type":"User","site_admin":false},"created_at":"2017-03-21T09:37:12Z","updated_at":"2017-03-21T09:37:12Z","author_association":"NONE","body":"Possibly related to #22786\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/288034133","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-288034133","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":288034133,"node_id":"MDEyOklzc3VlQ29tbWVudDI4ODAzNDEzMw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-21T10:18:11Z","updated_at":"2017-03-21T10:18:11Z","author_association":"MEMBER","body":"@nknize are you able to take a look at this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315890803","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-315890803","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":315890803,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTg5MDgwMw==","user":{"login":"sbocconi","id":3026280,"node_id":"MDQ6VXNlcjMwMjYyODA=","avatar_url":"https://avatars3.githubusercontent.com/u/3026280?v=4","gravatar_id":"","url":"https://api.github.com/users/sbocconi","html_url":"https://github.com/sbocconi","followers_url":"https://api.github.com/users/sbocconi/followers","following_url":"https://api.github.com/users/sbocconi/following{/other_user}","gists_url":"https://api.github.com/users/sbocconi/gists{/gist_id}","starred_url":"https://api.github.com/users/sbocconi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbocconi/subscriptions","organizations_url":"https://api.github.com/users/sbocconi/orgs","repos_url":"https://api.github.com/users/sbocconi/repos","events_url":"https://api.github.com/users/sbocconi/events{/privacy}","received_events_url":"https://api.github.com/users/sbocconi/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T21:30:21Z","updated_at":"2017-07-17T21:30:21Z","author_association":"NONE","body":"Any progress on this issue?\r\nThanks","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/318089966","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-318089966","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":318089966,"node_id":"MDEyOklzc3VlQ29tbWVudDMxODA4OTk2Ng==","user":{"login":"aj7","id":136886,"node_id":"MDQ6VXNlcjEzNjg4Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/136886?v=4","gravatar_id":"","url":"https://api.github.com/users/aj7","html_url":"https://github.com/aj7","followers_url":"https://api.github.com/users/aj7/followers","following_url":"https://api.github.com/users/aj7/following{/other_user}","gists_url":"https://api.github.com/users/aj7/gists{/gist_id}","starred_url":"https://api.github.com/users/aj7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aj7/subscriptions","organizations_url":"https://api.github.com/users/aj7/orgs","repos_url":"https://api.github.com/users/aj7/repos","events_url":"https://api.github.com/users/aj7/events{/privacy}","received_events_url":"https://api.github.com/users/aj7/received_events","type":"User","site_admin":false},"created_at":"2017-07-26T15:30:38Z","updated_at":"2018-12-14T09:27:50Z","author_association":"NONE","body":"we are getting quite a bit of 'array-out-of-bounds' error importing some geo-shape objects. Could it be that if the size is too big, then this becomes a problem? Any ideas please?\r\n```\r\n[2017-07-26T12:02:36,395][DEBUG][o.e.a.b.TransportShardBulkAction] [my_data_node] [my_index][4] failed to execute bulk item (index) BulkShardRequest [[my_index][4]] containing [index {[my_index][FeatureCollection][AV1-j4-ITghY5gkRJfoj], source[n/a, actual length: [4mb], max length: 2kb]}]\r\norg.elasticsearch.index.mapper.MapperParsingException: failed to parse [geometry]\r\n\tat org.elasticsearch.index.mapper.GeoShapeFieldMapper.parse(GeoShapeFieldMapper.java:473) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:450) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseObject(DocumentParser.java:467) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.innerParseObject(DocumentParser.java:383) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseObjectOrNested(DocumentParser.java:373) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.internalParseDocument(DocumentParser.java:93) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseDocument(DocumentParser.java:66) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:277) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.prepareIndex(IndexShard.java:536) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.prepareIndexOnPrimary(IndexShard.java:513) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.prepareIndexOperationOnPrimary(TransportShardBulkAction.java:450) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequestOnPrimary(TransportShardBulkAction.java:458) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:143) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:113) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:69) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:939) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:908) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:113) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:322) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:264) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:888) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:885) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShardOperationsLock.acquire(IndexShardOperationsLock.java:147) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationLock(IndexShard.java:1656) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryShardReference(TransportReplicationAction.java:897) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction.access$400(TransportReplicationAction.java:93) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:281) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:260) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:252) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:627) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException: -1\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.assign(PolygonBuilder.java:483) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.compose(PolygonBuilder.java:455) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.coordinates(PolygonBuilder.java:221) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.geo.builders.MultiPolygonBuilder.build(MultiPolygonBuilder.java:129) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.GeoShapeFieldMapper.parse(GeoShapeFieldMapper.java:455) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\t... 36 more\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/319506448","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-319506448","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":319506448,"node_id":"MDEyOklzc3VlQ29tbWVudDMxOTUwNjQ0OA==","user":{"login":"sbocconi","id":3026280,"node_id":"MDQ6VXNlcjMwMjYyODA=","avatar_url":"https://avatars3.githubusercontent.com/u/3026280?v=4","gravatar_id":"","url":"https://api.github.com/users/sbocconi","html_url":"https://github.com/sbocconi","followers_url":"https://api.github.com/users/sbocconi/followers","following_url":"https://api.github.com/users/sbocconi/following{/other_user}","gists_url":"https://api.github.com/users/sbocconi/gists{/gist_id}","starred_url":"https://api.github.com/users/sbocconi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sbocconi/subscriptions","organizations_url":"https://api.github.com/users/sbocconi/orgs","repos_url":"https://api.github.com/users/sbocconi/repos","events_url":"https://api.github.com/users/sbocconi/events{/privacy}","received_events_url":"https://api.github.com/users/sbocconi/received_events","type":"User","site_admin":false},"created_at":"2017-08-01T21:46:06Z","updated_at":"2017-08-01T21:46:06Z","author_association":"NONE","body":"Script and data to reproduce the problem:\r\n\r\ndata is [here](https://github.com/histograph/puppet-deploy/blob/master/bulk.ndjson)\r\nScript is [here](https://github.com/histograph/puppet-deploy/blob/master/testES.sh)\r\n\r\nRun the script in same dir as data, wait ~4.5 hours on a single node ES 32GB quad core.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/447277251","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-447277251","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":447277251,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NzI3NzI1MQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-12-14T10:05:30Z","updated_at":"2018-12-14T10:05:30Z","author_association":"MEMBER","body":"I was able to reproduce the issue on 6.4 and it is definitely unrelated to #25933 and #22786. The issues #25933 and #22786 were caused by a bug in the polygon parsing logic that couldn't handle malformed polygons with holes that were protruding out of the outer shell in a certain way and. These issues were fixed by #27685.\r\n\r\nIn this case the issue is caused by the shape of post-1948 Canada that at 10m precision produces a huge number of tokens that cannot be correctly handled by Lucene causing an ArrayOutOfBounds exception in ByteBlockPool most likely due to numeric overflow somewhere in [BytesRefHash](https://github.com/apache/lucene-solr/blob/be597a81ef516a8630f4488c011ddf66dda3c771/lucene/core/src/java/org/apache/lucene/util/BytesRefHash.java#L277). The exception is not handling gracefully and results in the engine failure that in turn causes the shard failure.\r\n\r\nI was able to shrink the reproduction [script](https://gist.github.com/imotov/328e234aa0cfe8ea7f2645fb5a68f672) in size and time required to reproduce the issue, but it still needs about 1 hour to generate enough tokens to cause the overflow on my machine.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448348459","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-448348459","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":448348459,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODM0ODQ1OQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-12-18T19:53:40Z","updated_at":"2018-12-18T19:53:40Z","author_association":"MEMBER","body":"So, just to see the impact of #36751 I indexed the same shape that was crashing the shard after 1h+ of the indexing time and it took 0.016 sec. I then modified the script in the original issue that was failing halfway after 4.5 hours of indexing and it took about 1 sec. I also ran the server with 1G instead of 16G that were required before.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448421981","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-448421981","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":448421981,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODQyMTk4MQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-12-19T00:20:21Z","updated_at":"2018-12-19T00:20:21Z","author_association":"MEMBER","body":"Opened [LUCENE-8614](https://issues.apache.org/jira/browse/LUCENE-8614)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448625140","html_url":"https://github.com/elastic/elasticsearch/issues/23670#issuecomment-448625140","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23670","id":448625140,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODYyNTE0MA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-12-19T15:00:11Z","updated_at":"2018-12-19T15:00:11Z","author_association":"MEMBER","body":"I don't think there is anything we can/should do to address this on the elasticsearch side. The short term solution would be to change the exception thrown by lucene so it doesn't cause unrecoverable engine failure and this will hopefully addressed by [LUCENE-8614](https://issues.apache.org/jira/browse/LUCENE-8614). The long term solution is #36751 and deprecation of quadtrees. So, I am going to close the issues.","performed_via_github_app":null}]