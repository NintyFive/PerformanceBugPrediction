{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36984","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36984/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36984/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36984/events","html_url":"https://github.com/elastic/elasticsearch/issues/36984","id":393986637,"node_id":"MDU6SXNzdWUzOTM5ODY2Mzc=","number":36984,"title":"[Elasticsearch Docs] Add clarification that `.security` index needs to be upgraded to `.security-6` index before upgrade the Elastic Stack from 5.6 to 6.x","user":{"login":"kunisen","id":30574753,"node_id":"MDQ6VXNlcjMwNTc0NzUz","avatar_url":"https://avatars2.githubusercontent.com/u/30574753?v=4","gravatar_id":"","url":"https://api.github.com/users/kunisen","html_url":"https://github.com/kunisen","followers_url":"https://api.github.com/users/kunisen/followers","following_url":"https://api.github.com/users/kunisen/following{/other_user}","gists_url":"https://api.github.com/users/kunisen/gists{/gist_id}","starred_url":"https://api.github.com/users/kunisen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kunisen/subscriptions","organizations_url":"https://api.github.com/users/kunisen/orgs","repos_url":"https://api.github.com/users/kunisen/repos","events_url":"https://api.github.com/users/kunisen/events{/privacy}","received_events_url":"https://api.github.com/users/kunisen/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-25T08:35:10Z","updated_at":"2019-01-09T16:14:24Z","closed_at":"2019-01-09T16:14:24Z","author_association":"NONE","active_lock_reason":null,"body":"Current Status\r\n---\r\n\r\nCurrently, we have the following statement to describe about upgrading internal indices.\r\n\r\n[1]\r\nhttps://www.elastic.co/guide/en/elastic-stack/6.5/upgrading-elastic-stack.html#upgrade-internal-indices\r\n```\r\nIf you are upgrading from a version prior to 5.6, you must upgrade them after after installing Elasticsearch 6.5.4.\r\n```\r\n\r\nIt only indicates the `version prior to 5.6`, but it didn't tell this includes `5.6` or not.\r\nTo say it clearly, it makes people think the version `before` (which means `less than <`) `5.6` needs upgraded, but the version `5.6` is safe and not need upgraded before upgrading Elastic Stack.\r\n\r\n[2]\r\nhttps://www.elastic.co/guide/en/elastic-stack-overview/6.5/security-auth-failure-upgrade.html\r\n```\r\nYou must upgrade the .security index to the 6.x format. For instructions, see Upgrading internal indices.\r\n\r\nThere are two situations where it’s necessary to manually upgrade the .security index:\r\n\r\n・After upgrading directly to 6.5.4 from 5.5 or earlier.\r\n・After restoring a snapshot from 5.5 or earlier that contains a .security index in the old format to a 6.0 cluster.\r\n```\r\n\r\nIt only indicates that `.security index of version 5.5` needs upgraded manually and it seems like `.security index of version 5.6` *does not need upgraded manually*.\r\n\r\nThe problem we encountered\r\n---\r\n\r\nIf we do not upgrade `.security` to `.security-6` before we upgrade the elasticsearch package itself, we will get the following error message and the new-version node cannot join the cluster.\r\nWe searched the document but didn't find anything officially documented.\r\n\r\n```\r\n[2018-12-20T03:51:57,435][INFO ][o.e.d.z.ZenDiscovery     ] [node3] failed to send join request to master [{node1}{nuKEosHfQiSEfY_oek5z_w}{OEYFHhINTZWzISxbHkSuIg}{10.146.0.10}{10.146.0.10:9300}{ml.max_open_jobs=10, ml.enabled=true}], reason [RemoteTransportException[[node1][10.146.0.10:9300][internal:discovery/zen/join]]; nested: IllegalStateException[failure when sending a validation request to node]; nested: RemoteTransportException[[node3][10.146.0.4:9300][internal:discovery/zen/join/validate]]; nested: IllegalStateException[Security index is not on the current version [6] - The Upgrade API must be run for 6.x nodes to join the cluster]; ]\r\n```\r\n\r\nWhat we concerned as the problem/cause\r\n---\r\n\r\n[a] The documentation about `.security` index upgrade is not clear, and can make confusion on the version different\r\n[b] There is no documentation described the above-mentioned error, which may lead confusion.\r\n\r\nFeature Request\r\n---\r\nWith the above said, could you please \r\n\r\n[i] Add some explicit description such as `.security index of any 5.x version needs to be upgraded before Elastic Stack upgrade`\r\n[ii] Add a page about the above mentioned `failed to send join request to master ...` error to **[Troubleshooting security](https://www.elastic.co/guide/en/elastic-stack-overview/6.5/security-troubleshooting.html)** page?\r\n\r\n","closed_by":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"performed_via_github_app":null}