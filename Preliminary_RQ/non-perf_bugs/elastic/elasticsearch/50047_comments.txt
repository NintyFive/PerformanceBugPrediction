[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/564160018","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-564160018","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":564160018,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NDE2MDAxOA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-12-10T18:08:52Z","updated_at":"2019-12-10T18:08:52Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/Distributed)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/564177733","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-564177733","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":564177733,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NDE3NzczMw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-12-10T18:50:43Z","updated_at":"2019-12-10T18:50:43Z","author_association":"MEMBER","body":"I can reproduce this locally, running this test in a loop eventually gets the JVM into a state where it completely locks up (as in not even a thread-dump can be taken) and then the test eventually fails. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/564543192","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-564543192","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":564543192,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NDU0MzE5Mg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-12-11T13:37:01Z","updated_at":"2019-12-11T13:37:01Z","author_association":"MEMBER","body":"The problem here is that we are randomly running into safe points that take multiple seconds when calling `suspend` on the thread:\r\n\r\n```\r\n[136.264s][debug  ][vmoperation             ] begin VM_Operation (0x00007f4aeaa576c0): ThreadDump, mode: safepoint, requested by thread 0x00007f4abc0e3800\r\n[136.264s][debug  ][vmoperation             ] end VM_Operation (0x00007f4aeaa576c0): ThreadDump, mode: safepoint, requested by thread 0x00007f4abc0e3800\r\n[136.264s][debug  ][safepoint,stats         ]  136.264: ThreadDump                    [                18                 0             0 ][             0       0       0       0       0 ]               0 \r\n[136.264s][info   ][safepoint               ] Leaving safepoint region\r\n[136.264s][info   ][safepoint               ] Total time for which application threads were stopped: 0.0002377 seconds, Stopping threads took: 0.0000023 seconds\r\n[136.264s][debug  ][thread,smr              ] tid=6164: SafeThreadsListPtr::acquire_stable_list: add nested list pointer to ThreadsList=0x00007f4abc004730\r\n[136.264s][debug  ][thread,smr              ] tid=6164: SafeThreadsListPtr::release_stable_list: delete nested list pointer to ThreadsList=0x00007f4abc004730\r\n[136.264s][debug  ][thread,smr              ] tid=6164: SafeThreadsListPtr::acquire_stable_list: add nested list pointer to ThreadsList=0x00007f4abc004730\r\n[142.645s][debug  ][vmthread                ] Adding VM operation: ThreadSuspend\r\n[142.645s][debug  ][vmthread                ] Evaluating safepoint VM operation: ThreadSuspend\r\n[142.645s][debug  ][safepoint               ] Safepoint synchronization initiated. (18 threads)\r\n[142.645s][info   ][safepoint               ] Application time: 6.3813087 seconds\r\n[142.645s][info   ][safepoint               ] Entering safepoint region: ThreadSuspend\r\n[142.645s][info   ][safepoint,cleanup       ] updating inline caches, 0.0000016 secs\r\n[142.645s][info   ][safepoint,cleanup       ] compilation policy safepoint handler, 0.0000006 secs\r\n[142.645s][info   ][safepoint,cleanup       ] deflating global idle monitors, 0.0000004 secs\r\n[142.645s][info   ][safepoint,cleanup       ] purging class loader data graph, 0.0000001 secs\r\n[142.645s][info   ][safepoint,cleanup       ] resizing system dictionaries, 0.0000008 secs\r\n[142.645s][info   ][safepoint,cleanup       ] deflating per-thread idle monitors, 0.0000044 secs\r\n[142.646s][info   ][safepoint,cleanup       ] safepoint cleanup tasks, 0.0002165 secs\r\n[142.646s][debug  ][vmoperation             ] begin VM_Operation (0x00007f4aeaa57710): ThreadSuspend, mode: safepoint, requested by thread 0x00007f4abc0e3800\r\n[142.646s][debug  ][vmoperation             ] end VM_Operation (0x00007f4aeaa57710): ThreadSuspend, mode: safepoint, requested by thread 0x00007f4abc0e3800\r\n[142.646s][debug  ][safepoint,stats         ]  142.645: ThreadSuspend                 [                18                 0             0 ][             0       0       0       0       0 ]               0 \r\n[142.646s][info   ][safepoint               ] Leaving safepoint region\r\n```\r\n\r\nThis looks a lot like the following JVM bug. https://bugs.openjdk.java.net/browse/JDK-8212933 that is supposed to be fixed in JDK 12 b13, but I can still reproduce it in b33. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571197437","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-571197437","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":571197437,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTE5NzQzNw==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-01-06T16:04:41Z","updated_at":"2020-01-06T16:04:41Z","author_association":"MEMBER","body":"Reopening... \r\n\r\n@original-brownbear the test fail on Java 8 (runtime, Java 13 build)\r\n\r\n\r\n```\r\njava.lang.RuntimeException: suspending node threads took too long\r\n\tat __randomizedtesting.SeedInfo.seed([59768ACBFC336E0F:5B65C274D81DD666]:0)\r\n\tat org.elasticsearch.test.disruption.LongGCDisruption.startDisrupting(LongGCDisruption.java:124)\r\n\tat org.elasticsearch.test.disruption.LongGCDisruptionTests.testNotBlockingUnsafeStackTraces(LongGCDisruptionTests.java:152)\r\n```\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+matrix-java-periodic/ES_BUILD_JAVA=openjdk13,ES_RUNTIME_JAVA=java8,nodes=general-purpose/433/console\r\nhttps://gradle-enterprise.elastic.co/s/mz54zhh4o5wfq\r\n\r\nAnd a few more found on build stats: \r\nhttps://gradle-enterprise.elastic.co/s/zpncey4ukuwgk\r\nhttps://gradle-enterprise.elastic.co/s/ag4cebu2jraju\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571212502","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-571212502","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":571212502,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTIxMjUwMg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-01-06T16:42:17Z","updated_at":"2020-01-06T16:42:17Z","author_association":"MEMBER","body":"Seems this is actually this issue https://bugs.openjdk.java.net/browse/JDK-8218446 for which the fix has been backed out again.\r\nIt's talking about the exact 6s waits I observed here as well in https://bugs.openjdk.java.net/browse/JDK-8218446?focusedCommentId=14251478&page=com.atlassian.jira.plugin.system.issuetabpanels%3Acomment-tabpanel#comment-14251478","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571215634","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-571215634","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":571215634,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTIxNTYzNA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-01-06T16:49:44Z","updated_at":"2020-01-06T16:49:44Z","author_association":"CONTRIBUTOR","body":"The above failure was on JDK8, not JDK13?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571547812","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-571547812","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":571547812,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTU0NzgxMg==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-01-07T11:26:00Z","updated_at":"2020-01-07T11:26:00Z","author_association":"CONTRIBUTOR","body":"failed again\r\nhttps://gradle-enterprise.elastic.co/s/p2c4a73pwq3js\r\n```\r\n./gradlew ':test:framework:test' --tests \"org.elasticsearch.test.disruption.LongGCDisruptionTests.testNotBlockingUnsafeStackTraces\" \\\r\n  -Dtests.seed=E32A05972B9EA548 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-KW \\\r\n  -Dtests.timezone=America/Argentina/Rio_Gallegos \\\r\n  -Dcompiler.java=13 \\\r\n  -Druntime.java=8\r\n```\r\nI wonder if the fix mentioned in comment https://github.com/elastic/elasticsearch/issues/50047#issuecomment-571212502 is aimed jdk13 only, we should try to disable the test for jdk8?\r\n@original-brownbear what do you think?  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571984480","html_url":"https://github.com/elastic/elasticsearch/issues/50047#issuecomment-571984480","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50047","id":571984480,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTk4NDQ4MA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-01-08T10:20:47Z","updated_at":"2020-01-08T10:20:47Z","author_association":"MEMBER","body":"@ywelsch \r\n\r\nright it's also happening on JDK-8 and 13 now ... 13 I'd expect because they backed out the fix for the linked issue but `8` is unexpected. \r\n\r\nI opened https://github.com/elastic/elasticsearch/pull/50731 to not fail the test if we run into blocked `Thread#suspend` but otherwise leave the test enabled as a suggested fix for this. If `8` fails for a different reason it should still fail and we can look into that then and we retain most of the coverage in general.","performed_via_github_app":null}]