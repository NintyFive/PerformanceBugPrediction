[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/311545747","html_url":"https://github.com/elastic/elasticsearch/issues/18629#issuecomment-311545747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18629","id":311545747,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMTU0NTc0Nw==","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2017-06-28T03:19:59Z","updated_at":"2017-06-28T03:19:59Z","author_association":"CONTRIBUTOR","body":"I'm looking into why 2.4 is recovering shards slowly and hot threads report:\r\n\r\n```\r\n::: {mynode}{MFzED4YTQuy-24wahqqeow}{10.36.19.17}{10.36.19.17:9305}{rack_id=111, master=false}\r\n   Hot threads at 2017-06-28T03:13:37.323Z, interval=5s, busiestThreads=3, ignoreIdleThreads=true:\r\n\r\n   24.4% (1.2s out of 5s) cpu usage by thread 'elasticsearch[mynode][[http_server_worker.default]][T#52]{New I/O worker #117}'\r\n     7/10 snapshots sharing following 7 elements\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\r\n       org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\r\n       org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n\r\n   23.5% (1.1s out of 5s) cpu usage by thread 'elasticsearch[mynode][[http_server_worker.default]][T#54]{New I/O worker #119}'\r\n     2/10 snapshots sharing following 38 elements\r\n       java.util.zip.Inflater.inflateBytes(Native Method)\r\n       java.util.zip.Inflater.inflate(Inflater.java:259)\r\n       java.util.zip.InflaterInputStream.read(InflaterInputStream.java:152)\r\n       java.io.BufferedInputStream.read1(BufferedInputStream.java:284)\r\n       java.io.BufferedInputStream.read(BufferedInputStream.java:345)\r\n       org.elasticsearch.common.io.Streams.readFully(Streams.java:216)\r\n       org.elasticsearch.common.io.stream.InputStreamStreamInput.readBytes(InputStreamStreamInput.java:51)\r\n       org.elasticsearch.common.io.stream.FilterStreamInput.readBytes(FilterStreamInput.java:44)\r\n       org.elasticsearch.common.io.stream.StreamInput.readBytesReference(StreamInput.java:98)\r\n       org.elasticsearch.common.io.stream.StreamInput.readBytesReference(StreamInput.java:86)\r\n       org.elasticsearch.indices.recovery.RecoveryFileChunkRequest.readFrom(RecoveryFileChunkRequest.java:109)\r\n       org.elasticsearch.transport.netty.MessageChannelHandler.handleRequest(MessageChannelHandler.java:222)\r\n       org.elasticsearch.transport.netty.MessageChannelHandler.messageReceived(MessageChannelHandler.java:116)\r\n       org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\r\n       org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)\r\n       org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296)\r\n       org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:462)\r\n       org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode(FrameDecoder.java:443)\r\n       org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived(FrameDecoder.java:310)\r\n       org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\r\n       org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)\r\n       org.elasticsearch.common.netty.OpenChannelsHandler.handleUpstream(OpenChannelsHandler.java:75)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:559)\r\n       org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)\r\n       org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\r\n       org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\r\n       org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n     5/10 snapshots sharing following 15 elements\r\n       sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\r\n       sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:269)\r\n       sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:93)\r\n       sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:86)\r\n       sun.nio.ch.SelectorImpl.select(SelectorImpl.java:97)\r\n       org.jboss.netty.channel.socket.nio.SelectorUtil.select(SelectorUtil.java:68)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.select(AbstractNioSelector.java:434)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:212)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\r\n       org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\r\n       org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n\r\n   19.8% (991.4ms out of 5s) cpu usage by thread 'elasticsearch[mynode][[http_server_worker.default]][T#64]{New I/O worker #129}'\r\n     2/10 snapshots sharing following 38 elements\r\n       java.util.zip.Inflater.inflateBytes(Native Method)\r\n       java.util.zip.Inflater.inflate(Inflater.java:259)\r\n       java.util.zip.InflaterInputStream.read(InflaterInputStream.java:152)\r\n       java.io.BufferedInputStream.read1(BufferedInputStream.java:284)\r\n       java.io.BufferedInputStream.read(BufferedInputStream.java:345)\r\n       org.elasticsearch.common.io.Streams.readFully(Streams.java:216)\r\n       org.elasticsearch.common.io.stream.InputStreamStreamInput.readBytes(InputStreamStreamInput.java:51)\r\n       org.elasticsearch.common.io.stream.FilterStreamInput.readBytes(FilterStreamInput.java:44)\r\n       org.elasticsearch.common.io.stream.StreamInput.readBytesReference(StreamInput.java:98)\r\n       org.elasticsearch.common.io.stream.StreamInput.readBytesReference(StreamInput.java:86)\r\n       org.elasticsearch.indices.recovery.RecoveryFileChunkRequest.readFrom(RecoveryFileChunkRequest.java:109)\r\n       org.elasticsearch.transport.netty.MessageChannelHandler.handleRequest(MessageChannelHandler.java:222)\r\n       org.elasticsearch.transport.netty.MessageChannelHandler.messageReceived(MessageChannelHandler.java:116)\r\n       org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\r\n       org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)\r\n       org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296)\r\n       org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:462)\r\n       org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode(FrameDecoder.java:443)\r\n       org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived(FrameDecoder.java:310)\r\n       org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\r\n       org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)\r\n       org.elasticsearch.common.netty.OpenChannelsHandler.handleUpstream(OpenChannelsHandler.java:75)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\r\n       org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:559)\r\n       org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)\r\n       org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\r\n       org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\r\n       org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n     7/10 snapshots sharing following 15 elements\r\n       sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\r\n       sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:269)\r\n       sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:93)\r\n       sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:86)\r\n       sun.nio.ch.SelectorImpl.select(SelectorImpl.java:97)\r\n       org.jboss.netty.channel.socket.nio.SelectorUtil.select(SelectorUtil.java:68)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.select(AbstractNioSelector.java:434)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:212)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\r\n       org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\r\n       org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n     unique snapshot\r\n       org.jboss.netty.buffer.HeapChannelBuffer.<init>(HeapChannelBuffer.java:42)\r\n       org.jboss.netty.buffer.BigEndianHeapChannelBuffer.<init>(BigEndianHeapChannelBuffer.java:34)\r\n       org.jboss.netty.buffer.ChannelBuffers.buffer(ChannelBuffers.java:134)\r\n       org.jboss.netty.buffer.HeapChannelBufferFactory.getBuffer(HeapChannelBufferFactory.java:68)\r\n       org.jboss.netty.buffer.AbstractChannelBufferFactory.getBuffer(AbstractChannelBufferFactory.java:48)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:80)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337)\r\n       org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\r\n       org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\r\n       org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\r\n       org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n```\r\n\r\nES itself is saturating 1 CPU when there are 32 idle CPUs in the system. With 2x10G network it makes very little sense to compress.","performed_via_github_app":null}]