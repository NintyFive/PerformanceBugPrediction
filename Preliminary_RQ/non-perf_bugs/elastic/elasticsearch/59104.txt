{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/59104","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59104/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59104/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59104/events","html_url":"https://github.com/elastic/elasticsearch/issues/59104","id":651824987,"node_id":"MDU6SXNzdWU2NTE4MjQ5ODc=","number":59104,"title":"7.8.0 shuffles shards constantly for no reason","user":{"login":"awick","id":427321,"node_id":"MDQ6VXNlcjQyNzMyMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/427321?v=4","gravatar_id":"","url":"https://api.github.com/users/awick","html_url":"https://github.com/awick","followers_url":"https://api.github.com/users/awick/followers","following_url":"https://api.github.com/users/awick/following{/other_user}","gists_url":"https://api.github.com/users/awick/gists{/gist_id}","starred_url":"https://api.github.com/users/awick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/awick/subscriptions","organizations_url":"https://api.github.com/users/awick/orgs","repos_url":"https://api.github.com/users/awick/repos","events_url":"https://api.github.com/users/awick/events{/privacy}","received_events_url":"https://api.github.com/users/awick/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-07-06T21:18:08Z","updated_at":"2020-09-08T22:24:08Z","closed_at":"2020-09-08T22:24:07Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): Version: 7.8.0, Build: default/tar/757314695644ea9a1dc2fecd26d1a43856725e65/2020-06-14T19:35:50.234439Z, JVM: 14.0.1\r\n\r\n**Plugins installed**: [] none\r\n\r\n**JVM version** (`java -version`): bundled\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux moloches29 3.10.0-1127.10.1.el7.YAHOO.20200605.60.x86_64 #1 SMP Fri Jun 5 13:51:56 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nAfter upgrading from 7.7.1 to 7.8.0 some of my clusters (9 of 14) have been migrating shards around constantly for 2 weeks now. The clusters are all GREEN. This happens on both clusters that have ILM and don't have ILM, so I don't think it is ILM related. It seems to only be happening on clusters that have cluster.routing.allocation.awareness.attributes set, but not sure if that is the cause. I do have 2 clusters with cluster.routing.allocation.awareness.attributes that aren't doing it. I've tried doing a full bounce of one the cluster (since they were upgraded using a rolling restart) but that doesn't seem to have fixed anything. The clusters that it happens on are medium to large, anywhere from 15 data nodes to over 100 data nodes. Prior to going to 7.8.0 there were no shards shuffling around.\r\n\r\nOther folks who use Moloch have reported having the same issue, so it isn't just me and my clusters.\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -s --insecure 'https://localhost:9200/_cluster/settings?pretty&flat_settings'\r\n{\r\n  \"persistent\" : {\r\n    \"cluster.max_shards_per_node\" : \"5000\",\r\n    \"cluster.routing.allocation.awareness.attributes\" : \"molochzone\",\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"40\",\r\n    \"cluster.routing.allocation.node_concurrent_recoveries\" : \"4\",\r\n    \"indices.recovery.max_bytes_per_sec\" : \"200mb\"\r\n  },\r\n  \"transient\" : { }\r\n}\r\n```\r\n","closed_by":{"login":"cjcenizal","id":1238659,"node_id":"MDQ6VXNlcjEyMzg2NTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1238659?v=4","gravatar_id":"","url":"https://api.github.com/users/cjcenizal","html_url":"https://github.com/cjcenizal","followers_url":"https://api.github.com/users/cjcenizal/followers","following_url":"https://api.github.com/users/cjcenizal/following{/other_user}","gists_url":"https://api.github.com/users/cjcenizal/gists{/gist_id}","starred_url":"https://api.github.com/users/cjcenizal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cjcenizal/subscriptions","organizations_url":"https://api.github.com/users/cjcenizal/orgs","repos_url":"https://api.github.com/users/cjcenizal/repos","events_url":"https://api.github.com/users/cjcenizal/events{/privacy}","received_events_url":"https://api.github.com/users/cjcenizal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}