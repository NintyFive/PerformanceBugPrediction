{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5928","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5928/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5928/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5928/events","html_url":"https://github.com/elastic/elasticsearch/issues/5928","id":32126745,"node_id":"MDU6SXNzdWUzMjEyNjc0NQ==","number":5928,"title":"Feature request : improvement of the perceived relevance of the highlight","user":{"login":"mdimiceli","id":3592430,"node_id":"MDQ6VXNlcjM1OTI0MzA=","avatar_url":"https://avatars1.githubusercontent.com/u/3592430?v=4","gravatar_id":"","url":"https://api.github.com/users/mdimiceli","html_url":"https://github.com/mdimiceli","followers_url":"https://api.github.com/users/mdimiceli/followers","following_url":"https://api.github.com/users/mdimiceli/following{/other_user}","gists_url":"https://api.github.com/users/mdimiceli/gists{/gist_id}","starred_url":"https://api.github.com/users/mdimiceli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mdimiceli/subscriptions","organizations_url":"https://api.github.com/users/mdimiceli/orgs","repos_url":"https://api.github.com/users/mdimiceli/repos","events_url":"https://api.github.com/users/mdimiceli/events{/privacy}","received_events_url":"https://api.github.com/users/mdimiceli/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-04-24T07:38:27Z","updated_at":"2018-03-23T15:08:21Z","closed_at":"2018-03-23T15:08:21Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, my name's Damien, I'm working for a french company, Orange.\n\nWe discovered Elasticsearch a few months ago and we are very enthusiasts about it, great tool really, so we decided to make a proof a of concept with it. The aim is to replace our internal (home-made) search engines with ES.\n\nTo this point we are really satisfied of the results we get in terms of search relevance thanks to all the possible tunings : mappings, lots of query types, filters, etc. But we are facing a big problem, a blocking one. We are not able to obtain what we want from the highlighting part.\n\nTo be precise, there are two types of relevance for us :\n- the \"real\" relevance : Do the documents I obtain from my search are relevant according to my search query (and maybe other criterias) ? Is the result exhaustive ? Are the documents well ordered ? etc. It involves reading all the returned documents in their entirety to answer those questions.\n- the \"perceived\" relevance : When I get the highlighted parts of the returned documents do I feel that the results are relevant ? It involves just reading a small part of the document to answer the relevance question.\n\nActually we have a good relevance and a poor perceived relevance (according to our criterias of what is a good preceived relevance).\nThis point is a blocking one and our marketing department will not give its approval for the migration until this problem is solved.\n\nI think that we read the the docs correctly, we tried a lot of things, so we need to submit a feature request to your team. Let me explain what we need with some examples, and if we missed something in the docs please accept our apologies.\n\n<h2>First example</h2>\n\nWhat we want : no matter the number of fragments, we want a constant total size (ex: 2x30, 3x20, 4x15, ... total size is 60).\n\nWhat we have:\nWe index a sentence 90 chars long (approximately). We make two searches with 2 fragments of size 30 specified. The first time we search with two words, we get 2 fragments, each of size 30, everything fine, total size is 60 (approximately). The second time we search with only one word so obviously we can have only one fragment and the total size is 30, not 60.\n\n``` bash\n# Deleting all indexes\ncurl -XDELETE 'localhost:9200/_all?pretty=yes'\n\n# Putting some data, approximately 70 characters long.\ncurl -XPUT 'localhost:9200/index/doc/1?pretty=yes' -d '\n{\n    \"text\": \"My parents had the good idea of offering me a dog for my tenth birthday. I like him a lot.\"\n}\n'\n\n# Refreshing the index.\ncurl -XPOST 'http://localhost:9200/_refresh?pretty=yes'\n\n# Searching with two keywords for two fragments.\ncurl -XGET 'localhost:9200/index/doc/_search?pretty=yes' -d '\n{\n    \"query\": {\n        \"match\": {\n            \"text\": {\n                \"query\": \"idea birthday\",\n                \"operator\" : \"and\"\n            }\n        }\n    },\n    \"highlight\": {\n        \"fields\": {\n            \"text\": {\n                \"number_of_fragments\": 2,\n                \"fragment_size\": 20\n            }\n        }\n    }\n}\n'\n\n# Searching with one keyword for two fragments.\ncurl -XGET 'localhost:9200/index/doc/_search?pretty=yes' -d '\n{\n    \"query\": {\n        \"match\": {\n            \"text\": \"idea\"\n        }\n    },\n    \"highlight\": {\n        \"fields\": {\n            \"text\": {\n                \"number_of_fragments\": 2,\n                \"fragment_size\": 20\n            }\n        }\n    }\n}\n'\n```\n\nHere we specify:\n\"number_of_fragments\": 2\n\"fragment_size\": 30\n\nWe would prefer:\n\"number_of_fragments\": 2\n\"preferred_fragment_size\": 30\n\"total_size\": 60\nor something like that, the parameters are up to you, we are looking for a behaviour not a syntax.\n\nWhat we really want is to have a constant total size because when showing the results to the users through a web page it's nicer to have regular sizes for text blocks (to the marketing department's point of view...). So according to this, there are cases when the fragments size should be of variable length. Typically when there are less matches than the number of required fragments. The only case for which we accept to have a smaller size is when the size of the searched field is shorter than the size we specified for the highlight, this is obvious but has to be mentionned to be exhaustive.\nThis is kind of a corner case between using \"no_match_size\", and \"number_of_fragments\" coupled with \"fragment_size\".\n\n<h2>Second example</h2>\n\nWhat we want: we compose resumes from fragments, by catenating them with ellipses(...). We want the resumes to start by the beginning of a phrase.\n\nWhat we have:\nWe have to choose between the postings highlighter and the fast vector highlighter. With the first one we have all the fragments beginning by the beginning of a sentence but we loose control over the total size of the resume. With the second one we keep control over the total size but we loose \"the sentence effect\". We would like something between the two, once more. The first fragment should start by the beginning of a sentence and the others are free.\n\nOnce more it's a matter of good user experience (still the marketing department's opinion...). The problem with that is that if the sentence contains a keyword but it is far from the beginning, it could be impossible to have both the beginning of the sentence AND the highlighted keyword in the same fragment because of a too short fragment. Variable fragments length could do the trick in some cases but not all, if the sentence is longer than the total length we loose once more. Maybe the solution would be to have an additional fragment for the sentence purpose.\n\nOnce your highlighted fragments have been collected you add an extra fragment which contains the beginning of the sentence in which the first fragment was taken. This extra fragment can be short and is not forced to contain a keyword, it is just here for the glitter effect.\n\n<h2>Third example</h2>\n\nThe total size should never be excedeed. If you look at the previous examples you will see that the total length is sometimes longer than our desired total size. Moreover the individual lengths of the fragments do not always seem optimal, they sometime could be longer without exceeding their specified size. We don't really understand how this works.\n\n<h2>Fourth example, the most important</h2>\n\nWhat we want:\nWhen searching for several terms we want to get the most big number of different terms to be highlighted. This point is crucial for the perceived relevance.\n\nWhat we have:\nES selects the best matches and so often takes the same keyword. In the following example we search for \"dog\" and \"friend\" and we only get \"dog\" highlighted, twice, because it comes first in the text. We would prefer to have \"dog\" and \"friend\" highlighted because it seems more relevant. We tried with highlighted query but did not manage to get what we wanted.\n\n``` bash\n# Deleting all indexes.\ncurl -XDELETE 'localhost:9200/_all?pretty=yes'\n\n# Putting some data\ncurl -XPUT 'localhost:9200/index/doc/1?pretty=yes' -d '\n{\n    \"text\": \"I have a dog, very cute. Maybe he is the cutest dog in the world. He is my friend, my best friend actually, and will remain it.\"\n}\n'\n\n# Refreshing the index\ncurl -XPOST 'http://localhost:9200/_refresh?pretty=yes'\n\n# Searching\ncurl -XGET 'localhost:9200/index/doc/_search?pretty=yes' -d '\n{\n    \"query\": {\n        \"match\": {\n            \"text\": {\n                \"query\": \"friend dog\",\n                \"operator\" : \"and\"\n            }\n        }\n    },\n    \"highlight\": {\n        \"order\": \"score\",\n        \"fields\": {\n            \"text\": {\n                \"number_of_fragments\": 2,\n                \"fragment_size\": 30\n            }\n        }\n    }\n}\n```\n\nResume of our requirements :\n- Specify total size.\n- Specify fragments number (preferred number to  be precise)\n- Specify fragments size (preferrered again)\n- First fragment starts as sentence.\n- Fragments contain as much different keywords as possible.\n\nMaybe this should have been posted to Lucene ? Sorry if it is the case.\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}