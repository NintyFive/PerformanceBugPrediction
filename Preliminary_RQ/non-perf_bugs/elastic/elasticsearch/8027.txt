{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8027","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8027/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8027/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8027/events","html_url":"https://github.com/elastic/elasticsearch/issues/8027","id":45294071,"node_id":"MDU6SXNzdWU0NTI5NDA3MQ==","number":8027,"title":"Inconsistency between `_percolate` and `_search`","user":{"login":"georgi0u","id":197144,"node_id":"MDQ6VXNlcjE5NzE0NA==","avatar_url":"https://avatars1.githubusercontent.com/u/197144?v=4","gravatar_id":"","url":"https://api.github.com/users/georgi0u","html_url":"https://github.com/georgi0u","followers_url":"https://api.github.com/users/georgi0u/followers","following_url":"https://api.github.com/users/georgi0u/following{/other_user}","gists_url":"https://api.github.com/users/georgi0u/gists{/gist_id}","starred_url":"https://api.github.com/users/georgi0u/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/georgi0u/subscriptions","organizations_url":"https://api.github.com/users/georgi0u/orgs","repos_url":"https://api.github.com/users/georgi0u/repos","events_url":"https://api.github.com/users/georgi0u/events{/privacy}","received_events_url":"https://api.github.com/users/georgi0u/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"assignees":[{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2014-10-08T20:41:11Z","updated_at":"2014-10-22T15:14:11Z","closed_at":"2014-10-22T15:14:11Z","author_association":"NONE","active_lock_reason":null,"body":"# Summary\n\nThere seems to be an unexplained inconsistency between the results of `_percolate` and `_search` when using the same document and query set.\n# Description\n\nI have an index defined with a custom analyzer set as my default and a few string fields. The analyzer tokenizes on commas, and nothing else. Curling the mapping returns the following output:\n\n```\n{\n    \"news_documents_20140729\": {\n        \"mappings\": {\n            \"0000000022-nid\": {\n                \"_all\": {\n                    \"enabled\": false\n                },\n                \"_timestamp\": {\n                    \"enabled\": true,\n                    \"store\": true\n                },\n                \"_ttl\": {\n                    \"enabled\": true\n                },\n                \"dynamic\": \"false\",\n                \"analyzer\": \"csv_lowercase_commas\",\n                \"properties\": {\n                     ...\n                     \"subjects\": {\n                        \"type\": \"string\"\n                     },\n                     \"product\": {\n                        \"type\": \"string\",\n                        \"null_value\": \"DJGM\"\n                     },\n                     ...\n```\n\nThe analyzer referenced above is defined as follows:\n\n```\n\"csv_lowercase_commas\" : {\n  \"type\" : \"custom\",\n  \"filter\" : [ \"lowercase\" ],\n  \"tokenizer\" : \"commas\"\n}\n```\n\nAnd the `commas` tokenizer is defined as follows:\n\n```\n\"commas\" : {\n    \"pattern\" : \",+\",\n    \"type\" : \"pattern\"\n}\n```\n\nI've indexed a very simple document to the above index, as the shown type..\n\n```\n{ \"subjects\":\"N/DJMT\", \"product\":\"DJGM\"}\n```\n\nI search for the above document using the following three queries, and the document is returned each time, as expected.\n## Match All Query\n\n```\n{\"query\": { \"match_all\":{}}}\n```\n## Term Query\n\n```\n{\n    \"query\": {\n        \"filtered\": {\n            \"filter\": {\n                \"and\": [\n                    {\n                        \"term\": {\n                            \"product\": \"djgm\"\n                        }\n                    },\n                    {\n                        \"in\": {\n                            \"subjects\": [\n                                \"n/djmt\"\n                            ]\n                        }\n                    }\n                ]\n            }\n        }\n    }\n}\n```\n## Phrase Query\n\n```\n{\n    \"query\": {\n        \"filtered\": {\n            \"filter\": {\n                \"term\": {\n                    \"product\": \"djgm\"\n                }\n            },\n            \"query\": {\n                \"match_phrase\" : {\n                    \"subjects\" : \"n/djmt\"\n                }\n            }\n        }\n    }\n}\n```\n## Here's the problem\n\nI add each of the above queries to the .percolator type in the above described index, and then percolate `{\"doc\":{ \"subjects\":\"N/DJMT\", \"product\":\"DJGM\"}}` -- i.e., the exact same document content I indexed and searched on previously. _However, the result contains only the `Match All Query` and the `Phrase Query`_. \n\nTo be more concise...\n\n**Searching for the document using the above queries returns the document independent of which query is used to perform the search. Percolating the same document, with the above three queries indexed in the same index's .percolator type, returns _only the first two queries_.**\n\n**The phrase query is inexplicably missing from the percolate results.**\n# More Information\n\nThis was verified on a 1.1.0 instance, within a clean index. It was originally discovered in a production index through a slightly more complicated, albeit technically synonymous (by my assessment), example.\n\n~~Sorry, I don't have access to a 1.3 cluster at the moment, so I haven't verified it there.~~\nAlso verified on a 1.3.4 test cluster I just spooled up for testing.\n\nA quick grep through the issue tracker using `percolate is:open label:bug` didn't show anything similar.\n# (Naive) Partially-substantiated Insights\n\nRunning the same experiment, except removing the '/' in the string 'n/djmt' in both all of the queries and the document, produces the expected, correct results. In other words, `_percolate` returns all three queries, and `_search` returns the document in response to all three queries. _(Did this on a 1.3.4 cluster with the same mappings as described above.)_\n\nThe combination of (1) the punctuation being a variable in the problem and (2) the fact that analysis is applied to phrase queries and not to term queries, has me believing the issue has to do with analysis, specifically it not being applied properly when percolating.\n\n_Lastly, if I'm missing something trivial, then I apologize in advance for wasting time. It's very likely I'm ignorant of some crucial fact here._\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}