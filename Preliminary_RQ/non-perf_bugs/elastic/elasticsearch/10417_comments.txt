[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89433808","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-89433808","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":89433808,"node_id":"MDEyOklzc3VlQ29tbWVudDg5NDMzODA4","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-04-03T22:02:37Z","updated_at":"2015-04-03T22:02:37Z","author_association":"CONTRIBUTOR","body":"When the query returns 0 results prematurely, do you have shard failures in the response?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89438456","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-89438456","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":89438456,"node_id":"MDEyOklzc3VlQ29tbWVudDg5NDM4NDU2","user":{"login":"hjz","id":480549,"node_id":"MDQ6VXNlcjQ4MDU0OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/480549?v=4","gravatar_id":"","url":"https://api.github.com/users/hjz","html_url":"https://github.com/hjz","followers_url":"https://api.github.com/users/hjz/followers","following_url":"https://api.github.com/users/hjz/following{/other_user}","gists_url":"https://api.github.com/users/hjz/gists{/gist_id}","starred_url":"https://api.github.com/users/hjz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hjz/subscriptions","organizations_url":"https://api.github.com/users/hjz/orgs","repos_url":"https://api.github.com/users/hjz/repos","events_url":"https://api.github.com/users/hjz/events{/privacy}","received_events_url":"https://api.github.com/users/hjz/received_events","type":"User","site_admin":false},"created_at":"2015-04-03T22:29:25Z","updated_at":"2015-04-03T22:29:25Z","author_association":"NONE","body":"We've seen shard failures before where 1 or 2 shards would fail and instead of 1000 results, it'll return 900 or 800. \n\nDidn't log the shard failures this time, suppose all 5 shards failed, any idea why that would happen? I'll add logging for that and circle back.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89832211","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-89832211","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":89832211,"node_id":"MDEyOklzc3VlQ29tbWVudDg5ODMyMjEx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-05T19:02:08Z","updated_at":"2015-04-05T19:02:08Z","author_association":"CONTRIBUTOR","body":"@hjz can you provide the actual code you're using for scroll requests, plus any exceptions?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89958896","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-89958896","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":89958896,"node_id":"MDEyOklzc3VlQ29tbWVudDg5OTU4ODk2","user":{"login":"hjz","id":480549,"node_id":"MDQ6VXNlcjQ4MDU0OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/480549?v=4","gravatar_id":"","url":"https://api.github.com/users/hjz","html_url":"https://github.com/hjz","followers_url":"https://api.github.com/users/hjz/followers","following_url":"https://api.github.com/users/hjz/following{/other_user}","gists_url":"https://api.github.com/users/hjz/gists{/gist_id}","starred_url":"https://api.github.com/users/hjz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hjz/subscriptions","organizations_url":"https://api.github.com/users/hjz/orgs","repos_url":"https://api.github.com/users/hjz/repos","events_url":"https://api.github.com/users/hjz/events{/privacy}","received_events_url":"https://api.github.com/users/hjz/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T07:27:31Z","updated_at":"2015-04-06T07:27:31Z","author_association":"NONE","body":"Here's the query to start the scroll\n\n``` scala\n  def startScrollQueryGetTotalHitsAndScrollId(index: String, filter: BaseFilterBuilder): (Long, String) = {\n    val r = ES.client.prepareSearch(index)\n      .setTypes(User.eventType)\n      .setSearchType(SearchType.SCAN)\n      .setFrom(0)\n      .setSize(config.scrollSizePerShard)\n      .setScroll(scrollTime)\n\n     r.setQuery(QueryBuilders.filteredQuery(QueryBuilders.matchAllQuery(), filter))\n\n    val resp = r.execute().actionGet(config.scrollTimeoutSecs, TimeUnit.SECONDS)\n\n    (resp.getHits.getTotalHits, resp.getScrollId)\n  }\n```\n\nThen subsequent looks up are done via:\n\n``` scala\n      val scrollResp = ES.client\n        .prepareSearchScroll(scrollId)\n        .setScroll(scrollTime)\n        .execute()\n        .actionGet(config.scrollTimeoutSecs, TimeUnit.SECONDS)\n\n      if (scrollResp.getFailedShards > 0) {\n        val shards = scrollResp.getShardFailures\n        shards.foreach { s =>\n          val msg = s\"Shard failed scroll query: ${s.index()}, shardId: ${s.shardId()} reason: ${s.reason()}}\"\n          hipChatService.errorMessage(msg, createAlert = false)\n        }\n      }\n\n      (scrollResp.getHits.getHits.map { sh =>\n        ApiUser.fromSource(sh.getId, sh.source() )\n      }.toSeq,  scrollResp.getScrollId)\n```\n\nI'll follow up with exceptions\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90184115","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-90184115","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":90184115,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMTg0MTE1","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T18:22:37Z","updated_at":"2015-04-06T18:22:37Z","author_association":"CONTRIBUTOR","body":"@hjz I don't see where you are getting the scroll_id from the previous scroll request and using it for the next scroll request.\n\nNormally there would be some `while` loop which does a scroll request, checks if there are any hits, then issues a new scroll request, using the `scroll_id` returned by the previous scroll request.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90225966","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-90225966","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":90225966,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMjI1OTY2","user":{"login":"hjz","id":480549,"node_id":"MDQ6VXNlcjQ4MDU0OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/480549?v=4","gravatar_id":"","url":"https://api.github.com/users/hjz","html_url":"https://github.com/hjz","followers_url":"https://api.github.com/users/hjz/followers","following_url":"https://api.github.com/users/hjz/following{/other_user}","gists_url":"https://api.github.com/users/hjz/gists{/gist_id}","starred_url":"https://api.github.com/users/hjz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hjz/subscriptions","organizations_url":"https://api.github.com/users/hjz/orgs","repos_url":"https://api.github.com/users/hjz/repos","events_url":"https://api.github.com/users/hjz/events{/privacy}","received_events_url":"https://api.github.com/users/hjz/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T20:08:59Z","updated_at":"2015-04-06T20:09:48Z","author_association":"NONE","body":"Yes that what we do. I omittied some code there. Essentially\n\n``` scala\ndef getNextScroll() = {\n      val scrollResp = ES.client\n        .prepareSearchScroll(scrollId)\n        .setScroll(scrollTime)\n        .execute()\n        .actionGet(config.scrollTimeoutSecs, TimeUnit.SECONDS)\n\n      if (scrollResp.getFailedShards > 0) {\n        val shards = scrollResp.getShardFailures\n        shards.foreach { s =>\n          val msg = s\"Shard failed scroll query: ${s.index()}, shardId: ${s.shardId()} reason: ${s.reason()}}\"\n          hipChatService.errorMessage(msg, createAlert = false)\n        }\n      }\n\n      (scrollResp.getHits.getHits.map { sh =>\n        ApiUser.fromSource(sh.getId, sh.source() )\n      }.toSeq,  scrollResp.getScrollId)\n}\n```\n\n``` scala\nval (totalHits, startScrollId) = startScrollQueryGetTotalHitsAndScrollId\nvar currentScrollId = startScrollId\nvar batch = 1\nvar remaining = totalHits\nvar retries = 0\nvar batchHits = 0L\n\ndo {\n      val startTime = DateTime.now\n\n     getNextScroll(currentScrollId) match {\n        case Success((users, nextScrollId)) =>\n          currentScrollId = nextScrollId\n          batch += 1\n\n        case Failure(e) =>\n          batchHits = 0\n          hipChatService.sendMessage(s\"$logHdr scroll query error. ${e.getMessage}. retry $retries\", color = HipChatNotificationColor.Red)\n      }\n\n      // If hits was 0 but there are users remaining, something fubared, so sleep for BatchRetrySeconds and retry\n      if (batchHits == 0 && remaining > 0) {\n        retries += 1\n        Logger.error(s\"$logHdr Elasticsearch scroll request failed, retries: $retries. Sleeping for ${config.scrollRetrySleepDuration.seconds} seconds\")\n        Thread.sleep(config.scrollRetrySleepDuration.millis)\n      }\n\n      remaining -= batchHits\n} while (remaining > 0 && retries < config.scrollMaxRetries)\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/91319788","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-91319788","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":91319788,"node_id":"MDEyOklzc3VlQ29tbWVudDkxMzE5Nzg4","user":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"created_at":"2015-04-09T18:30:14Z","updated_at":"2015-04-09T18:30:14Z","author_association":"MEMBER","body":"@hjz Have you gotten any logs for this issue yet?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/94538026","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-94538026","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":94538026,"node_id":"MDEyOklzc3VlQ29tbWVudDk0NTM4MDI2","user":{"login":"hjz","id":480549,"node_id":"MDQ6VXNlcjQ4MDU0OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/480549?v=4","gravatar_id":"","url":"https://api.github.com/users/hjz","html_url":"https://github.com/hjz","followers_url":"https://api.github.com/users/hjz/followers","following_url":"https://api.github.com/users/hjz/following{/other_user}","gists_url":"https://api.github.com/users/hjz/gists{/gist_id}","starred_url":"https://api.github.com/users/hjz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hjz/subscriptions","organizations_url":"https://api.github.com/users/hjz/orgs","repos_url":"https://api.github.com/users/hjz/repos","events_url":"https://api.github.com/users/hjz/events{/privacy}","received_events_url":"https://api.github.com/users/hjz/received_events","type":"User","site_admin":false},"created_at":"2015-04-20T18:48:48Z","updated_at":"2015-04-20T18:57:02Z","author_association":"NONE","body":"// Starts just after the initial scroll query\n\n2015-04-20 17:34:11,281 [ERROR] application - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[datanode4][inet[/x.x.x.248:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: EsRejectedExecutionException[rejected execution (queue capacity 1000) on org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler@1cf09828]; }\n\n2015-04-20 17:34:11,282 [ERROR] application - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[datanode4][inet[/x.x.x.248:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: EsRejectedExecutionException[rejected execution (queue capacity 1000) on org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler@57767fad]; }\n\n2015-04-20 17:34:11,283 [ERROR] application - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[datanode4][inet[/x.x.x.248:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: EsRejectedExecutionException[rejected execution (queue capacity 1000) on org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler@779578ef]; }\n\n2015-04-20 17:34:11,305 [ERROR] application - [xxx Batch 3 - 14531 remaining] [200 DONE] Fetching: 56.319 secs. Queuing: 0.015 secs. 3.550253843149785 msgs/sec\n\n2015-04-20 17:34:51,414 [ERROR] application - [xxx Batch 4 - 14331 remaining] [200 DONE] Fetching: 40.094 secs. Queuing: 0.013 secs. 4.986660682673848 msgs/sec\n\n2015-04-20 17:34:59,458 [ERROR] application - [xxx Batch 5 - 14131 remaining] [200 DONE] Fetching: 8.029 secs. Queuing: 0.013 secs. 24.869435463814973 msgs/sec\n\n2015-04-20 17:34:59,574 [ERROR] application - [xxx Batch 6 - 13931 remaining] [200 DONE] Fetching: 0.099 secs. Queuing: 0.015 secs. 1754.3859649122805 msgs/sec\n\n2015-04-20 17:34:59,646 [ERROR] application - [xxx Batch 7 - 13731 remaining] [200 DONE] Fetching: 0.057 secs. Queuing: 0.012 secs. 2898.550724637681 msgs/sec\n\n2015-04-20 17:34:59,865 [ERROR] application - [xxx Batch 9 - 13331 remaining] [200 DONE] Fetching: 0.098 secs. Queuing: 0.027 secs. 1600.0 msgs/sec\n\n2015-04-20 17:34:59,994 [ERROR] application - [xxx Batch 10 - 13131 remaining] [200 DONE] Fetching: 0.083 secs. Queuing: 0.045 secs. 1562.5 msgs/sec\n\n2015-04-20 17:35:00,009 [ERROR] application - [xxx Batch 11 - 12931 remaining] [9 DONE] Fetching: 0.011 secs. Queuing: 0.002 secs. 692.3076923076924 msgs/sec\n\n2015-04-20 17:35:00,012 [ERROR] application - [xxx Batch 12 - 12922 remaining] [0 DONE] Fetching: 0.0 secs. Queuing: 0.0 secs. NaN msgs/sec\n\n2015-04-20 17:35:00,015 [ERROR] application - [xxx Batch 13 - 12922 remaining] Elasticsearch scroll request failed, retries: 1. Sleeping for 5 seconds\n\n2015-04-20 17:35:00,071 [WARN ] n.k.r.connection.AbstractConnection - Lockdown ended.\n\n2015-04-20 17:35:05,017 [ERROR] application - [xxx Batch 13 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.0 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:05,018 [ERROR] application - [xxx Batch 14 - 12922 remaining] Elasticsearch scroll request failed, retries: 2. Sleeping for 5 seconds\n\n2015-04-20 17:35:x.x.x [ERROR] application - [xxx Batch 14 - 12922 remaining] [0 DONE] Fetching: 0.0 secs. Queuing: 0.001 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:10,021 [ERROR] application - [xxx Batch 15 - 12922 remaining] Elasticsearch scroll request failed, retries: 3. Sleeping for 5 seconds\n\n2015-04-20 17:35:15,023 [ERROR] application - [xxx Batch 15 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.0 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:15,025 [ERROR] application - [xxx Batch 16 - 12922 remaining] Elasticsearch scroll request failed, retries: 4. Sleeping for 5 seconds\n\n2015-04-20 17:35:20,027 [ERROR] application - [xxx Batch 16 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.0 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:20,030 [ERROR] application - [xxx Batch 17 - 12922 remaining] Elasticsearch scroll request failed, retries: 5. Sleeping for 5 seconds\n\n2015-04-20 17:35:25,032 [ERROR] application - [xxx Batch 17 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.001 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:25,034 [ERROR] application - [xxx Batch 18 - 12922 remaining] Elasticsearch scroll request failed, retries: 6. Sleeping for 5 seconds\n\n2015-04-20 17:35:30,036 [ERROR] application - [xxx Batch 18 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.0 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:30,038 [ERROR] application - [xxx Batch 19 - 12922 remaining] Elasticsearch scroll request failed, retries: 7. Sleeping for 5 seconds\n\n2015-04-20 17:35:30,350 [WARN ] n.k.r.connection.AbstractConnection - Lockdown ended.\n\n2015-04-20 17:35:35,040 [ERROR] application - [xxx Batch 19 - 12922 remaining] [0 DONE] Fetching: 0.0 secs. Queuing: 0.001 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:35,042 [ERROR] application - [xxx Batch 20 - 12922 remaining] Elasticsearch scroll request failed, retries: 8. Sleeping for 5 seconds\n\n2015-04-20 17:35:40,044 [ERROR] application - [xxx Batch 20 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.001 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:40,046 [ERROR] application - [xxx Batch 21 - 12922 remaining] Elasticsearch scroll request failed, retries: 9. Sleeping for 5 seconds\n\n2015-04-20 17:35:45,048 [ERROR] application - [xxx Batch 21 - 12922 remaining] [0 DONE] Fetching: 0.001 secs. Queuing: 0.0 secs. 0.0 msgs/sec\n\n2015-04-20 17:35:45,050 [ERROR] application - [xxx Batch 22 - 12922 remaining] Elasticsearch scroll request failed, retries: 10. Sleeping for 5 seconds\n\n2015-04-20 17:35:45,415 [WARN ] n.k.r.connection.AbstractConnection - Lockdown ended.\n\n2015-04-20 17:35:50,051 [ERROR] application - [xxx Batch 22 - 12922 remaining] Some users failed to fetch: remaining, 12922 retries: 10\n\n// We stop trying here\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/94836023","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-94836023","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":94836023,"node_id":"MDEyOklzc3VlQ29tbWVudDk0ODM2MDIz","user":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"created_at":"2015-04-21T15:17:33Z","updated_at":"2015-04-21T15:17:33Z","author_association":"MEMBER","body":"@hjz For your value of `index`, are you using `\"_all\"` (or equivalent) by chance? How many shards are actually associated with that request?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/94995715","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-94995715","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":94995715,"node_id":"MDEyOklzc3VlQ29tbWVudDk0OTk1NzE1","user":{"login":"hjz","id":480549,"node_id":"MDQ6VXNlcjQ4MDU0OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/480549?v=4","gravatar_id":"","url":"https://api.github.com/users/hjz","html_url":"https://github.com/hjz","followers_url":"https://api.github.com/users/hjz/followers","following_url":"https://api.github.com/users/hjz/following{/other_user}","gists_url":"https://api.github.com/users/hjz/gists{/gist_id}","starred_url":"https://api.github.com/users/hjz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hjz/subscriptions","organizations_url":"https://api.github.com/users/hjz/orgs","repos_url":"https://api.github.com/users/hjz/repos","events_url":"https://api.github.com/users/hjz/events{/privacy}","received_events_url":"https://api.github.com/users/hjz/received_events","type":"User","site_admin":false},"created_at":"2015-04-22T01:44:53Z","updated_at":"2015-04-22T01:45:08Z","author_association":"NONE","body":"We have _all turned off. This is hitting 15 shards that has 2 replicas. No doc value formats.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/113459700","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-113459700","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":113459700,"node_id":"MDEyOklzc3VlQ29tbWVudDExMzQ1OTcwMA==","user":{"login":"l15k4","id":518855,"node_id":"MDQ6VXNlcjUxODg1NQ==","avatar_url":"https://avatars1.githubusercontent.com/u/518855?v=4","gravatar_id":"","url":"https://api.github.com/users/l15k4","html_url":"https://github.com/l15k4","followers_url":"https://api.github.com/users/l15k4/followers","following_url":"https://api.github.com/users/l15k4/following{/other_user}","gists_url":"https://api.github.com/users/l15k4/gists{/gist_id}","starred_url":"https://api.github.com/users/l15k4/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/l15k4/subscriptions","organizations_url":"https://api.github.com/users/l15k4/orgs","repos_url":"https://api.github.com/users/l15k4/repos","events_url":"https://api.github.com/users/l15k4/events{/privacy}","received_events_url":"https://api.github.com/users/l15k4/received_events","type":"User","site_admin":false},"created_at":"2015-06-19T10:09:49Z","updated_at":"2015-06-19T15:36:42Z","author_association":"NONE","body":"I seem to have this issue too... I'm scanning a little more than 100 indices with `keepAlive=10s` : \n\n```\n            \"number_of_replicas\": \"1\",\n            \"number_of_shards\": \"5\",\n```\n\non : \n\n```\n   \"number_of_nodes\": 4,\n   \"number_of_data_nodes\": 4,\n   \"active_primary_shards\": 530,\n   \"active_shards\": 1060,\n```\n\nI'm using pattern `mi_*` for scanning those 100+ indices.\n\nI haven't noticed it would happen with sorted `QueryThenFetch` scroll because I couldn't scroll as much as I can `Scan`. But when scanning it returns 0 results after ~ 100M documents from 350M. I don't check `SearchResponse#getShardFailures` though. What should I do when there is a failure? Repeat the request with the same `scroll_id` ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/113553972","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-113553972","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":113553972,"node_id":"MDEyOklzc3VlQ29tbWVudDExMzU1Mzk3Mg==","user":{"login":"l15k4","id":518855,"node_id":"MDQ6VXNlcjUxODg1NQ==","avatar_url":"https://avatars1.githubusercontent.com/u/518855?v=4","gravatar_id":"","url":"https://api.github.com/users/l15k4","html_url":"https://github.com/l15k4","followers_url":"https://api.github.com/users/l15k4/followers","following_url":"https://api.github.com/users/l15k4/following{/other_user}","gists_url":"https://api.github.com/users/l15k4/gists{/gist_id}","starred_url":"https://api.github.com/users/l15k4/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/l15k4/subscriptions","organizations_url":"https://api.github.com/users/l15k4/orgs","repos_url":"https://api.github.com/users/l15k4/repos","events_url":"https://api.github.com/users/l15k4/events{/privacy}","received_events_url":"https://api.github.com/users/l15k4/received_events","type":"User","site_admin":false},"created_at":"2015-06-19T15:47:50Z","updated_at":"2015-06-19T15:48:59Z","author_association":"NONE","body":"I figured out why this happened to me, the reason is that scanning slows down so much that it gets out of `10s` keepAlive period which leads to `SearchResponse#shardFailures`. These logs document it : \n\n```\n100320 elements processed in 17 seconds\n100320 elements processed in 13 seconds\n100320 elements processed in 20 seconds\n100320 elements processed in 20 seconds\n100320 elements processed in 13 seconds\n100320 elements processed in 32 seconds\n100320 elements processed in 17 seconds\n100320 elements processed in 53 seconds\n100320 elements processed in 37 seconds\n100320 elements processed in 38 seconds\n100320 elements processed in 64 seconds\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208081]]\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208084]]\n - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[High Evolutionary][inet[/172.31.47.53:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: SearchContextMissingException[No search context found for id [221366]];\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208092]]\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208086]]\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208093]]\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208089]]\n - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[High Evolutionary][inet[/172.31.47.53:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: SearchContextMissingException[No search context found for id [221369]];\n - Shard failed scroll query: null, shardId: -1 reason: SearchContextMissingException[No search context found for id [208087]]\n - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[High Evolutionary][inet[/172.31.47.53:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: SearchContextMissingException[No search context found for id [221371]];\n - Shard failed scroll query: null, shardId: -1 reason: RemoteTransportException[[High Evolutionary][inet[/172.31.47.53:9300]][indices:data/read/search[phase/scan/scroll]]]; nested: SearchContextMissingException[No search context found for id [221372]];\n - ScanSource just completed...\n\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/132607543","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-132607543","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":132607543,"node_id":"MDEyOklzc3VlQ29tbWVudDEzMjYwNzU0Mw==","user":{"login":"vvcephei","id":832787,"node_id":"MDQ6VXNlcjgzMjc4Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/832787?v=4","gravatar_id":"","url":"https://api.github.com/users/vvcephei","html_url":"https://github.com/vvcephei","followers_url":"https://api.github.com/users/vvcephei/followers","following_url":"https://api.github.com/users/vvcephei/following{/other_user}","gists_url":"https://api.github.com/users/vvcephei/gists{/gist_id}","starred_url":"https://api.github.com/users/vvcephei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vvcephei/subscriptions","organizations_url":"https://api.github.com/users/vvcephei/orgs","repos_url":"https://api.github.com/users/vvcephei/repos","events_url":"https://api.github.com/users/vvcephei/events{/privacy}","received_events_url":"https://api.github.com/users/vvcephei/received_events","type":"User","site_admin":false},"created_at":"2015-08-19T13:58:42Z","updated_at":"2015-08-19T13:58:42Z","author_association":"CONTRIBUTOR","body":"I have had some trouble with this as well. Sadly, it's been long enough that I won't be able to remember the details for debugging. (I just happened to see this issue while looking for something else.)\n\nWhat I can say is that I've been able to (as far as I can tell) eliminate the possibility of missing data during a scroll by counting the number of documents I've seen and checking at the end of the scroll that it _exactly_ matches the total_hits reported by the initial query.\n\nThis seems like a good sanity check for anyone doing a scan&scroll, as there's no reason for the hits to differ from the total_hits.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172057998","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-172057998","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":172057998,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjA1Nzk5OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T19:17:08Z","updated_at":"2016-01-15T19:17:08Z","author_association":"CONTRIBUTOR","body":"The original issue looks like the cluster was overloaded. I don't think there is anything to do here.  Closing\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172104904","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-172104904","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":172104904,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjEwNDkwNA==","user":{"login":"vvcephei","id":832787,"node_id":"MDQ6VXNlcjgzMjc4Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/832787?v=4","gravatar_id":"","url":"https://api.github.com/users/vvcephei","html_url":"https://github.com/vvcephei","followers_url":"https://api.github.com/users/vvcephei/followers","following_url":"https://api.github.com/users/vvcephei/following{/other_user}","gists_url":"https://api.github.com/users/vvcephei/gists{/gist_id}","starred_url":"https://api.github.com/users/vvcephei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vvcephei/subscriptions","organizations_url":"https://api.github.com/users/vvcephei/orgs","repos_url":"https://api.github.com/users/vvcephei/repos","events_url":"https://api.github.com/users/vvcephei/events{/privacy}","received_events_url":"https://api.github.com/users/vvcephei/received_events","type":"User","site_admin":false},"created_at":"2016-01-15T21:53:49Z","updated_at":"2016-01-15T21:53:49Z","author_association":"CONTRIBUTOR","body":"Hey Clinton,\n\nYeah, our clusters are generally pretty heavily loaded, but I don't know\nhow to quantify it being overloaded.\n\nThis error actually happens to us all the time, and we simply detect it and\nstart the scroll again.\n\nThanks,\nJohn\n\nOn Friday, January 15, 2016, Clinton Gormley notifications@github.com\nwrote:\n\n> Closed #10417.\n> \n> â€”\n> Reply to this email directly or view it on GitHub.<\n> https://ci5.googleusercontent.com/proxy/D3fUvDCaH68UfTcyrC_41gEBYmFovoX9yBs4r5lq1Laf4bxsDbQSWk6_se-Oi4oNSPW8HJJdyOFXj7r0ZdCsnJNsF2dhmKquDRV0JrTGA0sxdrSwRx6x1s1ATQgnOXp5fiJiFvulaNuD4TduirJrHx3lOHzZMA=s0-d-e1-ft#https://github.com/notifications/beacon/AAy1E4J4EKL3Uyv3_42vkojmEbfE-RTrks5paT2FgaJpZM4D537e.gif\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172493108","html_url":"https://github.com/elastic/elasticsearch/issues/10417#issuecomment-172493108","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10417","id":172493108,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjQ5MzEwOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-18T10:36:16Z","updated_at":"2016-01-18T10:36:16Z","author_association":"CONTRIBUTOR","body":"@vvcephei see these in the logs from the https://github.com/elastic/elasticsearch/issues/10417#issuecomment-94538026:\n\n>  [indices:data/read/search[phase/scan/scroll]]]; nested: EsRejectedExecutionException[rejected execution (queue capacity 1000)\n\nYou can keep an eye on your search thread pool queue size.  If you're regularly filling it up then either you need (a) more efficient queries or (b) more hardware.\n","performed_via_github_app":null}]