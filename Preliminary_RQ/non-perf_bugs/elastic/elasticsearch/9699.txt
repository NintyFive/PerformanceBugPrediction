{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9699","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9699/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9699/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9699/events","html_url":"https://github.com/elastic/elasticsearch/issues/9699","id":57700311,"node_id":"MDU6SXNzdWU1NzcwMDMxMQ==","number":9699,"title":"Elasticsearch translog corruption if process is killed","user":{"login":"athanikkal","id":3370966,"node_id":"MDQ6VXNlcjMzNzA5NjY=","avatar_url":"https://avatars2.githubusercontent.com/u/3370966?v=4","gravatar_id":"","url":"https://api.github.com/users/athanikkal","html_url":"https://github.com/athanikkal","followers_url":"https://api.github.com/users/athanikkal/followers","following_url":"https://api.github.com/users/athanikkal/following{/other_user}","gists_url":"https://api.github.com/users/athanikkal/gists{/gist_id}","starred_url":"https://api.github.com/users/athanikkal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/athanikkal/subscriptions","organizations_url":"https://api.github.com/users/athanikkal/orgs","repos_url":"https://api.github.com/users/athanikkal/repos","events_url":"https://api.github.com/users/athanikkal/events{/privacy}","received_events_url":"https://api.github.com/users/athanikkal/received_events","type":"User","site_admin":false},"labels":[{"id":30486044,"node_id":"MDU6TGFiZWwzMDQ4NjA0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eregression","name":">regression","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":12,"created_at":"2015-02-14T17:40:54Z","updated_at":"2016-04-25T20:21:04Z","closed_at":"2015-03-03T15:32:15Z","author_association":"NONE","active_lock_reason":null,"body":"We found that Elasticsearch transaction log gets corrupted occasionally if the process is killed abruptly by any reason including power shutdown while indexing is going on. As the default translog flush interval is 5 seconds, we expect to loose transactions for the past 5 seconds not translog corruption in this case. This can be easily reproduced by invoking kill -9 on elasticsearch process repeatedly and restarting while sending index requests continuously.  I have attached 2 linux shell scripts to kill and restart ES.\n#### Extract from log:\n\n[2015-02-14 00:00:53,965][WARN ][indices.cluster          ] [r1s8-1.dg.com] [curr_1024][3] failed to start shard\norg.elasticsearch.index.gateway.IndexShardGatewayRecoveryException: [curr_1024][3] failed to recover shard\n        at org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:287)\n        at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:132)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)\nCaused by: org.elasticsearch.index.translog.TranslogCorruptedException: translog corruption while reading from stream\n        at org.elasticsearch.index.translog.ChecksummedTranslogStream.read(ChecksummedTranslogStream.java:70)\n        at org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:257)\n        ... 4 more\nCaused by: java.io.EOFException\n        at org.elasticsearch.common.io.stream.InputStreamStreamInput.readByte(InputStreamStreamInput.java:43)\n        at org.elasticsearch.index.translog.BufferedChecksumStreamInput.readByte(BufferedChecksumStreamInput.java:48)\n        at org.elasticsearch.common.io.stream.StreamInput.readInt(StreamInput.java:116)\n        at org.elasticsearch.common.io.stream.StreamInput.readLong(StreamInput.java:156)\n        at org.elasticsearch.index.translog.Translog$Create.readFrom(Translog.java:371)\n        at org.elasticsearch.index.translog.ChecksummedTranslogStream.read(ChecksummedTranslogStream.java:68)\n        ... 5 more\n[2015-02-14 00:00:53,979][WARN ][cluster.action.shard     ] [r1s8-1.dg.com] [curr_1024][3] sending failed shard for [curr_1024][3], node[9Ip4LaEbTnqVa8xOtVocHg], [P], s[INITIALIZING], indexUUID [F1efdIdUQwONYbyYMqloEg], reason [Failed to start shard, message [IndexShardGatewayRecoveryException[[curr_1024][3] failed to recover shard]; nested: TranslogCorruptedException[translog corruption while reading from stream]; nested: EOFException; ]]\n[2015-02-14 00:00:53,980][WARN ][cluster.action.shard     ] [r1s8-1.dg.com] [curr_1024][3] received shard failed for [curr_1024][3], node[9Ip4LaEbTnqVa8xOtVocHg], [P], s[INITIALIZING], indexUUID [F1efdIdUQwONYbyYMqloEg], reason [Failed to start shard, message [IndexShardGatewayRecoveryException[[curr_1024][3] failed to recover shard]; nested: TranslogCorruptedException[translog corruption while reading from stream]; nested: EOFException; ]]\n\n```\n/********************************************************/\nkilles.sh script\n/**********************************************************/\n#!/bin/sh\n#this script will kill ES periodically\n\nif [ -z \"$1\" ]\nthen\n    echo \"Usage: $0 <sleepinterval>\"\n    exit 1\nfi\n\nwhile [ : ]\ndo\n    pid=`ps aux | grep  elastic | grep -v \"grep\" | awk '{print $2}'`\n    if [ ! -z \"${pid}\" ]\n    then\n            echo \"killing es process $pid\"\n            kill -9 ${pid}\n    fi\n    sleep $1\ndone\n\n/*******************************************************************/\nrestart_es shell script\n/*******************************************************************/\n\n#!/bin/bash\n#This script is used to restart ES on failure\n\nES_ROOT=/var/ES\nexport ES_HEAP_SIZE=12g  # real size, for scale and performance testing\nES_HOME=/opt/elasticsearch\nexport ES_DIRECT_SIZE=1024m\nexport ES_JAVA_OPTS=\"-XX:HeapDumpPath=$ES_ROOT/cores/esheapdump.hprof\"\n\nwhile true; do\n    #start ES server in foreground\n    mkdir -p $ES_ROOT/log/\n    ulimit -n 65534;$ES_HOME/bin/elasticsearch -Des.node.name=\"`hostname`\"  2>&1 | logger -t es_mon\n    echo \"ES server exit with code $? , waiting to restart...\" | logger -t dg_es_mon\n    sleep 2  #pause before restart so ES processes can be cleaned up\ndone\n```\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}