{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8108","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8108/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8108/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8108/events","html_url":"https://github.com/elastic/elasticsearch/issues/8108","id":45966507,"node_id":"MDU6SXNzdWU0NTk2NjUwNw==","number":8108,"title":"Sampling aggregation to filter down to top-scoring docs","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-10-16T09:40:52Z","updated_at":"2015-04-21T09:30:58Z","closed_at":"2015-04-21T09:30:56Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"#### Requirement\n\nAs part of making https://github.com/elasticsearch/elasticsearch/pull/6796 more modular, there is a general need to limit analysis of documents to a subset of the top-matching results based on \n1. Quantity - some aggregations can be expensive to run on many documents so we need to cap the numbers\n2. Quality - the result set of a \"fuzzy\" search has a long-tail of low-quality results which we want to ignore\n\nAn example problem that requires capping is in a [recommendation problem like this](http://www.elasticsearch.org/blog/significant-terms-aggregation/#recommend) where the query can yield a large number of results and we want to cap the processing time of looking up background stats from disk by fixing the volumes of results we consider.\n#### Solution\n\nThe aggregation would be placed as a parent aggregation to the child aggs that need filtering. \n\n```\n{\n    \"query\": {\n        \"terms\": {\n            \"movie_id\": [\n                46970,\n                3726\n            ]\n        },\n        \"aggs\": {\n            \"qualityFilter\": {\n                \"top_docs_filter\": {\n                    \"shard_size\": 1000\n                },\n                \"aggregations\": {\n                    \"recommendations\": {\n                        \"significant_terms\": {\n                            \"field\": \"movie_id\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nThe assumption is we would always rank the top N selections on a shard based on the query score but there are various parameters we can use to control \"N\":\n1. An absolute number e.g. \"shard_size\" : 100\n2. An absolute score e.g.   \"min_score\" : 3.5\n3. A relative score i.e expressed as a percentage of max score:  \"relative_to_max_score\" : \"50%\"\n\nAll of these options could be used simultaneously as an OR rule for capping results.\nOption 3 would need to use a priority queue whose size is capped, either by a large sensible default or the setting chosen in 1.\n#### Concerns\n\nThere is a general concern over whether this feature is a new top-level agg which is a documented part of the Query DSL (as proposed here) or an implementation detail for existing aggs best hidden from the DSL and end users. The concerns with this proposal of use as a top-level agg are:\n##### Return value formatting\n\nWhile a potentially useful tool during execution of a query it is questionable that we would want to see this aggregation as a nested container in the search results. If we do choose to keep it as a container in results we could return some stats e.g number of rejected docs.\n##### Dangerous if forgotten\n\nIf you have a computationally expensive aggregation (e.g. a significant terms agg that needs to hit disk randomly) then you could argue it is a mistake to rely on end users configuring a separate parent agg to filter the volume of hits it processes. In the PR https://github.com/elasticsearch/elasticsearch/pull/6796 I made a conscious decision to couple the quality filter settings directly with the settings that enable use of the expensive disk-access mode. That way there's less chance of running a query-from-hell.\n##### Clash with top_hits agg\n\nIf we go down the route of making this filter a stand-alone agg then for consistency's sake the [existing top_hits agg](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html#search-aggregations-metrics-top-hits-aggregation) should be changed to be nested under this. In fact, we can refactor its sort and pagination features into the functionality proposed by this filtering agg.\n### Conclusion\n\nWe need to decide if this functionality needs breaking out as a new agg feature in the DSL.\nIf we choose not to do this we need to at least have some DSL consistency and reuse of sampling logic that is defined on things like top_hits agg and signifcant_terms.\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}