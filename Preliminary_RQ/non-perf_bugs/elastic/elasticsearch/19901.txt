{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19901","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19901/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19901/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19901/events","html_url":"https://github.com/elastic/elasticsearch/issues/19901","id":170299940,"node_id":"MDU6SXNzdWUxNzAyOTk5NDA=","number":19901,"title":"Add warning to pattern tokenizer documentation","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-08-10T00:06:53Z","updated_at":"2016-09-15T09:22:16Z","closed_at":"2016-09-15T09:22:15Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.x\n\nWe have encountered a scenario where a bad document is passed to the pattern tokenizer with a regex that ended up causing recursion or endless backtracking so that it ran out of stack space.\n\n```\njava.lang.StackOverflowError\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n    at java.util.regex.Pattern$GroupTail.match(Pattern.java:4717)\n    at java.util.regex.Pattern$BranchConn.match(Pattern.java:4568)\n    at java.util.regex.Pattern$CharProperty.match(Pattern.java:3777)\n    at java.util.regex.Pattern$Branch.match(Pattern.java:4604)\n    at java.util.regex.Pattern$GroupHead.match(Pattern.java:4658)\n    at java.util.regex.Pattern$Loop.match(Pattern.java:4785)\n```\n\nThere are a few caveats when using the pattern tokenizer that will be helpful to [document](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-pattern-tokenizer.html) in the product.\n- The pattern tokenizer uses the  JDK implementation (java.util.regex) which can easily do very trappy things (e.g. run in exponential time).  Various issues have been reported in the field by users of Java (http://bugs.java.com/bugdatabase/view_bug.do?bug_id=6337993) as well as Lucene (https://issues.apache.org/jira/browse/LUCENE-7256).  These are JDK issues so not something Lucene can address.\n- Unlike other Lucene analysis chains, it currently reads the entire doc [into RAM](https://github.com/apache/lucene-solr/blob/master/lucene/analysis/common/src/java/org/apache/lucene/analysis/pattern/PatternTokenizer.java#L156-L157).\n- In general, it is less performant than other options.  For example, one alternate (more efficient) method is to avoid using regex entirely by using the [mapping char filter](https://www.elastic.co/guide/en/elasticsearch/reference/2.3/analysis-mapping-charfilter.html) to map the different characters in the pattern tokenizer to a space so that the standard tokenizer will just split on them (since it sees it as a space). \n- Best to note in the documentation that the pattern tokenizer is considered an expert/advanced feature given the implications of using java.util.regex.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}