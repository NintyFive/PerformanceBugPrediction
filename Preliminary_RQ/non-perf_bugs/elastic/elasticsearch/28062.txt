{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28062","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28062/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28062/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28062/events","html_url":"https://github.com/elastic/elasticsearch/issues/28062","id":285696756,"node_id":"MDU6SXNzdWUyODU2OTY3NTY=","number":28062,"title":"Memory not reclaimed by GC","user":{"login":"ripjarphil","id":24223157,"node_id":"MDQ6VXNlcjI0MjIzMTU3","avatar_url":"https://avatars2.githubusercontent.com/u/24223157?v=4","gravatar_id":"","url":"https://api.github.com/users/ripjarphil","html_url":"https://github.com/ripjarphil","followers_url":"https://api.github.com/users/ripjarphil/followers","following_url":"https://api.github.com/users/ripjarphil/following{/other_user}","gists_url":"https://api.github.com/users/ripjarphil/gists{/gist_id}","starred_url":"https://api.github.com/users/ripjarphil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ripjarphil/subscriptions","organizations_url":"https://api.github.com/users/ripjarphil/orgs","repos_url":"https://api.github.com/users/ripjarphil/repos","events_url":"https://api.github.com/users/ripjarphil/events{/privacy}","received_events_url":"https://api.github.com/users/ripjarphil/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2018-01-03T14:07:25Z","updated_at":"2018-03-14T02:41:20Z","closed_at":"2018-03-14T02:41:20Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 5.5.1\r\n\r\n**JVM version**:\r\n`\r\nopenjdk version \"1.8.0_151\"\r\nOpenJDK Runtime Environment (build 1.8.0_151-b12)\r\nOpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n`\r\n\r\n**OS version**: `Linux box3-3 3.10.0-693.5.2.el7.x86_64 #1 SMP Fri Oct 20 20:32:50 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem**:\r\n\r\nThe memory used by our elastic cluster grew massively over an 8 hour period, and memory was not freed by the GC. During this time we were performing the following on the cluster:\r\n\r\n * indexing about 300k documents over 8 hours\r\n * scroll over 67 million documents. Scroll size was 100 and scroll parameter was '5m'. \r\n * very very few searches/queries, if any.\r\n\r\nThe scroll was started on 2017-12-28, so when this runaway memory usage was observed it had been running for almost 2 days. The index we're scrolling over is about 2.7TB in size, 67 million documents and is spread over 27 shards across 9 nodes.\r\n\r\nThe indexing is happening on a different index to the one that is being scrolled.\r\n\r\nIt looks like the GC runs, but is unable to recover any memory. \r\n\r\nI would like to understand what is happening, and whether this use case is triggering a bug in Elastic? Please let me know if there is any other relevant information I should provide.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2017-12-30T00:03:25,547][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][681591][154802] duration [740ms], collections [1]/[1.1s], total [740ms]/[2.9h], memory [9.6gb]->[8.8gb]/[29.8gb], all_pools {[young] [758.1mb]->[6mb]/[865.3mb]}{[survivor] [37.5mb]->[41mb]/[108.1mb]}{[old] [8.8gb]->[8.8gb]/[28.9gb]}\r\n[2017-12-30T02:46:35,000][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][691310][156235] duration [801ms], collections [1]/[1s], total [801ms]/[3h], memory [15gb]->[14.4gb]/[29.8gb], all_pools {[young] [769.4mb]->[40.6mb]/[865.3mb]}{[survivor] [64.4mb]->[108.1mb]/[108.1mb]}{[old] [14.2gb]->[14.2gb]/[28.9gb]}\r\n[2017-12-30T06:54:18,101][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][706070][159171] duration [988ms], collections [1]/[1.2s], total [988ms]/[3.1h], memory [10.3gb]->[9.6gb]/[29.8gb], all_pools {[young] [861.1mb]->[18.8mb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [9.4gb]->[9.5gb]/[28.9gb]}\r\n[2017-12-30T07:10:25,618][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][707025][159322] duration [708ms], collections [1]/[1.5s], total [708ms]/[3.1h], memory [12.2gb]->[11.6gb]/[29.8gb], all_pools {[young] [770mb]->[33.2mb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [11.4gb]->[11.5gb]/[28.9gb]}\r\n[2017-12-30T07:54:21,818][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][709626][159767] duration [1.2s], collections [1]/[2s], total [1.2s]/[3.1h], memory [24.1gb]->[23.5gb]/[29.8gb], all_pools {[young] [796.8mb]->[18mb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [23.2gb]->[23.4gb]/[28.9gb]}\r\n[2017-12-30T08:00:02,691][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][709961][159818] duration [772ms], collections [1]/[1.4s], total [772ms]/[3.1h], memory [26gb]->[25.4gb]/[29.8gb], all_pools {[young] [743.8mb]->[4.2mb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [25.1gb]->[25.3gb]/[28.9gb]}\r\n[2017-12-30T08:05:57,862][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][710312][159872] duration [853ms], collections [1]/[1.1s], total [853ms]/[3.1h], memory [27.6gb]->[26.9gb]/[29.8gb], all_pools {[young] [812.7mb]->[358.8kb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [26.7gb]->[26.8gb]/[28.9gb]}\r\n[2017-12-30T08:07:06,969][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][710379][159881] duration [922ms], collections [1]/[1.9s], total [922ms]/[3.1h], memory [28gb]->[27.4gb]/[29.8gb], all_pools {[young] [820.9mb]->[16.8mb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [27.1gb]->[27.2gb]/[28.9gb]}\r\n[2017-12-30T08:09:42,187][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][710531][159904] duration [726ms], collections [1]/[1.7s], total [726ms]/[3.1h], memory [28.1gb]->[27.6gb]/[29.8gb], all_pools {[young] [535.2mb]->[5.8mb]/[865.3mb]}{[survivor] [108.1mb]->[90.5mb]/[108.1mb]}{[old] [27.5gb]->[27.5gb]/[28.9gb]}\r\n[2017-12-30T08:12:18,255][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][710685][159933] duration [718ms], collections [1]/[1s], total [718ms]/[3.1h], memory [29.4gb]->[28.6gb]/[29.8gb], all_pools {[young] [844.9mb]->[3.5mb]/[865.3mb]}{[survivor] [108.1mb]->[108.1mb]/[108.1mb]}{[old] [28.4gb]->[28.5gb]/[28.9gb]}\r\n[2017-12-30T08:14:24,685][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][710702][159935] duration [827ms], collections [1]/[1.8m], total [827ms]/[3.1h], memory [29.6gb]->[28.4gb]/[29.8gb], all_pools {[young] [840.9mb]->[301.3mb]/[865.3mb]}{[survivor] [108.1mb]->[0b]/[108.1mb]}{[old] [28.7gb]->[28.1gb]/[28.9gb]}\r\n[2017-12-30T08:14:24,685][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710702][70] duration [1.8m], collections [1]/[1.8m], total [1.8m]/[2.6m], memory [29.6gb]->[28.4gb]/[29.8gb], all_pools {[young] [840.9mb]->[301.3mb]/[865.3mb]}{[survivor] [108.1mb]->[0b]/[108.1mb]}{[old] [28.7gb]->[28.1gb]/[28.9gb]}\r\n[2017-12-30T08:14:25,685][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][710703][159936] duration [813ms], collections [1]/[1.1s], total [813ms]/[3.1h], memory [28.4gb]->[28.6gb]/[29.8gb], all_pools {[young] [301.3mb]->[33.1mb]/[865.3mb]}{[survivor] [0b]->[108.1mb]/[108.1mb]}{[old] [28.1gb]->[28.5gb]/[28.9gb]}\r\n[2017-12-30T08:16:23,778][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710704][71] duration [1.9m], collections [1]/[1.9m], total [1.9m]/[4.5m], memory [28.6gb]->[28.7gb]/[29.8gb], all_pools {[young] [33.1mb]->[44.1mb]/[865.3mb]}{[survivor] [108.1mb]->[0b]/[108.1mb]}{[old] [28.5gb]->[28.6gb]/[28.9gb]}\r\n[2017-12-30T08:17:48,492][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710705][72] duration [1.4m], collections [1]/[1.4m], total [1.4m]/[6m], memory [28.7gb]->[28.7gb]/[29.8gb], all_pools {[young] [44.1mb]->[15.4mb]/[865.3mb]}{[survivor] [0b]->[0b]/[108.1mb]}{[old] [28.6gb]->[28.7gb]/[28.9gb]}\r\n[2017-12-30T08:19:24,172][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710706][73] duration [1.5m], collections [1]/[1.5m], total [1.5m]/[7.5m], memory [28.7gb]->[28.9gb]/[29.8gb], all_pools {[young] [15.4mb]->[62.4mb]/[865.3mb]}{[survivor] [0b]->[0b]/[108.1mb]}{[old] [28.7gb]->[28.8gb]/[28.9gb]}\r\n[2017-12-30T08:20:56,286][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710707][74] duration [1.5m], collections [1]/[1.5m], total [1.5m]/[9.1m], memory [28.9gb]->[29gb]/[29.8gb], all_pools {[young] [62.4mb]->[128.5mb]/[865.3mb]}{[survivor] [0b]->[0b]/[108.1mb]}{[old] [28.8gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:22:58,643][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710708][75] duration [2m], collections [1]/[2m], total [2m]/[11.1m], memory [29gb]->[29.7gb]/[29.8gb], all_pools {[young] [128.5mb]->[794.5mb]/[865.3mb]}{[survivor] [0b]->[0b]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:24:26,254][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710710][76] duration [1.4m], collections [1]/[1.4m], total [1.4m]/[12.5m], memory [29.8gb]->[29.3gb]/[29.8gb], all_pools {[young] [865.3mb]->[464.2mb]/[865.3mb]}{[survivor] [97.2mb]->[0b]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:26:31,524][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710712][77] duration [2m], collections [1]/[2m], total [2m]/[14.6m], memory [29.8gb]->[29.6gb]/[29.8gb], all_pools {[young] [865.3mb]->[735mb]/[865.3mb]}{[survivor] [54.8mb]->[0b]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:28:08,424][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710713][78] duration [1.5m], collections [1]/[1.5m], total [1.5m]/[16.2m], memory [29.6gb]->[29.7gb]/[29.8gb], all_pools {[young] [735mb]->[865.3mb]/[865.3mb]}{[survivor] [0b]->[2.2mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:30:02,460][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710714][79] duration [1.8m], collections [1]/[1.9m], total [1.8m]/[18m], memory [29.7gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [2.2mb]->[28.2mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:31:26,668][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710715][80] duration [1.3m], collections [1]/[1.4m], total [1.3m]/[19.4m], memory [29.8gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [28.2mb]->[77mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:33:30,638][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710716][81] duration [2m], collections [1]/[2m], total [2m]/[21.5m], memory [29.8gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [77mb]->[90.7mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:35:09,158][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710717][82] duration [1.6m], collections [1]/[1.6m], total [1.6m]/[23.1m], memory [29.8gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [90.7mb]->[90mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:37:17,525][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710718][83] duration [2.1m], collections [1]/[2.1m], total [2.1m]/[25.3m], memory [29.8gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [90mb]->[102.1mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:38:50,814][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710719][84] duration [1.5m], collections [1]/[1.5m], total [1.5m]/[26.8m], memory [29.8gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [102.1mb]->[106mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T08:51:45,761][WARN ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][old][710720][92] duration [12.9m], collections [8]/[4.6m], total [12.9m]/[39.7m], memory [29.8gb]->[29.8gb]/[29.8gb], all_pools {[young] [865.3mb]->[865.3mb]/[865.3mb]}{[survivor] [106mb]->[108mb]/[108.1mb]}{[old] [28.9gb]->[28.9gb]/[28.9gb]}\r\n[2017-12-30T10:52:59,952][WARN ][o.e.c.s.ClusterService   ] [box1-2] cluster state update task [zen-disco-receive(from master [master {box3-1}{Ac6MqR9tROioMFgKsfK-Xg}{TRONPx01S2-KSnuPVDHPdQ}{box3-1}{10.10.10.160:9300} committed version [27635]])] took [44.2s] above the warn threshold of 30s\r\n[2017-12-30T11:01:34,122][INFO ][o.e.m.j.JvmGcMonitorService] [box1-2] [gc][young][560][27] duration [889ms], collections [1]/[1s], total [889ms]/[5.9s], memory [2.2gb]->[1.4gb]/[29.8gb], all_pools {[young] [857.3mb]->[3.1mb]/[865.3mb]}{[survivor] [106.9mb]->[84.5mb]/[108.1mb]}{[old] [1.3gb]->[1.3gb]/[28.9gb]}\r\n```\r\n\r\n  ","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}