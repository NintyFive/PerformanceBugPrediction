{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16405","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16405/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16405/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16405/events","html_url":"https://github.com/elastic/elasticsearch/issues/16405","id":130975897,"node_id":"MDU6SXNzdWUxMzA5NzU4OTc=","number":16405,"title":"BalancedShardsAllocator mutates keys in HashMap","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-02-03T10:01:28Z","updated_at":"2018-02-14T14:05:30Z","closed_at":"2016-05-10T19:28:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The shard balancer currently relies on model nodes and model indices to simulate moving shards around in the cluster. Each model node contains a set of model indices. A model index represents a set of shards of the same index that are allocated to the node that owns the model index. Currently model indices store their shards in a hash map.\n\nFirst observation: allocation decisions stored as map values are actually never used, and can be removed.\nSecond observation: ShardRouting instances in the shard balancer are mutable and are modified while being keys in the map of the model index. Mutating a key in a hashmap is dangerous as the element can then not be found anymore. Luckily, for now the map is not accessed by key after an instance in it is mutated. This is, however, all but clear from the current implementation. I looked at it in detail and it works, but only for the following reasons:\n- in the method `tryRelocateShard`: After shard is added to the map, its state is changed from started to relocated but then it is not considered anymore for the containsShard() method and removeShard() method in subsequent calls of tryRelocateShard as we pass only started shards to these methods here.\n- in the method `allocateUnassigned`: After shard is added to the map, its state is changed from unassigned to initializing. This shard is then not considered in this method anymore.\n- in the `move` method: Safe as it removes shard routing from the map before changing it.\n\nAlthough this works for now, it is very fragile and has high chances of future bugs.\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}