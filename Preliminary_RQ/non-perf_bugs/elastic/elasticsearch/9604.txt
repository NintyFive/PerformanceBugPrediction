{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9604","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9604/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9604/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9604/events","html_url":"https://github.com/elastic/elasticsearch/issues/9604","id":56873831,"node_id":"MDU6SXNzdWU1Njg3MzgzMQ==","number":9604,"title":"Shards stuck after deleting & recreating index","user":{"login":"demon","id":55804,"node_id":"MDQ6VXNlcjU1ODA0","avatar_url":"https://avatars2.githubusercontent.com/u/55804?v=4","gravatar_id":"","url":"https://api.github.com/users/demon","html_url":"https://github.com/demon","followers_url":"https://api.github.com/users/demon/followers","following_url":"https://api.github.com/users/demon/following{/other_user}","gists_url":"https://api.github.com/users/demon/gists{/gist_id}","starred_url":"https://api.github.com/users/demon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/demon/subscriptions","organizations_url":"https://api.github.com/users/demon/orgs","repos_url":"https://api.github.com/users/demon/repos","events_url":"https://api.github.com/users/demon/events{/privacy}","received_events_url":"https://api.github.com/users/demon/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-02-06T21:57:32Z","updated_at":"2015-02-12T20:35:50Z","closed_at":"2015-02-12T20:35:50Z","author_association":"NONE","active_lock_reason":null,"body":"This is a test environment that has 4 nodes, all are master eligible. I need to reimage them all with a new partition scheme, so I took the first node offline for reinstall.\n\nCluster state was then red as 2 indexes had primary shards they couldn't allocate. Fair enough, it's all test data and can rebuild. Dropped the indexes and the unallocated shards disappeared. Cluster back to green.\n\nRecreated the indexes but the old shards showed back up again and put the cluster back into red. At this point I tried to force allocate them. Doing that results in:\n\n```\nElasticsearchIllegalArgumentException[[allocate] allocation of [enwiki_general_first][6] on node [deployment-elastic05][wSPDvi8cRDWOvfgXcnvm6w][deployment-elastic05][inet[/10.68.17.179:9300]]{master=true} is not allowed, reason: [NO(shard cannot be allocated on same node [wSPDvi8cRDWOvfgXcnvm6w] it already exists on)][YES(node passes include/exclude/require filters)][YES(primary is already active)][YES(below shard recovery limit of [2])][YES(allocation disabling is ignored)][YES(allocation disabling is ignored)][YES(no allocation awareness enabled)][YES(total shard limit disabled: [-1] <= 0)][YES(target node version [1.3.7] is same or newer than source node version [1.3.7])][YES(enough disk for shard on node, free: [56.4gb])][YES(shard not primary or relocation disabled)]]\n```\n\nI figured this means that it wasn't able to allocate the shard because such a shard exists already. I thought I'd outsmart things by dropping the index again and trying to allocate when there was no such index. No dice :(\n\n```\nElasticsearchIllegalArgumentException[[allocate] failed to find [enwiki_general_first][6] on the list of unassigned shards]\n```\n\nAt this point I knew we have some pretty messed up shards stuck somewhere. Thinking it was stuck in memory, I did a full cluster shutdown of all 4 nodes. After bringing them back up, the phantom shards still exist.\n\nIt's ultimately all test data so I could just nuke /var/lib/elasticsearch and start over but I'm more curious if there's a way out in case something so sinister happened to a production install. Or if there's any underlying bug here.\n","closed_by":{"login":"demon","id":55804,"node_id":"MDQ6VXNlcjU1ODA0","avatar_url":"https://avatars2.githubusercontent.com/u/55804?v=4","gravatar_id":"","url":"https://api.github.com/users/demon","html_url":"https://github.com/demon","followers_url":"https://api.github.com/users/demon/followers","following_url":"https://api.github.com/users/demon/following{/other_user}","gists_url":"https://api.github.com/users/demon/gists{/gist_id}","starred_url":"https://api.github.com/users/demon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/demon/subscriptions","organizations_url":"https://api.github.com/users/demon/orgs","repos_url":"https://api.github.com/users/demon/repos","events_url":"https://api.github.com/users/demon/events{/privacy}","received_events_url":"https://api.github.com/users/demon/received_events","type":"User","site_admin":false},"performed_via_github_app":null}