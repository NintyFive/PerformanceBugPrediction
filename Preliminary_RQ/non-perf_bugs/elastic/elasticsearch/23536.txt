{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23536","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23536/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23536/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23536/events","html_url":"https://github.com/elastic/elasticsearch/issues/23536","id":213309500,"node_id":"MDU6SXNzdWUyMTMzMDk1MDA=","number":23536,"title":"multi_match phrase type query seems to ignore shingle filters","user":{"login":"jeantil","id":22979,"node_id":"MDQ6VXNlcjIyOTc5","avatar_url":"https://avatars3.githubusercontent.com/u/22979?v=4","gravatar_id":"","url":"https://api.github.com/users/jeantil","html_url":"https://github.com/jeantil","followers_url":"https://api.github.com/users/jeantil/followers","following_url":"https://api.github.com/users/jeantil/following{/other_user}","gists_url":"https://api.github.com/users/jeantil/gists{/gist_id}","starred_url":"https://api.github.com/users/jeantil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeantil/subscriptions","organizations_url":"https://api.github.com/users/jeantil/orgs","repos_url":"https://api.github.com/users/jeantil/repos","events_url":"https://api.github.com/users/jeantil/events{/privacy}","received_events_url":"https://api.github.com/users/jeantil/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-03-10T10:55:42Z","updated_at":"2018-02-14T13:29:14Z","closed_at":"2017-04-21T13:06:32Z","author_association":"NONE","active_lock_reason":null,"body":"Using the official elasticsearch docker image elasticsearch:5.2.2\r\n\r\nElasticsearch version: 5.2.2\r\nPlugins installed: [] (no plugins installed)\r\nJVM version :\r\n```\r\n\"version\": \"1.8.0_121\",\r\n\"vm_name\": \"OpenJDK 64-Bit Server VM\",\r\n\"vm_vendor\": \"Oracle Corporation\",\r\n\"vm_version\": \"25.121-b13\"\r\n```\r\nOS version: MacOS sierra 10.12.2 (16C67)\r\n```\r\n\"os\": {\r\n  \"allocated_processors\": 4,\r\n  \"arch\": \"amd64\",\r\n  \"available_processors\": 4,\r\n  \"name\": \"Linux\",\r\n  \"refresh_interval_in_millis\": 1000,\r\n  \"version\": \"4.9.12-moby\"\r\n}\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen using a multi match query of type phrase it looks like query shingling is ignored and every shingle value is instead replaced by the input of the shingle  filter.\r\n\r\n**Steps to reproduce**:\r\n```\r\nDELETE /t\r\n\r\nPUT /t\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"analysis\": {\r\n      \"filter\":{\r\n         \"search_shingler\": {\r\n              \"max_shingle_size\": \"5\",\r\n              \"min_shingle_size\": \"2\",\r\n              \"token_separator\": \" \",\r\n              \"output_unigrams\": \"true\",\r\n              \"filler_token\": \"_\",\r\n              \"output_unigrams_if_no_shingles\": \"true\",\r\n              \"type\": \"shingle\"\r\n            }\r\n      },\r\n      \"analyzer\": {\r\n        \"phraser\":{\r\n           \"filter\": [\r\n                \"search_shingler\"\r\n              ],\r\n              \"type\": \"custom\",\r\n              \"tokenizer\": \"whitespace\"\r\n            }\r\n        }\r\n      }\r\n    },\r\n  \"mappings\": {\r\n    \"t\":{\r\n      \"properties\":{\r\n        \"foo\": {\r\n            \"type\": \"text\",\r\n            \"store\": true,\r\n            \"term_vector\": \"with_positions_offsets\",\r\n            \"norms\": false,\r\n            \"analyzer\": \"standard\", \r\n            \"search_analyzer\": \"phraser\",\r\n            \"fielddata\": true\r\n          }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST /t/t\r\n{\"foo\": \"foo bar\"}\r\n\r\nGET t/_analyze?analyzer=standard&text=foo bar baz\r\nGET t/_analyze?analyzer=phraser&text=foo bar baz\r\n\r\nGET /t/t/_validate/query?explain=true\r\n{\r\n  \"query\": {\r\n    \"multi_match\": {\r\n      \"query\": \"foo bar baz\",\r\n      \"fields\": \"foo\",\r\n      \"type\": \"phrase\"\r\n    }\r\n  }\r\n}\r\n\r\n\r\nGET /_search\r\n{\r\n  \"query\": {\r\n    \"multi_match\": {\r\n      \"query\": \"foo bar baz\",\r\n      \"fields\": \"foo\",\r\n      \"type\": \"phrase\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI would expect the query to match  since the query time phraser analyzer generates shingles for the expected sentence but the query doesn't match. \r\nMost surprising is that the validate api returns \r\n```\r\n{\r\n  \"valid\": true,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"explanations\": [\r\n    {\r\n      \"index\": \"t\",\r\n      \"valid\": true,\r\n      \"explanation\": \"\"\"+Graph(foo:\"foo bar baz\", foo:\"foo bar baz\", foo:\"foo bar baz\", foo:foo bar baz, hasBoolean=false, hasPhrase=true) #(#_type:t)\"\"\"\r\n    }\r\n  ]\r\n}\r\n```\r\nwhere I would expect it to use the shingles instead\r\n```\r\n{\r\n  \"valid\": true,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"explanations\": [\r\n    {\r\n      \"index\": \"t\",\r\n      \"valid\": true,\r\n      \"explanation\": \"\"\"+Graph(foo:\"foo\", foo:\"bar\", foo:\"baz\",foo:\"foo bar\",foo:\"bar baz\",foo:\"foo bar baz\", foo:foo bar baz, hasBoolean=false, hasPhrase=true) #(#_type:t)\"\"\"\r\n    }\r\n  ]\r\n}\r\n```\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}