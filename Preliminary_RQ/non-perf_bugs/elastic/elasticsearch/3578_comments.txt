[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23324996","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23324996","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23324996,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMzI0OTk2","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-08-27T10:02:31Z","updated_at":"2013-08-27T10:02:31Z","author_association":"CONTRIBUTOR","body":"if it is of any help, here are the stats for my shards(the cluster was not receiving updates at this moment, just to be sure the shards were equal): https://gist.github.com/lmenezes/6351739\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23325899","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23325899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23325899,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMzI1ODk5","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-08-27T10:20:58Z","updated_at":"2013-08-27T10:21:08Z","author_association":"CONTRIBUTOR","body":"hey @lmenezes, `max_docs` is the total number of documents in the shard including deletes. So if one shard has already merged away a bigger segment you can easily see a bid difference here. The `frequency` you mean is the `document_frequency` and that is calculated based on the `num_docs` (withou deletions).\n\n>  is it then possible to have a consistent sorting(based on score) with this scenario?\n\nyou mean across requests, well yes you can you can use a `_preference` based on a session id or a users ID to get a consistent result set so you hit the same replicas all the time. The problem here might be 1. tie-breaking since lucene by default tie-breaks on doc ID which is shard dependent (internal doc id) 2. Differences in Refreshes since one replica might already have refreshed...\n\ndoes this make sense?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23326258","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23326258","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23326258,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMzI2MjU4","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-08-27T10:29:54Z","updated_at":"2013-08-27T10:29:54Z","author_association":"CONTRIBUTOR","body":"yep, that's exactly what i needed. but it's \"preference\", right? no _ in front of it. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23326630","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23326630","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23326630,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMzI2NjMw","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-08-27T10:38:56Z","updated_at":"2013-08-27T10:39:02Z","author_association":"CONTRIBUTOR","body":"> yep, that's exactly what i needed. but it's \"preference\", right? no _ in front of it.\n\nah yeah maybe :) \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23400016","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23400016","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23400016,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDAwMDE2","user":{"login":"peschlowp","id":1713347,"node_id":"MDQ6VXNlcjE3MTMzNDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1713347?v=4","gravatar_id":"","url":"https://api.github.com/users/peschlowp","html_url":"https://github.com/peschlowp","followers_url":"https://api.github.com/users/peschlowp/followers","following_url":"https://api.github.com/users/peschlowp/following{/other_user}","gists_url":"https://api.github.com/users/peschlowp/gists{/gist_id}","starred_url":"https://api.github.com/users/peschlowp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peschlowp/subscriptions","organizations_url":"https://api.github.com/users/peschlowp/orgs","repos_url":"https://api.github.com/users/peschlowp/repos","events_url":"https://api.github.com/users/peschlowp/events{/privacy}","received_events_url":"https://api.github.com/users/peschlowp/received_events","type":"User","site_admin":false},"created_at":"2013-08-28T08:54:59Z","updated_at":"2013-08-28T08:54:59Z","author_association":"CONTRIBUTOR","body":"I face a similar (or maybe exactly the same) issue described in https://groups.google.com/forum/#!topic/elasticsearch/RJAT6MR4sHQ.\n\nIn my case, four nodes (one primary shard and three replicas) have the same \"num_docs\" but huge differences in \"deleted\" count. This explains why \"max_docs\" is different, but as far as I understood from the discussion above, the score computation ignores the deleted documents and is only based on those reflected by \"num_docs\" (which is equal on all nodes).\n\nBut if that's true, how come that the score computations differ for identical queries sent to the four nodes?\n\nTie-breaking is not the issue in my case because the scores are actually different. And I don't think that refreshes are the issue, because the symptom persists even after several hours without changes to the index and explicitly requested refresh.\n\nMaybe I misunderstood something. Anyway I hope you can clarify this once more :-)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23400525","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23400525","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23400525,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDAwNTI1","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-08-28T09:04:58Z","updated_at":"2013-08-28T09:04:58Z","author_association":"CONTRIBUTOR","body":"hey @peschlowp \nactually i think its not the num_docs, but the max_docs which is used while computing score. i just got the explanation for a query as an example:\n\nvalue: 0.99963135,\ndescription: queryWeight, product of:\n    details: [ \n{ value: 10, description: boost},\n{value: 3.6819985,description: idf(docFreq=79358, maxDocs=1159774)},\n{value: 0.027149152, description: queryNorm}\n]\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23400637","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23400637","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23400637,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDAwNjM3","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-08-28T09:07:30Z","updated_at":"2013-08-28T09:07:30Z","author_association":"CONTRIBUTOR","body":"@peschlowp well deleted documents still contribute to the score calculation since they are only marked as deleted but statistics are not updated so yes they contribute to the score. I confused num_docs in my explain above though. Sorry about that.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23400798","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23400798","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23400798,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDAwNzk4","user":{"login":"peschlowp","id":1713347,"node_id":"MDQ6VXNlcjE3MTMzNDc=","avatar_url":"https://avatars1.githubusercontent.com/u/1713347?v=4","gravatar_id":"","url":"https://api.github.com/users/peschlowp","html_url":"https://github.com/peschlowp","followers_url":"https://api.github.com/users/peschlowp/followers","following_url":"https://api.github.com/users/peschlowp/following{/other_user}","gists_url":"https://api.github.com/users/peschlowp/gists{/gist_id}","starred_url":"https://api.github.com/users/peschlowp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peschlowp/subscriptions","organizations_url":"https://api.github.com/users/peschlowp/orgs","repos_url":"https://api.github.com/users/peschlowp/repos","events_url":"https://api.github.com/users/peschlowp/events{/privacy}","received_events_url":"https://api.github.com/users/peschlowp/received_events","type":"User","site_admin":false},"created_at":"2013-08-28T09:10:42Z","updated_at":"2013-08-28T09:10:42Z","author_association":"CONTRIBUTOR","body":"Thanks for clarifying! I have to confess that I don't like the fact that deleted documents still contribute the to score (doesn't seem intuitive from a user's point of view), but on the other hand now at least the observed behavior makes sense :-)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23445510","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-23445510","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":23445510,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDQ1NTEw","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-08-28T20:37:28Z","updated_at":"2013-08-28T20:37:28Z","author_association":"CONTRIBUTOR","body":"> I have to confess that I don't like the fact that deleted documents still contribute the to score\n\nI can see how this is confusing but in practice this is hardly a problem. In fact that is most of the search indices work. Given the write once nature of lucene it's safe to say this won't change in the near future :)\n\nsorry about the confusion.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/476436544","html_url":"https://github.com/elastic/elasticsearch/issues/3578#issuecomment-476436544","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3578","id":476436544,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjQzNjU0NA==","user":{"login":"rocketraman","id":53049,"node_id":"MDQ6VXNlcjUzMDQ5","avatar_url":"https://avatars1.githubusercontent.com/u/53049?v=4","gravatar_id":"","url":"https://api.github.com/users/rocketraman","html_url":"https://github.com/rocketraman","followers_url":"https://api.github.com/users/rocketraman/followers","following_url":"https://api.github.com/users/rocketraman/following{/other_user}","gists_url":"https://api.github.com/users/rocketraman/gists{/gist_id}","starred_url":"https://api.github.com/users/rocketraman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocketraman/subscriptions","organizations_url":"https://api.github.com/users/rocketraman/orgs","repos_url":"https://api.github.com/users/rocketraman/repos","events_url":"https://api.github.com/users/rocketraman/events{/privacy}","received_events_url":"https://api.github.com/users/rocketraman/received_events","type":"User","site_admin":false},"created_at":"2019-03-26T01:18:04Z","updated_at":"2019-03-26T01:18:04Z","author_association":"NONE","body":"Well, heck, its 2019. Why not revive this thread? :-)\r\n\r\nWe just ran into the same issue, and the cause was a different number of deleted documents between the primary and replica of the same shard. We were already using \"dfs_query_then_fetch\" which we expected would solve the problem, but it did not.\r\n\r\nFor calculating doc counts when using dfs_query_then_fetch (at which point you're already incurring a perf penalty to get the stats from every shard), why not just use the active doc count instead of the maxDocs value? And if that is too big a performance hit, then at the very least this should be documented. Neither the blog page about DFS (https://www.elastic.co/blog/understanding-query-then-fetch-vs-dfs-query-then-fetch), the docs about DFS (https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-search-type.html), nor the page about Preference (https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-preference.html) explain this problem. The `search_after` (https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-search-after.html) docs could also mention this, as consistent scoring is necessary when using the score with `search_after`.","performed_via_github_app":null}]