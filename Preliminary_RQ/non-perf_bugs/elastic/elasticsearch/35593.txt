{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35593","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35593/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35593/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35593/events","html_url":"https://github.com/elastic/elasticsearch/issues/35593","id":381181592,"node_id":"MDU6SXNzdWUzODExODE1OTI=","number":35593,"title":"NodeDisconnectedException in CCR stats doc tests","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":912824565,"node_id":"MDU6TGFiZWw5MTI4MjQ1NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CCR","name":":Distributed/CCR","color":"0e8a16","default":false,"description":"Issues around the Cross Cluster State Replication features"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-11-15T14:20:08Z","updated_at":"2018-11-15T15:23:56Z","closed_at":"2018-11-15T15:23:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The following run failed:\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=opensuse/60/console\r\n\r\nThe failure was that `number_of_failed_remote_cluster_state_requests` yielded 1 but was expected to yield 0:\r\n\r\n```\r\n  1> [2018-11-15T05:48:22,692][INFO ][o.e.s.DocsClientYamlTestSuiteIT] [test] Stash dump on test failure [{\r\n  1>   \"stash\" : {\r\n  1>     \"body\" : {\r\n  1>       \"auto_follow_stats\" : {\r\n  1>         \"number_of_failed_follow_indices\" : 0,\r\n  1>         \"number_of_failed_remote_cluster_state_requests\" : 1,\r\n  1>         \"number_of_successful_follow_indices\" : 0,\r\n  1>         \"recent_auto_follow_errors\" : [\r\n  1>           {\r\n  1>             \"leader_index\" : \"my_auto_follow_pattern\",\r\n  1>             \"auto_follow_exception\" : {\r\n  1>               \"type\" : \"exception\",\r\n  1>               \"reason\" : \"ElasticsearchStatusException[can not fetch remote cluster state as the license state of the remote cluster [remote_cluster] could not be determined]; nested: ElasticsearchException[could not determine the license type for cluster [remote_cluster]]; nested: NodeDisconnectedException[[node-0][127.0.0.1:43215][cluster:monitor/xpack/info] disconnected];\",\r\n  1>               \"caused_by\" : {\r\n  1>                 \"type\" : \"status_exception\",\r\n  1>                 \"reason\" : \"can not fetch remote cluster state as the license state of the remote cluster [remote_cluster] could not be determined\",\r\n  1>                 \"caused_by\" : {\r\n  1>                   \"type\" : \"exception\",\r\n  1>                   \"reason\" : \"could not determine the license type for cluster [remote_cluster]\",\r\n  1>                   \"caused_by\" : {\r\n  1>                     \"type\" : \"node_disconnected_exception\",\r\n  1>                     \"reason\" : \"[node-0][127.0.0.1:43215][cluster:monitor/xpack/info] disconnected\"\r\n  1>                   }\r\n  1>                 }\r\n  1>               }\r\n  1>             }\r\n  1>           }\r\n  1>         ]\r\n  1>       },\r\n  1>       \"follow_stats\" : {\r\n  1>         \"indices\" : [\r\n  1>           {\r\n  1>             \"index\" : \"follower_index\",\r\n  1>             \"shards\" : [\r\n  1>               {\r\n  1>                 \"remote_cluster\" : \"remote_cluster\",\r\n  1>                 \"leader_index\" : \"leader_index\",\r\n  1>                 \"follower_index\" : \"follower_index\",\r\n  1>                 \"shard_id\" : 0,\r\n  1>                 \"leader_global_checkpoint\" : 0,\r\n  1>                 \"leader_max_seq_no\" : 0,\r\n  1>                 \"follower_global_checkpoint\" : 0,\r\n  1>                 \"follower_max_seq_no\" : 0,\r\n  1>                 \"last_requested_seq_no\" : 0,\r\n  1>                 \"outstanding_read_requests\" : 0,\r\n  1>                 \"outstanding_write_requests\" : 0,\r\n  1>                 \"write_buffer_operation_count\" : 0,\r\n  1>                 \"write_buffer_size_in_bytes\" : 0,\r\n  1>                 \"follower_mapping_version\" : 0,\r\n  1>                 \"follower_settings_version\" : 0,\r\n  1>                 \"total_read_time_millis\" : 0,\r\n  1>                 \"total_read_remote_exec_time_millis\" : 0,\r\n  1>                 \"successful_read_requests\" : 0,\r\n  1>                 \"failed_read_requests\" : 0,\r\n  1>                 \"operations_read\" : 0,\r\n  1>                 \"bytes_read\" : 0,\r\n  1>                 \"total_write_time_millis\" : 0,\r\n  1>                 \"successful_write_requests\" : 0,\r\n  1>                 \"failed_write_requests\" : 0,\r\n  1>                 \"operations_written\" : 0,\r\n  1>                 \"read_exceptions\" : [ ],\r\n  1>                 \"time_since_last_read_millis\" : -1\r\n  1>               }\r\n  1>             ]\r\n  1>           }\r\n  1>         ]\r\n  1>       }\r\n  1>     }\r\n  1>   }\r\n  1> }]\r\n```\r\n\r\n```\r\n  2> REPRODUCE WITH: ./gradlew :docs:integTestRunner -Dtests.seed=EC91D2DAA4CFDBD5 -Dtests.class=org.elasticsearch.smoketest.DocsClientYamlTestSuiteIT -Dtests.method=\"test {yaml=reference/ccr/apis/get-ccr-stats/line_88}\" -Dtests.security.manager=true -Dtests.locale=en-IE -Dtests.timezone=CST6CDT -Dcompiler.java=11 -Druntime.java=8\r\n```\r\n\r\nWhat puzzles me is that `127.0.0.1:43215` seems to be the local node, and we're running CCR within a single cluster:\r\n\r\n```\r\n[2018-11-15T11:34:40,065][INFO ][o.e.t.TransportService   ] [node-0] publish_address {127.0.0.1:43215}, bound_addresses {[::1]:33485}, {127.0.0.1:43215}\r\n...\r\n[2018-11-15T11:47:47,110][WARN ][o.e.x.c.a.AutoFollowCoordinator] [node-0] failure occurred while fetching cluster state for auto follow pattern [my_auto_follow_pattern]\r\norg.elasticsearch.ElasticsearchStatusException: can not fetch remote cluster state as the license state of the remote cluster [remote_cluster] could not be determined\r\n\tat org.elasticsearch.xpack.ccr.CcrLicenseChecker.clusterStateUnknownRemoteLicense(CcrLicenseChecker.java:425) ~[x-pack-ccr-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.ccr.CcrLicenseChecker.lambda$checkRemoteClusterLicenseAndFetchClusterState$5(CcrLicenseChecker.java:171) ~[x-pack-ccr-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.ccr.CcrLicenseChecker$1.onFailure(CcrLicenseChecker.java:217) [x-pack-ccr-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.license.RemoteClusterLicenseChecker$1.onFailure(RemoteClusterLicenseChecker.java:180) [x-pack-core-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.ContextPreservingActionListener.onFailure(ContextPreservingActionListener.java:50) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:53) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1127) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.TransportService.lambda$onConnectionClosed$8(TransportService.java:982) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:627) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\nCaused by: org.elasticsearch.ElasticsearchException: could not determine the license type for cluster [remote_cluster]\r\n\t... 9 more\r\nCaused by: org.elasticsearch.transport.NodeDisconnectedException: [node-0][127.0.0.1:43215][cluster:monitor/xpack/info] disconnected\r\n```\r\n\r\nNot sure how we get a `NodeDisconnctedException` in this situation.","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}