{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28984","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28984/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28984/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28984/events","html_url":"https://github.com/elastic/elasticsearch/issues/28984","id":304217669,"node_id":"MDU6SXNzdWUzMDQyMTc2Njk=","number":28984,"title":"Java 9: requiring elasticsearch from module-info.java fails with \"module not found\"","user":{"login":"reda-alaoui","id":2890843,"node_id":"MDQ6VXNlcjI4OTA4NDM=","avatar_url":"https://avatars0.githubusercontent.com/u/2890843?v=4","gravatar_id":"","url":"https://api.github.com/users/reda-alaoui","html_url":"https://github.com/reda-alaoui","followers_url":"https://api.github.com/users/reda-alaoui/followers","following_url":"https://api.github.com/users/reda-alaoui/following{/other_user}","gists_url":"https://api.github.com/users/reda-alaoui/gists{/gist_id}","starred_url":"https://api.github.com/users/reda-alaoui/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reda-alaoui/subscriptions","organizations_url":"https://api.github.com/users/reda-alaoui/orgs","repos_url":"https://api.github.com/users/reda-alaoui/repos","events_url":"https://api.github.com/users/reda-alaoui/events{/privacy}","received_events_url":"https://api.github.com/users/reda-alaoui/received_events","type":"User","site_admin":false},"labels":[{"id":106454670,"node_id":"MDU6TGFiZWwxMDY0NTQ2NzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Build","name":":Delivery/Build","color":"0e8a16","default":false,"description":"Build or test infrastructure"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"},{"id":552045539,"node_id":"MDU6TGFiZWw1NTIwNDU1Mzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/jdk9","name":"jdk9","color":"e11d21","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":23,"created_at":"2018-03-12T01:49:00Z","updated_at":"2020-11-11T21:41:56Z","closed_at":"2019-02-04T08:20:39Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.2\r\n\r\n**JVM version** (`java -version`): 9.0.4\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 17.10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWe are migrating our Maven project to Java 9.\r\nIn each module of our project, we add a `module-info.java`.\r\nEverything works fine for every dependencies except elasticsearch.\r\n\r\nRequiring it from module-info fails with:\r\n```\r\n[ERROR] Failed to execute goal org.apache.maven.plugins:maven-compiler-plugin:3.7.0:compile (default-compile) on project foo: Compilation failure\r\n[ERROR] /foo/src/main/java/module-info.java:[10,12] module not found: elasticsearch\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create basic maven project targeting JDK 9\r\n 2. Add elasticsearch as a dependency\r\n 3. Add a module-info.java with \"requires elasticsearch;\"\r\n 4. Try to build the project\r\n\r\n**Analysis**:\r\n\r\nI debugged `maven-compiler-plugin` and that lead me to `jdk.internal.module.ModulePath`.\r\nIt fails in `jdk.internal.module.ModulePath` at line 557:\r\n```java\r\n// parse each service configuration file\r\n        for (String sn : serviceNames) {\r\n            JarEntry entry = jf.getJarEntry(SERVICES_PREFIX + sn);\r\n            List<String> providerClasses = new ArrayList<>();\r\n            try (InputStream in = jf.getInputStream(entry)) {\r\n                BufferedReader reader\r\n                    = new BufferedReader(new InputStreamReader(in, \"UTF-8\"));\r\n                String cn;\r\n                while ((cn = nextLine(reader)) != null) {\r\n                    if (cn.length() > 0) {\r\n                        String pn = packageName(cn);\r\n                        if (!packages.contains(pn)) {\r\n                            String msg = \"Provider class \" + cn + \" not in module\";\r\n                            throw new InvalidModuleDescriptorException(msg); // <-- FAILING HERE\r\n                        }\r\n                        providerClasses.add(cn);\r\n                    }\r\n                }\r\n            }\r\n            if (!providerClasses.isEmpty())\r\n                builder.provides(sn, providerClasses);\r\n        }\r\n```\r\n\r\nThe issue comes from the fact that no elasticsearch packages match the following declared Java services:\r\n- server/src/main/resources/META-INF/services/org.apache.lucene.codecs.Codec\r\n- server/src/main/resources/META-INF/services/org.apache.lucene.codecs.PostingsFormat\r\n- server/src/main/resources/META-INF/services/org.apache.lucene.codecs.DocValuesFormat\r\n\r\nThose service declarations either need to be moved to another project, or a fake class should be added to `org.apache.lucene.codecs`.","closed_by":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"performed_via_github_app":null}