[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/709320075","html_url":"https://github.com/elastic/elasticsearch/issues/63742#issuecomment-709320075","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63742","id":709320075,"node_id":"MDEyOklzc3VlQ29tbWVudDcwOTMyMDA3NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-10-15T13:20:48Z","updated_at":"2020-10-15T13:20:48Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-ql (:Query Languages/EQL)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/723012290","html_url":"https://github.com/elastic/elasticsearch/issues/63742#issuecomment-723012290","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63742","id":723012290,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMzAxMjI5MA==","user":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"created_at":"2020-11-06T10:45:23Z","updated_at":"2020-11-06T10:45:23Z","author_association":"CONTRIBUTOR","body":"This is indeed a bug. And it comes from how we handle the events in one of the secondary sequence queries (that is any of the queries after the first one). In case of a `tail` sequence of events, the bug is that we double revert the limits (in time) of a window of events resulting from the first query. For `tail` the first query is executed with a descending sorting (on timestamp and tiebreaker field) and any of the subsequent queries in the sequence have an ascending sorting (on timestamp and tiebreaker field).\r\nAnd instead of discarding the events that are before the first event in the window, we discard the events after. And this includes all events in this case. Thus, instead of building the most recent set of sequences, we build some that are earlier. Code-wise, the double reverting happens [here](https://github.com/elastic/elasticsearch/blob/7.10/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/TumblingWindow.java#L219)\r\n\r\n```\r\n        log.trace(\"Querying (secondary) stage [{}] {}\", criterion.stage(), request);\r\n        client.query(request, wrap(r -> {\r\n            Ordinal boundary = reversed ? window.begin : window.end;\r\n            List<SearchHit> hits = searchHits(r);\r\n            // filter hits that are escaping the window (same timestamp but different tiebreaker)\r\n            hits = trim(hits, criterion, boundary, reversed);\r\n```\r\n\r\nand [here](https://github.com/elastic/elasticsearch/blob/7.10/x-pack/plugin/eql/src/main/java/org/elasticsearch/xpack/eql/execution/sequence/TumblingWindow.java#L293).\r\n\r\n```\r\n    private List<SearchHit> trim(List<SearchHit> searchHits, Criterion<BoxedQueryRequest> criterion, Ordinal boundary, boolean reversed) {\r\n        int offset = 0;\r\n\r\n        for (int i = searchHits.size() - 1; i >=0 ; i--) {\r\n            Ordinal ordinal = criterion.ordinal(searchHits.get(i));\r\n            boolean withinBoundaries = reversed ? ordinal.afterOrAt(boundary) : ordinal.beforeOrAt(boundary);\r\n            if (withinBoundaries == false) {\r\n```\r\n\r\nI'll wait for the work that's part of https://github.com/elastic/elasticsearch/issues/58646 that will most likely fix this issue as well and will re-test these queries then. The issue will be closed when that fix is confirmed.","performed_via_github_app":null}]