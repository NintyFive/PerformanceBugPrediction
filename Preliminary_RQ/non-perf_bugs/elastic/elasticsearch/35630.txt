{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35630","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35630/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35630/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35630/events","html_url":"https://github.com/elastic/elasticsearch/issues/35630","id":381555628,"node_id":"MDU6SXNzdWUzODE1NTU2Mjg=","number":35630,"title":"[painless] NullPointerExceptions when accessing params HashMap members","user":{"login":"jzzfs","id":9054705,"node_id":"MDQ6VXNlcjkwNTQ3MDU=","avatar_url":"https://avatars1.githubusercontent.com/u/9054705?v=4","gravatar_id":"","url":"https://api.github.com/users/jzzfs","html_url":"https://github.com/jzzfs","followers_url":"https://api.github.com/users/jzzfs/followers","following_url":"https://api.github.com/users/jzzfs/following{/other_user}","gists_url":"https://api.github.com/users/jzzfs/gists{/gist_id}","starred_url":"https://api.github.com/users/jzzfs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jzzfs/subscriptions","organizations_url":"https://api.github.com/users/jzzfs/orgs","repos_url":"https://api.github.com/users/jzzfs/repos","events_url":"https://api.github.com/users/jzzfs/events{/privacy}","received_events_url":"https://api.github.com/users/jzzfs/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"assignees":[{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2018-11-16T11:13:01Z","updated_at":"2019-01-07T14:48:43Z","closed_at":"2018-11-28T00:55:40Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**\r\nVersion: 6.3.1, Build: default/zip/eb782d0/2018-06-29T21:59:26.107521Z, JVM: 1.8.0_121\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\njava version \"1.8.0_121\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_121-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)\r\n\r\n**OS version**:\r\nMac OS Darwin xyz.local 17.6.0 Darwin Kernel Version 17.6.0\r\nroot:xnu-4570.61.1~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen accessing `doc` within the map_script of a scripted aggregation, I keep getting a null pointer exception.\r\n\r\n**Steps to reproduce**:\r\n\r\nExecuting\r\n\r\n    {\r\n        \"init_script\":{\r\n            \"source\":\"params._agg['transactions'] = [];\"\r\n        },\r\n        \"map_script\":{\r\n            \"source\":\"Debug.explain(params)\"        <----------------\r\n        },\r\n        ...\r\n    }\r\n\r\nwith no affecting queries or agg filters I get\r\n\r\n    {\r\n        ...,\r\n        \"painless_class\":\"java.util.HashMap\",\r\n        \"to_string\":\"{doc=org.elasticsearch.search.lookup.LeafDocLookup@133b9d24, _source=org.elasticsearch.search.lookup.SourceLookup@7b812d13, _doc=org.elasticsearch.search.lookup.LeafDocLookup@133b9d24, _fields=org.elasticsearch.search.lookup.LeafFieldsLookup@6149f5f3, _agg={transactions=[]}}\",\r\n        \"java_class\":\"java.util.HashMap\",\r\n        ...\r\n    }\r\n    \r\nIn here, `Debug.explain(params._agg)` is accessible w/o problems, as is `Debug.explain(params.containsKey('doc'))`, which returns\r\n\r\n    {\r\n        ...,\r\n        \"painless_class\":\"java.lang.Boolean\",\r\n        \"to_string\":\"true\",\r\n        \"java_class\":\"java.lang.Boolean\",\r\n        ...\r\n    }\r\n\r\nIf, however, I access \r\n\r\n - `params.doc`\r\n - `params['_doc']`\r\n - `doc`\r\n - `_doc`\r\n - or any variant of those\r\n \r\n\r\nI keep getting \r\n\r\n    {\r\n        ...,\r\n        \"caused_by\":{\r\n            \"type\":\"null_pointer_exception\",\r\n            \"reason\":null,\r\n            \"caused_by\":{\r\n                \"type\":\"null_pointer_exception\",\r\n                \"reason\":null\r\n            }\r\n        },\r\n        ...\r\n    }\r\n\r\nWhat's happening? And why am I seeing `LeafDocLookup` instances which cannot be accessed and appear not stringified / toString()-ed?\r\n\r\n\r\n----------\r\n\r\n**Kibana stacktrace**:\r\n\r\n    {\r\n        \"error\":{\r\n            \"root_cause\":[\r\n                {\r\n                    \"type\":\"null_pointer_exception\",\r\n                    \"reason\":null\r\n                }\r\n            ],\r\n            \"type\":\"search_phase_execution_exception\",\r\n            \"reason\":\"all shards failed\",\r\n            \"phase\":\"query\",\r\n            \"grouped\":true,\r\n            \"failed_shards\":[\r\n                {\r\n                    \"shard\":0,\r\n                    \"index\":\"abcdefgh\",\r\n                    \"node\":\"C2dBtzqBQOOiH5G5IGQPkQ\",\r\n                    \"reason\":{\r\n                        \"type\":\"null_pointer_exception\",\r\n                        \"reason\":null\r\n                    }\r\n                }\r\n            ],\r\n            \"caused_by\":{\r\n                \"type\":\"null_pointer_exception\",\r\n                \"reason\":null,\r\n                \"caused_by\":{\r\n                    \"type\":\"null_pointer_exception\",\r\n                    \"reason\":null\r\n                }\r\n            }\r\n        },\r\n        \"status\":500\r\n    }\r\n\r\n----------\r\n\r\n**ES stacktrace**:\r\n\r\n```\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:288) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:128) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:249) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:101) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:222) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:176) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:222) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:527) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1103) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1196) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1180) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:66) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6$1.onFailure(SearchTransportService.java:385) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:341) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:335) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:329) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:1019) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:725) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\nCaused by: org.elasticsearch.ElasticsearchException$1\r\n\tat org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:658) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:126) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\t... 26 more\r\nCaused by: java.lang.NullPointerException\r\n\tat org.elasticsearch.painless.Definition.getTypeInternal(Definition.java:1364) ~[?:?]\r\n\tat org.elasticsearch.painless.Definition.getType(Definition.java:447) ~[?:?]\r\n\tat org.elasticsearch.painless.Definition.ClassToType(Definition.java:615) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessExplainError.getHeaders(PainlessExplainError.java:57) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessScript$Script.execute(Debug.explain(params['doc']):21) ~[?:?]\r\n\tat org.elasticsearch.painless.ScriptImpl.run(ScriptImpl.java:105) ~[?:?]\r\n\tat org.elasticsearch.search.aggregations.metrics.scripted.ScriptedMetricAggregator$1.collect(ScriptedMetricAggregator.java:71) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.aggregations.LeafBucketCollector$2.collect(LeafBucketCollector.java:67) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.aggregations.LeafBucketCollector.collect(LeafBucketCollector.java:82) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.apache.lucene.search.MultiCollector$MultiLeafCollector.collect(MultiCollector.java:174) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.FilterLeafCollector.collect(FilterLeafCollector.java:43) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:233) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:184) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.ConstantScoreQuery$ConstantBulkScorer.score(ConstantScoreQuery.java:84) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:660) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:191) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:266) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:107) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:324) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:357) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n```\r\n\r\ncc @LucaWintergerst ","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}