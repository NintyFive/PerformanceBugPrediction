{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22500","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22500/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22500/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22500/events","html_url":"https://github.com/elastic/elasticsearch/issues/22500","id":199548925,"node_id":"MDU6SXNzdWUxOTk1NDg5MjU=","number":22500,"title":"ReduceSearchPhaseException Caused by NullPointerException","user":{"login":"Rogier75","id":23118927,"node_id":"MDQ6VXNlcjIzMTE4OTI3","avatar_url":"https://avatars2.githubusercontent.com/u/23118927?v=4","gravatar_id":"","url":"https://api.github.com/users/Rogier75","html_url":"https://github.com/Rogier75","followers_url":"https://api.github.com/users/Rogier75/followers","following_url":"https://api.github.com/users/Rogier75/following{/other_user}","gists_url":"https://api.github.com/users/Rogier75/gists{/gist_id}","starred_url":"https://api.github.com/users/Rogier75/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Rogier75/subscriptions","organizations_url":"https://api.github.com/users/Rogier75/orgs","repos_url":"https://api.github.com/users/Rogier75/repos","events_url":"https://api.github.com/users/Rogier75/events{/privacy}","received_events_url":"https://api.github.com/users/Rogier75/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2017-01-09T13:12:12Z","updated_at":"2018-03-22T11:35:11Z","closed_at":"2018-03-22T11:35:10Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.1\r\n```[root@atom1 jenkins]# curl -XGET 'localhost:9200'\r\n{\r\n  \"name\" : \"atom1\",\r\n  \"cluster_name\" : \"atomcluster\",\r\n  \"cluster_uuid\" : \"Ax602ATwRUanUplRc3d5iA\",\r\n  \"version\" : {\r\n    \"number\" : \"5.1.1\",\r\n    \"build_hash\" : \"5395e21\",\r\n    \"build_date\" : \"2016-12-06T12:36:15.409Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"6.3.0\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n```\r\n\r\n**Plugins installed**: []\r\nnone\r\n\r\n**JVM version**: 1.8.0\r\n[root@atom1 jenkins]# java -version\r\njava version \"1.8.0\"\r\nJava(TM) SE Runtime Environment (build 1.8.0-b132)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.0-b70, mixed mode)\r\n\r\n**OS version**: CentOS release 6.8 (Final) Linux 64bit\r\n[root@atom1 jenkins]# cat /etc/redhat-release\r\nCentOS release 6.8 (Final)\r\n[root@atom1 jenkins]# uname -a\r\nLinux atom1 2.6.32-642.11.1.el6.x86_64 #1 SMP Fri Nov 18 19:25:05 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n 1. Search and scroll using the following query.\r\n_search/?scroll=1m\r\n```\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"constant_score\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"must\": [\r\n            {\r\n              \"range\": {\r\n                \"@timestamp\": {\r\n                  \"gte\" : \"now-1d/d\",\r\n                  \"lt\" :  \"now/d\"\r\n                }\r\n              }\r\n            },\r\n            {\r\n              \"exists\": {\r\n                \"field\": \"session\"\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"terms\": {\r\n        \"field\": \"session.id.raw\"\r\n      },\r\n      \"aggs\": {\r\n        \"3\": {\r\n          \"terms\": {\r\n            \"field\": \"@timestamp\",\r\n            \"size\": 1,\r\n            \"order\": {\r\n              \"_term\": \"asc\"\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"4\": {\r\n              \"top_hits\": {\r\n                \"size\": 1\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Initial search request is successful. Second search, now with scroll_id as returned in step 1 fails.\r\n_search/scroll?scroll=1m\r\n```\r\n{\r\n   \"error\":{\r\n      \"root_cause\":[\r\n\r\n      ],\r\n      \"type\":\"reduce_search_phase_exception\",\r\n      \"reason\":\"[reduce] inner finish failed\",\r\n      \"phase\":\"fetch\",\r\n      \"grouped\":true,\r\n      \"failed_shards\":[\r\n\r\n      ],\r\n      \"caused_by\":{\r\n         \"type\":\"null_pointer_exception\",\r\n         \"reason\":null\r\n      }\r\n   },\r\n   \"status\":503\r\n}\r\n```\r\n\r\n**Cluster health**:\r\n[root@atom1 jenkins]# curl -XGET http://localhost:9200/_cluster/health?pretty=true\r\n```\r\n{\r\n  \"cluster_name\" : \"atomcluster\",\r\n  \"status\" : \"green\",\r\n  \"timed_out\" : false,\r\n  \"number_of_nodes\" : 2,\r\n  \"number_of_data_nodes\" : 2,\r\n  \"active_primary_shards\" : 165,\r\n  \"active_shards\" : 330,\r\n  \"relocating_shards\" : 0,\r\n  \"initializing_shards\" : 0,\r\n  \"unassigned_shards\" : 0,\r\n  \"delayed_unassigned_shards\" : 0,\r\n  \"number_of_pending_tasks\" : 0,\r\n  \"number_of_in_flight_fetch\" : 0,\r\n  \"task_max_waiting_in_queue_millis\" : 0,\r\n  \"active_shards_percent_as_number\" : 100.0\r\n}\r\n```\r\n\r\n**Cluster log**:\r\n```\r\n[2017-01-09T13:48:06,677][DEBUG][o.e.i.f.p.SortedSetDVOrdinalsIndexFieldData] global-ordinals [session.id.raw][1972] took [3.6ms]\r\n[2017-01-09T13:48:06,779][DEBUG][o.e.i.f.p.SortedSetDVOrdinalsIndexFieldData] global-ordinals [session.id.raw][2017] took [15.5ms]\r\n[2017-01-09T13:48:06,914][WARN ][r.suppressed             ] path: /_search/scroll, params: {scroll=1m}\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: [reduce] inner finish failed\r\n        at org.elasticsearch.action.search.SearchScrollQueryThenFetchAsyncAction.finishHim(SearchScrollQueryThenFetchAsyncAction.java:217) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.action.search.SearchScrollQueryThenFetchAsyncAction.executeFetchPhase(SearchScrollQueryThenFetchAsyncAction.java:175) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.action.search.SearchScrollQueryThenFetchAsyncAction.access$000(SearchScrollQueryThenFetchAsyncAction.java:44) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.action.search.SearchScrollQueryThenFetchAsyncAction$1.onResponse(SearchScrollQueryThenFetchAsyncAction.java:135) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.action.search.SearchScrollQueryThenFetchAsyncAction$1.onResponse(SearchScrollQueryThenFetchAsyncAction.java:129) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.action.ActionListenerResponseHandler.handleResponse(ActionListenerResponseHandler.java:46) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleResponse(TransportService.java:978) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.transport.TcpTransport$1.doRun(TcpTransport.java:1289) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.common.util.concurrent.EsExecutors$1.execute(EsExecutors.java:109) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.transport.TcpTransport.handleResponse(TcpTransport.java:1281) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.transport.TcpTransport.messageReceived(TcpTransport.java:1250) [elasticsearch-5.1.1.jar:5.1.1]\r\n        at org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.channelRead(Netty4MessageChannelHandler.java:74) [transport-netty4-5.1.1.jar:5.1.1]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:351) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:293) [netty-codec-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:280) [netty-codec-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:396) [netty-codec-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:248) [netty-codec-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:351) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1334) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:926) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:129) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:651) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:536) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:490) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:450) [netty-transport-4.1.6.Final.jar:4.1.6.Final]\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:873) [netty-common-4.1.6.Final.jar:4.1.6.Final]\r\n        at java.lang.Thread.run(Thread.java:744) [?:1.8.0]\r\nCaused by: java.lang.NullPointerException\r\n```\r\n\r\nThe _session_ field as well as the _@timestamp_ field exists in all documents during the time period of now - 1d.\r\nIs there anything that can be done to fix this? Please let me know what info you would need to help you in solving this issue.","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}