{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21712","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21712/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21712/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21712/events","html_url":"https://github.com/elastic/elasticsearch/issues/21712","id":190785357,"node_id":"MDU6SXNzdWUxOTA3ODUzNTc=","number":21712,"title":"`query_string` query mismatch when using multiple analyzers with and without stop words removal","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2016-11-21T17:31:06Z","updated_at":"2017-08-21T11:03:22Z","closed_at":"2017-08-21T11:03:22Z","author_association":"MEMBER","active_lock_reason":null,"body":"When using the `query_string` with default_operator set to AND on two fields, one with stop words removal and the other without, the stop words become mandatory for the fields that don't remove them. \r\nConsider for instance this mapping:\r\n\r\n````\r\nPUT t\r\n{\r\n   \"mappings\": {\r\n      \"t\": {\r\n         \"properties\": {\r\n            \"text\": {\r\n               \"type\": \"text\",\r\n               \"analyzer\": \"text_analyzer\"\r\n            },\r\n            \"text_stop\": {\r\n               \"type\": \"text\",\r\n               \"analyzer\": \"text_stop_analyzer\"\r\n            }\r\n         }\r\n      }\r\n   },\r\n   \"settings\": {\r\n      \"index\": {\r\n         \"analysis\": {\r\n            \"analyzer\": {\r\n               \"text_stop_analyzer\": {\r\n                  \"filter\": [\r\n                     \"lowercase\",\r\n                     \"stop\"\r\n                  ],\r\n                  \"type\": \"custom\",\r\n                  \"tokenizer\": \"standard\"\r\n               },\r\n               \"text_analyzer\": {\r\n                  \"filter\": [\r\n                     \"lowercase\"\r\n                  ],\r\n                  \"type\": \"custom\",\r\n                  \"tokenizer\": \"standard\"\r\n               }\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n````\r\n\r\nThe following query:\r\n````\r\nGET t/_validate/query?explain\r\n{\r\n   \"query\": {\r\n      \"query_string\": {\r\n         \"query\": \"the doors\",\r\n         \"fields\": [\r\n            \"text\",\r\n            \"text_stop\"\r\n         ],\r\n         \"default_operator\": \"AND\"\r\n      }\r\n   }\r\n}\r\n````\r\n... produces:\r\n\r\n````\r\n{\r\n   \"valid\": true,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"failed\": 0\r\n   },\r\n   \"explanations\": [\r\n      {\r\n         \"index\": \"t\",\r\n         \"valid\": true,\r\n         \"explanation\": \"+(text:the) +(text:doors | text_stop:doors)\"\r\n      }\r\n   ]\r\n}\r\n````\r\n\r\n... so \"the\" must be present in the field \"text\". This is problematic since it means that document like the following won't match:\r\n````\r\nPUT t/t/1\r\n{\r\n    \"text\": \"the doors\"\r\n}\r\n````\r\n\r\nAs a workaround we could make \"the\" optional since it has been removed from some fields ?:\r\n\r\n````\r\n \"explanation\": \"(text:the) +(text:doors | text_stop:doors)\"\r\n````\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}