{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36883/events","html_url":"https://github.com/elastic/elasticsearch/issues/36883","id":392963488,"node_id":"MDU6SXNzdWUzOTI5NjM0ODg=","number":36883,"title":"[Geo] ShapeBuilder fails when a polygon has a shared vertices","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-12-20T09:42:32Z","updated_at":"2019-08-26T18:42:40Z","closed_at":"2019-08-26T18:42:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I am working with the following polygon:\r\n\r\n```\r\nPOLYGON((-84.7761352 33.4183446, -84.7761826 33.4182834, -84.7762958 33.4181698, -84.7766048 33.4178631, -84.777346 33.417699, -84.7777224 33.4176621, -84.7785646 33.4171706, -84.7791635 33.4168679, -84.7798233 33.4164581, -84.7805481 33.4162178, -84.7812343 33.4161797, -84.7812367 33.4165802, -84.7812424 33.4177361, -84.78125 33.4186821, -84.7820206 33.419117, -84.7827072 33.419384, -84.7829622 33.4194496, -84.7834778 33.4195824, -84.7845659 33.419746, -84.7845688 33.4197464, -84.7848892 33.4198456, -84.7855759 33.4199104, -84.7860377 33.4199944, -84.7866651 33.4201085, -84.7866669 33.4201088, -84.7862751 33.4221866, -84.7862015 33.4225769, -84.7872996 33.4236772, -84.7879732 33.4241176, -84.7886796 33.4251154, -84.7888923 33.4253525, -84.789322 33.4256627, -84.7902293 33.4276989, -84.7902298 33.4277, -84.78952 33.4279991, -84.7892609 33.4281082, -84.7867737 33.4301834, -84.7811115 33.4300095, -84.7799173 33.4300392, -84.7778949 33.4299077, -84.7776226 33.4292901, -84.7766376 33.4281559, -84.7763741 33.4273955, -84.7769699 33.4275589, -84.7773117 33.4283217, -84.7790298 33.4292068, -84.7806283 33.4292697, -84.782135 33.4293289, -84.7854004 33.4292793, -84.7861252 33.4288673, -84.7861633 33.4285316, -84.7861604 33.4285306, -84.7848249 33.4280663, -84.7838589 33.4277307, -84.7831808 33.4279009, -84.7820816 33.4281769, -84.7814109 33.4280153, -84.7789307 33.4274178, -84.7792053 33.4263649, -84.7820142 33.4269809, -84.7826843 33.4271278, -84.7837505 33.4265113, -84.7838059 33.4264794, -84.7845187 33.4267634, -84.7874872 33.4279465, -84.7874908 33.427948, -84.7875595 33.4265289, -84.7870633 33.4261378, -84.7858124 33.4251518, -84.7851055 33.424546, -84.7844772 33.4240074, -84.7816468 33.4233437, -84.780861 33.4206775, -84.7787923 33.4205086, -84.7773524 33.4203912, -84.7773514 33.4203911, -84.7769089 33.4207649, -84.7773788 33.4214899, -84.7778931 33.4222832, -84.7784637 33.4241191, -84.7792996 33.424106, -84.7789307 33.4261468, -84.7775005 33.4259665, -84.7773134 33.4263762, -84.7770661 33.4272277, -84.7769699 33.4275589, -84.7763748 33.4273949, -84.776375 33.427394, -84.7764027 33.4272459, -84.7764416 33.4270466, -84.7769394 33.4244499, -84.7765876 33.4233765, -84.7762759 33.4224251, -84.7762756 33.4224243, -84.775965 33.4224266, -84.7757567 33.4224279, -84.775413 33.4218646, -84.7750168 33.4212151, -84.7751331 33.4198731, -84.7750716 33.4189315, -84.7757652 33.4185326, -84.7761352 33.4183446))\r\n```\r\n\r\nwhich looks like:\r\n\r\n![image](https://user-images.githubusercontent.com/29038686/50276706-e05c2a80-0442-11e9-9c86-b47a89c221c0.png)\r\n\r\n\r\nWhen trying to build the polygon with `ShapeBuilder` you get the following errors:\r\n\r\nLucene shape:\r\n\r\n```\r\nfirst and last points of the polygon must be the same (it must close itself): polyLats[0]=33.4185326 polyLats[17]=33.4281559\r\n```\r\n\r\nS4J shape:\r\n\r\n```\r\nPoints of LinearRing do not form a closed linestring\r\n```\r\n\r\n\r\nI think the problem is that the polygon has a share vertices [-84.7769699, 33.4275589] and when the logic tries to divide the shape into components it gets very confused.\r\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}