[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726138502","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726138502","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726138502,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjEzODUwMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:11:50Z","updated_at":"2020-11-12T15:11:50Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/Snapshot/Restore)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726138988","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726138988","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726138988,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjEzODk4OA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:12:36Z","updated_at":"2020-11-12T15:12:36Z","author_association":"MEMBER","body":"@blevine \r\n\r\n> the snapshots files still exist in the repo directory.\r\n\r\nWhat do you mean by this? Which file(s) exactly do you see after the delete that should not be in the repository any longer?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726147885","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726147885","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726147885,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjE0Nzg4NQ==","user":{"login":"blevine","id":435731,"node_id":"MDQ6VXNlcjQzNTczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/435731?v=4","gravatar_id":"","url":"https://api.github.com/users/blevine","html_url":"https://github.com/blevine","followers_url":"https://api.github.com/users/blevine/followers","following_url":"https://api.github.com/users/blevine/following{/other_user}","gists_url":"https://api.github.com/users/blevine/gists{/gist_id}","starred_url":"https://api.github.com/users/blevine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blevine/subscriptions","organizations_url":"https://api.github.com/users/blevine/orgs","repos_url":"https://api.github.com/users/blevine/repos","events_url":"https://api.github.com/users/blevine/events{/privacy}","received_events_url":"https://api.github.com/users/blevine/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:26:05Z","updated_at":"2020-11-12T15:29:58Z","author_association":"NONE","body":"After creating the snapshot repo, I see the repo's directory which is empty.  After creating a snapshot in that repo, I see something like the directory tree below in the repo's directory.  After deleting the snapshot, this directory tree still exists.\r\n\r\nAlso, after deleting the snapshot if I then create a snapshot in the same repo with the same name, I see a similar file tree except with index-1 and index-2 files in the root of the directory.  Each time I do this, I get new index-n files with n incremented. Interestingly, the index-n file contains:\r\n\r\n`{\"snapshots\":[],\"indices\":{}}`\r\n\r\nand the index-n+1 file contains the snapshot info:\r\n\r\n`{\"snapshots\":[{\"name\":\"download_test\",\"uuid\":\"FHBiz1hcSBGknO7uAJCpWQ\",\"state\":1}],\"indices\":{\"download_pdfs_2020-11-12t12_31_14.574z\":{\"id\":\"SMIwk4QKTAKlmrEing3yNg\",\"snapshots\":[\"FHBiz1hcSBGknO7uAJCpWQ\"]}}}`\r\n```\r\n.\r\n├── index-0\r\n├── index.latest\r\n├── indices\r\n│   └── Sa4zE8G0ReiylcfhHs-jhA\r\n│       ├── 0\r\n│       │   ├── __2Gz3HC97RWyfCoUV0ug2tQ\r\n│       │   ├── __2TLkJkzoRsCJT13Y4jfPWQ\r\n│       │   ├── __384CC2WcQE2d1UdQazNuLQ\r\n│       │   ├── __3z-l-Kr3Rp6lED3KkE31zQ\r\n│       │   ├── __4vv96fkpQ62HmbiWasUo5A\r\n│       │   ├── __61D_PzqxT86_IXXfIzVdJw\r\n│       │   ├── __7u5pOnOKQUSE402QSoT7tQ\r\n│       │   ├── __9UQBfGrBTYSRBX7iT-MAAg\r\n│       │   ├── __A7wRtmrMR8mWCy6I9x4IuA\r\n│       │   ├── __CwN8wu2LSwK_1f9AGEFuvA\r\n│       │   ├── __I8SZ3ACxSpemz8IGro9kIQ\r\n│       │   ├── __KBjni3e5RK6wC3WcsyjIWA\r\n│       │   ├── __KBkEx27VTWiJM9AC64d_kQ\r\n│       │   ├── __OEYU4iFlTrGphthJu4sC-A\r\n│       │   ├── __OGtn5yYfR5ShYMkOgOEieA\r\n│       │   ├── __OaLc1MgpRqWyWrqk6ZqNMg\r\n│       │   ├── __TgeYqrRCTd6VSHSlpnTlIA\r\n│       │   ├── __WFJH86drRrGrTrOCLrpQ6w\r\n│       │   ├── __WfDWJNxKRde5bfIcJo7Bjw\r\n│       │   ├── __d39v9QWlR56Xvn30y7atjA\r\n│       │   ├── __daZGdg4aSmqLGSsAvVD-EA\r\n│       │   ├── __ep-eAk11RjeaTWECSXnFBw\r\n│       │   ├── __ha_O_NdHSpm57WD0J8Dmpg\r\n│       │   ├── __iLGds6hgSqeLDpr1ytzhbg\r\n│       │   ├── __oIw-_CUXQxK72dbpH15Y2A\r\n│       │   ├── __qvSz941RSZGOe1QVCaSQxQ\r\n│       │   ├── __rJF2VYBuS6uEEppD39tpuQ\r\n│       │   ├── __rvnkmHRDTVq2X8xPcYXdrw\r\n│       │   ├── __vZgSoCxPTu2HYGaAPFC7zg\r\n│       │   ├── __zVT3_GN9QsmTmMfPmBUK0Q\r\n│       │   ├── index-0\r\n│       │   └── snap-kfTHbaEkR327z9d-CQESIg.dat\r\n│       └── meta-kfTHbaEkR327z9d-CQESIg.dat\r\n├── meta-kfTHbaEkR327z9d-CQESIg.dat\r\n└── snap-kfTHbaEkR327z9d-CQESIg.dat\r\n```\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726152083","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726152083","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726152083,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjE1MjA4Mw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:32:30Z","updated_at":"2020-11-12T15:32:30Z","author_association":"MEMBER","body":"@blevine what you're seeing is expected in version `7.4`. We keep an extra `index-N` file around (keeping the last two).  Even if you delete all snapshots in the repository an empty `index-N` (like the one you posted) that references no indices or snapshots will be created. Same goes for the `indices` directory which is never deleted (but should be empty if there are no snapshots in the repository at all) and the `index.latest` file.\r\nUnless we leak other files but the ones I mentioned above I don't think there's anything broken here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726156699","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726156699","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726156699,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjE1NjY5OQ==","user":{"login":"blevine","id":435731,"node_id":"MDQ6VXNlcjQzNTczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/435731?v=4","gravatar_id":"","url":"https://api.github.com/users/blevine","html_url":"https://github.com/blevine","followers_url":"https://api.github.com/users/blevine/followers","following_url":"https://api.github.com/users/blevine/following{/other_user}","gists_url":"https://api.github.com/users/blevine/gists{/gist_id}","starred_url":"https://api.github.com/users/blevine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blevine/subscriptions","organizations_url":"https://api.github.com/users/blevine/orgs","repos_url":"https://api.github.com/users/blevine/repos","events_url":"https://api.github.com/users/blevine/events{/privacy}","received_events_url":"https://api.github.com/users/blevine/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:40:13Z","updated_at":"2020-11-12T15:40:13Z","author_association":"NONE","body":"Thanks for the explanation @original-brownbear. Is this behavior changed in later 7.x releases? The documentation for 7.10 for example states that the files will be deleted: https://www.elastic.co/guide/en/elasticsearch/reference/current/delete-snapshot-api.html. For some reason I couldn't find 7.4 documentation for the delete snapshot API.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726159916","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726159916","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726159916,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjE1OTkxNg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:45:15Z","updated_at":"2020-11-12T15:45:15Z","author_association":"MEMBER","body":"No problem @blevine \r\n\r\n> Is this behavior changed in later 7.x releases?\r\n\r\nNewer 7.x versions (`7.6+`) will only keep around a single `index-N` file. Otherwise the behavior remains unchanged (empty `indices` and `index.latest` files will also stick around). Completely deleting all contents of the repository even after removing all snapshots isn't something we can do on all repository types due to consistency guarantees of the underlying blob store when reusing file names so this behavior is unlikely to change in the foreseeable future.\r\n\r\nI hope you don't mind that I'll close here for now as it doesn't look like there's anything broken.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/726165405","html_url":"https://github.com/elastic/elasticsearch/issues/65005#issuecomment-726165405","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65005","id":726165405,"node_id":"MDEyOklzc3VlQ29tbWVudDcyNjE2NTQwNQ==","user":{"login":"blevine","id":435731,"node_id":"MDQ6VXNlcjQzNTczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/435731?v=4","gravatar_id":"","url":"https://api.github.com/users/blevine","html_url":"https://github.com/blevine","followers_url":"https://api.github.com/users/blevine/followers","following_url":"https://api.github.com/users/blevine/following{/other_user}","gists_url":"https://api.github.com/users/blevine/gists{/gist_id}","starred_url":"https://api.github.com/users/blevine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blevine/subscriptions","organizations_url":"https://api.github.com/users/blevine/orgs","repos_url":"https://api.github.com/users/blevine/repos","events_url":"https://api.github.com/users/blevine/events{/privacy}","received_events_url":"https://api.github.com/users/blevine/received_events","type":"User","site_admin":false},"created_at":"2020-11-12T15:53:53Z","updated_at":"2020-11-12T15:53:53Z","author_association":"NONE","body":"Given your description, there's nothing broken.  However there's still a documentation bug because current doc states:\r\n\r\n\"When deleting a snapshot from a repository, Elasticsearch _deletes all files that are associated with the snapshot_ and not used by any other snapshots. All files that are shared with at least one other existing snapshot are left intact.\"\r\n","performed_via_github_app":null}]