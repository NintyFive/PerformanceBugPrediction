{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/39284","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39284/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39284/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39284/events","html_url":"https://github.com/elastic/elasticsearch/issues/39284","id":413215569,"node_id":"MDU6SXNzdWU0MTMyMTU1Njk=","number":39284,"title":"Running Kibana Upgrade assistant from 6 to 7 makes security index non-restricted","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":151933706,"node_id":"MDU6TGFiZWwxNTE5MzM3MDY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eupgrade","name":">upgrade","color":"c7def8","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2019-02-22T02:36:17Z","updated_at":"2019-02-28T02:48:22Z","closed_at":"2019-02-28T02:48:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The Kibana upgrade assistant has the ability to upgrades 5.x format indices by reindexing them into a new name and then aliasing the old name to the new name.\r\n\r\nIt includes the ability to do this for `.security-6` and the intent was that this would be the recommended way to upgrade a security index from 5.x to work on 7.x\r\n\r\nHowever, this has some unintended consequences.\r\n\r\n## Scenario\r\n- I created a 5.6.15 cluster and created users and roles.\r\n- I ran the [5.6 Elasticsearch migration API](https://www.elastic.co/guide/en/elasticsearch/reference/5.6/migration-api-upgrade.html) to convert that v5 `.security` index into `.security-6` with a `.security` alias.\r\n- I copied the data and config to a new node running 6.7.0 BC3\r\n- I started Elasticsearch and Kibana (also BC3) and ran the Kibana migration assistant on `.watches-6` and `.security-6`\r\n\r\n## Result:\r\n```\r\nGET _cat/aliases\r\n.triggered_watches .triggered_watches-6     - - -\r\n.watches           .reindexed-v6-watches-6  - - -\r\n.watches-6         .reindexed-v6-watches-6  - - -\r\n.security          .reindexed-v6-security-6 - - -\r\n.security-6        .reindexed-v6-security-6 - - -\r\n.kibana            .kibana_1                - - -\r\n```\r\n\r\nThis is all in keeping with how the upgrade assistant is designed to work. We now have `.reindexed-v6-security-6` index, and the `.security` and `.security-6` aliases point to it.\r\n\r\n## Issue\r\nThe problem is that the protections we have to prevent users from getting accidental access to the security index rely on a strict naming convention.\r\nSince Elasticsearch security knows nothing of the Kibana migration assistant, it does not apply any special access restrictions to the `.reindexed-v6-security-6` index.\r\n\r\nConsequently a user with this role (or many others like it)\r\n```\r\n{\r\n    \"indices\" : [\r\n        { \"names\" : [ \".re*\" ], \"privileges\" : [ \"read\" ] }\r\n    ]\r\n}\r\n```\r\ncan read from the security index, and a user with write privileges would be able to do much more (e.g. reset passwords).\r\n\r\n## Solution\r\n\r\nBroadly, there's 2 options\r\n1. Update Elasticsearch to know that `.reindexed-v6-security-6` is another _possible_ name for the security index. This is not particularly hard, we just need to make sure we cover everywhere it's needed (e.g. `RestrictedIndicesNames`, but also `XPackUser` and maybe others)\r\n2. Change the Kibana assistant to do something special for `.security-6`. It already has some knowledge about special indices - for example it stops Watcher before reindexing `.watches-6`\r\n\r\nI also have a concern about the risk associated with having more than 1 possible name for the security index. As it stands, clusters that were originally upgraded from 5.x will have the `.reindexed-v6-security-6` but clusters that upgraded from 6.x only, and clusters that were fresh 7.x installs will have `.security-6`.\r\nExperience has shown that having too many variables like this leads to mistakes, which in the case of  security can be mean quite significant problems.\r\n\r\nBased on that, my preference would be something like:\r\n- Change the Kibana assistant to rename `.security-6` to `.security-7`\r\n- Change Elasticsearch from 6.7 onwards to treat both `.security-6` and `.security-7` as restricted indices\r\n- Change Elasticsearch from 7.0 onwards to name the internal security index as `.security-7` whenever it needs to be created.\r\n\r\nThat seems to leave us in the lowest-risk end state (but I'm naturally cautious about such matters).\r\n\r\n","closed_by":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"performed_via_github_app":null}