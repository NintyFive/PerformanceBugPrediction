[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/414991014","html_url":"https://github.com/elastic/elasticsearch/issues/33045#issuecomment-414991014","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33045","id":414991014,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNDk5MTAxNA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-22T10:45:50Z","updated_at":"2018-08-22T10:45:50Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415083275","html_url":"https://github.com/elastic/elasticsearch/issues/33045#issuecomment-415083275","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33045","id":415083275,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTA4MzI3NQ==","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2018-08-22T15:55:07Z","updated_at":"2018-08-22T15:56:27Z","author_association":"CONTRIBUTOR","body":"I think this might be the way to go:\r\n\r\n\r\n```\r\n--- a/test/framework/src/main/java/org/elasticsearch/bootstrap/BootstrapForTesting.java\r\n+++ b/test/framework/src/main/java/org/elasticsearch/bootstrap/BootstrapForTesting.java\r\n@@ -36,7 +36,9 @@ import org.junit.Assert;\r\n\r\n import java.io.InputStream;\r\n import java.net.SocketPermission;\r\n+import java.net.URISyntaxException;\r\n import java.net.URL;\r\n+import java.nio.file.Files;\r\n import java.nio.file.Path;\r\n import java.security.Permission;\r\n import java.security.Permissions;\r\n@@ -177,8 +179,23 @@ public class BootstrapForTesting {\r\n     private static void addClassCodebase(Map<String, URL> codebases, String name, String classname) {\r\n         try {\r\n             Class<?> clazz = BootstrapForTesting.class.getClassLoader().loadClass(classname);\r\n-            if (codebases.put(name, clazz.getProtectionDomain().getCodeSource().getLocation()) != null) {\r\n-                throw new IllegalStateException(\"Already added \" + name + \" codebase for testing\");\r\n+            URL location = clazz.getProtectionDomain().getCodeSource().getLocation();\r\n+            try {\r\n+                // if we find the class in a file (jar), make sure that jar is not already in the codebases map\r\n+                // this will be the case when using test framework externally\r\n+                Path filePath = PathUtils.get(location.toURI());\r\n+                if (Files.isRegularFile(filePath)) {\r\n+                    String fileName = filePath.getFileName().toString();\r\n+                    if (!codebases.containsKey(name) && !codebases.containsKey(fileName)) {\r\n+                        codebases.put(name, location);\r\n+                    }\r\n+                } else {\r\n+                    if (codebases.put(name, location) != null) {\r\n+                        throw new IllegalStateException(\"Already added \" + name + \" codebase for testing\");\r\n+                    }\r\n+                }\r\n+            } catch (URISyntaxException e) {\r\n+                throw new RuntimeException(e);\r\n             }\r\n         } catch (ClassNotFoundException e) {\r\n             // no class, fall through to not add. this can happen for any tests that do not include\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415203626","html_url":"https://github.com/elastic/elasticsearch/issues/33045#issuecomment-415203626","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33045","id":415203626,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTIwMzYyNg==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2018-08-22T22:30:19Z","updated_at":"2018-08-22T22:30:19Z","author_association":"MEMBER","body":"Thanks for the report @mattweber. I will take a look at this in the next few days. ","performed_via_github_app":null}]