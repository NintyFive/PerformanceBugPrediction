{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49804","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49804/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49804/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49804/events","html_url":"https://github.com/elastic/elasticsearch/issues/49804","id":532189069,"node_id":"MDU6SXNzdWU1MzIxODkwNjk=","number":49804,"title":"Range query broken on dates","user":{"login":"motherhubbard","id":3320683,"node_id":"MDQ6VXNlcjMzMjA2ODM=","avatar_url":"https://avatars0.githubusercontent.com/u/3320683?v=4","gravatar_id":"","url":"https://api.github.com/users/motherhubbard","html_url":"https://github.com/motherhubbard","followers_url":"https://api.github.com/users/motherhubbard/followers","following_url":"https://api.github.com/users/motherhubbard/following{/other_user}","gists_url":"https://api.github.com/users/motherhubbard/gists{/gist_id}","starred_url":"https://api.github.com/users/motherhubbard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/motherhubbard/subscriptions","organizations_url":"https://api.github.com/users/motherhubbard/orgs","repos_url":"https://api.github.com/users/motherhubbard/repos","events_url":"https://api.github.com/users/motherhubbard/events{/privacy}","received_events_url":"https://api.github.com/users/motherhubbard/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-12-03T18:47:13Z","updated_at":"2019-12-05T08:58:34Z","closed_at":"2019-12-05T08:58:34Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n{\r\n  \"cluster_uuid\" : \"P_sQQBFfQ2Wt_Cn_rwz8Fg\",\r\n  \"version\" : {\r\n    \"number\" : \"7.4.0\",\r\n    \"build_flavor\" : \"default\",\r\n    \"build_type\" : \"rpm\",\r\n    \"build_hash\" : \"22e1767283e61a198cb4db791ea66e3f11ab9910\",\r\n    \"build_date\" : \"2019-09-27T08:36:48.569419Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"8.2.0\",\r\n    \"minimum_wire_compatibility_version\" : \"6.8.0\",\r\n    \"minimum_index_compatibility_version\" : \"6.0.0-beta1\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux SNIP 3.10.0-957.el7.x86_64 #1 SMP Thu Nov 8 23:39:32 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen performing a range query with an lte value and an ISO Date I get an error parsing the date. I don't get these errors on the gte field. Example queries and results shown below:\r\n\r\n```\r\ncurl localhost:9208/MYINDEX/_search -d '{\"query\":{\"range\":{\"core.date.timestamp\":{\"gte\":\"2018-01-01T00:00:00Z\", \"lte\":\"2018-01-02T00:00:00.000Z\"}}}}' -H \"Content-Type: application/json\"\r\n{\"error\":{\"root_cause\":[{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"MYINDEX\",\"node\":\"YBAtWyr8QHiqxM5rqlx1eg\",\"reason\":{\"type\":\"parse_exception\",\"reason\":\"failed to parse date field [2018-01-02T00:00:00.000Z] with format [epoch_millis||strict_date_optional_time]: [Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4]\",\"caused_by\":{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4\"}}}],\"caused_by\":{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4\"}},\"status\":400}\r\n```\r\n\r\nIn fact just lte fails:\r\n```\r\ncurl localhost:9208/MYINDEX/_search -d '{\"query\":{\"range\":{\"core.date.timestamp\":{\"lte\":\"2018-01-01T00:00:00Z\"}}}}' -H \"Content-Type: application/json\"\r\n{\"error\":{\"root_cause\":[{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-01T00:00:00Z' could not be parsed, unparsed text found at index 4\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"MYINDEX\",\"node\":\"YBAtWyr8QHiqxM5rqlx1eg\",\"reason\":{\"type\":\"parse_exception\",\"reason\":\"failed to parse date field [2018-01-01T00:00:00Z] with format [epoch_millis||strict_date_optional_time]: [Text '2018-01-01T00:00:00Z' could not be parsed, unparsed text found at index 4]\",\"caused_by\":{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-01T00:00:00Z' could not be parsed, unparsed text found at index 4\"}}}],\"caused_by\":{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-01T00:00:00Z' could not be parsed, unparsed text found at index 4\"}},\"status\":400}\r\n```\r\n\r\n```\r\ncurl localhost:9208/MYINDEX/_search -d '{\"query\":{\"range\":{\"core.date.timestamp\":{\"lte\":\"2018-01-02T00:00:00.000Z\"}}}}' -H \"Content-Type: application/json\"\r\n{\"error\":{\"root_cause\":[{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"MYINDEX\",\"node\":\"YBAtWyr8QHiqxM5rqlx1eg\",\"reason\":{\"type\":\"parse_exception\",\"reason\":\"failed to parse date field [2018-01-02T00:00:00.000Z] with format [epoch_millis||strict_date_optional_time]: [Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4]\",\"caused_by\":{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4\"}}}],\"caused_by\":{\"type\":\"date_time_parse_exception\",\"reason\":\"date_time_parse_exception: Text '2018-01-02T00:00:00.000Z' could not be parsed, unparsed text found at index 4\"}},\"status\":400}\r\n```\r\n\r\n\r\nThe following queries work:\r\n```\r\ncurl localhost:9208/MYINDEX/_search -d '{\"query\":{\"range\":{\"core.date.timestamp\":{\"gte\":\"2018-01-01T00:00:00Z\", \"lte\":\"now\"}}}}' -H \"Content-Type: application/json\"\r\n\r\ncurl localhost:9208/MYINDEX/_search -d '{\"query\":{\"range\":{\"core.date.timestamp\":{\"gte\":\"2018-01-01T00:00:00Z\"}}}}' -H \"Content-Type: application/json\"\r\n\r\ncurl localhost:9208/MYINDEX/_search -d '{\"query\":{\"range\":{\"core.date.timestamp\":{\"lte\":1546300800000}}}}' -H \"Content-Type: application/json\"\r\n```\r\n\r\nAll of these queries work on an ES5 system.","closed_by":{"login":"motherhubbard","id":3320683,"node_id":"MDQ6VXNlcjMzMjA2ODM=","avatar_url":"https://avatars0.githubusercontent.com/u/3320683?v=4","gravatar_id":"","url":"https://api.github.com/users/motherhubbard","html_url":"https://github.com/motherhubbard","followers_url":"https://api.github.com/users/motherhubbard/followers","following_url":"https://api.github.com/users/motherhubbard/following{/other_user}","gists_url":"https://api.github.com/users/motherhubbard/gists{/gist_id}","starred_url":"https://api.github.com/users/motherhubbard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/motherhubbard/subscriptions","organizations_url":"https://api.github.com/users/motherhubbard/orgs","repos_url":"https://api.github.com/users/motherhubbard/repos","events_url":"https://api.github.com/users/motherhubbard/events{/privacy}","received_events_url":"https://api.github.com/users/motherhubbard/received_events","type":"User","site_admin":false},"performed_via_github_app":null}