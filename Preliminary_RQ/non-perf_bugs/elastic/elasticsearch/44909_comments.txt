[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/515649585","html_url":"https://github.com/elastic/elasticsearch/issues/44909#issuecomment-515649585","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909","id":515649585,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNTY0OTU4NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-07-27T04:01:53Z","updated_at":"2019-07-27T04:01:53Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/515980634","html_url":"https://github.com/elastic/elasticsearch/issues/44909#issuecomment-515980634","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909","id":515980634,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNTk4MDYzNA==","user":{"login":"Hohol","id":2988117,"node_id":"MDQ6VXNlcjI5ODgxMTc=","avatar_url":"https://avatars0.githubusercontent.com/u/2988117?v=4","gravatar_id":"","url":"https://api.github.com/users/Hohol","html_url":"https://github.com/Hohol","followers_url":"https://api.github.com/users/Hohol/followers","following_url":"https://api.github.com/users/Hohol/following{/other_user}","gists_url":"https://api.github.com/users/Hohol/gists{/gist_id}","starred_url":"https://api.github.com/users/Hohol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hohol/subscriptions","organizations_url":"https://api.github.com/users/Hohol/orgs","repos_url":"https://api.github.com/users/Hohol/repos","events_url":"https://api.github.com/users/Hohol/events{/privacy}","received_events_url":"https://api.github.com/users/Hohol/received_events","type":"User","site_admin":false},"created_at":"2019-07-29T12:58:37Z","updated_at":"2019-07-29T12:58:37Z","author_association":"CONTRIBUTOR","body":"I think I've found the cause of this bug.\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/a5df840c24bde9bf2c4561d638a0eb05de17dc1f/server/src/main/java/org/elasticsearch/search/aggregations/metrics/MaxAggregator.java#L91-L96\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/a5df840c24bde9bf2c4561d638a0eb05de17dc1f/server/src/main/java/org/elasticsearch/search/aggregations/metrics/MinAggregator.java#L96-L101\r\n\r\nLooks like the second snippet is incorrect.\r\n\r\n`MinAggregator` and `MaxAggregators` classes are weird. I believe they should be almost identical, but actually, there are many differences.\r\nI think they should be refactored to get rid of code duplication and any unwanted differences.\r\n\r\nI can work on this if someone from Elastic team approves.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/516000857","html_url":"https://github.com/elastic/elasticsearch/issues/44909#issuecomment-516000857","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909","id":516000857,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjAwMDg1Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-07-29T13:53:09Z","updated_at":"2019-07-29T13:53:09Z","author_association":"MEMBER","body":"Thanks for reporting @greentruff . I opened https://github.com/elastic/elasticsearch/pull/44963 to fix the bug, @Hohol these snippets are correct, what's missing is the handling of the CollectionTerminatedException in the deferring collectors (see #44963).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/516005988","html_url":"https://github.com/elastic/elasticsearch/issues/44909#issuecomment-516005988","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909","id":516005988,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjAwNTk4OA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-07-29T14:05:39Z","updated_at":"2019-07-29T14:05:39Z","author_association":"MEMBER","body":"@Hohol Regarding the code differences, the reason they look so different is due to some early termination optimization.  If possible, both aggregators attempt to use the BKD to lookup the min or max because that is a lot faster than iterating over all the documents to collect the values.\r\n\r\nThe BKD tree sorts the values ascending, so the min is at the left-most leaf in the tree.  The min aggregator walks the tree leaves until it finds the first non-deleted document, then exits the BKD intersection and returns the value.\r\n\r\nIn contrast, the max aggregator has a comparably more difficult job.  BKD intersections proceed from least-to-greatest, and we don't want to walk the whole tree.  So the Max agg only inspects leaves that contain the maximum value for the segment (e.g. the last leaf), and then scans through those values to see which is the largest _and_ also not deleted.  So the max agg is more heuristic in nature, if all the docs are deleted in the last leaf it will fall back to iterating over all the values to find the max.\r\n\r\nThus, the differences in how the code looks :)  On the surface they look similar, but due to how the tree is structured it introduces some subtle differences.\r\n\r\n*Pretty sure these details are at least mostly right, Jim can correct me if I got anything grossly wrong :)*","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/516006872","html_url":"https://github.com/elastic/elasticsearch/issues/44909#issuecomment-516006872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909","id":516006872,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjAwNjg3Mg==","user":{"login":"Hohol","id":2988117,"node_id":"MDQ6VXNlcjI5ODgxMTc=","avatar_url":"https://avatars0.githubusercontent.com/u/2988117?v=4","gravatar_id":"","url":"https://api.github.com/users/Hohol","html_url":"https://github.com/Hohol","followers_url":"https://api.github.com/users/Hohol/followers","following_url":"https://api.github.com/users/Hohol/following{/other_user}","gists_url":"https://api.github.com/users/Hohol/gists{/gist_id}","starred_url":"https://api.github.com/users/Hohol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hohol/subscriptions","organizations_url":"https://api.github.com/users/Hohol/orgs","repos_url":"https://api.github.com/users/Hohol/repos","events_url":"https://api.github.com/users/Hohol/events{/privacy}","received_events_url":"https://api.github.com/users/Hohol/received_events","type":"User","site_admin":false},"created_at":"2019-07-29T14:07:55Z","updated_at":"2019-07-29T14:07:55Z","author_association":"CONTRIBUTOR","body":"Thanks for the explanation!","performed_via_github_app":null}]