{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4156","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4156/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4156/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4156/events","html_url":"https://github.com/elastic/elasticsearch/issues/4156","id":22523638,"node_id":"MDU6SXNzdWUyMjUyMzYzOA==","number":4156,"title":"SearchContext maintains a `size` length `int[]` when there are fewer than `size` results","user":{"login":"markelliot","id":685891,"node_id":"MDQ6VXNlcjY4NTg5MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/685891?v=4","gravatar_id":"","url":"https://api.github.com/users/markelliot","html_url":"https://github.com/markelliot","followers_url":"https://api.github.com/users/markelliot/followers","following_url":"https://api.github.com/users/markelliot/following{/other_user}","gists_url":"https://api.github.com/users/markelliot/gists{/gist_id}","starred_url":"https://api.github.com/users/markelliot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markelliot/subscriptions","organizations_url":"https://api.github.com/users/markelliot/orgs","repos_url":"https://api.github.com/users/markelliot/repos","events_url":"https://api.github.com/users/markelliot/events{/privacy}","received_events_url":"https://api.github.com/users/markelliot/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":65649829,"node_id":"MDU6TGFiZWw2NTY0OTgyOQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.8","name":"v0.90.8","color":"DDDDDD","default":false,"description":null},{"id":64607794,"node_id":"MDU6TGFiZWw2NDYwNzc5NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta2","name":"v1.0.0.Beta2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2013-11-12T14:53:20Z","updated_at":"2013-11-18T12:34:37Z","closed_at":"2013-11-18T12:34:37Z","author_association":"NONE","active_lock_reason":null,"body":"Reproduce with:\n\n```\nNode node = NodeBuilder.nodeBuilder().node();\nClient client = node.client();\n\nclient.prepareIndex(\"twitter\", \"twitter\")\n    .setSource(\"{ \\\"user\\\" : \\\"kimchy\\\", \\\"post_date\\\" : \\\"2009-11-15T14:12:12\\\", \\\"message\\\" : \\\"trying out Elastic Search\\\" }\")\n    .execute()\n    .get();\n\nWildcardQueryBuilder query = QueryBuilders.wildcardQuery(\"message\", \"trying\");\nSearchRequestBuilder request = client.prepareSearch(\"twitter\")\n        .setSearchType(SearchType.DFS_QUERY_AND_FETCH)\n        .setQuery(query)\n        .setSize(100000)\n        .setScroll(\"1m\");\nSearchResponse response = request.execute().get();\nfor (SearchHit hit : response.hits()) {\n    System.out.println(hit.getId());\n}\n\nclient.close();\nnode.close();\n```\n\nObserve by setting a breakpoint in `SearchContext#docIdstoLoad(int[], int, int)` and notice that despite creating a brand new index with only one result the `int[]` is sized at 100,000, to match the specified size.\n\nThis is leading to unwanted memory pressure, and appears to be fixable by editing `SearchService#shortcutDocIdsToLoad(SearchContext)` to size the `docIdsToLoad` array to the actual number of results.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}