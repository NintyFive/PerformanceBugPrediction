{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44146","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44146/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44146/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44146/events","html_url":"https://github.com/elastic/elasticsearch/issues/44146","id":466053714,"node_id":"MDU6SXNzdWU0NjYwNTM3MTQ=","number":44146,"title":"Cannot get aggregation result without filter","user":{"login":"HanguChoi","id":12369225,"node_id":"MDQ6VXNlcjEyMzY5MjI1","avatar_url":"https://avatars2.githubusercontent.com/u/12369225?v=4","gravatar_id":"","url":"https://api.github.com/users/HanguChoi","html_url":"https://github.com/HanguChoi","followers_url":"https://api.github.com/users/HanguChoi/followers","following_url":"https://api.github.com/users/HanguChoi/following{/other_user}","gists_url":"https://api.github.com/users/HanguChoi/gists{/gist_id}","starred_url":"https://api.github.com/users/HanguChoi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HanguChoi/subscriptions","organizations_url":"https://api.github.com/users/HanguChoi/orgs","repos_url":"https://api.github.com/users/HanguChoi/repos","events_url":"https://api.github.com/users/HanguChoi/events{/privacy}","received_events_url":"https://api.github.com/users/HanguChoi/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-07-10T01:36:36Z","updated_at":"2019-07-10T04:02:16Z","closed_at":"2019-07-10T01:57:18Z","author_association":"NONE","active_lock_reason":null,"body":"## I want a filtered docs result and not filtered aggregation result in same query. \r\n\r\nI've been used elasticsearch 1.75 and able to get this result, but I can't do this in elasticsearch 7. \r\nIf I am missing something, please let me know. \r\n\r\n## es 1.75\r\n### es 1.75 create index and add docs\r\n\r\n```\r\ncurl -X DELETE \"localhost:9200/some_index\"\r\n\r\ncurl -X PUT \"localhost:9200/some_index\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 5,\r\n    \"number_of_replicas\": 1,\r\n    \"analysis\": {}\r\n  },\r\n  \"mappings\": {\r\n    \"basic\": {\r\n      \"dynamic\": false,\r\n      \"properties\": {\r\n        \"user_id\": {\r\n          \"type\": \"integer\"\r\n        },\r\n        \"active\": {\r\n          \"type\": \"boolean\"\r\n        },\r\n        \"gender\": {\r\n          \"type\": \"string\"\r\n        },\r\n        \"age\": {\r\n          \"type\": \"integer\"\r\n        }\r\n      }\r\n    }\r\n    \r\n  }\r\n}\r\n'\r\n```\r\n\r\n### es 1.75 add docs\r\n```\r\n\r\ncurl -X PUT \"localhost:9200/some_index/basic/1\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 1,\r\n  \"active\": true,\r\n  \"gender\": \"M\",\r\n  \"age\": 30\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/some_index/basic/2\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 2,\r\n  \"active\": true,\r\n  \"gender\": \"M\",\r\n  \"age\": 37\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/some_index/basic/3\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 3,\r\n  \"active\": true,\r\n  \"gender\": \"M\",\r\n  \"age\": 23\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/some_index/basic/4\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 4,\r\n  \"active\": true,\r\n  \"gender\": \"F\",\r\n  \"age\": 27\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/some_index/basic/5\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 5,\r\n  \"active\": false,\r\n  \"gender\": \"F\",\r\n  \"age\": 31\r\n}\r\n'\r\n\r\n```\r\n\r\n### es 1.75 query\r\n```\r\n\r\ncurl -X GET \"localhost:9200/some_index/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"must\":{\r\n            \"match_all\": {}\r\n          }\r\n        }\r\n      },\r\n      \"functions\": []\r\n    }\r\n  },\r\n  \"filter\": {\r\n     \"and\": [\r\n      { \"terms\":{ \"active\": [ true ] } },\r\n      { \"terms\":{ \"gender\": [ \"m\" ] } }\r\n      \r\n    ]\r\n  },\r\n  \"from\": 0,\r\n  \"size\": 10,\r\n  \"aggs\": {\r\n    \"in_gen\": {\r\n      \"filter\": {\r\n        \"match_all\": {}\r\n      },\r\n      \"aggs\": {\r\n        \"gen\": {\r\n          \"terms\": {\r\n            \"field\": \"gender\",\r\n            \"size\": 30,\r\n            \"shard_size\": 30\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"in_age\": {\r\n      \"filter\": {\r\n        \"match_all\": {}\r\n      },\r\n      \"aggs\": {\r\n        \"age\": {\r\n          \"terms\": {\r\n            \"field\": \"age\",\r\n            \"size\": 30,\r\n            \"shard_size\": 30\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\n### es 1.75 result \r\n- hit docs are filtered result (count: 3) with `active: true` and `gender: 'M'`\r\n- aggregation result is for all (count: 5)\r\n\r\n\r\n```\r\n{\r\n  \"took\": 3,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 3,\r\n    \"max_score\": 1,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"some_index\",\r\n        \"_type\": \"basic\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"user_id\": 1,\r\n          \"active\": true,\r\n          \"gender\": \"M\",\r\n          \"age\": 30\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"some_index\",\r\n        \"_type\": \"basic\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"user_id\": 2,\r\n          \"active\": true,\r\n          \"gender\": \"M\",\r\n          \"age\": 37\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"some_index\",\r\n        \"_type\": \"basic\",\r\n        \"_id\": \"3\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"user_id\": 3,\r\n          \"active\": true,\r\n          \"gender\": \"M\",\r\n          \"age\": 23\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"aggregations\": {\r\n    \"in_gen\": {\r\n      \"doc_count\": 5,\r\n      \"gen\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 0,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": \"m\",\r\n            \"doc_count\": 3\r\n          },\r\n          {\r\n            \"key\": \"f\",\r\n            \"doc_count\": 2\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    \"in_age\": {\r\n      \"doc_count\": 5,\r\n      \"age\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 0,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": 23,\r\n            \"doc_count\": 1\r\n          },\r\n          {\r\n            \"key\": 27,\r\n            \"doc_count\": 1\r\n          },\r\n          {\r\n            \"key\": 30,\r\n            \"doc_count\": 1\r\n          },\r\n          {\r\n            \"key\": 31,\r\n            \"doc_count\": 1\r\n          },\r\n          {\r\n            \"key\": 37,\r\n            \"doc_count\": 1\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## es 7 (7.1.0)\r\n```\r\nVersion: 7.1.0, Build: default/tar/606a173/2019-05-16T00:43:15.323135Z, JVM: 1.8.0_112\r\n```\r\n\r\n### es7 - create index \r\n```\r\ncurl -X DELETE \"localhost:9700/some_index\"\r\n\r\ncurl -X PUT \"localhost:9700/some_index\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 5,\r\n    \"number_of_replicas\": 1,\r\n    \"analysis\": {}\r\n  },\r\n  \"mappings\": {\r\n    \"dynamic\": false,\r\n    \"properties\": {\r\n      \"user_id\": {\r\n        \"type\": \"integer\"\r\n      },\r\n      \"active\": {\r\n        \"type\": \"boolean\"\r\n      },\r\n      \"gender\": {\r\n        \"type\": \"keyword\"\r\n      },\r\n      \"age\": {\r\n        \"type\": \"integer\"\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\n### es7 - add docs\r\n```\r\n\r\ncurl -X PUT \"localhost:9700/some_index/_doc/1\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 1,\r\n  \"active\": true,\r\n  \"gender\": \"M\",\r\n  \"age\": 30\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9700/some_index/_doc/2\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 2,\r\n  \"active\": true,\r\n  \"gender\": \"M\",\r\n  \"age\": 37\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9700/some_index/_doc/3\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 3,\r\n  \"active\": true,\r\n  \"gender\": \"M\",\r\n  \"age\": 23\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9700/some_index/_doc/4\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 4,\r\n  \"active\": true,\r\n  \"gender\": \"F\",\r\n  \"age\": 27\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9700/some_index/_doc/5\" -H \"Content-Type: application/json\" -d'\r\n{\r\n  \"user_id\": 5,\r\n  \"active\": false,\r\n  \"gender\": \"F\",\r\n  \"age\": 31\r\n}\r\n'\r\n\r\n```\r\n\r\n### es7 - query \r\n```\r\ncurl -X GET \"localhost:9700/some_index/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"filter\": [\r\n            { \"terms\":{ \"active\": [ true ] } },\r\n            { \"terms\":{ \"gender\": [ \"M\" ] } }\r\n          ]\r\n        }\r\n      },\r\n      \"functions\": []\r\n    }\r\n  },\r\n  \"from\": 0,\r\n  \"size\": 10,\r\n  \"aggs\": {\r\n    \"in_gen\": {\r\n      \"filter\": {\r\n        \"match_all\": {}\r\n      },\r\n      \"aggs\": {\r\n        \"gen\": {\r\n          \"terms\": {\r\n            \"field\": \"gender\",\r\n            \"size\": 30,\r\n            \"shard_size\": 30\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"in_age\": {\r\n      \"filter\": {\r\n        \"match_all\": {}\r\n      },\r\n      \"aggs\": {\r\n        \"age\": {\r\n          \"terms\": {\r\n            \"field\": \"age\",\r\n            \"size\": 30,\r\n            \"shard_size\": 30\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\n### es7 result \r\n- hit docs are filtered result (count: 3) with `active: true` and `gender: 'M'`\r\n- aggregation result is filtered (count: 3) with `active: true` and `gender: 'M'`\r\n\r\n#### How can I get aggregation result  for all? (count: 5)\r\n\r\n```\r\n{\r\n  \"took\": 2,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0,\r\n    \"skipped\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": {\r\n      \"value\": 3,\r\n      \"relation\": \"eq\"\r\n    },\r\n    \"max_score\": 0,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"some_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"3\",\r\n        \"_score\": 0,\r\n        \"_source\": {\r\n          \"user_id\": 3,\r\n          \"active\": true,\r\n          \"gender\": \"M\",\r\n          \"age\": 23\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"some_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 0,\r\n        \"_source\": {\r\n          \"user_id\": 2,\r\n          \"active\": true,\r\n          \"gender\": \"M\",\r\n          \"age\": 37\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"some_index\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 0,\r\n        \"_source\": {\r\n          \"user_id\": 1,\r\n          \"active\": true,\r\n          \"gender\": \"M\",\r\n          \"age\": 30\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"aggregations\": {\r\n    \"in_gen\": {\r\n      \"doc_count\": 3,\r\n      \"gen\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 0,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": \"M\",\r\n            \"doc_count\": 3\r\n          }\r\n        ]\r\n      }\r\n    },\r\n    \"in_age\": {\r\n      \"doc_count\": 3,\r\n      \"age\": {\r\n        \"doc_count_error_upper_bound\": 0,\r\n        \"sum_other_doc_count\": 0,\r\n        \"buckets\": [\r\n          {\r\n            \"key\": 23,\r\n            \"doc_count\": 1\r\n          },\r\n          {\r\n            \"key\": 30,\r\n            \"doc_count\": 1\r\n          },\r\n          {\r\n            \"key\": 37,\r\n            \"doc_count\": 1\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n","closed_by":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"performed_via_github_app":null}