{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40572/events","html_url":"https://github.com/elastic/elasticsearch/issues/40572","id":426304626,"node_id":"MDU6SXNzdWU0MjYzMDQ2MjY=","number":40572,"title":"In hierarchical documents, under certain scenarios, snippets for descendant documents don't turn up","user":{"login":"kowndinyav","id":1315693,"node_id":"MDQ6VXNlcjEzMTU2OTM=","avatar_url":"https://avatars1.githubusercontent.com/u/1315693?v=4","gravatar_id":"","url":"https://api.github.com/users/kowndinyav","html_url":"https://github.com/kowndinyav","followers_url":"https://api.github.com/users/kowndinyav/followers","following_url":"https://api.github.com/users/kowndinyav/following{/other_user}","gists_url":"https://api.github.com/users/kowndinyav/gists{/gist_id}","starred_url":"https://api.github.com/users/kowndinyav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kowndinyav/subscriptions","organizations_url":"https://api.github.com/users/kowndinyav/orgs","repos_url":"https://api.github.com/users/kowndinyav/repos","events_url":"https://api.github.com/users/kowndinyav/events{/privacy}","received_events_url":"https://api.github.com/users/kowndinyav/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-03-28T05:24:29Z","updated_at":"2019-04-05T07:12:02Z","closed_at":"2019-03-28T08:16:00Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** : AWS Elastic Search Service 5.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** : Should be what ever JVM bundled with AWS Elastic Search Service \r\n\r\n**OS version** (`uname -a` if on a Unix-like system): \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe have an application where we store documents in hierarchical manner. At a high level, structure is \"board -> post -> comment -> reply\".\r\n\r\nThe requirement is to be able to search given text inside \"Post\" hierarchy i.e if text matches any of the fields from post, comment and reply documents, return post with matched snippets. One problem that we are observing is, post object is always returned when it matches any of the post, comment and reply fields. But in some cases snippets are not turning up. \r\n\r\nFor example, in the given scenario from the attachments, when searched for text \"document\", it fails to produce comment snippet for '202_post' (post it-self is returned).\r\n\r\nAccording to my understanding, given that post object is always returned with matched criteria, there is no issue in matching but there is some issue preparing the response for snippets.\r\n\r\n**Steps to reproduce**\r\nAttachments should help in reproducing the issue\r\n1. - create.txt - contains ES fragment to create a test index and the documents\r\n2. - query.txt - contains intended ES query\r\n3. - response.txt - contains the response\r\n4. - picture1.png - a visual representation of what goes wrong in the response\r\n\r\n \r\n\r\n[create.txt](https://github.com/elastic/elasticsearch/files/3016292/create.txt)\r\n![Picture1](https://user-images.githubusercontent.com/1315693/55132249-c3bd4600-5147-11e9-93a1-1f3038958c53.png)\r\n[query.txt](https://github.com/elastic/elasticsearch/files/3016293/query.txt)\r\n[response.txt](https://github.com/elastic/elasticsearch/files/3016294/response.txt)\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}