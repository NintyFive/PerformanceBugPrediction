[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259472041","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259472041","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259472041,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ3MjA0MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T17:23:59Z","updated_at":"2016-11-09T20:29:13Z","author_association":"MEMBER","body":"@gehel I'm very sorry, but I'm going to have to ask you for a more thorough reproduction here because this does not reproduce for me, and it surprises me that you're having trouble here. The reason that this is surprising to me is because the logging appenders would be configured before the security manager is installed.\n\nMy reproduction:\n- start a logging instance of Elasticsearch with the default config, a different cluster name, and specify `http.port` and `transport.tcp.port`: `--cluster.name=gelf --http.port=9201 --transport.tcp.port=9301`\n- start Logstash with `gelf` input and `elasticsearch` output: `-e 'input { gelf {} } output { elasticsearch { hosts => [ \"127.0.0.1:9201\" ] } }'`\n- start tcpdump against loopback interface and filter udp and port 12201\n- edit logging.yml with the following diff\n\n```\n3c3\n< rootLogger: ${es.logger.level}, console, file, gelf\n---\n> rootLogger: ${es.logger.level}, console, file\n38,49d37\n<   gelf:\n<     type: biz.paluch.logging.gelf.log4j.GelfLogAppender\n<     Threshold: INFO\n<     Host: udp:localhost\n<     Port: 12201\n<     Version: 1.1\n<     Facility: elasticsearch\n<     ExtractStackTrace: true\n<     FilterStackTrace: true\n<     MdcProfiling: false\n<     TimestampPattern: yyyy-MM-dd HH:mm:ss,SSSS\n<     MaximumMessageSize: 8192\n```\n- start Elasticsearch pointing to this config\n\nI can see packets in the tcpdump, and most importantly, I can see events hitting the logging instance of Elasticsearch:\n\n```\n[2016-11-09 12:14:18,155][INFO ][cluster.metadata         ] [Korvac] [logstash-2016.11.09] create_mapping [logs]\n```\n\n```\n$ curl -XGET \"localhost:9201/_search?size=1&pretty=1\"\n{\n  \"took\" : 1,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"logstash-2016.11.09\",\n      \"_type\" : \"logs\",\n      \"_id\" : \"AVhKFUY6iHKVEXE6By2d\",\n      \"_score\" : 1.0,\n      \"_source\" : {\n        \"host\" : \"jason-mbp.local\",\n        \"level\" : 6,\n        \"facility\" : \"elasticsearch\",\n        \"@version\" : \"1\",\n        \"@timestamp\" : \"2016-11-09T17:14:08.731Z\",\n        \"source_host\" : \"127.0.0.1\",\n        \"message\" : \"[Freakmaster] version[2.4.1], pid[26800], build[c67dc32/2016-09-27T18:57:55Z]\",\n        \"LoggerName\" : \"node\",\n        \"Server\" : \"jason-mbp.local\",\n        \"SourceSimpleClassName\" : \"Node\",\n        \"SourceClassName\" : \"org.elasticsearch.node.Node\",\n        \"Time\" : \"2016-11-09 12:14:08,0731\",\n        \"Severity\" : \"INFO\",\n        \"SourceLineNumber\" : 149,\n        \"Thread\" : \"main\",\n        \"SourceMethodName\" : \"<init>\"\n      }\n    } ]\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259476078","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259476078","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259476078,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ3NjA3OA==","user":{"login":"gehel","id":1415765,"node_id":"MDQ6VXNlcjE0MTU3NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/1415765?v=4","gravatar_id":"","url":"https://api.github.com/users/gehel","html_url":"https://github.com/gehel","followers_url":"https://api.github.com/users/gehel/followers","following_url":"https://api.github.com/users/gehel/following{/other_user}","gists_url":"https://api.github.com/users/gehel/gists{/gist_id}","starred_url":"https://api.github.com/users/gehel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gehel/subscriptions","organizations_url":"https://api.github.com/users/gehel/orgs","repos_url":"https://api.github.com/users/gehel/repos","events_url":"https://api.github.com/users/gehel/events{/privacy}","received_events_url":"https://api.github.com/users/gehel/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T17:41:06Z","updated_at":"2016-11-09T17:41:06Z","author_association":"NONE","body":"@jasontedor thanks for the quick answer! Strange that this works for you. If I understand correctly, you did not install any gelf specific security policy and it works?\n\nI'm not sure what you mean by:\n\n> The reason that this is surprising to me is because the logging appenders would be configured because the security manager is installed.\n\nI'll see if I can find anything else problematic in our configuration, but I am not really sure where to look...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259477532","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259477532","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259477532,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ3NzUzMg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T17:47:06Z","updated_at":"2016-11-09T17:47:06Z","author_association":"MEMBER","body":"> If I understand correctly, you did not install any gelf specific security policy and it works?\n\nThis is correct, I did not, and I did not expect to have to.\n\n> I'm not sure what you mean by:\n> \n> > The reason that this is surprising to me is because the logging appenders would be configured because the security manager is installed.\n\nWhen the JVM starts, there is no security manager in place, we configure it after some initialization has occurred. It is only after the security manager is in place that permissions become relevant. In particular, logging is something that we configure before the security manager is in place, the appender will have been created and the socket opened already.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259480262","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259480262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259480262,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ4MDI2Mg==","user":{"login":"gehel","id":1415765,"node_id":"MDQ6VXNlcjE0MTU3NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/1415765?v=4","gravatar_id":"","url":"https://api.github.com/users/gehel","html_url":"https://github.com/gehel","followers_url":"https://api.github.com/users/gehel/followers","following_url":"https://api.github.com/users/gehel/following{/other_user}","gists_url":"https://api.github.com/users/gehel/gists{/gist_id}","starred_url":"https://api.github.com/users/gehel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gehel/subscriptions","organizations_url":"https://api.github.com/users/gehel/orgs","repos_url":"https://api.github.com/users/gehel/repos","events_url":"https://api.github.com/users/gehel/events{/privacy}","received_events_url":"https://api.github.com/users/gehel/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T17:58:15Z","updated_at":"2016-11-09T17:58:15Z","author_association":"NONE","body":"A quick look at the sources of logstash-gelf indicate that the DatagramChannel is created and connected at initialisation, not on the first message, so if elasticsearch does indeed configure security manager only after logging, what I'm seeing does not make sense. I assume this is true for elasticsearch 2.4.1?\n\nI'll try to do a test on a fresh elasticsearch install and I'll see if can reproduce it there as well.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259483302","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259483302","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259483302,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ4MzMwMg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T18:11:00Z","updated_at":"2016-11-09T18:11:00Z","author_association":"MEMBER","body":"> if elasticsearch does indeed configure security manager only after logging\n\nThis is definitely the case.\n\n> I assume this is true for elasticsearch 2.4.1?\n\nYes, and that's what I tested against (thank you for providing the version information in the initial report).\n\n```\n$ curl -XGET localhost:9200/\n{\n  \"name\" : \"Sybil Dvorak\",\n  \"cluster_name\" : \"elasticsearch_jason\",\n  \"cluster_uuid\" : \"LsjwB5UySQmUjrHEqVUO-A\",\n  \"version\" : {\n    \"number\" : \"2.4.1\",\n    \"build_hash\" : \"c67dc32e24162035d18d6fe1e952c4cbcbe79d16\",\n    \"build_timestamp\" : \"2016-09-27T18:57:55Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"5.5.2\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n```\n\n> I'll try to do a test on a fresh elasticsearch install and I'll see if can reproduce it there as well.\n\nThanks.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259490551","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259490551","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259490551,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTQ5MDU1MQ==","user":{"login":"gehel","id":1415765,"node_id":"MDQ6VXNlcjE0MTU3NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/1415765?v=4","gravatar_id":"","url":"https://api.github.com/users/gehel","html_url":"https://github.com/gehel","followers_url":"https://api.github.com/users/gehel/followers","following_url":"https://api.github.com/users/gehel/following{/other_user}","gists_url":"https://api.github.com/users/gehel/gists{/gist_id}","starred_url":"https://api.github.com/users/gehel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gehel/subscriptions","organizations_url":"https://api.github.com/users/gehel/orgs","repos_url":"https://api.github.com/users/gehel/repos","events_url":"https://api.github.com/users/gehel/events{/privacy}","received_events_url":"https://api.github.com/users/gehel/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T18:39:56Z","updated_at":"2016-11-09T18:39:56Z","author_association":"NONE","body":"It turns out that we are using a fairly old version of logstash-gelf (1.5.3) and not the latest and greatest 1.11.0. I can reproduce the problem in a fresh install and logstash-gelf 1.5.3, but not with 1.11.0\n\nThat does not entirely explain why the security manager gets in the way, but I suspect a later initialisation of the DatagramChannel in 1.5.3, but I have not checked.\n\nTime to upgrade! Thanks @jasontedor for the help! I'm closing this as resolved.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259504171","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259504171","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259504171,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTUwNDE3MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T19:32:46Z","updated_at":"2016-11-09T19:32:46Z","author_association":"MEMBER","body":"You're welcome @gehel. Thanks for providing an easy means of reproducing, that gave me an opportunity to dig into your actual situation.\n\nWe [filter](https://github.com/elastic/elasticsearch/blob/a025c9c2eb1564033eb148a8d157ae70849b108c/core/src/main/java/org/elasticsearch/bootstrap/ESPolicy.java#L117) out the permission `permission java.net.SocketPermission \"localhost:0\", \"listen\"`. That's why you could not successfully grant it.\n\nI'm sorry for the trouble, but I'm glad that you're able to proceed now.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259511286","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259511286","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259511286,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTUxMTI4Ng==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T20:01:13Z","updated_at":"2016-11-09T20:01:13Z","author_association":"MEMBER","body":"The logstash-gelf appender change that obviated this issue is mp911de/logstash-gelf@89d384055cc958627a7e72d92b10119409cc8fe9. Prior to that, the UDP sender would be initialized on the first log message, which would be after we had installed the security manager.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259511665","html_url":"https://github.com/elastic/elasticsearch/issues/21428#issuecomment-259511665","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21428","id":259511665,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTUxMTY2NQ==","user":{"login":"gehel","id":1415765,"node_id":"MDQ6VXNlcjE0MTU3NjU=","avatar_url":"https://avatars1.githubusercontent.com/u/1415765?v=4","gravatar_id":"","url":"https://api.github.com/users/gehel","html_url":"https://github.com/gehel","followers_url":"https://api.github.com/users/gehel/followers","following_url":"https://api.github.com/users/gehel/following{/other_user}","gists_url":"https://api.github.com/users/gehel/gists{/gist_id}","starred_url":"https://api.github.com/users/gehel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gehel/subscriptions","organizations_url":"https://api.github.com/users/gehel/orgs","repos_url":"https://api.github.com/users/gehel/repos","events_url":"https://api.github.com/users/gehel/events{/privacy}","received_events_url":"https://api.github.com/users/gehel/received_events","type":"User","site_admin":false},"created_at":"2016-11-09T20:02:55Z","updated_at":"2016-11-09T20:02:55Z","author_association":"NONE","body":"@jasontedor Thanks for digging into this! That was my intuition, but I did not actually take the time to find the commit and validate the theory. Great!\n","performed_via_github_app":null}]