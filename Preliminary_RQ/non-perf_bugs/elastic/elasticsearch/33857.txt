{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33857","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33857/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33857/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33857/events","html_url":"https://github.com/elastic/elasticsearch/issues/33857","id":361733965,"node_id":"MDU6SXNzdWUzNjE3MzM5NjU=","number":33857,"title":"ShrinkIndexIT.testCreateShrinkIndexToN  fails on Windows ","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1039420826,"node_id":"MDU6TGFiZWwxMDM5NDIwODI2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.6.12","name":"v5.6.12","color":"eeeeee","default":false,"description":""},{"id":1163688906,"node_id":"MDU6TGFiZWwxMTYzNjg4OTA2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.7.0","name":"v6.7.0","color":"dddddd","default":false,"description":""},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":30,"created_at":"2018-09-19T12:51:54Z","updated_at":"2019-02-07T10:09:37Z","closed_at":"2019-02-01T08:38:10Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"[5.6](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+5.6+multijob-windows-compatibility/7/console)\r\n```\r\nFAILURE 33.4s J0 | ShrinkIndexIT.testCreateShrinkIndexToN <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: timed out waiting for green state\r\n   > \tat __randomizedtesting.SeedInfo.seed([FAAB0749B4C53E6F:EAEB4985116575FC]:0)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.ensureColor(ESIntegTestCase.java:933)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.ensureGreen(ESIntegTestCase.java:899)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.ensureGreen(ESIntegTestCase.java:888)\r\n   > \tat org.elasticsearch.action.admin.indices.create.ShrinkIndexIT.testCreateShrinkIndexToN(ShrinkIndexIT.java:115)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\nand \r\n```\r\n Caused by: java.nio.file.AccessDeniedException: C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\\recovery.AWXo49VofFhOtlDMUmb5._0.cfs -> C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\\_0.cfs\r\n  1> \tat sun.nio.fs.WindowsException.translateToIOException(WindowsException.java:83) ~[?:?]\r\n  1> \tat sun.nio.fs.WindowsException.rethrowAsIOException(WindowsException.java:97) ~[?:?]\r\n  1> \tat sun.nio.fs.WindowsFileCopy.move(WindowsFileCopy.java:301) ~[?:?]\r\n  1> \tat sun.nio.fs.WindowsFileSystemProvider.move(WindowsFileSystemProvider.java:287) ~[?:?]\r\n  1> \tat org.apache.lucene.mockfile.FilterFileSystemProvider.move(FilterFileSystemProvider.java:147) ~[lucene-test-framework-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:40]\r\n  1> \tat org.apache.lucene.mockfile.FilterFileSystemProvider.move(FilterFileSystemProvider.java:147) ~[lucene-test-framework-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:40]\r\n  1> \tat org.apache.lucene.mockfile.FilterFileSystemProvider.move(FilterFileSystemProvider.java:147) ~[lucene-test-framework-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:40]\r\n  1> \tat org.apache.lucene.mockfile.FilterFileSystemProvider.move(FilterFileSystemProvider.java:147) ~[lucene-test-framework-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:40]\r\n  1> \tat java.nio.file.Files.move(Files.java:1395) ~[?:1.8.0_181]\r\n  1> \tat org.apache.lucene.store.FSDirectory.rename(FSDirectory.java:297) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n  1> \tat org.apache.lucene.store.FilterDirectory.rename(FilterDirectory.java:88) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n  1> \tat org.apache.lucene.store.FilterDirectory.rename(FilterDirectory.java:88) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n  1> \tat org.elasticsearch.index.store.Store.renameTempFilesSafe(Store.java:319) ~[main/:?]\r\n  1> \tat org.elasticsearch.indices.recovery.RecoveryTarget.renameAllTempFiles(RecoveryTarget.java:181) ~[main/:?]\r\n  1> \tat org.elasticsearch.indices.recovery.RecoveryTarget.cleanFiles(RecoveryTarget.java:406) ~[main/:?]\r\n  1> \tat org.elasticsearch.indices.recovery.PeerRecoveryTargetService$CleanFilesRequestHandler.messageReceived(PeerRecoveryTargetService.java:486) ~[main/:?]\r\n  1> \tat org.elasticsearch.indices.recovery.PeerRecoveryTargetService$CleanFilesRequestHandler.messageReceived(PeerRecoveryTargetService.java:480) ~[main/:?]\r\n  1> \tat org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[main/:?]\r\n  1> \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[main/:?]\r\n  1> \tat org.elasticsearch.transport.local.LocalTransport$2.doRun(LocalTransport.java:390) ~[main/:?]\r\n  1> \t... 5 more\r\n\r\n[...]\r\n\r\n1> java.io.IOException: Could not remove the following files (in the order of attempts):\r\n  1>    C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\\_0.cfs: java.nio.file.AccessDeniedException: C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\\_0.cfs\r\n  1>    C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\\_1.cfs: java.nio.file.AccessDeniedException: C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\\_1.cfs\r\n  1>    C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index: java.nio.file.DirectoryNotEmptyException: C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\\index\r\n  2> REPRODUCE WITH: gradlew :core:integTest -Dtests.seed=FAAB0749B4C53E6F -Dtests.class=org.elasticsearch.action.admin.indices.create.ShrinkIndexIT -Dtests.method=\"testCreateShrinkIndexToN\" -Dtests.security.manager=true -Dtests.locale=zh -Dtests.timezone=Etc/GMT+10\r\n  1>    C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0: java.nio.file.DirectoryNotEmptyException: C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\\0\r\n  1>    C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg: java.nio.file.DirectoryNotEmptyException: C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+5.6+multijob-windows-compatibility\\core\\build\\testrun\\integTest\\J0\\temp\\org.elasticsearch.action.admin.indices.create.ShrinkIndexIT_FAAB0749B4C53E6F-001\\tempDir-002\\data\\nodes\\2\\indices\\dT7bmk_uQtqKf2wjfSn3Lg\r\n  1> \r\n  1> \tat org.apache.lucene.util.IOUtils.rm(IOUtils.java:329) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:40]\r\n  1> \tat org.elasticsearch.env.NodeEnvironment.deleteIndexDirectoryUnderLock(NodeEnvironment.java:558) ~[main/:?]\r\n  1> \tat org.elasticsearch.env.NodeEnvironment.deleteIndexDirectorySafe(NodeEnvironment.java:542) ~[main/:?]\r\n  1> \tat org.elasticsearch.indices.IndicesService.deleteIndexStoreIfDeletionAllowed(IndicesService.java:652) [main/:?]\r\n  1> \tat org.elasticsearch.indices.IndicesService.deleteIndexStore(IndicesService.java:639) [main/:?]\r\n  1> \tat org.elasticsearch.indices.IndicesService.deleteIndexStore(IndicesService.java:634) [main/:?]\r\n  1> \tat org.elasticsearch.indices.IndicesService.deleteUnassignedIndex(IndicesService.java:602) [main/:?]\r\n  1> \tat org.elasticsearch.indices.cluster.IndicesClusterStateService.deleteIndices(IndicesClusterStateService.java:263) [main/:?]\r\n  1> \tat org.elasticsearch.indices.cluster.IndicesClusterStateService.applyClusterState(IndicesClusterStateService.java:192) [main/:?]\r\n  1> \tat org.elasticsearch.cluster.service.ClusterService.callClusterStateAppliers(ClusterService.java:814) [main/:?]\r\n  1> \tat org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:768) [main/:?]\r\n  1> \tat org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:587) [main/:?]\r\n  1> \tat org.elasticsearch.cluster.service.ClusterService$ClusterServiceTaskBatcher.run(ClusterService.java:263) [main/:?]\r\n  1> \tat org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [main/:?]\r\n  1> \tat org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [main/:?]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:576) [main/:?]\r\n  1> \tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:247) [main/:?]\r\n  1> \tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:210) [main/:?]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_181]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_181]\r\n  1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\n```\r\n\r\nIt also happened on [6.4](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.4+multijob-windows-compatibility/8/console), [6.x](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+multijob-windows-compatibility/8/console) and [master](https://www.google.com/url?q=https%3A%2F%2Felasticsearch-ci.elastic.co%2Fjob%2Felastic%2Belasticsearch%2Bmaster%2Bmultijob-windows-compatibility%2F7%2Fconsole&sa=D&sntz=1&usg=AFQjCNGDaYrqrpeSYuN-NrYUSBSzoM4igw)\r\n\r\nI was not able to reproduce it on a Windows 2012 VM. \r\nThere's no evidence of similar failures in the past, nor recent changes to the 5.6 \r\nthat are obviously related. \r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}