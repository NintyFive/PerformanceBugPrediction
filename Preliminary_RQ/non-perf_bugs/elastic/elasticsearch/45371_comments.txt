[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/519818553","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-519818553","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":519818553,"node_id":"MDEyOklzc3VlQ29tbWVudDUxOTgxODU1Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-09T07:49:33Z","updated_at":"2019-08-09T07:49:33Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/520208657","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-520208657","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":520208657,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDIwODY1Nw==","user":{"login":"dengweisysu","id":18375623,"node_id":"MDQ6VXNlcjE4Mzc1NjIz","avatar_url":"https://avatars1.githubusercontent.com/u/18375623?v=4","gravatar_id":"","url":"https://api.github.com/users/dengweisysu","html_url":"https://github.com/dengweisysu","followers_url":"https://api.github.com/users/dengweisysu/followers","following_url":"https://api.github.com/users/dengweisysu/following{/other_user}","gists_url":"https://api.github.com/users/dengweisysu/gists{/gist_id}","starred_url":"https://api.github.com/users/dengweisysu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dengweisysu/subscriptions","organizations_url":"https://api.github.com/users/dengweisysu/orgs","repos_url":"https://api.github.com/users/dengweisysu/repos","events_url":"https://api.github.com/users/dengweisysu/events{/privacy}","received_events_url":"https://api.github.com/users/dengweisysu/received_events","type":"User","site_admin":false},"created_at":"2019-08-11T08:01:10Z","updated_at":"2019-08-11T08:01:10Z","author_association":"CONTRIBUTOR","body":"Disruptor use sun.misc.Unsafe internal, and this is forbidden in thirdPartyAudit.... I'm thinking other solution ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/520405488","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-520405488","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":520405488,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDQwNTQ4OA==","user":{"login":"dengweisysu","id":18375623,"node_id":"MDQ6VXNlcjE4Mzc1NjIz","avatar_url":"https://avatars1.githubusercontent.com/u/18375623?v=4","gravatar_id":"","url":"https://api.github.com/users/dengweisysu","html_url":"https://github.com/dengweisysu","followers_url":"https://api.github.com/users/dengweisysu/followers","following_url":"https://api.github.com/users/dengweisysu/following{/other_user}","gists_url":"https://api.github.com/users/dengweisysu/gists{/gist_id}","starred_url":"https://api.github.com/users/dengweisysu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dengweisysu/subscriptions","organizations_url":"https://api.github.com/users/dengweisysu/orgs","repos_url":"https://api.github.com/users/dengweisysu/repos","events_url":"https://api.github.com/users/dengweisysu/events{/privacy}","received_events_url":"https://api.github.com/users/dengweisysu/received_events","type":"User","site_admin":false},"created_at":"2019-08-12T12:31:49Z","updated_at":"2019-08-12T12:31:49Z","author_association":"CONTRIBUTOR","body":"use LinkedBlockingQueue instead of disruptor. \r\n\r\nIndexing elapsed time for each scene list below:\r\n\r\n- translog open with async durability model : 18 minutes\r\n- translog close (change source code) : 12 minutes\r\n- translog writing async using disruptor(change source code) : 12 minutes\r\n- **translog writing async using LinkedBlockQueue(change source code) : about 13 minutes**","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521246705","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-521246705","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":521246705,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTI0NjcwNQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2019-08-14T13:31:20Z","updated_at":"2019-08-14T13:31:20Z","author_association":"CONTRIBUTOR","body":"hey @dengweisysu thanks for opening this. I would like to take a couple of steps back. I skimmed the code and I understand what you are after. Yet, the translog is a very delicate part of the system which in some cases warrants performance hits over complexity. That said, I would like to understand what you are trying to improve and where are the bottlenecks. I understand that there is a lock around writing the bytes out and there are locks on when we roll over generations. Many different parts play a role here so it's crucial to understand what the bottleneck before we drop many guarantees by making everything async, threaded or queued. \r\n\r\nyou are referring to a some kind of benchmark, can you share how you benchmark the system? I have to be able to reproduce the problem you are seeing, I can try to do this myself if you can't provide the code for this scenario.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521490618","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-521490618","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":521490618,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTQ5MDYxOA==","user":{"login":"dengweisysu","id":18375623,"node_id":"MDQ6VXNlcjE4Mzc1NjIz","avatar_url":"https://avatars1.githubusercontent.com/u/18375623?v=4","gravatar_id":"","url":"https://api.github.com/users/dengweisysu","html_url":"https://github.com/dengweisysu","followers_url":"https://api.github.com/users/dengweisysu/followers","following_url":"https://api.github.com/users/dengweisysu/following{/other_user}","gists_url":"https://api.github.com/users/dengweisysu/gists{/gist_id}","starred_url":"https://api.github.com/users/dengweisysu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dengweisysu/subscriptions","organizations_url":"https://api.github.com/users/dengweisysu/orgs","repos_url":"https://api.github.com/users/dengweisysu/repos","events_url":"https://api.github.com/users/dengweisysu/events{/privacy}","received_events_url":"https://api.github.com/users/dengweisysu/received_events","type":"User","site_admin":false},"created_at":"2019-08-15T02:28:28Z","updated_at":"2019-08-15T02:28:28Z","author_association":"CONTRIBUTOR","body":"> hey @dengweisysu thanks for opening this. I would like to take a couple of steps back. I skimmed the code and I understand what you are after. Yet, the translog is a very delicate part of the system which in some cases warrants performance hits over complexity. That said, I would like to understand what you are trying to improve and where are the bottlenecks. I understand that there is a lock around writing the bytes out and there are locks on when we roll over generations. Many different parts play a role here so it's crucial to understand what the bottleneck before we drop many guarantees by making everything async, threaded or queued.\r\n> \r\n> you are referring to a some kind of benchmark, can you share how you benchmark the system? I have to be able to reproduce the problem you are seeing, I can try to do this myself if you can't provide the code for this scenario.\r\n\r\n\r\nTest scenarios:\r\n\r\nmachine: Cpu=24 core (2.4G Hz ), memory=64G\r\ndoc count: 10 million (user info, one doc per user, so it's 10 million diffent user info)\r\nfield count per doc: 400+ ,most of them are long,integer,keyword(no text field) and docvalues is disable\r\ndoc id : **user id** from our system\r\ntranslog size per doc: about 3k （34G tlog generate for 10 million doc）\r\n\r\nmain index settings is below:\r\n\r\n        \"refresh_interval\" : \"-1\",\r\n        \"translog\" : {\r\n          \"generation_threshold_size\" : \"64mb\", (this is default value)\r\n          \"flush_threshold_size\" : \"30gb\",\r\n          \"sync_interval\" : \"60s\",\r\n          \"durability\" : \"async\"\r\n        },\r\n        \"number_of_replicas\" : \"0\",\r\n        \"number_of_shards\" : \"1\",\r\n        \"merge\" : {\r\n          \"scheduler\" : {\r\n            \"max_thread_count\" : \"1\"\r\n          },\r\n          \"policy\" : {\r\n            \"segments_per_tier\" : \"30\"\r\n          }\r\n        }\r\n\r\nwe use Spark to write data,. When writing, cpu is nearly about 90%+., 24 write thread is busily writing.\r\n\r\nIn pull request discuss, we found that when i make the config to avoid fsync and rollgeneration, performance will improve a lot.\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521490757","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-521490757","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":521490757,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTQ5MDc1Nw==","user":{"login":"dengweisysu","id":18375623,"node_id":"MDQ6VXNlcjE4Mzc1NjIz","avatar_url":"https://avatars1.githubusercontent.com/u/18375623?v=4","gravatar_id":"","url":"https://api.github.com/users/dengweisysu","html_url":"https://github.com/dengweisysu","followers_url":"https://api.github.com/users/dengweisysu/followers","following_url":"https://api.github.com/users/dengweisysu/following{/other_user}","gists_url":"https://api.github.com/users/dengweisysu/gists{/gist_id}","starred_url":"https://api.github.com/users/dengweisysu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dengweisysu/subscriptions","organizations_url":"https://api.github.com/users/dengweisysu/orgs","repos_url":"https://api.github.com/users/dengweisysu/repos","events_url":"https://api.github.com/users/dengweisysu/events{/privacy}","received_events_url":"https://api.github.com/users/dengweisysu/received_events","type":"User","site_admin":false},"created_at":"2019-08-15T02:29:15Z","updated_at":"2019-08-15T02:29:15Z","author_association":"CONTRIBUTOR","body":"jvm heap size is 31G","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521591686","html_url":"https://github.com/elastic/elasticsearch/issues/45371#issuecomment-521591686","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45371","id":521591686,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTU5MTY4Ng==","user":{"login":"dengweisysu","id":18375623,"node_id":"MDQ6VXNlcjE4Mzc1NjIz","avatar_url":"https://avatars1.githubusercontent.com/u/18375623?v=4","gravatar_id":"","url":"https://api.github.com/users/dengweisysu","html_url":"https://github.com/dengweisysu","followers_url":"https://api.github.com/users/dengweisysu/followers","following_url":"https://api.github.com/users/dengweisysu/following{/other_user}","gists_url":"https://api.github.com/users/dengweisysu/gists{/gist_id}","starred_url":"https://api.github.com/users/dengweisysu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dengweisysu/subscriptions","organizations_url":"https://api.github.com/users/dengweisysu/orgs","repos_url":"https://api.github.com/users/dengweisysu/repos","events_url":"https://api.github.com/users/dengweisysu/events{/privacy}","received_events_url":"https://api.github.com/users/dengweisysu/received_events","type":"User","site_admin":false},"created_at":"2019-08-15T10:12:46Z","updated_at":"2019-08-15T10:12:46Z","author_association":"CONTRIBUTOR","body":"this test is done on v6.6.2\r\nAs I known, there are nearly no different in dealing with translog  with head version of master branch ","performed_via_github_app":null}]