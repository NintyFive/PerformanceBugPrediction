{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46722","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46722/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46722/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46722/events","html_url":"https://github.com/elastic/elasticsearch/issues/46722","id":493652064,"node_id":"MDU6SXNzdWU0OTM2NTIwNjQ=","number":46722,"title":"Invalid '?' in query when using word_delimiter_graph","user":{"login":"null-pointer-byte","id":55328334,"node_id":"MDQ6VXNlcjU1MzI4MzM0","avatar_url":"https://avatars1.githubusercontent.com/u/55328334?v=4","gravatar_id":"","url":"https://api.github.com/users/null-pointer-byte","html_url":"https://github.com/null-pointer-byte","followers_url":"https://api.github.com/users/null-pointer-byte/followers","following_url":"https://api.github.com/users/null-pointer-byte/following{/other_user}","gists_url":"https://api.github.com/users/null-pointer-byte/gists{/gist_id}","starred_url":"https://api.github.com/users/null-pointer-byte/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/null-pointer-byte/subscriptions","organizations_url":"https://api.github.com/users/null-pointer-byte/orgs","repos_url":"https://api.github.com/users/null-pointer-byte/repos","events_url":"https://api.github.com/users/null-pointer-byte/events{/privacy}","received_events_url":"https://api.github.com/users/null-pointer-byte/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-09-14T18:22:24Z","updated_at":"2019-09-16T07:25:12Z","closed_at":"2019-09-16T07:25:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 7.3.2, Build: default/tar/1c1faf1/2019-09-06T14:40:30.409026Z, JVM: 12.0.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"12.0.2\" 2019-07-16\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin MacBook-Pro.local 18.7.0 Darwin Kernel Version 18.7.0: Tue Aug 20 16:57:14 PDT 2019; root:xnu-4903.271.2~2/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen `word_delimiter_graph` is used and any token is removed by subsequent filters, the query containing a `PhraseQuery` from the produced tokens emits an invalid `?` in place of the removed token.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create an index with below mappings.\r\n```\r\nPUT /my-index HTTP/1.1\r\nHost: localhost:9200\r\nContent-Type: application/json\r\n\r\n{\r\n    \"settings\": {\r\n        \"number_of_shards\": 1,\r\n        \"number_of_replicas\": 0,\r\n        \"analysis\": {\r\n            \"filter\": {\r\n                \"english_stop\": {\r\n                    \"type\": \"stop\",\r\n                    \"stopwords\": \"_english_\"\r\n                },\r\n                \"my_delimiter\": {\r\n                    \"type\": \"word_delimiter_graph\"\r\n                }\r\n            },\r\n            \"analyzer\": {\r\n                \"my_analyzer\": {\r\n                    \"tokenizer\": \"whitespace\",\r\n                    \"filter\": [\r\n                        \"my_delimiter\",\r\n                        \"lowercase\",\r\n                        \"english_stop\"\r\n                    ]\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"mappings\": {\r\n        \"properties\": {\r\n            \"title\": {\r\n                \"type\": \"text\",\r\n                \"analyzer\": \"my_analyzer\"\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n2. Query the validate API to get the parsed query.\r\n```\r\nGET /my-index/_validate/query?explain HTTP/1.1\r\nHost: localhost:9200\r\nContent-Type: application/json\r\n\r\n{\r\n    \"query\": {\r\n        \"match_phrase\": {\r\n            \"title\": {\r\n                \"query\": \"stripAndHtml\"\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n3. Actual response contains an invalid `?` where `And` was removed from the tokens emitted by `word_delimiter_graph`.\r\n```\r\n{\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"failed\": 0\r\n    },\r\n    \"valid\": true,\r\n    \"explanations\": [\r\n        {\r\n            \"index\": \"my-index\",\r\n            \"valid\": true,\r\n            \"explanation\": \"title:\\\"strip ? html\\\"\"\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\nExpected response should be:\r\n```\r\n{\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"failed\": 0\r\n    },\r\n    \"valid\": true,\r\n    \"explanations\": [\r\n        {\r\n            \"index\": \"my-index\",\r\n            \"valid\": true,\r\n            \"explanation\": \"title:\\\"strip html\\\"\"\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\nVerified on v7.3.2 as well as master branch, got the same issue.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}