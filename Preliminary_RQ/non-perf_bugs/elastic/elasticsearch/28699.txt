{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28699","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28699/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28699/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28699/events","html_url":"https://github.com/elastic/elasticsearch/issues/28699","id":297630009,"node_id":"MDU6SXNzdWUyOTc2MzAwMDk=","number":28699,"title":"array_index_out_of_bounds_exception on multiple indexed_shape queries","user":{"login":"ncavig","id":323562,"node_id":"MDQ6VXNlcjMyMzU2Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/323562?v=4","gravatar_id":"","url":"https://api.github.com/users/ncavig","html_url":"https://github.com/ncavig","followers_url":"https://api.github.com/users/ncavig/followers","following_url":"https://api.github.com/users/ncavig/following{/other_user}","gists_url":"https://api.github.com/users/ncavig/gists{/gist_id}","starred_url":"https://api.github.com/users/ncavig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ncavig/subscriptions","organizations_url":"https://api.github.com/users/ncavig/orgs","repos_url":"https://api.github.com/users/ncavig/repos","events_url":"https://api.github.com/users/ncavig/events{/privacy}","received_events_url":"https://api.github.com/users/ncavig/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2018-02-15T23:09:41Z","updated_at":"2018-02-16T15:29:06Z","closed_at":"2018-02-16T09:47:32Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 6.2.1\r\n\r\nRunning in a docker image `docker.elastic.co/elasticsearch/elasticsearch:6.2.1`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen having multiple indexed_shape queries in a boolean should list, I get an error with the following\r\n\r\n```\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"array_index_out_of_bounds_exception\",\r\n        \"reason\" : \"1\"\r\n      }\r\n    ],\r\n    \"type\" : \"array_index_out_of_bounds_exception\",\r\n    \"reason\" : \"1\"\r\n  },\r\n  \"status\" : 500\r\n}\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nIndex mappings\r\n\r\n```\r\n{\r\n  \"index\": {\r\n    \"mappings\": {\r\n      \"type\": {\r\n        \"properties\": {\r\n          \"geo_json\": {\r\n            \"properties\": {\r\n              \"coordinates\": {\r\n                \"type\": \"float\"\r\n              },\r\n              \"type\": {\r\n                \"type\": \"text\",\r\n                \"fields\": {\r\n                  \"keyword\": {\r\n                    \"type\": \"keyword\",\r\n                    \"ignore_above\": 256\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"lat\": {\r\n            \"type\": \"float\"\r\n          },\r\n          \"lng\": {\r\n            \"type\": \"float\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nSearch query\r\n\r\n```\r\ncurl -X GET 'http://localhost:9200/other-index/_search?pretty' -H 'Content-Type: application/json' -d '{\r\n  \"from\":0,\r\n  \"size\":1,\r\n  \"query\":{\r\n    \"bool\":{\r\n          \"should\":[\r\n            {\r\n              \"geo_shape\":{\r\n                \"geo_location\":{\r\n                  \"relation\":\"within\",\r\n                  \"indexed_shape\":{\r\n                    \"type\":\"<type>\",\r\n                    \"index\":\"<index>\",\r\n                    \"id\":\"<id>\",\r\n                    \"path\":\"geo_json\"\r\n                  }\r\n                }\r\n              }\r\n            },\r\n            {\r\n              \"geo_shape\":{\r\n                \"geo_location\":{\r\n                  \"relation\":\"within\",\r\n                  \"indexed_shape\":{\r\n                    \"type\":\"<type>\",\r\n                    \"index\":\"<index>\",\r\n                    \"id\":\"<id>\",\r\n                    \"path\":\"geo_json\"\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          ]\r\n\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\nLogs\r\n\r\n```\r\nelasticsearch    | java.lang.ArrayIndexOutOfBoundsException: 1\r\nelasticsearch    | \tat org.elasticsearch.index.query.GeoShapeQueryBuilder$1.onResponse(GeoShapeQueryBuilder.java:408) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.index.query.GeoShapeQueryBuilder$1.onResponse(GeoShapeQueryBuilder.java:386) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:85) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:81) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.single.shard.TransportSingleShardAction$AsyncSingleAction$2.handleResponse(TransportSingleShardAction.java:247) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.single.shard.TransportSingleShardAction$AsyncSingleAction$2.handleResponse(TransportSingleShardAction.java:233) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleResponse(TransportService.java:1091) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processResponse(TransportService.java:1160) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1150) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1139) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:54) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:294) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.action.support.single.shard.TransportSingleShardAction$ShardTransportHandler.messageReceived(TransportSingleShardAction.java:286) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:30) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler$1.doRun(SecurityServerTransportInterceptor.java:258) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.common.util.concurrent.EsExecutors$1.execute(EsExecutors.java:135) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.lambda$messageReceived$0(SecurityServerTransportInterceptor.java:307) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.transport.ServerTransportFilter$NodeProfile.lambda$inbound$2(ServerTransportFilter.java:166) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authz.AuthorizationUtils$AsyncAuthorizer.maybeRun(AuthorizationUtils.java:183) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authz.AuthorizationUtils$AsyncAuthorizer.setRunAsRoles(AuthorizationUtils.java:177) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authz.AuthorizationUtils$AsyncAuthorizer.authorize(AuthorizationUtils.java:165) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.transport.ServerTransportFilter$NodeProfile.lambda$inbound$3(ServerTransportFilter.java:168) ~[?:?]\r\nelasticsearch    | \tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60) ~[elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$authenticateAsync$2(AuthenticationService.java:184) ~[x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$lookForExistingAuthentication$4(AuthenticationService.java:217) ~[x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lookForExistingAuthentication(AuthenticationService.java:228) [x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.authenticateAsync(AuthenticationService.java:182) [x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.access$000(AuthenticationService.java:143) [x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.authc.AuthenticationService.authenticate(AuthenticationService.java:113) [x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.transport.ServerTransportFilter$NodeProfile.inbound(ServerTransportFilter.java:142) [x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:314) [x-pack-security-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:656) [elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:635) [elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.1.jar:6.2.1]\r\nelasticsearch    | \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\nelasticsearch    | \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\nelasticsearch    | \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\n```\r\n\r\nTo make this query work without error, simply remove one of the indexed shape queries.\r\n\r\nLet me know if any more context or information would help. ","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}