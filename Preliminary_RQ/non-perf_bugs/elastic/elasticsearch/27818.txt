{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27818","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27818/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27818/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27818/events","html_url":"https://github.com/elastic/elasticsearch/issues/27818","id":282103651,"node_id":"MDU6SXNzdWUyODIxMDM2NTE=","number":27818,"title":"Master node not discovered in CI","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":106454670,"node_id":"MDU6TGFiZWwxMDY0NTQ2NzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Build","name":":Delivery/Build","color":"0e8a16","default":false,"description":"Build or test infrastructure"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-12-14T13:39:17Z","updated_at":"2020-11-11T21:42:12Z","closed_at":"2017-12-19T07:43:04Z","author_association":"MEMBER","active_lock_reason":null,"body":"_Note: These are three different test cases that fail but it appears to be the same cause, hence I just created one ticket._\r\n\r\nExample build failure: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+periodic/5368/console\r\n\r\nThe [full build log](https://github.com/elastic/elasticsearch/files/1559329/build.log.zip) is attached.\r\n\r\nfailing tests:\r\n\r\n```\r\norg.elasticsearch.indices.state.RareClusterStateIT#testDelayedMappingPropagationOnPrimary\r\norg.elasticsearch.cluster.routing.PrimaryAllocationIT#testDoNotAllowStaleReplicasToBePromotedToPrimary\r\norg.elasticsearch.cluster.MinimumMasterNodesIT#testSimpleMinimumMasterNodes\r\n```\r\n\r\nExample failure message (more of them in the attached log):\r\n\r\n```\r\nERROR   61.2s J2 | MinimumMasterNodesIT.testSimpleMinimumMasterNodes <<< FAILURES!\r\n   > Throwable #1: MasterNotDiscoveredException[null]\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$4.onTimeout(TransportMasterNodeAction.java:230)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:317)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:244)\r\n   > \tat org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:581)\r\n   > \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:566)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n   > \tat java.lang.Thread.run(Thread.java:748)Throwable #2: MasterNotDiscoveredException[null]\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$4.onTimeout(TransportMasterNodeAction.java:230)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:317)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:244)\r\n   > \tat org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:581)\r\n   > \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:566)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nbefore this failure we see in the log:\r\n\r\n```\r\n  1> [2017-12-14T08:01:25,025][WARN ][o.e.d.z.UnicastZenPing   ] [node_t1] [299] failed send ping to {#zen_unicast_127.0.0.1_3#}{QVh9ejEISw-Mkk7JqYIF1g}{127.0.0.1}{127.0.0.1:9623}\r\n  1> java.lang.IllegalStateException: handshake failed, mismatched cluster name [Cluster [SUITE-CHILD_VM=[2]-CLUSTER_SEED=[-3582321890366079432]-HASH=[4DDF2E03F454A3]-cluster]] - {#zen_unicast_127.0.0.1_3#}{QVh9ejEISw-Mkk7JqYIF1g}{127.0.0.1}{127.0.0.1:9623}\r\n```\r\n\r\nReproduction line:\r\n\r\n```\r\nREPRODUCE WITH: gradle :core:integTest \\\r\n  -Dtests.seed=3049C5F03325CE2F \\\r\n  -Dtests.class=org.elasticsearch.cluster.MinimumMasterNodesIT \\\r\n  -Dtests.method=\"testSimpleMinimumMasterNodes\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=es-GT \\\r\n  -Dtests.timezone=America/Eirunepe\r\n\r\nREPRODUCE WITH: gradle :core:integTest \\\r\n  -Dtests.seed=3049C5F03325CE2F \\\r\n  -Dtests.class=org.elasticsearch.cluster.routing.PrimaryAllocationIT \\\r\n  -Dtests.method=\"testDoNotAllowStaleReplicasToBePromotedToPrimary\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-TN \\\r\n  -Dtests.timezone=Australia/Adelaide\r\n\r\nREPRODUCE WITH: gradle :core:integTest \\\r\n  -Dtests.seed=3049C5F03325CE2F \\\r\n  -Dtests.class=org.elasticsearch.indices.state.RareClusterStateIT \\\r\n  -Dtests.method=\"testDelayedMappingPropagationOnPrimary\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=sk-SK \\\r\n  -Dtests.timezone=Asia/Kathmandu\r\n```\r\n\r\nreproduces locally: no (I ran a full build with `gradle :core:integTest -Dtests.seed=3049C5F03325CE2F -Dtests.security.manager=true -Dtests.locale=sk-SK -Dtests.timezone=Asia/Kathmandu`)\r\n\r\nfailure frequency:\r\n\r\n* `RareClusterStateIT#testDelayedMappingPropagationOnPrimary`: 10 times within the last year (out of that 6 times since December 11)\r\n* `PrimaryAllocationIT#testDoNotAllowStaleReplicasToBePromotedToPrimary`: 15 times within the last year (out of that 10 times since December 11)\r\n* `MinimumMasterNodesIT#testSimpleMinimumMasterNodes`: 20 times within the last year (out of that 12 times since December 11)\r\n\r\n\r\n\r\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}