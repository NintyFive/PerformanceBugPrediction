{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21633","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21633/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21633/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21633/events","html_url":"https://github.com/elastic/elasticsearch/issues/21633","id":190118926,"node_id":"MDU6SXNzdWUxOTAxMTg5MjY=","number":21633,"title":"ES 5.0.X synonyms bug with multi-match/cross_fields","user":{"login":"neowu","id":1100909,"node_id":"MDQ6VXNlcjExMDA5MDk=","avatar_url":"https://avatars3.githubusercontent.com/u/1100909?v=4","gravatar_id":"","url":"https://api.github.com/users/neowu","html_url":"https://github.com/neowu","followers_url":"https://api.github.com/users/neowu/followers","following_url":"https://api.github.com/users/neowu/following{/other_user}","gists_url":"https://api.github.com/users/neowu/gists{/gist_id}","starred_url":"https://api.github.com/users/neowu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neowu/subscriptions","organizations_url":"https://api.github.com/users/neowu/orgs","repos_url":"https://api.github.com/users/neowu/repos","events_url":"https://api.github.com/users/neowu/events{/privacy}","received_events_url":"https://api.github.com/users/neowu/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-11-17T17:58:37Z","updated_at":"2016-11-28T13:14:01Z","closed_at":"2016-11-28T13:14:01Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0.0/5.0.1   \r\nHi, I updated our ES from 2.4 to 5.0.X, and encountered this synonyms bug.\r\nthe solar format like following doesn't work anymore with dis_max/multi-match/cross_fields\r\n              \"synonym\": {\r\n                    \"type\": \"synonym\",\r\n                    \"synonyms\": [\r\n                        \"1st,first\",\r\n                        \"2nd,second\"\r\n                    ]\r\n                },\r\nfor more info, \"=>\" works, but not exactly what we want\r\n              \"synonym\": {\r\n                    \"type\": \"synonym\",\r\n                    \"synonyms\": [\r\n                        \"1st=>first\",\r\n                        \"2nd=>second\"\r\n                    ]\r\n                },\r\n\r\n**Steps to reproduce**:\r\nI am able to simplify our case and reproduce with clean ES 5.0.1 (by docker/elasticsearch image)\r\n\r\n1) create index and insert 2 sample records\r\n```\r\ncurl -XPUT localhost:9200/test -d '\r\n{\r\n    \"settings\": {\r\n        \"analysis\": {\r\n            \"filter\": {\r\n                \"synonym\": {\r\n                    \"type\": \"synonym\",\r\n                    \"synonyms\": [\r\n                        \"1st,first\",\r\n                        \"2nd,second\"\r\n                    ]\r\n                },\r\n                \"english_stemmer\": {\r\n                    \"type\": \"stemmer\",\r\n                    \"name\": \"english\"\r\n                }\r\n            },\r\n            \"analyzer\": {\r\n                \"english\": {\r\n                    \"tokenizer\": \"standard\",\r\n                    \"filter\": [\r\n                        \"lowercase\",\r\n                        \"stop\",\r\n                        \"english_stemmer\"\r\n                    ]\r\n                },\r\n                \"english_search\": {\r\n                    \"tokenizer\": \"standard\",\r\n                    \"filter\": [\r\n                        \"lowercase\",\r\n                        \"synonym\",\r\n                        \"stop\",\r\n                        \"english_stemmer\"\r\n                    ]\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"mappings\": {\r\n        \"product\": {\r\n            \"_all\": {\r\n                \"enabled\": false\r\n            },\r\n            \"properties\": {\r\n                \"name\": {\r\n                    \"type\": \"text\",\r\n                    \"analyzer\": \"english\",\r\n                    \"search_analyzer\": \"english_search\"\r\n                },\r\n                \"desc\": {\r\n                    \"type\": \"text\",\r\n                    \"analyzer\": \"english\",\r\n                    \"search_analyzer\": \"english_search\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n'\r\n\r\ncurl -XPUT localhost:9200/test/product/1 -d ' { \"name\" : \"first shoe\", \"desc\": \"desc\" } '\r\ncurl -XPUT localhost:9200/test/product/2 -d ' { \"name\" : \"1st shoes\", \"desc\": \"desc\"  } '\r\n```\r\n\r\n2) search with single term works as expected\r\n```\r\ncurl 'localhost:9200/test/_search?q=name:1st'\r\n```\r\n\r\n3) multimatch doesn't return result, this is to search '1st' in all fields as cross_fields.\r\n```\r\ncurl localhost:9200/test/_search -d '\r\n{ \"query\" : {\r\n  \"bool\" : {\r\n    \"must\" : [\r\n      { \"dis_max\" : {\r\n          \"queries\" : [\r\n            {\r\n              \"multi_match\" : {\r\n                \"query\" : \"1st\",\r\n                \"fields\" : [ \"name^1.0\", \"desc^1.0\"],\r\n                \"type\": \"cross_fields\",\r\n                \"operator\" : \"OR\"            \r\n              }\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n} }\r\n'\r\n```\r\n\r\n4) if I replace synonym in setting to be \"1st=>first\", and recreate whole index, then the dis_max/multi_match works.\r\n\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}