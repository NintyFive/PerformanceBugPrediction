[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/211848238","html_url":"https://github.com/elastic/elasticsearch/issues/17845#issuecomment-211848238","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845","id":211848238,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTg0ODIzOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-04-19T10:32:16Z","updated_at":"2016-04-19T10:32:16Z","author_association":"CONTRIBUTOR","body":"From the error message, it looks like your `field` is missing some times, hence the NPE.  I'm unable to replicate this.  I tried running these two requests in parallel:\n\n```\nPOST /t/t/1/_update?pretty=1&retry_on_conflict=5\n{\n   \"script\" : \"if (ctx._source.field.names== null) {ctx._source.field.names=newItems} else {ctx._source.field.names<< newItems}; ctx._source.field.names= ctx._source.field.names.flatten().unique();\",\n   \"params\" : {\n      \"newItems\" : [\n         \"foo\",\n         \"bar\"\n      ]\n   }\n}\n```\n\nand\n\n```\nPOST /t/t/1/_update?pretty=1&retry_on_conflict=5\n{\n  \"retry_on_conflict\": 5,\n  \"doc\": {\n    \"field\": {\n      \"foo\": {\n        \"name\": \"foo is awesome\"\n      }\n    }\n  }\n}\n```\n\nand I reset the doc every now and again with \n\n```\nPOST t/t/1\n{ \n   \"field\": {\n      \"names\": [\"A\",\"B\",\"C\"],\n      \"A\": { \"name\": \"A is awesome\" },\n      \"B\": { \"name\": \"B is awesome\" },\n      \"C\": { \"name\": \"C is awesome\" }\n   },\n   \"email\": \"x@gmail.com\"\n}\n```\n\nNo joy.  I think you have some code somewhere which is updating this doc with a source that doesn't include `field`.  A runnable recreation would be appreciated (and in something other than Scala :) )\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/212450902","html_url":"https://github.com/elastic/elasticsearch/issues/17845#issuecomment-212450902","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845","id":212450902,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMjQ1MDkwMg==","user":{"login":"tpraizler","id":1968838,"node_id":"MDQ6VXNlcjE5Njg4Mzg=","avatar_url":"https://avatars2.githubusercontent.com/u/1968838?v=4","gravatar_id":"","url":"https://api.github.com/users/tpraizler","html_url":"https://github.com/tpraizler","followers_url":"https://api.github.com/users/tpraizler/followers","following_url":"https://api.github.com/users/tpraizler/following{/other_user}","gists_url":"https://api.github.com/users/tpraizler/gists{/gist_id}","starred_url":"https://api.github.com/users/tpraizler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tpraizler/subscriptions","organizations_url":"https://api.github.com/users/tpraizler/orgs","repos_url":"https://api.github.com/users/tpraizler/repos","events_url":"https://api.github.com/users/tpraizler/events{/privacy}","received_events_url":"https://api.github.com/users/tpraizler/received_events","type":"User","site_admin":false},"created_at":"2016-04-20T14:37:53Z","updated_at":"2016-04-20T14:37:53Z","author_association":"NONE","body":"Thanks @clintongormley for looking into this! \nDid you run it on one documents? I run around 80 simultaneously requests to ES, 2 for every one of the 40 documents. This behavior is pretty random, it fails almost every execution of those 80 futures, but on different document every time.\nDoes this information help in some way? Are you able to create such scenario?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/212460774","html_url":"https://github.com/elastic/elasticsearch/issues/17845#issuecomment-212460774","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845","id":212460774,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMjQ2MDc3NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-04-20T14:55:13Z","updated_at":"2016-04-20T14:55:13Z","author_association":"CONTRIBUTOR","body":"@tpraizler your original description lacks some steps.  could you provide an exact recreation (something easy to run without installing lots of libraries) to try it out?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/221230838","html_url":"https://github.com/elastic/elasticsearch/issues/17845#issuecomment-221230838","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845","id":221230838,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMTIzMDgzOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-24T10:36:17Z","updated_at":"2016-05-24T10:36:17Z","author_association":"CONTRIBUTOR","body":"No further feedback.  Closing\n","performed_via_github_app":null}]