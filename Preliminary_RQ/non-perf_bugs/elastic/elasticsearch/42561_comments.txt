[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496019882","html_url":"https://github.com/elastic/elasticsearch/issues/42561#issuecomment-496019882","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42561","id":496019882,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NjAxOTg4Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-05-26T18:07:07Z","updated_at":"2019-05-26T18:07:07Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496021815","html_url":"https://github.com/elastic/elasticsearch/issues/42561#issuecomment-496021815","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42561","id":496021815,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NjAyMTgxNQ==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-05-26T18:36:45Z","updated_at":"2019-05-26T18:36:45Z","author_association":"CONTRIBUTOR","body":"To reproduce we need 3 nodes and do a rolling upgrade. We will use docker-compose:\r\n\r\n1. Unzip [mixed_cluster.zip](https://github.com/elastic/elasticsearch/files/3220961/mixed_cluster.zip) and navigate to the unzipped dir\r\n2. `docker-compose up -d` \r\n3. (another shell) `docker-compose logs -f` \r\n4. Open kibana dev tools: http://localhost:5601/app/kibana#/dev_tools/console?_g=()\r\n5. `GET _nodes?filter_path=nodes.*.version` - ensure that all 3 nodes are 6.5.4\r\n6. Create an index without replicas\r\n```\r\nPUT foo\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 0\r\n  }\r\n}\r\n```\r\n7. Move primary to node_one \r\n```\r\nPOST /_cluster/reroute\r\n{\r\n  \"commands\": [\r\n    {\r\n      \"move\": {\r\n        \"index\": \"foo\",\r\n        \"shard\": 0,\r\n        \"from_node\": \"node_three\",\r\n        \"to_node\": \"node_one\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n8. Add replicas\r\n```\r\nPUT foo/_settings\r\n{\"index\":{\"number_of_replicas\":2}}\r\n```\r\n9. Validate primary in on node_one, with 2 replicas `GET _cat/shards?v` should look like:\r\n```\r\nindex     shard prirep state   docs  store ip           node\r\nfoo       0     r      STARTED    0   230b 192.168.32.4 node_two\r\nfoo       0     p      STARTED    0   230b 192.168.32.2 node_one\r\nfoo       0     r      STARTED    0   230b 192.168.32.3 node_three\r\n```\r\n10. add a document\r\n```\r\nPUT foo/_doc/1\r\n{\r\n  \"one\": 1\r\n}\r\n```\r\n11. Upgrade node_one to 6.7\r\nin docker-compose.yml (for elasticsearch_one):\r\n```\r\n    image: elasticsearch:6.7.1\r\n   # image: elasticsearch:6.5.4\r\n```\r\nin elasticsearch_one.yml\r\n```\r\n#transport.tcp.port: 9300 # 6.5\r\ntransport.port: 9300 #6.7\r\n```\r\ncommand line:\r\n```\r\ndocker-compose up -d --build elasticsearch_one\r\n```\r\n12. Wait till all 3 are back up and node_one is 6.7, and all shards are started\r\n```\r\nGET _nodes?filter_path=nodes.*.version\r\nGET _cat/shards?v\r\n```\r\ne.g.\r\n```\r\n{\r\n  \"nodes\" : {\r\n    \"lofd6lhfSC6xRyVK-U68Rg\" : {\r\n      \"version\" : \"6.5.4\"\r\n    },\r\n    \"cWSBkCErQFm0lJPM6nlYLw\" : {\r\n      \"version\" : \"6.5.4\"\r\n    },\r\n    \"d-EFNPncQkuDai2VCewe2Q\" : {\r\n      \"version\" : \"6.7.1\"\r\n    }\r\n  }\r\n}\r\n```\r\nand\r\n```\r\nfoo       0     p      STARTED    1  2.7kb 192.168.32.4 node_two\r\nfoo       0     r      STARTED    1  2.7kb 192.168.32.2 node_one\r\nfoo       0     r      STARTED    1  2.7kb 192.168.32.3 node_three\r\n```\r\n13. Now we are going to upgrade the primary.  In this case node_two (which makes repro easier since kibana is attached node_three...if you have to upgrade node_three, you will need to update the kibana version too, or re-point it to the old one). There is a 50% chance when we upgrade node_two that node_one will be promoted to primary, if node_one (6.7) is promoted to primary, we can reproduce the issue. If node_three (6.5) is promoted to primary it won't reproduce. ðŸŽ² \r\n in docker-compose.yml (for elasticsearch_two):\r\n```\r\n    image: elasticsearch:6.7.1\r\n   # image: elasticsearch:6.5.4\r\n```\r\nin elasticsearch_two.yml\r\n```\r\n#transport.tcp.port: 9300 # 6.5\r\ntransport.port: 9300 #6.7\r\n```\r\ncommand line:\r\n```\r\ndocker-compose up -d --build elasticsearch_two\r\n```\r\n14. Wait again for everything to be stable\r\n```\r\nGET _nodes?filter_path=nodes.*.version\r\nGET _cat/shards?v\r\n```\r\ne.g.\r\n```\r\n{\r\n  \"nodes\" : {\r\n    \"5InXR978Try1TR3lWnnlSA\" : {\r\n      \"version\" : \"6.7.1\"\r\n    },\r\n    \"lofd6lhfSC6xRyVK-U68Rg\" : {\r\n      \"version\" : \"6.5.4\"\r\n    },\r\n    \"d-EFNPncQkuDai2VCewe2Q\" : {\r\n      \"version\" : \"6.7.1\"\r\n    }\r\n  }\r\n}\r\n```\r\nand\r\n```\r\nindex     shard prirep state   docs store ip           node\r\nfoo       0     r      STARTED    1 2.8kb 192.168.32.4 node_two\r\nfoo       0     p      STARTED    1 2.8kb 192.168.32.2 node_one\r\nfoo       0     r      STARTED    1 2.8kb 192.168.32.3 node_three\r\n```\r\n15. node_one and node_two are 6.7 and node_three is 6.5.  Now we have the scenario where a new primary shard (node_one 6.7) will attempt to replicate to an old shard (node_three 6.5).\r\n16. Lets partially update the document...\r\n```\r\nPOST foo/_doc/1/_update\r\n{\r\n  \"doc\": {\r\n    \"two\": 2\r\n  }\r\n}\r\n```\r\n17. bam\r\n```\r\n{\r\n  \"_index\" : \"foo\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"1\",\r\n  \"_version\" : 2,\r\n  \"result\" : \"updated\",\r\n  \"_shards\" : {\r\n    \"total\" : 3,\r\n    \"successful\" : 2,\r\n    \"failed\" : 1,\r\n    \"failures\" : [\r\n      {\r\n        \"_index\" : \"foo\",\r\n        \"_shard\" : 0,\r\n        \"_node\" : \"lofd6lhfSC6xRyVK-U68Rg\",\r\n        \"reason\" : {\r\n          \"type\" : \"illegal_state_exception\",\r\n          \"reason\" : \"sequence number based compare and write is not supported until all nodes are on version 7.0 or higher. Stream version [6.5.4]\"\r\n        },\r\n        \"status\" : \"INTERNAL_SERVER_ERROR\",\r\n        \"primary\" : false\r\n      }\r\n    ]\r\n  },\r\n  \"_seq_no\" : 1,\r\n  \"_primary_term\" : 3\r\n}\r\n```\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496053912","html_url":"https://github.com/elastic/elasticsearch/issues/42561#issuecomment-496053912","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42561","id":496053912,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NjA1MzkxMg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-05-27T02:03:33Z","updated_at":"2019-05-27T02:03:33Z","author_association":"MEMBER","body":"Thanks @jakelandis. I can reproduce this issue with a rolling upgrade test (in https://github.com/dnhatn/elasticsearch/commit/e25125f577bcfaa78f57e6de4b005b74220f427f).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496265387","html_url":"https://github.com/elastic/elasticsearch/issues/42561#issuecomment-496265387","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42561","id":496265387,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NjI2NTM4Nw==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-05-27T16:52:21Z","updated_at":"2019-05-27T16:52:21Z","author_association":"MEMBER","body":"I opened https://github.com/elastic/elasticsearch/pull/42596.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496322972","html_url":"https://github.com/elastic/elasticsearch/issues/42561#issuecomment-496322972","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42561","id":496322972,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NjMyMjk3Mg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-05-27T23:59:22Z","updated_at":"2019-05-27T23:59:22Z","author_association":"MEMBER","body":"Fixed in #42561.","performed_via_github_app":null}]