{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32528","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32528/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32528/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32528/events","html_url":"https://github.com/elastic/elasticsearch/issues/32528","id":346410412,"node_id":"MDU6SXNzdWUzNDY0MTA0MTI=","number":32528,"title":"cluster stats \"fs\" result ignore same nodes data.","user":{"login":"hgword","id":1271836,"node_id":"MDQ6VXNlcjEyNzE4MzY=","avatar_url":"https://avatars0.githubusercontent.com/u/1271836?v=4","gravatar_id":"","url":"https://api.github.com/users/hgword","html_url":"https://github.com/hgword","followers_url":"https://api.github.com/users/hgword/followers","following_url":"https://api.github.com/users/hgword/following{/other_user}","gists_url":"https://api.github.com/users/hgword/gists{/gist_id}","starred_url":"https://api.github.com/users/hgword/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hgword/subscriptions","organizations_url":"https://api.github.com/users/hgword/orgs","repos_url":"https://api.github.com/users/hgword/repos","events_url":"https://api.github.com/users/hgword/events{/privacy}","received_events_url":"https://api.github.com/users/hgword/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-08-01T01:01:18Z","updated_at":"2018-08-01T01:19:27Z","closed_at":"2018-08-01T01:19:27Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): Elasticsearch 5.6.4 ~\r\n\r\n**Plugins installed**: [] basic\r\n\r\n**JVM version** (`java -version`): java version \"1.8.0_161\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux 3.10.0-693.17.1.el7.x86_64 #1 SMP  x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nour production env using big memory and many disk.\r\n\r\nso elasicsearch run two node in server.(because we using JVM for 30G.)\r\nand cluster stats ignore that run same node elasicsearch.\r\n\r\nbecause this logic\r\n```java\r\n// org.elasticsearch.action.admin.cluster.stats.ClusterStatsNodes#ClusterStatsNodes\r\n\r\n    ClusterStatsNodes(List<ClusterStatsNodeResponse> nodeResponses) {\r\n        this.versions = new HashSet<>();\r\n        this.fs = new FsInfo.Path();\r\n        this.plugins = new HashSet<>();\r\n\r\n        Set<InetAddress> seenAddresses = new HashSet<>(nodeResponses.size());\r\n        List<NodeInfo> nodeInfos = new ArrayList<>(nodeResponses.size());\r\n        List<NodeStats> nodeStats = new ArrayList<>(nodeResponses.size());\r\n        for (ClusterStatsNodeResponse nodeResponse : nodeResponses) {\r\n            nodeInfos.add(nodeResponse.nodeInfo());\r\n            nodeStats.add(nodeResponse.nodeStats());\r\n            this.versions.add(nodeResponse.nodeInfo().getVersion());\r\n            this.plugins.addAll(nodeResponse.nodeInfo().getPlugins().getPluginInfos());\r\n\r\n            // now do the stats that should be deduped by hardware (implemented by ip deduping)\r\n            TransportAddress publishAddress = nodeResponse.nodeInfo().getTransport().address().publishAddress();\r\n            //publishAddress --> ipaddress:port   <-- I think elasticsearch should using this variable.\r\n            InetAddress inetAddress = null;\r\n            if (publishAddress.uniqueAddressTypeId() == 1) {  //--> if it's using \"InetSocketTransportAddress\"\r\n                inetAddress = ((InetSocketTransportAddress) publishAddress).address().getAddress();\r\n                // only check ip address \r\n            }\r\n            if (!seenAddresses.add(inetAddress)) {  <-- this logic ignore that run elasticsearch same node \r\n                continue;\r\n            }\r\n            if (nodeResponse.nodeStats().getFs() != null) {\r\n                this.fs.add(nodeResponse.nodeStats().getFs().getTotal());\r\n            }\r\n        }\r\n        this.counts = new Counts(nodeInfos);\r\n        this.os = new OsStats(nodeInfos, nodeStats);\r\n        this.process = new ProcessStats(nodeStats);\r\n        this.jvm = new JvmStats(nodeInfos, nodeStats);\r\n        this.networkTypes = new NetworkTypes(nodeInfos);\r\n    }\r\n\r\n```\r\n\r\nit should be change like this\r\n\r\n```\r\n...\r\nSet<TransportAddress> seenAddresses = new HashSet<>(nodeResponses.size());\r\n...\r\n\r\nif (!seenAddresses.add(publishAddress)) {\r\n...\r\n```\r\n\r\n\r\n**Steps to reproduce**:\r\n 1. prepare machine that have mutiple mount point\r\n* my test env\r\n    ```bash\r\n    Filesystem      Size  Used Avail Use% Mounted on\r\n    ...\r\n    /dev/xvda3       87G  5.6G   81G   7% /home\r\n    /dev/xvdb        99G   61M   94G   1% /home/data\r\n    ...\r\n    ```\r\n 2. run elasticsearch 2 nodes and it's data path are different mount point\r\n* node-1\r\n\r\n    ```yaml\r\n    cluster.name: es-test\r\n    node.name: node-1\r\n    path.data: /home1/downloads/elasticsearch-6.3.2/data\r\n    ...\r\n    ```\r\n* node-2\r\n    ```yaml\r\n    cluster.name: es-test\r\n    node.name: node-2\r\n    path.data: /home/data\r\n    ...\r\n    ```\r\n 3. run elasticsearch and check node data\r\n* GET _nodes/stats?human=true\r\n    * <img width=\"273\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1271836/43495192-97fc0160-9571-11e8-9969-84659c8acab9.png\">\r\n 4. run elasticsearch cluster stats api\r\n* GET _cluster/stats?human=true\r\n    *  <img width=\"230\" alt=\"image\" src=\"https://user-images.githubusercontent.com/1271836/43495226-c5819442-9571-11e8-8b5b-35746711207f.png\">\r\n     * api result only have one node data\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}