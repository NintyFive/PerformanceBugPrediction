{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16381","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16381/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16381/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16381/events","html_url":"https://github.com/elastic/elasticsearch/issues/16381","id":130773655,"node_id":"MDU6SXNzdWUxMzA3NzM2NTU=","number":16381,"title":"Allow aggregations on parent document fields from a nested aggregation without changing scope using reverse nested","user":{"login":"roytmana","id":2524911,"node_id":"MDQ6VXNlcjI1MjQ5MTE=","avatar_url":"https://avatars0.githubusercontent.com/u/2524911?v=4","gravatar_id":"","url":"https://api.github.com/users/roytmana","html_url":"https://github.com/roytmana","followers_url":"https://api.github.com/users/roytmana/followers","following_url":"https://api.github.com/users/roytmana/following{/other_user}","gists_url":"https://api.github.com/users/roytmana/gists{/gist_id}","starred_url":"https://api.github.com/users/roytmana/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/roytmana/subscriptions","organizations_url":"https://api.github.com/users/roytmana/orgs","repos_url":"https://api.github.com/users/roytmana/repos","events_url":"https://api.github.com/users/roytmana/events{/privacy}","received_events_url":"https://api.github.com/users/roytmana/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-02-02T18:31:52Z","updated_at":"2016-02-13T21:51:10Z","closed_at":"2016-02-13T21:51:10Z","author_association":"NONE","active_lock_reason":null,"body":"I think this could be a very practical solutions for whole set of issues where aggregation needs to be done on nested documents but be able to group on its parent document properties. It i snot the same as using reverse nested because reverse nested changes document scope to groupp and then it will needs to be changed back to nested again introducing double-counting.\nAlso from ease of use it would be a significant step forward comparing to using reverse nested just to be able to access parent document properties (even if were equivalent)\n\nHere is an example I used in another issue:\n\nImagine having Teams that handle Requests of certain Priority. Each request may have multiple teams assigned to it and each team request assignment has number of hours allocated for this team on this request\n\n``` javascript\nrequest:{\n  priority:1,\n  teams:[\n    {name:'team1', hours:10},\n    {name:'team2', hours:20},\n  ]\n}\n```\n\nI need a report that gives me number of hours by team by priority. Doing nested aggregation on **teams.name** and then reverse nested to group on **priority** and then nested to sum **teams.hours** double-counts hours because second nesting on teams knows nothing about  upstream nesting as it is executed in context of request and as result it will lump hours for each team on request under the top level team aggregation \n\nIf i could access \"../priority\" from teams nested document context I would not have to use reverse nested and lose my aggregation context and everything would have worked like a charm\n\nplease see also #16380 \n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}