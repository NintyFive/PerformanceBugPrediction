{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9263","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9263/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9263/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9263/events","html_url":"https://github.com/elastic/elasticsearch/issues/9263","id":54109397,"node_id":"MDU6SXNzdWU1NDEwOTM5Nw==","number":9263,"title":"Incorrect reverse nested agg counts when using multi level nested filters","user":{"login":"spotta","id":7988993,"node_id":"MDQ6VXNlcjc5ODg5OTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7988993?v=4","gravatar_id":"","url":"https://api.github.com/users/spotta","html_url":"https://github.com/spotta","followers_url":"https://api.github.com/users/spotta/followers","following_url":"https://api.github.com/users/spotta/following{/other_user}","gists_url":"https://api.github.com/users/spotta/gists{/gist_id}","starred_url":"https://api.github.com/users/spotta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spotta/subscriptions","organizations_url":"https://api.github.com/users/spotta/orgs","repos_url":"https://api.github.com/users/spotta/repos","events_url":"https://api.github.com/users/spotta/events{/privacy}","received_events_url":"https://api.github.com/users/spotta/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2015-01-12T21:30:09Z","updated_at":"2015-01-26T17:37:35Z","closed_at":"2015-01-26T17:37:35Z","author_association":"NONE","active_lock_reason":null,"body":" There are couple of issues, one is regression of previously fixed issue #6994. This is working fine in 1.3.4 and 1.4.0, failing from 1.4.1.\n\n Also there is another issue, reverse nested agg counts are incorrect when using more than one level of nested filter when fetching the aggs, this is happening even in 1.3.4.\n\n Below details to repro the issue. Not sure if these should be separate issues, entering as one as they seem to be related.\n\n```\nDELETE /_all\n\n\nPOST /test\n{\n  \"mappings\": {\n    \"foo\": {\n      \"dynamic\": \"strict\",\n      \"properties\": {\n        \"id\": {\n          \"type\": \"long\"\n        },\n        \"baz\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"baz_cde\": {\n              \"type\": \"string\"\n            }\n          }\n        },\n        \"bar\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"bar_typ\": {\n              \"type\": \"string\"\n            },\n            \"color\": {\n              \"type\": \"nested\",\n              \"properties\": {\n                \"name\": {\n                  \"type\": \"string\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nPUT /test/foo/1\n{\n    \"id\": 1,\n    \"bar\": [\n        {\n            \"bar_typ\": \"bar1\",\n            \"color\": [\n                {\n                    \"name\": \"red\"\n                },\n                {\n                    \"name\": \"green\"\n                },\n                {\n                    \"name\": \"yellow\"\n                }\n            ]\n        },\n        {\n            \"bar_typ\": \"bar1\",\n            \"color\": [\n                {\n                    \"name\": \"red\"\n                },\n                {\n                    \"name\": \"blue\"\n                },\n                {\n\n                    \"name\": \"white\"\n                }\n            ]\n        },\n        {\n            \"bar_typ\": \"bar1\",\n            \"color\": [\n                {\n                    \"name\": \"black\"\n                },\n                {\n                    \"name\": \"blue\"\n                }\n            ]\n        },\n        {\n            \"bar_typ\": \"bar2\",\n            \"color\": [\n                {\n                    \"name\": \"orange\"\n                }\n            ]\n        },\n        {\n            \"bar_typ\": \"bar2\",\n            \"color\": [\n                {\n                    \"name\": \"pink\"\n                }\n            ]\n        }\n    ],\n    \"baz\": [\n        {\n            \"baz_cde\": \"abc\"\n        },\n        {\n            \"baz_cde\": \"klm\"\n        },\n        {\n            \"baz_cde\": \"xyz\"\n        }\n    ]\n}\n```\n\nQuery to find bar counts, grouping by baz_cde, and applying a bar filter \n\n```\nPOST /test/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"nested_0\": {\n      \"nested\": {\n        \"path\": \"baz\"\n      },\n      \"aggs\": {\n        \"group_by_baz\": {\n          \"terms\": {\n            \"field\": \"baz.baz_cde\"\n          },\n          \"aggs\": {\n            \"to_root\": {\n              \"reverse_nested\": {},\n              \"aggs\": {\n                \"nested_1\": {\n                  \"nested\": {\n                    \"path\": \"bar\"\n                  },\n                  \"aggs\": {\n                    \"filter_by_bar\": {\n                      \"filter\": {\n                        \"term\": {\n                          \"bar.bar_typ\": \"bar1\"\n                        }\n                      },\n                      \"aggs\": {\n                        \"bar_count\": {\n                          \"value_count\": {\n                            \"field\": \"bar_typ\"\n                          }\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThis  query should return bar_count as 3 for all baz_cde fields, and is working as expected in 1.3.4 and 1.4.0, but failing from 1.4.1 onwards. Tested in 1.4.2 also.\n\nQuery to find bar counts, grouping by baz_cde, and applying a bar filter as well as bar.color filter\n\n```\nPOST /test/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"nested_0\": {\n      \"nested\": {\n        \"path\": \"baz\"\n      },\n      \"aggs\": {\n        \"group_by_baz\": {\n          \"terms\": {\n            \"field\": \"baz.baz_cde\"\n          },\n          \"aggs\": {\n            \"to_root\": {\n              \"reverse_nested\": {},\n              \"aggs\": {\n                \"nested_1\": {\n                  \"nested\": {\n                    \"path\": \"bar\"\n                  },\n                  \"aggs\": {\n                    \"filter_by_bar\": {\n                      \"filter\": {\n                        \"term\": {\n                          \"bar.bar_typ\": \"bar1\"\n                        }\n                      },\n                      \"aggs\": {\n                        \"nested_2\": {\n                          \"nested\": {\n                            \"path\": \"bar.color\"\n                          },\n                          \"aggs\": {\n                            \"filter_bar_color\": {\n                              \"filter\": {\n                                \"term\": {\n                                  \"bar.color.name\": \"red\"\n                                }\n                              },\n                              \"aggs\": {\n                                \"reverse_to_bar\": {\n                                  \"reverse_nested\": {\n                                    \"path\": \"bar\"\n                                  },\n                                  \"aggs\": {\n                                    \"bar_count\": {\n                                      \"value_count\": {\n                                        \"field\": \"bar_typ\"\n                                      }\n                                    }\n                                  }\n                                }\n                              }\n                            }\n                          }\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThis query should return bar_count as 2 for all baz_cde fields, but only one of them \"xyz\" is getting the correct count 2 but for the others value 1 is returned. This is happening in older versions too.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}