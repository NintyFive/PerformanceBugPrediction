{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17519","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17519/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17519/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17519/events","html_url":"https://github.com/elastic/elasticsearch/issues/17519","id":145776962,"node_id":"MDU6SXNzdWUxNDU3NzY5NjI=","number":17519,"title":"Disk Space full + unassigned nodes after close/open index","user":{"login":"joshreback","id":5649380,"node_id":"MDQ6VXNlcjU2NDkzODA=","avatar_url":"https://avatars1.githubusercontent.com/u/5649380?v=4","gravatar_id":"","url":"https://api.github.com/users/joshreback","html_url":"https://github.com/joshreback","followers_url":"https://api.github.com/users/joshreback/followers","following_url":"https://api.github.com/users/joshreback/following{/other_user}","gists_url":"https://api.github.com/users/joshreback/gists{/gist_id}","starred_url":"https://api.github.com/users/joshreback/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshreback/subscriptions","organizations_url":"https://api.github.com/users/joshreback/orgs","repos_url":"https://api.github.com/users/joshreback/repos","events_url":"https://api.github.com/users/joshreback/events{/privacy}","received_events_url":"https://api.github.com/users/joshreback/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-04-04T19:11:20Z","updated_at":"2016-04-07T09:56:02Z","closed_at":"2016-04-06T10:28:37Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: \n1.6.0\n\n**JVM version**:\n1.8.0_45-internal\n\n**Description of the problem including expected versus actual behavior**:\nI recently closed an index to make some changes to the available analyzers. After opening the index, I quickly started seeing disk space on all of our nodes fill up. My guess is that, as part of the failed recovery, Elasticsearch may have created another replica, since each shard has a replica which is not assigned to any node in the cluster (there are currently 3 shards and 2 replicas). I will paste relevant logs and configurations below. \n\n**Provide logs (if relevant)**:\nHere are logs from the master node on the day that the index was closed: \n\n```\n[2016-03-18 01:54:46,161][INFO ][cluster.metadata] [instance name] closing indices [[prod]]\n[2016-03-18 01:54:46,161][INFO ][cluster.metadata] [instance name] opening indices [[prod]]\n[2016-03-18 01:54:48,493][WARN ][cluster.routing.allocation.decider] [instance name] After allocating, node [nodename] would have less than the required 0b free bytes threshold (-28916726190 bytes free), preventing allocation\n[2016-03-18 01:54:48,494][WARN ][cluster.routing.allocation.decider] [instance name] After allocating, node [nodename] would have less than the required 0b free bytes threshold  (-29217364398 bytes free), preventing allocation\n```\n\n... one of these lines for each of the ES nodes ...\n\nThen, there is one of these exceptions for each node:\n\n```\n[2016-03-18 01:54:49,500][DEBUG][action.search.type] [instance name] All shards failed for phase: [query]\norg.elasticsearch.transport.RemoteTransportException: instance name]][indices:data/read/search[phase/query]]\nCaused by: org.elasticsearch.index.shard.IllegalIndexShardStateException: [prod][0] CurrentState[RECOVERING] operations only allowed when started/relocated\n    at org.elasticsearch.index.shard.IndexShard.readAllowed(IndexShard.java:1000)\n    at org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:793)\n    at org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:789)\n    at org.elasticsearch.search.SearchService.createContext(SearchService.java:552)\n    at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:532)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:294)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:776)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:767)\n    at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.doRun(MessageChannelHandler.java:279)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n```\n\nThen:\n\n```\n[2016-03-18 01:56:39,891][INFO ][cluster.metadata] [instance name] [prod] create_mapping [mapping name]\n.\n.\n.\n[2016-03-18 02:05:18,993][WARN ][cluster.action.shard] [instance name] [prod][1] received shard failed for [prod][1], node[node name], [R], s[INITIALIZING], indexUUID [index id], reason [shard failure [failed recovery][RecoveryFailedException[[prod][1]: Recovery failed from [instance name]{master=true} into [instance name]{master=false}]; nested: RemoteTransportException[[instance name][internal:index/shard/recovery/start_recovery]]; nested: RecoveryEngineException[[prod][1] Phase[1] Execution failed]; nested: RecoverFilesRecoveryException[[prod][1] Failed to transfer [0] files with total size of [0b]]; nested: IllegalStateException[try to recover [prod][1] from primary shard with sync id but number of docs differ: 217250828 (instance name, primary) vs 217250830(instance name)]; ]]\n```\n\nAnd then a bunch of low-disk/high-disk watermark errors on each of the nodes. These errors have continued happening since the time the open/close commands were run, and as such they are preventing new data from being indexed.\n\nWhen I run /cat/_shards/prod, I see:\n\n```\nindex shard prirep state             docs  store ip          node                                    \nprod  0     p      STARTED      218452373 73.5gb \nprod  0     r      STARTED      218452373 73.5gb \nprod  0     r      UNASSIGNED                                                                        \nprod  1     p      STARTED      217445482 73.1gb \nprod  1     r      STARTED      217445482 73.1gb \nprod  1     r      UNASSIGNED                                                                        \nprod  2     r      INITIALIZING                  \nprod  2     r      INITIALIZING                 \nprod  2     p      STARTED      218665090 73.2gb\n```\n\nand note that one of the replica shards for shard 2 oscillates between an INITIALIZING and UNASSIGNED phase.\n\nIs anyone able to consult on the best way to resolve these issues? My best guess is to scale the # of replicas down to 0, let Elasticsearch clean up the orphaned shards, and then scale back up to 1. But, I'm not really confident enough in my knowledge of ES to move forward quite yet. \n\nI'm also curious if anyone can provide some more info on why opening/closing an index leads to spikes in disk usage. The docs mention that closing an index can result in such a situation, but they don't give much other background.\n\nHappy to provide any other info if helpful. Thanks a bunch in advance!\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}