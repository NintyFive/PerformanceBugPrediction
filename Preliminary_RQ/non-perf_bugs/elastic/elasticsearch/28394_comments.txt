[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/360921838","html_url":"https://github.com/elastic/elasticsearch/issues/28394#issuecomment-360921838","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28394","id":360921838,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDkyMTgzOA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-01-26T22:27:08Z","updated_at":"2018-01-26T22:27:08Z","author_association":"MEMBER","body":"The example in the forum is not correctly formatted but the aggregation that fails with an NPE starts with:\r\n\r\n````\r\n\"attributes\":{\r\n   \"global\":{\r\n````\r\n\r\nThe `breadth_first` mode of the `terms` aggregation doesn't handle the `global` context when scores are needed by a sub aggregation. This is the case here because of the `top_hits` aggregation that by default uses the `_score` as the `sort` criteria. This is resolved in 6x by https://github.com/elastic/elasticsearch/pull/27942 but a simple fix for 5x is to use a different sort on the `top_hits` aggregation:\r\n\r\n````\r\n  \"top_attributes\":{\r\n   \"top_hits\":{\r\n      \"size\":1,\r\n      \"sort\": [\"_doc\"]\r\n   }\r\n````\r\n\r\nThis will prevent the `terms` aggregation to rebuild a scorer to replay matching documents on the top buckets. In 5x this scorer is always built from the query and this leads to NPE when executed in a `global` context (which by definition ignores the query and match all document). All document have the same `score` in the `global` context so switching to `_doc` should yield the same result.\r\n\r\n\r\n \r\n\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/360925462","html_url":"https://github.com/elastic/elasticsearch/issues/28394#issuecomment-360925462","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28394","id":360925462,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MDkyNTQ2Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-01-26T22:44:59Z","updated_at":"2018-01-26T22:44:59Z","author_association":"MEMBER","body":"I tested on 6x and it fails for another reason. We cannot access the score of children (`nested`) documents in the `breadth_first` mode. The `terms` aggregation is not aware that the execution is done in a `nested` context (where only the parent document matches the query) so we should force the `depth_first` mode when a `nested` sub-aggregation needs to access the score. I'll work on a pr and link to that issue.","performed_via_github_app":null}]