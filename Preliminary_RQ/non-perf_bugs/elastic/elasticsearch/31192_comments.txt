[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395661906","html_url":"https://github.com/elastic/elasticsearch/issues/31192#issuecomment-395661906","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31192","id":395661906,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTY2MTkwNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T06:31:32Z","updated_at":"2018-06-08T06:31:32Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395691492","html_url":"https://github.com/elastic/elasticsearch/issues/31192#issuecomment-395691492","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31192","id":395691492,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTY5MTQ5Mg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T08:37:27Z","updated_at":"2018-06-08T08:37:27Z","author_association":"CONTRIBUTOR","body":"In  #31171 I originally used the avg. number of shards per index in the high level request which had issues as @jpountz stated:\r\n> I'm a bit unhappy that it breaks the rule that searching N indices with 1 shard performs the same as searching 1 index with N shards.\r\n\r\nI think what we want to achieve here is that we gain a certain level of concurrency while at the same time don't overload the cluster with a search request hitting a large number of shards on a small number of nodes. The smallish clusters with large shard counts are the critical ones here IMO if a query matching all shards causing rejections because the queue of the search threadpool on a single node fills up quickly.  So with a queue size or _1000_ on the search threadpool I do think we have quite some room here to have a simple default like `5 * numberOfNodes`.\r\n\r\nI also looked into the CCS issue which is not an issue after all since we take the number of nodes that participate in the request into account already.\r\n\r\nIn-fact the CCS way is actually better because it only takes into account the nodes that participate in the request. I wonder if we should change the way we use this number and limit the number of concurrent shards requests per node instead. We can then do this dynamically in `InitialSearchPhase` and queue up shards if we hit a node too hard as a protection mechanism. That would make the default simpler I think and more effective? ie if we set the default to 5 I think we have a good default. WDYT?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395693331","html_url":"https://github.com/elastic/elasticsearch/issues/31192#issuecomment-395693331","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31192","id":395693331,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTY5MzMzMQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T08:44:18Z","updated_at":"2018-06-08T08:44:18Z","author_association":"CONTRIBUTOR","body":"I think this metric makes more sense and is easier to reason about. +1","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395695645","html_url":"https://github.com/elastic/elasticsearch/issues/31192#issuecomment-395695645","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31192","id":395695645,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTY5NTY0NQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T08:52:47Z","updated_at":"2018-06-08T08:52:47Z","author_association":"CONTRIBUTOR","body":"> I wonder if we should change the way we use this number and limit the number of concurrent shards requests per node instead. We can then do this dynamically in InitialSearchPhase and queue up shards if we hit a node too hard as a protection mechanism. That would make the default simpler I think and more effective\r\n\r\n+1 to making this a per-target node limit instead of a global one.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395751897","html_url":"https://github.com/elastic/elasticsearch/issues/31192#issuecomment-395751897","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31192","id":395751897,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTc1MTg5Nw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-06-08T12:54:09Z","updated_at":"2018-06-08T12:54:09Z","author_association":"MEMBER","body":"+1","performed_via_github_app":null}]