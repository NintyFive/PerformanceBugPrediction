{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32358/events","html_url":"https://github.com/elastic/elasticsearch/issues/32358","id":344385837,"node_id":"MDU6SXNzdWUzNDQzODU4Mzc=","number":32358,"title":"[CI] Tests failures in server due to MasterNotDiscoveredException on 6.x","user":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-07-25T10:28:14Z","updated_at":"2018-08-07T07:40:42Z","closed_at":"2018-08-07T07:40:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Link to build: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+periodic/2429/console\r\n\r\nThere are 2 tests failing there in a similar way. I suspect the underlying cause is the same as in both cases I see a `MasterNotDiscoveredException` so I'm grouping them together.\r\n\r\nThe 2 failures are:\r\n\r\n```\r\nERROR   36.3s J1 | RecoveryFromGatewayIT.testRecoveryDifferentNodeOrderStartup <<< FAILURES!\r\n   > Throwable #1: ElasticsearchException[failed to update minimum master node to [1] (current masters [1])]; nested: MasterNotDiscoveredException;\r\n   > \tat __randomizedtesting.SeedInfo.seed([37172630A243372B:FED2345689CD7C31]:0)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.updateMinMasterNodes(InternalTestCluster.java:1723)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.stopNodesAndClients(InternalTestCluster.java:1392)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.stopNodesAndClient(InternalTestCluster.java:1385)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.stopRandomNode(InternalTestCluster.java:1325)\r\n   > \tat org.elasticsearch.gateway.RecoveryFromGatewayIT.testRecoveryDifferentNodeOrderStartup(RecoveryFromGatewayIT.java:503)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n   > Caused by: MasterNotDiscoveredException[null]\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$4.onTimeout(TransportMasterNodeAction.java:223)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:317)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:244)\r\n   > \tat org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:573)\r\n   > \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:624)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n```\r\n\r\nwith reproduce line:\r\n\r\n```\r\n./gradlew :server:integTest -Dtests.seed=37172630A243372B -Dtests.class=org.elasticsearch.gateway.RecoveryFromGatewayIT -Dtests.method=\"testRecoveryDifferentNodeOrderStartup\" -Dtests.security.manager=true -Dtests.locale=hr -Dtests.timezone=Etc/GMT-11\r\n```\r\n\r\nand:\r\n\r\n```\r\nERROR   70.6s J0 | MasterDisruptionIT.testIsolateMasterAndVerifyClusterStateConsensus <<< FAILURES!\r\n   > Throwable #1: MasterNotDiscoveredException[NodeDisconnectedException[[node_t1][127.0.0.1:30133][cluster:monitor/health] disconnected]]; nested: NodeDisconnectedException[[node_t1][127.0.0.1:30133][cluster:monitor/health] disconnected];\r\n   > \tat __randomizedtesting.SeedInfo.seed([37172630A243372B:84C4296EB852883E]:0)\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$4.onTimeout(TransportMasterNodeAction.java:223)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:317)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver.waitForNextChange(ClusterStateObserver.java:145)\r\n   > \tat org.elasticsearch.cluster.ClusterStateObserver.waitForNextChange(ClusterStateObserver.java:117)\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.retry(TransportMasterNodeAction.java:208)\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.access$500(TransportMasterNodeAction.java:108)\r\n   > \tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$3.handleException(TransportMasterNodeAction.java:194)\r\n   > \tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1068)\r\n   > \tat org.elasticsearch.transport.TransportService.lambda$onConnectionClosed$8(TransportService.java:928)\r\n   > \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:624)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nwith reproduce:\r\n\r\n```\r\n./gradlew :server:integTest -Dtests.seed=37172630A243372B -Dtests.class=org.elasticsearch.discovery.MasterDisruptionIT -Dtests.method=\"testIsolateMasterAndVerifyClusterStateConsensus\" -Dtests.security.manager=true -Dtests.locale=ko -Dtests.timezone=Africa/Porto-Novo\r\n```\r\n\r\nCannot reproduce either locally and I could not figure out why the problem occurs.\r\n\r\nI'll refrain from disabling the tests just yet until we get some feedback.\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}