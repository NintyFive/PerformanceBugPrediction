{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12483","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12483/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12483/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12483/events","html_url":"https://github.com/elastic/elasticsearch/issues/12483","id":97466050,"node_id":"MDU6SXNzdWU5NzQ2NjA1MA==","number":12483,"title":"Elasticsearch shards sporadically failing when running queries against an alias that includes a filter","user":{"login":"kristianholmsejersen","id":690528,"node_id":"MDQ6VXNlcjY5MDUyOA==","avatar_url":"https://avatars2.githubusercontent.com/u/690528?v=4","gravatar_id":"","url":"https://api.github.com/users/kristianholmsejersen","html_url":"https://github.com/kristianholmsejersen","followers_url":"https://api.github.com/users/kristianholmsejersen/followers","following_url":"https://api.github.com/users/kristianholmsejersen/following{/other_user}","gists_url":"https://api.github.com/users/kristianholmsejersen/gists{/gist_id}","starred_url":"https://api.github.com/users/kristianholmsejersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kristianholmsejersen/subscriptions","organizations_url":"https://api.github.com/users/kristianholmsejersen/orgs","repos_url":"https://api.github.com/users/kristianholmsejersen/repos","events_url":"https://api.github.com/users/kristianholmsejersen/events{/privacy}","received_events_url":"https://api.github.com/users/kristianholmsejersen/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-07-27T13:42:49Z","updated_at":"2018-02-13T20:37:41Z","closed_at":"2016-05-24T10:29:25Z","author_association":"NONE","active_lock_reason":null,"body":"I am currently running an Elasticsearch v.1.6 setup with two nodes, and an index with 5 shards. To this index, I have added an alias that contains a reference to my index, as well as a Groovy script filter that helps avoiding documents with invalid start and end dates. The alias looks like this:\n\n``` JSON\n\"MyIndex\" : {\n   \"aliases\": { \n       \"MyIndex_alias\": { \n            \"filter\" : {\n                \"script\":{ \n                    \"script\":\n                        \"\\r\\n entryDate = doc['availability.start'].date.getMillis();\n                         \\r\\n exitDate =  doc['availability.end'].date.getMillis();\n                         \\r\\n rightNow = DateMidnight.now().getMillis();\n                         \\r\\n\\r\\n if (entryDate < rightNow && exitDate > rightNow)\\r\\n {\n                                       \\r\\n return true;\n                             \\r\\n }\n                             \\r\\n return false;\",\n                        \"lang\":\"groovy\"}}}}}\n```\n\nWhen performing a simple query, such as term \\* (/MyIndex_alias/my_type/_search?request.q=*), a number of shards will fail the query returning the following message:\n\n``` JSON\n\"failed\": 1,\n\"failures\": [\n    {\n        \"index\": \"MyIndex\",\n        \"shard\": 2,\n        \"status\": 500,\n        \"reason\": \"RemoteTransportException[[MyESCluster][inet[/10.131.43.61:9301]][indices:data/read/search[phase/query]]]; nested: QueryPhaseExecutionException[[MyIndex][2]: query[ConstantScore(ScriptFilter(\n        entryDate = doc['availability.start'].date.getMillis();\n        exitDate = doc['availability.end'].date.getMillis();\n        rightNow = DateMidnight.now().getMillis();\n\n        if (entryDate < rightNow && exitDate > rightNow)\n        {\n             return true;\n        }\n        return false;))],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: GroovyScriptExecutionException[ArrayIndexOutOfBoundsException[null]]; \"\n    }\n]\n```\n\nI have already verified the following things:\n1. All the documents in my index have valid start and end values, and none of them have a null value.\n2. The filter does work on the shards that perform the query successfully\n3. The cluster has a green health status\n4. The error occurs randomly on shards both in the master and worker nodes\n5. The errors do not occur if queries are directed to the index instead of the alias\n6. Adding more nodes to the cluster seems to mitigate the problem. Running with 2 nodes usually leaves 2-3 shards failing, while 3 nodes limits the failure to 1-2 shards. Adding a final 4th node leaves the query only failing rarely on a single shard\n7. Even when the query succeeds, I sometimes get fewer results than expected, again sporadically\n   Any help on the matter would be greatly appreciated!\n8. Upgrading to Elasticsearch 1.7 doesn't have any effect on the issue\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}