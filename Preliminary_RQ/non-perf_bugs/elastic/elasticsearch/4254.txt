{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4254","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4254/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4254/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4254/events","html_url":"https://github.com/elastic/elasticsearch/issues/4254","id":23312483,"node_id":"MDU6SXNzdWUyMzMxMjQ4Mw==","number":4254,"title":"Completion field is not removed from the completion-suggester index","user":{"login":"danilomr","id":6040211,"node_id":"MDQ6VXNlcjYwNDAyMTE=","avatar_url":"https://avatars0.githubusercontent.com/u/6040211?v=4","gravatar_id":"","url":"https://api.github.com/users/danilomr","html_url":"https://github.com/danilomr","followers_url":"https://api.github.com/users/danilomr/followers","following_url":"https://api.github.com/users/danilomr/following{/other_user}","gists_url":"https://api.github.com/users/danilomr/gists{/gist_id}","starred_url":"https://api.github.com/users/danilomr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danilomr/subscriptions","organizations_url":"https://api.github.com/users/danilomr/orgs","repos_url":"https://api.github.com/users/danilomr/repos","events_url":"https://api.github.com/users/danilomr/events{/privacy}","received_events_url":"https://api.github.com/users/danilomr/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2013-11-26T13:00:34Z","updated_at":"2013-11-26T15:48:32Z","closed_at":"2013-11-26T15:48:32Z","author_association":"NONE","active_lock_reason":null,"body":"Hello to all!\n\nI have a problem with documents holding completion suggestion fields: at some point, a document is removed, but its completion field remains.\nThis problem doesn't happen to all document inserted in the index, it only happened to me when I created documents with high ids.\n\nMy environment settings:\nElasticSearch version number: `1.0.0.Beta1`\nLucene version: `4.5.1`\n\nIn the following example, I create an index and insert two documents. One with a high id (`id 3567245`) and other with a low id (`id 103`). When I remove the \ndocument with low id, its completion suggestion field still remains.\n\nNote: if I change the high id from `3567245` to, for example, `700`. The problem reported doesn't happen.\n## Create index, populate and remove one of the documents\n\n``` sh\ncurl -XDELETE 'localhost:9200/myindex'\n\ncurl -X PUT localhost:9200/myindex\n\ncurl -X PUT localhost:9200/myindex/mytype/_mapping -d '{\n  \"mytype\": {\n      \"properties\": {\n        \"name\": {\n          \"type\": \"string\"\n        },\n        \"suggest-mytype\": {\n          \"type\": \"completion\",\n          \"payloads\": true\n        }\n      }\n    }\n}'\n\ncurl -XPOST 'localhost:9200/_bulk' -d '\n{\"index\":{\"_index\":\"myindex\",\"_type\":\"mytype\",\"_id\":3567245}}\n{\"name\":\"Johnny\",\"suggest-mytype\":{\"input\":[\"Johnny\"],\"output\":\"Johnny\",\"payload\":{\"_id\":3567245}}}\n{\"index\":{\"_index\":\"myindex\",\"_type\":\"mytype\",\"_id\":103}}\n{\"name\":\"Anderson\",\"suggest-mytype\":{\"input\":[\"Anderson\"],\"output\":\"Anderson\",\"payload\":{\"_id\":103}}}\n'\n\ncurl -XDELETE 'localhost:9200/myindex/_query' -d '\n{\"bool\":{\"should\":[{\"term\":{\"_id\":{\"value\":103}}}]}}\n'\n```\n## search 1: show everything from the index\n\n``` sh\ncurl -XPOST 'localhost:9200/myindex/_search?pretty' -d '{}'\n```\n\nEverything looks ok, the document with `id 103` was removed:\n\n``` JSON\n{\n  \"took\" : 1,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"myindex\",\n      \"_type\" : \"mytype\",\n      \"_id\" : \"3567245\",\n      \"_score\" : 1.0, \"_source\" : {\"name\":\"Johnny\",\"suggest-mytype\":{\"input\":[\"Johnny\"],\"output\":\"Johnny\",\"payload\":{\"_id\":3567245}}}\n    } ]\n  }\n}\n```\n## search 2: look for suggestions\n\n``` sh\ncurl -XPOST 'localhost:9200/myindex/_suggest?pretty' -d '{\n  \"completion1\": {\n    \"text\": \"Jo\",\n    \"completion\": {\n      \"field\": \"suggest-mytype\"\n    }\n  },\n  \"completion2\": {\n    \"text\": \"a\",\n    \"completion\": {\n      \"field\": \"suggest-mytype\"\n    }\n  }\n}'\n```\n\nOutput for search 2: \n\n``` JSON\n{\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"completion1\" : [ {\n    \"text\" : \"Jo\",\n    \"offset\" : 0,\n    \"length\" : 2,\n    \"options\" : [ {\n      \"text\" : \"Johnny\",\n      \"score\" : 1.0, \"payload\" : {\"_id\":3567245}\n    } ]\n  } ],\n  \"completion2\" : [ {\n    \"text\" : \"a\",\n    \"offset\" : 0,\n    \"length\" : 1,\n    \"options\" : [ {\n      \"text\" : \"Anderson\",\n      \"score\" : 1.0, \"payload\" : {\"_id\":103}\n    } ]\n  } ]\n}\n```\n\nThe entry with the `id 103` was **not** supposed to show up here, because we removed the document.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}