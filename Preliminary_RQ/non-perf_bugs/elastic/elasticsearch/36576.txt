{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36576","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36576/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36576/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36576/events","html_url":"https://github.com/elastic/elasticsearch/issues/36576","id":390449351,"node_id":"MDU6SXNzdWUzOTA0NDkzNTE=","number":36576,"title":"Add reverse nested query","user":{"login":"Derya","id":3374003,"node_id":"MDQ6VXNlcjMzNzQwMDM=","avatar_url":"https://avatars2.githubusercontent.com/u/3374003?v=4","gravatar_id":"","url":"https://api.github.com/users/Derya","html_url":"https://github.com/Derya","followers_url":"https://api.github.com/users/Derya/followers","following_url":"https://api.github.com/users/Derya/following{/other_user}","gists_url":"https://api.github.com/users/Derya/gists{/gist_id}","starred_url":"https://api.github.com/users/Derya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Derya/subscriptions","organizations_url":"https://api.github.com/users/Derya/orgs","repos_url":"https://api.github.com/users/Derya/repos","events_url":"https://api.github.com/users/Derya/events{/privacy}","received_events_url":"https://api.github.com/users/Derya/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-12-12T23:12:34Z","updated_at":"2019-01-10T09:58:40Z","closed_at":"2019-01-08T14:35:50Z","author_association":"NONE","active_lock_reason":null,"body":"There doesn't seem to be a way to break out of the nesting level in a query definition that's being defined in a filter aggregation. Normally we'd never need a reverse nested query, since any actual references to fields happen at the end of our query when all the compound/joining stuff is done. But if I'm filtering some nested documents, how can I filter on the parent document's properties? As a simple example of where I'd need to use this:\r\n\r\n```\r\n{\r\n  \"aggs\": {\r\n    \"OP0_nest\": {\r\n      \"nested\": { \"path\": \"events\" },\r\n      \"aggs\": {\r\n        \"OP0_custom_filter\": {\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"should\": [\r\n                { \"term\": { \"events.color\": \"orange\" } },\r\n                { \"term\": { \"customer_id\": 35 } }\r\n              ]\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"OP0_op\": {\r\n              \"avg\": { \"field\": \"events.coord_y\" }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis query doesn't work, because that `customer_id` term that wants to reference the parent doc is not allowed. But, if we had a way to break out and refer back to it, this would be easy to solve.","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}