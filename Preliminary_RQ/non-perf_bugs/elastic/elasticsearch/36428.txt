{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36428","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36428/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36428/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36428/events","html_url":"https://github.com/elastic/elasticsearch/issues/36428","id":389287498,"node_id":"MDU6SXNzdWUzODkyODc0OTg=","number":36428,"title":"TEST: ClusterDisruptionIT testSendingShardFailure fails","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"assignees":[{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-12-10T12:52:43Z","updated_at":"2018-12-11T10:22:24Z","closed_at":"2018-12-11T10:22:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Test failure: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+intake/638/console\r\n\r\nThe issue exhibited by the test is as follows: Simulated disconnect between follower and leader while sending shard failure. Follower gets reconnected to leader through a follower check, but does not remove NO_MASTER_BLOCK from cluster state, which means that sending the shard failure is not retried. Unfortunately, removing the NO_MASTER_BLOCK on becoming follower is not enough, because that will still not trigger the shard failure to be resent because the cluster state version is not incremented.\r\n\r\nRelevant log lines:\r\n\r\n```\r\n1> [2018-12-10T05:35:00,225][DEBUG][o.e.c.a.s.ShardStateAction] [testSendingShardFailure] sending [internal:cluster/shard/failure] to [ir1zPCLYRTikvc1ljjbFdw] for shard entry [shard id [[test][0]], allocation id [BSJMH3QrSAOmXvAY67aymg], primary term [0], message [simulated], failure [CorruptIndexException[simulated (resource=null)]], markAsStale [true]]\r\n  1> [2018-12-10T05:35:00,226][DEBUG][o.e.c.c.Coordinator      ] [node_t0] onLeaderFailure: becoming CANDIDATE (was FOLLOWER, lastKnownLeader was [Optional[{node_t1}{ir1zPCLYRTikvc1ljjbFdw}{MXpZkxX8TpWwVU5N02B_ew}{127.0.0.1}{127.0.0.1:35909}]])\r\n...\r\n  1> [2018-12-10T05:35:00,230][DEBUG][o.e.c.s.ClusterApplierService] [node_t0] processing [becoming candidate: onLeaderFailure]: execute\r\n  1> [2018-12-10T05:35:00,230][TRACE][o.e.c.s.ClusterApplierService] [node_t0] cluster state updated, source [becoming candidate: onLeaderFailure]\r\n...\r\n1> [2018-12-10T05:35:00,242][DEBUG][o.e.d.ClusterDisruptionIT] [testSendingShardFailure] ensuring cluster is stable with [3] nodes. access node: [node_t0]. timeout: [30s]\r\n  1> [2018-12-10T05:35:00,242][DEBUG][o.e.a.a.c.h.TransportClusterHealthAction] [testSendingShardFailure] no known master node, scheduling a retry\r\n  1> [2018-12-10T05:35:00,466][DEBUG][o.e.c.c.Coordinator      ] [node_t0] onFollowerCheckRequest: becoming FOLLOWER of [{node_t1}{ir1zPCLYRTikvc1ljjbFdw}{MXpZkxX8TpWwVU5N02B_ew}{127.0.0.1}{127.0.0.1:35909}] (was CANDIDATE, lastKnownLeader was [Optional[{node_t1}{ir1zPCLYRTikvc1ljjbFdw}{MXpZkxX8TpWwVU5N02B_ew}{127.0.0.1}{127.0.0.1:35909}]])\r\n  1> [2018-12-10T05:35:00,470][DEBUG][o.e.c.c.LeaderChecker    ] [node_t0] closed check scheduler woken up, doing nothing\r\n  1> [2018-12-10T05:35:30,244][DEBUG][o.e.a.a.c.h.TransportClusterHealthAction] [node_t0] timed out while retrying [cluster:monitor/health] after failure (timeout [30s])\r\n  1> [2018-12-10T05:35:30,245][INFO ][o.e.d.ClusterDisruptionIT] [testSendingShardFailure] [ClusterDisruptionIT#testSendingShardFailure]: cleaning up after test\r\n  1> [2018-12-10T05:35:30,245][INFO ][o.e.t.InternalTestCluster] [testSendingShardFailure] Clearing active scheme network disruption (disruption type: network disconnects, disrupted links: two partitions (partition 1: [node_t0] and partition 2: [node_t2, node_t1])), expected healing time 0s\r\n  1> [2018-12-10T05:35:30,268][DEBUG][o.e.a.a.c.s.TransportClusterStateAction] [testSendingShardFailure] no known master node, scheduling a retry\r\n  1> [2018-12-10T05:36:00,268][DEBUG][o.e.a.a.c.s.TransportClusterStateAction] [node_t0] timed out while retrying [cluster:monitor/state] after failure (timeout [30s])\r\n```","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}