{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22755","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22755/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22755/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22755/events","html_url":"https://github.com/elastic/elasticsearch/issues/22755","id":202670546,"node_id":"MDU6SXNzdWUyMDI2NzA1NDY=","number":22755,"title":"Cannot update index template using REST on s390x Docker Container","user":{"login":"benjsmi","id":3200536,"node_id":"MDQ6VXNlcjMyMDA1MzY=","avatar_url":"https://avatars2.githubusercontent.com/u/3200536?v=4","gravatar_id":"","url":"https://api.github.com/users/benjsmi","html_url":"https://github.com/benjsmi","followers_url":"https://api.github.com/users/benjsmi/followers","following_url":"https://api.github.com/users/benjsmi/following{/other_user}","gists_url":"https://api.github.com/users/benjsmi/gists{/gist_id}","starred_url":"https://api.github.com/users/benjsmi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benjsmi/subscriptions","organizations_url":"https://api.github.com/users/benjsmi/orgs","repos_url":"https://api.github.com/users/benjsmi/repos","events_url":"https://api.github.com/users/benjsmi/events{/privacy}","received_events_url":"https://api.github.com/users/benjsmi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-01-23T22:32:07Z","updated_at":"2017-01-25T13:50:27Z","closed_at":"2017-01-23T22:57:49Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.1\r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version**: \r\n```\r\nopenjdk version \"1.8.0_102\"\r\nOpenJDK Runtime Environment (build 1.8.0_102-8u102-b14.1-1~bpo8+1-b14)\r\nOpenJDK 64-Bit Zero VM (build 25.102-b14, interpreted mode)\r\n```\r\n\r\n**OS version**:\r\n```\r\nDistributor ID:\tUbuntu\r\nDescription:\tUbuntu 16.04.1 LTS\r\nRelease:\t16.04\r\nCodename:\txenial\r\n```\r\n\r\n**uname**\r\n```\r\n$ uname -a\r\nLinux ******** 4.4.0-47-generic #68-Ubuntu SMP Wed Oct 26 19:42:36 UTC 2016 s390x s390x s390x GNU/Linux\r\n````\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI stood up elasticsearch v5.1.1 in a Docker container running on System Z with the JNA libraries built for JNA support for ES.  I then pointed a logstash v5.1.1 container at this elasticsearch with the elasticsearch output plugin enabled.  When first starting the elasticsearch container, I see:\r\n```\r\n[2017-01-23T22:05:45,735][DEBUG][o.e.b.JNANatives         ] unable to install syscall filter\r\njava.lang.UnsupportedOperationException: seccomp unavailable: 's390x' architecture unsupported\r\n    at org.elasticsearch.bootstrap.Seccomp.linuxImpl(Seccomp.java:267) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.bootstrap.Seccomp.init(Seccomp.java:630) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.bootstrap.JNANatives.trySeccomp(JNANatives.java:215) [elasticsearch-5.1.1.jar:5.1.1]\r\n```\r\n\r\nWhich I'm not 100% sure I need to worry about nor is the source of the problem.  To the best of my knowledge, the above block means that elasticsearch tried to access a Java Native feature to increase the security of my deployment by _disallowing_ certain features at the kernel level for my protection but could not because that feature is not available in my kernel.  I include here as FYI just in case it has an effect on the problem I see later on.\r\n\r\nElasticsearch starts fine and I wait for it to finish coming up, then I kick on my logstash container.  Logstash connects and attempts to store the first index template.  That's when I see this:\r\n```\r\n[2017-01-23T22:06:55,319][DEBUG][r.suppressed             ] path: /_template/logstash, params: {name=logstash}\r\norg.elasticsearch.ElasticsearchParseException: Failed to derive xcontent\r\n    at org.elasticsearch.common.xcontent.XContentFactory.xContent(XContentFactory.java:239) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.action.admin.indices.template.put.PutIndexTemplateRequest.source(PutIndexTemplateRequest.java:362) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.rest.action.admin.indices.RestPutIndexTemplateAction.prepareRequest(RestPutIndexTemplateAction.java:50) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.rest.BaseRestHandler.handleRequest(BaseRestHandler.java:66) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.rest.RestController.executeHandler(RestController.java:243) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:200) [elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.http.HttpServer.dispatchRequest(HttpServer.java:113) [elasticsearch-5.1.1.jar:5.1.1]\r\n    at org.elasticsearch.http.netty4.Netty4HttpServerTransport.dispatchRequest(Netty4HttpServerTransport.java:507) [transport-netty4-5.1.1.jar:5.1.1]\r\n```\r\n\r\nBased on the [code](https://github.com/elastic/elasticsearch/blob/5.1/core/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java#L182), my read is that the XContentFactory instantiates the xContent class, where the [content type is guessed](https://github.com/elastic/elasticsearch/blob/5.1/core/src/main/java/org/elasticsearch/common/xcontent/XContentFactory.java#L248) based on the contents of the message.  What's odd is that I _know_ that logstash is sending a JSON object in the body of the message, and the code says if the message starts with `{`, it shouldn't return null, but rather should return the `JSON` type.\r\n\r\nI highly doubt that it's an incorrect request, given that logstash is the one generating it and that I can point this same container/image at an elasticsearch that is running on x86 and it functions correctly.\r\n\r\nI have committed my work for the steps to reproduce in a Github repository under my namespace: https://github.com/benjsmi/elasticsearch-s390x\r\n\r\nWithin this repo, you'll find all the files necessary to build elasticsearch 5.1.1 on s390x.  \r\n\r\nAlso, within this repo, you'll see the files necessary to build JNA for s390x:\r\nhttps://github.com/benjsmi/elasticsearch-s390x/blob/master/jna/Dockerfile-jna-z\r\n\r\nThe above Dockerfile can be used to build a docker builder on s390x, which will pull down the JNA code, ant, and run the targets to create a JAR that has s390x support with the relevant libdispatch.so.\r\n\r\n**Steps to reproduce**:\r\n 1. Build the Docker Image at https://github.com/benjsmi/elasticsearch-s390x on an s390x machine with the command:\r\n\r\n```\r\ndocker build -t elasticsearch:s390x -f ./Dockerfile-z .\r\n```\r\n\r\n 2. Run the container on this Z system with command:\r\n\r\n```\r\ndocker run -it -p 9200:9200 elasticsearch:s390x\r\n```\r\n\r\n3. Run an instance of logstash, configure to point at the above s390x machine on port 9200.  It doesn't matter how this logstash is configured elsewise, so long as its output is set to point at the above s390x machine.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nThe logs for the logstash container:\r\nhttp://pastebin.com/ds0Kvsdg\r\n\r\nThe logs for the elasticsearch container:\r\nhttp://pastebin.com/fBh7L4Tz","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}