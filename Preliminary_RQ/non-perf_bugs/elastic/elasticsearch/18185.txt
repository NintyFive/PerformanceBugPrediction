{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18185","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18185/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18185/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18185/events","html_url":"https://github.com/elastic/elasticsearch/issues/18185","id":153448284,"node_id":"MDU6SXNzdWUxNTM0NDgyODQ=","number":18185,"title":"Wrong score under explain when using dfs search type","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-05-06T13:15:23Z","updated_at":"2016-05-06T13:19:17Z","closed_at":"2016-05-06T13:19:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: `Elasticsearch 2.3`\n\n**JVM version**: `Java HotSpot(TM) 64-Bit Server VM (build 25.45-b02, mixed mode)`\n\n**OS version**: Any\n\n**Description of the problem including expected versus actual behavior**:\n\nThis only happens when `search_type=dfs_query_then_fetch`! Looks like the score that the explain object is returning is different than the actual score that it is being returned in the hit.\n\nFirst, start elasticsearch 1.7 to verify that the `explain` was working fine. Do the following bulk operation:\n\n```\nPOST /_bulk\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n{ \"index\": { \"_index\": \"trial\", \"_type\": \"type\" } }\n{ \"city\": \"montevideo\", \"cityAliases\": \"mvd\" }\n```\n\nThen, execute the following search operation:\n\n```\nPOST /trial/_search?search_type=dfs_query_and_fetch&explain&size=1\n{\"query\":{\"multi_match\":{\"query\":\"mvd\",\"fields\":[\"city\",\"cityAliases\"]}}}\n```\n\nVerify that the score under explain is the same as the main score:\n\n```\n# Result - Main Score:  0.24285339, _explanation Score: 0.24285339\n{\n  \"_shard\": 0,\n  \"_node\": \"bPFH3L1nT9-BTOKWyd-i0Q\",\n  \"_index\": \"trial\",\n  \"_type\": \"type\",\n  \"_id\": \"AVSGJuxrGCZTdIeL7K4h\",\n  \"_score\": 0.24285339,\n  \"_source\": {\n    \"city\": \"montevideo\",\n    \"cityAliases\": \"mvd\"\n  },\n  \"_explanation\": {\n    \"value\": 0.24285339,\n    \"description\": \"max of:\",\n    \"details\": [\n      {\n        \"value\": 0.24285339,\n        \"description\": \"weight(cityAliases:mvd in 0) [PerFieldSimilarity], result of:\",\n        \"details\": [\n          {\n            \"value\": 0.24285339,\n            \"description\": \"score(doc=0,freq=1.0), product of:\",\n            \"details\": [\n              {\n                \"value\": 0.26398334,\n                \"description\": \"queryWeight, product of:\",\n                \"details\": [\n                  {\n                    \"value\": 0.9199573,\n                    \"description\": \"idf(docFreq=12, maxDocs=12)\"\n                  },\n                  {\n                    \"value\": 0.28695172,\n                    \"description\": \"queryNorm\"\n                  }\n                ]\n              },\n              {\n                \"value\": 0.9199573,\n                \"description\": \"fieldWeight in 0, product of:\",\n                \"details\": [\n                  {\n                    \"value\": 1,\n                    \"description\": \"tf(freq=1.0), with freq of:\",\n                    \"details\": [\n                      {\n                        \"value\": 1,\n                        \"description\": \"termFreq=1.0\"\n                      }\n                    ]\n                  },\n                  {\n                    \"value\": 0.9199573,\n                    \"description\": \"idf(docFreq=12, maxDocs=12)\"\n                  },\n                  {\n                    \"value\": 1,\n                    \"description\": \"fieldNorm(doc=0)\"\n                  }\n                ]\n              }\n            ]\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n\nNow, do the same in Elasticsearch 2.3.  Use the same bulk operation and query!\n\nVerify that the score under explain is **DIFFERENT** as the main score. The score is `0.24285339` but the explain is giving `0.2417773`. With larger datasets the difference between explain and the score can be bigger.\n\n```\n# Result - Main Score:  0.24285339, _explanation Score: 0.2417773\n{\n  \"_shard\": 1,\n  \"_node\": \"CY8y3EdDQyWmUkB9oB3MgQ\",\n  \"_index\": \"trial\",\n  \"_type\": \"type\",\n  \"_id\": \"AVSGKy64GyfPh09elcKQ\",\n  \"_score\": 0.24285339,\n  \"_source\": {\n    \"city\": \"montevideo\",\n    \"cityAliases\": \"mvd\"\n  },\n  \"_explanation\": {\n    \"value\": 0.2417773,\n    \"description\": \"max of:\",\n    \"details\": [\n      {\n        \"value\": 0.2417773,\n        \"description\": \"weight(cityAliases:mvd in 0) [PerFieldSimilarity], result of:\",\n        \"details\": [\n          {\n            \"value\": 0.2417773,\n            \"description\": \"score(doc=0,freq=1.0), product of:\",\n            \"details\": [\n              {\n                \"value\": 0.3394233,\n                \"description\": \"queryWeight, product of:\",\n                \"details\": [\n                  {\n                    \"value\": 0.71231794,\n                    \"description\": \"idf(docFreq=3, maxDocs=3)\",\n                    \"details\": []\n                  },\n                  {\n                    \"value\": 0.47650534,\n                    \"description\": \"queryNorm\",\n                    \"details\": []\n                  }\n                ]\n              },\n              {\n                \"value\": 0.71231794,\n                \"description\": \"fieldWeight in 0, product of:\",\n                \"details\": [\n                  {\n                    \"value\": 1,\n                    \"description\": \"tf(freq=1.0), with freq of:\",\n                    \"details\": [\n                      {\n                        \"value\": 1,\n                        \"description\": \"termFreq=1.0\",\n                        \"details\": []\n                      }\n                    ]\n                  },\n                  {\n                    \"value\": 0.71231794,\n                    \"description\": \"idf(docFreq=3, maxDocs=3)\",\n                    \"details\": []\n                  },\n                  {\n                    \"value\": 1,\n                    \"description\": \"fieldNorm(doc=0)\",\n                    \"details\": []\n                  }\n                ]\n              }\n            ]\n          }\n        ]\n      }\n    ]\n  }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}