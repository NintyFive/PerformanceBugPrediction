{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941/events","html_url":"https://github.com/elastic/elasticsearch/issues/46941","id":496460390,"node_id":"MDU6SXNzdWU0OTY0NjAzOTA=","number":46941,"title":"A method to reduce the time cost to update cluster state","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-09-20T17:14:44Z","updated_at":"2019-10-31T10:55:23Z","closed_at":"2019-10-31T10:55:23Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ES_VERSION: 5.6.8 \r\nJVM version : JDK1.8.0_112\r\nOS version : linux\r\nDescription of the problem including expected versus actual behavior:\r\n&#160; &#160; &#160; &#160;As it's known, Updating cluster state on master node will cost too much time, which seriously affects the size and stability of the cluster. In out product, updating cluster state will cost 15s+ with the cluster of  50 nodes and 3,000 indices, 60,000 shard, the experience is very poor when we want to create index and delete index.\r\n&#160; &#160; &#160; &#160;To find out why it cost so much time on updating cluste state, I get the thread stack about updateTask, such that:\r\n```\r\n\"elasticsearch[node1][clusterService#updateTask][T#1]\" #32 daemon prio=5 os_prio=0 tid=0x00007f5d703a2800 nid=0x8252 runnable [0x00007f5c22b71000]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at java.util.Collections$UnmodifiableCollection$1.hasNext(Collections.java:1041)\r\n        at org.elasticsearch.cluster.routing.RoutingNode.shardsWithState(RoutingNode.java:148)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDecider.sizeOfRelocatingShards(DiskThresholdDecider.java:90)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDecider.getDiskUsage(DiskThresholdDecider.java:320)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.DiskThresholdDecider.canRemain(DiskThresholdDecider.java:265)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.AllocationDeciders.canRemain(AllocationDeciders.java:105)\r\n        at org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator$Balancer.decideMove(BalancedShardsAllocator.java:687)\r\n        at org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator$Balancer.moveShards(BalancedShardsAllocator.java:648)\r\n        at org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator.allocate(BalancedShardsAllocator.java:123)\r\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:329)\r\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.applyStartedShards(AllocationService.java:100)\r\n```\r\n&#160; &#160; &#160; &#160;I try several times and get the same thread stack. it seems that `DiskThresholdDecider.sizeOfRelocatingShards` will cost too much time, the code is as follow:\r\n```\r\n static long sizeOfRelocatingShards(RoutingNode node, RoutingAllocation allocation,\r\n                                       boolean subtractShardsMovingAway, String dataPath) {\r\n      ClusterInfo clusterInfo = allocation.clusterInfo();\r\n      long totalSize = 0;\r\n      for (ShardRouting routing : node.shardsWithState(ShardRoutingState.RELOCATING, \r\n     ShardRoutingState.INITIALIZING)) {\r\n             ......\r\n      }\r\n      ......\r\n}\r\n```\r\n&#160; &#160; &#160; &#160;It says that: to test whether the shard can remain stay on the node or not ,we will get the size of relocating shards, then we will get all the shards(about 6,000 shards on one node) of the node, check the shards if is be `RELOCATING` or `INITIALIZING`. This is only one shard, there have 60,000 shard need to be test, and  will be 60,000 * 6,000 times checkout, which will cost too much times.\r\n&#160; &#160; &#160; &#160;I find that we can use the settings to avoid this check: `\"cluster.routing.allocation.disk.include_relocations\":\"false\"`. when i set it to be false, the time to update cluster state decreases from 15s to 3s which has achives better result.\r\n&#160; &#160; &#160; &#160;if we could set the `cluster.routing.allocation.disk.include_relocations` to be `false` by default, most of us will ignore the default setting. or  if we could reserve the shard state of relocating and initializing about every node in cluster state, so we will not find out the shards every time by checking every time when updating cluster state.","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}