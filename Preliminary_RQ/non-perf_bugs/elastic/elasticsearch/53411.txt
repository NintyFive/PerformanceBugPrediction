{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53411","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53411/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53411/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53411/events","html_url":"https://github.com/elastic/elasticsearch/issues/53411","id":579284139,"node_id":"MDU6SXNzdWU1NzkyODQxMzk=","number":53411,"title":"Partial reduce failures can throw AssertionError","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-11T13:57:43Z","updated_at":"2020-07-28T09:35:37Z","closed_at":"2020-07-28T09:35:37Z","author_association":"MEMBER","active_lock_reason":null,"body":"Today we don't expect any failure when running a partial reduce of shard responses.\r\nHowever there are at least two cases where such failures occur:\r\n\r\n- Sorted queries on fields that are of mixed types in the different search indices (e.g.: a field mapped as keyword and double in the same search).\r\n- Partial reduce that creates more than `search.max_buckets`.\r\n\r\nThere's a race condition in this scenario because the internal counters are not properly accounted.\r\nTechnically speaking, a partial reduce that fails should fail the entire request. Currently we execute partial reduce when we receive a new shard response and the buffer is full.  Since we have other shard queries in flight (the search is not over) it's not easy to fail the entire request if a failure occurs. The final reduce is not affected by this bug because it is executed after all shards responded. \r\n\r\nWe should propagate the error safely to the final reduce or find a way to early terminate a request in the middle of a search phase. The latter would be a nice free improvements for users that disallows partial results (`\"allow_partial_search_results\": false`) since today we cannot early terminate the request on the first shard failure even if we know that the user expects an error.\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}