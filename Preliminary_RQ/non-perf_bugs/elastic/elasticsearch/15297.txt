{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297/events","html_url":"https://github.com/elastic/elasticsearch/issues/15297","id":120902961,"node_id":"MDU6SXNzdWUxMjA5MDI5NjE=","number":15297,"title":"Geolocation sorting inaccurate","user":{"login":"sudhanne","id":12982069,"node_id":"MDQ6VXNlcjEyOTgyMDY5","avatar_url":"https://avatars1.githubusercontent.com/u/12982069?v=4","gravatar_id":"","url":"https://api.github.com/users/sudhanne","html_url":"https://github.com/sudhanne","followers_url":"https://api.github.com/users/sudhanne/followers","following_url":"https://api.github.com/users/sudhanne/following{/other_user}","gists_url":"https://api.github.com/users/sudhanne/gists{/gist_id}","starred_url":"https://api.github.com/users/sudhanne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sudhanne/subscriptions","organizations_url":"https://api.github.com/users/sudhanne/orgs","repos_url":"https://api.github.com/users/sudhanne/repos","events_url":"https://api.github.com/users/sudhanne/events{/privacy}","received_events_url":"https://api.github.com/users/sudhanne/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-12-08T00:40:47Z","updated_at":"2015-12-16T11:33:41Z","closed_at":"2015-12-15T12:31:22Z","author_association":"NONE","active_lock_reason":null,"body":"Problem:\n    When using the geolocation sorting functionality to sort based on distance from a point (lat, lon), we are observing inaccurate distance computations.  In some cases these are off by a little bit, but in others they are wildly off.  Changing the sort accuracy to ARC does not seem to help much.\n    When we switch to using a Groovy script to calculate these values we get completely accurate results.  We are trying to understand where the differences could come from, and how such fundamental functionality could be broken.\n\nElasticsearch version: \n    1.5.1\n\nType Mapping:\n\n{\n \"lms_event\": {\n            \"dynamic\": \"strict\",\n            \"_all\": {\n               \"enabled\": false\n            },\n            \"properties\": {\n               \"acl\": {\n                  \"properties\": {\n                     \"ou_with_subs\": {\n                        \"type\": \"integer\"\n                     },\n                     \"ou_without_subs\": {\n                        \"type\": \"integer\"\n                     },\n                     \"user_with_subs\": {\n                        \"type\": \"integer\"\n                     },\n                     \"user_without_subs\": {\n                        \"type\": \"integer\"\n                     }\n                  }\n               },\n               \"event_id\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\"\n               },\n               \"rating\": {\n                  \"type\": \"integer\",\n                  \"doc_values\": true\n               },\n               \"session\": {\n                  \"type\": \"nested\",\n                  \"properties\": {\n                     \"date_end\": {\n                        \"type\": \"date\",\n                        \"format\": \"dateOptionalTime\"\n                     },\n                     \"date_start\": {\n                        \"type\": \"date\",\n                        \"format\": \"dateOptionalTime\"\n                     },\n                     \"location\": {\n                        \"type\": \"geo_point\",\n                        \"doc_values\": true\n                     },\n                     \"location_ou_id\": {\n                        \"type\": \"integer\"\n                     },\n                     \"schedule_id\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\"\n                     },\n                     \"session_id\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\"\n                     }\n                  }\n               },\n               \"subject_id\": {\n                  \"type\": \"integer\",\n                  \"doc_values\": true\n               }\n            }\n}\n\nQuery 1 (default ES geolocation sorting):\n\nGET /dev.devrelease/lms_event/_search\n{\n   \"_source\": [\n      \"event_id\"\n   ],\n   \"query\": {\n      \"filtered\": {\n         \"query\": {\n            \"match_all\": {}\n         },\n         \"filter\": {\n            \"bool\": {\n               \"must\": [\n                  {\n                     \"term\": {\n                        \"event_id\": \"54231e7d-e725-480f-a66d-4358fa31ba46\"\n                     }\n                  },\n                  {\n                     \"nested\": {\n                        \"path\": \"session\",\n                        \"filter\": {\n                           \"geo_distance\": {\n                              \"distance\": \"1mi\",\n                              \"location\": {\n                                 \"lon\": -118.486974,\n                                 \"lat\": 34.01956\n                              }\n                           }\n                        },\n                        \"inner_hits\": {\n                           \"size\": 1000,\n                           \"sort\": [\n                              {\n                                 \"_geo_distance\": {\n                                    \"session.location\": {\n                                 \"lon\": -118.486974,\n                                 \"lat\": 34.01956\n                                    },\n                                    \"order\": \"asc\",\n                                    \"unit\": \"mi\"\n                                 }\n                              },\n                              {\n                                 \"date_start\": {\n                                    \"order\": \"asc\"\n                                 }\n                              }\n                           ]\n                        }\n                     }\n                  }\n               ]\n            }\n         }\n      }\n   }\n}\n}\n\nQuery 1 Result (inaccurate)\n\n```\n    {\n                       \"_index\": \"dev.devrelease.3034\",\n                       \"_type\": \"lms_event\",\n                       \"_id\": \"54231e7d-e725-480f-a66d-4358fa31ba46\",\n                       \"_nested\": {\n                          \"field\": \"session\",\n                          \"offset\": 11\n                       },\n                       \"_score\": null,\n                       \"_source\": {\n                          \"session_id\": \"940c8051-3b9f-45e4-8d2c-b85168c0eaad\",\n                          \"schedule_id\": \"4ca2b22e-ebf4-4188-8ecb-0217bab50a69\",\n                          \"location\": {\n                             \"lon\": -118.486974,\n                             \"lat\": 34.01956\n                          },\n                          \"date_start\": \"2016-06-28T16:00:00.0000000\",\n                          \"date_end\": \"2016-06-28T17:05:00.0000000\",\n                          \"location_ou_id\": 764362\n                       },\n                       \"sort\": [\n                          2.553454168690986,\n                          1467129600000\n                       ]\n                    }\n```\n\nQuery 2 (groovy script)\n\n{\nGET /dev.devrelease/lms_event/_search\n{\n   \"_source\": [\n      \"event_id\"\n   ],\n   \"query\": {\n      \"filtered\": {\n         \"query\": {\n            \"match_all\": {}\n         },\n         \"filter\": {\n            \"bool\": {\n               \"must\": [\n                  {\n                     \"term\": {\n                        \"event_id\": \"54231e7d-e725-480f-a66d-4358fa31ba46\"\n                     }\n                  },\n                  {\n                     \"nested\": {\n                        \"path\": \"session\",\n                        \"filter\": {\n                           \"geo_distance\": {\n                              \"distance\": \"1mi\",\n                              \"location\": {\n                                 \"lon\": -118.486974,\n                                 \"lat\": 34.01956\n                              }\n                           }\n                        },\n                        \"inner_hits\": {\n                           \"size\": 1000,\n                           \"sort\": [\n                              {\n                                 \"_script\": {\n                                    \"lang\": \"groovy\",\n                                    \"script\": \"doc['session.location'].arcDistanceInMiles(34.01956, -118.486974)\",\n                                    \"type\": \"number\",\n                                    \"order\": \"asc\"\n                                 }\n                              },\n                              {\n                                 \"date_start\": {\n                                    \"order\": \"asc\"\n                                 }\n                              }\n                           ]\n                        }\n                     }\n                  }\n               ]\n            }\n         }\n      }\n   }\n}\n}\n\nQuery 2 Results (accurate)\n\n```\n     {\n                       \"_index\": \"dev.devrelease.3034\",\n                       \"_type\": \"lms_event\",\n                       \"_id\": \"54231e7d-e725-480f-a66d-4358fa31ba46\",\n                       \"_nested\": {\n                          \"field\": \"session\",\n                          \"offset\": 8\n                       },\n                       \"_score\": null,\n                       \"_source\": {\n                          \"session_id\": \"d54e485b-9e3d-42fc-a23a-e36dffb59fe9\",\n                          \"schedule_id\": \"957d7df0-98d8-4318-93cf-3bedb9aa70b4\",\n                          \"location\": {\n                             \"lon\": -118.473667,\n                             \"lat\": 34.028449\n                          },\n                          \"date_start\": \"2016-06-30T16:00:00.0000000\",\n                          \"date_end\": \"2016-06-30T17:05:00.0000000\",\n                          \"location_ou_id\": 764360\n                       },\n                       \"sort\": [\n                          0.9787904132112273,\n                          1467302400000\n                       ]\n                    }\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}