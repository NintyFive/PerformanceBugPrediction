[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433074529","html_url":"https://github.com/elastic/elasticsearch/issues/34862#issuecomment-433074529","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34862","id":433074529,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzA3NDUyOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-10-25T14:31:45Z","updated_at":"2018-10-25T14:31:45Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433319357","html_url":"https://github.com/elastic/elasticsearch/issues/34862#issuecomment-433319357","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34862","id":433319357,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzMxOTM1Nw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-26T07:48:50Z","updated_at":"2018-10-26T07:48:50Z","author_association":"CONTRIBUTOR","body":"I looked into this some more. I'm not sure the `unexpected mapping update` is the issue, because I also found this:\r\n\r\n```\r\n   > Throwable #1: java.lang.Exception: Suite timeout exceeded (>= 1200000 msec).\r\n   > \tat __randomizedtesting.SeedInfo.seed([934A6D0349D74193]:0)Throwable #2: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=1816, name=elasticsearch[org.elasticsearch.index.shard.IndexShardTests][index][T#1], state=RUNNABLE, group=TGRP-IndexShardTests]\r\n   > Caused by: java.lang.AssertionError: \r\n   > Expected: <92L>\r\n   >      but: was <93L>\r\n   > \tat __randomizedtesting.SeedInfo.seed([934A6D0349D74193]:0)\r\n   > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   > \tat org.elasticsearch.index.shard.IndexShardTests$9.onResponse(IndexShardTests.java:1000)\r\n   > \tat org.elasticsearch.index.shard.IndexShardTests$9.onResponse(IndexShardTests.java:996)\r\n   > \tat org.elasticsearch.index.shard.IndexShard$3.onResponse(IndexShard.java:2357)\r\n   > \tat org.elasticsearch.index.shard.IndexShard$3.onResponse(IndexShard.java:2337)\r\n   > \tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\r\n   > \tat org.elasticsearch.index.shard.IndexShardOperationPermits$PermitAwareThreadedActionListener$1.doRun(IndexShardOperationPermits.java:378)\r\n   > \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723)\r\n   > \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n   > \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThe failing assertion is here:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/5d0699b30f82bb410f3eb97c53efbd4e9b2a8fba/server/src/test/java/org/elasticsearch/index/shard/IndexShardTests.java#L1000\r\n\r\nThis might mean that the race fixed in #32442 is still present, or may be something else? @ywelsch do you have any thoughts?\r\n\r\nAlso I think we should release that `releasable` in a `finally` block rather than keeping hold of it and letting the suite time out when that assertion fails.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433377071","html_url":"https://github.com/elastic/elasticsearch/issues/34862#issuecomment-433377071","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34862","id":433377071,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzM3NzA3MQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-26T11:27:58Z","updated_at":"2018-10-26T11:27:58Z","author_association":"CONTRIBUTOR","body":"I added some more logging and left this test (in `master`) running for a while with `-Dtests.iters=1000` and it failed eventually in the same way:\r\n\r\n```\r\n  2> WARNING: Uncaught exception in thread: Thread[elasticsearch[org.elasticsearch.index.shard.IndexShardTests][write][T#1],5,TGRP-IndexShardTests]\r\n  2> java.lang.AssertionError:\r\n  2> Expected: <13L>\r\n  2>      but: was <14L>\r\n  2>    at __randomizedtesting.SeedInfo.seed([934A6D0349D74193]:0)\r\n  2>    at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n  2>    at org.junit.Assert.assertThat(Assert.java:956)\r\n  2>    at org.junit.Assert.assertThat(Assert.java:923)\r\n  2>    at org.elasticsearch.index.shard.IndexShardTests$10.onResponse(IndexShardTests.java:1057)\r\n  2>    at org.elasticsearch.index.shard.IndexShardTests$10.onResponse(IndexShardTests.java:1051)\r\n  2>    at org.elasticsearch.index.shard.IndexShard$3.onResponse(IndexShard.java:2387)\r\n  2>    at org.elasticsearch.index.shard.IndexShard$3.onResponse(IndexShard.java:2365)\r\n  2>    at org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\r\n  2>    at org.elasticsearch.index.shard.IndexShardOperationPermits$PermitAwareThreadedActionListener$1.doRun(IndexShardOperationPermits.java:374)\r\n  2>    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723)\r\n  2>    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n  2>    at java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n  2>    at java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n  2>    at java.base/java.lang.Thread.run(Thread.java:834)\r\n```\r\n\r\nExtra logging:\r\n\r\n```diff\r\ndiff --git a/server/src/test/java/org/elasticsearch/index/shard/IndexShardTests.java b/server/src/test/java/org/elasticsearch/index/shard/IndexShardTests.java\r\nindex 487ac7e..3ad2471 100644\r\n--- a/server/src/test/java/org/elasticsearch/index/shard/IndexShardTests.java\r\n+++ b/server/src/test/java/org/elasticsearch/index/shard/IndexShardTests.java\r\n@@ -125,6 +125,7 @@ import org.elasticsearch.test.FieldMaskingReader;\r\n import org.elasticsearch.test.VersionUtils;\r\n import org.elasticsearch.threadpool.ThreadPool;\r\n import org.elasticsearch.ElasticsearchException;\r\n+import org.elasticsearch.test.junit.annotations.TestLogging;\r\n\r\n import java.io.IOException;\r\n import java.nio.charset.Charset;\r\n@@ -1025,6 +1026,7 @@ public class IndexShardTests extends IndexShardTestCase {\r\n         closeShard(indexShard, false);\r\n     }\r\n\r\n+    @TestLogging(\"org.elasticsearch.index.shard:TRACE,org.elasticsearch.index.seqno:TRACE\")\r\n     public void testConcurrentTermIncreaseOnReplicaShard() throws BrokenBarrierException, InterruptedException, IOException {\r\n         final IndexShard indexShard = newStartedShard(false);\r\n\r\n@@ -1049,10 +1051,18 @@ public class IndexShardTests extends IndexShardTestCase {\r\n                     new ActionListener<Releasable>() {\r\n                         @Override\r\n                         public void onResponse(Releasable releasable) {\r\n-                            counter.incrementAndGet();\r\n-                            assertThat(indexShard.getPendingPrimaryTerm(), equalTo(primaryTerm + increment));\r\n-                            latch.countDown();\r\n-                            releasable.close();\r\n+                            logger.info(\"obtained replica operation permit for increment={}\", increment);\r\n+                            try {\r\n+                              counter.incrementAndGet();\r\n+                              assertThat(indexShard.getPendingPrimaryTerm(), equalTo(primaryTerm + increment));\r\n+                              logger.info(\"passed term check for increment={}\", increment);\r\n+                            } finally {\r\n+                              logger.info(\"counting down for increment={}\", increment);\r\n+                              latch.countDown();\r\n+                              logger.info(\"releasing replica operation permit for increment={}\", increment);\r\n+                              releasable.close();\r\n+                              logger.info(\"released replica operation permit for increment={}\", increment);\r\n+                            }\r\n                         }\r\n\r\n                         @Override\r\n@@ -1062,6 +1072,7 @@ public class IndexShardTests extends IndexShardTestCase {\r\n                         }\r\n                     },\r\n                     ThreadPool.Names.WRITE, \"\");\r\n+            logger.info(\"launched wait for increment={}\", increment);\r\n         };\r\n\r\n         final long firstIncrement = 1 + (randomBoolean() ? 0 : 1);\r\n@@ -1069,6 +1080,8 @@ public class IndexShardTests extends IndexShardTestCase {\r\n         final Thread first = new Thread(function.apply(firstIncrement));\r\n         final Thread second = new Thread(function.apply(secondIncrement));\r\n\r\n+        logger.info(\"firstIncrement={}, secondIncrement={}, primaryTerm={}\", firstIncrement, secondIncrement, primaryTerm);\r\n+\r\n         first.start();\r\n         second.start();\r\n```\r\n\r\nThe log from this run is:\r\n\r\n```\r\n  1> [2018-10-26T20:02:36,879][INFO ][o.e.i.s.IndexShardTests  ] [testConcurrentTermIncreaseOnReplicaShard] firstIncrement=2, secondIncrement=1, primaryTerm=12\r\n  1> [2018-10-26T20:02:36,879][INFO ][o.e.i.s.IndexShardTests  ] [[Thread-214]] launched wait for increment=1\r\n  1> [2018-10-26T20:02:36,879][INFO ][o.e.i.s.IndexShard       ] [org.elasticsearch.index.shard.IndexShardTests] [index][0] detected new primary with primary term [13], global checkpoint [-1], max_seq_no [-1]\r\n  1> [2018-10-26T20:02:36,880][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] obtained replica operation permit for increment=1\r\n  1> [2018-10-26T20:02:36,881][INFO ][o.e.i.s.IndexShardTests  ] [[Thread-213]] launched wait for increment=2\r\n  1> [2018-10-26T20:02:36,883][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] counting down for increment=1\r\n  1> [2018-10-26T20:02:36,883][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] releasing replica operation permit for increment=1\r\n  1> [2018-10-26T20:02:36,883][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] released replica operation permit for increment=1\r\n  1> [2018-10-26T20:02:36,883][INFO ][o.e.i.s.IndexShard       ] [org.elasticsearch.index.shard.IndexShardTests] [index][0] detected new primary with primary term [14], global checkpoint [-1], max_seq_no [-1]\r\n  1> [2018-10-26T20:02:36,884][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] obtained replica operation permit for increment=2\r\n  1> [2018-10-26T20:02:36,884][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] passed term check for increment=2\r\n  1> [2018-10-26T20:02:36,884][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] counting down for increment=2\r\n  1> [2018-10-26T20:02:36,884][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] releasing replica operation permit for increment=2\r\n  1> [2018-10-26T20:02:36,884][INFO ][o.e.i.s.IndexShardTests  ] [org.elasticsearch.index.shard.IndexShardTests] released replica operation permit for increment=2\r\n```\r\n\r\nNB the first check is the one that fails (lack of `passed term check` log message), apparently because the second term bump got in there first. Looks like a race, I've no idea if it's benign or not.","performed_via_github_app":null}]