{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24820","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24820/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24820/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24820/events","html_url":"https://github.com/elastic/elasticsearch/issues/24820","id":230248289,"node_id":"MDU6SXNzdWUyMzAyNDgyODk=","number":24820,"title":"Painless script don't have access to a _index variable and groovy is depreciated in 5.4","user":{"login":"infa-spritman","id":7199580,"node_id":"MDQ6VXNlcjcxOTk1ODA=","avatar_url":"https://avatars0.githubusercontent.com/u/7199580?v=4","gravatar_id":"","url":"https://api.github.com/users/infa-spritman","html_url":"https://github.com/infa-spritman","followers_url":"https://api.github.com/users/infa-spritman/followers","following_url":"https://api.github.com/users/infa-spritman/following{/other_user}","gists_url":"https://api.github.com/users/infa-spritman/gists{/gist_id}","starred_url":"https://api.github.com/users/infa-spritman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/infa-spritman/subscriptions","organizations_url":"https://api.github.com/users/infa-spritman/orgs","repos_url":"https://api.github.com/users/infa-spritman/repos","events_url":"https://api.github.com/users/infa-spritman/events{/privacy}","received_events_url":"https://api.github.com/users/infa-spritman/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-05-21T20:57:08Z","updated_at":"2017-05-21T22:41:18Z","closed_at":"2017-05-21T21:30:18Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.4\r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version**: 1.8.0_131\r\n\r\n**OS version**:  Windows 10\r\n\r\nDescription of the problem including expected versus actual behavior:\r\n\r\nAccording to the [docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-advanced-scripting.html), Text features, such as term or document frequency for a specific term can be accessed in scripts with the _index variable. When attempting this with a Painless script, I get a Variable [_index] is not defined. error.\r\n\r\n**Steps to reproduce:**\r\n\r\nExecute a query with a painless script that attempts to access _index, something like this:\r\n\r\n```\r\nGET /ap_dataset/document/_search\r\n{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": {\r\n        \"match\": {\r\n          \"text\": \"cow\"\r\n        }\r\n      },\r\n      \"boost_mode\": \"replace\",\r\n      \"functions\": [\r\n        {\r\n          \"script_score\": {\r\n            \"script\": {\r\n               \"lang\": \"painless\",\r\n               \"inline\": \"_index['text']['cow'].tf()\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\n**Provide logs (if relevant):**\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"script_exception\",\r\n        \"reason\": \"compile error\",\r\n        \"script_stack\": [\r\n          \"_index['text']['cow'].tf( ...\",\r\n          \"^---- HERE\"\r\n        ],\r\n        \"script\": \"_index['text']['cow'].tf()\",\r\n        \"lang\": \"painless\"\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"ap_dataset\",\r\n        \"node\": \"zhCmVrZgRC-YQU5BOaz49w\",\r\n        \"reason\": {\r\n          \"type\": \"query_shard_exception\",\r\n          \"reason\": \"script_score: the script could not be loaded\",\r\n          \"index_uuid\": \"-TpUstdDQVSZnLwvLKWkPA\",\r\n          \"index\": \"ap_dataset\",\r\n          \"caused_by\": {\r\n            \"type\": \"script_exception\",\r\n            \"reason\": \"compile error\",\r\n            \"script_stack\": [\r\n              \"_index['text']['cow'].tf( ...\",\r\n              \"^---- HERE\"\r\n            ],\r\n            \"script\": \"_index['text']['cow'].tf()\",\r\n            \"lang\": \"painless\",\r\n            \"caused_by\": {\r\n              \"type\": \"illegal_argument_exception\",\r\n              \"reason\": \"Variable [_index] is not defined.\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"status\": 400\r\n} \r\n```\r\nI tried using the groovy language, but it says \r\n**#! Deprecation: [groovy] scripts are deprecated, use [painless] scripts instead**\r\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}