{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27846","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27846/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27846/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27846/events","html_url":"https://github.com/elastic/elasticsearch/issues/27846","id":282535909,"node_id":"MDU6SXNzdWUyODI1MzU5MDk=","number":27846,"title":"Node lock is occasionally being lost","user":{"login":"617m4rc","id":1398799,"node_id":"MDQ6VXNlcjEzOTg3OTk=","avatar_url":"https://avatars1.githubusercontent.com/u/1398799?v=4","gravatar_id":"","url":"https://api.github.com/users/617m4rc","html_url":"https://github.com/617m4rc","followers_url":"https://api.github.com/users/617m4rc/followers","following_url":"https://api.github.com/users/617m4rc/following{/other_user}","gists_url":"https://api.github.com/users/617m4rc/gists{/gist_id}","starred_url":"https://api.github.com/users/617m4rc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/617m4rc/subscriptions","organizations_url":"https://api.github.com/users/617m4rc/orgs","repos_url":"https://api.github.com/users/617m4rc/repos","events_url":"https://api.github.com/users/617m4rc/events{/privacy}","received_events_url":"https://api.github.com/users/617m4rc/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-12-15T20:14:29Z","updated_at":"2018-08-02T11:20:58Z","closed_at":"2018-01-12T15:26:54Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nVersion: 5.6.5, Build: 6a37571/2017-12-04T07:50:10.466Z, JVM: 1.8.0_144\r\n\r\n**Plugins installed**: \r\n\r\n[]\r\n\r\n**JVM version** (`java -version`):\r\n\r\njava version \"1.8.0_144\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_144-b01)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nOS Name:                   Microsoft Windows Server 2008 R2 Enterprise\r\nOS Version:                6.1.7601 Service Pack 1 Build 7601\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nElasticsearch 5.6.5 occasionally reports a failed lock assertion during the startup, or shortly after the startup has finished. We have already ruled out the possiblity of another application tampering with the lock file. We did not face such a behavior with elasticsearch 2.x.\r\n\r\n**Steps to reproduce**:\r\n\r\nStart and stop the application repeatedly and at frequent intervals.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[20:06:14,200][INFO ][o.e.n.Node               ] [ANAME] started\r\n[20:06:14,200][DEBUG][o.e.i.s.IndexShard       ] [ANAME] [anindex][4] state: [CREATED]\r\n[20:06:14,216][TRACE][o.e.i.s.IndexShard       ] [ANAME] [anindex][4] [anindex][4] writing shard state, reason [initial state with allocation id [[id=Io2ngdY8RlqG9s_LM-zquA]]]\r\n[20:06:14,231][DEBUG][o.e.i.s.IndexShard       ] [ANAME] [anindex][4] state: [CREATED]->[RECOVERING], reason [from store]\r\n[20:06:14,231][DEBUG][o.e.i.c.IndicesClusterStateService] [ANAME] [anindex][3] creating shard\r\n[20:06:14,231][TRACE][o.e.e.NodeEnvironment    ] [ANAME] acquiring node shardlock on [[anindex][3]], timeout [5000]\r\n[20:06:14,231][TRACE][o.e.e.NodeEnvironment    ] [ANAME] successfully acquired shardlock for [[anindex][3]]\r\n[20:06:14,231][DEBUG][o.e.i.s.IndexShard       ] [ANAME] [anindex][4] starting recovery from store ...\r\n[20:06:14,231][DEBUG][i.n.b.AbstractByteBuf    ] -Dio.netty.buffer.bytebuf.checkAccessible: true\r\n[20:06:14,247][DEBUG][i.n.u.ResourceLeakDetectorFactory] Loaded default ResourceLeakDetector: io.netty.util.ResourceLeakDetector@33678879\r\n[20:06:14,231][WARN ][o.e.e.NodeEnvironment    ] [ANAME] lock assertion failed\r\njava.io.IOException: The handle is invalid\r\n            at sun.nio.ch.FileDispatcherImpl.size0(Native Method) ~[?:?]\r\n            at sun.nio.ch.FileDispatcherImpl.size(FileDispatcherImpl.java:97) ~[?:?]\r\n            at sun.nio.ch.FileChannelImpl.size(FileChannelImpl.java:310) ~[?:?]\r\n            at org.apache.lucene.store.NativeFSLockFactory$NativeFSLock.ensureValid(NativeFSLockFactory.java:170) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n            at org.elasticsearch.env.NodeEnvironment.assertEnvIsLocked(NodeEnvironment.java:941) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.env.NodeEnvironment.availableShardPaths(NodeEnvironment.java:804) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.index.shard.ShardPath.loadShardPath(ShardPath.java:114) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.index.IndexService.createShard(IndexService.java:298) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.IndicesService.createShard(IndicesService.java:499) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.IndicesService.createShard(IndicesService.java:147) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.cluster.IndicesClusterStateService.createShard(IndicesClusterStateService.java:542) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.cluster.IndicesClusterStateService.createOrUpdateShards(IndicesClusterStateService.java:519) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyClusterState(IndicesClusterStateService.java:204) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService.callClusterStateAppliers(ClusterService.java:814) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:768) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:587) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService$ClusterServiceTaskBatcher.run(ClusterService.java:263) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:247) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:210) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]\r\n            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]\r\n            at java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]\r\n[20:06:14,247][WARN ][o.e.i.IndexService       ] [ANAME] [anindex] [anindex][3] failed to load shard path, trying to remove leftover\r\n[20:06:14,247][TRACE][o.e.e.NodeEnvironment    ] [ANAME] shard lock wait count for [anindex][3] is now [0]\r\n[20:06:14,247][TRACE][o.e.e.NodeEnvironment    ] [ANAME] last shard lock wait decremented, removing lock for [anindex][3]\r\n[20:06:14,247][TRACE][o.e.e.NodeEnvironment    ] [ANAME] released shard lock for [[anindex][3]]\r\n[20:06:14,247][TRACE][o.e.i.IndexService       ] [ANAME] [anindex] [3] store not initialized prior to closing shard, nothing to close\r\n[20:06:14,247][WARN ][o.e.i.c.IndicesClusterStateService] [ANAME] [[anindex][3]] marking and sending shard failed due to [failed to create shard]\r\njava.lang.IllegalStateException: environment is not locked\r\n            at org.elasticsearch.env.NodeEnvironment.assertEnvIsLocked(NodeEnvironment.java:944) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.env.NodeEnvironment.availableShardPaths(NodeEnvironment.java:804) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.index.shard.ShardPath.loadShardPath(ShardPath.java:114) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.index.IndexService.createShard(IndexService.java:298) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.IndicesService.createShard(IndicesService.java:499) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.IndicesService.createShard(IndicesService.java:147) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.cluster.IndicesClusterStateService.createShard(IndicesClusterStateService.java:542) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.cluster.IndicesClusterStateService.createOrUpdateShards(IndicesClusterStateService.java:519) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyClusterState(IndicesClusterStateService.java:204) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService.callClusterStateAppliers(ClusterService.java:814) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:768) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:587) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.ClusterService$ClusterServiceTaskBatcher.run(ClusterService.java:263) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:247) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:210) [elasticsearch-5.6.5.jar:5.6.5]\r\n            at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]\r\n            at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]\r\n            at java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]\r\n            Suppressed: org.apache.lucene.store.AlreadyClosedException: Unexpected lock file size: 162, (lock=NativeFSLock(path=D:\\APATH\\data\\nodes\\0\\node.lock,impl=sun.nio.ch.FileLockImpl[0:9223372036854775807 exclusive valid],creationTime=18:58:30.65886Z))\r\n                        at org.apache.lucene.store.NativeFSLockFactory$NativeFSLock.ensureValid(NativeFSLockFactory.java:172) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n                        at org.elasticsearch.env.NodeEnvironment.assertEnvIsLocked(NodeEnvironment.java:941) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.env.NodeEnvironment.availableShardPaths(NodeEnvironment.java:804) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.index.shard.ShardPath.deleteLeftoverShardDirectory(ShardPath.java:153) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.index.IndexService.createShard(IndexService.java:302) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.indices.IndicesService.createShard(IndicesService.java:499) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.indices.IndicesService.createShard(IndicesService.java:147) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.indices.cluster.IndicesClusterStateService.createShard(IndicesClusterStateService.java:542) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.indices.cluster.IndicesClusterStateService.createOrUpdateShards(IndicesClusterStateService.java:519) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyClusterState(IndicesClusterStateService.java:204) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.cluster.service.ClusterService.callClusterStateAppliers(ClusterService.java:814) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:768) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:587) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.cluster.service.ClusterService$ClusterServiceTaskBatcher.run(ClusterService.java:263) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:247) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:210) [elasticsearch-5.6.5.jar:5.6.5]\r\n                        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]\r\n                        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]\r\n                        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]\r\nCaused by: java.io.IOException: The handle is invalid\r\n            at sun.nio.ch.FileDispatcherImpl.size0(Native Method) ~[?:?]\r\n            at sun.nio.ch.FileDispatcherImpl.size(FileDispatcherImpl.java:97) ~[?:?]\r\n            at sun.nio.ch.FileChannelImpl.size(FileChannelImpl.java:310) ~[?:?]\r\n            at org.apache.lucene.store.NativeFSLockFactory$NativeFSLock.ensureValid(NativeFSLockFactory.java:170) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n            at org.elasticsearch.env.NodeEnvironment.assertEnvIsLocked(NodeEnvironment.java:941) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n            ... 20 more\r\n```","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}