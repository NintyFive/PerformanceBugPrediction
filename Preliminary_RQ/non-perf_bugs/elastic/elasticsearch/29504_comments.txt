[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/381069248","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-381069248","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":381069248,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MTA2OTI0OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-13T08:49:11Z","updated_at":"2018-04-13T08:49:11Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/381126640","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-381126640","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":381126640,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MTEyNjY0MA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-04-13T12:56:24Z","updated_at":"2018-04-13T13:02:21Z","author_association":"MEMBER","body":"You are right: Your young generation size is quite small, however that is an ergonomic choice of the JVM an we do not want to override its default choice. Hence I'll close the ticket because we will not change anything in Elasticsearch.\r\n\r\nHowever, I want to explain what (I think) is going on.\r\n\r\n### Reproduction\r\n\r\nI tried to reproduce your scenario on a machine with 32GB of RAM and 4 physical cores (8 with hyperthreading).\r\n\r\nI ran:\r\n\r\n```\r\ndocker run -p 9200:9200 -p 9300:9300 -e \"discovery.type=single-node\" -e ES_JAVA_OPTS=\"-Xms18g -Xmx18g\" docker.elastic.co/elasticsearch/elasticsearch:6.2.3\r\n```\r\n\r\nin the gc.log we see:\r\n\r\n```\r\nCommandLine flags: -XX:+AlwaysPreTouch -XX:CMSInitiatingOccupancyFraction=75 -XX:GCLogFileSize=67108864 -XX:+HeapDumpOnOutOfMemoryError -XX:InitialHeapSize=19327352832 -XX:MaxHeapSize=19327352832 -XX:MaxNewSize=697933824 -XX:MaxTenuringThreshold=6 -XX:NewSize=697933824 -XX:NumberOfGCLogFiles=32 -XX:OldPLABSize=16 -XX:OldSize=1395867648 -XX:-OmitStackTraceInFastThrow -XX:+PrintGC -XX:+PrintGCApplicationStoppedTime -XX:+PrintGCDateStamps -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintTenuringDistribution -XX:ThreadStackSize=1024 -XX:+UseCMSInitiatingOccupancyOnly -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseConcMarkSweepGC -XX:+UseGCLogFileRotation -XX:+UseParNewGC\r\n```\r\n\r\nThe node stats show:\r\n\r\n```json\r\n{\r\n        \"mem\" : {\r\n          \"heap_used_in_bytes\" : 494350496,\r\n          \"heap_used_percent\" : 2,\r\n          \"heap_committed_in_bytes\" : 19257622528,\r\n          \"heap_max_in_bytes\" : 19257622528,\r\n          \"non_heap_used_in_bytes\" : 99471720,\r\n          \"non_heap_committed_in_bytes\" : 107511808,\r\n          \"pools\" : {\r\n            \"young\" : {\r\n              \"used_in_bytes\" : 413565824,\r\n              \"max_in_bytes\" : 558432256,\r\n              \"peak_used_in_bytes\" : 558432256,\r\n              \"peak_max_in_bytes\" : 558432256\r\n            },\r\n            \"survivor\" : {\r\n              \"used_in_bytes\" : 36792080,\r\n              \"max_in_bytes\" : 69730304,\r\n              \"peak_used_in_bytes\" : 60211504,\r\n              \"peak_max_in_bytes\" : 69730304\r\n            },\r\n            \"old\" : {\r\n              \"used_in_bytes\" : 43992592,\r\n              \"max_in_bytes\" : 18629459968,\r\n              \"peak_used_in_bytes\" : 43992592,\r\n              \"peak_max_in_bytes\" : 18629459968\r\n            }\r\n          }\r\n        }\r\n}\r\n```\r\n\r\nAdding young (which is more appropriately: Eden) + 2 * survivor (there are two survivor spaces) gives 558432256 + 2*69730304 = 697892864 bytes = 665MB.\r\n\r\nIf I try the following on the command line:\r\n\r\n```\r\njava -Xms18G -Xmx18G -XX:+UseConcMarkSweepGC -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | egrep -i \"(NewSize|OldSize)\"\r\n    uintx MaxNewSize                               := 697892864                           {product}\r\n    uintx NewSize                                  := 697892864                           {product}\r\n    uintx NewSizeThreadIncrease                     = 5320                                {pd product}\r\n    uintx OldSize                                  := 18629459968                         {product}\r\n```\r\n\r\nI get the same value for `NewSize` this matches the calculation and the output in the gc log file.\r\n\r\nThe question is now: Why do you get a (vastly) different value? Let's turn to the JVM source code. The relevant piece of code is in [/src/share/vm/runtime/arguments.cpp#l1265](http://hg.openjdk.java.net/jdk8u/jdk8u60/hotspot/file/37240c1019fd/src/share/vm/runtime/arguments.cpp#l1265):\r\n\r\n```c++\r\nconst size_t preferred_max_new_size_unaligned =\r\n    MIN2(max_heap/(NewRatio+1), ScaleForWordSize(young_gen_per_worker * parallel_gc_threads));\r\n```\r\n\r\nwith such a large heap, only the part `ScaleForWordSize(young_gen_per_worker * parallel_gc_threads)` matters as the JVM will use the minimum of the two terms.  The parameters for that term are: \r\n\r\n* `young_gen_per_worker` is 64MB for x86_64.\r\n* `parallel_gc_threads` is (again) chosen ergonomically by the JVM. \r\n\r\nYou can check the latter for your environment with:\r\n\r\n```\r\njava -Xms18G -Xmx18G -XX:+UseConcMarkSweepGC -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep -i \"ParallelGCThreads\"\r\n```\r\n\r\nOn my machine it says:\r\n\r\n```\r\n    uintx ParallelGCThreads                         = 8                                   {product}\r\n```\r\n\r\nIf I explicitly set `ParallelGCThreads` to 2, I get a size that is very similar to yours (yours was 174485504 bytes, mine is 174456832 bytes):\r\n\r\n```\r\njava -Xms18G -Xmx18G -XX:ParallelGCThreads=2 -XX:+UseConcMarkSweepGC -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | egrep -i \"(NewSize|OldSize)\"\r\n    uintx MaxNewSize                               := 174456832                           {product}\r\n    uintx NewSize                                  := 174456832                           {product}\r\n    uintx NewSizeThreadIncrease                     = 5320                                {pd product}\r\n    uintx OldSize                                  := 19152896000                         {product}\r\n```\r\n\r\n### Next steps for you\r\n\r\nyou should check whether the number of `ParallelGCThreads` is indeed as low as I think it is.\r\n\r\n```\r\njava -Xms18G -Xmx18G -XX:+UseConcMarkSweepGC -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep -i \"ParallelGCThreads\"\r\n```\r\n\r\nThis is probably due to the number of CPUs on the system.\r\n\r\nYou can now either use a different system with more CPUs or manually increase the size of the young generation via an explicit JVM flag. However, you should keep in mind that due to the low number of GC threads you might get into trouble later (I'd not be surprised about long GC pauses because of that).\r\n\r\nBtw, I saw your WTF comment in https://hub.docker.com/r/davidkarlsen/elasticsearchhq/~/dockerfile/. According to the docs, the setting you're referring to (`xpack.reporting.enabled`) is intended for `kibana.yml` and unknown to Elasticsearch that's why Elasticsearch complains upon startup.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/381225974","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-381225974","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":381225974,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MTIyNTk3NA==","user":{"login":"davidkarlsen","id":18299,"node_id":"MDQ6VXNlcjE4Mjk5","avatar_url":"https://avatars0.githubusercontent.com/u/18299?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkarlsen","html_url":"https://github.com/davidkarlsen","followers_url":"https://api.github.com/users/davidkarlsen/followers","following_url":"https://api.github.com/users/davidkarlsen/following{/other_user}","gists_url":"https://api.github.com/users/davidkarlsen/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkarlsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkarlsen/subscriptions","organizations_url":"https://api.github.com/users/davidkarlsen/orgs","repos_url":"https://api.github.com/users/davidkarlsen/repos","events_url":"https://api.github.com/users/davidkarlsen/events{/privacy}","received_events_url":"https://api.github.com/users/davidkarlsen/received_events","type":"User","site_admin":false},"created_at":"2018-04-13T18:40:17Z","updated_at":"2018-04-13T18:40:17Z","author_association":"NONE","body":"Thank you very much for the thorough and knowledgeable response. \r\n\r\nNum GC-threads was indeed 2, on my 4-core (non-hyperthreading) box - and the reason for that is that cpus have been added hot-plugged and the docker daemon not restarted, so I went to /proc...cpuset and enabled all cpus doing echo 0-3 into cpuset, and recreated the container in order to get a fresh java process with an updated view on the world, and indeed I now have 4 gc-threads (along with larger regions). The effect is very apparent and the young-gen gc immediately halved. Additionally I have requested to flip the CPUs over to hyperthreading (as this is a virtual environment) - so I expect to get even better figures after that.\r\n\r\nThe gc monitor can still kick in when I do a search over 24hr worth of data, but the searches will complete and it stabilizes (this is a mostly write env).\r\n\r\nAgain - thanks a lot for the explanation!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/381493392","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-381493392","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":381493392,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MTQ5MzM5Mg==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-04-16T06:31:27Z","updated_at":"2018-04-16T06:31:27Z","author_association":"MEMBER","body":"You're welcome, glad that it helped you.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406179770","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-406179770","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":406179770,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjE3OTc3MA==","user":{"login":"ezraroi","id":5808368,"node_id":"MDQ6VXNlcjU4MDgzNjg=","avatar_url":"https://avatars1.githubusercontent.com/u/5808368?v=4","gravatar_id":"","url":"https://api.github.com/users/ezraroi","html_url":"https://github.com/ezraroi","followers_url":"https://api.github.com/users/ezraroi/followers","following_url":"https://api.github.com/users/ezraroi/following{/other_user}","gists_url":"https://api.github.com/users/ezraroi/gists{/gist_id}","starred_url":"https://api.github.com/users/ezraroi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ezraroi/subscriptions","organizations_url":"https://api.github.com/users/ezraroi/orgs","repos_url":"https://api.github.com/users/ezraroi/repos","events_url":"https://api.github.com/users/ezraroi/events{/privacy}","received_events_url":"https://api.github.com/users/ezraroi/received_events","type":"User","site_admin":false},"created_at":"2018-07-19T07:20:19Z","updated_at":"2018-07-19T07:20:19Z","author_association":"NONE","body":"So on 4 cores machine it is not recommended to run elastic with heap size of 30G? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406225799","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-406225799","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":406225799,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjIyNTc5OQ==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-07-19T10:08:18Z","updated_at":"2018-07-19T10:08:18Z","author_association":"MEMBER","body":"> So on 4 cores machine it is not recommended to run elastic with heap size of 30G?\r\n\r\nI think that conclusion is oversimplifying [my analysis](https://github.com/elastic/elasticsearch/issues/29504#issuecomment-381126640). The JVM chooses the number of GC threads ergonomically and also bases the young generation size on this decision. With a small number of cores you end up with less GC threads and thus a smaller young generation. Consequently, it will promote objects earlier from the young generation to the old generation (because there is less space available for the objects that are still alive in the young generation).  You need to measure the performance impact in your scenario, decide whether you are satisfied and if not potentially tune the GC / heap settings.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406495309","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-406495309","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":406495309,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjQ5NTMwOQ==","user":{"login":"ezraroi","id":5808368,"node_id":"MDQ6VXNlcjU4MDgzNjg=","avatar_url":"https://avatars1.githubusercontent.com/u/5808368?v=4","gravatar_id":"","url":"https://api.github.com/users/ezraroi","html_url":"https://github.com/ezraroi","followers_url":"https://api.github.com/users/ezraroi/followers","following_url":"https://api.github.com/users/ezraroi/following{/other_user}","gists_url":"https://api.github.com/users/ezraroi/gists{/gist_id}","starred_url":"https://api.github.com/users/ezraroi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ezraroi/subscriptions","organizations_url":"https://api.github.com/users/ezraroi/orgs","repos_url":"https://api.github.com/users/ezraroi/repos","events_url":"https://api.github.com/users/ezraroi/events{/privacy}","received_events_url":"https://api.github.com/users/ezraroi/received_events","type":"User","site_admin":false},"created_at":"2018-07-20T05:44:45Z","updated_at":"2018-07-20T05:44:45Z","author_association":"NONE","body":"yes but what we see is that the JVM is 65% of the time doing GC on the young generation as most of the time our data nodes are doing heavy load writing which makes them very slow","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406759949","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-406759949","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":406759949,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjc1OTk0OQ==","user":{"login":"pySilver","id":1113925,"node_id":"MDQ6VXNlcjExMTM5MjU=","avatar_url":"https://avatars1.githubusercontent.com/u/1113925?v=4","gravatar_id":"","url":"https://api.github.com/users/pySilver","html_url":"https://github.com/pySilver","followers_url":"https://api.github.com/users/pySilver/followers","following_url":"https://api.github.com/users/pySilver/following{/other_user}","gists_url":"https://api.github.com/users/pySilver/gists{/gist_id}","starred_url":"https://api.github.com/users/pySilver/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pySilver/subscriptions","organizations_url":"https://api.github.com/users/pySilver/orgs","repos_url":"https://api.github.com/users/pySilver/repos","events_url":"https://api.github.com/users/pySilver/events{/privacy}","received_events_url":"https://api.github.com/users/pySilver/received_events","type":"User","site_admin":false},"created_at":"2018-07-21T01:12:42Z","updated_at":"2018-07-21T01:12:42Z","author_association":"NONE","body":"I'm observing the opposite behavior while trying to solve high CPU usage. Server is the huge: 48 CPU, 256GB RAM (https://www.hetzner.com/dedicated-rootserver/ax160/configurator) with fast NVI SSD.\r\n\r\nHere is the stats of 5 nodes (they all live on that single server for now, having 20GB ram each). They eventually will migrate to separate smaller nodes, I'm trying to solve the problem asap.\r\n\r\n```\r\n$ curl -X GET \"localhost:9200/_cat/nodes?v\"\r\nip        heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name\r\n127.0.0.1           23          87  93   69.45   64.85    56.70 mdi       *      node1\r\n127.0.0.1           12          87  85   69.45   64.85    56.70 mdi       -      node4\r\n127.0.0.1           17          87  85   69.45   64.85    56.70 mdi       -      node5\r\n127.0.0.1           14          87  85   69.45   64.85    56.70 mdi       -      node3\r\n127.0.0.1           11          87  85   69.45   64.85    56.70 mdi       -      node2\r\n\r\n\r\n$ curl -X GET \"localhost:9200/_cat/allocation?v\"\r\nshards disk.indices disk.used disk.avail disk.total disk.percent host      ip        node\r\n     9       10.7gb   314.6gb    560.9gb    875.5gb           35 127.0.0.1 127.0.0.1 node5\r\n     9       10.4gb   314.6gb    560.9gb    875.5gb           35 127.0.0.1 127.0.0.1 node3\r\n     9       10.3gb   314.6gb    560.9gb    875.5gb           35 127.0.0.1 127.0.0.1 node2\r\n     9       10.2gb   314.6gb    560.9gb    875.5gb           35 127.0.0.1 127.0.0.1 node4\r\n     9       10.4gb   314.6gb    560.8gb    875.5gb           35 127.0.0.1 127.0.0.1 node1\r\n\r\n$ curl -X GET \"localhost:9200/_cat/health?v\"\r\nepoch      timestamp cluster       status node.total node.data shards pri relo init unassign pending_tasks max_task_wait_time active_shards_percent\r\n1532135075 01:04:35  elasticsearch green           5         5     45  45    0    0        0             0                  -                100.0%\r\n\r\n# root @ cmc-web-1 in /var/log/elasticsearch [0:55:28]\r\n$ java -Xms18G -Xmx18G -XX:+UseConcMarkSweepGC -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | grep -i \"ParallelGCThreads\"\r\n    uintx ParallelGCThreads                         = 33                                  {product}\r\nopenjdk version \"1.8.0_171\"\r\nOpenJDK Runtime Environment (build 1.8.0_171-8u171-b11-0ubuntu0.16.04.1-b11)\r\nOpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n\r\n# root @ cmc-web-1 in /var/log/elasticsearch [0:56:15]\r\n$ java -Xms18G -Xmx18G -XX:ParallelGCThreads=2 -XX:+UseConcMarkSweepGC -XX:+UnlockDiagnosticVMOptions -XX:+PrintFlagsFinal -version | egrep -i \"(NewSize|OldSize)\"\r\n    uintx MaxNewSize                               := 174456832                           {product}\r\n    uintx NewSize                                  := 174456832                           {product}\r\n    uintx NewSizeThreadIncrease                     = 5320                                {pd product}\r\n    uintx OldSize                                  := 19152896000                         {product}\r\nopenjdk version \"1.8.0_171\"\r\nOpenJDK Runtime Environment (build 1.8.0_171-8u171-b11-0ubuntu0.16.04.1-b11)\r\nOpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n\r\n# root @ cmc-web-1 in /var/log/elasticsearch [1:04:35]\r\n$ curl -X GET \"localhost:9200/\"\r\n{\r\n  \"name\" : \"node1\",\r\n  \"cluster_name\" : \"elasticsearch\",\r\n  \"cluster_uuid\" : \"gva6U2gLR6mozUzJHkUR5g\",\r\n  \"version\" : {\r\n    \"number\" : \"6.1.4\",\r\n    \"build_hash\" : \"d838f2d\",\r\n    \"build_date\" : \"2018-03-14T08:28:22.470Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"7.1.0\",\r\n    \"minimum_wire_compatibility_version\" : \"5.6.0\",\r\n    \"minimum_index_compatibility_version\" : \"5.0.0\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n```\r\n\r\nhtop constantly says each node eats 300+% of CPU. Logs of each nodes shows that GC runs 3-4 times a minute (not always, it may occupy one node and leave in peace the other for a while..). As you can see I've allocated x2 more ram than size of data.\r\n\r\nIts not a high traffic website yet, 6–10K pageviews per day, each pageview triggers search across e-commerce products database with *lots of aggregations*. Portion of the queries uses random_score sorting.\r\n\r\nI will highly appreciate any directions - what logs should I investigate to find out what causes this problem. Thank you!\r\n\r\nTypical Query:\r\n```\r\n{\r\n    \"from\": 0,\r\n    \"size\": 248,\r\n    \"sort\": [\r\n        {\r\n            \"meta._product_popularity.long\": {\r\n                \"order\": \"desc\"\r\n            }\r\n        }\r\n    ],\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"bool\": {\r\n                        \"must\": [\r\n                            {\r\n                                \"terms\": {\r\n                                    \"terms.product_cat.slug\": [\r\n                                        \"majtki-damskie-koronkowe\",\r\n                                        \"majtki-damskie-szorty\",\r\n                                        \"panty-damskie\",\r\n                                        \"majtki-damskie\",\r\n                                        \"bokserki-damskie\",\r\n                                        \"figi\",\r\n                                        \"stringi\"\r\n                                    ]\r\n                                }\r\n                            }\r\n                        ],\r\n                        \"must_not\": [\r\n                            {\r\n                                \"terms\": {\r\n                                    \"terms.product_visibility.term_taxonomy_id\": [\r\n                                        3293\r\n                                    ]\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                },\r\n                {\r\n                    \"term\": {\r\n                        \"post_type.raw\": \"product\"\r\n                    }\r\n                },\r\n                {\r\n                    \"terms\": {\r\n                        \"post_status\": [\r\n                            \"publish\",\r\n                            \"acf-disabled\"\r\n                        ]\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"post_filter\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"bool\": {\r\n                        \"must\": [\r\n                            {\r\n                                \"terms\": {\r\n                                    \"terms.product_cat.slug\": [\r\n                                        \"majtki-damskie-koronkowe\",\r\n                                        \"majtki-damskie-szorty\",\r\n                                        \"panty-damskie\",\r\n                                        \"majtki-damskie\",\r\n                                        \"bokserki-damskie\",\r\n                                        \"figi\",\r\n                                        \"stringi\"\r\n                                    ]\r\n                                }\r\n                            }\r\n                        ],\r\n                        \"must_not\": [\r\n                            {\r\n                                \"terms\": {\r\n                                    \"terms.product_visibility.term_taxonomy_id\": [\r\n                                        3293\r\n                                    ]\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                },\r\n                {\r\n                    \"term\": {\r\n                        \"post_type.raw\": \"product\"\r\n                    }\r\n                },\r\n                {\r\n                    \"terms\": {\r\n                        \"post_status\": [\r\n                            \"publish\",\r\n                            \"acf-disabled\"\r\n                        ]\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"aggs\": {\r\n        \"pa_brand\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"pa_brand\": {\r\n                    \"terms\": {\r\n                        \"size\": \"6952\",\r\n                        \"field\": \"terms.pa_brand.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"pa_brand\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.pa_brand\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"pa_color\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"pa_color\": {\r\n                    \"terms\": {\r\n                        \"size\": \"11\",\r\n                        \"field\": \"terms.pa_color.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"pa_color\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.pa_color\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"pa_merchant\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"pa_merchant\": {\r\n                    \"terms\": {\r\n                        \"size\": \"116\",\r\n                        \"field\": \"terms.pa_merchant.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"pa_merchant\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.pa_merchant\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"pa_wzor\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"pa_wzor\": {\r\n                    \"terms\": {\r\n                        \"size\": \"24\",\r\n                        \"field\": \"terms.pa_wzor.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"pa_wzor\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.pa_wzor\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"pa_material\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"pa_material\": {\r\n                    \"terms\": {\r\n                        \"size\": \"54\",\r\n                        \"field\": \"terms.pa_material.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"pa_material\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.pa_material\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"pa_rozmiar\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"pa_rozmiar\": {\r\n                    \"terms\": {\r\n                        \"size\": \"9\",\r\n                        \"field\": \"terms.pa_rozmiar.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"pa_rozmiar\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.pa_rozmiar\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"product_cat\": {\r\n            \"filter\": {\r\n                \"match_all\": {\r\n                    \"boost\": 1\r\n                }\r\n            },\r\n            \"aggs\": {\r\n                \"product_cat\": {\r\n                    \"terms\": {\r\n                        \"size\": \"750\",\r\n                        \"field\": \"terms.product_cat.slug\",\r\n                        \"order\": {\r\n                            \"_term\": \"asc\"\r\n                        }\r\n                    },\r\n                    \"aggs\": {\r\n                        \"product_cat\": {\r\n                            \"top_hits\": {\r\n                                \"size\": 1,\r\n                                \"_source\": [\r\n                                    \"terms.product_cat\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"price\": {\r\n            \"aggs\": {\r\n                \"percentiles\": {\r\n                    \"percentiles\": {\r\n                        \"field\": \"meta._price.long\"\r\n                    }\r\n                },\r\n                \"min\": {\r\n                    \"min\": {\r\n                        \"field\": \"meta._price.long\"\r\n                    }\r\n                },\r\n                \"max\": {\r\n                    \"max\": {\r\n                        \"field\": \"meta._price.long\"\r\n                    }\r\n                }\r\n            },\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            }\r\n        },\r\n        \"discount\": {\r\n            \"filter\": {\r\n                \"bool\": {\r\n                    \"must\": [\r\n                        {\r\n                            \"range\": {\r\n                                \"meta._sale_price.long\": {\r\n                                    \"gt\": 0\r\n                                }\r\n                            }\r\n                        },\r\n                        {\r\n                            \"terms\": {\r\n                                \"terms.product_cat.slug\": [\r\n                                    \"majtki-damskie-koronkowe\",\r\n                                    \"majtki-damskie-szorty\",\r\n                                    \"panty-damskie\",\r\n                                    \"majtki-damskie\",\r\n                                    \"bokserki-damskie\",\r\n                                    \"figi\",\r\n                                    \"stringi\"\r\n                                ]\r\n                            }\r\n                        }\r\n                    ]\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/572674243","html_url":"https://github.com/elastic/elasticsearch/issues/29504#issuecomment-572674243","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29504","id":572674243,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MjY3NDI0Mw==","user":{"login":"shawnregan","id":15198851,"node_id":"MDQ6VXNlcjE1MTk4ODUx","avatar_url":"https://avatars1.githubusercontent.com/u/15198851?v=4","gravatar_id":"","url":"https://api.github.com/users/shawnregan","html_url":"https://github.com/shawnregan","followers_url":"https://api.github.com/users/shawnregan/followers","following_url":"https://api.github.com/users/shawnregan/following{/other_user}","gists_url":"https://api.github.com/users/shawnregan/gists{/gist_id}","starred_url":"https://api.github.com/users/shawnregan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shawnregan/subscriptions","organizations_url":"https://api.github.com/users/shawnregan/orgs","repos_url":"https://api.github.com/users/shawnregan/repos","events_url":"https://api.github.com/users/shawnregan/events{/privacy}","received_events_url":"https://api.github.com/users/shawnregan/received_events","type":"User","site_admin":false},"created_at":"2020-01-09T17:46:18Z","updated_at":"2020-01-09T17:50:31Z","author_association":"NONE","body":"Leaving this here for anyone seeing excessive GC after upgrading to ES6 using JDK8. In my searching I came across this github article but needed more to find our solution. For us we have a 5 node cluster each with 32GB Ram and each has a Heap of 16G and the young gen was only 600M. Not sure exactly our setting for young gen before the upgrade. ES6, for us anyway, uses a ton of young gen but not so much old gen. So setting the newRatio=1 along with the other changes mentioned in the article below gave us our solution. \r\n\r\nFirst step would be to upload your current log to gceasy.io and see what's going on. For us we were getting about 4-5 full GCs per day and the graph showed that we are maxing the young gen immediately and old gen was fairly full. Our issue in a nutshell\r\n\r\n\"When the young generation is undersized, objects will be prematurely promoted to the old generation. Collecting garbage from the old generation takes more time than collecting it from the young generation. Thus, increasing the young generation size has the potential to reduce long GC pauses.\"\r\n\r\nChanges to make per node (also should uncomment the logging entries):\r\n- jvm.options\r\n## GC configuration\r\n-XX:+UseConcMarkSweepGC\r\n-XX:CMSInitiatingOccupancyFraction=50    # <= changed from 75\r\n-XX:+UseCMSInitiatingOccupancyOnly\r\n-XX:NewRatio=1  # <= set to 1\r\n-XX:ParallelGCThreads=8 <= set to match the number of CPUs\r\n\r\n(With the NewRatio set to 1 this gave our young and old gen each 50% of the heap. Young gen went from 600M to 8G for us)\r\n \r\n- elasticsearch.yml add this\r\nindices.memory.index_buffer_size: 20%\r\n\r\nAnd using a curl command change this setting for the cluster:\r\n index.refresh_interval to 30s\r\n\r\ncurl -XPUT -u es_admin:your_passwd   -H \"Content-Type: application/json\" 'https://127.0.0.1:9200/_all/_settings?preserve_existing=true' -d '{\"index.refresh_interval\" : \"30s\"}' -k\r\n\r\nWould be good to mv or rm your old gc log files so as to be sure you have a fresh new one after the node restart to upload for analysis.\r\n\r\nAfter restarting your cluster let run for at least an hour with traffic and upload your gc.log to gceasy.io and see how they are doing.\r\n\r\nArticle that saved us: https://e-mc2.net/elasticsearch-garbage-collection-hell","performed_via_github_app":null}]