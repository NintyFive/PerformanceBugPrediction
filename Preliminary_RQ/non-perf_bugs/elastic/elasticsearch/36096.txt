{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36096","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36096/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36096/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36096/events","html_url":"https://github.com/elastic/elasticsearch/issues/36096","id":385987705,"node_id":"MDU6SXNzdWUzODU5ODc3MDU=","number":36096,"title":"Audit regex filtering in log4j2 with multiline events ","user":{"login":"Leaf-Lin","id":39002973,"node_id":"MDQ6VXNlcjM5MDAyOTcz","avatar_url":"https://avatars3.githubusercontent.com/u/39002973?v=4","gravatar_id":"","url":"https://api.github.com/users/Leaf-Lin","html_url":"https://github.com/Leaf-Lin","followers_url":"https://api.github.com/users/Leaf-Lin/followers","following_url":"https://api.github.com/users/Leaf-Lin/following{/other_user}","gists_url":"https://api.github.com/users/Leaf-Lin/gists{/gist_id}","starred_url":"https://api.github.com/users/Leaf-Lin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Leaf-Lin/subscriptions","organizations_url":"https://api.github.com/users/Leaf-Lin/orgs","repos_url":"https://api.github.com/users/Leaf-Lin/repos","events_url":"https://api.github.com/users/Leaf-Lin/events{/privacy}","received_events_url":"https://api.github.com/users/Leaf-Lin/received_events","type":"User","site_admin":false},"labels":[{"id":912837734,"node_id":"MDU6TGFiZWw5MTI4Mzc3MzQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Audit","name":":Security/Audit","color":"0e8a16","default":false,"description":"X-Pack Audit logging"}],"state":"closed","locked":false,"assignee":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"assignees":[{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2018-11-30T00:36:01Z","updated_at":"2019-03-07T22:19:06Z","closed_at":"2018-12-05T12:17:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nTested on both 6.2.3 and 6.2.4, both of them have this issue.\r\n\r\n**Plugins installed**: []\r\nx-pack\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_161\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 4db072fad34a 4.9.125-linuxkit \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nInconsistent audit filter behaviour when using  \"xpack.security.audit.logfile.events.include\" vs  \"xpack.security.audit.logfile.events.exclude\".\r\n\r\n**Steps to reproduce**:\r\nEssentially I want to filter the audit log with this line `appender.audit_rolling.filter.regex.regex = .*`\r\nFor now, I use .* which means that should apply to all the audit trail generated from xpack.security.audit.logfile.events\r\n\r\nWhen I have different events included in elasticsearch.yml file, the output in audit log should all be empty, as I have filter out everything. But it's not true for some of the scenarios below.\r\n\r\n**In `elasticsearh.yml` file:**\r\n```\r\nxpack.security.audit.enabled: true\r\nxpack.security.audit.logfile.events.emit_request_body: true \r\n#xpack.security.audit.logfile.events.include  #[1]\r\nxpack.security.audit.logfile.events.include: [authentication_success, run_as_granted]  #[2]\r\nxpack.security.audit.logfile.events.include: [authentication_success]  #[3]\r\nxpack.security.audit.logfile.events.exclude: [authentication_success, run_as_granted]  #[4]\r\nxpack.security.audit.logfile.events.exclude: [authentication_success]  #[5]\r\nxpack.security.audit.logfile.events.exclude: \"\"  #[6]\r\n```\r\n\r\n**In `x-pack/log4j2properties` file:**\r\n```\r\nlogger.xpack_security_audit_logfile.name = org.elasticsearch.xpack.security.audit.logfile.LoggingAuditTrail\r\nlogger.xpack_security_audit_logfile.appenderRef.console.ref = console\r\nlogger.xpack_security_audit_logfile.level = info\r\n\r\nlogger.xpack_security_audit_logfile.appenderRef.audit_rolling.ref = audit_rolling\r\nlogger.xpack_security_audit_logfile.additivity = false\r\nappender.audit_rolling.type = RollingFile\r\nappender.audit_rolling.name = audit_rolling\r\nappender.audit_rolling.fileName = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_access.log\r\nappender.audit_rolling.layout.type = PatternLayout\r\nappender.audit_rolling.layout.pattern = [%d{ISO8601}] %m%n\r\nappender.audit_rolling.filePattern = ${sys:es.logs.base_path}${sys:file.separator}${sys:es.logs.cluster_name}_access-%d{yyyy-MM-dd}.log\r\nappender.audit_rolling.policies.type = Policies\r\nappender.audit_rolling.policies.time.type = TimeBasedTriggeringPolicy\r\nappender.audit_rolling.policies.time.interval = 1\r\nappender.audit_rolling.policies.time.modulate = true\r\nappender.audit_rolling.filter.regex.type = RegexFilter\r\nappender.audit_rolling.filter.regex.onMatch = DENY\r\nappender.audit_rolling.filter.regex.regex = .*   \r\nappender.audit_rolling.filter.regex.onMisMatch = ACCEPT\r\n```\r\n\r\nThe expected behaviour is that no matter which line I included in [1]..[6], all output should be the same.\r\n\r\n[1] not specifying the events.include at all, **works**\r\n[2] specifying multiple events in the events.include, **fails** <-- this is unexpected.\r\n[3] specifying only one event in events.include, **fails** <-- this is unexpected.\r\n[4] sepcfiying multiple events in the events.exclude, **works**\r\n[5] specifying only one event in events.exclude, **works**\r\n[6] specifying null in events.exclude, **works**","closed_by":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"performed_via_github_app":null}