{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54802","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54802/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54802/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54802/events","html_url":"https://github.com/elastic/elasticsearch/issues/54802","id":595061722,"node_id":"MDU6SXNzdWU1OTUwNjE3MjI=","number":54802,"title":"Wrap a query with constant score change the size of result from 1 to 0 , es 6.8.8","user":{"login":"vkocubinsky","id":2220464,"node_id":"MDQ6VXNlcjIyMjA0NjQ=","avatar_url":"https://avatars3.githubusercontent.com/u/2220464?v=4","gravatar_id":"","url":"https://api.github.com/users/vkocubinsky","html_url":"https://github.com/vkocubinsky","followers_url":"https://api.github.com/users/vkocubinsky/followers","following_url":"https://api.github.com/users/vkocubinsky/following{/other_user}","gists_url":"https://api.github.com/users/vkocubinsky/gists{/gist_id}","starred_url":"https://api.github.com/users/vkocubinsky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vkocubinsky/subscriptions","organizations_url":"https://api.github.com/users/vkocubinsky/orgs","repos_url":"https://api.github.com/users/vkocubinsky/repos","events_url":"https://api.github.com/users/vkocubinsky/events{/privacy}","received_events_url":"https://api.github.com/users/vkocubinsky/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-04-06T12:09:59Z","updated_at":"2020-04-06T12:26:44Z","closed_at":"2020-04-06T12:26:44Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.8.8, Build: default/tar/2f4c224/2020-03-18T23:22:18.622755Z, JVM: 1.8.0_192\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_192\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_192-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin MacBook.local 19.3.0 Darwin Kernel Version 19.3.0: Thu Jan  9 20:58:23 PST 2020; root:xnu-6153.81.5~1/RELEASE_X86_64 x86_64\r\n**Description of the problem including expected versus actual behavior**:\r\nI have an index, index contains 1 document, I have  elasticsearch query , query match the document and search api return the result. When I wrap the query with \"constant_score\" clause I got zero result. I reproduced issue on 6.8.0, 6.8.8, but on 7.6.2 everything is works as expected\r\n\r\nMy question is is any plan to fix it for 6.x version?\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create index\r\n```\r\ncurl -XPUT localhost:9200/twitter -H 'Content-type: application/json' -d '\r\n{\r\n    \"mappings\" : {\r\n        \"_doc\": { \r\n            \"properties\" : {\r\n                \"message\" : { \"type\" : \"text\" }\r\n            }\r\n        }\r\n    }\r\n}\r\n'\r\n```\r\n\r\n2. Put a document\r\n\r\n```\r\ncurl -XPUT localhost:9200/twitter/_doc/1?pretty -H 'Content-Type: application/json' -d '\r\n{\r\n    \"message\": \"hello world\"\r\n}'\r\n```\r\n\r\n3. Execute query\r\n\r\n```\r\ncurl -H \"Content-type: application/json\" -XPOST localhost:9200/twitter/_search -d '\r\n{\r\n   \"query\" : {\r\n      \"bool\" : {\r\n         \"must\" : [\r\n            {\r\n               \"bool\" : {\r\n                  \"must\" : [\r\n                     {\r\n                        \"bool\" : {\r\n                           \"must\" : {\r\n                              \"query_string\" : {\r\n                                 \"query\" : \"+message:hello +message:world\"\r\n                              }\r\n                           },\r\n                           \"should\" : {\r\n                              \"query_string\" : {\r\n                                 \"query\" : \"message:foo\"\r\n                              }\r\n                           }\r\n                        }\r\n                     }\r\n                  ]\r\n               }\r\n            }\r\n         ]\r\n      }\r\n   }\r\n}\r\n'\r\n\r\n```\r\n\r\nQuery return the result\r\n```\r\n{\"took\":78,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"skipped\":0,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":0.5753642,\"hits\":[{\"_index\":\"twitter\",\"_type\":\"_doc\",\"_id\":\"1\",\"_score\":0.5753642,\"_source\":\r\n{\r\n    \"message\": \"hello world\"\r\n}}]}}\r\n```\r\n4. Execute wrapped with \"constant_score\" query\r\n\r\n```\r\ncurl -H \"Content-type: application/json\" -XPOST localhost:9200/twitter/_search -d '\r\n{\r\n   \"query\" : {\r\n      \"constant_score\" : {\r\n         \"filter\" : {\r\n            \"bool\" : {\r\n               \"must\" : [\r\n                  {\r\n                     \"bool\" : {\r\n                        \"must\" : [\r\n                           {\r\n                              \"bool\" : {\r\n                                 \"must\" : \r\n                                    {\r\n                                       \"query_string\" : {\r\n                                          \"query\" : \"+message:hello +_words:world\"\r\n                                       }\r\n                                    }\r\n                                 ,\r\n                                 \"should\" : \r\n                                    {\r\n                                       \"query_string\" : {\r\n                                          \"query\" : \"message:foo\"\r\n                                       }\r\n                                    }\r\n                                 \r\n                              }\r\n                           }\r\n                        ]\r\n                     }\r\n                  }\r\n               ]\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n'\r\n```\r\nThe difference is only \"constant_score ... filter\". The result is \r\n```\r\n{\"took\":7,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"skipped\":0,\"failed\":0},\"hits\":{\"total\":0,\"max_score\":null,\"hits\":[]}}\r\n```\r\nExpected result is 1 document, the same as not wrapped with \"constant_score\" query.\r\n\r\nThis is only reproduced on es 6.8 especially 6.8.0 and 6.8.8, but on 7.6.2 wrapped with \"constant_score\" query. \r\n\r\nDo you plan to fix for 6.8.8 ? \r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}