[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460033648","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460033648","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460033648,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDAzMzY0OA==","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"created_at":"2019-02-03T08:44:12Z","updated_at":"2019-02-03T08:44:12Z","author_association":"NONE","body":"> The Java virtual machine (JVM) caches DNS name lookups. When the JVM resolves a hostname to an IP address, it caches the IP address for a specified period of time, known as the time-to-live (TTL).\r\n> \r\n> Because AWS resources use DNS name entries that occasionally change, we recommend that you configure your JVM with a TTL value of no more than 60 seconds. This ensures that when a resource's IP address changes, your application will be able to receive and use the resource's new IP address by requerying the DNS.\r\n> \r\n> On some Java configurations, the JVM default TTL is set so that it will never refresh DNS entries until the JVM is restarted. Thus, if the IP address for an AWS resource changes while your application is still running, it won't be able to use that resource until you manually restart the JVM and the cached IP information is refreshed. In this case, it's crucial to set the JVM's TTL so that it will periodically refresh its cached IP information.\r\n\r\nThis ^ seems likely to be the root cause:\r\nhttps://docs.aws.amazon.com/sdk-for-java/v1/developer-guide/java-dg-jvm-ttl.html\r\n\r\nShould you guys be setting this TTL somewhere in this repo? https://github.com/elastic/elasticsearch/tree/master/plugins/repository-s3","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460033673","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460033673","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460033673,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDAzMzY3Mw==","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"created_at":"2019-02-03T08:44:33Z","updated_at":"2019-02-03T08:44:33Z","author_association":"NONE","body":"Just in case it's useful, according to the Elasticsearch log, we are NOT passing any JVM arg that could be overriding any ttl defaults.\r\n\r\n> [2019-02-02T14:33:52,392][INFO ][o.e.n.Node ] [es-master-3.localdomain] version[6.3.0], pid[27981], build[default/rpm/424e937/2018-06-11T23:38:03.357887Z], OS[Linux/4.14.88-72.76.amzn1.x86_64/amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_171/25.171-b11]\r\n\r\n> [2019-02-02T14:33:52,392][INFO ][o.e.n.Node ] [es-master-3.localdomain] JVM arguments [-Xms7789m, -Xmx7789m, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -XX:+PrintGCDetails, -XX:+PrintGCDateStamps, -XX:+PrintTenuringDistribution, -XX:+PrintGCApplicationStoppedTime, -Xloggc:logs/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLogFiles=32, -XX:GCLogFileSize=64m, -Des.index.memory.max_index_buffer_size=10240mb, -Des.path.home=/usr/share/elasticsearch, -Des.path.conf=/etc/elasticsearch, -Des.distribution.flavor=default, -Des.distribution.type=rpm]","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460042303","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460042303","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460042303,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDA0MjMwMw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-02-03T11:07:14Z","updated_at":"2019-02-03T11:07:14Z","author_association":"CONTRIBUTOR","body":"If the issue is DNS caching, see https://github.com/elastic/elasticsearch/pull/36570 which I think should fix this in â‰¥6.6.0.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460053549","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460053549","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460053549,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDA1MzU0OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-03T13:54:42Z","updated_at":"2019-02-03T13:54:42Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460053653","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460053653","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460053653,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDA1MzY1Mw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-02-03T13:56:08Z","updated_at":"2019-02-03T13:57:25Z","author_association":"MEMBER","body":"Since you have triaged this as a DNS caching issue, you have two options:\r\n - in 6.3.0, [override the infinite DNS cache in your security policy](https://www.elastic.co/guide/en/elasticsearch/reference/6.3/networkaddress-cache-ttl.html)\r\n - upgrade to 6.6.0 where we override the infinite DNS cache by default\r\n\r\nPlease let us know if this addresses your issue.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460059169","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460059169","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460059169,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDA1OTE2OQ==","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"created_at":"2019-02-03T15:01:35Z","updated_at":"2019-02-03T15:01:35Z","author_association":"NONE","body":"**For option 1:** I believe I have found the correct file\r\n\r\n```\r\nhead -n3 $JAVA_HOME/jre/lib/security/java.security\r\n#\r\n# This is the \"master security properties file\".\r\n#\r\n```\r\n\r\nAm I correct in saying I need to append the following two lines to this file (values taken from your PR)\r\n\r\n```\r\nnetworkaddress.cache.ttl=60\r\nnetworkaddress.cache.negative.ttl=10\r\n```\r\n\r\nAnd then I need to restart the Elasticsearch process?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460668762","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-460668762","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":460668762,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDY2ODc2Mg==","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T14:59:40Z","updated_at":"2019-02-05T14:59:40Z","author_association":"NONE","body":"@jasontedor I have **not** been able to prove that option 1 works. \r\n\r\nHere is what I did on a test cluster.\r\n\r\n1. Checked which version of `java` the Elasticsearch process is using\r\n\r\n```\r\nps aux | grep elasticsearch\r\n495      13082  5.6 54.5 11676924 8393576 ?    SLl  14:29   0:47 /usr/bin/java ...\r\n```\r\n\r\n1. Found the location of java.home\r\n```\r\n/usr/bin/java -XshowSettings:properties -version 2>&1 | grep java.home\r\n    java.home = /usr/lib/jvm/jdk1.8.0_171/jre\r\n```\r\n\r\nAccording to [the docs](https://docs.oracle.com/javase/8/docs/technotes/guides/security/PolicyFiles.html) the file I need to edit is `java.home/lib/security/java.security` so `/usr/lib/jvm/jdk1.8.0_171/jre/lib/security/java.security`\r\n\r\n2. I made sure that the cluster could talk to S3\r\n\r\n```\r\ncurl -X GET 'localhost:9200/_snapshot/my_backup/_all?pretty'\r\n[{\r\n      \"snapshot\" : \"redacted\",\r\n      \"uuid\" : \"bqsiTs04RJCVhMlx8W0XxQ\",\r\n      \"version_id\" : 6030099,\r\n      \"version\" : \"6.3.0\",\r\n      \"indices\" : [\r\n        \"redacted\"\r\n      ],\r\n      \"include_global_state\" : true,\r\n      \"state\" : \"SUCCESS\",\r\n      \"start_time\" : \"2019-02-04T11:16:32.825Z\",\r\n      \"start_time_in_millis\" : 1549278992825,\r\n      \"end_time\" : \"2019-02-04T11:19:25.602Z\",\r\n      \"end_time_in_millis\" : 1549279165602,\r\n      \"duration_in_millis\" : 172777,\r\n      \"failures\" : [ ],\r\n      \"shards\" : {\r\n        \"total\" : 331,\r\n        \"failed\" : 0,\r\n        \"successful\" : 331\r\n      }\r\n    }\r\n}]\r\n```\r\n\r\n3. I edited `/etc/hosts` on all master eligible nodes so that they could no longer talk to S3\r\n\r\n```\r\ntail -n1 /etc/hosts \r\n1.2.3.4 redacted.s3.amazonaws.com\r\n```\r\n\r\n4. I edited `java.security` to turn on ttl-ing\r\n\r\n```\r\ngrep 'networkaddress.cache.ttl' /usr/lib/jvm/jdk1.8.0_171/jre/lib/security/java.security\r\nnetworkaddress.cache.ttl=60\r\n```\r\n\r\n5. I restarted the Elasticsearch process on all master eligible nodes\r\n\r\n6. I verified that the cluster could no longer talk to S3\r\n\r\n```\r\ncurl -X GET 'localhost:9200/_snapshot/my_backup/_all?pretty' \r\n{\r\n  \"error\": {\r\n    \"reason\": \"[my_backup] missing\",\r\n    \"root_cause\": [\r\n      {\r\n        \"reason\": \"[my_backup] missing\",\r\n        \"type\": \"repository_missing_exception\"\r\n      }\r\n    ],\r\n    \"type\": \"repository_missing_exception\"\r\n  },\r\n  \"status\": 404\r\n}\r\n```\r\n\r\n7. I edited `/etc/hosts` on all master eligible nodes so that they could talk to S3 again\r\n\r\n```\r\ntail -n1 /etc/hosts \r\n#1.2.3.4 redacted.s3.amazonaws.com\r\n```\r\n\r\n8. I waited 1 minute and expected to be able to talk to S3\r\n\r\n```\r\ncurl -X GET 'localhost:9200/_snapshot/my_backup/_all?pretty'\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"repository_missing_exception\",\r\n        \"reason\" : \"[my_backup] missing\"\r\n      }\r\n    ],\r\n    \"type\" : \"repository_missing_exception\",\r\n    \"reason\" : \"[my_backup] missing\"\r\n  },\r\n  \"status\" : 404\r\n}\r\n```\r\n\r\n9. I waited another 10 minutes and still the same thing (I was **not** expecting this, the TTL should have expired by now)\r\n```\r\ncurl -X GET 'localhost:9200/_snapshot/my_backup/_all?pretty'\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"repository_missing_exception\",\r\n        \"reason\" : \"[my_backup] missing\"\r\n      }\r\n    ],\r\n    \"type\" : \"repository_missing_exception\",\r\n    \"reason\" : \"[my_backup] missing\"\r\n  },\r\n  \"status\" : 404\r\n}\r\n```\r\n\r\n10. I restarted the Elasticsearch process on all master eligible nodes and I could talk to S3 again\r\n```\r\ncurl -X GET 'localhost:9200/_snapshot/my_backup/_all?pretty'\r\n[{\r\n      \"snapshot\" : \"redacted\",\r\n      \"uuid\" : \"bqsiTs04RJCVhMlx8W0XxQ\",\r\n      \"version_id\" : 6030099,\r\n      \"version\" : \"6.3.0\",\r\n      \"indices\" : [\r\n        \"redacted\"\r\n      ],\r\n      \"include_global_state\" : true,\r\n      \"state\" : \"SUCCESS\",\r\n      \"start_time\" : \"2019-02-04T11:16:32.825Z\",\r\n      \"start_time_in_millis\" : 1549278992825,\r\n      \"end_time\" : \"2019-02-04T11:19:25.602Z\",\r\n      \"end_time_in_millis\" : 1549279165602,\r\n      \"duration_in_millis\" : 172777,\r\n      \"failures\" : [ ],\r\n      \"shards\" : {\r\n        \"total\" : 331,\r\n        \"failed\" : 0,\r\n        \"successful\" : 331\r\n      }\r\n    }\r\n}]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461499958","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-461499958","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":461499958,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTQ5OTk1OA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-02-07T16:31:48Z","updated_at":"2019-02-07T16:31:48Z","author_association":"MEMBER","body":"@original-brownbear Can you take a look?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461512258","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-461512258","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":461512258,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTUxMjI1OA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-07T17:03:32Z","updated_at":"2019-02-07T17:03:32Z","author_association":"MEMBER","body":"@jasontedor sure will do :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461603018","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-461603018","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":461603018,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTYwMzAxOA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-07T21:30:14Z","updated_at":"2019-02-07T21:30:14Z","author_association":"MEMBER","body":"@ccoffey I just manually tried this out using Elasticsearch 6.3, following your exact steps.\r\nI was able to reproduce the exact issue of the cache not refreshing without the DNS TTL manually adjusted, but unlike for you it was fixed by setting the TTL in the `java.security` file.\r\nAlso tried this out in `6.6` and it worked fine out of the box there as @jasontedor suggested\r\n\r\nSo as far I can see this is a problem with your environment not picking up the setting for some reason.\r\nOne thing you could try to rule out that your system loads the wrong `java.security` file for some reason is to add \r\n\r\n```\r\n-Djava.security.properties=/usr/lib/jvm/jdk1.8.0_171/jre/lib/security/java.security\r\n```\r\n\r\nto elasticsearch's `config/jvm.options` file.\r\n\r\nSince we reserve Github for confirmed bugs and feature requests I am going to close this issue and would suggest opening a thread on this topic on our [discuss forum](https://discuss.elastic.co/c/elasticsearch).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461893346","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-461893346","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":461893346,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTg5MzM0Ng==","user":{"login":"andrejbl","id":36857192,"node_id":"MDQ6VXNlcjM2ODU3MTky","avatar_url":"https://avatars1.githubusercontent.com/u/36857192?v=4","gravatar_id":"","url":"https://api.github.com/users/andrejbl","html_url":"https://github.com/andrejbl","followers_url":"https://api.github.com/users/andrejbl/followers","following_url":"https://api.github.com/users/andrejbl/following{/other_user}","gists_url":"https://api.github.com/users/andrejbl/gists{/gist_id}","starred_url":"https://api.github.com/users/andrejbl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrejbl/subscriptions","organizations_url":"https://api.github.com/users/andrejbl/orgs","repos_url":"https://api.github.com/users/andrejbl/repos","events_url":"https://api.github.com/users/andrejbl/events{/privacy}","received_events_url":"https://api.github.com/users/andrejbl/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T18:08:16Z","updated_at":"2019-02-08T18:08:16Z","author_association":"NONE","body":"@original-brownbear - thanks for investigating this. Indeed, you are correct, the steps we performed above do fix the problem with infinite DNS caching and the real issue was with our repro setup.\r\n\r\nHowever, the repro setup we used surfaced a different caching issue at another level. Namely, the error we observed: \r\n```\r\ncurl -X GET 'localhost:9200/_snapshot/my_backup/_all?pretty'\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"repository_missing_exception\",\r\n        \"reason\" : \"[my_backup] missing\"\r\n      }\r\n    ],\r\n    \"type\" : \"repository_missing_exception\",\r\n    \"reason\" : \"[my_backup] missing\"\r\n  },\r\n  \"status\" : 404\r\n}\r\n```\r\nis not the one we expected from a stale DNS entry caching bug, which would have looked like this:\r\n```\r\n\"root_cause\":[{\"type\":\"sdk_client_exception\",\"reason\":\"sdk_client_exception: Unable to execute HTTP request: Connect to i\r\nredacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/X.X.X.X] failed: connect timed out\"}]\r\n```\r\nThe 404 error started being returned indefinitely after we 1) created the fake /etc/hosts entry and 2) restarted elasticsearch. \r\n\r\nWhat seems to happen is that if a snapshot is not reachable at ES startup time (as opposed to running time), the ES indefinitely starts returning 404 errors back to the caller for any snapshot operations, regardless of later DNS or snapshot connectivity changes.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462711981","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-462711981","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":462711981,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjcxMTk4MQ==","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T10:49:23Z","updated_at":"2019-02-12T10:49:23Z","author_association":"NONE","body":"@original-brownbear I think you should re open this as there is still an issue here. \r\n\r\nIf you start Elasticsearch and you cannot reach S3, then this gets cached forever. \r\n\r\nThe way to test this is to simply edit `/etc/hosts` and make S3 unreachable before starting the Elasticsearch process.  You will then see the following error when you try to check snapshots\r\n\r\n```\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"repository_missing_exception\",\r\n        \"reason\" : \"[my_backup] missing\"\r\n      }\r\n    ],\r\n    \"type\" : \"repository_missing_exception\",\r\n    \"reason\" : \"[my_backup] missing\"\r\n  },\r\n  \"status\" : 404\r\n}\r\n```\r\n\r\nThis is bad because if there happens to be a network blip during the booting of the Elasticsearch process, then that process will not be able to talk to S3, even after the network has recovered. The only way to get it to talk to S3 again is to restart the process.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462713006","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-462713006","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":462713006,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjcxMzAwNg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T10:52:30Z","updated_at":"2019-02-12T10:52:30Z","author_association":"MEMBER","body":"@ccoffey sorry had a day off, back to this soon :) I'll investigate this soon. It could be we're caching the failed repository validation in some unfortunate way here.\r\n=> Reopening + investigating soon.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463586069","html_url":"https://github.com/elastic/elasticsearch/issues/38272#issuecomment-463586069","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","id":463586069,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzU4NjA2OQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-14T11:01:53Z","updated_at":"2019-02-14T11:01:53Z","author_association":"MEMBER","body":"I reproduced this with `6.3` but also verified that it's fixed in `master` now due to https://github.com/elastic/elasticsearch/pull/31606 so upgrading to `6.4+` should resolve your issue :)","performed_via_github_app":null}]