{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28628","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28628/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28628/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28628/events","html_url":"https://github.com/elastic/elasticsearch/issues/28628","id":296300656,"node_id":"MDU6SXNzdWUyOTYzMDA2NTY=","number":28628,"title":"[v6.1.x] Possible Memory Leak leads to Java Heap Space","user":{"login":"jloisel","id":3208716,"node_id":"MDQ6VXNlcjMyMDg3MTY=","avatar_url":"https://avatars1.githubusercontent.com/u/3208716?v=4","gravatar_id":"","url":"https://api.github.com/users/jloisel","html_url":"https://github.com/jloisel","followers_url":"https://api.github.com/users/jloisel/followers","following_url":"https://api.github.com/users/jloisel/following{/other_user}","gists_url":"https://api.github.com/users/jloisel/gists{/gist_id}","starred_url":"https://api.github.com/users/jloisel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jloisel/subscriptions","organizations_url":"https://api.github.com/users/jloisel/orgs","repos_url":"https://api.github.com/users/jloisel/repos","events_url":"https://api.github.com/users/jloisel/events{/privacy}","received_events_url":"https://api.github.com/users/jloisel/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-02-12T08:51:24Z","updated_at":"2018-02-12T12:15:35Z","closed_at":"2018-02-12T12:15:34Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.1.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): elasticsearch-oss docker image JVM\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 16.04 LTS, Docker 17.09-ce\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nHi,\r\n\r\nSince we migrated from v5.6.5 to v6.1.2, we experience repeated Java Heap Space issues. We have a cluster composed of 3 nodes, with Xms and Xmx 2g heap space allocated to each.\r\n\r\nWe had no issues at all with v5.6.x and below. \r\n\r\nWe had 3 indices in v5.6.5. Now, with v6.1.2, we have about 34 indices, each configured with 5 shards and 1 replica. The load on the cluster is very light (indexing a few hundred json docs per sec at peak). 95% of the time is spent reading the data from the database.\r\n\r\nAll type mappings on strings are using \"keyword\". We don't perform any match search at all.\r\n\r\nWe perform mostly the following queries:\r\n\r\n- Aggregations on terms, histogram, average, min, max,\r\n- Searches based on terms,\r\n- Scroll-Searches based on terms.\r\n\r\nAll mappings are like this: (using either keyword, int, long, double, or object)\r\n\r\n```json\r\n\r\n{\r\n  \"dynamic\": false,\r\n  \"properties\": {\r\n    \"agentId\": {\r\n      \"type\": \"keyword\"\r\n    },\r\n    \"projectId\": {\r\n      \"type\": \"keyword\"\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nUnfortunately, it happens after the database is running a few days. There is no easy step to reproduce this. Increasing the heap size only slowed down the out of memory, but doesn't prevent it. \r\n\r\n**Provide logs (if relevant)**:\r\n\r\nSome nodes are displaying Gc issues in their logs:\r\n\r\n> 2/12/2018 7:28:53 AM[2018-02-12T06:28:53,078][WARN ][o.e.m.j.JvmGcMonitorService] [EQWabWg] [gc][1070905] overhead, spent [2.1s] collecting in the last [2.1s]\r\n2/12/2018 7:28:53 AM[2018-02-12T06:28:53,078][WARN ][o.e.d.z.ZenDiscovery     ] [EQWabWg] not enough master nodes discovered during pinging (found [[Candidate{node={EQWabWg}{EQWabWg1TSqSDIPjV9BK3Q}{N3FlAw83RgquNx02PvNK5A}{10.42.153.220}{10.42.153.220:9300}, clusterStateVersion=2472}]], but needed [2]), pinging again\r\n2/12/2018 7:28:56 AM[2018-02-12T06:28:56,396][WARN ][o.e.m.j.JvmGcMonitorService] [EQWabWg] [gc][1070907] overhead, spent [2.3s] collecting in the last [2.3s]\r\n2/12/2018 7:28:58 AM[2018-02-12T06:28:58,572][WARN ][o.e.m.j.JvmGcMonitorService] [EQWabWg] [gc][1070908] overhead, spent [2.1s] collecting in the last [2.1s]\r\n2/12/2018 7:29:03 AM[2018-02-12T06:29:03,328][WARN ][o.e.m.j.JvmGcMonitorService] [EQWabWg] [gc][1070909] overhead, spent [4.6s] collecting in the last [4.7s]\r\n2/12/2018 7:29:09 AM[2018-02-12T06:29:09,579][WARN ][o.e.m.j.JvmGcMonitorService] [EQWabWg] [gc][1070910] overhead, spent [6.2s] collecting in the last [6.2s]\r\n2/12/2018 7:29:16 AM[2018-02-12T06:29:16,860][WARN ][o.e.m.j.JvmGcMonitorService] [EQWabWg] [gc][1070911] overhead, spent [7.2s] collecting in the last [7.2s]\r\n\r\nWhile some others:\r\n\r\n> 2/12/2018 7:19:37 AMException: java.lang.SecurityException thrown from the UncaughtExceptionHandler in thread \"Thread-83087\"\r\n2/12/2018 7:19:39 AM[2018-02-12T06:14:51,364][WARN ][o.e.t.n.Netty4Transport  ] [pK-llbn] send message failed [channel: org.elasticsearch.transport.netty4.NettyTcpChannel@100830bf]\r\n2/12/2018 7:19:39 AMjava.nio.channels.ClosedChannelException: null\r\n2/12/2018 7:19:39 AM\tat io.netty.channel.AbstractChannel$AbstractUnsafe.write(...)(Unknown Source) ~[?:?]\r\n2/12/2018 7:19:51 AM[2018-02-12T06:19:43,702][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[pK-llbn][generic][T#655]], exiting\r\n2/12/2018 7:19:51 AMjava.lang.OutOfMemoryError: Java heap space\r\n2/12/2018 7:20:04 AM\r\n2/12/2018 7:20:04 AMException: java.lang.SecurityException thrown from the UncaughtExceptionHandler in thread \"elasticsearch[pK-llbn][generic][T#655]\"\r\n2/12/2018 7:20:08 AM[2018-02-12T06:20:08,654][WARN ][o.e.m.j.JvmGcMonitorService] [pK-llbn] [gc][1063774] overhead, spent [32.2m] collecting in the last [32.5m]\r\n2/12/2018 7:20:28 AM[2018-02-12T06:20:14,904][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[pK-llbn][refresh][T#47]], exiting\r\n2/12/2018 7:20:28 AMjava.lang.OutOfMemoryError: Java heap space\r\n2/12/2018 7:20:40 AM\r\n2/12/2018 7:20:40 AMException: java.lang.SecurityException thrown from the UncaughtExceptionHandler in thread \"elasticsearch[pK-llbn][refresh][T#47]\"\r\n2/12/2018 7:21:30 AM[2018-02-12T06:19:41,784][WARN ][o.e.t.n.Netty4Transport  ] [pK-llbn] send message failed [channel: org.elasticsearch.transport.netty4.NettyTcpChannel@100830bf]\r\n2/12/2018 7:21:30 AMjava.nio.channels.ClosedChannelException: null\r\n2/12/2018 7:21:30 AM\tat io.netty.channel.AbstractChannel$AbstractUnsafe.write(...)(Unknown Source) ~[?:?]\r\n2/12/2018 7:22:43 AM[2018-02-12T06:19:35,640][WARN ][o.e.t.n.Netty4Transport  ] [pK-llbn] send message failed [channel: org.elasticsearch.transport.netty4.NettyTcpChannel@64fb4972]\r\n2/12/2018 7:22:43 AMjava.nio.channels.ClosedChannelException: null\r\n2/12/2018 7:22:43 AM\tat io.netty.channel.AbstractChannel$AbstractUnsafe.write(...)(Unknown Source) ~[?:?]\r\n2/12/2018 7:24:34 AM[2018-02-12T06:21:32,718][WARN ][o.e.t.n.Netty4Transport  ] [pK-llbn] send message failed [channel: org.elasticsearch.transport.netty4.NettyTcpChannel@100830bf]\r\n2/12/2018 7:24:34 AMjava.nio.channels.ClosedChannelException: null\r\n2/12/2018 7:24:34 AM\tat io.netty.channel.AbstractChannel$AbstractUnsafe.write(...)(Unknown Source) ~[?:?]\r\n2/12/2018 7:28:39 AM[2018-02-12T06:28:34,965][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[pK-llbn][refresh][T#50]], exiting\r\n2/12/2018 7:28:39 AMjava.lang.OutOfMemoryError: Java heap space\r\n2/12/2018 7:28:52 AM[2018-02-12T06:28:26,110][WARN ][i.n.c.AbstractChannelHandlerContext] An exception 'java.lang.OutOfMemoryError: Java heap space' [enable DEBUG level for full stacktrace] was thrown by a user handler's exceptionCaught() method while handling the following exception:\r\n2/12/2018 7:28:52 AMjava.lang.OutOfMemoryError: Java heap space\r\n2/12/2018 7:29:02 AM[2018-02-12T06:28:37,041][WARN ][i.n.u.c.DefaultPromise   ] An exception was thrown by org.elasticsearch.transport.netty4.NettyTcpChannel$$Lambda$1538/1854092390.operationComplete()\r\n2/12/2018 7:29:02 AMjava.lang.OutOfMemoryError: Java heap space","closed_by":{"login":"jloisel","id":3208716,"node_id":"MDQ6VXNlcjMyMDg3MTY=","avatar_url":"https://avatars1.githubusercontent.com/u/3208716?v=4","gravatar_id":"","url":"https://api.github.com/users/jloisel","html_url":"https://github.com/jloisel","followers_url":"https://api.github.com/users/jloisel/followers","following_url":"https://api.github.com/users/jloisel/following{/other_user}","gists_url":"https://api.github.com/users/jloisel/gists{/gist_id}","starred_url":"https://api.github.com/users/jloisel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jloisel/subscriptions","organizations_url":"https://api.github.com/users/jloisel/orgs","repos_url":"https://api.github.com/users/jloisel/repos","events_url":"https://api.github.com/users/jloisel/events{/privacy}","received_events_url":"https://api.github.com/users/jloisel/received_events","type":"User","site_admin":false},"performed_via_github_app":null}