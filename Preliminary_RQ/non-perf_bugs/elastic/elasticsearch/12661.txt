{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12661","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12661/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12661/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12661/events","html_url":"https://github.com/elastic/elasticsearch/issues/12661","id":99111170,"node_id":"MDU6SXNzdWU5OTExMTE3MA==","number":12661,"title":"ES shard fail to recovery due do number of docs differ","user":{"login":"kenny-ye","id":13653428,"node_id":"MDQ6VXNlcjEzNjUzNDI4","avatar_url":"https://avatars0.githubusercontent.com/u/13653428?v=4","gravatar_id":"","url":"https://api.github.com/users/kenny-ye","html_url":"https://github.com/kenny-ye","followers_url":"https://api.github.com/users/kenny-ye/followers","following_url":"https://api.github.com/users/kenny-ye/following{/other_user}","gists_url":"https://api.github.com/users/kenny-ye/gists{/gist_id}","starred_url":"https://api.github.com/users/kenny-ye/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kenny-ye/subscriptions","organizations_url":"https://api.github.com/users/kenny-ye/orgs","repos_url":"https://api.github.com/users/kenny-ye/repos","events_url":"https://api.github.com/users/kenny-ye/events{/privacy}","received_events_url":"https://api.github.com/users/kenny-ye/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2015-08-05T03:44:20Z","updated_at":"2018-01-15T15:42:37Z","closed_at":"2016-01-26T17:45:33Z","author_association":"NONE","active_lock_reason":null,"body":"We use two ES data nodes with setting -Xmx30g -Xms30g. The two ES servers have 128G physical memory and 24 CPU cores.\nAfter bulking insert for about 2 weeks, totally we indexed about 10 million document (5 shards, 1 replica). The index size is about 4.7TB in disk. Then ES server comes into frequently long old GC and even after old GC, the heap occupation is above 20G.  \nI tried to release the heap usage by stopping the bulk insert and close the index. Then I open the index again, but the cluster goes to yellow. One replica shard failed to recovery because of document number mismatch with primary shard. How to solve this issue to recover the failed shard? \n\nThe server log:\n###### \n\n[2015-08-05 03:30:26,461][WARN ][indices.cluster          ] [ipattern-es01.iad1] [[ipattern-2015-07][3]] marking and sending shard failed due to [failed recovery]\norg.elasticsearch.indices.recovery.RecoveryFailedException: [ipattern-2015-07][3]: Recovery failed from [ipattern-es02.iad1][CB3p3ZnZR_qUHGc05ZKK7Q][ipattern-es02.iad1][inet[/10.40.146.47:9300]] into [ipattern-es01.iad1][gqF0BDR_S9SAlSIfGZVx_g][ipattern-es01.iad1][inet[ipattern-es01.iad1/10.40.146.46:9300]]\n    at org.elasticsearch.indices.recovery.RecoveryTarget.doRecovery(RecoveryTarget.java:280)\n    at org.elasticsearch.indices.recovery.RecoveryTarget.access$700(RecoveryTarget.java:70)\n    at org.elasticsearch.indices.recovery.RecoveryTarget$RecoveryRunner.doRun(RecoveryTarget.java:561)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.transport.RemoteTransportException: [ipattern-es02.iad1][inet[/10.40.146.47:9300]][internal:index/shard/recovery/start_recovery]\nCaused by: org.elasticsearch.index.engine.RecoveryEngineException: [ipattern-2015-07][3] Phase[1] Execution failed\n    at org.elasticsearch.index.engine.InternalEngine.recover(InternalEngine.java:898)\n    at org.elasticsearch.index.shard.IndexShard.recover(IndexShard.java:780)\n    at org.elasticsearch.indices.recovery.RecoverySource.recover(RecoverySource.java:125)\n    at org.elasticsearch.indices.recovery.RecoverySource.access$200(RecoverySource.java:49)\n    at org.elasticsearch.indices.recovery.RecoverySource$StartRecoveryTransportRequestHandler.messageReceived(RecoverySource.java:146)\n    at org.elasticsearch.indices.recovery.RecoverySource$StartRecoveryTransportRequestHandler.messageReceived(RecoverySource.java:132)\n    at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.doRun(MessageChannelHandler.java:279)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.indices.recovery.RecoverFilesRecoveryException: [ipattern-2015-07][3] Failed to transfer [0] files with total size of [0b]\n    at org.elasticsearch.indices.recovery.RecoverySourceHandler.phase1(RecoverySourceHandler.java:431)\n    at org.elasticsearch.index.engine.InternalEngine.recover(InternalEngine.java:893)\n    ... 10 more\nCaused by: java.lang.IllegalStateException: try to recover [ipattern-2015-07][3] from primary shard with sync id but number of docs differ: 2435163 (ipattern-es02.iad1, primary) vs 2435160(ipattern-es01.iad1)\n    at org.elasticsearch.indices.recovery.RecoverySourceHandler.phase1(RecoverySourceHandler.java:177)\n    ... 11 more\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}