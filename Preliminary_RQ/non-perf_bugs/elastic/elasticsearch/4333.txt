{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4333","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4333/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4333/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4333/events","html_url":"https://github.com/elastic/elasticsearch/issues/4333","id":23690649,"node_id":"MDU6SXNzdWUyMzY5MDY0OQ==","number":4333,"title":"Shard replica recovering from remote shard although data is identical (incomplete checksum ?)","user":{"login":"martin-a","id":1248717,"node_id":"MDQ6VXNlcjEyNDg3MTc=","avatar_url":"https://avatars0.githubusercontent.com/u/1248717?v=4","gravatar_id":"","url":"https://api.github.com/users/martin-a","html_url":"https://github.com/martin-a","followers_url":"https://api.github.com/users/martin-a/followers","following_url":"https://api.github.com/users/martin-a/following{/other_user}","gists_url":"https://api.github.com/users/martin-a/gists{/gist_id}","starred_url":"https://api.github.com/users/martin-a/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martin-a/subscriptions","organizations_url":"https://api.github.com/users/martin-a/orgs","repos_url":"https://api.github.com/users/martin-a/repos","events_url":"https://api.github.com/users/martin-a/events{/privacy}","received_events_url":"https://api.github.com/users/martin-a/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2013-12-04T02:39:19Z","updated_at":"2014-12-24T16:47:44Z","closed_at":"2014-12-24T16:47:44Z","author_association":"NONE","active_lock_reason":null,"body":"It looks like a bug to me, please tell me if I misunderstand something\n\nAfter having a look in ES source code and user mailing list post (https://groups.google.com/forum/?fromgroups#!searchin/elasticsearch/checksum/elasticsearch/9uF-a5vqfkQ/19jIIMpho8UJ) it seems recovery of a shard replica copies data from a remote primary shard only if local data is different from the remote one.\n\nI experience here a strange behavior, as replica shard recovery copies data from remote primary shard even when files on the disk are identical.\nI had a look at trace level logs, and it seems some files does not have any checksum associated with them\n\n<pre>\n2013-12-04 10:52:40.995 [elasticsearch[index3][generic][T#6]] TRACE org.elasticsearch.indices.recovery - [index3] [logst_20130902][3] recovery [phase1] to [index][8zAoqm0QTJy6ZZxr6hxcKg][inet[/172.28.2.124:9300]]{server=index, local=false}: recovering [_4m7.fdt], exists in local store, but is different: remote [name [_4m7.fdt], length [5055878], checksum [null]], local [name [_4m7.fdt], length [5055878], checksum [null]]</pre>\n\nI then had a look at the _checksums-###### file in the index and it seems that some files are actually not registered inside.\n\nlist of files:\n<pre>\nPS E:\\...\\nodes\\0\\indices\\logst_20130902\\3\\index> ls\n\n\n    ディレクトリ: E:\\...\\nodes\\0\\indices\\logst_20130902\\3\\index\n\n\nMode                LastWriteTime     Length Name\n----                -------------     ------ ----\n-a---        2013/12/03     18:06        149 segments_2o\n-a---        2013/12/04     11:21          0 write.lock\n-a---        2013/12/03     18:06   24851477 _3wf.fdt\n-a---        2013/12/03     18:06       8588 _3wf.fdx\n-a---        2013/12/03     18:06       1523 _3wf.fnm\n-a---        2013/12/03     18:06        416 _3wf.si\n-a---        2013/11/21     19:10         40 _3wf_1.del\n-a---        2013/12/03     18:06     228022 _3wf_es090_0.blm\n-a---        2013/12/03     18:06    6242130 _3wf_es090_0.doc\n-a---        2013/12/03     18:06         34 _3wf_es090_0.pay\n-a---        2013/12/03     18:06    1902714 _3wf_es090_0.pos\n-a---        2013/12/03     18:06   52196457 _3wf_es090_0.tim\n-a---        2013/12/03     18:06     383286 _3wf_es090_0.tip\n-a---        2013/12/03     18:06    5055878 _4m7.fdt\n-a---        2013/12/03     18:06       1620 _4m7.fdx\n-a---        2013/12/03     18:06       1523 _4m7.fnm\n-a---        2013/12/03     18:06        416 _4m7.si\n-a---        2013/11/21     19:10         41 _4m7_1.del\n-a---        2013/12/03     18:06      46454 _4m7_es090_0.blm\n-a---        2013/12/03     18:06     993440 _4m7_es090_0.doc\n-a---        2013/12/03     18:06         34 _4m7_es090_0.pay\n-a---        2013/12/03     18:06     387284 _4m7_es090_0.pos\n-a---        2013/12/03     18:06   11199156 _4m7_es090_0.tim\n-a---        2013/12/03     18:06      95699 _4m7_es090_0.tip\n-a---        2013/12/03     17:42    3644643 _5y3.fdt\n-a---        2013/12/03     17:42       1360 _5y3.fdx\n-a---        2013/12/03     17:42       1523 _5y3.fnm\n-a---        2013/12/03     17:42        414 _5y3.si\n-a---        2013/12/03     17:42      33334 _5y3_es090_0.blm\n-a---        2013/12/03     17:42     696249 _5y3_es090_0.doc\n-a---        2013/12/03     17:42         34 _5y3_es090_0.pay\n-a---        2013/12/03     17:42     277744 _5y3_es090_0.pos\n-a---        2013/12/03     17:42    8093228 _5y3_es090_0.tim\n-a---        2013/12/03     17:42      70340 _5y3_es090_0.tip\n-a---        2013/12/03     18:06        256 _checksums-1386061599167\n</pre>\n\n\ncontent of _checksums-1386061599167\n\n<pre>\n              \f\b_5y3.fnm\u0004jp3l\u0010_5y3_es090_0.tim\u000719lvp16\n_4m7_1.del\u000716ngfcf\u0010_5y3_es090_0.blm\u00061z3shz\u0010_5y3_es090_0.pay\u00071oc8igi\u0010_5y3_es090_0.doc\u0006ug5ct1\b_5y3.fdx\u0007148mb8r\u0007_5y3.si\u0006o5uult\u0010_5y3_es090_0.tip\u00071rjuwi0\u0010_5y3_es090_0.pos\u0006ccqsms\n_3wf_1.del\u000714p3tnl\b_5y3.fdt\u00071ttm03z\n</pre>\n\n\nI am using ES 0.90.1. I had a look at recent release notes but could not find anything related.\n\nNote: for some reason when there is only one segment/shard, checksum file seems to be complete\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}