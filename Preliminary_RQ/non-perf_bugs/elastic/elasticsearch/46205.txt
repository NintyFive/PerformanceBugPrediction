{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46205","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46205/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46205/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46205/events","html_url":"https://github.com/elastic/elasticsearch/issues/46205","id":487792739,"node_id":"MDU6SXNzdWU0ODc3OTI3Mzk=","number":46205,"title":"org.elasticsearch.xpack.slm.SnapshotLifecycleIT Fails due to Rate Limiting","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2019-08-31T17:28:21Z","updated_at":"2019-09-09T15:55:38Z","closed_at":"2019-09-09T15:55:38Z","author_association":"MEMBER","active_lock_reason":null,"body":"There's numerous failures of `org.elasticsearch.xpack.slm.SnapshotLifecycleIT` at the moment. The reason for this is that these tests use rate limiting with very low rate limits on the snapshot repository to simulate snapshot aborts and other concurrent scenarios.\r\n\r\nExample Failure -> https://gradle-enterprise.elastic.co/s/sscyvnvkf23gy/console-log\r\n\r\n\r\n```\r\n\r\nSuite: Test class org.elasticsearch.xpack.slm.SnapshotLifecycleIT\r\n--\r\n1> [2019-08-31T12:22:27,369][INFO ][o.e.x.s.SnapshotLifecycleIT] [testPolicyFailure] before test\r\n1> [2019-08-31T12:22:27,385][INFO ][o.e.x.s.SnapshotLifecycleIT] [testPolicyFailure] initializing REST clients against [http://[::1]:32827, http://127.0.0.1:33495, http://[::1]:43357, http://127.0.0.1:37929, http://[::1]:34097, http://127.0.0.1:43543, http://[::1]:36011, http://127.0.0.1:36555]\r\n1> [2019-08-31T12:22:31,480][INFO ][o.e.x.s.SnapshotLifecycleIT] [testPolicyFailure] after test\r\n1> [2019-08-31T12:22:31,539][INFO ][o.e.x.s.SnapshotLifecycleIT] [testPolicyManualExecution] before test\r\n1> [2019-08-31T12:22:35,781][INFO ][o.e.x.s.SnapshotLifecycleIT] [testPolicyManualExecution] after test\r\n1> [2019-08-31T12:22:35,824][INFO ][o.e.x.s.SnapshotLifecycleIT] [testSnapshotInProgress] before test\r\n1> [2019-08-31T12:22:38,715][INFO ][o.e.x.s.SnapshotLifecycleIT] [testSnapshotInProgress] after test\r\n1> [2019-08-31T12:22:38,769][INFO ][o.e.x.s.SnapshotLifecycleIT] [testFullPolicySnapshot] before test\r\n1> [2019-08-31T12:24:40,221][INFO ][o.e.x.s.SnapshotLifecycleIT] [testFullPolicySnapshot] There are still tasks running after this test that might break subsequent tests [cluster:admin/repository/put].\r\n1> [2019-08-31T12:24:40,222][INFO ][o.e.x.s.SnapshotLifecycleIT] [testFullPolicySnapshot] after test\r\n2> REPRODUCE WITH: ./gradlew :x-pack:plugin:ilm:qa:multi-node:integTestRunner --tests \"org.elasticsearch.xpack.slm.SnapshotLifecycleIT.testFullPolicySnapshot\" -Dtests.seed=4A8659A9FC9A2C94 -Dtests.security.manager=true -Dtests.locale=fy -Dtests.timezone=Atlantic/Azores -Dcompiler.java=12 -Druntime.java=11\r\n2> java.net.SocketTimeoutException: 30.000 milliseconds timeout on connection http-outgoing-40 [ACTIVE]\r\nat __randomizedtesting.SeedInfo.seed([4A8659A9FC9A2C94:435FF4A6DC4174C1]:0)\r\nat org.elasticsearch.client.RestClient.extractAndWrapCause(RestClient.java:778)\r\nat org.elasticsearch.client.RestClient.performRequest(RestClient.java:218)\r\nat org.elasticsearch.client.RestClient.performRequest(RestClient.java:221)\r\nat org.elasticsearch.client.RestClient.performRequest(RestClient.java:221)\r\nat org.elasticsearch.client.RestClient.performRequest(RestClient.java:221)\r\nat org.elasticsearch.client.RestClient.performRequest(RestClient.java:205)\r\nat org.elasticsearch.xpack.slm.SnapshotLifecycleIT.inializeRepo(SnapshotLifecycleIT.java:379)\r\nat org.elasticsearch.xpack.slm.SnapshotLifecycleIT.inializeRepo(SnapshotLifecycleIT.java:364)\r\nat org.elasticsearch.xpack.slm.SnapshotLifecycleIT.testFullPolicySnapshot(SnapshotLifecycleIT.java:85)\r\nÂ \r\nCaused by:\r\njava.net.SocketTimeoutException: 30.000 milliseconds timeout on connection http-outgoing-40 [ACTIVE]\r\n\r\n```\r\n\r\nThe problem with this approach is that low rate limits can lead to extremely long sleep times in the rate limiter. In one spot we limit to `1b/s` but read `8k` in one go -> we get minutes of sleeping. These tests passed more often before #42791 and #45689 but that PR changed timings in a way that made this trigger more often (I think this is due to the fact that we now write data in the first step of snapshotting and thus simply build up long waits before the concurrent action is tested ... before we had quite a bit of delay from first writing the snapshot metadata).\r\nI tried fixing improving this situation by using only a single snapshot thread in #46195 but it wasn't enough evidently.\r\n\r\nI'll see what better solution to these tests I can find here.","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}