{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45692","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45692/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45692/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45692/events","html_url":"https://github.com/elastic/elasticsearch/issues/45692","id":482175824,"node_id":"MDU6SXNzdWU0ODIxNzU4MjQ=","number":45692,"title":"Using Java API multi-thread snapshot index come across ConcurrentSnapshotExecutionException ","user":{"login":"guobinhit","id":26641090,"node_id":"MDQ6VXNlcjI2NjQxMDkw","avatar_url":"https://avatars1.githubusercontent.com/u/26641090?v=4","gravatar_id":"","url":"https://api.github.com/users/guobinhit","html_url":"https://github.com/guobinhit","followers_url":"https://api.github.com/users/guobinhit/followers","following_url":"https://api.github.com/users/guobinhit/following{/other_user}","gists_url":"https://api.github.com/users/guobinhit/gists{/gist_id}","starred_url":"https://api.github.com/users/guobinhit/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guobinhit/subscriptions","organizations_url":"https://api.github.com/users/guobinhit/orgs","repos_url":"https://api.github.com/users/guobinhit/repos","events_url":"https://api.github.com/users/guobinhit/events{/privacy}","received_events_url":"https://api.github.com/users/guobinhit/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-08-19T08:32:00Z","updated_at":"2019-08-19T08:58:23Z","closed_at":"2019-08-19T08:58:22Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: `6.6.0`\r\n\r\n**Plugins installed**: install snapshot plugin in es cluster.\r\n\r\n![image](https://user-images.githubusercontent.com/26641090/63250048-51d3cd80-c29d-11e9-9e14-e6b3dad41129.png)\r\n\r\n**JVM version**: `1.8.0_131`\r\n\r\n**OS version**: `Darwin Guobin.local 16.6.0 Darwin Kernel Version 16.6.0: Fri Apr 14 16:21:16 PDT 2017; root:xnu-3789.60.24~6/RELEASE_X86_64 x86_64`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nUsing Java API multi-thread snapshot index come across ConcurrentSnapshotExecutionException.\r\n\r\nRunning 3 threads of `LogArchiveSnapshotThread-0`, `LogArchiveSnapshotThread-1` and `LogArchiveSnapshotThread-2`,  snapshot method as below:\r\n\r\n```java\r\npublic ActionFuture<CreateSnapshotResponse> createSnapshot(String repositoryName, String indexName) {\r\n\r\n        String snapshotName = indexName + CommonConstant.SNAPSHOT_SUFFIX;\r\n\r\n        ClusterAdminClient clusterAdminClient = elasticsearchUtil.getClusterAdminClient();\r\n\r\n        CreateSnapshotRequestBuilder createSnapshotRequestBuilder = clusterAdminClient.prepareCreateSnapshot(repositoryName, snapshotName);\r\n\r\n        createSnapshotRequestBuilder.setIndices(indexName)\r\n                .setIncludeGlobalState(false)\r\n                .setWaitForCompletion(true);\r\n\r\n        ActionFuture<CreateSnapshotResponse> response = clusterAdminClient.createSnapshot(createSnapshotRequestBuilder.request());\r\n\r\n        if (response != null &&\r\n                SnapshotStatusEnum.SUCCESS.name().equals(response.actionGet().getSnapshotInfo().state().name())) {\r\n            logger.info(\"create snapshot success, current index is \" + indexName + \", snapshot is \" + snapshotName + \", repository is \" + repositoryName);\r\n        }\r\n\r\n        return response;\r\n    }\r\n``` \r\n\r\n**Log info**:\r\n\r\n```java\r\n2019-08-19 16:14:02.932 ERROR 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : LogArchiveSnapshotThread create snapshot index { cbp_transfer_webservice-2019-08-19 } come across a error, message is ConcurrentSnapshotExecutionException[[test541to660:cbp_transfer_webservice-2019-08-19_snapshot]  a snapshot is already running]\r\n2019-08-19 16:14:02.932  INFO 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : current thread is LogArchiveSnapshotThread-2, current processing index is remit_ebank_hessian-2019-08-19\r\n2019-08-19 16:14:02.944 ERROR 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : LogArchiveSnapshotThread create snapshot index { remit_ebank_hessian-2019-08-19 } come across a error, message is ConcurrentSnapshotExecutionException[[test541to660:remit_ebank_hessian-2019-08-19_snapshot]  a snapshot is already running]\r\n2019-08-19 16:14:02.944  INFO 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : current thread is LogArchiveSnapshotThread-2, current processing index is p2f_starter-2019-08-19\r\n2019-08-19 16:14:02.944 ERROR 4278 --- [pool-2-thread-2] c.y.l.c.common.LogArchiveSnapshotThread  : LogArchiveSnapshotThread create snapshot index { bankrouter_hessian-2019-08-19 } come across a error, message is ConcurrentSnapshotExecutionException[[test541to660:bankrouter_hessian-2019-08-19_snapshot]  a snapshot is already running]\r\n2019-08-19 16:14:02.944  INFO 4278 --- [pool-2-thread-2] c.y.l.c.common.LogArchiveSnapshotThread  : current thread is LogArchiveSnapshotThread-1, current processing index is monitor_center_hessian-2019-08-19\r\n2019-08-19 16:14:02.965 ERROR 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : LogArchiveSnapshotThread create snapshot index { p2f_starter-2019-08-19 } come across a error, message is ConcurrentSnapshotExecutionException[[test541to660:p2f_starter-2019-08-19_snapshot]  a snapshot is already running]\r\n2019-08-19 16:14:02.965 ERROR 4278 --- [pool-2-thread-2] c.y.l.c.common.LogArchiveSnapshotThread  : LogArchiveSnapshotThread create snapshot index { monitor_center_hessian-2019-08-19 } come across a error, message is ConcurrentSnapshotExecutionException[[test541to660:monitor_center_hessian-2019-08-19_snapshot]  a snapshot is already running]\r\n2019-08-19 16:14:02.965  INFO 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : current thread is LogArchiveSnapshotThread-2, current processing index is pp_cashier_app-2019-08-19\r\n2019-08-19 16:14:02.965  INFO 4278 --- [pool-2-thread-2] c.y.l.c.common.LogArchiveSnapshotThread  : current thread is LogArchiveSnapshotThread-1, current processing index is ap_order_hessian-2019-08-19\r\n2019-08-19 16:14:02.985 ERROR 4278 --- [pool-2-thread-3] c.y.l.c.common.LogArchiveSnapshotThread  : LogArchiveSnapshotThread create snapshot index { pp_cashier_app-2019-08-19 } come across a error, message is ConcurrentSnapshotExecutionException[[test541to660:pp_cashier_app-2019-08-19_snapshot]  a snapshot is already running]\r\n```\r\n\r\nBeside of this problem above, I also want to konw where is the ES java api doc? Thx!!!\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}