{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32446","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32446/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32446/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32446/events","html_url":"https://github.com/elastic/elasticsearch/issues/32446","id":345372145,"node_id":"MDU6SXNzdWUzNDUzNzIxNDU=","number":32446,"title":"_xpack/rollup/job doesn't work correctly","user":{"login":"jdu-mydevices","id":33299623,"node_id":"MDQ6VXNlcjMzMjk5NjIz","avatar_url":"https://avatars1.githubusercontent.com/u/33299623?v=4","gravatar_id":"","url":"https://api.github.com/users/jdu-mydevices","html_url":"https://github.com/jdu-mydevices","followers_url":"https://api.github.com/users/jdu-mydevices/followers","following_url":"https://api.github.com/users/jdu-mydevices/following{/other_user}","gists_url":"https://api.github.com/users/jdu-mydevices/gists{/gist_id}","starred_url":"https://api.github.com/users/jdu-mydevices/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdu-mydevices/subscriptions","organizations_url":"https://api.github.com/users/jdu-mydevices/orgs","repos_url":"https://api.github.com/users/jdu-mydevices/repos","events_url":"https://api.github.com/users/jdu-mydevices/events{/privacy}","received_events_url":"https://api.github.com/users/jdu-mydevices/received_events","type":"User","site_admin":false},"labels":[{"id":912843355,"node_id":"MDU6TGFiZWw5MTI4NDMzNTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Rollup","name":":Analytics/Rollup","color":"0e8a16","default":false,"description":"Turn fine-grained time-based data into coarser-grained data"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2018-07-27T21:30:40Z","updated_at":"2018-08-01T16:46:55Z","closed_at":"2018-08-01T16:46:55Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`6.3.0`):\r\n\r\n**Plugins installed**: [_xpack]\r\n\r\n**JVM version** (`1.8.0_161-b14`):\r\n\r\n**OS version** (`Linux 3.10.0-327.10.1.el7.x86_64`):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n1). Firstly, I have a job to rollup data with `\"interval\": \"1m\"`\r\n```\r\nPUT _xpack/rollup/job/rollup_data_minutes_job\r\n{\r\n    \"index_pattern\": \"data*\",\r\n    \"rollup_index\": \"rollup_data_minutes\",\r\n    \"cron\": \"* */5 * * * ?\",\r\n    \"page_size\" :1000,\r\n    \"groups\" : {\r\n      \"date_histogram\": {\r\n        \"field\": \"created_at\",\r\n        \"interval\": \"1m\",\r\n        \"time_zone\": \"UTC\"\r\n      },\r\n      \"terms\": {\r\n        \"fields\": [\"account_id\", \"data_id\"]\r\n      }\r\n    },\r\n    \"metrics\": [\r\n        {\r\n            \"field\": \"value\",\r\n            \"metrics\": [\"sum\"]\r\n        }\r\n    ]\r\n}\r\n```\r\n2). After that, I have another job to rollup the created indices in step `1)`\r\n```\r\nPUT _xpack/rollup/job/rollup_data_hours_job\r\n{\r\n    \"index_pattern\": \"rollup_data_minutes*\",\r\n    \"rollup_index\": \"rollup_data_hours\",\r\n    \"cron\": \"* */30 * * * ?\",\r\n    \"page_size\" :1000,\r\n    \"groups\" : {\r\n      \"date_histogram\": {\r\n        \"field\": \"created_at.date_histogram.timestamp\",\r\n        \"interval\": \"1h\",\r\n        \"time_zone\": \"UTC\"\r\n      },\r\n      \"terms\": {\r\n        \"fields\": [\"account_id.terms.value\", \"data_id.terms.value\"]\r\n      }\r\n    },\r\n    \"metrics\": [\r\n        {\r\n            \"field\": \"value.sum.value\",\r\n            \"metrics\": [\"sum\"]\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n**Problem**\r\nThe job can be created correctly but no result returned when searching it.\r\nI've confirmed that the `rollup_data_minutes` index returned several millions of data.\r\n```\r\nPOST /rollup_data_hours/_search\r\n{\r\n      \"query\": {\r\n        \"match_all\": {}\r\n      }\r\n}\r\n```\r\n```\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 0,\r\n    \"max_score\": null,\r\n    \"hits\": []\r\n  }\r\n}\r\n```\r\n\r\nAlso, I hope the result of metrics `\"avg\"` can also return the `\"sum\"` value in the result. now I can get `_count` only, so need to use the sum directly and then use `sum`/`count` to get the average.\r\n```\r\n    \"metrics\": [\r\n        {\r\n            \"field\": \"value\",\r\n            \"metrics\": [\"avg\"]\r\n        }\r\n    ]\r\n```\r\n\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}