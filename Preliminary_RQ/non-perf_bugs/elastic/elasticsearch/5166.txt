{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5166","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5166/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5166/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5166/events","html_url":"https://github.com/elastic/elasticsearch/issues/5166","id":27809894,"node_id":"MDU6SXNzdWUyNzgwOTg5NA==","number":5166,"title":"Documentation: aggregations/facets are not executed in the context of top level filters","user":{"login":"Fizzadar","id":1026154,"node_id":"MDQ6VXNlcjEwMjYxNTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1026154?v=4","gravatar_id":"","url":"https://api.github.com/users/Fizzadar","html_url":"https://github.com/Fizzadar","followers_url":"https://api.github.com/users/Fizzadar/followers","following_url":"https://api.github.com/users/Fizzadar/following{/other_user}","gists_url":"https://api.github.com/users/Fizzadar/gists{/gist_id}","starred_url":"https://api.github.com/users/Fizzadar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Fizzadar/subscriptions","organizations_url":"https://api.github.com/users/Fizzadar/orgs","repos_url":"https://api.github.com/users/Fizzadar/repos","events_url":"https://api.github.com/users/Fizzadar/events{/privacy}","received_events_url":"https://api.github.com/users/Fizzadar/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2014-02-18T17:08:44Z","updated_at":"2014-07-31T10:56:40Z","closed_at":"2014-07-31T10:56:40Z","author_association":"NONE","active_lock_reason":null,"body":"When running top level aggregations filters are ignored, while query values are not. I am going by the following line from [the guide](http://www.elasticsearch.org/guide/en/elasticsearch/reference/master/search-aggregations.html): \"(e.g. a top-level aggregation executes within the context of the executed query/filters of the search request)\" in thinking that both queries and filters should affect top-level aggregate results. Test case below, tested against ES 1.0.0.\n\n```\n# Add data\ncurl -X PUT localhost:9200/test/test/2 -d '{ \"term\": \"term1\", \"price\":100}'\ncurl -X PUT localhost:9200/test/test/2 -d '{ \"term\": \"term2\", \"price\":100}'\ncurl -X PUT localhost:9200/test/test/3 -d '{ \"term\": \"term3\", \"price\":500}'\n\n# Test with query\n# aggregate correctly returns count of 2\ncurl -X GET localhost:9200/test/test/_search -d '{\n  \"query\": {\n    \"range\": {\n      \"price\": {\n        \"from\": 0,\n        \"to\": 400\n      }\n    }\n  },\n  \"aggregations\": {\n    \"term\": {\n      \"stats\": {\n        \"field\": \"price\"\n      }\n    }\n  }\n}'\n\n# Test with filter\n# aggregate incorrectly returns count of 3 (ignores filter)\ncurl -X GET localhost:9200/test/test/_search -d '{\n  \"filter\": {\n    \"range\": {\n      \"price\": {\n        \"from\": 0,\n        \"to\": 400\n      }\n    }\n  },\n  \"aggregations\": {\n    \"term\": {\n      \"stats\": {\n        \"field\": \"price\"\n      }\n    }\n  }\n}'\n```\n\nHope this is useful, let me know if I can be of assistance!\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}