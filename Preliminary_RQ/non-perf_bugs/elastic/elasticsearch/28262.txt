{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28262","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28262/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28262/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28262/events","html_url":"https://github.com/elastic/elasticsearch/issues/28262","id":289250858,"node_id":"MDU6SXNzdWUyODkyNTA4NTg=","number":28262,"title":"Terms Aggregation inside a nested document and a filter in the main query returns or-linked counts","user":{"login":"SimonJonasGubler","id":32632429,"node_id":"MDQ6VXNlcjMyNjMyNDI5","avatar_url":"https://avatars3.githubusercontent.com/u/32632429?v=4","gravatar_id":"","url":"https://api.github.com/users/SimonJonasGubler","html_url":"https://github.com/SimonJonasGubler","followers_url":"https://api.github.com/users/SimonJonasGubler/followers","following_url":"https://api.github.com/users/SimonJonasGubler/following{/other_user}","gists_url":"https://api.github.com/users/SimonJonasGubler/gists{/gist_id}","starred_url":"https://api.github.com/users/SimonJonasGubler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SimonJonasGubler/subscriptions","organizations_url":"https://api.github.com/users/SimonJonasGubler/orgs","repos_url":"https://api.github.com/users/SimonJonasGubler/repos","events_url":"https://api.github.com/users/SimonJonasGubler/events{/privacy}","received_events_url":"https://api.github.com/users/SimonJonasGubler/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2018-01-17T12:36:23Z","updated_at":"2018-01-29T12:29:48Z","closed_at":"2018-01-29T12:29:48Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** : 5.6.5, 6.1.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_141\r\n\r\n**OS version** : Windows 10 Enterprise Version 1703\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n**Precondition:**\r\nThere is a nested type with an array of filteroptions in the inner object\r\nOne nested object with two inner objects is inserted. One with “opt1” in the filteroptions, one with “opt2”\r\nA query filters by “opt1” and has an aggregation with a terms aggregation on the filteroptions. \r\n\r\n**Expected behavior:**\r\nThe aggregation result for “opt2” should return 0\r\n\r\n**Actual behavior**:\r\nThe aggregation result for “opt2” returns 1\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Execute script to create an index, insert an entry and execute a query \r\n[ScriptForElastic5.6.txt](https://github.com/elastic/elasticsearch/files/1638844/ScriptForElastic5.6.txt)\r\nor for elastic 6\r\n[ScriptForElastic6.txt](https://github.com/elastic/elasticsearch/files/1638845/ScriptForElastic6.txt)\r\n\r\n 2. Investigate the result\r\n[Elastic5.6Result.txt](https://github.com/elastic/elasticsearch/files/1638842/Elastic5.6Result.txt)\r\n[Elastic6Result.txt](https://github.com/elastic/elasticsearch/files/1638843/Elastic6Result.txt)\r\n\r\nThe aggregation \"CountsOfAllFilterOptions\" contains a terms aggregation and a reverse_nested aggregation. The doc_count-results of both the \"opt1\" and \"opt2\" buckets as well as the reverse_nested aggregation are 1 but in our understanding the result of bucket \"opt1\" should be the count of documents with \r\n\"op1\" **and** \"opt2\" as filteroptions. \r\nInstead the result seems to be the count of documents with \r\n\"opt1\" **or** \"opt2\". \r\n\r\n\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}