{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27838","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27838/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27838/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27838/events","html_url":"https://github.com/elastic/elasticsearch/issues/27838","id":282401786,"node_id":"MDU6SXNzdWUyODI0MDE3ODY=","number":27838,"title":"Index with no changes gets new `sync_id` when becoming inactive.","user":{"login":"larschri","id":77080,"node_id":"MDQ6VXNlcjc3MDgw","avatar_url":"https://avatars3.githubusercontent.com/u/77080?v=4","gravatar_id":"","url":"https://api.github.com/users/larschri","html_url":"https://github.com/larschri","followers_url":"https://api.github.com/users/larschri/followers","following_url":"https://api.github.com/users/larschri/following{/other_user}","gists_url":"https://api.github.com/users/larschri/gists{/gist_id}","starred_url":"https://api.github.com/users/larschri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/larschri/subscriptions","organizations_url":"https://api.github.com/users/larschri/orgs","repos_url":"https://api.github.com/users/larschri/repos","events_url":"https://api.github.com/users/larschri/events{/privacy}","received_events_url":"https://api.github.com/users/larschri/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."}],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-12-15T11:39:03Z","updated_at":"2018-03-16T15:16:30Z","closed_at":"2018-03-16T15:16:30Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nVersion: 5.5.2, Build: b2f0c09/2017-08-14T12:33:14.154Z, JVM: 1.8.0_144\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\njava version \"1.8.0_144\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_144-b01)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nLinux xxx 3.13.0-33-generic #58-Ubuntu SMP Tue Jul 29 16:45:05 UTC 2014 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe problem is that restarting a node takes very long. It takes several hours to wait for a cluster to become *green* after restarting just one single node, even if there are no indexing and sync flush was successfully executed. The restarted node should be able to recover from local files since they are up to date, but it doesn't because the `sync_id` doesn't match.\r\n\r\nExpected behavior: After shutting down indexing and performing a successful synced flush it is expected that `sync_id`s stays the same.\r\n\r\nActual behavior: After shutting down indexing and performing a successful synced flush the `sync_id` changes when the index becomes *inactive*.\r\n\r\n**Steps to reproduce**:\r\n\r\n```shell\r\n# Create replicated index with single shard\r\ncurl -XPUT localhost:9200/testindex -d '{\"settings\":{\"index\":{\r\n  \"number_of_shards\" : 1,\r\n  \"number_of_replicas\" : 1\r\n}}}'\r\n\r\n# Index one document\r\ncurl -XPUT localhost:9200/testindex/doc/1 -d '{}'\r\n\r\n# Perform a synced flush\r\ncurl -XPOST localhost:9200/_flush/synced\r\n\r\n# Note the sync_id (if jq is not installed; navigate JSON correspondingly)\r\ncurl localhost:9200/_stats?level=shards | jq '.indices.testindex.shards[\"0\"][].commit.user_data.sync_id'\r\n\r\n# wait 5-6 minutes\r\n\r\n# The sync_id has changed:\r\ncurl localhost:9200/_stats?level=shards | jq '.indices.testindex.shards[\"0\"][].commit.user_data.sync_id'\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nWith debug logging enabled, something like this is printed:\r\n```\r\n[2017-12-15T11:30:21,439][DEBUG][o.e.i.e.Engine           ] [xxx] [testindex][0] successfully sync committed. sync id [AWBZ8H59yP3Rl7MoZfSx].\r\n[2017-12-15T11:30:22,312][DEBUG][o.e.i.s.IndexShard       ] [xxx] [testindex][0] shard is now inactive\r\n```\r\n","closed_by":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"performed_via_github_app":null}