[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/305732868","html_url":"https://github.com/elastic/elasticsearch/issues/25020#issuecomment-305732868","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25020","id":305732868,"node_id":"MDEyOklzc3VlQ29tbWVudDMwNTczMjg2OA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-06-02T09:07:31Z","updated_at":"2017-06-02T09:11:17Z","author_association":"MEMBER","body":"After digging some more I have realised that this is actually not a bug but we should clarify the behaviour int he documentation.\r\n\r\nFirstly,  the reduce script is run multiple times because the scripted_metric aggregation is a sub-aggregation of the terms aggregation it is evaluated for each of the terms buckets so the reduce script needs to be run for each bucket in the terms aggregation. In my recreation script above the reduce script is run 5 times because the terms aggregation produces five buckets (one for each of my five id terms).\r\n\r\nNow to why you get a NPE in the first reduce script:\r\n```\r\n \"double profit = 0; for (a in params._aggs) { profit += a } return profit\"\r\n```\r\nThe reason is because there are terms buckets where none of the documents that fall into the bucket match the filter aggregation. In my example above this is seen because of the document:\r\n\r\n```\r\nPUT test/doc/10\r\n{\r\n  \"id\": \"e\",\r\n  \"foo.bar\": \"fooo\",\r\n  \"foo.baz\": \"barr\"\r\n  \r\n}\r\n```\r\n\r\nwhich is the only document that contains the term `e` in the `id` field and also doesn't match the filter aggregation. This causes an [empty aggregation response to be created for the aggregation in that bucket when it is returned from the shards](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/search/aggregations/metrics/scripted/ScriptedMetricAggregator.java#L89) which the reduce script doesn't expect and deal with. If you replace the reduce script with the following it executes correctly:\r\n```\r\n\"double profit = 0; for (a in params._aggs) { if (a != null) { profit += a } } return profit\"\r\n```\r\nAt the moment there is no mention of the empty aggregation response in the [documentation for the scripted_metric aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/5.4/search-aggregations-metrics-scripted-metric-aggregation.html) so I think we should clarify it there.\r\n\r\nAnother thing that is a little confusing here is that the output for the error seemed to point to `profit` being `null` instead of `a`:\r\n```\r\n      \"script_stack\": [\r\n        \"profit += a } \",\r\n        \"^---- HERE\"\r\n      ],\r\n```\r\nI can sort of see why this happens as its not the fact that `a` is `null` that causes the error but its when the operation is applied to `profit` (i.e. when we try to increment profit by `null`) that the error occurs, so I'm not sure whether we should change this? /cc @jdconrad \r\n\r\nFor the second reduce script which uses `Debug.explain` the reason it is not showing that the value is null is that because the `Debug.explain` throws an exception to tell you what the value of the variable is, it is throwing the exception on the first bucket it is evaluating which does not have the empty aggregation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/305745098","html_url":"https://github.com/elastic/elasticsearch/issues/25020#issuecomment-305745098","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25020","id":305745098,"node_id":"MDEyOklzc3VlQ29tbWVudDMwNTc0NTA5OA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-06-02T10:02:07Z","updated_at":"2017-06-02T10:02:07Z","author_association":"MEMBER","body":"The documentation has been updated in https://github.com/elastic/elasticsearch/commit/5e7a79636d2bbad0525e677531a173d5e865230f","performed_via_github_app":null}]