{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14901","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14901/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14901/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14901/events","html_url":"https://github.com/elastic/elasticsearch/issues/14901","id":118088354,"node_id":"MDU6SXNzdWUxMTgwODgzNTQ=","number":14901,"title":"Issue with upsert by file ES v1.5.2 - COuld only be a documentation bug","user":{"login":"bitonp","id":2499269,"node_id":"MDQ6VXNlcjI0OTkyNjk=","avatar_url":"https://avatars1.githubusercontent.com/u/2499269?v=4","gravatar_id":"","url":"https://api.github.com/users/bitonp","html_url":"https://github.com/bitonp","followers_url":"https://api.github.com/users/bitonp/followers","following_url":"https://api.github.com/users/bitonp/following{/other_user}","gists_url":"https://api.github.com/users/bitonp/gists{/gist_id}","starred_url":"https://api.github.com/users/bitonp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitonp/subscriptions","organizations_url":"https://api.github.com/users/bitonp/orgs","repos_url":"https://api.github.com/users/bitonp/repos","events_url":"https://api.github.com/users/bitonp/events{/privacy}","received_events_url":"https://api.github.com/users/bitonp/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-11-20T17:32:52Z","updated_at":"2015-11-28T14:15:24Z","closed_at":"2015-11-28T14:15:24Z","author_association":"NONE","active_lock_reason":null,"body":"Trying to do an upsert with a script file (inline scripting kept off). Simple use case (simplified further):\n== mappings ===\n\"mappings\":{\n\"sometype\":{\n\"_source\":{\"enabled\": true},\n\"_ttl\":{\"enabled\":false},\n\"properties\":{\n\"somefield\":{\"type\":\"long\"},\n\"counter\":{\"type\":\"long\"} }\n}\n}\n\nUpsert done via curl....\ncurl -XPOST 'eshost:9200/test_index/sometype/11223344/_update' -d '{\n\"script\":{\n\"file\":\"sometype-add\"\n}, \n\"upsert\":{\n\"somefield\":\"11223344\",\n\"counter\":0\n}\n}'\n\nHave put a sometype-add.groovy in the scripts folder under /etc .. which does this:\nctx._source.counter += 1\nNothing too demanding here. \nIf the doc exists, the counter is updated. However... if the doc does not exist, we fail with:\n{\"error\":\"RemoteTransportException[[nodename][inet[/esserverip:9300]][indices:data/write/update]]; nested: DocumentMissingException[[index][0] [data][11223344]: document missing]; \",\"status\":404}\n\nI jumped through all teh relevant hoops for a few hoours. tried doc_as_upsert.. nothing. Then , out of frustration, I changed the call around to this:\n\ncurl -XPOST 'eshost:9200/test_index/sometype/11223344/_update' -d '{\n\"upsert\":{\n\"somefield\":\"11223344\",\n\"counter\":0\n},\n\"script\":{\n\"file\":\"sometype-add\"\n}\n}'\n.. and presto! If the doc exists, it adds to the counter.. if the doc does not exist it creates it. All you have to do is put the upsert first, and the script second.... I think this is an internal bugette... but one that needs highlighting....\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}