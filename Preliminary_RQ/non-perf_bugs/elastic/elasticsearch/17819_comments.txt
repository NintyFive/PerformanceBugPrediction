[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/211638735","html_url":"https://github.com/elastic/elasticsearch/issues/17819#issuecomment-211638735","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17819","id":211638735,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTYzODczNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-04-18T23:59:03Z","updated_at":"2016-04-19T00:04:06Z","author_association":"MEMBER","body":"This one is fun. The trouble starts in the innocuous looking [line 199 `Bootstrap.java`](https://github.com/elastic/elasticsearch/blob/6941966b1654106ed9249cd01c32bfa2e06b452f/core/src/main/java/org/elasticsearch/bootstrap/Bootstrap.java#L199):\n\n``` java\n199:        if (Strings.hasLength(pidFile)) {\n```\n\nThis triggers class initialization for `Strings` which causes the field `TIME_UUID_GENERATOR` to be initialized on [line 64](https://github.com/elastic/elasticsearch/blob/6941966b1654106ed9249cd01c32bfa2e06b452f/core/src/main/java/org/elasticsearch/common/Strings.java#L64):\n\n``` java\n64:    private static final UUIDGenerator TIME_UUID_GENERATOR = new TimeBasedUUIDGenerator();\n```\n\nThis in turn triggers class initialization for `TimeBasedUUIDGenerator` which causes the field `secureMungedAddressed` to be initialized on [line 38](https://github.com/elastic/elasticsearch/blob/6941966b1654106ed9249cd01c32bfa2e06b452f/core/src/main/java/org/elasticsearch/common/TimeBasedUUIDGenerator.java#L38):\n\n``` java\n38:    private static final byte[] secureMungedAddress = MacAddressProvider.getSecureMungedAddress();\n```\n\nNow the coup de grÃ¢ce. The method [`MacAddressProvider#getSecureMungedAddress`](https://github.com/elastic/elasticsearch/blob/6941966b1654106ed9249cd01c32bfa2e06b452f/core/src/main/java/org/elasticsearch/common/MacAddressProvider.java#L64) tries to get a secure MAC address for use in generating the time-based UUIDs. If all the network interfaces are disabled, then there is no MAC address to use so the check on [line 73](https://github.com/elastic/elasticsearch/blob/6941966b1654106ed9249cd01c32bfa2e06b452f/core/src/main/java/org/elasticsearch/common/MacAddressProvider.java#L73) passes:\n\n``` java\n73:        if (!isValidAddress(address)) {\n```\n\nwhich leads to the fatal logging statement on [line 74](https://github.com/elastic/elasticsearch/blob/6941966b1654106ed9249cd01c32bfa2e06b452f/core/src/main/java/org/elasticsearch/common/MacAddressProvider.java#L74):\n\n``` java\n74:             logger.warn(\"Unable to get a valid mac address, will use a dummy address\");\n```\n\nThis line being fatal because it's invoked _before_ logging has been initialized.\n\nTwo lessons:\n1. `static` is evil, don't do `static`\n2. logging in static methods using a statically-initialized static logger (instead of an instance of `logger` from an `AbstractComponent`) is prone to this problem\n\nI opened #17837.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/212024821","html_url":"https://github.com/elastic/elasticsearch/issues/17819#issuecomment-212024821","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17819","id":212024821,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMjAyNDgyMQ==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2016-04-19T17:20:24Z","updated_at":"2016-04-19T17:20:24Z","author_association":"MEMBER","body":"> This one is fun.\n\nSounds like it, thanks a lot for digging and fixing @jasontedor \n","performed_via_github_app":null}]