{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4443","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4443/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4443/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4443/events","html_url":"https://github.com/elastic/elasticsearch/issues/4443","id":24266595,"node_id":"MDU6SXNzdWUyNDI2NjU5NQ==","number":4443,"title":"Adding document to index fails when the number of Unassigned shards is greater than 1.","user":{"login":"blenihan","id":1334823,"node_id":"MDQ6VXNlcjEzMzQ4MjM=","avatar_url":"https://avatars3.githubusercontent.com/u/1334823?v=4","gravatar_id":"","url":"https://api.github.com/users/blenihan","html_url":"https://github.com/blenihan","followers_url":"https://api.github.com/users/blenihan/followers","following_url":"https://api.github.com/users/blenihan/following{/other_user}","gists_url":"https://api.github.com/users/blenihan/gists{/gist_id}","starred_url":"https://api.github.com/users/blenihan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blenihan/subscriptions","organizations_url":"https://api.github.com/users/blenihan/orgs","repos_url":"https://api.github.com/users/blenihan/repos","events_url":"https://api.github.com/users/blenihan/events{/privacy}","received_events_url":"https://api.github.com/users/blenihan/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2013-12-13T19:20:42Z","updated_at":"2013-12-16T16:46:56Z","closed_at":"2013-12-14T12:56:46Z","author_association":"NONE","active_lock_reason":null,"body":"You can reach this state by creating an index with more replicas than active nodes or by failing nodes after index was set up correctly.\n\nRepro:\n(copied from https://gist.github.com/creg/7775457.  He is sitting next to me)\n# clean up test index\n\ncurl -XDELETE \"http://localhost:9200/toomanyreplicas\"\n# create index\n\ncurl -XPOST \"http://localhost:9200/toomanyreplicas\" -d '\n{\n    \"index\" : {\n        \"analysis\" : {\n            \"analyzer\" : {\n                \"language_analyzer\" : {\n                    \"type\" : \"snowball\",\n                    \"language\" : \"English\"\n                }\n            }\n        },\n        \"number_of_shards\": 5,\n    \"number_of_replicas\": 2\n    }\n}\n'\n# create mapping\n\ncurl -XPOST \"http://localhost:9200/toomanyreplicas/Document/_mapping\" -d '\n{\n    \"Document\": {\n        \"_source\": {\n            \"compress\": false,\n            \"excludes\": [\n                \"fileAttachment\"\n            ]\n        },\n        \"properties\": {\n            \"fileAttachment\": {\n                \"type\": \"attachment\",\n                \"path\": \"full\",\n                \"fields\": {\n                    \"fileAttachment\": {\n                        \"type\": \"string\",\n                        \"term_vector\": \"with_positions_offsets\",\n                        \"index_analyzer\": \"language_analyzer\",\n                        \"search_analyzer\": \"language_analyzer\"\n                    },\n                    \"author\": {\n                        \"type\": \"string\",\n                        \"store\": true\n                    },\n                    \"title\": {\n                        \"type\": \"string\",\n                        \"store\": true,\n                        \"index_analyzer\": \"language_analyzer\"\n                    },\n                    \"name\": {\n                        \"type\": \"string\"\n                    },\n                    \"date\": {\n                        \"type\": \"date\",\n                        \"format\": \"dateOptionalTime\"\n                    },\n                    \"keywords\": {\n                        \"type\": \"string\"\n                    },\n                    \"content_type\": {\n                        \"type\": \"string\",\n                        \"store\": true\n                    },\n                    \"content_length\": {\n                        \"type\": \"integer\"\n                    }\n                }\n            },\n            \"id\": {\n                \"type\": \"string\"\n            },\n            \"currentVersionId\": {\n                \"type\": \"string\"\n            }\n        }\n    }\n}\n'\n# Attempt to index the document\n\ncurl -XPOST \"http://localhost:9200/toomanyreplicas/testdocument\" -d '\n{\n    \"fileAttachment\" : \"ZmlnaHRpbmc=\"\n}\n'\n\nExpect:\ndocument to be added to the good node\n\nActual:\n\n{\n  \"error\":\"UnavailableShardsException[[toomanyreplicas][4] [3] shardIt, [1] active : Timeout waiting for [1m], request: index {[toomanyreplicas][testdocument][QegOmpSTQZePZ1IaFeEmag], source[\\n{\\n    \\\"fileAttachment\\\" : \\\"ZmlnaHRpbmc=\\\"\\n}\\n]}]\",\n  \"status\":503\n}\n\n---\n\nbelow is the response from http://localhost:9200/_cluster/state in this condition\n\n{\"cluster_name\":\"blenihan-ES\",\"master_node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"blocks\":{},\"nodes\":{\"chKSwPhQRVqmqJTZnrIZfQ\":{\"name\":\"Beetle\",\"transport_address\":\"inet[/10.3.60.127:9300]\",\"attributes\":{}}},\"metadata\":{\"templates\":{},\"indices\":{\"toomanyreplicas\":{\"state\":\"open\",\"settings\":{\"index.analysis.analyzer.language_analyzer.language\":\"English\",\"index.number_of_replicas\":\"2\",\"index.number_of_shards\":\"5\",\"index.analysis.analyzer.language_analyzer.type\":\"snowball\",\"index.version.created\":\"900799\",\"index.uuid\":\"qjdWPfMoQdCU5SjD7FrA3g\"},\"mappings\":{\"Document\":{\"_source\":{\"compress\":false,\"excludes\":[\"fileAttachment\"]},\"properties\":{\"id\":{\"type\":\"string\"},\"fileAttachment\":{\"path\":\"full\",\"type\":\"attachment\",\"fields\":{\"author\":{\"store\":true,\"type\":\"string\"},\"title\":{\"index_analyzer\":\"language_analyzer\",\"store\":true,\"type\":\"string\"},\"keywords\":{\"type\":\"string\"},\"fileAttachment\":{\"analyzer\":\"language_analyzer\",\"term_vector\":\"with_positions_offsets\",\"type\":\"string\"},\"name\":{\"type\":\"string\"},\"content_length\":{\"type\":\"integer\"},\"date\":{\"format\":\"dateOptionalTime\",\"type\":\"date\"},\"content_type\":{\"store\":true,\"type\":\"string\"}}},\"currentVersionId\":{\"type\":\"string\"}}},\"testdoc\":{\"properties\":{\"fileAttachment\":{\"type\":\"string\"}}}},\"aliases\":[]}}},\"routing_table\":{\"indices\":{\"toomanyreplicas\":{\"shards\":{\"0\":[{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":0,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":0,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":0,\"index\":\"toomanyreplicas\"}],\"1\":[{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":1,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":1,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":1,\"index\":\"toomanyreplicas\"}],\"2\":[{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":2,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":2,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":2,\"index\":\"toomanyreplicas\"}],\"3\":[{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":3,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":3,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":3,\"index\":\"toomanyreplicas\"}],\"4\":[{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":4,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":4,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":4,\"index\":\"toomanyreplicas\"}]}}}},\"routing_nodes\":{\"unassigned\":[{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":0,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":0,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":1,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":1,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":2,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":2,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":3,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":3,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":4,\"index\":\"toomanyreplicas\"},{\"state\":\"UNASSIGNED\",\"primary\":false,\"node\":null,\"relocating_node\":null,\"shard\":4,\"index\":\"toomanyreplicas\"}],\"nodes\":{\"chKSwPhQRVqmqJTZnrIZfQ\":[{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":0,\"index\":\"toomanyreplicas\"},{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":1,\"index\":\"toomanyreplicas\"},{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":2,\"index\":\"toomanyreplicas\"},{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":3,\"index\":\"toomanyreplicas\"},{\"state\":\"STARTED\",\"primary\":true,\"node\":\"chKSwPhQRVqmqJTZnrIZfQ\",\"relocating_node\":null,\"shard\":4,\"index\":\"toomanyreplicas\"}]}},\"allocations\":[]}\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}