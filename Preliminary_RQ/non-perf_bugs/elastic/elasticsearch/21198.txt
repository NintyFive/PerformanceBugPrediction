{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21198","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21198/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21198/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21198/events","html_url":"https://github.com/elastic/elasticsearch/issues/21198","id":186276479,"node_id":"MDU6SXNzdWUxODYyNzY0Nzk=","number":21198,"title":"IndicesOptionsIntegrationIT#testUpdateSettings failure on 5.0 branch","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":475845060,"node_id":"MDU6TGFiZWw0NzU4NDUwNjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.2","name":"v5.0.2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-10-31T12:53:45Z","updated_at":"2017-06-16T16:56:43Z","closed_at":"2017-06-16T16:56:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Avast! `IndicesOptionsIntegrationIT`'s [sprung a leak](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+5.0+java9-periodic/488/console) on the 5.0 branch! `testUpdateSettings` failed with this reproduction:\r\n```\r\ngradle :core:integTest -Dtests.seed=D466EB96D225CD8D -Dtests.class=org.elasticsearch.indices.IndicesOptionsIntegrationIT -Dtests.method=\"testUpdateSettings\" -Dtests.security.manager=true -Dtests.locale=sw-UG -Dtests.timezone=Asia/Shanghai\r\n```\r\n\r\nOur robot butler tells me that the cause of the failure is:\r\n\r\n```\r\n1> java.lang.IllegalStateException: IndexWriter is still open on shard [barbaz][1]\r\n1> at org.elasticsearch.test.store.MockFSDirectoryService.checkIndex(MockFSDirectoryService.java:142) ~[framework-5.0.1-SNAPSHOT.jar:5.0.1-SNAPSHOT]\r\n1> at org.elasticsearch.test.store.MockFSIndexStore$Listener.afterIndexShardClosed(MockFSIndexStore.java:101) ~[framework-5.0.1-SNAPSHOT.jar:5.0.1-SNAPSHOT]\r\n1> at org.elasticsearch.index.CompositeIndexEventListener.afterIndexShardClosed(CompositeIndexEventListener.java:110) ~[main/:?]\r\n1> at org.elasticsearch.index.IndexService.closeShard(IndexService.java:405) ~[main/:?]\r\n1> at org.elasticsearch.index.IndexService.removeShard(IndexService.java:381) ~[main/:?]\r\n1> at org.elasticsearch.index.IndexService.close(IndexService.java:237) ~[main/:?]\r\n1> at org.elasticsearch.indices.IndicesService.removeIndex(IndicesService.java:506) ~[main/:?]\r\n1> at org.elasticsearch.indices.IndicesService.deleteIndex(IndicesService.java:568) ~[main/:?]\r\n1> at org.elasticsearch.indices.cluster.IndicesClusterStateService.deleteIndices(IndicesClusterStateService.java:254) ~[main/:?]\r\n1> at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:188) ~[main/:?]\r\n1> at org.elasticsearch.cluster.service.ClusterService.runTasksForExecutor(ClusterService.java:708) ~[main/:?]\r\n1> at org.elasticsearch.cluster.service.ClusterService$UpdateTask.run(ClusterService.java:894) ~[main/:?]\r\n1> at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:444) ~[main/:?]\r\n1> at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:237) ~[main/:?]\r\n1> at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:200) ~[main/:?]\r\n1> at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@9-ea/ThreadPoolExecutor.java:1161) ~[?:?]\r\n1> at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@9-ea/ThreadPoolExecutor.java:635) ~[?:?]\r\n1> at java.lang.Thread.run(java.base@9-ea/Thread.java:843) ~[?:?]\r\n1> Caused by: org.apache.lucene.store.LockObtainFailedException: Lock held by this virtual machine: /var/lib/jenkins/workspace/elastic+elasticsearch+5.0+java9-\r\nCaused by: org.apache.lucene.store.LockObtainFailedException: Lock held by this virtual machine: /var/lib/jenkins/workspace/elastic+elasticsearch+5.0+java9-periodic/core/build/testrun/integTest/J1/temp/org.elasticsearch.indices.IndicesOptionsIntegrationIT_D466EB96D225CD8D-001/tempDir-002/data/nodes/2/indices/3nw9U4VtSgGIsmt9ICaQ9Q/1/index/write.lock\r\n1> at org.apache.lucene.store.NativeFSLockFactory.obtainFSLock(NativeFSLockFactory.java:127) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.store.FSLockFactory.obtainLock(FSLockFactory.java:41) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.store.BaseDirectory.obtainLock(BaseDirectory.java:45) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.store.FilterDirectory.obtainLock(FilterDirectory.java:104) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.store.FilterDirectory.obtainLock(FilterDirectory.java:104) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.store.MockDirectoryWrapper.obtainLock(MockDirectoryWrapper.java:1049) ~[lucene-test-framework-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.store.FilterDirectory.obtainLock(FilterDirectory.java:104) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.apache.lucene.index.CheckIndex.<init>(CheckIndex.java:399) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\r\n1> at org.elasticsearch.test.store.MockFSDirectoryService.checkIndex(MockFSDirectoryService.java:123) ~[framework-5.0.1-SNAPSHOT.jar:5.0.1-SNAPSHOT] \r\n  1> \t... 17 more \r\n```\r\n\r\nAfter that all kinds of things failed because the butler couldn't shoot our test.","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}