{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21434","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21434/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21434/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21434/events","html_url":"https://github.com/elastic/elasticsearch/issues/21434","id":188304836,"node_id":"MDU6SXNzdWUxODgzMDQ4MzY=","number":21434,"title":"ElasticsearchParseException for custom date intervals 3w or 3M","user":{"login":"chrisdrusso","id":4182524,"node_id":"MDQ6VXNlcjQxODI1MjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/4182524?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisdrusso","html_url":"https://github.com/chrisdrusso","followers_url":"https://api.github.com/users/chrisdrusso/followers","following_url":"https://api.github.com/users/chrisdrusso/following{/other_user}","gists_url":"https://api.github.com/users/chrisdrusso/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisdrusso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisdrusso/subscriptions","organizations_url":"https://api.github.com/users/chrisdrusso/orgs","repos_url":"https://api.github.com/users/chrisdrusso/repos","events_url":"https://api.github.com/users/chrisdrusso/events{/privacy}","received_events_url":"https://api.github.com/users/chrisdrusso/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-11-09T17:25:48Z","updated_at":"2016-11-10T17:35:19Z","closed_at":"2016-11-10T13:04:03Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\n1.8.0_65\r\n1.8.0_111\r\n\r\n**OS version**:\r\nOs X 10.10.5\r\nWindows Server 2008 R2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nUsing a custom interval value denominated in weeks and a value greater than 1 (e.g., 2w) in a date_histogram aggregation request causes a ElasticsearchParseException saying \"failed to parse setting.\"\r\n\r\nUsing custom intervals denominated in months also often fails.  For example using 3M will convert to 13w and then cause the same parse exception.\r\n\r\n\r\n**Steps to reproduce**:\r\n 1. Create a line visualization.\r\n 2. Select \"Date Histogram\" as the aggregation\r\n 3. Select \"Custom\" interval.\r\n 4. Enter \"3w\" as the interval value.\r\n 5. Apply.\r\n\r\nUsing 3M as the custom interval value also fails.\r\n\r\n**Provide logs (if relevant)**:\r\nCaused by: org.elasticsearch.ElasticsearchParseException: failed to parse setting [DateHistogramAggregationBuilder.interval] with value [13w] as a time value: unit is missing or unrecognized\r\n        at org.elasticsearch.common.unit.TimeValue.parseTimeValue(TimeValue.java:350) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramAggregationBuilder.createRounding(DateHistogramAggregationBuilder.java:296) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.aggregations.bucket.histogram.DateHistogramAggregationBuilder.innerBuild(DateHistogramAggregationBuilder.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.aggregations.support.ValuesSourceAggregationBuilder.doBuild(ValuesSourceAggregationBuilder.java:300) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.aggregations.support.ValuesSourceAggregationBuilder.doBuild(ValuesSourceAggregationBuilder.java:49) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.aggregations.AbstractAggregationBuilder.build(AbstractAggregationBuilder.java:126) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.aggregations.AggregatorFactories$Builder.build(AggregatorFactories.java:211) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.SearchService.parseSource(SearchService.java:698) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.SearchService.createContext(SearchService.java:536) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:502) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:243) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$6(SearchTransportService.java:276) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_65]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_65]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_65]\r\n[2016-11-09T11:35:07,464][DEBUG][o.e.a.s.TransportSearchAction] [he1jgGc] [batdash][3], node[he1jgGcRTkuopKIoPkhh8g], [P], s[STARTED], a[id=GPzlTqcdTkCEH_ZzpPUP5w]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[batdash], indicesOptions=IndicesOptions[id=39, ignore_unavailable=true, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_alisases_to_multiple_indices=true, forbid_closed_indices=true], types=[], routing='null', preference='1478373887531', requestCache=null, scroll=null, source={\r\n  \"size\" : 0,\r\n  \"query\" : {\r\n    \"bool\" : {\r\n      \"must\" : [\r\n        {\r\n          \"query_string\" : {\r\n            \"query\" : \"*\",\r\n            \"fields\" : [ ],\r\n            \"use_dis_max\" : true,\r\n            \"tie_breaker\" : 0.0,\r\n            \"default_operator\" : \"or\",\r\n            \"auto_generate_phrase_queries\" : false,\r\n            \"max_determined_states\" : 10000,\r\n            \"lowercase_expanded_terms\" : true,\r\n            \"enable_position_increment\" : true,\r\n            \"fuzziness\" : \"AUTO\",\r\n            \"fuzzy_prefix_length\" : 0,\r\n            \"fuzzy_max_expansions\" : 50,\r\n            \"phrase_slop\" : 0,\r\n            \"analyze_wildcard\" : true,\r\n            \"locale\" : \"und\",\r\n            \"escape\" : false,\r\n            \"boost\" : 1.0\r\n          }\r\n        },\r\n        {\r\n          \"range\" : {\r\n            \"@timestamp\" : {\r\n              \"from\" : 1420145441771,\r\n              \"to\" : 1478029841772,\r\n              \"include_lower\" : true,\r\n              \"include_upper\" : true,\r\n              \"format\" : \"epoch_millis\",\r\n              \"boost\" : 1.0\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\" : false,\r\n      \"adjust_pure_negative\" : true,\r\n      \"boost\" : 1.0\r\n    }\r\n  },\r\n  \"aggregations\" : {\r\n    \"2\" : {\r\n      \"date_histogram\" : {\r\n        \"field\" : \"@timestamp\",\r\n        \"time_zone\" : \"America/New_York\",\r\n        \"interval\" : \"13w\",\r\n        \"offset\" : 0,\r\n        \"order\" : {\r\n          \"_key\" : \"asc\"\r\n        },\r\n        \"keyed\" : false,\r\n        \"min_doc_count\" : 1\r\n      },\r\n      \"aggregations\" : {\r\n        \"3\" : {\r\n          \"terms\" : {\r\n            \"field\" : \"NIIN\",\r\n            \"size\" : 5,\r\n            \"shard_size\" : -1,\r\n            \"min_doc_count\" : 1,\r\n            \"shard_min_doc_count\" : 0,\r\n            \"show_term_doc_count_error\" : false,\r\n            \"order\" : [\r\n              {\r\n                \"1\" : \"desc\"\r\n              },\r\n              {\r\n                \"_term\" : \"asc\"\r\n              }\r\n            ]\r\n          },\r\n          \"aggregations\" : {\r\n            \"1\" : {\r\n              \"sum\" : {\r\n                \"field\" : \"DMD_QTY\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"ext\" : { }\r\n}}] lastShard [true]\r\norg.elasticsearch.transport.RemoteTransportException: [he1jgGc][127.0.0.1:9300][indices:data/read/search[phase/query]]","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}