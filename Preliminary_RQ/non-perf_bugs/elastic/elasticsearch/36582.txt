{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36582","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36582/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36582/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36582/events","html_url":"https://github.com/elastic/elasticsearch/issues/36582","id":390515070,"node_id":"MDU6SXNzdWUzOTA1MTUwNzA=","number":36582,"title":"X-pack for Es-Hadoop can not connect use user & pass","user":{"login":"imperio-wxm","id":8111349,"node_id":"MDQ6VXNlcjgxMTEzNDk=","avatar_url":"https://avatars3.githubusercontent.com/u/8111349?v=4","gravatar_id":"","url":"https://api.github.com/users/imperio-wxm","html_url":"https://github.com/imperio-wxm","followers_url":"https://api.github.com/users/imperio-wxm/followers","following_url":"https://api.github.com/users/imperio-wxm/following{/other_user}","gists_url":"https://api.github.com/users/imperio-wxm/gists{/gist_id}","starred_url":"https://api.github.com/users/imperio-wxm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imperio-wxm/subscriptions","organizations_url":"https://api.github.com/users/imperio-wxm/orgs","repos_url":"https://api.github.com/users/imperio-wxm/repos","events_url":"https://api.github.com/users/imperio-wxm/events{/privacy}","received_events_url":"https://api.github.com/users/imperio-wxm/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2018-12-13T04:38:07Z","updated_at":"2018-12-13T06:23:27Z","closed_at":"2018-12-13T06:23:27Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n6.2.4\r\n\r\n**JVM version** (`java -version`):\r\n\r\njava version \"1.8.0_121\"\r\n\r\n**Hadoop version**:\r\n\r\n2.6.0-cdh5.11.1\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI want make a mapreduce with es use Es-Hadoop, however can not connect es cluster when I install X-pack for es.\r\n\r\n```shell\r\n// mapreduce conf\r\nconf.setBoolean(\"mapred.map.tasks.speculative.execution\", false);\r\nconf.setBoolean(\"mapred.reduce.tasks.speculative.execution\", false);\r\nconf.set(\"es.net.http.auth.user\", \"xxxx\");\r\nconf.set(\"es.net.http.auth.pass\", \"xxxx\");\r\nconf.set(\"es.nodes\", \"xxxx:9200\");\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```shell\r\n// error log on datanode\r\n2018-12-13 10:55:17,834 INFO [main] org.elasticsearch.hadoop.util.Version: Elasticsearch Hadoop v6.2.4 [0dadc1ea14]\r\n2018-12-13 10:55:18,095 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,095 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,096 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,096 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,097 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,097 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,099 ERROR [main] org.elasticsearch.hadoop.rest.NetworkClient: Node [10.174.20.34:9200] failed (Connection refused (Connection refused)); selected next node [xxxx:9200]\r\n2018-12-13 10:55:18,100 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,100 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,101 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,101 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,101 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,101 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,103 ERROR [main] org.elasticsearch.hadoop.rest.NetworkClient: Node [xxxx:9200] failed (Connection refused (Connection refused)); selected next node [xxxx:9200]\r\n2018-12-13 10:55:18,105 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,105 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,106 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,106 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,106 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: I/O exception (java.net.ConnectException) caught when processing request: Connection refused (Connection refused)\r\n2018-12-13 10:55:18,106 INFO [main] org.apache.commons.httpclient.HttpMethodDirector: Retrying request\r\n2018-12-13 10:55:18,107 ERROR [main] org.elasticsearch.hadoop.rest.NetworkClient: Node [xxxx:9200] failed (Connection refused (Connection refused)); no other nodes left - aborting...\r\n2018-12-13 10:55:18,109 WARN [main] org.apache.hadoop.mapred.YarnChild: Exception running child : org.elasticsearch.hadoop.rest.EsHadoopNoNodesLeftException: Connection error (check network and/or proxy settings)- all nodes failed; tried [[xxxx:9200, xxxx:9200, xxxx:9200]] \r\n\tat org.elasticsearch.hadoop.rest.NetworkClient.execute(NetworkClient.java:149)\r\n\tat org.elasticsearch.hadoop.rest.RestClient.execute(RestClient.java:380)\r\n\tat org.elasticsearch.hadoop.rest.RestClient.execute(RestClient.java:344)\r\n\tat org.elasticsearch.hadoop.rest.RestClient.execute(RestClient.java:348)\r\n\tat org.elasticsearch.hadoop.rest.RestClient.get(RestClient.java:158)\r\n\tat org.elasticsearch.hadoop.rest.RestClient.getHttpNodes(RestClient.java:115)\r\n\tat org.elasticsearch.hadoop.rest.InitializationUtils.discoverNodesIfNeeded(InitializationUtils.java:92)\r\n\tat org.elasticsearch.hadoop.rest.RestService.createWriter(RestService.java:579)\r\n\tat org.elasticsearch.hadoop.mr.EsOutputFormat$EsRecordWriter.init(EsOutputFormat.java:173)\r\n\tat org.elasticsearch.hadoop.mr.EsOutputFormat$EsRecordWriter.write(EsOutputFormat.java:149)\r\n\tat org.apache.hadoop.mapred.ReduceTask$NewTrackingRecordWriter.write(ReduceTask.java:558)\r\n\tat org.apache.hadoop.mapreduce.task.TaskInputOutputContextImpl.write(TaskInputOutputContextImpl.java:89)\r\n\tat org.apache.hadoop.mapreduce.lib.reduce.WrappedReducer$Context.write(WrappedReducer.java:105)\r\n\tat org.apache.hadoop.mapreduce.Reducer.reduce(Reducer.java:150)\r\n\tat org.apache.hadoop.mapreduce.Reducer.run(Reducer.java:171)\r\n\tat org.apache.hadoop.mapred.ReduceTask.runNewReducer(ReduceTask.java:627)\r\n\tat org.apache.hadoop.mapred.ReduceTask.run(ReduceTask.java:389)\r\n\tat org.apache.hadoop.mapred.YarnChild$2.run(YarnChild.java:164)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat javax.security.auth.Subject.doAs(Subject.java:422)\r\n\tat org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1920)\r\n\tat org.apache.hadoop.mapred.YarnChild.main(YarnChild.java:158)\r\n```\r\n\r\nI use Java Client is work:\r\n\r\n```java\r\nSettings settings = Settings.builder().put(\"client.transport.ignore_cluster_name\", true)\r\n                .put(\"xpack.security.user\", bundle.getString(\"es.cluster.username\") + \":\" + bundle.getString(\"es.cluster.password\"))\r\n                .put(\"xpack.ssl.verification_mode\", \"certificate\")\r\n                .put(\"xpack.ssl.keystore.path\", path)\r\n                .put(\"xpack.ssl.truststore.path\", path)\r\n                .put(\"xpack.security.transport.ssl.enabled\", \"true\").build();\r\nList<TransportAddress> addresses = new ArrayList<>();\r\nfor (String broker : esClusterIp.split(\",\")) {\r\n\tTransportAddress address = new TransportAddress(\r\n\t\t\tInetAddress.getByName(broker.split(\":\")[0]), Integer.parseInt(broker.split(\":\")[1]));\r\n\taddresses.add(address);\r\n}\r\nTransportClient tc = new PreBuiltXPackTransportClient(settings);\r\n```\r\n\r\n","closed_by":{"login":"imperio-wxm","id":8111349,"node_id":"MDQ6VXNlcjgxMTEzNDk=","avatar_url":"https://avatars3.githubusercontent.com/u/8111349?v=4","gravatar_id":"","url":"https://api.github.com/users/imperio-wxm","html_url":"https://github.com/imperio-wxm","followers_url":"https://api.github.com/users/imperio-wxm/followers","following_url":"https://api.github.com/users/imperio-wxm/following{/other_user}","gists_url":"https://api.github.com/users/imperio-wxm/gists{/gist_id}","starred_url":"https://api.github.com/users/imperio-wxm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imperio-wxm/subscriptions","organizations_url":"https://api.github.com/users/imperio-wxm/orgs","repos_url":"https://api.github.com/users/imperio-wxm/repos","events_url":"https://api.github.com/users/imperio-wxm/events{/privacy}","received_events_url":"https://api.github.com/users/imperio-wxm/received_events","type":"User","site_admin":false},"performed_via_github_app":null}