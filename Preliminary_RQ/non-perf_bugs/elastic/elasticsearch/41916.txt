{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41916","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41916/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41916/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41916/events","html_url":"https://github.com/elastic/elasticsearch/issues/41916","id":441432278,"node_id":"MDU6SXNzdWU0NDE0MzIyNzg=","number":41916,"title":"Unable to create snapshot backup repository in S3","user":{"login":"ashish-kalbhor","id":2133383,"node_id":"MDQ6VXNlcjIxMzMzODM=","avatar_url":"https://avatars2.githubusercontent.com/u/2133383?v=4","gravatar_id":"","url":"https://api.github.com/users/ashish-kalbhor","html_url":"https://github.com/ashish-kalbhor","followers_url":"https://api.github.com/users/ashish-kalbhor/followers","following_url":"https://api.github.com/users/ashish-kalbhor/following{/other_user}","gists_url":"https://api.github.com/users/ashish-kalbhor/gists{/gist_id}","starred_url":"https://api.github.com/users/ashish-kalbhor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ashish-kalbhor/subscriptions","organizations_url":"https://api.github.com/users/ashish-kalbhor/orgs","repos_url":"https://api.github.com/users/ashish-kalbhor/repos","events_url":"https://api.github.com/users/ashish-kalbhor/events{/privacy}","received_events_url":"https://api.github.com/users/ashish-kalbhor/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-05-07T20:29:55Z","updated_at":"2019-05-13T04:42:09Z","closed_at":"2019-05-11T19:16:19Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**:\r\n```\r\n# bin/elasticsearch --version\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\nVersion: 6.5.4, Build: oss/tar/d2ef93d/2018-12-17T21:17:40.758843Z, JVM: 11.0.1\r\n```\r\n\r\n**Plugins installed**: \r\n```\r\n# bin/elasticsearch-plugin list\r\nrepository-s3\r\n```\r\n\r\n**Description of the problem**:\r\n\r\nWhen I try to create an Elasticsearch snapshot repository in S3 I get the following error:\r\n\r\n```\r\n$ curl -v -XPUT graylog-elasticsearch-client:9200/_snapshot/my_s3_repository -H \"Content-Type: application/json\" -d \"{\r\n>     \\\"type\\\": \\\"s3\\\",\r\n>     \\\"settings\\\": {\r\n>         \\\"bucket\\\": \\\"es-testbackup\\\",\r\n>         \\\"compress\\\": true\r\n>     }\r\n> }\"\r\n> PUT /_snapshot/my_s3_repository HTTP/1.1\r\n> User-Agent: curl/7.35.0\r\n> Host: graylog-elasticsearch-client:9200\r\n> Accept: */*\r\n> Content-Type: application/json\r\n> Content-Length: 101\r\n> \r\n< HTTP/1.1 500 Internal Server Error\r\n< content-type: application/json; charset=UTF-8\r\n< content-length: 466\r\n< \r\n{\"error\":{\"root_cause\":[{\"type\":\"amazon_service_exception\",\"reason\":\"amazon_service_exception: Internal Server Error (Service: null; Status Code: 500; Error Code: null; Request ID: null)\"}],\"type\":\"repository_exception\",\"reason\":\"[my_s3_repository] cannot create blob store\",\"caused_by\":{\"type\":\"amazon_service_exception\",\"reason\":\"amazon_service_exception: Internal Server Error (Service: null; Status Code: 500; Error Code: null; Request ID: null)\"}},\"status\":500}\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\n\r\n 1. Set `s3.client.default.endpoint: \"s3.us-west-1.amazonaws.com\"` in elasticsearch.yml\r\n 2. Set the s3 access keys in secure settings:\r\n\r\n ```\r\n # bin/elasticsearch-keystore list\r\n keystore.seed\r\n s3.client.default.access_key\r\n s3.client.default.secret_key\r\n ```\r\n  Verified same AWS S3 keys work on awscli and I can upload using `aws s3 cp <>`\r\n\r\n 3. Reload settings (just to be sure):\r\n\r\n ```\r\n $ curl -X POST \"graylog-elasticsearch-client:9200/_nodes/reload_secure_settings\"\r\n ```\r\n\r\n 4. Create snapshot repository (fails with status code 500)\r\n\r\n \r\n ```\r\n $ curl -v -XPUT graylog-elasticsearch-client:9200/_snapshot/my_s3_repository -H \"Content-Type: application/json\" -d \"{\r\n >     \\\"type\\\": \\\"s3\\\",\r\n >     \\\"settings\\\": {\r\n >         \\\"bucket\\\": \\\"es-testbackup\\\",\r\n >         \\\"compress\\\": true\r\n >     }\r\n > }\"\r\n > PUT /_snapshot/my_s3_repository HTTP/1.1\r\n > User-Agent: curl/7.35.0\r\n > Host: graylog-elasticsearch-client:9200\r\n > Accept: */*\r\n > Content-Type: application/json\r\n > Content-Length: 101\r\n > \r\n < HTTP/1.1 500 Internal Server Error\r\n < content-type: application/json; charset=UTF-8\r\n < content-length: 466\r\n < \r\n {\"error\":{\"root_cause\":[{\"type\":\"amazon_service_exception\",\"reason\":\"amazon_service_exception: Internal Server Error (Service: null; Status Code: 500; Error Code: null; Request ID: null)\"}],\"type\":\"repository_exception\",\"reason\":\"[my_s3_repository] cannot create blob store\",\"caused_by\":{\"type\":\"amazon_service_exception\",\"reason\":\"amazon_service_exception: Internal Server Error (Service: null; Status Code: 500; Error Code: null; Request ID: null)\"}},\"status\":500}\r\n ```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n I see this below stacktrace in ES logs:\r\n\r\n ```\r\n [2019-05-07T20:20:41,347][WARN ][r.suppressed             ] [graylog-elasticsearch-client-7c5c9956b9-7hdxj] path: /_snapshot/my_s3_repository, params: {repository=my_s3_repository}\r\norg.elasticsearch.transport.RemoteTransportException: [graylog-elasticsearch-master-1][10.233.111.202:9300][cluster:admin/repository/put]\r\nCaused by: org.elasticsearch.repositories.RepositoryException: [my_s3_repository] cannot create blob store\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.blobStore(BlobStoreRepository.java:336) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat org.elasticsearch.repositories.s3.S3Repository.blobStore(S3Repository.java:258) ~[?:?]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.startVerification(BlobStoreRepository.java:635) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat org.elasticsearch.repositories.RepositoriesService.lambda$verifyRepository$2(RepositoriesService.java:218) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:624) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\nCaused by: org.elasticsearch.common.io.stream.NotSerializableExceptionWrapper: amazon_service_exception: Internal Server Error (Service: null; Status Code: 500; Error Code: null; Request ID: null)\r\n\tat com.amazonaws.internal.EC2CredentialsUtils.handleErrorResponse(EC2CredentialsUtils.java:179) ~[?:?]\r\n\tat com.amazonaws.internal.EC2CredentialsUtils.readResource(EC2CredentialsUtils.java:126) ~[?:?]\r\n\tat com.amazonaws.auth.EC2CredentialsFetcher.fetchCredentials(EC2CredentialsFetcher.java:121) ~[?:?]\r\n\tat com.amazonaws.auth.EC2CredentialsFetcher.getCredentials(EC2CredentialsFetcher.java:82) ~[?:?]\r\n\tat com.amazonaws.auth.InstanceProfileCredentialsProvider.getCredentials(InstanceProfileCredentialsProvider.java:164) ~[?:?]\r\n\tat com.amazonaws.auth.EC2ContainerCredentialsProviderWrapper.getCredentials(EC2ContainerCredentialsProviderWrapper.java:75) ~[?:?]\r\n\tat java.security.AccessController.doPrivileged(Native Method) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.SocketAccess.doPrivileged(SocketAccess.java:42) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3Service$PrivilegedInstanceProfileCredentialsProvider.getCredentials(S3Service.java:184) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutor.getCredentialsFromContext(AmazonHttpClient.java:1184) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutor.runBeforeRequestHandlers(AmazonHttpClient.java:774) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutor.doExecute(AmazonHttpClient.java:726) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeWithTimer(AmazonHttpClient.java:719) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutor.execute(AmazonHttpClient.java:701) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutor.access$500(AmazonHttpClient.java:669) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient$RequestExecutionBuilderImpl.execute(AmazonHttpClient.java:651) ~[?:?]\r\n\tat com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:515) ~[?:?]\r\n\tat com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:4443) ~[?:?]\r\n\tat com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:4390) ~[?:?]\r\n\tat com.amazonaws.services.s3.AmazonS3Client.headBucket(AmazonS3Client.java:1354) ~[?:?]\r\n\tat com.amazonaws.services.s3.AmazonS3Client.doesBucketExist(AmazonS3Client.java:1293) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3BlobStore.lambda$new$0(S3BlobStore.java:74) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.SocketAccess.lambda$doPrivilegedVoid$0(SocketAccess.java:57) ~[?:?]\r\n\tat java.security.AccessController.doPrivileged(Native Method) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.SocketAccess.doPrivilegedVoid(SocketAccess.java:56) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3BlobStore.<init>(S3BlobStore.java:73) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3Repository.createBlobStore(S3Repository.java:251) ~[?:?]\r\n\tat org.elasticsearch.repositories.s3.S3Repository.createBlobStore(S3Repository.java:53) ~[?:?]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.blobStore(BlobStoreRepository.java:332) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat org.elasticsearch.repositories.s3.S3Repository.blobStore(S3Repository.java:258) ~[?:?]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.startVerification(BlobStoreRepository.java:635) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat org.elasticsearch.repositories.RepositoriesService.lambda$verifyRepository$2(RepositoriesService.java:218) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:624) ~[elasticsearch-6.5.4.jar:6.5.4]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) ~[?:?]\r\n ```\r\n\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}