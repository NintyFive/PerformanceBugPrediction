{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977/events","html_url":"https://github.com/elastic/elasticsearch/issues/18977","id":161179523,"node_id":"MDU6SXNzdWUxNjExNzk1MjM=","number":18977,"title":"Duplicate documents retrieved from _search using sorting on string","user":{"login":"bqk-","id":2953722,"node_id":"MDQ6VXNlcjI5NTM3MjI=","avatar_url":"https://avatars1.githubusercontent.com/u/2953722?v=4","gravatar_id":"","url":"https://api.github.com/users/bqk-","html_url":"https://github.com/bqk-","followers_url":"https://api.github.com/users/bqk-/followers","following_url":"https://api.github.com/users/bqk-/following{/other_user}","gists_url":"https://api.github.com/users/bqk-/gists{/gist_id}","starred_url":"https://api.github.com/users/bqk-/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bqk-/subscriptions","organizations_url":"https://api.github.com/users/bqk-/orgs","repos_url":"https://api.github.com/users/bqk-/repos","events_url":"https://api.github.com/users/bqk-/events{/privacy}","received_events_url":"https://api.github.com/users/bqk-/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-06-20T12:02:58Z","updated_at":"2016-06-21T07:40:14Z","closed_at":"2016-06-21T07:40:14Z","author_association":"NONE","active_lock_reason":null,"body":"When searching trough a few documents (1206 in that case) in an index (updated with deletes, inserts, updates from time to time), I got some duplicates or not depending on the sorting I supply.\n\n**Elasticsearch version**:\n2.1.0  \n\n**JVM version**:\nopenjdk version \"1.8.0_66-internal\"\nOpenJDK Runtime Environment (build 1.8.0_66-internal-b17)\nOpenJDK 64-Bit Server VM (build 25.66-b17, mixed mode)\n\n**OS version**:\nLinux CBISES02 3.16.0-4-amd64 #1 SMP Debian 3.16.7-ckt11-1+deb8u6 (2015-11-09) x86_64 GNU/Linux\n\n**Description of the problem including expected versus actual behavior**:\nI have an index with the following mapping:\n\n```\n{  \n   \"state\":\"open\",\n   \"settings\":{  \n      \"index\":{  \n         \"creation_date\":\"1466088694234\",\n         \"number_of_shards\":\"10\",\n         \"number_of_replicas\":\"1\",\n         \"uuid\":\"4tiKdB_6RWe-x2LoxDGOFg\",\n         \"version\":{  \n            \"created\":\"2010099\"\n         }\n      }\n   },\n   \"mappings\":{  \n      \"product\":{  \n         \"_routing\":{  \n            \"required\":true\n         },\n         \"dynamic\":\"false\",\n         \"_all\":{  \n            \"enabled\":false\n         },\n         \"properties\":{  \n            \"id\":{  \n               \"index\":\"not_analyzed\",\n               \"type\":\"string\"\n            },\n            \"entityId\":{  \n               \"index\":\"not_analyzed\",\n               \"type\":\"string\"\n            },\n            \"categories\":{  \n               \"type\":\"integer\"\n            },\n            \"name\":{  \n               \"type\":\"string\",\n               \"fields\":{  \n                  \"raw\":{  \n                     \"index\":\"not_analyzed\",\n                     \"type\":\"string\"\n                  }\n               }\n            },\n            \"routingKey\":{  \n               \"index\":\"not_analyzed\",\n               \"type\":\"string\"\n            }\n            (...)\n         }\n      }\n   },\n   \"aliases\":[  \n      (.. some aliases)\n   }\n```\n\nRetrieving the documents using the following query returns 1206 documents, **with** duplicates and therefor some documents are missing. Note that re-indexing changes the number of duplicates.\n\n```\n{\n  \"from\": page * 3, // page from 0 to no more documents \n  \"size\": 3,\n  \"sort\": [\n    {\n      \"name.raw\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nRetrieving the documents using the following query returns 1206 documents, **without** duplicates.\n\n```\n{\n  \"from\": page * 3, //page from 0 to no more documents \n  \"size\": 3,\n  \"sort\": [\n    {\n      \"entityId\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nAs there is a routing key, only one shard is hit at any time for both searches so the sorting should be consistent.\n\n**Expected result**:\nNo duplicates, regardless of the sorting supplied.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}