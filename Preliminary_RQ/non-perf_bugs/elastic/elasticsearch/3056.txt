{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3056","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3056/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3056/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3056/events","html_url":"https://github.com/elastic/elasticsearch/issues/3056","id":14467277,"node_id":"MDU6SXNzdWUxNDQ2NzI3Nw==","number":3056,"title":"Accessing fields of nested doc in custom score script may cause documents missing in query result","user":{"login":"junjun-zhang","id":1071695,"node_id":"MDQ6VXNlcjEwNzE2OTU=","avatar_url":"https://avatars2.githubusercontent.com/u/1071695?v=4","gravatar_id":"","url":"https://api.github.com/users/junjun-zhang","html_url":"https://github.com/junjun-zhang","followers_url":"https://api.github.com/users/junjun-zhang/followers","following_url":"https://api.github.com/users/junjun-zhang/following{/other_user}","gists_url":"https://api.github.com/users/junjun-zhang/gists{/gist_id}","starred_url":"https://api.github.com/users/junjun-zhang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/junjun-zhang/subscriptions","organizations_url":"https://api.github.com/users/junjun-zhang/orgs","repos_url":"https://api.github.com/users/junjun-zhang/repos","events_url":"https://api.github.com/users/junjun-zhang/events{/privacy}","received_events_url":"https://api.github.com/users/junjun-zhang/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2013-05-17T19:12:09Z","updated_at":"2014-08-08T12:11:39Z","closed_at":"2014-08-08T12:11:39Z","author_association":"NONE","active_lock_reason":null,"body":"I recently ran into a problem of missing documents in query result when custom score script is used. After some testing, I found that the problem seems occur when the script tries to access a field in a nested doc where a particular root document does not contain any such nested doc.\n\nTo reproduce the problem, test data and queries can be found here: http://goo.gl/iHOc5. The example may not make much sense in real world, but the idea is to sort products by average rate from users' review. One particular requirement is to always treat anonymous user's rate as 3 and assign rate as 3 for products with no reviews.\n\nWe can determine whether a user is anonymous or not by checking review.user.member_id field is empty or not: doc['review.user.member_id'].empty, this seems work fine except that products with no reviews are dropped out in the result as the first query example shows. Is this a bug? As there is no query/filter that excludes documents, shouldn't all documents be returned?\n\nAlso, there seems no way to determine whether a review exists or not. The second query example shows doc['review'].empty does not work, this makes sense because indeed, there is not such field as 'review' under the 'product' index, 'review' is a nested document. However, the question remains: is there a way to determine the existence of a nested doc?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}