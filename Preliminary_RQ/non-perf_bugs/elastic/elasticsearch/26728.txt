{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26728","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26728/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26728/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26728/events","html_url":"https://github.com/elastic/elasticsearch/issues/26728","id":259301507,"node_id":"MDU6SXNzdWUyNTkzMDE1MDc=","number":26728,"title":"Some Japanese characters changed or missing in aggregations","user":{"login":"tdoman","id":11098266,"node_id":"MDQ6VXNlcjExMDk4MjY2","avatar_url":"https://avatars1.githubusercontent.com/u/11098266?v=4","gravatar_id":"","url":"https://api.github.com/users/tdoman","html_url":"https://github.com/tdoman","followers_url":"https://api.github.com/users/tdoman/followers","following_url":"https://api.github.com/users/tdoman/following{/other_user}","gists_url":"https://api.github.com/users/tdoman/gists{/gist_id}","starred_url":"https://api.github.com/users/tdoman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tdoman/subscriptions","organizations_url":"https://api.github.com/users/tdoman/orgs","repos_url":"https://api.github.com/users/tdoman/repos","events_url":"https://api.github.com/users/tdoman/events{/privacy}","received_events_url":"https://api.github.com/users/tdoman/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2017-09-20T21:04:27Z","updated_at":"2017-09-29T09:50:23Z","closed_at":"2017-09-25T09:45:09Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: 1.7.5\r\nNEST: 1.9.2\r\n\r\nBefore the \"keyword\" type, we created our own analyzer to accomplish the same purpose (we called it \"tag_analyzer\").  As far as I can tell, we're doing everything we should be doing to support languages such as Japanese and yet our aggregations on that field lose or modify some of the characters.  Below I'll include all the pertinent mappings etc. to reproduce.  With those examples, you'll see the Japanese stored and returned properly in the documents themselves but the aggregations produce the unexpected results.  The examples:\r\n\r\n1. ビジネスプラン produces ヒシネスフラン\r\n2. Eラーニング produces eラニング\r\n\r\nHere is all the repro data required.\r\n```\r\nPUT /_template/test_japanese\r\n{\r\n\t\"template\": \"*\",\r\n\t\"settings\": {\r\n\t\t\"analysis\": {\r\n\t\t\t\"analyzer\": {\r\n\t\t\t\t\"tag_analyzer\": {\r\n\t\t\t\t\t\"type\": \"custom\",\r\n\t\t\t\t\t\"tokenizer\": \"keyword\",\r\n\t\t\t\t\t\"filter\": [\"icu_normalizer\", \"icu_folding\"],\r\n\t\t\t\t\t\"char_filter\": [\"html_strip\"]\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nPUT /tests_v1\r\n{\r\n\t\"mappings\": {\r\n\t\t\"test\": {\r\n\t\t\t\"dynamic\": \"false\",\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"title\": {\r\n\t\t\t\t\t\"type\": \"string\"\r\n\t\t\t\t},\r\n\t\t\t\t\"tags\": {\r\n\t\t\t\t\t\"type\": \"string\",\r\n\t\t\t\t\t\"fields\": {\r\n\t\t\t\t\t\t\"raw\": {\r\n\t\t\t\t\t\t\t\"type\": \"string\",\r\n\t\t\t\t\t\t\t\"analyzer\": \"tag_analyzer\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nPUT /tests_v1/test/1\r\n{\r\n\t\"title\": \"This is tagged w/ some Japanese\",\r\n\t\"tags\": [\"ビジネスプラン\"]\r\n}\r\n\r\nPUT /tests_v1/test/2\r\n{\r\n\t\"title\": \"Another one tagged w/ some Japanese\",\r\n\t\"tags\": [\"Eラーニング\"]\r\n}\r\n\r\nPOST /tests_v1/test/_search\r\n{\r\n   \"aggs\": {\r\n      \"Category\": {\r\n         \"filter\": {\r\n            \"match_all\": {}\r\n         },\r\n         \"aggs\": {\r\n            \"Category\": {\r\n               \"terms\": {\r\n                  \"field\": \"tags.raw\",\r\n                  \"size\": 100\r\n               }\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}