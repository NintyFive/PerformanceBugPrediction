{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14927","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14927/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14927/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14927/events","html_url":"https://github.com/elastic/elasticsearch/issues/14927","id":118339148,"node_id":"MDU6SXNzdWUxMTgzMzkxNDg=","number":14927,"title":"After upgrading from ES 1.7 to 2.0, getting lots of IllegalIndexShardStateException when bulk creating indices","user":{"login":"bjorn-ali-goransson","id":668160,"node_id":"MDQ6VXNlcjY2ODE2MA==","avatar_url":"https://avatars2.githubusercontent.com/u/668160?v=4","gravatar_id":"","url":"https://api.github.com/users/bjorn-ali-goransson","html_url":"https://github.com/bjorn-ali-goransson","followers_url":"https://api.github.com/users/bjorn-ali-goransson/followers","following_url":"https://api.github.com/users/bjorn-ali-goransson/following{/other_user}","gists_url":"https://api.github.com/users/bjorn-ali-goransson/gists{/gist_id}","starred_url":"https://api.github.com/users/bjorn-ali-goransson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bjorn-ali-goransson/subscriptions","organizations_url":"https://api.github.com/users/bjorn-ali-goransson/orgs","repos_url":"https://api.github.com/users/bjorn-ali-goransson/repos","events_url":"https://api.github.com/users/bjorn-ali-goransson/events{/privacy}","received_events_url":"https://api.github.com/users/bjorn-ali-goransson/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2015-11-23T08:47:12Z","updated_at":"2015-11-23T21:08:09Z","closed_at":"2015-11-23T18:03:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hello,\n\nWe have a tool that creates a language-contenttype matrix of indices at first run (it checks what indices are missing from the matrix), which functioned well using ES 1.7 but now we're getting lots of  `IllegalIndexShardStateException` exceptions.\n\nSo we issue a `_cluster/health?wait_for_status=yellow` before each index creation HTTP request, still same issue.\n\nWe wait 1000ms before the cluster health request, and 1000ms after each index creation request, still same issue.\n\nCould it be that the yellow status is reached too fast? We always run with an empty ES instance when testing (ie remove `data` and `logs` dir before starting). Sometimes even the first index to be created seems to cause the error?\n\nTips for further investigation is appreciated.\n\n```\n[2015-11-23 07:37:58,716][INFO ][cluster.metadata         ] [my-name] [content__1fzc2hfheucqdv2_q5nmpa__en] creating index, cause [api], templates [], shards [5]/[1], mappings [content]\n[2015-11-23 07:38:00,983][INFO ][cluster.metadata         ] [my-name] [content__p9p2lcwchuwe4atddvvd2w__en] creating index, cause [api], templates [], shards [5]/[1], mappings [content]\n[2015-11-23 07:38:03,281][INFO ][cluster.metadata         ] [my-name] [content__tuslngocl06jrzeywjpdzw__en] creating index, cause [api], templates [], shards [5]/[1], mappings [content]\n[2015-11-23 07:38:05,576][INFO ][cluster.metadata         ] [my-name] [content__hkwufjcos0urbpkg6t7dnq__en] creating index, cause [api], templates [], shards [5]/[1], mappings [content]\n[2015-11-23 07:38:07,968][INFO ][cluster.metadata         ] [my-name] [content__w6mzamir00cz2uk6ot7ijw__en] creating index, cause [api], templates [], shards [5]/[1], mappings [content]\n[2015-11-23 07:38:08,299][DEBUG][action.admin.indices.stats] [my-name] [indices:monitor/stats] failed to execute operation for shard [[content__w6mzamir00cz2uk6ot7ijw__en][3], node[NSXOyiZxTT63LKBFnm3ESA], [P], v[1], s[INITIALIZING], a[id=OckfAhmIRiSxOjXG8J4Mcg], unassigned_info[[reason=INDEX_CREATED], at[2015-11-23T06:38:07.969Z]]]\n[content__w6mzamir00cz2uk6ot7ijw__en][[content__w6mzamir00cz2uk6ot7ijw__en][3]] BroadcastShardOperationFailedException[operation indices:monitor/stats failed]; nested: IllegalIndexShardStateException[CurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED, RELOCATED]];\n  at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.onShardOperation(TransportBroadcastByNodeAction.java:399)\n  at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:376)\n  at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:365)\n  at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n  at java.lang.Thread.run(Thread.java:745)\nCaused by: [content__w6mzamir00cz2uk6ot7ijw__en][[content__w6mzamir00cz2uk6ot7ijw__en][3]] IllegalIndexShardStateException[CurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED, RELOCATED]]\n  at org.elasticsearch.index.shard.IndexShard.readAllowed(IndexShard.java:957)\n  at org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:791)\n  at org.elasticsearch.index.shard.IndexShard.docStats(IndexShard.java:612)\n  at org.elasticsearch.action.admin.indices.stats.CommonStats.<init>(CommonStats.java:131)\n  at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:165)\n  at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:47)\n  at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.onShardOperation(TransportBroadcastByNodeAction.java:395)\n  ... 7 more\n```\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}