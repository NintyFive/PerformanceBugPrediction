{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23880","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23880/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23880/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23880/events","html_url":"https://github.com/elastic/elasticsearch/issues/23880","id":218986259,"node_id":"MDU6SXNzdWUyMTg5ODYyNTk=","number":23880,"title":"_msearch query filtering","user":{"login":"izenk","id":6417697,"node_id":"MDQ6VXNlcjY0MTc2OTc=","avatar_url":"https://avatars2.githubusercontent.com/u/6417697?v=4","gravatar_id":"","url":"https://api.github.com/users/izenk","html_url":"https://github.com/izenk","followers_url":"https://api.github.com/users/izenk/followers","following_url":"https://api.github.com/users/izenk/following{/other_user}","gists_url":"https://api.github.com/users/izenk/gists{/gist_id}","starred_url":"https://api.github.com/users/izenk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/izenk/subscriptions","organizations_url":"https://api.github.com/users/izenk/orgs","repos_url":"https://api.github.com/users/izenk/repos","events_url":"https://api.github.com/users/izenk/events{/privacy}","received_events_url":"https://api.github.com/users/izenk/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-04-03T16:16:10Z","updated_at":"2017-04-04T00:41:12Z","closed_at":"2017-04-04T00:41:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\njava version \"1.8.0_60\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_60-b27)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.60-b23, mixed mode)\r\n\r\n**OS version**:\r\nUbuntu 14.04 x64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nSend query to get some metrics (gathered by metricbeats), filter it and group by several conditions\r\n\r\n**Steps to reproduce**:\r\n 1. Enable metricbeat system module\r\n 2. Import metricsets template for ELS \r\n 3. send query\r\n\r\n```json\r\n{\"search_type\":\"query_then_fetch\",\"ignore_unavailable\":true,\"index\":[\"metricbeat-2017.04.02\",\"metricbeat-2017.04.03\"]}\r\n{\"size\":0,\"query\":{\"bool\":{\"filter\":[{\"range\":{\"@timestamp\":{\"gte\":\"1491166800000\",\"lte\":\"1491253199999\",\"format\":\"epoch_millis\"}}},{\"query_string\":{\"analyze_wildcard\":true,\"query\":\"role:db\"}}]}},\"aggs\":{\"5\":{\"terms\":{\"field\":\"role_host\",\"size\":10,\"order\":{\"_term\":\"asc\"},\"min_doc_count\":0},\"aggs\":{\"2\":{\"date_histogram\":{\"interval\":\"1m\",\"field\":\"@timestamp\",\"min_doc_count\":0,\"extended_bounds\":{\"min\":\"1491166800000\",\"max\":\"1491253199999\"},\"format\":\"epoch_millis\"},\"aggs\":{\"1\":{\"avg\":{\"field\":\"system.load.1\"}}}}}}}}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```json\r\n{\"responses\":[{\"took\":100,\"timed_out\":false,\"_shards\":{\"total\":18,\"successful\":18,\"failed\":0},\"hits\":{\"total\":994883,\"max_score\":0.0,\"hits\":[]},\"aggregations\":{\"5\":{\"doc_count_error_upper_bound\":0,\"sum_other_doc_count\":0,\"buckets\":[{\"key\":\"lb1.lb.ap.prd\",\"doc_count\":0,\"2\":{\"buckets\":[{\"key_as_string\":\"1491166800000\",\"key\":1491166800000,\"doc_count\":0,\"1\":{\"value\":null}},{\"key_as_string\":\"1491166860000\",\"key\":1491166860000,\"doc_count\":0,\"1\":{\"value\":null}},{\"key_as_string\":\"1491166920000\",\"key\":1491166920000,\"doc_count\":0,\"1\":{\"value\":null}},{\"key_as_string\":\"1491166980000\",\"key\":1491166980000,\"doc_count\":0,\"1\":{\"value\":null}},\"status\":200}]}\r\n```\r\nResponce is provided partly because of huge number of rows, but it's enough to reproduce issue: key:lb1.lb.ap.prd - this host has no role:db, it's role is role:lb. Issue is, that filtering is not working, I'm getting aggregation by all role_host values, but should get only where role:db\r\n\r\n<img width=\"1267\" alt=\"screen shot 2017-04-03 at 19 11 08\" src=\"https://cloud.githubusercontent.com/assets/6417697/24619100/abf0aef8-18a1-11e7-8e69-8cc7455ba0d7.png\">\r\n\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}