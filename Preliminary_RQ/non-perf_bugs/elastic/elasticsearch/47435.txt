{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/47435","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47435/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47435/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47435/events","html_url":"https://github.com/elastic/elasticsearch/issues/47435","id":501429878,"node_id":"MDU6SXNzdWU1MDE0Mjk4Nzg=","number":47435,"title":"elasticsearch-shard remove-corrupted-data doesn't work on missing metadata","user":{"login":"ct0br0","id":54405045,"node_id":"MDQ6VXNlcjU0NDA1MDQ1","avatar_url":"https://avatars2.githubusercontent.com/u/54405045?v=4","gravatar_id":"","url":"https://api.github.com/users/ct0br0","html_url":"https://github.com/ct0br0","followers_url":"https://api.github.com/users/ct0br0/followers","following_url":"https://api.github.com/users/ct0br0/following{/other_user}","gists_url":"https://api.github.com/users/ct0br0/gists{/gist_id}","starred_url":"https://api.github.com/users/ct0br0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ct0br0/subscriptions","organizations_url":"https://api.github.com/users/ct0br0/orgs","repos_url":"https://api.github.com/users/ct0br0/repos","events_url":"https://api.github.com/users/ct0br0/events{/privacy}","received_events_url":"https://api.github.com/users/ct0br0/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2019-10-02T11:25:12Z","updated_at":"2019-11-13T14:27:53Z","closed_at":"2019-11-13T14:27:53Z","author_association":"NONE","active_lock_reason":null,"body":"`elasticsearch-shard` appears to be the tool for removing corrupted metadata.\r\nThis has happened several times to us after updating past 7.0.0\r\n\r\nIssue: directory structure and files are either deleted or never created, and `elasticsearch-shard` (remove-corrupted-data) can not remove it from the metadata\r\n\r\nSteps:\r\nrecreate directory structure (as `elasticsearch-shard` errors out \"directory must exist\" if it does not)\r\nrun `elasticsearch-shard` (hits null pointer exception, because only directories exist)\r\n\r\n> /usr/share/elasticsearch/bin $ ./elasticsearch-shard remove-corrupted-data --index dce_rpc-2019.08.28 --shard-id 24 -d /data/nsm/elasticsearch/nodes/0/indices/TUa5c332RFGKmM6yZSK-Rw/0/index\r\n> ERROR StatusLogger No Log4j 2 configuration file found. Using default configuration (logging only errors to the console), or user programmatically provided configurations. Set system property 'log4j2.debug' to show Log4j 2 internal initialization logging. See https://logging.apache.org/log4j/2.x/manual/configuration.html for instructions on how to configure Log4j 2\r\n> -----------------------------------------------------------------------\r\n> \r\n>     WARNING: Elasticsearch MUST be stopped before running this tool.\r\n> \r\n>   Please make a complete backup of your index before using this tool.\r\n> \r\n> -----------------------------------------------------------------------\r\n> Exception in thread \"main\" java.lang.NullPointerException\r\n> \tat org.elasticsearch.index.shard.RemoveCorruptedShardDataCommand.findAndProcessShardPath(RemoveCorruptedShardDataCommand.java:152)\r\n> \tat org.elasticsearch.index.shard.RemoveCorruptedShardDataCommand.execute(RemoveCorruptedShardDataCommand.java:282)\r\n> \tat org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)\r\n> \tat org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)\r\n> \tat org.elasticsearch.cli.MultiCommand.execute(MultiCommand.java:77)\r\n> \tat org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)\r\n> \tat org.elasticsearch.cli.Command.main(Command.java:90)\r\n> \tat org.elasticsearch.index.shard.ShardToolCli.main(ShardToolCli.java:35)\r\n> \r\n> \r\n> /usr/share/elasticsearch/bin $ ls  /data/nsm/elasticsearch/nodes/0/indices/TUa5c332RFGKmM6yZSK-Rw/0/\r\n> index  _state  translog\r\n\r\n\r\n\r\nWhat I'd expect:\r\nKill the shard and not have to `rm -rf` the entire node and rely on replicas.\r\n\r\nHopefully there's an error in my steps.\r\n\r\n\r\nelastic 7.3.0 (no plugins)\r\noracle linux 7.6\r\nnetwork drives (vSAN) for elastic storage (though this happens on physical boxes with docker containers too)\r\n","closed_by":{"login":"ebadyano","id":26631211,"node_id":"MDQ6VXNlcjI2NjMxMjEx","avatar_url":"https://avatars0.githubusercontent.com/u/26631211?v=4","gravatar_id":"","url":"https://api.github.com/users/ebadyano","html_url":"https://github.com/ebadyano","followers_url":"https://api.github.com/users/ebadyano/followers","following_url":"https://api.github.com/users/ebadyano/following{/other_user}","gists_url":"https://api.github.com/users/ebadyano/gists{/gist_id}","starred_url":"https://api.github.com/users/ebadyano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ebadyano/subscriptions","organizations_url":"https://api.github.com/users/ebadyano/orgs","repos_url":"https://api.github.com/users/ebadyano/repos","events_url":"https://api.github.com/users/ebadyano/events{/privacy}","received_events_url":"https://api.github.com/users/ebadyano/received_events","type":"User","site_admin":false},"performed_via_github_app":null}