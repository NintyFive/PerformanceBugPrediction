[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461847361","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-461847361","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":461847361,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTg0NzM2MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T15:50:14Z","updated_at":"2019-02-08T15:50:14Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461858600","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-461858600","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":461858600,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTg1ODYwMA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T16:22:28Z","updated_at":"2019-02-08T16:22:28Z","author_association":"MEMBER","body":"I muted this test method with #38634 on master, 7.x and 7.0","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464359256","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-464359256","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":464359256,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDM1OTI1Ng==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-02-16T16:13:45Z","updated_at":"2019-02-16T16:13:45Z","author_association":"MEMBER","body":"@bleskes @dnhatn @DaveCTurner @martijnvg @ywelsch I think that I can explain what is occurring in this test, and what is occurring here is a blocker issue.\r\n\r\nThis issue is the result of adding recovery from remote.\r\n\r\nWith recovery from remote, we copy over the index files and there is no translog replay phase. If the leader does a flush before the follower initiates recovery from remote, after recovery from remote the follower will be fully caught up all primary shards of the follower will have empty translogs. When a replica shard of the follower attempts to recover from the primary shard of the follower, we want to replay translog from the local checkpoint of the commit, to bake a history of operations for it. Since the primary shards of the follower have empty translogs, this replay can not happen and recovery will fail. That explains the following:\r\n\r\n```\r\nRemoteTransportException[[follower3][127.0.0.1:58606][internal:index/shard/recovery/start_recovery]]; nested: IllegalStateException[translog replay failed to cover required sequence numbers (required range [1:174). first missing op is [1]]; ], allocation_status[no_attempt]]\r\n```\r\n\r\nImmediately, I see two options:\r\n - `InternalEngine#readHistoryOperations` could serve operations from the Lucene history instead of the translog; however, this interplays with the need for shard history retention leases to interplay with recovery to ensure that these operations exist\r\n - the primary shards of the follower could build their own translog from Lucene history after remotely recovering files\r\n\r\nI am going to mute this test for now and open a new issue marked as a blocker.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464365491","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-464365491","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":464365491,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDM2NTQ5MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-02-16T17:32:16Z","updated_at":"2019-02-16T17:32:16Z","author_association":"MEMBER","body":"I have marked this test as awaiting a fix in 6.7, 7.0, 7.x, and master.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464367213","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-464367213","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":464367213,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDM2NzIxMw==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-02-16T17:54:07Z","updated_at":"2019-02-16T17:54:07Z","author_association":"MEMBER","body":"@jasontedor Thanks for digging into this. @martijnvg  and I found this issue in https://github.com/elastic/elasticsearch/issues/38949. I am working on the fix for this - it's pretty contained. We can use the local checkpoint of the recovery target to validate the sending operations instead of tracking them locally on the recovery source.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464368952","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-464368952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":464368952,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDM2ODk1Mg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-02-16T18:16:39Z","updated_at":"2019-02-16T18:17:21Z","author_association":"CONTRIBUTOR","body":"Is this caused (or exacerbated) by #38904? Prior to #38904 if soft deletes were enabled we _did_ read historical operations from Lucene during peer recovery, and I think the follower primary would have retained that history in Lucene for the duration of the recovery.\r\n\r\nI ask because I note that the first report of this failure comes from a time before when #38904 was merged.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464369423","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-464369423","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":464369423,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDM2OTQyMw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2019-02-16T18:23:30Z","updated_at":"2019-02-16T18:23:30Z","author_association":"MEMBER","body":"Yes that exacerbates it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/467158949","html_url":"https://github.com/elastic/elasticsearch/issues/38633#issuecomment-467158949","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38633","id":467158949,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NzE1ODk0OQ==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-02-25T19:55:16Z","updated_at":"2019-02-25T19:55:16Z","author_association":"MEMBER","body":"This should be fixed by #39006. I unmuted this test in https://github.com/elastic/elasticsearch/commit/f59b8cdb30ffd18975b49c1566e3d38c46c18eb2.","performed_via_github_app":null}]