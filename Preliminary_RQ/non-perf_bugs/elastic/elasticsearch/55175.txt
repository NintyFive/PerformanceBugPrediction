{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/55175","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55175/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55175/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55175/events","html_url":"https://github.com/elastic/elasticsearch/issues/55175","id":599778695,"node_id":"MDU6SXNzdWU1OTk3Nzg2OTU=","number":55175,"title":"Removing phases from an ILM policy while some indices are mid-policy can cause log spam","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2020-04-14T18:38:06Z","updated_at":"2020-04-15T20:16:22Z","closed_at":"2020-04-15T19:03:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): observed in logs from clusters on versions ranging from 6.8.5 to 7.7.0, reproducible on 7.6.2, there is a different but similar bug ([see below](https://github.com/elastic/elasticsearch/issues/55175#issuecomment-613682808)) in prerelease versions of 7.7.0.\r\n\r\nIf a policy is changed to remove some phases while it is in use by an index that is partway through the policy, ILM can get \"stuck\" in a state for that index where it emits a log every poll interval for each index that's \"stuck\". There's no functionality errors, as this (as far as I'm aware) can only occur when at the end of a policy anyway, just log spam.\r\n\r\nThe log entries in question look like this:\r\n```\r\n2020-04-14T12:02:50,691][ERROR][o.e.x.i.IndexLifecycleRunner] [Elastic-MBP-4.local] current step [{\"phase\":\"warm\",\"action\":\"complete\",\"name\":\"complete\"}] for index [test-000001] with policy [my_policy] is not recognized\r\n```\r\n\r\nIt appears that this occurs when an index is at the end of a phase (e.g. in step `warm/completed/completed`) when the policy is updated to remove phases following where the index is currently.  In the example of an index in the `warm` phase, the JSON definition for the phase is cached, but when there are no subsequent phases, the step will be generated from the cached policy JSON as `completed/completed/completed`, rather than `warm/completed/completed`, which leads to this error.\r\n\r\nThis bug appears to have been fixed as part of #51631 in 7.7.0, but another bug was introduced ([see below](https://github.com/elastic/elasticsearch/issues/55175#issuecomment-613682808)) which leads to very similar log spam. (Update: Bug only present in prerelease versions of 7.7.0)\r\n\r\nReproduction script (it is recommended to set `indices.lifecycle.history_index_enabled` to `false` to make the ILM logs easier to read):\r\n```\r\n// Set ILM poll interval to 1s to speed things up\r\nPUT _cluster/settings\r\n{\r\n    \"transient\": {\r\n        \"indices.lifecycle.poll_interval\": \"1s\",\r\n        \"logger.org.elasticsearch.xpack.ilm\": \"trace\",\r\n        \"logger.org.elasticsearch.xpack.core.ilm\": \"trace\"\r\n    }\r\n}\r\n\r\n// Create a policy with multiple phases + an index using it\r\nPUT _ilm/policy/my_policy\r\n{\r\n    \"policy\": {\r\n        \"phases\": {\r\n            \"hot\": {\r\n                \"actions\": {\r\n                    \"rollover\": {\r\n                        \"max_docs\": 1\r\n                    }\r\n                }\r\n            },\r\n            \"warm\": {\r\n                \"actions\": {\r\n                    \"set_priority\": {\r\n                        \"priority\": 10\r\n                    }\r\n                }\r\n            },\r\n            \"delete\": {\r\n                \"min_age\": \"1d\",\r\n                \"actions\": {\r\n                    \"delete\": {}\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nPUT test-000001\r\n{\r\n    \"settings\": {\r\n        \"index.number_of_shards\": 3,\r\n        \"index.lifecycle.name\": \"my_policy\",\r\n        \"index.lifecycle.rollover_alias\": \"test-alias\"\r\n    },\r\n    \"aliases\": {\r\n        \"test-alias\": {\r\n            \"is_write_index\": true\r\n        }\r\n    }\r\n}\r\n\r\n// Once the index is checking rollover conditions, index a doc\r\nPOST test-alias/_doc\r\n{\r\n  \"foo\": \"bar\"\r\n}\r\n\r\n// Wait for the index to finish the warm phase, then update the policy to remove the warm & delete phases\r\nPUT _ilm/policy/my_policy\r\n{\r\n    \"policy\": {\r\n        \"phases\": {\r\n            \"hot\": {\r\n                \"actions\": {\r\n                    \"rollover\": {\r\n                        \"max_docs\": 2\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nFollowing all that, this error should now be emitted every poll interval (`1s` per script above):\r\n```\r\n2020-04-14T12:02:50,691][ERROR][o.e.x.i.IndexLifecycleRunner] [Elastic-MBP-4.local] current step [{\"phase\":\"warm\",\"action\":\"complete\",\"name\":\"complete\"}] for index [test-000001] with policy [my_policy] is not recognized\r\n```","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}