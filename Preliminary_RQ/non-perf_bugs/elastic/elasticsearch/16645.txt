{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645/events","html_url":"https://github.com/elastic/elasticsearch/issues/16645","id":133329170,"node_id":"MDU6SXNzdWUxMzMzMjkxNzA=","number":16645,"title":"SimpleRoutingIT.testRequiredRoutingMapping fails because a doc remains undeleted","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-02-12T19:55:58Z","updated_at":"2018-02-13T19:39:28Z","closed_at":"2016-02-27T18:03:33Z","author_association":"MEMBER","active_lock_reason":null,"body":"http://build-us-00.elastic.co/job/es_core_master_metal/12355/\n\n```\nelastic/elasticsearch\nmaster\n\nSUMMARY\n\nPlease direct your attention to the attached stacktraces associated with some or all of these tests:\n\norg.elasticsearch.routing.SimpleRoutingIT testRequiredRoutingMapping\nFAILED: 1\nERROR: 0\nSKIPPED: 80\nTOTAL: 5644\n\nBUILD INFO\n\nBuild   20160212182431-BE4C2D89\nLog https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+periodic/406/console\nDuration    12m 33s (753008ms)\nStarted 2016-02-12T18:24:32.000Z\nEnded   2016-02-12T18:37:05.008Z\nExit Code   1\nHost    slave-3740eaed (up 43 days)\nOS  Ubuntu 15.04, Linux 3.19.0-42-generic\nSpecs   4 CPUs, 15.67GB RAM\njava.version    1.8.0_45-internal\njava.vm.name    OpenJDK 64-Bit Server VM\njava.vm.version 25.45-b02\njava.runtime.version    1.8.0_45-internal-b14\njava.home   /usr/lib/jvm/java-8-openjdk-amd64\n```\n\nFailure replicates for me.\n\nDue to https://github.com/elastic/elasticsearch/pull/10136, when a _routing is defined in the mapping, \"Broadcast Deletes\" are no longer allowed.  The `testRequiredRoutingMapping` test was updated in the single-delete case so that `isExists(), equalTo(true)` each time through the loop, since the document should not be deleted.\n\nHowever, it looks like the Bulk Delete case wasn't changed, so the test is still trying to verify that the bulk delete \"broadcasted\" despite no _routing being specified:\n\n``` java\nfor (int i = 0; i < 5; i++) {\n    try {\n        client().prepareGet(indexOrAlias(), \"type1\", \"1\").execute().actionGet().isExists();\n        fail();\n    } catch (RoutingMissingException e) {\n        assertThat(e.status(), equalTo(RestStatus.BAD_REQUEST));\n        assertThat(e.getMessage(), equalTo(\"routing is required for [test]/[type1]/[1]\"));\n    }\n    assertThat(\n      client().prepareGet(indexOrAlias(), \"type1\", \"1\")\n        .setRouting(\"0\")\n        .execute()\n        .actionGet()\n        .isExists(),\n      equalTo(false));  // <-- Here\n}\n```\n\nI assumed this was just a test problem, so I updated it to match the single-delete case (`isExists(), equalTo(true))`.  But that begins to fail under other seeds:\n\n```\ngradle :core:integTest -Dtests.seed=42425D480F1F72E8 -Dtests.class=org.elasticsearch.routing.SimpleRoutingIT -Dtests.method=\"testRequiredRoutingMapping\" -Dtests.locale=es-CL -Dtests.timezone=AET\n```\n\nSo either:\n1. The test was correct, Bulk broadcast deletes without _routing are allowed, and the document isn't being deleted for some reason\n2. Or the test is incorrect, bulk broadcast deletes _shouldn't_ be allowed, but they are working anyway under certain conditions.\n\n/cc @javanna any thoughts?\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}