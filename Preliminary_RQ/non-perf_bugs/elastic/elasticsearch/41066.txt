{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41066","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41066/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41066/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41066/events","html_url":"https://github.com/elastic/elasticsearch/issues/41066","id":431410815,"node_id":"MDU6SXNzdWU0MzE0MTA4MTU=","number":41066,"title":"Highlighter no_match_size ignored with number_of_fragments 0 on 6.7","user":{"login":"benvand","id":3469840,"node_id":"MDQ6VXNlcjM0Njk4NDA=","avatar_url":"https://avatars0.githubusercontent.com/u/3469840?v=4","gravatar_id":"","url":"https://api.github.com/users/benvand","html_url":"https://github.com/benvand","followers_url":"https://api.github.com/users/benvand/followers","following_url":"https://api.github.com/users/benvand/following{/other_user}","gists_url":"https://api.github.com/users/benvand/gists{/gist_id}","starred_url":"https://api.github.com/users/benvand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benvand/subscriptions","organizations_url":"https://api.github.com/users/benvand/orgs","repos_url":"https://api.github.com/users/benvand/repos","events_url":"https://api.github.com/users/benvand/events{/privacy}","received_events_url":"https://api.github.com/users/benvand/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-04-10T09:55:07Z","updated_at":"2019-04-16T16:16:55Z","closed_at":"2019-04-16T16:16:55Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\r\n\r\nelasticsearch-6.7.1\r\n\r\n**JVM version**:\r\n\r\njava version \"1.8.0_201\"\r\n\r\n**OS version**:\r\n\r\n17.7.0 Darwin Kernel Version 17.7.0\r\n\r\n**Expected/ 5.x behaviour**\r\n\r\nAs per the documentation:\r\n\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-highlighting.html#highlighting-settings\r\n\r\n> If the number of fragments is set to 0, no fragments are returned. Instead, the entire field contents are highlighted and returned.\r\n\r\nThis was the behaviour on 5.x where the respective `highlight` field for the original field was returned in full (up to the `no_match_size`).\r\n\r\nThe behaviour on 6.x is that only a partial of the field is returned.\r\n\r\n**Steps to reproduce**:\r\n\r\nThe query command returns different responses on ES5 and ES6\r\n\r\n```bash\r\ncurl -H 'Content-Type: application/json' -XPUT 'http://localhost:9200/test-index?pretty' -d '{\"mappings\": {\r\n    \"services\": {\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"someDescription\": {\r\n          \"type\": \"text\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n\r\ncurl -H 'Content-Type: application/json' -XPUT 'http://localhost:9400/test-index/services/1?pretty' -d '{\r\n  \"someDescription\": \"Here is a description that is quite long and describes the problem that we have had with the new elasticsearch highlighting engine. The length of this field is 500 characters and the problem. Is that the whole description is not returned as a single fragment. Rather the description is split into its constituent sentances. And the first sentence is returned. Those thereafter are not. This was not the behaviour in elasticsearch 5 where the whole field would be returned but has been introduced in es6.\"\r\n}'\r\n\r\ncurl -H 'Content-Type: application/json' -XGET 'http://localhost:9200/test-index/services/_search?pretty&search_type=dfs_query_then_fetch' -d '{\r\n  \"highlight\": {\r\n    \"encoder\": \"html\",\r\n    \"fields\": {\r\n      \"someDescription\": {\r\n        \"no_match_size\": 500,\r\n        \"number_of_fragments\": 0\r\n      }\r\n    },\r\n    \"post_tags\": [\r\n      \"</mark>\"\r\n    ],\r\n    \"pre_tags\": [\r\n      \"<mark class=\\u0027search-result-highlighted-text\\u0027>\"\r\n    ]\r\n  },\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  },\r\n  \"size\": 100\r\n}'\r\n\r\ncurl -XDELETE 'http://localhost:9200/test-*?pretty' -d ''\r\n```\r\n\r\n\r\nThe response on ES5:\r\n\r\n```\r\n{\r\n  \"took\" : 1,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test-index\",\r\n        \"_type\" : \"services\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"someDescription\" : \"Here is a description that is quite long and describes the problem that we have had with the new elasticsearch highlighting engine. The length of this field is 500 characters and the problem. Is that the whole description is not returned as a single fragment. Rather the description is split into its constituent sentances. And the first sentence is returned. Those thereafter are not. This was not the behaviour in elasticsearch 5 where the whole field would be returned but has been introduced in es6.\"\r\n        },\r\n        \"highlight\" : {\r\n          \"someDescription\" : [\r\n            \"Here is a description that is quite long and describes the problem that we have had with the new elasticsearch highlighting engine. The length of this field is 500 characters and the problem. Is that the whole description is not returned as a single fragment. Rather the description is split into its constituent sentances. And the first sentence is returned. Those thereafter are not. This was not the behaviour in elasticsearch 5 where the whole field would be returned but has been introduced in\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n\r\n```\r\n\r\nThe response on ES6:\r\n\r\n```\r\n{\r\n  \"took\" : 2,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test-index\",\r\n        \"_type\" : \"services\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"someDescription\" : \"Here is a description that is quite long and describes the problem that we have had with the new elasticsearch highlighting engine. The length of this field is 500 characters and the problem. Is that the whole description is not returned as a single fragment. Rather the description is split into its constituent sentances. And the first sentence is returned. Those thereafter are not. This was not the behaviour in elasticsearch 5 where the whole field would be returned but has been introduced in es6.\"\r\n        },\r\n        \"highlight\" : {\r\n          \"someDescription\" : [\r\n            \"Here is a description that is quite long and describes the problem that we have had with the new elasticsearch highlighting engine.\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}