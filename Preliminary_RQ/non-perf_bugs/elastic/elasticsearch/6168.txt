{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6168","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6168/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6168/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6168/events","html_url":"https://github.com/elastic/elasticsearch/issues/6168","id":33489219,"node_id":"MDU6SXNzdWUzMzQ4OTIxOQ==","number":6168,"title":"disk.threshold_enabled allocation creates dynamics that can cause runaway disk space usage","user":{"login":"gibrown","id":820871,"node_id":"MDQ6VXNlcjgyMDg3MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820871?v=4","gravatar_id":"","url":"https://api.github.com/users/gibrown","html_url":"https://github.com/gibrown","followers_url":"https://api.github.com/users/gibrown/followers","following_url":"https://api.github.com/users/gibrown/following{/other_user}","gists_url":"https://api.github.com/users/gibrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gibrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gibrown/subscriptions","organizations_url":"https://api.github.com/users/gibrown/orgs","repos_url":"https://api.github.com/users/gibrown/repos","events_url":"https://api.github.com/users/gibrown/events{/privacy}","received_events_url":"https://api.github.com/users/gibrown/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":17,"created_at":"2014-05-14T12:58:35Z","updated_at":"2018-02-13T19:28:49Z","closed_at":"2014-12-24T18:55:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Enabling disk.threshold_enabled for shard allocation can cause shards to continuously get relocated around the cluster and potentially lead to completely running out of disk space if the shards (including replicas) is at least half of total disk space. \n\nThe mechanism is as follows:\n1. Run a cluster restart or have a substantial percentage of nodes restart, triggering many shards to reinitialize\n2. Shards will get allocated onto other nodes and begin initializing. Some of those nodes may trigger the high disk threshold level for the disk allocation.\n3. When the high disk threshold is triggered shards will start relocating. \n4. Relocation effectively creates a duplicate shard, increasing disk space across the cluster.\n5. Because other nodes are also initializing/relocating nodes, new shard relocations may again trigger the high threshold\n6. Repeat to step 3. (Slowly increasing the number of simultaneously relocating shards in the cluster.)\n\nHere's a graph showing relocating shards continuously increasing:\n![image](https://cloud.githubusercontent.com/assets/820871/2971078/dd98e172-db65-11e3-9ae5-29ac509d10f1.png)\n\ncluster.routing.allocation.cluster_concurrent_rebalance was set to 6. This was observed in ES 1.1.1\n\nA number of other config options affect the dynamics:\n- Shard size and number of shards (more likely to happen with big shards that take longer to move)\n- Throttling of recovery/relocation\n- Shard Allocation Awareness limiting where nodes can be moved\n\nSome possible solutions:\n- Treat cluster_concurrent_rebalance as a hard maximum (see also #6141)\n- Have the relocation/initialization algorithm calculate what disk space will be once all shards are fully moved rather than what disk space currently is.\n\nMaybe related to #4790 \n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}