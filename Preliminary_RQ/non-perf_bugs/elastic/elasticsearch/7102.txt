{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7102","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7102/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7102/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7102/events","html_url":"https://github.com/elastic/elasticsearch/issues/7102","id":39169334,"node_id":"MDU6SXNzdWUzOTE2OTMzNA==","number":7102,"title":"OOM again","user":{"login":"zouxc","id":1393691,"node_id":"MDQ6VXNlcjEzOTM2OTE=","avatar_url":"https://avatars2.githubusercontent.com/u/1393691?v=4","gravatar_id":"","url":"https://api.github.com/users/zouxc","html_url":"https://github.com/zouxc","followers_url":"https://api.github.com/users/zouxc/followers","following_url":"https://api.github.com/users/zouxc/following{/other_user}","gists_url":"https://api.github.com/users/zouxc/gists{/gist_id}","starred_url":"https://api.github.com/users/zouxc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zouxc/subscriptions","organizations_url":"https://api.github.com/users/zouxc/orgs","repos_url":"https://api.github.com/users/zouxc/repos","events_url":"https://api.github.com/users/zouxc/events{/privacy}","received_events_url":"https://api.github.com/users/zouxc/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-07-31T07:25:45Z","updated_at":"2014-08-23T15:16:35Z","closed_at":"2014-08-23T15:16:35Z","author_association":"NONE","active_lock_reason":null,"body":"here is my query,when I add sort on it ,so it can result in OOM\nthe query json:\n{\n  \"sort\" : [\n       {\n          \"pt_float_props.value\" : {\n             \"order\" : \"asc\",\n             \"nested_filter\" : {\n                \"term\" : {  \"pt_float_props.name\": \"consume_vol_tot\" }\n             }\n          }\n       },  {\n          \"pt_str_props.value\" : {\n             \"order\" : \"asc\",\n             \"nested_filter\" : {\n                \"term\" : {  \"pt_str_props.name\": \"last_login_date\" }\n             }\n          }\n       }\n    ],\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"and\": [\n          {\n            \"nested\": {\n              \"path\": \"pt_float_props\",\n              \"filter\": {\n                \"bool\": {\n                  \"must\": [\n                    {\n                      \"term\": {\n                        \"pt_float_props.name\": \"consume_vol_tot\"\n                      }\n                    },\n                    {\n                      \"range\": {\n                        \"pt_float_props.value\": {\n                          \"from\": 10\n                        }\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n          },\n          {\n            \"nested\": {\n              \"path\": \"pt_str_props\",\n              \"filter\": {\n                \"bool\": {\n                  \"must\": [\n                    {\n                      \"term\": {\n                        \"pt_str_props.name\": \"last_login_date\"\n                      }\n                    },\n                    {\n                      \"range\": {\n                        \"pt_str_props.value\": {\"from\" : \"2012-02-22\"}\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n          },\n          {\n            \"nested\": {\n              \"path\": \"pt_str_props\",\n              \"filter\": {\n                \"bool\": {\n                  \"must\": [\n                    {\n                      \"term\": {\n                        \"pt_str_props.name\": \"last_consume_date\"\n                      }\n                    },\n                    {\n                      \"range\": {\n                        \"pt_str_props.value\": {\"from\": \"2011-02-22\"}\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n          }\n        ]\n      }\n    }\n  }\n}\n\nthe error\nCaused by: java.lang.OutOfMemoryError: Java heap space\n[2014-07-31 11:20:11,753][DEBUG][action.search.type       ] [Freakmaster] [test][50], node[-aNuC2p0SxyA91sJXn8L5A], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@f85ad37]\njava.lang.OutOfMemoryError: Java heap space\n[2014-07-31 11:20:03,413][DEBUG][action.search.type       ] [Freakmaster] [test][48], node[3nv09tjgTKSAkZnu8eaeJA], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@2fee46f5]\norg.elasticsearch.transport.RemoteTransportException: [Balor][inet[/10.1.10.154:9300]][search/phase/query]\nCaused by: org.elasticsearch.search.query.QueryPhaseExecutionException: [test][48]: query[filtered(ConstantScore(+QueryWrapperFilter(ToParentBlockJoinQuery (filtered(+pt_float_props.name:consume_vol_tot +pt_float_props.value:[240.0 TO *])->cache(_type:__pt_float_props))) +QueryWrapperFilter(ToParentBlockJoinQuery (filtered(+pt_str_props.name:last_login_date +pt_str_props.value:2014-02-22)->cache(_type:__pt_str_props))) +QueryWrapperFilter(ToParentBlockJoinQuery (filtered(+pt_str_props.name:pt_id +(pt_str_props.value:seven13577 pt_str_props.value:semail0018))->cache(_type:__pt_str_props)))))->cache(_type:pt_game_properties_all)],from[0],size[10],sort[<custom:\"pt_float_props.value\": org.elasticsearch.index.search.nested.NestedFieldComparatorSource@549a1432>!]: Query Failed [Failed to execute main query]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:138)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:239)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:529)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:518)\n        at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.run(MessageChannelHandler.java:265)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        at java.lang.Thread.run(Thread.java:619)\nCaused by: org.elasticsearch.ElasticSearchException: java.lang.OutOfMemoryError: Java heap space\n        at org.elasticsearch.index.fielddata.plain.DoubleArrayIndexFieldData.load(DoubleArrayIndexFieldData.java:80)\n        at org.elasticsearch.index.fielddata.plain.DoubleArrayIndexFieldData.load(DoubleArrayIndexFieldData.java:46)\n        at org.elasticsearch.index.fielddata.fieldcomparator.DoubleValuesComparatorBase.setNextReader(DoubleValuesComparatorBase.java:57)\n        at org.elasticsearch.index.search.nested.NestedFieldComparator.setNextReader(NestedFieldComparatorSource.java:128)\n        at org.apache.lucene.search.TopFieldCollector$OneComparatorNonScoringCollector.setNextReader(TopFieldCollector.java:97)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:603)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:161)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:572)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:524)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:501)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:345)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:127)\n        ... 7 more\nCaused by: org.elasticsearch.common.util.concurrent.ExecutionError: java.lang.OutOfMemoryError: Java heap space\n        at org.elasticsearch.common.cache.LocalCache$Segment.get(LocalCache.java:2261)\n        at org.elasticsearch.common.cache.LocalCache.get(LocalCache.java:4000)\n        at org.elasticsearch.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4789)\n        at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:144)\n        at org.elasticsearch.index.fielddata.plain.DoubleArrayIndexFieldData.load(DoubleArrayIndexFieldData.java:75)\n        ... 18 more\nCaused by: java.lang.OutOfMemoryError: Java heap space\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}