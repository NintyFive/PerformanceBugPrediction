{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31324","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31324/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31324/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31324/events","html_url":"https://github.com/elastic/elasticsearch/issues/31324","id":332309229,"node_id":"MDU6SXNzdWUzMzIzMDkyMjk=","number":31324,"title":"Understand Gradle 4.8 test failure around setup of security policies ","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"labels":[{"id":106454670,"node_id":"MDU6TGFiZWwxMDY0NTQ2NzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Build","name":":Delivery/Build","color":"0e8a16","default":false,"description":"Build or test infrastructure"},{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"},{"id":959855511,"node_id":"MDU6TGFiZWw5NTk4NTU1MTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/jdk11","name":"jdk11","color":"e11d21","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2018-06-14T08:54:02Z","updated_at":"2020-11-11T21:41:14Z","closed_at":"2018-06-28T05:13:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With Gradle 4.8 running on JDK 10 this happens (reformatted for readability):\r\n```\r\njava.lang.RuntimeException: unable to install test security manager\r\n\tat org.elasticsearch.bootstrap.BootstrapForTesting.<clinit>(BootstrapForTesting.java:170)\r\n\tat org.elasticsearch.test.ESTestCase.<clinit>(ESTestCase.java:197)\r\n\tat java.base/java.lang.Class.forName0(Native Method)\r\n\tat java.base/java.lang.Class.forName(Class.java:374)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:592)\r\nCaused by: java.lang.IllegalStateException: codebase property already set: codebase.plugin-classloader -> \r\nfile:/home/alpar/work/elastic/elasticsearch_master_ci/libs/plugin-classloader/build/distributions/plugin-classloader-7.0.0-alpha1-SNAPSHOT.jar, cannot set to \r\nfile:/home/alpar/work/elastic/elasticsearch_master_ci/libs/plugin-classloader/build/distributions/plugin-classloader-7.0.0-alpha1-SNAPSHOT.jar\r\n\tat org.elasticsearch.bootstrap.Security.readPolicy(Security.java:233)\r\n\tat org.elasticsearch.bootstrap.BootstrapForTesting.<clinit>(BootstrapForTesting.java:145)\r\n\t... 4 more\r\n```\r\nthen most other tests fail with something like:\r\n```\r\nException in thread \"Thread-3\" java.lang.NoClassDefFoundError: Could not initialize class org.elasticsearch.test.ESTestCase\r\n    at java.base/java.lang.Thread.run(Thread.java:844)\r\n```\r\n\r\nThe reading of policies from `Security` is done trough a `static {}` block in `BootstrapForTesting` which should guarantee that it is only initialized once. There doesn't seem to be any other code paths that exercise this, the only time `Security.readPolicy` is in `BootstrapForTesting` and `Bootstrap` that starts Elasticsearch, even if the tests were to do that, it doesn't have a chance to run before the tests are bootstrap. \r\n\r\nIt must be some strange intimacy between Gradle 4.8 and JDK 10 `OpenJDK Runtime Environment (build 10.0.1+10)` in my case, as the issue only reproduces with: \r\n`./gradlew clean check`\r\nIt does not reproduce with:\r\n- `./gradlew :server:test`\r\n- `./gradlew :server:test` ran 100 times \r\n- Gradle 4.7 \r\n- Gradle 4.8 with JDK 11ea (`OpenJDK Runtime Environment 18.9 (build 11-ea+17)`)\r\n\r\nGradle seems to change the order of tasks a lot and will run many other tasks, including some tests before the `:server:tests` ( which probably doesn't make sense ). Not sure this is relevant. \r\n\r\nIn order to be able to move to the new Gradle version #31271 has a work around. \r\nI'm writhing this up in the hopes of revisiting it to provide more clarity.\r\nNote that as of this writing the Gradle 4.8 PR mentioned above is not merged.\r\n\r\nRelates to #31230.","closed_by":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"performed_via_github_app":null}