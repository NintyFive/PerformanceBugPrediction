[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368346922","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-368346922","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":368346922,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODM0NjkyMg==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2018-02-25T21:36:10Z","updated_at":"2018-02-25T21:36:10Z","author_association":"MEMBER","body":"/cc @elastic/es-search-aggs ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374018127","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-374018127","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":374018127,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDAxODEyNw==","user":{"login":"rationull","id":6431686,"node_id":"MDQ6VXNlcjY0MzE2ODY=","avatar_url":"https://avatars2.githubusercontent.com/u/6431686?v=4","gravatar_id":"","url":"https://api.github.com/users/rationull","html_url":"https://github.com/rationull","followers_url":"https://api.github.com/users/rationull/followers","following_url":"https://api.github.com/users/rationull/following{/other_user}","gists_url":"https://api.github.com/users/rationull/gists{/gist_id}","starred_url":"https://api.github.com/users/rationull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rationull/subscriptions","organizations_url":"https://api.github.com/users/rationull/orgs","repos_url":"https://api.github.com/users/rationull/repos","events_url":"https://api.github.com/users/rationull/events{/privacy}","received_events_url":"https://api.github.com/users/rationull/received_events","type":"User","site_admin":false},"created_at":"2018-03-18T17:15:54Z","updated_at":"2018-03-18T17:15:54Z","author_association":"CONTRIBUTOR","body":"@rjernst What should the behavior be if script params and aggregation params are provided with the same name?\r\n\r\nI'm inclined to think that should cause an error at `ScriptedMetricAggregatorFactory` construction time. If conflicts must be silently allowed then I think the aggregation level params have to win (at least for `_agg` to ensure it keeps the same identity across all the scripts that are run -- the general case is to ensure that **all** aggregation level params have the same identity across scripts, which is directly in conflict with letting individual scripts override such params). That works too but could be confusing and a fail-fast check ensuring no conflicts seems more developer friendly.\r\n\r\nI have a start to a PR on this. Pretty sure I have it working but it needs some trivial cleanup plus refinement for this conflict case. Input is appreciated if you'd welcome a PR.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374027392","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-374027392","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":374027392,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDAyNzM5Mg==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2018-03-18T18:20:13Z","updated_at":"2018-03-18T18:20:13Z","author_association":"MEMBER","body":"I think an error is the right thing. Right now, anything passed into params at the script level is ignored, so any errors that result of this change could only happen if a user is already either passing in params in both the script and one level up, or they are passing in `_agg`/`_aggs` at the script level, and they really should be notified that this is completely broken from what they are trying to do (and they can stop doing this before upgrading).\r\n\r\nLong term, I think `_agg` and `_aggs` need to be removed from params, and replaced with specific `ScriptContext`s for each of the 4 script types for a metric agg. This would allow making the variables local to each script (no more need to access via params) and at the same time possibly renaming to be more descriptive. But a PR to fix this existing bug in the current setup would be greatly appreciated.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374030553","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-374030553","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":374030553,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDAzMDU1Mw==","user":{"login":"rationull","id":6431686,"node_id":"MDQ6VXNlcjY0MzE2ODY=","avatar_url":"https://avatars2.githubusercontent.com/u/6431686?v=4","gravatar_id":"","url":"https://api.github.com/users/rationull","html_url":"https://github.com/rationull","followers_url":"https://api.github.com/users/rationull/followers","following_url":"https://api.github.com/users/rationull/following{/other_user}","gists_url":"https://api.github.com/users/rationull/gists{/gist_id}","starred_url":"https://api.github.com/users/rationull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rationull/subscriptions","organizations_url":"https://api.github.com/users/rationull/orgs","repos_url":"https://api.github.com/users/rationull/repos","events_url":"https://api.github.com/users/rationull/events{/privacy}","received_events_url":"https://api.github.com/users/rationull/received_events","type":"User","site_admin":false},"created_at":"2018-03-18T18:39:37Z","updated_at":"2018-03-18T18:39:37Z","author_association":"CONTRIBUTOR","body":"Thanks, that makes sense. Agree that the aggregation status/results are really part of the context, not part of the parameters -- that does sound like a better design.\r\n\r\n`ScriptedMetricIT` has a few test cases where the same params are being passed in at both the aggregator and script level (looks like by accident) so we'll get easy test coverage of the new error case :)\r\n\r\nI will clean up my progress other than this new error case today and should be able to take care of the error case either this week or next weekend and submit the PR.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374030962","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-374030962","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":374030962,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDAzMDk2Mg==","user":{"login":"rationull","id":6431686,"node_id":"MDQ6VXNlcjY0MzE2ODY=","avatar_url":"https://avatars2.githubusercontent.com/u/6431686?v=4","gravatar_id":"","url":"https://api.github.com/users/rationull","html_url":"https://github.com/rationull","followers_url":"https://api.github.com/users/rationull/followers","following_url":"https://api.github.com/users/rationull/following{/other_user}","gists_url":"https://api.github.com/users/rationull/gists{/gist_id}","starred_url":"https://api.github.com/users/rationull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rationull/subscriptions","organizations_url":"https://api.github.com/users/rationull/orgs","repos_url":"https://api.github.com/users/rationull/repos","events_url":"https://api.github.com/users/rationull/events{/privacy}","received_events_url":"https://api.github.com/users/rationull/received_events","type":"User","site_admin":false},"created_at":"2018-03-18T18:41:52Z","updated_at":"2018-03-18T18:41:52Z","author_association":"CONTRIBUTOR","body":"(Another option is we could treat _agg/_aggs as a special case to disallow passing at the script level, but given your long term change suggestion that is not really moving in the right direction in general. Even passing non-\"special\" params in at both the aggregate and script level seems more like a confusing mistake than an important use case.)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374049420","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-374049420","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":374049420,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDA0OTQyMA==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2018-03-18T21:26:10Z","updated_at":"2018-03-18T21:26:10Z","author_association":"MEMBER","body":"/cc @colings86 for your thoughts on the approach discussed here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374148784","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-374148784","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":374148784,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDE0ODc4NA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-03-19T09:24:25Z","updated_at":"2018-03-19T09:24:25Z","author_association":"MEMBER","body":"Agreed that an error would be the best approach for handling colliding keys in the params. I also agree that now we have script contexts it would be much better to expose the `_agg` and `_aggs` variables there rather than abusing the params for this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/400545081","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-400545081","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":400545081,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMDU0NTA4MQ==","user":{"login":"rationull","id":6431686,"node_id":"MDQ6VXNlcjY0MzE2ODY=","avatar_url":"https://avatars2.githubusercontent.com/u/6431686?v=4","gravatar_id":"","url":"https://api.github.com/users/rationull","html_url":"https://github.com/rationull","followers_url":"https://api.github.com/users/rationull/followers","following_url":"https://api.github.com/users/rationull/following{/other_user}","gists_url":"https://api.github.com/users/rationull/gists{/gist_id}","starred_url":"https://api.github.com/users/rationull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rationull/subscriptions","organizations_url":"https://api.github.com/users/rationull/orgs","repos_url":"https://api.github.com/users/rationull/repos","events_url":"https://api.github.com/users/rationull/events{/privacy}","received_events_url":"https://api.github.com/users/rationull/received_events","type":"User","site_admin":false},"created_at":"2018-06-27T05:14:41Z","updated_at":"2018-06-27T05:14:41Z","author_association":"CONTRIBUTOR","body":"@rjernst can this be closed?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401395449","html_url":"https://github.com/elastic/elasticsearch/issues/28819#issuecomment-401395449","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28819","id":401395449,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTM5NTQ0OQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2018-06-29T15:48:51Z","updated_at":"2018-06-29T15:48:51Z","author_association":"MEMBER","body":"Yes, closed by #29154.","performed_via_github_app":null}]