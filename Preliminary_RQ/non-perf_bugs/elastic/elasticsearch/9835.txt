{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9835","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9835/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9835/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9835/events","html_url":"https://github.com/elastic/elasticsearch/issues/9835","id":58651817,"node_id":"MDU6SXNzdWU1ODY1MTgxNw==","number":9835,"title":"CSV River strange behavior","user":{"login":"proxylab","id":10655938,"node_id":"MDQ6VXNlcjEwNjU1OTM4","avatar_url":"https://avatars3.githubusercontent.com/u/10655938?v=4","gravatar_id":"","url":"https://api.github.com/users/proxylab","html_url":"https://github.com/proxylab","followers_url":"https://api.github.com/users/proxylab/followers","following_url":"https://api.github.com/users/proxylab/following{/other_user}","gists_url":"https://api.github.com/users/proxylab/gists{/gist_id}","starred_url":"https://api.github.com/users/proxylab/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/proxylab/subscriptions","organizations_url":"https://api.github.com/users/proxylab/orgs","repos_url":"https://api.github.com/users/proxylab/repos","events_url":"https://api.github.com/users/proxylab/events{/privacy}","received_events_url":"https://api.github.com/users/proxylab/received_events","type":"User","site_admin":false},"labels":[{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-02-23T21:31:25Z","updated_at":"2015-09-08T08:26:01Z","closed_at":"2015-09-08T08:26:00Z","author_association":"NONE","active_lock_reason":null,"body":"Hi all, \n\nI have recently replaced my bulk import mechanism (PHP and bulk API) with river csv. What I have noticed so far is a strange behavior that shows up after a certain index size (around 10.000.000 docs and ~1.5G disk size). So when the index is small everything works fine, I have set the bulk_size=1000, concurrent_requests=4 and bulk_threashold=10. After a couple of hours when index become bigger the whole process slows down and the import of .csv files becomes really slow. I have checked the elastic .log files and I figured out that the execution circle (polling time) of the import is interrupted. For instance here is what I get from the logs\n#  logs\n\n[2015-02-23 20:08:55,135][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] File has been processed 54eb7eed2bbe9.csv.processing\n[2015-02-23 20:08:55,136][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] File 54eb7eed2bbe9.csv.processing, processed lines 2300\n[2015-02-23 20:08:55,137][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Processing file 54eb81de7e37f.csv\n[2015-02-23 20:08:55,146][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:09:52,079][ERROR][marvel.agent.exporter    ] [Domina] error sending data to [http://[0:0:0:0:0:0:0:0]:9200/.marvel-2015.02.23/_bulk]: [SocketTimeoutException[Read timed out]]\n[2015-02-23 20:09:54,170][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:09:54,286][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:10:41,762][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:10:41,911][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:10:52,411][ERROR][marvel.agent.exporter    ] [Domina] error sending data to [http://[0:0:0:0:0:0:0:0]:9200/.marvel-2015.02.23/_bulk]: SocketTimeoutException[Read timed out]\n[2015-02-23 20:11:37,582][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:11:37,758][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] File has been processed 54eb81de7e37f.csv.processing\n[2015-02-23 20:11:37,759][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] File 54eb81de7e37f.csv.processing, processed lines 2985\n[2015-02-23 20:11:37,759][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Processing file 54eb807bf351c.csv\n[2015-02-23 20:11:37,765][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:12:02,830][ERROR][marvel.agent.exporter    ] [Domina] error sending data to [http://[0:0:0:0:0:0:0:0]:9200/.marvel-2015.02.23/_bulk]: SocketTimeoutException[Read timed out]\n[2015-02-23 20:12:30,479][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:12:30,536][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:13:03,132][ERROR][marvel.agent.exporter    ] [Domina] error sending data to [http://[0:0:0:0:0:0:0:0]:9200/.marvel-2015.02.23/_bulk]: [SocketTimeoutException[Read timed out]]\n[2015-02-23 20:13:24,458][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:13:24,581][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:14:03,423][ERROR][marvel.agent.exporter    ] [Domina] error sending data to [http://[0:0:0:0:0:0:0:0]:9200/.marvel-2015.02.23/_bulk]: SocketTimeoutException[Read timed out]\n[2015-02-23 20:14:12,914][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:14:13,010][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] File has been processed 54eb807bf351c.csv.processing\n[2015-02-23 20:14:13,010][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] File 54eb807bf351c.csv.processing, processed lines 2924\n[2015-02-23 20:14:13,011][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Processing file 54eb7eb509a30.csv\n[2015-02-23 20:14:13,032][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:15:11,204][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Executed bulk composed of 1000 actions\n[2015-02-23 20:15:11,311][INFO ][org.agileworks.elasticsearch.river.csv.CSVRiver] [Domina] [csv][maxweb] Going to execute new bulk composed of 1000 actions\n[2015-02-23 20:15:13,741][ERROR][marvel.agent.exporter    ] [Domina] error sending data to [http://[0:0:0:0:0:0:0:0]:9200/.marvel-2015.02.23/_bulk]: SocketTimeoutException[Read timed out]\n\nAs you can see there is no accuracy between time periods. The one circle ends at 2015-02-23 20:13:24 and the next start at 2015-02-23 20:14:12. Next you can find the csv river and index settings\n# CSV River\n\n``` json\n{\n    \"type\": \"csv\",\n    \"csv_file\": {\n        \"folder\": \"/vagrant/CSV/\",\n        \"filename_pattern\": \".*\\.csv$\",\n        \"poll\": \"1m\",\n        \"fields\": [\n            \"serverId\",\n            \"duration\",\n            \"requestTime\",\n            \"responseTime\",\n            \"statementType\",\n            \"isRealQuery\",\n            \"queryFailed\",\n            \"sqlQuery\",\n            \"transactionId\",\n            \"clientName\",\n            \"serverName\",\n            \"serverUniqueName\",\n            \"affectedTables\",\n            \"queryError\",\n            \"canonCommandType\",\n            \"canonicalId\"\n        ],\n        \"first_line_is_header\": \"false\",\n        \"concurrent_requests\": \"4\",\n        \"charset\": \"UTF-8\"\n    },\n    \"index\": {\n        \"index\": \"maxweb\",\n        \"type\": \"queries\",\n        \"bulk_size\": 1000,\n        \"bulk_threshold\": 10\n    }\n}\n```\n# Index mapping\n\n``` json\n{\n    \"mappings\": {\n        \"queries\": {\n            \"transform\": {\n                \"script\": \"ctx._source['affectedTables'] = ctx._source['affectedTables']?.tokenize(',')\",\n                \"lang\": \"groovy\"\n            },\n            \"_all\": {\n                \"enabled\": false\n            },\n            \"_source\": {\n                \"compress\": false\n            },\n            \"properties\": {\n                \"affectedTables\": {\n                    \"type\": \"string\",\n                    \"index\": \"not_analyzed\",\n                    \"copy_to\": [\n                        \"suggest_tables\"\n                    ]\n                },\n                \"canonCommandType\": {\n                    \"type\": \"integer\",\n                    \"index\": \"no\"\n                },\n                \"canonicalId\": {\n                    \"type\": \"string\",\n                    \"index\": \"no\"\n                },\n                \"clientName\": {\n                    \"type\": \"string\",\n                    \"index\": \"no\"\n                },\n                \"duration\": {\n                    \"type\": \"double\",\n                    \"doc_values\": true\n                },\n                \"isRealQuery\": {\n                    \"type\": \"string\"\n                },\n                \"queryError\": {\n                    \"type\": \"string\",\n                    \"index\": \"no\"\n                },\n                \"queryFailed\": {\n                    \"type\": \"boolean\"\n                },\n                \"requestTime\": {\n                    \"type\": \"double\",\n                    \"doc_values\": true\n                },\n                \"responseTime\": {\n                    \"type\": \"double\",\n                    \"index\": \"no\"\n                },\n                \"serverId\": {\n                    \"type\": \"long\",\n                    \"doc_values\": true\n                },\n                \"serverName\": {\n                    \"type\": \"string\",\n                    \"index\": \"no\"\n                },\n                \"serverUniqueName\": {\n                    \"type\": \"string\",\n                    \"index\": \"no\"\n                },\n                \"sqlQuery\": {\n                    \"type\": \"string\",\n                    \"norms\": {\n                        \"enabled\": false\n                    }\n                },\n                \"statementType\": {\n                    \"type\": \"integer\",\n                    \"doc_values\": true\n                },\n                \"suggest_tables\": {\n                    \"type\": \"completion\",\n                    \"analyzer\": \"simple\",\n                    \"payloads\": false,\n                    \"preserve_separators\": true,\n                    \"preserve_position_increments\": true,\n                    \"max_input_length\": 50\n                }\n            }\n        }\n    }\n}\n```\n# elasticasearch.yml\n\nindex.refresh_interval: 30s\nindex.translog.flush_threshold_ops: 50000\nindex.translog.flush_threshold_size: 512mb\nindices.fielddata.cache.size: 20%\nindices.cache.filter.size: 20%\nindices.memory.index_buffer_size: 40%\nindex.merge.scheduler.max_thread_count : 1\nbootstrap.mlockall: true\n# /etc/sysconfig/elasticsearch\n\nMAX_LOCKED_MEMORY=unlimited\nMAX_OPEN_FILES=65535\nES_JAVA_OPTS=-server\nES_HEAP_SIZE=512m\n# index status\n\n``` json\n{\n    \"_shards\": {\n        \"total\": 1,\n        \"successful\": 1,\n        \"failed\": 0\n    },\n    \"indices\": {\n        \"maxweb\": {\n            \"index\": {\n                \"primary_size_in_bytes\": 3413521092,\n                \"size_in_bytes\": 3413521092\n            },\n            \"translog\": {\n                \"operations\": 4423\n            },\n            \"docs\": {\n                \"num_docs\": 17886624,\n                \"max_doc\": 17886624,\n                \"deleted_docs\": 0\n            },\n            \"merges\": {\n                \"current\": 0,\n                \"current_docs\": 0,\n                \"current_size_in_bytes\": 0,\n                \"total\": 29,\n                \"total_time_in_millis\": 28204,\n                \"total_docs\": 262490,\n                \"total_size_in_bytes\": 60109517\n            },\n            \"refresh\": {\n                \"total\": 158,\n                \"total_time_in_millis\": 15612\n            },\n            \"flush\": {\n                \"total\": 3,\n                \"total_time_in_millis\": 23029\n            },\n            \"shards\": {\n                \"0\": [{\n                    \"routing\": {\n                        \"state\": \"STARTED\",\n                        \"primary\": true,\n                        \"node\": \"oYGAJctoTTmSU1wD021byA\",\n                        \"relocating_node\": null,\n                        \"shard\": 0,\n                        \"index\": \"maxweb\"\n                    },\n                    \"state\": \"STARTED\",\n                    \"index\": {\n                        \"size_in_bytes\": 3413521092\n                    },\n                    \"translog\": {\n                        \"id\": 1424570700536,\n                        \"operations\": 4423\n                    },\n                    \"docs\": {\n                        \"num_docs\": 17886624,\n                        \"max_doc\": 17886624,\n                        \"deleted_docs\": 0\n                    },\n                    \"merges\": {\n                        \"current\": 0,\n                        \"current_docs\": 0,\n                        \"current_size_in_bytes\": 0,\n                        \"total\": 29,\n                        \"total_time_in_millis\": 28204,\n                        \"total_docs\": 262490,\n                        \"total_size_in_bytes\": 60109517\n                    },\n                    \"refresh\": {\n                        \"total\": 158,\n                        \"total_time_in_millis\": 15612\n                    },\n                    \"flush\": {\n                        \"total\": 3,\n                        \"total_time_in_millis\": 23029\n                    }\n                }]\n            }\n        }\n    }\n}\n```\n# index stats\n\n``` json\n{\n         \"primaries\": {\n            \"docs\": {\n               \"count\": 17890687,\n               \"deleted\": 0\n            },\n            \"store\": {\n               \"size_in_bytes\": 3416809219,\n               \"throttle_time_in_millis\": 669\n            },\n            \"indexing\": {\n               \"index_total\": 76407,\n               \"index_time_in_millis\": 9773626,\n               \"index_current\": 2,\n               \"delete_total\": 0,\n               \"delete_time_in_millis\": 0,\n               \"delete_current\": 0,\n               \"noop_update_total\": 0,\n               \"is_throttled\": false,\n               \"throttle_time_in_millis\": 0\n            },\n            \"get\": {\n               \"total\": 0,\n               \"time_in_millis\": 0,\n               \"exists_total\": 0,\n               \"exists_time_in_millis\": 0,\n               \"missing_total\": 0,\n               \"missing_time_in_millis\": 0,\n               \"current\": 0\n            },\n            \"search\": {\n               \"open_contexts\": 0,\n               \"query_total\": 0,\n               \"query_time_in_millis\": 0,\n               \"query_current\": 0,\n               \"fetch_total\": 0,\n               \"fetch_time_in_millis\": 0,\n               \"fetch_current\": 0\n            },\n            \"merges\": {\n               \"current\": 0,\n               \"current_docs\": 0,\n               \"current_size_in_bytes\": 0,\n               \"total\": 31,\n               \"total_time_in_millis\": 29507,\n               \"total_docs\": 281907,\n               \"total_size_in_bytes\": 64514039\n            },\n            \"refresh\": {\n               \"total\": 165,\n               \"total_time_in_millis\": 16431\n            },\n            \"flush\": {\n               \"total\": 3,\n               \"total_time_in_millis\": 23029\n            },\n            \"warmer\": {\n               \"current\": 0,\n               \"total\": 368,\n               \"total_time_in_millis\": 119\n            },\n            \"filter_cache\": {\n               \"memory_size_in_bytes\": 0,\n               \"evictions\": 0\n            },\n            \"id_cache\": {\n               \"memory_size_in_bytes\": 0\n            },\n            \"fielddata\": {\n               \"memory_size_in_bytes\": 0,\n               \"evictions\": 0\n            },\n            \"percolate\": {\n               \"total\": 0,\n               \"time_in_millis\": 0,\n               \"current\": 0,\n               \"memory_size_in_bytes\": -1,\n               \"memory_size\": \"-1b\",\n               \"queries\": 0\n            },\n            \"completion\": {\n               \"size_in_bytes\": 32864\n            },\n            \"segments\": {\n               \"count\": 26,\n               \"memory_in_bytes\": 9095212,\n               \"index_writer_memory_in_bytes\": 324016,\n               \"index_writer_max_memory_in_bytes\": 103887667,\n               \"version_map_memory_in_bytes\": 22792,\n               \"fixed_bit_set_memory_in_bytes\": 0\n            },\n            \"translog\": {\n               \"operations\": 8246,\n               \"size_in_bytes\": 4267399\n            },\n            \"suggest\": {\n               \"total\": 0,\n               \"time_in_millis\": 0,\n               \"current\": 0\n            },\n            \"query_cache\": {\n               \"memory_size_in_bytes\": 0,\n               \"evictions\": 0,\n               \"hit_count\": 0,\n               \"miss_count\": 0\n            }\n         },\n         \"total\": {\n            \"docs\": {\n               \"count\": 17890687,\n               \"deleted\": 0\n            },\n            \"store\": {\n               \"size_in_bytes\": 3416809219,\n               \"throttle_time_in_millis\": 669\n            },\n            \"indexing\": {\n               \"index_total\": 76407,\n               \"index_time_in_millis\": 9773626,\n               \"index_current\": 2,\n               \"delete_total\": 0,\n               \"delete_time_in_millis\": 0,\n               \"delete_current\": 0,\n               \"noop_update_total\": 0,\n               \"is_throttled\": false,\n               \"throttle_time_in_millis\": 0\n            },\n            \"get\": {\n               \"total\": 0,\n               \"time_in_millis\": 0,\n               \"exists_total\": 0,\n               \"exists_time_in_millis\": 0,\n               \"missing_total\": 0,\n               \"missing_time_in_millis\": 0,\n               \"current\": 0\n            },\n            \"search\": {\n               \"open_contexts\": 0,\n               \"query_total\": 0,\n               \"query_time_in_millis\": 0,\n               \"query_current\": 0,\n               \"fetch_total\": 0,\n               \"fetch_time_in_millis\": 0,\n               \"fetch_current\": 0\n            },\n            \"merges\": {\n               \"current\": 0,\n               \"current_docs\": 0,\n               \"current_size_in_bytes\": 0,\n               \"total\": 31,\n               \"total_time_in_millis\": 29507,\n               \"total_docs\": 281907,\n               \"total_size_in_bytes\": 64514039\n            },\n            \"refresh\": {\n               \"total\": 165,\n               \"total_time_in_millis\": 16431\n            },\n            \"flush\": {\n               \"total\": 3,\n               \"total_time_in_millis\": 23029\n            },\n            \"warmer\": {\n               \"current\": 0,\n               \"total\": 368,\n               \"total_time_in_millis\": 119\n            },\n            \"filter_cache\": {\n               \"memory_size_in_bytes\": 0,\n               \"evictions\": 0\n            },\n            \"id_cache\": {\n               \"memory_size_in_bytes\": 0\n            },\n            \"fielddata\": {\n               \"memory_size_in_bytes\": 0,\n               \"evictions\": 0\n            },\n            \"percolate\": {\n               \"total\": 0,\n               \"time_in_millis\": 0,\n               \"current\": 0,\n               \"memory_size_in_bytes\": -1,\n               \"memory_size\": \"-1b\",\n               \"queries\": 0\n            },\n            \"completion\": {\n               \"size_in_bytes\": 32864\n            },\n            \"segments\": {\n               \"count\": 26,\n               \"memory_in_bytes\": 9095212,\n               \"index_writer_memory_in_bytes\": 324016,\n               \"index_writer_max_memory_in_bytes\": 103887667,\n               \"version_map_memory_in_bytes\": 22792,\n               \"fixed_bit_set_memory_in_bytes\": 0\n            },\n            \"translog\": {\n               \"operations\": 8246,\n               \"size_in_bytes\": 4267399\n            },\n            \"suggest\": {\n               \"total\": 0,\n               \"time_in_millis\": 0,\n               \"current\": 0\n            },\n            \"query_cache\": {\n               \"memory_size_in_bytes\": 0,\n               \"evictions\": 0,\n               \"hit_count\": 0,\n               \"miss_count\": 0\n            }\n         }\n      }\n```\n\n**\\* Is store.throttle_time_in_millis: 669 cosidered as an important factor? I am asking since I use doc_values on my mapping so maybe I am pushig too much my little VM :)\n# Finally I did notice some high I/O traffic with iotop\n\n![screenshot from 2015-02-23 22 48 22](https://cloud.githubusercontent.com/assets/10655938/6336848/4a30d73a-bbae-11e4-9c80-618bcc6d26a2.png)\n# Here is the sys info\n\nVagrant\nOS: CentOS release 6.6\nRAM: 2GB\nCPU: Intel(R) Core(TM) i5-2430M CPU @ 2.40GHz (2 cores)\n\nThanks a lot for your time\n\nRegards,\nAlex\n\nThe proxylab team | http://www.proxylab.io/\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}