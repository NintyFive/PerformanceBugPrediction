{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62084","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62084/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62084/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62084/events","html_url":"https://github.com/elastic/elasticsearch/issues/62084","id":695741310,"node_id":"MDU6SXNzdWU2OTU3NDEzMTA=","number":62084,"title":"Sub-aggregations when terms aggregation `min_doc_count` is 0 return a server error (new in 7.9.0)","user":{"login":"jamieparkinson","id":4429247,"node_id":"MDQ6VXNlcjQ0MjkyNDc=","avatar_url":"https://avatars1.githubusercontent.com/u/4429247?v=4","gravatar_id":"","url":"https://api.github.com/users/jamieparkinson","html_url":"https://github.com/jamieparkinson","followers_url":"https://api.github.com/users/jamieparkinson/followers","following_url":"https://api.github.com/users/jamieparkinson/following{/other_user}","gists_url":"https://api.github.com/users/jamieparkinson/gists{/gist_id}","starred_url":"https://api.github.com/users/jamieparkinson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jamieparkinson/subscriptions","organizations_url":"https://api.github.com/users/jamieparkinson/orgs","repos_url":"https://api.github.com/users/jamieparkinson/repos","events_url":"https://api.github.com/users/jamieparkinson/events{/privacy}","received_events_url":"https://api.github.com/users/jamieparkinson/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2020-09-08T10:08:54Z","updated_at":"2020-09-09T15:21:57Z","closed_at":"2020-09-09T15:21:57Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 7.9.0 on Elastic Cloud, verified on local official Docker image\r\n**Plugins installed**: _N/A_\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nPerforming a search that includes a terms aggregation with `min_doc_count: 0` and any sub-aggregation, where the query ensures that buckets with a doc count of 0 will exist, returns a `search_phase_execution_exception` with a root cause of `array_index_out_of_bounds_exception`.\r\n\r\nThis behaviour was not present in 7.8.1, and is still present in 7.9.1. The previous (and expected) behaviour was for the sub-aggregations to proceed as if on an empty context.\r\n\r\n**Steps to reproduce**:\r\nThese steps reproduce the problem on a fresh cluster. So far as I can tell, _any_ aggregation under `subagg` will return the same error - not just the filter/match_all in this example.\r\n\r\n```\r\nPUT /bug-mre\r\n\r\nPUT /bug-mre/_mapping\r\n{\r\n  \"properties\": {\r\n    \"letter\": {\r\n      \"type\": \"keyword\"\r\n    }\r\n  }\r\n}\r\n\r\nPOST /bug-mre/_bulk\r\n{\"index\":{}}\r\n{\"letter\":\"a\"}\r\n{\"index\":{}}\r\n{\"letter\":\"b\"}\r\n\r\nGET /bug-mre/_search\r\n{\r\n  \"query\": {\r\n    \"term\": {\r\n      \"letter\": \"a\"\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"letters\": {\r\n      \"terms\": {\r\n        \"field\": \"letter\",\r\n        \"min_doc_count\": 0\r\n      },\r\n      \"aggs\": {\r\n        \"subagg\": {\r\n          \"filter\": {\r\n            \"match_all\": {}\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis returns:\r\n\r\n```\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"array_index_out_of_bounds_exception\",\r\n        \"reason\" : \"Index -1 out of bounds for length 1\"\r\n      }\r\n    ],\r\n    \"type\" : \"search_phase_execution_exception\",\r\n    \"reason\" : \"all shards failed\",\r\n    \"phase\" : \"query\",\r\n    \"grouped\" : true,\r\n    \"failed_shards\" : [\r\n      {\r\n        \"shard\" : 0,\r\n        \"index\" : \"bug-mre\",\r\n        \"node\" : \"vuf3AdPqQV--8ZHh5QiYrA\",\r\n        \"reason\" : {\r\n          \"type\" : \"array_index_out_of_bounds_exception\",\r\n          \"reason\" : \"Index -1 out of bounds for length 1\"\r\n        }\r\n      }\r\n    ],\r\n    \"caused_by\" : {\r\n      \"type\" : \"array_index_out_of_bounds_exception\",\r\n      \"reason\" : \"Index -1 out of bounds for length 1\",\r\n      \"caused_by\" : {\r\n        \"type\" : \"array_index_out_of_bounds_exception\",\r\n        \"reason\" : \"Index -1 out of bounds for length 1\"\r\n      }\r\n    }\r\n  },\r\n  \"status\" : 500\r\n}\r\n\r\n```\r\n\r\nPlease let me know if you'd like any more info!","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}