[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223240274","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-223240274","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":223240274,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzI0MDI3NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-06-02T09:23:54Z","updated_at":"2016-06-02T09:23:54Z","author_association":"CONTRIBUTOR","body":"@polyfractal any ideas?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223290921","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-223290921","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":223290921,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzI5MDkyMQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-06-02T13:27:46Z","updated_at":"2016-06-02T13:27:46Z","author_association":"MEMBER","body":"@apanimesh061 Could you gist up somewhere the full output of the profiler response?  The short answer is I'm not sure.  It might be a recursive-style bug where timings are recorded multiple times, or perhaps one of the leaf components in your query isn't behaving correctly.\n\nNote: the `rewrite` time is in nanoseconds, so that's only 0.5ms.  But the rest of the time looks strange, I agree :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223602591","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-223602591","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":223602591,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzYwMjU5MQ==","user":{"login":"apanimesh061","id":3243029,"node_id":"MDQ6VXNlcjMyNDMwMjk=","avatar_url":"https://avatars2.githubusercontent.com/u/3243029?v=4","gravatar_id":"","url":"https://api.github.com/users/apanimesh061","html_url":"https://github.com/apanimesh061","followers_url":"https://api.github.com/users/apanimesh061/followers","following_url":"https://api.github.com/users/apanimesh061/following{/other_user}","gists_url":"https://api.github.com/users/apanimesh061/gists{/gist_id}","starred_url":"https://api.github.com/users/apanimesh061/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/apanimesh061/subscriptions","organizations_url":"https://api.github.com/users/apanimesh061/orgs","repos_url":"https://api.github.com/users/apanimesh061/repos","events_url":"https://api.github.com/users/apanimesh061/events{/privacy}","received_events_url":"https://api.github.com/users/apanimesh061/received_events","type":"User","site_admin":false},"created_at":"2016-06-03T14:58:47Z","updated_at":"2016-06-03T14:58:47Z","author_association":"NONE","body":"@polyfractal I have added the whole output [here](https://gist.github.com/apanimesh061/49ae3208287ced5d7ca33b125b2fbd27).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223634135","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-223634135","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":223634135,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzYzNDEzNQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-06-03T16:58:38Z","updated_at":"2016-06-03T16:58:38Z","author_association":"MEMBER","body":"Thanks @apanimesh061, that helped a bunch!\n\n@jpountz, it looks like my assumptions about method invocation order/dependence may be wrong?  Timings assume that the `breakdown` for each component are \"independent\" and do not include their children times.  E.g. the `score()` of a boolean query does not include the timing of `score()` for the children.\n\nBut looking closer, I think this is wrong.  For example, I'm looking at `ConjunctionScorer`, and it's `score()` method calls the `score()` of all it's children.  I imagine this is similar for the other methods (nextDoc, etc)...and it makes sense, as the Boolean would need to call down to all of it's children.\n\nSo I think the `breakdown` timings are actually inclusive of children already.  This seems to be backed up by the timings:\n\n```\n\"query_type\": \"GlobalOrdinalsQuery\",\n\"lucene\": \"GlobalOrdinalsQuery{joinField=_parent#influencer}\",\n\"time\": \"17080.18500ms\",\n\"breakdown\": {\n  \"score\": 4154770,\n  \"create_weight\": 19246,\n  \"next_doc\": 25930,\n  \"match\": 3595232475,\n  \"build_scorer\": 31100,\n  \"advance\": 9849058759\n},\n\"children\": [\n  {\n    \"query_type\": \"TermQuery\",\n    \"lucene\": \"_type:post\",\n    \"time\": \"3631.662722ms\",\n    \"breakdown\": {\n      \"score\": 0,\n      \"create_weight\": 15276,\n      \"next_doc\": 9534,\n      \"match\": 0,\n      \"build_scorer\": 23276,\n      \"advance\": 3631614636\n    }\n  }\n]\n```\n- `TermQuery`:  breakdown == 3631.662722 == reported time\n- `GlobalOrdinalsQuery`: breakdown == 13448.52228 != reported time\n\nBut if you add the child's time to the breakdown (13448.52228 + 3631.662722) you get the reported time of 17080.18500.\n\nFurther, the top-level breakdown comes out to 101,065ms, which is suspiciously close to the took time of 116,727ms (minus some non-profiled overhead).  Whereas the reported time is over double that.\n\nSo I think we can just [remove the recursive part of the calculation](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/search/profile/query/InternalQueryProfileTree.java#L234-L237) and everything should work?\n\nSimple change, but I'm afraid I've over-simplified how Lucene works, would be interested in hearing what you think. :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/224647321","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-224647321","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":224647321,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNDY0NzMyMQ==","user":{"login":"apanimesh061","id":3243029,"node_id":"MDQ6VXNlcjMyNDMwMjk=","avatar_url":"https://avatars2.githubusercontent.com/u/3243029?v=4","gravatar_id":"","url":"https://api.github.com/users/apanimesh061","html_url":"https://github.com/apanimesh061","followers_url":"https://api.github.com/users/apanimesh061/followers","following_url":"https://api.github.com/users/apanimesh061/following{/other_user}","gists_url":"https://api.github.com/users/apanimesh061/gists{/gist_id}","starred_url":"https://api.github.com/users/apanimesh061/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/apanimesh061/subscriptions","organizations_url":"https://api.github.com/users/apanimesh061/orgs","repos_url":"https://api.github.com/users/apanimesh061/repos","events_url":"https://api.github.com/users/apanimesh061/events{/privacy}","received_events_url":"https://api.github.com/users/apanimesh061/received_events","type":"User","site_admin":false},"created_at":"2016-06-08T16:28:58Z","updated_at":"2016-06-08T16:28:58Z","author_association":"NONE","body":"@polyfractal \nSo, basically you mean to say is that the time on a single node is already inclusive of the times of its children but due to that recursive function they are being added again?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/224654022","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-224654022","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":224654022,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNDY1NDAyMg==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-06-08T16:49:49Z","updated_at":"2016-06-08T16:49:49Z","author_association":"MEMBER","body":"@apanimesh061 Yep, that's correct.  \n\nThe `breakdown` timings of a node is the node + the timing of children.  But when the `\"time\"` summary is calculated, it recursively adds the `breakdown` + the `breakdown` of the children, so it's essentially counting the times twice.\n\nYou should be able to use just the `breakdown` time for now and get an accurate profile (although it'll be in nanoseconds, which is less pleasant to work with).\n\nI'm out this week and part of the next, but I'll work on this as soon as I get back :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230476844","html_url":"https://github.com/elastic/elasticsearch/issues/18693#issuecomment-230476844","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18693","id":230476844,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDQ3Njg0NA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2016-07-05T13:24:20Z","updated_at":"2016-07-05T13:24:20Z","author_association":"MEMBER","body":"Quick note (and reminder to self): I'm back from my traveling extravaganza and will fix this imminently.\n","performed_via_github_app":null}]