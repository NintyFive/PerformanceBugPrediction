{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21589","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21589/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21589/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21589/events","html_url":"https://github.com/elastic/elasticsearch/issues/21589","id":189632906,"node_id":"MDU6SXNzdWUxODk2MzI5MDY=","number":21589,"title":"Restarting node causes cluster red with dangling index","user":{"login":"HeyuimSara","id":9973525,"node_id":"MDQ6VXNlcjk5NzM1MjU=","avatar_url":"https://avatars2.githubusercontent.com/u/9973525?v=4","gravatar_id":"","url":"https://api.github.com/users/HeyuimSara","html_url":"https://github.com/HeyuimSara","followers_url":"https://api.github.com/users/HeyuimSara/followers","following_url":"https://api.github.com/users/HeyuimSara/following{/other_user}","gists_url":"https://api.github.com/users/HeyuimSara/gists{/gist_id}","starred_url":"https://api.github.com/users/HeyuimSara/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HeyuimSara/subscriptions","organizations_url":"https://api.github.com/users/HeyuimSara/orgs","repos_url":"https://api.github.com/users/HeyuimSara/repos","events_url":"https://api.github.com/users/HeyuimSara/events{/privacy}","received_events_url":"https://api.github.com/users/HeyuimSara/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-11-16T08:48:03Z","updated_at":"2016-11-16T11:39:41Z","closed_at":"2016-11-16T11:39:41Z","author_association":"NONE","active_lock_reason":null,"body":"**ENV:** \r\nUbuntu 14.04.1 LTS\r\nElasticsearch cluster: version 2.3.0 with 6 nodes\r\n\r\n**Reproduce steps:**\r\n\r\n- Create an index \r\n`curl -XPUT 'http://localhost:9200/sara_wednesday_test/' -d '{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 6, \r\n            \"number_of_replicas\" : 1\r\n        }\r\n    }\r\n}'`\r\n\r\n- See shards allocations, esnode02 holds primary shard 2 and replica shard 1\r\ncurl localhost:9200/_cat/shards?pretty | grep sara_wednesday_test`\r\nsara_wednesday_test 1 p STARTED   0    130b 10.29.97.183 esnode03\r\nsara_wednesday_test 1 r STARTED   0    130b 10.29.97.182 esnode02\r\nsara_wednesday_test 2 p STARTED   0    130b 10.29.97.182 esnode02\r\nsara_wednesday_test 2 r STARTED   0    130b 10.29.97.181 esnode01\r\nsara_wednesday_test 3 r STARTED   0    130b 10.29.97.186 esnode06\r\nsara_wednesday_test 3 p STARTED   0    130b 10.29.97.181 esnode01\r\nsara_wednesday_test 5 r STARTED   0    130b 10.29.97.185 esnode05\r\nsara_wednesday_test 5 p STARTED   0    130b 10.29.97.184 esnode04\r\nsara_wednesday_test 4 p STARTED   0    130b 10.29.97.185 esnode05\r\nsara_wednesday_test 4 r STARTED   0    130b 10.29.97.184 esnode04\r\nsara_wednesday_test 0 p STARTED   0    130b 10.29.97.186 esnode06\r\nsara_wednesday_test 0 r STARTED   0    130b 10.29.97.183 esnode03\r\n\r\n- Shutdown node esnode02 in the cluster\r\n\r\n- Delete the index\r\n`curl localhost:9200/sara_wednesday_test -XDELETE`\r\n{\"acknowledged\":true}\r\n\r\n- Restart node esnode02 in the cluster, seeing logs:\r\n\r\n> [2016-11-16 00:10:59,661][INFO ][gateway                  ] [esnode02] [sara_wednesday_test] dangling index, exists on local file system, but not in cluster metadata, auto import to cluster state\r\n\r\n\r\n- Cluster health shows red. See shard allocation, only shard 1 and shard 2 STARTED, other shards have been lost.\r\n`curl localhost:9200/_cat/shards?pretty | grep sara_wednesday_test`\r\nsara_wednesday_test 1 r STARTED      0    159b 10.29.97.186 esnode06\r\nsara_wednesday_test 1 p STARTED      0    159b 10.29.97.182 esnode02\r\nsara_wednesday_test 3 p UNASSIGNED\r\nsara_wednesday_test 3 r UNASSIGNED\r\nsara_wednesday_test 2 r STARTED      0    159b 10.29.97.183 esnode03\r\nsara_wednesday_test 2 p STARTED      0    159b 10.29.97.182 esnode02\r\nsara_wednesday_test 5 p UNASSIGNED\r\nsara_wednesday_test 5 r UNASSIGNED\r\nsara_wednesday_test 4 p UNASSIGNED\r\nsara_wednesday_test 4 r UNASSIGNED\r\nsara_wednesday_test 0 p UNASSIGNED\r\nsara_wednesday_test 0 r UNASSIGNED\r\n\r\n\r\nObviously, deleted index data still remains on the esnode02 filesystem, and when the node restarts, it is reimported into cluster by default. However, esnode02 does not hold the complete data of the index, thus causing index red and cluster red.\r\n\r\nThe problem here is that, as I am an ops guy, hosting Elasticsearch cluster for my consumers, I can only see there is something wrong with the index, indicating there must be unassigned shards (data loss).\r\nI think probably the right behavior is either Elasticsearch deletes the dangling index if the data is not complete, or Elasticsearch finds a way to recover the deleted data if reimport is the default behavior.\r\n\r\nHope to hear from you soon. Thanks.","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}