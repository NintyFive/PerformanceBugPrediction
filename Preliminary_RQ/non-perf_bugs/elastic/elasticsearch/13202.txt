{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13202","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13202/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13202/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13202/events","html_url":"https://github.com/elastic/elasticsearch/issues/13202","id":103933557,"node_id":"MDU6SXNzdWUxMDM5MzM1NTc=","number":13202,"title":"Cant add listener to ShardIndexingService if index failed","user":{"login":"kiryam","id":146705,"node_id":"MDQ6VXNlcjE0NjcwNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/146705?v=4","gravatar_id":"","url":"https://api.github.com/users/kiryam","html_url":"https://github.com/kiryam","followers_url":"https://api.github.com/users/kiryam/followers","following_url":"https://api.github.com/users/kiryam/following{/other_user}","gists_url":"https://api.github.com/users/kiryam/gists{/gist_id}","starred_url":"https://api.github.com/users/kiryam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kiryam/subscriptions","organizations_url":"https://api.github.com/users/kiryam/orgs","repos_url":"https://api.github.com/users/kiryam/repos","events_url":"https://api.github.com/users/kiryam/events{/privacy}","received_events_url":"https://api.github.com/users/kiryam/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-08-30T16:39:33Z","updated_at":"2015-09-02T20:52:29Z","closed_at":"2015-09-02T20:52:29Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ShardIndexingService has functionality for add listener on events preIndex and postIndex\nIn my project (https://github.com/kiryam/elasticsearch-top) I try to monitor current running index actions. Simple add to Queue if preIndex and remove if postIndex. But if I get failedIndex - index action will freeze in Queue.\n\n<pre>public Engine.Index preIndex(Engine.Index index) {\n        totalStats.indexCurrent.inc();\n        typeStats(index.type()).indexCurrent.inc();\n        for (IndexingOperationListener listener : listeners) {\n            index = listener.preIndex(index);\n        }\n        return index;\n    }\n\npublic void postIndex(Engine.Index index) {\n        long took = index.endTime() - index.startTime();\n        totalStats.indexMetric.inc(took);\n        totalStats.indexCurrent.dec();\n        StatsHolder typeStats = typeStats(index.type());\n        typeStats.indexMetric.inc(took);\n        typeStats.indexCurrent.dec();\n        slowLog.postIndex(index, took);\n        for (IndexingOperationListener listener : listeners) {\n            try {\n                listener.postIndex(index);\n            } catch (Exception e) {\n                logger.warn(\"post listener [{}] failed\", e, listener);\n            }\n        }\n    }\n\n\n// HERE no call listeners\npublic void failedIndex(Engine.Index index) {\n      totalStats.indexCurrent.dec();\n      typeStats(index.type()).indexCurrent.dec();\n  }</pre>\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}