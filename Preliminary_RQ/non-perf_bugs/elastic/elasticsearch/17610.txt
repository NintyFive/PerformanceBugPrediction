{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17610","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17610/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17610/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17610/events","html_url":"https://github.com/elastic/elasticsearch/issues/17610","id":146829175,"node_id":"MDU6SXNzdWUxNDY4MjkxNzU=","number":17610,"title":"Aggregation are not returned even though logs match in ES 2.x","user":{"login":"kadishmal","id":978004,"node_id":"MDQ6VXNlcjk3ODAwNA==","avatar_url":"https://avatars1.githubusercontent.com/u/978004?v=4","gravatar_id":"","url":"https://api.github.com/users/kadishmal","html_url":"https://github.com/kadishmal","followers_url":"https://api.github.com/users/kadishmal/followers","following_url":"https://api.github.com/users/kadishmal/following{/other_user}","gists_url":"https://api.github.com/users/kadishmal/gists{/gist_id}","starred_url":"https://api.github.com/users/kadishmal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kadishmal/subscriptions","organizations_url":"https://api.github.com/users/kadishmal/orgs","repos_url":"https://api.github.com/users/kadishmal/repos","events_url":"https://api.github.com/users/kadishmal/events{/privacy}","received_events_url":"https://api.github.com/users/kadishmal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-04-08T06:36:34Z","updated_at":"2016-04-12T14:08:12Z","closed_at":"2016-04-12T14:08:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: \n\n```\n2.0.2, 2.2.2, 2.3.0, 2.3.1\n```\n\n**JVM version**:\n\n```\nopenjdk version \"1.8.0_72-internal\"\nOpenJDK Runtime Environment (build 1.8.0_72-internal-b15)\nOpenJDK 64-Bit Server VM (build 25.72-b15, mixed mode)\n```\n\n**OS version**:\n\n```\nLinux defae922887a 4.0.9-boot2docker #1 SMP Thu Sep 10 20:39:20 UTC 2015 x86_64 GNU/Linux\n```\n\n**Description of the problem including expected versus actual behavior**:\n\nRunning the following query, which includes `range` and `query` filters under Filter Bool doesn't return aggregations:\n\n```\nPOST /_search?search_type=count\n{\n  \"query\": {\n    \"bool\": {\n      \"filter\": {\n        \"range\": {\n          \"logTime\": {\n            \"from\": 1459486745156,\n            \"to\": 1460091545156\n          }\n        },\n        \"query\": {\n          \"query_string\": {\n            \"default_field\": \"body\",\n            \"default_operator\": \"AND\",\n            \"lowercase_expanded_terms\": false,\n            \"query\": \"projectName:project*test\"\n          }\n        }\n      }\n    }\n  },\n  \"sort\": [\n    {\n      \"logTime\": {\n        \"order\": \"desc\",\n        \"ignoreUnmapped\": true\n      }\n    }\n  ],\n  \"aggs\": {\n    \"projectName\": {\n      \"terms\": {\n        \"field\": \"projectName\",\n        \"size\": 100\n      }\n    },\n    \"host\": {\n      \"terms\": {\n        \"field\": \"host\",\n        \"size\": 100\n      }\n    },\n    \"logLevel\": {\n      \"terms\": {\n        \"field\": \"logLevel\",\n        \"size\": 100\n      }\n    },\n    \"projectVersion\": {\n      \"terms\": {\n        \"field\": \"projectVersion\",\n        \"size\": 100\n      }\n    }\n  }\n}\n```\n\nResponse is (notice the `total = 2800`, there are matching logs, but no `aggregations`):\n\n```\n{\n   \"took\": 32,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 16,\n      \"successful\": 16,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 2800,\n      \"max_score\": 0,\n      \"hits\": []\n   }\n}\n```\n\nThe following query works however after converting `filter` into an array:\n\n```\nPOST /_search?search_type=count\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": [\n        {\n            \"range\": {\n              \"logTime\": {\n                \"from\": 1459486745156,\n                \"to\": 1460091545156\n              }\n            }\n        },\n        {\n            \"query\": {\n              \"query_string\": {\n                \"default_field\": \"body\",\n                \"default_operator\": \"AND\",\n                \"lowercase_expanded_terms\": false,\n                \"query\": \"projectName:project*test\"\n              }\n            }\n        }\n      ]\n    }\n  },\n  \"sort\": [\n    {\n      \"logTime\": {\n        \"order\": \"desc\",\n        \"ignoreUnmapped\": true\n      }\n    }\n  ],\n  \"aggs\": {\n    \"projectName\": {\n      \"terms\": {\n        \"field\": \"projectName\",\n        \"size\": 100\n      }\n    },\n    \"host\": {\n      \"terms\": {\n        \"field\": \"host\",\n        \"size\": 100\n      }\n    },\n    \"logLevel\": {\n      \"terms\": {\n        \"field\": \"logLevel\",\n        \"size\": 100\n      }\n    },\n    \"projectVersion\": {\n      \"terms\": {\n        \"field\": \"projectVersion\",\n        \"size\": 100\n      }\n    }\n  }\n}\n```\n\nThe response is:\n\n```\n{\n   \"took\": 105,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 60,\n      \"successful\": 60,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 2800,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"logLevel\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"INFO\",\n               \"doc_count\": 1459\n            },\n            {\n               \"key\": \"FATAL\",\n               \"doc_count\": 1341\n            }\n         ]\n      },\n      \"host\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"host1504\",\n               \"doc_count\": 2800\n            }\n         ]\n      },\n      \"projectName\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"project-ios-test\",\n               \"doc_count\": 1400\n            },\n            {\n               \"key\": \"project-test\",\n               \"doc_count\": 1400\n            }\n         ]\n      },\n      \"projectVersion\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"2.0.0\",\n               \"doc_count\": 2800\n            }\n         ]\n      }\n   }\n}\n```\n\n**Steps to reproduce**:\n\nThe index has the following mapping:\n\n```\n{\n   \"log-2016-04-08\": {\n      \"mappings\": {\n         \"project-test\": {\n            \"dynamic_templates\": [\n               {\n                  \"string_fields\": {\n                     \"mapping\": {\n                        \"index\": \"analyzed\",\n                        \"omit_norms\": true,\n                        \"type\": \"string\",\n                        \"fields\": {\n                           \"raw\": {\n                              \"ignore_above\": 256,\n                              \"index\": \"not_analyzed\",\n                              \"type\": \"string\",\n                              \"doc_values\": true\n                           }\n                        }\n                     },\n                     \"match\": \"*\",\n                     \"match_mapping_type\": \"string\"\n                  }\n               }\n            ],\n            \"date_detection\": false,\n            \"properties\": {\n               \"DmpData\": {\n                  \"type\": \"string\",\n                  \"index\": \"no\",\n                  \"norms\": {\n                     \"enabled\": false\n                  }\n               },\n               \"SDK\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"Platform\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"body\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"host\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"index\": {\n                  \"properties\": {\n                     \"_id\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     },\n                     \"_index\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     },\n                     \"_routing\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     },\n                     \"_type\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     }\n                  }\n               },\n               \"logLevel\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"logSource\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"logTime\": {\n                  \"type\": \"long\"\n               },\n               \"logType\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"projectName\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"projectVersion\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"toList\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               }\n            }\n         },\n         \"project-ios-test\": {\n            \"dynamic_templates\": [\n               {\n                  \"string_fields\": {\n                     \"mapping\": {\n                        \"index\": \"analyzed\",\n                        \"omit_norms\": true,\n                        \"type\": \"string\",\n                        \"fields\": {\n                           \"raw\": {\n                              \"ignore_above\": 256,\n                              \"index\": \"not_analyzed\",\n                              \"type\": \"string\",\n                              \"doc_values\": true\n                           }\n                        }\n                     },\n                     \"match\": \"*\",\n                     \"match_mapping_type\": \"string\"\n                  }\n               }\n            ],\n            \"date_detection\": false,\n            \"properties\": {\n               \"DmpData\": {\n                  \"type\": \"string\",\n                  \"index\": \"no\",\n                  \"norms\": {\n                     \"enabled\": false\n                  }\n               },\n               \"SDK\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"Platform\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"body\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"host\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"index\": {\n                  \"properties\": {\n                     \"_id\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     },\n                     \"_index\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     },\n                     \"_type\": {\n                        \"type\": \"string\",\n                        \"norms\": {\n                           \"enabled\": false\n                        },\n                        \"fields\": {\n                           \"raw\": {\n                              \"type\": \"string\",\n                              \"index\": \"not_analyzed\",\n                              \"ignore_above\": 256\n                           }\n                        }\n                     }\n                  }\n               },\n               \"logLevel\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"logSource\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"logTime\": {\n                  \"type\": \"long\"\n               },\n               \"logType\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               },\n               \"projectName\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"projectVersion\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"toList\": {\n                  \"type\": \"string\",\n                  \"norms\": {\n                     \"enabled\": false\n                  },\n                  \"fields\": {\n                     \"raw\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                        \"ignore_above\": 256\n                     }\n                  }\n               }\n            }\n         },\n         \"_default_\": {\n            \"dynamic_templates\": [\n               {\n                  \"string_fields\": {\n                     \"mapping\": {\n                        \"index\": \"analyzed\",\n                        \"omit_norms\": true,\n                        \"type\": \"string\",\n                        \"fields\": {\n                           \"raw\": {\n                              \"ignore_above\": 256,\n                              \"index\": \"not_analyzed\",\n                              \"type\": \"string\",\n                              \"doc_values\": true\n                           }\n                        }\n                     },\n                     \"match\": \"*\",\n                     \"match_mapping_type\": \"string\"\n                  }\n               }\n            ],\n            \"date_detection\": false,\n            \"properties\": {\n               \"DmpData\": {\n                  \"type\": \"string\",\n                  \"index\": \"no\",\n                  \"norms\": {\n                     \"enabled\": false\n                  }\n               },\n               \"host\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"logLevel\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"logTime\": {\n                  \"type\": \"long\"\n               },\n               \"projectName\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               },\n               \"projectVersion\": {\n                  \"type\": \"string\",\n                  \"index\": \"not_analyzed\",\n                  \"ignore_above\": 256\n               }\n            }\n         }\n      }\n   }\n}\n```\n\n**Provide logs (if relevant)**:\n\nA sample log is:\n\n```\n{\n               \"index\": {\n                  \"_index\": \"log-2016-04-08\",\n                  \"_type\": \"project-test\",\n                  \"_id\": \"d490daea5bf23010560017\",\n                  \"_routing\": \"project-test\"\n               },\n               \"SDK\": \"0.9.0\",\n               \"Platform\": \"Windows Server 2008 R2(6.1)\",\n               \"body\": \"[2014/04/22 17:21:31.704] [ItemCode:12402][ItemCount:1]\\n\",\n               \"host\": \"host1504\",\n               \"logLevel\": \"INFO\",\n               \"logSource\": \"openapi\",\n               \"logTime\": 1460091528472,\n               \"logType\": \"mocha\",\n               \"projectName\": \"project-test\",\n               \"projectVersion\": \"2.0.0\",\n               \"toList\": \"[NA11607, NA10214]\"\n            }\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}