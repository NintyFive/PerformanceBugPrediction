[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454849536","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-454849536","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":454849536,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDg0OTUzNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-16T16:41:41Z","updated_at":"2019-01-16T16:41:41Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460224023","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-460224023","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":460224023,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDIyNDAyMw==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2019-02-04T12:01:20Z","updated_at":"2019-02-04T12:01:20Z","author_association":"CONTRIBUTOR","body":"Cannot reproduce it locally after many thousands of iterations.\r\nFound a reproduce command from kibana logs:\r\n```\r\n./gradlew :server:unitTest -Dtests.seed=C593D66EF8528D36 -Dtests.class=org.elasticsearch.index.mapper.NestedObjectMapperTests -Dtests.security.manager=true -Dtests.locale=en-US -Dtests.timezone=Etc/UTC -Dcompiler.java=11 -Druntime.java=8\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461200454","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-461200454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":461200454,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTIwMDQ1NA==","user":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"created_at":"2019-02-06T21:46:18Z","updated_at":"2019-02-06T21:46:18Z","author_association":"CONTRIBUTOR","body":"I've done some digging into this one, and I'm pretty sure it's the same issue in #37469 and #32369.  I haven't yet traced where the specific leaked threads are being created, or why they only sometimes leak.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463718578","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-463718578","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":463718578,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzcxODU3OA==","user":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"created_at":"2019-02-14T17:35:18Z","updated_at":"2019-02-14T17:35:18Z","author_association":"CONTRIBUTOR","body":"I'm recategorizing this as a distributed issue, and reaching out to the distributed team for help with it.  Here's what I know so far:\r\n\r\nThis issue and the two linked issues result from threads created in the `MockTcpTransport` test shim class not properly exiting during node shutdown.  That was removed from master in #36628 but still exists in the 6.x line.  These threads are cleaned up as part of the node shutdown in `EsSingleNodeTestCase`, so I don't think there's anything to be gained by muting specific instances of this issue.  By similar logic, I don't think this issue is specifically related to the `NestedObjectMapperTests`.\r\n\r\nIncidents of this issue spiked during some of the infra difficulties in January, and have since tapered off.  That and the fact that the relevant class is no longer in master might be enough to say we should just close this issue, but I'd like a second opinion on that.  You can see the trend in the relevant failures here: https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-60d,mode:quick,to:now))&_a=(columns:!(_source),index:b646ed00-7efc-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'com.carrotsearch.randomizedtesting.ThreadLeakError%20AND%20__mock_network_thread*'),sort:!(process.time-start,desc))\r\n\r\nI'm happy to help out whoever wants to pick this up, but at this point I think it needs someone more familiar with the relevant sections of code than I am.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463718770","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-463718770","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":463718770,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzcxODc3MA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-14T17:35:49Z","updated_at":"2019-02-14T17:35:49Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464047348","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-464047348","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":464047348,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDA0NzM0OA==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-02-15T13:17:12Z","updated_at":"2019-02-15T13:18:22Z","author_association":"CONTRIBUTOR","body":"The log file from:\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.6+multijob-unix-compatibility/os=debian-9/110/console\r\n\r\nindicates that Node.stop took 20 seconds:\r\n```\r\n  1> [2019-02-11T23:57:06,163][INFO ][o.e.n.Node               ] [suite] stopping ...\r\n  1> [2019-02-11T23:57:26,169][INFO ][o.e.n.Node               ] [suite] stopped\r\n```\r\n\r\n I think this comes from MockTransport.stopInternal:\r\n\r\n```\r\n    @Override\r\n    protected void stopInternal() {\r\n        ThreadPool.terminate(executor, 10, TimeUnit.SECONDS);\r\n        synchronized (openChannels) {\r\n            assert openChannels.isEmpty() : \"there are still open channels: \" + openChannels;\r\n        }\r\n    }\r\n\r\n```\r\n\r\nThreadPool.terminate will wait twice for the timeout, trying to shutdown nicely first and then using shutdownNow.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464635366","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-464635366","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":464635366,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDYzNTM2Ng==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-02-18T08:32:59Z","updated_at":"2019-02-18T18:36:33Z","author_association":"CONTRIBUTOR","body":"There are 3 main ways this could potentially happen (TcpTransport/MockTcpTransport).\r\n1. The synchronization around serverChannels is not complete and thus close might not see all channels.\r\n2. The generic() thread pool is shutdown before we get to doStop\r\n3. Close on the socket does not break accept (JVM bug).\r\n\r\n3 sounds unlikely. I tried provoking it but were not successful.\r\n2 I could not find any indications of. Also, we should have had a 30 second wait on the latch in doStop, not a 20 second wait.\r\n1 also seems not to be able to happen, since everything regarding start and stop works sequentially with happens-before relations from Future.get, executor.execute etc.\r\n\r\nWe should notice that we do get to stopping the transport and that there is a good indication that the problem is the current test's transport due to the 20 second wait time noted above. Also, it does not fail exceptionally, since we get the Stopped message and we also do not get any \"uncaught exception\" logging entries from `QueueUncaughtExceptionsHandler`.\r\n\r\nAs also noted by Mark, master no longer uses MockTcpTransport so seems likely this will not appear.\r\n\r\nI will open a PR that does following:\r\n\r\n1. asserts that the generic() threadpool is not shutdown when we enter doStop()\r\n2. Add synchronized around reading the serverChannels map\r\n\r\nThis will be backported to both 6.x and 6.6 since this is the only place we still see these errors occasionally.\r\n\r\nNotice that the specific tests this affect vary greatly and failures in both `ESSingleNodeTestCase` and `ESIntegTestCase` style tests have been found.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471028251","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-471028251","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":471028251,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTAyODI1MQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-03-08T18:27:44Z","updated_at":"2019-03-08T18:27:44Z","author_association":"CONTRIBUTOR","body":"@henningandersen can we close this now as #39031 is merged?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471525635","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-471525635","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":471525635,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTUyNTYzNQ==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-03-11T12:50:14Z","updated_at":"2019-03-11T12:50:14Z","author_association":"CONTRIBUTOR","body":"@ywelsch, unfortunately not since we had 3 test failures with leaked threads last week. Will continue investigation based on logs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/490082042","html_url":"https://github.com/elastic/elasticsearch/issues/37543#issuecomment-490082042","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37543","id":490082042,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MDA4MjA0Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-05-07T13:35:11Z","updated_at":"2019-05-07T13:35:11Z","author_association":"CONTRIBUTOR","body":"Given that this is 6.x only, and an issue related to a transport implementation which is no longer used in newer branches, I'm inclined to close this here. If this reoccurs more often, we can revisit.","performed_via_github_app":null}]