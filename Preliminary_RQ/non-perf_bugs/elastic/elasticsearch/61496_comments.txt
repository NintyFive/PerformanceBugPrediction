[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/679274866","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-679274866","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":679274866,"node_id":"MDEyOklzc3VlQ29tbWVudDY3OTI3NDg2Ng==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-08-24T17:52:18Z","updated_at":"2020-08-24T17:52:18Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/679275117","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-679275117","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":679275117,"node_id":"MDEyOklzc3VlQ29tbWVudDY3OTI3NTExNw==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2020-08-24T17:52:51Z","updated_at":"2020-08-24T17:52:51Z","author_association":"MEMBER","body":"Tagging search as I am unsure what other team should get pinged :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/692850647","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-692850647","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":692850647,"node_id":"MDEyOklzc3VlQ29tbWVudDY5Mjg1MDY0Nw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-09-15T17:08:31Z","updated_at":"2020-09-15T17:08:31Z","author_association":"MEMBER","body":"Narrowing this down a bit. This reproduces for me on 7.x but not on master. Also if I leave out the runtime Java version `-Druntime.java=8` or change it to anything highter the test passes.\r\nThe randomization picks a \"strict_weekyear_week\" formatter and formats a random long date trough which for this seed gives \"2003-W41\". This doesn't get parsed well back with `parseMillis` by the same formatter, so roundtripping doesn't work. Reduced to one line:\r\n```\r\nDateFormatter.forPattern(\"strict_weekyear_week\").parseMillis(\"2003-W41\");\r\n```\r\nfails for `-Druntime.java=8` (which for me locally is Oracle jdk1.8.0_201.jdk) but passes for higher versions (e.g. 9, Oracle jdk-9.0.4.jdk)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/692873687","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-692873687","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":692873687,"node_id":"MDEyOklzc3VlQ29tbWVudDY5Mjg3MzY4Nw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-09-15T17:47:50Z","updated_at":"2020-09-15T17:47:50Z","author_association":"MEMBER","body":"Using 8, DateFormatter#from(TemporalAccessor accessor, Locale locale, ZoneId defaultZone) falls through for the above, while higher jdk versions return from the `else if (accessor.isSupported(WeekFields.of(locale).weekBasedYear()))` condition.\r\nOther formatters that exhibit similar quirks with 8 are \"strict_weekyear_week\", \"strict_weekyear\", \"weekyear_week\" and \"week_year\".\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/703717440","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-703717440","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":703717440,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMzcxNzQ0MA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-10-05T15:45:30Z","updated_at":"2020-10-05T15:45:30Z","author_association":"MEMBER","body":"> ' DateFormatter.forPattern(\"strict_weekyear_week\").parseMillis(\"2003-W41\");'\r\n\r\nThis is not only a test issue, I started current 7.x branch locally with java 8 (Oracle 1.8.0_201), and the following\r\nsnippet does not work, whereas with a Java 9 version everthing works fine.\r\n\r\n```\r\nPUT /datetest\r\n{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"datefield\" : {\r\n        \"type\": \"date\",\r\n        \"format\": \"strict_weekyear_week\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT /datetest/_doc/1\r\n{\r\n  \"datefield\" : \"2003-W41\"\r\n}\r\n```\r\nGetting the following error on 8:\r\n```\r\n \"type\" : \"illegal_argument_exception\",\r\n      \"reason\" : \"temporal accessor [{WeekBasedYear[WeekFields[MONDAY,4]]=2003, WeekOfWeekBasedYear[WeekFields[MONDAY,4]]=41},ISO] cannot be converted to zoned date time\"\r\n```\r\n\r\nI will go ahead and file a regular issue for this, then we can maybe simplify the test by excluding the problematic formats for the time being (at least on 7.x branch, this is no issue on master etc... since we don't allow using Java 8 there anymore).\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704317371","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-704317371","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":704317371,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDMxNzM3MQ==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-10-06T14:42:46Z","updated_at":"2020-10-13T15:18:38Z","author_association":"CONTRIBUTOR","body":"the problem is indeed with JDK 8. \r\nJDK defaults start of the week to Sunday and expects 1 day in the first week of the year. \r\nWe use SPI to load custom `IsoCalendarDataProvider` which allows use to override start of the week and minimum of years in first week of year.\r\nIt is easy with jdk9+ as we only need to put it on a classpath. To make it work with jdk8 we would have to place it in jre/ext/lib - we don't expect users to do this.\r\n\r\nSo when running DateFormatters.from method in this line https://github.com/elastic/elasticsearch/blob/7.x/server/src/main/java/org/elasticsearch/common/time/DateFormatters.java#L1898\r\nwe have an accessor ` [{WeekBasedYear[WeekFields[MONDAY,4]]=2003, WeekOfWeekBasedYear[WeekFields[MONDAY,4]]=41},ISO] `\r\nbut it checks if `isSupported(WeekBasedYear[WeekFields[Sunday,1]]` and it returns false.\r\n\r\nin jdk9+ this would test against `isSupported(WeekBasedYear[WeekFields[MONDAY,4]]` and would return true.\r\n\r\nIt is documented in 6.8 as a known issue, we made a comment about this in code here \r\nhttps://github.com/elastic/elasticsearch/blob/7.x/server/src/main/java/org/elasticsearch/common/time/DateFormatters.java#L58\r\nbut the problem for jdk8 will persist in 7.x\r\nFor other tests we make an assumption it has to be run with at least JDK9 \r\nmaybe we do the same here?\r\nhttps://github.com/elastic/elasticsearch/blob/7.x/server/src/test/java/org/elasticsearch/common/joda/JavaJodaTimeDuellingTests.java#L58 \r\n\r\nWe could try to fix this with snippet like.. will investigate\r\n```\r\nprivate static WeekFields weekFields(Locale locale) {\r\n        if(locale.equals(Locale.ROOT)){\r\n            return WEEK_FIELDS_ROOT;\r\n        }\r\n        return WeekFields.of(locale);\r\n    }\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704321678","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-704321678","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":704321678,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDMyMTY3OA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-10-06T14:49:04Z","updated_at":"2020-10-06T14:49:04Z","author_association":"MEMBER","body":"> For other tests we make an assumption it has to be run with at least JDK8\r\n> maybe we do the same here?\r\n> https://github.com/elastic/elasticsearch/blob/7.x/server/src/test/java/org/elasticsearch/common/joda/JavaJodaTimeDuellingTests.java#L58\r\n\r\nI'm happy to do that for the test in question. I was concerned that this is a real issue for anybody running 7.x versions with JDK 8, but since this seems to be a rare format and combination and its going away with 8.0 anyway it might not be worth fixing. Would you think this is rather a documentation / known issue case then? I can open a follow up to document this better.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704322259","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-704322259","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":704322259,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDMyMjI1OQ==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-10-06T14:49:57Z","updated_at":"2020-10-06T14:49:57Z","author_association":"CONTRIBUTOR","body":"I will try to investigate if any fix is possible and will add a known issue if nothing helps","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/708166142","html_url":"https://github.com/elastic/elasticsearch/issues/61496#issuecomment-708166142","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61496","id":708166142,"node_id":"MDEyOklzc3VlQ29tbWVudDcwODE2NjE0Mg==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-10-14T05:29:39Z","updated_at":"2020-10-14T05:29:39Z","author_association":"CONTRIBUTOR","body":"closed by  https://github.com/elastic/elasticsearch/pull/63626","performed_via_github_app":null}]