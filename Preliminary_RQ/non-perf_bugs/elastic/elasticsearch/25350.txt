{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25350","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25350/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25350/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25350/events","html_url":"https://github.com/elastic/elasticsearch/issues/25350","id":237802574,"node_id":"MDU6SXNzdWUyMzc4MDI1NzQ=","number":25350,"title":"Upgrading an index using a custom similarity fails","user":{"login":"xabbu42","id":98500,"node_id":"MDQ6VXNlcjk4NTAw","avatar_url":"https://avatars3.githubusercontent.com/u/98500?v=4","gravatar_id":"","url":"https://api.github.com/users/xabbu42","html_url":"https://github.com/xabbu42","followers_url":"https://api.github.com/users/xabbu42/followers","following_url":"https://api.github.com/users/xabbu42/following{/other_user}","gists_url":"https://api.github.com/users/xabbu42/gists{/gist_id}","starred_url":"https://api.github.com/users/xabbu42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xabbu42/subscriptions","organizations_url":"https://api.github.com/users/xabbu42/orgs","repos_url":"https://api.github.com/users/xabbu42/repos","events_url":"https://api.github.com/users/xabbu42/events{/privacy}","received_events_url":"https://api.github.com/users/xabbu42/received_events","type":"User","site_admin":false},"labels":[{"id":146832994,"node_id":"MDU6TGFiZWwxNDY4MzI5OTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Plugins","name":":Core/Infra/Plugins","color":"0e8a16","default":false,"description":"Plugin API and infrastructure"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-06-22T10:36:57Z","updated_at":"2018-02-17T01:05:30Z","closed_at":"2018-01-09T00:41:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 5.1.1 - 5.4.1\r\n\r\n**Plugins installed**: [analysis-icu, elasticsearch-position-similarity]\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_131\"\r\nOpenJDK Runtime Environment (IcedTea 3.4.0) (suse-10.10.3-x86_64)\r\nOpenJDK 64-Bit Server VM (build 25.131-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux oviken 4.4.36-8-default #1 SMP Fri Dec 9 16:18:38 UTC 2016 (3ec5648) x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nUpgrading an index using a custom similarity fails in org.elasticsearch.cluster.metadata.MetaDataIndexUpgradeService.checkMappingsCompatibility with the exception \"Unknown Similarity type\". If the old and the new elasticserver have the same custom similarity installed, upgrading should work.\r\n\r\nLooking at the code, it is no surprise that this does not work, as checkMappingsCompatibility creates a SimilarityService with an empty list of additional similarities. It seems something akin to the fake analyzerMap is necessary for custom similarities?\r\n\r\nThis is a follow up to https://discuss.elastic.co/t/upgrading-index-with-custom-similarity-not-working/76678 as by now I'm quite sure this is a bug with elasticsearch an not with my similarity plugin.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Start elasticsearch version 5.1.1 with https://github.com/sdauletau/elasticsearch-position-similarity installed (I've attached the exact zip I build and used)\r\n[elasticsearch-position-similarity-5.1.1.zip](https://github.com/elastic/elasticsearch/files/1094449/elasticsearch-position-similarity-5.1.1.zip)\r\n\r\n 2. Create an index using this similarity:\r\n```\r\ncurl -s -XPUT \"http://localhost:9200/test_index\" -d '\r\n{\r\n  \"settings\": {\r\n    \"similarity\": {\r\n      \"positionSimilarity\": {\r\n        \"type\": \"position-similarity\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n 3. Stop elasticsearch, upgrade to 5.1.2, install the same plugin for this version (I again attached the zip I used)\r\n[elasticsearch-position-similarity-5.1.2.zip](https://github.com/elastic/elasticsearch/files/1094446/elasticsearch-position-similarity-5.1.2.zip)\r\n\r\n4. Start elasticsearch again\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n[elasticsearch.txt](https://github.com/elastic/elasticsearch/files/1094451/elasticsearch.txt)\r\n\r\nhttps://gist.github.com/xabbu42/66dd46bd3cc15244cede8ceadf884fd8\r\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}