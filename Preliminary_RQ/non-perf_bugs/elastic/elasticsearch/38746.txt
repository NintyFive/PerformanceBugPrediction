{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38746","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38746/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38746/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38746/events","html_url":"https://github.com/elastic/elasticsearch/issues/38746","id":408968841,"node_id":"MDU6SXNzdWU0MDg5Njg4NDE=","number":38746,"title":"Sorting: text field with \"missing\": \"_last\" is not working properly with date orders.","user":{"login":"brunoocasali","id":4116980,"node_id":"MDQ6VXNlcjQxMTY5ODA=","avatar_url":"https://avatars1.githubusercontent.com/u/4116980?v=4","gravatar_id":"","url":"https://api.github.com/users/brunoocasali","html_url":"https://github.com/brunoocasali","followers_url":"https://api.github.com/users/brunoocasali/followers","following_url":"https://api.github.com/users/brunoocasali/following{/other_user}","gists_url":"https://api.github.com/users/brunoocasali/gists{/gist_id}","starred_url":"https://api.github.com/users/brunoocasali/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brunoocasali/subscriptions","organizations_url":"https://api.github.com/users/brunoocasali/orgs","repos_url":"https://api.github.com/users/brunoocasali/repos","events_url":"https://api.github.com/users/brunoocasali/events{/privacy}","received_events_url":"https://api.github.com/users/brunoocasali/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-02-11T20:47:35Z","updated_at":"2019-02-12T15:05:08Z","closed_at":"2019-02-12T15:05:08Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.4\r\n\r\n**Plugins installed**: \r\n```\r\n[x-pack-core, x-pack-deprecation, x-pack-graph, x-pack-logstash, \r\n x-pack-ml, x-pack-monitoring, x-pack-security, x-pack-upgrade, x-pack-watcher]\r\n```\r\n\r\n**JVM version**: \r\n```\r\njava version \"1.8.0_181\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_181-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)\r\n```\r\n\r\n**OS version**: \r\n```\r\nLinux elastic 4.4.0-141-generic #167-Ubuntu SMP Wed Dec 5 10:40:15 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe \"missing\" query is not responding as requested, specially if used with a date field. \r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n**Mapping**: (The real mapping has more than 100 lines, to reduce that I just let the maps used in query)\r\n```json\r\n{\r\n  \"store_reviews\": {\r\n    \"mappings\": {\r\n      \"store_review\": {\r\n        \"dynamic_templates\": [\r\n          {\r\n            \"string_template\": {\r\n              \"match\": \"*\",\r\n              \"match_mapping_type\": \"string\",\r\n              \"mapping\": {\r\n                \"fields\": {\r\n                  \"analyzed\": {\r\n                    \"analyzer\": \"searchkick_index\",\r\n                    \"index\": true,\r\n                    \"type\": \"text\"\r\n                  }\r\n                },\r\n                \"ignore_above\": 30000,\r\n                \"type\": \"keyword\"\r\n              }\r\n            }\r\n          }\r\n        ],\r\n        \"properties\": {\r\n          \"created_at\": {\r\n            \"type\": \"date\"\r\n          },\r\n          \"id\": {\r\n            \"type\": \"long\"\r\n          },\r\n          \"text\": {\r\n            \"type\": \"keyword\",\r\n            \"fields\": {\r\n              \"analyzed\": {\r\n                \"type\": \"text\",\r\n                \"analyzer\": \"searchkick_index\"\r\n              }\r\n            },\r\n            \"ignore_above\": 30000\r\n          },\r\n          \"store_id\": {\r\n            \"type\": \"long\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Query**\r\n```json\r\nGET /store_reviews/_search?\r\n{\r\n  \"_source\": [\"created_at\", \"text\"],\r\n  \"size\": 1000,\r\n  \"sort\": [\r\n    { \"created_at\": \"desc\" },\r\n    { \"text\": { \"missing\": \"_last\" } }\r\n  ],\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"store_id\": \"81534\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n**Response**\r\n```\r\n{\r\n  \"took\": 2,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 4361,\r\n    \"max_score\": null,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"store_reviews\",\r\n        \"_type\": \"store_review\",\r\n        \"_id\": \"4482159\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"created_at\": \"2019-02-10T23:29:13.000Z\",\r\n          \"text\": \"Tem excelentes produtos. Porém precisa melhorar as informações do site oficial da marca. No comércio local se encontra produtos  da marca bem melhores do que no site. \"\r\n        },\r\n        \"sort\": [\r\n          1549841353000,\r\n          \"Tem excelentes produtos. Porém precisa melhorar as informações do site oficial da marca. No comércio local se encontra produtos  da marca bem melhores do que no site. \"\r\n        ]\r\n      },\r\n      {\r\n        \"_index\": \"store_reviews\",\r\n        \"_type\": \"store_review\",\r\n        \"_id\": \"4482087\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"created_at\": \"2019-02-10T21:24:40.000Z\",\r\n          \"text\": null\r\n        },\r\n        \"sort\": [\r\n          1549833880000,\r\n          null\r\n        ]\r\n      },\r\n      {\r\n        \"_index\": \"store_reviews\",\r\n        \"_type\": \"store_review\",\r\n        \"_id\": \"4482000\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"created_at\": \"2019-02-10T18:43:45.000Z\",\r\n          \"text\": \"Ótimos preços e opções para nossos pequenos ☺\"\r\n        },\r\n        \"sort\": [\r\n          1549824225000,\r\n          \"Ótimos preços e opções para nossos pequenos ☺\"\r\n        ]\r\n      },\r\n      {\r\n        \"_index\": \"store_reviews\",\r\n        \"_type\": \"store_review\",\r\n        \"_id\": \"4481622\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"created_at\": \"2019-02-10T02:35:44.000Z\",\r\n          \"text\": \"otimo entrega rapida\"\r\n        },\r\n        \"sort\": [\r\n          1549766144000,\r\n          \"otimo entrega rapida\"\r\n        ]\r\n      },\r\n      {\r\n        \"_index\": \"store_reviews\",\r\n        \"_type\": \"store_review\",\r\n        \"_id\": \"4481619\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"created_at\": \"2019-02-10T02:25:17.000Z\",\r\n          \"text\": null\r\n        },\r\n        \"sort\": [\r\n          1549765517000,\r\n          null\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nI've changed the order of the created_at (placed at the top of the text: missing), but this makes the \r\nresponse returns old records first (with text but older). ex:\r\n\r\n```\r\n# first item\r\ncreated_at: 2018-04-10\r\ntext: 'my text' \r\n\r\n# second item\r\ncreated_at: 2019-02-12\r\ntext: 'my text'\r\n```\r\n\r\nWhile we discuss about this, I've fixed my query using this script:\r\n```json\r\n\"sort\": [\r\n    {\r\n      \"_script\": {\r\n        \"type\": \"number\",\r\n        \"script\": {\r\n          \"source\": \"doc['text'].empty ? 0 : 1\"\r\n        },\r\n        \"order\": \"desc\"\r\n      }\r\n    },\r\n    { \"created_at\": \"desc\" }\r\n  ]\r\n```\r\n\r\nAny thoughts about this?","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}