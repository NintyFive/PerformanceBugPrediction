[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/677710931","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-677710931","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":677710931,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NzcxMDkzMQ==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2020-08-20T14:46:52Z","updated_at":"2020-08-20T14:46:52Z","author_association":"MEMBER","body":"After discussing this, we concluded that EQL (and QL in general) should be more careful around what thread it uses.\r\nWhile the `transport_worker` thread usage is okayish, the usage of the `management` one is not. Also with EQL doing multiple queries for a sequence, the use of the `search` thread becomes problematic.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680068830","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680068830","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680068830,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDA2ODgzMA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2020-08-25T14:43:29Z","updated_at":"2020-08-25T14:43:29Z","author_association":"MEMBER","body":"I wonder if @elastic/es-core-infra have some recommendations on how we should deal with threads in EQL.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680081105","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680081105","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680081105,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDA4MTEwNQ==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2020-08-25T15:03:34Z","updated_at":"2020-08-25T15:03:34Z","author_association":"MEMBER","body":"I think threads and which one to use is a problem we have in many different places. I did some thinking about this recently when introducing a new threadpool for system reads and a lot of times we just throw things into the generic threadpool and call it done :(. Thank you for starting this discussion and thinking about the usage of threads by EQL. In order to provide the most useful input, can the steps be explained a bit more?\r\n\r\nFor example, in terms of mapping merging - what exactly is this doing? What is involved in the plan analysis?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680104956","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680104956","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680104956,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDEwNDk1Ng==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2020-08-25T15:41:47Z","updated_at":"2020-08-25T15:41:47Z","author_association":"MEMBER","body":"Thanks for stepping in Jay.\r\n\r\nIn terms of thread usage, EQL currently has 3 main stages:\r\n\r\n`transport_worker`\r\n1. EQL request is received.\r\nThe query is parsed and the grammar checked. Before doing proper analysis, the mapping of the target index/alias is being requested.\r\n\r\n`management` \r\n2. Once the mappings get returned, they are being merged into one virtual mapping (as the target can hit multiple indices and currently we do have to do conflict resolution - this might be something that will change in the future).\r\nOnce the mapping gets created and no conflicts are discovered, the process resumes- the plan gets analyzed, optimized and planning occurs. The actual search queries are sent.\r\n\r\n`search`\r\n3. As the results are being returned, the sequences / correlation happens. This is where most of the work/execution time is spent since as the data comes back, some of it will be dropped (it doesn't form sequences) while some will. But most importantly new queries are created and the process repeated until either we're running out of data or the number of requested results has been found.\r\n\r\nI think 1 is fine however with 2 I'm concerned the mappings themselves can be a problem. Otherwise, this process from a computation POV is quite fast (we're talking ms here). 3 is the biggest concern since EQL does trigger other queries as it navigates through the data and in case of issues, might be hard to isolate or exacerbate the problem to other areas.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680203845","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680203845","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680203845,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDIwMzg0NQ==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2020-08-25T18:43:12Z","updated_at":"2020-08-25T18:43:12Z","author_association":"MEMBER","body":"Thanks for the details Costin. \r\n\r\n`transport_worker` - I agree that the work done when a request is received is fine. \r\n\r\n`management` - I do not believe that the mappings should be an issue. Can you elaborate on the mappings being a problem in terms of threading? (BTW it looks like EQL is actually pulling the field capabilities and not mappings if I am looking in the right [place](https://github.com/elastic/elasticsearch/blob/20c4da3a64e3b1ccf5cef26e9e99b561df4efa76/x-pack/plugin/ql/src/main/java/org/elasticsearch/xpack/ql/index/IndexResolver.java#L281-L291)). Also, it doesn't look like EQL is blocking or anything like that so I don't really see a reason to move to another thread.\r\n\r\n`search` - I'd say this is the right choice. If you think about the nature of the search threads we run searches and aggregations on these threads. If EQL is triggering other queries _asynchronously_ then it won't be tying up search threads indefinitely. Searches need to process data as it comes back (reduce phase from shards). There is a cost to process the data but I think that's still part of search. It is almost like EQL is search with more phases/processing especially when I think about this phrase from your response:\r\n\r\n> the process repeated until either we're running out of data or the number of requested results has been found.\r\n\r\nThat said maybe EQL could fit into its own bucket in terms of expense in comparison to other searches. With async_search more slow searches will be executed and there has been consideration that these need some sort of prioritization, see #37867 and there is a mention of EQL by the security team as well.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680238676","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680238676","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680238676,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDIzODY3Ng==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2020-08-25T19:57:36Z","updated_at":"2020-08-25T19:57:36Z","author_association":"MEMBER","body":"Regarding the management thread, we are indeed pulling field capabilities, and then we perform potentially CPU-intensive operation by analyzing pulled fields and formulating search requests and sending them back to the server. It is not blocking. (It also seems that analysis of EQL is less CPU intensive than SQL).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680762013","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680762013","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680762013,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDc2MjAxMw==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2020-08-26T09:16:09Z","updated_at":"2020-08-26T09:16:09Z","author_association":"MEMBER","body":"It sounds like steps 1 and 3 are okay in terms of execution. With a future move to async search, using our own thread-pool for actual search queries might be even less of an issue.\r\nThat leaves the use of `management` thread which is used to return the data from field caps and then is used to assemble the actual query. \r\nIn case of large mappings this might be problematic though considering no IO is done it's still quite fast (less than 10 ms I would say) even on large mappings which put more pressure on memory instead of CPU.\r\nHowever moving that to a different thread pool (`generic`?) seems excessive...","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/680921111","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-680921111","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":680921111,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MDkyMTExMQ==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2020-08-26T14:38:09Z","updated_at":"2020-08-26T14:38:09Z","author_association":"MEMBER","body":">  However moving that to a different thread pool (generic?) seems excessive...\r\n\r\n+1. Moving to a different thread just adds more overhead and we should strive to process this quick and free the memory up sooner rather than later if it is going to add memory pressure.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/681871391","html_url":"https://github.com/elastic/elasticsearch/issues/59708#issuecomment-681871391","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59708","id":681871391,"node_id":"MDEyOklzc3VlQ29tbWVudDY4MTg3MTM5MQ==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2020-08-27T10:44:18Z","updated_at":"2020-08-27T10:44:18Z","author_association":"MEMBER","body":"Sounds to me like the current situation is acceptable hence why I'm closing this ticket.\r\nIf somehow this is not the case, @jaymode or @imotov please open it up again.\r\n\r\nThanks,","performed_via_github_app":null}]