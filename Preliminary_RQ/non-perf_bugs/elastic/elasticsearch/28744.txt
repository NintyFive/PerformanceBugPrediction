{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28744","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28744/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28744/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28744/events","html_url":"https://github.com/elastic/elasticsearch/issues/28744","id":298572561,"node_id":"MDU6SXNzdWUyOTg1NzI1NjE=","number":28744,"title":"geo_shape query on geo_shape field of type point with points_only set to true does not work in 6.x","user":{"login":"znanev","id":20048364,"node_id":"MDQ6VXNlcjIwMDQ4MzY0","avatar_url":"https://avatars2.githubusercontent.com/u/20048364?v=4","gravatar_id":"","url":"https://api.github.com/users/znanev","html_url":"https://github.com/znanev","followers_url":"https://api.github.com/users/znanev/followers","following_url":"https://api.github.com/users/znanev/following{/other_user}","gists_url":"https://api.github.com/users/znanev/gists{/gist_id}","starred_url":"https://api.github.com/users/znanev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/znanev/subscriptions","organizations_url":"https://api.github.com/users/znanev/orgs","repos_url":"https://api.github.com/users/znanev/repos","events_url":"https://api.github.com/users/znanev/events{/privacy}","received_events_url":"https://api.github.com/users/znanev/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":821037897,"node_id":"MDU6TGFiZWw4MjEwMzc4OTc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.2.1","name":"v6.2.1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-02-20T12:15:25Z","updated_at":"2018-02-23T02:58:17Z","closed_at":"2018-02-23T02:58:17Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.2.1, Build: 7299dc3/2018-02-07T19:34:26.990113Z, JVM: 1.8.0_161\r\n\r\n**Plugins installed**: None\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_161\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_161-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux node1 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\ngeo_shape query on geo_shape field of type point with points_only set to true does not work anymore in 6.x. It was working correctly in 5.x. By not working I mean when querying for points contained within a geo_shape (envelope, polygon etc.), no hits are returned. When points_only: true is removed from mapping, the queries work as expected, returning the points contained within the specified geo_shape.\r\n\r\n**Steps to reproduce**:\r\n\r\nBasically using the examples in https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-geo-shape-query.html. The only difference is specifying points_only: true in the location field, as shown below:\r\n\r\n1. Create an index to store some points:\r\n```\r\nPUT /example\r\n{\r\n    \"mappings\": {\r\n        \"_doc\": {\r\n            \"properties\": {\r\n                \"location\": {\r\n                    \"type\": \"geo_shape\",\r\n                    \"points_only\": true\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n2. Store a point\r\n```\r\nPOST /example/_doc?refresh\r\n{\r\n    \"name\": \"Wind & Wetter, Berlin, Germany\",\r\n    \"location\": {\r\n        \"type\": \"point\",\r\n        \"coordinates\": [13.400544, 52.530286]\r\n    }\r\n}\r\n```\r\n3. The following query should find the point using the Elasticsearchâ€™s envelope GeoJSON extension:\r\n```\r\nGET /example/_search\r\n{\r\n    \"query\":{\r\n        \"bool\": {\r\n            \"must\": {\r\n                \"match_all\": {}\r\n            },\r\n            \"filter\": {\r\n                \"geo_shape\": {\r\n                    \"location\": {\r\n                        \"shape\": {\r\n                            \"type\": \"envelope\",\r\n                            \"coordinates\" : [[13.0, 53.0], [14.0, 52.0]]\r\n                        },\r\n                        \"relation\": \"within\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nBut in fact it returns no hits:\r\n```\r\n{\r\n   \"took\": 0,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"skipped\": 0,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 0,\r\n      \"max_score\": null,\r\n      \"hits\": []\r\n   }\r\n}\r\n```\r\n\r\nIf you delete the example index and create it without specifying points_only: true, as follows:\r\n\r\n```\r\nPUT /example\r\n{\r\n    \"mappings\": {\r\n        \"_doc\": {\r\n            \"properties\": {\r\n                \"location\": {\r\n                    \"type\": \"geo_shape\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\nand repeat steps 2 and 3 above, the query will return the point, as expected:\r\n\r\n```\r\n{\r\n   \"took\": 0,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 1,\r\n      \"successful\": 1,\r\n      \"skipped\": 0,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 1,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"example\",\r\n            \"_type\": \"_doc\",\r\n            \"_id\": \"SZods2EBpb50aY-UDsK9\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"name\": \"Wind & Wetter, Berlin, Germany\",\r\n               \"location\": {\r\n                  \"type\": \"point\",\r\n                  \"coordinates\": [\r\n                     13.400544,\r\n                     52.530286\r\n                  ]\r\n               }\r\n            }\r\n         }\r\n      ]\r\n   }\r\n}\r\n```","closed_by":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"performed_via_github_app":null}