{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15413","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15413/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15413/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15413/events","html_url":"https://github.com/elastic/elasticsearch/issues/15413","id":121961262,"node_id":"MDU6SXNzdWUxMjE5NjEyNjI=","number":15413,"title":"grandchildren aggregation broken in ES 2.0?","user":{"login":"chintan-shah-25","id":6856646,"node_id":"MDQ6VXNlcjY4NTY2NDY=","avatar_url":"https://avatars0.githubusercontent.com/u/6856646?v=4","gravatar_id":"","url":"https://api.github.com/users/chintan-shah-25","html_url":"https://github.com/chintan-shah-25","followers_url":"https://api.github.com/users/chintan-shah-25/followers","following_url":"https://api.github.com/users/chintan-shah-25/following{/other_user}","gists_url":"https://api.github.com/users/chintan-shah-25/gists{/gist_id}","starred_url":"https://api.github.com/users/chintan-shah-25/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chintan-shah-25/subscriptions","organizations_url":"https://api.github.com/users/chintan-shah-25/orgs","repos_url":"https://api.github.com/users/chintan-shah-25/repos","events_url":"https://api.github.com/users/chintan-shah-25/events{/privacy}","received_events_url":"https://api.github.com/users/chintan-shah-25/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2015-12-14T02:06:24Z","updated_at":"2018-02-14T13:28:41Z","closed_at":"2015-12-16T09:30:51Z","author_association":"NONE","active_lock_reason":null,"body":"I am looking into this [SO question](http://stackoverflow.com/questions/34222753/elasticsearch-deep-children-aggregation-with-sum-metric-returning-empty-re), I am also facing something similar in my own project after I upgraded from 1.7 to 2.0. **children aggregation** gives weird results.\n\nI created test index like this\n\n```\nPOST companies\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0\n  },\n  \"mappings\": {\n    \"category\": {\n      \"properties\": {\n        \"id\": {\n          \"type\": \"string\"\n        },\n        \"title\": {\n          \"type\": \"string\"\n        }\n      }\n    },\n    \"subcategory\": {\n      \"_parent\": {\n        \"type\": \"category\"\n      },\n      \"properties\": {\n        \"id\": {\n          \"type\": \"string\"\n        },\n        \"title\": {\n          \"type\": \"string\"\n        }\n      }\n    },\n    \"item\": {\n      \"_parent\": {\n        \"type\": \"subcategory\"\n      },\n      \"properties\": {\n        \"id\": {\n          \"type\": \"string\"\n        },\n        \"price\": {\n          \"type\": \"integer\"\n        }\n      }\n    }\n  }\n}\n```\n\nI indexed some documents\n\n```\nPUT companies/category/cat1\n{\n  \"id\" : \"cat1\",\n  \"title\" : \"t1\"\n}\n\nPUT companies/category/cat2\n{\n  \"id\" : \"cat2\",\n  \"title\" : \"t2\"\n}\n\nPUT companies/category/cat3\n{\n  \"id\" : \"cat3\",\n  \"title\" : \"t3\"\n}\n\nPUT companies/subcategory/sub1?parent=cat1\n{\n  \"id\" : \"sub1\",\n  \"title\" : \"st1\"\n}\n\nPUT companies/subcategory/sub2?parent=cat1\n{\n  \"id\" : \"sub2\",\n  \"title\" : \"st2\"\n}\n\nPUT companies/subcategory/sub3?parent=cat2\n{\n  \"id\" : \"sub3\",\n  \"title\" : \"st2\"\n}\n\nPUT companies/subcategory/sub4?parent=cat2\n{\n  \"id\" : \"sub4\",\n  \"title\" : \"st4\"\n}\n\nPUT companies/subcategory/sub5?parent=cat3\n{\n  \"id\" : \"sub5\",\n  \"title\" : \"st4\"\n}\n\nPUT companies/subcategory/sub6?parent=cat3\n{\n  \"id\" : \"sub6\",\n  \"title\" : \"st6\"\n}\n\nPUT companies/subcategory/sub7?parent=cat3\n{\n  \"id\" : \"sub7\",\n  \"title\" : \"st7\"\n}\n\nPUT companies/item/i1?parent=sub1&routing=cat1\n{\n  \"id\" : \"i1\",\n  \"price\" : 100\n}\n\nPUT companies/item/i2?parent=sub1&routing=cat1\n{\n  \"id\" : \"i2\",\n  \"price\" : 200\n}\n\nPUT companies/item/i3?parent=sub2&routing=cat1\n{\n  \"id\" : \"i3\",\n  \"price\" : 200\n}\n\nPUT companies/item/i4?parent=sub2&routing=cat1\n{\n  \"id\" : \"i4\",\n  \"price\" : 150\n}\n\nPUT companies/item/i5?parent=sub3&routing=cat2\n{\n  \"id\" : \"i5\",\n  \"price\" : 150\n}\n\nPUT companies/item/i6?parent=sub3&routing=cat2\n{\n  \"id\" : \"i6\",\n  \"price\" : 180\n}\n\nPUT companies/item/i7?parent=sub4&routing=cat2\n{\n  \"id\" : \"i7\",\n  \"price\" : 180\n}\n\nPUT companies/item/i8?parent=sub5&routing=cat3\n{\n  \"id\" : \"i8\",\n  \"price\" : 1180\n}\n\nPUT companies/item/i9?parent=sub6&routing=cat3\n{\n  \"id\" : \"i9\",\n  \"price\" : 11180\n}\n\nPUT companies/item/i10?parent=sub7&routing=cat3\n{\n  \"id\" : \"i10\",\n  \"price\" : 180\n}\n\nPUT companies/item/i11?parent=sub7&routing=cat3\n{\n  \"id\" : \"i11\",\n  \"price\" : 150\n}\n\nPUT companies/item/i12?parent=sub7&routing=cat3\n{\n  \"id\" : \"i12\",\n  \"price\" : 210\n}\n\n```\n\nThis is the aggregation query\n\n```\nGET companies/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"subcategory\",\n      \"query\": {\n        \"has_child\": {\n          \"type\": \"item\",\n          \"query\": {\n            \"range\": {\n              \"price\": {\n                \"gte\": 100,\n                \"lte\": 250\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"aggs\": {\n    \"categories\": {\n      \"terms\": {\n        \"field\": \"id\"\n      },\n      \"aggs\": {\n        \"sub_categories\": {\n          \"children\": {\n            \"type\": \"subcategory\"\n          },\n          \"aggs\": {\n            \"sub_category_ids\": {\n              \"terms\": {\n                \"field\": \"id\"\n              },\n              \"aggs\": {\n                \"items\": {\n                  \"children\": {\n                    \"type\": \"item\"\n                  },\n                  \"aggs\": {\n                    \"price\": {\n                      \"sum\": {\n                        \"field\": \"price\"\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0\n}\n```\n\nResults for ES 1.7\n\n```\n{\n   \"took\": 189,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 1,\n      \"successful\": 1,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 3,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"categories\": {\n         \"doc_count_error_upper_bound\": 0,\n         \"sum_other_doc_count\": 0,\n         \"buckets\": [\n            {\n               \"key\": \"cat1\",\n               \"doc_count\": 1,\n               \"sub_categories\": {\n                  \"doc_count\": 2,\n                  \"sub_category_ids\": {\n                     \"doc_count_error_upper_bound\": 0,\n                     \"sum_other_doc_count\": 0,\n                     \"buckets\": [\n                        {\n                           \"key\": \"sub1\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 2,\n                              \"price\": {\n                                 \"value\": 300\n                              }\n                           }\n                        },\n                        {\n                           \"key\": \"sub2\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 2,\n                              \"price\": {\n                                 \"value\": 350\n                              }\n                           }\n                        }\n                     ]\n                  }\n               }\n            },\n            {\n               \"key\": \"cat2\",\n               \"doc_count\": 1,\n               \"sub_categories\": {\n                  \"doc_count\": 2,\n                  \"sub_category_ids\": {\n                     \"doc_count_error_upper_bound\": 0,\n                     \"sum_other_doc_count\": 0,\n                     \"buckets\": [\n                        {\n                           \"key\": \"sub3\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 2,\n                              \"price\": {\n                                 \"value\": 330\n                              }\n                           }\n                        },\n                        {\n                           \"key\": \"sub4\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 1,\n                              \"price\": {\n                                 \"value\": 180\n                              }\n                           }\n                        }\n                     ]\n                  }\n               }\n            },\n            {\n               \"key\": \"cat3\",\n               \"doc_count\": 1,\n               \"sub_categories\": {\n                  \"doc_count\": 3,\n                  \"sub_category_ids\": {\n                     \"doc_count_error_upper_bound\": 0,\n                     \"sum_other_doc_count\": 0,\n                     \"buckets\": [\n                        {\n                           \"key\": \"sub5\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 1,\n                              \"price\": {\n                                 \"value\": 1180\n                              }\n                           }\n                        },\n                        {\n                           \"key\": \"sub6\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 1,\n                              \"price\": {\n                                 \"value\": 11180\n                              }\n                           }\n                        },\n                        {\n                           \"key\": \"sub7\",\n                           \"doc_count\": 1,\n                           \"items\": {\n                              \"doc_count\": 3,\n                              \"price\": {\n                                 \"value\": 540\n                              }\n                           }\n                        }\n                     ]\n                  }\n               }\n            }\n         ]\n      }\n   }\n}\n```\n\nResult for ES 2.0\n\n```\n{\n  \"took\": 24,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 1,\n    \"successful\": 1,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 3,\n    \"max_score\": 1,\n    \"hits\": [\n      {\n        \"_index\": \"companies\",\n        \"_type\": \"category\",\n        \"_id\": \"cat1\",\n        \"_score\": 1,\n        \"_source\": {\n          \"id\": \"cat1\",\n          \"title\": \"t1\"\n        }\n      },\n      {\n        \"_index\": \"companies\",\n        \"_type\": \"category\",\n        \"_id\": \"cat2\",\n        \"_score\": 1,\n        \"_source\": {\n          \"id\": \"cat2\",\n          \"title\": \"t2\"\n        }\n      },\n      {\n        \"_index\": \"companies\",\n        \"_type\": \"category\",\n        \"_id\": \"cat3\",\n        \"_score\": 1,\n        \"_source\": {\n          \"id\": \"cat3\",\n          \"title\": \"t3\"\n        }\n      }\n    ]\n  },\n  \"aggregations\": {\n    \"categories\": {\n      \"doc_count_error_upper_bound\": 0,\n      \"sum_other_doc_count\": 0,\n      \"buckets\": [\n        {\n          \"key\": \"cat1\",\n          \"doc_count\": 1,\n          \"sub_categories\": {\n            \"doc_count\": 2,\n            \"sub_category_ids\": {\n              \"doc_count_error_upper_bound\": 0,\n              \"sum_other_doc_count\": 0,\n              \"buckets\": [\n                {\n                  \"key\": \"sub1\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 0,\n                    \"price\": {\n                      \"value\": 0\n                    }\n                  }\n                },\n                {\n                  \"key\": \"sub2\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 0,\n                    \"price\": {\n                      \"value\": 0\n                    }\n                  }\n                }\n              ]\n            }\n          }\n        },\n        {\n          \"key\": \"cat2\",\n          \"doc_count\": 1,\n          \"sub_categories\": {\n            \"doc_count\": 2,\n            \"sub_category_ids\": {\n              \"doc_count_error_upper_bound\": 0,\n              \"sum_other_doc_count\": 0,\n              \"buckets\": [\n                {\n                  \"key\": \"sub3\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 0,\n                    \"price\": {\n                      \"value\": 0\n                    }\n                  }\n                },\n                {\n                  \"key\": \"sub4\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 0,\n                    \"price\": {\n                      \"value\": 0\n                    }\n                  }\n                }\n              ]\n            }\n          }\n        },\n        {\n          \"key\": \"cat3\",\n          \"doc_count\": 1,\n          \"sub_categories\": {\n            \"doc_count\": 3,\n            \"sub_category_ids\": {\n              \"doc_count_error_upper_bound\": 0,\n              \"sum_other_doc_count\": 0,\n              \"buckets\": [\n                {\n                  \"key\": \"sub5\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 1,\n                    \"price\": {\n                      \"value\": 1180\n                    }\n                  }\n                },\n                {\n                  \"key\": \"sub6\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 0,\n                    \"price\": {\n                      \"value\": 0\n                    }\n                  }\n                },\n                {\n                  \"key\": \"sub7\",\n                  \"doc_count\": 1,\n                  \"items\": {\n                    \"doc_count\": 0,\n                    \"price\": {\n                      \"value\": 0\n                    }\n                  }\n                }\n              ]\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nDid I miss something?\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}