{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16544","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16544/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16544/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16544/events","html_url":"https://github.com/elastic/elasticsearch/issues/16544","id":132469462,"node_id":"MDU6SXNzdWUxMzI0Njk0NjI=","number":16544,"title":"Getting Shard failures for a quoted string search query","user":{"login":"apanimesh061","id":3243029,"node_id":"MDQ6VXNlcjMyNDMwMjk=","avatar_url":"https://avatars2.githubusercontent.com/u/3243029?v=4","gravatar_id":"","url":"https://api.github.com/users/apanimesh061","html_url":"https://github.com/apanimesh061","followers_url":"https://api.github.com/users/apanimesh061/followers","following_url":"https://api.github.com/users/apanimesh061/following{/other_user}","gists_url":"https://api.github.com/users/apanimesh061/gists{/gist_id}","starred_url":"https://api.github.com/users/apanimesh061/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/apanimesh061/subscriptions","organizations_url":"https://api.github.com/users/apanimesh061/orgs","repos_url":"https://api.github.com/users/apanimesh061/repos","events_url":"https://api.github.com/users/apanimesh061/events{/privacy}","received_events_url":"https://api.github.com/users/apanimesh061/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-02-09T16:44:37Z","updated_at":"2016-02-29T08:43:50Z","closed_at":"2016-02-29T08:43:50Z","author_association":"NONE","active_lock_reason":null,"body":"I am using Elasticsearch 2.2.0.\n\nI have the following schema for the index:\n\n```\n{\n  \"settings\" : {\n    \"index.number_of_shards\" : 1,\n    \"index.similarity.default.type\": \"BM25\"\n  }\n}\n```\n\nI index 5 documents and I even test it in the code as follows:\n\n```\nClient testClient = client();\n.\n. // index the documents here\n.\nSearchResponse countResponse = testClient.prepareSearch(indexName)\n            .setTypes(\"post\").setSize(0).execute().actionGet();\nassertHitCount(countResponse, 5L); // this one passes which means all 5 documents were indexed\n\nString singleWord = \"Lorem\";\nString twoWords = \"Lorem ipsum\";\nString quotedPhrase = \"\\\"Lorem ipsum\\\"\";\n\nQueryStringQueryBuilder query = queryStringQuery(quotedPhrase);\nquery.useDisMax(true);\nquery.defaultOperator(QueryStringQueryBuilder.Operator.AND);\nquery.autoGeneratePhraseQueries(true);\nquery.field(\"content\", 1f);\n\nSearchRequestBuilder request = testClient.prepareSearch(indexName).setTypes(\"student\");\nrequest.setQuery(query);\nrequest.addField(\"*\");\nrequest.setExplain(true);\nSearchResponse response = request.execute().actionGet();\nassertHitCount(response, 1L);\n```\n\nI notice that the query for `quotedPhrase` results in the following errors arbitrarily:\n- Shard Failures\n\n```\nFailed to execute phase [query_fetch], all shards failed\n; shardFailures {[ppHLclgASbiK4nZBBjIYjg][default_index][0]: RemoteTransportException[[node_t1][local[2]][indices:data/read/search[phase/query+fetch]]]; nested: QueryPhaseExecutionException[Query Failed [Failed to execute main query]]; nested: AbstractMethodError[org.apache.lucene.search.TwoPhaseIterator.matchCost()F]; }\n```\n- No hits\n\n```\njava.lang.AssertionError: Hit count is 0 but 1 was expected.  Total shards: 9 Successful shards: 8 & 1 shard failures:\n```\n- Sometimes that test passes.\n\n**UPDATE**: This works in ES 2.1.1 but not in ES 2.2.0\n\nOther details:\n1. I am using `ESIntegTestCase`\n2. On the top of the class name I have `@ESIntegTestCase.ClusterScope(scope = ESIntegTestCase.Scope.TEST)`\n3. This test runs for `singleWord` and `twoWords`\n\nWhat could be the issue?\n\nI am attacking the stack trace as well:\n\n```\norg.elasticsearch.transport.RemoteTransportException: [node_t0][local[1]][indices:data/read/search[phase/query+fetch]]\norg.elasticsearch.search.query.QueryPhaseExecutionException: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:409) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:113) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:364) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:468) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [na:1.8.0_66]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_66]\n    at java.lang.Thread.run(Thread.java:745) [na:1.8.0_66]\nCaused by: java.lang.AbstractMethodError: org.apache.lucene.search.TwoPhaseIterator.matchCost()F\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhaseConjunctionDISI.<init>(ConjunctionDISI.java:186) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhaseConjunctionDISI.<init>(ConjunctionDISI.java:164) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhase.<init>(ConjunctionDISI.java:227) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhase.<init>(ConjunctionDISI.java:221) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI.intersect(ConjunctionDISI.java:50) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionScorer.<init>(ConjunctionScorer.java:41) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.BooleanWeight.req(BooleanWeight.java:403) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.BooleanWeight.scorer(BooleanWeight.java:326) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.Weight.bulkScorer(Weight.java:135) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.BooleanWeight.bulkScorer(BooleanWeight.java:262) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.AssertingWeight.bulkScorer(AssertingWeight.java:69) ~[lucene-test-framework-5.3.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.AssertingWeight.bulkScorer(AssertingWeight.java:69) ~[lucene-test-framework-5.3.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:818) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:535) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:384) ~[elasticsearch-2.2.0.jar:2.2.0]\n    ... 10 common frames omitted\n13:57:52.458 [elasticsearch[node_t0][search][T#3]] DEBUG action.search.type - [node_t0] All shards failed for phase: [query_fetch]\norg.elasticsearch.transport.RemoteTransportException: [node_t0][local[1]][indices:data/read/search[phase/query+fetch]]\norg.elasticsearch.search.query.QueryPhaseExecutionException: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:409) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:113) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:364) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:468) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-2.2.0.jar:2.2.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [na:1.8.0_66]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [na:1.8.0_66]\n    at java.lang.Thread.run(Thread.java:745) [na:1.8.0_66]\nCaused by: java.lang.AbstractMethodError: org.apache.lucene.search.TwoPhaseIterator.matchCost()F\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhaseConjunctionDISI.<init>(ConjunctionDISI.java:186) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhaseConjunctionDISI.<init>(ConjunctionDISI.java:164) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhase.<init>(ConjunctionDISI.java:227) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI$TwoPhase.<init>(ConjunctionDISI.java:221) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionDISI.intersect(ConjunctionDISI.java:50) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.ConjunctionScorer.<init>(ConjunctionScorer.java:41) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.BooleanWeight.req(BooleanWeight.java:403) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.BooleanWeight.scorer(BooleanWeight.java:326) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.Weight.bulkScorer(Weight.java:135) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.BooleanWeight.bulkScorer(BooleanWeight.java:262) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.AssertingWeight.bulkScorer(AssertingWeight.java:69) ~[lucene-test-framework-5.3.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.AssertingWeight.bulkScorer(AssertingWeight.java:69) ~[lucene-test-framework-5.3.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:818) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:535) ~[lucene-core-5.4.1.jar:5.4.1 1725212 - jpountz - 2016-01-18 11:44:59]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:384) ~[elasticsearch-2.2.0.jar:2.2.0]\n    ... 10 common frames omitted\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}