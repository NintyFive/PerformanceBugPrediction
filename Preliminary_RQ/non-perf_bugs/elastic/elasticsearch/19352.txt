{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19352","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19352/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19352/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19352/events","html_url":"https://github.com/elastic/elasticsearch/issues/19352","id":164722019,"node_id":"MDU6SXNzdWUxNjQ3MjIwMTk=","number":19352,"title":"TranslogCorruptedException while attempting to recover ES cluster (2.3.2)","user":{"login":"jaychris","id":5815008,"node_id":"MDQ6VXNlcjU4MTUwMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/5815008?v=4","gravatar_id":"","url":"https://api.github.com/users/jaychris","html_url":"https://github.com/jaychris","followers_url":"https://api.github.com/users/jaychris/followers","following_url":"https://api.github.com/users/jaychris/following{/other_user}","gists_url":"https://api.github.com/users/jaychris/gists{/gist_id}","starred_url":"https://api.github.com/users/jaychris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaychris/subscriptions","organizations_url":"https://api.github.com/users/jaychris/orgs","repos_url":"https://api.github.com/users/jaychris/repos","events_url":"https://api.github.com/users/jaychris/events{/privacy}","received_events_url":"https://api.github.com/users/jaychris/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-07-10T16:05:59Z","updated_at":"2018-02-13T20:32:20Z","closed_at":"2016-07-11T15:55:03Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.3.2\n\n**JVM version**: 8u29\n\n**OS version**: Ubuntu 16.10\n\n**Description of the problem including expected versus actual behavior**:\nAfter node failure, cluster fails to re-index with TranslogCorruptedException.\n\nWe have a 4-node cluster.  One of the nodes (cluster leader) failed due to a cpu failure.  The other 3 nodes were stopped while the failed node was fixed.  Once the node was fixed, the leader was brought back up and the other three nodes restarted.  Re-indexing begins, but two of the nodes start spitting out errors and the cluster fails to start/re-index.\n\nExpected Behavior:\nES will re-index and recover the cluster to \"green\" health.\n\nActual Behavior:\nSeveral nodes produce a stream of errors like:\n\n```\n[logstash-telemetry-2016.07.09][[logstash-telemetry-2016.07.09][3]] IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed\nto create engine]; nested: TranslogCorruptedException[expected shard UUID [[68 46 45 4e 49 38 4e 74 51 65 71 61 33 36 6b 66 33 47 6e 58 56 67]] but got: [[52 6a 6b 5f 50 59 4f\n46 54 6d 79 6a 4c 36 45 5a 61 76 33 51 4d 41]] this translog file belongs to a different translog];\n    at org.elasticsearch.index.shard.StoreRecoveryService.recoverFromStore(StoreRecoveryService.java:250)\n    at org.elasticsearch.index.shard.StoreRecoveryService.access$100(StoreRecoveryService.java:56)\n    at org.elasticsearch.index.shard.StoreRecoveryService$1.run(StoreRecoveryService.java:129)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n```\n\nand the cluster fails to recover.  The leader eventually reports a Java OOM exception, even though each node has more than enough heap for normal operations.\n\n**Steps to reproduce**:\nunsure.  The sequence of events was:\n1.  leader crashed due to hardware failure\n2.  other three nodes were stopped by hand (process, not system)\n3.  leader was recovered/restarted\n4.  other three nodes were started and joined the cluster\n5.  two nodes immediately began reporting TranslogCorruptedException\n6.  cluster continues to index, but eventually fails\n\n**Provide logs (if relevant)**:\n\nErrors are a repeating stream like this:\n\n```\n[logstash-telemetry-2016.07.09][[logstash-telemetry-2016.07.09][3]] IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed\nto create engine]; nested: TranslogCorruptedException[expected shard UUID [[68 46 45 4e 49 38 4e 74 51 65 71 61 33 36 6b 66 33 47 6e 58 56 67]] but got: [[52 6a 6b 5f 50 59 4f\n46 54 6d 79 6a 4c 36 45 5a 61 76 33 51 4d 41]] this translog file belongs to a different translog];\n    at org.elasticsearch.index.shard.StoreRecoveryService.recoverFromStore(StoreRecoveryService.java:250)\n    at org.elasticsearch.index.shard.StoreRecoveryService.access$100(StoreRecoveryService.java:56)\n    at org.elasticsearch.index.shard.StoreRecoveryService$1.run(StoreRecoveryService.java:129)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: [logstash-telemetry-2016.07.09][[logstash-telemetry-2016.07.09][3]] EngineCreationFailureException[failed to create engine]; nested: TranslogCorruptedException[expec\nted shard UUID [[68 46 45 4e 49 38 4e 74 51 65 71 61 33 36 6b 66 33 47 6e 58 56 67]] but got: [[52 6a 6b 5f 50 59 4f 46 54 6d 79 6a 4c 36 45 5a 61 76 33 51 4d 41]] this translo\ng file belongs to a different translog];\n    at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:155)\n    at org.elasticsearch.index.engine.InternalEngineFactory.newReadWriteEngine(InternalEngineFactory.java:25)\n    at org.elasticsearch.index.shard.IndexShard.newEngine(IndexShard.java:1509)\n    at org.elasticsearch.index.shard.IndexShard.createNewEngine(IndexShard.java:1493)\n    at org.elasticsearch.index.shard.IndexShard.internalPerformTranslogRecovery(IndexShard.java:966)\n    at org.elasticsearch.index.shard.IndexShard.performTranslogRecovery(IndexShard.java:938)\n    at org.elasticsearch.index.shard.StoreRecoveryService.recoverFromStore(StoreRecoveryService.java:241)\n    ... 5 more\nCaused by: TranslogCorruptedException[expected shard UUID [[68 46 45 4e 49 38 4e 74 51 65 71 61 33 36 6b 66 33 47 6e 58 56 67]] but got: [[52 6a 6b 5f 50 59 4f 46 54 6d 79 6a 4\nc 36 45 5a 61 76 33 51 4d 41]] this translog file belongs to a different translog]\n    at org.elasticsearch.index.translog.TranslogReader.open(TranslogReader.java:235)\n```\n","closed_by":{"login":"jaychris","id":5815008,"node_id":"MDQ6VXNlcjU4MTUwMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/5815008?v=4","gravatar_id":"","url":"https://api.github.com/users/jaychris","html_url":"https://github.com/jaychris","followers_url":"https://api.github.com/users/jaychris/followers","following_url":"https://api.github.com/users/jaychris/following{/other_user}","gists_url":"https://api.github.com/users/jaychris/gists{/gist_id}","starred_url":"https://api.github.com/users/jaychris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaychris/subscriptions","organizations_url":"https://api.github.com/users/jaychris/orgs","repos_url":"https://api.github.com/users/jaychris/repos","events_url":"https://api.github.com/users/jaychris/events{/privacy}","received_events_url":"https://api.github.com/users/jaychris/received_events","type":"User","site_admin":false},"performed_via_github_app":null}