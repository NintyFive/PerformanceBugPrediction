{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33322","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33322/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33322/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33322/events","html_url":"https://github.com/elastic/elasticsearch/issues/33322","id":356103778,"node_id":"MDU6SXNzdWUzNTYxMDM3Nzg=","number":33322,"title":"bulk upsert is not working correctly","user":{"login":"skumar4120","id":5290704,"node_id":"MDQ6VXNlcjUyOTA3MDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/5290704?v=4","gravatar_id":"","url":"https://api.github.com/users/skumar4120","html_url":"https://github.com/skumar4120","followers_url":"https://api.github.com/users/skumar4120/followers","following_url":"https://api.github.com/users/skumar4120/following{/other_user}","gists_url":"https://api.github.com/users/skumar4120/gists{/gist_id}","starred_url":"https://api.github.com/users/skumar4120/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/skumar4120/subscriptions","organizations_url":"https://api.github.com/users/skumar4120/orgs","repos_url":"https://api.github.com/users/skumar4120/repos","events_url":"https://api.github.com/users/skumar4120/events{/privacy}","received_events_url":"https://api.github.com/users/skumar4120/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-08-31T19:46:34Z","updated_at":"2018-09-24T15:00:09Z","closed_at":"2018-09-24T15:00:09Z","author_association":"NONE","active_lock_reason":null,"body":"I am doing bulk upsert in the ES index and this is deleting the old document and creating new document for the given record\r\n\r\nFunction to create bulk update satements:\r\n\r\nasync function toBulk(data: any, index: string, action: string, body: any) {\r\n    if (index === process.env.ES_INDEX) {\r\n        body.push({\r\n            update: {\r\n                '_index': process.env.ES_INDEX,\r\n                '_type': process.env.ES_TYPE,\r\n                '_id': data.nwVehicleId,\r\n                'retry_on_conflict': 25\r\n            }\r\n        });\r\n    } else {\r\n        body.push({\r\n            update: {\r\n                '_index': process.env.LBES_INDEX,\r\n                '_type': process.env.LBES_TYPE,\r\n                '_id': data.nwLiveblockEventId,\r\n                'retry_on_conflict': 25\r\n            }\r\n        });\r\n    }\r\n    switch (action) {\r\n        case 'update':\r\n            body.push({\r\n                'doc': data,\r\n                'doc_as_upsert': true\r\n            });\r\n            break;\r\n        case 'get_update':\r\n            const lbInfo = await client.get({\r\n                'index': process.env.LBES_INDEX,\r\n                'type': process.env.LBES_TYPE,\r\n                'id': data.nwLiveblockEventId\r\n            });\r\n            body.push({\r\n                'doc': lbInfo._source,\r\n                'doc_as_upsert': true\r\n            });\r\n            log('Merged_ES Live Block event', lbInfo);\r\n            break;\r\n        default:\r\n    }\r\n}\r\n\r\nInput record:\r\n\"data\":{\"nwVehicleId\":\"5C8650DD-8133-4F64-AC57-4ABD21775A05\",\"originVehicleId\":\"402384270\",\"vin\":\"3GTP2WE78CG271115\",\"make\":\"GMC\",\"model\":\"Sierra 1500\",\"year\":2012,\"series\":\"SLT\",\"bodyStyle\":\"4WD CREW CAB 143.5\\\"\",\"trim\":\"\",\"odometer\":66456,\"odometerUnitOfMeasure\":\"MI\",\"exteriorColor\":\"Blue\",\"interiorColor\":\"Blue\",\"carGroupConfigName\":\"DLRAVE1- Dealer Avenue 1000 ADESA\",\"originCarGroupConfigId\":\"886\",\"nwCarGroupConfigId\":\"\",\"vehicleStatus\":\"Auction\",\"vehicleSize\":\"\",\"vehicleType\":\"Retail\",\"assetType\":\"Car/Light Truck\",\"cylinders\":\"8\",\"displacement\":5.3,\"doors\":\"4\",\"driveTrain\":\"4WD\",\"emissionsStandard\":\"\",\"engineName\":\"8 CYLINDER FLEX-FUEL\",\"fuelType\":\"Flex Fuel\",\"headlightType\":\"\",\"inventoryType\":\"Retail\",\"roofColor\":\"\",\"speeds\":\"\",\"transmission\":\"Automatic\",\"turbo\":0,\"truck\":\"\",\"cylinderType\":\"\",\"originSellerOrganizationId\":\"249116\",\"nwSellerOrganizationId\":\"1E3B71C5-F662-4A20-B107-493E7CF5A7FE\",\"sellerOrganizationName\":\"PAR NORTH AMERICA\",\"countryName\":\"United States\",\"sellerModelCode\":\"TK10543\",\"sellerAuctionAccessId\":\"5999998\",\"locationCity\":\"BARNHART\",\"stateAbbreviation\":\"MO\",\"systemUuid\":\"6286E116-4D78-4CDF-9CF9-1D118A832036\",\"systemOrigin\":\"classic\",\"systemWhenCreated\":1535744120131,\"systemTopic\":\"nw-inventory-develop\",\"systemTopicKey\":\"5C8650DD-8133-4F64-AC57-4ABD21775A05\",\"systemEvent\":\"vehicle_updated_inventory\",\"originTimestamp\":1535744114000,\"originCreatedBy\":\"ADAPPL\",\"originModifiedBy\":\"\",\"viewAccessGroupList\":[1,297,296],\"isCarGroupRunlistEnabled\":false,\"isAllowProcessingAuction\":true,\"isActive\":true,\"registrationProvince\":\"\",\"warrantyStartDate\":0,\"displayEmissionCompliance\":false,\"msrp\":\"\",\"epaStickers\":\"\",\"titleStatus\":\"\",\"odometerDigits\":\"6\",\"openRecall\":\"\",\"sellerVehicleCode\":\"14295\",\"processingLocation\":\"ADESA St.Louis\",\"listingCategory\":\"Enhanced\",\"isDealerblock\":false,\"isRunlist\":false,\"isLiveblock\":false,\"address\":\"7858 HIGHWAY 61-67\",\"zipcode\":\"63012\",\"origYear\":2012,\"origMake\":\"GMC\",\"origModel\":\"SIERRA 1500\",\"origExteriorcolor\":\"BLUE\",\"origInteriorcolor\":\"BLUE\",\"origOdometer\":66456,\"origDrivetrain\":\"4WD\",\"origProcessinglocation\":\"ADESA St. Louis\",\"origEnginename\":\"5.3L 8CYL FLEX FUEL CAPAB\",\"bodyType\":\"\"}\r\n\r\nOutput expexted is to do upsert whne the document is present but however the old document is deleted in elasticsearch and new document is created which is not the required functionality.\r\n\r\nJSon.stringify version of the bulk upsert statements created for ES indexing:\r\n\r\n{\"timestamp\":\"2018-08-31T19:35:23.597Z\",\"lambdaContext\":{\"functionName\":\"nwSearch-testdev-putIndex-f3d26e02df\",\"awsRequestId\":\"ce4adbf0-7770-46dc-bb42-a8a7972f142f\"},\"service\":\"nwSearch\",\"severity\":\"CONSOLE.LOG\",\"message\":{\"text\":\"Successfully indexed 2 out of 2 events [{\\\"update\\\":{\\\"_index\\\":\\\"nwsearchindex\\\",\\\"_type\\\":\\\"nwsearchtype\\\",\\\"_id\\\":\\\"5C8650DD-8133-4F64-AC57-4ABD21775A05\\\",\\\"retry_on_conflict\\\":25}},{\\\"doc\\\":{\\\"nwVehicleId\\\":\\\"5C8650DD-8133-4F64-AC57-4ABD21775A05\\\",\\\"originVehicleId\\\":\\\"402384270\\\",\\\"vin\\\":\\\"3GTP2WE78CG271115\\\",\\\"make\\\":\\\"GMC\\\",\\\"model\\\":\\\"Sierra 1500\\\",\\\"year\\\":2012,\\\"series\\\":\\\"SLT\\\",\\\"bodyStyle\\\":\\\"4WD CREW CAB 143.5\\\\\\\"\\\",\\\"trim\\\":\\\"\\\",\\\"odometer\\\":66456,\\\"odometerUnitOfMeasure\\\":\\\"MI\\\",\\\"exteriorColor\\\":\\\"Blue\\\",\\\"interiorColor\\\":\\\"Blue\\\",\\\"carGroupConfigName\\\":\\\"DLRAVE1- Dealer Avenue 1000 ADESA\\\",\\\"originCarGroupConfigId\\\":\\\"886\\\",\\\"nwCarGroupConfigId\\\":\\\"\\\",\\\"vehicleStatus\\\":\\\"Auction\\\",\\\"vehicleSize\\\":\\\"\\\",\\\"vehicleType\\\":\\\"Retail\\\",\\\"assetType\\\":\\\"Car/Light Truck\\\",\\\"cylinders\\\":\\\"8\\\",\\\"displacement\\\":5.3,\\\"doors\\\":\\\"4\\\",\\\"driveTrain\\\":\\\"4WD\\\",\\\"emissionsStandard\\\":\\\"\\\",\\\"engineName\\\":\\\"8 CYLINDER FLEX-FUEL\\\",\\\"fuelType\\\":\\\"Flex Fuel\\\",\\\"headlightType\\\":\\\"\\\",\\\"inventoryType\\\":\\\"Retail\\\",\\\"roofColor\\\":\\\"\\\",\\\"speeds\\\":\\\"\\\",\\\"transmission\\\":\\\"Automatic\\\",\\\"turbo\\\":0,\\\"truck\\\":\\\"\\\",\\\"cylinderType\\\":\\\"\\\",\\\"originSellerOrganizationId\\\":\\\"249116\\\",\\\"nwSellerOrganizationId\\\":\\\"1E3B71C5-F662-4A20-B107-493E7CF5A7FE\\\",\\\"sellerOrganizationName\\\":\\\"PAR NORTH AMERICA\\\",\\\"countryName\\\":\\\"United States\\\",\\\"sellerModelCode\\\":\\\"TK10543\\\",\\\"sellerAuctionAccessId\\\":\\\"5999998\\\",\\\"locationCity\\\":\\\"BARNHART\\\",\\\"stateAbbreviation\\\":\\\"MO\\\",\\\"systemUuid\\\":\\\"6286E116-4D78-4CDF-9CF9-1D118A832036\\\",\\\"systemOrigin\\\":\\\"classic\\\",\\\"systemWhenCreated\\\":1535744120131,\\\"systemTopic\\\":\\\"nw-inventory-develop\\\",\\\"systemTopicKey\\\":\\\"5C8650DD-8133-4F64-AC57-4ABD21775A05\\\",\\\"systemEvent\\\":\\\"vehicle_updated_inventory\\\",\\\"originTimestamp\\\":1535744114000,\\\"originCreatedBy\\\":\\\"ADAPPL\\\",\\\"originModifiedBy\\\":\\\"\\\",\\\"viewAccessGroupList\\\":[1,297,296],\\\"isCarGroupRunlistEnabled\\\":false,\\\"isAllowProcessingAuction\\\":true,\\\"isActive\\\":true,\\\"registrationProvince\\\":\\\"\\\",\\\"warrantyStartDate\\\":0,\\\"displayEmissionCompliance\\\":false,\\\"msrp\\\":\\\"\\\",\\\"epaStickers\\\":\\\"\\\",\\\"titleStatus\\\":\\\"\\\",\\\"odometerDigits\\\":\\\"6\\\",\\\"openRecall\\\":\\\"\\\",\\\"sellerVehicleCode\\\":\\\"14295\\\",\\\"processingLocation\\\":\\\"ADESA St.Louis\\\",\\\"listingCategory\\\":\\\"Enhanced\\\",\\\"isDealerblock\\\":false,\\\"isRunlist\\\":false,\\\"isLiveblock\\\":false,\\\"address\\\":\\\"7858 HIGHWAY 61-67\\\",\\\"zipcode\\\":\\\"63012\\\",\\\"origYear\\\":2012,\\\"origMake\\\":\\\"GMC\\\",\\\"origModel\\\":\\\"SIERRA 1500\\\",\\\"origExteriorcolor\\\":\\\"BLUE\\\",\\\"origInteriorcolor\\\":\\\"BLUE\\\",\\\"origOdometer\\\":66456,\\\"origDrivetrain\\\":\\\"4WD\\\",\\\"origProcessinglocation\\\":\\\"ADESA St. Louis\\\",\\\"origEnginename\\\":\\\"5.3L 8CYL FLEX FUEL CAPAB\\\",\\\"bodyType\\\":\\\"\\\"},\\\"doc_as_upsert\\\":true},{\\\"update\\\":{\\\"_index\\\":\\\"nwsearchindex\\\",\\\"_type\\\":\\\"nwsearchtype\\\",\\\"_id\\\":\\\"5C8650DD-8133-4F64-AC57-4ABD21775A05\\\",\\\"retry_on_conflict\\\":25}},{\\\"doc\\\":{\\\"originAuctionId\\\":\\\"154062739\\\",\\\"nwAuctionId\\\":\\\"7655F783-E95F-4ACF-BCF8-F17FA6F1200F\\\",\\\"originVehicleId\\\":\\\"402384270\\\",\\\"nwVehicleId\\\":\\\"5C8650DD-8133-4F64-AC57-4ABD21775A05\\\",\\\"openTimestamp\\\":1535744107000,\\\"auctionStartTime\\\":1535734800000,\\\"auctionEndTime\\\":1536091200000,\\\"closeTimestamp\\\":0,\\\"resolveTime\\\":1536102000000,\\\"startPrice\\\":7500,\\\"reservePrice\\\":8500,\\\"buyNowPrice\\\":9500,\\\"bidIncrement\\\":100,\\\"iteration\\\":1,\\\"systemUuid\\\":\\\"60EA5F81-46FC-4690-BA99-5F821F01D925\\\",\\\"systemOrigin\\\":\\\"classic\\\",\\\"systemWhenCreated\\\":1535744120139,\\\"systemTopic\\\":\\\"nw-auction-develop\\\",\\\"systemTopicKey\\\":\\\"5C8650DD-8133-4F64-AC57-4ABD21775A05\\\",\\\"systemEvent\\\":\\\"db_auction_started\\\",\\\"originTimestamp\\\":1535744114000,\\\"originCreatedBy\\\":\\\"ADAPPL\\\",\\\"originModifiedBy\\\":\\\"529715\\\",\\\"viewAccessGroupList\\\":[1,297,296],\\\"bidAccessGroupList\\\":\\\"1,297,296\\\",\\\"bestOfferAccessGroupList\\\":\\\"\\\",\\\"buyAccessGroupList\\\":\\\"1,297,296\\\",\\\"buyDisappearLimitType\\\":\\\"Fixed Amount\\\",\\\"buyDisappearLimit\\\":0,\\\"previewStartTime\\\":0,\\\"previewType\\\":\\\"\\\",\\\"isDealerBlockSearchable\\\":true},\\\"doc_as_upsert\\\":true}]\"}}\r\n\r\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}