{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6301","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6301/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6301/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6301/events","html_url":"https://github.com/elastic/elasticsearch/issues/6301","id":34196139,"node_id":"MDU6SXNzdWUzNDE5NjEzOQ==","number":6301,"title":"Routing + filter aggregation + extended_bounds = ReduceSearchPhaseException (503)","user":{"login":"lafave","id":697613,"node_id":"MDQ6VXNlcjY5NzYxMw==","avatar_url":"https://avatars1.githubusercontent.com/u/697613?v=4","gravatar_id":"","url":"https://api.github.com/users/lafave","html_url":"https://github.com/lafave","followers_url":"https://api.github.com/users/lafave/followers","following_url":"https://api.github.com/users/lafave/following{/other_user}","gists_url":"https://api.github.com/users/lafave/gists{/gist_id}","starred_url":"https://api.github.com/users/lafave/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lafave/subscriptions","organizations_url":"https://api.github.com/users/lafave/orgs","repos_url":"https://api.github.com/users/lafave/repos","events_url":"https://api.github.com/users/lafave/events{/privacy}","received_events_url":"https://api.github.com/users/lafave/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2014-05-23T17:41:06Z","updated_at":"2014-07-24T14:31:38Z","closed_at":"2014-07-24T14:31:38Z","author_association":"NONE","active_lock_reason":null,"body":"#### Description\n\nI'm using a date histogram aggregation (with the extended bounds option) nested inside of a filter aggregation along with routing. Here are the combinations that work:\n- `!routing, filter, extended_bounds`\n- `routing, !filter, extended_bounds`\n- `routing, filter, !extended_bounds`\n\nCombining all three results in the following response from elasticsearch:\n\n```\n{\"error\":\"ReduceSearchPhaseException[Failed to execute phase [merge], [reduce] ]; nested: UnsupportedOperationException; \",\"status\":503}\n```\n\nand the following trace:\n\n```\n[2014-05-23 10:32:16,017][DEBUG][action.search.type       ] [Jumbo Carnation] failed to reduce search\norg.elasticsearch.action.search.ReduceSearchPhaseException: Failed to execute phase [merge], [reduce] \n    at org.elasticsearch.action.search.type.TransportSearchQueryAndFetchAction$AsyncAction.moveToSecondPhase(TransportSearchQueryAndFetchAction.java:79)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.innerMoveToSecondPhase(TransportSearchTypeAction.java:404)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAction.java:198)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onResult(TransportSearchTypeAction.java:174)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onResult(TransportSearchTypeAction.java:171)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:526)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:744)\nCaused by: java.lang.UnsupportedOperationException\n    at java.util.Collections$EmptyListIterator.add(Collections.java:3059)\n    at org.elasticsearch.search.aggregations.bucket.histogram.InternalHistogram.reduce(InternalHistogram.java:290)\n    at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:160)\n    at org.elasticsearch.search.aggregations.bucket.InternalSingleBucketAggregation.reduce(InternalSingleBucketAggregation.java:69)\n    at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:146)\n    at org.elasticsearch.search.controller.SearchPhaseController.merge(SearchPhaseController.java:545)\n    at org.elasticsearch.action.search.type.TransportSearchQueryAndFetchAction$AsyncAction.innerFinishHim(TransportSearchQueryAndFetchAction.java:89)\n    at org.elasticsearch.action.search.type.TransportSearchQueryAndFetchAction$AsyncAction.moveToSecondPhase(TransportSearchQueryAndFetchAction.java:77)\n    ... 8 more\n```\n#### Environment\n\nElasticsearch versions tested:\n- `Version: 1.1.1, Build: f1585f0/2014-04-16T14:27:12Z, JVM: 1.7.0_45`\n- `Version: 1.2.0, Build: c82387f/2014-05-22T12:49:13Z, JVM: 1.7.0_45`\n\nOperating system:\n\n```\nProductName:    Mac OS X\nProductVersion: 10.9.2\nBuildVersion:   13C64\n```\n#### Steps to reproduce\n\nCreate index:\n\n```\ncurl -XPUT localhost:9200/foo -d '\n{\n  \"mappings\": {\n    \"charges\": {\n      \"_routing\": {\n        \"require\": true,\n        \"path\": \"account_id\"\n      },\n      \"properties\": {\n        \"account_id\": {\n          \"type\": \"integer\"\n        },\n        \"amount\": {\n          \"type\": \"integer\"\n        },\n        \"created_at\": {\n          \"type\": \"date\"\n        }\n      }\n    }\n  }\n}'\n```\n\n```\n{\"acknowledged\":true}\n```\n\nQuery:\n\n```\ncurl -XGET localhost:9200/foo/charges/_search?routing=1 -d '\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"term\": {\n                \"account_id\": 1\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"aggs\": {\n    \"charges\": {\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"term\": {\n                \"_type\": \"charges\"\n              }\n            }\n          ]\n        }\n      },\n      \"aggs\": {\n        \"monthly_stats\": {\n          \"date_histogram\": {\n            \"field\": \"created_at\",\n            \"interval\": \"month\",\n            \"min_doc_count\": 0,\n            \"extended_bounds\": {\n              \"min\": \"2014-01-01\",\n              \"max\": \"2014-12-31\"\n            }\n          },\n          \"aggs\": {\n            \"revenue\": {\n              \"sum\": {\n                \"field\": \"amount\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n\n```\n{\"error\":\"ReduceSearchPhaseException[Failed to execute phase [merge], [reduce] ]; nested: UnsupportedOperationException; \",\"status\":503}\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}