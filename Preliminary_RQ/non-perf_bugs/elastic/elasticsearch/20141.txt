{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20141","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20141/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20141/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20141/events","html_url":"https://github.com/elastic/elasticsearch/issues/20141","id":172962242,"node_id":"MDU6SXNzdWUxNzI5NjIyNDI=","number":20141,"title":"random_sort on query with has_child eating insane amounts of memory in field data","user":{"login":"AndreCimander","id":1685335,"node_id":"MDQ6VXNlcjE2ODUzMzU=","avatar_url":"https://avatars3.githubusercontent.com/u/1685335?v=4","gravatar_id":"","url":"https://api.github.com/users/AndreCimander","html_url":"https://github.com/AndreCimander","followers_url":"https://api.github.com/users/AndreCimander/followers","following_url":"https://api.github.com/users/AndreCimander/following{/other_user}","gists_url":"https://api.github.com/users/AndreCimander/gists{/gist_id}","starred_url":"https://api.github.com/users/AndreCimander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AndreCimander/subscriptions","organizations_url":"https://api.github.com/users/AndreCimander/orgs","repos_url":"https://api.github.com/users/AndreCimander/repos","events_url":"https://api.github.com/users/AndreCimander/events{/privacy}","received_events_url":"https://api.github.com/users/AndreCimander/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-08-24T14:09:49Z","updated_at":"2016-08-24T14:14:38Z","closed_at":"2016-08-24T14:14:38Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:  2.3.4\n\n**Plugins installed**: [license, marvel, kibana, kopf, elastic-hq]\n\n**JVM version**: Java(TM) SE Runtime Environment (build 1.8.0_101-b13)\n\n**OS version**: Ubuntu 14.04 with kernel 4.2\n\n**Description of the problem including expected versus actual behavior**:\n\nHey everyone,\n\nfirst of all, thanks for this fine piece of software! :+1:\n\nI noticed extremely high memory usage and cache trashing in our elasticsearch cluster, after some digging I pinned it down to one random-sort query with a has_child filter. We currently have about 70 million parents with 1.3 billion children.\n\nApplying the query without the random_score function uses just a few GB of field data memory, using the random_sort skyrockets the field data memory usage to **60GB** per query, which is a little... _unsettling_. \n\nThe query:\n`\nGET /instagram-user/instagram-user/_search\n{\n   \"query\": {\n      \"function_score\": {\n         \"filter\": {\n            \"bool\": {\n               \"must_not\": [\n                  {\n                     \"exists\": {\n                        \"field\": \"calculated\"\n                     }\n                  }\n               ],\n               \"filter\": [\n                  {\n                     \"term\": {\n                        \"private\": false\n                     }\n                  },\n                  {\n                     \"has_child\": {\n                        \"query\": {\n                           \"bool\": {\n                              \"filter\": [\n                                 {\n                                    \"term\": {\n                                       \"instagram_user_id\": \"1397123079\"\n                                    }\n                                 }\n                              ]\n                           }\n                        },\n                        \"score_mode\": \"none\",\n                        \"type\": \"instagram-like\"\n                     }\n                  }\n               ]\n            }\n         },\n         \"functions\": [\n            {\n               \"random_score\": {\n                  \"seed\": 12345\n               }\n            }\n         ]\n      }\n   }\n}\n`\n\nI wonder if I missed some config parameter for the random_score, resulting in including all child documents and bloating the filter bitsets?\n\nHappy to supply additional logs.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}