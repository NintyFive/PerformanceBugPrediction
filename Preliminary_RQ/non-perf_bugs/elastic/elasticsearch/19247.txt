{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19247","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19247/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19247/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19247/events","html_url":"https://github.com/elastic/elasticsearch/issues/19247","id":163648322,"node_id":"MDU6SXNzdWUxNjM2NDgzMjI=","number":19247,"title":"Alias delete and addition silently fails occasionally","user":{"login":"smithsimonj","id":6840292,"node_id":"MDQ6VXNlcjY4NDAyOTI=","avatar_url":"https://avatars1.githubusercontent.com/u/6840292?v=4","gravatar_id":"","url":"https://api.github.com/users/smithsimonj","html_url":"https://github.com/smithsimonj","followers_url":"https://api.github.com/users/smithsimonj/followers","following_url":"https://api.github.com/users/smithsimonj/following{/other_user}","gists_url":"https://api.github.com/users/smithsimonj/gists{/gist_id}","starred_url":"https://api.github.com/users/smithsimonj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smithsimonj/subscriptions","organizations_url":"https://api.github.com/users/smithsimonj/orgs","repos_url":"https://api.github.com/users/smithsimonj/repos","events_url":"https://api.github.com/users/smithsimonj/events{/privacy}","received_events_url":"https://api.github.com/users/smithsimonj/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2016-07-04T10:29:27Z","updated_at":"2018-02-13T20:37:31Z","closed_at":"2017-03-31T13:34:21Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**:\n2.3.2\n**JVM version**:\njava version \"1.8.0_91\"\nJava(TM) SE Runtime Environment (build 1.8.0_91-b14)\nJava HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)\n**OS version**:\nCentos 7\n**Description of the problem including expected versus actual behavior**:\nI was migrating data on our 12 node elastic cluster and created a replica index with a new mapping for every index (79 indices in total). Then I ran a post command to `http://localhost:9200/_aliases` on one of the nodes and posted a list of 158 actions consisting of a remove of the alias pointing at the old index and then an add of the same alias name to the new index.\n\nSo something like:\n\n```\nRemove: A - > A1\nAdd: A -> A2\n```\n\nFor every index.\n\nThis appeared to work and the result of GET  on `http://localhost:9200/_aliases` showed the correct mapping that I was hoping to achieve.\n\nThere was a serious error however with two of the indices the results of a search gave the results of **both** the old and the new index. Also, attempting to index new documents failed with an error saying that you cannot index documents on an alias with two indices.\n\nAs mentioned the GET on `http://localhost:9200/_aliases` yielded the correct result, leaving me to feel that the operations on two of the indices were not carried out to completion.\n\nFurther because the system appeared to think that the aliases were like those given in the result of GET on `http://localhost:9200/_aliases` I could not delete the alias to the old index.\n\nIn the end, I managed to get the alias to work for the two broken indices by reversing the change that I made, then remaking it. I.e. applying:\n\n```\nRemove: A -> A2\nAdd: A - > A1\n```\n\nThen again:\n\n```\nRemove: A - > A1\nAdd: A -> A2\n```\n\nAnd this finally fixed it so that the state shown by GET on `http://localhost:9200/_aliases` matched the observed behaviour.\n\nThis is very serious error when doing mass migrations as you can have no trust in the results of the alias changes.\n\nWe did not find any errors in the elastic logs when this operation occurred. \n\n**Steps to reproduce**:\n1. Change the aliases in a single command for many (O(100)) indices on a large cluster\n2. Attempt to insert a document into every alias and look for errors\n\n**Provide logs (if relevant)**:\n\n<!--\nIf you are filing a feature request, please remove the above bug\nreport block and provide responses for all of the below items.\n-->\n\n**Describe the feature**:\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}