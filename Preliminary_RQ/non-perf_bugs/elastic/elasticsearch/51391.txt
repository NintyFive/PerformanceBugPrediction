{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391/events","html_url":"https://github.com/elastic/elasticsearch/issues/51391","id":554602754,"node_id":"MDU6SXNzdWU1NTQ2MDI3NTQ=","number":51391,"title":"Lower required permission for _analyze when calling it without an index","user":{"login":"pheyos","id":1945390,"node_id":"MDQ6VXNlcjE5NDUzOTA=","avatar_url":"https://avatars0.githubusercontent.com/u/1945390?v=4","gravatar_id":"","url":"https://api.github.com/users/pheyos","html_url":"https://github.com/pheyos","followers_url":"https://api.github.com/users/pheyos/followers","following_url":"https://api.github.com/users/pheyos/following{/other_user}","gists_url":"https://api.github.com/users/pheyos/gists{/gist_id}","starred_url":"https://api.github.com/users/pheyos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pheyos/subscriptions","organizations_url":"https://api.github.com/users/pheyos/orgs","repos_url":"https://api.github.com/users/pheyos/repos","events_url":"https://api.github.com/users/pheyos/events{/privacy}","received_events_url":"https://api.github.com/users/pheyos/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2020-01-24T08:24:35Z","updated_at":"2020-05-20T13:39:25Z","closed_at":"2020-02-13T09:33:03Z","author_association":"NONE","active_lock_reason":null,"body":"It's possible to use the `_analyze` endpoint without an index, example taken from our [docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/indices-analyze.html):\r\n```\r\nGET /_analyze\r\n{\r\n  \"analyzer\": \"standard\",\r\n  \"text\": \"Quick Brown Foxes!\"\r\n}\r\n```\r\n\r\nWhen doing this as a user without `cluster:manage` or `cluster:all`, an error is returned:\r\n```\r\naction [cluster:admin/analyze] is unauthorized for user [USER]\r\n```\r\n\r\nIn a slack discussion @romseygeek pointed out that if you use `_analyze` with an index and use a field that doesn't exist, it falls back to the default analyzer, potentially leaking data. So the required high privileges are justified for this use case.\r\nBut when calling the endpoint without an index, there is no such danger, so this request does not necessarily need to be restricted that strong. @jasontedor suggested to `use a separate (virtual) transport action for that one so that it doesnâ€™t require such elevated privileges`.\r\n\r\n**Background**: We have a new ML UI functionality in 7.6 that uses the `_analyze` API (with strings in the request body only) in order to show how categorization would tokenize a message. The `cluster:manage` would be a higher privilege than required for the rest of ML and we would like to avoid it if possible.\r\n\r\ncc @droberts195 ","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}