{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10511","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10511/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10511/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10511/events","html_url":"https://github.com/elastic/elasticsearch/issues/10511","id":67379954,"node_id":"MDU6SXNzdWU2NzM3OTk1NA==","number":10511,"title":"Duplicate ids in index (without autogeneration)","user":{"login":"mrec","id":4206148,"node_id":"MDQ6VXNlcjQyMDYxNDg=","avatar_url":"https://avatars0.githubusercontent.com/u/4206148?v=4","gravatar_id":"","url":"https://api.github.com/users/mrec","html_url":"https://github.com/mrec","followers_url":"https://api.github.com/users/mrec/followers","following_url":"https://api.github.com/users/mrec/following{/other_user}","gists_url":"https://api.github.com/users/mrec/gists{/gist_id}","starred_url":"https://api.github.com/users/mrec/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mrec/subscriptions","organizations_url":"https://api.github.com/users/mrec/orgs","repos_url":"https://api.github.com/users/mrec/repos","events_url":"https://api.github.com/users/mrec/events{/privacy}","received_events_url":"https://api.github.com/users/mrec/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-04-09T14:56:48Z","updated_at":"2015-04-09T23:03:58Z","closed_at":"2015-04-09T16:52:01Z","author_association":"NONE","active_lock_reason":null,"body":"Opening a new issue as requested by @brwe in the comments to #8788.\n\nWe recently saw an unexpectedly high count on an index we're feeding. It's the second time we've seen this; the first time was only off by 1, but this time it was off by over 16,000 in an index that should contain less than 300k docs. Since the dataset is so small I pulled down everything (`_search?pretty=true&fields=&size=400000`), scraped out the ids and ran them through `uniq`, which revealed a ton of duplicates. \n\nNotes/observations:\n- We're using 1.3.4, doing bulk indexing with the Java API's `TransportClient` and `BulkProcessor`.\n- We're **not** using autogenerated ids, so it doesn't look as if the fix for #8788 is likely to help us.\n- No id appeared more than twice.\n- The index has not been migrated from an earlier version. In fact, the index is deleted and recreated irregularly but fairly frequently, from every few days to every couple of weeks.\n- Around the time the duplicates appeared, we saw problems in other (non-Elastic) parts of the system. I can't see any way that they could directly cause the duplication, but it's possible that network issues were the common cause of both.\n\nRunning\n\n```\ncurl -s 'http://HOST:9200/std_physicalasset_alpha_a/_search?pretty&q=_id:77309419847&explain&fields=_source,_routing' -d '{\"version\":true}'\n```\n\nproduced\n\n```\n{\n  \"took\" : 247,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_shard\" : 3,\n      \"_node\" : \"HRLe1R1iTzqzZ44ocSb4Sw\",\n      \"_index\" : \"std_physicalasset_alpha_a\",\n      \"_type\" : \"other\",\n      \"_id\" : \"77309419847\",\n      \"_version\" : 2,\n      \"_score\" : 1.0,\n      \"_source\":{\"DEBUGRUN\":\"2015-04-03T20:48:55.327Z\"},\n      \"_explanation\" : {\n        \"value\" : 1.0,\n        \"description\" : \"ConstantScore(_uid:_default_#77309419847 _uid:generic#77309419847 _uid:other#77309419847 _uid:plant#77309419847 _uid:vessel#77309419847), product of:\",\n        \"details\" : [ {\n          \"value\" : 1.0,\n          \"description\" : \"boost\"\n        }, {\n          \"value\" : 1.0,\n          \"description\" : \"queryNorm\"\n        } ]\n      }\n    }, {\n      \"_shard\" : 3,\n      \"_node\" : \"HRLe1R1iTzqzZ44ocSb4Sw\",\n      \"_index\" : \"std_physicalasset_alpha_a\",\n      \"_type\" : \"vessel\",\n      \"_id\" : \"77309419847\",\n      \"_version\" : 456,\n      \"_score\" : 1.0,\n      \"_source\":{\"DEBUGRUN\":\"2015-04-08T16:12:52.903Z\"},\n      \"_explanation\" : {\n        \"value\" : 1.0,\n        \"description\" : \"ConstantScore(_uid:_default_#77309419847 _uid:generic#77309419847 _uid:other#77309419847 _uid:plant#77309419847 _uid:vessel#77309419847), product of:\",\n        \"details\" : [ {\n          \"value\" : 1.0,\n          \"description\" : \"boost\"\n        }, {\n          \"value\" : 1.0,\n          \"description\" : \"queryNorm\"\n        } ]\n      }\n    } ]\n  }\n}\n```\n\nI've removed most of `_source` as verbose and not relevant, but `DEBUGBATCH` is interesting; it's a manually-set human-readable equivalent of `_timestamp`, and shows that the two documents with this id were loaded almost 5 days apart. The second has been updated again since I captured that, although the feeder process has now been stopped.\n\n```\ncurl -s 'http://HOST:9200/std_physicalasset_alpha_a/_segments?pretty'\n```\n\nproduces around 100k of JSON, which seems a bit much to post in full. (That may be telling in itself; the full response contained a suspiciously-round 255 segment objects.) The following is just the portion for the shard and (non-primary) node containing the sample duplicate id above:\n\n```\n{\n  \"_shards\" : {\n    \"total\" : 10,\n    \"successful\" : 10,\n    \"failed\" : 0\n  },\n  \"indices\" : {\n    \"std_physicalasset_alpha_a\" : {\n      \"shards\" : {\n====================\n# Shards 0-2 omitted\n====================\n        \"3\" : [ {\n          \"routing\" : {\n            \"state\" : \"STARTED\",\n            \"primary\" : false,\n            \"node\" : \"HRLe1R1iTzqzZ44ocSb4Sw\"\n          },\n          \"num_committed_segments\" : 26,\n          \"num_search_segments\" : 16,\n          \"segments\" : {\n            \"_2a5z\" : {\n              \"generation\" : 106487,\n              \"num_docs\" : 43857,\n              \"deleted_docs\" : 15215,\n              \"size_in_bytes\" : 341737818,\n              \"memory_in_bytes\" : 2035824,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a76\" : {\n              \"generation\" : 106530,\n              \"num_docs\" : 1197,\n              \"deleted_docs\" : 31,\n              \"size_in_bytes\" : 9592426,\n              \"memory_in_bytes\" : 418896,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a7t\" : {\n              \"generation\" : 106553,\n              \"num_docs\" : 1382,\n              \"deleted_docs\" : 35,\n              \"size_in_bytes\" : 11067533,\n              \"memory_in_bytes\" : 434208,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a82\" : {\n              \"generation\" : 106562,\n              \"num_docs\" : 1629,\n              \"deleted_docs\" : 48,\n              \"size_in_bytes\" : 12533722,\n              \"memory_in_bytes\" : 443952,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a8n\" : {\n              \"generation\" : 106583,\n              \"num_docs\" : 2070,\n              \"deleted_docs\" : 61,\n              \"size_in_bytes\" : 15764916,\n              \"memory_in_bytes\" : 447088,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a9e\" : {\n              \"generation\" : 106610,\n              \"num_docs\" : 1480,\n              \"deleted_docs\" : 28,\n              \"size_in_bytes\" : 11471539,\n              \"memory_in_bytes\" : 435432,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a9m\" : {\n              \"generation\" : 106618,\n              \"num_docs\" : 151,\n              \"deleted_docs\" : 3,\n              \"size_in_bytes\" : 1529856,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2a9n\" : {\n              \"generation\" : 106619,\n              \"num_docs\" : 6528,\n              \"deleted_docs\" : 145,\n              \"size_in_bytes\" : 45294050,\n              \"memory_in_bytes\" : 632040,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2a9q\" : {\n              \"generation\" : 106622,\n              \"num_docs\" : 186,\n              \"deleted_docs\" : 4,\n              \"size_in_bytes\" : 1872124,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2a9t\" : {\n              \"generation\" : 106625,\n              \"num_docs\" : 220,\n              \"deleted_docs\" : 9,\n              \"size_in_bytes\" : 2276799,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2a9w\" : {\n              \"generation\" : 106628,\n              \"num_docs\" : 654,\n              \"deleted_docs\" : 18,\n              \"size_in_bytes\" : 5614691,\n              \"memory_in_bytes\" : 368520,\n              \"committed\" : true,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2aaf\" : {\n              \"generation\" : 106647,\n              \"num_docs\" : 101,\n              \"deleted_docs\" : 80,\n              \"size_in_bytes\" : 1858120,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2aaj\" : {\n              \"generation\" : 106651,\n              \"num_docs\" : 499,\n              \"deleted_docs\" : 269,\n              \"size_in_bytes\" : 6309352,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2aaq\" : {\n              \"generation\" : 106658,\n              \"num_docs\" : 609,\n              \"deleted_docs\" : 207,\n              \"size_in_bytes\" : 6785525,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2aas\" : {\n              \"generation\" : 106660,\n              \"num_docs\" : 663,\n              \"deleted_docs\" : 225,\n              \"size_in_bytes\" : 7485334,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2aat\" : {\n              \"generation\" : 106661,\n              \"num_docs\" : 106,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1942039,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2aau\" : {\n              \"generation\" : 106662,\n              \"num_docs\" : 123,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 2226032,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2aaw\" : {\n              \"generation\" : 106664,\n              \"num_docs\" : 75,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1489187,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2aaz\" : {\n              \"generation\" : 106667,\n              \"num_docs\" : 93,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1683929,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2ab0\" : {\n              \"generation\" : 106668,\n              \"num_docs\" : 74,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1368605,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2ab5\" : {\n              \"generation\" : 106673,\n              \"num_docs\" : 68,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1346587,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2ab8\" : {\n              \"generation\" : 106676,\n              \"num_docs\" : 31,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 690748,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2ab9\" : {\n              \"generation\" : 106677,\n              \"num_docs\" : 54,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1086051,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2aba\" : {\n              \"generation\" : 106678,\n              \"num_docs\" : 121,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 2119135,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2abb\" : {\n              \"generation\" : 106679,\n              \"num_docs\" : 473,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 6822800,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2abc\" : {\n              \"generation\" : 106680,\n              \"num_docs\" : 714,\n              \"deleted_docs\" : 388,\n              \"size_in_bytes\" : 12332118,\n              \"memory_in_bytes\" : 417680,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2abd\" : {\n              \"generation\" : 106681,\n              \"num_docs\" : 1,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 49613,\n              \"memory_in_bytes\" : 0,\n              \"committed\" : true,\n              \"search\" : false,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2acb\" : {\n              \"generation\" : 106715,\n              \"num_docs\" : 17,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 398023,\n              \"memory_in_bytes\" : 195496,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2acc\" : {\n              \"generation\" : 106716,\n              \"num_docs\" : 36,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 756378,\n              \"memory_in_bytes\" : 228552,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2acd\" : {\n              \"generation\" : 106717,\n              \"num_docs\" : 13,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 316552,\n              \"memory_in_bytes\" : 196488,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2ace\" : {\n              \"generation\" : 106718,\n              \"num_docs\" : 17,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 354373,\n              \"memory_in_bytes\" : 189920,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2acf\" : {\n              \"generation\" : 106719,\n              \"num_docs\" : 2118,\n              \"deleted_docs\" : 96,\n              \"size_in_bytes\" : 23788950,\n              \"memory_in_bytes\" : 490448,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : false\n            },\n            \"_2acg\" : {\n              \"generation\" : 106720,\n              \"num_docs\" : 24,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 516210,\n              \"memory_in_bytes\" : 219592,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            },\n            \"_2ach\" : {\n              \"generation\" : 106721,\n              \"num_docs\" : 67,\n              \"deleted_docs\" : 0,\n              \"size_in_bytes\" : 1265169,\n              \"memory_in_bytes\" : 236688,\n              \"committed\" : false,\n              \"search\" : true,\n              \"version\" : \"4.9\",\n              \"compound\" : true\n            }\n          }\n        }, {\n          \"routing\" : {\n            \"state\" : \"STARTED\",\n            \"primary\" : true,\n            \"node\" : \"oyFoYqV1SHyLoJmOzRQrDQ\"\n          },\n          \"num_committed_segments\" : 14,\n          \"num_search_segments\" : 13,\n          \"segments\" : {\n==========================\n20 segment objects omitted\n==========================\n        } ],\n===============\nShard 4 omitted\n===============\n      }\n    }\n  }\n}\n```\n\nIt's highly unlikely that I'll be able to make the ES server logs available in full, but I can grep them if there's anything specific that might help. I can't find any mention of the `std_physicalasset_alpha_a` index in them except for a bunch of entries of the form\n\n```\n[2015-04-05 22:20:58,598][INFO ][index.engine.internal    ] [c115knppaes01-01] [std_physicalasset_alpha_a][2] now throttling indexing: numMergesInFlight=6, maxNumMerges=5\n[2015-04-05 22:20:59,216][INFO ][index.engine.internal    ] [c115knppaes01-01] [std_physicalasset_alpha_a][2] stop throttling indexing: numMergesInFlight=4, maxNumMerges=5\n```\n","closed_by":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"performed_via_github_app":null}