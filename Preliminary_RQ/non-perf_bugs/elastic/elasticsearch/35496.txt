{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35496","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35496/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35496/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35496/events","html_url":"https://github.com/elastic/elasticsearch/issues/35496","id":380270980,"node_id":"MDU6SXNzdWUzODAyNzA5ODA=","number":35496,"title":"[CI] DocsClientYamlTestSuiteIT test {yaml=reference/ccr/apis/get-ccr-stats}","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"labels":[{"id":912824565,"node_id":"MDU6TGFiZWw5MTI4MjQ1NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CCR","name":":Distributed/CCR","color":"0e8a16","default":false,"description":"Issues around the Cross Cluster State Replication features"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2018-11-13T15:09:13Z","updated_at":"2018-11-30T09:08:32Z","closed_at":"2018-11-30T09:08:32Z","author_association":"MEMBER","active_lock_reason":null,"body":"Failure:\r\n\r\n```\r\n DocsClientYamlTestSuiteIT.test {yaml=reference/ccr/apis/get-ccr-stats/line_88} <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: Failure at [reference/ccr/apis/get-ccr-stats:74]: $body didn't match expected value:\r\n   >                          $body: \r\n   >                auto_follow_stats: \r\n   >     number_of_failed_follow_indices: same [0]\r\n   >     number_of_failed_remote_cluster_state_requests: expected [0] but was [1]\r\n   >     number_of_successful_follow_indices: same [0]\r\n   >          recent_auto_follow_errors: \r\n   >       received [1] more entries than expected\r\n   >                     follow_stats: \r\n   >                            indices: \r\n   >                                    0: \r\n   >                                  index: same [follower_index]\r\n   >                                 shards: \r\n   >                                        0: \r\n   >                                 bytes_read: same [0]\r\n   >                       failed_read_requests: same [0]\r\n   >                      failed_write_requests: same [0]\r\n   >                 follower_global_checkpoint: same [0]\r\n   >                             follower_index: same [follower_index]\r\n   >                   follower_mapping_version: same [0]\r\n   >                        follower_max_seq_no: same [0]\r\n   >                  follower_settings_version: same [0]\r\n   >                      last_requested_seq_no: same [0]\r\n   >                   leader_global_checkpoint: same [0]\r\n   >                               leader_index: same [leader_index]\r\n   >                          leader_max_seq_no: same [0]\r\n   >                            operations_read: same [0]\r\n   >                         operations_written: same [0]\r\n   >                  outstanding_read_requests: same [0]\r\n   >                 outstanding_write_requests: same [0]\r\n   >                            read_exceptions: same [empty list]\r\n   >                             remote_cluster: same [remote_cluster]\r\n   >                                   shard_id: same [0]\r\n   >                   successful_read_requests: same [0]\r\n   >                  successful_write_requests: same [0]\r\n   >                time_since_last_read_millis: same [-1]\r\n   >             total_read_remote_exec_time_millis: same [0]\r\n   >                     total_read_time_millis: same [0]\r\n   >                    total_write_time_millis: same [0]\r\n   >               write_buffer_operation_count: same [0]\r\n   >                 write_buffer_size_in_bytes: same [0]\r\n   >    at __randomizedtesting.SeedInfo.seed([9F632EDCF44DF\r\n```\r\n\r\nDoes not reproduce. Log is full with connection error. The AutoFollowCoordinator could fetch remote cluster state, because the license couldn't be determined and that was caused by a node disconnect exception:\r\n\r\n```\r\n[2018-11-13T06:31:16,896][WARN ][o.e.x.c.a.AutoFollowCoordinator] [node-0] failure occurred while fetching cluster state for auto follow pattern [my_auto_follow_pattern]\r\norg.elasticsearch.ElasticsearchStatusException: can not fetch remote cluster state as the license state of the remote cluster [remote_cluster] could not be determined\r\n        at org.elasticsearch.xpack.ccr.CcrLicenseChecker.clusterStateUnknownRemoteLicense(CcrLicenseChecker.java:425) ~[x-pack-ccr-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.xpack.ccr.CcrLicenseChecker.lambda$checkRemoteClusterLicenseAndFetchClusterState$5(CcrLicenseChecker.java:171) ~[x-pack-ccr-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.xpack.ccr.CcrLicenseChecker$1.onFailure(CcrLicenseChecker.java:217) [x-pack-ccr-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.license.RemoteClusterLicenseChecker$1.onFailure(RemoteClusterLicenseChecker.java:180) [x-pack-core-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.action.support.ContextPreservingActionListener.onFailure(ContextPreservingActionListener.java:50) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:53) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1127) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.transport.TransportService.lambda$onConnectionClosed$8(TransportService.java:982) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:627) [elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n        at java.lang.Thread.run(Thread.java:834) [?:?]\r\nCaused by: org.elasticsearch.ElasticsearchException: could not determine the license type for cluster [remote_cluster]\r\n        ... 9 more\r\nCaused by: org.elasticsearch.transport.NodeDisconnectedException: [node-0][127.0.0.1:59722][cluster:monitor/xpack/info] disconnected\r\n... SKIPPED 56 LINES ...\r\n```\r\n\r\nThe test failed because a the auto follow stats are not expected to report failures (`number_of_failed_remote_cluster_state_requests` should be 0 and `recent_auto_follow_errors` should be empty). \r\n\r\nReturned auto follow stats:\r\n\r\n```\r\n{\r\n  1>       \"auto_follow_stats\" : {\r\n  1>         \"number_of_failed_follow_indices\" : 0,\r\n  1>         \"number_of_failed_remote_cluster_state_requests\" : 1,\r\n  1>         \"number_of_successful_follow_indices\" : 0,\r\n  1>         \"recent_auto_follow_errors\" : [\r\n  1>           {\r\n  1>             \"leader_index\" : \"my_auto_follow_pattern\",\r\n  1>             \"auto_follow_exception\" : {\r\n  1>               \"type\" : \"exception\",\r\n  1>               \"reason\" : \"ElasticsearchStatusException[can not fetch remote cluster state as the license state of the remote cluster [remote_cluster] could not be determined]; nested: ElasticsearchException\r\n[could not determine the license type for cluster [remote_cluster]]; nested: NodeDisconnectedException[[node-0][127.0.0.1:59722][cluster:monitor/xpack/info] disconnected];\",\r\n  1>               \"caused_by\" : {\r\n  1>                 \"type\" : \"status_exception\",\r\n  1>                 \"reason\" : \"can not fetch remote cluster state as the license state of the remote cluster [remote_cluster] could not be determined\",\r\n  1>                 \"caused_by\" : {\r\n  1>                   \"type\" : \"exception\",\r\n  1>                   \"reason\" : \"could not determine the license type for cluster [remote_cluster]\",\r\n  1>                   \"caused_by\" : {\r\n  1>                     \"type\" : \"node_disconnected_exception\",\r\n  1>                     \"reason\" : \"[node-0][127.0.0.1:59722][cluster:monitor/xpack/info] disconnected\"\r\n  1>                   }\r\n  1>                 }\r\n  1>               }\r\n  1>             }\r\n  1>           }\r\n  1>         ]\r\n  1>       }\r\n```","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}