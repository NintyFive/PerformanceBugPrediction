{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41840","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41840/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41840/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41840/events","html_url":"https://github.com/elastic/elasticsearch/issues/41840","id":440607885,"node_id":"MDU6SXNzdWU0NDA2MDc4ODU=","number":41840,"title":"why keyword typed field`s Aggregation consume fielddata memory","user":{"login":"bigstar119","id":24514189,"node_id":"MDQ6VXNlcjI0NTE0MTg5","avatar_url":"https://avatars0.githubusercontent.com/u/24514189?v=4","gravatar_id":"","url":"https://api.github.com/users/bigstar119","html_url":"https://github.com/bigstar119","followers_url":"https://api.github.com/users/bigstar119/followers","following_url":"https://api.github.com/users/bigstar119/following{/other_user}","gists_url":"https://api.github.com/users/bigstar119/gists{/gist_id}","starred_url":"https://api.github.com/users/bigstar119/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bigstar119/subscriptions","organizations_url":"https://api.github.com/users/bigstar119/orgs","repos_url":"https://api.github.com/users/bigstar119/repos","events_url":"https://api.github.com/users/bigstar119/events{/privacy}","received_events_url":"https://api.github.com/users/bigstar119/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-05-06T09:12:13Z","updated_at":"2019-05-06T16:43:07Z","closed_at":"2019-05-06T16:43:06Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 5.6.5, Build: 6a37571/2017-12-04T07:50:10.466Z, JVM: 1.8.0_141\r\n**Plugins installed**: [no]\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_141\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_141-b15)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.141-b15, mixed mode)\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentOS Linux release 7.3.1611 (Core) X64\r\n**Description of the problem including expected versus actual behavior**:\r\nI do some Aggregation operation on a keyword typed field.because keyword typed field`s sort/Aggregation use doc_values, so\r\nthe fielddata will not increase. but fielddata memory is increased  a lot! why?\r\nand when i use _forcemerge cmd like below:\r\ncurl -X POST 'http://10.10.105.50:9200/mstest20190506/_forcemerge?max_num_segments=1'\r\nafter forcemerge finished,i redo Aggregation operation on the keyword  typed field, this time fielddata never increased! why?\r\n\r\nin my test max_num_segments only set to 1 ,after forcemerge,redo Aggregation operation on the keyword  typed field fielddata never increased\r\nis _forcemerge?max_num_segments=1 do any special things caused this ?\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1.create index and mapping\r\n curl -XPUT 'http://10.10.105.50:9200/mstest20190506 -d\r\n {\r\n   \"settings\": {\r\n     \"index.translog.durability\": \"async\",\r\n     \"index.translog.sync_interval\": \"120s\",\r\n     \"refresh_interval\": \"30s\",\r\n     \"number_of_shards\": 8,\r\n     \"number_of_replicas\": 1\r\n   },\r\n   \"mappings\": {\r\n     \"ph_http_list_tab\": {\r\n       \"properties\": {\r\n         \"title\": {\r\n           \"type\": \"text\",\r\n           \"fielddata\": true\r\n         },\r\n         \"keyword\": {\r\n           \"type\": \"keyword\"\r\n         }\r\n       }\r\n     }\r\n   }\r\n }\r\n 2.insert some data\r\n    mstest20190506\r\n    size: 2.73Gi (5.45Gi)\r\n    docs: 2,931,888 (5,769,392)\r\n 3.do Aggregation operation on a keyword typed field(keyword),and lookup fielddata memory(fm)\r\ncurl -X POST 'http://10.10.105.50:9200/mstest20190506/ph_http_list_tab/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"keyword_aggs\": {\r\n      \"terms\": {\r\n        \"field\": \"keyword\"\r\n      }\r\n    }\r\n  }\r\n}\r\n[es@hadoop-3 indices]$ curl -X GET \"http://10.10.105.50:9200/_cat/nodes?v&h=name,port,sc,sm,fm,qcm,rcm,siwm,svmm,sfbm,hc,hm,hp,rp,scc,so,scti,sfc,sqc,sqti,scrcc,mc,iic,idc,gc,load_15m,cs\"\r\nname   port sc      sm      fm qcm   rcm siwm svmm sfbm    hc    hm hp rp scc so  scti sfc sqc sqti scrcc mc iic idc gc load_15m cs\r\nnode-3 9300 68 456.7mb   1.2mb  0b   3kb   0b   0b   0b 1.4gb 1.9gb 72 88   0  0 19.9m   0   0   1m     1  0   0   0  0     2.07 0b\r\nnode-1 9300 57 458.8mb 935.1kb  0b 2.2kb   0b   0b   0b 1.4gb 1.9gb 73 90   0  0 17.9m   0   0   1m     1  0   0   0  0     0.63 0b\r\nnode-2 9300 57 548.8mb 301.2kb  0b  785b   0b   0b   0b 1.1gb 1.9gb 58 89   0  0   22m   0   0 1.3m     1  0   0   0  0     1.33 0b\r\n[es@hadoop-3 indices]$ curl -X GET \"http://10.10.105.50:9200/_cat/fielddata?v\"\r\nid                     host         ip           node   field      size\r\n3l1CfRtPR_SCBnyIChasaw 10.10.105.50 10.10.105.50 node-1 keyword 935.1kb\r\n-f1o6kzcS9uelICQMzpxaQ 10.10.125.54 10.10.125.54 node-3 keyword   1.2mb\r\nAPuxDzzaQjSZtIsW4qUCaQ 10.10.125.50 10.10.125.50 node-2 keyword 301.2kb\r\n4.forcemerge and do agg operate again\r\n4-1.forcemerge\r\ncurl -X POST 'http://10.10.105.50:9200/mstest20190506/_forcemerge?max_num_segments=1'\r\n4-2.do agg operate\r\ncurl -X POST 'http://10.10.105.50:9200/mstest20190506/ph_http_list_tab/_search -d\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"keyword_aggs\": {\r\n      \"terms\": {\r\n        \"field\": \"keyword\"\r\n      }\r\n    }\r\n  }\r\n}\r\n4-3.ookup fielddata memory(fm)\r\n[es@hadoop-3 indices]$ curl -X GET \"http://10.10.105.50:9200/_cat/nodes?v&h=name,port,sc,sm,fm,qcm,rcm,siwm,svmm,sfbm,hc,hm,hp,rp,scc,so,scti,sfc,sqc,sqti,scrcc,mc,iic,idc,gc,load_15m,cs\"\r\nname   port sc      sm fm qcm   rcm siwm svmm sfbm    hc    hm hp rp scc so  scti sfc sqc sqti scrcc mc iic idc gc load_15m cs\r\nnode-3 9300 11 456.6mb 0b  0b 1.5kb   0b   0b   0b 1.2gb 1.9gb 63 88   0  0 19.9m   0   0   1m     1  0   0   0  0     2.02 0b\r\nnode-1 9300 10 458.7mb 0b  0b 1.5kb   0b   0b   0b 1.2gb 1.9gb 66 91   0  0 17.9m   0   0   1m     1  0   0   0  0     0.55 0b\r\nnode-2 9300 11 548.8mb 0b  0b   3kb   0b   0b   0b 1.4gb 1.9gb 76 89   0  0   22m   0   0 1.3m     1  0   0   0  0     1.28 0b\r\n[es@hadoop-3 indices]$ curl -X GET \"http://10.10.105.50:9200/_cat/fielddata?v\"\r\nid                     host         ip           node   field   size\r\nAPuxDzzaQjSZtIsW4qUCaQ 10.10.125.50 10.10.125.50 node-2 keyword   0b\r\n3l1CfRtPR_SCBnyIChasaw 10.10.105.50 10.10.105.50 node-1 keyword   0b\r\n-f1o6kzcS9uelICQMzpxaQ 10.10.125.54 10.10.125.54 node-3 keyword   0b\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}