[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155046353","html_url":"https://github.com/elastic/elasticsearch/issues/14574#issuecomment-155046353","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14574","id":155046353,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTA0NjM1Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-09T12:04:10Z","updated_at":"2015-11-09T12:04:10Z","author_association":"CONTRIBUTOR","body":"It'd be much easier to answer your question if you provided a complete example demonstrating exactly what you're doing.\n\nI've come up with my own example which demonstrates that it works correctly:\n\n```\nPUT test \n{\n  \"mappings\": {\n    \"parent\": {\n\n    },\n    \"child\": {\n      \"_parent\": {\n        \"type\": \"parent\"\n      }\n    }\n  }\n}\n\nPUT test/parent/1\n{}\n\nPUT test/child/2?parent=1\n{\n  \"foo\": \"bar\"\n}\n\nPUT test/child/3?parent=1\n{\n  \"foo\": \"baz\"\n}\n\nPUT test/child/4?parent=1\n{\n  \"foo\": \"bar baz\"\n}\n\nGET test/parent/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"has_child\": {\n            \"type\": \"child\",\n            \"inner_hits\": {\n              \"name\": \"bar\"\n            },\n            \"query\": {\n              \"match\": {\n                \"foo\": \"bar\"\n              }\n            }\n          }\n        },\n        {\n          \"has_child\": {\n            \"type\": \"child\",\n            \"inner_hits\": {\n              \"name\": \"baz\"\n            },\n            \"query\": {\n              \"match\": {\n                \"foo\": \"baz\"\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155276637","html_url":"https://github.com/elastic/elasticsearch/issues/14574#issuecomment-155276637","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14574","id":155276637,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTI3NjYzNw==","user":{"login":"lipixun","id":12741165,"node_id":"MDQ6VXNlcjEyNzQxMTY1","avatar_url":"https://avatars0.githubusercontent.com/u/12741165?v=4","gravatar_id":"","url":"https://api.github.com/users/lipixun","html_url":"https://github.com/lipixun","followers_url":"https://api.github.com/users/lipixun/followers","following_url":"https://api.github.com/users/lipixun/following{/other_user}","gists_url":"https://api.github.com/users/lipixun/gists{/gist_id}","starred_url":"https://api.github.com/users/lipixun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lipixun/subscriptions","organizations_url":"https://api.github.com/users/lipixun/orgs","repos_url":"https://api.github.com/users/lipixun/repos","events_url":"https://api.github.com/users/lipixun/events{/privacy}","received_events_url":"https://api.github.com/users/lipixun/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T03:56:20Z","updated_at":"2015-11-10T03:56:20Z","author_association":"NONE","body":"All right, here is a complete query which I sent to es:\n\n```\n{\n    \"query\": {\n        \"bool\": {\n            \"must\": [\n                {\n                    \"has_child\": {\n                        \"query\": {\n                            \"bool\": {\n                                \"must\": [\n                                    {\n                                        \"match\": {\n                                            \"text\": {\n                                                \"operator\": \"and\",\n                                                \"query\": \"avalue\",\n                                                \"_name\": \"q1\"\n                                            }\n                                        }\n                                    },\n                                    {\n                                        \"term\": {\n                                            \"doc_type\": {\n                                                \"value\": \"XXX\"\n                                            }\n                                        }\n                                    }\n                                ]\n                            }\n                        },\n                        \"inner_hits\": {\n                            \"highlight\": {\n                                \"fields\": {\n                                    \"text\": {}\n                                }\n                            },\n                            \"name\": \"child1\",\n                            \"size\": 1\n                        },\n                        \"type\": \"es_emr\",\n                        \"_name\": \"child1\"\n                    }\n                },\n                {\n                    \"has_child\": {\n                        \"query\": {\n                            \"bool\": {\n                                \"must\": [\n                                    {\n                                        \"match\": {\n                                            \"text\": {\n                                                \"operator\": \"and\",\n                                                \"query\": \"avalue\",\n                                                \"_name\": \"q2\"\n                                            }\n                                        }\n                                    },\n                                    {\n                                        \"term\": {\n                                            \"doc_type\": {\n                                                \"value\": \"YYY\"\n                                            }\n                                        }\n                                    }\n                                ]\n                            }\n                        },\n                        \"inner_hits\": {\n                            \"highlight\": {\n                                \"fields\": {\n                                    \"text\": {}\n                                }\n                            },\n                            \"name\": \"child2\",\n                            \"size\": 1\n                        },\n                        \"type\": \"es_emr\",\n                        \"_name\": \"child2\"\n                    }\n                }\n            ]\n        }\n    }\n}\n```\n\nWe have a document type es_emr which is the child document of es_visit and we are searching the es_visit by the above query.\n\nIt's obviously that the q1 and q2 are exactly the same query in this case, but they're searched with a different term query in each has_child query.\n\nq1 is searched with doc_type == 'XXX' and q2 is searched with doc_type == 'YYY' and there's no way for the field doc_type to match both XXX and YYY in one document.\n\nThe strange thing I found is that I got matched query [ \"q1\", \"q2\" ] in child1, but q2 is not defined in child1.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155278026","html_url":"https://github.com/elastic/elasticsearch/issues/14574#issuecomment-155278026","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14574","id":155278026,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTI3ODAyNg==","user":{"login":"lipixun","id":12741165,"node_id":"MDQ6VXNlcjEyNzQxMTY1","avatar_url":"https://avatars0.githubusercontent.com/u/12741165?v=4","gravatar_id":"","url":"https://api.github.com/users/lipixun","html_url":"https://github.com/lipixun","followers_url":"https://api.github.com/users/lipixun/followers","following_url":"https://api.github.com/users/lipixun/following{/other_user}","gists_url":"https://api.github.com/users/lipixun/gists{/gist_id}","starred_url":"https://api.github.com/users/lipixun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lipixun/subscriptions","organizations_url":"https://api.github.com/users/lipixun/orgs","repos_url":"https://api.github.com/users/lipixun/repos","events_url":"https://api.github.com/users/lipixun/events{/privacy}","received_events_url":"https://api.github.com/users/lipixun/received_events","type":"User","site_admin":false},"created_at":"2015-11-10T04:04:15Z","updated_at":"2015-11-10T04:06:10Z","author_association":"NONE","body":"The returned es raw result (Only the inner_hits part of a hitted item):\n\n```\n\"child1\": {\n    \"hits\": {\n        \"hits\": [\n        {\n            \"_type\": \"es_emr\",\n            \"_routing\": \"someid\",\n            \"_index\": \"indexname\",\n            \"_score\": 4.782811,\n            \"_source\": { ... },\n            \"_parent\": \"The parent id\",\n            \"highlight\": {\n            \"text\": [\n                ....\n            ]\n            },\n            \"_id\": \"The document id\",\n            \"matched_queries\": [\n            \"q1\",\n            \"q2\"\n            ]\n        }\n        ],\n        \"total\": 1,\n        \"max_score\": 4.782811\n    }\n}\n```\n\n@clintongormley \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/157371150","html_url":"https://github.com/elastic/elasticsearch/issues/14574#issuecomment-157371150","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14574","id":157371150,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NzM3MTE1MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-17T13:30:46Z","updated_at":"2015-11-17T13:30:46Z","author_association":"CONTRIBUTOR","body":"@lipixun you're really going to need to provide a full recreation so that I don't have to guess about anything and can just run it.  \n","performed_via_github_app":null}]