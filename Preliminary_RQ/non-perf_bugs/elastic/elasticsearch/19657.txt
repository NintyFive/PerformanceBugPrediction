{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19657","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19657/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19657/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19657/events","html_url":"https://github.com/elastic/elasticsearch/issues/19657","id":168105663,"node_id":"MDU6SXNzdWUxNjgxMDU2NjM=","number":19657,"title":"ES 2.3.4: same query being run several times","user":{"login":"doron-logzio","id":20183290,"node_id":"MDQ6VXNlcjIwMTgzMjkw","avatar_url":"https://avatars3.githubusercontent.com/u/20183290?v=4","gravatar_id":"","url":"https://api.github.com/users/doron-logzio","html_url":"https://github.com/doron-logzio","followers_url":"https://api.github.com/users/doron-logzio/followers","following_url":"https://api.github.com/users/doron-logzio/following{/other_user}","gists_url":"https://api.github.com/users/doron-logzio/gists{/gist_id}","starred_url":"https://api.github.com/users/doron-logzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/doron-logzio/subscriptions","organizations_url":"https://api.github.com/users/doron-logzio/orgs","repos_url":"https://api.github.com/users/doron-logzio/repos","events_url":"https://api.github.com/users/doron-logzio/events{/privacy}","received_events_url":"https://api.github.com/users/doron-logzio/received_events","type":"User","site_admin":false},"labels":[{"id":151561891,"node_id":"MDU6TGFiZWwxNTE1NjE4OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Logging","name":":Core/Infra/Logging","color":"0e8a16","default":false,"description":"Log management and logging utilities"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-07-28T14:12:40Z","updated_at":"2017-03-31T13:43:44Z","closed_at":"2017-03-31T13:43:44Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.3.4\n\n**JVM version**: 1.7.0_101\n\n**OS version**: Ubuntu 14.04\n\n**Description of the problem including expected versus actual behavior**:\n\nOur setup is as follows:\nAn index over 11 nodes each of them holding 2 shards one primary and one replica (not of the same shard).\nWhen running a slow query of search_type  QUERY_THEN_FETCH and looking at the elasticsearch slow query logs we see that on each of the nodes we are getting 3 calls of the exact same query with timestamps miliseconds apart.\nWe were wondering whether this is a \"feature\" of the slow query logging or whether there are really 3 distinct calls of the same query performed on the index and if the latter, what would be an explanation for this.\n\nThe query we are running is:\n{\"index\":[\"index-*****************_\"],\"search_type\":\"count\",\"ignore_unavailable\":true}\n{\"size\":0,\"aggs\":{\"2\":{\"date_histogram\":{\"field\":\"@timestamp\",\"interval\":\"30m\",\"time_zone\":\"+03:00\",\"min_doc_count\":1,\"extended_bounds\":{\"min\":1469318400000,\"max\":1469393384478}},\"aggs\":{\"3\":{\"terms\":{\"field\":\"level\",\"size\":5,\"order\":{\"_count\":\"desc\"}}}}}},\"query\":{\"filtered\":{\"query\":{\"query_string\":{\"analyze_wildcard\":true,\"query\":\"_\"}},\"filter\":{\"bool\":{\"must\":[{\"query\":{\"match\":{\"type\":{\"query\":\"mainlog\",\"type\":\"phrase\"}}}},{\"range\":{\"@timestamp\":{\"gte\":1469318400000,\"lte\":1469393384478}}}],\"must_not\":[]}}}},\"highlight\":{\"pre_tags\":[\"@kibana-highlighted-field@\"],\"post_tags\":[\"@/kibana-highlighted-field@\"],\"fields\":{\"*\":{}},\"fragment_size\":2147483647}}\n\nAnd the slow query log (after some processing on our end) is:\n[2016-07-28 07:53:00,561][INFO ][index.search.slowlog.query] [index-*****************_]took[5.2s], took_millis[5209], types[], stats[], search_type[QUERY_THEN_FETCH], total_shards[11], source[{\"size\":0,\"aggs\":{\"2\":{\"date_histogram\":{\"field\":\"@timestamp\",\"interval\":\"30m\",\"time_zone\":\"+03:00\",\"min_doc_count\":1,\"extended_bounds\":{\"min\":1469318400000,\"max\":1469393384478}},\"aggs\":{\"3\":{\"terms\":{\"field\":\"level\",\"size\":5,\"order\":{\"_count\":\"desc\"}}}}}},\"query\":{\"filtered\":{\"query\":{\"query_string\":{\"analyze_wildcard\":true,\"query\":\"_\"}},\"filter\":{\"bool\":{\"must\":[{\"query\":{\"match\":{\"type\":{\"query\":\"mainlog\",\"type\":\"phrase\"}}}},{\"range\":{\"@timestamp\":{\"gte\":1469318400000,\"lte\":1469393384478}}}],\"must_not\":[]}}}},\"highlight\":{\"pre_tags\":[\"@kibana-highlighted-field@\"],\"post_tags\":[\"@/kibana-highlighted-field@\"],\"fields\":{\"*\":{}},\"fragment_size\":2147483647}}], extra_source[],\n\n(the other two instances are exactly the same with a slight variance on the time taken)\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}