[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/31945890","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-31945890","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":31945890,"node_id":"MDEyOklzc3VlQ29tbWVudDMxOTQ1ODkw","user":{"login":"uboness","id":211019,"node_id":"MDQ6VXNlcjIxMTAxOQ==","avatar_url":"https://avatars3.githubusercontent.com/u/211019?v=4","gravatar_id":"","url":"https://api.github.com/users/uboness","html_url":"https://github.com/uboness","followers_url":"https://api.github.com/users/uboness/followers","following_url":"https://api.github.com/users/uboness/following{/other_user}","gists_url":"https://api.github.com/users/uboness/gists{/gist_id}","starred_url":"https://api.github.com/users/uboness/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uboness/subscriptions","organizations_url":"https://api.github.com/users/uboness/orgs","repos_url":"https://api.github.com/users/uboness/repos","events_url":"https://api.github.com/users/uboness/events{/privacy}","received_events_url":"https://api.github.com/users/uboness/received_events","type":"User","site_admin":false},"created_at":"2014-01-09T15:58:19Z","updated_at":"2014-01-09T15:58:19Z","author_association":"CONTRIBUTOR","body":"fixed\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33057079","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33057079","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33057079,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDU3MDc5","user":{"login":"TrevRUNDSP","id":5139063,"node_id":"MDQ6VXNlcjUxMzkwNjM=","avatar_url":"https://avatars0.githubusercontent.com/u/5139063?v=4","gravatar_id":"","url":"https://api.github.com/users/TrevRUNDSP","html_url":"https://github.com/TrevRUNDSP","followers_url":"https://api.github.com/users/TrevRUNDSP/followers","following_url":"https://api.github.com/users/TrevRUNDSP/following{/other_user}","gists_url":"https://api.github.com/users/TrevRUNDSP/gists{/gist_id}","starred_url":"https://api.github.com/users/TrevRUNDSP/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrevRUNDSP/subscriptions","organizations_url":"https://api.github.com/users/TrevRUNDSP/orgs","repos_url":"https://api.github.com/users/TrevRUNDSP/repos","events_url":"https://api.github.com/users/TrevRUNDSP/events{/privacy}","received_events_url":"https://api.github.com/users/TrevRUNDSP/received_events","type":"User","site_admin":false},"created_at":"2014-01-22T19:19:21Z","updated_at":"2014-01-22T19:19:21Z","author_association":"NONE","body":"Hi all,\nI'm using the below code to try and grab the terms that have the greatest sums of field \"impression\":\n\n{\n\"size\":0,\n\"query\":{\n\"filtered\":{\n\"query\":{\"match_all\":{}},\n\"filter\":{\n\"and\":{\n\"filters\":[{\"range\":{\"date_time\":{\"from\":\"2013-12-12T00:00:00Z\",\"to\":\"2013-12-12T23:59:59Z\"}}}]\n} \n}\n}\n},\n\"aggs\":{\n\"XXXXXXXXX\" : {\n\"terms\" : { \n\"field\" : \"XXXXXXXXX.untouched\",\n\"size\" : 10,\n\"order\" : { \"Impression_summation\" : \"desc\" }\n},\n\"aggs\" : {\n\"Impression_summation\" : { \"sum\" : { \"field\" : \"impression\" } }\n}\n}\n}\n}}\n'\n\nWhile this code _does_ order by the sums of that field, it is omitting many terms that would have even greater sums. It is only after I increase the size parameter to something pretty high (10 --> 1000 in this case), does it then 'catch' the terms with the largest summations of field \"impression\". Is there other code I should be using for this or is this a bug? Thanks!\n- Trev\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33059872","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33059872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33059872,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDU5ODcy","user":{"login":"alexbrasetvik","id":43624,"node_id":"MDQ6VXNlcjQzNjI0","avatar_url":"https://avatars0.githubusercontent.com/u/43624?v=4","gravatar_id":"","url":"https://api.github.com/users/alexbrasetvik","html_url":"https://github.com/alexbrasetvik","followers_url":"https://api.github.com/users/alexbrasetvik/followers","following_url":"https://api.github.com/users/alexbrasetvik/following{/other_user}","gists_url":"https://api.github.com/users/alexbrasetvik/gists{/gist_id}","starred_url":"https://api.github.com/users/alexbrasetvik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexbrasetvik/subscriptions","organizations_url":"https://api.github.com/users/alexbrasetvik/orgs","repos_url":"https://api.github.com/users/alexbrasetvik/repos","events_url":"https://api.github.com/users/alexbrasetvik/events{/privacy}","received_events_url":"https://api.github.com/users/alexbrasetvik/received_events","type":"User","site_admin":false},"created_at":"2014-01-22T19:47:13Z","updated_at":"2014-01-22T19:47:13Z","author_association":"CONTRIBUTOR","body":"Hi Trev,\n\nYou probably want to increase the `shard_size`.\n\nHere's the relevant section in the docs: http://www.elasticsearch.org/guide/en/elasticsearch/reference/master/search-aggregations-bucket-terms-aggregation.html#_size_amp_shard_size\n\nâ€“ Alex\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33060554","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33060554","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33060554,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDYwNTU0","user":{"login":"TrevRUNDSP","id":5139063,"node_id":"MDQ6VXNlcjUxMzkwNjM=","avatar_url":"https://avatars0.githubusercontent.com/u/5139063?v=4","gravatar_id":"","url":"https://api.github.com/users/TrevRUNDSP","html_url":"https://github.com/TrevRUNDSP","followers_url":"https://api.github.com/users/TrevRUNDSP/followers","following_url":"https://api.github.com/users/TrevRUNDSP/following{/other_user}","gists_url":"https://api.github.com/users/TrevRUNDSP/gists{/gist_id}","starred_url":"https://api.github.com/users/TrevRUNDSP/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TrevRUNDSP/subscriptions","organizations_url":"https://api.github.com/users/TrevRUNDSP/orgs","repos_url":"https://api.github.com/users/TrevRUNDSP/repos","events_url":"https://api.github.com/users/TrevRUNDSP/events{/privacy}","received_events_url":"https://api.github.com/users/TrevRUNDSP/received_events","type":"User","site_admin":false},"created_at":"2014-01-22T19:53:55Z","updated_at":"2014-01-22T19:53:55Z","author_association":"NONE","body":"Excellent! I'll give that a whirl. Thanks for the help (and fast response)!\n- Trev\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33645384","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33645384","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33645384,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjQ1Mzg0","user":{"login":"benatwork99","id":970507,"node_id":"MDQ6VXNlcjk3MDUwNw==","avatar_url":"https://avatars3.githubusercontent.com/u/970507?v=4","gravatar_id":"","url":"https://api.github.com/users/benatwork99","html_url":"https://github.com/benatwork99","followers_url":"https://api.github.com/users/benatwork99/followers","following_url":"https://api.github.com/users/benatwork99/following{/other_user}","gists_url":"https://api.github.com/users/benatwork99/gists{/gist_id}","starred_url":"https://api.github.com/users/benatwork99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benatwork99/subscriptions","organizations_url":"https://api.github.com/users/benatwork99/orgs","repos_url":"https://api.github.com/users/benatwork99/repos","events_url":"https://api.github.com/users/benatwork99/events{/privacy}","received_events_url":"https://api.github.com/users/benatwork99/received_events","type":"User","site_admin":false},"created_at":"2014-01-29T23:44:49Z","updated_at":"2014-01-29T23:44:49Z","author_association":"NONE","body":"I'm using 1.0.0-RC1 and this doesn't appear to be working correctly for me for a metric sub-aggregation.\n\nIf I use the following query:\n\n```\n{\n  \"aggs\": {\n    \"fieldValues\": {\n      \"terms\": {\n        \"field\": \"name.field\",\n        \"order\": {\n          \"totalAmount\": \"desc\"\n        }\n      },\n      \"aggs\": {\n        \"totalAmount\": {\n          \"sum\": {\n            \"field\": \"amount\"\n          }\n        }\n      }\n    }\n  },\n  \"size\": 0\n}\n```\n\nIt appears to be sorted in 'asc' mode, and changing 'desc' to 'asc' produces the same results. Other than that the query does appear to work successfully and returns the expected sort of data in the buckets.\n\nChanging the order key from 'totalAmount' to '_term' works as expected, and 'asc' and 'desc' show different results.\n\nI've looked at the code for 1.0.0-RC1 and the above changes do appear to be in, was it working for you on RC1 Trev?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33649899","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33649899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33649899,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjQ5ODk5","user":{"login":"uboness","id":211019,"node_id":"MDQ6VXNlcjIxMTAxOQ==","avatar_url":"https://avatars3.githubusercontent.com/u/211019?v=4","gravatar_id":"","url":"https://api.github.com/users/uboness","html_url":"https://github.com/uboness","followers_url":"https://api.github.com/users/uboness/followers","following_url":"https://api.github.com/users/uboness/following{/other_user}","gists_url":"https://api.github.com/users/uboness/gists{/gist_id}","starred_url":"https://api.github.com/users/uboness/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uboness/subscriptions","organizations_url":"https://api.github.com/users/uboness/orgs","repos_url":"https://api.github.com/users/uboness/repos","events_url":"https://api.github.com/users/uboness/events{/privacy}","received_events_url":"https://api.github.com/users/uboness/received_events","type":"User","site_admin":false},"created_at":"2014-01-30T00:52:41Z","updated_at":"2014-01-30T00:52:41Z","author_association":"CONTRIBUTOR","body":"@benatwork99 I just indexed a few documents that fit the aggs you have above, and it seem to work as expected. Are you sure you're running it on RC1? \n\nhere's what I ran (save it to a file `test_aggs.sh`):\n\n``` bash\ncurl -XDELETE 'http://localhost:9200/idx?pretty'; echo;\n\nfor i in {1..3}\ndo\n  curl -XPOST 'http://localhost:9200/idx/type&pretty' -d '{\n    \"name\" : {\n      \"field\" : \"val1\"\n    },\n    \"amount\" : '$i'\n  }'; echo;\ndone\n\nfor i in {1..2}\ndo\n  curl -XPOST 'http://localhost:9200/idx/type&pretty' -d '{\n    \"name\" : {\n      \"field\" : \"val2\"\n    },\n    \"amount\" : '$i'\n  }'; echo;\ndone\n\n\nsleep 3s; ehco;\n\ndir=$1\n\necho 'executing search ('$dir')';\n\ncurl -XGET 'http://localhost:9200/idx/_search?search_type=count&pretty' -d '{\n  \"aggs\": {\n    \"fieldValues\": {\n      \"terms\": {\n        \"field\": \"name.field\",\n        \"order\": {\n          \"totalAmount\": \"'$dir'\"\n        }\n      },\n      \"aggs\": {\n        \"totalAmount\": {\n          \"sum\": {\n            \"field\": \"amount\"\n          }\n        }\n      }\n    }\n  }\n}'; echo;\n```\n\ndesc order : `./test_aggs.sh desc`\nasc order: `./test_aggs.sh asc`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33656895","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33656895","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33656895,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjU2ODk1","user":{"login":"benatwork99","id":970507,"node_id":"MDQ6VXNlcjk3MDUwNw==","avatar_url":"https://avatars3.githubusercontent.com/u/970507?v=4","gravatar_id":"","url":"https://api.github.com/users/benatwork99","html_url":"https://github.com/benatwork99","followers_url":"https://api.github.com/users/benatwork99/followers","following_url":"https://api.github.com/users/benatwork99/following{/other_user}","gists_url":"https://api.github.com/users/benatwork99/gists{/gist_id}","starred_url":"https://api.github.com/users/benatwork99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benatwork99/subscriptions","organizations_url":"https://api.github.com/users/benatwork99/orgs","repos_url":"https://api.github.com/users/benatwork99/repos","events_url":"https://api.github.com/users/benatwork99/events{/privacy}","received_events_url":"https://api.github.com/users/benatwork99/received_events","type":"User","site_admin":false},"created_at":"2014-01-30T03:14:17Z","updated_at":"2014-01-30T03:14:17Z","author_association":"NONE","body":"Thank you very much for the detailed reply uboness. If I download the vanilla RC1 distribution and run your query against it, I can confirm that it works as intended. Our version is part of a larger build and configuration process, it's definitely RC1 but there's obviously something else - distribution or configuration - affecting it.\n\nI'm looking in to this now trying to understand what's different, will post back as soon as I can figure it out, and hopefully this won't have been just a waste of time for you!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33657010","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33657010","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33657010,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjU3MDEw","user":{"login":"uboness","id":211019,"node_id":"MDQ6VXNlcjIxMTAxOQ==","avatar_url":"https://avatars3.githubusercontent.com/u/211019?v=4","gravatar_id":"","url":"https://api.github.com/users/uboness","html_url":"https://github.com/uboness","followers_url":"https://api.github.com/users/uboness/followers","following_url":"https://api.github.com/users/uboness/following{/other_user}","gists_url":"https://api.github.com/users/uboness/gists{/gist_id}","starred_url":"https://api.github.com/users/uboness/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uboness/subscriptions","organizations_url":"https://api.github.com/users/uboness/orgs","repos_url":"https://api.github.com/users/uboness/repos","events_url":"https://api.github.com/users/uboness/events{/privacy}","received_events_url":"https://api.github.com/users/uboness/received_events","type":"User","site_admin":false},"created_at":"2014-01-30T03:18:08Z","updated_at":"2014-01-30T03:18:08Z","author_association":"CONTRIBUTOR","body":"@benatwork99 ok, cool, keep us posted (and it's definitely not a waste of our time... we're here to make it work :))\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33658147","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33658147","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33658147,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjU4MTQ3","user":{"login":"benatwork99","id":970507,"node_id":"MDQ6VXNlcjk3MDUwNw==","avatar_url":"https://avatars3.githubusercontent.com/u/970507?v=4","gravatar_id":"","url":"https://api.github.com/users/benatwork99","html_url":"https://github.com/benatwork99","followers_url":"https://api.github.com/users/benatwork99/followers","following_url":"https://api.github.com/users/benatwork99/following{/other_user}","gists_url":"https://api.github.com/users/benatwork99/gists{/gist_id}","starred_url":"https://api.github.com/users/benatwork99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benatwork99/subscriptions","organizations_url":"https://api.github.com/users/benatwork99/orgs","repos_url":"https://api.github.com/users/benatwork99/repos","events_url":"https://api.github.com/users/benatwork99/events{/privacy}","received_events_url":"https://api.github.com/users/benatwork99/received_events","type":"User","site_admin":false},"created_at":"2014-01-30T03:49:50Z","updated_at":"2014-01-30T03:49:50Z","author_association":"NONE","body":"Aha! Ok turned out our test and dev setups use a single shard - setting\n\n```\nindex.number_of_shards: 1\n```\n\nin elasticsearch.yml.\n\nWith this set to 1, I see ordering by the metric sub aggregate always sorting in ascending order! Leaving it blank (or setting it to 2 or higher) means that the descending order works as expected.\n\nSo, I think that's a bug. At least I wasn't doing something daft ;) Do you want me to create a separate issue on it?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/33660371","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-33660371","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":33660371,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNjYwMzcx","user":{"login":"uboness","id":211019,"node_id":"MDQ6VXNlcjIxMTAxOQ==","avatar_url":"https://avatars3.githubusercontent.com/u/211019?v=4","gravatar_id":"","url":"https://api.github.com/users/uboness","html_url":"https://github.com/uboness","followers_url":"https://api.github.com/users/uboness/followers","following_url":"https://api.github.com/users/uboness/following{/other_user}","gists_url":"https://api.github.com/users/uboness/gists{/gist_id}","starred_url":"https://api.github.com/users/uboness/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uboness/subscriptions","organizations_url":"https://api.github.com/users/uboness/orgs","repos_url":"https://api.github.com/users/uboness/repos","events_url":"https://api.github.com/users/uboness/events{/privacy}","received_events_url":"https://api.github.com/users/uboness/received_events","type":"User","site_admin":false},"created_at":"2014-01-30T04:58:24Z","updated_at":"2014-01-30T04:58:24Z","author_association":"CONTRIBUTOR","body":"@benatwork99 yep.. indeed a bug... opened an issue for it, will be fixed shortly. Thanks! (see.. no waste of time :))\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/34028028","html_url":"https://github.com/elastic/elasticsearch/issues/4643#issuecomment-34028028","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4643","id":34028028,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MDI4MDI4","user":{"login":"andrewreedy","id":386447,"node_id":"MDQ6VXNlcjM4NjQ0Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/386447?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewreedy","html_url":"https://github.com/andrewreedy","followers_url":"https://api.github.com/users/andrewreedy/followers","following_url":"https://api.github.com/users/andrewreedy/following{/other_user}","gists_url":"https://api.github.com/users/andrewreedy/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewreedy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewreedy/subscriptions","organizations_url":"https://api.github.com/users/andrewreedy/orgs","repos_url":"https://api.github.com/users/andrewreedy/repos","events_url":"https://api.github.com/users/andrewreedy/events{/privacy}","received_events_url":"https://api.github.com/users/andrewreedy/received_events","type":"User","site_admin":false},"created_at":"2014-02-04T03:40:12Z","updated_at":"2014-02-04T03:40:12Z","author_association":"NONE","body":"@uboness I'm seeing an issue with sorting by sub-agg when two of the values equal each other.. for example: Doc 1 and 2 work fine but with Doc 3 it will throw NPE.\n\n#### Mapping\n\n```\n{\n    \"bid\" : {\n        \"properties\" : {\n            \"bid_price\" : {\n                \"type\" : \"float\"   \n            }, \n           \"company_id\" : {\n                \"type\" : \"string\",\n                \"index\" : \"not_analyzed\"\n            },\n           \"bid_id\" : {\n                \"type\" : \"string\",\n                \"index\" : \"not_analyzed\"\n            }\n        }\n    }\n}\n```\n\n#### Doc 1\n\n```\n{\n    \"bid_price\" : 7.0, \n    \"company_id\" : \"7\",\n    \"bid_id\": \"11\"\n}\n```\n\n#### Doc 2\n\n```\n{\n    \"bid_price\" : 6.0, \n    \"company_id\" : \"6\",\n    \"bid_id\": \"11\"\n}\n```\n\n#### Doc 3\n\n```\n{\n    \"bid_price\" : 7.0, \n    \"company_id\" : \"6\",\n    \"bid_id\": \"11\"\n}\n```\n\n#### Agg\n\n```\n  \"aggs\" : {\n        \"company_id\" : {\n            \"terms\" : { \n                \"field\" : \"company_id\",\n                \"order\": {\n                    \"max_bid\": \"desc\"\n                }\n            },\n            \"aggs\" : {\n                \"bid_id\" : {\n                    \"terms\" : { \n                        \"field\" : \"bid_id\",\n                        \"order\": {\n                            \"company_max_bid\": \"desc\"\n                        },\n                        \"size\"  : 1\n                    },\n                    \"aggs\" : {\n                        \"company_max_bid\": {\n                            \"max\": {\n                                \"field\": \"bid_price\"\n                            }\n                        }   \n                    }\n                },\n                \"max_bid\": {\n                    \"max\": {\n                        \"field\": \"bid_price\"\n                    }\n                }\n            }\n        }\n    }\n```\n\n#### Result\n\n```\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 4,\n      \"failed\": 1,\n      \"failures\": [\n         {\n            \"index\": \"bids_02-03-14\",\n            \"shard\": 0,\n            \"status\": 500,\n            \"reason\": \"NullPointerException[null]\"\n         }\n      ]\n   }\n```\n","performed_via_github_app":null}]