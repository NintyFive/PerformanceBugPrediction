{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18499","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18499/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18499/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18499/events","html_url":"https://github.com/elastic/elasticsearch/issues/18499","id":156035922,"node_id":"MDU6SXNzdWUxNTYwMzU5MjI=","number":18499,"title":"Incorrect results for nested cardinality aggregations","user":{"login":"chrisdrusso","id":4182524,"node_id":"MDQ6VXNlcjQxODI1MjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/4182524?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisdrusso","html_url":"https://github.com/chrisdrusso","followers_url":"https://api.github.com/users/chrisdrusso/followers","following_url":"https://api.github.com/users/chrisdrusso/following{/other_user}","gists_url":"https://api.github.com/users/chrisdrusso/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisdrusso/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisdrusso/subscriptions","organizations_url":"https://api.github.com/users/chrisdrusso/orgs","repos_url":"https://api.github.com/users/chrisdrusso/repos","events_url":"https://api.github.com/users/chrisdrusso/events{/privacy}","received_events_url":"https://api.github.com/users/chrisdrusso/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-05-20T19:35:31Z","updated_at":"2016-06-01T16:11:05Z","closed_at":"2016-05-23T08:24:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: \n2.3.0\n\n**JVM version**: \n1.8.0_40\n1.8.0_91\n\n**OS version**: \nWindows 10\n\n**Description of the problem including expected versus actual behavior**:\nWhen nesting aggregations of term cardinality (unique counts of terms in Kibana), the results are often incorrect.  Depending on the data, sometimes the result is higher than it should be, other times it is lower than it should be.  When the nesting is removed, the results for a single aggregation of term cardinality is correct.  \n\nIn the following example, the results show 8 distinct values for field3, but there are only 7 unique values for field3.  \n\n**Steps to reproduce**:\n1. Index the following data:\n   `POST test/_bulk\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"1\"}\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"2\"}\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"3\"}\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"4\"}\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"5\"}\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"6\"}\n   {\"index\":{\"_index\":\"test\",\"_type\":\"test\"}}\n   {\"field1\":\"A\",\"field2\":\"B\",\"field3\":\"7\"}`\n2. Run the following aggregation query:\n   `POST test/_search\n   {\n   \"query\": {\n     \"filtered\": {\n       \"query\": {\n         \"query_string\": {\n           \"analyze_wildcard\": true,\n           \"query\": \"*\"\n         }\n       },\n       \"filter\": {\n         \"bool\": {\n           \"must\": [\n             {\n               \"query\": {\n                 \"query_string\": {\n                   \"analyze_wildcard\": true,\n                   \"query\": \"*\"\n                 }\n               }\n             }\n           ],\n           \"must_not\": []\n         }\n       }\n     }\n   },\n   \"size\": 0,\n   \"aggs\": {\n     \"3\": {\n       \"terms\": {\n         \"field\": \"field1\",\n         \"size\": 0,\n         \"order\": {\n           \"_term\": \"asc\"\n         }\n       },\n       \"aggs\": {\n         \"4\": {\n           \"terms\": {\n             \"field\": \"field2\",\n             \"size\": 0,\n             \"order\": {\n               \"_term\": \"asc\"\n             }\n           },\n           \"aggs\": {\n             \"1\": {\n               \"cardinality\": {\n                 \"field\": \"field3\"\n               }\n             }\n           }\n         }\n       }\n     }\n   }\n   }`\n\n**Provide logs (if relevant)**:\nNothing in the logs.\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}