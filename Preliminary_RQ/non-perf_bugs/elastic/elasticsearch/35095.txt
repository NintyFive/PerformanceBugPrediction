{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35095","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35095/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35095/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35095/events","html_url":"https://github.com/elastic/elasticsearch/issues/35095","id":375580829,"node_id":"MDU6SXNzdWUzNzU1ODA4Mjk=","number":35095,"title":"Add dual TLS/Plaintext networking support","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"labels":[{"id":912838655,"node_id":"MDU6TGFiZWw5MTI4Mzg2NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Network","name":":Security/Network","color":"0e8a16","default":false,"description":"SSL/TLS, Security for NIO/Netty"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"assignees":[{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2018-10-30T16:29:24Z","updated_at":"2019-02-28T19:17:13Z","closed_at":"2019-02-28T19:17:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Currently we do not offer a straightforward way to enable security on a cluster without doing a full cluster restart. This is because a cluster cannot communicate when half of it is plaintext and half of it is TLS.\r\n\r\nWe can support both TLS and plaintext communications on new nodes that have enabled security. This would allow a rolling restart when enabling security.\r\n\r\nThere solution is:\r\n\r\n1. On incoming connections, check if the first incoming bytes are 'E', 'S'. These bytes do not overlap with TLS bytes. If the first bytes are 'E', 'S' then it is a plaintext connection. Otherwise assume it is TLS.\r\n2. On outgoing connections, attempt to open a TLS connection. If the other node is plaintext that connection will fail quickly. If the connection fails, attempt a plaintext connection. \r\n\r\nThere are two tricky parts of this issue:\r\n\r\n1. Normally we do not want to allow dual stack. @jaymode and I discussed a number of potential solutions and we were struggling to find a good one. We could add some type of dynamic setting that indicates if dual stack is supported. However, there are a number of failure scenarios here as a restarted node with security NEEDS to know if it supports plaintext before joining a cluster. To ensure that the restarted node knows this, the customer would need to add this setting to each of the nodes yml files. And then they have to update the setting (once the rolling restart is complete) to disable this functionality.\r\n\r\n2. We also need to have some type of reaper process that will kill plaintext connections once the dual stack is disabled. This is problematic as it is possible that a connection is open, but we have not yet identified if it is plaintext. I think in this scenario we just want to kill the connection anyway. We could also check on every channel read/write on a dual stack plaintext channel if the dual stack networking is still enabled. \r\n\r\nI think we need to discuss the best approach to the first issue. I can probably resolve the second one once we know how we are approaching the enablement of this functionality.\r\n\r\n@s1monw @jaymode ","closed_by":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"performed_via_github_app":null}