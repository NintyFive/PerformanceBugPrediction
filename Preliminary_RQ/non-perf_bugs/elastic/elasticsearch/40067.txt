{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40067","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40067/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40067/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40067/events","html_url":"https://github.com/elastic/elasticsearch/issues/40067","id":421199306,"node_id":"MDU6SXNzdWU0MjExOTkzMDY=","number":40067,"title":"CCS: field collapsing doesn't work when minimizing roundtrips and remote index is empty","user":{"login":"chrisronline","id":56682,"node_id":"MDQ6VXNlcjU2Njgy","avatar_url":"https://avatars1.githubusercontent.com/u/56682?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisronline","html_url":"https://github.com/chrisronline","followers_url":"https://api.github.com/users/chrisronline/followers","following_url":"https://api.github.com/users/chrisronline/following{/other_user}","gists_url":"https://api.github.com/users/chrisronline/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisronline/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisronline/subscriptions","organizations_url":"https://api.github.com/users/chrisronline/orgs","repos_url":"https://api.github.com/users/chrisronline/repos","events_url":"https://api.github.com/users/chrisronline/events{/privacy}","received_events_url":"https://api.github.com/users/chrisronline/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-03-14T19:16:44Z","updated_at":"2019-03-18T11:23:45Z","closed_at":"2019-03-18T11:23:45Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): latest master snapshot (hash: `8839a72`)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): `java version \"11.0.1\" 2018-10-16 LTS`\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Darwin Kernel Version 18.2.0`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen performing a CCS search request, an error occurs if there is field collapsing in the query.\r\n\r\nThe exact error is:\r\n```\r\njava.lang.ArrayStoreException: arraycopy: element type mismatch: can not cast one of the elements of java.lang.Object[] to the type of the destination array, org.apache.lucene.search.grouping.CollapseTopFieldDocs\r\n\tat java.util.ArrayList.toArray(ArrayList.java:432) ~[?:?]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.mergeTopDocs(SearchPhaseController.java:236) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchResponseMerger.getMergedResponse(SearchResponseMerger.java:190) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.TransportSearchAction$3.createFinalResponse(TransportSearchAction.java:389) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.TransportSearchAction$3.createFinalResponse(TransportSearchAction.java:379) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Start two ES instances, ensuring they have unique `cluster.name`s\r\n2. Configure one ES instance to talk to the other through CCS\r\n```\r\nPOST _cluster/settings\r\n{\r\n  \"persistent\": {\r\n    \"cluster\": {\r\n      \"remote\": {\r\n        \"other\": {\r\n          \"seeds\": [\r\n            \"{other_es_instance_address}\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n3. Put data in the an index on the ES cluster you ran the above query:\r\n```\r\nPOST _bulk\r\n{ \"index\": { \"_index\": \"sales\" } }\r\n{ \"price\": 30, \"payment_type\": \"credit_card\" }\r\n{ \"index\": { \"_index\": \"sales\" } }\r\n{ \"price\": 40, \"payment_type\": \"cash\" }\r\n```\r\n4. **DO NOT** put any data into the other ES cluster\r\n5. Perform a CCS search that uses field collapsing from the same ES instance\r\n```\r\nPOST *:sales*,sales*/_search\r\n{\r\n  \"collapse\": {\r\n    \"field\": \"payment_type.keyword\"\r\n  }\r\n}\r\n```\r\n\r\nThis error also happens if you modify step 4 to *only* put the index (but do not index documents into it) on the other ES instance:\r\n```\r\nPUT sales\r\n{\r\n  \"mappings\": {\r\n    \"properties\" : {\r\n      \"payment_type\" : {\r\n        \"type\" : \"text\",\r\n        \"fields\" : {\r\n          \"keyword\" : {\r\n            \"type\" : \"keyword\",\r\n            \"ignore_above\" : 256\r\n          }\r\n        }\r\n      },\r\n      \"price\" : {\r\n        \"type\" : \"long\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe error *DOES NOT* happen if you actually index documents into the index on the other ES cluster:\r\n```\r\nPOST _bulk\r\n{ \"index\": { \"_index\": \"sales\" } }\r\n{ \"price\": 30, \"payment_type\": \"credit_card\" }\r\n{ \"index\": { \"_index\": \"sales\" } }\r\n{ \"price\": 40, \"payment_type\": \"cash\" }\r\n\r\n```\r\n\r\nThis is currently **BREAKING** the Kibana Stack Monitoring app, as we run these sorts of field collapsing which are currently broken with CCS enabled.\r\n\r\nRelated to #40059","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}