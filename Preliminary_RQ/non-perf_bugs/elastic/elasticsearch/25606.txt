{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25606","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25606/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25606/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25606/events","html_url":"https://github.com/elastic/elasticsearch/issues/25606","id":241335620,"node_id":"MDU6SXNzdWUyNDEzMzU2MjA=","number":25606,"title":"Cross cluster aggregations don't include cluster alias in _index","user":{"login":"spalger","id":1329312,"node_id":"MDQ6VXNlcjEzMjkzMTI=","avatar_url":"https://avatars1.githubusercontent.com/u/1329312?v=4","gravatar_id":"","url":"https://api.github.com/users/spalger","html_url":"https://github.com/spalger","followers_url":"https://api.github.com/users/spalger/followers","following_url":"https://api.github.com/users/spalger/following{/other_user}","gists_url":"https://api.github.com/users/spalger/gists{/gist_id}","starred_url":"https://api.github.com/users/spalger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spalger/subscriptions","organizations_url":"https://api.github.com/users/spalger/orgs","repos_url":"https://api.github.com/users/spalger/repos","events_url":"https://api.github.com/users/spalger/events{/privacy}","received_events_url":"https://api.github.com/users/spalger/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":654498781,"node_id":"MDU6TGFiZWw2NTQ0OTg3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.0-beta1","name":"v6.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2017-07-07T17:55:03Z","updated_at":"2017-12-12T09:48:27Z","closed_at":"2017-07-26T07:16:53Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version**: master\r\n**Plugins installed**: none\r\n**JVM version**: 1.8.0_121\r\n**OS version**: macOS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen running a search on a remote cluster, remote documents include the cluster alias in the `_index` field so that the document can be properly addressed. This behavior does not apply to aggregations. When doing a `terms` agg on `_index` for instance, the terms do not include the cluster alias. The `top_hits` agg also doesn't enhance `_index` with the cluster alias.\r\n\r\n**Steps to reproduce**:\r\n 1. Start a node that remotes to itself\r\n\r\n     ```sh\r\n     ./bin/elasticsearch -E search.remote.local.seeds=localhost:9300\r\n     ```\r\n\r\n 2. Index a document\r\n\r\n      ```sh\r\n      curl -XPOST \"http://localhost:9200/index/doc/id\" -H 'Content-Type: application/json' -d'\r\n      {\r\n        \"foo\": \"bar\"\r\n      }'\r\n      ```\r\n\r\n 3. Execute a search for the document via local and remote index names, which results in two unique documents (correct behavior) but one index term in the aggs and what appears to be two identical `top_hits`\r\n\r\n      ```sh\r\n    curl -XPOST \"http://localhost:9200/index,local:index/_search\" -H 'Content-Type: application/json' -d'\r\n      {\r\n        \"aggs\": {\r\n          \"indices\": {\r\n            \"terms\": {\r\n              \"field\": \"_index\"\r\n            },\r\n            \"aggs\": {\r\n              \"hits\": {\r\n                \"top_hits\": {\r\n                  \"size\": 10\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }'\r\n      ```\r\n\r\n      results:\r\n      ```json\r\n      {\r\n        \"took\": 7,\r\n        \"timed_out\": false,\r\n        \"_shards\": {\r\n          \"total\": 10,\r\n          \"successful\": 10,\r\n          \"failed\": 0\r\n        },\r\n        \"hits\": {\r\n          \"total\": 2,\r\n          \"max_score\": 1,\r\n          \"hits\": [\r\n            {\r\n              \"_index\": \"index\",\r\n              \"_type\": \"doc\",\r\n              \"_id\": \"id\",\r\n              \"_score\": 1,\r\n              \"_source\": {\r\n                \"foo\": \"bar\"\r\n              }\r\n            },\r\n            {\r\n              \"_index\": \"local:index\",\r\n              \"_type\": \"doc\",\r\n              \"_id\": \"id\",\r\n              \"_score\": 1,\r\n              \"_source\": {\r\n                \"foo\": \"bar\"\r\n              }\r\n            }\r\n          ]\r\n        },\r\n        \"aggregations\": {\r\n          \"indices\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": \"index\",\r\n                \"doc_count\": 2,\r\n                \"hits\": {\r\n                  \"hits\": {\r\n                    \"total\": 2,\r\n                    \"max_score\": 1,\r\n                    \"hits\": [\r\n                      {\r\n                        \"_index\": \"index\",\r\n                        \"_type\": \"doc\",\r\n                        \"_id\": \"id\",\r\n                        \"_score\": 1,\r\n                        \"_source\": {\r\n                          \"foo\": \"bar\"\r\n                        }\r\n                      },\r\n                      {\r\n                        \"_index\": \"index\",\r\n                        \"_type\": \"doc\",\r\n                        \"_id\": \"id\",\r\n                        \"_score\": 1,\r\n                        \"_source\": {\r\n                          \"foo\": \"bar\"\r\n                        }\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n      ```\r\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}