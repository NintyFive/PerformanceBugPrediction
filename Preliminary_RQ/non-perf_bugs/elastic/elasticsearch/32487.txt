{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32487","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32487/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32487/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32487/events","html_url":"https://github.com/elastic/elasticsearch/issues/32487","id":346057092,"node_id":"MDU6SXNzdWUzNDYwNTcwOTI=","number":32487,"title":"[CI] SslIntegrationTests fail with Netty buffer leak","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":912838655,"node_id":"MDU6TGFiZWw5MTI4Mzg2NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Network","name":":Security/Network","color":"0e8a16","default":false,"description":"SSL/TLS, Security for NIO/Netty"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-07-31T06:50:38Z","updated_at":"2018-08-01T00:34:59Z","closed_at":"2018-08-01T00:34:59Z","author_association":"MEMBER","active_lock_reason":null,"body":"Build failure link: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+matrix-java-periodic/ES_BUILD_JAVA=java10,ES_RUNTIME_JAVA=java11,nodes=virtual&&linux/208/console\r\n\r\nBuild failure:\r\n\r\n```\r\n   > Expected: an empty collection\r\n   >      but: <[LEAK: ByteBuf.release() was not called before it's garbage-collected. See http://netty.io/wiki/reference-counted-objects.html for more information.\r\n   > WARNING: 4 leak records were discarded because the leak record count is limited to 4. Use system property io.netty.leakDetection.maxRecords to increase the limit.\r\n   > Recent access records: 4\r\n   > #4:\r\n   >    io.netty.buffer.AdvancedLeakAwareByteBuf.internalNioBuffer(AdvancedLeakAwareByteBuf.java:732)\r\n[...]\r\n   >    io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)\r\n   >    java.base/java.lang.Thread.run(Thread.java:834)\r\n   > #3:\r\n   >    io.netty.buffer.AdvancedLeakAwareByteBuf.nioBufferCount(AdvancedLeakAwareByteBuf.java:702)\r\n   >    io.netty.handler.ssl.SslHandler.wrap(SslHandler.java:927)\r\n   >    io.netty.handler.ssl.SslHandler.wrap(SslHandler.java:762)\r\n   >    io.netty.handler.ssl.SslHandler.wrapAndFlush(SslHandler.java:731)\r\n   >    io.netty.handler.ssl.SslHandler.flush(SslHandler.java:712)\r\n[...]\r\n   >    java.base/java.lang.Thread.run(Thread.java:834)\r\n   > #2:\r\n   >    io.netty.buffer.AdvancedLeakAwareByteBuf.nioBufferCount(AdvancedLeakAwareByteBuf.java:702)\r\n   >    io.netty.handler.ssl.SslHandler.wrap(SslHandler.java:759)\r\n   >    io.netty.handler.ssl.SslHandler.wrapAndFlush(SslHandler.java:731)\r\n   >    io.netty.handler.ssl.SslHandler.flush(SslHandler.java:712)\r\n[...]\r\n   >    java.base/java.lang.Thread.run(Thread.java:834)\r\n   > #1:\r\n   >    io.netty.buffer.AdvancedLeakAwareByteBuf.writeBytes(AdvancedLeakAwareByteBuf.java:588)\r\n   >    io.netty.handler.ssl.SslHandler$SslHandlerCoalescingBufferQueue.composeFirst(SslHandler.java:1831)\r\n   >    io.netty.channel.AbstractCoalescingBufferQueue.remove(AbstractCoalescingBufferQueue.java:154)\r\n   >    io.netty.handler.ssl.SslHandler.wrap(SslHandler.java:752)\r\n   >    io.netty.handler.ssl.SslHandler.wrapAndFlush(SslHandler.java:731)\r\n   >    io.netty.handler.ssl.SslHandler.flush(SslHandler.java:712)\r\n[...]\r\n   >    io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)\r\n   >    java.base/java.lang.Thread.run(Thread.java:834)\r\n   > Created at:\r\n   >    io.netty.buffer.PooledByteBufAllocator.newDirectBuffer(PooledByteBufAllocator.java:331)\r\n   >    io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:181)\r\n   >    io.netty.buffer.AbstractByteBufAllocator.directBuffer(AbstractByteBufAllocator.java:172)\r\n   >    io.netty.handler.ssl.SslHandler$SslHandlerCoalescingBufferQueue.composeFirst(SslHandler.java:1830)\r\n   >    io.netty.channel.AbstractCoalescingBufferQueue.remove(AbstractCoalescingBufferQueue.java:154)\r\n   >    io.netty.handler.ssl.SslHandler.wrap(SslHandler.java:752)\r\n   >    io.netty.handler.ssl.SslHandler.wrapAndFlush(SslHandler.java:731)\r\n   >    io.netty.handler.ssl.SslHandler.flush(SslHandler.java:712)\r\n[...]\r\n   >    java.base/java.lang.Thread.run(Thread.java:834)]>\r\n```\r\n\r\nReproduces locally with:\r\n\r\n```\r\n./gradlew :x-pack:plugin:security:test -Dtests.seed=28197402351DB64D -Dtests.class=org.elasticsearch.xpack.security.transport.ssl.SslIntegrationTests -Dtests.method=\"testThatUnconfiguredCiphersAreRejected\" -Dtests.security.manager=true -Dtests.locale=fr-MC -Dtests.timezone=SystemV/MST7\r\n```\r\n\r\nNote that one other test failed  as well in the same test run but as the underlying cause appears to be the same I just created one ticket.\r\n\r\nHere are all reproduction lines:\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :x-pack:plugin:security:test \\\r\n  -Dtests.seed=28197402351DB64D \\\r\n  -Dtests.class=org.elasticsearch.xpack.security.transport.ssl.SslIntegrationTests \\\r\n  -Dtests.method=\"testThatTransportClientUsingSSLv3ProtocolIsRejected\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=fr-MC \\\r\n  -Dtests.timezone=SystemV/MST7\r\n\r\nREPRODUCE WITH: ./gradlew :x-pack:plugin:security:test \\\r\n  -Dtests.seed=28197402351DB64D \\\r\n  -Dtests.class=org.elasticsearch.xpack.security.transport.ssl.SslIntegrationTests \\\r\n  -Dtests.method=\"testThatUnconfiguredCiphersAreRejected\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=fr-MC \\\r\n  -Dtests.timezone=SystemV/MST7\r\n```","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}