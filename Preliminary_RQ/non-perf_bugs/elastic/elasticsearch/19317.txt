{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19317","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19317/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19317/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19317/events","html_url":"https://github.com/elastic/elasticsearch/issues/19317","id":164423264,"node_id":"MDU6SXNzdWUxNjQ0MjMyNjQ=","number":19317,"title":"Use output of rescoring when top hits aggregation is used","user":{"login":"ebernhardson","id":558434,"node_id":"MDQ6VXNlcjU1ODQzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/558434?v=4","gravatar_id":"","url":"https://api.github.com/users/ebernhardson","html_url":"https://github.com/ebernhardson","followers_url":"https://api.github.com/users/ebernhardson/followers","following_url":"https://api.github.com/users/ebernhardson/following{/other_user}","gists_url":"https://api.github.com/users/ebernhardson/gists{/gist_id}","starred_url":"https://api.github.com/users/ebernhardson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ebernhardson/subscriptions","organizations_url":"https://api.github.com/users/ebernhardson/orgs","repos_url":"https://api.github.com/users/ebernhardson/repos","events_url":"https://api.github.com/users/ebernhardson/events{/privacy}","received_events_url":"https://api.github.com/users/ebernhardson/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-07-07T22:40:11Z","updated_at":"2020-08-12T15:36:40Z","closed_at":"2016-10-20T10:50:49Z","author_association":"NONE","active_lock_reason":null,"body":"**Describe the feature**:\n\nWhen using the top_hits aggregation it is sorting by the scores prior to rescore running. I put together an trimmed down example script that demonstrates this. The score from the main query is returned as 2.6434526, but the score as seen in top_hits aggregation is 1.\n\nThe larger goal is to perform a search over a geographic area, take the top N (we use 8192) hits per shard, and then show the top M hits per grid point. While the example below uses a match_all for simplicity with a 10km area, the query could just as well be run with a query_string query, additional filters, and over a much larger area. I would like to keep the original limits put in place in the rescore phase and only aggregate over those 8k results per shard.  Utilizing the result of rescoring is incredibly important for choosing the best items per grid point in my use case.\n\n```\n#!/bin/sh\n\ncurl -s -XDELETE localhost:9200/top_hits_rescore | jq -c .\ncurl -s -XPUT localhost:9200/top_hits_rescore/ -d '{\n  \"settings\": {\n    \"index\": {\n      \"number_of_shards\": 1,\n      \"number_of_replicas\": 0\n    }\n  }\n}' | jq -c .;\n\ncurl -s -XPUT localhost:9200/top_hits_rescore/_mapping/page -d '{\n  \"properties\": {\n    \"title\": { \"type\": \"string\" },\n    \"weight\": { \"type\": \"long\" },\n    \"coord\": { \"type\": \"geo_point\", \"lat_lon\": true }\n  }\n}' | jq -c .\n\ncurl -s -XPOST localhost:9200/top_hits_rescore/page/ -d '{\n  \"title\": \"foo\",\n  \"weight\": 42,\n  \"coord\": { \"lat\": 1.2345, \"lon\": 5.4321 }\n}' | jq -c .\n\ncurl -s -XPOST localhost:9200/top_hits_rescore/_flush | jq -c .\n\ncurl -s -XGET localhost:9200/top_hits_rescore/page/_search -d '{\n  \"rescore\": [\n    {\n      \"query\": {\n        \"rescore_query\": {\n          \"function_score\": {\n            \"functions\": [ {\n              \"field_value_factor\": {\n                \"modifier\": \"log2p\",\n                \"field\": \"weight\"\n              }\n            } ]\n          }\n        }\n      }\n    }\n  ],\n  \"query\": {\n    \"bool\": {\n      \"must\": [ { \"match_all\": {} } ],\n      \"filter\": [ {\n        \"geo_distance\": {\n          \"distance\": \"10km\",\n          \"coord\": { \"lat\": 1.2345, \"lon\": 5.4321 }\n        }\n      } ]\n    }\n  },\n  \"aggs\": {\n    \"grid\": {\n      \"geohash_grid\": { \"field\": \"coord\" },\n      \"aggs\": {\n        \"top_grid_hits\": { \"top_hits\": {} }\n      }\n    }\n  }\n}' | jq .\n```\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}