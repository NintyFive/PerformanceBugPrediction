{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20182","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20182/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20182/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20182/events","html_url":"https://github.com/elastic/elasticsearch/issues/20182","id":173496519,"node_id":"MDU6SXNzdWUxNzM0OTY1MTk=","number":20182,"title":"Provide better URIBuilder for RestClient","user":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"labels":[{"id":407508641,"node_id":"MDU6TGFiZWw0MDc1MDg2NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20Low%20Level%20REST%20Client","name":":Core/Features/Java Low Level REST Client","color":"0e8a16","default":false,"description":"Minimal dependencies Java Client for Elasticsearch"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2016-08-26T16:50:55Z","updated_at":"2016-09-16T10:01:27Z","closed_at":"2016-09-16T10:01:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"The `URIBuilder` that comes with the `RestClient` (by way of the `HttpClient`) is goofy with how it decides to parse `URI`s, specifically surrounding underscores, which can create a trappy experience. (In fairness, it just wraps the `URI` class itself, but chooses not to workaround any of _its_ weirdness)\n\nThis creates a lot of unexpected scenarios, like:\n\n``` java\nfinal URIBuilder builder = new URIBuilder(\"_prefix.domain\");\n\nif (builder.getPort() == -1) {\n  builder.setPort(9200);\n}\n```\n\nFor starters, the `scheme` is missing and it won't provide it. But more troublesome, is that the `_` will cause the `builder.getHost()` to be `null` and you can't tell that it actually knows what it is _unless_ you build the `URI` and manually parse the `uri.getRawAuthority()`. _Even worse_, the authority will consume the port if it's supplied, so when setting the port, it throws away the authority:\n\n``` java\nfinal URIBuilder builder = new URIBuilder(\"http://_prefix.domain:9200\");\n\nif (builder.getPort() == -1) {\n  builder.setPort(9200);\n}\n```\n\nThe port _will_ be `-1`, but the authority will be `_prefix.domain:9200`. So, when the code goes along defaulting the port, it will create an invalid URL, which throws an unexpected exception.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}