{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11439/events","html_url":"https://github.com/elastic/elasticsearch/issues/11439","id":83092704,"node_id":"MDU6SXNzdWU4MzA5MjcwNA==","number":11439,"title":"Index Corrupted when upgrading from Java7u67 to Java7u80","user":{"login":"marcelog","id":527356,"node_id":"MDQ6VXNlcjUyNzM1Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/527356?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelog","html_url":"https://github.com/marcelog","followers_url":"https://api.github.com/users/marcelog/followers","following_url":"https://api.github.com/users/marcelog/following{/other_user}","gists_url":"https://api.github.com/users/marcelog/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelog/subscriptions","organizations_url":"https://api.github.com/users/marcelog/orgs","repos_url":"https://api.github.com/users/marcelog/repos","events_url":"https://api.github.com/users/marcelog/events{/privacy}","received_events_url":"https://api.github.com/users/marcelog/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2015-05-31T13:45:35Z","updated_at":"2015-06-14T20:18:20Z","closed_at":"2015-06-02T11:21:21Z","author_association":"NONE","active_lock_reason":null,"body":"Hi guys,\n\nI decided to open an issue here to see if this might be an issue that is affecting more people or just us. Everything is described here: [https://discuss.elastic.co/t/how-safe-is-java7-update-80-with-es-1-4-x/1380](https://discuss.elastic.co/t/how-safe-is-java7-update-80-with-es-1-4-x/1380) but I'll reproduce the text anyway for your convenience.\n\nI'm planning on upgrading from Java7 u67 to u80, due to the fix for the upcoming leap second.\n\nToday just tried shutting down all the nodes (3 in total, 2 with data, 1 just to route searches) and upgrading one of the data nodes to JRE7u80 (this was the only online node, just to be safe). It came up with index corrupted errors (note that everything was working flawlessly until the upgrade):\n\n> {\"message\":\"[elastic2-west02] [index_2015_05_v1][3] sending failed shard for [index_2015_05_v1][3], node[Yx684lX3SC6uoD_yT0d5Tw], [P], s[INITIALIZING], indexUUID [UqUZW7iXTqez4M5nReZH1Q], reason [Failed to start shard, message [IndexShardGatewayRecoveryException[[index_2015_05_v1][3] failed to fetch index version after copying it over]; nested: CorruptIndexException[[index_2015_05_v1][3] Preexisting corrupted index [corrupted_UXeWPgF7Qn61i2_qi9gkJw] caused by: CorruptIndexException[Invalid fieldsStream maxPointer (file truncated?): maxPointer=102522365, length=40370176]\\norg.apache.lucene.index.CorruptIndexException: Invalid fieldsStream maxPointer (file truncated?): maxPointer=102522365, length=40370176\\n\\tat org.apache.lucene.codecs.compressing.CompressingStoredFieldsReader.(CompressingStoredFieldsReader.java:135)\\n\\tat org.apache.lucene.codecs.compressing.CompressingStoredFieldsFormat.fieldsReader(CompressingStoredFieldsFormat.java:113)\\n\\tat org.apache.lucene.index.SegmentCoreReaders.(SegmentCoreReaders.java:133)\\n\\tat org.apache.lucene.index.SegmentReader.(SegmentReader.java:108)\\n\\tat org.apache.lucene.index.ReadersAndUpdates.getReader(ReadersAndUpdates.java:145)\\n\\tat org.apache.lucene.index.ReadersAndUpdates.getReadOnlyClone(ReadersAndUpdates.java:239)\\n\\tat org.apache.lucene.index.StandardDirectoryReader.open(StandardDirectoryReader.java:104)\\n\\tat org.apache.lucene.index.IndexWriter.getReader(IndexWriter.java:422)\\n\\tat org.apache.lucene.index.DirectoryReader.open(DirectoryReader.java:112)\\n\\tat org.apache.lucene.search.SearcherManager.(SearcherManager.java:89)\\n\\tat org.elasticsearch.index.engine.internal.InternalEngine.buildSearchManager(InternalEngine.java:1569)\\n\\tat org.elasticsearch.index.engine.internal.InternalEngine.start(InternalEngine.java:313)\\n\\tat org.elasticsearch.index.shard.service.InternalIndexShard.postRecovery(InternalIndexShard.java:710)\\n\\tat org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:223)\\n\\tat org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:132)\\n\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\\n\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\\n\\tat java.lang.Thread.run(Unknown Source)\\n]; ]]\",\"@version\":\"1\",\"@timestamp\":\"2015-05-31T11:57:31.887Z\",\"type\":\"elasticsearch\",\"host\":\"x.x.x.x:56107\",\"path\":\"cluster.action.shard\",\"priority\":\"WARN\",\"logger_name\":\"cluster.action.shard\",\"thread\":\"elasticsearch[elastic2-west02][generic][T#2]\",\"class\":\"?\",\"file\":\"?:?\",\"method\":\"?\"}\n\nThis is ES 1.4.4 (a couple of months ago we upgraded from 1.3.2 to 1.4.4 without issues) with JRE7u67 (the cluster has been running on this java version since the beginning). The node was upgraded to JRE7u80 and started up isolated from the cluster (all the nodes were down for this test), running on Amazon Linux 3.14.42-31.38.amzn1.x86_64\n\nWhen we noticed the errors, we shut down the upgraded node and rollbacked the jre upgrade, renamed the data directory (just to have evidence and recreate the data dir from scratch) started the other nodes that were untouched and then the problematic one. Everything went back to JRE7u67, the shards were reallocated successfuly (from the copies in the other data node) and the cluster is now all green and happy... but, without the latest java update.\n\nAnyone with any thoughts/comments?\n\nThanks!\n","closed_by":{"login":"marcelog","id":527356,"node_id":"MDQ6VXNlcjUyNzM1Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/527356?v=4","gravatar_id":"","url":"https://api.github.com/users/marcelog","html_url":"https://github.com/marcelog","followers_url":"https://api.github.com/users/marcelog/followers","following_url":"https://api.github.com/users/marcelog/following{/other_user}","gists_url":"https://api.github.com/users/marcelog/gists{/gist_id}","starred_url":"https://api.github.com/users/marcelog/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcelog/subscriptions","organizations_url":"https://api.github.com/users/marcelog/orgs","repos_url":"https://api.github.com/users/marcelog/repos","events_url":"https://api.github.com/users/marcelog/events{/privacy}","received_events_url":"https://api.github.com/users/marcelog/received_events","type":"User","site_admin":false},"performed_via_github_app":null}