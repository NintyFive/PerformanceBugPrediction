{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754/events","html_url":"https://github.com/elastic/elasticsearch/issues/4754","id":25712100,"node_id":"MDU6SXNzdWUyNTcxMjEwMA==","number":4754,"title":"Faceting using DFS_QUERY_THEN_FETCH fails","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"labels":[{"id":82340461,"node_id":"MDU6TGFiZWw4MjM0MDQ2MQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.13","name":"v0.90.13","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2014-01-16T09:22:54Z","updated_at":"2014-04-24T10:03:28Z","closed_at":"2014-03-20T09:20:17Z","author_association":"MEMBER","active_lock_reason":null,"body":"Hey,\n\nthis came via the ML (there are also some prerequisites listed): https://groups.google.com/d/msg/elasticsearch/ySHfbIW4sBQ/8ozOkBcbWTMJ\n\nWorks on master, fails on 0.90\n\nTo reproduce (sometimes, not always)\n\n```\npublic class BrokenFacetTest extends ElasticsearchIntegrationTest {\n\n    @Test\n    @TestLogging(\"_root:DEBUG\")\n    public void foo() throws Exception {\n        client().prepareIndex(\"test-index\", \"test-type\")\n                .setSource(\"{ \\\"id\\\": 123, \\\"test-value\\\": 321 }\")\n                .setRefresh(true)\n                .execute()\n                .actionGet();\n\n        SearchResponse searchResponse = client()\n                .prepareSearch(\"test-index\")\n                .setQuery(new MatchAllQueryBuilder())\n                .addFacet(new TermsFacetBuilder(\"test-facet\").field(\"test-value\"))\n                .setSearchType(SearchType.DFS_QUERY_AND_FETCH)\n                .execute()\n                .actionGet();\n\n        assertEquals(searchResponse.getFailedShards(), 0); // Failing!\n    }\n\n}\n```\n\nException being logged\n\n```\n[2014-01-16 10:13:16,061][DEBUG][org.elasticsearch.action.search.type] [node_2] [2] Failed to execute query phase\norg.elasticsearch.ElasticSearchException\n    at org.elasticsearch.ExceptionsHelper.convertToRuntime(ExceptionsHelper.java:37)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:360)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteFetch(SearchServiceTransportAction.java:338)\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryAndFetchAction$AsyncAction.executeSecondPhase(TransportSearchDfsQueryAndFetchAction.java:139)\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryAndFetchAction$AsyncAction$2.run(TransportSearchDfsQueryAndFetchAction.java:123)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:722)\nCaused by: java.lang.AssertionError\n    at org.elasticsearch.common.recycler.ThreadLocalRecycler$TV.release(ThreadLocalRecycler.java:84)\n    at org.elasticsearch.search.facet.terms.longs.TermsLongFacetExecutor.buildFacet(TermsLongFacetExecutor.java:122)\n    at org.elasticsearch.search.facet.FacetPhase.execute(FacetPhase.java:200)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:129)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:357)\n    ... 6 more\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}