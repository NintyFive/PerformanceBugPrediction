{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62762","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62762/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62762/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62762/events","html_url":"https://github.com/elastic/elasticsearch/issues/62762","id":706324291,"node_id":"MDU6SXNzdWU3MDYzMjQyOTE=","number":62762,"title":"Documents in a data stream can be deleted via the bulk API","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":1915711992,"node_id":"MDU6TGFiZWwxOTE1NzExOTky","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Data%20streams","name":":Core/Features/Data streams","color":"0e8a16","default":false,"description":""},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2020-09-22T12:05:44Z","updated_at":"2020-09-23T11:25:26Z","closed_at":"2020-09-23T11:25:26Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.9.1\r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version** (`java -version`): irrelevant\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): irrelevant\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIn the docs we state that [only `create` is allowed as action in bulk requests](https://www.elastic.co/guide/en/elasticsearch/reference/current/use-a-data-stream.html#data-streams-bulk-indexing-requests) for data streams. However, it is possible to use other actions as well with Elasticsearch 7.9.1.\r\n\r\n* Expectation: Any bulk item with an operation type other than `create` fails with an `IllegalArgumentException` with a message \"only write ops with an op_type of create are allowed in data streams\".\r\n* Actual behavior: The bulk request succeeds\r\n\r\n**Steps to reproduce**:\r\n\r\nIn the following example we setup a data stream according to the docs:\r\n\r\n```\r\ncurl -X PUT \"localhost:9200/_ilm/policy/my-data-stream-policy?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"policy\": {\r\n    \"phases\": {\r\n      \"hot\": {\r\n        \"actions\": {\r\n          \"rollover\": {\r\n            \"max_size\": \"25GB\"\r\n          }\r\n        }\r\n      },\r\n      \"delete\": {\r\n        \"min_age\": \"30d\",\r\n        \"actions\": {\r\n          \"delete\": {}\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/_index_template/my-data-stream-template?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"index_patterns\": [ \"my-data-stream*\" ],\r\n  \"data_stream\": { },\r\n  \"priority\": 200,\r\n  \"template\": {\r\n    \"settings\": {\r\n      \"index.lifecycle.name\": \"my-data-stream-policy\"\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\nOnce it is setup, we will index a single document into it. This requires `jq` so we can extract the document id automatically.\r\n\r\n```\r\nDOC_ID=$(curl -s -X POST \"localhost:9200/my-data-stream/_doc?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"@timestamp\": \"2020-12-06T11:04:05.000Z\",\r\n  \"user\": {\r\n    \"id\": \"vlb44hny\"\r\n  },\r\n  \"message\": \"Login attempt failed\"\r\n}\r\n' | jq -r ._id)\r\n```\r\n\r\nAttempting to delete a single document via the data stream will fail (as expected):\r\n\r\n```\r\ncurl -X DELETE \"localhost:9200/my-data-stream/_doc/$DOC_ID?pretty\"\r\n\r\n# response:\r\n\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"illegal_argument_exception\",\r\n        \"reason\" : \"only write ops with an op_type of create are allowed in data streams\"\r\n      }\r\n    ],\r\n    \"type\" : \"illegal_argument_exception\",\r\n    \"reason\" : \"only write ops with an op_type of create are allowed in data streams\"\r\n  },\r\n  \"status\" : 400\r\n}\r\n```\r\n\r\nHowever, if we attempt to do the same via the bulk API, the request succeeds:\r\n\r\n```\r\ncurl -X PUT \"localhost:9200/my-data-stream/_bulk?refresh&pretty\" -H 'Content-Type: application/json' -d\"\r\n{\\\"create\\\":{ }}\r\n{ \\\"@timestamp\\\": \\\"2020-12-08T11:06:07.000Z\\\", \\\"user\\\": { \\\"id\\\": \\\"8a4f500d\\\" }, \\\"message\\\": \\\"Login successful\\\" }\r\n{ \\\"delete\\\" : { \\\"_id\\\" : \\\"$DOC_ID\\\" } }\r\n\"\r\n```\r\n\r\nThis results in:\r\n\r\n```\r\n{\r\n  \"took\" : 48,\r\n  \"errors\" : false,\r\n  \"items\" : [\r\n    {\r\n      \"create\" : {\r\n        \"_index\" : \".ds-my-data-stream-000001\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"l6uxtXQBe4e9VJV_yQMw\",\r\n        \"_version\" : 1,\r\n        \"result\" : \"created\",\r\n        \"forced_refresh\" : true,\r\n        \"_shards\" : {\r\n          \"total\" : 2,\r\n          \"successful\" : 1,\r\n          \"failed\" : 0\r\n        },\r\n        \"_seq_no\" : 13,\r\n        \"_primary_term\" : 1,\r\n        \"status\" : 201\r\n      }\r\n    },\r\n    {\r\n      \"delete\" : {\r\n        \"_index\" : \".ds-my-data-stream-000001\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"laustXQBe4e9VJV_xgOd\",\r\n        \"_version\" : 2,\r\n        \"result\" : \"deleted\",\r\n        \"forced_refresh\" : true,\r\n        \"_shards\" : {\r\n          \"total\" : 2,\r\n          \"successful\" : 1,\r\n          \"failed\" : 0\r\n        },\r\n        \"_seq_no\" : 14,\r\n        \"_primary_term\" : 1,\r\n        \"status\" : 200\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nNotes:\r\n\r\n* The bulk API will behave identical to the document delete API if there is only one bulk item but behaves as described above if there are multiple actions.\r\n* It is irrelevant whether the `_index` property is contained in the bulk request body. The behavior is identical.","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}