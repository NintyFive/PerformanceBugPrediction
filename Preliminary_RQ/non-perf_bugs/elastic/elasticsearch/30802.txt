{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30802","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30802/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30802/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30802/events","html_url":"https://github.com/elastic/elasticsearch/issues/30802","id":325588533,"node_id":"MDU6SXNzdWUzMjU1ODg1MzM=","number":30802,"title":"Issue with running tests (requiring ES server startup) on a custom junit runner","user":{"login":"shashanka981","id":24698946,"node_id":"MDQ6VXNlcjI0Njk4OTQ2","avatar_url":"https://avatars1.githubusercontent.com/u/24698946?v=4","gravatar_id":"","url":"https://api.github.com/users/shashanka981","html_url":"https://github.com/shashanka981","followers_url":"https://api.github.com/users/shashanka981/followers","following_url":"https://api.github.com/users/shashanka981/following{/other_user}","gists_url":"https://api.github.com/users/shashanka981/gists{/gist_id}","starred_url":"https://api.github.com/users/shashanka981/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shashanka981/subscriptions","organizations_url":"https://api.github.com/users/shashanka981/orgs","repos_url":"https://api.github.com/users/shashanka981/repos","events_url":"https://api.github.com/users/shashanka981/events{/privacy}","received_events_url":"https://api.github.com/users/shashanka981/received_events","type":"User","site_admin":false},"labels":[{"id":106454670,"node_id":"MDU6TGFiZWwxMDY0NTQ2NzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Build","name":":Delivery/Build","color":"0e8a16","default":false,"description":"Build or test infrastructure"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-05-23T07:51:13Z","updated_at":"2020-11-11T21:41:40Z","closed_at":"2018-05-23T10:57:04Z","author_association":"NONE","active_lock_reason":null,"body":"@RunWith(MyCustomRunner.class)\r\npublic class TestESIndeingPerformance{\r\n\r\n@BeforeClass\r\npublic static void setup(){\r\n// start Elasticsearch server\r\n}\r\n\r\n@test\r\npublic void performindexing() {\r\n// java apis to initiate indexing\r\n}\r\n\r\n}\r\n\r\nHi , \r\n\r\nWe are using ElasticSearch 5.6.9 and we are seeing an exception during ES server startup....This was working well with ES 2.4 version...The error basically suggests to use Randomized runner annotation on the test class....but i am looking for a way to use my own custom junit runner and should be able to start the server without having to annotate the test class with randomized runner.I am not using any ElasticSearch helper tests to start the cluster\r\n\r\norg.elasticsearch.common.inject.CreationException: Guice creation errors:\r\n\r\n1) Error injecting constructor, java.lang.IllegalStateException: running tests but failed to invoke RandomizedContext#getRandom\r\n  at org.elasticsearch.action.bulk.CustomTransportBulkAction.<init>(Unknown Source)\r\n  while locating org.elasticsearch.action.bulk.CustomTransportBulkAction\r\nCaused by: java.lang.IllegalStateException: running tests but failed to invoke RandomizedContext#getRandom\r\n\tat org.elasticsearch.common.Randomness.get(Randomness.java:105)\r\n\tat org.elasticsearch.action.ingest.IngestActionForwarder.<init>(IngestActionForwarder.java:42)\r\n\tat org.elasticsearch.action.bulk.CustomTransportBulkAction.<init>(CustomTransportBulkAction.java:122)\r\n\tat org.elasticsearch.action.bulk.CustomTransportBulkAction.<init>(CustomTransportBulkAction.java:101)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)\r\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)\r\n\tat java.lang.reflect.Constructor.newInstance(Unknown Source)\r\n\tat org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:49)\r\n\tat org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\r\n\tat org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:116)\r\n\tat org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\r\n\tat org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:825)\r\n\tat org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\r\n\tat org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\r\n\tat org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:50)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:191)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:183)\r\n\tat org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:818)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:183)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:173)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:161)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:96)\r\n\tat org.elasticsearch.common.inject.Guice.createInjector(Guice.java:96)\r\n\tat org.elasticsearch.common.inject.Guice.createInjector(Guice.java:70)\r\n\tat org.elasticsearch.common.inject.ModulesBuilder.createInjector(ModulesBuilder.java:42)\r\n\tat org.elasticsearch.node.Node.<init>(Node.java:499)\r\n\tat com.pega.platform.search.internal.ESSearchProviderEmbedded$ESNode.<init>(ESSearchProviderEmbedded.java:234)\r\ncom.pega.pegarules.search.internal.PRSearchProviderImpl.initializeFTS(PRSearchProviderImpl.java:152)\r\ncom.pega.pegarules.search.internal.es.TestElasticSearchV7.setupOnce(TestElasticSearchV7.java:189)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\r\n\tat java.lang.reflect.Method.invoke(Unknown Source)\r\n\tat org.junit.runners.model.FrameworkMethod$1.runReflectiveCall(FrameworkMethod.java:50)\r\n\tat org.junit.internal.runners.model.ReflectiveCallable.run(ReflectiveCallable.java:12)\r\n\tat org.junit.runners.model.FrameworkMethod.invokeExplosively(FrameworkMethod.java:47)\r\n\tat org.junit.internal.runners.statements.RunBefores.evaluate(RunBefores.java:24)\r\n\tat org.junit.internal.runners.statements.RunAfters.evaluate(RunAfters.java:27)\r\n\tat com.pega.pegarules.unittest.util.BeforeAndAfter$1.evaluate(BeforeAndAfter.java:49)\r\n\tat org.junit.rules.RunRules.evaluate(RunRules.java:20)\r\n\tat org.junit.runners.ParentRunner.run(ParentRunner.java:363)\r\n\tat org.eclipse.jdt.internal.junit4.runner.JUnit4TestReference.run(JUnit4TestReference.java:86)\r\n\tat org.eclipse.jdt.internal.junit.runner.TestExecution.run(TestExecution.java:38)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:459)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.runTests(RemoteTestRunner.java:678)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.run(RemoteTestRunner.java:382)\r\n\tat org.eclipse.jdt.internal.junit.runner.RemoteTestRunner.main(RemoteTestRunner.java:192)\r\nCaused by: java.lang.reflect.InvocationTargetException\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(Unknown Source)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(Unknown Source)\r\n\tat java.lang.reflect.Method.invoke(Unknown Source)\r\n\tat org.elasticsearch.common.Randomness.get(Randomness.java:101)\r\n\t... 65 more\r\nCaused by: java.lang.IllegalStateException: No context information for thread: Thread[id=1, name=L34990WIN, state=RUNNABLE, group=main]. Is this thread running under a class com.carrotsearch.randomizedtesting.RandomizedRunner runner context? Add @RunWith(class com.carrotsearch.randomizedtesting.RandomizedRunner.class) to your test class. Make sure your code accesses random contexts within @BeforeClass and @AfterClass boundary (for example, static test class initializers are not permitted to access random contexts).\r\n\tat com.carrotsearch.randomizedtesting.RandomizedContext.context(RandomizedContext.java:244)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedContext.current(RandomizedContext.java:151)\r\n\t... 70 more\r\n\r\n2) Error injecting constructor, java.lang.IllegalArgumentException: transport handlers for action indices:data/write/custom-bulk is already registered\r\n  at org.elasticsearch.action.bulk.CustomTransportBulkAction.<init>(Unknown Source)\r\n  while locating org.elasticsearch.action.bulk.CustomTransportBulkAction\r\n  while locating org.elasticsearch.action.support.TransportAction annotated with @org.elasticsearch.common.inject.multibindings.Element(setName=,uniqueId=67)\r\nCaused by: java.lang.IllegalArgumentException: transport handlers for action indices:data/write/custom-bulk is already registered\r\n\tat org.elasticsearch.transport.TransportService.registerRequestHandler(TransportService.java:743)\r\n\tat org.elasticsearch.transport.TransportService.registerRequestHandler(TransportService.java:737)\r\n\tat org.elasticsearch.action.support.HandledTransportAction.<init>(HandledTransportAction.java:50)\r\n\tat org.elasticsearch.action.support.HandledTransportAction.<init>(HandledTransportAction.java:43)\r\n\tat org.elasticsearch.action.bulk.CustomTransportBulkAction.<init>(CustomTransportBulkAction.java:113)\r\n\tat org.elasticsearch.action.bulk.CustomTransportBulkAction.<init>(CustomTransportBulkAction.java:101)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(Unknown Source)\r\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(Unknown Source)\r\n\tat java.lang.reflect.Constructor.newInstance(Unknown Source)\r\n\tat org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:49)\r\n\tat org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\r\n\tat org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:116)\r\n\tat org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\r\n\tat org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:825)\r\n\tat org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\r\n\tat org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\r\n\tat org.elasticsearch.common.inject.InternalFactoryToProvide...","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}