{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29630","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29630/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29630/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29630/events","html_url":"https://github.com/elastic/elasticsearch/issues/29630","id":316159642,"node_id":"MDU6SXNzdWUzMTYxNTk2NDI=","number":29630,"title":"Update nested fields with Spark","user":{"login":"cristinaluengoagullo","id":8060310,"node_id":"MDQ6VXNlcjgwNjAzMTA=","avatar_url":"https://avatars0.githubusercontent.com/u/8060310?v=4","gravatar_id":"","url":"https://api.github.com/users/cristinaluengoagullo","html_url":"https://github.com/cristinaluengoagullo","followers_url":"https://api.github.com/users/cristinaluengoagullo/followers","following_url":"https://api.github.com/users/cristinaluengoagullo/following{/other_user}","gists_url":"https://api.github.com/users/cristinaluengoagullo/gists{/gist_id}","starred_url":"https://api.github.com/users/cristinaluengoagullo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cristinaluengoagullo/subscriptions","organizations_url":"https://api.github.com/users/cristinaluengoagullo/orgs","repos_url":"https://api.github.com/users/cristinaluengoagullo/repos","events_url":"https://api.github.com/users/cristinaluengoagullo/events{/privacy}","received_events_url":"https://api.github.com/users/cristinaluengoagullo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-04-20T07:38:26Z","updated_at":"2018-08-29T13:11:44Z","closed_at":"2018-04-20T07:49:38Z","author_association":"NONE","active_lock_reason":null,"body":"I'm trying to update a nested field using Spark and a scripted update. The code I'm using is:\r\n\r\nupdate_params = \"new_samples: samples\"\r\nupdate_script = \"ctx._source.samples += new_samples\"\r\n\r\nes_conf = {\r\n\"es.mapping.id\": \"id\",\r\n\"es.mapping.exclude\": \"id\",\r\n\"es.write.operation\": \"upsert\",\r\n\"es.update.script.params\": update_params,\r\n\"es.update.script.inline\": update_script\r\n}\r\n\r\nresult.write.format(\"org.elasticsearch.spark.sql\").options(**es_conf).option(\"es.nodes\",configuration[\"elasticsearch\"][\"host\"]).option(\"es.port\",configuration[\"elasticsearch\"][\"port\"] ).save(configuration[\"elasticsearch\"][\"index_name\"]+\"/\"+configuration[\"version\"],mode='append')\r\n\r\nAnd the schema of the field is:\r\n\r\n|-- samples: array (nullable = true)\r\n| |-- element: struct (containsNull = true)\r\n| | |-- gq: integer (nullable = true)\r\n| | |-- dp: integer (nullable = true)\r\n| | |-- gt: string (nullable = true)\r\n| | |-- adBug: array (nullable = true)\r\n| | | |-- element: integer (containsNull = true)\r\n| | |-- ad: double (nullable = true)\r\n| | |-- sample: string (nullable = true)\r\n\r\nAnd I get the following error:\r\n\r\npy4j.protocol.Py4JJavaError: An error occurred while calling o83.save.\r\n: org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 1 times, most recent failure: Lost task 0.0 in stage 1.0 (TID 1, localhost, executor driver): java.lang.ClassCastException: scala.collection.mutable.WrappedArray$ofRef cannot be cast to scala.Tuple2\r\n\r\nAm I doing something wrong or is this a bug? Thanks.\r\n\r\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}