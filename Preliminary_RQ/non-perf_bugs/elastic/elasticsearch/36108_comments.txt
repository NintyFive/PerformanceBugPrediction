[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443152831","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443152831","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443152831,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzE1MjgzMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T09:59:26Z","updated_at":"2018-11-30T09:59:26Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443210786","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443210786","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443210786,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzIxMDc4Ng==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T13:57:15Z","updated_at":"2018-11-30T13:58:59Z","author_association":"CONTRIBUTOR","body":"Are you planning to add the ClassRewriter groovy code (https://github.com/apache/lucene-solr/blob/master/lucene/tools/src/groovy/patch-mrjar-classes.groovy) to elastic, so you can do the same FutureObjects->Objects replacements in Elasticsearch, too?\r\n\r\nI haven't seen any code yet.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443211927","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443211927","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443211927,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzIxMTkyNw==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T14:01:11Z","updated_at":"2018-11-30T14:01:11Z","author_association":"CONTRIBUTOR","body":"It should work easily, because Elasticsearch already builds an MR-JAR for the \"server\" code. So running the above rewriter on the Java 8 class files using FutureObjects/Arrays and storing the rewritten result in the java9 classes dir should be easy. It would not interfere with the current MR-JAR code in build.gradle.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443230031","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443230031","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443230031,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzIzMDAzMQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T15:02:07Z","updated_at":"2018-11-30T15:02:07Z","author_association":"CONTRIBUTOR","body":"We discussed this issue in FixitFriday and agreed that this move would be a win. However some concerns have been expressed regarding patching class files so we might want to build a MR JAR that exposes this functionality (similarly to the first patches on the Lucene issue) instead of the Lucene approach of patching call sites.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443270986","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443270986","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443270986,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzI3MDk4Ng==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T17:06:31Z","updated_at":"2018-11-30T17:12:31Z","author_association":"CONTRIBUTOR","body":"Thanks @jpountz, \r\nI am fine with any solution. It would just be interesting what the concerns were. To me it has been always something from \"I am just afraid to patch classfiles\" to \"how to test\"?\r\n\r\nAs disussed in the Lucene issue: Especially about optimization of duplicate checkIndex checks on different levels in the call stack, the additional overhead brings the risk that optimzer cannot replace everything with native code and may also not able to remove the duplicate checks. I discussed this with the OpenJDK hotspot guys last year on FOSDEM and they were also favouring this approach (just replacing class name). To my knowledge especially Objects.checkIndex() should always be called directly from call site (e.g., in an if statement).\r\n\r\nAbout the risks: Patching class files is harmless here if you can ensure the following: Signatures are 100% identical. If you reuse the Lucene FutureObjects and FutureArrays classes, this is tested already by the Lucene tests with several checks (I wanted to add more). Using a different approach to build the MR-JAR in ES would also not add any safety, because if the Lucene approach would be broken, it would break ES anyways. It's now tested in several releases, no problems.\r\n\r\nIn contrast, if you add a new layer of indirection with 2 different source trees, the risk of bugs is much higher. Because you have to be 100% sure that both of your source trees compile to the same method signatures! If you reuse the already tested Lucene approach, the risk is zero.\r\n\r\nThe only backside with patching the caller code is a larger JAR file: Every class that uses FutureObjects/FutureArrays is duplicated in the JAR file while a single wrapper class does not blow up. But on Lucene it has shown that JAR file only growed minimally (around 10%). Of course this depends on number of usages.\r\n\r\nSo I tend to use the same approach. I can help in moving the patching groovy code as a Gradle Task (that's quite easy). It can then be added easily. We may also reuse it in Lucene as a real task once we switch to Gradle.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443274198","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443274198","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443274198,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzI3NDE5OA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T17:17:04Z","updated_at":"2018-11-30T17:17:04Z","author_association":"CONTRIBUTOR","body":"@uschindler I think the concern is mostly that some of the class files that we would package would no longer be directly produced by the compiler. We are not too concerned with getting worse performance, the main benefit that we are looking for is correctness. I agree that both approaches have risks, just different ones. :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443274850","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-443274850","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":443274850,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MzI3NDg1MA==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2018-11-30T17:19:12Z","updated_at":"2018-11-30T17:19:12Z","author_association":"CONTRIBUTOR","body":"The class files created by painless are also not coming from the compiler...\r\n\r\nAs said before, correctness cannot be ensured by the separate compile steps, because the output of the real compiler can still be incompatible. That's what I wanted to say.\r\n\r\nNevertheless, I'm happy to help.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/535004337","html_url":"https://github.com/elastic/elasticsearch/issues/36108#issuecomment-535004337","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36108","id":535004337,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNTAwNDMzNw==","user":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"created_at":"2019-09-25T12:45:02Z","updated_at":"2019-09-25T12:45:02Z","author_association":"CONTRIBUTOR","body":"Closed in #46953.","performed_via_github_app":null}]