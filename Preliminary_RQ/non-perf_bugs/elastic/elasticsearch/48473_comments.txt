[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/545973053","html_url":"https://github.com/elastic/elasticsearch/issues/48473#issuecomment-545973053","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48473","id":545973053,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NTk3MzA1Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-10-24T15:30:12Z","updated_at":"2019-10-24T15:30:12Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/547046858","html_url":"https://github.com/elastic/elasticsearch/issues/48473#issuecomment-547046858","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48473","id":547046858,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzA0Njg1OA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-10-28T17:03:56Z","updated_at":"2019-10-28T17:03:56Z","author_association":"CONTRIBUTOR","body":"Handling `TermsQueryBuilder` (note the `s`) would be helpful too.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/547549099","html_url":"https://github.com/elastic/elasticsearch/issues/48473#issuecomment-547549099","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48473","id":547549099,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzU0OTA5OQ==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2019-10-29T17:49:36Z","updated_at":"2019-10-29T17:49:51Z","author_association":"CONTRIBUTOR","body":"@jpountz  I expect the required rewrite logic would be something like this:\r\n\r\n        if (fieldName.equals(\"_index\") && context.indexMatches(value.toString()) == false) {\r\n            return Queries.newMatchNoDocsQuery(\r\n                    \"The index [\" + context.getFullyQualifiedIndex().getName() + \"] doesn't match the provided value [\" + value + \"].\");\r\n        }\r\n\r\nBut I added this example is in the `AbstractQueryBuilder.doToQuery` method override where \"context\" arg is a `QueryShardContext` with that helpful index-name matching method. \r\n\r\nIn your suggested placement of `AbstractQueryBuilder.doRewrite` the `context` arg passed is a less useful class - `QueryRewriteContext` without the index-name checking logic.\r\n\r\nWould it matter if the MatchNoDocs rewrite happens in the `doToQuery` method?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/547557088","html_url":"https://github.com/elastic/elasticsearch/issues/48473#issuecomment-547557088","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48473","id":547557088,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzU1NzA4OA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-10-29T18:07:32Z","updated_at":"2019-11-01T16:44:48Z","author_association":"CONTRIBUTOR","body":"Indeed it would probably look something like that. You can call `queryRewriteContext.convertToShardContext();` to get a shard context - with some caveats. See for instance how `RangeQueryBuilder#doToRewrite` works.\r\n\r\n> Would it matter if the MatchNoDocs rewrite happens in the doToQuery method?\r\n\r\nUnfortunately yes. We already do this in doToQuery today actually via `IndexFieldType#termQuery`. However the heuristic that the `can_match` phase uses to know whether a shard might have any documents is by looking at whether the query rewrites to a MatchNoneQueryBuilder on that shard.","performed_via_github_app":null}]