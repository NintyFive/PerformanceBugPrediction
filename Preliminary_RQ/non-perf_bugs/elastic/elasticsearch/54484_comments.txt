[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/607791290","html_url":"https://github.com/elastic/elasticsearch/issues/54484#issuecomment-607791290","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54484","id":607791290,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNzc5MTI5MA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-04-02T11:35:35Z","updated_at":"2020-04-02T11:35:35Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features (:Core/Features/Java High Level REST Client)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/685806835","html_url":"https://github.com/elastic/elasticsearch/issues/54484#issuecomment-685806835","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54484","id":685806835,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NTgwNjgzNQ==","user":{"login":"swallez","id":213730,"node_id":"MDQ6VXNlcjIxMzczMA==","avatar_url":"https://avatars2.githubusercontent.com/u/213730?v=4","gravatar_id":"","url":"https://api.github.com/users/swallez","html_url":"https://github.com/swallez","followers_url":"https://api.github.com/users/swallez/followers","following_url":"https://api.github.com/users/swallez/following{/other_user}","gists_url":"https://api.github.com/users/swallez/gists{/gist_id}","starred_url":"https://api.github.com/users/swallez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/swallez/subscriptions","organizations_url":"https://api.github.com/users/swallez/orgs","repos_url":"https://api.github.com/users/swallez/repos","events_url":"https://api.github.com/users/swallez/events{/privacy}","received_events_url":"https://api.github.com/users/swallez/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T15:19:52Z","updated_at":"2020-09-02T15:25:07Z","author_association":"MEMBER","body":"The [update by query doc](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html) states: \"Updates documents that match the specified query. If no query is specified, performs an update on every document in the data stream or index\".\r\n\r\nWhat happens here is that the request has no query part, so the script is run for every document in the index, unconditionally. Since we do not do a document diff after running the script to know whether it has changed or not, all documents are updated.\r\n\r\nThe docs have an [example showing a query and a script](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-update-by-query.html#docs-update-by-query-api-source).\r\n\r\nThe corresponding Java code would be:\r\n\r\n```java\r\nUpdateByQueryRequest queryRequest = new UpdateByQueryRequest(\"test\")\r\nqueryRequest.setQuery(new TermQueryBuilder(\"foo\", someVal));\r\n    \r\nScript script = new Script(ScriptType.INLINE, \"painless\", \"ctx._source.foo = someOtherVal;\", Collections.emptyMap());\r\nqueryRequest.setScript(script);\r\n\r\nBulkByScrollResponse bulkResponse = esClient.updateByQuery(queryRequest, RequestOptions.DEFAULT);\r\n```\r\n\r\nAnd then the result of `getUpdated()` will be the number of documents matching the query.\r\n\r\nHope this helps!\r\n\r\n","performed_via_github_app":null}]