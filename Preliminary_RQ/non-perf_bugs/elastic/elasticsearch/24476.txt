{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24476","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24476/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24476/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24476/events","html_url":"https://github.com/elastic/elasticsearch/issues/24476","id":226157211,"node_id":"MDU6SXNzdWUyMjYxNTcyMTE=","number":24476,"title":"Can not fix unclosed brackets in pattern replace char filter","user":{"login":"yoshiodeveloper","id":1727843,"node_id":"MDQ6VXNlcjE3Mjc4NDM=","avatar_url":"https://avatars0.githubusercontent.com/u/1727843?v=4","gravatar_id":"","url":"https://api.github.com/users/yoshiodeveloper","html_url":"https://github.com/yoshiodeveloper","followers_url":"https://api.github.com/users/yoshiodeveloper/followers","following_url":"https://api.github.com/users/yoshiodeveloper/following{/other_user}","gists_url":"https://api.github.com/users/yoshiodeveloper/gists{/gist_id}","starred_url":"https://api.github.com/users/yoshiodeveloper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yoshiodeveloper/subscriptions","organizations_url":"https://api.github.com/users/yoshiodeveloper/orgs","repos_url":"https://api.github.com/users/yoshiodeveloper/repos","events_url":"https://api.github.com/users/yoshiodeveloper/events{/privacy}","received_events_url":"https://api.github.com/users/yoshiodeveloper/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-05-04T01:27:57Z","updated_at":"2017-05-04T09:54:59Z","closed_at":"2017-05-04T09:54:58Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version:**\r\n5.3.2\r\n\r\n**Plugins installed:**\r\nx-pack, analysis-icu\r\n\r\n**JVM version:**\r\nopenjdk version \"1.8.0_121\"\r\nOpenJDK Runtime Environment (build 1.8.0_121-8u121-b13-0ubuntu1.16.04.2-b13)\r\nOpenJDK 64-Bit Server VM (build 25.121-b13, mixed mode)\r\n\r\n**OS version:**\r\nLinux 4.4.0-72-generic # 93-Ubuntu SMP Fri Mar 31 14:07:41 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description:**\r\nAfter create a regex pattern with unclosed brackets the index settings can not be updated to fix it, also the index can not be opened again.\r\n\r\n**Steps to reproduce:**\r\n\r\n 1. Create a test index with a pattern replace char filter. The pattern_replace has a working pattern. \r\n```\r\nPUT /test\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 0,\r\n    \"analysis\": {\r\n      \"char_filter\": {\r\n        \"my_normalizer\": {\r\n          \"type\": \"pattern_replace\",\r\n          \"pattern\": \"([\\\\w+])\", // working pattern\r\n          \"replacement\": \"$1\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResult:\r\n```\r\n{\r\n  \"acknowledged\": true,\r\n  \"shards_acknowledged\": true\r\n}\r\n```\r\n\r\n\r\n 2. Close the index\r\n\r\n`POST /test/_close`\r\n\r\n\r\n 3. Update the char_filter with a unclosed pattern.\r\n\r\n```\r\nPUT /test/_settings\r\n{\r\n  \"analysis\": {\r\n      \"char_filter\": {\r\n      \"my_normalizer\": {\r\n        \"type\": \"pattern_replace\",\r\n        \"pattern\": \"([\\\\w+)\", // without \"]\"\r\n        \"replacement\": \"$1\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe pattern is wrong but no warning is given:\r\n```\r\n{\r\n  \"acknowledged\": true\r\n}\r\n```\r\n\r\n\r\n 4. Now the index can not be opened.\r\n`\r\nPOST /test/_open`\r\n\r\nResult:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"exception\",\r\n        \"reason\": \"Failed to verify index [test/n3rzxZvSTfe4GxvbhDYQYA]\"\r\n      }\r\n    ],\r\n    \"type\": \"exception\",\r\n    \"reason\": \"Failed to verify index [test/n3rzxZvSTfe4GxvbhDYQYA]\",\r\n    \"caused_by\": {\r\n      \"type\": \"pattern_syntax_exception\",\r\n      \"reason\": \"Unclosed character class near index 5\\n([\\\\w+)\\n     ^\"\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n 5. The wrong pattern can not be fixed.\r\n\r\n```\r\nPUT /test/_settings\r\n{\r\n  \"analysis\": {\r\n      \"char_filter\": {\r\n      \"my_normalizer\": {\r\n        \"type\": \"pattern_replace\",\r\n        \"pattern\": \"([\\\\w+])\", // fixed\r\n        \"replacement\": \"$1\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResult:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"pattern_syntax_exception\",\r\n        \"reason\": \"Unclosed character class near index 5\\n([\\\\w+)\\n     ^\"\r\n      }\r\n    ],\r\n    \"type\": \"pattern_syntax_exception\",\r\n    \"reason\": \"Unclosed character class near index 5\\n([\\\\w+)\\n     ^\"\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\n\r\n**Log:**\r\n```\r\n[2017-05-03T21:32:59,786][DEBUG][o.e.a.a.i.s.p.TransportUpdateSettingsAction] [notebookavell] failed to update settings on indices [[[test/8NEkZ6ziSWehmTIzm3RZ6A]]]\r\njava.util.regex.PatternSyntaxException: Unclosed character class near index 5\r\n([\\w+)\r\n     ^\r\n    at java.util.regex.Pattern.error(Pattern.java:1955) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.clazz(Pattern.java:2548) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.sequence(Pattern.java:2063) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.expr(Pattern.java:1996) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.group0(Pattern.java:2905) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.sequence(Pattern.java:2051) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.expr(Pattern.java:1996) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.compile(Pattern.java:1696) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.<init>(Pattern.java:1351) ~[?:1.8.0_121]\r\n    at java.util.regex.Pattern.compile(Pattern.java:1054) ~[?:1.8.0_121]\r\n    at org.elasticsearch.common.regex.Regex.compile(Regex.java:159) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.index.analysis.PatternReplaceCharFilterFactory.<init>(PatternReplaceCharFilterFactory.java:43) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.indices.analysis.AnalysisModule$1.get(AnalysisModule.java:351) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.index.analysis.AnalysisRegistry.buildMapping(AnalysisRegistry.java:342) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.index.analysis.AnalysisRegistry.buildCharFilterFactories(AnalysisRegistry.java:181) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.index.analysis.AnalysisRegistry.build(AnalysisRegistry.java:153) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.index.IndexService.<init>(IndexService.java:145) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.index.IndexModule.newIndexService(IndexModule.java:363) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.indices.IndicesService.createIndexService(IndicesService.java:427) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.indices.IndicesService.verifyIndexMetadata(IndicesService.java:460) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.cluster.metadata.MetaDataUpdateSettingsService$2.execute(MetaDataUpdateSettingsService.java:289) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.cluster.ClusterStateUpdateTask.execute(ClusterStateUpdateTask.java:45) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.cluster.service.ClusterService.executeTasks(ClusterService.java:679) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.cluster.service.ClusterService.calculateTaskOutputs(ClusterService.java:658) ~[elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:617) [elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.cluster.service.ClusterService$UpdateTask.run(ClusterService.java:1117) [elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:238) [elasticsearch-5.3.2.jar:5.3.2]\r\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:201) [elasticsearch-5.3.2.jar:5.3.2]\r\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}