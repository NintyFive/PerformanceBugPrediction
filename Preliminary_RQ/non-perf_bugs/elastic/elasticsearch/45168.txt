{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45168","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45168/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45168/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45168/events","html_url":"https://github.com/elastic/elasticsearch/issues/45168","id":476409396,"node_id":"MDU6SXNzdWU0NzY0MDkzOTY=","number":45168,"title":"Getting wrong data in aggs using script or field property","user":{"login":"webmastervishal","id":15266438,"node_id":"MDQ6VXNlcjE1MjY2NDM4","avatar_url":"https://avatars1.githubusercontent.com/u/15266438?v=4","gravatar_id":"","url":"https://api.github.com/users/webmastervishal","html_url":"https://github.com/webmastervishal","followers_url":"https://api.github.com/users/webmastervishal/followers","following_url":"https://api.github.com/users/webmastervishal/following{/other_user}","gists_url":"https://api.github.com/users/webmastervishal/gists{/gist_id}","starred_url":"https://api.github.com/users/webmastervishal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/webmastervishal/subscriptions","organizations_url":"https://api.github.com/users/webmastervishal/orgs","repos_url":"https://api.github.com/users/webmastervishal/repos","events_url":"https://api.github.com/users/webmastervishal/events{/privacy}","received_events_url":"https://api.github.com/users/webmastervishal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-08-03T03:06:02Z","updated_at":"2019-08-05T06:52:59Z","closed_at":"2019-08-05T06:52:33Z","author_association":"NONE","active_lock_reason":null,"body":"I have setup kibana for elastic search and in dev tools, I have been querying data but getting incorrect results.\r\n\r\nMy Elastic search data is generated by a food ordering app, so basically, the structure of data is like I am fetching all those orders and inside each order, I have menu items and its count. \r\n\r\nFor example, I will be using a single menu item (i.e Boil Egg )here for elaboration. \r\n\r\nSo below is my query to get the items to count for \"Boil Egg\" menu item \r\n\r\n> Query\r\n\r\n: \r\n```\r\nGET _search\r\n{\r\n  \"size\": 5000,\r\n  \"aggs\": {\r\n    \"items_count\": {\r\n      \"sum\": {\r\n        \"field\": \"data.items.count\"\r\n      }\r\n    },\r\n    \"requests\": {\r\n      \"terms\": {\r\n        \"field\": \"data.items.menuitemname.keyword\",\r\n        \"size\": 5000,\r\n        \"order\": {\r\n          \"itemscount\": \"desc\"\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"totalprice\": {\r\n          \"sum\": {\r\n            \"field\": \"data.items.totalprice\"\r\n          }\r\n        },\r\n        \"itemscount\": {\r\n          \"sum\": {\r\n            \"field\": \"data.items.count\"\r\n          }\r\n        }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [],\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"appId.keyword\": \"5825d15cf009c4bc37fd7b9f\"\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"entityId.keyword\": \"5825d66df009c4bc37fd7bae\"\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"data.placedtime\": {\r\n              \"gte\": \"2019-07-31T18:30:00.000Z\",\r\n              \"lt\": \"2019-08-01T18:29:59.999Z\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"should\": [\r\n        [\r\n          {\r\n            \"term\": {\r\n              \"data.parentId.keyword\": \"5d0fb4173516ac51d7498f63\"\r\n            }\r\n          }\r\n        ]\r\n      ],\r\n      \"must_not\": [],\r\n      \"minimum_should_match\": 1\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Note:** I tried with the script as well but getting the same result \r\n`script: \"doc['data.items.menuitem.keyword'].value\"\r\n`\r\nI know with this query there are two orders that will be pulled by an elastic search query.\r\n\r\nOrder 1 : \r\n\r\n```\r\n{\r\n  \"_index\": \"gokhanaprod\",\r\n  \"_type\": \"entityrecord\",\r\n  \"_id\": \"5d42d2e193cf3923fb1558a4\",\r\n  \"_score\": 3.6844535,\r\n  \"_source\": {\r\n    \"appId\": \"5825d15cf009c4bc37fd7b9f\",\r\n    \"createdAt\": \"2019-08-01T11:54:09.832Z\",\r\n    \"createdby\": \"5cf4be2ab1a01b4c13554c9c\",\r\n    \"data\": {\r\n      \"checksum\": \"a432f092-1f3f-4b78-b852-854b4d7f9cbb\",\r\n      \"createdplatform\": \"gokhanapartnerfm\",\r\n      \"creditdiscount\": null,\r\n      \"customercount\": 0,\r\n      \"discountfromcredit\": 0,\r\n      \"discountsplit\": [],\r\n      \"foodcourt\": \"5cdbf8b2bca97402a052bbdf\",\r\n      \"foodcourtname\": \"Marvel Edge\",\r\n      \"grossamount\": 20,\r\n      \"grossamount_p\": 20,\r\n      \"itemprice_included_taxes\": [],\r\n      \"items\": [\r\n        {\r\n          \"totalprice\": 20,\r\n          \"restaurant\": \"5d0fb4173516ac51d7498f63\",\r\n          \"count\": 2,\r\n          \"price_includes_tax\": false,\r\n          \"features\": [],\r\n          \"menuitemname\": \"Boil Egg \",\r\n          \"restaurantcustomer\": null,\r\n          \"customeitems\": [],\r\n          \"restaurantmenuitem\": \"5d1b2cdf5bfcca209234bb10\",\r\n          \"included_tax_items\": [\r\n            {\r\n              \"name\": \"CGST\",\r\n              \"value\": 2.5\r\n            },\r\n            {\r\n              \"name\": \"SGST\",\r\n              \"value\": 2.5\r\n            }\r\n          ],\r\n          \"itemprice\": 10,\r\n          \"specialnotes\": null,\r\n          \"acceptedtime\": \"2019-08-01T11:54:12.382Z\",\r\n          \"id\": \"451fe67a-0ec0-4ab8-a8fd-1833163c6178\",\r\n          \"taxAmount\": 0,\r\n          \"status\": \"completed\"\r\n        }\r\n      ],\r\n      \"itemscount\": 2,\r\n      \"merchant_price\": 20,\r\n      \"orderid\": \"ORD10273973\",\r\n      \"orderstatus\": \"completed\",\r\n      \"ordertype\": \"dine-in\",\r\n      \"paid\": true,\r\n      \"paidamount\": 20,\r\n      \"paidtime\": \"2019-08-01T11:54:08.738Z\",\r\n      \"parcelcharge\": 0,\r\n      \"parentId\": \"5d0fb4173516ac51d7498f63\",\r\n      \"paymentgateway\": \"onsite\",\r\n      \"paymentstatus\": \"complete\",\r\n      \"paymenttransactions\": [\r\n        {\r\n          \"paidamount\": 20,\r\n          \"paymetcollectedby\": \"5cf4be2ab1a01b4c13554c9c\",\r\n          \"paymentgateway\": \"gokhana\",\r\n          \"paid\": true,\r\n          \"paidtime\": \"2019-08-01T11:54:08.738Z\",\r\n          \"paymenttype\": \"cash\"\r\n        }\r\n      ],\r\n      \"paymenttype\": \"cash\",\r\n      \"placedtime\": \"2019-08-01T11:54:08.768Z\",\r\n      \"prepaid\": true,\r\n      \"promotion\": null,\r\n      \"refundamounttocustomer\": 0,\r\n      \"restaurantcustomer\": null,\r\n      \"restaurantname\": \"Super Cafe - Meal\",\r\n      \"restauranttable\": null,\r\n      \"taxamount\": 0,\r\n      \"taxitems\": [],\r\n      \"tokenno\": \"C216\",\r\n      \"totalprice\": 20,\r\n      \"transactions\": [],\r\n      \"acceptedtime\": \"2019-08-01T11:54:12.382Z\",\r\n      \"acceptanceWaitedDuration\": \"-PT3.614S\",\r\n      \"closedtime\": \"2019-08-01T14:21:36.026Z\"\r\n    },\r\n    \"entityId\": \"5825d66df009c4bc37fd7bae\",\r\n    \"lastupdatedby\": \"5d0fb92030928751d16d8e04\",\r\n    \"updatedAt\": \"2019-08-01T14:21:37.404Z\",\r\n    \"id\": \"5d42d2e193cf3923fb1558a4\"\r\n  }\r\n}\r\n```\r\n\r\nOrder 2: \r\n\r\n```\r\n{\r\n  \"_index\": \"gokhanaprod\",\r\n  \"_type\": \"entityrecord\",\r\n  \"_id\": \"5d429d4a6729d40a121cc29d\",\r\n  \"_score\": 3.673422,\r\n  \"_source\": {\r\n    \"appId\": \"5825d15cf009c4bc37fd7b9f\",\r\n    \"createdAt\": \"2019-08-01T08:05:30.281Z\",\r\n    \"createdby\": \"5cff6064b67f1072d4e85b46\",\r\n    \"data\": {\r\n      \"appversion\": \"71\",\r\n      \"checksum\": \"73cbf286-ceda-4506-abd9-5e6755e8e7a8\",\r\n      \"createdplatform\": \"gokhanacustomer\",\r\n      \"creditdiscount\": null,\r\n      \"customername\": \"Dipayan\",\r\n      \"customerno\": \"9609744454\",\r\n      \"discountfromcredit\": 0,\r\n      \"discountsplit\": [],\r\n      \"externaltransactionid\": \"20190801111212800110168904380924952\",\r\n      \"foodcourt\": \"5cdbf8b2bca97402a052bbdf\",\r\n      \"foodcourtname\": \"Marvel Edge\",\r\n      \"grossamount\": 50,\r\n      \"grossamount_p\": 50,\r\n      \"itemprice_included_taxes\": [],\r\n      \"items\": [\r\n        {\r\n          \"restaurantname\": \"Super Cafe - Meal\",\r\n          \"placedtime\": \"2019-08-01T08:05:29.18Z\",\r\n          \"totalprice\": 40,\r\n          \"restaurant\": \"5d0fb4173516ac51d7498f63\",\r\n          \"count\": 1,\r\n          \"price_includes_tax\": false,\r\n          \"features\": [],\r\n          \"baseprice\": 40,\r\n          \"menuitemname\": \"Dal Rice\",\r\n          \"restaurantcustomer\": \"5cff6064b67f1072d4e85b46\",\r\n          \"customeitems\": [],\r\n          \"restaurantmenuitem\": \"5d11c7eee3799451a54d2533\",\r\n          \"itemprice\": 40,\r\n          \"acceptedtime\": \"2019-08-01T08:05:33.059Z\",\r\n          \"id\": \"5acc7848-cfb0-439a-9d50-4d2a944f6629\",\r\n          \"taxAmount\": 0,\r\n          \"status\": \"completed\"\r\n        },\r\n        {\r\n          \"restaurantname\": \"Super Cafe - Meal\",\r\n          \"placedtime\": \"2019-08-01T08:05:29.18Z\",\r\n          \"totalprice\": 10,\r\n          \"restaurant\": \"5d0fb4173516ac51d7498f63\",\r\n          \"count\": 1,\r\n          \"price_includes_tax\": false,\r\n          \"features\": [],\r\n          \"baseprice\": 10,\r\n          \"menuitemname\": \"Boil Egg \",\r\n          \"restaurantcustomer\": \"5cff6064b67f1072d4e85b46\",\r\n          \"customeitems\": [],\r\n          \"restaurantmenuitem\": \"5d1b2cdf5bfcca209234bb10\",\r\n          \"itemprice\": 10,\r\n          \"acceptedtime\": \"2019-08-01T08:05:33.059Z\",\r\n          \"id\": \"b68705d7-2456-48f2-9a65-2b95ef174373\",\r\n          \"taxAmount\": 0,\r\n          \"status\": \"completed\"\r\n        }\r\n      ],\r\n      \"itemscount\": 2,\r\n      \"mealvoucherapplicable\": true,\r\n      \"merchant_price\": 50,\r\n      \"orderid\": \"ORD10273334\",\r\n      \"orderstatus\": \"completed\",\r\n      \"ordertype\": \"dine-in\",\r\n      \"paid\": true,\r\n      \"paidamount\": 50,\r\n      \"paidtime\": \"2019-08-01T08:05:29.154Z\",\r\n      \"parentId\": \"5d0fb4173516ac51d7498f63\",\r\n      \"paymentgateway\": \"paytm\",\r\n      \"paymentstatus\": \"complete\",\r\n      \"paymenttransactions\": [\r\n        {\r\n          \"paidamount\": 50,\r\n          \"paymentgateway\": \"paytm\",\r\n          \"paid\": true,\r\n          \"externaltransactionid\": \"20190801111212800110168904380924952\",\r\n          \"paidtime\": \"2019-08-01T08:05:29.155Z\",\r\n          \"paymenttype\": \"paytm-cash\",\r\n          \"transactionid\": \"5d429d421b45fa1ad8e2cf78\"\r\n        }\r\n      ],\r\n      \"paymenttype\": \"paytm-cash\",\r\n      \"placedtime\": \"2019-08-01T08:05:29.18Z\",\r\n      \"prepaid\": true,\r\n      \"promotion\": null,\r\n      \"refundamounttocustomer\": 0,\r\n      \"restaurantcustomer\": \"5cff6064b67f1072d4e85b46\",\r\n      \"restaurantname\": \"Super Cafe - Meal\",\r\n      \"taxamount\": 0,\r\n      \"taxitems\": [],\r\n      \"tokenno\": \"O018\",\r\n      \"totalprice\": 50,\r\n      \"transaction\": \"5d429d421b45fa1ad8e2cf78\",\r\n      \"transactions\": [],\r\n      \"acceptedtime\": \"2019-08-01T08:05:33.059Z\",\r\n      \"acceptanceWaitedDuration\": \"-PT3.879S\",\r\n      \"closedtime\": \"2019-08-01T08:15:55.505Z\"\r\n    },\r\n    \"entityId\": \"5825d66df009c4bc37fd7bae\",\r\n    \"lastupdatedby\": \"5d0fb92030928751d16d8e04\",\r\n    \"updatedAt\": \"2019-08-01T08:15:56.307Z\",\r\n    \"id\": \"5d429d4a6729d40a121cc29d\"\r\n  }\r\n}\r\n```\r\n\r\nIn the first order, you can see **data.items** array has only one item i.e **Boil Egg** and the count is 2, whereas in second-order you can see **data.items** array has two items one is **Boil Egg** with count 1 and another is **Dal Rice** with count 1.\r\n\r\nSo I am querying elastic search to just return me the **count** & **total price** of **Boil Egg** irrespective of how many items we have in the array. \r\n\r\nSo the expected output is : \r\n\r\n```\r\n{\r\n          \"key\" : \"Boil Egg \",\r\n          \"doc_count\" : 2,\r\n          \"totalprice\" : {\r\n            \"value\" : 30.0\r\n          },\r\n          \"itemscount\" : {\r\n            \"value\" : 3.0\r\n          }\r\n        }\r\n```\r\n\r\nActual Output is: \r\n\r\n```\r\n{\r\n          \"key\" : \"Boil Egg \",\r\n          \"doc_count\" : 2,\r\n          \"totalprice\" : {\r\n            \"value\" : 70.0\r\n          },\r\n          \"itemscount\" : {\r\n            \"value\" : 4.0\r\n          }\r\n        }\r\n```\r\n\r\nSo what is happening, I am bucketing the menu item but while aggregating it is considering the count and total price of second item i.e Dal Rice in second-order details. \r\n\r\nThis should not be the case. I have tried many things searched on internet but was not able to get the proper solution for this.\r\n\r\nI am not sure whether this is a bug or there is some feature in ES that I am missing over here. ","closed_by":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}