{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31966","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31966/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31966/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31966/events","html_url":"https://github.com/elastic/elasticsearch/issues/31966","id":340250597,"node_id":"MDU6SXNzdWUzNDAyNTA1OTc=","number":31966,"title":"Position offsets incorrect on analysis - not getting results from a phrase query using query_string","user":{"login":"ontology-rory","id":23317326,"node_id":"MDQ6VXNlcjIzMzE3MzI2","avatar_url":"https://avatars1.githubusercontent.com/u/23317326?v=4","gravatar_id":"","url":"https://api.github.com/users/ontology-rory","html_url":"https://github.com/ontology-rory","followers_url":"https://api.github.com/users/ontology-rory/followers","following_url":"https://api.github.com/users/ontology-rory/following{/other_user}","gists_url":"https://api.github.com/users/ontology-rory/gists{/gist_id}","starred_url":"https://api.github.com/users/ontology-rory/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ontology-rory/subscriptions","organizations_url":"https://api.github.com/users/ontology-rory/orgs","repos_url":"https://api.github.com/users/ontology-rory/repos","events_url":"https://api.github.com/users/ontology-rory/events{/privacy}","received_events_url":"https://api.github.com/users/ontology-rory/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"}],"state":"closed","locked":false,"assignee":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"assignees":[{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-07-11T13:49:09Z","updated_at":"2018-07-13T07:58:44Z","closed_at":"2018-07-13T07:58:44Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 6.2.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n```\r\nopenjdk version \"1.8.0_162\"\r\nOpenJDK Runtime Environment (Zulu 8.27.0.7-linux64) (build 1.8.0_162-b01)\r\nOpenJDK 64-Bit Server VM (Zulu 8.27.0.7-linux64) (build 25.162-b01, mixed mode)\r\n```\r\n\r\n**OS version**: `Linux 3.10.0-514.10.2.el7.x86_64 #1 SMP Fri Mar 3 00:04:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI have a document with the text `SAL_S8371 - SAL SUBTEND 0001` in it and perform a `query_string` search where the query is `\"SAL_S8371 - SAL SUBTEND 0001\"`. No documents are returned when I would expect to get a hit for this text.\r\n\r\nWhen I run this text through the `_analyze` endpoint, I noticed that the position offsets are missing a  step when it encounters the dash, i.e. the position of '-' is 3 and the position of 'SAL' is 5 - there is no term at position 4.\r\n\r\nPossibly related to #29021 ?\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. create index\r\n```\r\nPUT testing\r\n{\r\n  \"mappings\": {\r\n    \"raw\": {\r\n      \"_source\": {\r\n        \"includes\": [\r\n          \"*\"\r\n        ],\r\n        \"excludes\": [\r\n          \"OntoAll\"\r\n        ]\r\n      },\r\n      \"properties\": {\r\n        \"OntoID\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"OntoAll\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"OntoFields\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"key\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"value\": {\r\n              \"type\": \"text\",\r\n              \"copy_to\": [\r\n                \"OntoAll\"\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"analysis\": {\r\n        \"filter\": {\r\n          \"OntoFilter\": {\r\n            \"split_on_numerics\": \"true\",\r\n            \"generate_word_parts\": \"true\",\r\n            \"preserve_original\": \"true\",\r\n            \"catenate_words\": \"false\",\r\n            \"generate_number_parts\": \"true\",\r\n            \"catenate_all\": \"false\",\r\n            \"split_on_case_change\": \"true\",\r\n            \"type\": \"word_delimiter_graph\",\r\n            \"catenate_numbers\": \"false\"\r\n          }\r\n        },\r\n        \"analyzer\": {\r\n          \"default\": {\r\n            \"filter\": [\r\n              \"OntoFilter\",\r\n              \"lowercase\"\r\n            ],\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 2. add document\r\n```\r\nPUT testing/raw/id1\r\n{\r\n  \"OntoID\": \"S8371\",\r\n  \"OntoFields\": {\r\n    \"key\": \"prop\",\r\n    \"value\": \"SAL_S8371 - SAL SUBTEND 0001\"\r\n  }\r\n}\r\n```\r\n 3. run query and expected to get 1 result - but get 0\r\n```\r\nGET testing/_search\r\n{\r\n  \"from\": 0,\r\n  \"size\": 10,\r\n  \"query\": {\r\n    \"query_string\": {\r\n      \"query\": \"\\\"SAL_S8371 - SAL SUBTEND 0001\\\"\",\r\n      \"fields\": [\r\n        \"OntoAll\"\r\n      ],\r\n      \"tie_breaker\": 0,\r\n      \"default_operator\": \"and\"\r\n    }\r\n  }\r\n}\r\n```\r\n4. check the query via the `_analyze` endpoint - note position 4 is skipped\r\n```\r\nGET testing/_analyze\r\n{\r\n  \"text\": [\r\n    \"SAL_S8371 - SAL SUBTEND 0001\"\r\n  ]\r\n}\r\n\r\n{\r\n  \"tokens\": [\r\n    {\r\n      \"token\": \"sal_s8371\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 9,\r\n      \"type\": \"word\",\r\n      \"position\": 0,\r\n      \"positionLength\": 3\r\n    },\r\n    {\r\n      \"token\": \"sal\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 3,\r\n      \"type\": \"word\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"s\",\r\n      \"start_offset\": 4,\r\n      \"end_offset\": 5,\r\n      \"type\": \"word\",\r\n      \"position\": 1\r\n    },\r\n    {\r\n      \"token\": \"8371\",\r\n      \"start_offset\": 5,\r\n      \"end_offset\": 9,\r\n      \"type\": \"word\",\r\n      \"position\": 2\r\n    },\r\n    {\r\n      \"token\": \"-\",\r\n      \"start_offset\": 10,\r\n      \"end_offset\": 11,\r\n      \"type\": \"word\",\r\n      \"position\": 3\r\n    },\r\n    {\r\n      \"token\": \"sal\",\r\n      \"start_offset\": 12,\r\n      \"end_offset\": 15,\r\n      \"type\": \"word\",\r\n      \"position\": 5\r\n    },\r\n    {\r\n      \"token\": \"subtend\",\r\n      \"start_offset\": 16,\r\n      \"end_offset\": 23,\r\n      \"type\": \"word\",\r\n      \"position\": 6\r\n    },\r\n    {\r\n      \"token\": \"0001\",\r\n      \"start_offset\": 24,\r\n      \"end_offset\": 28,\r\n      \"type\": \"word\",\r\n      \"position\": 7\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nI noticed that adding `\"phrase_slop\": 1` to the query then resulted in finding the document but feel this shouldn't be required - or that a greater slop maybe required for other queries where more position values are off.\r\n\r\nAlso added a simpler document with a similar query pattern and that works OK - i.e. get the expected result back\r\n\r\n```\r\nPUT testing/raw/id3\r\n{\r\n  \"OntoID\": \"nice\",\r\n  \"OntoFields\": {\r\n    \"key\": \"prop\",\r\n    \"value\": \"gogo - penguin\"\r\n  }\r\n}\r\n```\r\n\r\n```\r\nGET testing/_search\r\n{\r\n  \"from\": 0,\r\n  \"size\": 10,\r\n  \"query\": {\r\n    \"query_string\": {\r\n      \"query\": \"\\\"gogo - penguin\\\"\",\r\n      \"fields\": [\r\n        \"OntoAll\"\r\n      ],\r\n      \"tie_breaker\": 0,\r\n      \"default_operator\": \"and\",\r\n      \"phrase_slop\": 0\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n{\r\n  \"took\": 67,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 1,\r\n    \"max_score\": 0.8630463,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"testing\",\r\n        \"_type\": \"raw\",\r\n        \"_id\": \"id3\",\r\n        \"_score\": 0.8630463,\r\n        \"_source\": {\r\n          \"OntoID\": \"nice\",\r\n          \"OntoFields\": {\r\n            \"key\": \"prop\",\r\n            \"value\": \"gogo - penguin\"\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n","closed_by":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}