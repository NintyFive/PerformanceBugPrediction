{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36880","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36880/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36880/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36880/events","html_url":"https://github.com/elastic/elasticsearch/issues/36880","id":392883833,"node_id":"MDU6SXNzdWUzOTI4ODM4MzM=","number":36880,"title":"GC overhead cause \"Java out of memory\" error when using a synonym file","user":{"login":"ikingme","id":27466250,"node_id":"MDQ6VXNlcjI3NDY2MjUw","avatar_url":"https://avatars1.githubusercontent.com/u/27466250?v=4","gravatar_id":"","url":"https://api.github.com/users/ikingme","html_url":"https://github.com/ikingme","followers_url":"https://api.github.com/users/ikingme/followers","following_url":"https://api.github.com/users/ikingme/following{/other_user}","gists_url":"https://api.github.com/users/ikingme/gists{/gist_id}","starred_url":"https://api.github.com/users/ikingme/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ikingme/subscriptions","organizations_url":"https://api.github.com/users/ikingme/orgs","repos_url":"https://api.github.com/users/ikingme/repos","events_url":"https://api.github.com/users/ikingme/events{/privacy}","received_events_url":"https://api.github.com/users/ikingme/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-12-20T04:28:28Z","updated_at":"2018-12-21T04:00:27Z","closed_at":"2018-12-20T09:50:51Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 5.4.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\njava version \"11\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen using a synonym file in the index mapping declarationï¼Œ the jvm heap will immediately increase by creating indicies. The count of indexes associates with the jvm heap size.  The GC willl over head quickly and finally cause the \"Java out of memory\" error. Elasticsearch will crash. \r\n\r\n**Steps to reproduce**:\r\n\r\n 1. the mapping of the index\r\n\r\n`\r\n{\r\n\t\"mappings\":{\r\n\t\t\"knowledge\":{\r\n\t\t\t\"_all\": {\r\n\t\t\t\t\"enabled\": false\r\n\t\t\t},\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"kq_id\": {\r\n\t\t\t\t\t\"type\": \"integer\"\r\n\t\t\t\t},\r\n\t\t\t\t\"status\": {\r\n\t\t\t\t\t\"type\": \"integer\"\r\n\t\t\t\t},\r\n\t\t\t\t\"k_question_index\": {\r\n\t\t\t\t\t\"type\": \"text\",\r\n\t\t\t\t\t\"analyzer\": \"synonymAnalyzer\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t\"settings\":{\r\n\t\t\"index\":{\r\n\t\t\t\"analysis\": {\r\n\t\t\t\t\"filter\": {\r\n\t\t\t\t\t\"synonymFilter\": {\r\n\t\t\t\t\t\t\"type\": \"synonym\",\r\n\t\t\t\t\t\t\"synonyms_path\": \"analysis/synonymWord.dic\"\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t\"analyzer\": {\r\n\t\t\t\t\t\"synonymAnalyzer\": {\r\n\t\t\t\t\t\t\"filter\": [\r\n\t\t\t\t\t\t\t\"lowercase\",\r\n\t\t\t\t\t\t\t\"synonymFilter\"\r\n\t\t\t\t\t\t],\r\n\t\t\t\t\t\t\"tokenizer\": \"whitespace\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\"number_of_shards\":3,\r\n\t\t\t\"number_of_replicas\":1\r\n\t\t}\r\n\t}\r\n}\r\n`\r\n\r\n 2. The link of the synonyms file: [synonymWord.dic](https://github.com/ikingme/es/blob/master/synonymWord.dic)\r\n 3. Set jvm heap size in the config file:  -Xms4g -Xmx4g\r\n 4. Start the elasticsearch process\r\n 5. Create indicies with the mapping above.  There is no need to index data. Just creating indicies is OK. Generally after no more than 100 indicies were created, the process will crash\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n[2018-12-20T12:15:38,326][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][372] overhead, spent [2.6s] collecting in the last [2.6s]\r\n[2018-12-20T12:15:39,592][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][373] overhead, spent [1.2s] collecting in the last [1.2s]\r\n[2018-12-20T12:15:42,256][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][374] overhead, spent [2.6s] collecting in the last [1.4s]\r\n[2018-12-20T12:15:47,098][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][375] overhead, spent [4s] collecting in the last [5.3s]\r\n[2018-12-20T12:15:49,757][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][376] overhead, spent [3.4s] collecting in the last [3.4s]\r\n[2018-12-20T12:16:00,615][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][377] overhead, spent [9.4s] collecting in the last [9.5s]\r\n[2018-12-20T12:16:04,472][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][378] overhead, spent [5.1s] collecting in the last [5.2s]\r\n[2018-12-20T12:16:16,026][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][379] overhead, spent [11.5s] collecting in the last [11.5s]\r\n[2018-12-20T12:16:20,126][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][380] overhead, spent [2.7s] collecting in the last [2.7s]\r\n[2018-12-20T12:16:25,334][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][381] overhead, spent [6.5s] collecting in the last [5.3s]\r\n[2018-12-20T12:16:26,684][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][382] overhead, spent [1.3s] collecting in the last [2.5s]\r\n[2018-12-20T12:16:29,226][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][383] overhead, spent [2.5s] collecting in the last [1.2s]\r\n[2018-12-20T12:16:35,697][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][384] overhead, spent [6.4s] collecting in the last [7s]\r\n[2018-12-20T12:16:47,941][WARN ][o.e.m.j.JvmGcMonitorService] [fFnUsan] [gc][385] overhead, spent [10.4s] collecting in the last [10.4s]\r\njava.lang.OutOfMemoryError: Java heap space\r\nDumping heap to java_pid74459.hprof ...\r\nHeap dump file created [4393416384 bytes in 8.368 secs]\r\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}