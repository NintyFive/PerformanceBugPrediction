{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33874","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33874/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33874/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33874/events","html_url":"https://github.com/elastic/elasticsearch/issues/33874","id":361964925,"node_id":"MDU6SXNzdWUzNjE5NjQ5MjU=","number":33874,"title":"S3 snapshot fails unable to move the index file blob","user":{"login":"gregolsen","id":287994,"node_id":"MDQ6VXNlcjI4Nzk5NA==","avatar_url":"https://avatars0.githubusercontent.com/u/287994?v=4","gravatar_id":"","url":"https://api.github.com/users/gregolsen","html_url":"https://github.com/gregolsen","followers_url":"https://api.github.com/users/gregolsen/followers","following_url":"https://api.github.com/users/gregolsen/following{/other_user}","gists_url":"https://api.github.com/users/gregolsen/gists{/gist_id}","starred_url":"https://api.github.com/users/gregolsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gregolsen/subscriptions","organizations_url":"https://api.github.com/users/gregolsen/orgs","repos_url":"https://api.github.com/users/gregolsen/repos","events_url":"https://api.github.com/users/gregolsen/events{/privacy}","received_events_url":"https://api.github.com/users/gregolsen/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-09-19T23:32:15Z","updated_at":"2018-09-20T07:07:09Z","closed_at":"2018-09-20T06:11:22Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**: `6.3.0`\r\n\r\n**Plugins installed**: `[discovery-ec2, repository-s3]`\r\n\r\n**JVM version**: `java version \"1.8.0_171\"`\r\n\r\n**OS version** : `Linux 4.14.51-60.38.amzn1.x86_64 #1 SMP Tue Jun 26 23:06:43 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nOccasionally cluster snapshot operation fails with `Failed to finalize snapshot creation` exception caused by `AmazonS3Exception: The specified key does not exist.` (see full stacktrace at the bottom). Resulted snapshot marked as partial. Exception is thrown in `writeAtomic` when moving a newly created temporary index file.\r\nhttps://github.com/elastic/elasticsearch/blob/d879cf44803b176cdebf065814d5079c72d98aa2/server/src/main/java/org/elasticsearch/repositories/blobstore/ChecksumBlobStoreFormat.java#L138\r\nTemporary file itself is created in the same method by `writeBlob` method, which in turn calls `writeBlob` on `S3BlobContainer`. Note that before writing the blob `blobExists` is called to check whether it already exists.\r\nhttps://github.com/elastic/elasticsearch/blob/2b4e7a12c30736bc1400f676239518c41c71406b/plugins/repository-s3/src/main/java/org/elasticsearch/repositories/s3/S3BlobContainer.java#L98-L101\r\n\r\nMost likely the problem is that S3 only guarantees **eventual** consistency for read-after-write in case \"exists\" request was issued before write.\r\nAccording to [S3 documentation (see \"Amazon S3 Data Consistency Model\r\n\" section)](https://docs.aws.amazon.com/AmazonS3/latest/dev/Introduction.html):\r\n> Amazon S3 provides read-after-write consistency for PUTS of new objects in your S3 bucket in all regions with one caveat. The caveat is that if you make a HEAD or GET request to the key name (to find if the object exists) before creating the object, Amazon S3 provides eventual consistency for read-after-write.\r\n\r\nThat's why `move` operation fails with `The specified key does not exist` â€“ before writing the blob its existence is verified, which makes subsequent write operation to be eventually consistent and hence newly written index file is not immediately available.\r\n\r\nAs a potential solution `BlobContainer` interface could be extended with an additional method which writes the blob w/o verifying its existence. `ChecksumBlobStoreFormat` could use that method instead of `writeBlob` to make write operation immediately consistent. To avoid any potential name conflicts `ChecksumBlobStoreFormat#tempBlobName` could have some random part in it.\r\n\r\n**Provide logs (if relevant)**:\r\n<details>\r\n<summary>Full stacktrace</summary>\r\n\r\n```\r\n[2018-09-14T04:00:27,071][WARN ][o.e.s.SnapshotShardsService] [data.localdomain] [[index_name][6]][bucket_name:snapshot_2018-09-14t04:00:10z/vm0BgXHgSRuZad49bQ_OIA]\r\n failed to snapshot shard\r\norg.elasticsearch.index.snapshots.IndexShardSnapshotFailedException: Failed to finalize snapshot creation [snapshot_2018-09-14t04:00:10z/vm0BgXHgSRuZad49bQ_OIA] with shard index [index-54]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:1015) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1255) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:813) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:410) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:97) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:354) [elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:724) [elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.0.jar:6.3.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_171]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_171]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_171]\r\nCaused by: java.io.IOException: com.amazonaws.services.s3.model.AmazonS3Exception: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: 599340CA5D293CCD; S3 Extended Request ID: BJID/TmaSF3GyAt8PYxin+3MQ2F6si83vFqfi3xXlZkNYotCWPBnc9UYsU8PYMKXQ8ffzK8Yluw=), S3 Extended Request ID: BJID/TmaSF3GyAt8PYxin+3MQ2F6si83vFqfi3xXlZkNYotCWPBnc9UYsU8PYMKXQ8ffzK8Yluw=\r\n        at org.elasticsearch.repositories.s3.S3BlobContainer.move(S3BlobContainer.java:177) ~[?:?]\r\n        at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeAtomic(ChecksumBlobStoreFormat.java:138) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:986) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n        ... 10 more\r\n        Suppressed: java.nio.file.NoSuchFileException: Blob [pending-index-54] does not exist\r\n                at org.elasticsearch.repositories.s3.S3BlobContainer.deleteBlob(S3BlobContainer.java:116) ~[?:?]\r\n                at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeAtomic(ChecksumBlobStoreFormat.java:142) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:986) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1255) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:813) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:410) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:97) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:354) [elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:724) [elasticsearch-6.3.0.jar:6.3.0]\r\n                at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.0.jar:6.3.0]\r\n                at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_171]\r\n                at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_171]\r\n                at java.lang.Thread.run(Thread.java:748) [?:1.8.0_171]\r\nCaused by: com.amazonaws.services.s3.model.AmazonS3Exception: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: 599340CA5D293CCD; S3 Extended Request ID: BJID/TmaSF3GyAt8PYxin+3MQ2F6si83vFqfi3xXlZkNYotCWPBnc9UYsU8PYMKXQ8ffzK8Yluw=)\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.handleErrorResponse(AmazonHttpClient.java:1639) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeOneRequest(AmazonHttpClient.java:1304) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeHelper(AmazonHttpClient.java:1056) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.doExecute(AmazonHttpClient.java:743) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeWithTimer(AmazonHttpClient.java:717) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.execute(AmazonHttpClient.java:699) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutor.access$500(AmazonHttpClient.java:667) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient$RequestExecutionBuilderImpl.execute(AmazonHttpClient.java:649) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:513) ~[?:?]\r\n        at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:4247) ~[?:?]\r\n        at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:4194) ~[?:?]\r\n        at com.amazonaws.services.s3.AmazonS3Client.copyObject(AmazonS3Client.java:1870) ~[?:?]\r\n        at org.elasticsearch.repositories.s3.S3BlobContainer.lambda$move$6(S3BlobContainer.java:172) ~[?:?]\r\n        at org.elasticsearch.repositories.s3.SocketAccess.lambda$doPrivilegedVoid$0(SocketAccess.java:57) ~[?:?]\r\n        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_171]\r\n        at org.elasticsearch.repositories.s3.SocketAccess.doPrivilegedVoid(SocketAccess.java:56) ~[?:?]\r\n        at org.elasticsearch.repositories.s3.S3BlobContainer.move(S3BlobContainer.java:171) ~[?:?]\r\n        at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeAtomic(ChecksumBlobStoreFormat.java:138) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n```\r\n</details>\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}