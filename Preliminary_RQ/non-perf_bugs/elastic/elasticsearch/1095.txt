{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1095","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1095/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1095/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1095/events","html_url":"https://github.com/elastic/elasticsearch/issues/1095","id":1174351,"node_id":"MDU6SXNzdWUxMTc0MzUx","number":1095,"title":"Nested Object/Docs Mapping and Searching","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":97023,"node_id":"MDU6TGFiZWw5NzAyMw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.17.0","name":"v0.17.0","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2011-07-06T14:53:18Z","updated_at":"2015-07-29T10:04:30Z","closed_at":"2011-07-06T14:54:13Z","author_association":"MEMBER","active_lock_reason":null,"body":"Nested objects/documents allow to map certain sections in the document indexed as nested allowing to query them as if they are separate docs joining with the parent owning doc.\n\nNote, this feature is experimental and might require reindexing the data if using it.\n\nOne of the problems when indexing inner objects that occur several times in a doc is that \"cross object\" search match will occur, for example:\n\n```\n{\n    \"obj1\" : [\n        {\n            \"name\" : \"blue\",\n            \"count\" : 4\n        },\n        {\n            \"name\" : \"green\",\n            \"count\" : 6\n        }\n    ]\n}\n```\n\nSearching for `name` set to `blue` and `count` higher than `5` will match the doc, because in the first element the `name` matches `blue`, and in the second element, `count` matches \"higher than `5`\".\n## Nested Mapping\n\nNested mapping allow to map certain inner objects (usually multi instance ones), for example:\n\n```\n{\n    \"type1\" : {\n        \"properties\" : {\n            \"obj1\" : {\n                \"type\" : \"nested\"\n            }\n        }\n    }\n}\n```\n\nThe above will cause all `obj1` to be indexed as a nested doc. The mapping is similar in nature to setting `type` to `object`, except that its `nested`.\n\nThe `nested` object fields can also be automatically added to the immediate parent by setting `include_in_parent` to `true`, and also included in the root object by setting `include_in_root` to `true`.\n\nNested docs will also automatically use the root doc `_all` field. \n## Nested Queries\n\nNested queries allow to search within nested docs, resulting in the root parent doc (join), for example:\n\n```\n{\n    \"nested\" : {\n        \"path\" : \"obj1\",\n        \"score_mode\" : \"avg\"\n        \"query\" : {\n            \"bool\" : {\n                \"must\" : [\n                    \"text\" : {\"obj1.name\" : \"blue\"},\n                    \"range\" : {\"obj1.count\" : {\"gt\" : 5}}\n                ]\n            }\n        }\n    }\n}\n```\n\nThe query `path` points to the nested object path, and the `query` (or `filter`) includes the query that will run on the nested docs matching the direct path, and joining with the root parent docs.\n\nThe `score_mode` allows to set how inner children matching affects scoring of parent. It defaults to `avg`, but can be `total`, `max` and `none`.\n\nMulti level nesting is automatically supported, and detected, resulting in an inner nested query to automatically match the relevant nesting level (and not root) if it exists within another nested query.\n## Internal Implementation\n\nInternally, nested objects are indexed as additional documents, but, since they can be guaranteed to be indexed within the same \"block\", it allows for extremely fast joining with parent docs.\n\nThose internal nested documents are automatically masked away when doing operations against the index (like searching with a `match_all` query), and they bubble out when using the nested query.\n## Left Overs\n\nThere are many things to still do to have it as a complete. The most important one is have a good story around faceting and nested docs (it will really enhance it as well, especially for key and value based facets).\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}