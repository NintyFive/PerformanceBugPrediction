{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/64069","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64069/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64069/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64069/events","html_url":"https://github.com/elastic/elasticsearch/issues/64069","id":727450078,"node_id":"MDU6SXNzdWU3Mjc0NTAwNzg=","number":64069,"title":"GetFieldMappingsRequest() called from within an AbstractQueryBuilder returns an empty map","user":{"login":"alexklibisz","id":8015228,"node_id":"MDQ6VXNlcjgwMTUyMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/8015228?v=4","gravatar_id":"","url":"https://api.github.com/users/alexklibisz","html_url":"https://github.com/alexklibisz","followers_url":"https://api.github.com/users/alexklibisz/followers","following_url":"https://api.github.com/users/alexklibisz/following{/other_user}","gists_url":"https://api.github.com/users/alexklibisz/gists{/gist_id}","starred_url":"https://api.github.com/users/alexklibisz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexklibisz/subscriptions","organizations_url":"https://api.github.com/users/alexklibisz/orgs","repos_url":"https://api.github.com/users/alexklibisz/repos","events_url":"https://api.github.com/users/alexklibisz/events{/privacy}","received_events_url":"https://api.github.com/users/alexklibisz/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2020-10-22T14:37:00Z","updated_at":"2020-10-26T16:32:44Z","closed_at":"2020-10-24T22:08:23Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): upgrading from 7.6.2 to 7.9.2\r\n\r\n**Plugins installed**: [elastiknn](https://github.com/alexklibisz/elastiknn) (this issue is in the Elastiknn code)\r\n\r\n**JVM version** (`java -version`): 14\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThere's a part of the Elastiknn plugin that uses the client provided by the `QueryShardContext` (i.e. `context.getClient()`) to make a `GetFieldMappingsRequest()`. Specifically, a `new GetFieldMappingsRequest().indices(nameOfTheIndex).fields(nameOfTheField)`. The exact code is here: https://github.com/alexklibisz/elastiknn/blob/es-792/elastiknn-plugin/src/main/scala/com/klibisz/elastiknn/query/KnnQueryBuilder.scala#L145-L157. It's scala but should be pretty clear what's happening.\r\n\r\nPrior to 7.9.2, this would return basically the same JSON-ish Java Map structure that you'd get from using the `GET _mapping?pretty` endpoint. Now it just returns a map with a single key for the index name and no further values. \r\n\r\nI've made sure that a curl request to the `GET _mapping?pretty` endpoint returns the correct mapping JSON.\r\n\r\nThe broader context here is that I'm updating the custom field mappers to account for changes made between 7.8.x and 7.9.x. Specifically, it looks like there were some changes to the MappedFieldType and FieldType constructs between those versions. Here's the exact diff: https://github.com/alexklibisz/elastiknn/pull/173/files#diff-0d7f259cbb9b71de0625d9bdb96c1fc7b4f896f2e33220b964279116320564b5\r\n\r\n**Steps to reproduce**:\r\n\r\nI can provide a repro but it will take some non-trivial effort to get all the right components in place, given it's a custom plugin.\r\nI'm really hoping there's just some subtlety or tribal knowledge to how I make the request or how I define the custom mapper.\r\nIf not, I'll edit the issue with repro directions.\r\n\r\n**Provide logs (if relevant)**:\r\nN/A\r\n\r\n","closed_by":{"login":"alexklibisz","id":8015228,"node_id":"MDQ6VXNlcjgwMTUyMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/8015228?v=4","gravatar_id":"","url":"https://api.github.com/users/alexklibisz","html_url":"https://github.com/alexklibisz","followers_url":"https://api.github.com/users/alexklibisz/followers","following_url":"https://api.github.com/users/alexklibisz/following{/other_user}","gists_url":"https://api.github.com/users/alexklibisz/gists{/gist_id}","starred_url":"https://api.github.com/users/alexklibisz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexklibisz/subscriptions","organizations_url":"https://api.github.com/users/alexklibisz/orgs","repos_url":"https://api.github.com/users/alexklibisz/repos","events_url":"https://api.github.com/users/alexklibisz/events{/privacy}","received_events_url":"https://api.github.com/users/alexklibisz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}