{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20667","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20667/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20667/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20667/events","html_url":"https://github.com/elastic/elasticsearch/issues/20667","id":179480240,"node_id":"MDU6SXNzdWUxNzk0ODAyNDA=","number":20667,"title":"Moving average shifted","user":{"login":"l8liu","id":7715960,"node_id":"MDQ6VXNlcjc3MTU5NjA=","avatar_url":"https://avatars0.githubusercontent.com/u/7715960?v=4","gravatar_id":"","url":"https://api.github.com/users/l8liu","html_url":"https://github.com/l8liu","followers_url":"https://api.github.com/users/l8liu/followers","following_url":"https://api.github.com/users/l8liu/following{/other_user}","gists_url":"https://api.github.com/users/l8liu/gists{/gist_id}","starred_url":"https://api.github.com/users/l8liu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/l8liu/subscriptions","organizations_url":"https://api.github.com/users/l8liu/orgs","repos_url":"https://api.github.com/users/l8liu/repos","events_url":"https://api.github.com/users/l8liu/events{/privacy}","received_events_url":"https://api.github.com/users/l8liu/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":14,"created_at":"2016-09-27T12:33:29Z","updated_at":"2019-05-16T16:06:52Z","closed_at":"2018-06-01T15:45:46Z","author_association":"NONE","active_lock_reason":null,"body":"I 'm using Elasticsearch 'Moving Average' in the pipeline aggregation to compute the moving average of time series data, but I found the moving average is shifted one day . For example, when I set window = 3, i.e., 3 days moving average, I expect the moving average equals the average of the current day and previous 2 days, but the results are the average of previous 3 days, and not including the current day. The first bucket doesn't include any moving average value because of this.\n\nAlso, could you please consider add a 'Moving Standard deviation' in the future? It will be helpful for the statistical process control.\n\nHere are my codes and results.\n\n```\nGET /tweets-classified*/_search\n{\n  \"size\": 0,\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"query_string\": {\n          \"query\": \"(syndromes.GI: 2) AND (place.country_code: CA)\"\n        }\n      },\n      \"filter\": {\n        \"range\": {\n          \"@timestamp\": {\n            \"gte\": \"2016-01-01\"\n\n          }\n        }\n      }\n    }\n  },\n   \"aggs\": {\n      \"daily_count\": {\n         \"date_histogram\": {\n            \"field\": \"@timestamp\",\n            \"interval\": \"day\"\n         },\n         \"aggs\": {\n            \"the_sum\": {\n               \"sum\": {\n                  \"field\": \"syndromes.GI\"\n             }\n          },\n            \"mvavg\": {\n                \"moving_avg\": {\n                  \"buckets_path\": \"the_sum\",\n                  \"window\": 3,\n                  \"model\": \"simple\"\n                }\n            }\n        }\n    }\n  }\n}\n```\n\n```\n{\n  \"took\": 6470,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 96,\n    \"successful\": 96,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 1940,\n    \"max_score\": 0,\n    \"hits\": []\n  },\n  \"aggregations\": {\n    \"daily_count\": {\n      \"buckets\": [\n        {\n          \"key_as_string\": \"2016-01-01T00:00:00.000Z\",\n          \"key\": 1451606400000,\n          \"doc_count\": 10,\n          \"the_sum\": {\n            \"value\": 20\n          }\n        },\n        {\n          \"key_as_string\": \"2016-01-02T00:00:00.000Z\",\n          \"key\": 1451692800000,\n          \"doc_count\": 9,\n          \"the_sum\": {\n            \"value\": 18\n          },\n          \"mvavg\": {\n            \"value\": 20\n          }\n        },\n        {\n          \"key_as_string\": \"2016-01-03T00:00:00.000Z\",\n          \"key\": 1451779200000,\n          \"doc_count\": 5,\n          \"the_sum\": {\n            \"value\": 10\n          },\n          \"mvavg\": {\n            \"value\": 19\n          }\n        },\n        {\n          \"key_as_string\": \"2016-01-04T00:00:00.000Z\",\n          \"key\": 1451865600000,\n          \"doc_count\": 9,\n          \"the_sum\": {\n            \"value\": 18\n          },\n          \"mvavg\": {\n            \"value\": 16\n          }\n        },\n        {\n          \"key_as_string\": \"2016-01-05T00:00:00.000Z\",\n          \"key\": 1451952000000,\n          \"doc_count\": 12,\n          \"the_sum\": {\n            \"value\": 24\n          },\n          \"mvavg\": {\n            \"value\": 15.333333333333334\n          }\n        },\n        {\n          \"key_as_string\": \"2016-01-06T00:00:00.000Z\",\n          \"key\": 1452038400000,\n          \"doc_count\": 10,\n          \"the_sum\": {\n            \"value\": 20\n          },\n          \"mvavg\": {\n            \"value\": 17.333333333333332\n          }\n        },\n```\n\n.......\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}