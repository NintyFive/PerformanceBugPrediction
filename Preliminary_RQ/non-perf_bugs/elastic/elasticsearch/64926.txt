{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/64926","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64926/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64926/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/64926/events","html_url":"https://github.com/elastic/elasticsearch/issues/64926","id":740787668,"node_id":"MDU6SXNzdWU3NDA3ODc2Njg=","number":64926,"title":"Multiple tests in ClassificationIT are failing","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"assignees":[{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-11-11T13:59:32Z","updated_at":"2020-11-17T12:49:44Z","closed_at":"2020-11-17T12:49:44Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Build scan**: https://gradle-enterprise.elastic.co/s/73luwxfnclwxs\r\n\r\n**Repro line**:\r\n\r\n```\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testWithOnlyTrainingRowsAndTrainingPercentIsFifty_DependentVariableIsBoolean\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testSingleNumericFeatureAndMixedTrainingAndNonTrainingRows\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testUpdateAnalytics\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testSetUpgradeMode_ExistingTaskGetsUnassigned\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testTwoJobsWithSameRandomizeSeedUseSameTrainingSet\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testDependentVariableCardinalityTooHighButWithQueryMakesItWithinRange\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testDependentVariableIsAliasToNested\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testWithOnlyTrainingRowsAndTrainingPercentIsHundred\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testWithOnlyTrainingRowsAndTrainingPercentIsFifty_DependentVariableIsDouble\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n\r\n./gradlew ':x-pack:plugin:ml:qa:native-multi-node-tests:integTestRunner' --tests \"org.elasticsearch.xpack.ml.integration.ClassificationIT.testWithOnlyTrainingRowsAndTrainingPercentIsFifty_DependentVariableIsKeyword\" \\\r\n  -Dtests.seed=1C06ACF456D7250A \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-SY \\\r\n  -Dtests.timezone=Europe/Volgograd \\\r\n  -Druntime.java=8\r\n```\r\n\r\n**Reproduces locally?**: no\r\n\r\n**Applicable branches**: This specific failure happened on `7.9` but build history shows failures on `master` as well.\r\n\r\n**Failure history**:\r\n\r\nWe see [155 failure documents](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-1M,mode:relative,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'class:%22org.elasticsearch.xpack.ml.integration.ClassificationIT%22'),sort:!(time,desc))) in build stats for the prior month.\r\n\r\n**Failure excerpt**:\r\n\r\nLooking at the output this is probably a test setup issue rather than a specific test issue:\r\n\r\n```\r\n10:00:37     java.lang.AssertionError: Stats were: {\"id\":\"classification_training_percent_is_50_boolean\",\"state\":\"starting\",\"progress\":[{\"phase\":\"reindexing\",\"progress_percent\":1},{\"phase\":\"loading_data\",\"progress_percent\":0},{\"phase\":\"feature_selection\",\"progress_percent\":0},{\"phase\":\"coarse_parameter_search\",\"progress_percent\":0},{\"phase\":\"fine_tuning_parameters\",\"progress_percent\":0},{\"phase\":\"final_training\",\"progress_percent\":0},{\"phase\":\"writing_results\",\"progress_percent\":0},{\"phase\":\"inference\",\"progress_percent\":0}],\"data_counts\":{\"training_docs_count\":0,\"test_docs_count\":0,\"skipped_docs_count\":0},\"memory_usage\":{\"peak_usage_bytes\":0,\"status\":\"ok\"},\"node\":{\"id\":\"3JoP5p90RJugcI1l-tjB2w\",\"name\":\"integTest-2\",\"ephemeral_id\":\"JGR_vyedRuavrBcMaERnuw\",\"transport_address\":\"127.0.0.1:38155\",\"attributes\":{\"testattr\":\"test\",\"ml.machine_memory\":\"101375320064\",\"ml.max_open_jobs\":\"20\",\"xpack.installed\":\"true\",\"transform.node\":\"true\"}},\"assignment_explanation\":\"\"}\r\n10:00:37     Expected: <stopped>\r\n10:00:37          but: was <starting>\r\n10:00:37         at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\r\n10:00:37         at org.junit.Assert.assertThat(Assert.java:956)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.assertIsStopped(MlNativeDataFrameAnalyticsIntegTestCase.java:207)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.lambda$waitUntilAnalyticsIsStopped$0(MlNativeDataFrameAnalyticsIntegTestCase.java:157)\r\n10:00:37         at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:951)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.waitUntilAnalyticsIsStopped(MlNativeDataFrameAnalyticsIntegTestCase.java:157)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.waitUntilAnalyticsIsStopped(MlNativeDataFrameAnalyticsIntegTestCase.java:153)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.ClassificationIT.testWithOnlyTrainingRowsAndTrainingPercentIsFifty(ClassificationIT.java:275)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.ClassificationIT.testWithOnlyTrainingRowsAndTrainingPercentIsFifty_DependentVariableIsBoolean(ClassificationIT.java:354)\r\n10:00:37 \r\n10:00:37     java.lang.RuntimeException: Had to resort to force-stopping jobs, something went wrong?\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.stopAnalyticsAndForceStopOnError(MlNativeDataFrameAnalyticsIntegTestCase.java:114)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.cleanUpAnalytics(MlNativeDataFrameAnalyticsIntegTestCase.java:91)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.cleanUpResources(MlNativeDataFrameAnalyticsIntegTestCase.java:87)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.MlNativeIntegTestCase.cleanUp(MlNativeIntegTestCase.java:158)\r\n10:00:37         at org.elasticsearch.xpack.ml.integration.ClassificationIT.cleanup(ClassificationIT.java:90)\r\n10:00:37 \r\n10:00:37         Caused by:\r\n10:00:37         java.lang.IllegalStateException: Timed out when waiting for persistent tasks after 30s\r\n10:00:37             at org.elasticsearch.persistent.PersistentTasksService$2.onTimeout(PersistentTasksService.java:209)\r\n10:00:37             at org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:325)\r\n10:00:37             at org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:252)\r\n10:00:37             at org.elasticsearch.cluster.service.ClusterApplierService$NotifyTimeout.run(ClusterApplierService.java:605)\r\n10:00:37             at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:678)\r\n10:00:37             at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n10:00:37             at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n10:00:37             at java.lang.Thread.run(Thread.java:748)\r\n10:00:37 \r\n10:00:37     java.lang.AssertionError: ClusterHealthResponse has timed out - returned: [{\"cluster_name\":\"integTest\",\"status\":\"red\",\"timed_out\":true,\"number_of_nodes\":2,\"number_of_data_nodes\":2,\"active_primary_shards\":12,\"active_shards\":18,\"relocating_shards\":0,\"initializing_shards\":0,\"unassigned_shards\":2,\"delayed_unassigned_shards\":0,\"number_of_pending_tasks\":0,\"number_of_in_flight_fetch\":0,\"task_max_waiting_in_queue_millis\":0,\"active_shards_percent_as_number\":90.0}]\r\n10:00:37     Expected: is <false>\r\n10:00:37          but: was <true>\r\n10:00:37         at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\r\n10:00:37         at org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertNoTimeout(ElasticsearchAssertions.java:111)\r\n10:00:37         at org.elasticsearch.test.ESIntegTestCase.ensureClusterSizeConsistency(ESIntegTestCase.java:1050)\r\n10:00:37         at org.elasticsearch.test.ESIntegTestCase.afterInternal(ESIntegTestCase.java:575)\r\n10:00:37         at org.elasticsearch.test.ESIntegTestCase.cleanUpCluster(ESIntegTestCase.java:2233)\r\n10:00:37         at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n10:00:37         at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n10:00:37         at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n10:00:37         at java.lang.reflect.Method.invoke(Method.java:498)\r\n10:00:37         at com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1750)\r\n10:00:37         at com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:996)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:49)\r\n10:00:37         at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\r\n10:00:37         at org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\r\n10:00:37         at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\r\n10:00:37         at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:368)\r\n10:00:37         at com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:817)\r\n10:00:37         at com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:468)\r\n10:00:37         at com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:947)\r\n10:00:37         at com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:832)\r\n10:00:37         at com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:883)\r\n10:00:37         at com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:894)\r\n10:00:37         at org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:41)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:53)\r\n10:00:37         at org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\r\n10:00:37         at org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\r\n10:00:37         at org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:54)\r\n10:00:37         at com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n10:00:37         at com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:368)\r\n10:00:37         at java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\n","closed_by":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"performed_via_github_app":null}