[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155856529","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155856529","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155856529,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg1NjUyOQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T17:36:02Z","updated_at":"2015-11-11T17:36:02Z","author_association":"CONTRIBUTOR","body":"We can fix it, here is the deal:\n1. existing 1.x startup scripts had a bug that would add `CWD` to `CLASSPATH` (https://github.com/elastic/elasticsearch/issues/12000). Java classloaders are lenient, so this went undetected forever. In many cases such as running as a service, `CWD` would be `/`, which is terrible: it would mean total read access to all files on the system. So we initially (and still do) jumped through hoops to avoid granting access to what is in `CLASSPATH` etc, since it was too arbitrary and crazy.\n2. as far as ubuntu's agent (#13785), that is unrelated to your situation, in that case its an unwanted agent and its being added in a sneaky way that the user is not aware of. We detect that and kick it out, if you want an agent, it should be that you asked for it explicit (like in your case, where you are asking to run newrelic because you pass `-javaagent:/usr/local/newrelic/newrelic.jar`)\n3. `ES_CLASSPATH` was exposed directly to users, but this is problematic, because most likely it will just result in pain, its not a good or tested way to \"plugin code\", no isolation etc, we have the plugin mechanism for that.\n\nwe fixed and added safety around these situations too in https://github.com/elastic/elasticsearch/pull/13880.\n\nAnyway, I think we can now safely add permissions to `CLASSPATH`, to ensure agents work, since now we defend against the silliness, and that will solve it for your agent or any other agent where the user has explicitly configured it.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155857574","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155857574","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155857574,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg1NzU3NA==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T17:40:15Z","updated_at":"2015-11-11T17:40:15Z","author_association":"CONTRIBUTOR","body":"By the way, this is the best way to workaround it in the meantime: https://docs.oracle.com/javase/tutorial/ext/basics/install.html\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155858462","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155858462","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155858462,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg1ODQ2Mg==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T17:44:09Z","updated_at":"2015-11-11T17:44:09Z","author_association":"CONTRIBUTOR","body":"> I tried setting a custom java policy for my elasticsearch user by creating /usr/share/elasticsearch/.java.policy with the following content:\n\nYeah, we don't read from any of the standard locations and add to our policy. Its worth looking at too, since what you did probably should have worked, but i want to investigate first, just concerned about what kind of stuff might be in these standard locations on various distros etc.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155861427","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155861427","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155861427,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg2MTQyNw==","user":{"login":"krisb78","id":222033,"node_id":"MDQ6VXNlcjIyMjAzMw==","avatar_url":"https://avatars3.githubusercontent.com/u/222033?v=4","gravatar_id":"","url":"https://api.github.com/users/krisb78","html_url":"https://github.com/krisb78","followers_url":"https://api.github.com/users/krisb78/followers","following_url":"https://api.github.com/users/krisb78/following{/other_user}","gists_url":"https://api.github.com/users/krisb78/gists{/gist_id}","starred_url":"https://api.github.com/users/krisb78/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krisb78/subscriptions","organizations_url":"https://api.github.com/users/krisb78/orgs","repos_url":"https://api.github.com/users/krisb78/repos","events_url":"https://api.github.com/users/krisb78/events{/privacy}","received_events_url":"https://api.github.com/users/krisb78/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T17:57:08Z","updated_at":"2015-11-11T17:57:08Z","author_association":"NONE","body":"Thanks a lot, I'll try the workaround.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155863966","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155863966","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155863966,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg2Mzk2Ng==","user":{"login":"krisb78","id":222033,"node_id":"MDQ6VXNlcjIyMjAzMw==","avatar_url":"https://avatars3.githubusercontent.com/u/222033?v=4","gravatar_id":"","url":"https://api.github.com/users/krisb78","html_url":"https://github.com/krisb78","followers_url":"https://api.github.com/users/krisb78/followers","following_url":"https://api.github.com/users/krisb78/following{/other_user}","gists_url":"https://api.github.com/users/krisb78/gists{/gist_id}","starred_url":"https://api.github.com/users/krisb78/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krisb78/subscriptions","organizations_url":"https://api.github.com/users/krisb78/orgs","repos_url":"https://api.github.com/users/krisb78/repos","events_url":"https://api.github.com/users/krisb78/events{/privacy}","received_events_url":"https://api.github.com/users/krisb78/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T18:08:11Z","updated_at":"2015-11-11T18:08:11Z","author_association":"NONE","body":"FTR, I also tried to pass in the policy explicitly by adding `-Djava.security.policy=/usr/share/elasticsearch/.java.policy` to `ES_JAVA_OPTS`, but it didn't work either.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155868249","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155868249","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155868249,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg2ODI0OQ==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T18:26:41Z","updated_at":"2015-11-11T18:26:41Z","author_association":"CONTRIBUTOR","body":"yeah, I see this is the mechanism newrelic support recommends to their users: https://discuss.newrelic.com/t/flux-scheduler-not-able-to-load-newrelic-jar/2114\n\nso its less about us changing our classpath logic I think, changing that would only mean a more confusing exception follows (like newrelic not having access to connect somewhere, write to its log file, something like that). \n\nits more about allowing you to do this in the system files like they recommend (without having to resort to installing it into an extension directory). and if you don't configure access for your agent then it predictably fails on that agent jar.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/155881872","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-155881872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":155881872,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NTg4MTg3Mg==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-11-11T19:12:07Z","updated_at":"2015-11-11T19:12:35Z","author_association":"CONTRIBUTOR","body":"> just concerned about what kind of stuff might be in these standard locations on various distros etc.\n\nits kind of a downer, on java 7 < update 51:\n\n```\n// default permissions granted to all domains\n\ngrant {\n        // Allows any thread to stop itself using the java.lang.Thread.stop()\n        // method that takes no argument.\n        // Note that this permission is granted by default only to remain\n        // backwards compatible.\n        // It is strongly recommended that you either remove this permission\n        // from this policy file or further restrict it to code sources\n        // that you specify, because Thread.stop() is potentially unsafe.\n        // See the API specification of java.lang.Thread.stop() for more\n        // information.\n        permission java.lang.RuntimePermission \"stopThread\";\n\n        // allows anyone to listen on un-privileged ports\n        permission java.net.SocketPermission \"localhost:1024-\", \"listen\";\n```\n\nAfter update 51 the SocketPermission improves into two (they broke back compat here and changed how listen ports are checked, yet kept stopThread for back compat?!?!?!):\n\n```\n        // allows anyone to listen on dynamic ports\n        permission java.net.SocketPermission \"localhost:0\", \"listen\";\n\n        // permission for standard RMI registry port\n        permission java.net.SocketPermission \"localhost:1099\", \"listen\";\n```\n\nOn java 8 and 9 the RMI is cleaned up and removed, but ephemeral port and stopThread remains. Looks like in 9 they work on cleaning up their own house with permissions to jdk internals though, which is a positive.\n\nAnyway, sucking in the system/user configuration naively has some downsides and undoes some work, but its probably what we should do. Just makes life difficult as usual, I'll work up something.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/156059190","html_url":"https://github.com/elastic/elasticsearch/issues/14690#issuecomment-156059190","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14690","id":156059190,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NjA1OTE5MA==","user":{"login":"krisb78","id":222033,"node_id":"MDQ6VXNlcjIyMjAzMw==","avatar_url":"https://avatars3.githubusercontent.com/u/222033?v=4","gravatar_id":"","url":"https://api.github.com/users/krisb78","html_url":"https://github.com/krisb78","followers_url":"https://api.github.com/users/krisb78/followers","following_url":"https://api.github.com/users/krisb78/following{/other_user}","gists_url":"https://api.github.com/users/krisb78/gists{/gist_id}","starred_url":"https://api.github.com/users/krisb78/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/krisb78/subscriptions","organizations_url":"https://api.github.com/users/krisb78/orgs","repos_url":"https://api.github.com/users/krisb78/repos","events_url":"https://api.github.com/users/krisb78/events{/privacy}","received_events_url":"https://api.github.com/users/krisb78/received_events","type":"User","site_admin":false},"created_at":"2015-11-12T10:19:08Z","updated_at":"2015-11-12T10:19:08Z","author_association":"NONE","body":"Awesome, thanks @rmuir !\n","performed_via_github_app":null}]