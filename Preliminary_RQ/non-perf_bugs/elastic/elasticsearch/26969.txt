{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26969","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26969/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26969/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26969/events","html_url":"https://github.com/elastic/elasticsearch/issues/26969","id":264596274,"node_id":"MDU6SXNzdWUyNjQ1OTYyNzQ=","number":26969,"title":"Snapshots to S3 Repository in 5.x cause a much higher object churn/GC than previous versions","user":{"login":"centic9","id":548322,"node_id":"MDQ6VXNlcjU0ODMyMg==","avatar_url":"https://avatars0.githubusercontent.com/u/548322?v=4","gravatar_id":"","url":"https://api.github.com/users/centic9","html_url":"https://github.com/centic9","followers_url":"https://api.github.com/users/centic9/followers","following_url":"https://api.github.com/users/centic9/following{/other_user}","gists_url":"https://api.github.com/users/centic9/gists{/gist_id}","starred_url":"https://api.github.com/users/centic9/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/centic9/subscriptions","organizations_url":"https://api.github.com/users/centic9/orgs","repos_url":"https://api.github.com/users/centic9/repos","events_url":"https://api.github.com/users/centic9/events{/privacy}","received_events_url":"https://api.github.com/users/centic9/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"assignees":[{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-10-11T13:55:56Z","updated_at":"2018-02-14T13:55:49Z","closed_at":"2017-11-10T11:22:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Elasticsearch version: Ok on 2.3.3, Not Ok on 5.3.3\r\nPlugins: S3, EC2\r\nJVM: 1.8.0_102\r\nOS Version: Linux ip-10-176-42-66 4.9.32-15.41.amzn1.x86_64 #1 SMP Thu Jun 22 06:20:54 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\nheap size [4.6gb], compressed ordinary object pointers [true]\r\n\r\nWe have a number of Elasticsearch nodes in multiple clusters on EC2 instances. Previously we were running version 2.3.3, but lately upgraded to 5.3.3.\r\n\r\nWe run Snapshots every hour to back up data regularly to S3.\r\n\r\nSince upgrading from 2.3.3 to 5.3.3 we see a regular pattern of high GC, both in our monitoring (Dynatrace) and the newly introduced gc-logs from Elasticsearch itself. \r\n\r\n![image](https://user-images.githubusercontent.com/548322/31443863-d3d305a8-ae9a-11e7-9a7a-1cf174988a10.png)\r\n\r\nIt seems the Snapshot operation changed in 5.x and now causes quite a large spike in GC activity on the Elasticsearch server. \r\n\r\nWe analyzed this with Java Flight Recorder and it shows that almost all of the memory churn is caused by the constructor S3OutputStream(), which seems to allocate a huge byte[]. 957 allocations of byte[] cause 94GB of memory allocation, this would mean 100MB per invocation of S3ObjectStream(). This matches with the debug-output from S3Repository:\r\n\r\n`[2017-10-11T13:46:28,431][DEBUG][o.e.r.s.S3Repository     ] [i-052912327e74e66e0] using bucket [ruxit-elasticsearch-testbackups], chunk_size [1gb], server_side_encryption [false], buffer_size [100mb], cannedACL [], storageClass []`\r\n\r\nSo it seems the buffer is re-allocated again and again, which causes quite high object churn/GC spikes. I am not sure if it is on-purpose to re-create this buffer continuously or not, so either this re-allocation is wrong or the memory size calculation (see below) does not fit well for 4GB heap instances. (we also see it for 8GB instances, BTW)\r\n\r\nThis is what JFR reports:\r\n\r\n![Java Flight Recorder allocation analyzis](https://user-images.githubusercontent.com/548322/31443429-b8b71616-ae99-11e7-9629-2952e09c88ac.png)\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Use a normal EC2 instance, e.g. m4.large\r\n2. Set up Elasticsearch 5.3.3 using the default setup and add S3 plugins\r\n3. Add some index-data, e.g. in our case 8GB in 12 indices with 3 shards, 0 replicas each\r\n3. Set up an S3 snapshot repository\r\n4. Trigger a snapshot to S3\r\n=> We see GC-logs stating that more than 500ms were spent for GC in 1s:\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2017-10-10T11:10:26,254][INFO ][o.e.m.j.JvmGcMonitorService] [i-052912327e74e66e0] [gc][82970] overhead, spent [258ms] collecting in the last [1s]\r\n[2017-10-10T11:11:02,393][INFO ][o.e.m.j.JvmGcMonitorService] [i-052912327e74e66e0] [gc][83006] overhead, spent [281ms] collecting in the last [1s]\r\n[2017-10-10T11:12:08,671][INFO ][o.e.m.j.JvmGcMonitorService] [i-052912327e74e66e0] [gc][83072] overhead, spent [255ms] collecting in the last [1s]\r\n[2017-10-10T11:13:15,227][INFO ][o.e.s.SnapshotShardsService] [i-052912327e74e66e0] snapshot [s3_repository:snapshot_dost-test-apm-108329_1507633631823/mWeSRcliTSKvN8NYDzApGA] is done\r\n```\r\n\r\n**Additional info**:\r\n\r\nThe buffer size is computed as follows, for 4.6GB, it leads to 100MB\r\n\r\n```\r\n                Math.max(\r\n                        ByteSizeUnit.MB.toBytes(5), // minimum value\r\n                        Math.min(\r\n                                ByteSizeUnit.MB.toBytes(100),\r\n                                JvmInfo.jvmInfo().getMem().getHeapMax().getBytes() / 20)),\r\n```\r\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}