{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13259","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13259/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13259/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13259/events","html_url":"https://github.com/elastic/elasticsearch/issues/13259","id":104365837,"node_id":"MDU6SXNzdWUxMDQzNjU4Mzc=","number":13259,"title":"`beforeIndexShardCreated` listener for indexModule called twice","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2015-09-01T22:17:13Z","updated_at":"2015-10-23T18:01:33Z","closed_at":"2015-10-21T20:12:07Z","author_association":"MEMBER","active_lock_reason":null,"body":"If I have a plugin that registers a listener for `beforeIndexShardCreated` via the `indexModules` endpoint, as so:\n\n``` java\npublic class ListenerPlugin extends Plugin {\n    /** ... other stuff here */\n    @Override\n    public Collection<Module> indexModules(Settings settings) {\n        List<Module> modules = new ArrayList<>(super.indexModules(settings));\n        modules.add(new ListenerModule());\n        return modules;\n    }\n}\n```\n\nAnd then does:\n\n``` java\npublic class Listener extends IndicesLifecycle.Listener {\n\n    @Inject\n    public Listener(Settings settings, IndicesLifecycle indicesLifecycle, Environment env) {\n        indicesLifecycle.addListener(this);\n        System.out.println(\"Listener created!\");\n    }\n\n    @Override\n    public void beforeIndexShardCreated(ShardId shardId, Settings indexSettings) {\n        System.out.println(\"Entering beforeIndexShardCreated()\");\n\n        System.out.println(\"Exiting beforeIndexShardCreated()\");\n    }\n}\n```\n\nI expect that the listener's `beforeIndexShardCreated` method will only be called once for each newly created shard, however, in some cases, it is called twice.\n\nHere's how I reproduced this:\n- Install plugin on all ES nodes\n- Start 3 ES nodes\n- Create an index with 1 primary shard and 0 replicas\n\n``` json\nPOST /myindex\n{\n  \"index\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"data_path\": \"/tmp/bar/foo\",\n    \"shadow_replicas\": true\n  }\n}\n```\n- Verify that the shard is created and I see:\n\nEntering beforeIndexShardCreated()\nExiting beforeIndexShardCreated()\n\n**Once**, in the logs (because 1 shard was created)\n- Relocate the shard from a node to another node via the `_cluster/reroute` API\n\nThen I see this in the logs:\n\n```\n[2015-09-01 15:52:16,468][DEBUG][org.elasticsearch.indices.cluster] [Thermo] [myindex][0] creating shard\nEntering beforeIndexShardCreated()\nExiting beforeIndexShardCreated()\nEntering beforeIndexShardCreated()\nExiting beforeIndexShardCreated()\n```\n\nThe listener is being called twice. Looking through the logs, I see the log line `Listener created!` **twice** on this particular node, once when the index was created but no shards were placed on this node, and another time when the actual shard is moved to the node.\n\nIt looks like we create class more than once per index, which seems like something we should try to avoid?\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}