{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23128","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23128/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23128/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23128/events","html_url":"https://github.com/elastic/elasticsearch/issues/23128","id":206970084,"node_id":"MDU6SXNzdWUyMDY5NzAwODQ=","number":23128,"title":"Similarity setting does not work in es v2.3.3","user":{"login":"nbqyqx","id":14268143,"node_id":"MDQ6VXNlcjE0MjY4MTQz","avatar_url":"https://avatars1.githubusercontent.com/u/14268143?v=4","gravatar_id":"","url":"https://api.github.com/users/nbqyqx","html_url":"https://github.com/nbqyqx","followers_url":"https://api.github.com/users/nbqyqx/followers","following_url":"https://api.github.com/users/nbqyqx/following{/other_user}","gists_url":"https://api.github.com/users/nbqyqx/gists{/gist_id}","starred_url":"https://api.github.com/users/nbqyqx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nbqyqx/subscriptions","organizations_url":"https://api.github.com/users/nbqyqx/orgs","repos_url":"https://api.github.com/users/nbqyqx/repos","events_url":"https://api.github.com/users/nbqyqx/events{/privacy}","received_events_url":"https://api.github.com/users/nbqyqx/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-02-11T09:38:13Z","updated_at":"2017-02-12T11:45:37Z","closed_at":"2017-02-12T11:45:37Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n**Elasticsearch version**:\r\nv2.3.3\r\n\r\n**Plugins installed**: []\r\nhead\r\n\r\n**JVM version**:\r\nopenjdk version \"1.8.0_111\"\r\nOpenJDK Runtime Environment (build 1.8.0_111-b15)\r\nOpenJDK 64-Bit Server VM (build 25.111-b15, mixed mode)\r\n\r\n**OS version**:\r\nLinux es1-test 3.10.0-327.el7.x86_64 #1 SMP Thu Nov 19 22:10:57 UTC 2015 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nSet the similarity in index setting does not work \r\n\r\n**Steps to reproduce**:\r\n 1.create index\r\ncurl -XPUT 'localhost:9200/idx' -d '\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 1,\r\n            \"number_of_replicas\" : 1,\r\n            \"store\": \"memory\"\r\n        },\r\n\r\n        \"similarity\": {\r\n          \"custom_similarity\": {\r\n             \"type\" : \"DFR\",\r\n             \"basic_model\" : \"g\",\r\n              \"after_effect\" : \"l\",\r\n              \"normalization\" : \"h2\",\r\n              \"normalization.h2.c\" : \"3.0\"\r\n          }\r\n        }\r\n    }\r\n}\r\n'\r\n 2.put mapping\r\ncurl -XPUT 'localhost:9200/idx/_mapping/typ' -d '\r\n{\r\n  \"properties\": {\r\n    \"page_id\": {\r\n      \"type\": \"string\",\r\n      \"index\":  \"not_analyzed\"\r\n    },\r\n    \"user_ids\": {\r\n      \"type\": \"string\",\r\n      \"analyzer\": \"standard\",\r\n      \"index_options\": \"docs\",\r\n      \"similarity\": \"custom_similarity\" \r\n    }\r\n  }\r\n}\r\n'\r\n 3.put data\r\ncurl -XPUT 'localhost:9200/idx/typ/1' -d '\r\n{\"page_id\": \"page_wednesday\", \"user_ids\": \"user_7251 user_1829 user_9389 user_1902 user_717 user_2217 user_117 user_877 user_7608 user_8883 user_7322 user_8447 user_3231 user_9430 user_8532 user_8545 user_1795 user_1981 user_7128 user_1785 user_2116 user_10493 user_9394 user_276 user_3254 user_8378 user_1926 user_10535 user_780 user_9278 user_10166 user_1546 user_4575 user_9344 user_8603 user_7304 user_9068 user_9115 user_8462 user_2218 user_1957 user_9851 user_2903 user_1973 user_6733 user_6869 user_7303 user_1809 user_145 user_7292 user_3880\"}\r\n'\r\ncurl -XPUT 'localhost:9200/idx/typ/2' -d '\r\n{\"page_id\": \"page_shows\", \"user_ids\": \"user_9463 user_9149 user_870 user_2451 user_7449 user_6668 user_7784 user_5589 user_902 user_7194 user_5813 user_1829 user_10811 user_9289 user_2954 user_9015 user_6759 user_9086 user_6523 user_9787 user_10949 user_24 user_9837 user_7454 user_1902 user_9657 user_7867 user_2217 user_8660 user_877 user_8405 user_7322 user_1823 user_6789 user_6302 user_7149 user_8663 user_1391 user_6479 user_7874 user_4767 user_1872 user_7834 user_1170 user_518 user_4952 user_8601 user_8228 user_2896 user_446 user_8275 user_6212 user_3270 user_1921 user_6887 user_40 user_9686 user_9515 user_10903 user_2046 user_10781 user_8449 user_4405 user_4481 user_554 user_9645 user_3500 user_2773 user_3509 user_6134 user_4742 user_1795 user_1981 user_1949 user_1915 user_10800 user_2049 user_193 user_1185 user_662 user_2234 user_8363 user_4061 user_455 user_3629 user_10094 user_4778 user_5030 user_8256 user_2482 user_8023 user_8265 user_7654 user_9220 user_7080 user_6721 user_9517 user_3332 user_9019 user_11025 user_9215 user_101 user_3021 user_5548 user_177 user_202 user_9642 user_7606 user_4324 user_7163 user_6898 user_6163 user_484 user_10679 user_9533 user_10303 user_7648 user_10964 user_780 user_3081 user_6904 user_3414 user_3739 user_11219 user_2591 user_5557 user_9266 user_8318 user_9875 user_647 user_7009 user_10016 user_9621 user_2878 user_9076 user_3621 user_1906 user_2023 user_7592 user_135 user_6149 user_1551 user_4222 user_6839 user_475 user_10122 user_1873 user_7561 user_9247 user_10829 user_4631 user_5912 user_3024 user_3675 user_9132 user_10103 user_2237 user_3337 user_7597 user_9542 user_2973 user_8183 user_9480 user_274 user_6947 user_7304 user_7790 user_9211 user_1960 user_9056 user_9165 user_3268 user_3829 user_8988 user_7112 user_2223 user_6002 user_9450 user_2164 user_10567 user_845 user_8805 user_214 user_1957 user_1086 user_930 user_11108 user_2013 user_3816 user_3780 user_3769 user_4274 user_1973 user_8913 user_6148 user_10705 user_9750 user_5282 user_7089 user_3453 user_1968 user_8814 user_1809 user_6256 user_5223 user_6542 user_6387 user_7910 user_363 user_9092 user_1182 user_9009 user_7734 user_8917 user_2077 user_8083 user_3240\"}\r\n'\r\n 4.query data\r\ncurl -XPOST 'localhost:9200/idx/typ/_search?pretty=true' -d'\r\n{\r\n  \"explain\":true,\r\n  \"size\":20,\r\n  \"query\": {\r\n        \"match\" : {\r\n\"user_ids\": \"user_7251 user_1829 user_9389 user_1902 user_717 user_2217 user_117 user_877 user_7608 user_8883 user_7322 user_8447 user_3231 user_9430 user_8532 user_8545 user_1795 user_1981 user_7128 user_1785 user_2116 user_10493 user_9394 user_276 user_3254 user_8378 user_1926 user_10535 user_780 user_9278 user_10166 user_1546 user_4575 user_9344 user_8603 user_7304 user_9068 user_9115 user_8462 user_2218 user_1957 user_9851 user_2903 user_1973 user_6733 user_6869 user_7303 user_1809 user_145 user_7292 user_3880\"       \r\n  \r\n        }\r\n  }\r\n}\r\n'\r\n\r\nthe response shows similarity does not use DFR but the default similarity.\r\n\r\nthe expected is :\r\ncontains below in explanation\r\n \"description\": \"score(DFRSimilarity, doc=0, freq=1.0), computed from:\",\r\n**Provide logs (if relevant)**:\r\n\r\n\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}