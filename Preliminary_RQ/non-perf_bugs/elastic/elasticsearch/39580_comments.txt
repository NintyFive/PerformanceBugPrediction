[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/468755330","html_url":"https://github.com/elastic/elasticsearch/issues/39580#issuecomment-468755330","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39580","id":468755330,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2ODc1NTMzMA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-03-01T18:03:35Z","updated_at":"2019-03-01T18:03:35Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/468796035","html_url":"https://github.com/elastic/elasticsearch/issues/39580#issuecomment-468796035","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39580","id":468796035,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2ODc5NjAzNQ==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2019-03-01T20:10:41Z","updated_at":"2019-03-01T20:10:41Z","author_association":"CONTRIBUTOR","body":"This does reproduce in a FIPS JVM and has to do with the changes introduced in #39408 . We didn't pick this up since we don't run tests in a FIPS JVM in PRs. I will investigate","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/468799527","html_url":"https://github.com/elastic/elasticsearch/issues/39580#issuecomment-468799527","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39580","id":468799527,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2ODc5OTUyNw==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2019-03-01T20:23:11Z","updated_at":"2019-03-01T20:23:11Z","author_association":"CONTRIBUTOR","body":"This has to do with how certificates are read from files in the default java security provider and the security provider offered by BouncyCastle. The former reads the certificate from file in `sun.security.provider.X509Provider` with \r\n\r\n```java\r\n    private Collection<? extends java.security.cert.Certificate>\r\n        parseX509orPKCS7Cert(InputStream is)\r\n        throws CertificateException, IOException\r\n    {\r\n        int peekByte;\r\n        byte[] data;\r\n        PushbackInputStream pbis = new PushbackInputStream(is);\r\n        Collection<X509CertImpl> coll = new ArrayList<>();\r\n\r\n        // Test the InputStream for end-of-stream.  If the stream's\r\n        // initial state is already at end-of-stream then return\r\n        // an empty collection.  Otherwise, push the byte back into the\r\n        // stream and let readOneBlock look for the first certificate.\r\n        peekByte = pbis.read();\r\n        if (peekByte == -1) {\r\n            return new ArrayList<>(0);\r\n        } else {\r\n            pbis.unread(peekByte);\r\n            data = readOneBlock(pbis);\r\n        }\r\n\r\n        // If we end up with a null value after reading the first block\r\n        // then we know the end-of-stream has been reached and no certificate\r\n        // data has been found.\r\n        if (data == null) {\r\n            throw new CertificateException(\"No certificate data found\"); // It throws here in our test !\r\n        }\r\n\r\n        try {\r\n            PKCS7 pkcs7 = new PKCS7(data);\r\n            X509Certificate[] certs = pkcs7.getCertificates();\r\n            // certs are optional in PKCS #7\r\n            if (certs != null) {\r\n                return Arrays.asList(certs);\r\n            } else {\r\n                // no certificates provided\r\n                return new ArrayList<>(0);\r\n            }\r\n        } catch (ParsingException e) {\r\n            while (data != null) {\r\n                coll.add(new X509CertImpl(data));\r\n                data = readOneBlock(pbis);\r\n            }\r\n        }\r\n        return coll;\r\n    }\r\n```\r\n\r\nwhich throws an exception for the malformed file, while the latter reads the certificate from file in `org.bouncycastle.jcajce.provider.CertificateFactory` with \r\n\r\n```java\r\n   public Collection engineGenerateCertificates(InputStream inStream) throws CertificateException {\r\n        List certs = new ArrayList();\r\n        BufferedInputStream in = new BufferedInputStream(inStream);\r\n\r\n        Certificate certificate;\r\n        while((certificate = this.readCertificate(in)) != null) {\r\n            certs.add(certificate);\r\n        }\r\n\r\n        return certs;\r\n    }\r\n```\r\n\r\nthat returns an empty Arraylist and doesn't throw. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/469078792","html_url":"https://github.com/elastic/elasticsearch/issues/39580#issuecomment-469078792","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39580","id":469078792,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTA3ODc5Mg==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2019-03-03T23:50:31Z","updated_at":"2019-03-03T23:50:31Z","author_association":"CONTRIBUTOR","body":"In ssl-config we worked around this by failing if the cert parsing returned and empty list:\r\n- https://github.com/elastic/elasticsearch/blob/6.7/libs/ssl-config/src/main/java/org/elasticsearch/common/ssl/PemUtils.java#L597-L599","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/469085018","html_url":"https://github.com/elastic/elasticsearch/issues/39580#issuecomment-469085018","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39580","id":469085018,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTA4NTAxOA==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2019-03-04T00:54:28Z","updated_at":"2019-03-04T00:54:28Z","author_association":"CONTRIBUTOR","body":"I'm going to mute this on FIPS.","performed_via_github_app":null}]