{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1322","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1322/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1322/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1322/events","html_url":"https://github.com/elastic/elasticsearch/issues/1322","id":1616032,"node_id":"MDU6SXNzdWUxNjE2MDMy","number":1322,"title":"Allow merging shard replicas based on document versions","user":{"login":"rbranson","id":61890,"node_id":"MDQ6VXNlcjYxODkw","avatar_url":"https://avatars1.githubusercontent.com/u/61890?v=4","gravatar_id":"","url":"https://api.github.com/users/rbranson","html_url":"https://github.com/rbranson","followers_url":"https://api.github.com/users/rbranson/followers","following_url":"https://api.github.com/users/rbranson/following{/other_user}","gists_url":"https://api.github.com/users/rbranson/gists{/gist_id}","starred_url":"https://api.github.com/users/rbranson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rbranson/subscriptions","organizations_url":"https://api.github.com/users/rbranson/orgs","repos_url":"https://api.github.com/users/rbranson/repos","events_url":"https://api.github.com/users/rbranson/events{/privacy}","received_events_url":"https://api.github.com/users/rbranson/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"assignees":[{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2011-09-10T22:54:57Z","updated_at":"2015-09-19T16:54:53Z","closed_at":"2015-09-19T16:54:53Z","author_association":"NONE","active_lock_reason":null,"body":"Would it be possible to allow shard replicas to be merged together after a network partition based on the highest version numbers? \n\nClearly this would be optional, as versions would collide or become out-of-sequence in a default configuration. However, for people who desire this functionality, it's easy to generate globally unique, sequential version numbers from the content that won't collide (microsecond timestamp + truncated hash of the doc) on the client side and feed these as version numbers into ElasticSearch.\n\nThe only caveat I can think of is that deletions aren't as straightforward. It seems like the system Cassandra uses, which replaces the stored value with a \"tombstone\" that represents the deletion. The tombstones get cleaned up after a configurable grace time  period. I believe the grace period in Cassandra is 10 days by default -- clearly a very conservative value. This system seems to work well. The delete API already takes a version number, so that could be used to version the tombstones. Again, I think this should be totally optional as keeping tombstones might effect the performance & data size of some existing use cases that don't need this feature. If it isn't optional or doesn't need to be, perhaps the default grace period could be very short, like an hour?\n\nMergeable replicas would allow the an ElasticSearch cluster to operate as an eventually consistent \"AP\" system and could make working with multiple datacenters very feasible out-of-the-box. Currently it works as a \"CP\" system, so the quorum side of a network partition takes precedence and the other side(s) become effectively read-only. It would be nice to be able to continue to receive writes on the non-quorum side(s) and merge these writes into the cluster once it is healed.\n\nCurrently my strategy involves building a completely isolated ES cluster at each datacenter and distributing index updates using a message queue / worker system. Each datacenter has it's own isolated MQ and worker group. Index updates get inserted into a fan-out exchange which inserts an update message in each individual datacenter's outbound queue, which the workers pick up and perform the index update. This is complicated and was error-prone to start, and also introduces adds non-trivial extra cost and latency to the process.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}