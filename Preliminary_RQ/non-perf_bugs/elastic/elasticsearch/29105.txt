{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29105","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29105/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29105/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29105/events","html_url":"https://github.com/elastic/elasticsearch/issues/29105","id":305796440,"node_id":"MDU6SXNzdWUzMDU3OTY0NDA=","number":29105,"title":"Incorrect documentation about multiple awareness attributes","user":{"login":"bittusarkar","id":860447,"node_id":"MDQ6VXNlcjg2MDQ0Nw==","avatar_url":"https://avatars0.githubusercontent.com/u/860447?v=4","gravatar_id":"","url":"https://api.github.com/users/bittusarkar","html_url":"https://github.com/bittusarkar","followers_url":"https://api.github.com/users/bittusarkar/followers","following_url":"https://api.github.com/users/bittusarkar/following{/other_user}","gists_url":"https://api.github.com/users/bittusarkar/gists{/gist_id}","starred_url":"https://api.github.com/users/bittusarkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bittusarkar/subscriptions","organizations_url":"https://api.github.com/users/bittusarkar/orgs","repos_url":"https://api.github.com/users/bittusarkar/repos","events_url":"https://api.github.com/users/bittusarkar/events{/privacy}","received_events_url":"https://api.github.com/users/bittusarkar/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-03-16T04:09:27Z","updated_at":"2018-03-19T07:04:48Z","closed_at":"2018-03-19T07:04:48Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 5.4.1\r\n\r\n**Plugins installed**: N/A\r\n\r\n**JVM version**: 1.8.0_72\r\n\r\n**OS version**: Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**: The documentation [here](https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-awareness.html) is misleading. Copying it below:\r\n```\r\nMultiple awareness attributes can be specified, in which case the combination of values from each attribute is considered to be a separate value.\r\n```\r\n\r\n**Steps to reproduce**:\r\n1. Set up an Elasticsearch cluster with three nodes, say, n1, n2 and n3 with the following configuration:\r\n\r\n- elasticsearch.yml of n1:\r\n```\r\ncluster.name: c2\r\nnode.name: n1\r\ncluster.routing.allocation.awareness.attributes: updateDomain, faultDomain\r\ncluster.routing.allocation.awareness.force.updateDomain.values: 0,1\r\ncluster.routing.allocation.awareness.force.faultDomain.values: 0,1,2\r\nnode.attr.updateDomain: 1\r\nnode.attr.faultDomain: 0\r\n```\r\n- elasticsearch.yml of n2:\r\n```\r\ncluster.name: c2\r\nnode.name: n2\r\ncluster.routing.allocation.awareness.attributes: updateDomain, faultDomain\r\ncluster.routing.allocation.awareness.force.updateDomain.values: 0,1\r\ncluster.routing.allocation.awareness.force.faultDomain.values: 0,1,2\r\nnode.attr.updateDomain: 0\r\nnode.attr.faultDomain: 1\r\n```\r\n- elasticsearch.yml of n3:\r\n```\r\ncluster.name: c2\r\nnode.name: n3\r\ncluster.routing.allocation.awareness.attributes: updateDomain, faultDomain\r\ncluster.routing.allocation.awareness.force.updateDomain.values: 0,1\r\ncluster.routing.allocation.awareness.force.faultDomain.values: 0,1,2\r\nnode.attr.updateDomain: 1\r\nnode.attr.faultDomain: 2\r\n```\r\n 2. Create a test index:\r\n```\r\nPUT idx1\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1, \r\n    \"number_of_replicas\": 1\r\n  }\r\n}\r\n```\r\n 3. Shards should be allocated on either n1 and n2 or n2 and n3. Say, the primary is allocated on n1 and replica is allocated on n2. Try moving the replica to n3:\r\n```\r\nPOST _cluster/reroute?explain\r\n{\r\n  \"commands\": [\r\n    {\r\n      \"move\": {\r\n        \"index\": \"idx1\",\r\n        \"shard\": 0,\r\n        \"from_node\": \"n2\",\r\n        \"to_node\": \"n3\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nIt will fail with the below explanation:\r\n```\r\n{\r\n  \"decider\": \"awareness\",\r\n  \"decision\": \"NO\",\r\n  \"explanation\": \"there are too many copies of the shard allocated to nodes with attribute [updateDomain], there are [2] total configured shard copies for this shard id and [2] total attribute values, expected the allocated shard count per attribute [2] to be less than or equal to the upper bound of the required number of shards per attribute [1]\"\r\n}\r\n```\r\n\r\nWhat this means is that for multiple awareness attributes, each on its own is considered to be a unique value and not a combination of them. If combination was considered to be unique, then the cluster reroute should have worked but it did not. ","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}