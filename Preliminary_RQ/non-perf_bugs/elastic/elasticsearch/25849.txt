{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25849","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25849/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25849/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25849/events","html_url":"https://github.com/elastic/elasticsearch/issues/25849","id":244954026,"node_id":"MDU6SXNzdWUyNDQ5NTQwMjY=","number":25849,"title":"Warnings of \"IllegalStateException: unexpected docvalues type NONE for field '_parent'\" on upgraded index","user":{"login":"robinpower","id":30226658,"node_id":"MDQ6VXNlcjMwMjI2NjU4","avatar_url":"https://avatars0.githubusercontent.com/u/30226658?v=4","gravatar_id":"","url":"https://api.github.com/users/robinpower","html_url":"https://github.com/robinpower","followers_url":"https://api.github.com/users/robinpower/followers","following_url":"https://api.github.com/users/robinpower/following{/other_user}","gists_url":"https://api.github.com/users/robinpower/gists{/gist_id}","starred_url":"https://api.github.com/users/robinpower/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/robinpower/subscriptions","organizations_url":"https://api.github.com/users/robinpower/orgs","repos_url":"https://api.github.com/users/robinpower/repos","events_url":"https://api.github.com/users/robinpower/events{/privacy}","received_events_url":"https://api.github.com/users/robinpower/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-07-24T01:56:40Z","updated_at":"2018-02-14T13:28:08Z","closed_at":"2017-07-24T11:07:20Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.5.0\r\n\r\n**Plugins installed**: [ x-pack ]\r\n\r\n**JVM version** (`java -version`): 1.8.0_92\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n_parent fields on upgraded indices seem to cause, IMHO undesirable and unexpected, IllegalStateException warnings in the logs on startup even though the migration checker and documentation suggests these fields require no action.\r\n\r\nIf we ignore the warning, is it a concern that the upgraded _parent field is not a doc value? For performance perhaps?\r\n\r\n**Steps to reproduce**:\r\n 1. Create an index on 2.4.1\r\n````\r\nPUT test-index\r\n{\r\n  \"mappings\": {\r\n    \"my-child\": {\r\n      \"properties\": {\r\n        \"child-1\": {\r\n          \"type\": \"long\"\r\n        }\r\n      },\r\n      \"_parent\": {\r\n        \"type\": \"my-parent\"\r\n      }\r\n    },\r\n    \"my-parent\": {}\r\n  }\r\n}\r\n````\r\n 2. Add parent and child documents\r\n````\r\nPUT test-index/my-parent/1\r\n{\r\n  \"field-1\": \"testing\"\r\n}\r\n\r\nPUT test-index/my-child/1?parent=1\r\n{\r\n  \"child-1\": 20\r\n}\r\n````\r\n 3. Upgrade to 5.5.0 (or copy 2.4.1 data folder to 5.5.0 data folder) and start\r\n\r\n**Provide logs (if relevant)**:\r\nLogs showing the index getting upgraded without incident:\r\n````\r\n[2017-07-24T11:21:29,740][INFO ][o.e.c.u.IndexFolderUpgrader] [test-index/6_nfai1tT0C9oZpnj6ztyw] upgrading [D:\\work\\Elasticsearch\\elasticsearch-5.5.0 - Upgraded\\data\\batman\\nodes\\0\\indices\\test-index] to new naming convention\r\n[2017-07-24T11:21:29,742][INFO ][o.e.c.u.IndexFolderUpgrader] [test-index/6_nfai1tT0C9oZpnj6ztyw] moved from [D:\\work\\Elasticsearch\\elasticsearch-5.5.0 - Upgraded\\data\\batman\\nodes\\0\\indices\\test-index] to [D:\\work\\Elasticsearch\\elasticsearch-5.5.0 - Upgraded\\data\\batman\\nodes\\0\\indices\\6_nfai1tT0C9oZpnj6ztyw]\r\n````\r\nThe exception that comes shortly thereafter:\r\n````\r\n[2017-07-24T11:21:34,221][WARN ][o.e.i.w.ShardIndexWarmerService] [Z6tXLYo] [test-index][3] failed to warm-up global ordinals for [_parent]\r\norg.elasticsearch.ElasticsearchException: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: unexpected docvalues type NONE for field '_parent' (expected one of [SORTED, SORTED_SET]). Re-index with correct docvalues type.\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:120) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:45) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.IndexWarmer$FieldDataWarmer.lambda$warmReader$1(IndexWarmer.java:141) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.5.0.jar:5.5.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_92]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_92]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_92]\r\nCaused by: java.util.concurrent.ExecutionException: java.lang.IllegalStateException: unexpected docvalues type NONE for field '_parent' (expected one of [SORTED, SORTED_SET]). Re-index with correct docvalues type.\r\n        at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:404) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:115) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        ... 6 more\r\nCaused by: java.lang.IllegalStateException: unexpected docvalues type NONE for field '_parent' (expected one of [SORTED, SORTED_SET]). Re-index with correct docvalues type.\r\n        at org.apache.lucene.index.DocValues.checkField(DocValues.java:212) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n        at org.apache.lucene.index.DocValues.getSortedSet(DocValues.java:306) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVBytesAtomicFieldData.getOrdinalsValues(SortedSetDVBytesAtomicFieldData.java:53) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.fielddata.ordinals.GlobalOrdinalsBuilder.build(GlobalOrdinalsBuilder.java:63) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:127) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.localGlobalDirect(SortedSetDVOrdinalsIndexFieldData.java:45) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.lambda$load$1(IndicesFieldDataCache.java:157) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:401) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:154) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        at org.elasticsearch.index.fielddata.plain.SortedSetDVOrdinalsIndexFieldData.loadGlobal(SortedSetDVOrdinalsIndexFieldData.java:115) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n        ... 6 more\r\n````","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}