{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38080","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38080/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38080/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38080/events","html_url":"https://github.com/elastic/elasticsearch/issues/38080","id":405177180,"node_id":"MDU6SXNzdWU0MDUxNzcxODA=","number":38080,"title":"Plaintext slow logs with multiline causing problems when parsing","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"labels":[{"id":151561891,"node_id":"MDU6TGFiZWwxNTE1NjE4OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Logging","name":":Core/Infra/Logging","color":"0e8a16","default":false,"description":"Log management and logging utilities"},{"id":1163688906,"node_id":"MDU6TGFiZWwxMTYzNjg4OTA2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.7.0","name":"v6.7.0","color":"dddddd","default":false,"description":""},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"assignees":[{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-01-31T10:26:20Z","updated_at":"2019-02-07T10:00:12Z","closed_at":"2019-02-01T07:12:13Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In order to keep the parsing logic consistent across docker and standard deployments, Beats is distinguishing the type of logs (JSON or plaintext) by the first character in a line.\r\nIf the first character is '{' then the JSON logging will be applied, otherwise the plaintext one.\r\n\r\nSlow logs contain source field which wraps the json. When the `index.indexing.slowlog.reformat: false` is set, it will print the JSON as the user provided. Could be that the first line being `\\n`. \r\nThe plaintext log will end up like this:\r\n```\r\n[2018-07-04T21:51:30,411][INFO ][index.indexing.slowlog.index] [v_VJhjV] [metricbeat-6.3.0-2018.07.04/VLKxBLvUSYuIMKzpacGjRg] took[1.7ms], took_millis[1], type[doc], id[s01HZ2QBk9jw4gtgaFtn], routing[], source[\r\n{\r\n  \"@timestamp\":\"2018-07-04T21:27:30.730Z\",\r\n  \"metricset\":{\r\n    \"name\":\"network\",\r\n    \"module\":\"system\",\r\n    \"rtt\":7264},\r\n    \"system\":{\r\n      \"network\":{\r\n        \"name\":\"lo0\",\r\n        \"in\":{\r\n          \"errors\":0,\r\n          \"dropped\":0,\r\n          \"bytes\":77666873,\r\n          \"packets\":244595},\r\n          \"out\":{\r\n            \"packets\":244595,\r\n            \"bytes\":77666873,\r\n            \"errors\":0,\r\n            \"dropped\":0\r\n          }\r\n        }\r\n      },\r\n      \"beat\":{\r\n        \"name\":\"Rados-MacBook-Pro.local\",\r\n        \"hostname\":\"Rados-MacBook-Pro.local\",\r\n        \"version\":\"6.3.0\"\r\n      },\r\n      \"host\":{\r\n        \"name\":\"Rados-MacBook-Pro.local\"\r\n      }\r\n    }]\r\n```\r\n\r\nThis is causing problems for beats, as previously mentioned the first character in a line being `{` means it will try parse it as a JSON\r\n\r\nThe easiet approach will be to remove the `\\n` at the beginning so that the first `{` ends up on the previous line\r\n```\r\n[2018-07-04T21:51:30,411][INFO ][index.indexing.slowlog.index] [v_VJhjV] [metricbeat-6.3.0-2018.07.04/VLKxBLvUSYuIMKzpacGjRg] took[1.7ms], took_millis[1], type[doc], id[s01HZ2QBk9jw4gtgaFtn], routing[], source[{\r\n  \"@timestamp\":\"2018-07-04T21:27:30.730Z\",\r\n...\r\n...\r\n}\r\n```\r\n\r\nThe other approach would be to escape the JSON, but that would make it leas readable. Even less readable in `*.json` logs (escaping twice)\r\n\r\nWe should also schedule work to extract these fields into top level JSON fields in `*.json` logs \r\n\r\nthe original discussion on beats PR\r\nhttps://github.com/elastic/beats/pull/10447/files#r252512969\r\n","closed_by":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"performed_via_github_app":null}