{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33870","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33870/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33870/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33870/events","html_url":"https://github.com/elastic/elasticsearch/issues/33870","id":361878813,"node_id":"MDU6SXNzdWUzNjE4Nzg4MTM=","number":33870,"title":"Completion Suggester for certain search text gives IOException ElasticServer 6.4","user":{"login":"nitineman","id":12403654,"node_id":"MDQ6VXNlcjEyNDAzNjU0","avatar_url":"https://avatars2.githubusercontent.com/u/12403654?v=4","gravatar_id":"","url":"https://api.github.com/users/nitineman","html_url":"https://github.com/nitineman","followers_url":"https://api.github.com/users/nitineman/followers","following_url":"https://api.github.com/users/nitineman/following{/other_user}","gists_url":"https://api.github.com/users/nitineman/gists{/gist_id}","starred_url":"https://api.github.com/users/nitineman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nitineman/subscriptions","organizations_url":"https://api.github.com/users/nitineman/orgs","repos_url":"https://api.github.com/users/nitineman/repos","events_url":"https://api.github.com/users/nitineman/events{/privacy}","received_events_url":"https://api.github.com/users/nitineman/received_events","type":"User","site_admin":false},"labels":[{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"},{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2018-09-19T18:45:47Z","updated_at":"2018-09-20T19:09:47Z","closed_at":"2018-09-20T18:51:59Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, \r\n\r\nI am trying to get some used cases up and running in ElasticSearch 6.4 version on my local machine.\r\n\r\nI have created an index with a mapping required for the autocomplete(type as you search capabilities) amongst other used cases.\r\n\r\nThe issue is with only a few text terms but it works as expected for a few selected text terms(\"kan\") search it gives org.elasticsearch.common.xcontent.XContentParseException and resultantly IOException while trying to fetch the search response from the elastic server.  This term is part of the whole text fields which is indexed as the  \"type\": \"completion\" - something like \"Ideal kan\" . But it still doesn't explain why it will fail only for this text suggester search but for other's with similar characteristics doesn't.\r\n\r\ncurl -X PUT \"localhost:9200/twitter\" -H 'Content-Type: application/json' -d'\r\n{\r\n       \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"autocomplete\": {\r\n          \"tokenizer\": \"autocomplete\",\r\n          \"filter\": [\r\n            \"lowercase\"\r\n          ]\r\n        },\r\n        \"autocomplete_search\": {\r\n          \"tokenizer\": \"lowercase\"\r\n        }\r\n      },\r\n      \"tokenizer\": {\r\n        \"autocomplete\": {\r\n          \"type\": \"edge_ngram\",\r\n          \"min_gram\": 3,\r\n          \"max_gram\": 10,\r\n          \"token_chars\": [\r\n            \"letter\",\r\n            \"digit\",\r\n            \"symbol\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }, \"mappings\": {\r\n            \"tweet\": {\r\n                \"properties\": {\r\n                    \"MongoDocId\": {\r\n                        \"fields\": {\r\n                            \"keyword\": {\r\n                                \"ignore_above\": 256,\r\n                                \"type\": \"keyword\"\r\n                            }\r\n                        },\r\n                        \"type\": \"text\"\r\n                    },\r\n                    \"author\": {\r\n                        \"fields\": {\r\n                            \"keyword\": {\r\n                                \"ignore_above\": 256,\r\n                                \"type\": \"keyword\"\r\n                            }\r\n                        },\r\n                        \"type\": \"text\"\r\n                    },\r\n                    \"comment\": {\r\n                        \"fields\": {\r\n                            \"keyword\": {\r\n                                \"ignore_above\": 2048,\r\n                                \"type\": \"keyword\"\r\n                            }\r\n                        },\r\n                        \"type\": \"text\",\r\n                        \"analyzer\" : \"english\"\r\n                    },\r\n                    \"createdDateTimeStamp\": {\r\n                        \"type\": \"date\"\r\n                    },\r\n                    \"userId\": {\r\n                        \"type\": \"long\"\r\n                    },\r\n                    \"hashTagList\": {\r\n                    \"type\": \"text\",\r\n                        \"fields\": {\r\n                            \"hashtags\": { \r\n              \t\t\t\t\t\t\"type\":  \"keyword\"\r\n            \t\t\t\t},\r\n            \"completetag\": {\r\n              \"type\": \"completion\"\r\n            }\r\n                    }\r\n                },\r\n                    \"docId\": {\r\n                        \"fields\": {\r\n                            \"keyword\": {\r\n                                \"ignore_above\": 256,\r\n                                \"type\": \"keyword\"\r\n                            }\r\n                        },\r\n                        \"type\": \"text\"\r\n                    },\r\n                    \"updated\": {\r\n                        \"type\": \"date\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n'\r\n\r\n\r\n/* Code where I am invoking the java client code for the suggestion based search with certain text terms. */\r\npublic void onApplicationElasticSample(RestHighLevelClient elasticClient) throws IOException {\r\n\t\tSearchRequest searchRequest = new SearchRequest(\"twitter\");\r\n\t\tSearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();\r\n\r\n\t\tCompletionSuggestionBuilder csb = SuggestBuilders.completionSuggestion(\"hashTagList.completetag\").text(\"kan\");\r\n\r\n\t\tSuggestBuilder suggestBuilder = new SuggestBuilder();\r\n\t\tsuggestBuilder.addSuggestion(\"suggest_completer\", csb);\r\n\r\n\t\tsearchSourceBuilder.suggest(suggestBuilder);\r\n\t\tsearchRequest.source(searchSourceBuilder);\r\n\r\n\t\tSearchResponse searchResponse = elasticClient.search(searchRequest, RequestOptions.DEFAULT);\r\n\r\n\t\tSystem.out.println(\"searchResponse :\" + searchResponse);\r\n\r\n\t\tif (searchResponse.getSuggest().getSuggestion(\"suggest_completer\").getEntries().get(0).getOptions().size() > 0)\r\n\t\t\tSystem.out.println(\"searchResponse OTHERS:\" + searchResponse.getSuggest().getSuggestion(\"suggest_completer\")\r\n\t\t\t\t\t.getEntries().get(0).getOptions().get(0));\r\n\t}\r\n\r\n\r\n/** The Exception trace from the application. */\r\n\r\n\r\njava.lang.IllegalStateException: Failed to execute CommandLineRunner\r\n\tat org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:803) ~[spring-boot-2.0.4.RELEASE.jar:2.0.4.RELEASE]\r\n\tat org.springframework.boot.SpringApplication.callRunners(SpringApplication.java:784) ~[spring-boot-2.0.4.RELEASE.jar:2.0.4.RELEASE]\r\n\tat org.springframework.boot.SpringApplication.run(SpringApplication.java:338) ~[spring-boot-2.0.4.RELEASE.jar:2.0.4.RELEASE]\r\n\tat com.mongo.watcher.MongoApplicationWatcher.main(MongoApplicationWatcher.java:93) [classes/:na]\r\nCaused by: java.io.IOException: **Unable to parse response body for Response{requestLine=POST /twitter/_search?typed_keys=true&ignore_unavailable=false&expand_wildcards=open&allow_no_indices=true&search_type=query_then_fetch&batched_reduce_size=512 HTTP/1.1, host=http://localhost:9200, response=HTTP/1.1 200 OK}**\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1275) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1231) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.search(RestHighLevelClient.java:730) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\tat com.mongo.watcher.MongoApplicationWatcher.onApplicationElasticSample(MongoApplicationWatcher.java:166) [classes/:na]\r\n\tat com.mongo.watcher.MongoApplicationWatcher.run(MongoApplicationWatcher.java:111) [classes/:na]\r\n\tat org.springframework.boot.SpringApplication.callRunner(SpringApplication.java:800) ~[spring-boot-2.0.4.RELEASE.jar:2.0.4.RELEASE]\r\n\t... 3 common frames omitted\r\nCaused by: org.elasticsearch.common.xcontent.XContentParseException: [1:1920] [CompletionSuggestionEntryParser] failed to parse field [options]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:316) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseArray(ObjectParser.java:308) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseSub(ObjectParser.java:329) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parse(ObjectParser.java:168) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.apply(ObjectParser.java:182) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.completion.CompletionSuggestion$Entry.fromXContent(CompletionSuggestion.java:257) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.Suggest$Suggestion.parseEntries(Suggest.java:413) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.completion.CompletionSuggestion.fromXContent(CompletionSuggestion.java:126) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.lambda$getDefaultNamedXContents$58(RestHighLevelClient.java:1490) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.NamedXContentRegistry.parseNamedObject(NamedXContentRegistry.java:141) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.support.AbstractXContentParser.namedObject(AbstractXContentParser.java:433) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.parseTypedKeysObject(XContentParserUtils.java:153) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.Suggest$Suggestion.fromXContent(Suggest.java:404) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.Suggest.fromXContent(Suggest.java:187) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.action.search.SearchResponse.innerFromXContent(SearchResponse.java:291) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.action.search.SearchResponse.fromXContent(SearchResponse.java:248) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:1406) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.lambda$performRequestAndParseEntity$9(RestHighLevelClient.java:1232) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1273) ~[elasticsearch-rest-high-level-client-6.4.0.jar:6.4.0]\r\n\t... 8 common frames omitted\r\nCaused by: org.elasticsearch.common.xcontent.XContentParseException: [1:1920] [CompletionOptionParser] _ignored doesn't support values of type: START_ARRAY\r\n\tat org.elasticsearch.common.xcontent.ObjectParser$FieldParser.assertSupports(ObjectParser.java:373) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parse(ObjectParser.java:167) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.apply(ObjectParser.java:182) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.completion.CompletionSuggestion$Entry$Option.fromXContent(CompletionSuggestion.java:356) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.search.suggest.completion.CompletionSuggestion$Entry.lambda$static$0(CompletionSuggestion.java:253) ~[elasticsearch-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.lambda$declareObjectArray$7(AbstractObjectParser.java:184) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.lambda$declareFieldArray$13(AbstractObjectParser.java:212) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.parseArray(AbstractObjectParser.java:230) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.lambda$declareFieldArray$14(AbstractObjectParser.java:212) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.lambda$declareField$1(ObjectParser.java:213) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:314) ~[elasticsearch-x-content-6.4.0.jar:6.4.0]\r\n\t... 26 common frames omitted\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}