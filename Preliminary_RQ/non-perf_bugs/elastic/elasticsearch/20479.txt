{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20479","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20479/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20479/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20479/events","html_url":"https://github.com/elastic/elasticsearch/issues/20479","id":176916600,"node_id":"MDU6SXNzdWUxNzY5MTY2MDA=","number":20479,"title":"Custom analyzer filter scope ","user":{"login":"mbarker","id":999721,"node_id":"MDQ6VXNlcjk5OTcyMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/999721?v=4","gravatar_id":"","url":"https://api.github.com/users/mbarker","html_url":"https://github.com/mbarker","followers_url":"https://api.github.com/users/mbarker/followers","following_url":"https://api.github.com/users/mbarker/following{/other_user}","gists_url":"https://api.github.com/users/mbarker/gists{/gist_id}","starred_url":"https://api.github.com/users/mbarker/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbarker/subscriptions","organizations_url":"https://api.github.com/users/mbarker/orgs","repos_url":"https://api.github.com/users/mbarker/repos","events_url":"https://api.github.com/users/mbarker/events{/privacy}","received_events_url":"https://api.github.com/users/mbarker/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":30,"created_at":"2016-09-14T14:05:35Z","updated_at":"2018-02-13T20:39:44Z","closed_at":"2017-01-12T10:32:51Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.4.0\n\n**Plugins installed**: [kopf]\n\n**JVM version**: 1.8.0_60\n\n**OS version**: OSX 10.11.6 locally, reproducible on CentOS 7.2.1511 as well\n\n**Description of the problem including expected versus actual behavior**:\n\nAfter upgrading to 2.4.0 our templates are no longer functioning from 2.3.3.\n\nWe have our template split up into several templates so we can specify default analyzers per language, and we share analyzers/filters/tokenizers between the templates.\n\n**Steps to reproduce**:\n1. Push a shared template with common analyzers/filters\n\n```\nPOST /_template/analyzers\n{\n  \"template\": \"*\",\n  \"order\": 20,\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"untouched_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"keyword\",\n          \"filter\": [ \"max_length\", \"lowercase\" ]\n        },\n        \"no_stopwords_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"standard\",\n          \"filter\": [ \"max_length\", \"standard\", \"lowercase\" ]\n        }\n      },\n      \"tokenizer\": {\n        \"standard\": {\n          \"type\": \"standard\",\n          \"version\": \"4.4\"\n        }\n      },\n      \"filter\": {\n        \"max_length\": {\n          \"type\": \"length\",\n          \"max\": \"32766\"\n        }\n      }\n    }\n  }\n}\n```\n1. Push a language specific analyzer template, which is a `czech` analyzer referencing a filter from the `analyzers` template.\n\n```\nPOST /_template/analyzer-cs\n{\n  \"template\": \"*-cs\",\n  \"order\": 30,\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"default\": {\n          \"type\": \"czech\",\n          \"filter\": [ \"max_length\" ]\n        }\n      }\n    }\n  }\n}\n```\n1. Push another language specific analyzer template which uses a custom analyzer, referencing some filters from the shared `analyzers` template.\n\n```\nPOST /_template/analyzer-en\n{\n  \"template\": \"*-en\",\n  \"order\": 30,\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"default\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"standard\",\n          \"filter\": [ \"max_length\", \"standard\", \"lowercase\", \"stop_en\" ]\n        }\n      },\n      \"filter\": {\n        \"stop_en\": {\n          \"type\": \"stop\",\n          \"stopwords\": \"_english_\",\n          \"ignore_case\": \"true\"\n        }\n      }\n    }\n  }\n}\n```\n\nThis action fails, resulting in:\n\n```\n2016-09-13 09:52:00,174][DEBUG][action.admin.indices.template.put] [Zartra] failed to put template [analyzers-en]\n[kOccXLKbR5CwAsXCt0v_3w] IndexCreationException[failed to create index]; nested: IllegalArgumentException[Custom Analyzer [default] failed to find filter under name [max_length]];\n```\n\nHowever, as you see the first `analyzer-cs` was able to reference the `max_length` filter without issue.\n\nThese templates worked fine in 2.3.3 and 2.3.4, haven't tried 2.3.5 but it sounds like there weren't any changes to that release. Reading over release notes for 2.4.0 don't seem to indicate anything that would prevent this functionality from being supported. \n\nWe were seeing similar issues with referencing the shared analyzers in our mapping template file.\n\n**Provide logs (if relevant)**:\n\n```\n    2016-09-13 09:52:00,174][DEBUG][action.admin.indices.template.put] [Zartra] failed to put template [analyzers-en]\n    [kOccXLKbR5CwAsXCt0v_3w] IndexCreationException[failed to create index]; nested: IllegalArgumentException[Custom Analyzer [default] failed to find filter under name [max_length]];\n        at org.elasticsearch.indices.IndicesService.createIndex(IndicesService.java:360)\n        at org.elasticsearch.cluster.metadata.MetaDataIndexTemplateService.validateAndAddTemplate(MetaDataIndexTemplateService.java:196)\n        at org.elasticsearch.cluster.metadata.MetaDataIndexTemplateService.access$200(MetaDataIndexTemplateService.java:57)\n        at org.elasticsearch.cluster.metadata.MetaDataIndexTemplateService$2.execute(MetaDataIndexTemplateService.java:157)\n        at org.elasticsearch.cluster.ClusterStateUpdateTask.execute(ClusterStateUpdateTask.java:45)\n        at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:468)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n    Caused by: java.lang.IllegalArgumentException: Custom Analyzer [default] failed to find filter under name [max_length]\n        at org.elasticsearch.index.analysis.CustomAnalyzerProvider.build(CustomAnalyzerProvider.java:76)\n        at org.elasticsearch.index.analysis.AnalysisService.<init>(AnalysisService.java:216)\n        at org.elasticsearch.index.analysis.AnalysisService.<init>(AnalysisService.java:70)\n        at sun.reflect.GeneratedConstructorAccessor6.newInstance(Unknown Source)\n        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n        at java.lang.reflect.Constructor.newInstance(Constructor.java:422)\n        at org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:50)\n        at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\n        at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:104)\n        at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\n        at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:886)\n        at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\n        at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\n        at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:46)\n        at org.elasticsearch.common.inject.SingleParameterInjector.inject(SingleParameterInjector.java:42)\n        at org.elasticsearch.common.inject.SingleParameterInjector.getAll(SingleParameterInjector.java:66)\n        at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:85)\n        at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:104)\n        at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\n        at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:886)\n        at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\n        at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\n        at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:46)\n        at org.elasticsearch.common.inject.SingleParameterInjector.inject(SingleParameterInjector.java:42)\n        at org.elasticsearch.common.inject.SingleParameterInjector.getAll(SingleParameterInjector.java:66)\n        at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:85)\n        at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:104)\n        at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\n        at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:886)\n        at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\n        at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\n        at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:46)\n        at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:201)\n        at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:193)\n        at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:879)\n        at org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:193)\n        at org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:175)\n        at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:110)\n        at org.elasticsearch.common.inject.InjectorImpl.createChildInjector(InjectorImpl.java:154)\n        at org.elasticsearch.common.inject.ModulesBuilder.createChildInjector(ModulesBuilder.java:55)\n        at org.elasticsearch.indices.IndicesService.createIndex(IndicesService.java:358)\n        ... 11 more\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}