{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21372","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21372/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21372/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21372/events","html_url":"https://github.com/elastic/elasticsearch/issues/21372","id":187713412,"node_id":"MDU6SXNzdWUxODc3MTM0MTI=","number":21372,"title":"ES script error when upgrade from 2.1.0 to 5.0.0","user":{"login":"small-tomorrow","id":16282334,"node_id":"MDQ6VXNlcjE2MjgyMzM0","avatar_url":"https://avatars3.githubusercontent.com/u/16282334?v=4","gravatar_id":"","url":"https://api.github.com/users/small-tomorrow","html_url":"https://github.com/small-tomorrow","followers_url":"https://api.github.com/users/small-tomorrow/followers","following_url":"https://api.github.com/users/small-tomorrow/following{/other_user}","gists_url":"https://api.github.com/users/small-tomorrow/gists{/gist_id}","starred_url":"https://api.github.com/users/small-tomorrow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/small-tomorrow/subscriptions","organizations_url":"https://api.github.com/users/small-tomorrow/orgs","repos_url":"https://api.github.com/users/small-tomorrow/repos","events_url":"https://api.github.com/users/small-tomorrow/events{/privacy}","received_events_url":"https://api.github.com/users/small-tomorrow/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-11-07T13:36:59Z","updated_at":"2016-11-09T07:58:00Z","closed_at":"2016-11-07T14:00:43Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**:\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: Java HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)\r\n\r\n**OS version**: Linux version 2.6.32_1-15-0-0 \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n    after upgrading from v2.1 to 5.0 , the query scripts seem not to work anymore . however,I have followed the doc reference of Version 5.0 as configured : **script.legacy.default_lang: groovy** ,but it seems not work ,as the error log shows in the **Provide logs** part bellow.\r\n    my question is : **is there a way to set the default script lang instead of setting lang params in each query script ?**  **any advice will be great appreciated !**\r\n**Steps to reproduce**:\r\n 1. upgrade from V 2.1 to V 5.0\r\n 2. script query failed \r\n 3. how can I set the default script lang without changing my service code (which is too much) ?\r\n\r\n**Provide logs (if relevant)**:\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: [reduce] \r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.onFailure(SearchQueryThenFetchAsyncAction.java:143) [elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:490) [elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.0.0.jar:5.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_111]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_111]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_111]\r\nCaused by: org.elasticsearch.script.ScriptException: compile error\r\n\tat org.elasticsearch.painless.PainlessScriptEngineService.convertToScriptException(PainlessScriptEngineService.java:264) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessScriptEngineService.compile(PainlessScriptEngineService.java:176) ~[?:?]\r\n\tat org.elasticsearch.script.ScriptService.compileInternal(ScriptService.java:339) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.script.ScriptService.compile(ScriptService.java:235) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.pipeline.bucketscript.BucketScriptPipelineAggregator.reduce(BucketScriptPipelineAggregator.java:95) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:144) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms$Bucket.reduce(InternalTerms.java:135) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(InternalTerms.java:234) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:142) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.merge(SearchPhaseController.java:493) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.doRun(SearchQueryThenFetchAsyncAction.java:132) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\t... 3 more\r\nCaused by: java.lang.IllegalArgumentException: Variable [sum_total] is not defined.\r\n\tat org.elasticsearch.painless.Executable$Script.compile(sum_total / sum_count @ <inline script>:1) ~[?:?]\r\n\tat org.elasticsearch.painless.Locals.getVariable(Locals.java:171) ~[?:?]\r\n\tat org.elasticsearch.painless.Locals.getVariable(Locals.java:169) ~[?:?]\r\n\tat org.elasticsearch.painless.node.EVariable.analyze(EVariable.java:55) ~[?:?]\r\n\tat org.elasticsearch.painless.node.EBinary.analyzeDiv(EBinary.java:145) ~[?:?]\r\n\tat org.elasticsearch.painless.node.EBinary.analyze(EBinary.java:72) ~[?:?]\r\n\tat org.elasticsearch.painless.node.SExpression.analyze(SExpression.java:56) ~[?:?]\r\n\tat org.elasticsearch.painless.node.SSource.analyze(SSource.java:190) ~[?:?]\r\n\tat org.elasticsearch.painless.node.SSource.analyze(SSource.java:162) ~[?:?]\r\n\tat org.elasticsearch.painless.Compiler.compile(Compiler.java:104) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessScriptEngineService$2.run(PainlessScriptEngineService.java:171) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessScriptEngineService$2.run(PainlessScriptEngineService.java:168) ~[?:?]\r\n\tat java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_111]\r\n\tat org.elasticsearch.painless.PainlessScriptEngineService.compile(PainlessScriptEngineService.java:168) ~[?:?]\r\n\tat org.elasticsearch.script.ScriptService.compileInternal(ScriptService.java:339) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.script.ScriptService.compile(ScriptService.java:235) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.pipeline.bucketscript.BucketScriptPipelineAggregator.reduce(BucketScriptPipelineAggregator.java:95) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:144) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms$Bucket.reduce(InternalTerms.java:135) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(InternalTerms.java:234) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:142) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.merge(SearchPhaseController.java:493) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.doRun(SearchQueryThenFetchAsyncAction.java:132) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n\t... 3 more\r\n\r\n<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n\r\n**Describe the feature**:\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}