[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/52913425","html_url":"https://github.com/elastic/elasticsearch/issues/7372#issuecomment-52913425","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7372","id":52913425,"node_id":"MDEyOklzc3VlQ29tbWVudDUyOTEzNDI1","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-08-21T12:35:42Z","updated_at":"2014-08-21T12:36:26Z","author_association":"MEMBER","body":"Problem seems to be the JTS thinks there is an intersection between two edges which are not at the end points of those edges.  The edges in question can be found in the following gist (there actually may be other cases of intersecting edges but JTS throws an exception on the first one it finds): https://gist.github.com/colings86/ee11d2d5a413014c46e3\n\nThe code in JTS which detects this intersection is in RobustLineIntersector line 166 (the exception is thrown from a different location later on).  \n\nThis seems to be a rounding issue somewhere but as yet I don't know where (or even whether this is a happening in ES code or in JTS)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/156134525","html_url":"https://github.com/elastic/elasticsearch/issues/7372#issuecomment-156134525","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7372","id":156134525,"node_id":"MDEyOklzc3VlQ29tbWVudDE1NjEzNDUyNQ==","user":{"login":"bogensberger","id":1038966,"node_id":"MDQ6VXNlcjEwMzg5NjY=","avatar_url":"https://avatars1.githubusercontent.com/u/1038966?v=4","gravatar_id":"","url":"https://api.github.com/users/bogensberger","html_url":"https://github.com/bogensberger","followers_url":"https://api.github.com/users/bogensberger/followers","following_url":"https://api.github.com/users/bogensberger/following{/other_user}","gists_url":"https://api.github.com/users/bogensberger/gists{/gist_id}","starred_url":"https://api.github.com/users/bogensberger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bogensberger/subscriptions","organizations_url":"https://api.github.com/users/bogensberger/orgs","repos_url":"https://api.github.com/users/bogensberger/repos","events_url":"https://api.github.com/users/bogensberger/events{/privacy}","received_events_url":"https://api.github.com/users/bogensberger/received_events","type":"User","site_admin":false},"created_at":"2015-11-12T15:14:35Z","updated_at":"2015-11-12T15:14:35Z","author_association":"CONTRIBUTOR","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/158663189","html_url":"https://github.com/elastic/elasticsearch/issues/7372#issuecomment-158663189","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7372","id":158663189,"node_id":"MDEyOklzc3VlQ29tbWVudDE1ODY2MzE4OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-21T17:21:14Z","updated_at":"2015-11-21T17:21:14Z","author_association":"CONTRIBUTOR","body":"@nknize one to think about for your work replacing jTS\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/351691191","html_url":"https://github.com/elastic/elasticsearch/issues/7372#issuecomment-351691191","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7372","id":351691191,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MTY5MTE5MQ==","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"created_at":"2017-12-14T11:58:24Z","updated_at":"2017-12-14T11:58:24Z","author_association":"CONTRIBUTOR","body":"Any news regarding this? It still seems to be an issue with JTS coming from the following code:\r\n\r\n```\r\n    protected JtsGeometry jtsGeometry(Geometry geom) {\r\n        //dateline180Check is false because ElasticSearch does it's own dateline wrapping\r\n        JtsGeometry jtsGeometry = new JtsGeometry(geom, SPATIAL_CONTEXT, false, MULTI_POLYGON_MAY_OVERLAP);\r\n        if (AUTO_VALIDATE_JTS_GEOMETRY)\r\n            jtsGeometry.validate();\r\n        if (AUTO_INDEX_JTS_GEOMETRY)\r\n            jtsGeometry.index();\r\n        return jtsGeometry;\r\n    }\r\n```\r\n\r\nThe stack trace is very clear about it\r\n\r\n```\r\n[2017-12-14T09:44:41,687][DEBUG][o.e.a.b.TransportShardBulkAction] [bGXdNiM] [test][4] failed to execute bulk item (index) BulkShardRequest [[test][4]] containing [index {[test][incident][AWBU10K79QsC6f7f66N0], source[n/a, actual length: [1.3mb], max length: 2kb]}]\r\norg.elasticsearch.index.mapper.MapperParsingException: failed to parse [affected_area]\r\n\tat org.elasticsearch.index.mapper.GeoShapeFieldMapper.parse(GeoShapeFieldMapper.java:473) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:468) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n...\r\n...\r\n...\r\nCaused by: org.locationtech.spatial4j.exception.InvalidShapeException: Self-intersection at or near point (-89.76905934507116, 29.318118373985925, NaN)\r\n\tat org.locationtech.spatial4j.shape.jts.JtsGeometry.validate(JtsGeometry.java:127) ~[spatial4j-0.6.jar:?]\r\n\tat org.elasticsearch.common.geo.builders.ShapeBuilder.jtsGeometry(ShapeBuilder.java:94) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.build(PolygonBuilder.java:226) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n\tat org.elasticsearch.common.geo.builders.GeometryCollectionBuilder.build(GeometryCollectionBuilder.java:148) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n\tat org.elasticsearch.index.mapper.GeoShapeFieldMapper.parse(GeoShapeFieldMapper.java:455) ~[elasticsearch-5.6.1.jar:5.6.1]\r\n\t... 61 more\r\n```\r\n\r\nThis is coming from the following validation: https://github.com/locationtech/jts/blob/master/modules/core/src/main/java/org/locationtech/jts/operation/valid/IsValidOp.java#L296-L303 . \r\n\r\nTo me it seems to be that the issue is clearly coming from `JTS` rather than Elasticsearch itself?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/351728670","html_url":"https://github.com/elastic/elasticsearch/issues/7372#issuecomment-351728670","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7372","id":351728670,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MTcyODY3MA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-14T14:38:39Z","updated_at":"2017-12-14T14:39:08Z","author_association":"CONTRIBUTOR","body":"The [sample failing polygon](https://gist.github.com/GaelTadh/f9ccae0c703451786da6) genuinely does self-intersect as reported:\r\n\r\n```\r\n              ...\r\n              [\r\n                -0.0688679,\r\n                51.4773\r\n              ],\r\n              [\r\n                -0.0688818,\r\n                51.4773\r\n              ],\r\n              [\r\n                -0.0688079,\r\n                51.4773\r\n              ],\r\n              ...\r\n```\r\n\r\nThere is no rounding error here, nor a problem with resolution: these three points all have equal latitude and the longitudes are not in order, so the polygon's boundary does intersect itself. It looks like this:\r\n\r\n<img width=\"393\" alt=\"screen shot 2017-12-14 at 14 31 35\" src=\"https://user-images.githubusercontent.com/5058284/33997297-ced1afaa-e0db-11e7-8230-66700abea7c2.png\">\r\n\r\n","performed_via_github_app":null}]