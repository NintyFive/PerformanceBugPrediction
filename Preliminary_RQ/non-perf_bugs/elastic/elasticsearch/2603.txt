{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2603","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2603/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2603/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2603/events","html_url":"https://github.com/elastic/elasticsearch/issues/2603","id":10441640,"node_id":"MDU6SXNzdWUxMDQ0MTY0MA==","number":2603,"title":"Term frequency settings for different types in the same index seem to get squashed if fields have the same name","user":{"login":"pvulgaris","id":1030026,"node_id":"MDQ6VXNlcjEwMzAwMjY=","avatar_url":"https://avatars1.githubusercontent.com/u/1030026?v=4","gravatar_id":"","url":"https://api.github.com/users/pvulgaris","html_url":"https://github.com/pvulgaris","followers_url":"https://api.github.com/users/pvulgaris/followers","following_url":"https://api.github.com/users/pvulgaris/following{/other_user}","gists_url":"https://api.github.com/users/pvulgaris/gists{/gist_id}","starred_url":"https://api.github.com/users/pvulgaris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pvulgaris/subscriptions","organizations_url":"https://api.github.com/users/pvulgaris/orgs","repos_url":"https://api.github.com/users/pvulgaris/repos","events_url":"https://api.github.com/users/pvulgaris/events{/privacy}","received_events_url":"https://api.github.com/users/pvulgaris/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2013-01-30T00:55:52Z","updated_at":"2014-07-08T19:36:51Z","closed_at":"2014-07-08T19:36:51Z","author_association":"NONE","active_lock_reason":null,"body":"Seems to happen when adding a lot of data quickly. Here's the PHP code that replicates the issue:\n\n``` PHP\n<?php\n\nexec('curl -XDELETE http://localhost:9200/test_index/');\nexec('curl -XPUT http://localhost:9200/test_index/');\nexec('curl -XPUT http://localhost:9200/test_index/type1/_mapping -d \\''.\n  json_encode(array('type1' => array('properties' =>\n    array('body' => array('type' => 'string'))))).'\\'');\nexec('curl -XPUT http://localhost:9200/test_index/type2/_mapping -d \\''.\n  json_encode(array('type2' => array('properties' =>\n    array('body' => array('type' => 'string',\n      'omit_term_freq_and_positions' => true))))).'\\'');\n\nfor ($j = 0; $j < 1000; $j++) {\n\n  $docs = array();\n  $type = ($j == 0) ? 'type1' : 'type'.rand(1, 2);\n\n  for ($i = 0; $i < 1000; $i++) {\n    $docs[] = array('index' => array('_id' => ($j * 1000 + $i + 1)));\n    $docs[] = array('body' => 'test string');\n  }\n\n  exec(\"curl -XPUT http://localhost:9200/test_index/{$type}/_bulk -d '\".\n    implode(\"\\n\", array_map('json_encode', $docs)).'\\'');\n\n  // This sleep isn't even necessary, it's just there to prove that\n  // the phrase match works at least once. Without it, this loop exits\n  // after the first match on my comp.\n  sleep(1);\n\n  $line = system('curl -XGET http://localhost:9200/test_index/type1/1/_explain -d \\''.\n      json_encode(array('query' => array('match_phrase' => array(\n        'body' => 'test string')))).'\\'');\n\n  // Term frequency for the phrase will go to zero when\n  // the bug hits (I think during segment mergeing).\n  if (strstr($line, 'phraseFreq=0.0') !== false) {\n    exit;\n  }\n\n}\n```\n\nIf you change the names of the fields (\"body\"), the issue does not happen. I think the problem stems from corruption during segment merging. I didn't dig in too deeply, but disabling segment merging in the Lucene library kept the issue from happening. This seems to affect 0.19 and 0.20. Might be losing other metadata as well, but I was only concerned with phrase matching.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}