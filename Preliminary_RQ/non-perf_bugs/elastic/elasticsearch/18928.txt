{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18928","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18928/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18928/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18928/events","html_url":"https://github.com/elastic/elasticsearch/issues/18928","id":160719451,"node_id":"MDU6SXNzdWUxNjA3MTk0NTE=","number":18928,"title":"Upgrading cluster from 1.7 to 2.3 mapper attachment plugin copied data but not mapping settings","user":{"login":"pholly","id":3717650,"node_id":"MDQ6VXNlcjM3MTc2NTA=","avatar_url":"https://avatars0.githubusercontent.com/u/3717650?v=4","gravatar_id":"","url":"https://api.github.com/users/pholly","html_url":"https://github.com/pholly","followers_url":"https://api.github.com/users/pholly/followers","following_url":"https://api.github.com/users/pholly/following{/other_user}","gists_url":"https://api.github.com/users/pholly/gists{/gist_id}","starred_url":"https://api.github.com/users/pholly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pholly/subscriptions","organizations_url":"https://api.github.com/users/pholly/orgs","repos_url":"https://api.github.com/users/pholly/repos","events_url":"https://api.github.com/users/pholly/events{/privacy}","received_events_url":"https://api.github.com/users/pholly/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-06-16T17:43:16Z","updated_at":"2016-06-21T08:40:37Z","closed_at":"2016-06-21T07:53:29Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\nUpgrading from 1.7 to 2.3.3\n\n**Mapper Attachment version**\nUpgrading from 2.7.1(version targeted for es1.7) to 2.3.3\n\n**JVM version**:\n1.8.0_91\n\n**OS version**:\nWindows Server 2012 R2 Standard\n\n**Description of the problem including expected versus actual behavior**:\nI'm upgrading our 1.7 cluster to the latest 2.3 cluster. We have 2 nodes but the topology of our cluster isn't relevant for this issue.\n\nAfter successfully upgrading our cluster I noticed the mapping for our attachment fields did not carry over. Starting with mapper attachment version 3.0.3 the meta field containing the indexed attachment content changed from the name of the field to \"content\". The upgrade successfully copied my data to the new \"content\" meta field but the field settings (analyzer, term vectors) were not copied over. This is important because the data was indexed using English analyzer and that's how it's stored in the field. I verified this by returning script field document(\"field.content\") to see what data is actually in the field.\n\nThis concrete example will explain it much better:\n\nThis is my attachment field mapping in ES1.7\n\n``` javascript\n\"contentPdf\": {\n        \"path\": \"full\",\n        \"type\": \"attachment\",\n        \"fields\": {\n          \"date\": {\n            \"format\": \"dateOptionalTime\",\n            \"type\": \"date\"\n          },\n          \"keywords\": {\n            \"type\": \"string\"\n          },\n          \"content_type\": {\n            \"type\": \"string\"\n          },\n          \"author\": {\n            \"type\": \"string\"\n          },\n          \"name\": {\n            \"type\": \"string\"\n          },\n          \"language\": {\n            \"type\": \"string\"\n          },\n          \"title\": {\n            \"type\": \"string\"\n          },\n          \"contentPdf\": {\n            \"analyzer\": \"english\",\n            \"term_vector\": \"with_positions_offsets\",\n            \"store\": true,\n            \"type\": \"string\",\n            \"fields\": {\n              \"standard\": {\n                \"analyzer\": \"standard\",\n                \"type\": \"string\"\n              }\n            }\n          },\n          \"content_length\": {\n            \"store\": true,\n            \"type\": \"string\"\n          }\n        }\n```\n\nThere you can see the meta field with the actual indexed content is called `contentPdf` - has to be the same name as the property field name. There I set an `english` analyzer, `term_vector`, `store`, and a sub field with a `standard` analyzer.\n\nAfter upgrading both ES and the mapper plugin to 2.3.3 this is my mapping\n\n``` javascript\n\"contentPdf\": {\n        \"path\": \"full\",\n        \"type\": \"attachment\",\n        \"fields\": {\n          \"date\": {\n            \"format\": \"epoch_millis||dateOptionalTime\",\n            \"type\": \"date\"\n          },\n          \"keywords\": {\n            \"type\": \"string\"\n          },\n          \"content_type\": {\n            \"type\": \"string\"\n          },\n          \"contentPdf.content\": {\n            \"type\": \"string\",\n            \"index_name\": \"contentPdf\"\n          },\n          \"author\": {\n            \"type\": \"string\"\n          },\n          \"name\": {\n            \"type\": \"string\"\n          },\n          \"language\": {\n            \"type\": \"string\"\n          },\n          \"title\": {\n            \"type\": \"string\"\n          },\n          \"content_length\": {\n            \"store\": true,\n            \"type\": \"string\"\n          }\n        }\n```\n\nAs you can see, the field properties were not copied over from `contentPdf` meta field to `contentPdf.content`. The plugin also added `index_name` for backwards compatibility I believe.\n\nI verified the data was copied by running a query and specifying script fields so I could see what was actually in the index:\n\n``` javascript\n\"script_fields\": {\n    \"pdf content\": {\n      \"script\": \"doc['contentPdf']\"\n    }\n  },\n```\n\n**Problems this causes**\n1. Attachment field can't be queried properly because the analyzer info is gone. Since I was using an `english` analyzer all words were indexed with their stemmed form but stemming is not applied when queried. Future documents will be indexed using default analyzer (`standard`) for the content field.\n2. Hit highlighting will not work without `term_vectors: with_positions_offsets` and `store: true`.\n\n**Solution if this is not fixed**\nAfter I realized the mapping was not copied over, I reverted to ES1.7 and attempted to add a `content` meta field with correct settings to my `contentPdf` property using PUT mapping API, hoping that during the upgrade the data will be copied to a field that already has the correct mapping. Unfortunately attachment fields do not let you add any other meta fields. I verified this by creating another attachment field with test meta fields and my test meta fields were not taken. \n\nThe only alternative I see is to reindex into a 2.3 cluster then switch over to the new cluster. This is what we are preparing to do right now.\n\n**Steps to reproduce**:\n1. Use PUT mapping API to create a type with an `attachment` property and set `\"term_vector\": \"with_positions_offsets\",\n           \"store\": true` on the meta field with the same name as the property. E.g.\n\n``` javascript\n{\n  \"TestDoc\": {\n     \"properties\" :{\n        \"myAttachment\": {\n        \"type\": \"attachment\",\n        \"fields\": {\n          \"myAttachment\": {\n            \"term_vector\": \"with_positions_offsets\",\n            \"store\": true,\n            \"type\": \"string\"\n          }\n     }\n }\n}\n```\n1. Index a document with a base64 encoded binary file as the content of the `myAttachment` field\n2. Shut down all nodes in cluster, upgrade ES and mapper plugin to 2.3.3, restart cluster\n   1.  Data will now be in `myAttachment.content` field but the mappings for that field will be missing.\n\nThanks!\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}