{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38/events","html_url":"https://github.com/elastic/elasticsearch/issues/38","id":137941,"node_id":"MDU6SXNzdWUxMzc5NDE=","number":38,"title":"Terms results differs between one node and multiple","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":23175,"node_id":"MDU6TGFiZWwyMzE3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.05.0","name":"v0.05.0","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2010-02-22T21:02:37Z","updated_at":"2010-03-02T17:17:18Z","closed_at":"2010-02-25T19:45:28Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"hiya\n\nWhen I run 'terms' queries against multiple nodes, I get incorrect results with these shard failures:\n\n```\n  \"reason\" : \"BroadcastShardOperationFailedException[[es_test_2][2] ]; nested: RemoteTransportException[[Thumb, Tom][inet[/127.0.0.2:9302]][indices/terms/shard]]; nested: ArrayIndexOutOfBoundsException[23]; \"\n```\n\nStart one server, then run this script.  It pauses to allow you to stop the server, then to start 3 nodes, then it shows the diff between the two runs:\n\n```\n#!/bin/bash\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/'  -d '\n{}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/'  -d '\n{}'\ncurl -XPUT 'http://127.0.0.2:9200/_all/type_1/_mapping?ignoreDuplicates=false'  -d '\n{\"properties\":{\"num\":{\"store\":\"yes\",\"type\":\"integer\"},\"text\":{\"store\":\"yes\",\"type\":\"string\"}}}'\ncurl -XPUT 'http://127.0.0.2:9200/_all/type_2/_mapping?ignoreDuplicates=false'  -d '\n{\"properties\":{\"num\":{\"store\":\"yes\",\"type\":\"integer\"},\"text\":{\"store\":\"yes\",\"type\":\"string\"}}}'\ncurl -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \nsleep 2;\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/1'  -d '\n{\"num\":2,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/2'  -d '\n{\"num\":3,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/3'  -d '\n{\"num\":4,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/4'  -d '\n{\"num\":5,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/5'  -d '\n{\"num\":6,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/6'  -d '\n{\"num\":7,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/7'  -d '\n{\"num\":8,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/8'  -d '\n{\"num\":9,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/9'  -d '\n{\"num\":10,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/10'  -d '\n{\"num\":11,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/11'  -d '\n{\"num\":12,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/12'  -d '\n{\"num\":13,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/13'  -d '\n{\"num\":14,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/14'  -d '\n{\"num\":15,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/15'  -d '\n{\"num\":16,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/16'  -d '\n{\"num\":17,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/17'  -d '\n{\"num\":18,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/18'  -d '\n{\"num\":19,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/19'  -d '\n{\"num\":20,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/20'  -d '\n{\"num\":21,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/21'  -d '\n{\"num\":22,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/22'  -d '\n{\"num\":23,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/23'  -d '\n{\"num\":24,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/24'  -d '\n{\"num\":25,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/25'  -d '\n{\"num\":26,\"text\":\"foo baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/26'  -d '\n{\"num\":27,\"text\":\"foo baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/27'  -d '\n{\"num\":28,\"text\":\"foo baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/28'  -d '\n{\"num\":29,\"text\":\"foo baz\"}'\ncurl -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \nsleep 2\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/30'  -d '\n{\n   \"text\" : \"foo\"\n}\n'\n\ncurl -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true'\" > log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true' >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/es_test_1/_terms?pretty=true&fields=text&toInclusive=true'\" >> log_1\ncurl -XGET 'http://127.0.0.2:9200/es_test_1/_terms?pretty=true&fields=text&toInclusive=true' >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&minFreq=17'\" >> log_1 \ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&minFreq=17' >> log_1 \n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&maxFreq=16&fields=text&toInclusive=true'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&maxFreq=16&fields=text&toInclusive=true'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&size=2&fields=text&toInclusive=true'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&size=2&fields=text&toInclusive=true'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&sort=freq&fields=text&toInclusive=true'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&sort=freq&fields=text&toInclusive=true'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=true'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=true'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz&fromInclusive=false'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz&fromInclusive=false'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=false'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=false'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&prefix=ba'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&prefix=ba'  >> log_1\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&regexp=foo|baz'\"  >> log_1\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&regexp=foo|baz'  >> log_1\n  #########################################################################\n\n\necho \"\n\nNow kill the current server, and start 3 nodes, then press Enter\n\n\"\n\nread\n\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/'  -d '\n{}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/'  -d '\n{}'\ncurl -XPUT 'http://127.0.0.2:9200/_all/type_1/_mapping?ignoreDuplicates=false'  -d '\n{\"properties\":{\"num\":{\"store\":\"yes\",\"type\":\"integer\"},\"text\":{\"store\":\"yes\",\"type\":\"string\"}}}'\ncurl -XPUT 'http://127.0.0.2:9200/_all/type_2/_mapping?ignoreDuplicates=false'  -d '\n{\"properties\":{\"num\":{\"store\":\"yes\",\"type\":\"integer\"},\"text\":{\"store\":\"yes\",\"type\":\"string\"}}}'\ncurl -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \nsleep 2;\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/1'  -d '\n{\"num\":2,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/2'  -d '\n{\"num\":3,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/3'  -d '\n{\"num\":4,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/4'  -d '\n{\"num\":5,\"text\":\"foo\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/5'  -d '\n{\"num\":6,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/6'  -d '\n{\"num\":7,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/7'  -d '\n{\"num\":8,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/8'  -d '\n{\"num\":9,\"text\":\"foo bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/9'  -d '\n{\"num\":10,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/10'  -d '\n{\"num\":11,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/11'  -d '\n{\"num\":12,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/12'  -d '\n{\"num\":13,\"text\":\"foo bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/13'  -d '\n{\"num\":14,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/14'  -d '\n{\"num\":15,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/15'  -d '\n{\"num\":16,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/16'  -d '\n{\"num\":17,\"text\":\"bar baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/17'  -d '\n{\"num\":18,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/18'  -d '\n{\"num\":19,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/19'  -d '\n{\"num\":20,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/20'  -d '\n{\"num\":21,\"text\":\"baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/21'  -d '\n{\"num\":22,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/22'  -d '\n{\"num\":23,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/23'  -d '\n{\"num\":24,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/24'  -d '\n{\"num\":25,\"text\":\"bar\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/25'  -d '\n{\"num\":26,\"text\":\"foo baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_2/26'  -d '\n{\"num\":27,\"text\":\"foo baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/27'  -d '\n{\"num\":28,\"text\":\"foo baz\"}'\ncurl -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/28'  -d '\n{\"num\":29,\"text\":\"foo baz\"}'\ncurl -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \nsleep 2\ncurl -XPUT 'http://127.0.0.2:9200/es_test_1/type_1/30'  -d '\n{\n   \"text\" : \"foo\"\n}\n'\n\ncurl -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true'\" > log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true' >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/es_test_1/_terms?pretty=true&fields=text&toInclusive=true'\" >> log_2\ncurl -XGET 'http://127.0.0.2:9200/es_test_1/_terms?pretty=true&fields=text&toInclusive=true' >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&minFreq=17'\" >> log_2 \ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&minFreq=17' >> log_2 \n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&maxFreq=16&fields=text&toInclusive=true'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&maxFreq=16&fields=text&toInclusive=true'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&size=2&fields=text&toInclusive=true'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&size=2&fields=text&toInclusive=true'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&sort=freq&fields=text&toInclusive=true'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&sort=freq&fields=text&toInclusive=true'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=true'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=true'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz&fromInclusive=false'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&from=baz&fromInclusive=false'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=false'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&to=baz&fields=text&toInclusive=false'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&prefix=ba'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&prefix=ba'  >> log_2\n\necho \"\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&regexp=foo|baz'\"  >> log_2\ncurl -XGET 'http://127.0.0.2:9200/_terms?pretty=true&fields=text&toInclusive=true&regexp=foo|baz'  >> log_2\n\necho \"\n\n\n\n\nShowing diff:\n\"\n\ndiff -y --left-column log_1 log_2\n```\n","closed_by":null,"performed_via_github_app":null}