{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40984","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40984/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40984/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40984/events","html_url":"https://github.com/elastic/elasticsearch/issues/40984","id":430639169,"node_id":"MDU6SXNzdWU0MzA2MzkxNjk=","number":40984,"title":"SQL provides incorrect results when sorting by an aggregation and using LIMIT","user":{"login":"alexfrancoeur","id":25181823,"node_id":"MDQ6VXNlcjI1MTgxODIz","avatar_url":"https://avatars1.githubusercontent.com/u/25181823?v=4","gravatar_id":"","url":"https://api.github.com/users/alexfrancoeur","html_url":"https://github.com/alexfrancoeur","followers_url":"https://api.github.com/users/alexfrancoeur/followers","following_url":"https://api.github.com/users/alexfrancoeur/following{/other_user}","gists_url":"https://api.github.com/users/alexfrancoeur/gists{/gist_id}","starred_url":"https://api.github.com/users/alexfrancoeur/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexfrancoeur/subscriptions","organizations_url":"https://api.github.com/users/alexfrancoeur/orgs","repos_url":"https://api.github.com/users/alexfrancoeur/repos","events_url":"https://api.github.com/users/alexfrancoeur/events{/privacy}","received_events_url":"https://api.github.com/users/alexfrancoeur/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1296382697,"node_id":"MDU6TGFiZWwxMjk2MzgyNjk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.7.2","name":"v6.7.2","color":"dddddd","default":false,"description":""},{"id":1306883601,"node_id":"MDU6TGFiZWwxMzA2ODgzNjAx","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.1","name":"v7.0.1","color":"dddddd","default":false,"description":""},{"id":1222918656,"node_id":"MDU6TGFiZWwxMjIyOTE4NjU2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.2.0","name":"v7.2.0","color":"DDDDDD","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"assignees":[{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-04-08T20:18:24Z","updated_at":"2019-04-16T20:02:11Z","closed_at":"2019-04-16T19:40:30Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n`7.0.0-rc1`\r\n\r\n**Plugins installed**: []\r\nnone\r\n\r\n**JVM version** (`java -version`):\r\n```\r\njava version \"1.8.0_121\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_121-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n`Darwin Alexs-MacBook-Pro-2.local 18.5.0 Darwin Kernel Version 18.5.0: Mon Mar 11 20:40:32 PDT 2019; root:xnu-4903.251.3~3/RELEASE_X86_64 x86_64`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nIn Canvas I\"m running the following query\r\n\r\n```sql\r\nSELECT source.geo.country_iso_code country, count(*) total\r\nFROM \"filebeat-*\"\r\nGROUP BY country\r\nORDER BY total desc\r\n```\r\nand getting\r\n\r\n![image (28)](https://user-images.githubusercontent.com/25181823/55753926-898e5700-5a19-11e9-8744-c6e2ca2b6305.png)\r\n\r\nWhen I run the following query\r\n\r\n```sql\r\nSELECT source.geo.country_iso_code country, count(*) total\r\nFROM \"filebeat-*\"\r\nGROUP BY country\r\nORDER BY total desc\r\nLIMIT 5\r\n```\r\n\r\nI'd expect to get US, IT, FR, DE, MX but instead I get \r\n\r\n![image (29)](https://user-images.githubusercontent.com/25181823/55754018-b93d5f00-5a19-11e9-97aa-a82fef66ef1a.png)\r\n\r\nTranslate returns\r\n\r\n```json\r\n{\r\n  \"size\" : 0,\r\n  \"_source\" : false,\r\n  \"stored_fields\" : \"_none_\",\r\n  \"aggregations\" : {\r\n    \"groupby\" : {\r\n      \"composite\" : {\r\n        \"size\" : 5,\r\n        \"sources\" : [\r\n          {\r\n            \"164180\" : {\r\n              \"terms\" : {\r\n                \"field\" : \"source.geo.country_iso_code\",\r\n                \"missing_bucket\" : true,\r\n                \"order\" : \"asc\"\r\n              }\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis seems to be a bug with LIMIT and ordering by an aggregation\r\n\r\ncc: @astefan @costin ","closed_by":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"performed_via_github_app":null}