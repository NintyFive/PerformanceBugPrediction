{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20728","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20728/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20728/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20728/events","html_url":"https://github.com/elastic/elasticsearch/issues/20728","id":180776505,"node_id":"MDU6SXNzdWUxODA3NzY1MDU=","number":20728,"title":"Unable to access source from inside nested script","user":{"login":"silentsea90","id":6876946,"node_id":"MDQ6VXNlcjY4NzY5NDY=","avatar_url":"https://avatars3.githubusercontent.com/u/6876946?v=4","gravatar_id":"","url":"https://api.github.com/users/silentsea90","html_url":"https://github.com/silentsea90","followers_url":"https://api.github.com/users/silentsea90/followers","following_url":"https://api.github.com/users/silentsea90/following{/other_user}","gists_url":"https://api.github.com/users/silentsea90/gists{/gist_id}","starred_url":"https://api.github.com/users/silentsea90/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/silentsea90/subscriptions","organizations_url":"https://api.github.com/users/silentsea90/orgs","repos_url":"https://api.github.com/users/silentsea90/repos","events_url":"https://api.github.com/users/silentsea90/events{/privacy}","received_events_url":"https://api.github.com/users/silentsea90/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2016-10-03T23:58:39Z","updated_at":"2016-10-07T18:43:36Z","closed_at":"2016-10-07T18:43:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 4.2.1\n\n**JVM version**:1.8\n\n**Description of the problem including expected versus actual behavior**:\nI don't get any results for queries over nested fields, even though the script does work as expected for non nested fields. The reason, as I observed while debugging my wildcard script is that I fetch source() in the script which tends to be empty when I keep my script inside nested, but returns one document per successive call when querying over non nested fields.\n\nMy guess is that it has to do with nested fields having their own separate document, and the docId provided for the document when used to fetch source can not be fetched from inside nested field?\n\n**Steps to reproduce**:\nThe mapping looks like this:\n\n```\nproperties =  {  \n         address = {  \n            type=nested,\n            properties=            {  \n               street=               {  \n                  type=string,\n                  fielddata=                  {  \n                     format=disabled\n                  }\n               },\n               zip=               {  \n                  type=long\n               }\n            }\n         },\n         age=         {  \n            type=long\n         },\n         designation=         {  \n            type=string,\n            fielddata=            {  \n               format=disabled\n            }\n         },\n         eventTimestamp=         {  \n            type=date,\n            format=strict_date_optional_time||epoch_millis\n         },\n         pickupTimestamp=         {  \n            type=date,\n            format=strict_date_optional_time||epoch_millis\n         },\n         user=         {  \n            type=string,\n            index=not_analyzed\n         }\n      }\n   }\n```\n\n**The query looks like this:**\n\n```\n{\n  \"size\" : 10000,\n  \"timeout\" : 30000,\n  \"query\" : {\n    \"bool\" : {\n      \"must\" : [ {\n        \"match_all\" : { }\n      }, {\n        \"nested\" : {\n          \"query\" : {\n            \"script\" : {\n              \"script\" : {\n                \"inline\" : \"MyNativePluginScript\",\n                \"lang\" : \"native\",\n                \"params\" : {\n                  \"params\" : \"eyJmaWVsZF9uYW1lIjoiYWRkcmVzcy5zdHJlZXQiLCJxdWVyeV9zdHJpbmciOiIqUyoifQ==\"\n                }\n              }\n            }\n          },\n          \"path\" : \"address\"\n        }\n      } ]\n    }\n  },\n  \"sort\" : [ {\n    \"eventTimestamp\" : {\n      \"order\" : \"desc\"\n    }\n  } ]\n}\n```\n\n**TL;DR**: Script fetches empty source() when kept inside nested construct, but returns valid source() when not nested.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}