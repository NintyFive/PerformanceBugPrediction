{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27073","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27073/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27073/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27073/events","html_url":"https://github.com/elastic/elasticsearch/issues/27073","id":267410555,"node_id":"MDU6SXNzdWUyNjc0MTA1NTU=","number":27073,"title":"Dangling indices living in non-data nodes are detected and auto-imported","user":{"login":"tsouza","id":122435,"node_id":"MDQ6VXNlcjEyMjQzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/122435?v=4","gravatar_id":"","url":"https://api.github.com/users/tsouza","html_url":"https://github.com/tsouza","followers_url":"https://api.github.com/users/tsouza/followers","following_url":"https://api.github.com/users/tsouza/following{/other_user}","gists_url":"https://api.github.com/users/tsouza/gists{/gist_id}","starred_url":"https://api.github.com/users/tsouza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsouza/subscriptions","organizations_url":"https://api.github.com/users/tsouza/orgs","repos_url":"https://api.github.com/users/tsouza/repos","events_url":"https://api.github.com/users/tsouza/events{/privacy}","received_events_url":"https://api.github.com/users/tsouza/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"assignees":[{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false}],"milestone":null,"comments":16,"created_at":"2017-10-21T20:12:04Z","updated_at":"2019-01-25T13:22:49Z","closed_at":"2019-01-25T13:22:49Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n```\r\nVersion: 5.5.3, Build: 9305a5e/2017-09-07T15:56:59.599Z, JVM: 1.8.0_151\r\n```\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): \r\n```\r\njava version \"1.8.0_151\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_151-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Darwin Thiagos-MacBook-Pro.local 17.0.0 Darwin Kernel Version 17.0.0: Thu Aug 24 21:48:19 PDT 2017; root:xnu-4570.1.46~2/RELEASE_X86_64 x86_64`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIf a non-data node, that contains dangling indices in it's data path, joins a cluster these dangling indices will be detected and auto-imported.\r\n\r\nIMO, a non-data node that contains index data in it's data path is probably accidental and unintended. In this case, those dangling indices should not be detected, better yet if the node does not even starts (maybe a bootstrap check that fails if a non-data node contains index data in it's data path).\r\n\r\n**Steps to reproduce**:\r\n\r\nThis can be done in a single machine:\r\n 1. Start `node-1` with `bin/elasticsearch -E path.data=/Users/thiago/data-1 -E node.name=node-1`\r\n 2. Start `node-2` with `bin/elasticsearch -E path.data=/Users/thiago/data-2 -E node.name=node-2`\r\n 3. Create an index `test` configured with `1S/0R` with `curl -XPUT localhost:9200/test -d '{ \"settings\": { \"index\": { \"number_of_shards\": 1, \"number_of_replicas\": 0 }  } }' -H \"Content-Type: application/json\"`\r\n 4. Create a document `curl -XPOST localhost:9200/test -d '{ \"test\": 1 }' -H \"Content-Type: application/json\"`\r\n 5. Stop both nodes\r\n 6. Check which data directory, either `data-1` or `data-2`, that the shard for index `test` was created in and delete the _other_ empty data directory (so we effectively make a dangling index). \r\n 7. Consider that `data-2` was deleted. So start `node-2` again with `bin/elasticsearch -E path.data=/Users/thiago/data-2 -E node.name=node-2`\r\n 8. Start `node-1` (which contains dangling indices) as a non-data node with `bin/elasticsearch -E path.data=/Users/thiago/data-1 -E node.name=node-1 -E node.data=false`\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nAfter non-data node `node-1` starts, `node-2` will detect and auto-import dangling indices even though `node-1` is a non-data node: \r\n```\r\n[2017-10-21T18:02:14,158][INFO ][o.e.g.LocalAllocateDangledIndices] [node-2] auto importing dangled indices [[test/R2Nh9sERThmkJ-0IZ0ppwA]/OPEN] from [{node-1}{RqWMW2AeSXWOpkUm4cT1TA}{lEqpWLIhRqqU_n1DSFuv2Q}{127.0.0.1}{127.0.0.1:9301}]\r\n```\r\n\r\n","closed_by":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"performed_via_github_app":null}