[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135205266","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135205266","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135205266,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTIwNTI2Ng==","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"created_at":"2015-08-26T23:33:10Z","updated_at":"2015-08-27T17:23:15Z","author_association":"NONE","body":"Also, if you copy the logging of `_agg.get(debug_parent)` to the very start of `run()`, you can see that `install` is already gone by the time `run()` is next called - so it must be something outside of the script above (unless there's something bizarre with references going on that I'm missing - although I've tried every form of dereferencing that I know).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135386863","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135386863","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135386863,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTM4Njg2Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T11:08:31Z","updated_at":"2015-08-27T11:08:31Z","author_association":"CONTRIBUTOR","body":"@colings86 could you take a look at this please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135399208","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135399208","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135399208,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTM5OTIwOA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T11:56:04Z","updated_at":"2015-08-27T11:56:04Z","author_association":"MEMBER","body":"@iwhitfield Could you post (maybe in a gist) of a Sense or curl recreation of this issue, including the commands for creating the index, indexing the events, and and search request for the scripted metric aggregation that uses your native script above?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135476336","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135476336","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135476336,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTQ3NjMzNg==","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T15:54:11Z","updated_at":"2015-08-27T15:54:11Z","author_association":"NONE","body":"@colings86 I'll dump my index, although I'm not sure the index is the issue, let me get back to you ASAP.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135477229","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135477229","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135477229,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTQ3NzIyOQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T15:57:39Z","updated_at":"2015-08-27T15:57:39Z","author_association":"MEMBER","body":"@iwhitfield no, I don't think the index is the issue either but having the curl recreation will make it alot easier to reproduce the issue and work out whats going on\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135478057","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135478057","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135478057,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTQ3ODA1Nw==","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T15:59:46Z","updated_at":"2015-08-27T15:59:46Z","author_association":"NONE","body":"@colings86 sure thing, I'll get that to you - I just have to remove some private info in there, but I'll get it to you shortly.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135478184","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135478184","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135478184,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTQ3ODE4NA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T16:00:19Z","updated_at":"2015-08-27T16:00:19Z","author_association":"MEMBER","body":"@iwhitfield ok great, thanks :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135500406","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135500406","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135500406,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTUwMDQwNg==","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T17:28:55Z","updated_at":"2015-08-27T22:26:11Z","author_association":"NONE","body":"@colings86 ok here's a gist - I hope I got everything you need: https://gist.github.com/iwhitfield/86b3193280bdd1d4edf2\n\nI decided to keep the names as-is, rather than rename them to \"eventX\" because it'd just make it harder for you to read :)\n\n`raw_data_dump.json` can be loaded by https://github.com/taskrabbit/elasticsearch-dump if you have it accessible to you (it's also handy if you wanna just use JS or something to scan it), otherwise `raw_data_sense.txt` should be a file you can just load up into Sense (let me know if I did that wrong, though).\n\n`test_curl.txt` is just the curl query I have been testing with. Although I don't think it's relevant, I'll note that I also had a combiner and reducer in most of my testing, but I narrowed it down to the mapping phase being the issue and so I have removed those from the curl (i.e. the logs in the OP prove it's a mapping issue).\n\nYour help is much appreciated, let me know if I can do anything else to point you in a helpful direction - I've kept the index around that displays this issue, so I can run anything you like on it.\n\n<s>Also, it appears that the keys and values are not mixed up at random - subsequent runs will always show the same progression as shown in the logs above, so perhaps that's a hint towards something.</s> **Edit:** strike this, it appears that this has changed (I have restarted ES several times since last trying). \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135584508","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135584508","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135584508,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTU4NDUwOA==","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"created_at":"2015-08-27T23:36:38Z","updated_at":"2015-08-28T02:12:18Z","author_association":"NONE","body":"Have verified that this is the case consistently after reloading the gisted dataset on my installation of ES1.7.1, and on another installation of ES1.6.1. So @colings86, you should be able to replicate using the info above :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135756397","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135756397","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135756397,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTc1NjM5Nw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2015-08-28T12:16:01Z","updated_at":"2015-08-28T12:16:01Z","author_association":"MEMBER","body":"@iwhitfield Sorry, it took me a little while to realise what the code in your script is doing. \n\nYou are trying to store the DocLookup object in your `_agg` object but this will not work. This object does not represent a particular document, it is an object that can be used to access particular fields for the current document. When the aggregation moves onto the next document the DocLookup object stayed the same (you can see this as it has the same object id) but now calls to DocLookup will return values for the next document. This is why you are seeing this strange behaviour. \n\nYou will need to change your script to retrieve the values that you need for each document (it looks like this is the value of `event` in your script above) and store that value in your `_agg` object rather than trying to store the DocLookup object.\n\nI am going to close this issue as Elasticsearch it working correctly here.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135787672","html_url":"https://github.com/elastic/elasticsearch/issues/13131#issuecomment-135787672","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13131","id":135787672,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTc4NzY3Mg==","user":{"login":"whitfin","id":5376378,"node_id":"MDQ6VXNlcjUzNzYzNzg=","avatar_url":"https://avatars0.githubusercontent.com/u/5376378?v=4","gravatar_id":"","url":"https://api.github.com/users/whitfin","html_url":"https://github.com/whitfin","followers_url":"https://api.github.com/users/whitfin/followers","following_url":"https://api.github.com/users/whitfin/following{/other_user}","gists_url":"https://api.github.com/users/whitfin/gists{/gist_id}","starred_url":"https://api.github.com/users/whitfin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/whitfin/subscriptions","organizations_url":"https://api.github.com/users/whitfin/orgs","repos_url":"https://api.github.com/users/whitfin/repos","events_url":"https://api.github.com/users/whitfin/events{/privacy}","received_events_url":"https://api.github.com/users/whitfin/received_events","type":"User","site_admin":false},"created_at":"2015-08-28T14:25:28Z","updated_at":"2015-08-28T14:25:28Z","author_association":"NONE","body":"@colings86 that makes perfect sense, thank you for summing it up so quickly :) I knew it must be something with the way things are referenced. Thank you!\n","performed_via_github_app":null}]