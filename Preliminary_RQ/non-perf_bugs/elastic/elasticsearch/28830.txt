{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28830","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28830/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28830/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28830/events","html_url":"https://github.com/elastic/elasticsearch/issues/28830","id":300324351,"node_id":"MDU6SXNzdWUzMDAzMjQzNTE=","number":28830,"title":"max_analyzed_offset warnings in header part of ES response","user":{"login":"golonzovsky","id":2477950,"node_id":"MDQ6VXNlcjI0Nzc5NTA=","avatar_url":"https://avatars0.githubusercontent.com/u/2477950?v=4","gravatar_id":"","url":"https://api.github.com/users/golonzovsky","html_url":"https://github.com/golonzovsky","followers_url":"https://api.github.com/users/golonzovsky/followers","following_url":"https://api.github.com/users/golonzovsky/following{/other_user}","gists_url":"https://api.github.com/users/golonzovsky/gists{/gist_id}","starred_url":"https://api.github.com/users/golonzovsky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/golonzovsky/subscriptions","organizations_url":"https://api.github.com/users/golonzovsky/orgs","repos_url":"https://api.github.com/users/golonzovsky/repos","events_url":"https://api.github.com/users/golonzovsky/events{/privacy}","received_events_url":"https://api.github.com/users/golonzovsky/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-02-26T17:19:35Z","updated_at":"2018-02-27T15:47:37Z","closed_at":"2018-02-26T17:30:20Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.2.2\r\n\r\n**JVM version** (`java -version`):\r\n```\r\nopenjdk version \"1.8.0_151\"\r\nOpenJDK Runtime Environment (IcedTea 3.6.0) (Alpine 8.151.12-r0)\r\nOpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux es-client-5bdb9dc9dc-n4kfh 4.14.11-coreos #1 SMP Fri Jan 5 11:00:14 UTC 2018 x86_64 Linux\r\n```\r\nalpine container from `https://quay.io/repository/pires/docker-elasticsearch-kubernetes` running in kubernetes cluster behind `nginx-ingress-controller`.\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nmax_analyzed_offset warnings in ES 6.2 produces response with unreasonably big headers - breaks Kibana deployed behind `nginx-ingress-controller`.\r\n\r\nI'm using Kibana search and receiving `BAD GATEWAY` error.\r\n```\r\nError Discover: Bad Gateway\r\n\r\nError: Bad Gateway\r\n    at respond (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:111:161556)\r\n    at checkRespForFailure (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:111:160796)\r\n    at http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:105:285566\r\n    at processQueue (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:132456)\r\n    at http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:133349\r\n    at Scope.$digest (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:144239)\r\n    at Scope.$apply (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:147018)\r\n    at done (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:100026)\r\n    at completeRequest (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:104697)\r\n    at XMLHttpRequest.xhr.onload (http://kibana-backend-stg.***/bundles/vendors.bundle.js?v=16588:58:105435)\r\n```\r\n\r\nI've investigated the cause and it turns out that nginx rejects response from ES due to huge headers from ES:\r\n```\r\nnginx-ingress-controller-7669c9c9c7-c2h89 nginx-ingress-controller 2018/02/26 16:07:38 [error] 32351#32351: *5136430 upstream sent too big header while reading response header from upstream, client: 10.***.72, server: es-backend-stg.***, request: \"POST /_search HTTP/1.1\", upstream: \"http://10.***.75:9200/_search\", host: \"es-backend-stg.***\"                                                      \r\nnginx-ingress-controller-7669c9c9c7-c2h89 nginx-ingress-controller 2018/02/26 16:07:39 [error] 32351#32351: *5136436 upstream sent too big header while reading response header from upstream, client: 10.***.72, server: es-backend-stg.***, request: \"POST /_search HTTP/1.1\", upstream: \"http://10.***.89:9200/_search\", host: \"es-backend-stg.***\"\r\n```\r\n\r\ntcpdump from client showed that ES dumps lots of [highlighting warnings](https://www.elastic.co/guide/en/elasticsearch/reference/6.x/breaking_60_analysis_changes.html#_limiting_the_length_of_an_analyzed_text_during_highlighting) into a response before headers:\r\n```\r\nHTTP/1.1 200 OK [290/46590]\r\nWarning: 299 Elasticsearch-6.2.2-10b1edd \"The length of text to be analyzed for highlighting [86432] exceeded the allowed maximum of [10000] set for the next major Elastic version. For large texts, indexing with offsets or term vectors is recommended!\" \"Mon, 26 Feb 2018 16:13:44 GMT\"\r\nWarning: 299 Elasticsearch-6.2.2-10b1edd \"The length of text to be analyzed for highlighting [10307] exceeded the allowed maximum of [10000] set for the next major Elastic version. For large texts, indexing with offsets or term vectors is recommended!\" \"Mon, 26 Feb 2018 16:13:44 GMT\"\r\n.....40x.....\r\ncontent-type: application/json; charset=UTF-8\r\n```\r\n\r\nES query which is issued by kibana (formatted):\r\n```\r\nPOST /_msearch HTTP/1.1\r\n\r\n{\"index\":[\"kafka-*\"],\"ignore_unavailable\":true,\"preference\":1519659811998}\r\n{\r\n  \"version\": true,\r\n  \"size\": 500,\r\n  \"sort\": [\r\n    {\r\n      \"kafka_timestamp\": {\r\n        \"order\": \"desc\",\r\n        \"unmapped_type\": \"boolean\"\r\n      }\r\n    }\r\n  ],\r\n  \"_source\": {\r\n    \"excludes\": []\r\n  },\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"kafka_timestamp\",\r\n        \"interval\": \"1h\",\r\n        \"time_zone\": \"Europe/Berlin\",\r\n        \"min_doc_count\": 1\r\n      }\r\n    }\r\n  },\r\n  \"stored_fields\": [\r\n    \"*\"\r\n  ],\r\n  \"script_fields\": {},\r\n  \"docvalue_fields\": [\r\n    \"@timestamp\",\r\n    \"kafka_timestamp\"\r\n  ],\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match_all\": {}\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"kafka_timestamp\": {\r\n              \"gte\": 1519486913449,\r\n              \"lte\": 1519659713449,\r\n              \"format\": \"epoch_millis\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"pre_tags\": [\r\n      \"@kibana-highlighted-field@\"\r\n    ],\r\n    \"post_tags\": [\r\n      \"@/kibana-highlighted-field@\"\r\n    ],\r\n    \"fields\": {\r\n      \"*\": {}\r\n    },\r\n    \"fragment_size\": 2147483647\r\n  }\r\n}\r\n```\r\n\r\nI've fixed my case by issuing below request:\r\n```\r\ncurl -X PUT http://es-backend-stg.***/kafka-*/_settings -d '{ \"index.highlight.max_analyzed_offset\": 100000}'\r\n```\r\n\r\n**Expected behaviour**: \r\nI'm not sure is the issue should be fixed on ES or Kibana side.    \r\nFrom ES perspective maybe limiting warnings to reasonable size, or logging them instead of putting into response headers may help..   \r\nMoving them in body field instead of headers may simplify middlware configuration and visibility.   \r\nMaybe Kibana request is another point where this could be fixed if warning-in-header behavior is preferred.   \r\n     \r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}