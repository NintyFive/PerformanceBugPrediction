{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27987","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27987/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27987/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27987/events","html_url":"https://github.com/elastic/elasticsearch/issues/27987","id":284540160,"node_id":"MDU6SXNzdWUyODQ1NDAxNjA=","number":27987,"title":"StartOffset must be non-negative, and endOffset must be >= startOffset, and offsets must not go backwards","user":{"login":"boliza","id":1076043,"node_id":"MDQ6VXNlcjEwNzYwNDM=","avatar_url":"https://avatars3.githubusercontent.com/u/1076043?v=4","gravatar_id":"","url":"https://api.github.com/users/boliza","html_url":"https://github.com/boliza","followers_url":"https://api.github.com/users/boliza/followers","following_url":"https://api.github.com/users/boliza/following{/other_user}","gists_url":"https://api.github.com/users/boliza/gists{/gist_id}","starred_url":"https://api.github.com/users/boliza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boliza/subscriptions","organizations_url":"https://api.github.com/users/boliza/orgs","repos_url":"https://api.github.com/users/boliza/repos","events_url":"https://api.github.com/users/boliza/events{/privacy}","received_events_url":"https://api.github.com/users/boliza/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"assignees":[{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-12-26T11:17:57Z","updated_at":"2018-01-03T08:15:31Z","closed_at":"2017-12-26T13:03:35Z","author_association":"NONE","active_lock_reason":null,"body":"**Bug report**\r\n1. Elasticsearch version:6.0.0\r\n2. Plugins installed: [hanlp](https://github.com/shikeio/hanlp-ext) x-pack\r\n3. JVM version:1.8.0_144\r\n4. OS version:CentOS 7.3 64\r\n\r\n**mapping is**\r\n```json\r\nPUT test/_mapping/test\r\n{\r\n  \"properties\": {\r\n    \"content\":{\r\n      \"type\": \"text\", \r\n      \"analyzer\": \"hanlp-index\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nthese request passed:\r\n```json\r\nPUT test/test/1\r\n{\r\n  \"content\":\"中华人民共和国\"\r\n}\r\nPUT test/test/2\r\n{\r\n  \"content\":[\"中华\",\"地大物博\"]\r\n}\r\n```\r\n\r\nbut this one failed:\r\n```json\r\nPUT test/test/3\r\n{\r\n  \"content\":[\"中华人民共和国\",\"地大物博\"]\r\n}\r\n```\r\n\r\nresponse is:\r\n```json\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"illegal_argument_exception\",\r\n        \"reason\": \"startOffset must be non-negative, and endOffset must be >= startOffset, and offsets must not go backwards startOffset=1,endOffset=5,lastStartOffset=4 for field 'content'\"\r\n      }\r\n    ],\r\n    \"type\": \"illegal_argument_exception\",\r\n    \"reason\": \"startOffset must be non-negative, and endOffset must be >= startOffset, and offsets must not go backwards startOffset=1,endOffset=5,lastStartOffset=4 for field 'content'\"\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nthe exception is:\r\n```\r\n[2017-12-26T19:15:47,819][DEBUG][o.e.a.b.TransportShardBulkAction] [test][4] failed to execute bulk item (index) BulkShardRequest [[test][4]] containing [inde\r\nx {[test][test][3], source[{\r\n  \"content\":[\"中华人民共和国\",\"地大物博\"]\r\n}\r\n]}]\r\njava.lang.IllegalArgumentException: startOffset must be non-negative, and endOffset must be >= startOffset, and offsets must not go backwards startOffset=1,en\r\ndOffset=5,lastStartOffset=4 for field 'content'\r\n        at org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:767) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1d\r\nbb3f03bf207140b - sarowe - 2017-10-02 14:36:35]\r\n        at org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:430) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1dbb3\r\nf03bf207140b - sarowe - 2017-10-02 14:36:35]\r\n        at org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:392) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1d\r\nbb3f03bf207140b - sarowe - 2017-10-02 14:36:35]\r\n        at org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:239) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa54395442\r\n4d8ac1dbb3f03bf207140b - sarowe - 2017-10-02 14:36:35]\r\n        at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:481) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1dbb3f03bf207\r\n140b - sarowe - 2017-10-02 14:36:35]\r\n        at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1717) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1dbb3f03bf207140b - \r\nsarowe - 2017-10-02 14:36:35]\r\n        at org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1462) ~[lucene-core-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1dbb3f03bf207140b - sar\r\nowe - 2017-10-02 14:36:35]\r\n        at org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:892) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n        at org.elasticsearch.index.engine.InternalEngine.indexIntoLucene(InternalEngine.java:834) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n        at org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:700) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n        at org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:727) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n        at org.elasticsearch.index.shard.IndexShard.applyIndexOperation(IndexShard.java:696) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n        at org.elasticsearch.index.shard.IndexShard.applyIndexOperationOnPrimary(IndexShard.java:662) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n        at org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequestOnPrimary(TransportShardBulkAction.java:548) ~[elasticsearch-6.0.0.jar:6.\r\n:\r\n```\r\n\r\n\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}