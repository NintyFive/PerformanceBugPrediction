[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/702846571","html_url":"https://github.com/elastic/elasticsearch/issues/63203#issuecomment-702846571","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63203","id":702846571,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMjg0NjU3MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-10-02T17:00:50Z","updated_at":"2020-10-02T17:00:50Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security (:Security/Authorization)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/705317967","html_url":"https://github.com/elastic/elasticsearch/issues/63203#issuecomment-705317967","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63203","id":705317967,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNTMxNzk2Nw==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2020-10-08T04:13:45Z","updated_at":"2020-10-08T04:13:45Z","author_association":"CONTRIBUTOR","body":"@ycombinator Can you confirm what we need to support here?\r\n \r\nFrom previous conversation, it seems to be:\r\n- `GET /_alias/metricbeat-*`\r\n- `HEAD /metricbeat-*`\r\n\r\nIs that all?\r\nWe can manage the PR once we're confident about what needs to be fixed.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/705766477","html_url":"https://github.com/elastic/elasticsearch/issues/63203#issuecomment-705766477","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63203","id":705766477,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNTc2NjQ3Nw==","user":{"login":"ycombinator","id":51061,"node_id":"MDQ6VXNlcjUxMDYx","avatar_url":"https://avatars2.githubusercontent.com/u/51061?v=4","gravatar_id":"","url":"https://api.github.com/users/ycombinator","html_url":"https://github.com/ycombinator","followers_url":"https://api.github.com/users/ycombinator/followers","following_url":"https://api.github.com/users/ycombinator/following{/other_user}","gists_url":"https://api.github.com/users/ycombinator/gists{/gist_id}","starred_url":"https://api.github.com/users/ycombinator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ycombinator/subscriptions","organizations_url":"https://api.github.com/users/ycombinator/orgs","repos_url":"https://api.github.com/users/ycombinator/repos","events_url":"https://api.github.com/users/ycombinator/events{/privacy}","received_events_url":"https://api.github.com/users/ycombinator/received_events","type":"User","site_admin":false},"created_at":"2020-10-08T19:09:23Z","updated_at":"2020-10-08T19:11:59Z","author_association":"CONTRIBUTOR","body":"tl;dr: Yes, those are the only two API calls we are currently missing support for. Further, support for them should be added to the `remote_monitoring_agent` role (**not** the `remote_monitoring_collector` role). For details on how I arrived at this conclusion, see below.\r\n\r\n---\r\n\r\nI started with a fresh install of Elasticsearch and Metricbeat. Using Wireshark I looked at the HTTP API calls Metricbeat makes to Elasticsearch right after start up (which is when it performs any index management related setup actions). Here's what that looks like:\r\n\r\n<img width=\"1205\" alt=\"Screen Shot 2020-10-08 at 11 21 20 AM\" src=\"https://user-images.githubusercontent.com/51061/95498400-9d8d7e80-0958-11eb-8c89-a15cc138c0ce.png\">\r\n\r\nLooking at the definition of the `remote_monitoring_user` built-in user, I see that it is assigned the `remote_monitoring_agent` and `remote_monitoring_collector` roles:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/5197043c41d7a7af3b4df6f11a4f57a5b8f1f88c/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/user/RemoteMonitoringUser.java#L13-L22\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/5197043c41d7a7af3b4df6f11a4f57a5b8f1f88c/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/user/UsernamesField.java#L29-L31\r\n\r\nLooking at the definition of these roles...\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/5197043c41d7a7af3b4df6f11a4f57a5b8f1f88c/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/security/authz/store/ReservedRolesStore.java#L70-L99\r\n\r\n... I see that they have the following privileges already:\r\n\r\n* Cluster-level: \r\n   * `manage_index_templates`, which resolves to:\r\n      * `indices:admin/template/*`\r\n      * `indices:admin/index_template/*`,\r\n      * `cluster:admin/component_template/*`\r\n   * `manage_ingest_pipelines`, which resolves to:\r\n      * `cluster:admin/ingest/pipeline/*`\r\n   * `monitor`, which resolves to:\r\n      * `cluster:monitor/*`\r\n   * `cluster:admin/ilm/get`\r\n   * `cluster:admin/ilm/put`\r\n* Index-level:\r\n  * On all (`*`) indices:\r\n    * `monitor`, which resolves to:\r\n       * `indices:monitor/*`\r\n  * On `.monitoring-*`:\r\n    * `all`\r\n  * On `metricbeat-*`:\r\n    * `index`, which resolves to:\r\n       * `indices:data/write/index*`\r\n       * `indices:data/write/bulk*`\r\n       * `indices:data/write/update*`\r\n    * `create_index`, which resolves to:\r\n       * `indices:admin/create`\r\n       * `indices:admin/auto_create`\r\n       * `indices:admin/data_stream/create`\r\n  * On `.kibana`:\r\n    * `read`, which resolves to:\r\n       * `indices:data/read/*`\r\n\r\nComparing the API calls made by Metricbeat to Elasticsearch at start up with the privileges already available to the `remote_monitoring_user` built-in user, it appears we're missing privileges to support the `GET /_alias/metricbeat-*` and  `HEAD /metricbeat-*` API calls. These could be satisfied by the `indices:admin/aliases/get` and `indices:admin/get` index-level privileges or the broader `view_index_metadata` index-level privilege.\r\n\r\nAs noted earlier, the `remote_monitoring_user` built-in user is assigned the `remote_monitoring_agent` and `remote_monitoring_collector` roles. Of these, the former is intended for use by Metricbeat to _index_ monitored data into `.monitoring-*` and `metricbeat-*` indices. The latter is intended for Metricbeat to monitor Elasticsearch and _gather_ data from it. As such, the missing privileges should be granted to the former role, not the latter one.","performed_via_github_app":null}]