{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2953","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2953/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2953/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2953/events","html_url":"https://github.com/elastic/elasticsearch/issues/2953","id":13795998,"node_id":"MDU6SXNzdWUxMzc5NTk5OA==","number":2953,"title":"TransportAnalyzeAction causes StringIndexOutOfBoundsException on first attempt to analyze a numeric field","user":{"login":"recoil","id":38198,"node_id":"MDQ6VXNlcjM4MTk4","avatar_url":"https://avatars3.githubusercontent.com/u/38198?v=4","gravatar_id":"","url":"https://api.github.com/users/recoil","html_url":"https://github.com/recoil","followers_url":"https://api.github.com/users/recoil/followers","following_url":"https://api.github.com/users/recoil/following{/other_user}","gists_url":"https://api.github.com/users/recoil/gists{/gist_id}","starred_url":"https://api.github.com/users/recoil/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/recoil/subscriptions","organizations_url":"https://api.github.com/users/recoil/orgs","repos_url":"https://api.github.com/users/recoil/repos","events_url":"https://api.github.com/users/recoil/events{/privacy}","received_events_url":"https://api.github.com/users/recoil/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":37906074,"node_id":"MDU6TGFiZWwzNzkwNjA3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.1","name":"v0.90.1","color":"DDDDDD","default":false,"description":null},{"id":37906111,"node_id":"MDU6TGFiZWwzNzkwNjExMQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta1","name":"v1.0.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2013-04-30T08:02:04Z","updated_at":"2013-04-30T14:58:10Z","closed_at":"2013-04-30T14:58:10Z","author_association":"NONE","active_lock_reason":null,"body":"I'm seeing the following in Elastic 0.90.0 during the first attempt attempt to initiate an AnalyzeRequest against a numeric field:\n\n```\nCaused by: java.util.concurrent.ExecutionException: java.lang.StringIndexOutOfBoundsException: String index out of range: -1\n        at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.getValue(BaseFuture.java:285)\n        at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:272)\n        at org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:113)\n        at org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:45)\n        ... 38 more\nCaused by: java.lang.StringIndexOutOfBoundsException: String index out of range: -1\n        at java.lang.String.<init>(String.java:207)\n        at org.elasticsearch.index.analysis.NumericTokenizer.reset(NumericTokenizer.java:59)\n        at org.elasticsearch.index.analysis.NumericTokenizer.reset(NumericTokenizer.java:54)\n        at org.elasticsearch.action.admin.indices.analyze.TransportAnalyzeAction.shardOperation(TransportAnalyzeAction.java:202)\n        at org.elasticsearch.action.admin.indices.analyze.TransportAnalyzeAction.shardOperation(TransportAnalyzeAction.java:57)\n        at org.elasticsearch.action.support.single.custom.TransportSingleCustomOperationAction$AsyncSingleAction$2.run(TransportSingleCustomOperationAction.java:175)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.runTask(ThreadPoolExecutor.java:886)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:908)\n        ... 1 more\n```\n\nThe cause of the problem appears to be that the `reset()` method of the `NumericTokenizer` is called twice the first time `analyzer.tokenStream()` is called for a the field in a thread:\n- The first call happens as a result of Lucene calling `createComponents()` on the `NumericAnalyzer`.  This eventually results in the construction of a `NumericTokenizer` with a `char[]` buffer, which calls `reset()` during construction.  This first `reset()` call leaves the `FastStringReader` associated with the Tokenizer with a `next` value that is equal to the  length of that buffer because it reads all the chars out of the reader.\n- The second call happens as a result of the explicit call to `reset()` in `TransportAnalyzeAction` immediately after the `TokenStream` has been retrieved from the analyzer.  Unfortunately calling the method a second time triggers the `if (next >= length)` check in the `read()` method of the associated `FastStringReader` to return -1.  NumericTokenizer then tries to use -1 as the number of chars to use when constructing a `String`, which throws the `StringIndexOutOfBoundsException` above.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}