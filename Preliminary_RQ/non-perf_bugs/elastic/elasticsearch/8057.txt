{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8057","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8057/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8057/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8057/events","html_url":"https://github.com/elastic/elasticsearch/issues/8057","id":45549227,"node_id":"MDU6SXNzdWU0NTU0OTIyNw==","number":8057,"title":"Thread leak with autodiscover after adding / removing a master node","user":{"login":"fdv","id":9949,"node_id":"MDQ6VXNlcjk5NDk=","avatar_url":"https://avatars2.githubusercontent.com/u/9949?v=4","gravatar_id":"","url":"https://api.github.com/users/fdv","html_url":"https://github.com/fdv","followers_url":"https://api.github.com/users/fdv/followers","following_url":"https://api.github.com/users/fdv/following{/other_user}","gists_url":"https://api.github.com/users/fdv/gists{/gist_id}","starred_url":"https://api.github.com/users/fdv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fdv/subscriptions","organizations_url":"https://api.github.com/users/fdv/orgs","repos_url":"https://api.github.com/users/fdv/repos","events_url":"https://api.github.com/users/fdv/events{/privacy}","received_events_url":"https://api.github.com/users/fdv/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2014-10-11T11:49:58Z","updated_at":"2015-11-21T19:44:01Z","closed_at":"2015-11-21T19:44:00Z","author_association":"NONE","active_lock_reason":null,"body":"I've had an epic bug leading to a thread leak (and ES dying because it had no more RAM to create more threads). [Whole story here](https://t37.net/my-epic-elasticsearch-bug-and-how-i-fucked-up-my-investigation-not-focusing-wide-enough.html).\n## Bug description\n\n4 nodes ES cluster on EC2. 1 routing node, 3 data nodes. The routing node acts as master (configuration provided below)\n\nAfter I added and removed a master node, one of the data nodes kept sending auto discovery requests to a the gone node. This led to the remaining routing node to create about 1 thread / second (sending auto discovery requests) and never closing them.\n## Configuration\n- ES 1.0.1 (old, I know)\n- ES Transport Thrift: elasticsearch-transport-thrift-2.0.0\n- AWS cloud plugin: cloud-aws-2.0.0\n### Routing node\n\n``` yml\nbootstrap:\n  mlockall: true\ncloud:\n  aws:\n    access_key: something\n    region: us-east-1\n    secret_key: something\ncluster:\n  name: robots\ndiscovery:\n  ec2:\n    ping_timeout: 360\n    tag:\n      Cluster: production\n  type: ec2\n  zen:\n    minimum_master_nodes: 1\ngateway:\n  expected_nodes: 4\n  recover_after_nodes: 4\n  recover_after_time: 5m\nhttp:\n  max_content_length: 100mb\nindex:\n  query:\n    bool:\n      max_clause_count: 1000000\n  refresh_interval: 300\n  store:\n    type: mmapfs\nindices:\n  fielddata:\n    cache:\n      expire: 10m\n      size: 30%\n  memory:\n    index_buffer_size: 10%\nnetwork:\n  host: 0.0.0.0\nnode:\n  data: false\n  master: true\n  name: something\npath:\n  data: /mnt/elasticsearch\n  logs: /var/log/elasticsearch\n```\n### Data nodes\n\n``` yaml\nbootstrap:\n  mlockall: true\ncloud:\n  aws:\n    access_key: something\n    region: us-east-1\n    secret_key: something\ncluster:\n  name: robots\ndiscovery:\n  ec2:\n    ping_timeout: 360\n    tag:\n      Cluster: production\n  type: ec2\n  zen:\n    minimum_master_nodes: 1\ngateway:\n  expected_nodes: 4\n  recover_after_nodes: 4\n  recover_after_time: 5m\nhttp:\n  max_content_length: 100mb\nindex:\n  query:\n    bool:\n      max_clause_count: 1000000\n  refresh_interval: 300\n  store:\n    type: mmapfs\nindices:\n  fielddata:\n    cache:\n      expire: 10m\n      size: 30%\n  memory:\n    index_buffer_size: 10%\nnetwork:\n  host: 0.0.0.0\nnode:\n  data: true\n  master: false\n  name: something\npath:\n  data: /mnt/elasticsearch\n  logs: /var/log/elasticsearch\n```\n### JVM\n- xmx and xms to 4G\n- no fancy GC tuning\n\nTell me if I you need anything else.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}