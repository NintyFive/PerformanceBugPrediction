{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14558","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14558/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14558/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14558/events","html_url":"https://github.com/elastic/elasticsearch/issues/14558","id":115283543,"node_id":"MDU6SXNzdWUxMTUyODM1NDM=","number":14558,"title":"Phrase suggester collate doesnâ€™t work in search template","user":{"login":"buinauskas","id":7301441,"node_id":"MDQ6VXNlcjczMDE0NDE=","avatar_url":"https://avatars0.githubusercontent.com/u/7301441?v=4","gravatar_id":"","url":"https://api.github.com/users/buinauskas","html_url":"https://github.com/buinauskas","followers_url":"https://api.github.com/users/buinauskas/followers","following_url":"https://api.github.com/users/buinauskas/following{/other_user}","gists_url":"https://api.github.com/users/buinauskas/gists{/gist_id}","starred_url":"https://api.github.com/users/buinauskas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/buinauskas/subscriptions","organizations_url":"https://api.github.com/users/buinauskas/orgs","repos_url":"https://api.github.com/users/buinauskas/repos","events_url":"https://api.github.com/users/buinauskas/events{/privacy}","received_events_url":"https://api.github.com/users/buinauskas/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-11-05T13:28:04Z","updated_at":"2015-11-09T09:22:00Z","closed_at":"2015-11-09T09:22:00Z","author_association":"NONE","active_lock_reason":null,"body":"First of all, I'm using Elasticsearch 1.7.3\n\nI'm facing issues with `collate` in Phrase Suggester.\n\nPlease see this reproduction:\n\n```\nPUT /test/test/1\n{\n  \"CompanyName\": \"coca-cola\"\n}\n\nPOST /test/_search\n{\n  \"size\": 0,\n  \"suggest\": {\n    \"DidYouMean\": {\n      \"text\": \"coce\",\n      \"phrase\": {\n        \"field\": \"_all\",\n        \"size\": 50,\n        \"direct_generator\": [\n          {\n            \"field\": \"_all\",\n            \"suggest_mode\": \"popular\",\n            \"min_word_length\": 3\n          }\n        ],\n        \"collate\": {\n          \"query\": {\n            \"match\": {\n              \"CompanyName\": {\n                \"query\": \"{{suggestion}}\",\n                \"operator\": \"and\"\n              }\n            }\n          },\n          \"prune\": true\n        }\n      }\n    }\n  }\n}\n```\n\nIt brings me this result with `\"collate_match\": true`:\n\n```\n{\n   \"took\": 4,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"suggest\": {\n      \"DidYouMean\": [\n         {\n            \"text\": \"coce\",\n            \"offset\": 0,\n            \"length\": 4,\n            \"options\": [\n               {\n                  \"text\": \"coca\",\n                  \"score\": 0.6531368,\n                  \"collate_match\": true\n               },\n               {\n                  \"text\": \"cola\",\n                  \"score\": 0.5476822,\n                  \"collate_match\": true\n               }\n            ]\n         }\n      ]\n   }\n} \n```\n\nBut when I create a template using this query:\n\n```\nPUT /_search/template/suggest\n{\n  \"template\": {\n    \"size\": 0,\n    \"suggest\": {\n      \"DidYouMean\": {\n        \"text\": \"{{SearchPhrase}}\",\n        \"phrase\": {\n          \"field\": \"_all\",\n          \"size\": 50,\n          \"direct_generator\": [\n            {\n              \"field\": \"_all\",\n              \"suggest_mode\": \"popular\",\n              \"min_word_length\": 3\n            }\n          ],\n          \"collate\": {\n            \"query\": {\n              \"match\": {\n                \"CompanyName\": {\n                  \"query\": \"{{suggestion}}\",\n                  \"operator\": \"and\"\n                }\n              }\n            },\n            \"prune\": true\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nAnd call it using this:\n\n```\nPOST /test/_search/template\n{\n  \"template\": {\n    \"id\": \"suggest\"\n  },\n  \"params\": {\n    \"SearchPhrase\": \"coca cole\"\n  }\n}\n```\n\nI'm getting false results:\n\n```\n{\n   \"took\": 6,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"suggest\": {\n      \"DidYouMean\": [\n         {\n            \"text\": \"coca cole\",\n            \"offset\": 0,\n            \"length\": 9,\n            \"options\": [\n               {\n                  \"text\": \"coca cola\",\n                  \"score\": 0.4727091,\n                  \"collate_match\": false\n               },\n               {\n                  \"text\": \"coca coca\",\n                  \"score\": 0.39638618,\n                  \"collate_match\": false\n               }\n            ]\n         }\n      ]\n   }\n}\n```\n\nIssue seems to be {{suggestion}} itself. I'm suspecting that when I call a template, it expects `suggestion` parameter from my template query, so it can pass a value. However - it's empty.\n\nAs a workaround, I modified template like this:\n\n```\n{\n  \"collate\" : {\n    \"prune\" : true,\n    \"query\" : {\n      \"match\" : {\n        \"_all\" : {\n          \"query\" : \"{{=<% %>=}}{{suggestion}}<%={{ }}=%>\"\n        }\n      }\n    }\n  }\n}\n```\n\nQuery was expecting a parameter, which was not supplied. Special characters (braces) had to be escaped, now it seems to perform right.\n\nCan anyone confirm it's correct approach?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}