{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13536","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13536/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13536/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13536/events","html_url":"https://github.com/elastic/elasticsearch/issues/13536","id":106168857,"node_id":"MDU6SXNzdWUxMDYxNjg4NTc=","number":13536,"title":"Feature Request: Re-sort terms aggregation result by key after size truncation","user":{"login":"sigpwned","id":1236302,"node_id":"MDQ6VXNlcjEyMzYzMDI=","avatar_url":"https://avatars1.githubusercontent.com/u/1236302?v=4","gravatar_id":"","url":"https://api.github.com/users/sigpwned","html_url":"https://github.com/sigpwned","followers_url":"https://api.github.com/users/sigpwned/followers","following_url":"https://api.github.com/users/sigpwned/following{/other_user}","gists_url":"https://api.github.com/users/sigpwned/gists{/gist_id}","starred_url":"https://api.github.com/users/sigpwned/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sigpwned/subscriptions","organizations_url":"https://api.github.com/users/sigpwned/orgs","repos_url":"https://api.github.com/users/sigpwned/repos","events_url":"https://api.github.com/users/sigpwned/events{/privacy}","received_events_url":"https://api.github.com/users/sigpwned/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2015-09-12T15:58:36Z","updated_at":"2016-01-28T17:34:08Z","closed_at":"2016-01-28T17:29:37Z","author_association":"NONE","active_lock_reason":null,"body":"I'm currently using ElasticSearch aggregations to perform frequency analysis on large groups of cases (10Ks) for variables with many categorical values (100Ks) using a terms aggregation. It's working great!\n## Use Case\n\nI'd like to add a feature where I compare the frequency distributions of these variables across two different groups of people. In order to minimize the memory requirements and avoid the use of temporary files, here was my plan:\n1. Run a terms query against group A that returns the top N (for N <<100K) hits sorted by key value\n2. Run a terms query against group B that returns the top N (for N <<100K) hits sorted by key value\n3. Merge the results from (1) and (2) in a streaming fashion, computing a score describing the difference in the two frequencies for the two groups for each pair\n4. Iterate until both streams (1) and (2) are exhausted, retaining the top N biggest differences in memory\n5. Return these results to the user\n\nThis approach would work fine, except that I can't sort the top N by count subsequently by key! I can do the following:\n- Sort the entire terms aggregation by document count and take the top N\n- Sort the entire terms aggregation by term and take the top N\n\nBut I _can't_ do the following:\n- Sort the entire terms aggregation by document count, take the top N, and the sort the truncated result by term\n\nThis \"post truncate sort\" would be a very useful feature for me! I imagine that it may be useful for others too.\n## Possible Implementations\n\nHere are a couple of additions to the aggregations DSL that would address this use case.\n### Post-Truncate Sort in Terms Aggregation\n\nOne fairly self-contained fix would be to add a second sort to the terms aggregation that is a NOP by default, but provides a second sort like the `order` feature already in the terms aggregation that is performed after truncation. Purely for illustration, the syntax might look something like this:\n\n```\n{\n  \"aggregations\" : {\n    \"name\" : {\n      \"terms\" : {\n        \"field\" : \"categorical\",\n        \"size\" : 10000,\n        \"postorder\" : { \"_term\" : \"asc\" }\n      }\n    }\n  }\n}\n```\n### A New Order Aggregation\n\nA more general fix might be to add a new aggregation type called something like \"resort\" that simply applies a new sort to its child aggregation(s). Purely for illustration, the syntax might look something like this:\n\n```\n{\n  \"aggregations\" : {\n    \"name\" : {\n      \"resort\" : {\n        \"order\" : {\n          \"name2\" : { \"_bucket\" : \"asc\" }\n        },\n        \"aggregations\" : {\n          \"name2\" : {\n            \"terms\" : {\n              \"field\" : \"categorical\",\n              \"size\" : 10000,\n              \"postorder\" : { \"_term\" : \"asc\" }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThis would allow users to perform arbitrary resorting on their aggregations whenever they needed. This approach may require some thought regarding what options for sorting are available, but would give people a lot more flexibility on their sorts.\n## Workarounds\n\nThere are some fairly good workarounds for now. Here are a few options I see open to me at the moment:\n- Streaming the untruncated terms result for both groups sorted by term\n- Pulling the entire truncated result for both groups into memory and working on them directly\n- Write sorted results for both groups to temporary files, then stream the results from the files\n\nRegardless, ElasticSearch is great, and a joy to work with! :)\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}