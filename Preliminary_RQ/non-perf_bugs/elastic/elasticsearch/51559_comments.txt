[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/580166742","html_url":"https://github.com/elastic/elasticsearch/issues/51559#issuecomment-580166742","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51559","id":580166742,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MDE2Njc0Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-01-30T09:35:46Z","updated_at":"2020-01-30T09:35:46Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo (:Analytics/Aggregations)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/580291575","html_url":"https://github.com/elastic/elasticsearch/issues/51559#issuecomment-580291575","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51559","id":580291575,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MDI5MTU3NQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-01-30T14:56:10Z","updated_at":"2020-01-30T14:56:10Z","author_association":"MEMBER","body":"Hey @niemyjski :)  I just recently replied to a different issue explaining a little how the setting works: https://github.com/elastic/elasticsearch/issues/34209#issuecomment-579362100.  At a minimum, it seems we need to document how this setting works internally so users have a better understanding.\r\n\r\nI think the main difficulty is that the setting serves two purposes today, which confuses the semantics a little.  First, it's a soft-limit for response size.  Easy enough to reason about.\r\n\r\nBut the other purpose (and arguably the more important one to us) is that it acts as a \"breaker\" to help kill execution of expensive aggregations.  There are several ways aggs can go off the rails and cause issues, but one of the predominant mechanisms are \"abusive\" aggs that generate too many buckets.  The `max_buckets` threshold allows us to abort aggs that are generating an excessive amount of buckets.  This is helpful in two areas:\r\n\r\n- On the shard while actually aggregating the data\r\n- On the coordinator, while incrementally reducing shard responses and during the final reduction.\r\n\r\nThe coordinator can't return results until all shards have reported in, so it has to buffer the intermediate reductions in memory.  In an extreme example, if you as for `size: 1, shard_size:1000000` and have ten shards all with unique values (say, aggregating on an ID field or similar), the coordinator may need to buffer 1m*10 == 10m buckets before it can select the single, top bucket to return.  This is super expensive, especially when you get to real world scenarios where aggs are complex and multi-layered.\r\n\r\nSo the `max_buckets` threshold is a soft limit that allows us to proactively abort aggs that are growing past the point of safety.\r\n\r\nI agree that does make it confusing/complicated for users, particularly since some aggs (like `rare_terms`) actually reduce their bucket count on the coordinator but might trip the limit on the shards.  There is some work going on elsewhere (like https://github.com/elastic/elasticsearch/pull/46751) that hopefully will help decouple the memory aspects of `max_buckets` and leave it purely as a response-size limiter.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/598730962","html_url":"https://github.com/elastic/elasticsearch/issues/51559#issuecomment-598730962","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51559","id":598730962,"node_id":"MDEyOklzc3VlQ29tbWVudDU5ODczMDk2Mg==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-03-13T13:53:39Z","updated_at":"2020-03-13T13:53:39Z","author_association":"MEMBER","body":"Small update: there is discussion ongoing about deprecating or changing the behavior of `max_buckets`, with the tentative plan leaning towards only counting buckets at the very end of reduction (e.g. so that it behaves purely as a bucket size limiter on the response), and potentially changing the default to a much higher value.\r\n\r\nhttps://github.com/elastic/elasticsearch/issues/51731","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/646056068","html_url":"https://github.com/elastic/elasticsearch/issues/51559#issuecomment-646056068","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51559","id":646056068,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NjA1NjA2OA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2020-06-18T14:30:02Z","updated_at":"2020-06-18T14:30:02Z","author_association":"MEMBER","body":"This should now be resolved by https://github.com/elastic/elasticsearch/pull/57042.  The limit has been drastically increased, and bucket counts are now only tallied _after_ all reductions are complete.  SO the various and confusing edge-cases that I described above no longer apply, and the setting really does what it says on the tin. :)\r\n\r\n:tada: ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/646306342","html_url":"https://github.com/elastic/elasticsearch/issues/51559#issuecomment-646306342","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51559","id":646306342,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NjMwNjM0Mg==","user":{"login":"niemyjski","id":1020579,"node_id":"MDQ6VXNlcjEwMjA1Nzk=","avatar_url":"https://avatars3.githubusercontent.com/u/1020579?v=4","gravatar_id":"","url":"https://api.github.com/users/niemyjski","html_url":"https://github.com/niemyjski","followers_url":"https://api.github.com/users/niemyjski/followers","following_url":"https://api.github.com/users/niemyjski/following{/other_user}","gists_url":"https://api.github.com/users/niemyjski/gists{/gist_id}","starred_url":"https://api.github.com/users/niemyjski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/niemyjski/subscriptions","organizations_url":"https://api.github.com/users/niemyjski/orgs","repos_url":"https://api.github.com/users/niemyjski/repos","events_url":"https://api.github.com/users/niemyjski/events{/privacy}","received_events_url":"https://api.github.com/users/niemyjski/received_events","type":"User","site_admin":false},"created_at":"2020-06-18T21:07:57Z","updated_at":"2020-06-18T21:07:57Z","author_association":"CONTRIBUTOR","body":"Thanks!","performed_via_github_app":null}]