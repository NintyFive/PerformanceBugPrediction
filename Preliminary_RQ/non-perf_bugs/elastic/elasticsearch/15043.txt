{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15043","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15043/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15043/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15043/events","html_url":"https://github.com/elastic/elasticsearch/issues/15043","id":119028543,"node_id":"MDU6SXNzdWUxMTkwMjg1NDM=","number":15043,"title":"ES 2.1 occasional failed engine [refresh failed] due to NullPointerException while evicting query cache.","user":{"login":"vs-adm","id":370526,"node_id":"MDQ6VXNlcjM3MDUyNg==","avatar_url":"https://avatars1.githubusercontent.com/u/370526?v=4","gravatar_id":"","url":"https://api.github.com/users/vs-adm","html_url":"https://github.com/vs-adm","followers_url":"https://api.github.com/users/vs-adm/followers","following_url":"https://api.github.com/users/vs-adm/following{/other_user}","gists_url":"https://api.github.com/users/vs-adm/gists{/gist_id}","starred_url":"https://api.github.com/users/vs-adm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vs-adm/subscriptions","organizations_url":"https://api.github.com/users/vs-adm/orgs","repos_url":"https://api.github.com/users/vs-adm/repos","events_url":"https://api.github.com/users/vs-adm/events{/privacy}","received_events_url":"https://api.github.com/users/vs-adm/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":288407525,"node_id":"MDU6TGFiZWwyODg0MDc1MjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.1.1","name":"v2.1.1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":12,"created_at":"2015-11-26T11:39:30Z","updated_at":"2015-12-03T08:38:08Z","closed_at":"2015-12-03T08:38:08Z","author_association":"NONE","active_lock_reason":null,"body":"Hello all.\n\nI am running 4-node ES cluster with logstash as data producer. Recently I've upgraded ES from 1.6 to 2.1. After upgrade recent indexs' shards are continuously being marked as failed and re-initialized. If failed shard is primary shard then indexing stucks.\n\nOne node:\n\n```\n2015-11-26_07:01:21.22958 [2015-11-26 07:01:21,229][WARN ][index.engine             ] [John Falsworth] [logstash-2015.11.26][2] failed engine [refresh failed]\n2015-11-26_07:01:21.22961 java.lang.NullPointerException\n2015-11-26_07:01:21.23006 [2015-11-26 07:01:21,229][WARN ][index.shard              ] [John Falsworth] [logstash-2015.11.26][2] Failed to perform scheduled engine refresh\n2015-11-26_07:01:21.23008 [logstash-2015.11.26][[logstash-2015.11.26][2]] RefreshFailedEngineException[Refresh failed]; nested: NullPointerException;\n2015-11-26_07:01:21.23008       at org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:686)\n2015-11-26_07:01:21.23008       at org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:615)\n2015-11-26_07:01:21.23009       at org.elasticsearch.index.shard.IndexShard$EngineRefresher$1.run(IndexShard.java:1255)\n2015-11-26_07:01:21.23009       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n2015-11-26_07:01:21.23009       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2015-11-26_07:01:21.23010       at java.lang.Thread.run(Thread.java:745)\n2015-11-26_07:01:21.23010 Caused by: java.lang.NullPointerException\n2015-11-26_07:01:21.23044 [2015-11-26 07:01:21,230][WARN ][indices.cluster          ] [John Falsworth] [[logstash-2015.11.26][2]] marking and sending shard failed due to [eng\nine failure, reason [refresh failed]]\n2015-11-26_07:01:21.23046 java.lang.NullPointerException\n2015-11-26_07:04:18.05160 [2015-11-26 07:04:18,050][WARN ][index.translog           ] [John Falsworth] [logstash-2015.11.26][2] failed to delete temp file /var/lib/elasticsea\nrch/dss2es/nodes/0/indices/logstash-2015.11.26/2/translog/translog-8708119625210250383.tlog\n2015-11-26_07:04:18.05162 java.nio.file.NoSuchFileException: /var/lib/elasticsearch/dss2es/nodes/0/indices/logstash-2015.11.26/2/translog/translog-8708119625210250383.tlog\n2015-11-26_07:04:18.05163       at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)\n2015-11-26_07:04:18.05163       at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)\n2015-11-26_07:04:18.05163       at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)\n2015-11-26_07:04:18.05164       at sun.nio.fs.UnixFileSystemProvider.implDelete(UnixFileSystemProvider.java:244)\n2015-11-26_07:04:18.05164       at sun.nio.fs.AbstractFileSystemProvider.delete(AbstractFileSystemProvider.java:103)\n2015-11-26_07:04:18.05164       at java.nio.file.Files.delete(Files.java:1126)\n2015-11-26_07:04:18.05165       at org.elasticsearch.index.translog.Translog.recoverFromFiles(Translog.java:324)\n2015-11-26_07:04:18.05165       at org.elasticsearch.index.translog.Translog.<init>(Translog.java:166)\n2015-11-26_07:04:18.05165       at org.elasticsearch.index.engine.InternalEngine.openTranslog(InternalEngine.java:209)\n2015-11-26_07:04:18.05166       at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:152)\n2015-11-26_07:04:18.05166       at org.elasticsearch.index.engine.InternalEngineFactory.newReadWriteEngine(InternalEngineFactory.java:25)\n2015-11-26_07:04:18.05167       at org.elasticsearch.index.shard.IndexShard.newEngine(IndexShard.java:1408)\n2015-11-26_07:04:18.05167       at org.elasticsearch.index.shard.IndexShard.createNewEngine(IndexShard.java:1403)\n2015-11-26_07:04:18.05167       at org.elasticsearch.index.shard.IndexShard.internalPerformTranslogRecovery(IndexShard.java:906)\n2015-11-26_07:04:18.05168       at org.elasticsearch.index.shard.IndexShard.performTranslogRecovery(IndexShard.java:883)\n2015-11-26_07:04:18.05168       at org.elasticsearch.index.shard.StoreRecoveryService.recoverFromStore(StoreRecoveryService.java:245)\n2015-11-26_07:04:18.05168       at org.elasticsearch.index.shard.StoreRecoveryService.access$100(StoreRecoveryService.java:56)\n2015-11-26_07:04:18.05169       at org.elasticsearch.index.shard.StoreRecoveryService$1.run(StoreRecoveryService.java:129)\n2015-11-26_07:04:18.05169       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n2015-11-26_07:04:18.05169       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2015-11-26_07:04:18.05171       at java.lang.Thread.run(Thread.java:745)\n```\n\nAnother node:\n\n```\n2015-11-26_07:04:16.53521 [2015-11-26 07:04:16,534][WARN ][index.engine             ] [Turner D. Century] [logstash-2015.11.26][2] failed engine [refresh failed]\n2015-11-26_07:04:16.53524 java.lang.NullPointerException\n2015-11-26_07:04:16.53525       at org.elasticsearch.indices.cache.query.IndicesQueryCache$1.onDocIdSetEviction(IndicesQueryCache.java:158)\n2015-11-26_07:04:16.53525       at org.apache.lucene.search.LRUQueryCache.clearCoreCacheKey(LRUQueryCache.java:313)\n2015-11-26_07:04:16.53525       at org.apache.lucene.search.LRUQueryCache$1.onClose(LRUQueryCache.java:276)\n2015-11-26_07:04:16.53526       at org.apache.lucene.index.SegmentCoreReaders.notifyCoreClosedListeners(SegmentCoreReaders.java:168)\n2015-11-26_07:04:16.53526       at org.apache.lucene.index.SegmentCoreReaders.decRef(SegmentCoreReaders.java:157)\n2015-11-26_07:04:16.53526       at org.apache.lucene.index.SegmentReader.doClose(SegmentReader.java:175)\n2015-11-26_07:04:16.53527       at org.apache.lucene.index.IndexReader.decRef(IndexReader.java:253)\n2015-11-26_07:04:16.53527       at org.apache.lucene.index.StandardDirectoryReader.doClose(StandardDirectoryReader.java:359)\n2015-11-26_07:04:16.53527       at org.apache.lucene.index.IndexReader.decRef(IndexReader.java:253)\n2015-11-26_07:04:16.53528       at org.apache.lucene.index.IndexReader.close(IndexReader.java:403)\n2015-11-26_07:04:16.53528       at org.apache.lucene.index.FilterDirectoryReader.doClose(FilterDirectoryReader.java:134)\n2015-11-26_07:04:16.53529       at org.apache.lucene.index.IndexReader.decRef(IndexReader.java:253)\n2015-11-26_07:04:16.53529       at org.apache.lucene.search.SearcherManager.decRef(SearcherManager.java:130)\n2015-11-26_07:04:16.53530       at org.apache.lucene.search.SearcherManager.decRef(SearcherManager.java:58)\n2015-11-26_07:04:16.53531       at org.apache.lucene.search.ReferenceManager.release(ReferenceManager.java:274)\n2015-11-26_07:04:16.53531       at org.apache.lucene.search.ReferenceManager.doMaybeRefresh(ReferenceManager.java:189)\n2015-11-26_07:04:16.53531       at org.apache.lucene.search.ReferenceManager.maybeRefreshBlocking(ReferenceManager.java:253)\n2015-11-26_07:04:16.53532       at org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:678)\n2015-11-26_07:04:16.53532       at org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:615)\n2015-11-26_07:04:16.53532       at org.elasticsearch.index.shard.IndexShard$EngineRefresher$1.run(IndexShard.java:1255)\n2015-11-26_07:04:16.53532       at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n2015-11-26_07:04:16.53533       at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n2015-11-26_07:04:16.53533       at java.lang.Thread.run(Thread.java:745)\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}