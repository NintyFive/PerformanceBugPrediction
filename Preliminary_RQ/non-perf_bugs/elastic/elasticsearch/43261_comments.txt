[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/502437868","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-502437868","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":502437868,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMjQzNzg2OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-16T09:56:14Z","updated_at":"2019-06-16T09:56:14Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/502583538","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-502583538","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":502583538,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMjU4MzUzOA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-06-17T08:21:50Z","updated_at":"2019-06-17T08:21:50Z","author_association":"MEMBER","body":"@cbuescher this seems to be related with https://github.com/elastic/elasticsearch/pull/42927, can you take a look ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/502626181","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-502626181","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":502626181,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMjYyNjE4MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-17T10:25:05Z","updated_at":"2019-06-17T10:25:05Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504374091","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-504374091","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":504374091,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDM3NDA5MQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-06-21T10:16:52Z","updated_at":"2019-06-21T10:16:52Z","author_association":"MEMBER","body":"This happened again on 7.x (Jun 14, https://scans.gradle.com/s/lceobfjdjnwfy/tests/kyv2y2z3r4v7m-sbwnmbkfcgtx4) and master (Jun 19, https://scans.gradle.com/s/zzr4cgqseffes/tests/kyv2y2z3r4v7m-sbwnmbkfcgtx4). Unfortunately I cannot reproduce the failure with either of the reproduce lines or the seeds in both of those cases. Digging through the logs now if anything sticks out that might indicate how to reproduce the failure.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510062670","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-510062670","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":510062670,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDA2MjY3MA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2019-07-10T13:33:21Z","updated_at":"2019-07-10T13:33:21Z","author_association":"MEMBER","body":"We have another instance on `7.3` in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.3+matrix-java-periodic/ES_BUILD_JAVA=openjdk12,ES_RUNTIME_JAVA=java11,nodes=general-purpose/14/console\r\n\r\n```\r\n11:17:34   2> java.lang.AssertionError: Suggest result: {\r\n11:17:34       \"suggest\" : {\r\n11:17:34         \"did_you_mean\" : [\r\n11:17:34           {\r\n11:17:34             \"text\" : \"tetsting sugestion\",\r\n11:17:34             \"offset\" : 0,\r\n11:17:34             \"length\" : 18,\r\n11:17:34             \"options\" : [\r\n11:17:34               {\r\n11:17:34                 \"text\" : \"testing suggestions\",\r\n11:17:34                 \"score\" : 0.053599596\r\n11:17:34               }\r\n11:17:34             ]\r\n11:17:34           }\r\n11:17:34         ]\r\n11:17:34       }\r\n11:17:34     }\r\n11:17:34     Expected: <3>\r\n11:17:34          but: was <1>\r\n11:17:34         at __randomizedtesting.SeedInfo.seed([1269EF3325F321EB:99054A93C4724102]:0)\r\n11:17:34         at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\r\n11:17:34         at org.elasticsearch.test.hamcrest.ElasticsearchAssertions.assertSuggestionSize(ElasticsearchAssertions.java:386)\r\n11:17:34         at org.elasticsearch.search.suggest.SuggestSearchIT.testEmptyShards(SuggestSearchIT.java:831)\r\n```\r\n\r\nreproduction line (does not reproduce locally):\r\n\r\n```\r\n./gradlew :server:integTest --tests \"org.elasticsearch.search.suggest.SuggestSearchIT.testEmptyShards\" -Dtests.seed=1269EF3325F321EB -Dtests.security.manager=true -Dtests.locale=yo-NG -Dtests.timezone=Portugal -Dcompiler.java=12 -Druntime.java=11\r\n```\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/511943224","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-511943224","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":511943224,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMTk0MzIyNA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-07-16T18:58:54Z","updated_at":"2019-07-16T18:58:54Z","author_association":"MEMBER","body":"Ran this for a few hours locally on master and didn't get a failure, so this remains hard to reproduce. I was suspecting an incomplete index operation or something with index refrshing at first, but then again the response contains one of the three expected suggestions which means the one single document containing the suggested data must have been indexed and the suggestions been collected on that shard, otherwise we'd get an empty options entry. Still puzzled.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/513879576","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-513879576","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":513879576,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMzg3OTU3Ng==","user":{"login":"ebadyano","id":26631211,"node_id":"MDQ6VXNlcjI2NjMxMjEx","avatar_url":"https://avatars0.githubusercontent.com/u/26631211?v=4","gravatar_id":"","url":"https://api.github.com/users/ebadyano","html_url":"https://github.com/ebadyano","followers_url":"https://api.github.com/users/ebadyano/followers","following_url":"https://api.github.com/users/ebadyano/following{/other_user}","gists_url":"https://api.github.com/users/ebadyano/gists{/gist_id}","starred_url":"https://api.github.com/users/ebadyano/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ebadyano/subscriptions","organizations_url":"https://api.github.com/users/ebadyano/orgs","repos_url":"https://api.github.com/users/ebadyano/repos","events_url":"https://api.github.com/users/ebadyano/events{/privacy}","received_events_url":"https://api.github.com/users/ebadyano/received_events","type":"User","site_admin":false},"created_at":"2019-07-22T17:32:29Z","updated_at":"2019-07-22T17:32:29Z","author_association":"CONTRIBUTOR","body":"Another failure: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+matrix-java-periodic/ES_BUILD_JAVA=openjdk12,ES_RUNTIME_JAVA=java12,nodes=general-purpose/97/consoleFull","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/516930347","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-516930347","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":516930347,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjkzMDM0Nw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-07-31T16:49:20Z","updated_at":"2019-07-31T16:49:20Z","author_association":"MEMBER","body":"I got this failing a few times locally from my IDE now with the last failure seed (-Dtests.seed=51F37CF75C1694B8), however it still reproduces very rarely (i need to run it several times and hope it fails). \r\n\r\nFrom what I see after adding a bit more logging, when we get only one instead of the three expected options, they missing ones are not added to the PhraseSuggestion.Entry because its internal \"cutoffScore\" is higher than the option added. This cutoffScore on the entry gets transferred from the NoisyChannelSpellChecker and seems to depend on some other internal term statistics. The entry cutoff scores (and the option scores) seem to differ depending on test randomization, usually stay fixed with a fixed seed. In the failure case I get different outputs though. Might be some very sneaky race condition. \r\n\r\nDigging further, but it looks like this level of detail shouldn't be tested by the \"testEmptyShards\" method. I'm mostly interested why this doesn't reproduce easily.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/519506107","html_url":"https://github.com/elastic/elasticsearch/issues/43261#issuecomment-519506107","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43261","id":519506107,"node_id":"MDEyOklzc3VlQ29tbWVudDUxOTUwNjEwNw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2019-08-08T12:55:45Z","updated_at":"2019-08-08T12:55:45Z","author_association":"MEMBER","body":"I was able to reproduce this now with some tweaking of the test code. The two suggestion options that are missing in the rate failure case are not added to the suggestion entry in the reduce phase because they are below the PhraseSuggestion.Entry cutoff score. \r\n\r\nFor the particular last failure seed (-Dtests.seed=51F37CF75C1694B8) we have seven shards. In the regular case, empty shards return entries with a cutoff score of  4.9E-324, one shard has a cutoff score of 0.026 and one with 0.0334. In the failure case, instead we get cutoff scores of 4.9E-324, 0.0334 and 0.043. While reducing, we pick the highest cutoff score for the entry we merge, and two of the original three options are dropped now because they are below 0.043.\r\n\r\nThe reason one shard very infrequently returns suggestion entries with the higher cutoff score is that the WordScorer inside the suggestion CandidateScorer occasionally sees more than one Lucene segment if e.g. a refresh happens during indexing of the test documents (this can be forced by inserting a few second waits in between indexing the documents). In that case term statistics are slightly different. \r\n\r\nBottom line: the slightly differen suggestion scoring behaviour is due to varying segment counts depending on when refreshes etc... happen on the shard which is something that the test seed cannot fully determine. The slight variation is only pronounced here because of the very low document count, in practice term statistics shouldn't differ that much. In order to make the test more stable it should be enough to turn off refreshes at all or force-merge after indexing. I'll open a PR with the former option.\r\n\r\n","performed_via_github_app":null}]