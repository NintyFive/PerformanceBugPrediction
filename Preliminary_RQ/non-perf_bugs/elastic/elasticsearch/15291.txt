{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15291","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15291/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15291/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15291/events","html_url":"https://github.com/elastic/elasticsearch/issues/15291","id":120870471,"node_id":"MDU6SXNzdWUxMjA4NzA0NzE=","number":15291,"title":"Highlighter tags extraneous terms when used with match_phrase query (v2.1.0)","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars3.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2015-12-07T21:20:37Z","updated_at":"2015-12-17T16:23:22Z","closed_at":"2015-12-17T16:12:18Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nI've got an application which uses match_phrase queries to look for, and highlight, exact matches within file texts. It worked fantastically on ElasticSearch version 2.0.0 and 2.0.1, but breaks on 2.1.0.\n\nThe query appears to run correctly but the highlighter highlights ALL instances of terms in the query instead of just those that appear within matched phrases. For example, if the query contains the word \"is\", then every instance of the word \"is\" - throughout the entire document - is highlighted.\n# Example:\n\nAs an example, I've prepared a series of commands in the Sense chrome plugin to replicate the problem:\n\n```\nPOST /test_index\n{\n   \"settings\": {\n      \"number_of_shards\": 1,\n      \"number_of_replicas\": 0\n   },\n       \"mappings\" : {\n        \"file\" : {\n            \"properties\" : {\n                \"text\" : { \"type\" : \"string\"}\n            }\n        }\n    }\n}\n\nPOST /test_index/file\n{\n    \"text\": \"The quick brown fox jumped over the other, lazier, fox.\"\n}\n\nPOST /test_index/file\n{\n    \"text\": \"Doc Brown is one quick fox.\"\n}\n\nPOST /test_index/file/_search\n{\n   \"query\": {\n      \"match_phrase\": {\n         \"text\": \"quick brown fox\"\n      }\n   },\n   \"highlight\": {\n      \"fields\": {\n         \"text\": {\n            \"number_of_fragments\": 0\n         }\n      }\n   }\n}\n```\n## Version 2.0.1 results\n\nUnder version 2.0.1, the search call returns the following hits array:\n\n``` JSON\n\"hits\": [\n    {\n        \"_index\": \"test_index\",\n        \"_type\": \"file\",\n        \"_id\": \"AVF-PCoeysoVw9xNBYa3\",\n        \"_score\": 0.55737644,\n        \"_source\":{\n            \"text\": \"The quick brown fox jumped over the other, lazier, fox.\"\n        },\n        \"highlight\": {\n            \"text\": [\n                \"The <em>quick</em> <em>brown</em> <em>fox</em> jumped over the other, lazier, fox.\"\n            ]\n        }\n    }\n]\n```\n\nThis is the expected and desired output.\n## Version 2.1.0 results\n\nUnder version 2.1.0, the search call returns the following hits array:\n\n``` JSON\n\"hits\": [\n    {\n        \"_index\": \"test_index\",\n        \"_type\": \"file\",\n        \"_id\": \"AVF-MdXsEcdhEnh7dUcO\",\n        \"_score\": 0.55737644,\n        \"_source\": {\n            \"text\": \"The quick brown fox jumped over the other, lazier, fox.\"\n        },\n        \"highlight\": {\n            \"text\": [\n                \"The <em>quick</em> <em>brown</em> <em>fox</em> jumped over the other, lazier, <em>fox</em>.\"\n            ]\n        }\n    }\n]\n```\n\nThis is the same match, and even has the same score, but the word \"fox\" is incorrectly highlighted when it occurs without the rest of the phrase.\n## Tested solutions\n\nIn attempt to rectify this problem, I attempted two things:\n1. First, on the theory that perhaps it had switched to the postings highlighter rather than the plain highlighter, I attempted to force the use of the plain version with the `\"type\": \"plain\"` flag. Unfortunately, this had no visible effect.\n2. Second, duplicated the original query within a `\"highlight_query\"` block. This too, unfortunately, had no visible effect.\n# Theory\n\nCurrently, my theory is that this problem is related to the upgrade to lucene-5.3.0. (https://github.com/elastic/elasticsearch/pull/13239)\nSpecifically, I wonder if it has to do with how NearSpansOrdered are processed. (https://issues.apache.org/jira/browse/LUCENE-6537)\n\nThat said, this is purely conjecture. It's quite possible - or even likely - that the problem lies elsewhere.\nI'm hoping that an elasticsearch expert might have a better idea.\n\nThank you.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}