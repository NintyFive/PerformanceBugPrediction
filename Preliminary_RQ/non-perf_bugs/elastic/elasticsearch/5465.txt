{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5465","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5465/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5465/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5465/events","html_url":"https://github.com/elastic/elasticsearch/issues/5465","id":29759507,"node_id":"MDU6SXNzdWUyOTc1OTUwNw==","number":5465,"title":"Adding \"routing\" setting for an alias via POST _aliases has different behavior than PUT (single alias)","user":{"login":"sujal","id":7303,"node_id":"MDQ6VXNlcjczMDM=","avatar_url":"https://avatars1.githubusercontent.com/u/7303?v=4","gravatar_id":"","url":"https://api.github.com/users/sujal","html_url":"https://github.com/sujal","followers_url":"https://api.github.com/users/sujal/followers","following_url":"https://api.github.com/users/sujal/following{/other_user}","gists_url":"https://api.github.com/users/sujal/gists{/gist_id}","starred_url":"https://api.github.com/users/sujal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sujal/subscriptions","organizations_url":"https://api.github.com/users/sujal/orgs","repos_url":"https://api.github.com/users/sujal/repos","events_url":"https://api.github.com/users/sujal/events{/privacy}","received_events_url":"https://api.github.com/users/sujal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2014-03-19T18:26:59Z","updated_at":"2014-03-20T09:38:37Z","closed_at":"2014-03-20T09:38:37Z","author_association":"NONE","active_lock_reason":null,"body":"Hi there,\n\nI've noticed an issue that either points to me misunderstanding something about routing in Elasticsearch or a subtle bug in elasticsearch itself. Here's what I'm trying to do:\n- create an alias with a routing parameter and a term filter ( following the [single index + routing idea](http://www.elasticsearch.org/videos/big-data-search-and-analytics/) for multi-user indices)\n\nWhen trying to create aliases, we noticed that the routing parameter was getting dropped from our alias's definition. Since we put documents into the index with the routing param, but only query using the alias, documents weren't getting returned most of the time even if they were in the index. \n\nUpon debugging, we found that the POST _aliases endpoint silently drops the routing parameter if it's an integer, but honors it if it's a string. Oddly, though, the PUT endpoint to create a single alias works for a string or numeric routing param.\n\nSee the test case below.\n\n```\ncurl -X PUT 'http://localhost:9200/test1?pretty'\n\ncurl -X POST 'http://localhost:9200/_aliases?pretty' -d '{\n  \"actions\":[\n    {\n      \"add\":{\n        \"index\":\"test1\",\n        \"alias\":\"test1_1\",\n        \"routing\":1,\n        \"filter\":{\n          \"term\":{\n            \"user_id\":1\n          }\n        }\n      }\n    }\n  ]\n}'\n\n\ncurl -X GET 'http://localhost:9200/_alias/test1_1?pretty'\n#2014-03-19T14:07:28-04:00 [200] (0.002s)\n#\n# {\n#   \"test1\":{\n#     \"aliases\":{\n#       \"test1_1\":{\n#         \"filter\":{\n#           \"term\":{\n#             \"user_id\":1\n#           \n# }\n#         }\n#       }\n#     }\n#   }\n# }\n\n\ncurl -X DELETE 'http://localhost:9200/test1/_alias/test1_1?pretty'\n\ncurl -X PUT 'http://localhost:9200/test1/_alias/test1_1?pretty' -d '{\n  \"routing\":1,\n  \"filter\":{\n    \"term\":{\n      \"user_id\":1\n    }\n  }\n}'\n\ncurl -X GET 'http://localhost:9200/_alias/test1_1?pretty'\n#2014-03-19T14:07:28-04:00 [200] (0.002s)\n#\n# {\n#   \"test1\":{\n#     \"aliases\":{\n#       \"test1_1\":{\n#         \"filter\":{\n#           \"term\":{\n#             \"user_id\":1\n#           \n# }\n#         },\n#         \"index_routing\":\"1\",\n#         \"search_routing\":\"1\"\n#       }\n#     }\n#   }\n# }\n\n# NOW try a STRING for routing\n\ncurl -X DELETE 'http://localhost:9200/test1/_alias/test1_1?pretty'\n\ncurl -X POST 'http://localhost:9200/_aliases?pretty' -d '{\n  \"actions\":[\n    {\n      \"add\":{\n        \"index\":\"test1\",\n        \"alias\":\"test1_1\",\n        \"routing\":\"1\",\n        \"filter\":{\n          \"term\":{\n            \"user_id\":1\n          }\n        }\n      }\n    }\n  ]\n}'\n\ncurl -X GET 'http://localhost:9200/_alias/test1_1?pretty'\n# {\n#   \"test1\" : {\n#     \"aliases\" : {\n#       \"test1_1\" : {\n#         \"filter\" : {\n#           \"term\" : {\n#             \"user_id\" : 1\n#           }\n#         },\n#         \"index_routing\" : \"1\",\n#         \"search_routing\" : \"1\"\n#       }\n#     }\n#   }\n# }\n\n\n```\n\nOur ES version we're testing against:\n\n`curl -XGET 'http://localhost:9200'`\n\nwhich returns:\n\n```\n{\n  \"status\" : 200,\n  \"name\" : \"Jamie Braddock\",\n  \"version\" : {\n    \"number\" : \"1.0.1\",\n    \"build_hash\" : \"5c03844e1978e5cc924dab2a423dc63ce881c42b\",\n    \"build_timestamp\" : \"2014-02-25T15:52:53Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.6\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n```\n\nHere's the ruby program we initially used to debug inside the Rails console (easier to change the routing param from int to string - i just cut & pasted the curl commands from our logging there. Guess I could set an ENV var for the shell stuff, but I leave that to the user :smile: )\n\n```\nclient = Rails.configuration.elasticsearch\n\nindex = \"test1\"\nfilter_id = 1\nunique_alias_name = \"test1_#{filter_id}\"\nfilter_hash = { \"term\" => { \"user_id\" => filter_id } }\n\nclient.indices.create(index: index)\nclient.indices.update_aliases body: {\n  actions: [\n    { add: { index: index, alias: unique_alias_name, routing: filter_id, filter: filter_hash } }\n  ]\n}\n\nresult1 = client.indices.get_alias name: unique_alias_name\nputs result1\n\nclient.indices.delete_alias index: index, name: unique_alias_name\n\nif client.indices.exists_alias(name: unique_alias_name)\n  puts \"didn't delete\" \n  exit 1\nend\n\nclient.indices.put_alias index: index, name: unique_alias_name, body: {\n  routing: filter_id,\n  filter: filter_hash\n}\n\nresult2 = client.indices.get_alias name: unique_alias_name\nputs result2\n\n\nunless result1 == result2\n  puts \"Why don't these match!!\" \n  exit 1\nend\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}