{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8268","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8268/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8268/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8268/events","html_url":"https://github.com/elastic/elasticsearch/issues/8268","id":47133322,"node_id":"MDU6SXNzdWU0NzEzMzMyMg==","number":8268,"title":"Core: filter cache heap usage should include RAM used by the cache keys (Filter)","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2014-10-29T10:47:09Z","updated_at":"2015-05-29T17:22:19Z","closed_at":"2015-05-28T21:23:52Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I looked at the heap dump from #8249 and it looks like the majority of the heap is consumed by filter cache keys (TermFilter in that case, where each term was quite large: ~200 bytes long).  There were ~5.5 M such entries, I suspect most of which matching 0 docs.\n\nWe don't track cache key RAM usage today in Elasticsearch, because it's tricky.  E.g. Lucene's Filter doesn't implement Accountable, so we can't (easily) ask it how much RAM it's using.  In general there can be sharing between Filters so the RAM used across N filters is less than the sum of each, though I'm not sure Elasticsearch does this. Also, ideally we'd avoid over-counting when the same Filter is cached across N segments.\n\nIt's tricky, but I think we need to do something here...\n\nMaybe a separate improvement we could make here is to not bother caching a filter that matched 0 docs?  Such filters are usually (?) fast to re-execute...\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}