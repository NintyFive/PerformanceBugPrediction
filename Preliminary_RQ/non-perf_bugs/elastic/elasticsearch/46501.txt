{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46501","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46501/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46501/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46501/events","html_url":"https://github.com/elastic/elasticsearch/issues/46501","id":491201320,"node_id":"MDU6SXNzdWU0OTEyMDEzMjA=","number":46501,"title":"[ML] After 7.3->7.4 upgrade get transforms only shows transforms from 7.3","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":1434538947,"node_id":"MDU6TGFiZWwxNDM0NTM4OTQ3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.4.0","name":"v7.4.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"assignees":[{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-09-09T16:31:44Z","updated_at":"2019-09-11T13:02:08Z","closed_at":"2019-09-11T13:02:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"(Found by @wwang500.)\r\n\r\n1. Install 7.3\r\n2. Create some data frame transforms\r\n3. Upgrade to 7.4\r\n4. Create some more data frame transforms\r\n5. `GET _data_frame/transforms`\r\n6. `GET _data_frame/transforms/_stats`\r\n\r\nThe problem is that steps 5 and 6 only show the data frame transforms created in step 2.  The data frame transforms in step 4 are invisible to these endpoints.\r\n\r\nThe root cause of the problem can be seen by running these searches:\r\n\r\n```\r\nGET .data-frame-internal-*/_search?q=doc_type:data_frame_transform_config\r\n\r\nGET .data-frame-internal-*/_search?q=doc_type:data_frame_transform_config&sort=id\r\n```\r\n\r\nIn the case of @wwang500's Cloud cluster the first search returns 10 documents and the second search returns 3 documents and this warning:\r\n\r\n```\r\n  \"_shards\" : {\r\n    \"total\" : 2,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 1,\r\n    \"failures\" : [\r\n      {\r\n        \"shard\" : 0,\r\n        \"index\" : \".data-frame-internal-2\",\r\n        \"node\" : \"azom_s-7RzC_59GZv4cm8g\",\r\n        \"reason\" : {\r\n          \"type\" : \"illegal_argument_exception\",\r\n          \"reason\" : \"Fielddata is disabled on text fields by default. Set fielddata=true on [id] in order to load fielddata in memory by uninverting the inverted index. Note that this can however use significant memory. Alternatively use a keyword field instead.\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n```\r\n\r\nCalling `GET .data-frame-internal-2/_mapping` shows that the problem is that a document was written to the `.data-frame-internal-2` index before the corresponding index template was created, so it has been created with dynamic mappings.\r\n\r\nIt means there must be some loophole where the index template that is supposed to be installed as soon as a 7.4 node starts up does not get installed immediately, and there is enough time for a transform that was running during the upgrade to get assigned to the 7.4 node and write a document to the `.data-frame-internal-2` index before the template is installed.\r\n\r\n`GET .data-frame-internal-2/_search?seq_no_primary_term=true&q=_seq_no:0` shows that the first document written to the `.data-frame-internal-2` index was a checkpoint document:\r\n\r\n```\r\n    ...\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \".data-frame-internal-2\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"data_frame_transform_checkpoint-dfm-continuous-2\",\r\n        \"_seq_no\" : 0,\r\n        \"_primary_term\" : 1,\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"id\" : \"dfm-continuous\",\r\n          \"checkpoint\" : 2,\r\n          \"doc_type\" : \"data_frame_transform_checkpoint\",\r\n          ...\r\n```\r\n\r\nSo it's the place where checkpoints are written that can sneak ahead of the index template upgrade.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}