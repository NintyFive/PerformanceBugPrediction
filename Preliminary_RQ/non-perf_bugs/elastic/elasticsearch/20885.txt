{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20885","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20885/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20885/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20885/events","html_url":"https://github.com/elastic/elasticsearch/issues/20885","id":182519417,"node_id":"MDU6SXNzdWUxODI1MTk0MTc=","number":20885,"title":"illegal_argument_exception when using scripted fields.","user":{"login":"stacey-gammon","id":16563603,"node_id":"MDQ6VXNlcjE2NTYzNjAz","avatar_url":"https://avatars3.githubusercontent.com/u/16563603?v=4","gravatar_id":"","url":"https://api.github.com/users/stacey-gammon","html_url":"https://github.com/stacey-gammon","followers_url":"https://api.github.com/users/stacey-gammon/followers","following_url":"https://api.github.com/users/stacey-gammon/following{/other_user}","gists_url":"https://api.github.com/users/stacey-gammon/gists{/gist_id}","starred_url":"https://api.github.com/users/stacey-gammon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/stacey-gammon/subscriptions","organizations_url":"https://api.github.com/users/stacey-gammon/orgs","repos_url":"https://api.github.com/users/stacey-gammon/repos","events_url":"https://api.github.com/users/stacey-gammon/events{/privacy}","received_events_url":"https://api.github.com/users/stacey-gammon/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-10-12T13:01:06Z","updated_at":"2016-10-12T18:19:15Z","closed_at":"2016-10-12T13:12:28Z","author_association":"NONE","active_lock_reason":null,"body":"There is a bug in the Kibana Repo that looks like it might be exposing an ES bug.  Could someone take a look?  https://github.com/elastic/kibana/issues/8404\n\nHere is the relevant request/response that is triggering the error, copied from the above issue:\n\n```\nPOST logstash-0/_search\n{  \n   \"size\":500,\n   \"sort\":[  \n      {  \n         \"@timestamp\":{  \n            \"order\":\"desc\",\n            \"unmapped_type\":\"boolean\"\n         }\n      }\n   ],\n   \"highlight\":{  \n      \"pre_tags\":[  \n         \"@kibana-highlighted-field@\"\n      ],\n      \"post_tags\":[  \n         \"@/kibana-highlighted-field@\"\n      ],\n      \"fields\":{  \n         \"*\":{  \n\n         }\n      },\n      \"require_field_match\":false,\n      \"fragment_size\":2147483647\n   },\n   \"query\":{  \n      \"bool\":{  \n         \"must\":[  \n            {  \n               \"query_string\":{  \n                  \"query\":\"*\",\n                  \"analyze_wildcard\":true\n               }\n            },\n            {  \n               \"script\":{  \n                  \"script\":{  \n                     \"inline\":\"(-1 * doc['bytes'].value) == value\",\n                     \"lang\":\"painless\",\n                     \"params\":{  \n                        \"value\":0\n                     }\n                  }\n               }\n            },\n            {  \n               \"script\":{  \n                  \"script\":{  \n                     \"inline\":\"(-1 * doc['bytes'].value) == value\",\n                     \"lang\":\"painless\",\n                     \"params\":{  \n                        \"value\":-2724\n                     }\n                  }\n               }\n            },\n            {  \n               \"range\":{  \n                  \"@timestamp\":{  \n                     \"gte\":1474479018497,\n                     \"lte\":1474479918497,\n                     \"format\":\"epoch_millis\"\n                  }\n               }\n            }\n         ],\n         \"must_not\":[  \n\n         ]\n      }\n   },\n   \"aggs\":{  \n      \"2\":{  \n         \"date_histogram\":{  \n            \"field\":\"@timestamp\",\n            \"interval\":\"30s\",\n            \"time_zone\":\"America/New_York\",\n            \"min_doc_count\":1\n         }\n      }\n   },\n   \"stored_fields\":[  \n      \"*\"\n   ],\n   \"_source\":true,\n   \"script_fields\":{  \n      \"inverse bytes\":{  \n         \"script\":{  \n            \"inline\":\"-1 * doc['bytes'].value\",\n            \"lang\":\"painless\"\n         }\n      }\n   },\n   \"docvalue_fields\":[  \n      \"utc_time\",\n      \"relatedContent.article:modified_time\",\n      \"@timestamp\",\n      \"relatedContent.article:published_time\"\n   ]\n}\n```\n\nResponse:\n\n```\n{  \n   \"error\":{  \n      \"root_cause\":[  \n         {  \n            \"type\":\"script_exception\",\n            \"reason\":\"compile error\",\n            \"script_stack\":[  \n               \"... * doc['bytes'].value) == value\",\n               \"                             ^---- HERE\"\n            ],\n            \"script\":\"(-1 * doc['bytes'].value) == value\",\n            \"lang\":\"painless\"\n         }\n      ],\n      \"type\":\"search_phase_execution_exception\",\n      \"reason\":\"all shards failed\",\n      \"phase\":\"query_fetch\",\n      \"grouped\":true,\n      \"failed_shards\":[  \n         {  \n            \"shard\":0,\n            \"index\":\"logstash-0\",\n            \"node\":\"apPgvtcuTbSA2V4HWRUWww\",\n            \"reason\":{  \n               \"type\":\"query_shard_exception\",\n               \"reason\":\"failed to create query: {\\n  \\\"bool\\\" : {\\n    \\\"must\\\" : [\\n      {\\n        \\\"query_string\\\" : {\\n          \\\"query\\\" : \\\"*\\\",\\n          \\\"fields\\\" : [ ],\\n          \\\"use_dis_max\\\" : true,\\n          \\\"tie_breaker\\\" : 0.0,\\n          \\\"default_operator\\\" : \\\"or\\\",\\n          \\\"auto_generate_phrase_queries\\\" : false,\\n          \\\"max_determined_states\\\" : 10000,\\n          \\\"lowercase_expanded_terms\\\" : true,\\n          \\\"enable_position_increment\\\" : true,\\n          \\\"fuzziness\\\" : \\\"AUTO\\\",\\n          \\\"fuzzy_prefix_length\\\" : 0,\\n          \\\"fuzzy_max_expansions\\\" : 50,\\n          \\\"phrase_slop\\\" : 0,\\n          \\\"analyze_wildcard\\\" : true,\\n          \\\"locale\\\" : \\\"und\\\",\\n          \\\"escape\\\" : false,\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"script\\\" : {\\n          \\\"script\\\" : {\\n            \\\"inline\\\" : \\\"(-1 * doc['bytes'].value) == value\\\",\\n            \\\"lang\\\" : \\\"painless\\\",\\n            \\\"params\\\" : {\\n              \\\"value\\\" : 0\\n            }\\n          },\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"script\\\" : {\\n          \\\"script\\\" : {\\n            \\\"inline\\\" : \\\"(-1 * doc['bytes'].value) == value\\\",\\n            \\\"lang\\\" : \\\"painless\\\",\\n            \\\"params\\\" : {\\n              \\\"value\\\" : -2724\\n            }\\n          },\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"range\\\" : {\\n          \\\"@timestamp\\\" : {\\n            \\\"from\\\" : 1474479018497,\\n            \\\"to\\\" : 1474479918497,\\n            \\\"include_lower\\\" : true,\\n            \\\"include_upper\\\" : true,\\n            \\\"format\\\" : \\\"epoch_millis\\\",\\n            \\\"boost\\\" : 1.0\\n          }\\n        }\\n      }\\n    ],\\n    \\\"disable_coord\\\" : false,\\n    \\\"adjust_pure_negative\\\" : true,\\n    \\\"boost\\\" : 1.0\\n  }\\n}\",\n               \"index_uuid\":\"2Gr8UT6HTTCyaJWywRhrCQ\",\n               \"index\":\"logstash-0\",\n               \"caused_by\":{  \n                  \"type\":\"script_exception\",\n                  \"reason\":\"compile error\",\n                  \"caused_by\":{  \n                     \"type\":\"illegal_argument_exception\",\n                     \"reason\":\"Variable [value] is not defined.\"\n                  },\n                  \"script_stack\":[  \n                     \"... * doc['bytes'].value) == value\",\n                     \"                             ^---- HERE\"\n                  ],\n                  \"script\":\"(-1 * doc['bytes'].value) == value\",\n                  \"lang\":\"painless\"\n               }\n            }\n         }\n      ],\n      \"caused_by\":{  \n         \"type\":\"query_shard_exception\",\n         \"reason\":\"failed to create query: {\\n  \\\"bool\\\" : {\\n    \\\"must\\\" : [\\n      {\\n        \\\"query_string\\\" : {\\n          \\\"query\\\" : \\\"*\\\",\\n          \\\"fields\\\" : [ ],\\n          \\\"use_dis_max\\\" : true,\\n          \\\"tie_breaker\\\" : 0.0,\\n          \\\"default_operator\\\" : \\\"or\\\",\\n          \\\"auto_generate_phrase_queries\\\" : false,\\n          \\\"max_determined_states\\\" : 10000,\\n          \\\"lowercase_expanded_terms\\\" : true,\\n          \\\"enable_position_increment\\\" : true,\\n          \\\"fuzziness\\\" : \\\"AUTO\\\",\\n          \\\"fuzzy_prefix_length\\\" : 0,\\n          \\\"fuzzy_max_expansions\\\" : 50,\\n          \\\"phrase_slop\\\" : 0,\\n          \\\"analyze_wildcard\\\" : true,\\n          \\\"locale\\\" : \\\"und\\\",\\n          \\\"escape\\\" : false,\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"script\\\" : {\\n          \\\"script\\\" : {\\n            \\\"inline\\\" : \\\"(-1 * doc['bytes'].value) == value\\\",\\n            \\\"lang\\\" : \\\"painless\\\",\\n            \\\"params\\\" : {\\n              \\\"value\\\" : 0\\n            }\\n          },\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"script\\\" : {\\n          \\\"script\\\" : {\\n            \\\"inline\\\" : \\\"(-1 * doc['bytes'].value) == value\\\",\\n            \\\"lang\\\" : \\\"painless\\\",\\n            \\\"params\\\" : {\\n              \\\"value\\\" : -2724\\n            }\\n          },\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"range\\\" : {\\n          \\\"@timestamp\\\" : {\\n            \\\"from\\\" : 1474479018497,\\n            \\\"to\\\" : 1474479918497,\\n            \\\"include_lower\\\" : true,\\n            \\\"include_upper\\\" : true,\\n            \\\"format\\\" : \\\"epoch_millis\\\",\\n            \\\"boost\\\" : 1.0\\n          }\\n        }\\n      }\\n    ],\\n    \\\"disable_coord\\\" : false,\\n    \\\"adjust_pure_negative\\\" : true,\\n    \\\"boost\\\" : 1.0\\n  }\\n}\",\n         \"index_uuid\":\"2Gr8UT6HTTCyaJWywRhrCQ\",\n         \"index\":\"logstash-0\",\n         \"caused_by\":{  \n            \"type\":\"script_exception\",\n            \"reason\":\"compile error\",\n            \"caused_by\":{  \n               \"type\":\"illegal_argument_exception\",\n               \"reason\":\"Variable [value] is not defined.\"\n            },\n            \"script_stack\":[  \n               \"... * doc['bytes'].value) == value\",\n               \"                             ^---- HERE\"\n            ],\n            \"script\":\"(-1 * doc['bytes'].value) == value\",\n            \"lang\":\"painless\"\n         }\n      }\n   },\n   \"status\":400\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}