{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18005","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18005/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18005/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18005/events","html_url":"https://github.com/elastic/elasticsearch/issues/18005","id":151344457,"node_id":"MDU6SXNzdWUxNTEzNDQ0NTc=","number":18005,"title":"elasticsearch nested aggregation inside a reverse nested aggregation","user":{"login":"manioc2015","id":10515438,"node_id":"MDQ6VXNlcjEwNTE1NDM4","avatar_url":"https://avatars0.githubusercontent.com/u/10515438?v=4","gravatar_id":"","url":"https://api.github.com/users/manioc2015","html_url":"https://github.com/manioc2015","followers_url":"https://api.github.com/users/manioc2015/followers","following_url":"https://api.github.com/users/manioc2015/following{/other_user}","gists_url":"https://api.github.com/users/manioc2015/gists{/gist_id}","starred_url":"https://api.github.com/users/manioc2015/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/manioc2015/subscriptions","organizations_url":"https://api.github.com/users/manioc2015/orgs","repos_url":"https://api.github.com/users/manioc2015/repos","events_url":"https://api.github.com/users/manioc2015/events{/privacy}","received_events_url":"https://api.github.com/users/manioc2015/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2016-04-27T09:49:04Z","updated_at":"2018-04-16T14:59:39Z","closed_at":"2016-05-02T10:59:52Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.1\n\n**JVM version**: 1.8.0_66 / 25.66-b17\n\n**OS version**: Mac OS X 10.11.4\n\n**Description of the problem including expected versus actual behavior**:\nI am having trouble getting the correct values to show up in a 4 level deep aggregation scenario where the first two levels are nested, the third is reverse_nested, and the fourth is nested again.\n\nHere is my index mapping: \n\n```\ncurl -XDELETE localhost:9200/orders-d\ncurl -XPUT localhost:9200/orders-d\ncurl -XPUT localhost:9200/orders-d/order-d/_mapping -d '{\n    \"order-d\": {  \n        \"properties\": {  \n            \"id\": {  \n                \"type\": \"string\"  \n            },  \n            \"orderNumber\": {  \n                \"type\": \"string\"  \n            },  \n            \"groupId\": {  \n                \"type\": \"string\"  \n            },  \n            \"groupOrderNumber\": {  \n                \"type\": \"string\"  \n            },  \n            \"dateCreated\": {  \n                \"type\": \"date\"  \n            },  \n            \"dateUpdated\": {  \n                \"type\": \"date\"  \n            },  \n            \"location\": {  \n                \"type\": \"object\"  \n            },  \n            \"orderSubmitter\": {  \n                \"type\": \"object\"  \n            },  \n            \"distributor\": {  \n                \"type\": \"object\"  \n            },  \n            \"salesRep\": {  \n                \"type\": \"object\"  \n            },  \n            \"status\": {  \n                \"type\": \"string\"  \n            },  \n            \"total\": {  \n                \"type\": \"double\"  \n            },  \n            \"isTTOrder\": {  \n                \"type\": \"boolean\"  \n            },  \n            \"lineItems\": {  \n                \"type\": \"nested\",  \n                \"include_in_parent\": true,  \n                \"properties\": {  \n                    \"product\": {  \n                        \"type\": \"object\"  \n                    },  \n                    \"category\": {  \n                        \"type\": \"object\"  \n                    },  \n                    \"subCategory\": {  \n                        \"type\": \"object\"  \n                    },  \n                    \"quantity\": {  \n                        \"type\": \"double\"  \n                    },  \n                    \"unitPrice\": {  \n                        \"type\": \"double\"  \n                    },  \n                    \"totalPrice\": {  \n                        \"type\": \"double\"  \n                    },  \n                    \"pricedByUnitPrice\": {  \n                        \"type\": \"double\"  \n                    }  \n                }  \n            }  \n        }  \n    }\n}'\n```\n\nHere is my data:\n\n```\ncurl -XPUT localhost:9200/orders-d/order-d/0 -d '{\n                \"id\": \"571652632a19085c008b4577\",\n                \"orderNumber\": \"1617590686\",\n                \"groupId\": \"571652632a19085c008b4578\",\n                \"groupOrderNumber\": \"3485944627\",\n                \"dateCreated\": \"2016-04-19\",\n                \"dateUpdated\": null,\n                \"location\": {\n                    \"id\": \"54e53853505eb66b008b4569\",\n                    \"name\": \"Andrews Diner\"\n                },\n                \"orderSubmitter\": {\n                    \"id\": \"54e53853505eb66b008b4567\",\n                    \"name\": \"Kostantino Plaitis\"\n                },\n                \"distributor\": {\n                    \"id\": \"55c3879459ad0c63008b4569\",\n                    \"name\": \"Performance Foodservice Metro NY\"\n                },\n                \"salesRep\": null,\n                \"status\": \"pending\",\n                \"total\": 5410.21,\n                \"isTTOrder\": true,\n                \"lineItems\": [{\n                    \"product\": {\n                        \"id\": \"55bfb445c440b26a008b4571\",\n                        \"name\": \"Sabrett Sauerkraut 12 x 2 lb bags\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df845b3b8e77710e7b23ec\",\n                        \"name\": \"Groceries & Dry Food\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"53e1e8723b8e77a52b8b4586\",\n                        \"name\": \"Other Sauces Dipping\\/Condiments\\/Savoury Toppings\\/Savoury Spreads\\/Marinades (Perishable)\"\n                    },\n                    \"quantity\": 1,\n                    \"unitPrice\": 25.24,\n                    \"totalPrice\": 25.24,\n                    \"pricedByUnitPrice\": 0\n                }, {\n                    \"product\": {\n                        \"id\": \"55bc219238c0376e008b4570\",\n                        \"name\": \"Franks Red Hot Cayenne Pepper Sauce 4 x 1 gallon\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df845b3b8e77710e7b23ec\",\n                        \"name\": \"Groceries & Dry Food\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"53e1e8723b8e77a52b8b4606\",\n                        \"name\": \"Other Sauces Dipping\\/Condiments\\/Savoury Toppings\\/Savoury Spreads\\/Marinades (Shelf Stable)\"\n                    },\n                    \"quantity\": 1,\n                    \"unitPrice\": 45.06,\n                    \"totalPrice\": 45.06,\n                    \"pricedByUnitPrice\": 0\n                }, {\n                    \"product\": {\n                        \"id\": \"56d76c41bd821fda008b459a\",\n                        \"name\": \"Cereal, Classic Variety Pack, Kelloggs 1\\/60 ct.\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df845b3b8e77710e7b23ec\",\n                        \"name\": \"Groceries & Dry Food\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"53e1e8723b8e77a52b8b462d\",\n                        \"name\": \"Grains\\/Cereal - Ready to Eat - (Shelf Stable)\"\n                    },\n                    \"quantity\": 1,\n                    \"unitPrice\": 56.03,\n                    \"totalPrice\": 56.03,\n                    \"pricedByUnitPrice\": 0\n                }]\n            }'\n\ncurl -XPUT localhost:9200/orders-d/order-d/0 -d '{\n                \"id\": \"571652632a19085c008b4576\",\n                \"orderNumber\": \"2041063294\",\n                \"groupId\": \"571652632a19085c008b4578\",\n                \"groupOrderNumber\": \"3485944627\",\n                \"dateCreated\": \"2016-04-19\",\n                \"dateUpdated\": null,\n                \"location\": {\n                    \"id\": \"54e53853505eb66b008b4569\",\n                    \"name\": \"Andrews Diner\"\n                },\n                \"orderSubmitter\": {\n                    \"id\": \"54e53853505eb66b008b4567\",\n                    \"name\": \"Kostantino Plaitis\"\n                },\n                \"distributor\": {\n                    \"id\": \"55cdeece0a41216c008b4583\",\n                    \"name\": \"Driscoll Foods\"\n                },\n                \"salesRep\": null,\n                \"status\": \"pending\",\n                \"total\": 7575.27,\n                \"isTTOrder\": true,\n                \"lineItems\": [{\n                    \"product\": {\n                        \"id\": \"55ad05e08d28c36b008b456c\",\n                        \"name\": \"Pepper 3000 pcs\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df845b3b8e77710e7b23ec\",\n                        \"name\": \"Groceries & Dry Food\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"53e1e8723b8e77a52b8b4582\",\n                        \"name\": \"Herbs\\/Spices (Shelf Stable)\"\n                    },\n                    \"quantity\": 3,\n                    \"unitPrice\": 8.95,\n                    \"totalPrice\": 26.85,\n                    \"pricedByUnitPrice\": 0\n                }, {\n                    \"product\": {\n                        \"id\": \"55b3a12f6b415c68008b4568\",\n                        \"name\": \"Venice Maid Deluxe Corned Beef Hash 6 x 6 lb 10 oz\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df846c3b8e77710e7b23f7\",\n                        \"name\": \"Meat\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"54d8c56a279871b9078b4581\",\n                        \"name\": \"Beef - Prepared\\/Processed\"\n                    },\n                    \"quantity\": 1,\n                    \"unitPrice\": 59.75,\n                    \"totalPrice\": 59.75,\n                    \"pricedByUnitPrice\": 0\n                }, {\n                    \"product\": {\n                        \"id\": \"55b145798c26dc69008b4568\",\n                        \"name\": \"Aladdin Bakers Sesame Bread Sticks 150 x 2 packs\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df845b3b8e77710e7b23ec\",\n                        \"name\": \"Groceries & Dry Food\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"53e1e8723b8e77a52b8b45b0\",\n                        \"name\": \"Dried Breads (Shelf Stable)\"\n                    },\n                    \"quantity\": 8,\n                    \"unitPrice\": 15.5,\n                    \"totalPrice\": 124,\n                    \"pricedByUnitPrice\": 0\n                }, {\n                    \"product\": {\n                        \"id\": \"55ad074a8d28c36f008b456d\",\n                        \"name\": \"Smuckers Breakfast Syrup 100 cups\"\n                    },\n                    \"category\": {\n                        \"id\": \"53df845b3b8e77710e7b23ec\",\n                        \"name\": \"Groceries & Dry Food\"\n                    },\n                    \"subCategory\": {\n                        \"id\": \"53e1e8723b8e77a52b8b457d\",\n                        \"name\": \"Syrup\\/Treacle\\/Molasses (Shelf Stable)\"\n                    },\n                    \"quantity\": 10,\n                    \"unitPrice\": 8.95,\n                    \"totalPrice\": 89.5,\n                    \"pricedByUnitPrice\": 0\n                }]\n            }'\n```\n\nHere is my query:\n\n```\ncurl -XPOST localhost:9200/orders-d/_search -d '{\n        \"from\": 0,\n        \"size\": 0,\n        \"aggregations\": {\n            \"totalLineItems\": {\n                \"aggs\": {\n                    \"totalLineItems\": {\n                        \"terms\": {\n                            \"field\": \"lineItems.category.id\",\n                            \"size\": 0\n                        },\n                        \"aggs\": {\n                            \"totalLineItems\": {\n                                \"terms\": {\n                                    \"field\": \"lineItems.product.id\",\n                                    \"size\": 0\n                                },\n                                \"aggs\": {\n                                    \"totalLineItems\": {\n                                        \"aggs\": {\n                                            \"totalLineItems\": {\n                                                \"terms\": {\n                                                    \"field\": \"distributor.id\",\n                                                    \"size\": 0\n                                                },\n                                                \"aggs\": {\n                                                    \"totalLineItems\": {\n                                                        \"aggs\": {\n                                                            \"totalLineItems\": {\n                                                                \"sum\": {\n                                                                    \"field\": \"lineItems.totalPrice\"\n                                                                }\n                                                            }\n                                                        },\n                                                        \"nested\": {\n                                                            \"path\": \"lineItems\"\n                                                        }\n                                                    }\n                                                }\n                                            }\n                                        },\n                                        \"reverse_nested\": {}\n                                    }\n                                }\n                            }\n                        }\n                    }\n                },\n                \"nested\": {\n                    \"path\": \"lineItems\"\n                }\n            }\n        },\n        \"query\": {\n            \"bool\": {\n                \"must\": [{\n                    \"range\": {\n                        \"dateCreated\": {\n                            \"format\": \"yyyy-MM-dd\",\n                            \"gte\": \"2016-01-01\",\n                            \"lte\": \"2016-04-30\"\n                        }\n                    }\n                }]\n            }\n        }\n    }'\n```\n\n...and here are my results:\n\n```\n{\n    \"took\": 8,\n    \"timed_out\": false,\n    \"_shards\": {\n        \"total\": 5,\n        \"successful\": 5,\n        \"failed\": 0\n    },\n    \"hits\": {\n        \"total\": 1,\n        \"max_score\": 0.0,\n        \"hits\": []\n    },\n    \"aggregations\": {\n        \"totalLineItems\": {\n            \"doc_count\": 4,\n            \"totalLineItems\": {\n                \"doc_count_error_upper_bound\": 0,\n                \"sum_other_doc_count\": 0,\n                \"buckets\": [{\n                    \"key\": \"53df845b3b8e77710e7b23ec\",\n                    \"doc_count\": 3,\n                    \"totalLineItems\": {\n                        \"doc_count_error_upper_bound\": 0,\n                        \"sum_other_doc_count\": 0,\n                        \"buckets\": [{\n                            \"key\": \"55ad05e08d28c36b008b456c\",\n                            \"doc_count\": 1,\n                            \"totalLineItems\": {\n                                \"doc_count\": 1,\n                                \"totalLineItems\": {\n                                    \"doc_count_error_upper_bound\": 0,\n                                    \"sum_other_doc_count\": 0,\n                                    \"buckets\": [{\n                                        \"key\": \"55cdeece0a41216c008b4583\",\n                                        \"doc_count\": 1,\n                                        \"totalLineItems\": {\n                                            \"doc_count\": 4,\n                                            \"totalLineItems\": {\n                                                \"value\": 300.1\n                                            }\n                                        }\n                                    }]\n                                }\n                            }\n                        }, {\n                            \"key\": \"55ad074a8d28c36f008b456d\",\n                            \"doc_count\": 1,\n                            \"totalLineItems\": {\n                                \"doc_count\": 1,\n                                \"totalLineItems\": {\n                                    \"doc_count_error_upper_bound\": 0,\n                                    \"sum_other_doc_count\": 0,\n                                    \"buckets\": [{\n                                        \"key\": \"55cdeece0a41216c008b4583\",\n                                        \"doc_count\": 1,\n                                        \"totalLineItems\": {\n                                            \"doc_count\": 4,\n                                            \"totalLineItems\": {\n                                                \"value\": 300.1\n                                            }\n                                        }\n                                    }]\n                                }\n                            }\n                        }, {\n                            \"key\": \"55b145798c26dc69008b4568\",\n                            \"doc_count\": 1,\n                            \"totalLineItems\": {\n                                \"doc_count\": 1,\n                                \"totalLineItems\": {\n                                    \"doc_count_error_upper_bound\": 0,\n                                    \"sum_other_doc_count\": 0,\n                                    \"buckets\": [{\n                                        \"key\": \"55cdeece0a41216c008b4583\",\n                                        \"doc_count\": 1,\n                                        \"totalLineItems\": {\n                                            \"doc_count\": 4,\n                                            \"totalLineItems\": {\n                                                \"value\": 300.1\n                                            }\n                                        }\n                                    }]\n                                }\n                            }\n                        }]\n                    }\n                }, {\n                    \"key\": \"53df846c3b8e77710e7b23f7\",\n                    \"doc_count\": 1,\n                    \"totalLineItems\": {\n                        \"doc_count_error_upper_bound\": 0,\n                        \"sum_other_doc_count\": 0,\n                        \"buckets\": [{\n                            \"key\": \"55b3a12f6b415c68008b4568\",\n                            \"doc_count\": 1,\n                            \"totalLineItems\": {\n                                \"doc_count\": 1,\n                                \"totalLineItems\": {\n                                    \"doc_count_error_upper_bound\": 0,\n                                    \"sum_other_doc_count\": 0,\n                                    \"buckets\": [{\n                                        \"key\": \"55cdeece0a41216c008b4583\",\n                                        \"doc_count\": 1,\n                                        \"totalLineItems\": {\n                                            \"doc_count\": 4,\n                                            \"totalLineItems\": {\n                                                \"value\": 300.1\n                                            }\n                                        }\n                                    }]\n                                }\n                            }\n                        }]\n                    }\n                }]\n            }\n        }\n    }\n}\n```\n\nAs you can see from the results, all the aggregated values for each drilldown of totalLineItems have the same exact value. This is obviously incorrect.\n\nDid I do something wrong or is nesting inside a reverse nesting not supported?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}