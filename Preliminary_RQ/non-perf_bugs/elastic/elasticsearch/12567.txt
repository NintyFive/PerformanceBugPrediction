{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12567","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12567/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12567/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12567/events","html_url":"https://github.com/elastic/elasticsearch/issues/12567","id":98244038,"node_id":"MDU6SXNzdWU5ODI0NDAzOA==","number":12567,"title":"Delete snapshot not able to interrupt shard level operation due to Azure client call hanging","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2015-07-30T19:29:01Z","updated_at":"2018-02-14T13:48:01Z","closed_at":"2016-01-19T17:03:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"Have a scenario where a delete snapshot is not able to interrupt the shard level request. The snapshot state shows aborted, with 1 shard still in started status:\n\n```\n{\n  \"snapshots\" : [ {\n    \"snapshot\" : \"20150728t111647z\",\n    \"repository\" : \"snapshot\",\n    \"state\" : \"ABORTED\",\n    \"shards_stats\" : {\n      \"initializing\" : 0,\n      \"started\" : 1,\n      \"finalizing\" : 0,\n      \"done\" : 129,\n      \"failed\" : 0,\n      \"total\" : 130\n    },\n```\n\nShard in started status except that processed_size_in_bytes hasn't moved in >1 day.\n\n```\n        \"shards\" : {\n          \"0\" : {\n            \"stage\" : \"STARTED\",\n            \"stats\" : {\n              \"number_of_files\" : 110,\n              \"processed_files\" : 87,\n              \"total_size_in_bytes\" : 2486849879,\n              \"processed_size_in_bytes\" : 1493448551,\n              \"start_time_in_millis\" : 1438082207888,\n              \"time_in_millis\" : 0\n            },\n```\n\nThe hot threads is showing the snapshot thread stuck due to an Azure client call:\n\n```\n   0.0% (0s out of 500ms) cpu usage by thread 'elasticsearch[ESNode-ElasticSearchData_IN_2][snapshot][T#196]'\n     10/10 snapshots sharing following 25 elements\n       java.net.SocketInputStream.socketRead0(Native Method)\n       java.net.SocketInputStream.socketRead(SocketInputStream.java:116)\n       java.net.SocketInputStream.read(SocketInputStream.java:170)\n       java.net.SocketInputStream.read(SocketInputStream.java:141)\n       java.io.BufferedInputStream.fill(BufferedInputStream.java:246)\n       java.io.BufferedInputStream.read1(BufferedInputStream.java:286)\n       java.io.BufferedInputStream.read(BufferedInputStream.java:345)\n       sun.net.www.http.HttpClient.parseHTTPHeader(HttpClient.java:704)\n       sun.net.www.http.HttpClient.parseHTTP(HttpClient.java:647)\n       sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1535)\n       sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1440)\n       java.net.HttpURLConnection.getResponseCode(HttpURLConnection.java:480)\n       com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:124)\n       com.microsoft.azure.storage.blob.CloudBlockBlob.commitBlockList(CloudBlockBlob.java:244)\n       com.microsoft.azure.storage.blob.BlobOutputStream.commit(BlobOutputStream.java:321)\n       com.microsoft.azure.storage.blob.BlobOutputStream.close(BlobOutputStream.java:285)\n       org.elasticsearch.cloud.azure.blobstore.AzureOutputStream.close(AzureOutputStream.java:41)\n       org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$SnapshotContext.snapshotFile(BlobStoreIndexShardRepository.java:559)\n       org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$SnapshotContext.snapshot(BlobStoreIndexShardRepository.java:500)\n       org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.snapshot(BlobStoreIndexShardRepository.java:140)\n       org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.snapshot(IndexShardSnapshotAndRestoreService.java:85)\n       org.elasticsearch.snapshots.SnapshotsService$5.run(SnapshotsService.java:852)\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n       java.lang.Thread.run(Thread.java:745)\n```\n\nIs there a way to handle this situation better when the Azure call hangs so that the delete snapshot can successfully interrupt the outstanding (but stuck) shard request?\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}