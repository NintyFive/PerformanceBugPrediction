[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429488905","html_url":"https://github.com/elastic/elasticsearch/issues/34425#issuecomment-429488905","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34425","id":429488905,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTQ4ODkwNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-10-12T23:28:59Z","updated_at":"2018-10-12T23:28:59Z","author_association":"MEMBER","body":"Thanks very much for your interest in Elasticsearch.\r\n\r\nThis appears to be a user question, and we'd like to direct these kinds of things to the [forums](https://discuss.elastic.co). If you can stop by there, we'd appreciate it. This allows us to use GitHub for verified bug reports, feature requests, and pull requests.\r\n\r\nThere's an active community in the [forums](https://discuss.elastic.co) that should be able to help get an answer to your question. As such, I hope you don't mind that I close this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429490722","html_url":"https://github.com/elastic/elasticsearch/issues/34425#issuecomment-429490722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34425","id":429490722,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTQ5MDcyMg==","user":{"login":"benbenwilde","id":3302573,"node_id":"MDQ6VXNlcjMzMDI1NzM=","avatar_url":"https://avatars3.githubusercontent.com/u/3302573?v=4","gravatar_id":"","url":"https://api.github.com/users/benbenwilde","html_url":"https://github.com/benbenwilde","followers_url":"https://api.github.com/users/benbenwilde/followers","following_url":"https://api.github.com/users/benbenwilde/following{/other_user}","gists_url":"https://api.github.com/users/benbenwilde/gists{/gist_id}","starred_url":"https://api.github.com/users/benbenwilde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benbenwilde/subscriptions","organizations_url":"https://api.github.com/users/benbenwilde/orgs","repos_url":"https://api.github.com/users/benbenwilde/repos","events_url":"https://api.github.com/users/benbenwilde/events{/privacy}","received_events_url":"https://api.github.com/users/benbenwilde/received_events","type":"User","site_admin":false},"created_at":"2018-10-12T23:42:55Z","updated_at":"2018-10-12T23:43:16Z","author_association":"NONE","body":"@jasontedor yes I have done so [here](https://discuss.elastic.co/t/cant-get-top-level-inner-hits-with-search-results-in-6-x/151716), but to no avail. I've seen other similar questions go unanswered in the forums so I don't have much hope.\r\n\r\nYou must be very familiar with the codebase, can you **confirm that top-level inner_hits was removed**? It was indeed removed from the documentation and the .NET SDK (NEST) with no mention of alternatives. If it was really removed, are you aware of any alternative? \r\n\r\n**The key here is that I need to search and query a set of documents, and simultaneously return those documents' inner_hits via an independent query (in the same request).**\r\n\r\nIf there is no way to do this currently, I would like to **request it as a feature** in a coming release. Even if we have to workaround it for now, it would be incredibly valuable in the future.\r\n\r\nThank you for your time, it is very appreciated!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430786576","html_url":"https://github.com/elastic/elasticsearch/issues/34425#issuecomment-430786576","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34425","id":430786576,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDc4NjU3Ng==","user":{"login":"benbenwilde","id":3302573,"node_id":"MDQ6VXNlcjMzMDI1NzM=","avatar_url":"https://avatars3.githubusercontent.com/u/3302573?v=4","gravatar_id":"","url":"https://api.github.com/users/benbenwilde","html_url":"https://github.com/benbenwilde","followers_url":"https://api.github.com/users/benbenwilde/followers","following_url":"https://api.github.com/users/benbenwilde/following{/other_user}","gists_url":"https://api.github.com/users/benbenwilde/gists{/gist_id}","starred_url":"https://api.github.com/users/benbenwilde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benbenwilde/subscriptions","organizations_url":"https://api.github.com/users/benbenwilde/orgs","repos_url":"https://api.github.com/users/benbenwilde/repos","events_url":"https://api.github.com/users/benbenwilde/events{/privacy}","received_events_url":"https://api.github.com/users/benbenwilde/received_events","type":"User","site_admin":false},"created_at":"2018-10-17T20:55:44Z","updated_at":"2018-10-17T20:59:01Z","author_association":"NONE","body":"Okay, I was able to get this to work by messing with the query a little bit.\r\n\r\nBasically, since there is no top level inner hits anymore, and they now have to be attached to a has child section of the parent query, you have to add the child query to a has child query on the parent query. To do this without impacting the original parent query, all you have to do is add the query again in a logical OR NOT, i.e. `parent_query && (has_child_query || !has_child_query)`. Then just attach the inner hits clause to the first has child query.\r\n\r\n--- \r\n\r\n### Here is a full example\r\nElasticsearch 2.x request:\r\n`POST index1/parent/_search`\r\n```\r\n{\r\n    \"from\": 0,\r\n    \"size\": 100,\r\n    \"sort\": [\r\n        {\r\n            \"time\": {\r\n                \"order\": \"desc\"\r\n            }\r\n        }\r\n    ],\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"terms\": {\r\n                        \"thingIds\": [\r\n                            \"thing/345\"\r\n                        ]\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"inner_hits\": {\r\n        \"children\": {\r\n            \"type\": {\r\n                \"child\": {\r\n                    \"query\": {\r\n                        \"terms\": {\r\n                            \"userId\": [\r\n                                \"u/1234\"\r\n                            ]\r\n                        }\r\n                    },\r\n                    \"size\": 1000\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nElasticsearch 6.x request:\r\n(note that parent and child both have the same `_type` of \"_doc\" (to support ES 6.x indices with single mapping), and I'm using a custom `type` field to differentiate)\r\n`POST index1/_doc/_search`\r\n```\r\n{\r\n    \"from\": 0,\r\n    \"size\": 100,\r\n    \"sort\": [\r\n        {\r\n            \"time\": {\r\n                \"order\": \"desc\"\r\n            }\r\n        }\r\n    ],\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"bool\": {\r\n                        \"must\": [\r\n                            {\r\n                                \"term\": {\r\n                                    \"type\": {\r\n                                        \"value\": \"parent\"\r\n                                    }\r\n                                }\r\n                            },\r\n                            {\r\n                                \"terms\": {\r\n                                    \"groupIds\": [\r\n                                        \"groups/345\"\r\n                                    ]\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                },\r\n                {\r\n                    \"bool\": {\r\n                        \"should\": [\r\n                            {\r\n                                \"has_child\": {\r\n                                    \"type\": \"child\",\r\n                                    \"query\": {\r\n                                        \"terms\": {\r\n                                            \"userId\": [\r\n                                                \"u/1234\"\r\n                                            ]\r\n                                        }\r\n                                    },\r\n                                    \"inner_hits\": {\r\n                                        \"name\": \"children\"\r\n                                    }\r\n                                }\r\n                            },\r\n                            {\r\n                                \"bool\": {\r\n                                    \"must_not\": [\r\n                                        {\r\n                                            \"has_child\": {\r\n                                                \"type\": \"child\",\r\n                                                \"query\": {\r\n                                                    \"terms\": {\r\n                                                        \"userId\": [\r\n                                                            \"u/1234\"\r\n                                                        ]\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    ]\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}\r\n```","performed_via_github_app":null}]