{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40831","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40831/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40831/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40831/events","html_url":"https://github.com/elastic/elasticsearch/issues/40831","id":429087873,"node_id":"MDU6SXNzdWU0MjkwODc4NzM=","number":40831,"title":"ILM policy Rollover action fails in case alias points to more than one index","user":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"assignees":[{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-04-04T05:19:49Z","updated_at":"2019-04-17T02:19:54Z","closed_at":"2019-04-17T02:19:54Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.6.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRollover action via ILM fails with unauthorized access when the user does\r\nnot have access to concrete index but only to alias.\r\nThis only happens when `is_write_index` is true, that is after the rollover\r\nwe can have rolled over-index with the same alias.\r\n\r\nThe authorization check fails as `IndicesAndAliasesResolver#getPutMappingIndexOrAlias` filters\r\nout the alias name as it has multiple indices associated with it. For multiple indexes for the given alias, we should check if there is only one write index associated with it instead of simple size check.\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/c7379435439cc56c203329d085d4ad4cfd931ccb/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authz/IndicesAndAliasesResolver.java#L249-L253\r\n\r\n**Expected behavior:**\r\nThe rollover action should succeed resulting in successful policy run.\r\n\r\n**Actual behavior:**\r\nFails with \r\n```\r\naction [indices:admin/mapping/put] is unauthorized for user [test_user]\r\n```\r\n\r\n**Steps to reproduce**:\r\n- Create ILM policy\r\n```\r\nPUT /_ilm/policy/foo-policy\r\n         {\r\n            \"policy\" : {\r\n               \"phases\" : {\r\n                  \"hot\" : {\r\n                    \"min_age\": \"0ms\",\r\n                    \"actions\" : {\r\n                       \"rollover\" : {\r\n                          \"max_docs\" : 2\r\n                       }\r\n                    }\r\n                  }\r\n               }\r\n             }\r\n          }\r\n```\r\n\r\n- Put Index template\r\n```\r\nPUT /_template/foo-template\r\n         {\r\n            \"index_patterns\": [\"foo-logs-*\"],\r\n            \"settings\": {\r\n              \"number_of_shards\": 1,\r\n              \"number_of_replicas\": 0,\r\n              \"index.lifecycle.name\": \"foo-policy\",\r\n              \"index.lifecycle.rollover_alias\": \"foo_alias\"\r\n            }\r\n          }\r\n```\r\n- Create an index with alias\r\n```\r\nPUT /foo-logs-000001\r\n         {\r\n            \"aliases\": {\r\n              \"foo_alias\" : { \"is_write_index\": true }\r\n            }\r\n          }\r\n```\r\n\r\n- Create a user with a role\r\n```\r\nPUT /_xpack/security/user/ufoo '{ \"password\": \"foobar\", \"roles\" : [ \"foo_role\" ]  }'\r\n\r\nPUT /_xpack/security/role/foo_role '{ \"cluster\": [ \"all\" ], \"indices\": [ { \"names\": [\"foo_alias\"], \"privileges\": [\"write\", \"manage\"] } ] }'\r\n```\r\n\r\n- Index some documents such that ILM gets policy gets triggered using created user (`ufoo`)\r\n```\r\nPOST /foo_alias/_doc '{ \"field\" : \"foo\" }'\r\nPOST /foo_alias/_doc '{ \"field\" : \"foo\" }'\r\n```\r\n\r\n- Verify new index exists\r\n```\r\nGET /foo-logs-000002\r\n```\r\n\r\n- Try to index using alias\r\n```\r\nPOST /foo_alias/_doc '{ \"field\" : \"foo\" }'\r\n```\r\nFails with :\r\n```\r\naction [indices:admin/mapping/put] is unauthorized for user [ufoo]\r\n```\r\n\r\n","closed_by":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"performed_via_github_app":null}