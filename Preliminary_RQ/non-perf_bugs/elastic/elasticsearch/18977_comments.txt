[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/227167783","html_url":"https://github.com/elastic/elasticsearch/issues/18977#issuecomment-227167783","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977","id":227167783,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNzE2Nzc4Mw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-06-20T14:58:40Z","updated_at":"2016-06-20T14:58:40Z","author_association":"CONTRIBUTOR","body":"Can you show the result of the following request:\n\n```\n{\n  \"from\": page * 3, // page from 0 to no more documents \n  \"size\": 3,\n  \"fields\" : [\"_routing\"],\n  \"sort\": [\n    {\n      \"name.raw\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nI suspect that some documents have been put into different shards because they had different routing keys.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/227171760","html_url":"https://github.com/elastic/elasticsearch/issues/18977#issuecomment-227171760","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977","id":227171760,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNzE3MTc2MA==","user":{"login":"bqk-","id":2953722,"node_id":"MDQ6VXNlcjI5NTM3MjI=","avatar_url":"https://avatars1.githubusercontent.com/u/2953722?v=4","gravatar_id":"","url":"https://api.github.com/users/bqk-","html_url":"https://github.com/bqk-","followers_url":"https://api.github.com/users/bqk-/followers","following_url":"https://api.github.com/users/bqk-/following{/other_user}","gists_url":"https://api.github.com/users/bqk-/gists{/gist_id}","starred_url":"https://api.github.com/users/bqk-/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bqk-/subscriptions","organizations_url":"https://api.github.com/users/bqk-/orgs","repos_url":"https://api.github.com/users/bqk-/repos","events_url":"https://api.github.com/users/bqk-/events{/privacy}","received_events_url":"https://api.github.com/users/bqk-/received_events","type":"User","site_admin":false},"created_at":"2016-06-20T15:11:33Z","updated_at":"2016-06-20T15:11:33Z","author_association":"NONE","body":"```\n{  \n   \"took\":8,\n   \"timed_out\":false,\n   \"_shards\":{  \n      \"total\":1,\n      \"successful\":1,\n      \"failed\":0\n   },\n   \"hits\":{  \n      \"total\":1448,\n      \"max_score\":null,\n      \"hits\":[  \n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:632589\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"sort\":[  \n               \"cbis:632589\"\n            ]\n         },\n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:632594\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"sort\":[  \n               \"cbis:632594\"\n            ]\n         },\n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:632642\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"sort\":[  \n               \"cbis:632642\"\n            ]\n         }\n      ]\n   }\n}\n```\n\nAs mentioned, I am querying and indexing using a the routing key (ApiKey-v3). There is also `\"_routing\":{  \n            \"required\":true\n         },` in the mapping of the index.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/227175867","html_url":"https://github.com/elastic/elasticsearch/issues/18977#issuecomment-227175867","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977","id":227175867,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNzE3NTg2Nw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-06-20T15:25:29Z","updated_at":"2016-06-20T15:25:29Z","author_association":"CONTRIBUTOR","body":"The above response does not contain duplicates as all documents do NOT have the same (`_index`, `_type`, `_id`) tuple (which uniquely identify a document within a cluster)?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/227356653","html_url":"https://github.com/elastic/elasticsearch/issues/18977#issuecomment-227356653","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977","id":227356653,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNzM1NjY1Mw==","user":{"login":"bqk-","id":2953722,"node_id":"MDQ6VXNlcjI5NTM3MjI=","avatar_url":"https://avatars1.githubusercontent.com/u/2953722?v=4","gravatar_id":"","url":"https://api.github.com/users/bqk-","html_url":"https://github.com/bqk-","followers_url":"https://api.github.com/users/bqk-/followers","following_url":"https://api.github.com/users/bqk-/following{/other_user}","gists_url":"https://api.github.com/users/bqk-/gists{/gist_id}","starred_url":"https://api.github.com/users/bqk-/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bqk-/subscriptions","organizations_url":"https://api.github.com/users/bqk-/orgs","repos_url":"https://api.github.com/users/bqk-/repos","events_url":"https://api.github.com/users/bqk-/events{/privacy}","received_events_url":"https://api.github.com/users/bqk-/received_events","type":"User","site_admin":false},"created_at":"2016-06-21T07:00:08Z","updated_at":"2016-06-21T07:00:08Z","author_association":"NONE","body":"Query:\n\n```\n{\n  \"from\": 258,\n  \"size\": 3,\n  \"sort\": [\n    {\n      \"name.raw\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nResult:\n\n```\n{  \n   \"took\":66,\n   \"timed_out\":false,\n   \"_shards\":{  \n      \"total\":1,\n      \"successful\":1,\n      \"failed\":0\n   },\n   \"hits\":{  \n      \"total\":1207,\n      \"max_score\":null,\n      \"hits\":[  \n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:423457\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"_source\":{  \n               \"name\":\"Drängstugan\",\n               \"version\":3,\n               \"apiKey\":\"ApiKey\",\n               \"id\":\"ApiKey-v3-cbis:423457\",\n               \"entityId\":\"cbis:423457\",\n               \"updated\":\"2016-06-20T13:12:10.8807738+02:00\",\n               \"routingKey\":\"ApiKey-v3\"\n            },\n            \"sort\":[  \n               \"Drängstugan\"\n            ]\n         },\n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"**ApiKey-v3-cbis:1222242**\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"_source\":{  \n               \"name\":\"Drömstuga 2+2\",\n               \"version\":3,\n               \"apiKey\":\"ApiKey\",\n               \"id\":\"ApiKey-v3-cbis:1222242\",\n               \"entityId\":\"cbis:1222242\",\n               \"updated\":\"2016-06-20T13:12:32.2718554+02:00\",\n               \"routingKey\":\"ApiKey-v3\"\n            },\n            \"sort\":[  \n               \"Drömstuga 2+2\"\n            ]\n         },\n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:1222259\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"_source\":{  \n               \"name\":\"Drömstuga 2+2\",\n               \"version\":3,\n               \"apiKey\":\"ApiKey\",\n               \"id\":\"ApiKey-v3-cbis:1222259\",\n               \"entityId\":\"cbis:1222259\",\n               \"updated\":\"2016-06-20T13:12:32.8031266+02:00\",\n               \"routingKey\":\"ApiKey-v3\"\n            },\n            \"sort\":[  \n               \"Drömstuga 2+2\"\n            ]\n         }\n      ]\n   }\n}\n```\n\nQuery:\n\n```\n{\n  \"from\": 261,\n  \"size\": 3,\n  \"sort\": [\n    {\n      \"name.raw\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nResult:\n\n```\n{  \n   \"took\":15,\n   \"timed_out\":false,\n   \"_shards\":{  \n      \"total\":1,\n      \"successful\":1,\n      \"failed\":0\n   },\n   \"hits\":{  \n      \"total\":1207,\n      \"max_score\":null,\n      \"hits\":[  \n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:1222261\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"_source\":{  \n               \"name\":\"Drömstuga 2+2\",\n               \"version\":3,\n               \"apiKey\":\"ApiKey\",\n               \"id\":\"ApiKey-v3-cbis:1222261\",\n               \"entityId\":\"cbis:1222261\",\n               \"updated\":\"2016-06-20T13:12:32.8031266+02:00\",\n               \"routingKey\":\"ApiKey-v3\"\n            },\n            \"sort\":[  \n               \"Drömstuga 2+2\"\n            ]\n         },\n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"**ApiKey-v3-cbis:1222242**\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"_source\":{  \n               \"name\":\"Drömstuga 2+2\",\n               \"version\":3,\n               \"apiKey\":\"ApiKey\",\n               \"id\":\"ApiKey-v3-cbis:1222242\",\n               \"entityId\":\"cbis:1222242\",\n               \"updated\":\"2016-06-20T13:12:32.2718554+02:00\",\n               \"routingKey\":\"ApiKey-v3\"\n            },\n            \"sort\":[  \n               \"Drömstuga 2+2\"\n            ]\n         },\n         {  \n            \"_index\":\"product-sv-se\",\n            \"_type\":\"product\",\n            \"_id\":\"ApiKey-v3-cbis:1222262\",\n            \"_score\":null,\n            \"_routing\":\"ApiKey-v3\",\n            \"_source\":{  \n               \"name\":\"Drömstuga 4+2\",\n               \"version\":3,\n               \"apiKey\":\"ApiKey\",\n               \"id\":\"ApiKey-v3-cbis:1222262\",\n               \"entityId\":\"cbis:1222262\",\n               \"updated\":\"2016-06-20T13:12:32.8031266+02:00\",\n               \"routingKey\":\"ApiKey-v3\"\n            },\n            \"sort\":[  \n               \"Drömstuga 4+2\"\n            ]\n         }\n      ]\n   }\n}\n```\n\nOne thing I noticed is that the duplicates are always on subsequent pages.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/227364047","html_url":"https://github.com/elastic/elasticsearch/issues/18977#issuecomment-227364047","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18977","id":227364047,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNzM2NDA0Nw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-06-21T07:40:13Z","updated_at":"2016-06-21T07:40:13Z","author_association":"CONTRIBUTOR","body":"Ah ok, this is a known issue. When sorting, elasticsearch uses the Lucene doc id as a tie-break. However, these doc ids can be different across shards. What is happening in your case is that `**ApiKey-v3-cbis:1222242**` should be on page 86 according to one shard and on page 87 according to another shard (due to the fact that you have several documents that have `Drömstuga 2+2` as a value for `name.raw`).\n\nYou can work-around the issue either by giving elasticsearch another field to use as a tie breaker, eg.\n\n```\n\"sort\": [\n    {\n      \"name.raw\": {\n        \"order\": \"asc\"\n      }\n    },\n    {\n      \"updated\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n```\n\nor by creating a random [preference](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-preference.html) on the first page, and then making sure to always reuse it for all pages so that all pages will be requested on the same shard.\n","performed_via_github_app":null}]