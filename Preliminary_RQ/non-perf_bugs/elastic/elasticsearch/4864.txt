{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4864","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4864/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4864/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4864/events","html_url":"https://github.com/elastic/elasticsearch/issues/4864","id":26166562,"node_id":"MDU6SXNzdWUyNjE2NjU2Mg==","number":4864,"title":"Rivers might not get started due to missing _meta document","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":74293669,"node_id":"MDU6TGFiZWw3NDI5MzY2OQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.11","name":"v0.90.11","color":"DDDDDD","default":false,"description":null},{"id":76575635,"node_id":"MDU6TGFiZWw3NjU3NTYzNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.RC2","name":"v1.0.0.RC2","color":"DDDDDD","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2014-01-23T13:38:15Z","updated_at":"2014-07-28T09:39:39Z","closed_at":"2014-01-23T14:05:13Z","author_association":"MEMBER","active_lock_reason":null,"body":"When a new river is registered by indexing its `_meta` document, its type gets created via dynamic mappings, which triggers a cluster state update task on the master node. The update triggers a cluster state listener (`RiversRouter`) that executes only on the master. The master node looks for the river `_meta` document (get with `preference=_primary`) and schedules a retry in case it is not found (since #4089).\n\nOnce the master node has found the `_meta` document it decides where to allocate the river and  publishes the new river cluster state containing that information. At that point each node receives the new river cluster state and the node where the river is supposed to be allocated on will start the river locally (`RiversService.ApplyRivers`).\n\nIn order for the river to be properly allocated, the `_meta` document has to be found through get api. There is a retry mechanism in case the get fails, but not in case the `_meta` document is not found, which can currently happen as this second get doesn't set `preference` to `_primary`, thus the `_meta` document could be found by the master node on the primary shard, but not on the second get call done by the node that is trying to start the river locally. This happens when the document replication hasn't been completed yet.\n\nLong story short: no retry needed, we just need to add `preference=_primary` to the second get call.\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}