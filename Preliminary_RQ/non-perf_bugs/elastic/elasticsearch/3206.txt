{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3206","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3206/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3206/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3206/events","html_url":"https://github.com/elastic/elasticsearch/issues/3206","id":15743006,"node_id":"MDU6SXNzdWUxNTc0MzAwNg==","number":3206,"title":"Thread pools incorrectly rejecting requests","user":{"login":"peterbourgon","id":114509,"node_id":"MDQ6VXNlcjExNDUwOQ==","avatar_url":"https://avatars2.githubusercontent.com/u/114509?v=4","gravatar_id":"","url":"https://api.github.com/users/peterbourgon","html_url":"https://github.com/peterbourgon","followers_url":"https://api.github.com/users/peterbourgon/followers","following_url":"https://api.github.com/users/peterbourgon/following{/other_user}","gists_url":"https://api.github.com/users/peterbourgon/gists{/gist_id}","starred_url":"https://api.github.com/users/peterbourgon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peterbourgon/subscriptions","organizations_url":"https://api.github.com/users/peterbourgon/orgs","repos_url":"https://api.github.com/users/peterbourgon/repos","events_url":"https://api.github.com/users/peterbourgon/events{/privacy}","received_events_url":"https://api.github.com/users/peterbourgon/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2013-06-19T12:59:40Z","updated_at":"2014-08-08T12:53:02Z","closed_at":"2014-08-08T12:32:45Z","author_association":"NONE","active_lock_reason":null,"body":"I have two problems that appear to be caused by thread pools incorrectly rejecting threads.\n\nFor context, my [cluster settings](https://gist.github.com/peterbourgon/c01be2b7f7ff7b3e8766) and [node stats](https://gist.github.com/peterbourgon/242c579b17ebd2a0a589). Important bit is that all of my {bulk,index,search} threadpools are type: fixed and queue_size: -1. My understanding from the [guide](http://www.elasticsearch.org/guide/reference/modules/threadpool/) is that -1 means unbounded. \n\n(Side note: the documentation is apparently wrong here, unbounded is _not_ the default behavior, when I had queue_size unset, node stats reported capacity: 1k)\n1. First symptom is during shard balancing. Shards sometimes get into a state where they are continuously \"initializing\" or \"relocating\", and cluster therefore remaining stuck in \"yellow\" stage for hours/indefinitely. Checking the logs, I see \"Failed to perform [bulk/shard] on replica\" due to EsRejectedExecutionException ([gist here](https://gist.github.com/peterbourgon/6da550f8458a1e03708f)). So I assume bulk or index requests are getting rejected at the threadpool stage. But how can it be, if both have unbounded queues?\n2. Second symptom is more general. My search threadpool reports steadily rising number of rejected requests. Compare [this node stats thread_pool.search.rejected count](https://gist.github.com/peterbourgon/242c579b17ebd2a0a589#file-gistfile1-txt-L78) with [the same output a few minutes later](https://gist.github.com/peterbourgon/1a18d63444c52aaad1a1#file-gistfile1-txt-L78). Checking my application logs, I count a lot of 50X's coming back from ES: 74% of all 50X's are EsRejectedExecutionExceptions, and a further 22% are ReduceSearchPhaseException due to EsRejectedExecutionException ([gist here](https://gist.github.com/peterbourgon/e25e328459f90247ea85)). So, seems like same error(s) as above, except against search threadpool.\n\n**tl;dr**: are EsRejectedExecutionExceptions always from thread pool queue rejection? If so, why are unbounded thread pools rejecting requests (should never happen AFAIK)? If not, what else could be causing my symptoms?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}