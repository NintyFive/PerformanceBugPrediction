[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/470598528","html_url":"https://github.com/elastic/elasticsearch/issues/39798#issuecomment-470598528","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39798","id":470598528,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MDU5ODUyOA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-03-07T16:36:58Z","updated_at":"2019-03-07T16:36:58Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/470706346","html_url":"https://github.com/elastic/elasticsearch/issues/39798#issuecomment-470706346","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39798","id":470706346,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MDcwNjM0Ng==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-03-07T21:42:41Z","updated_at":"2019-03-07T21:42:41Z","author_association":"MEMBER","body":"I just discovered an additional related complication that kicks in if we have more data than fits on a single page. If we have a folded ConstantProcessor that needs to be serialized, it [will try to serialize](https://github.com/elastic/elasticsearch/blob/15515a616ebb8dc9d1fa100baab2641b09b92776/x-pack/plugin/sql/src/main/java/org/elasticsearch/xpack/sql/expression/gen/processor/ConstantProcessor.java#L29) the wrapped constant as a genericValue. That works only for some types. To reproduce:\r\n```\r\nDELETE test\r\nPUT test\r\n{\r\n  \"mappings\": {\r\n      \"properties\": {\r\n        \"timestamp\": {\r\n          \"type\": \"date\"\r\n        }\r\n      }\r\n  }\r\n}\r\n\r\nPUT test/_doc/1\r\n{\r\n  \"timestamp\": \"2019-03-05T21:23:19.000Z\"\r\n}\r\n\r\nPUT test/_doc/2\r\n{\r\n  \"timestamp\": \"2019-03-05T21:23:19.000Z\"\r\n}\r\n\r\nPUT test/_doc/3\r\n{\r\n  \"timestamp\": \"2019-03-05T21:23:19.000Z\"\r\n}\r\n\r\nPUT test/_doc/4\r\n{\r\n  \"timestamp\": \"2019-03-05T21:23:19.000Z\"\r\n}\r\n\r\nPOST _sql\r\n{\r\n  \"query\": \"SELECT timestamp + INTERVAL '1' DAY AS a  FROM test\",\r\n  \"fetch_size\": 2\r\n}\r\n```\r\nThis will generate the error:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"sql_illegal_argument_exception\",\r\n        \"reason\": \"Unexpected failure retriving next page\"\r\n      }\r\n    ],\r\n    \"type\": \"sql_illegal_argument_exception\",\r\n    \"reason\": \"Unexpected failure retriving next page\",\r\n    \"caused_by\": {\r\n      \"type\": \"i_o_exception\",\r\n      \"reason\": \"can not write type [class org.elasticsearch.xpack.sql.expression.literal.IntervalDayTime]\"\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n```\r\n[elasticsearch] Caused by: java.io.IOException: can not write type [class org.elasticsearch.xpack.sql.expression.literal.IntervalDayTime]\r\n[elasticsearch]         at org.elasticsearch.common.io.stream.StreamOutput.writeGenericValue(StreamOutput.java:758) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.xpack.sql.expression.gen.processor.ConstantProcessor.writeTo(ConstantProcessor.java:29) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteable(StreamOutput.java:994) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.xpack.sql.expression.gen.processor.BinaryProcessor.writeTo(BinaryProcessor.java:30) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteable(StreamOutput.java:994) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.xpack.sql.execution.search.extractor.ComputingExtractor.writeTo(ComputingExtractor.java:54) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteable(StreamOutput.java:994) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteableList(StreamOutput.java:1113) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.xpack.sql.execution.search.ScrollCursor.writeTo(ScrollCursor.java:61) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteable(StreamOutput.java:994) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.xpack.sql.session.Cursors.encodeToString(Cursors.java:75) ~[?:?]\r\n[elasticsearch]         ... 31 more\r\n```\r\n\r\nPlease note that the error message `Unexpected failure retriving next page` is misleading since we are not retrieving the next page yet here, we are just preparing the cursor to retrieve this page later on.  \r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471164359","html_url":"https://github.com/elastic/elasticsearch/issues/39798#issuecomment-471164359","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39798","id":471164359,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTE2NDM1OQ==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2019-03-09T10:14:40Z","updated_at":"2019-03-09T10:14:40Z","author_association":"MEMBER","body":"This issue actually bumped into two bugs, both related to some degree to serialization:\r\n1. ConstantProcessor handling of complex objects - see #39875\r\n2. serialization `ZoneDateTime` to a human/json-friendly format - incoming PR.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471553900","html_url":"https://github.com/elastic/elasticsearch/issues/39798#issuecomment-471553900","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39798","id":471553900,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTU1MzkwMA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-03-11T14:10:58Z","updated_at":"2019-03-11T14:10:58Z","author_association":"MEMBER","body":"> serialization ZoneDateTime to a human/json-friendly format - incoming PR\r\n\r\nI think serialization actually works, it's deserialization on the painless side is where we fail. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471575992","html_url":"https://github.com/elastic/elasticsearch/issues/39798#issuecomment-471575992","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39798","id":471575992,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTU3NTk5Mg==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2019-03-11T15:02:22Z","updated_at":"2019-03-11T15:02:22Z","author_association":"MEMBER","body":"Forgot to update the second PR: https://github.com/elastic/elasticsearch/pull/39911","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471740564","html_url":"https://github.com/elastic/elasticsearch/issues/39798#issuecomment-471740564","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39798","id":471740564,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTc0MDU2NA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-03-11T21:38:41Z","updated_at":"2019-03-11T21:38:41Z","author_association":"MEMBER","body":"This approach works for geosql as well. Closing.","performed_via_github_app":null}]