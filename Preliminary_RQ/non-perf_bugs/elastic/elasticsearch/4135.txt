{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4135","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4135/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4135/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4135/events","html_url":"https://github.com/elastic/elasticsearch/issues/4135","id":22361155,"node_id":"MDU6SXNzdWUyMjM2MTE1NQ==","number":4135,"title":"NPE for has_child query if number of results exceed certain limit","user":{"login":"ajhalani","id":1163503,"node_id":"MDQ6VXNlcjExNjM1MDM=","avatar_url":"https://avatars3.githubusercontent.com/u/1163503?v=4","gravatar_id":"","url":"https://api.github.com/users/ajhalani","html_url":"https://github.com/ajhalani","followers_url":"https://api.github.com/users/ajhalani/followers","following_url":"https://api.github.com/users/ajhalani/following{/other_user}","gists_url":"https://api.github.com/users/ajhalani/gists{/gist_id}","starred_url":"https://api.github.com/users/ajhalani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajhalani/subscriptions","organizations_url":"https://api.github.com/users/ajhalani/orgs","repos_url":"https://api.github.com/users/ajhalani/repos","events_url":"https://api.github.com/users/ajhalani/events{/privacy}","received_events_url":"https://api.github.com/users/ajhalani/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":64134382,"node_id":"MDU6TGFiZWw2NDEzNDM4Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.7","name":"v0.90.7","color":"dddddd","default":false,"description":null},{"id":64607794,"node_id":"MDU6TGFiZWw2NDYwNzc5NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta2","name":"v1.0.0.Beta2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2013-11-08T20:15:00Z","updated_at":"2013-11-11T13:42:29Z","closed_at":"2013-11-11T13:42:29Z","author_association":"NONE","active_lock_reason":null,"body":"If the number of results exceed a certain limit, has_child query throws a NullPointerException.  \n\n```\ncurl -x '' -s -XPOST \"http://localhost:9200/myindex/vendor/_search?from=0&size=20&pretty=true&routing=0\" -d '{\n   \"query\" : {\n      \"has_child\" : {\n         \"query\" : {\n            \"query_string\" : { \"query\" : \"signed_date:[now-120d TO now-90d]\" }\n         },\n         \"type\" : \"transaction\"\n      }\n   }\n}\n'\n\n[2013-11-08 15:01:41,825][DEBUG][action.search.type       ] [Phage] [myindex_20131108][1], node[fuBzjMWDQgmr_qm0cVLIog], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@23b13dc6]\norg.elasticsearch.transport.RemoteTransportException: [Ch'od][inet[/192.168.175.128:9301]][search/phase/query+fetch]\nCaused by: org.elasticsearch.search.query.QueryPhaseExecutionException: [myindex_20131108][1]: query[filtered(child_filter[transaction/vendor](filtered(signed_date:[1373572895448 TO 1376164895448])->cache(_type:transaction)))->cache(_type:vendor)],from[0],size[20]: Query Failed [Failed to execute main query]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:123)\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:306)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:686)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:1)\n        at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.run(MessageChannelHandler.java:270)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:744)\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.common.lucene.search.ApplyAcceptedDocsFilter.getDocIdSet(ApplyAcceptedDocsFilter.java:45)\n        at org.elasticsearch.index.search.child.ChildrenConstantScoreQuery$ParentWeight.scorer(ChildrenConstantScoreQuery.java:178)\n        at org.apache.lucene.search.FilteredQuery$RandomAccessFilterStrategy.filteredScorer(FilteredQuery.java:533)\n        at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:133)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:624)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:167)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:491)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:448)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:281)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:269)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:119)\n        ... 7 more\n[2013-11-08 15:01:41,827][DEBUG][action.search.type       ] [Phage] All shards failed for phase: [query_fetch]\n```\n\nI debugged the code and found the issue happens due to class ChildrenConstantScoreQuery.java, line #115 is passing null shortCircuitFilter. This happens when remaining value > 8192 so it's not initialized \n\n```\n        Filter shortCircuitFilter = null;\n        if (remaining == 1) {\n            BytesRef id = collectedUids.v().iterator().next().value.toBytesRef();\n            shortCircuitFilter = new TermFilter(new Term(UidFieldMapper.NAME, Uid.createUidAsBytes(parentType, id)));\n        } else if (remaining <= shortCircuitParentDocSet) {\n            shortCircuitFilter = new ParentIdsFilter(parentType, collectedUids.v().keys, collectedUids.v().allocated);\n        }\n\n        ParentWeight parentWeight = new ParentWeight(parentFilter, shortCircuitFilter, searchContext, collectedUids);\n```\n\nThis is bug introduced after 0.90.1 as the query was running fine in past. Thanks!\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}