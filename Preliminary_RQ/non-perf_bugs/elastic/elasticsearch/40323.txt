{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40323","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40323/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40323/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40323/events","html_url":"https://github.com/elastic/elasticsearch/issues/40323","id":423828789,"node_id":"MDU6SXNzdWU0MjM4Mjg3ODk=","number":40323,"title":"Feeding non-numeric data into a `long` field may consume excessive CPU","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":914911779,"node_id":"MDU6TGFiZWw5MTQ5MTE3Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.3.1","name":"v6.3.1","color":"DDDDDD","default":false,"description":""},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""},{"id":1232175174,"node_id":"MDU6TGFiZWwxMjMyMTc1MTc0","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.6.2","name":"v6.6.2","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"assignees":[{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-03-21T16:37:26Z","updated_at":"2019-03-28T12:13:25Z","closed_at":"2019-03-28T12:13:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I've seen a couple of cases where all the `write` threads are heroically trying to parse some very large numbers on the way into a `long` field, consuming far too much CPU in the process. The hot threads output reported many threads stuck doing `BigInteger` shenanigans such as this:\r\n\r\n```\r\n       java.math.BigInteger.square(BigInteger.java:1899)\r\n       java.math.BigInteger.squareToomCook3(BigInteger.java:2053)\r\n       java.math.BigInteger.square(BigInteger.java:1899)\r\n       java.math.BigInteger.squareToomCook3(BigInteger.java:2051)\r\n       java.math.BigInteger.square(BigInteger.java:1899)\r\n       java.math.BigInteger.squareToomCook3(BigInteger.java:2051)\r\n       java.math.BigInteger.square(BigInteger.java:1899)\r\n       java.math.BigInteger.squareToomCook3(BigInteger.java:2053)\r\n       java.math.BigInteger.square(BigInteger.java:1899)\r\n       java.math.BigInteger.pow(BigInteger.java:2306)\r\n       java.math.BigDecimal.bigTenToThe(BigDecimal.java:3543)\r\n       java.math.BigDecimal.bigMultiplyPowerTen(BigDecimal.java:3676)\r\n       java.math.BigDecimal.setScale(BigDecimal.java:2445)\r\n       java.math.BigDecimal.toBigInteger(BigDecimal.java:3025)\r\n       org.elasticsearch.common.xcontent.support.AbstractXContentParser.toLong(AbstractXContentParser.java:195)\r\n       org.elasticsearch.common.xcontent.support.AbstractXContentParser.longValue(AbstractXContentParser.java:220)\r\n       org.elasticsearch.index.mapper.NumberFieldMapper$NumberType$7.parse(NumberFieldMapper.java:679)\r\n       org.elasticsearch.index.mapper.NumberFieldMapper$NumberType$7.parse(NumberFieldMapper.java:655)\r\n       org.elasticsearch.index.mapper.NumberFieldMapper.parseCreateField(NumberFieldMapper.java:996)\r\n       org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:297)\r\n```\r\n\r\nOne example was at https://discuss.elastic.co/t/high-cpu-usage-in-elasticsearch-nodes/161504 and another was with a customer.\r\n\r\nWe fall back to `BigInteger` if a naive conversion to `long` fails, for instance if using scientific notation, but then reject the result if it doesn't fit into a `long`:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/92b2e1a2091ce30d6267029b7b7b19d4b6690d64/libs/x-content/src/main/java/org/elasticsearch/common/xcontent/support/AbstractXContentParser.java#L157-L180\r\n\r\nThis means that if you try and insert a short string such as `\"1e99999999\"` into a long field then we spend a lot of resources converting this into a very large `BigInteger` before deciding it's too big. I think we should not try so hard to parse values like `\"1e99999999\"` as a `long`.","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}