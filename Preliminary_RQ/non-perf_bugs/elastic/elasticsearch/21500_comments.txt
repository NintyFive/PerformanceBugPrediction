[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260054511","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260054511","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260054511,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDA1NDUxMQ==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-11T21:01:00Z","updated_at":"2016-11-11T21:01:00Z","author_association":"CONTRIBUTOR","body":"I think this is a Lucene bug; there is a missing null check in `CompletionFieldsConsumer.java` ... I'll open an issue.\n\nIt can happen if a given field (that you are building suggestions on) was never indexed into a particular segment.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260061265","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260061265","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260061265,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDA2MTI2NQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2016-11-11T21:37:10Z","updated_at":"2016-11-11T21:37:10Z","author_association":"CONTRIBUTOR","body":"> It can happen if a given field (that you are building suggestions on) was never indexed into a particular segment.\n\nDo you think there is a way to work around this temporarily?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260063188","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260063188","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260063188,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDA2MzE4OA==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-11T21:47:38Z","updated_at":"2016-11-11T21:47:38Z","author_association":"CONTRIBUTOR","body":"> It can happen if a given field (that you are building suggestions on) was never indexed into a particular segment.\n\nHmm I'm trying, but failing, so far, to make a Lucene test that reproduces this.  @olivere can you describe how you are using the ES completion suggester?  Is it enabled for more than one field?  Do some documents have those fields but others do not?  Do you have deleted documents, and is it possible e.g. that you deleted many documents that had the suggestion fields, leaving only documents that do not?\n\n> Do you think there is a way to work around this temporarily?\n\nAlas, I'm not sure yet.  If my guesses so far are right, it happens because all documents in one segment are missing the field, so one workaround might be to ensure all documents include the field.\n\nSorry, I hope to know more once I can reproduce it in Lucene...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260066162","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260066162","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260066162,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDA2NjE2Mg==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2016-11-11T22:03:44Z","updated_at":"2016-11-11T22:03:44Z","author_association":"CONTRIBUTOR","body":"Hmm... to be honest: I have completion suggesters in my mapping, but not in the documents I was bulk indexing. The bulk indexing process should have been the only process that was running at the time of the exception. The bulk indexer is shuffling data over from one type to another in the same index: No deletions, no updates, just bulk index requests. Is it possible that it's caused by something that ES does in the background?\n\nUnfortunately I don't have access to the mapping right now. But I can send it to you tomorrow if that helps. There's multiple completion suggesters for about 3 different types. We're in the process of updating an ES 1.x mapping to ES 5.x, so I'm not even sure if something's wrong on our side (I'm personally not a pro with suggesters tbh).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260110756","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260110756","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260110756,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDExMDc1Ng==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2016-11-12T09:04:33Z","updated_at":"2016-11-12T09:04:33Z","author_association":"CONTRIBUTOR","body":"Okay. As promised here's some details about the mapping.\n\nThe index has 7 types, 4 of them with one or more fields that use completion suggest. The mapping for those completion fields is defined as e.g.:\n\n```\n...\n    \"catalog\" : {\n      \"properties\" : {\n        \"catalogNameSuggest\" : {\n          \"type\" : \"completion\",\n          \"analyzer\" : \"suggest\",\n          \"preserve_separators\" : false,\n          \"preserve_position_increments\" : true,\n          \"max_input_length\" : 50\n        },\n        \"catalogPINSuggest\" : {\n          \"type\" : \"completion\",\n          \"analyzer\" : \"suggest\",\n          \"preserve_separators\" : false,\n          \"preserve_position_increments\" : true,\n          \"max_input_length\" : 50\n        },\n        \"catalogSlugSuggest\" : {\n          \"type\" : \"completion\",\n          \"analyzer\" : \"suggest\",\n          \"preserve_separators\" : false,\n          \"preserve_position_increments\" : true,\n          \"max_input_length\" : 50\n        },\n...\n```\n\n... with the `suggest` analyzer defined as ...\n\n```\n          \"suggest\" : {\n            \"type\" : \"custom\",\n            \"tokenizer\" : \"keyword\",\n            \"filter\" : [\n              \"lowercase\",\n              \"asciifolding\"\n            ]\n          },\n```\n\nAt the time the exception occured I was scrolling through documents of type `product` (no `suggest` fields), modifying and bulk indexing them into type `live` (again, no `suggest` fields). Lots of documents were removed from type `live` about 30s before the exception.\n\nAfter the restart, there was one error message in the log. Hopefully that is a potential candidate that caused the issue. It was an update to a doc of type `catalog` which has completion suggest fields--see above):\n\n```\n[2016-11-11T16:47:39,148][INFO ][o.e.n.Node               ] [99cr2z0] started\n[2016-11-11T16:47:39,529][INFO ][o.e.g.GatewayService     ] [99cr2z0] recovered [8] indices into cluster_state\n[2016-11-11T16:48:39,893][WARN ][r.suppressed             ] path: /store2-v5/catalog/14, params: {index=store2-v5, id=14, type=catalog}\norg.elasticsearch.action.UnavailableShardsException: [store2-v5][0] primary shard is not active Timeout: [1m], request: [index {[store2-v5][catalog][14], source[{\"catalogId\":14,\"type\":\"corporate\",\"merchantId\":9,\"projectId\":1,\"projectMPCC\":\"meplato\",\"slug\":\"haus-baumarkt-kueche-fuer-mps\",\"catalogSlugSuggest\":{\"input\":\"haus-baumarkt-kueche-fuer-mps\"},\"name\":\"Haus, Baumarkt, K端che\",\"catalogNameSuggest\":{\"input\":\"Haus, Baumarkt, K端che\"},\"pin\":\"3007ECA973\",\"catalogPINSuggest\":{\"input\":[\"3007ECA973\",\"Haus, Baumarkt, K端che\"]},\"validFrom\":\"2016-03-13\",\"validUntil\":\"2016-12-31\",\"lastImported\":\"2016-03-13T07:55:51Z\",\"lastPublished\":\"2016-11-11T15:46:46.420019897Z\",\"publishedVersion\":9,\"country\":\"DE\",\"language\":\"de\",\"currency\":\"EUR\",\"eclassesLevel1\":[\"21\",\"22\",\"23\",\"24\",\"29\",\"41\"],\"eclassesLevel2\":[\"2104\",\"2254\",\"2311\",\"2315\",\"2431\",\"2909\",\"4101\",\"4102\",\"4108\"],\"unspscsLevel1\":[],\"unspscsLevel2\":[],\"created\":\"2016-03-13T07:53:59Z\",\"updated\":\"2016-11-11T15:46:46.420313882Z\",\"lockedForDownload\":false,\"sageNumber\":\"\",\"sageContract\":\"\",\"supportsOciDetail\":false,\"supportsOciDetailadd\":false,\"supportsOciValidate\":false,\"supportsOciSourcing\":false,\"supportsOciBackgroundsearch\":false,\"supportsOciQuantitycheck\":false,\"supportsOciDownloadjson\":false,\"keepOriginalBlobs\":false}]}]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.retryBecauseUnavailable(TransportReplicationAction.java:811) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.retryIfUnavailable(TransportReplicationAction.java:651) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.doRun(TransportReplicationAction.java:604) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase$2.onTimeout(TransportReplicationAction.java:765) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onTimeout(ClusterStateObserver.java:350) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.onTimeout(ClusterStateObserver.java:240) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.cluster.service.ClusterService$NotifyTimeout.run(ClusterService.java:936) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:444) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-11T16:48:40,265][INFO ][o.e.c.r.a.AllocationService] [99cr2z0] Cluster health status changed from [RED] to [GREEN] (reason: [shards started [[store2-v5][0]] ...]).\n```\n\nI also looked into the log before the exception. There were only a few GC-related messages:\n\n```\n[2016-11-11T16:39:32,592][INFO ][o.e.m.j.JvmGcMonitorService] [99cr2z0] [gc][214306] overhead, spent [401ms] collecting in the last [1s]\n[2016-11-11T16:39:41,789][INFO ][o.e.m.j.JvmGcMonitorService] [99cr2z0] [gc][214315] overhead, spent [434ms] collecting in the last [1.1s]\n```\n\nLet me know if I can help somehow.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260114795","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260114795","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260114795,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDExNDc5NQ==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-12T10:44:02Z","updated_at":"2016-11-12T10:44:02Z","author_association":"CONTRIBUTOR","body":"Thank you for all the details @olivere ... it could be because there are 7 types, differing in which fields completion suggester is enabled for, that this leads to the issue where segments are missing some fields.\n\nI'm not sure you hit that `UnavailableShardsException`; it may or may not be related to this NPE.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260344254","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260344254","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260344254,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDM0NDI1NA==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2016-11-14T14:11:36Z","updated_at":"2016-11-14T14:11:36Z","author_association":"CONTRIBUTOR","body":"@mikemccand Just FYI: I'm now in the situation where I can restart ES and will always hit the wall with the NPE. Don't know if that's an expected result.\n\nHere's the log after restarting:\n\n```\n[2016-11-14T15:05:23,713][INFO ][o.e.n.Node               ] [] initializing ...\n[2016-11-14T15:05:23,843][INFO ][o.e.e.NodeEnvironment    ] [99cr2z0] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable_space [164.2gb], net total_space [930.7gb], spins? [unknown], types [hfs]\n[2016-11-14T15:05:23,843][INFO ][o.e.e.NodeEnvironment    ] [99cr2z0] heap size [3.9gb], compressed ordinary object pointers [true]\n[2016-11-14T15:05:23,862][INFO ][o.e.n.Node               ] [99cr2z0] node name [99cr2z0] derived from node ID; set [node.name] to override\n[2016-11-14T15:05:23,865][INFO ][o.e.n.Node               ] [99cr2z0] version[5.0.0], pid[19274], build[253032b/2016-10-26T04:37:51.531Z], OS[Mac OS X/10.12.1/x86_64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_102/25.102-b14]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [aggs-matrix-stats]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [ingest-common]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [lang-expression]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [lang-groovy]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [lang-mustache]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [lang-painless]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [percolator]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [reindex]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [transport-netty3]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] loaded module [transport-netty4]\n[2016-11-14T15:05:24,628][INFO ][o.e.p.PluginsService     ] [99cr2z0] no plugins loaded\n[2016-11-14T15:05:26,434][INFO ][o.e.n.Node               ] [99cr2z0] initialized\n[2016-11-14T15:05:26,434][INFO ][o.e.n.Node               ] [99cr2z0] starting ...\n[2016-11-14T15:05:26,631][INFO ][o.e.t.TransportService   ] [99cr2z0] publish_address {127.0.0.1:9300}, bound_addresses {[fe80::1]:9300}, {[::1]:9300}, {127.0.0.1:9300}\n[2016-11-14T15:05:29,682][INFO ][o.e.c.s.ClusterService   ] [99cr2z0] new_master {99cr2z0}{99cr2z0mRj6mvJ5Vvufpwg}{IeZqdK5xQESmw9sC19coeA}{127.0.0.1}{127.0.0.1:9300}, reason: zen-disco-elected-as-master ([0] nodes joined)\n[2016-11-14T15:05:29,703][INFO ][o.e.h.HttpServer         ] [99cr2z0] publish_address {127.0.0.1:9200}, bound_addresses {[fe80::1]:9200}, {[::1]:9200}, {127.0.0.1:9200}\n[2016-11-14T15:05:29,703][INFO ][o.e.n.Node               ] [99cr2z0] started\n[2016-11-14T15:05:30,089][INFO ][o.e.g.GatewayService     ] [99cr2z0] recovered [8] indices into cluster_state\n```\n\nEverything's fine until I do index data by moving from one type to another.\n\nFirst this happens:\n\n```\n[2016-11-14T15:05:57,820][INFO ][o.e.c.r.a.AllocationService] [99cr2z0] Cluster health status changed from [RED] to [GREEN] (reason: [shards started [[store2-v5][0]] ...]).\n[2016-11-14T15:05:58,793][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [7] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [7]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,793][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [4] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [4]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,793][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [8] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [8]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,794][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [9] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [9]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,793][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [3] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [3]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,795][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [10] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [10]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,793][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [5] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [5]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n[2016-11-14T15:05:58,798][DEBUG][o.e.a.s.TransportSearchScrollAction] [99cr2z0] [6] Failed to execute query phase\norg.elasticsearch.transport.RemoteTransportException: [99cr2z0][127.0.0.1:9300][indices:data/read/search[phase/query/scroll]]\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [6]\n    at org.elasticsearch.search.SearchService.findContext(SearchService.java:495) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:277) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$8(SearchTransportService.java:286) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n```\n\nThen I'll hit the NPE again:\n\n```\n[2016-11-14T15:06:24,735][ERROR][o.e.i.e.InternalEngine$EngineMergeScheduler] [99cr2z0] [store2-v5][0] failed to merge\njava.lang.NullPointerException\n    at org.apache.lucene.search.suggest.document.CompletionFieldsConsumer.write(CompletionFieldsConsumer.java:89) ~[lucene-suggest-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:54]\n    at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.write(PerFieldPostingsFormat.java:198) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:216) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:101) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4312) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3889) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626) [lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n[2016-11-14T15:06:24,745][WARN ][o.e.i.e.Engine           ] [99cr2z0] [store2-v5][0] failed engine [already closed by tragic event on the index writer]\njava.lang.NullPointerException\n    at org.apache.lucene.search.suggest.document.CompletionFieldsConsumer.write(CompletionFieldsConsumer.java:89) ~[lucene-suggest-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:54]\n    at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.write(PerFieldPostingsFormat.java:198) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:216) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:101) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4312) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3889) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n[2016-11-14T15:06:24,747][WARN ][o.e.i.c.IndicesClusterStateService] [99cr2z0] [[store2-v5][0]] marking and sending shard failed due to [shard failure, reason [already closed by tragic event on the index writer]]\njava.lang.NullPointerException\n    at org.apache.lucene.search.suggest.document.CompletionFieldsConsumer.write(CompletionFieldsConsumer.java:89) ~[lucene-suggest-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:54]\n    at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.write(PerFieldPostingsFormat.java:198) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:216) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:101) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4312) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3889) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n[2016-11-14T15:06:24,748][WARN ][o.e.c.a.s.ShardStateAction] [99cr2z0] [store2-v5][0] received shard failed for shard id [[store2-v5][0]], allocation id [w6E_VGiDSJm4nxHlu6NQfA], primary term [0], message [shard failure, reason [already closed by tragic event on the index writer]], failure [NullPointerException[null]]\njava.lang.NullPointerException\n    at org.apache.lucene.search.suggest.document.CompletionFieldsConsumer.write(CompletionFieldsConsumer.java:89) ~[lucene-suggest-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:54]\n    at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.write(PerFieldPostingsFormat.java:198) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:216) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:101) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4312) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3889) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n[2016-11-14T15:06:24,747][DEBUG][o.e.a.b.TransportShardBulkAction] [99cr2z0] [store2-v5][0] failed to execute bulk item (index) index {[store2-v5][live][700107356@39], source[{\"id\":\"700107356@39\",\"merchantId\":1,\"projectId\":1,\"catalogId\":39,\"spn\":\"700107356\",\"name\":\"Electronic HP Care Pack 6-Hour Call-To-Repair Proactive Care Service - Servicee\",\"description\":\"Electronic HP Care Pack 6-Hour Call-To-Repair Proactive Care Service - Serviceerweiterung - Arbeitszeit und Ersatzteile - 3 Jahre - Vor-Ort - 24x7\",\"keywords\":[\"Garantieerweiterungen / Servicepacks / F端r / Netzwerkprodukte / HP / Electronic / Care / Pack / 6-Hour / Call-To-Repair / Proactive / Service / - / Serviceerweiterung / Arbeitszeit / und / Ersatzteile / 3 / Jahre / Vor-Ort / 24x7\"],\"categories\":null,\"eclasses\":null,\"unspscs\":null,\"price\":1788.39,\"meplatoPrice\":0,\"listPrice\":0,\"scalePrices\":null,\"currency\":\"EUR\",\"country\":\"DE\",\"priceQty\":1,\"ou\":\"EA\",\"cuPerOu\":0,\"cu\":\"\",\"leadtime\":3,\"quantityMin\":1,\"quantityMax\":null,\"quantityInterval\":1,\"taxCode\":\"0.190000\",\"taxRate\":0.19,\"conditions\":[{\"kind\":\"core_product\",\"text\":\"Y\"}],\"gtin\":\"\",\"asin\":\"\",\"bpn\":\"\",\"mpn\":\"U8N20E\",\"manufacturer\":\"HP\",\"manufactcode\":\"\",\"service\":false,\"image\":\"http://img.misco.eu/resources/images/products/100/HWP/U8/U8N20E//U8N20E_200x200.jpg\",\"thumbnail\":\"http://img.misco.eu/resources/images/products/100/HWP/U8/U8N20E//U8N20E_40x40.jpg\",\"datasheet\":\"\",\"safetysheet\":\"\",\"blobs\":[{\"kind\":\"thumbnail\",\"source\":\"http://img.misco.eu/resources/images/products/100/HWP/U8/U8N20E//U8N20E_40x40.jpg\"},{\"kind\":\"normal\",\"source\":\"http://img.misco.eu/resources/images/products/100/HWP/U8/U8N20E//U8N20E_200x200.jpg\"}],\"hazmats\":[{\"kind\":\"Gefahrgutklasse\",\"text\":\"N\"},{\"kind\":\"Gefahrstoff\",\"text\":\"N\"}],\"matgroup\":\"\",\"erpGroupSupplier\":\"\",\"extSchemaType\":\"\",\"extCategoryId\":\"\",\"extCategory\":\"\",\"extProductId\":\"\",\"custField1\":\"\",\"custField2\":\"\",\"custField3\":\"\",\"custField4\":\"\",\"custField5\":\"\",\"custFields\":[{\"name\":\"SIEMENS.COUNTRYOFORIGIN\",\"value\":\"CN\"},{\"name\":\"SIEMENS.PREFEREDCOUNTRIES\",\"value\":\"DE\"},{\"name\":\"SIEMENS.NETWEIGHT\",\"value\":\"0\"},{\"name\":\"SIEMENS.WEIGHTUOM\",\"value\":\"KGM\"}],\"references\":null,\"features\":null,\"availability\":null,\"messages\":null,\"tags\":null,\"excluded\":false,\"catalogManaged\":false,\"created\":\"2016-06-14T13:06:15Z\",\"updated\":\"2016-06-14T13:06:15Z\"}]}\norg.elasticsearch.index.engine.IndexFailedEngineException: Index failed for [live#700107356@39]\n    at org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:417) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:552) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:542) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.index.TransportIndexAction.executeIndexRequestOnPrimary(TransportIndexAction.java:191) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.shardIndexOperation(TransportShardBulkAction.java:351) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.index(TransportShardBulkAction.java:158) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.handleItem(TransportShardBulkAction.java:137) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.onPrimaryShard(TransportShardBulkAction.java:123) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.onPrimaryShard(TransportShardBulkAction.java:74) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportWriteAction.shardOperationOnPrimary(TransportWriteAction.java:78) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportWriteAction.shardOperationOnPrimary(TransportWriteAction.java:50) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:902) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:872) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:113) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:319) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:254) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:838) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:835) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.shard.IndexShardOperationsLock.acquire(IndexShardOperationsLock.java:142) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationLock(IndexShard.java:1651) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryShardReference(TransportReplicationAction.java:847) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:271) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:250) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:242) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\nCaused by: org.apache.lucene.store.AlreadyClosedException: this IndexWriter is closed\n    at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:740) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.ensureOpen(IndexWriter.java:754) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.updateDocuments(IndexWriter.java:1371) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.elasticsearch.index.engine.InternalEngine.update(InternalEngine.java:541) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.engine.InternalEngine.innerIndex(InternalEngine.java:519) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:408) ~[elasticsearch-5.0.0.jar:5.0.0]\n    ... 31 more\nCaused by: java.lang.NullPointerException\n    at org.apache.lucene.search.suggest.document.CompletionFieldsConsumer.write(CompletionFieldsConsumer.java:89) ~[lucene-suggest-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:54]\n    at org.apache.lucene.codecs.perfield.PerFieldPostingsFormat$FieldsWriter.write(PerFieldPostingsFormat.java:198) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.codecs.FieldsConsumer.merge(FieldsConsumer.java:105) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.mergeTerms(SegmentMerger.java:216) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:101) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4312) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3889) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:588) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:99) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:626) ~[lucene-core-6.2.0.jar:6.2.0 764d0f19151dbff6f5fcd9fc4b2682cf934590c5 - mike - 2016-08-20 05:39:36]\n[2016-11-14T15:06:24,751][INFO ][o.e.c.r.a.AllocationService] [99cr2z0] Cluster health status changed from [GREEN] to [RED] (reason: [shards failed [[store2-v5][0]] ...]).\n[2016-11-14T15:06:29,756][ERROR][o.e.g.TransportNodesListGatewayStartedShards] [99cr2z0] [store2-v5][0] unable to acquire shard lock\norg.elasticsearch.env.ShardLockObtainFailedException: [store2-v5][0]: obtaining shard lock timed out after 5000ms\n    at org.elasticsearch.env.NodeEnvironment$InternalShardLock.acquire(NodeEnvironment.java:711) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.env.NodeEnvironment.shardLock(NodeEnvironment.java:630) ~[elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.index.store.Store.tryOpenIndex(Store.java:418) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.gateway.TransportNodesListGatewayStartedShards.nodeOperation(TransportNodesListGatewayStartedShards.java:143) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.gateway.TransportNodesListGatewayStartedShards.nodeOperation(TransportNodesListGatewayStartedShards.java:60) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.nodes.TransportNodesAction.nodeOperation(TransportNodesAction.java:144) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.nodes.TransportNodesAction$NodeTransportHandler.messageReceived(TransportNodesAction.java:271) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.action.support.nodes.TransportNodesAction$NodeTransportHandler.messageReceived(TransportNodesAction.java:267) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\n    at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\n```\n\nAnything I can do to further assist?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260390833","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260390833","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260390833,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDM5MDgzMw==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-14T16:49:43Z","updated_at":"2016-11-14T16:49:43Z","author_association":"CONTRIBUTOR","body":"Hi @olivere, could you possibly zip up one of the shards and post somewhere that I could download from?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260395052","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260395052","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260395052,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDM5NTA1Mg==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2016-11-14T17:03:16Z","updated_at":"2016-11-14T17:03:16Z","author_association":"CONTRIBUTOR","body":"@mikemccand Aaah, too bad. I was experimenting a bit more and lost the index. :-( I'm confident to maneuver myself into the same situation and promise to create a backup immediately... and let you know.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260615461","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260615461","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260615461,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDYxNTQ2MQ==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-15T11:18:21Z","updated_at":"2016-11-15T11:18:21Z","author_association":"CONTRIBUTOR","body":"Phew, I was finally able to reproduce with a Lucene test: https://issues.apache.org/jira/browse/LUCENE-7562\n\nThank you @olivere ... I no longer need the shard.\n\nI believe the issue happens when every document containing a given suggestion field has been removed from all segments currently being merged.  What's confusing is that the first merge in this situation runs fine, but another merge w/ that segment against other segments that were also created by similar merges (or didn't have this field to begin with) will lead to the NPE.  Though I am confused why in your case you were not bulk indexing nor deleting documents that had the suggestion field ...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260616413","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260616413","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260616413,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDYxNjQxMw==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2016-11-15T11:23:25Z","updated_at":"2016-11-15T11:23:25Z","author_association":"CONTRIBUTOR","body":"@mikemccand Thank you very much for solving this! :-)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260899116","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260899116","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260899116,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDg5OTExNg==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-16T09:39:40Z","updated_at":"2016-11-16T09:39:40Z","author_association":"CONTRIBUTOR","body":"@olivere Thank you for uncovering it!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260899932","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260899932","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260899932,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDg5OTkzMg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-11-16T09:43:10Z","updated_at":"2016-11-16T09:43:10Z","author_association":"CONTRIBUTOR","body":"@mikemccand can we expect a fix for this in 5.0.2?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260912573","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-260912573","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":260912573,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDkxMjU3Mw==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-11-16T10:39:10Z","updated_at":"2016-11-16T10:39:10Z","author_association":"CONTRIBUTOR","body":"> @mikemccand can we expect a fix for this in 5.0.2?\n\nWell, we need to kick off a Lucene bug fix release (6.2.2, 6.3.1), which I agree we should do soon, but I was planning on waiting a bit more to see what other Lucene bug fixes we should fold in.\n\nI.e. the cases that provoke this bug (deleting whole types that had unique completion fields) seems uncommon and didn't seem severe enough to warrant triggering the Lucene bug fix releases today?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/268761073","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-268761073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":268761073,"node_id":"MDEyOklzc3VlQ29tbWVudDI2ODc2MTA3Mw==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2016-12-22T09:48:24Z","updated_at":"2016-12-22T09:48:24Z","author_association":"CONTRIBUTOR","body":"Is there any chance to see the fixed Lucene versions in the next 5.x release?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/268781481","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-268781481","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":268781481,"node_id":"MDEyOklzc3VlQ29tbWVudDI2ODc4MTQ4MQ==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2016-12-22T11:30:38Z","updated_at":"2016-12-22T11:30:38Z","author_association":"CONTRIBUTOR","body":"@olivere I think that is likely; Lucene will probably soon start the 6.4.0 release process, and there are a number of improvements in that release, including this bug fix, that we want to expose for ES's next release.  But I can't promise the timing will work out!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/276918086","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-276918086","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":276918086,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NjkxODA4Ng==","user":{"login":"olivere","id":134848,"node_id":"MDQ6VXNlcjEzNDg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/134848?v=4","gravatar_id":"","url":"https://api.github.com/users/olivere","html_url":"https://github.com/olivere","followers_url":"https://api.github.com/users/olivere/followers","following_url":"https://api.github.com/users/olivere/following{/other_user}","gists_url":"https://api.github.com/users/olivere/gists{/gist_id}","starred_url":"https://api.github.com/users/olivere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/olivere/subscriptions","organizations_url":"https://api.github.com/users/olivere/orgs","repos_url":"https://api.github.com/users/olivere/repos","events_url":"https://api.github.com/users/olivere/events{/privacy}","received_events_url":"https://api.github.com/users/olivere/received_events","type":"User","site_admin":false},"created_at":"2017-02-02T10:14:46Z","updated_at":"2017-02-02T10:14:46Z","author_association":"CONTRIBUTOR","body":"Hmm... wasn't this fixed in Lucene 6.4.0 (which v5.2.0 is using)? Is it correct this has been relabeled to v5.2.1?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/276918837","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-276918837","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":276918837,"node_id":"MDEyOklzc3VlQ29tbWVudDI3NjkxODgzNw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-02T10:18:18Z","updated_at":"2017-02-02T10:18:18Z","author_association":"CONTRIBUTOR","body":"thanks @olivere - relabelled and closing as fixed by https://github.com/elastic/elasticsearch/pull/22724","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/279684732","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-279684732","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":279684732,"node_id":"MDEyOklzc3VlQ29tbWVudDI3OTY4NDczMg==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2017-02-14T11:38:56Z","updated_at":"2017-02-14T11:38:56Z","author_association":"CONTRIBUTOR","body":"The Lucene fix was backported to Lucene 5.5.4, so will be in the Elasticsearch 2.4.5 release: https://github.com/elastic/elasticsearch/pull/23162","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/294307616","html_url":"https://github.com/elastic/elasticsearch/issues/21500#issuecomment-294307616","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21500","id":294307616,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NDMwNzYxNg==","user":{"login":"shakdoesgithub","id":7268367,"node_id":"MDQ6VXNlcjcyNjgzNjc=","avatar_url":"https://avatars2.githubusercontent.com/u/7268367?v=4","gravatar_id":"","url":"https://api.github.com/users/shakdoesgithub","html_url":"https://github.com/shakdoesgithub","followers_url":"https://api.github.com/users/shakdoesgithub/followers","following_url":"https://api.github.com/users/shakdoesgithub/following{/other_user}","gists_url":"https://api.github.com/users/shakdoesgithub/gists{/gist_id}","starred_url":"https://api.github.com/users/shakdoesgithub/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shakdoesgithub/subscriptions","organizations_url":"https://api.github.com/users/shakdoesgithub/orgs","repos_url":"https://api.github.com/users/shakdoesgithub/repos","events_url":"https://api.github.com/users/shakdoesgithub/events{/privacy}","received_events_url":"https://api.github.com/users/shakdoesgithub/received_events","type":"User","site_admin":false},"created_at":"2017-04-15T17:40:03Z","updated_at":"2017-04-15T17:40:03Z","author_association":"NONE","body":"Hi, Is there a workaround for this? We are using AWS ES and they are on ES Version 5.1 and we're not sure when they'll migrate to a fixed version of ES. We are running into this issue, any help would be awesome!","performed_via_github_app":null}]