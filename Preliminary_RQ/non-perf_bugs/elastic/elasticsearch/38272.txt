{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38272/events","html_url":"https://github.com/elastic/elasticsearch/issues/38272","id":406066724,"node_id":"MDU6SXNzdWU0MDYwNjY3MjQ=","number":38272,"title":"S3 snapshotting times out requiring Elasticsearch process restart","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2019-02-03T08:43:46Z","updated_at":"2019-02-14T11:01:54Z","closed_at":"2019-02-14T11:01:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n```json\r\ncurl -X GET \"localhost:9200\"\r\n{\r\n  \"name\" : \"redacted\",\r\n  \"cluster_name\" : \"redacted\",\r\n  \"cluster_uuid\" : \"UJ8NSWbXSQmErxP9IfbvNA\",\r\n  \"version\" : {\r\n    \"number\" : \"6.3.0\",\r\n    \"build_flavor\" : \"default\",\r\n    \"build_type\" : \"rpm\",\r\n    \"build_hash\" : \"424e937\",\r\n    \"build_date\" : \"2018-06-11T23:38:03.357887Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"7.3.1\",\r\n    \"minimum_wire_compatibility_version\" : \"5.6.0\",\r\n    \"minimum_index_compatibility_version\" : \"5.0.0\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n```\r\n\r\n**Plugins installed**: [repository-s3, discovery-ec2]\r\n\r\n**JVM version** (`java -version`):\r\n```\r\njava version \"1.8.0_171\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_171-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n```\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux es-client-1 4.14.88-72.76.amzn1.x86_64 #1 SMP Mon Jan 7 19:47:07 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nSnapshotting is failing for us with the following error\r\n\r\n```\r\n{\r\n  \"duration_in_millis\": 345001,\r\n  \"end_time\": \"2019-02-02T00:05:48.480Z\",\r\n  \"end_time_in_millis\": 1549065948480,\r\n  \"failures\": [\r\n    {\r\n      \"index\": \"redacted\",\r\n      \"index_uuid\": \"redacted\",\r\n      \"node_id\": \"lxtigl9JRvm1dLX0RurmUg\",\r\n      \"reason\": \"IndexShardSnapshotFailedException[com.amazonaws.SdkClientException: Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SdkClientException[Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: ConnectTimeoutException[Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SocketTimeoutException[connect timed out]; \",\r\n      \"shard_id\": 11,\r\n      \"status\": \"INTERNAL_SERVER_ERROR\"\r\n    },\r\n    {\r\n      \"index\": \"redacted\",\r\n      \"index_uuid\": \"redacted\",\r\n      \"node_id\": \"lxtigl9JRvm1dLX0RurmUg\",\r\n      \"reason\": \"IndexShardSnapshotFailedException[com.amazonaws.SdkClientException: Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SdkClientException[Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: ConnectTimeoutException[Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SocketTimeoutException[connect timed out]; \",\r\n      \"shard_id\": 13,\r\n      \"status\": \"INTERNAL_SERVER_ERROR\"\r\n    },\r\n    {\r\n      \"index\": \"redacted\",\r\n      \"index_uuid\": \"redacted\",\r\n      \"node_id\": \"lxtigl9JRvm1dLX0RurmUg\",\r\n      \"reason\": \"IndexShardSnapshotFailedException[com.amazonaws.SdkClientException: Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SdkClientException[Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: ConnectTimeoutException[Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SocketTimeoutException[connect timed out]; \",\r\n      \"shard_id\": 11,\r\n      \"status\": \"INTERNAL_SERVER_ERROR\"\r\n    },\r\n    {\r\n      \"index\": \"redacted\",\r\n      \"index_uuid\": \"redacted\",\r\n      \"node_id\": \"lxtigl9JRvm1dLX0RurmUg\",\r\n      \"reason\": \"IndexShardSnapshotFailedException[com.amazonaws.SdkClientException: Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SdkClientException[Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: ConnectTimeoutException[Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SocketTimeoutException[connect timed out]; \",\r\n      \"shard_id\": 14,\r\n      \"status\": \"INTERNAL_SERVER_ERROR\"\r\n    },\r\n    {\r\n      \"index\": \"redacted\",\r\n      \"index_uuid\": \"redacted\",\r\n      \"node_id\": \"lxtigl9JRvm1dLX0RurmUg\",\r\n      \"reason\": \"IndexShardSnapshotFailedException[com.amazonaws.SdkClientException: Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SdkClientException[Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: ConnectTimeoutException[Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SocketTimeoutException[connect timed out]; \",\r\n      \"shard_id\": 12,\r\n      \"status\": \"INTERNAL_SERVER_ERROR\"\r\n    },\r\n    {\r\n      \"index\": \"redacted\",\r\n      \"index_uuid\": \"redacted\",\r\n      \"node_id\": \"lxtigl9JRvm1dLX0RurmUg\",\r\n      \"reason\": \"IndexShardSnapshotFailedException[com.amazonaws.SdkClientException: Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SdkClientException[Unable to execute HTTP request: Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: ConnectTimeoutException[Connect to redacted.s3.amazonaws.com:443 [redacted.s3.amazonaws.com/52.216.176.27] failed: connect timed out]; nested: SocketTimeoutException[connect timed out]; \",\r\n      \"shard_id\": 19,\r\n      \"status\": \"INTERNAL_SERVER_ERROR\"\r\n    }\r\n  ],\r\n  \"include_global_state\": true,\r\n  \"indices\": [\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\",\r\n    \"redacted\"\r\n  ],\r\n  \"shards\": {\r\n    \"failed\": 6,\r\n    \"successful\": 194,\r\n    \"total\": 200\r\n  },\r\n  \"snapshot\": \"redacted_2019-02-02t00:00:03z\",\r\n  \"start_time\": \"2019-02-02T00:00:03.479Z\",\r\n  \"start_time_in_millis\": 1549065603479,\r\n  \"state\": \"PARTIAL\",\r\n  \"uuid\": \"mbCeCSWuTXWkauPLgNq3Hg\",\r\n  \"version\": \"6.3.0\",\r\n  \"version_id\": 6030099\r\n}\r\n```\r\n\r\n**Note:** The 6 shards that failed to snapshot were all on the same host `lxtigl9JRvm1dLX0RurmUg`. Every subsequent attempt to create a snapshot results in the exact same error, with only this single node failing with a timeout to S3.\r\n\r\nRestarting the Elasticsearch process on this host, waiting for the cluster to go green, and then snapshotting again is successful.\r\n\r\nThis is a pretty serious problem for us, we need to be able to reliably take snapshots every 24 hours. If there is more information you need us to provide in order to get this triaged, please let us know.","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}