[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385055741","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-385055741","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":385055741,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTA1NTc0MQ==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2018-04-27T18:29:05Z","updated_at":"2018-04-27T18:29:05Z","author_association":"CONTRIBUTOR","body":"@OlivierPetri, which version of Elasticsearch are you running? Knowing the script context \r\nyou are running against would also be helpful.\r\n\r\nIn Elasticsearch 6.2.2, I see the expected behavior. Assuming this is for search-response-time scripting, I've re-created your example with what I see. Let me know if this does not align with your use-case.\r\n\r\n```\r\nPUT sumtest\r\n{\r\n\t\"mappings\" : {\r\n  \t\"doc\" : {\r\n  \t\"properties\" : {\r\n  \t\t\"NRA\" : { \"type\" : \"integer\" },\r\n  \t\t\"NRB\" : { \"type\" : \"integer\" }\r\n  \t}\r\n  \t}\r\n\t}\r\n}\r\n\r\nPUT sumtest/doc/1\r\n{\r\n\"NRA\" : 12,\r\n\"NRB\" : 34\r\n}\r\n\r\nPUT sumtest/doc/2\r\n{\r\n\"NRA\" : \"12\",\r\n\"NRB\" : \"34\"\r\n}\r\n\r\n\r\nGET sumtest/_search\r\n{\r\n    \"query\" : {\r\n        \"match_all\": {}\r\n    },\r\n    \"script_fields\": {\r\n      \"sum\": {\r\n        \"script\": \"\"\"doc[\"NRA\"].value + doc[\"NRB\"].value\"\"\"\r\n      }\r\n    }\r\n}\r\n```\r\n\r\nreturns:\r\n\r\n```\r\n...\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"sumtest\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 1,\r\n        \"fields\": {\r\n          \"sum\": [\r\n            46\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"sumtest\",\r\n        \"_type\": \"doc\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 1,\r\n        \"fields\": {\r\n          \"sum\": [\r\n            46\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n...\r\n```\r\n\r\nTwo things to note about the above example that differs from the two other expressions that were shared.\r\n\r\n1. the `doc` object holds the value of the fields that are stored in the doc-values for the index. This means that these values are post-coercion and mapping evaluation. `doc['NRA']` references a wrapper object around the actual value, so `doc['NRA'].value` is necessary to retrieve the long-value to add together.\r\n2. `ctx._source.NRA` retrieves the original value in the source that was indexed. This is pre-coercion, meaning that this will stay a string for doc `2` and a long for doc `1`. You can find some more explanation about this concept at the bottom of the documentation on this page: https://www.elastic.co/guide/en/elasticsearch/reference/6.2/search-request-script-fields.html","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385055826","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-385055826","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":385055826,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTA1NTgyNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-27T18:29:24Z","updated_at":"2018-04-27T18:29:24Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385057326","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-385057326","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":385057326,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTA1NzMyNg==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2018-04-27T18:34:56Z","updated_at":"2018-04-27T18:34:56Z","author_association":"CONTRIBUTOR","body":"Regarding your feature request for stricter validation, I forgot to mention that we do have this for numeric mapping types.\r\n\r\nPlease check out https://www.elastic.co/guide/en/elasticsearch/reference/6.2/coerce.html for examples","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/385980433","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-385980433","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":385980433,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NTk4MDQzMw==","user":{"login":"OlivierPetri","id":38720194,"node_id":"MDQ6VXNlcjM4NzIwMTk0","avatar_url":"https://avatars2.githubusercontent.com/u/38720194?v=4","gravatar_id":"","url":"https://api.github.com/users/OlivierPetri","html_url":"https://github.com/OlivierPetri","followers_url":"https://api.github.com/users/OlivierPetri/followers","following_url":"https://api.github.com/users/OlivierPetri/following{/other_user}","gists_url":"https://api.github.com/users/OlivierPetri/gists{/gist_id}","starred_url":"https://api.github.com/users/OlivierPetri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OlivierPetri/subscriptions","organizations_url":"https://api.github.com/users/OlivierPetri/orgs","repos_url":"https://api.github.com/users/OlivierPetri/repos","events_url":"https://api.github.com/users/OlivierPetri/events{/privacy}","received_events_url":"https://api.github.com/users/OlivierPetri/received_events","type":"User","site_admin":false},"created_at":"2018-05-02T13:38:15Z","updated_at":"2018-05-02T13:39:14Z","author_association":"NONE","body":"Hi there, and thanks for your kind reply. \r\n\r\nI confirm that \r\n`doc['NRA'] + doc['NRB']`\r\nworks and\r\n`ctx._source.NRA + ctx._source.NRB`\r\ndoes not. \r\n\r\nHowever the doc notation cannot be used in update or  update by query statements as stated [here](https://github.com/elastic/elasticsearch/issues/30210) and [here](https://github.com/elastic/elasticsearch/issues/29290). This means, that you have to do it manualy\r\n`Integer.parseInt(ctx._source.CNTA) + Integer.parseInt(ctx._source.CNTB)`\r\nas suggested [here](https://discuss.elastic.co/t/cannot-assign-numeric-values-in-script-on-update-by-query/129802/2), and I do not feel this is a viable solution in the long run.\r\n\r\nI will rerun my tests and come back here, but from what I observed, coercion did not work by default.\r\n\r\nI'll be back later today. \r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/386020613","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-386020613","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":386020613,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NjAyMDYxMw==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2018-05-02T15:34:07Z","updated_at":"2018-05-02T15:34:14Z","author_association":"CONTRIBUTOR","body":"@OlivierPetri ah, I see. Since this is an update-script, it does not have access doc-values. I believe that the real issue here is that errors like this should come up at compilation-time, rather than runtime. I believe the explicit integer parsing is the only option at the moment","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/386022580","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-386022580","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":386022580,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NjAyMjU4MA==","user":{"login":"OlivierPetri","id":38720194,"node_id":"MDQ6VXNlcjM4NzIwMTk0","avatar_url":"https://avatars2.githubusercontent.com/u/38720194?v=4","gravatar_id":"","url":"https://api.github.com/users/OlivierPetri","html_url":"https://github.com/OlivierPetri","followers_url":"https://api.github.com/users/OlivierPetri/followers","following_url":"https://api.github.com/users/OlivierPetri/following{/other_user}","gists_url":"https://api.github.com/users/OlivierPetri/gists{/gist_id}","starred_url":"https://api.github.com/users/OlivierPetri/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OlivierPetri/subscriptions","organizations_url":"https://api.github.com/users/OlivierPetri/orgs","repos_url":"https://api.github.com/users/OlivierPetri/repos","events_url":"https://api.github.com/users/OlivierPetri/events{/privacy}","received_events_url":"https://api.github.com/users/OlivierPetri/received_events","type":"User","site_admin":false},"created_at":"2018-05-02T15:40:03Z","updated_at":"2018-05-02T15:40:03Z","author_association":"NONE","body":"Allright and hello again. So from what I found, \"coerce = false\" just enforces what I named \"STRICT\" in my proposal, so an integer field has to be inserted as a json integer, and \"coerce = true\" does what I dubbed \"LEGACY\": It accepts a quoted number as an integer, but it will not cast it to an integer (which is what I'd understand as \"coercion\"), but retain the string value. \r\n\r\nSo with \"coerce=true\" and the input I gave above, I'll end up with:\r\n\r\n```\r\n            {\r\n                \"_index\": \"sumtest\",\r\n                \"_type\": \"doc\",\r\n                \"_id\": \"1\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                    \"NRA\": 12,\r\n                    \"NRB\": 34,\r\n                }\r\n            },\r\n            {\r\n                \"_index\": \"sumtest\",\r\n                \"_type\": \"doc\",\r\n                \"_id\": \"2\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                    \"NRA\": \"12\",\r\n                    \"NRB\": \"34\",\r\n                }\r\n            }\r\n\r\n```\r\nWith this, \r\n`ctx._source.NRA + ctx._source.NRB`\r\nwill work for item #1 but not for #2. Or rather, #1 will yield 46 and #2 will yield \"1234\" in an update query.\r\n\r\nAnd sorry for describing this behaviour for \r\n`doc['NRA'] + doc['NRB']`\r\nwitch is wrong, as doc[] seemingly does coerce on the fly. But since it is not available in update queries, it's not a general solution to use the doc notation. I'm afraid I caused some confustion mentioning doc at all, and I appologize for posting on Friday afternoon...\r\n\r\nHey, thank you all for the excellent work and your lightening fast responsiveness! ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/386052038","html_url":"https://github.com/elastic/elasticsearch/issues/30211#issuecomment-386052038","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30211","id":386052038,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NjA1MjAzOA==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2018-05-02T17:13:03Z","updated_at":"2018-05-02T17:13:03Z","author_association":"CONTRIBUTOR","body":"you're welcome @OlivierPetri, thanks for bearing with the lack of compile-time checking around this! This will be fixed over time, as was mentioned in https://github.com/elastic/elasticsearch/issues/30210#issuecomment-385030360.","performed_via_github_app":null}]