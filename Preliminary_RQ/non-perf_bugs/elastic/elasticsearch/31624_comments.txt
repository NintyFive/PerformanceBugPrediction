[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/400952987","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-400952987","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":400952987,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMDk1Mjk4Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-06-28T08:19:33Z","updated_at":"2018-06-28T08:19:33Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/400976583","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-400976583","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":400976583,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMDk3NjU4Mw==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2018-06-28T09:40:18Z","updated_at":"2018-06-28T09:40:18Z","author_association":"MEMBER","body":"@tlrx can you take a look?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/400988755","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-400988755","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":400988755,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMDk4ODc1NQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-06-28T10:25:30Z","updated_at":"2018-06-28T10:25:30Z","author_association":"MEMBER","body":"@TimHeckel Do you have more information about the snapshot deletion? It was a currently running / unfinished snapshot that you tried to delete? How long did it hang before you tried to restart the cluster?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408640700","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-408640700","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":408640700,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODY0MDcwMA==","user":{"login":"TimHeckel","id":83935,"node_id":"MDQ6VXNlcjgzOTM1","avatar_url":"https://avatars0.githubusercontent.com/u/83935?v=4","gravatar_id":"","url":"https://api.github.com/users/TimHeckel","html_url":"https://github.com/TimHeckel","followers_url":"https://api.github.com/users/TimHeckel/followers","following_url":"https://api.github.com/users/TimHeckel/following{/other_user}","gists_url":"https://api.github.com/users/TimHeckel/gists{/gist_id}","starred_url":"https://api.github.com/users/TimHeckel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimHeckel/subscriptions","organizations_url":"https://api.github.com/users/TimHeckel/orgs","repos_url":"https://api.github.com/users/TimHeckel/repos","events_url":"https://api.github.com/users/TimHeckel/events{/privacy}","received_events_url":"https://api.github.com/users/TimHeckel/received_events","type":"User","site_admin":false},"created_at":"2018-07-28T23:13:09Z","updated_at":"2018-07-28T23:13:09Z","author_association":"CONTRIBUTOR","body":"@tlrx - apologies for my delay in getting back to you here; the snapshot had been running for many days before I attempted deleting it and/or restarting the cluster. Is there anything I can do to force the removal of this aborted snapshot attempt? Thanks","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/422609133","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-422609133","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":422609133,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMjYwOTEzMw==","user":{"login":"TimHeckel","id":83935,"node_id":"MDQ6VXNlcjgzOTM1","avatar_url":"https://avatars0.githubusercontent.com/u/83935?v=4","gravatar_id":"","url":"https://api.github.com/users/TimHeckel","html_url":"https://github.com/TimHeckel","followers_url":"https://api.github.com/users/TimHeckel/followers","following_url":"https://api.github.com/users/TimHeckel/following{/other_user}","gists_url":"https://api.github.com/users/TimHeckel/gists{/gist_id}","starred_url":"https://api.github.com/users/TimHeckel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimHeckel/subscriptions","organizations_url":"https://api.github.com/users/TimHeckel/orgs","repos_url":"https://api.github.com/users/TimHeckel/repos","events_url":"https://api.github.com/users/TimHeckel/events{/privacy}","received_events_url":"https://api.github.com/users/TimHeckel/received_events","type":"User","site_admin":false},"created_at":"2018-09-19T00:56:21Z","updated_at":"2018-09-19T16:19:52Z","author_association":"CONTRIBUTOR","body":"Hi -- I've since upgraded from 6.3.0 to 6.4.1, but this one hanging snapshot remains. Below are all the responses I've gotten after upgrading. @tlrx - wondering if you could take another look or give me a pointer? I'd prefer not to have to migrate to a whole new cluster, but I simply cannot delete this hanging _snapshot, and that may be my last option.\r\n\r\n```\r\nGET /_snapshot/s3-6-backup/_status\r\n{\r\n  \"snapshots\": [\r\n    {\r\n      \"snapshot\": \"curator-20180623143002\",\r\n      \"repository\": \"s3-6-backup\",\r\n      \"uuid\": \"CbzLTfmbRCaGc5tu90x-9A\",\r\n      \"state\": \"ABORTED\",\r\n      \"include_global_state\": true,\r\n      \"shards_stats\": {\r\n        \"initializing\": 0,\r\n        \"started\": 0,\r\n        \"finalizing\": 0,\r\n        \"done\": 187,\r\n        \"failed\": 320,\r\n        \"total\": 507\r\n      },\r\n      \"stats\": {\r\n        \"incremental\": {\r\n          \"file_count\": 0,\r\n          \"size_in_bytes\": 0\r\n        },\r\n        \"total\": {\r\n          \"file_count\": 0,\r\n          \"size_in_bytes\": 0\r\n        },\r\n        \"start_time_in_millis\": 0,\r\n        \"time_in_millis\": 0,\r\n        \"number_of_files\": 0,\r\n        \"processed_files\": 0,\r\n        \"total_size_in_bytes\": 0,\r\n        \"processed_size_in_bytes\": 0\r\n      },\r\n      \"indices\": { ...\r\n```\r\n\r\n```\r\nGET /_snapshot/s3-6-backup/_current\r\n{\r\n  \"snapshots\": [\r\n    {\r\n      \"snapshot\": \"curator-20180623143002\",\r\n      \"uuid\": \"CbzLTfmbRCaGc5tu90x-9A\",\r\n      \"version_id\": 6040199,\r\n      \"version\": \"6.4.1\",\r\n      \"indices\": [ ... ],\r\n      \"include_global_state\": true,\r\n      \"state\": \"IN_PROGRESS\",\r\n      \"start_time\": \"2018-06-23T14:30:03.389Z\",\r\n      \"start_time_in_millis\": 1529764203389,\r\n      \"end_time\": \"1970-01-01T00:00:00.000Z\",\r\n      \"end_time_in_millis\": 0,\r\n      \"duration_in_millis\": -1529764203389,\r\n      \"failures\": [],\r\n      \"shards\": {\r\n        \"total\": 0,\r\n        \"failed\": 0,\r\n        \"successful\": 0\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n```\r\nDELETE /_snapshot/s3-6-backup/curator-20180623143002\r\n\r\n(eventually returns with a `curl: (52) Empty reply from server` on the server\r\n```\r\n\r\n```\r\nDELETE /_snapshot/s3-6-backup\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"remote_transport_exception\",\r\n        \"reason\": \"[main-2][10.0.1.61:9300][cluster:admin/repository/delete]\"\r\n      }\r\n    ],\r\n    \"type\": \"illegal_state_exception\",\r\n    \"reason\": \"trying to modify or unregister repository that is currently used \"\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/425867613","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-425867613","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":425867613,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNTg2NzYxMw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-10-01T10:58:36Z","updated_at":"2018-10-01T10:58:36Z","author_association":"CONTRIBUTOR","body":"The simplest solution to get rid of the stuck snapshot is to do a full cluster restart, i.e., all nodes down, and only then start them up again. This will clear the snapshot state, but will ofc also mean downtime. The more involved solution consists of the following: Look at the clusterstate, and check the snapshot entries that are marked as ABORTED. Check the node id associated with that entry. For example, let's look at:\r\n\r\n```\r\n{\r\n            \"index\" : {\r\n              \"index_name\" : \"my_index\",\r\n              \"index_uuid\" : \"VhUbEkzIQvggTmOXaRS3gQ\"\r\n            },\r\n            \"shard\" : 0,\r\n            \"state\" : \"ABORTED\",\r\n            \"node\" : \"zDggEbNfTj-DrAwJYjagcw\"\r\n          },\r\n```\r\n\r\nThe node id is `zDggEbNfTj-DrAwJYjagcw`, so in order for this entry to be properly cleaned up, the node with that id needs to be shut down. Now you might think: But that's what we did when we performed the rolling upgrade? Unfortunately, things are a little more complex. You need to shut down the node with id `zDggEbNfTj-DrAwJYjagcw`, and then WAIT for the snapshot entries for that node to be cleared up in the cluster state (i.e. marked as FAILED) before starting up that node again. The reason for this odd behavior is that the clean-up logic is scheduled when the node leaves the cluster, but so are also possibly lots of other events (e.g. shard failures). The scheduled clean-up logic (which will appear in the pending tasks as update snapshot state after node removal) unfortunately runs at a quite low priority compared to some of the other tasks, which means that if the node rejoins the cluster before the task has gotten to execute, it will mistake the node for not having left, and not clean-up the ABORTED state.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/427002150","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-427002150","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":427002150,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNzAwMjE1MA==","user":{"login":"BobBlank12","id":39975390,"node_id":"MDQ6VXNlcjM5OTc1Mzkw","avatar_url":"https://avatars3.githubusercontent.com/u/39975390?v=4","gravatar_id":"","url":"https://api.github.com/users/BobBlank12","html_url":"https://github.com/BobBlank12","followers_url":"https://api.github.com/users/BobBlank12/followers","following_url":"https://api.github.com/users/BobBlank12/following{/other_user}","gists_url":"https://api.github.com/users/BobBlank12/gists{/gist_id}","starred_url":"https://api.github.com/users/BobBlank12/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BobBlank12/subscriptions","organizations_url":"https://api.github.com/users/BobBlank12/orgs","repos_url":"https://api.github.com/users/BobBlank12/repos","events_url":"https://api.github.com/users/BobBlank12/events{/privacy}","received_events_url":"https://api.github.com/users/BobBlank12/received_events","type":"User","site_admin":false},"created_at":"2018-10-04T12:36:58Z","updated_at":"2018-10-04T12:36:58Z","author_association":"CONTRIBUTOR","body":"I believe you may also have to look for shards that are in the INIT state, not just the ABORTED state.  Please correct me if I am off on this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/427056700","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-427056700","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":427056700,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNzA1NjcwMA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-10-04T15:11:58Z","updated_at":"2018-10-04T15:12:39Z","author_association":"CONTRIBUTOR","body":"In the situation outlined by @TimHeckel here, he had already issued a delete snapshot command. This moves the entries from INIT to the ABORTED state (but lets the delete snapshot request hang until the abort is fully completed and confirmed by the nodes). So a prerequisite to the above procedure is to first issue a delete snapshot command.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/427366452","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-427366452","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":427366452,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNzM2NjQ1Mg==","user":{"login":"TimHeckel","id":83935,"node_id":"MDQ6VXNlcjgzOTM1","avatar_url":"https://avatars0.githubusercontent.com/u/83935?v=4","gravatar_id":"","url":"https://api.github.com/users/TimHeckel","html_url":"https://github.com/TimHeckel","followers_url":"https://api.github.com/users/TimHeckel/followers","following_url":"https://api.github.com/users/TimHeckel/following{/other_user}","gists_url":"https://api.github.com/users/TimHeckel/gists{/gist_id}","starred_url":"https://api.github.com/users/TimHeckel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimHeckel/subscriptions","organizations_url":"https://api.github.com/users/TimHeckel/orgs","repos_url":"https://api.github.com/users/TimHeckel/repos","events_url":"https://api.github.com/users/TimHeckel/events{/privacy}","received_events_url":"https://api.github.com/users/TimHeckel/received_events","type":"User","site_admin":false},"created_at":"2018-10-05T13:30:04Z","updated_at":"2018-10-05T13:35:50Z","author_association":"CONTRIBUTOR","body":"@ywelsch  - thank you so much for your help. I did attempt the second scenario, where I shut down the `ABORTED` node(s) and wait for the snapshot entries to turn into `FAILED` -- I did shut down just one of these nodes in my three node cluster, and unfortunately my first attempt caused the cluster to report:\r\n\r\n```\r\n{ \"error\" : { \"root_cause\" : [ { \"type\" : \"master_not_discovered_exception\", \"reason\" : null } ], \"type\" : \"master_not_discovered_exception\", \"reason\" : null }, \"status\" : 503 }\r\n```\r\n\r\nI think I will try for the full cluster restart tonight. At any rate, you've given me the first actionable advice, so I really appreciate it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/427597417","html_url":"https://github.com/elastic/elasticsearch/issues/31624#issuecomment-427597417","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31624","id":427597417,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNzU5NzQxNw==","user":{"login":"TimHeckel","id":83935,"node_id":"MDQ6VXNlcjgzOTM1","avatar_url":"https://avatars0.githubusercontent.com/u/83935?v=4","gravatar_id":"","url":"https://api.github.com/users/TimHeckel","html_url":"https://github.com/TimHeckel","followers_url":"https://api.github.com/users/TimHeckel/followers","following_url":"https://api.github.com/users/TimHeckel/following{/other_user}","gists_url":"https://api.github.com/users/TimHeckel/gists{/gist_id}","starred_url":"https://api.github.com/users/TimHeckel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TimHeckel/subscriptions","organizations_url":"https://api.github.com/users/TimHeckel/orgs","repos_url":"https://api.github.com/users/TimHeckel/repos","events_url":"https://api.github.com/users/TimHeckel/events{/privacy}","received_events_url":"https://api.github.com/users/TimHeckel/received_events","type":"User","site_admin":false},"created_at":"2018-10-06T18:46:13Z","updated_at":"2018-10-06T18:46:25Z","author_association":"CONTRIBUTOR","body":"@ywelsch  - just to close this, the FULL restart of the cluster worked. Thanks again.","performed_via_github_app":null}]