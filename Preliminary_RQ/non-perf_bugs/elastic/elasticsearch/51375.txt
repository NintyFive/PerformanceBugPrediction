{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51375","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51375/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51375/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51375/events","html_url":"https://github.com/elastic/elasticsearch/issues/51375","id":554402911,"node_id":"MDU6SXNzdWU1NTQ0MDI5MTE=","number":51375,"title":"Various TimeSeriesLifecycleActionsIT failures, NPE in moveClusterStateToErrorStep","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2020-01-23T20:57:46Z","updated_at":"2020-02-19T20:50:07Z","closed_at":"2020-02-19T20:50:07Z","author_association":"MEMBER","active_lock_reason":null,"body":"I'm not really sure how to classify this test failure, but I noticed an NPE so figured it was worthy to try and track.  Something probably went off the rails at some point and the rest is just fallout from that, but I don't know enough to tell what the cause is. \r\n\r\nInterestingly, the yaml tests fail due to a timeout later so perhaps it is tied to whatever is causing the yaml tests to timeout too.\r\n\r\nhttps://gradle-enterprise.elastic.co/s/474sinachygny\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:ilm:qa:multi-node:integTestRunner' --tests \"org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.testMoveToStepRereadsPolicy\" \\\r\n  -Dtests.seed=426FF3BECB3DFDF2 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=mt \\\r\n  -Dtests.timezone=America/Glace_Bay \\\r\n  -Dcompiler.java=13 \\\r\n  -Druntime.java=11\r\n\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:ilm:qa:multi-node:integTestRunner' --tests \"org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.testILMRolloverOnManuallyRolledIndex\" \\\r\n  -Dtests.seed=426FF3BECB3DFDF2 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=mt \\\r\n  -Dtests.timezone=America/Glace_Bay \\\r\n  -Dcompiler.java=13 \\\r\n  -Druntime.java=11\r\n\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:ilm:qa:multi-node:integTestRunner' --tests \"org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.testMoveToStepRereadsPolicy\" \\\r\n  -Dtests.seed=426FF3BECB3DFDF2 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=mt \\\r\n  -Dtests.timezone=America/Glace_Bay \\\r\n  -Dcompiler.java=13 \\\r\n  -Druntime.java=11\r\n\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:ilm:qa:multi-node:integTestRunner' --tests \"org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.testILMRolloverOnManuallyRolledIndex\" \\\r\n  -Dtests.seed=426FF3BECB3DFDF2 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=mt \\\r\n  -Dtests.timezone=America/Glace_Bay \\\r\n  -Dcompiler.java=13 \\\r\n  -Druntime.java=11\r\n\r\n```\r\n\r\n\r\n\r\nSo it looks like a test fails because it wasn't on the right step:\r\n```\r\n org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT > testMoveToStepRereadsPolicy FAILED\r\n15:10:41     org.elasticsearch.client.ResponseException: method [POST], host [http://127.0.0.1:32840], URI [_ilm/move/test-1], status line [HTTP/1.1 400 Bad Request]\r\n15:10:41     {\"error\":{\"root_cause\":[{\"type\":\"illegal_argument_exception\",\"reason\":\"index [test-1] is not on current step [{\\\"phase\\\":\\\"hot\\\",\\\"action\\\":\\\"rollover\\\",\\\"name\\\":\\\"check-rollover-ready\\\"}]\"}],\"type\":\"illegal_argument_exception\",\"reason\":\"index [test-1] is not on current step [{\\\"phase\\\":\\\"hot\\\",\\\"action\\\":\\\"rollover\\\",\\\"name\\\":\\\"check-rollover-ready\\\"}]\"},\"status\":400}\r\n15:10:41         at __randomizedtesting.SeedInfo.seed([426FF3BECB3DFDF2:AC845E4FC75748A8]:0)\r\n15:10:41         at org.elasticsearch.client.RestClient.convertResponse(RestClient.java:283)\r\n15:10:41         at org.elasticsearch.client.RestClient.performRequest(RestClient.java:261)\r\n15:10:41         at org.elasticsearch.client.RestClient.performRequest(RestClient.java:235)\r\n15:10:41         at org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.testMoveToStepRereadsPolicy(TimeSeriesLifecycleActionsIT.java:879)\r\n15:10:42 org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT > testILMRolloverOnManuallyRolledIndex FAILED\r\n15:10:42     org.elasticsearch.client.ResponseException: method [PUT], host [http://[::1]:41018], URI [/jkpkacsspx-000001], status line [HTTP/1.1 500 Internal Server Error]\r\n15:10:42     {\"error\":{\"root_cause\":[{\"type\":\"illegal_state_exception\",\"reason\":\"alias [alias] has more than one write index [jkpkacsspx-000001,test-000002]\"}],\"type\":\"illegal_state_exception\",\"reason\":\"alias [alias] has more than one write index [jkpkacsspx-000001,test-000002]\"},\"status\":500}\r\n15:10:42         at __randomizedtesting.SeedInfo.seed([426FF3BECB3DFDF2:B06F05619DCCFAE7]:0)\r\n15:10:42         at org.elasticsearch.client.RestClient.convertResponse(RestClient.java:283)\r\n15:10:42         at org.elasticsearch.client.RestClient.performRequest(RestClient.java:261)\r\n15:10:42         at org.elasticsearch.client.RestClient.performRequest(RestClient.java:235)\r\n15:10:42         at org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.createIndexWithSettings(TimeSeriesLifecycleActionsIT.java:1561)\r\n15:10:42         at org.elasticsearch.xpack.ilm.TimeSeriesLifecycleActionsIT.testILMRolloverOnManuallyRolledIndex(TimeSeriesLifecycleActionsIT.java:1034)\r\n```\r\n\r\nBut there are also errors about too many shards\r\n\r\n```\r\nERROR\",\"creation_date\":\"1579806667403\",\"step_time\":\"1579806670611\"},\"error_details\":\"{\\\"type\\\":\\\"illegal_argument_exception\\\",\\\"reason\\\":\\\"the number of target shards [8] must be less that the number of source shards [6]\\\",\\\"stack_trace\\\":\\\"java.lang.IllegalArgumentException: the number of target shards [8] must be less that the number of source shards [6]\\\\n\\\\tat \r\n```\r\n\r\nAnd existing indices:\r\n\r\n```\r\nERROR][o.e.x.i.IndexLifecycleRunner] [integTest-0] policy [AlIWG] for index [dqnlkipzun-000001] failed on step [{\"phase\":\"hot\",\"action\":\"rollover\",\"name\":\"check-rollover-ready\"}]. Moving to ERROR step\r\n15:14:03 »  org.elasticsearch.ResourceAlreadyExistsException: index [dqnlkipzun-000002/3JcIEtUYSwOwTFC2m2fYnQ] already exists\r\n15:14:03 »  \tat org.elasticsearch.cluster.metadata.MetaDataCreateIndexService.validateIndexName(MetaDataCreateIndexService.java:156) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n15:14:03 »  \tat org.elasticsearch.action.admin.indices.rollover.TransportRolloverAction.masterOperation(TransportRolloverAction.java:133) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n15:14:03 »  \tat org.elasticsearch.action.admin.indices.rollover.TransportRolloverAction.masterOperation(TransportRolloverAction.java:72) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n15:14:03 »  \tat \r\n```\r\n\r\nand at one point an NPE somewhere in the error handling chain\r\n\r\n```\r\n Caused by: java.lang.NullPointerException: unable to move to an error step where there is no current step, state: {}\r\n15:14:03 »  \tat java.util.Objects.requireNonNull(Objects.java:246) ~[?:?]\r\n15:14:03 »  \tat org.elasticsearch.xpack.ilm.IndexLifecycleTransition.moveClusterStateToErrorStep(IndexLifecycleTransition.java:133) ~[?:?]\r\n15:14:03 »  \tat org.elasticsearch.xpack.ilm.ExecuteStepsUpdateTask.moveToErrorStep(ExecuteStepsUpdateTask.java:210) ~[?:?]\r\n15:14:03 »  \tat org.elasticsearch.xpack.ilm.ExecuteStepsUpdateTask.execute(ExecuteStepsUpdateTask.java:99) ~[?:?]\r\n15:14:03 »  \tat org.elasticsearch.cluster.ClusterStateUpdateTask.execute(ClusterStateUpdateTask.java:47) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n15:14:03 »  \tat org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:702) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n15:14:03 »  \tat org.elasticsearch.cluster.service.MasterService.calculateTaskOutputs(MasterService.java:324) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n15:14:03 »  \tat org.elasticsearch.cluster.service.MasterService.runTasks(MasterService.java:219) ~[elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n```\r\n\r\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}