{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/58482","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58482/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58482/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58482/events","html_url":"https://github.com/elastic/elasticsearch/issues/58482","id":644507627,"node_id":"MDU6SXNzdWU2NDQ1MDc2Mjc=","number":58482,"title":"[ML] Job fail to start with \"Invalid alias name [.ml-state-write] ...\"","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-06-24T10:35:02Z","updated_at":"2020-11-04T00:09:25Z","closed_at":"2020-07-03T13:24:33Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Affected version**: 7.7 -\r\n\r\n**Problem**\r\n\r\n`.ml-state-write` is supposed to be an index alias, however by accident it can become an index. If `.ml-state-write` is a concrete index instead of an alias, starting a job can fail due to index rollover introduced in #52356.\r\n\r\nThe reason for `.ml-state-write` being an index instead of an alias is explained in #57645\r\n\r\nFrom `7.9` the job fails with: `Detected a problem with the internal machine learning data: the state index alias ...  exists as index but must be an alias.`\r\n\r\n**Mitigation**\r\n\r\n- if you are ok with re-creating ML models you can delete `.ml-state-write`\r\n- if you want to preserve state:\r\n\t- reindex `.ml-state-write` to `.ml-state`:\r\n\r\n```\r\n#---\r\n# reindex\r\n# - https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html\r\n#---\r\nPOST _reindex\r\n{\r\n\"source\": {\r\n\"index\": \".ml-state-write\",\r\n\"size\": 100\r\n},\r\n\"dest\": {\r\n\"index\": \".ml-state\"\r\n}\r\n}\r\n```\r\n\r\nAfter the _successful_ reindex, delete the old index and create an alias:\r\n\r\n```\r\n#---\r\n# delete .ml-state-write\r\n#---\r\nDELETE /.ml-state-write\r\n```\r\n\r\nNow you should be able to start the jobs.\r\n\r\n**Solution**\r\n\r\nThe issues #57645 and #55267 discuss solutions for preventing the `.ml-state-write` index. This will solve the root cause of this issue.\r\n\r\nFor users that have an `.ml-state-write` index by mistake, this won't help. Because reindex is an expensive operation it's _not_ an option to reindex in the back.\r\n\r\n2 possible improvements I can think of:\r\n\r\n**A: improve log message**\r\n\r\nThe log message isn't very descriptive and does not help for finding a solution quickly. We can improve the message (concrete wording to be discussed): \"Expected [.ml-state-write] to be an alias but it is an index, can't start the job. Please reindex [.ml-state-write] to [.ml-state]\". It's not possible to write full instructions in a log message, but given the message is part of this, users should find this.\r\n\r\n~**B: do not use ILM if ml-state-write is an index**~\r\n\r\n~We could be lenient and simply fall back to the old non-ILM way. We added ILM for a reason, that's why this solution is questionable, however, we talk about `7.x`. For upgrading to `8.0` we can require using an update tool and reindex as part of migrating to `8`, so eventually the state index will be managed. This solution requires that a `.ml-state-write` index does not cause problems in other parts of the code.~","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}