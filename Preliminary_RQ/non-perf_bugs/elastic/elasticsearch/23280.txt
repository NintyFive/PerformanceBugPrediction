{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23280","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23280/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23280/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23280/events","html_url":"https://github.com/elastic/elasticsearch/issues/23280","id":209030214,"node_id":"MDU6SXNzdWUyMDkwMzAyMTQ=","number":23280,"title":"Repeating A Functional Search Query Results In Permanent Errors Until Restarting ES","user":{"login":"neoform","id":3719298,"node_id":"MDQ6VXNlcjM3MTkyOTg=","avatar_url":"https://avatars3.githubusercontent.com/u/3719298?v=4","gravatar_id":"","url":"https://api.github.com/users/neoform","html_url":"https://github.com/neoform","followers_url":"https://api.github.com/users/neoform/followers","following_url":"https://api.github.com/users/neoform/following{/other_user}","gists_url":"https://api.github.com/users/neoform/gists{/gist_id}","starred_url":"https://api.github.com/users/neoform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neoform/subscriptions","organizations_url":"https://api.github.com/users/neoform/orgs","repos_url":"https://api.github.com/users/neoform/repos","events_url":"https://api.github.com/users/neoform/events{/privacy}","received_events_url":"https://api.github.com/users/neoform/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2017-02-21T03:05:58Z","updated_at":"2018-02-14T13:29:20Z","closed_at":"2017-02-21T14:30:52Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.2.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_121\r\n\r\n**OS version**: Debian 8\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n 1. Execute Search Query (below), valid results returned.\r\n 2. Repeat step #1 more than 3 times.\r\n 3. Error message is shown.\r\n 4. Restart ElasticSearch.\r\n 5. Repeat step #1.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n[2017-02-21 02:48:41] log.INFO: Request Success: {\"method\":\"POST\",\"uri\":\"http://127.0.0.1:9200/product/product/_search?timeout=6s&from=0&size=40\",\"headers\":{\"host\":[\"127.0.0.1:9200\"],\"user-agent\":[\"Guzzle/3.9.2 curl/7.38.0 PHP/7.0.16-1~dotdeb+8.1\"],\"content-length\":[1570]},\"HTTP code\":200,\"duration\":0.080847} {\"file\":\"/var/www/xxxx/library/Elasticsearch/Connections/AbstractConnection.php\",\"line\":131,\"class\":\"Elasticsearch\\\\Connections\\\\AbstractConnection\",\"function\":\"logRequestSuccess\"}\r\n\r\n[2017-02-21 02:48:42] log.WARNING: Request Failure: {\"method\":\"POST\",\"uri\":\"http://127.0.0.1:9200/product/product/_search?timeout=6s&from=0&size=40\",\"headers\":{\"host\":[\"127.0.0.1:9200\"],\"user-agent\":[\"Guzzle/3.9.2 curl/7.38.0 PHP/7.0.16-1~dotdeb+8.1\"],\"content-length\":[1570]},\"HTTP code\":500,\"duration\":0.08146,\"error\":\"Server error response\\n[status code] 500\\n[reason phrase] Internal Server Error\\n[url] http://127.0.0.1:9200/product/product/_search?timeout=6s&from=0&size=40\"} {\"file\":\"/var/www/xxxx/library/Elasticsearch/Connections/AbstractConnection.php\",\"line\":186,\"class\":\"Elasticsearch\\\\Connections\\\\AbstractConnection\",\"function\":\"logRequestFail\"}\r\n\r\n[2017-02-21 02:48:42] log.WARNING: Response [\"{\\\"error\\\":{\\\"root_cause\\\":[{\\\"type\\\":\\\"illegal_state_exception\\\",\\\"reason\\\":\\\"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\\\"}],\\\"type\\\":\\\"search_phase_execution_exception\\\",\\\"reason\\\":\\\"all shards failed\\\",\\\"phase\\\":\\\"query_fetch\\\",\\\"grouped\\\":true,\\\"failed_shards\\\":[{\\\"shard\\\":0,\\\"index\\\":\\\"product\\\",\\\"node\\\":\\\"ddjlYjROS8e3YTe4HT730A\\\",\\\"reason\\\":{\\\"type\\\":\\\"illegal_state_exception\\\",\\\"reason\\\":\\\"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\\\"}}],\\\"caused_by\\\":{\\\"type\\\":\\\"illegal_state_exception\\\",\\\"reason\\\":\\\"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\\\"}},\\\"status\\\":500}\"] {\"file\":\"/var/www/xxxx/library/Elasticsearch/Connections/AbstractConnection.php\",\"line\":189,\"class\":\"Elasticsearch\\\\Connections\\\\AbstractConnection\",\"function\":\"logRequestFail\"}\r\n\r\n[2017-02-21 02:48:42] log.ERROR: 500 Server Exception: Server error response [status code] 500 [reason phrase] Internal Server Error [url] http://127.0.0.1:9200/product/product/_search?timeout=6s&from=0&size=40 {\"error\":{\"root_cause\":[{\"type\":\"illegal_state_exception\",\"reason\":\"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query_fetch\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"product\",\"node\":\"ddjlYjROS8e3YTe4HT730A\",\"reason\":{\"type\":\"illegal_state_exception\",\"reason\":\"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\"}}],\"caused_by\":{\"type\":\"illegal_state_exception\",\"reason\":\"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\"}},\"status\":500} [] {\"file\":\"/var/www/xxxx/library/Elasticsearch/Connections/GuzzleConnection.php\",\"line\":229,\"class\":\"Elasticsearch\\\\Connections\\\\GuzzleConnection\",\"function\":\"process5xxError\"}\r\n\r\n**Query**:\r\n\r\n```javascript\r\n{\r\n    \"timeout\": \"6s\",\r\n    \"index\": \"product\",\r\n    \"type\": \"product\",\r\n    \"from\": 0,\r\n    \"size\": 40,\r\n    \"body\": {\r\n        \"_source\": [\r\n            \"mpn\",\r\n            \"cheapest_product_id\",\r\n            \"price\",\r\n            \"price_discount_percent\",\r\n            \"price_discount_amount\",\r\n            \"product_count\",\r\n            \"rank_weight\",\r\n            \"product.id\",\r\n            \"product.price\",\r\n            \"product.status_id\"\r\n        ],\r\n        \"query\": {\r\n            \"function_score\": {\r\n                \"query\": {\r\n                    \"bool\": {\r\n                        \"filter\": [\r\n                            {\r\n                                \"nested\": {\r\n                                    \"path\": \"product\",\r\n                                    \"query\": {\r\n                                        \"bool\": {\r\n                                            \"filter\": [\r\n                                                {\r\n                                                    \"term\": {\r\n                                                        \"product.status_id\": 1\r\n                                                    }\r\n                                                },\r\n                                                {\r\n                                                    \"nested\": {\r\n                                                        \"path\": \"product.category\",\r\n                                                        \"query\": {\r\n                                                            \"bool\": {\r\n                                                                \"filter\": [\r\n                                                                    {\r\n                                                                        \"terms\": {\r\n                                                                            \"product.category.id\": [\r\n                                                                                870\r\n                                                                            ]\r\n                                                                        }\r\n                                                                    }\r\n                                                                ]\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n                                                },\r\n                                                {\r\n                                                    \"nested\": {\r\n                                                        \"path\": \"product.brand\",\r\n                                                        \"query\": {\r\n                                                            \"bool\": {\r\n                                                                \"filter\": [\r\n                                                                    {\r\n                                                                        \"terms\": {\r\n                                                                            \"product.brand.id\": [\r\n                                                                                23083\r\n                                                                            ]\r\n                                                                        }\r\n                                                                    }\r\n                                                                ]\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            ],\r\n                                            \"must\": [\r\n                                                {\r\n                                                    \"multi_match\": {\r\n                                                        \"query\": \"television, audio, phone, dvd, tv\",\r\n                                                        \"fields\": [\r\n                                                            \"product.name^10\",\r\n                                                            \"product.description^4\",\r\n                                                            \"product.brand.name\",\r\n                                                            \"product.brand.keywords_internal\",\r\n                                                            \"product.brand.keywords_external\"\r\n                                                        ],\r\n                                                        \"minimum_should_match\": 0\r\n                                                    }\r\n                                                }\r\n                                            ]\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                },\r\n                \"functions\": [\r\n                    {\r\n                        \"field_value_factor\": {\r\n                            \"field\": \"product_count\",\r\n                            \"factor\": 50,\r\n                            \"modifier\": \"log1p\"\r\n                        }\r\n                    },\r\n                    {\r\n                        \"field_value_factor\": {\r\n                            \"field\": \"rank_weight\",\r\n                            \"modifier\": \"reciprocal\",\r\n                            \"missing\": 1\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        },\r\n        \"aggs\": {\r\n            \"brands\": {\r\n                \"nested\": {\r\n                    \"path\": \"product.brand\"\r\n                },\r\n                \"aggs\": {\r\n                    \"brands\": {\r\n                        \"filter\": {\r\n                            \"bool\": {\r\n                                \"filter\": [\r\n                                    {\r\n                                        \"nested\": {\r\n                                            \"path\": \"product\",\r\n                                            \"query\": {\r\n                                                \"bool\": {\r\n                                                    \"filter\": [\r\n                                                        {\r\n                                                            \"term\": {\r\n                                                                \"product.status_id\": 1\r\n                                                            }\r\n                                                        },\r\n                                                        {\r\n                                                            \"nested\": {\r\n                                                                \"path\": \"product.category\",\r\n                                                                \"query\": {\r\n                                                                    \"bool\": {\r\n                                                                        \"filter\": [\r\n                                                                            {\r\n                                                                                \"terms\": {\r\n                                                                                    \"product.category.id\": [\r\n                                                                                        870\r\n                                                                                    ]\r\n                                                                                }\r\n                                                                            }\r\n                                                                        ]\r\n                                                                    }\r\n                                                                }\r\n                                                            }\r\n                                                        }\r\n                                                    ],\r\n                                                    \"must\": [\r\n                                                        {\r\n                                                            \"multi_match\": {\r\n                                                                \"query\": \"television, audio, phone, dvd, tv\",\r\n                                                                \"fields\": [\r\n                                                                    \"product.name^10\",\r\n                                                                    \"product.description^4\",\r\n                                                                    \"product.brand.name\",\r\n                                                                    \"product.brand.keywords_internal\",\r\n                                                                    \"product.brand.keywords_external\"\r\n                                                                ],\r\n                                                                \"minimum_should_match\": 0\r\n                                                            }\r\n                                                        }\r\n                                                    ]\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                ]\r\n                            }\r\n                        },\r\n                        \"aggs\": {\r\n                            \"brands\": {\r\n                                \"terms\": {\r\n                                    \"field\": \"product.brand.id\",\r\n                                    \"size\": 30\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n*After the first few executions*:\r\n\r\n```javascript\r\n{\r\n    \"took\": 156,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 854,\r\n        \"max_score\": 0,\r\n        \"hits\": [ ... ]\r\n    }\r\n}\r\n```\r\n\r\n*Then on the 3rd try*:\r\n\r\n```javascript\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [\r\n            {\r\n                \"type\": \"illegal_state_exception\",\r\n                \"reason\": \"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\"\r\n            }\r\n        ],\r\n        \"type\": \"search_phase_execution_exception\",\r\n        \"reason\": \"all shards failed\",\r\n        \"phase\": \"query_fetch\",\r\n        \"grouped\": true,\r\n        \"failed_shards\": [\r\n            {\r\n                \"shard\": 0,\r\n                \"index\": \"product\",\r\n                \"node\": \"ddjlYjROS8e3YTe4HT730A\",\r\n                \"reason\": {\r\n                    \"type\": \"illegal_state_exception\",\r\n                    \"reason\": \"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\"\r\n                }\r\n            }\r\n        ],\r\n        \"caused_by\": {\r\n            \"type\": \"illegal_state_exception\",\r\n            \"reason\": \"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc. docId=2147483647, class org.apache.lucene.search.ConjunctionScorer\"\r\n        }\r\n    },\r\n    \"status\": 500\r\n}\r\n```","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}