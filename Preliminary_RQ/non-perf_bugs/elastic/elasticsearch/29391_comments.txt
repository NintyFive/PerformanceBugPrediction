[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/378928759","html_url":"https://github.com/elastic/elasticsearch/issues/29391#issuecomment-378928759","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29391","id":378928759,"node_id":"MDEyOklzc3VlQ29tbWVudDM3ODkyODc1OQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-04-05T13:05:13Z","updated_at":"2018-04-05T13:05:13Z","author_association":"MEMBER","body":"@aurimasplu I reproduced your issues using this following script:\r\n```\r\nPUT test\r\n{\r\n  \"settings\": {\r\n    \"number_of_shards\": 1,\r\n    \"number_of_replicas\": 0\r\n  },\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"date\": {\r\n          \"type\": \"date\"\r\n        },\r\n        \"number\": {\r\n          \"type\": \"long\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test/doc/1\r\n{\r\n  \"date\": \"2018-01-01\",\r\n  \"number\": 1\r\n}\r\nPUT test/doc/2\r\n{\r\n  \"date\": \"2018-01-02\",\r\n  \"number\": 2\r\n}\r\nPUT test/doc/3\r\n{\r\n  \"date\": \"2018-01-03\",\r\n  \"number\": 3\r\n}\r\nPUT test/doc/5\r\n{\r\n  \"date\": \"2018-01-05\",\r\n  \"number\": 5\r\n}\r\n\r\nGET test/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"histo\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"date\",\r\n        \"interval\": \"day\"\r\n      },\r\n      \"aggs\": {\r\n        \"avg\": {\r\n          \"avg\": {\r\n            \"field\": \"number\"\r\n          }\r\n        },\r\n        \"script\": {\r\n          \"bucket_script\": {\r\n            \"buckets_path\": {\r\n              \"my_var1\": \"avg\"\r\n            },\r\n            \"script\": \"params.my_var1 * 2\"\r\n          }\r\n        },\r\n        \"selector\": {\r\n          \"bucket_selector\": {\r\n            \"buckets_path\": {\r\n              \"my_var3\": \"script\"\r\n            },\r\n            \"script\": \"params.my_var3 > 4\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nNotice that there is no document for `2018-01-04` which means the date histogram has an empty bucket. There is a known issue (https://github.com/elastic/elasticsearch/issues/27377) which means the bucket_script aggregation is not run on buckets that have a doc_count of 0 due to how pipeline aggregations deal with gaps in data. The same issue is happening here where empty buckets do not have a value for the bucket_script because its not run so the bucket_selector is throwing a null pointer when it tries to unbox the null value to compare it in the condition. As a work around you can add a default value for `params.my_var3` to your bucket_selector script so it can evaluate the expression even when the bucket_script agg is not run. For my example above that would look like the following:\r\n```\r\nGET test/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"histo\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"date\",\r\n        \"interval\": \"day\"\r\n      },\r\n      \"aggs\": {\r\n        \"avg\": {\r\n          \"avg\": {\r\n            \"field\": \"number\"\r\n          }\r\n        },\r\n        \"script\": {\r\n          \"bucket_script\": {\r\n            \"buckets_path\": {\r\n              \"my_var1\": \"avg\"\r\n            },\r\n            \"script\": \"params.my_var1 * 2\"\r\n          }\r\n        },\r\n        \"selector\": {\r\n          \"bucket_selector\": {\r\n            \"buckets_path\": {\r\n              \"my_var3\": \"script\"\r\n            },\r\n            \"script\": \"(params.my_var3 ?: 0) > 4\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nNote the `?: 0` which means that if `params.my_var3` is null `0` will be used instead.\r\n\r\nI'm going to close this issue in favour of https://github.com/elastic/elasticsearch/issues/27377 since this is the same problem that https://github.com/elastic/elasticsearch/issues/27377 describes.","performed_via_github_app":null}]