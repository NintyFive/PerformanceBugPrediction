{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10920","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10920/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10920/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10920/events","html_url":"https://github.com/elastic/elasticsearch/issues/10920","id":72444163,"node_id":"MDU6SXNzdWU3MjQ0NDE2Mw==","number":10920,"title":"java recovery api, stale/incorrect shard information, only correct after close/re-open","user":{"login":"bitsofinfo","id":1743646,"node_id":"MDQ6VXNlcjE3NDM2NDY=","avatar_url":"https://avatars1.githubusercontent.com/u/1743646?v=4","gravatar_id":"","url":"https://api.github.com/users/bitsofinfo","html_url":"https://github.com/bitsofinfo","followers_url":"https://api.github.com/users/bitsofinfo/followers","following_url":"https://api.github.com/users/bitsofinfo/following{/other_user}","gists_url":"https://api.github.com/users/bitsofinfo/gists{/gist_id}","starred_url":"https://api.github.com/users/bitsofinfo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bitsofinfo/subscriptions","organizations_url":"https://api.github.com/users/bitsofinfo/orgs","repos_url":"https://api.github.com/users/bitsofinfo/repos","events_url":"https://api.github.com/users/bitsofinfo/events{/privacy}","received_events_url":"https://api.github.com/users/bitsofinfo/received_events","type":"User","site_admin":false},"labels":[{"id":146829143,"node_id":"MDU6TGFiZWwxNDY4MjkxNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Transport%20API","name":":Core/Infra/Transport API","color":"0e8a16","default":false,"description":"Transport client API"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-05-01T14:31:33Z","updated_at":"2017-04-03T21:52:18Z","closed_at":"2017-04-03T21:52:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I am using ES 1.5.2\n\nFor a given index I am trying to determine which ES node(s) hold the primary shards at any given time.\n\nI am using the Java API\n\nI make a RecoveryRequest for a specific index to a node, and get back a RecoveryResponse, I then do the following to create a simple list that only contains nodes which are primary for a given shard. I just switch on getPrimary then match on nodeId from a previously built map of nodes that I have.\n\n```\nresponse.shardResponses.values.foreach(srrList => {\n                srrList.foreach(shardRecoveryResponse => {\n\n                    val recoveryState = shardRecoveryResponse.recoveryState;\n                    if (recoveryState.getPrimary) {\n                        primaryNodes += nodeMap(recoveryState.getSourceNode.getId)\n                    }\n                })\n        })\n```\n\nThe issue is this. \n\na) I startup my cluster with a test index, 5 shards and only a few documents. The cluster is 4 nodes. The shards are distributed as such (via the head plugin) (all green)\n\nnode1: s(1)-replica, s(2)-primary, s(3)-primary\nnode2: s(2)-replica, s(4)-replica\nnode3: s(0)-replica, s(3)-replica, s(4)-primary\nnode4: s(0)-primary, s(1)-primary\n\nb) I run my little bit of code like the above and I get back what I would expect, (node1, node3 and node4) as the only nodes in my list because they are the only ones w/ primary shards\n\nc) I then shut down node1 (currently holds 2 primary shards)\n\nd) The cluster now balances and looks like this (via the head plugin) (all green)\n\nnode2: s(1)-replica, s(4)-replica, s(2)-primary\nnode3: s(0)-replica, s(3)-primary, s(4)-primary\nnode4: s(0)-primary, s(1)-primary, s(2)-replica, s(3)-replica\n\ne) I run my little bit of code again and I DON'T get back what I expect the data within the RecoveryResponse states primary shard holding nodes are (node3 and node4). Node2 (according to data within RecoveryResponse) does not hold any primary shards..... Even after killing my client and completely re-connecting I get the same response. \n\nf) The only way I can get a correct view of the cluster after a rebalance is by closing the index, then re-opening it. Once this is done then the data in RecoveryResponse is correct (matches what head plugin says)\n\nI am using this api wrong? Is this expected?\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}