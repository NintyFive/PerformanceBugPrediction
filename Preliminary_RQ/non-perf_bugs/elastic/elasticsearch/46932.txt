{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46932","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46932/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46932/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46932/events","html_url":"https://github.com/elastic/elasticsearch/issues/46932","id":496409069,"node_id":"MDU6SXNzdWU0OTY0MDkwNjk=","number":46932,"title":"Interim Downgrade Issue with Elasticsearch (from 7.3.1 to 6.8.3)","user":{"login":"sanjaysahu-git","id":55587969,"node_id":"MDQ6VXNlcjU1NTg3OTY5","avatar_url":"https://avatars0.githubusercontent.com/u/55587969?v=4","gravatar_id":"","url":"https://api.github.com/users/sanjaysahu-git","html_url":"https://github.com/sanjaysahu-git","followers_url":"https://api.github.com/users/sanjaysahu-git/followers","following_url":"https://api.github.com/users/sanjaysahu-git/following{/other_user}","gists_url":"https://api.github.com/users/sanjaysahu-git/gists{/gist_id}","starred_url":"https://api.github.com/users/sanjaysahu-git/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sanjaysahu-git/subscriptions","organizations_url":"https://api.github.com/users/sanjaysahu-git/orgs","repos_url":"https://api.github.com/users/sanjaysahu-git/repos","events_url":"https://api.github.com/users/sanjaysahu-git/events{/privacy}","received_events_url":"https://api.github.com/users/sanjaysahu-git/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-09-20T15:15:39Z","updated_at":"2019-09-20T17:38:41Z","closed_at":"2019-09-20T17:38:41Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nCluster master: `6.8.3`\r\nOnly one node upgraded to: ES version 7.3.1\r\n```code\r\nrpm -qa elasticsearch\r\nelasticsearch-7.3.1-1.x86_64\r\n```\r\n\r\n**Plugins installed**: [N/A]\r\n\r\n**JVM version** (`java -version`):\r\n```code\r\njava -version\r\nopenjdk version \"11.0.4\" 2019-07-16 LTS\r\nOpenJDK Runtime Environment 18.9 (build 11.0.4+11-LTS)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11.0.4+11-LTS, mixed mode, sharing)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```code\r\nuname -a\r\nLinux analytics_01 3.10.0-957.10.1.el7.x86_64 #1 SMP Thu Feb 7 07:12:53 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI have a multi-node cluster with elasticsearch version `6.8.3`. I want to upgrade my cluster to version `7.3.1`. I could successfully upgrade one node (injest) to `7.3`. I tried to rollbacl the upgraded node but elasticsearch throws exception:\r\n\r\n`failed to read [id:4, file:/mnt/persistent/elasticsearch/indices/nodes/0/_state/node-4.st]`\r\n\r\n\r\n\r\n**Steps to reproduce**:\r\n step-0. The cluster (6 injest, 6 data and 6 master-eligible nodes) is on ES version 6.8.3\r\n 1. Before I start upgrading one node, I fixed the indices from “7.0 upgrade assistant”\r\n 2. Upgrade one of the analytics node - (upgrade one node to 7.3 is successful)\r\n \r\n```code\r\n GET /http://localhost:9200/\r\n  {\r\n  \"name\" : \"analytics_01\",\r\n  \"cluster_name\" : \"analytics-cluster\",\r\n  \"cluster_uuid\" : \"T28wyP4-TIWc8Qu2DFWsyg\",\r\n  \"version\" : {\r\n    \"number\" : \"7.3.1\",\r\n    \"build_flavor\" : \"default\",\r\n    \"build_type\" : \"rpm\",\r\n    \"build_hash\" : \"4749ba6\",\r\n    \"build_date\" : \"2019-08-19T20:19:25.651794Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"8.1.0\",\r\n    \"minimum_wire_compatibility_version\" : \"6.8.0\",\r\n    \"minimum_index_compatibility_version\" : \"6.0.0-beta1\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n }\r\n```\r\n\r\n3. Now I want to do a rollback (interim) of the upgraded node back to version `6.8.3`. But it fails with the following exception:\r\n\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2][2019-09-20T11:06:27,762][ERROR][o.e.b.Bootstrap          ] [analytics_01] Exception\r\norg.elasticsearch.ElasticsearchException: java.io.IOException: failed to read [id:4, file:/mnt/persistent/elasticsearch/indices/nodes/0/_state/node-4.st]\r\n        at org.elasticsearch.ExceptionsHelper.maybeThrowRuntimeAndSuppress(ExceptionsHelper.java:165) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestStateWithGeneration(MetaDataStateFormat.java:306) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestState(MetaDataStateFormat.java:324) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.env.NodeEnvironment.loadOrCreateNodeMetaData(NodeEnvironment.java:417) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.env.NodeEnvironment.<init>(NodeEnvironment.java:305) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.node.Node.<init>(Node.java:296) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.node.Node.<init>(Node.java:266) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:212) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:212) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:333) [elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:159) [elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:150) [elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86) [elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124) [elasticsearch-cli-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.cli.Command.main(Command.java:90) [elasticsearch-cli-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:116) [elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:93) [elasticsearch-6.8.3.jar:6.8.3]\r\nCaused by: java.io.IOException: failed to read [id:4, file:/mnt/persistent/elasticsearch/indices/nodes/0/_state/node-4.st]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestStateWithGeneration(MetaDataStateFormat.java:300) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        ... 15 more\r\nCaused by: org.elasticsearch.common.xcontent.XContentParseException: [-1:36] [node_meta_data] unknown field [node_version], parser not found\r\n        at org.elasticsearch.common.xcontent.ObjectParser.getParser(ObjectParser.java:369) ~[elasticsearch-x-content-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.common.xcontent.ObjectParser.parse(ObjectParser.java:158) ~[elasticsearch-x-content-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.common.xcontent.ObjectParser.apply(ObjectParser.java:182) ~[elasticsearch-x-content-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.env.NodeMetaData$1.fromXContent(NodeMetaData.java:110) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.env.NodeMetaData$1.fromXContent(NodeMetaData.java:94) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.read(MetaDataStateFormat.java:197) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        at org.elasticsearch.gateway.MetaDataStateFormat.loadLatestStateWithGeneration(MetaDataStateFormat.java:296) ~[elasticsearch-6.8.3.jar:6.8.3]\r\n        ... 15 more\r\n\r\n```\r\n\r\n**Location of the node-4.st (attached)**\r\n\r\n```\r\n[root@analytics_01 _state]# pwd\r\n/mnt/persistent/elasticsearch/indices/nodes/0/_state\r\n[root@analytics_01 _state]# ls -tlr\r\ntotal 116\r\n-rw-r--r--. 1 elasticsearch elasticsearch     89 Sep 20 10:39 node-4.st\r\n-rw-r--r--. 1 elasticsearch elasticsearch 106737 Sep 20 10:54 global-39.st\r\n-rw-r--r--. 1 elasticsearch elasticsearch   4083 Sep 20 10:54 manifest-11.st\r\n```\r\n\r\n[node-4.zip](https://github.com/elastic/elasticsearch/files/3636577/node-4.zip)\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}