{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45370","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45370/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45370/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45370/events","html_url":"https://github.com/elastic/elasticsearch/issues/45370","id":478831409,"node_id":"MDU6SXNzdWU0Nzg4MzE0MDk=","number":45370,"title":"Getting incorrect response from elasticsearch Node.js client v7.2.0 for aggregation query","user":{"login":"kartikchauhan","id":16608281,"node_id":"MDQ6VXNlcjE2NjA4Mjgx","avatar_url":"https://avatars2.githubusercontent.com/u/16608281?v=4","gravatar_id":"","url":"https://api.github.com/users/kartikchauhan","html_url":"https://github.com/kartikchauhan","followers_url":"https://api.github.com/users/kartikchauhan/followers","following_url":"https://api.github.com/users/kartikchauhan/following{/other_user}","gists_url":"https://api.github.com/users/kartikchauhan/gists{/gist_id}","starred_url":"https://api.github.com/users/kartikchauhan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kartikchauhan/subscriptions","organizations_url":"https://api.github.com/users/kartikchauhan/orgs","repos_url":"https://api.github.com/users/kartikchauhan/repos","events_url":"https://api.github.com/users/kartikchauhan/events{/privacy}","received_events_url":"https://api.github.com/users/kartikchauhan/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-08-09T07:05:28Z","updated_at":"2019-09-13T15:15:47Z","closed_at":"2019-09-13T15:15:47Z","author_association":"NONE","active_lock_reason":null,"body":"I am sending a nested aggregation query on a nested object using the Node.js client v7.2.0 for elasticsearch. While executing the query on Node.js client, i am getting all the records for that index and not the filtered result with aggregation. Executing the same query using kibana or curl provides the expected result. \r\n\r\nQuery :- \r\n\r\n    const client = new Client({ node: 'http://localhost:9200' });\r\n\r\n    let body = {\r\n      \"size\": 0,\r\n      \"query\": {\r\n          \"bool\": {\r\n              \"must\": [\r\n                  {\r\n                      \"nested\": {\r\n                          \"path\": \"doc.parentKey\",\r\n                          \"query\": {\r\n                              \"bool\": {\r\n                                  \"must\": [\r\n                                      {\r\n                                          \"term\": {\r\n                                              \"doc.parentKey.name.keyword\": \"Name1\"\r\n                                          }\r\n                                      }\r\n                                  ]\r\n                              }\r\n                          }\r\n                      }\r\n                  },\r\n                  {\r\n                      \"term\": {\r\n                          \"doc.owner.keyword\": \"0aa7b933-eab1-4939-b4d2-38c2d0602cba\"\r\n                      }\r\n                  }\r\n              ]\r\n          }\r\n      },\r\n      \"aggs\": {\r\n          \"parentKey\": {\r\n              \"nested\": {\r\n                  \"path\": \"doc.parentKey\"\r\n              },\r\n              \"aggs\": {\r\n                  \"response\": {\r\n                      \"aggs\": {\r\n                          \"name\": {\r\n                              \"terms\": {\r\n                                  \"field\": \"doc.parentKey.name.keyword\"\r\n                              },\r\n                              \"aggs\": {\r\n                                  \"value\": {\r\n                                      \"terms\": {\r\n                                          \"field\": \"doc.parentKey.value.keyword\"\r\n                                      }\r\n                                  }\r\n                              }\r\n                          }\r\n                      },\r\n                      \"filter\": {\r\n                          \"term\": {\r\n                              \"doc.parentKey.name.keyword\": \"Name1\"\r\n                          }\r\n                      }\r\n                  }\r\n              }\r\n          }\r\n      }\r\n    }\r\n    let {body: response} = await client.search({index: 'test-index', body});\r\n\r\nExpected result (Getting this from kibana and curl)\r\n\r\n    {\r\n      \"took\" : 47,\r\n      \"timed_out\" : false,\r\n      \"_shards\" : {\r\n        \"total\" : 1,\r\n        \"successful\" : 1,\r\n        \"skipped\" : 0,\r\n        \"failed\" : 0\r\n      },\r\n      \"hits\" : {\r\n        \"total\" : {\r\n          \"value\" : 131,\r\n          \"relation\" : \"eq\"\r\n        },\r\n        \"max_score\" : null,\r\n        \"hits\" : [ ]\r\n      },\r\n      \"aggregations\" : {\r\n        \"parentKey\" : {\r\n          \"doc_count\" : 10218,\r\n          \"response\" : {\r\n            \"doc_count\" : 131,\r\n            \"name\" : {\r\n              \"doc_count_error_upper_bound\" : 0,\r\n              \"sum_other_doc_count\" : 0,\r\n              \"buckets\" : [\r\n                {\r\n                  \"key\" : \"Name1\",\r\n                  \"doc_count\" : 131,\r\n                  \"value\" : {\r\n                    \"doc_count_error_upper_bound\" : 0,\r\n                    \"sum_other_doc_count\" : 0,\r\n                    \"buckets\" : [\r\n                      {\r\n                        \"key\" : \"Value1\",\r\n                        \"doc_count\" : 131\r\n                      }\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n    \r\nResult from Node.js client \r\n\r\n    {\r\n        \"body\": {\r\n            \"took\": 1277,\r\n            \"timed_out\": false,\r\n            \"_shards\": {\r\n                \"total\": 1,\r\n                \"successful\": 1,\r\n                \"skipped\": 0,\r\n                \"failed\": 0\r\n            },\r\n            \"hits\": {\r\n                \"total\": {\r\n                    \"value\": 10000,\r\n                    \"relation\": \"gte\"\r\n                },\r\n                \"max_score\": 1,\r\n                \"hits\": [\r\n                    {\r\n                        \"_index\": \"indexName\",\r\n                        \"_type\": \"_doc\",\r\n                        \"_id\": \"2f0e4524-1203-40a6-8527-aa980fc349a7[8196858]\",\r\n                        \"_score\": 1,\r\n                        \"_source\": {\r\n                            \"doc\": {\r\n                                \"owner\": \"059d2569-f268-417f-906b-cbed1f6fbcec\",\r\n                                \"parentKey\": [\r\n                                    {\r\n                                        \"value\": \"Value3\",\r\n                                        \"name\": \"Name3\"\r\n                                    },\r\n                                    {\r\n                                        \"value\": \"Value4\",\r\n                                        \"name\": \"Name4\"\r\n                                    }\r\n                                ]\r\n                            },\r\n                            \"@version\": \"1\",\r\n                            \"doc_as_upsert\": true,\r\n                            \"@timestamp\": \"2019-07-31T09:29:27.644Z\"\r\n                        }\r\n                    },\r\n                    {\r\n                        \"_index\": \"indexName\",\r\n                        \"_type\": \"_doc\",\r\n                        \"_id\": \"6f5652a3-8b33-4c53-8bea-316e8ab1b8c5[8201864]\",\r\n                        \"_score\": 1,\r\n                        \"_source\": {\r\n                            \"doc\": {\r\n                                \"owner\": \"71a83599-1751-4fa4-896a-46b644f29a50\"\r\n                                \"parentKey\": [\r\n                                    {\r\n                                        \"value\": \"Value1\",\r\n                                        \"name\": \"Name1\"\r\n                                    },\r\n                                    {\r\n                                        \"value\": \"Value2\",\r\n                                        \"name\": \"Name2\"\r\n                                    }\r\n                                ]\r\n                            },\r\n                            \"@version\": \"1\",\r\n                            \"doc_as_upsert\": true,\r\n                            \"@timestamp\": \"2019-07-31T09:29:33.795Z\"\r\n                        }\r\n                    }\r\n                ]\r\n            }\r\n        },\r\n        \"statusCode\": 200,\r\n        \"headers\": {\r\n            \"content-type\": \"application/json; charset=UTF-8\",\r\n            \"date\": \"Thu, 08 Aug 2019 13:27:15 GMT\",\r\n            \"server\": \"nginx/1.12.2\",\r\n            \"content-length\": \"113899\",\r\n            \"connection\": \"keep-alive\"\r\n        },\r\n        \"warnings\": null,\r\n        \"meta\": {\r\n            \"context\": null,\r\n            \"request\": {\r\n                \"params\": {\r\n                    \"method\": \"GET\",\r\n                    \"path\": \"/indexName/_search\",\r\n                    \"body\": \"\",\r\n                    \"querystring\": \"\",\r\n                    \"headers\": {\r\n                        \"User-Agent\": \"elasticsearch-js/7.3.0 (linux 3.10.0-862.9.1.el7.x86_64-x64; Node.js v8.9.4)\",\r\n                        \"Content-Type\": \"application/json\",\r\n                        \"Content-Length\": \"0\"\r\n                    },\r\n                    \"timeout\": 30000\r\n                },\r\n                \"options\": {\r\n                    \"size\": 0,\r\n                    \"aggs\": {\r\n                        \"parentKey\": {\r\n                            \"nested\": {\r\n                                \"path\": \"doc.parentKey\"\r\n                            },\r\n                            \"aggs\": {\r\n                                \"response\": {\r\n                                    \"aggs\": {\r\n                                        \"name\": {\r\n                                            \"terms\": {\r\n                                                \"field\": \"doc.parentKey.name.keyword\"\r\n                                            },\r\n                                            \"aggs\": {\r\n                                                \"value\": {\r\n                                                    \"terms\": {\r\n                                                        \"field\": \"doc.parentKey.value.keyword\"\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    },\r\n                                    \"filter\": {\r\n                                        \"term\": {\r\n                                            \"doc.parentKey.name.keyword\": \"63bb04a3eb41417e8d0e61e074293581\"\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    },\r\n                    \"warnings\": null\r\n                },\r\n                \"id\": 1\r\n            },\r\n            \"name\": \"elasticsearch-js\",\r\n            \"connection\": {\r\n                \"url\": \"http://elasticsearch\",\r\n                \"id\": \"http://elasticsearch\",\r\n                \"headers\": {},\r\n                \"deadCount\": 0,\r\n                \"resurrectTimeout\": 0,\r\n                \"_openRequests\": 0,\r\n                \"status\": \"alive\",\r\n                \"roles\": {\r\n                    \"master\": true,\r\n                    \"data\": true,\r\n                    \"ingest\": true,\r\n                    \"ml\": false\r\n                }\r\n            },\r\n            \"attempts\": 0,\r\n            \"aborted\": false\r\n        }\r\n    }\r\n\r\nThe response from Node.js client is truncated(the response consisted of 10 objects inside hits.hits array which we would also get by running match_all for this index)","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}