{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7971","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7971/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7971/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7971/events","html_url":"https://github.com/elastic/elasticsearch/issues/7971","id":44793973,"node_id":"MDU6SXNzdWU0NDc5Mzk3Mw==","number":7971,"title":"Strange `filter` aggregation behavior","user":{"login":"golubev","id":951364,"node_id":"MDQ6VXNlcjk1MTM2NA==","avatar_url":"https://avatars0.githubusercontent.com/u/951364?v=4","gravatar_id":"","url":"https://api.github.com/users/golubev","html_url":"https://github.com/golubev","followers_url":"https://api.github.com/users/golubev/followers","following_url":"https://api.github.com/users/golubev/following{/other_user}","gists_url":"https://api.github.com/users/golubev/gists{/gist_id}","starred_url":"https://api.github.com/users/golubev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/golubev/subscriptions","organizations_url":"https://api.github.com/users/golubev/orgs","repos_url":"https://api.github.com/users/golubev/repos","events_url":"https://api.github.com/users/golubev/events{/privacy}","received_events_url":"https://api.github.com/users/golubev/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-10-03T11:31:34Z","updated_at":"2014-10-16T09:53:08Z","closed_at":"2014-10-15T15:50:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Currently I am observing a strange behavior of the `filter` aggregation that contradicts with the documentaion in my mind. In the [reference](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-bucket-filter-aggregation.html) it is stated that `filter` aggregation:\n\n> Defines a single bucket of all the documents in the current document set context that match a specified filter. Often this will be used to narrow down the current aggregation context to a specific set of documents.\n\nOK, so one may think that a filter, used in the `filter` aggregation narrows down the whole document set that in its turn may be composed using a `query` and (or) a `filter`.\n\nNow, let me provide an example. Suppose we have a set of realty ads and we want to know the max and the min price of flats that have only one room. We deal with real data and price can be empty (equal to zero) or have any inadequate value. So it is reasonable to wrap `min` and `max` aggregations with another `filter` aggregation that will filter only adequate price values for us. The query will look something like:\n\n``` json\n{\n    \"filter\": {\"term\": {\"room_count\": 1}},\n    \"size\": 0,\n    \"aggregations\" : {\n        \"price\" : {\n            \"filter\" : {\"range\": {\"price\":{\"gte\" : 300000, \"lte\" : 10000000000}}},\n            \"aggregations\" : {\n                \"min\": {\"min\" : { \"field\" : \"price\" }},\n                \"max\": {\"max\" : { \"field\" : \"price\" }}\n            }\n        }\n    }\n}\n```\n\nAnd the result:\n\n``` json\n{\n    \"hits\": {\n        \"total\": 54345\n    },\n    \"aggregations\": {\n        \"price\": {\n            \"doc_count\": 256659,\n            \"min\": {\n                \"value\": 300000\n            },\n            \"max\": {\n                \"value\": 4049215000\n            }\n        }\n    }\n}\n```\n\nThere is something strange in the result above that is not logic for me after reading the manual: the `doc_count` (256659) for the `filter` aggregation (that is supposed to be more narrow) is more than the `total` documents count (54345), but it is supposed that the `doc_count` will be less than the`total`.\n\nOK, after some thinking one may suppose that a filter in the `filter` aggregation is not being applied over the query's `filter` — they do not form a superposition like in the way that may be concluded from the reference. So let's try to do a workaround — append the outer `filter` manually to the `filter` aggregation:\n\n``` json\n{\n    \"filter\": {\"term\": {\"room_count\": 1}},\n    \"size\": 0,\n    \"aggregations\" : {\n        \"price\" : {\n            \"filter\" : {\n                \"and\": [\n                    {\"term\": {\"room_count\": 1}},\n                    {\"range\": {\"price\":{\"gte\" : 300000, \"lte\" : 10000000000}}}\n                ]\n            },\n            \"aggregations\" : {\n                \"min\": {\"min\" : { \"field\" : \"price\" }},\n                \"max\": {\"max\" : { \"field\" : \"price\" }}\n            }\n        }\n    }\n}\n```\n\nAnd we get the result:\n\n``` json\n{\n    \"hits\": {\n        \"total\": 54345\n    },\n    \"aggregations\": {\n        \"price\": {\n            \"doc_count\": 34167,\n            \"min\": {\n                \"value\": 320000\n            },\n            \"max\": {\n                \"value\": 2011623600\n            }\n        }\n    }\n}\n```\n\nThat looks more like a true result. The `doc_count` is now less than the `total`. The `min` and the `max` values had changed too.\n\nDon't you think that something may be wrong: the aggregations manual or the `filter` aggregation's implementation?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}