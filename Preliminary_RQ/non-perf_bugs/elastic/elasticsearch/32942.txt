{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32942","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32942/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32942/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32942/events","html_url":"https://github.com/elastic/elasticsearch/issues/32942","id":351579139,"node_id":"MDU6SXNzdWUzNTE1NzkxMzk=","number":32942,"title":"Stack overflow during parsing of SQL causes elasticsearch service to crash","user":{"login":"AdiJurca","id":7048054,"node_id":"MDQ6VXNlcjcwNDgwNTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/7048054?v=4","gravatar_id":"","url":"https://api.github.com/users/AdiJurca","html_url":"https://github.com/AdiJurca","followers_url":"https://api.github.com/users/AdiJurca/followers","following_url":"https://api.github.com/users/AdiJurca/following{/other_user}","gists_url":"https://api.github.com/users/AdiJurca/gists{/gist_id}","starred_url":"https://api.github.com/users/AdiJurca/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/AdiJurca/subscriptions","organizations_url":"https://api.github.com/users/AdiJurca/orgs","repos_url":"https://api.github.com/users/AdiJurca/repos","events_url":"https://api.github.com/users/AdiJurca/events{/privacy}","received_events_url":"https://api.github.com/users/AdiJurca/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":962378555,"node_id":"MDU6TGFiZWw5NjIzNzg1NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.5.0","name":"v6.5.0","color":"Dddddd","default":false,"description":""},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"assignees":[{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-08-17T12:42:31Z","updated_at":"2019-02-07T08:23:11Z","closed_at":"2018-09-25T17:20:26Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.3.0, Build: default/rpm/424e937/2018-06-11T23:38:03.357887Z, JVM: 1.8.0_121\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_121\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_121-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux se10tsnbe06.tclk.se.om.com 3.10.0-693.11.6.el7.x86_64 #1 SMP Thu Dec 28 14:23:39 EST 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning a query that has many OR expressions(in lac of IN clause) through the JDBC driver causes a stack overflow while parsing the SQL which crashes the instance of elasticsearch.\r\n\r\nIt's probably not ok to have a query with so many OR expression, but in lack of an IN clause we did what we could. But we would expect that this does not to crash the entire node. \r\n\r\n[stack_overflow_crash_files.zip](https://github.com/elastic/elasticsearch/files/2297201/stack_overflow_crash_files.zip)\r\n\r\n**Steps to reproduce**:\r\n 1. Create an index with given mapping (attached file: index_mapping.json)\r\n 2. Perform given query through JDBC(attachd file: crashy.sql) \r\n 3. Notice at least one node in the cluster goes down.\r\n\r\n**Provide logs (if relevant)**:\r\n[2018-08-16T17:41:34,222][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [SDD-N3] fatal error in thread [Thread-18], exiting\r\njava.lang.StackOverflowError: null\r\n        at org.elasticsearch.xpack.sql.parser.SqlBaseParser$LogicalBinaryContext.accept(SqlBaseParser.java:2742) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.AbstractBuilder.typedParsing(AbstractBuilder.java:40) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.ExpressionBuilder.expression(ExpressionBuilder.java:101) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.ExpressionBuilder.visitLogicalBinary(ExpressionBuilder.java:410) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.SqlBaseParser$LogicalBinaryContext.accept(SqlBaseParser.java:2742) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.AbstractBuilder.typedParsing(AbstractBuilder.java:40) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.ExpressionBuilder.expression(ExpressionBuilder.java:101) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.ExpressionBuilder.visitLogicalBinary(ExpressionBuilder.java:410) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.SqlBaseParser$LogicalBinaryContext.accept(SqlBaseParser.java:2742) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.parser.AbstractBuilder.typedParsing(AbstractBuilder.java:40) ~[?:?]\r\nâ€¦\r\n\r\n","closed_by":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"performed_via_github_app":null}