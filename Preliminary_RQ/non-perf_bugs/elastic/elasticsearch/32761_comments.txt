[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/411962935","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-411962935","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":411962935,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMTk2MjkzNQ==","user":{"login":"boicehuang","id":4607177,"node_id":"MDQ6VXNlcjQ2MDcxNzc=","avatar_url":"https://avatars3.githubusercontent.com/u/4607177?v=4","gravatar_id":"","url":"https://api.github.com/users/boicehuang","html_url":"https://github.com/boicehuang","followers_url":"https://api.github.com/users/boicehuang/followers","following_url":"https://api.github.com/users/boicehuang/following{/other_user}","gists_url":"https://api.github.com/users/boicehuang/gists{/gist_id}","starred_url":"https://api.github.com/users/boicehuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boicehuang/subscriptions","organizations_url":"https://api.github.com/users/boicehuang/orgs","repos_url":"https://api.github.com/users/boicehuang/repos","events_url":"https://api.github.com/users/boicehuang/events{/privacy}","received_events_url":"https://api.github.com/users/boicehuang/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T03:13:45Z","updated_at":"2018-08-10T03:13:45Z","author_association":"CONTRIBUTOR","body":"@clintongormley  @elasticmachine ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/411962990","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-411962990","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":411962990,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMTk2Mjk5MA==","user":{"login":"boicehuang","id":4607177,"node_id":"MDQ6VXNlcjQ2MDcxNzc=","avatar_url":"https://avatars3.githubusercontent.com/u/4607177?v=4","gravatar_id":"","url":"https://api.github.com/users/boicehuang","html_url":"https://github.com/boicehuang","followers_url":"https://api.github.com/users/boicehuang/followers","following_url":"https://api.github.com/users/boicehuang/following{/other_user}","gists_url":"https://api.github.com/users/boicehuang/gists{/gist_id}","starred_url":"https://api.github.com/users/boicehuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boicehuang/subscriptions","organizations_url":"https://api.github.com/users/boicehuang/orgs","repos_url":"https://api.github.com/users/boicehuang/repos","events_url":"https://api.github.com/users/boicehuang/events{/privacy}","received_events_url":"https://api.github.com/users/boicehuang/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T03:14:09Z","updated_at":"2018-08-10T07:06:33Z","author_association":"CONTRIBUTOR","body":"Thanks for any help given.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/411964108","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-411964108","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":411964108,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMTk2NDEwOA==","user":{"login":"boicehuang","id":4607177,"node_id":"MDQ6VXNlcjQ2MDcxNzc=","avatar_url":"https://avatars3.githubusercontent.com/u/4607177?v=4","gravatar_id":"","url":"https://api.github.com/users/boicehuang","html_url":"https://github.com/boicehuang","followers_url":"https://api.github.com/users/boicehuang/followers","following_url":"https://api.github.com/users/boicehuang/following{/other_user}","gists_url":"https://api.github.com/users/boicehuang/gists{/gist_id}","starred_url":"https://api.github.com/users/boicehuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boicehuang/subscriptions","organizations_url":"https://api.github.com/users/boicehuang/orgs","repos_url":"https://api.github.com/users/boicehuang/repos","events_url":"https://api.github.com/users/boicehuang/events{/privacy}","received_events_url":"https://api.github.com/users/boicehuang/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T03:22:46Z","updated_at":"2018-08-10T09:29:14Z","author_association":"CONTRIBUTOR","body":"Not only I have encountered the same problem, eager for any help. Is there any method or circuit breaker to control or reduce the field data cache of keyword fields when running a huge-buckets terms aggregation? \r\n\r\nhttps://discuss.elastic.co/t/when-can-keyword-field-with-doc-values-enabled-consume-fielddata-cache/127146","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412025097","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-412025097","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":412025097,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjAyNTA5Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T09:09:46Z","updated_at":"2018-08-10T09:09:46Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412030444","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-412030444","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":412030444,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjAzMDQ0NA==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T09:30:59Z","updated_at":"2018-08-10T09:30:59Z","author_association":"CONTRIBUTOR","body":"The `fielddata` settings you might pick for a field are only one of several potential contributors to the overall internal fielddata accounting that is reported. \r\n\r\nEven if you don't select to use fielddata in your mapping certain actions may cause other field-related structures to be loaded into memory e.g. your `terms` aggregation may have triggered the use of a global ordinals map under the covers to service the request. These costs fall under the umbrella of fielddata-related stats and the 3% setting you have is probably low for the aggregations you're doing.\r\n\r\nIt's also worth noting that the fielddata circuit breaker is not the one tripping here anyway - it's the request circuit breaker and its doing the right thing as you're trying to run a very memory heavy aggregation and the circuit breaker is stopping it based on the defined limits for a request.\r\n\r\nClosing as \"not a bug\" with fielddata.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412033121","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-412033121","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":412033121,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjAzMzEyMQ==","user":{"login":"boicehuang","id":4607177,"node_id":"MDQ6VXNlcjQ2MDcxNzc=","avatar_url":"https://avatars3.githubusercontent.com/u/4607177?v=4","gravatar_id":"","url":"https://api.github.com/users/boicehuang","html_url":"https://github.com/boicehuang","followers_url":"https://api.github.com/users/boicehuang/followers","following_url":"https://api.github.com/users/boicehuang/following{/other_user}","gists_url":"https://api.github.com/users/boicehuang/gists{/gist_id}","starred_url":"https://api.github.com/users/boicehuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boicehuang/subscriptions","organizations_url":"https://api.github.com/users/boicehuang/orgs","repos_url":"https://api.github.com/users/boicehuang/repos","events_url":"https://api.github.com/users/boicehuang/events{/privacy}","received_events_url":"https://api.github.com/users/boicehuang/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T09:41:21Z","updated_at":"2018-08-10T09:49:56Z","author_association":"CONTRIBUTOR","body":"@markharwood  it's the parent circuit breaker takes effects, not request circuit breaker, is that reasonableï¼Ÿ And the memory used by field data cache has not been released for a long time even after the aggregation is killed by breaker , which continuously causes normal requests to the cluster to be rejected by parent circuit breaker.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412036311","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-412036311","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":412036311,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjAzNjMxMQ==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2018-08-10T09:54:48Z","updated_at":"2018-08-10T09:54:48Z","author_association":"CONTRIBUTOR","body":">the memory used by field data cache has not been released for a long time\r\n\r\nThe global ordinals map is a `term -> unique number` map that can be reused across requests so it's going to be heavy. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/440594813","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-440594813","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":440594813,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MDU5NDgxMw==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2018-11-21T09:27:13Z","updated_at":"2018-11-21T09:28:07Z","author_association":"CONTRIBUTOR","body":"> The global ordinals map is a `term -> unique number` map that can be reused across requests so it's going to be heavy.\r\n\r\n@markharwood please do note the docs here (https://www.elastic.co/guide/en/elasticsearch/reference/current/eager-global-ordinals.html) state otherwise. It is also in our experience that global ordinals are not light on memory (and also can take a while to load, depending on cardinality). Maybe it'll be worth changing the docs accordingly, or elaborating more?\r\n\r\nFrom the docs:\r\n\r\n> The loading time of global ordinals depends on the number of terms in a field, but in general it is low, since it source field data has already been loaded. The memory overhead of global ordinals is a small because it is very efficiently compressed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/440601202","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-440601202","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":440601202,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MDYwMTIwMg==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2018-11-21T09:47:37Z","updated_at":"2018-11-21T09:47:37Z","author_association":"CONTRIBUTOR","body":"> please do note the docs here \r\n\r\nMy bad. Believe the docs not me :)\r\nSo it's a `segment term ordinal -> global term ordinal` map.\r\n\r\n>in our experience that global ordinals are not light on memory (and also can take a while to load,\r\n\r\nWe have logic that tries to automatically guess the best execution strategy but when I run selective queries I find setting `execution_hint` to `map` is often a useful guiding hand.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/440607209","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-440607209","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":440607209,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MDYwNzIwOQ==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2018-11-21T10:07:32Z","updated_at":"2018-11-21T10:07:32Z","author_association":"CONTRIBUTOR","body":"> Believe the docs not me :)\r\n\r\nYou were wrong about the mapping, not about the timings which is what I referred to... Like I said our tests show exactly what you described for high cardinality fields. I'm not aware of any monitoring / APIs which reflect on the size of that thing, and it seems to take us ~15m to load global ordinals and ~5GB on-heap for a single field from single index which is bad.\r\n\r\nWhat's more curious is that some other datatypes seem to load slower (terms agg on ip datatype is ~20% slower than keyword datatype, for some reason).\r\n\r\nI'm going to create a discussion on the forums about this soon, as this is rather unexpected and throws me back to pre-2.x days :( , but any help appreciated\r\n\r\n> We have logic that tries to automatically guess the best execution strategy but when I run selective queries I find setting execution_hint to map is often a useful guiding hand.\r\n\r\nYup, this was my fallback as well. The following disclaimer in the docs worries me, though:\r\n\r\n> Please note that Elasticsearch will ignore this execution hint if it is not applicable and that there is no backward compatibility guarantee on these hints.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/442014154","html_url":"https://github.com/elastic/elasticsearch/issues/32761#issuecomment-442014154","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","id":442014154,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MjAxNDE1NA==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2018-11-27T10:49:25Z","updated_at":"2018-11-27T10:49:25Z","author_association":"CONTRIBUTOR","body":"@markharwood moved the discussion to the forums (https://discuss.elastic.co/t/global-ordinals-performance-and-size-on-heap/158320) , will greatly appreciate your input!","performed_via_github_app":null}]