[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525204398","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-525204398","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":525204398,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTIwNDM5OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T08:45:53Z","updated_at":"2019-08-27T08:45:53Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/526142532","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-526142532","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":526142532,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNjE0MjUzMg==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2019-08-29T11:22:08Z","updated_at":"2019-08-29T11:42:38Z","author_association":"CONTRIBUTOR","body":"Two more failures: \r\n - Log: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/os=windows-2016/107/console Build scan: https://gradle-enterprise.elastic.co/s/ap7zbfvwrhm7i\r\n- Log: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/os=windows-2012-r2/107/console Build scan: https://gradle-enterprise.elastic.co/s/fb3uxkh6kfj4o","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/526143137","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-526143137","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":526143137,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNjE0MzEzNw==","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"created_at":"2019-08-29T11:24:15Z","updated_at":"2019-08-29T11:24:15Z","author_association":"CONTRIBUTOR","body":"Same error for `:x-pack:plugin:ccr:qa:restart:followClusterRestartTest`\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/os=windows-2019/107/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/527018467","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-527018467","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":527018467,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNzAxODQ2Nw==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-09-02T06:25:37Z","updated_at":"2019-09-02T06:37:57Z","author_association":"CONTRIBUTOR","body":"Similar error here, though not identical it looks like the same underlying issue:\r\n\r\nhttps://gradle-enterprise.elastic.co/s/5tp5vjeeruqqk/failure?openFailures=WzBd&openStackTraces=WzFd#top=0\r\n\r\n```\r\nUnable to delete directory 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro'\r\n  Failed to delete some children. This might happen because a process has files open or has its working directory set in the target directory.\r\n  - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_date_time-vc141-mt-1_65_1.dll\r\n  - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_filesystem-vc141-mt-1_65_1.dll\r\n```\r\n\r\nFailed around 5 times over the weekend with same/similar error.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/527082351","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-527082351","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":527082351,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNzA4MjM1MQ==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2019-09-02T09:47:27Z","updated_at":"2019-09-02T09:47:27Z","author_association":"CONTRIBUTOR","body":"Looking at one of the stack traces of the failure:\r\n```\r\nat org.elasticsearch.gradle.testclusters.ElasticsearchNode.syncWithLinks(ElasticsearchNode.java:887)\r\nat org.elasticsearch.gradle.testclusters.ElasticsearchNode.createWorkingDir(ElasticsearchNode.java:869)\r\nat org.elasticsearch.gradle.testclusters.ElasticsearchNode.start(ElasticsearchNode.java:395)\r\nat org.elasticsearch.gradle.testclusters.ElasticsearchNode.restart(ElasticsearchNode.java:474)\r\nat org.elasticsearch.gradle.testclusters.ElasticsearchNode.goToNextVersion(ElasticsearchNode.java:486)\r\nat org.gradle.api.internal.DefaultDomainObjectCollection.all(DefaultDomainObjectCollection.java:158)\r\nat org.elasticsearch.gradle.testclusters.ElasticsearchCluster.goToNextVersion(ElasticsearchCluster.java:277)\r\n```\r\n\r\nA restart operation is implemented as a `stop` followed by a `start`. \r\nThe `start` does some cleanup if files exist. It's this cleanup that fails because some files can't be deleted possibly because they are still open. \r\nThe stop does a recursive walk of processes so it's unlikely that processes linger. \r\nI have encountered this in testing some time ago [here](https://github.com/elastic/elasticsearch/pull/36475#discussion_r243624223).\r\n@rjernst would you agree to add a wait and retry in case the cleanup fails here ?  \r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/527408496","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-527408496","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":527408496,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNzQwODQ5Ng==","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"created_at":"2019-09-03T10:54:13Z","updated_at":"2019-09-03T10:54:13Z","author_association":"CONTRIBUTOR","body":"another one: https://gradle-enterprise.elastic.co/s/jsaajm7ezmr6q","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/527562548","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-527562548","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":527562548,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNzU2MjU0OA==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2019-09-03T17:38:50Z","updated_at":"2019-09-03T17:38:50Z","author_association":"MEMBER","body":"> The start does some cleanup if files exist. It's this cleanup that fails because some files can't be deleted possibly because they are still open.\r\n\r\nHow can they still be open? It looks like we always do a SIGKILL in this case, and even if we were doing a SIGTERM, there is logic in stop to wait on the pid. Retrying seems like it would be masking a different issue we need to identify.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/527814417","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-527814417","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":527814417,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNzgxNDQxNw==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2019-09-04T09:10:03Z","updated_at":"2019-09-04T09:10:03Z","author_association":"CONTRIBUTOR","body":"@rjernst \r\nMy understanding is that the fact that the process is no longer there doesn't guarantee that it's resources were closed. Not on windows. So if we stop elasticsearch and try to remove the files it was using in quick succession there's no way to have a guarantee that  those files were closed. \r\nOf course there's no way to know if the OS hasn't released the resources yet or there's something lurking, so I understand your concern, but I think a retry with a short timeout ( e.x. we try to delete for 5 seconds max before we give up ) would work if the OS is lagging behind but is not likely to help if there are processes lurking. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/529420468","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-529420468","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":529420468,"node_id":"MDEyOklzc3VlQ29tbWVudDUyOTQyMDQ2OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-09-09T11:08:27Z","updated_at":"2019-09-09T11:08:27Z","author_association":"CONTRIBUTOR","body":"There is a variation on this in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/os=windows-2019/129/console\r\n\r\n```\r\n> Unable to delete directory 'C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro'\r\n    Failed to delete some children. This might happen because a process has files open or has its working directory set in the target directory.\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_date_time-vc141-mt-x64-1_71.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_filesystem-vc141-mt-x64-1_71.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_iostreams-vc141-mt-x64-1_71.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_program_options-vc141-mt-x64-1_71.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\boost_regex-vc141-mt-x64-1_71.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\controller.exe\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\libapr-1.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\libapriconv-1.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\libaprutil-1.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\libMlCore.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\libxml2.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\log4cxx.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\msvcp140.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\vcruntime140.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\\zlib1.dll\r\n    - C:\\Users\\jenkins\\workspace\\elastic+elasticsearch+master+multijob-windows-compatibility\\os\\windows-2019\\x-pack\\plugin\\ccr\\qa\\restart\\build\\testclusters\\follow-cluster-0\\distro\\modules\\x-pack-ml\\platform\\windows-x86_64\\bin\r\n    - and more ...\r\n```\r\n\r\nIn this case the process that's stopping the files being deleted is the ML controller process.\r\n\r\nDoing a `TerminateProcess` on the ES JVM will not instantly kill the controller.  Instead the controller notices that its stdin has been disconnected and exits.  But obviously there can be a few milliseconds between brutally killing the ES JVM (but not the controller) and the controller reacting.\r\n\r\n> but I think a retry with a short timeout ( e.x. we try to delete for 5 seconds max before we give up )\r\n\r\n5 seconds should be ample for the controller to notice that the ES JVM has died and exit by itself (especially given that this problem is fairly rare even without any retries).\r\n\r\nThe only other alternative would be for the testclusters code to kill the controller explicitly as well as the JVM before cleaning up installation directories.  But if multiple clusters are running in parallel that may not be easy.  It would need to kill the controller whose parent process is the JVM.  If it killed all processes named `controller.exe` then it would cripple the other clusters running in parallel on the same machine.  So retrying for up to 5 seconds is probably simpler.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/529434357","html_url":"https://github.com/elastic/elasticsearch/issues/46014#issuecomment-529434357","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46014","id":529434357,"node_id":"MDEyOklzc3VlQ29tbWVudDUyOTQzNDM1Nw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-09-09T11:48:11Z","updated_at":"2019-09-09T11:48:11Z","author_association":"CONTRIBUTOR","body":"Another one like the original issue description, i.e. due to `.jar` files rather than the ML controller: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/os=windows-2016/129/console","performed_via_github_app":null}]