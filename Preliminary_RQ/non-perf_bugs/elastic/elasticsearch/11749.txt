{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11749","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11749/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11749/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11749/events","html_url":"https://github.com/elastic/elasticsearch/issues/11749","id":89294406,"node_id":"MDU6SXNzdWU4OTI5NDQwNg==","number":11749,"title":"Aggregations: nested filter aggregation with nested filter returning no results","user":{"login":"crutch","id":119724,"node_id":"MDQ6VXNlcjExOTcyNA==","avatar_url":"https://avatars0.githubusercontent.com/u/119724?v=4","gravatar_id":"","url":"https://api.github.com/users/crutch","html_url":"https://github.com/crutch","followers_url":"https://api.github.com/users/crutch/followers","following_url":"https://api.github.com/users/crutch/following{/other_user}","gists_url":"https://api.github.com/users/crutch/gists{/gist_id}","starred_url":"https://api.github.com/users/crutch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/crutch/subscriptions","organizations_url":"https://api.github.com/users/crutch/orgs","repos_url":"https://api.github.com/users/crutch/repos","events_url":"https://api.github.com/users/crutch/events{/privacy}","received_events_url":"https://api.github.com/users/crutch/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":17,"created_at":"2015-06-18T13:31:13Z","updated_at":"2019-11-15T11:02:15Z","closed_at":"2016-07-26T07:21:33Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nI am not able to combine normal (e.g., `term filter`) with `nested filter` in `filter aggregation` which is itself nested in `nested aggregation`.\n\nMapping: `tasks` with nested `events`, `events` with nested `parameters`.\n\n<pre>\ncurl -XPUT 'localhost:9200/nestingtest/' -d '\n{\n  \"mappings\": {\n    \"tasks\": {\n      properties: {\n        task_id: {\n          type: \"long\",\n          doc_values: true\n        },\n        events: {\n          type: \"nested\",\n          properties: {\n            id: {\n              type: \"long\",\n              doc_values: true\n            },\n            parameters: {\n              type: \"nested\",\n              properties: {\n                name: {\n                  type: \"string\",\n                  index: \"not_analyzed\",\n                  doc_values: true\n                },\n                value: {\n                  type: \"string\",\n                  index: \"not_analyzed\",\n                  doc_values: true\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n'\n</pre>\n\nData:\n\n<pre>\ncurl -XPOST 'localhost:9200/nestingtest/tasks/1' -d '\n{\n  task_id: 1,\n  events: [\n    {\n      id: 1,\n      parameters: {\n        name: \"attribution\",\n        value: \"campaignX\"\n      }\n    }\n  ]\n}\n'\n\ncurl -XPOST 'localhost:9200/nestingtest/tasks/2' -d '\n{\n  task_id: 2,\n  events: [\n    {\n      id: 21,\n      parameters: [\n        {\n          name: \"attribution\",\n          value: \"campaignY\"\n        }\n      ]\n    },\n    {\n      id: 22,\n      parameters: {\n        name: \"attribution\",\n        value: \"campaignY\"\n      }\n    }\n  ]\n}\n'\n</pre>\n\n\nQuery that does not work as expected:\n\n<pre>\ncurl -XPOST 'localhost:9200/nestingtest/tasks/_search' -d '\n{\n  size: 0,\n  aggs: {\n    \"to-events\": {\n      nested: {\n        path: \"events\"\n      },\n      aggs: {\n        filtered: {\n          filter: {\n            nested: {\n              path: \"events.parameters\",\n              filter: {\n                term: {\n                  \"events.parameters.value\": \"campaignX\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n'\n</pre>\n\n\nResponse:\n\n<pre>\n\"aggregations\": {\n  \"to-events\": {\n    \"doc_count\": 3,\n    \"filtered\": {\n      \"doc_count\": 0 //this is wrong, should be 1\n    }\n  }\n}\n</pre>\n\n\nIf I change the query to use the `nested aggregation`, the results are as expected:\n\n<pre>\ncurl -XPOST 'localhost:9200' -d '\n{\n  size: 0,\n  aggs: {\n    \"to-events\": {\n      nested: {\n        path: \"events\"\n      },\n      aggs: {\n        \"to-parameters\": {\n          nested: {\n            path: \"events.parameters\"\n          },\n          aggs: {\n            filtered: {\n              filter: {\n                term: {\n                  \"events.parameters.value\": \"campaignX\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n</pre>\n\nResponse:\n\n<pre>\n\"aggregations\": {\n      \"to-events\": {\n         \"doc_count\": 3,\n         \"to-parameters\": {\n            \"doc_count\": 3,\n            \"filtered\": {\n               \"doc_count\": 1\n            }\n         }\n      }\n   }\n</pre>\n\n\nUsing `nested aggregation` is not an ideal solution for me, as I would like to combine that `nested filter` with other filters acting at the level of events, get one number of matched documents and then dive into sub-aggs for those documents.\n# \n\n<pre>\n\"version\" : {\n    \"number\" : \"1.6.0\",\n    \"build_hash\" : \"cdd3ac4dde4f69524ec0a14de3828cb95bbb86d0\",\n    \"build_timestamp\" : \"2015-06-09T13:36:34Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  }\n</pre>\n\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}