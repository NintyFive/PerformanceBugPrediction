{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30261","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30261/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30261/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30261/events","html_url":"https://github.com/elastic/elasticsearch/issues/30261","id":318890816,"node_id":"MDU6SXNzdWUzMTg4OTA4MTY=","number":30261,"title":"Causes of XContentParseException should be included in search for root_cause","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":753477051,"node_id":"MDU6TGFiZWw3NTM0NzcwNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.3.0","name":"v6.3.0","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2018-04-30T13:31:39Z","updated_at":"2018-05-01T11:44:59Z","closed_at":"2018-05-01T11:44:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Following #29373 parse exceptions are now `XContentParseException` rather than `ParsingException`.  This has a major effect on the determination of the `root_cause` of an exception that is found during parsing due to the definition of `root_cause`.\r\n\r\nThe `root_cause` is determined by starting at the outermost exception and recursing through the causes until an exception is found that is _not_ an `ElasticsearchException`.  Then:\r\n\r\n* If the outermost exception was not an `ElasticsearchException` then it is the `root_cause`\r\n* Otherwise the most deeply nested `ElasticsearchException` is the `root_cause`\r\n\r\n`ParsingException` extends `ElasticsearchException` whereas `XContentParseException` does not.\r\n\r\nThis means that if a validation error occurs during parsing then following #29373 the most general parsing exception is reported as the root cause.  Prior to #29373 the most specific parsing exception, i.e. most likely the one detailing the validation error, was considered the `root_cause`.\r\n\r\nAs a concrete example, this is a validation error after #29373:\r\n\r\n```\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [{\r\n            \"type\": \"x_content_parse_exception\",\r\n            \"reason\": \"[1:144] [job_details] failed to parse field [analysis_limits]\"\r\n        }],\r\n        \"type\": \"x_content_parse_exception\",\r\n        \"reason\": \"[1:144] [job_details] failed to parse field [analysis_limits]\",\r\n        \"caused_by\": {\r\n            \"type\": \"x_content_parse_exception\",\r\n            \"reason\": \"Failed to build [analysis_limits] after last required field arrived\",\r\n            \"caused_by\": {\r\n                \"type\": \"status_exception\",\r\n                \"reason\": \"categorization_examples_limit cannot be less than 0. Value = -1\"\r\n            }\r\n        }\r\n    },\r\n    \"status\": 400\r\n}\r\n```\r\n\r\nAnd this is the equivalent error before #29373:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"status_exception\",\r\n        \"reason\": \"categorization_examples_limit cannot be less than 0. Value = -1\"\r\n      }\r\n    ],\r\n    \"type\": \"parsing_exception\",\r\n    \"reason\": \"[job_details] failed to parse field [analysis_limits]\",\r\n    \"line\": 11,\r\n    \"col\": 3,\r\n    \"caused_by\": {\r\n      \"type\": \"parsing_exception\",\r\n      \"reason\": \"Failed to build [analysis_limits] after last required field arrived\",\r\n      \"caused_by\": {\r\n        \"type\": \"status_exception\",\r\n        \"reason\": \"categorization_examples_limit cannot be less than 0. Value = -1\"\r\n      }\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nIf all you have to go on is the `root_cause` then `[1:144] [job_details] failed to parse field [analysis_limits]` is nowhere near as useful as `categorization_examples_limit cannot be less than 0. Value = -1`.  The red error bars that Kibana shows when an error occurs only show the `root_cause`, so Kibana users suffer from this.\r\n\r\nI think the solution that will keep the `root_cause` functionality as it was previously would be to consider both `ElasticsearchException` and `XContentParseException` when recursing through causes.","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}