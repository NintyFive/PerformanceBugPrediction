{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6574","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6574/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6574/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6574/events","html_url":"https://github.com/elastic/elasticsearch/issues/6574","id":36167135,"node_id":"MDU6SXNzdWUzNjE2NzEzNQ==","number":6574,"title":"Snapshot backup utilizing high heap memory and cpu% of es node","user":{"login":"tsaswin","id":7095004,"node_id":"MDQ6VXNlcjcwOTUwMDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/7095004?v=4","gravatar_id":"","url":"https://api.github.com/users/tsaswin","html_url":"https://github.com/tsaswin","followers_url":"https://api.github.com/users/tsaswin/followers","following_url":"https://api.github.com/users/tsaswin/following{/other_user}","gists_url":"https://api.github.com/users/tsaswin/gists{/gist_id}","starred_url":"https://api.github.com/users/tsaswin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsaswin/subscriptions","organizations_url":"https://api.github.com/users/tsaswin/orgs","repos_url":"https://api.github.com/users/tsaswin/repos","events_url":"https://api.github.com/users/tsaswin/events{/privacy}","received_events_url":"https://api.github.com/users/tsaswin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-06-20T13:30:56Z","updated_at":"2014-12-30T20:16:57Z","closed_at":"2014-12-30T20:16:57Z","author_association":"NONE","active_lock_reason":null,"body":"## Snapshot backup utilizing high heap memory and cpu% <h2>\n\nWe have 3 nodes in different servers say, node1 node2 node3, and configured the snapshot repository per cluster on NFS, mounted on all the 3 servers, while executing snapshot the node which is actively taking backup utilizing high heap usage and the node is removing from cluster which let the cluster to go yellow, the same happens in all the cluster running snapshots\n\nSize of the below index is \n\nsize: 19.3G (38.5G)\ndocs: 10,214,293 (11,682,412)\n\n| nodes | heap alloted |\n| --- | --- |\n| node1 | 4GB |\n| node2 | 4GB |\n| node2 | 4GB |\n\n```\nnode 1 : \n\n[2014-06-09 08:12:57,447][INFO ][monitor.jvm              ] [node1] [gc][young][201419][1869] duration [725ms], collections [1]/[1.1s], total [725ms]/[7m], memory [1.6gb]->[1.5gb]/[3.9gb], all_pools {[young] [268.1mb]->[15.4mb]/[382.7mb]}{[survivor] [6.8mb]->[47.8mb]/[47.8mb]}{[old] [1.3gb]->[1.4gb]/[3.5gb]}\n[2014-06-09 11:44:20,392][INFO ][monitor.jvm              ] [node1] [gc][young][214097][1980] duration [706ms], collections [1]/[1.5s], total [706ms]/[7.2m], memory [1.8gb]->[1.7gb]/[3.9gb], all_pools {[young] [303.5mb]->[9.6mb]/[382.7mb]}{[survivor] [47.8mb]->[47.8mb]/[47.8mb]}{[old] [1.5gb]->[1.6gb]/[3.5gb]}\n[2014-06-09 13:39:28,102][INFO ][monitor.jvm              ] [node1] [gc][young][221002][2025] duration [808ms], collections [1]/[1.4s], total [808ms]/[7.3m], memory [1.9gb]->[1.8gb]/[3.9gb], all_pools {[young] [278.9mb]->[7.5mb]/[382.7mb]}{[survivor] [43.2mb]->[47.8mb]/[47.8mb]}{[old] [1.6gb]->[1.7gb]/[3.5gb]}\n[2014-06-09 21:39:54,469][INFO ][monitor.jvm              ] [node1] [gc][young][249819][2158] duration [744ms], collections [1]/[1.3s], total [744ms]/[7.6m], memory [2gb]->[1.9gb]/[3.9gb], all_pools {[young] [252.5mb]->[1.5mb]/[382.7mb]}{[survivor] [18.2mb]->[47.8mb]/[47.8mb]}{[old] [1.8gb]->[1.9gb]/[3.5gb]}\n~                                                                                                                                                                               \n~\n\nnode 2 :\n\n2014-06-08 12:17:13,044][INFO ][cluster.service          ] [node2] removed {[node1][m-lCXG-ATBGWjiDCadnriA][godavari11.sirahu.com][inet[/19.19.20.101:91201]],}, reason: zen-disco-receive(from master [[node3][0yETviCKTROJgTIUSlIRiw][godavari13.sirahu.com][inet[/19.19.20.103:91203]]])\n[2014-06-08 12:18:59,955][INFO ][cluster.service          ] [node2] added {[node1][m-lCXG-ATBGWjiDCadnriA][godavari11.sirahu.com][inet[/19.19.20.101:91201]],}, reason: zen-disco-receive(from master [[node3][0yETviCKTROJgTIUSlIRiw][godavari13.sirahu.com][inet[/19.19.20.103:91203]]])\n[2014-06-08 23:57:11,575][DEBUG][action.search.type       ] [node2] [incides2][1], node[m-lCXG-ATBGWjiDCadnriA], [R], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@59ecb9f2]\norg.elasticsearch.transport.RemoteTransportException: [node1][inet[/19.19.20.101:91201]][search/phase/query+fetch]\nCaused by: org.elasticsearch.search.query.QueryPhaseExecutionException: [incides2][1]: query[ConstantScore(cache(_type:59))],from[0],size[50]: Query Failed [Failed to execute main query]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:127)\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:330)\n\n~                                                                                                                                                                               \n~\n\nnode 3 : \n\n[2014-06-09 07:18:42,428][WARN ][monitor.jvm              ] [node3] [gc][young][198311][2132] duration [1.3s], collections [1]/[3.7s], total [1.3s]/[5.2m], memory [2.3gb]->[930.1mb]/[3.9gb], all_pools {[young] [345.9mb]->[9.9mb]/[382.7mb]}{[survivor] [17.5mb]->[0b]/[47.8mb]}{[old] [2gb]->[920.3mb]/[3.5gb]}\n```\n\nI Tried configuring the below parameters in the staging setup, backup is taking much time than usual\nalso cpu% in top command shows 300%  where 10 - 15% ( at normal state)\n\n```\n curl -XPUT http://ip:port/_snapshot/es-stag -d '{\n    \"type\": \"fs\",\n    \"settings\": {\n        \"location\": \"/mountpath/to/esearch_snapshots/es-stag\",\n        \"compress\": false,\n        \"chunk_size\": \"50m\",\n        \"max_snapshot_bytes_per_sec\": \"100mb\"\n    }\n```\n\nI want to achieve 20 mins snapshot backup without any heap or cpu utilization issue! \n\nPlease help!\n\nThank you in advance\n\n-Aswin\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}