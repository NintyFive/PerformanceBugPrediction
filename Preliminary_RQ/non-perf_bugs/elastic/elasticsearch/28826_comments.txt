[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368504141","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368504141","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368504141,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODUwNDE0MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-26T13:30:05Z","updated_at":"2018-02-27T15:00:49Z","author_association":"MEMBER","body":"@bra-fsn A corrupt index exception with a mismatch segment ID is almost always a system error (usually a hardware error). As such, we are not going to treat this as a bug that requires investigation on our side without ample evidence. Instead, I encourage you to check your systems for hardware issues or other issues that could be corrupting data on disk.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368507884","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368507884","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368507884,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODUwNzg4NA==","user":{"login":"bra-fsn","id":820331,"node_id":"MDQ6VXNlcjgyMDMzMQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820331?v=4","gravatar_id":"","url":"https://api.github.com/users/bra-fsn","html_url":"https://github.com/bra-fsn","followers_url":"https://api.github.com/users/bra-fsn/followers","following_url":"https://api.github.com/users/bra-fsn/following{/other_user}","gists_url":"https://api.github.com/users/bra-fsn/gists{/gist_id}","starred_url":"https://api.github.com/users/bra-fsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bra-fsn/subscriptions","organizations_url":"https://api.github.com/users/bra-fsn/orgs","repos_url":"https://api.github.com/users/bra-fsn/repos","events_url":"https://api.github.com/users/bra-fsn/events{/privacy}","received_events_url":"https://api.github.com/users/bra-fsn/received_events","type":"User","site_admin":false},"created_at":"2018-02-26T13:44:19Z","updated_at":"2018-02-26T13:54:24Z","author_association":"NONE","body":"All servers have ECC RAM and the data is stored on zfs, which doesn't show a checksum error.\r\nThis means this is not a hardware issue, but a software one and it's -if I can trust zfs itself- above zfs, which means the OS/java/lucene/elasticsearch.\r\nIs it possible to check all data files for checksum mismatches? (with a dry-run possibly)\r\n\r\nAlso, can the IDs tell something about the possible source of the error? They are close, but not too close:\r\nid=cge03ew8t5un8p71dbjd9wmv6, got=cge03ew8t5un8p71dbjd9wmwr\r\n\r\nGoogle throws out Lucene bugs too, like this:\r\nhttps://issues.apache.org/jira/browse/SOLR-6640\r\nWhat makes you confident that this isn't a SW bug?\r\n\r\nThanks,","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368510293","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368510293","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368510293,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODUxMDI5Mw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-26T13:53:21Z","updated_at":"2018-02-26T13:53:21Z","author_association":"MEMBER","body":"You can run check index on all of your shards:\r\n\r\n```\r\n$ java -cp <path to elasticsearch lib/lucene-core-7.2.1.jar> -ea:org.apache.lucene... org.apache.lucene.index.CheckIndex <path to folder containing indices/<index UUID>/<shard ID>/index>\r\n```\r\n\r\nYou have to do this over all of your index UUID/shard ID pairs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368514790","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368514790","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368514790,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODUxNDc5MA==","user":{"login":"bra-fsn","id":820331,"node_id":"MDQ6VXNlcjgyMDMzMQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820331?v=4","gravatar_id":"","url":"https://api.github.com/users/bra-fsn","html_url":"https://github.com/bra-fsn","followers_url":"https://api.github.com/users/bra-fsn/followers","following_url":"https://api.github.com/users/bra-fsn/following{/other_user}","gists_url":"https://api.github.com/users/bra-fsn/gists{/gist_id}","starred_url":"https://api.github.com/users/bra-fsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bra-fsn/subscriptions","organizations_url":"https://api.github.com/users/bra-fsn/orgs","repos_url":"https://api.github.com/users/bra-fsn/repos","events_url":"https://api.github.com/users/bra-fsn/events{/privacy}","received_events_url":"https://api.github.com/users/bra-fsn/received_events","type":"User","site_admin":false},"created_at":"2018-02-26T14:09:13Z","updated_at":"2018-02-26T14:09:13Z","author_association":"NONE","body":"I guess this should be run on closed indices only (not with running elasticsearch instances)...\r\nDo you see any possibility to run this on a read-only fs? (snapshot)\r\n\r\nBTW, I've modified my previous comment in between. What could I do to figure out the source of this error?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368532249","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368532249","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368532249,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODUzMjI0OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-26T15:04:47Z","updated_at":"2018-02-26T15:04:47Z","author_association":"MEMBER","body":"First ECC and ZFS do not mean that you are free from hardware errors, and ZFS is software anyway so I'm deeply puzzled by \"this means this is not a hardware issue, but a software one\". \r\n\r\n> Google throws out Lucene bugs too, like this:\r\n>https://issues.apache.org/jira/browse/SOLR-6640\r\n\r\nThat is not a Lucene bug, that is a Solr bug, they did something wrong, not Lucene.\r\n\r\n> What makes you confident that this isn't a SW bug?\r\n\r\nBecause for several years running every corrupt index exception I have seen has been not the fault of Lucene/Elasticsearch.\r\n\r\n> I guess this should be run on closed indices only (not with running elasticsearch instances)...\r\n\r\nYes.\r\n\r\n> Do you see any possibility to run this on a read-only fs? (snapshot)\r\n\r\nThat should be fine.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368814177","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368814177","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368814177,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODgxNDE3Nw==","user":{"login":"bra-fsn","id":820331,"node_id":"MDQ6VXNlcjgyMDMzMQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820331?v=4","gravatar_id":"","url":"https://api.github.com/users/bra-fsn","html_url":"https://github.com/bra-fsn","followers_url":"https://api.github.com/users/bra-fsn/followers","following_url":"https://api.github.com/users/bra-fsn/following{/other_user}","gists_url":"https://api.github.com/users/bra-fsn/gists{/gist_id}","starred_url":"https://api.github.com/users/bra-fsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bra-fsn/subscriptions","organizations_url":"https://api.github.com/users/bra-fsn/orgs","repos_url":"https://api.github.com/users/bra-fsn/repos","events_url":"https://api.github.com/users/bra-fsn/events{/privacy}","received_events_url":"https://api.github.com/users/bra-fsn/received_events","type":"User","site_admin":false},"created_at":"2018-02-27T09:56:08Z","updated_at":"2018-02-27T09:56:08Z","author_association":"NONE","body":"Sorry, I wrote quickly without the needed attention. :)\r\n\r\n> First ECC and ZFS do not mean that you are free from hardware errors, and ZFS is software anyway so I'm deeply puzzled by \"this means this is not a hardware issue, but a software one\".\r\n\r\nWhat I was trying to say here is ECC and ZFS should probably point out a hardware issue here, but it did not.\r\nYes, it could be a ZFS error too, that's also software. :)\r\n\r\n> That is not a Lucene bug, that is a Solr bug, they did something wrong, not Lucene.\r\n\r\nThat's my mistake, I've linked the page then read it and didn't correct the sentence. Couldn't something similar happen here? (even in the replication path)\r\n\r\n\r\n> Because  for several years running every corrupt index exception I have seen has been not the fault of Lucene/Elasticsearch.\r\n\r\nIs it possible to make sure this is the case here? It would be good to track the source of the error down.\r\nIf the file system could report a corruption, I would sleep well. But here it didn't and something must have corrupted the data...\r\n\r\n\r\n>>  Do you see any possibility to run this on a read-only fs? (snapshot)\r\n\r\n> That should be fine.\r\n\r\nIt dies with:\r\n```\r\nOpening index @ index/\r\n\r\nException in thread \"main\" java.nio.file.FileSystemException: /data/elasticsearch/fmprod.9300/data/.zfs/snapshot/idxcorruption/nodes/0/indices/FnCfiv-VSyK5Qd_9-EMGKg/1/index/write.lock: Read-only file system\r\n\tat sun.nio.fs.UnixException.translateToIOException(UnixException.java:91)\r\n\tat sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)\r\n\tat sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)\r\n\tat sun.nio.fs.UnixFileSystemProvider.newFileChannel(UnixFileSystemProvider.java:177)\r\n\tat java.nio.channels.FileChannel.open(FileChannel.java:287)\r\n\tat java.nio.channels.FileChannel.open(FileChannel.java:335)\r\n\tat org.apache.lucene.store.NativeFSLockFactory.obtainFSLock(NativeFSLockFactory.java:125)\r\n\tat org.apache.lucene.store.FSLockFactory.obtainLock(FSLockFactory.java:41)\r\n\tat org.apache.lucene.store.BaseDirectory.obtainLock(BaseDirectory.java:45)\r\n\tat org.apache.lucene.index.CheckIndex.<init>(CheckIndex.java:403)\r\n\tat org.apache.lucene.index.CheckIndex.doMain(CheckIndex.java:2725)\r\n\tat org.apache.lucene.index.CheckIndex.main(CheckIndex.java:2653)\r\n```\r\nWould it be hard to implement a readonly or dryrun command line option for this?\r\nOr can this check work at all on snapshotted, but otherwise open/working elasticsearch shards?\r\n\r\nThanks.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/368909693","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-368909693","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":368909693,"node_id":"MDEyOklzc3VlQ29tbWVudDM2ODkwOTY5Mw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-27T15:10:02Z","updated_at":"2018-02-27T15:10:02Z","author_association":"MEMBER","body":"> Couldn't something similar happen here? (even in the replication path)\r\n\r\nNo, that is not possible, your issue is not occurring in the replication path, but actually on a refresh.\r\n\r\n> Would it be hard to implement a readonly or dryrun command line option for this?\r\n\r\nOh, no. It takes out a lock to ensure the files can not be mutated under it while running check index. That is why it will not work on a read-only filesystem. Sorry for the trouble.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/485710050","html_url":"https://github.com/elastic/elasticsearch/issues/28826#issuecomment-485710050","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28826","id":485710050,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NTcxMDA1MA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2019-04-23T08:48:06Z","updated_at":"2019-04-23T08:48:06Z","author_association":"CONTRIBUTOR","body":"@bra-fsn Would you be able to tell us a bit more about the hardware that you were using when you ran into this error? In particular whether it was a public cloud, or bare metal, whether it used virtualization, what kind of disk you were using, whether you were using hardware RAID, software RAID, etc.?","performed_via_github_app":null}]