{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50241","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50241/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50241/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50241/events","html_url":"https://github.com/elastic/elasticsearch/issues/50241","id":538519952,"node_id":"MDU6SXNzdWU1Mzg1MTk5NTI=","number":50241,"title":"OOM due to large number of requests in TransportService.clientHandlers","user":{"login":"njustyq","id":34452367,"node_id":"MDQ6VXNlcjM0NDUyMzY3","avatar_url":"https://avatars2.githubusercontent.com/u/34452367?v=4","gravatar_id":"","url":"https://api.github.com/users/njustyq","html_url":"https://github.com/njustyq","followers_url":"https://api.github.com/users/njustyq/followers","following_url":"https://api.github.com/users/njustyq/following{/other_user}","gists_url":"https://api.github.com/users/njustyq/gists{/gist_id}","starred_url":"https://api.github.com/users/njustyq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/njustyq/subscriptions","organizations_url":"https://api.github.com/users/njustyq/orgs","repos_url":"https://api.github.com/users/njustyq/repos","events_url":"https://api.github.com/users/njustyq/events{/privacy}","received_events_url":"https://api.github.com/users/njustyq/received_events","type":"User","site_admin":false},"labels":[{"id":912834056,"node_id":"MDU6TGFiZWw5MTI4MzQwNTY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Monitoring","name":":Core/Features/Monitoring","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-12-16T16:31:11Z","updated_at":"2019-12-19T08:39:16Z","closed_at":"2019-12-18T20:14:16Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --6.3.2`):\r\n\r\n**Plugins installed**: [repository-hdfs]\r\n\r\n**JVM version** (`java -version`):10.0.2\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):centos7.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nour cluster is 24 data nodes with 31G heap and 1.7T*4 ssd disk , 3 master with 8G heap ,about 8000tps for write. we rolling upgrade(6.3.2 to 6.3.2) the cluster as the following steps:\r\n①set allocation to none\r\n②restart the data node \t\r\n③set allocation to all\r\nwait for the health from yellow to green.\r\nWhen i finished upgrade part of the data nodes，i had waited a while,i found the master node old gc and run OOM later.\r\nSo I loaded heap dump from master node into Eclipse MemoryAnalyzer and found that 87.57% of memory is used by TransportService.clientHandlers hash map,\r\nmost of the RequestHolder was consist of like the action:indices:monitor/stats[n]、indices:monitor/recovery[n] or cluster:monitor/stats[n],below is the pic of heap dump:\r\n![client](https://user-images.githubusercontent.com/34452367/70923617-1c7c9800-2063-11ea-8f7f-ece1f61a3a67.png)\r\n![1](https://user-images.githubusercontent.com/34452367/70923169-66b14980-2062-11ea-9d1a-2f20ff506b91.png)\r\n![2](https://user-images.githubusercontent.com/34452367/70923174-687b0d00-2062-11ea-975c-66555a62ec2c.png)\r\n\r\nand i use the OQL \r\n` SELECT toString(action) FROM org.elasticsearch.transport.TransportService$RequestHolder`\r\nto statistic the action,result is as follows:\r\n\r\n![action](https://user-images.githubusercontent.com/34452367/70923478-e6d7af00-2062-11ea-8e84-10a109158b5f.png)\r\n\r\n\r\nSo,are there any bugs here or master overload?\r\n\r\n\r\n","closed_by":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}