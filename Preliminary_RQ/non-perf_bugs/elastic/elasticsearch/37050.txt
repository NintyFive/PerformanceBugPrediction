{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37050","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37050/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37050/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37050/events","html_url":"https://github.com/elastic/elasticsearch/issues/37050","id":394997786,"node_id":"MDU6SXNzdWUzOTQ5OTc3ODY=","number":37050,"title":"discovery-ec2 plugin doesn't work with ec2 vpc endpoint","user":{"login":"laod","id":349427,"node_id":"MDQ6VXNlcjM0OTQyNw==","avatar_url":"https://avatars3.githubusercontent.com/u/349427?v=4","gravatar_id":"","url":"https://api.github.com/users/laod","html_url":"https://github.com/laod","followers_url":"https://api.github.com/users/laod/followers","following_url":"https://api.github.com/users/laod/following{/other_user}","gists_url":"https://api.github.com/users/laod/gists{/gist_id}","starred_url":"https://api.github.com/users/laod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/laod/subscriptions","organizations_url":"https://api.github.com/users/laod/orgs","repos_url":"https://api.github.com/users/laod/repos","events_url":"https://api.github.com/users/laod/events{/privacy}","received_events_url":"https://api.github.com/users/laod/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-31T15:45:58Z","updated_at":"2019-01-03T17:31:24Z","closed_at":"2019-01-03T17:31:24Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nVersion: 6.5.4, Build: default/rpm/d2ef93d/2018-12-17T21:17:40.758843Z, JVM: 1.8.0_191\r\n\r\n**Plugins installed**: \r\n\r\nThis cluster isn't forming yet so I can't get a _cat/plugins. Instead:\r\n\r\n```\r\n[centos@ip-10-128-64-225 ~]$ ls -l /usr/share/elasticsearch/plugins/\r\ntotal 4\r\ndrwxr-xr-x. 2 root root 4096 Dec 27 20:47 discovery-ec2\r\n[centos@ip-10-128-64-225 ~]$ ls -l /usr/share/elasticsearch/plugins/discovery-ec2/\r\ntotal 6632\r\n-rw-r--r--. 1 root root  850229 Dec 27 20:47 aws-java-sdk-core-1.11.187.jar\r\n-rw-r--r--. 1 root root 3159983 Dec 27 20:47 aws-java-sdk-ec2-1.11.187.jar\r\n-rw-r--r--. 1 root root  284184 Dec 27 20:47 commons-codec-1.10.jar\r\n-rw-r--r--. 1 root root   62050 Dec 27 20:47 commons-logging-1.1.3.jar\r\n-rw-r--r--. 1 root root   30334 Dec 27 20:47 discovery-ec2-6.5.4.jar\r\n-rw-r--r--. 1 root root  736658 Dec 27 20:47 httpclient-4.5.2.jar\r\n-rw-r--r--. 1 root root  327373 Dec 27 20:47 httpcore-4.4.5.jar\r\n-rw-r--r--. 1 root root   46968 Dec 27 20:47 jackson-annotations-2.6.0.jar\r\n-rw-r--r--. 1 root root 1165323 Dec 27 20:47 jackson-databind-2.6.7.1.jar\r\n-rw-r--r--. 1 root root   11358 Dec 27 20:47 LICENSE.txt\r\n-rw-r--r--. 1 root root   86403 Dec 27 20:47 NOTICE.txt\r\n-rw-r--r--. 1 root root    1502 Dec 27 20:47 plugin-descriptor.properties\r\n-rw-r--r--. 1 root root    1249 Dec 27 20:47 plugin-security.policy\r\n```\r\n\r\n**JVM version** (`java -version`):\r\n\r\njava version \"1.8.0_191\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_191-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nLinux ip-10-128-64-225.us-west-2.compute.internal 3.10.0-862.3.2.el7.x86_64 #1 SMP Mon May 21 23:36:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen using a vpc endpoint url for ec2 (example: vpce-somehash-aphlsvfe-us-west-2a.ec2.us-west-2.vpce.amazonaws.com) the ec2 discovery plugin fails. If I add a hosts entry mapping the appropriate non-vpc ec2 endpoint (ec2.us-west-2.amazonaws.com) to the vpc endpoint ip address it works.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Configure elasticsearch normally adding the following ec2-discovery config:\r\n\r\n```\r\ndiscovery.zen.hosts_provider: ec2\r\ndiscovery.zen.minimum_master_nodes: 2\r\ndiscovery.ec2.groups: <security group>\r\ndiscovery.ec2.endpoint: <vpc ec2 endpoint url>\r\n```\r\n\r\n 2. Start elasticsearch\r\n\r\n 3. Observe exception in log:\r\n\r\n`Exception while retrieving instance list from AWS API: AWS was not able to validate the provided access credentials (Service: AmazonEC2; Status Code: 401; Error Code: AuthFailure; Request ID: 3db49e60-a260-48d1-a8f7-b1d342c2dc67)`\r\n\r\nNote that these credentials work unchanged after adding the hosts entry.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"laod","id":349427,"node_id":"MDQ6VXNlcjM0OTQyNw==","avatar_url":"https://avatars3.githubusercontent.com/u/349427?v=4","gravatar_id":"","url":"https://api.github.com/users/laod","html_url":"https://github.com/laod","followers_url":"https://api.github.com/users/laod/followers","following_url":"https://api.github.com/users/laod/following{/other_user}","gists_url":"https://api.github.com/users/laod/gists{/gist_id}","starred_url":"https://api.github.com/users/laod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/laod/subscriptions","organizations_url":"https://api.github.com/users/laod/orgs","repos_url":"https://api.github.com/users/laod/repos","events_url":"https://api.github.com/users/laod/events{/privacy}","received_events_url":"https://api.github.com/users/laod/received_events","type":"User","site_admin":false},"performed_via_github_app":null}