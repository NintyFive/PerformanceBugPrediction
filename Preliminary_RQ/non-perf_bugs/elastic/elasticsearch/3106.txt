{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3106","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3106/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3106/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3106/events","html_url":"https://github.com/elastic/elasticsearch/issues/3106","id":14859404,"node_id":"MDU6SXNzdWUxNDg1OTQwNA==","number":3106,"title":"Facet on different numerical types causes exceptions even when resticting by type","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2013-05-28T20:25:18Z","updated_at":"2014-07-23T13:35:08Z","closed_at":"2014-07-23T13:35:08Z","author_association":"MEMBER","active_lock_reason":null,"body":"Given this script:\n\n``` sh\n#!/usr/bin/env zsh\n\ncurl -s -XDELETE localhost:9200/ftest\ncurl -s -XPOST localhost:9200/ftest -d'\n{\n    \"mappings\": {\n        \"doc\": {\n            \"_source\": {\n                \"enabled\": true\n            },\n            \"properties\": {\n                \"id\": {\n                    \"index\": \"not_analyzed\",\n                    \"type\": \"string\"\n                },\n                \"size\": {\n                    \"type\": \"integer\"\n                }\n            }\n        },\n        \"doc2\": {\n            \"_source\": {\n                \"enabled\": true\n            },\n            \"properties\": {\n                \"id\": {\n                    \"index\": \"not_analyzed\",\n                    \"type\": \"string\"\n                },\n                \"size\": {\n                    \"type\": \"long\"\n                }\n            }\n        }\n    },\n    \"settings\": {\n        \"number_of_replicas\": 0,\n        \"number_of_shards\": 1\n    }\n}'\necho\n\ncurl -XPUT localhost:9200/ftest/doc/1 -d'{\"id\":\"1\",\"size\":10}'\ncurl -XPUT localhost:9200/ftest/doc2/1 -d'{\"id\":\"1\",\"size\":5}'\n\ncurl -XPOST localhost:9200/ftest/_refresh\n\necho \"\\n\\nall\"\ncurl -XPOST http://localhost:9200/ftest/_search\\?search_type\\=count -d '{\n    \"facets\": {\n        \"size_stats\": {\n            \"statistical\": {\n                \"field\": \"size\"\n            }\n        }\n    },\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n'\n\necho \"\\n\\njust doc\"\ncurl -XPOST http://localhost:9200/ftest/doc/_search\\?search_type\\=count -d '{\n    \"facets\": {\n        \"size_stats\": {\n            \"statistical\": {\n                \"field\": \"size\"\n            }\n        }\n    },\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n'\n\necho \"\\n\\njust doc2\"\ncurl -XPOST http://localhost:9200/ftest/doc2/_search\\?search_type\\=count -d '{\n    \"facets\": {\n        \"size_stats\": {\n            \"statistical\": {\n                \"field\": \"size\"\n            }\n        }\n    },\n    \"query\": {\n        \"match_all\": {}\n    }\n}\n'\n\necho\n```\n\nWhen run:\n\n```\nâˆ´ ./facet-on-different-types.zsh \n{\"ok\":true,\"acknowledged\":true}{\"ok\":true,\"acknowledged\":true}\n{\"ok\":true,\"_index\":\"ftest\",\"_type\":\"doc\",\"_id\":\"1\",\"_version\":1}{\"ok\":true,\"_index\":\"ftest\",\"_type\":\"doc2\",\"_id\":\"1\",\"_version\":1}{\"ok\":true,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0}}\n\nall\n{\"error\":\"SearchPhaseExecutionException[Failed to execute phase [query], total failure; shardFailures {[gNdiQCO0TQSxijotnwBMUQ][ftest][0]: QueryPhaseExecutionException[[ftest][0]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: ElasticSearchException[java.lang.NumberFormatException: Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; nested: UncheckedExecutionException[java.lang.NumberFormatException: Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; nested: NumberFormatException[Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; }]\",\"status\":500}\n\njust doc\n{\"error\":\"SearchPhaseExecutionException[Failed to execute phase [query], total failure; shardFailures {[gNdiQCO0TQSxijotnwBMUQ][ftest][0]: QueryPhaseExecutionException[[ftest][0]: query[ConstantScore(cache(_type:doc))],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: ElasticSearchException[java.lang.NumberFormatException: Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; nested: UncheckedExecutionException[java.lang.NumberFormatException: Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; nested: NumberFormatException[Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; }]\",\"status\":500}\n\njust doc2\n{\"error\":\"SearchPhaseExecutionException[Failed to execute phase [query], total failure; shardFailures {[gNdiQCO0TQSxijotnwBMUQ][ftest][0]: QueryPhaseExecutionException[[ftest][0]: query[ConstantScore(cache(_type:doc2))],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: ElasticSearchException[java.lang.NumberFormatException: Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; nested: UncheckedExecutionException[java.lang.NumberFormatException: Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; nested: NumberFormatException[Invalid shift value in prefixCoded bytes (is encoded value really an INT?)]; }]\",\"status\":500}\n```\n\nWhich I'm guessing is caused by ES seeing \"integer\" as the type for the `size` field in the `doc` type and assuming everything else will be an integer. What I don't understand is that specifying `doc` or `doc2` as part of the URL to limit the query to a particular ES type doesn't work around this.\n\nAnother interesting this is that if the types are swapped (put \"long\" for doc and \"integer\" for doc2), the facet works correctly, so the order seems to matter.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}