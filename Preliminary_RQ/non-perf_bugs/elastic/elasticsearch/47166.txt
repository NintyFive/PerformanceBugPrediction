{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/47166","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47166/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47166/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47166/events","html_url":"https://github.com/elastic/elasticsearch/issues/47166","id":498880825,"node_id":"MDU6SXNzdWU0OTg4ODA4MjU=","number":47166,"title":"Ignore_malformed enabled by default and cannot be disabled on fields of type completion","user":{"login":"andrejbl","id":36857192,"node_id":"MDQ6VXNlcjM2ODU3MTky","avatar_url":"https://avatars1.githubusercontent.com/u/36857192?v=4","gravatar_id":"","url":"https://api.github.com/users/andrejbl","html_url":"https://github.com/andrejbl","followers_url":"https://api.github.com/users/andrejbl/followers","following_url":"https://api.github.com/users/andrejbl/following{/other_user}","gists_url":"https://api.github.com/users/andrejbl/gists{/gist_id}","starred_url":"https://api.github.com/users/andrejbl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrejbl/subscriptions","organizations_url":"https://api.github.com/users/andrejbl/orgs","repos_url":"https://api.github.com/users/andrejbl/repos","events_url":"https://api.github.com/users/andrejbl/events{/privacy}","received_events_url":"https://api.github.com/users/andrejbl/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":1619315113,"node_id":"MDU6TGFiZWwxNjE5MzE1MTEz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.6.0","name":"v7.6.0","color":"DDDDDD","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2019-09-26T13:20:51Z","updated_at":"2019-10-18T18:39:08Z","closed_at":"2019-10-18T18:39:08Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.8.3\r\n\r\n**Plugins installed**: [discovery-ec2, repository-s3]\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_171\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_171-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux es-data-2 4.14.143-91.122.amzn1.x86_64 #1 SMP Wed Sep 11 00:43:34 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe have an index with a field mapping of type 'completion' defined like so:\r\n```\r\n{\r\n  \"mappings\" : {\r\n    \"_doc\" : {\r\n      \"dynamic\" : \"false\",\r\n      \"properties\" : {\r\n        \"id\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"term\" : {\r\n          \"type\" : \"completion\",\r\n          \"analyzer\" : \"analyzer_search_term_suggestions\",\r\n          \"search_analyzer\" : \"standard\",\r\n          \"preserve_separators\" : true,\r\n          \"preserve_position_increments\" : true,\r\n          \"max_input_length\" : 50\r\n        },\r\n        \"type\" : {\r\n          \"type\" : \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"settings\" : {\r\n    \"index\" : {\r\n      \"number_of_shards\" : \"1\",\r\n      \"analysis\" : {\r\n        \"filter\" : {\r\n          \"custom_stop_filter\" : {\r\n            \"type\" : \"stop\",\r\n            \"stopwords\" : [\r\n              \"within\",\r\n              \"without\"\r\n            ]\r\n          }\r\n        },\r\n        \"analyzer\" : {\r\n          \"analyzer_search_term_suggestions\" : {\r\n            \"filter\" : [\r\n              \"standard\",\r\n              \"lowercase\",\r\n              \"stop\",\r\n              \"custom_stop_filter\"\r\n            ],\r\n            \"char_filter\" : [\r\n              \"html_strip\"\r\n            ],\r\n            \"type\" : \"custom\",\r\n            \"tokenizer\" : \"standard\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n``` \r\n\r\nIn ES version 6.3.0 which we ran so far, ingesting a malformed document would fail, as would be expected:\r\n\r\n```\r\ncurl -XPUT 'localhost:9200/app_store_suggested_search_term_test/_doc/app-name' -H 'Content-type: application/json' -d'{\r\n   \"id\": \"app-name\",\r\n   \"term\": \"\",\r\n   \"type\" : \"full-app-name\"\r\n}'\r\n\r\n{\"error\":{\"root_cause\":[{\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse\"}],\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse\",\"caused_by\":{\"type\":\"illegal_argument_exception\",\"reason\":\"value must have a length > 0\"}},\"status\":400}\r\n```\r\n\r\nAfter upgrading ES to 6.8.3, the ingestion of such documents works, with the term field being flagged as `_ignored`:\r\n\r\n```\r\ncurl -XPUT 'localhost:9200/app_store_suggested_search_term_test/_doc/full_app_name-' -H 'Content-type: application/json' -d'{\r\n   \"id\": \"full_app_name-\",\r\n   \"term\": \"\",\r\n   \"type\" : \"full-app-name\"\r\n}'\r\n{\"_index\":\"app_store_suggested_search_term_test\",\"_type\":\"_doc\",\"_id\":\"full_app_name-\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":2,\"failed\":0},\"_seq_no\":2,\"_primary_term\":1}\r\n\r\n...\r\n{\r\n        \"_index\" : \"app_store_suggested_search_term_test\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"full_app_name-\",\r\n        \"_score\" : 1.0,\r\n        \"_ignored\" : [\r\n          \"term\"\r\n        ],\r\n        \"_source\" : {\r\n          \"id\" : \"full_app_name-\",\r\n          \"term\" : \"\",\r\n          \"type\" : \"full-app-name\"\r\n        }\r\n      }\r\n}\r\n```\r\n\r\n[Documentation](https://www.elastic.co/guide/en/elasticsearch/reference/master/mapping-ignored-field.html) suggests that this behaviour should only happen when the `ignore_malformed` setting has been set to true on the index or the field itself. However, that setting is not set and we still see the behaviour. In fact, setting the `ignore_malformed` index level setting to either `true` or `false` on the index seems not to have any impact on the behaviour.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create an index with the `ignore_malformed` explicitly set to false:\r\n ```\r\ncurl -XPUT 'localhost:9200/my_index?pretty' -H 'Content-Type: application/json' -d'  \r\n {\r\n   \"settings\" : {\r\n     \"index\" : {\r\n      \"mapping\" : {\r\n         \"ignore_malformed\": false\r\n       },\r\n       \"number_of_shards\" : 1, \r\n       \"number_of_replicas\" : 1,\r\n       \"analysis\" : {\r\n         \"filter\" : {\r\n           \"custom_stop_filter\" : {\r\n             \"type\" : \"stop\",\r\n             \"stopwords\" : [\r\n               \"within\",\r\n               \"without\"\r\n             ]\r\n           }\r\n         },\r\n         \"analyzer\" : {\r\n           \"analyzer_search_term_suggestions\" : {\r\n             \"filter\" : [\r\n               \"standard\",\r\n               \"lowercase\",\r\n               \"stop\",\r\n               \"custom_stop_filter\"\r\n             ],\r\n             \"char_filter\" : [\r\n               \"html_strip\"\r\n             ],\r\n             \"type\" : \"custom\",\r\n             \"tokenizer\" : \"standard\"\r\n           }\r\n         }\r\n       }\r\n     }\r\n   }\r\n }'\r\n\r\ncurl -XPUT 'localhost:9200/my_index/_mapping/_doc?pretty' -H 'Content-Type: application/json' -d'  \r\n{\r\n  \"dynamic\" : \"false\",\r\n  \"properties\" : {\r\n    \"id\" : {\r\n      \"type\" : \"keyword\"\r\n    },\r\n    \"term\" : {\r\n      \"type\" : \"completion\",\r\n      \"analyzer\" : \"analyzer_search_term_suggestions\",\r\n      \"search_analyzer\" : \"standard\",\r\n      \"preserve_separators\" : true,\r\n      \"preserve_position_increments\" : true,\r\n      \"max_input_length\" : 50\r\n    },\r\n    \"type\" : {\r\n      \"type\" : \"keyword\"\r\n    }\r\n  }\r\n}'\r\n```\r\n 2. Index a document with the malformed field:\r\n```\r\ncurl -XPUT 'localhost:9200/my_index/_doc/full_app_name-' -H 'Content-type: application/json' -d'{\r\n  \"id\": \"full_app_name\",\r\n  \"term\": \"\",\r\n  \"type\" : \"full-app-name\"\r\n}'\r\n```\r\n3. Ingestion should result in a failure. Instead it succeeds.\r\n\r\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}