[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/84911260","html_url":"https://github.com/elastic/elasticsearch/issues/10142#issuecomment-84911260","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10142","id":84911260,"node_id":"MDEyOklzc3VlQ29tbWVudDg0OTExMjYw","user":{"login":"SMUnlimited","id":5180431,"node_id":"MDQ6VXNlcjUxODA0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/5180431?v=4","gravatar_id":"","url":"https://api.github.com/users/SMUnlimited","html_url":"https://github.com/SMUnlimited","followers_url":"https://api.github.com/users/SMUnlimited/followers","following_url":"https://api.github.com/users/SMUnlimited/following{/other_user}","gists_url":"https://api.github.com/users/SMUnlimited/gists{/gist_id}","starred_url":"https://api.github.com/users/SMUnlimited/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SMUnlimited/subscriptions","organizations_url":"https://api.github.com/users/SMUnlimited/orgs","repos_url":"https://api.github.com/users/SMUnlimited/repos","events_url":"https://api.github.com/users/SMUnlimited/events{/privacy}","received_events_url":"https://api.github.com/users/SMUnlimited/received_events","type":"User","site_admin":false},"created_at":"2015-03-23T09:29:52Z","updated_at":"2015-03-23T09:29:52Z","author_association":"NONE","body":"A crazy solution that just might work. Set no parent fields! The parent fields are themselves only available in a nested document. And all nested documents are only in a single nested path. Then when we do an aggregation we can get the merged results of the parents and children without any duplication of parent doc counts or data. \n\nIf at some point we are only interested in the parent or children on our aggregation, we set a field on nested documents that says whether it is the parent fields or not. Then do a (term?) aggregation to split the nested documents into 2 buckets of parent nested docs and children nested docs, followed by the actual aggregation we want to do. \n\nThe upcoming inner hits feature can be used when we are after displaying the parent fields to a user.\n\nOnly disadvantage is this doesn't solve the problem for multiple levels of nesting.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89636174","html_url":"https://github.com/elastic/elasticsearch/issues/10142#issuecomment-89636174","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10142","id":89636174,"node_id":"MDEyOklzc3VlQ29tbWVudDg5NjM2MTc0","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-04T18:37:59Z","updated_at":"2015-04-04T18:37:59Z","author_association":"CONTRIBUTOR","body":"Hi @SMUnlimited \n\nAny chance you could upload some actual REST examples?  It's easier reading code than descriptions :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/93236503","html_url":"https://github.com/elastic/elasticsearch/issues/10142#issuecomment-93236503","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10142","id":93236503,"node_id":"MDEyOklzc3VlQ29tbWVudDkzMjM2NTAz","user":{"login":"SMUnlimited","id":5180431,"node_id":"MDQ6VXNlcjUxODA0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/5180431?v=4","gravatar_id":"","url":"https://api.github.com/users/SMUnlimited","html_url":"https://github.com/SMUnlimited","followers_url":"https://api.github.com/users/SMUnlimited/followers","following_url":"https://api.github.com/users/SMUnlimited/following{/other_user}","gists_url":"https://api.github.com/users/SMUnlimited/gists{/gist_id}","starred_url":"https://api.github.com/users/SMUnlimited/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SMUnlimited/subscriptions","organizations_url":"https://api.github.com/users/SMUnlimited/orgs","repos_url":"https://api.github.com/users/SMUnlimited/repos","events_url":"https://api.github.com/users/SMUnlimited/events{/privacy}","received_events_url":"https://api.github.com/users/SMUnlimited/received_events","type":"User","site_admin":false},"created_at":"2015-04-15T07:25:52Z","updated_at":"2015-04-15T07:25:52Z","author_association":"NONE","body":"@clintongormley There is an example in the gist:\n\nhttps://gist.github.com/SMUnlimited/86e03e8f59ac6a09935c\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/95542202","html_url":"https://github.com/elastic/elasticsearch/issues/10142#issuecomment-95542202","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10142","id":95542202,"node_id":"MDEyOklzc3VlQ29tbWVudDk1NTQyMjAy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-23T11:05:31Z","updated_at":"2015-04-23T11:05:31Z","author_association":"CONTRIBUTOR","body":"@SMUnlimited I think you need to solve these problems at index time.  For instance, if you want to count identical primary and secondary products as 1, then you should merge these products into a single field, eg using `copy_to`:\n\n```\nPUT myindex\n{\n  \"mappings\": {\n    \"lead\": {\n      \"properties\": {\n        \"primary_product\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\",\n          \"copy_to\": \"all_products\"\n        },\n        \"secondary_product\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\",\n          \"copy_to\": \"all_products\"\n        },\n        \"all_products\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        }\n      }\n    }\n  }\n}\n\nPUT myindex/lead/1\n{\n  \"name\": \"John\",\n  \"primary_product\": \"Foo\",\n  \"secondary_product\": \"Bar\"\n}\n\nPUT myindex/lead/2\n{\n  \"name\": \"Mary\",\n  \"primary_product\": \"Foo\",\n  \"secondary_product\": \"Foo\"\n}\n\nGET /myindex/lead/_search\n{\n  \"size\": 0,\n  \"aggs\": {\n    \"products\": {\n      \"terms\": {\n        \"field\": \"all_products\"\n      }\n    }\n  }\n}\n```\n\nThis returns:\n\n```\n  \"products\": {\n     \"doc_count_error_upper_bound\": 0,\n     \"sum_other_doc_count\": 0,\n     \"buckets\": [\n        {\n           \"key\": \"Foo\",\n           \"doc_count\": 2\n        },\n        {\n           \"key\": \"Bar\",\n           \"doc_count\": 1\n        }\n     ]\n  }\n```\n","performed_via_github_app":null}]