{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3399","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3399/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3399/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3399/events","html_url":"https://github.com/elastic/elasticsearch/issues/3399","id":17285653,"node_id":"MDU6SXNzdWUxNzI4NTY1Mw==","number":3399,"title":"auto_expand_replicas causing very large amount of cluster state changes when a node joins or leaves the cluster - causing the master to become unresponsive","user":{"login":"moberg","id":205836,"node_id":"MDQ6VXNlcjIwNTgzNg==","avatar_url":"https://avatars3.githubusercontent.com/u/205836?v=4","gravatar_id":"","url":"https://api.github.com/users/moberg","html_url":"https://github.com/moberg","followers_url":"https://api.github.com/users/moberg/followers","following_url":"https://api.github.com/users/moberg/following{/other_user}","gists_url":"https://api.github.com/users/moberg/gists{/gist_id}","starred_url":"https://api.github.com/users/moberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/moberg/subscriptions","organizations_url":"https://api.github.com/users/moberg/orgs","repos_url":"https://api.github.com/users/moberg/repos","events_url":"https://api.github.com/users/moberg/events{/privacy}","received_events_url":"https://api.github.com/users/moberg/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":45109570,"node_id":"MDU6TGFiZWw0NTEwOTU3MA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.3","name":"v0.90.3","color":"DDDDDD","default":false,"description":null},{"id":37906111,"node_id":"MDU6TGFiZWwzNzkwNjExMQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta1","name":"v1.0.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2013-07-26T21:30:36Z","updated_at":"2013-07-30T20:35:45Z","closed_at":"2013-07-30T20:35:45Z","author_association":"NONE","active_lock_reason":null,"body":"In our cluster we have 8 nodes and about 100 indices. Each index have one shard and is replicated to every node using the setting “auto_expand_replicas=’0-all’”. \n\nWe observed that when a node leaves the cluster, the master node becomes unresponsive for some time. The more indices we added the longer time it got unresponsive. During this time restarted nodes were sometimes not able to join back into the cluster, causing a split brain scenario, or were just hung at startup.\n\nLooking at the source code for how the node leave and join events is handled I think I have identified the bug. The ClusterChangedEvent is propagated to MetaDataUpdateSettingsService#clusterChanged which will loop through every index and if the number of nodes has changed, fire updateSettings for that index. When a node joins or leaves and using the auto_expand_replicas setting, every index will be affected. So for 100 indices it will fire off 100 updateSettings. \n\nThe problem is that each call updateSettings results in a new cluster state, which again will propagate back to the MetaDataUpdateSettingsService#clusterChanged, resulting in an exponential number of cluster state changes. This fills the log with messages like this:\n\n[2013-07-26 20:55:45,726][INFO ][cluster.metadata         ] [master] [index1] auto expanded replicas to [5]\n[2013-07-26 20:55:45,726][INFO ][cluster.metadata         ] [master] [index2] auto expanded replicas to [5]\n[2013-07-26 20:55:45,726][INFO ][cluster.metadata         ] [master] [index3] auto expanded replicas to [5]\n\nMy proposed fix is to group the updates together by fNumberOfReplicas and only trigger one update for each fNumberOfReplicas. In our case, when “auto_expand_replicas” is set to “0-all” this will result in one cluster state change instead of a flood of changes. \n\nThe fix passes all the tests and solves the problem we have been observing in production and been able to reproduce in our development environment. \n\nWill update the ticket asap with a link to the commit for fix.\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}