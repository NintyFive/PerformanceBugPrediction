{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9305","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9305/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9305/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9305/events","html_url":"https://github.com/elastic/elasticsearch/issues/9305","id":54412764,"node_id":"MDU6SXNzdWU1NDQxMjc2NA==","number":9305,"title":"Sorting with nested_filter does not work with inner nested document","user":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2015-01-15T04:59:14Z","updated_at":"2015-02-17T16:54:48Z","closed_at":"2015-02-17T16:54:48Z","author_association":"MEMBER","active_lock_reason":null,"body":"Using an inner nested filter within a `nested_filter` for `sort`ing does not work (tested in 1.4.2) and it silently fails to handle the inner nested filter.\n\nThe corresponding test code is commented out at https://github.com/elasticsearch/elasticsearch/tree/v1.4.2/src/test/java/org/elasticsearch/nested/SimpleNestedTests.java#L1171\n\nExample follows:\n\n```\nPUT /test\n{\"mappings\":{\"type\":{\"properties\":{\"officelocation\":{\"type\":\"string\"},\"users\":{\"type\":\"nested\",\"properties\":{\"first\":{\"type\":\"string\"},\"last\":{\"type\":\"string\"},\"workstation\":{\"type\":\"nested\",\"properties\":{\"stationid\":{\"type\":\"string\"},\"phoneid\":{\"type\":\"string\"}}}}}}}}}\n\nPUT /test/type/1\n{\"officelocation\":\"glendale\",\"users\":[{\"first\":\"fname1\",\"last\":\"lname1\",\"workstation\":[{\"stationid\":\"s1\",\"phoneid\":\"p1\"},{\"stationid\":\"s2\",\"phoneid\":\"p2\"}]},{\"first\":\"fname2\",\"last\":\"lname2\",\"workstation\":[{\"stationid\":\"s3\",\"phoneid\":\"p3\"},{\"stationid\":\"s4\",\"phoneid\":\"p4\"}]},{\"first\":\"fname3\",\"last\":\"lname3\",\"workstation\":[{\"stationid\":\"s5\",\"phoneid\":\"p5\"},{\"stationid\":\"s6\",\"phoneid\":\"p6\"}]}]}\n\nPUT /test/type/2\n{\"officelocation\":\"glendale\",\"users\":[{\"first\":\"fname4\",\"last\":\"lname4\",\"workstation\":[{\"stationid\":\"s1\",\"phoneid\":\"p1\"},{\"stationid\":\"s2\",\"phoneid\":\"p2\"}]},{\"first\":\"fname5\",\"last\":\"lname5\",\"workstation\":[{\"stationid\":\"s3\",\"phoneid\":\"p3\"},{\"stationid\":\"s4\",\"phoneid\":\"p4\"}]},{\"first\":\"fname1\",\"last\":\"lname1\",\"workstation\":[{\"stationid\":\"s5 ss\",\"phoneid\":\"p5\"},{\"stationid\":\"s6\",\"phoneid\":\"p6\"}]}]}\n\nGET /test/_search\n{\n  \"fields\": \"_id\",\n  \"sort\": [\n    {\n      \"users.first\": {\n        \"order\": \"asc\"\n      }\n    },\n    {\n      \"users.first\": {\n        \"order\": \"asc\",\n        \"nested_path\": \"users\",\n        \"nested_filter\": {\n          \"nested\": {\n            \"path\": \"users.workstation\",\n            \"filter\": {\n              \"term\": {\n                \"users.workstation.stationid\": \"s5\"\n              }\n            }\n          }\n        }\n      }\n    }\n  ]\n}\n```\n\nThis returns\n\n```\n{\n   \"took\": 9,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 2,\n      \"max_score\": null,\n      \"hits\": [\n         {\n            \"_index\": \"test\",\n            \"_type\": \"myType\",\n            \"_id\": \"1\",\n            \"_score\": null,\n            \"sort\": [\n               \"fname1\",\n               null // <- should be \"fname3\"\n            ]\n         },\n         {\n            \"_index\": \"test\",\n            \"_type\": \"myType\",\n            \"_id\": \"2\",\n            \"_score\": null,\n            \"sort\": [\n               \"fname1\",\n               null // <- should be \"fname1\"\n            ]\n         }\n      ]\n   }\n}\n```\n\nHere is the nested filter as a query:\n\n```\nGET /test/_search\n{\"query\":{\"filtered\":{\"filter\":{\"nested\":{\"path\":\"users\",\"filter\":{\"nested\":{\"path\":\"users.workstation\",\"filter\":{\"term\":{\"users.workstation.stationid\":\"s5\"}}}}}}}}}\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}