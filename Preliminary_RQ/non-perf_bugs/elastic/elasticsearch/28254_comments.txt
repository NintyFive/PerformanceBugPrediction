[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/358384013","html_url":"https://github.com/elastic/elasticsearch/issues/28254#issuecomment-358384013","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28254","id":358384013,"node_id":"MDEyOklzc3VlQ29tbWVudDM1ODM4NDAxMw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-01-17T17:43:13Z","updated_at":"2018-01-17T17:43:13Z","author_association":"MEMBER","body":"Could you be more precise in the description of the feature ? What do you mean by child scoring ? \r\nIs it `nested` sort: https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#nested-sorting ? \r\nYou can choose a sort mode already:\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-sort.html#_sort_mode_option\r\nAre you proposing to add a `first` mode that would select the first nested document ?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/361455567","html_url":"https://github.com/elastic/elasticsearch/issues/28254#issuecomment-361455567","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28254","id":361455567,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MTQ1NTU2Nw==","user":{"login":"DR9885","id":461852,"node_id":"MDQ6VXNlcjQ2MTg1Mg==","avatar_url":"https://avatars1.githubusercontent.com/u/461852?v=4","gravatar_id":"","url":"https://api.github.com/users/DR9885","html_url":"https://github.com/DR9885","followers_url":"https://api.github.com/users/DR9885/followers","following_url":"https://api.github.com/users/DR9885/following{/other_user}","gists_url":"https://api.github.com/users/DR9885/gists{/gist_id}","starred_url":"https://api.github.com/users/DR9885/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DR9885/subscriptions","organizations_url":"https://api.github.com/users/DR9885/orgs","repos_url":"https://api.github.com/users/DR9885/repos","events_url":"https://api.github.com/users/DR9885/events{/privacy}","received_events_url":"https://api.github.com/users/DR9885/received_events","type":"User","site_admin":false},"created_at":"2018-01-30T02:22:56Z","updated_at":"2018-01-30T02:22:56Z","author_association":"NONE","body":"Sure, I have two documents (Securities and Offers), with a parent-child relationship. The end goal is to sort Securities by Offer Expiration, but only on the \"cheapest\" offer.\r\n\r\nFor Example, lets say we have the following data: (* is cheapest offer)\r\n\r\n\t- Security 1\r\n\t\t-- Offer 1, Price 2, Expiration 1/1/2017 \r\n\t\t-- *Offer 2, Price 1, Expiration 1/1/2018\r\n\t- Security 2\r\n\t\t-- Offer 1, Price 3, Expiration 1/1/2018\r\n\t\t-- *Offer 2, Price 2, Expiration 1/1/2019\r\n\r\nBut I wanted it to sort by Offer Expiration Desc (of the cheapest offer only)\r\n\r\n\t- Security 2\r\n\t\t-- Offer 1, Price 3, Expiration 1/1/2018\r\n\t\t-- *Offer 2, Price 2, Expiration 1/1/2019\r\n\t- Security 1\r\n\t\t-- Offer 1, Price 2, Expiration 1/1/2017 \r\n\t\t-- *Offer 2, Price 1, Expiration 1/1/2018\r\n\r\nNote: Security 2 wins because it's cheapest offer is in 2019\r\n\r\n\r\nThe following document suggests that if I want to sort two documents, to write scoring scripts:\r\nRef: https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-has-child-query.html","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/362609810","html_url":"https://github.com/elastic/elasticsearch/issues/28254#issuecomment-362609810","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28254","id":362609810,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MjYwOTgxMA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-02-02T15:01:22Z","updated_at":"2018-02-02T15:01:22Z","author_association":"MEMBER","body":"Ok I thought you were talking of nested fields but if you use `parent/child` then the only way to sort by a child field is to use a function_score. I think you can achieve what you want by using a function_score like this (https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-has-child-query.html#_sorting):\r\n\r\n```\r\n\"function_score\" : {\r\n                    \"script_score\": {\r\n                        \"script\": \"doc['price'].value\"\r\n                    }\r\n                }\r\n```\r\nand then use `inner_hits` with a different sort for the offers:\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-inner-hits.html\r\n\r\nSince this is more a question on how to achieve something I hope you dont mind if I close this issue. We reserve github for verified bugs and feature request so can I ask you to open a new discussion on discuss.elastic.co ? I'll be happy to help there.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/362699135","html_url":"https://github.com/elastic/elasticsearch/issues/28254#issuecomment-362699135","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28254","id":362699135,"node_id":"MDEyOklzc3VlQ29tbWVudDM2MjY5OTEzNQ==","user":{"login":"DR9885","id":461852,"node_id":"MDQ6VXNlcjQ2MTg1Mg==","avatar_url":"https://avatars1.githubusercontent.com/u/461852?v=4","gravatar_id":"","url":"https://api.github.com/users/DR9885","html_url":"https://github.com/DR9885","followers_url":"https://api.github.com/users/DR9885/followers","following_url":"https://api.github.com/users/DR9885/following{/other_user}","gists_url":"https://api.github.com/users/DR9885/gists{/gist_id}","starred_url":"https://api.github.com/users/DR9885/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DR9885/subscriptions","organizations_url":"https://api.github.com/users/DR9885/orgs","repos_url":"https://api.github.com/users/DR9885/repos","events_url":"https://api.github.com/users/DR9885/events{/privacy}","received_events_url":"https://api.github.com/users/DR9885/received_events","type":"User","site_admin":false},"created_at":"2018-02-02T20:34:00Z","updated_at":"2018-02-02T20:36:00Z","author_association":"NONE","body":"I'm aware that some of this feature exists, but it's incomplete for my needs. function_score requires a score_mode of \"min, max, sum, avg or none\". However, when doing so, it scores all the children. I want it to ignore all but the first. So I'm asking for a Feature \"score_mode\" : \"first\"\r\n\r\nSo I can do something like the following:\r\n\r\n\r\n        {\r\n          \"has_child\": {\r\n            \"type\": \"offer\",\r\n            \"score_mode\": \"first\",\r\n            \"query\": {\r\n              \"function_score\": {\r\n                \"functions\": [\r\n                  {\r\n                    \"script_score\": {\r\n                      \"script\": {\r\n                        \"inline\": \"doc['expiration'].value\"\r\n                      }\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            },\r\n            \"inner_hits\": {\r\n              \"sort\": [\r\n                {\r\n                  \"price\": {\r\n                    \"order\": \"asc\"\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n\r\n\r\nIdeally that would do the following:\r\n\r\n1. sort inner_hits of offers by price (so the first offer is always the best price)\r\n2. score only the first offer by expiration date\r\n3. then sort the results by the parent\r\n\r\n#2 being the most important","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/373815722","html_url":"https://github.com/elastic/elasticsearch/issues/28254#issuecomment-373815722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28254","id":373815722,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MzgxNTcyMg==","user":{"login":"potatman","id":13949771,"node_id":"MDQ6VXNlcjEzOTQ5Nzcx","avatar_url":"https://avatars1.githubusercontent.com/u/13949771?v=4","gravatar_id":"","url":"https://api.github.com/users/potatman","html_url":"https://github.com/potatman","followers_url":"https://api.github.com/users/potatman/followers","following_url":"https://api.github.com/users/potatman/following{/other_user}","gists_url":"https://api.github.com/users/potatman/gists{/gist_id}","starred_url":"https://api.github.com/users/potatman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/potatman/subscriptions","organizations_url":"https://api.github.com/users/potatman/orgs","repos_url":"https://api.github.com/users/potatman/repos","events_url":"https://api.github.com/users/potatman/events{/privacy}","received_events_url":"https://api.github.com/users/potatman/received_events","type":"User","site_admin":false},"created_at":"2018-03-16T19:08:47Z","updated_at":"2018-03-16T19:08:47Z","author_association":"NONE","body":"Hi @jimczi I am hitting this bug as well for a similar use case.  I'm afraid the approach in https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-has-child-query.html#_sorting doesn't help in these sorts of cases.  Any chance this could be reopened and get fixed?  Function_score doesn't work when you need to sort based on a value in a specific child doc.   It just takes the lowest or highest value of any child doc.","performed_via_github_app":null}]