{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23790","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23790/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23790/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23790/events","html_url":"https://github.com/elastic/elasticsearch/issues/23790","id":217839726,"node_id":"MDU6SXNzdWUyMTc4Mzk3MjY=","number":23790,"title":"MultiClusterSearchYamlTestSuiteIT{p0=/10_basic/Index data and search on the old cluster} fails","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":334286612,"node_id":"MDU6TGFiZWwzMzQyODY2MTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.0-alpha1","name":"v6.0.0-alpha1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-03-29T11:00:44Z","updated_at":"2017-04-11T07:00:40Z","closed_at":"2017-04-11T07:00:40Z","author_association":"MEMBER","active_lock_reason":null,"body":"* Link to failed build: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=fedora/757/console\r\n* Reproduction line: `gradle :qa:multi-cluster-search:remoteClusterTestRunner -Dtests.seed=2C5B47B8A3E32364 -Dtests.class=org.elasticsearch.upgrades.MultiClusterSearchYamlTestSuiteIT -Dtests.method=\"test {p0=/10_basic/Index data and search on the old cluster}\" -Dtests.security.manager=true -Dtests.locale=hu-HU -Dtests.timezone=Africa/Lagos -Dtests.rest.suite=remote_cluster`\r\n* Does not reproduce locally; failed only once more two days ago in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+periodic/2228/console (I checked all failures in the last year).\r\n\r\nFailure output:\r\n\r\n```\r\nSuite: org.elasticsearch.upgrades.MultiClusterSearchYamlTestSuiteIT\r\n  1> [2017-03-28T21:41:23,829][INFO ][o.e.u.MultiClusterSearchYamlTestSuiteIT] [test {p0=/10_basic/Index data and search on the old cluster}]: before test\r\n  1> [2017-03-28T21:41:23,846][INFO ][o.e.u.MultiClusterSearchYamlTestSuiteIT] initializing REST clients against [http://[::1]:43685, http://[::1]:41113]\r\n  1> [2017-03-28T21:41:24,392][INFO ][o.e.u.MultiClusterSearchYamlTestSuiteIT] initializing yaml client, minimum es version: [6.0.0-alpha1] master version: [6.0.0-alpha1] hosts: [http://[::1]:43685, http://[::1]:41113]\r\n  1> [2017-03-28T21:41:25,641][INFO ][o.e.u.MultiClusterSearchYamlTestSuiteIT] [test {p0=/10_basic/Index data and search on the old cluster}]: after test\r\n  1> [2017-03-28T21:41:25,660][INFO ][o.e.u.MultiClusterSearchYamlTestSuiteIT] Stash dump on failure [{\r\n  1>   \"stash\" : {\r\n  1>     \"body\" : {\r\n  1>       \"took\" : 134,\r\n  1>       \"timed_out\" : false,\r\n  1>       \"_shards\" : {\r\n  1>         \"total\" : 3,\r\n  1>         \"successful\" : 3,\r\n  1>         \"failed\" : 0\r\n  1>       },\r\n  1>       \"hits\" : {\r\n  1>         \"total\" : 5,\r\n  1>         \"max_score\" : 1.0,\r\n  1>         \"hits\" : [\r\n  1>           {\r\n  1>             \"_index\" : \"test_index\",\r\n  1>             \"_type\" : \"test_type\",\r\n  1>             \"_id\" : \"AVsWptjSUpYF0tZRx4kZ\",\r\n  1>             \"_score\" : 1.0,\r\n  1>             \"_source\" : {\r\n  1>               \"filter_field\" : 0,\r\n  1>               \"f1\" : \"remote_cluster\"\r\n  1>             }\r\n  1>           },\r\n  1>           {\r\n  1>             \"_index\" : \"test_index\",\r\n  1>             \"_type\" : \"test_type\",\r\n  1>             \"_id\" : \"AVsWptjSUpYF0tZRx4kV\",\r\n  1>             \"_score\" : 1.0,\r\n  1>             \"_source\" : {\r\n  1>               \"filter_field\" : 1,\r\n  1>               \"f1\" : \"remote_cluster\"\r\n  1>             }\r\n  1>           },\r\n  1>           {\r\n  1>             \"_index\" : \"test_index\",\r\n  1>             \"_type\" : \"test_type\",\r\n  1>             \"_id\" : \"AVsWptjSUpYF0tZRx4kX\",\r\n  1>             \"_score\" : 1.0,\r\n  1>             \"_source\" : {\r\n  1>               \"filter_field\" : 1,\r\n  1>               \"f1\" : \"remote_cluster\"\r\n  1>             }\r\n  1>           },\r\n  1>           {\r\n  1>             \"_index\" : \"test_index\",\r\n  1>             \"_type\" : \"test_type\",\r\n  1>             \"_id\" : \"AVsWptjSUpYF0tZRx4kW\",\r\n  1>             \"_score\" : 1.0,\r\n  1>             \"_source\" : {\r\n  1>               \"filter_field\" : 0,\r\n  1>               \"f1\" : \"remote_cluster\"\r\n  1>             }\r\n  1>           },\r\n  1>           {\r\n  1>             \"_index\" : \"test_index\",\r\n  1>             \"_type\" : \"test_type\",\r\n  1>             \"_id\" : \"AVsWptjSUpYF0tZRx4kY\",\r\n  1>             \"_score\" : 1.0,\r\n  1>             \"_source\" : {\r\n  1>               \"filter_field\" : 0,\r\n  1>               \"f1\" : \"remote_cluster\"\r\n  1>             }\r\n  1>           }\r\n  1>         ]\r\n  1>       },\r\n  1>       \"aggregations\" : {\r\n  1>         \"cluster\" : {\r\n  1>           \"doc_count_error_upper_bound\" : 0,\r\n  1>           \"sum_other_doc_count\" : 0,\r\n  1>           \"buckets\" : [\r\n  1>             {\r\n  1>               \"key\" : \"remote_cluster\",\r\n  1>               \"doc_count\" : 5\r\n  1>             }\r\n  1>           ]\r\n  1>         }\r\n  1>       }\r\n  1>     }\r\n  1>   }\r\n  1> }]\r\n  2> REPRODUCE WITH: gradle :qa:multi-cluster-search:remoteClusterTestRunner -Dtests.seed=2C5B47B8A3E32364 -Dtests.class=org.elasticsearch.upgrades.MultiClusterSearchYamlTestSuiteIT -Dtests.method=\"test {p0=/10_basic/Index data and search on the old cluster}\" -Dtests.security.manager=true -Dtests.locale=hu-HU -Dtests.timezone=Africa/Lagos -Dtests.rest.suite=remote_cluster\r\nFAILURE 1.85s | MultiClusterSearchYamlTestSuiteIT.test {p0=/10_basic/Index data and search on the old cluster} <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: Failure at [/10_basic:45]: hits.total didn't match expected value:\r\n   >                     hits.total: expected [6] but was [5]\r\n   > \tat __randomizedtesting.SeedInfo.seed([2C5B47B8A3E32364:A40F78620D1F4E9C]:0)\r\n   > \tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:377)\r\n   > \tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.test(ESClientYamlSuiteTestCase.java:357)\r\n   > \tat java.lang.Thread.run(Thread.java:745)\r\n   > Caused by: java.lang.AssertionError: hits.total didn't match expected value:\r\n   >                     hits.total: expected [6] but was [5]\r\n   > \tat org.elasticsearch.test.rest.yaml.section.MatchAssertion.doAssert(MatchAssertion.java:87)\r\n   > \tat org.elasticsearch.test.rest.yaml.section.Assertion.execute(Assertion.java:76)\r\n   > \tat org.elasticsearch.test.rest.yaml.ESClientYamlSuiteTestCase.executeSection(ESClientYamlSuiteTestCase.java:373)\r\n   > \t... 38 more\r\n```\r\n\r\nLikely cause: The cause seems to be related to a problem during bulk indexing. In the node logs, we see the following output:\r\n\r\n```\r\n[2017-03-28T20:41:25,132][DEBUG][o.e.a.b.TransportShardBulkAction] [test_index][0] failed to execute bulk item (index) BulkShardRequest [[test_index][0]] containing [2] requests and a refresh\r\njava.lang.NullPointerException: null\r\n\tat org.apache.lucene.util.AttributeSource.clearAttributes(AttributeSource.java:272) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.document.Field$StringTokenStream.incrementToken(Field.java:641) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:746) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:447) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:403) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:232) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:478) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1569) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1314) ~[lucene-core-6.5.0.jar:6.5.0 4b16c9a10c3c00cafaf1fc92ec3276a7bc7b8c95 - jimczi - 2017-03-21 20:40:22]\r\n\tat org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:674) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.index.engine.InternalEngine.indexIntoLucene(InternalEngine.java:625) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:587) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:561) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:549) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequestOnPrimary(TransportShardBulkAction.java:452) ~[elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequest(TransportShardBulkAction.java:134) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:218) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:117) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:75) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:967) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:945) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:113) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:327) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:269) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:900) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:897) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.index.shard.IndexShardOperationsLock.acquire(IndexShardOperationsLock.java:147) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationLock(IndexShard.java:1792) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryShardReference(TransportReplicationAction.java:909) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction.access$400(TransportReplicationAction.java:94) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:286) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:265) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:257) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:623) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:613) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.0.0-alpha1-SNAPSHOT.jar:6.0.0-alpha1-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\n```\r\n\r\nAs this might indicate a problem in Lucene, I'm assigning it to you @jpountz for further dispatching. ","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}