{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2255","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2255/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2255/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2255/events","html_url":"https://github.com/elastic/elasticsearch/issues/2255","id":6883551,"node_id":"MDU6SXNzdWU2ODgzNTUx","number":2255,"title":"Shard failures when searching multiple indices with a type filter and sort field","user":{"login":"ddecola","id":2333582,"node_id":"MDQ6VXNlcjIzMzM1ODI=","avatar_url":"https://avatars1.githubusercontent.com/u/2333582?v=4","gravatar_id":"","url":"https://api.github.com/users/ddecola","html_url":"https://github.com/ddecola","followers_url":"https://api.github.com/users/ddecola/followers","following_url":"https://api.github.com/users/ddecola/following{/other_user}","gists_url":"https://api.github.com/users/ddecola/gists{/gist_id}","starred_url":"https://api.github.com/users/ddecola/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ddecola/subscriptions","organizations_url":"https://api.github.com/users/ddecola/orgs","repos_url":"https://api.github.com/users/ddecola/repos","events_url":"https://api.github.com/users/ddecola/events{/privacy}","received_events_url":"https://api.github.com/users/ddecola/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2012-09-14T18:30:15Z","updated_at":"2014-08-01T13:30:39Z","closed_at":"2014-08-01T13:30:39Z","author_association":"NONE","active_lock_reason":null,"body":"When executing a search with both a type filter and a sort across multiple indices any shards that do not contain the target type mapping fail. While these failures can be masked by using ignore_unmapped, it seems as if the type filter should make the flag unnecessary.\n\nFor example, let there be an index aaa with a type mapping Y and another index bbb without mapping Y. A search across all indices for all records with type Y (i.e. GET /_all/Y) and sorted by a field F in Y will fail on all shards containing data for index bbb. The failed shards all throw SearchParseExceptions because there was no mapping Y found for the field F (the sort field).\n\nThis failure arises specifically because the sort field is resolved (for type information, etc) before the type filter (or any other filter) is applied. After the filters are applied there are no matching records and so no sort is needed. There does not appear to be any downside to deferring this field resolution until after the number of matched records is known to be greater than zero.\n\nSimple test case for scenario above:\n\n```\ncurl -XPUT 'localhost:9200/aaa' -d '{\n    \"settings\" : {\n        \"number_of_shards\" : 5\n    },\n    \"mappings\" : {\n        \"Y\" : {\n            \"properties\" : {\n                \"F\" : { \"type\" : \"integer\" }\n            }\n        }\n    }\n}'\n\ncurl -XPUT 'localhost:9200/bbb' -d '{\n    \"settings\" : {\n        \"number_of_shards\" : 5\n    }\n}'\n\ncurl -XPUT 'localhost:9200/aaa/Y/1' -d '{\n    \"F\" : 1\n}'\n\ncurl -XPOST 'localhost:9200/_all/Y/_search' -d '{\n     \"sort\" : [\n        { \"F\" : {\"order\" : \"asc\"} }\n    ]\n}'\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}