[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/197072222","html_url":"https://github.com/elastic/elasticsearch/issues/17124#issuecomment-197072222","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17124","id":197072222,"node_id":"MDEyOklzc3VlQ29tbWVudDE5NzA3MjIyMg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-03-15T23:54:03Z","updated_at":"2016-03-16T01:23:08Z","author_association":"MEMBER","body":"There are unit tests in place that verify that modifying these settings works as expected, and I am unable to reproduce. Against a fresh 1.7.5 node:\n\n``` bash\n19:30:20 [jason:~] $ curl -XGET localhost:9200/\n{\n  \"status\" : 200,\n  \"name\" : \"Crimson Dynamo V\",\n  \"cluster_name\" : \"elasticsearch_jason\",\n  \"version\" : {\n    \"number\" : \"1.7.5\",\n    \"build_hash\" : \"00f95f4ffca6de89d68b7ccaf80d148f1f70e4d4\",\n    \"build_timestamp\" : \"2016-02-02T09:55:30Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n19:30:33 [jason:~] $ curl -XGET localhost:9200/_cat/thread_pool?h=index.queueSize\n200\n19:30:37 [jason:~] $ curl -XPUT localhost:9200/_cluster/settings?pretty=1 -d '{\"transient\" : {\"threadpool.index.queue_size\":500}, \"persistent\": {\"threadpool.index.queue_size\":500} }'\n{\n  \"acknowledged\" : true,\n  \"persistent\" : {\n    \"threadpool\" : {\n      \"index\" : {\n        \"queue_size\" : \"500\"\n      }\n    }\n  },\n  \"transient\" : {\n    \"threadpool\" : {\n      \"index\" : {\n        \"queue_size\" : \"500\"\n      }\n    }\n  }\n}\n19:30:40 [jason:~] $ curl -XGET localhost:9200/_cat/thread_pool?h=index.queueSize\n500\n```\n\nPlus I see the logging statement:\n\n```\n[2016-03-15 19:30:37,222][DEBUG][threadpool               ] [Husk] creating thread_pool [index], type [fixed], size [8], queue_size [500]\n```\n\nwhich only happens if the thread pool is actually recreated to reflect the new queue size.\n\nDo you possibly have other settings set here such as `threadpool.index.capacity` or `threadpool.index.queue`? It's crazy that we support all of these, but either of those would override `thread pool.index.queue_size`.\n\nStarting from a fresh 1.7.5 node again:\n\n``` bash\n19:50:48 [jason:~] 7 $ curl -XGET localhost:9200/_cat/thread_pool?h=index.queueSize\n200\n19:51:08 [jason:~] $ curl -XPUT localhost:9200/_cluster/settings?pretty=1 -d '{\"transient\" : {\"threadpool.index.capacity\":500}, \"persistent\": {\"threadpool.index.capacity\":500} }'\n{\n  \"acknowledged\" : true,\n  \"persistent\" : {\n    \"threadpool\" : {\n      \"index\" : {\n        \"capacity\" : \"500\"\n      }\n    }\n  },\n  \"transient\" : {\n    \"threadpool\" : {\n      \"index\" : {\n        \"capacity\" : \"500\"\n      }\n    }\n  }\n}\n19:51:12 [jason:~] $ curl -XGET localhost:9200/_cat/thread_pool?h=index.queueSize\n500\n19:51:15 [jason:~] $ curl -XPUT localhost:9200/_cluster/settings?pretty=1 -d '{\"transient\" : {\"threadpool.index.queue_size\":200}, \"persistent\": {\"threadpool.index.queue_size\":200} }'\n{\n  \"acknowledged\" : true,\n  \"persistent\" : {\n    \"threadpool\" : {\n      \"index\" : {\n        \"queue_size\" : \"200\"\n      }\n    }\n  },\n  \"transient\" : {\n    \"threadpool\" : {\n      \"index\" : {\n        \"queue_size\" : \"200\"\n      }\n    }\n  }\n}\n19:51:37 [jason:~] $ curl -XGET localhost:9200/_cat/thread_pool?h=index.queueSize\n500\n```\n\nshowing that the `queue_size` setting has no effect after `capacity` is set. I note further that my logs match yours in this case:\n\n```\n[2016-03-15 19:51:37,497][DEBUG][cluster.service          ] [Aries] processing [cluster_update_settings]: execute\n[2016-03-15 19:51:37,497][DEBUG][cluster.service          ] [Aries] cluster state updated, version [4], source [cluster_update_settings]\n[2016-03-15 19:51:37,497][DEBUG][cluster.service          ] [Aries] publishing cluster state version 4\n[2016-03-15 19:51:37,497][DEBUG][cluster.service          ] [Aries] set local cluster state to version 4\n[2016-03-15 19:51:37,498][DEBUG][river.cluster            ] [Aries] processing [reroute_rivers_node_changed]: execute\n[2016-03-15 19:51:37,498][DEBUG][river.cluster            ] [Aries] processing [reroute_rivers_node_changed]: no change in cluster_state\n[2016-03-15 19:51:37,499][DEBUG][cluster.service          ] [Aries] processing [cluster_update_settings]: took 2ms done applying updated cluster_state (version: 4)\n[2016-03-15 19:51:37,499][DEBUG][cluster.service          ] [Aries] processing [reroute_after_cluster_update_settings]: execute\n[2016-03-15 19:51:37,499][DEBUG][cluster.service          ] [Aries] processing [reroute_after_cluster_update_settings]: took 0s no change in cluster_state\n```\n\nI will point to examples like this every time that there is an attempt at arguing that we should support more than one way to do something.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/197093892","html_url":"https://github.com/elastic/elasticsearch/issues/17124#issuecomment-197093892","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17124","id":197093892,"node_id":"MDEyOklzc3VlQ29tbWVudDE5NzA5Mzg5Mg==","user":{"login":"petitout","id":12103790,"node_id":"MDQ6VXNlcjEyMTAzNzkw","avatar_url":"https://avatars1.githubusercontent.com/u/12103790?v=4","gravatar_id":"","url":"https://api.github.com/users/petitout","html_url":"https://github.com/petitout","followers_url":"https://api.github.com/users/petitout/followers","following_url":"https://api.github.com/users/petitout/following{/other_user}","gists_url":"https://api.github.com/users/petitout/gists{/gist_id}","starred_url":"https://api.github.com/users/petitout/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petitout/subscriptions","organizations_url":"https://api.github.com/users/petitout/orgs","repos_url":"https://api.github.com/users/petitout/repos","events_url":"https://api.github.com/users/petitout/events{/privacy}","received_events_url":"https://api.github.com/users/petitout/received_events","type":"User","site_admin":false},"created_at":"2016-03-16T01:12:35Z","updated_at":"2016-03-16T01:12:35Z","author_association":"NONE","body":"With all due respect, you didn't prove that there was no issue.\n\nI also have the same behavior than you : elasticsearch seems to acknowledge the setup and is returning the updated configuration using the GET query (curl -XPUT localhost:9200/_cluster/settings?pretty=1)\n\nbut that doesn't mean that behind the hood it actually takes the configuration into account.\n\nplease retest with the steps I've provided (it fails EVERY time) :\n\n1 - recreate the context to get the \"EsRejectedExecutionException\" with a voluntarily too small value for the queue_size\n2- update the queue_size with the cluster API\n3- try again the request that previously got the \"EsRejectedExecutionException\"\n\nIf this is the way you manage issues, next time I will not waste my time opening one. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/197102722","html_url":"https://github.com/elastic/elasticsearch/issues/17124#issuecomment-197102722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17124","id":197102722,"node_id":"MDEyOklzc3VlQ29tbWVudDE5NzEwMjcyMg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-03-16T01:36:20Z","updated_at":"2016-03-16T07:01:33Z","author_association":"MEMBER","body":"> With all due respect, you didn't prove that there was no issue.\n\n@petitout With the information that you provided, I am not able to reproduce the issue that you report, and after spending an hour studying the relevant code, I provided a plausible explanation for the behavior that you're seeing, including most importantly the fact that the cluster state is updated but without logging that the thread pool is recreated. I also added the [feedback_needed](https://github.com/elastic/elasticsearch/labels/feedback_needed) label to indicate that there's a possibility that new information could alter the assessment provided here so far.\n\n> but that doesn't mean that behind the hood it actually takes the configuration into account.\n\nThe [_only_](https://github.com/elastic/elasticsearch/blob/v1.7.5/src/main/java/org/elasticsearch/threadpool/ThreadPool.java#L379) way that the new queue size is updated in the the APIs (`_cat/thread_pool` and `_cluster/settings`) is if the thread pool is actually recreated with a new work queue. In the relevant code here, for a fixed thread pool, either a new executor holder is [created](https://github.com/elastic/elasticsearch/blob/v1.7.5/src/main/java/org/elasticsearch/threadpool/ThreadPool.java#L365) with updated info but _without_ changing the queue size, or a new executor holder is [created](https://github.com/elastic/elasticsearch/blob/v1.7.5/src/main/java/org/elasticsearch/threadpool/ThreadPool.java#L380) with updated info, a new queue size, _and_ a new executor. Since you're saying that the API is outputting a _new_ queue size, it is in fact the case that the queue is correctly updated.\n\n> please retest with the steps I've provided (it fails EVERY time) :\n\nPlease provide a complete shell script that reproduces what you claim, against a _fresh_ cluster. Again, I tried and it did not reproduce for me.\n\n> If this is the way you manage issues, next time I will not waste my time opening one.\n\nI am genuinely trying to help you and I'm very sorry that you feel otherwise.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/197142866","html_url":"https://github.com/elastic/elasticsearch/issues/17124#issuecomment-197142866","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17124","id":197142866,"node_id":"MDEyOklzc3VlQ29tbWVudDE5NzE0Mjg2Ng==","user":{"login":"petitout","id":12103790,"node_id":"MDQ6VXNlcjEyMTAzNzkw","avatar_url":"https://avatars1.githubusercontent.com/u/12103790?v=4","gravatar_id":"","url":"https://api.github.com/users/petitout","html_url":"https://github.com/petitout","followers_url":"https://api.github.com/users/petitout/followers","following_url":"https://api.github.com/users/petitout/following{/other_user}","gists_url":"https://api.github.com/users/petitout/gists{/gist_id}","starred_url":"https://api.github.com/users/petitout/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/petitout/subscriptions","organizations_url":"https://api.github.com/users/petitout/orgs","repos_url":"https://api.github.com/users/petitout/repos","events_url":"https://api.github.com/users/petitout/events{/privacy}","received_events_url":"https://api.github.com/users/petitout/received_events","type":"User","site_admin":false},"created_at":"2016-03-16T04:06:02Z","updated_at":"2016-03-16T04:06:02Z","author_association":"NONE","body":"@jasontedor, I started with a fresh installation on another virtual machine and I couldn't reproduce the problem.......\nI'm truly sorry for the inconvenience\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/197310325","html_url":"https://github.com/elastic/elasticsearch/issues/17124#issuecomment-197310325","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17124","id":197310325,"node_id":"MDEyOklzc3VlQ29tbWVudDE5NzMxMDMyNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-03-16T12:58:08Z","updated_at":"2016-03-16T12:58:08Z","author_association":"MEMBER","body":"> I'm truly sorry for the inconvenience\n\n@petitout No worries!\n","performed_via_github_app":null}]