[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525302631","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-525302631","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":525302631,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTMwMjYzMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T13:32:01Z","updated_at":"2019-08-27T13:32:01Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525360242","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-525360242","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":525360242,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTM2MDI0Mg==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T15:41:26Z","updated_at":"2019-08-27T15:41:26Z","author_association":"MEMBER","body":"@droberts195 what do you think about having this check within the Datafeed node assignment? It seems to fit more naturally there and those errors still pop-up in the UI. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525366109","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-525366109","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":525366109,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTM2NjEwOQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T15:55:17Z","updated_at":"2019-08-27T15:55:17Z","author_association":"CONTRIBUTOR","body":"> what do you think about having this check within the Datafeed node assignment\r\n\r\nThe datafeed node assignment is currently \"assign the datafeed to the same node as its associated job\".  (This was originally done to avoid two network trips for the extracted data - currently when the datafeed posts the extracted data to the job even though it's calling a separate endpoint that will just involve transferring data between threads in the same JVM.)\r\n\r\nIf we changed the datafeed node assignment such that it could fail after assignment of the associated job succeeded then you could get a situation where the job is open and hogging resources while the datafeed failed to start.  This is another indication that we probably should have made datafeeds and anomaly detection jobs a single entity in the first place.\r\n\r\nIt would be very frustrating for a user if they had 2 ML nodes, one of which was permitted to do CCS and the other not, and we assigned a job whose datafeed required CCS to the node that was not allowed to do CCS and then errored when trying to assign the datafeed to that same node.\r\n\r\nSo I think if we did the check at the point of assigning the datafeed then we would have to relax the requirement that datafeeds get assigned to the same nodes as their associated jobs.  But this would probably open up whole classes of other problems.\r\n\r\nI'm currently working on the principle that we should treat datafeeds and their associated anomaly detection jobs as one thing and not worry about binding them ever more tightly together.\r\n\r\nHaving said that, if there's a quick win in having datafeeds that use CCS check the `cluster.remote.connect` setting as the first thing they do and fail fast if they find it's `false` on the node they've been allocated to then that's still an improvement over where we are today.  It will be frustrating in the case where another ML node could have successfully run the datafeed, but not as frustrating as silently failing to achieve anything like it does today.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525378623","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-525378623","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":525378623,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTM3ODYyMw==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T16:25:11Z","updated_at":"2019-08-27T19:23:21Z","author_association":"MEMBER","body":"The reason I bring this up is that there will be complications adding this check for the anomaly detection job assignment. During the node assignment phase all the checks need to be synchronous and rely on the current cluster state. This poses a problem because the datafeed task is not created yet (I think) and we would have to read the configuration via the index. \r\n\r\nHaving a \"fail fast\" path would definitely be a win, and I can write that up fairly quickly. At least that way we don't get mysterious errors when the DF attempts to start. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525645240","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-525645240","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":525645240,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTY0NTI0MA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-08-28T08:42:58Z","updated_at":"2019-08-28T08:42:58Z","author_association":"CONTRIBUTOR","body":"Yes, true, the separation between jobs and datafeeds makes this very hard.\r\n\r\nThe pragmatic approach is that we document that if you want to use CCS in datafeeds then _every_ ML node must be permitted to do CCS.  Then our error path that leaves the job open with no running datafeed in the event of a user breaching this rule is not so bad.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/604011530","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-604011530","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":604011530,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNDAxMTUzMA==","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T18:31:30Z","updated_at":"2020-03-25T18:31:30Z","author_association":"CONTRIBUTOR","body":"FWIW #53924 made this significantly easier to implement, e.g. similar implementation in transform: #54217","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/604802236","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-604802236","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":604802236,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNDgwMjIzNg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2020-03-27T03:57:26Z","updated_at":"2020-03-27T03:57:26Z","author_association":"MEMBER","body":"I think that this issue can be closed now?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/604839063","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-604839063","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":604839063,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNDgzOTA2Mw==","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"created_at":"2020-03-27T06:34:29Z","updated_at":"2020-03-27T06:34:29Z","author_association":"CONTRIBUTOR","body":"> I think that this issue can be closed now?\r\n\r\nI do not think so, but @droberts195 should know better. The task assigner for ML still needs to query the newly introduced role and assign jobs/datafeeds according to it iff a remote connection is required.\r\n\r\n(FWIW: for transforms the issue is solved, we migrated to the new node role)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/604913795","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-604913795","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":604913795,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNDkxMzc5NQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-27T09:57:51Z","updated_at":"2020-03-27T09:57:51Z","author_association":"CONTRIBUTOR","body":"The state we are currently in is that if you have a cluster where some ML nodes can do cross cluster search and some ML nodes cannot then a datafeed that requires cross cluster search will eventually fail with this error: https://github.com/elastic/elasticsearch/blob/1fc0432b244624ef800b616324f1d4d5911fcba8/x-pack/plugin/core/src/main/java/org/elasticsearch/xpack/core/ml/job/messages/Messages.java#L54\r\n\r\nIf we think that's a good enough solution to the problem then this issue can be closed.\r\n\r\nTransforms does better because if you have a cluster where some transform nodes can do cross cluster search and some transform nodes cannot then the node assignment will put the transforms that require cross cluster search on the transform nodes that can do it.\r\n\r\nWe could make ML do better, but it's non-trivial due to the job/datafeed split as detailed in earlier comments.  We would need to get the job's datafeed early in the job assignment process, check if it needed CCS, then pass an extra boolean to the job node selector to say whether CCS was required.  Then the job node selector could take this requirement into account like the transform node assignment does.\r\n\r\nI've added the `team-discuss` label so we can discuss whether it's worth putting in this effort or whether the current error message is good enough.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/605446161","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-605446161","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":605446161,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNTQ0NjE2MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2020-03-28T13:16:19Z","updated_at":"2020-03-28T13:16:19Z","author_association":"MEMBER","body":"Thanks for clarifying @hendrikmuhs and @droberts195.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/607267869","html_url":"https://github.com/elastic/elasticsearch/issues/46025#issuecomment-607267869","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46025","id":607267869,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNzI2Nzg2OQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-04-01T14:01:18Z","updated_at":"2020-04-01T14:01:18Z","author_association":"CONTRIBUTOR","body":"We discussed this and decided that it's too much of a complication to try to support ML jobs that require cross cluster search when only a subset of ML nodes can handle them.  It would make assignment much harder.  If we claimed to support it then people could legitimately question why we assigned jobs that _didn't_ require CCS to the subset of nodes that supported it and then later found ourselves unable to assign jobs requiring CCS.  Therefore we will stick with the current approach of throwing an error stating that all ML nodes must allow CCS if any job uses CCS.","performed_via_github_app":null}]