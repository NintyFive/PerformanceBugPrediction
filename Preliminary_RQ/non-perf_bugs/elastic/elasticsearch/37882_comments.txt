[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/457687283","html_url":"https://github.com/elastic/elasticsearch/issues/37882#issuecomment-457687283","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37882","id":457687283,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NzY4NzI4Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-25T19:06:45Z","updated_at":"2019-01-25T19:06:45Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/457690344","html_url":"https://github.com/elastic/elasticsearch/issues/37882#issuecomment-457690344","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37882","id":457690344,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NzY5MDM0NA==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2019-01-25T19:13:57Z","updated_at":"2019-01-25T19:13:57Z","author_association":"MEMBER","body":"Since this test has failed several times in the past month, I muted it in https://github.com/elastic/elasticsearch/commit/455f223c3a8526d7462159ab362754c890d2af6f.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/465388479","html_url":"https://github.com/elastic/elasticsearch/issues/37882#issuecomment-465388479","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37882","id":465388479,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NTM4ODQ3OQ==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2019-02-20T01:59:43Z","updated_at":"2019-02-20T02:10:50Z","author_association":"MEMBER","body":"I wasn't able to make progress debugging this locally, so I unmuted the test and enabled logging on master and 7.x.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/469833277","html_url":"https://github.com/elastic/elasticsearch/issues/37882#issuecomment-469833277","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37882","id":469833277,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTgzMzI3Nw==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2019-03-05T19:52:16Z","updated_at":"2019-03-05T19:52:16Z","author_association":"MEMBER","body":"As @jaymode described in #35503, the issue seems to be that after the tests starts, there can be a change in local shard routing, which then causes the watch service to be loaded. This in turn calls `ScheduleTriggerEngineMock#pauseExecution`, which clears all watches that this mock object holds. Subsequent calls to `ScheduleTriggerEngineMock#trigger` then fail to find the requested watches.\r\n\r\nPrior to #39277 (where we stopped triggering watches through `TimeWarp`) I'm able to consistently reproduce the error message above if I simulate a change in shard routing, and repeat the test 10 times:\r\n\r\n```\r\n--- a/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherLifeCycleService.java\r\n+++ b/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/WatcherLifeCycleService.java\r\n@@ -137,7 +137,7 @@ public class WatcherLifeCycleService implements ClusterStateListener {\r\n             .sorted(Comparator.comparing(ShardRouting::hashCode))\r\n             .collect(Collectors.toList());\r\n \r\n-        if (previousShardRoutings.get().equals(localAffectedShardRoutings) == false) {\r\n+        if (Math.random() < 0.1 || previousShardRoutings.get().equals(localAffectedShardRoutings) == false) {\r\n             if (watcherService.validate(event.state())) {\r\n                 previousShardRoutings.set(localAffectedShardRoutings);\r\n                 if (state.get() == WatcherState.STARTED) {\r\n```\r\n\r\nWith #39277, I'm no longer able to reproduce the issue. This is because when we execute a watch through the client, we load it from the index instead of retrieving it from the mock object `ScheduleTriggerEngineMock`.\r\n\r\nFor this reason, I'm planning to close the issue as 'resolved'. If we see this test fail in the same way again, we can re-open it.","performed_via_github_app":null}]