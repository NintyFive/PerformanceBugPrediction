{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13721","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13721/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13721/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13721/events","html_url":"https://github.com/elastic/elasticsearch/issues/13721","id":107770818,"node_id":"MDU6SXNzdWUxMDc3NzA4MTg=","number":13721,"title":"Leaky PatternTokenizer","user":{"login":"achow","id":1609236,"node_id":"MDQ6VXNlcjE2MDkyMzY=","avatar_url":"https://avatars0.githubusercontent.com/u/1609236?v=4","gravatar_id":"","url":"https://api.github.com/users/achow","html_url":"https://github.com/achow","followers_url":"https://api.github.com/users/achow/followers","following_url":"https://api.github.com/users/achow/following{/other_user}","gists_url":"https://api.github.com/users/achow/gists{/gist_id}","starred_url":"https://api.github.com/users/achow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/achow/subscriptions","organizations_url":"https://api.github.com/users/achow/orgs","repos_url":"https://api.github.com/users/achow/repos","events_url":"https://api.github.com/users/achow/events{/privacy}","received_events_url":"https://api.github.com/users/achow/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2015-09-22T18:20:18Z","updated_at":"2016-01-05T19:38:17Z","closed_at":"2015-09-25T10:53:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Analyzer component reuse does not interact well with `PatternTokenizer` (and possibly other tokenizers, but I haven't looked into them). https://github.com/elastic/elasticsearch/pull/6792 changed the `PatternAnalyzer` from lucene's deprecated version (that packaged its own `PatternTokenizer`) to a standalone `PatternTokenizer`. Under the hood, lucene uses `StringBuilder` to store field values during tokenization but never reclaims storage (e.g. with `trimToSize()`). This causes PatternTokenizer to grow to the largest field the Tokenizer encounters.\n\nThe use case we're encountering this issue with is using a custom `PatternTokenizer` for indexing logs, creating indices corresponding to log timestamp. We're running 1.6.2, but so far I don't see anything that this has been fixed in later versions. This really hurts with a large number of indices.\n\nI was looking into closing Analyzers when indices go inactive, but it's been a bit rough trying to find the right place to put it. I'm sure there's probably a better solution as well. Reverting https://github.com/elastic/elasticsearch/pull/6792 is an option if lucene's PatternAnalyzer can be vendored (was removed in 5.x).\n\nIn the meantime, are there any short term solutions to explicitly freeing up Analyzers? `index.blocks.read_only` looked promising, but from what I can tell, it only causes requests to be rejected and doesn't release Analyzers (though I might be mistaken). Closing and reopening indices isn't a particularly good option for our use case either.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}