{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9791","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9791/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9791/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9791/events","html_url":"https://github.com/elastic/elasticsearch/issues/9791","id":58373083,"node_id":"MDU6SXNzdWU1ODM3MzA4Mw==","number":9791,"title":"New type of aggregation","user":{"login":"zmathe","id":981448,"node_id":"MDQ6VXNlcjk4MTQ0OA==","avatar_url":"https://avatars3.githubusercontent.com/u/981448?v=4","gravatar_id":"","url":"https://api.github.com/users/zmathe","html_url":"https://github.com/zmathe","followers_url":"https://api.github.com/users/zmathe/followers","following_url":"https://api.github.com/users/zmathe/following{/other_user}","gists_url":"https://api.github.com/users/zmathe/gists{/gist_id}","starred_url":"https://api.github.com/users/zmathe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zmathe/subscriptions","organizations_url":"https://api.github.com/users/zmathe/orgs","repos_url":"https://api.github.com/users/zmathe/repos","events_url":"https://api.github.com/users/zmathe/events{/privacy}","received_events_url":"https://api.github.com/users/zmathe/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2015-02-20T16:08:49Z","updated_at":"2015-03-18T21:50:26Z","closed_at":"2015-03-02T15:05:36Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\nI am using ElasticSearch 1.4.2 and Kibana 4. I am not able to get the correct plots, because the following aggregation does not exists in Elasticsearch and also Kibana.\nGiven T1, T2, T3 ... Tn time periods. Each period contains the following element: {T1, d1:v1, d2:v2...dn:vn} where d1:v1 keys value pairs. For example: {\"09:00\",\"Product\":\"a\",\"Color\":\"red\",\"quantity\":1}, {\"09:01\",\"Product\":\"c\",\"Color\":\"blue\",\"quantity\":5}.\n\nI wanted to make a plot based on time(X axis) and quantity (Y axis).  The current elasticsearch and kibana return the \"wrong\" values in my case.\n\nThe system automatically splits the T1..Tn time interval into bucket[1],bucket[2],...,bucket[n](bucket[1]>=T1 and bucket[n]<=T[n])\n\nbucket[1] = SUM(T1) + SUM(T2)\nbucket[2] = SUM(T1) + SUM(T2)+SUM(T3)\n...\nbucket[n] = SUM(Tn-1) + SUM(Tn)\n\nThis aggregation is wrong for me. I would like to have the following:\nbucket[1] = AVG(SUM(T1) + SUM(T2))\nbucket[2] = AVG(SUM(T1) + SUM(T2)+SUM(T3))\n...\nbucket[n] = AVG(SUM(Tn-1) + SUM(Tn))\n\nFor example:\n\n![screen shot 2015-02-18 at 18 13 53](https://cloud.githubusercontent.com/assets/981448/6252348/f15a41f4-b799-11e4-8b95-0234ca142dae.png)\n\nThe bucket length is 18 minute: we have 09:00,16:12, 16:30 buckets.\n09:00 SUM(T1) + SUM(t2) = 1 + 1 + 1 + 1 + 1= 5\n16:12  SUM(T3) = 1 + 2 + 2+ 2 = 7\n16:20 SUM(T4) = 1 \n\nWhat I want to have:\n09:00 = AVG(SUM(T1) + SUM(T2)) = (2 +  3)/2 = 2.5\n16:12  AVG(SUM(T3)) = 7/1 = 7\n16:20 AVG(SUM(T4)) = 1 \n\nI provide an example which can easily reproducible using kibana 4 and the latest elasticsearch:\n-Insert the following data to elasticsearch(I used sense from marvel):\nPOST /example/transactions/_bulk\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"a\", \"time\": \"2015-02-09T09:00:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"b\", \"time\": \"2015-02-09T16:15:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"b\", \"time\": \"2015-02-09T16:30:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"a\", \"time\":\"2015-02-09T09:00:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"a\", \"time\": \"2015-02-09T09:15:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 2, \"Product\": \"b\", \"time\": \"2015-02-09T16:15:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"a\", \"time\":\"2015-02-09T09:15:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 2, \"Product\": \"b\", \"time\": \"2015-02-09T16:15:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 1, \"Product\": \"a\", \"time\": \"2015-02-09T09:15:00Z\"}\n{ \"index\": {}}\n{\"Color\": \"red\", \"quantity\": 2, \"Product\": \"b\", \"time\": \"2015-02-09T16:15:00Z\"}\n- make the query using kibana 4\n  ![screen shot 2015-02-18 at 17 31 43](https://cloud.githubusercontent.com/assets/981448/6251405/13cf497e-b794-11e4-8702-b18ad5960ba8.png)\n\nThe query made to the elasticsearch is:\n\n``` json\n{\n    \"size\": 0,\n    \"query\": {\n        \"filtered\": {\n            \"query\": {\n                \"query_string\": {\n                    \"query\": \"*\"\n                }\n            },\n            \"filter\": {\n                \"bool\": {\n                    \"must\": [{\n                        \"range\": {\n                            \"time\": {\n                                \"gte\": 1423399451544,\n                                \"lte\": 1423631917911\n                            }\n                        }\n                    }],\n                    \"must_not\": []\n                }\n            }\n        }\n    },\n    \"aggs\": {\n        \"3\": {\n            \"date_histogram\": {\n                \"field\": \"time\",\n                \"interval\": \"3600000ms\",\n                \"min_doc_count\": 1,\n                \"extended_bounds\": {\n                    \"min\": 1423399451544,\n                    \"max\": 1423631917911\n                }\n            },\n            \"aggs\": {\n                \"4\": {\n                    \"terms\": {\n                        \"field\": \"Product\",\n                        \"size\": 0,\n                        \"order\": {\n                            \"1\": \"desc\"\n                        }\n                    },\n                    \"aggs\": {\n                        \"1\": {\n                            \"sum\": {\n                                \"field\": \"quantity\"\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    },\n    \"fields\": [\"*\", \"_source\"],\n    \"script_fields\": {\n        \"time\": {\n            \"script\": \"if (doc[\\\"time\\\"].value == 0) { null } else { doc[\\\"time\\\"].value }\"\n        }\n    }\n}\n```\n\nI made a simple web page where I can make queries to ES and the result of the query is plotted. I changed the query as follow in order to make the \"correct\" plot.\n\n``` json\n{\n    \"size\": 0,\n    \"query\": {\n        \"filtered\": {\n            \"query\": {\n                \"query_string\": {\n                    \"query\": \"*\"\n                }\n            },\n            \"filter\": {\n                \"bool\": {\n                    \"must\": [\n                        {\n                            \"range\": {\n                                \"time\": {\n                                   \"gte\": 1423147775940,\n                                    \"lte\": 1423752575940\n                                }\n                            }\n                        }\n                    ],\n                    \"must_not\": []\n                }\n            }\n        }\n    },\n    \"aggs\": {\n        \"2\": {\n            \"terms\": {\n                \"size\": 0,\n                \"field\": \"Product\"\n            },\n            \"aggs\": {\n                \"end_data\": {\n                    \"date_histogram\": {\n                        \"field\": \"time\",\n                        \"interval\": \"1080000ms\",\n                        \"min_doc_count\": 1,\n                        \"extended_bounds\": {\n                           \"min\":1423147775940,\n                           \"max\":1423752575940\n                        }\n                    },\n                    \"aggs\": {\n                        \"times\": {\n                            \"terms\": {\n                                \"field\": \"time\"\n                            },\n                            \"aggs\": {\n                                \"total_jobs\": {\n                                    \"sum\": {\n                                        \"field\": \"quantity\"\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    },\n    \"fields\": [\n        \"*\",\n        \"_source\"\n    ],\n    \"script_fields\": {\n        \"time\": {\n            \"script\": \"if (doc[\\\"time\\\"].value == 0) { null } else { doc[\\\"time\\\"].value }\"\n        }\n    }\n}\n```\n\nI made the averages in JS and I got the plot what I want:\n![screen shot 2015-02-18 at 17 36 35](https://cloud.githubusercontent.com/assets/981448/6251536/b7235e62-b794-11e4-84a7-ea7eaf6ebc80.png)\n\nIs it possible to support this kind of aggregation? \n\nThank you,\nZoltan\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}