{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1512","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1512/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1512/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1512/events","html_url":"https://github.com/elastic/elasticsearch/issues/1512","id":2394391,"node_id":"MDU6SXNzdWUyMzk0Mzkx","number":1512,"title":"CouchDB river : Add support for views","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2011-11-29T22:21:07Z","updated_at":"2011-12-05T19:26:15Z","closed_at":"2011-12-05T19:26:15Z","author_association":"MEMBER","active_lock_reason":null,"body":"Real implementation of pull request #1258, as there was a problem with GitHub.\n\nIn CouchDB, you can retrieve docs by `GET`, `_changes` API and views.\nCouchDB river uses `_changes` API to get documents.\n\nI would like to be able to get documents that changed (getting ID with the _changes API) using a view with parameter `key=\"DOCID\"`.\n\nAs views return a collection of results (aka rows), we will index in ES each row with an id like DOCID_seq where seq is the sequence number of each row.\nIf you get back 3 rows for one single change for document with ID=1234, the river will index 3 documents :\n- 1234_1\n- 1234_2\n- 1234_3\n\nTo use it, you have to define a view in couchDB. For instance, `_design/vues/_view/test_dpi` with \n\n``` javascript\nfunction(doc) {\nlistArt=doc.document.articles;\n\nfor(var i=0; i<listArt.length;i++) {  \n var artJson = {};\n artJson = { 'docid' : doc._id, 'num' : listArt[i].numeroArticle };\n artJson =  JSON.stringify( artJson );\n emit(doc._id, eval('('+artJson+')') );\n};\n}\n```\n\nYou can use it in your couchDb river as follow :\n\n``` javascript\n{\n  \"type\":\"couchdb\",\n  \"couchdb\": {\n    \"host\":\"localhost\",\n    \"port\":\"5984\",\n    \"db\":\"dau_test\",\n    \"view\":\"vues/_view/test_dpi\",\n    \"viewIgnoreRemove\":false\n  }\n}\n```\n\nNew options :\n- `view` : if not null, couchDB river will not fetch content from `_changes` API but only IDs and then will use the view to retrieve rows using the ID as a key. By default : null\n- `viewIgnoreRemove` : ask the river to ignore removal of rows if there is less rows after a document update. By default : false so non existing rows will be removed from elastic search.\n\nFor example, with the 3 rows described earlier, if you push a new version of the document 1234 in couchDB with only 2 docs, \n\nIf `viewIgnoreRemove` is false (default), then\n- 1234_1 will be updated\n- 1234_2 will be updated\n- 1234_3 will be removed\n\nIf `viewIgnoreRemove` is true, then\n- 1234_1 will be updated\n- 1234_2 will be updated\n- 1234_3 will not be updated\n\nBTW, I will push an update to the pull request when the `ids_prefix` filter will be available to make code more efficient. (See issue #1259).\n\nThanks\nDavid\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}