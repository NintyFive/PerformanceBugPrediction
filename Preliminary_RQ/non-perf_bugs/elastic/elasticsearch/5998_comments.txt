[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/42002984","html_url":"https://github.com/elastic/elasticsearch/issues/5998#issuecomment-42002984","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998","id":42002984,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDAyOTg0","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2014-05-02T08:30:08Z","updated_at":"2014-05-02T08:30:08Z","author_association":"CONTRIBUTOR","body":"Thanks for looking at this, Britta. The `shard_size` setting controls the size of the shard-local PriorityQueue and defaults to a multiple of the final `size` requested by the end user to help improve accuracy. \nThe `terms` aggregation employs a similar strategy but for the reasons you point out I use a larger multiplier for the default `shard_size` in `significant_terms` because that algo is not as certain as the terms aggregation in the selections it gathers from each shard.\nHave you tried experimenting with a bigger `shard_size` to fix the accuracy issues? The best choice of shard_size will depend on your index sharding policy, the data you have stored, the chosen query/agg and the amount of RAM/network traffic you want to throw at the problem.\nBefore applying the tweaks you suggest I think it would make sense to try understand the problem better (although for the reasons I outlined above \"the problem\" can vary wildly). I think it would be useful to measure how many of \"the right\" terms found in a single-shard scenario were not found in a multi-shard scenario where we perhaps vary the number of shards and the shard_size setting. If we find we have to increase shard_size to unreasonably large settings we could employ some of the techniques you suggest and again measure the improvement based on how many of the correct results it returns.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/42022065","html_url":"https://github.com/elastic/elasticsearch/issues/5998#issuecomment-42022065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998","id":42022065,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDIyMDY1","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2014-05-02T11:52:34Z","updated_at":"2014-05-02T11:52:34Z","author_association":"CONTRIBUTOR","body":"My bad, did not try the `shard_size` parameter  - I can solve this problem for my case it I set `shard_size` to something like 30X the size parameter which is 100. \n\nA little more explanation: In my particular case I was trying to get the significant terms for wikipedia articles (only partially indexed) that contain a particular term in the title, in this case \"shoe\". I have only one shard.\nIf I try getting the top 100 terms (`min_doc_count` is 10) then with the default settings only one term is returned. I actually get 100 terms returned if I set the `shard_size` to 3k. \n\nNot sure if 3k is unreasonable and I also only tested tis one case. In addition, I do not know the true significance of the terms that are returned. The documents (only 254 contained \"shoe\" in the title) did not contain many significant terms anyway, so most of the 100 terms did not make sense and also scored low.\n\nI am still wondering if it makes sense use the `min_doc_count` parameter for determining if a candidate should be added to the pq or not. The reason is this:\nI cannot know in advance how many terms with a low `min_doc_count` will score higher than the one I with a high `min_doc_count`. Therefore this parameter must be tuned which might be tricky, since it can also depend on `size` and `min_doc_count`.\n\nOn the other hand, if there is no routing of docs to shards involved, I can maybe assume that the documents of classes and also the terms therein are distributed evenly across shards. So in that case it might be easier to not add documents to the pq that have `subsetDF <= min_doc_count/number_of_shards` (maybe not exactly but something similar) because I would assume that even when summing up the subsetDF across shards `min_doc_count` will not be reached. However, I am yet unsure if this would be more easy than setting the `shard_size` parameter properly - might depend on how rare the sought terms are and how random distribution of docs across shards really is.\n\nAnyway, this is just and idea. We could proceed with formal measurements but this might be tricky and time consuming. If 3k is reasonable for the pq size we can also close this issue for now.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/42028874","html_url":"https://github.com/elastic/elasticsearch/issues/5998#issuecomment-42028874","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998","id":42028874,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDI4ODc0","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2014-05-02T13:01:53Z","updated_at":"2014-05-02T13:01:53Z","author_association":"CONTRIBUTOR","body":"So if `shard_size` is a shard-local equivalent for the final `size` then maybe we can also introduce `shard_min_doc_count`  as an optional shard-level policy for controlling quality?\n\nOne thing to watch with Wikipedia - there tend to be a lot of very short docs that have no real wordy content on a theme but instead serve as disambiguation or synonym type entries. It can be important to tune these out from these sorts of analysis.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/42164644","html_url":"https://github.com/elastic/elasticsearch/issues/5998#issuecomment-42164644","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5998","id":42164644,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMTY0NjQ0","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2014-05-05T07:30:44Z","updated_at":"2014-05-05T07:30:44Z","author_association":"CONTRIBUTOR","body":"I like the `shard_min_doc_count` parameter. I'll prepare a pull request for that.\n","performed_via_github_app":null}]