{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20192","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20192/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20192/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20192/events","html_url":"https://github.com/elastic/elasticsearch/issues/20192","id":173592747,"node_id":"MDU6SXNzdWUxNzM1OTI3NDc=","number":20192,"title":"Replica recoveries can get stuck on concurrent primary relocation","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-08-27T11:57:14Z","updated_at":"2017-06-30T10:24:49Z","closed_at":"2017-06-30T10:24:49Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Failing test:\n\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+java9-periodic/1113/consoleFull\n\nScenario:\n\nPrimary relocation is ongoing while concurrent replica relocation is ongoing. Primary relocation completes, which results in the replica recovery being cancelled, which is done using `RecoverySourceHandler#cancel(...)`. This results in an exception being thrown on the recovery thread of the replica. The first thing to notice in the test failure above is that the wrong exception type is being thrown (`ExecutionCancelledException` instead of `IndexShardClosedException`). The reason is that the code selecting the exception type (here: https://github.com/elastic/elasticsearch/blob/f6aeb35ce8244f4e60cb827cccb42a359f3a2862/core/src/main/java/org/elasticsearch/indices/recovery/RecoverySourceHandler.java#L92 ) gets to run before the shard state has actually moved to closed (cancel is called in `beforeIndexShardClosed` in `RecoverySource`).\n\nThe `ExecutionCancelledException` gets propagated back to the replica recovery target node. `RecoveryTargetService` deals with this exception by first failing the recovery and then in a second step removing the shard (but not sending a shard failed message to the master).\nBetween the first and second step, the replica node is applying the cluster state update where primary relocation has completed. In `IndicesClusterStateService`, the `IndexShard` that will be removed is still visible. `IndicesClusterStateService` notices that the recovery source changed (as primary relocation completed), but also sees that there are no more ongoing recoveries for the shard (see here: https://github.com/elastic/elasticsearch/blob/1825d8060c47cd5d82c2afd8b333930fd632c387/core/src/main/java/org/elasticsearch/indices/cluster/IndicesClusterStateService.java#L379). This means that it considers recovery completed for that shard and does nothing. After the `IndicesClusterStateService` is finished applying the CS update, the shard is then being removed by failed recovery (with no shard failure message being sent to the master).\n\nIf there are no more cluster state updates after that, the cluster state will show the replica as initializing on the node but no actual recovery will be ongoing (`IndexShard` was removed).\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}