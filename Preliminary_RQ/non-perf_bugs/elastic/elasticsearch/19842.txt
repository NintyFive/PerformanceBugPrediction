{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19842","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19842/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19842/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19842/events","html_url":"https://github.com/elastic/elasticsearch/issues/19842","id":169685374,"node_id":"MDU6SXNzdWUxNjk2ODUzNzQ=","number":19842,"title":"Elasticsearch remains unhealthy because master node doesn't think its master","user":{"login":"mkelkarbv","id":8582461,"node_id":"MDQ6VXNlcjg1ODI0NjE=","avatar_url":"https://avatars1.githubusercontent.com/u/8582461?v=4","gravatar_id":"","url":"https://api.github.com/users/mkelkarbv","html_url":"https://github.com/mkelkarbv","followers_url":"https://api.github.com/users/mkelkarbv/followers","following_url":"https://api.github.com/users/mkelkarbv/following{/other_user}","gists_url":"https://api.github.com/users/mkelkarbv/gists{/gist_id}","starred_url":"https://api.github.com/users/mkelkarbv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mkelkarbv/subscriptions","organizations_url":"https://api.github.com/users/mkelkarbv/orgs","repos_url":"https://api.github.com/users/mkelkarbv/repos","events_url":"https://api.github.com/users/mkelkarbv/events{/privacy}","received_events_url":"https://api.github.com/users/mkelkarbv/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2016-08-05T20:02:59Z","updated_at":"2016-08-12T16:53:25Z","closed_at":"2016-08-12T16:53:24Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 1.7.3\n\nJVM version: openjdk version \"1.8.0_65\"\nOpenJDK Runtime Environment (build 1.8.0_65-b17)\nOpenJDK 64-Bit Server VM (build 25.65-b01, mixed mode)\n\nOS version: Amazon linux 3.14.35-28.38.amzn1.x86_64\n\n**Description of the problem including expected versus actual behavior**:\nExpected behavior: elasticsearch becomes healthy.\n\nActual behavior: elasticsearch remains unhealthy..\n\nIf the master eligible node does not find minimum number of master eligible nodes in the cluster, then it thinks its not the master node. Even though master eligible nodes become available later, it continues to think its not master, and rejects join requests. It does not re-evaluate its master status even though minimum number of master eligible nodes become available later...\n\nsequence of events:\n1. the chosen master node starts and does not see other master eligible nodes. We have gateway.expected_master_nodes= 3 elasticsearch config.\n2. The chosen master node thinks its not master...\n3. Other master eligible nodes come up and try to contact the chosen master node, and their request s get rejected...\n\nrestarting the chosen master node does not resolve the problem. However, full cluster restart fixes it..\n\n**Steps to reproduce**:\n1. Create a ES cluster with gateway.expected_master_nodes= 3 in config with dedicated client, master and data nodes.\n2. Make sure the chosen client node starts first, and other master eligible nodes start after it.\n3. Start other master eligible nodes, and see how their requests get rejected...\n\n**Provide logs (if relevant)**:\n\nHere are some logs that we see when this happens -\n\nfrom chosen master node -\n\n`[2016-07-19 15:51:12,695][WARN ][discovery.ec2] [10-100-52-166] not enough master nodes, current nodes: {{client_bv=false, availability_zone=a, master=false},{client_bv=false, availability_zone=a, data=false, master=true},{data=false, client=true},{data=false, client=true}}\n`\n\nFrom the other master eligible nodes - \n\n`[2016-07-19 15:49:44,168][DEBUG][action.admin.cluster.health] [10-100-61-115] no known master node, scheduling a retry\n[2016-07-19 15:50:07,936][INFO ][discovery.ec2]failed to send join request to master [10-100-52-166][Be-E2WoeQ02g9APPaTP_AQ]{client_bv=false, availability_zone=a, data=false, master=true}], reason [RemoteTransportException[[10-100-52-166]][internal:discovery/zen/join]]; nested: ElasticsearchIllegalStateException[Node [[10-100-52-166][Be-E2WoeQ02g9APPaTP_AQ][10-100-52-166][inet[/10.100.52.166:9300]]{client_bv=false, availability_zone=a, data=false, master=true}] not master for join request from [[10-100-61-115][EMVPvC_5TACp44kIpzpxWg][10-100-61-115][inet[/10.100.61.115:9300]]{client_bv=false, availability_zone=c, data=false, master=true}]]; ], tried [3] times\n`\n\n`[2016-07-19 15:51:59,473][DEBUG][action.admin.cluster.health] [10-100-61-115] observer: timeout notification from cluster service. timeout setting [30s], time since start [30s]\n[2016-07-19 15:52:08,885][INFO ][discovery.ec2            ] [10-100-61-115] failed to send join request to master [[10-100-61-166][Be-E2WoeQ02g9APPaTP_AQ][10-100-52-166][inet[/10.100.52.166:9300]]{client_bv=false, availability_zone=a, data=false, master=true}], reason [RemoteTransportException[[10-100-52-166][inet[/10.100.52.166:9300]][internal:discovery/zen/join]]; nested: ElasticsearchIllegalStateException[Node [[10-100-52-166][Be-E2WoeQ02g9APPaTP_AQ][10-100-52-166][inet[/10.100.52.166:9300]]{client_bv=false, availability_zone=a, data=false, master=true}] not master for join request from [[10-100-61-115][EMVPvC_5TACp44kIpzpxWg][10-100-61-115][inet[/10.100.61.115:9300]]{client_bv=false, availability_zone=c, data=false, master=true}]]; ], tried [3] times`\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}