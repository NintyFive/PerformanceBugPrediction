[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/417517312","html_url":"https://github.com/elastic/elasticsearch/issues/33291#issuecomment-417517312","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33291","id":417517312,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNzUxNzMxMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-31T01:10:32Z","updated_at":"2018-08-31T01:10:32Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429879826","html_url":"https://github.com/elastic/elasticsearch/issues/33291#issuecomment-429879826","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33291","id":429879826,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTg3OTgyNg==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2018-10-15T14:39:33Z","updated_at":"2018-10-15T14:39:33Z","author_association":"CONTRIBUTOR","body":"Occurred again https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+multijob-unix-compatibility/os=centos/58/console\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :x-pack:qa:smoke-test-watcher-with-security:integTestRunner \\\r\n  -Dtests.seed=484163AFA937AD5E \\\r\n  -Dtests.class=org.elasticsearch.smoketest.SmokeTestWatcherWithSecurityIT \\\r\n  -Dtests.method=\"testSearchTransformInsufficientPermissions\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=it \\\r\n  -Dtests.timezone=Antarctica/Mawson \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/435200954","html_url":"https://github.com/elastic/elasticsearch/issues/33291#issuecomment-435200954","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33291","id":435200954,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNTIwMDk1NA==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2018-11-01T21:56:45Z","updated_at":"2018-11-01T21:56:45Z","author_association":"CONTRIBUTOR","body":"I haven't reproduced this exact issue... but stepping through the code, there appears to be a bug in the start/stop logic in `SmokeTestWatcherWithSecurityIT` such that it does not busy wait as (I believe) is the intent of the code. \r\n\r\nStarting Watcher [here](https://github.com/elastic/elasticsearch/blob/master/x-pack/qa/smoke-test-watcher-with-security/src/test/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java#L41) is wrapped in an `assertBusy()` which appears to attempt to wait for 10 seconds max until the Watcher is indeed started. However, the `break` [here](https://github.com/elastic/elasticsearch/blob/master/x-pack/qa/smoke-test-watcher-with-security/src/test/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java#L66) allows not only to break the switch, but also effectively stops the busy wait logic since it exits the lamda normally. [assertBusy](https://github.com/elastic/elasticsearch/blob/master/test/framework/src/main/java/org/elasticsearch/test/ESTestCase.java#L837) only busy waits while an `assertionError` is getting thrown in the (lamda) code block. \r\n\r\nStop Watcher has the same bug [here](https://github.com/elastic/elasticsearch/blob/master/x-pack/qa/smoke-test-watcher-with-security/src/test/java/org/elasticsearch/smoketest/SmokeTestWatcherWithSecurityIT.java#L111) (note the assertion in both is asserting the success/failure of the http call, not the state of Watcher)... and it looks like `SmokeTestWatcherWithSecurityClientYamlTestSuiteIT` may have the same issue (but haven't stepped trough that yet). \r\n\r\nThis means that Watcher is not guaranteed to be started or stopped between tests since it is not properly blocking till started or stopped, and is likely the root cause of many of these Watcher failures. \r\n\r\nI believe the fix is to simply change the `break` to a `AssertionError` for the state change switches. \r\n\r\nAlso, this specific test is _peculiar_ since it can pass without Watcher ever started. \r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/442927086","html_url":"https://github.com/elastic/elasticsearch/issues/33291#issuecomment-442927086","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33291","id":442927086,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MjkyNzA4Ng==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-11-29T17:44:27Z","updated_at":"2018-11-29T17:44:27Z","author_association":"MEMBER","body":"@jakelandis I got something that looks quite similar to this today on 6.5, not sure if this should have been fixed you your PR\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.5+multijob-unix-compatibility/os=centos/70/console\r\n\r\n```\r\n./gradlew :x-pack:qa:smoke-test-watcher-with-security:integTestRunner \\\r\n  -Dtests.seed=2EA37470CE126E3E \\\r\n  -Dtests.class=org.elasticsearch.smoketest.SmokeTestWatcherWithSecurityIT \\\r\n  -Dtests.method=\"testSearchTransformInsufficientPermissions\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=es-UY \\\r\n  -Dtests.timezone=ART \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n```\r\njava.lang.AssertionError: \r\nExpected: is a value equal to or greater than <1>\r\n     but: <0> was less than <1>\r\n\tat __randomizedtesting.SeedInfo.seed([2EA37470CE126E3E:B3D6708EEF1969D3]:0)\r\n\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n\tat org.junit.Assert.assertThat(Assert.java:956)\r\n\tat org.junit.Assert.assertThat(Assert.java:923)\r\n\tat org.elasticsearch.smoketest.SmokeTestWatcherWithSecurityIT.lambda$getWatchHistoryEntry$3(SmokeTestWatcherWithSecurityIT.java:328)\r\n\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:848)\r\n\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:822)\r\n\tat org.elasticsearch.smoketest.SmokeTestWatcherWithSecurityIT.getWatchHistoryEntry(SmokeTestWatcherWithSecurityIT.java:306)\r\n\tat org.elasticsearch.smoketest.SmokeTestWatcherWithSecurityIT.getWatchHistoryEntry(SmokeTestWatcherWithSecurityIT.java:301)\r\n\tat org.elasticsearch.smoketest.SmokeTestWatcherWithSecurityIT.testSearchTransformInsufficientPermissions(SmokeTestWatcherWithSecurityIT.java:237)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/495771962","html_url":"https://github.com/elastic/elasticsearch/issues/33291#issuecomment-495771962","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33291","id":495771962,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NTc3MTk2Mg==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-05-24T20:02:32Z","updated_at":"2019-05-24T20:02:32Z","author_association":"CONTRIBUTOR","body":"Un-muted this test on PR #42409 to obtain additional logs. \r\n\r\nIf (when?) this test fails again please obtain the following information before muting the test:\r\n\r\n* Copy of the relevant failure\r\n* Copy of the reproduce line\r\n* The Jenkins build link \r\n* The Gradle scan link\r\n* The relevant cluster logs from \"Google Cloud Storage Upload Report\" (link found in Jenkins build)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/574161795","html_url":"https://github.com/elastic/elasticsearch/issues/33291#issuecomment-574161795","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33291","id":574161795,"node_id":"MDEyOklzc3VlQ29tbWVudDU3NDE2MTc5NQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-01-14T12:58:21Z","updated_at":"2020-01-14T12:58:21Z","author_association":"MEMBER","body":"Closing in favour of #30777 as this test fails in [a similar way](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-90d,mode:quick,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:e58bf320-7efd-11e8-bf69-63c8ef516157,key:test,negate:!f,params:(query:testSearchTransformInsufficientPermissions,type:phrase),type:phrase,value:testSearchTransformInsufficientPermissions),query:(match:(test:(query:testSearchTransformInsufficientPermissions,type:phrase))))),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'class:*SmokeTestWatcherWithSecurityIT'),sort:!(time,desc))) as the mentioned issue.\r\n\r\nPR #50931 will add more logging in case this fails again.","performed_via_github_app":null}]