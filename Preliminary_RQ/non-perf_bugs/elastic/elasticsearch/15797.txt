{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15797","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15797/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15797/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15797/events","html_url":"https://github.com/elastic/elasticsearch/issues/15797","id":125233399,"node_id":"MDU6SXNzdWUxMjUyMzMzOTk=","number":15797,"title":"Support multi level nested filters inside sort","user":{"login":"sumitjainn","id":657557,"node_id":"MDQ6VXNlcjY1NzU1Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/657557?v=4","gravatar_id":"","url":"https://api.github.com/users/sumitjainn","html_url":"https://github.com/sumitjainn","followers_url":"https://api.github.com/users/sumitjainn/followers","following_url":"https://api.github.com/users/sumitjainn/following{/other_user}","gists_url":"https://api.github.com/users/sumitjainn/gists{/gist_id}","starred_url":"https://api.github.com/users/sumitjainn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sumitjainn/subscriptions","organizations_url":"https://api.github.com/users/sumitjainn/orgs","repos_url":"https://api.github.com/users/sumitjainn/repos","events_url":"https://api.github.com/users/sumitjainn/events{/privacy}","received_events_url":"https://api.github.com/users/sumitjainn/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-01-06T18:26:38Z","updated_at":"2018-03-21T18:53:29Z","closed_at":"2018-03-21T18:53:28Z","author_association":"NONE","active_lock_reason":null,"body":"I have hotel docs which have multiple rooms and each room has day wise price and inventory.\nhotel > room > priceInventory\n\nI have filters on all three levels. Say hotels with 5 star rating, rooms with \"free wifi\" amenity and having inventory of 2 for dates d1-d2 and between price p1-p2.\n\n`For sorting, I want to calculate minimum price from all matched nested docs. But this isn't possible with regular sort, as I cannot specify filters on multiple nested levels inside it.` So I have to utilize script sorting. But inside a script accessing nested level fields is only possible with the _source field which is non-performant as described in https://github.com/elastic/elasticsearch/issues/15767.\n\nConverting this to single nesting level and copying room attributes in every invPrice doesn't work either \ndue to loss of grouping.\n\nMapping:\n\n``` json\n        \"hotel\": {\n            \"properties\": {\n               \"name\": {\n                  \"type\": \"string\",\n               },\n               \"id\": {\n                  \"type\": \"string\",\n               },\n               \"roomTypes\": {\n                  \"type\": \"nested\",\n                  \"properties\": {\n                     \"roomCode\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                     },\n                     \"roomType\": {\n                        \"type\": \"string\",\n                        \"index\": \"not_analyzed\",\n                     },\n                     \"amenities\": {\n                          \"type\": \"string\",\n                          \"index\": \"not_analyzed\",\n                     },\n                     \"invPrice\": {\n                          \"type\": \"nested\",\n                          \"properties\": {\n                             \"date\": {\n                                \"type\": \"date\",\n                                \"format\": \"dateOptionalTime\",\n                             },\n                             \"inventory\": {\n                                \"type\": \"integer\",\n                             },\n                             \"price\": {\n                                \"type\": \"double\",\n                             }\n                          }\n                       }\n                  }\n               },\n               \"starRating\": {\n                  \"type\": \"short\",\n               }\n            }\n        }\n```\n","closed_by":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"performed_via_github_app":null}