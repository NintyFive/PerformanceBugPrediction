[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48724820","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-48724820","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":48724820,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzI0ODIw","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-07-11T12:34:02Z","updated_at":"2014-07-11T12:34:02Z","author_association":"CONTRIBUTOR","body":"Do you have many unique field names that are analyzed?\n\nIf so, you may be hitting\nhttps://github.com/elasticsearch/elasticsearch/pull/6714 which is fixed in\n1.3 (along with some other optimizations for the many-unique-fields case).\n Are you able to test on the 1.x snapshot build to see if that fixes it?\n\nMike McCandless\n\nhttp://blog.mikemccandless.com\n\nOn Fri, Jul 11, 2014 at 7:10 AM, Aldian-fr notifications@github.com wrote:\n\n> Hi.\n> \n> I am struggling with Elasticsearch consuming too much heap memory, forcing\n> me to restart it every two weeks. To better understand the problem, I went\n> as far as analyzing a memory dump. This analysis was not performed after a\n> crash because I cannot afford waiting for a crash if I can avoid it, but I\n> waited for the heap reaching 1.7GB (on 1.9GB allowed) to perform a heap\n> dump and make an analysis. Once clean of every free object the final heap\n> dump size is about 1.5GB. Here is the overview I got from MAT.\n> \n> [image: 00_overview]\n> https://cloud.githubusercontent.com/assets/2630481/3551512/3e2f1da8-08e8-11e4-88d9-f388989c43a2.png\n> \n> Next I opened the dominator tree and grouped by class name. Here is the\n> result:\n> \n> [image: 01_dominator_tree_group_by_class]\n> https://cloud.githubusercontent.com/assets/2630481/3551547/9836bb1c-08e8-11e4-945f-66617d865942.png\n> \n> As you can see there are 63% (1GB) of HashMap objects. In some situations\n> where HashMaps are used as a cache this can be normal. But still it seems\n> worth investigating. Lets see what is nested in:\n> \n> [image: 02_hashmap_global]\n> https://cloud.githubusercontent.com/assets/2630481/3551576/edfbe856-08e8-11e4-8e4c-c6af44501ca2.png\n> \n> Wow! 755MB of strings. That is quite a lot. Now lets take a look at what\n> can be inside it. First we will stop grouping by class in the dominator\n> tree, and rather filter on HashMaps objects. Here it is:\n> \n> [image: 03_hashmap_list]\n> https://cloud.githubusercontent.com/assets/2630481/3551600/54a5ad9e-08e9-11e4-927d-1ef26e9310b9.png\n> \n> Ok so there are 9000 of them. Next lets open one of them to inspect what\n> is inside it:\n> \n> [image: 04_hashmap_detail]\n> https://cloud.githubusercontent.com/assets/2630481/3551630/c162ab58-08e9-11e4-9ea8-bf3897aeedfa.png\n> \n> Seems kinda like a log entry if you ask me. Should have mentioned it\n> earlier, but I am using the usual stack Logstash/Elasticsearch/Kibana to\n> monitor a java application. We have stacktraces in the logs and some of\n> them are quite long and we use a multiline filter in logstash to gather\n> them in a single message. No doubt that it is what happened here.\n> \n> Please not that I am not saying that all 9000 Hashmaps contain log\n> entries, actually even in the toped ranked 300ko Hashmaps I found some that\n> do not contain that kind of stuff. But as far as I have seen, it happens\n> quite often. The tokenizer seem to have a fixed 4096 char array size, and\n> since there was around 750M char[] in the heap dump, I would assume that\n> there may be 92000 of them.\n> \n> Now I know that it is normal that the heap would keep growing since I am\n> continuously indexing new stuff and such, but every day at midnight when it\n> compress the index, it should as weel free all those tokenizer stuff. Since\n> I get the memory back to 1.1GB every time I restart ElasticSearch, this is\n> the proof that the memory from 1.1GB to 1.7GB is just leaking. Or maybe\n> there is something wrong with the configuration of ElasticSearch? I am\n> using the default, I just changed allowed memory from 1GB to 2GB, was there\n> something else important to do?\n> \n> What do you think?\n> \n> â€”\n> Reply to this email directly or view it on GitHub\n> https://github.com/elasticsearch/elasticsearch/issues/6831.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48730654","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-48730654","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":48730654,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzMwNjU0","user":{"login":"Aldian-fr","id":2630481,"node_id":"MDQ6VXNlcjI2MzA0ODE=","avatar_url":"https://avatars2.githubusercontent.com/u/2630481?v=4","gravatar_id":"","url":"https://api.github.com/users/Aldian-fr","html_url":"https://github.com/Aldian-fr","followers_url":"https://api.github.com/users/Aldian-fr/followers","following_url":"https://api.github.com/users/Aldian-fr/following{/other_user}","gists_url":"https://api.github.com/users/Aldian-fr/gists{/gist_id}","starred_url":"https://api.github.com/users/Aldian-fr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Aldian-fr/subscriptions","organizations_url":"https://api.github.com/users/Aldian-fr/orgs","repos_url":"https://api.github.com/users/Aldian-fr/repos","events_url":"https://api.github.com/users/Aldian-fr/events{/privacy}","received_events_url":"https://api.github.com/users/Aldian-fr/received_events","type":"User","site_admin":false},"created_at":"2014-07-11T13:36:42Z","updated_at":"2014-07-11T13:38:05Z","author_association":"NONE","body":"I believe I don't have that many. According to Kibana I only have 20 different fields:\n\n@timestamp\n@version\n_id\n_index\n_type\nclassname\ncommand\nexception\nhost\nid_cam\nid_com\nidsession\nip\nlog_date\nlog_level\nmessage\nmsg\nport\ntags\ntype\n\nBut I have 27 input types (The application is splitted across 27 servers). If you are making the same thing as for the mapping and treating separately each input type, that would make 20*27=540 fields.\n\nAlso I can't beta test since this is a production server and I don't have the problem on my test platform. But I will surely upgrade once you release 1.3\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48733460","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-48733460","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":48733460,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzMzNDYw","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-07-11T14:01:07Z","updated_at":"2014-07-11T14:01:07Z","author_association":"CONTRIBUTOR","body":"Hmm I don't think the 27 different input types would multiply out the fields.  You don't use any dynamic_templates (this creates new Lucene fields under-the-hood).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/48734012","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-48734012","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":48734012,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NzM0MDEy","user":{"login":"Aldian-fr","id":2630481,"node_id":"MDQ6VXNlcjI2MzA0ODE=","avatar_url":"https://avatars2.githubusercontent.com/u/2630481?v=4","gravatar_id":"","url":"https://api.github.com/users/Aldian-fr","html_url":"https://github.com/Aldian-fr","followers_url":"https://api.github.com/users/Aldian-fr/followers","following_url":"https://api.github.com/users/Aldian-fr/following{/other_user}","gists_url":"https://api.github.com/users/Aldian-fr/gists{/gist_id}","starred_url":"https://api.github.com/users/Aldian-fr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Aldian-fr/subscriptions","organizations_url":"https://api.github.com/users/Aldian-fr/orgs","repos_url":"https://api.github.com/users/Aldian-fr/repos","events_url":"https://api.github.com/users/Aldian-fr/events{/privacy}","received_events_url":"https://api.github.com/users/Aldian-fr/received_events","type":"User","site_admin":false},"created_at":"2014-07-11T14:05:34Z","updated_at":"2014-07-11T14:05:59Z","author_association":"NONE","body":"No nothing like this. Except if Logstash does it. In fact, only logstash writes in ES (I believe Kibana also saves its dashboards), but I did not tune Elasticsearch at all, except for setting its allowed memory to 2GB\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/50866021","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-50866021","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":50866021,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODY2MDIx","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-08-01T09:30:49Z","updated_at":"2014-08-01T09:30:49Z","author_association":"CONTRIBUTOR","body":"Did you try upgrading to 1.3.1?  Did memory usage improve?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/51323270","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-51323270","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":51323270,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMzIzMjcw","user":{"login":"Aldian-fr","id":2630481,"node_id":"MDQ6VXNlcjI2MzA0ODE=","avatar_url":"https://avatars2.githubusercontent.com/u/2630481?v=4","gravatar_id":"","url":"https://api.github.com/users/Aldian-fr","html_url":"https://github.com/Aldian-fr","followers_url":"https://api.github.com/users/Aldian-fr/followers","following_url":"https://api.github.com/users/Aldian-fr/following{/other_user}","gists_url":"https://api.github.com/users/Aldian-fr/gists{/gist_id}","starred_url":"https://api.github.com/users/Aldian-fr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Aldian-fr/subscriptions","organizations_url":"https://api.github.com/users/Aldian-fr/orgs","repos_url":"https://api.github.com/users/Aldian-fr/repos","events_url":"https://api.github.com/users/Aldian-fr/events{/privacy}","received_events_url":"https://api.github.com/users/Aldian-fr/received_events","type":"User","site_admin":false},"created_at":"2014-08-06T11:36:35Z","updated_at":"2014-08-06T16:23:43Z","author_association":"NONE","body":"I am planning to try the upgrade this afternoon. I will tell you in a week or two.\n\nEdit: Upgrade successful but the deactivation by default of JSONP broke my Bigdesk. For the time being I am blind about the server health. Will take a look about how to reactivate it.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/51800964","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-51800964","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":51800964,"node_id":"MDEyOklzc3VlQ29tbWVudDUxODAwOTY0","user":{"login":"Aldian-fr","id":2630481,"node_id":"MDQ6VXNlcjI2MzA0ODE=","avatar_url":"https://avatars2.githubusercontent.com/u/2630481?v=4","gravatar_id":"","url":"https://api.github.com/users/Aldian-fr","html_url":"https://github.com/Aldian-fr","followers_url":"https://api.github.com/users/Aldian-fr/followers","following_url":"https://api.github.com/users/Aldian-fr/following{/other_user}","gists_url":"https://api.github.com/users/Aldian-fr/gists{/gist_id}","starred_url":"https://api.github.com/users/Aldian-fr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Aldian-fr/subscriptions","organizations_url":"https://api.github.com/users/Aldian-fr/orgs","repos_url":"https://api.github.com/users/Aldian-fr/repos","events_url":"https://api.github.com/users/Aldian-fr/events{/privacy}","received_events_url":"https://api.github.com/users/Aldian-fr/received_events","type":"User","site_admin":false},"created_at":"2014-08-11T16:03:49Z","updated_at":"2014-08-11T16:03:49Z","author_association":"NONE","body":"Unfortunately I had to restart the server to reactivate JSONP (required for Bigdesk to work). There should be some tuning about this security, like allways allowing JSONP for requests coming from the localhost.\n\nI will take a look in two weeks to see if 1.3.1 solved the heap problem.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/51808964","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-51808964","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":51808964,"node_id":"MDEyOklzc3VlQ29tbWVudDUxODA4OTY0","user":{"login":"lukas-vlcek","id":205174,"node_id":"MDQ6VXNlcjIwNTE3NA==","avatar_url":"https://avatars2.githubusercontent.com/u/205174?v=4","gravatar_id":"","url":"https://api.github.com/users/lukas-vlcek","html_url":"https://github.com/lukas-vlcek","followers_url":"https://api.github.com/users/lukas-vlcek/followers","following_url":"https://api.github.com/users/lukas-vlcek/following{/other_user}","gists_url":"https://api.github.com/users/lukas-vlcek/gists{/gist_id}","starred_url":"https://api.github.com/users/lukas-vlcek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukas-vlcek/subscriptions","organizations_url":"https://api.github.com/users/lukas-vlcek/orgs","repos_url":"https://api.github.com/users/lukas-vlcek/repos","events_url":"https://api.github.com/users/lukas-vlcek/events{/privacy}","received_events_url":"https://api.github.com/users/lukas-vlcek/received_events","type":"User","site_admin":false},"created_at":"2014-08-11T17:04:26Z","updated_at":"2014-08-11T17:04:26Z","author_association":"CONTRIBUTOR","body":"Speaking of Bigdesk, it hasn't been announced yet but there are some new\nreleases including fix for missing JSONP support (for Elasticsearch 1.3.x).\nSee release notes for details [1].\n\nBefore this is \"officially\" announced I want to upload new online versions\n[2] too, however, if you install Bigdesk via plugin script you can use it\nright now.\n\nRegards,\nLukas\n\n[1] https://github.com/lukas-vlcek/bigdesk#release-notes\n[2] bigdesk.org/v/\n\nOn Mon, Aug 11, 2014 at 6:03 PM, Aldian-fr notifications@github.com wrote:\n\n> Unfortunately I had to restart the server to reactivate JSONP (required\n> for Bigdesk to work). There should be some tuning about this security, like\n> allways allowing JSONP for requests coming from the localhost.\n> \n> I will take a look in two weeks to see if 1.3.1 solved the heap problem.\n> \n> â€”\n> Reply to this email directly or view it on GitHub\n> https://github.com/elasticsearch/elasticsearch/issues/6831#issuecomment-51800964\n> .\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/53238546","html_url":"https://github.com/elastic/elasticsearch/issues/6831#issuecomment-53238546","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6831","id":53238546,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMjM4NTQ2","user":{"login":"Aldian-fr","id":2630481,"node_id":"MDQ6VXNlcjI2MzA0ODE=","avatar_url":"https://avatars2.githubusercontent.com/u/2630481?v=4","gravatar_id":"","url":"https://api.github.com/users/Aldian-fr","html_url":"https://github.com/Aldian-fr","followers_url":"https://api.github.com/users/Aldian-fr/followers","following_url":"https://api.github.com/users/Aldian-fr/following{/other_user}","gists_url":"https://api.github.com/users/Aldian-fr/gists{/gist_id}","starred_url":"https://api.github.com/users/Aldian-fr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Aldian-fr/subscriptions","organizations_url":"https://api.github.com/users/Aldian-fr/orgs","repos_url":"https://api.github.com/users/Aldian-fr/repos","events_url":"https://api.github.com/users/Aldian-fr/events{/privacy}","received_events_url":"https://api.github.com/users/Aldian-fr/received_events","type":"User","site_admin":false},"created_at":"2014-08-25T08:15:49Z","updated_at":"2014-08-25T08:15:49Z","author_association":"NONE","body":"Two weeks after upgrading to 1.3.1, the heap consumption is stable. BigDesk reports 900 MB used over 1.9GB committed, which is about the same as after the last restart. Seems like the heap memory leak is gone. I am closing this. Thank you very much.\n\n@lukas-vlcek thanks for the info. I will be trying this for the next upgrade ;)\n","performed_via_github_app":null}]