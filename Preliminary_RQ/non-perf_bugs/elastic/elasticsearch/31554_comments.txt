[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/399955700","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-399955700","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":399955700,"node_id":"MDEyOklzc3VlQ29tbWVudDM5OTk1NTcwMA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-06-25T13:41:27Z","updated_at":"2018-06-25T13:41:27Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/400356294","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-400356294","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":400356294,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMDM1NjI5NA==","user":{"login":"luciansabo","id":7838978,"node_id":"MDQ6VXNlcjc4Mzg5Nzg=","avatar_url":"https://avatars2.githubusercontent.com/u/7838978?v=4","gravatar_id":"","url":"https://api.github.com/users/luciansabo","html_url":"https://github.com/luciansabo","followers_url":"https://api.github.com/users/luciansabo/followers","following_url":"https://api.github.com/users/luciansabo/following{/other_user}","gists_url":"https://api.github.com/users/luciansabo/gists{/gist_id}","starred_url":"https://api.github.com/users/luciansabo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luciansabo/subscriptions","organizations_url":"https://api.github.com/users/luciansabo/orgs","repos_url":"https://api.github.com/users/luciansabo/repos","events_url":"https://api.github.com/users/luciansabo/events{/privacy}","received_events_url":"https://api.github.com/users/luciansabo/received_events","type":"User","site_admin":false},"created_at":"2018-06-26T15:38:34Z","updated_at":"2018-06-26T15:38:34Z","author_association":"NONE","body":"I can confirm this happening on 6.2 and 6.3. If you reindex all items that need to be sorted soring works correctly. I think it uses some kind of cache because if you update a single document, the first non-matching document appears on the same position, shifting the items.\r\nA possible workaround is to use function_score.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401165457","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401165457","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401165457,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTE2NTQ1Nw==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-06-28T20:37:13Z","updated_at":"2018-06-28T20:37:13Z","author_association":"CONTRIBUTOR","body":"@luciansabo  Thank you  for reporting the issue!\r\n\r\nUnfortunately I was NOT able to reproduce your issue. I followed all the steps on 6.3: put 1st doc, put 2nd doc, put 1st doc again, refresh, search. I am always getting `\"sort\": [-1]\"`.  Can you confirm the steps are correct?\r\n\r\nCan you reproduce this issue on an empty index?\r\nHave you modified any index settings (`refresh_interval` etc)?\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401177204","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401177204","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401177204,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTE3NzIwNA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-06-28T21:21:24Z","updated_at":"2018-06-28T21:21:24Z","author_association":"MEMBER","body":"Oops, I thought I had replied to this earlier but looks like I forgot to hit enter.\r\n\r\nI managed to reproduce this locally, although it wasn't consistent.  Sometimes I would get `-1`, sometimes `1234`.  It _may_ have been timing related.  It felt like executing the steps slowly would return the correct sort value.  But if I ran them all in one go it returned the bad value.  This wasn't super consistent though, so it may just have been coincidence.\r\n\r\nI was able to drop a breakpoint and see it collect the incorrect nested doc's values for the sort, but I'm not too familiar with how nested sorted works so didn't make any further progress. \r\n\r\nNot super helpful, sorry :(  This was on master fwiw.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401178509","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401178509","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401178509,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTE3ODUwOQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-06-28T21:26:30Z","updated_at":"2018-06-28T21:26:30Z","author_association":"CONTRIBUTOR","body":"thanks @polyfractal, good to know that it is reproducible and worth investigating.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401271350","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401271350","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401271350,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTI3MTM1MA==","user":{"login":"luciansabo","id":7838978,"node_id":"MDQ6VXNlcjc4Mzg5Nzg=","avatar_url":"https://avatars2.githubusercontent.com/u/7838978?v=4","gravatar_id":"","url":"https://api.github.com/users/luciansabo","html_url":"https://github.com/luciansabo","followers_url":"https://api.github.com/users/luciansabo/followers","following_url":"https://api.github.com/users/luciansabo/following{/other_user}","gists_url":"https://api.github.com/users/luciansabo/gists{/gist_id}","starred_url":"https://api.github.com/users/luciansabo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luciansabo/subscriptions","organizations_url":"https://api.github.com/users/luciansabo/orgs","repos_url":"https://api.github.com/users/luciansabo/repos","events_url":"https://api.github.com/users/luciansabo/events{/privacy}","received_events_url":"https://api.github.com/users/luciansabo/received_events","type":"User","site_admin":false},"created_at":"2018-06-29T07:24:12Z","updated_at":"2018-06-29T07:24:12Z","author_association":"NONE","body":"@mayya-sharipova I am not the issue author, @dbevacqua is, but I can confirm a similar thing happening here. We were seeing this bug on multiple docker setups and on our staging environment, both on empty index and older indexes. For us it is very easy to reproduce. \r\nIf you don't manage to reproduce I will find the time to prepare a basic mapping and detail the steps.\r\n\r\nWe sort scores with a condition to sort only scores of a user.\r\nThis happens for us only if there are nested documents not having scores. If you make any update to a single document with a score, the first document having no scores takes his place in the sort order. This issue does not happen if you **reindex all documents** that are retrieved.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401401143","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401401143","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401401143,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTQwMTE0Mw==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-06-29T16:09:23Z","updated_at":"2018-06-29T16:09:23Z","author_association":"NONE","body":"The original bash script I posted, if run as-is, allows me to reproduce the issue every time.\r\n\r\nAs per my comments in the bash script, calling `_refresh` between second and third PUT, or using `_update` instead of the third PUT, gives the correct results. In addition, forcing refresh by performing all PUTs of documents with `?refresh` has the same effect, i.e. no erroneous sort values. I guess it's possible that on a slower machine, the default refresh interval of `1s` comes into play and means that the issue does not manifest itself on every invocation of the bash script. Setting the `refresh_interval` to a value greater than the default may help in reproducing the issue.\r\n\r\nAnother couple of observations I have made:\r\n\r\n- the issue is reproducible with the first level of nesting in the sort removed, i.e. we can further simplify the conditions required to reproduce the issue\r\n- the issue occurs when I use an equivalent script-based sort referencing doc values\r\n- with an appropriate inner_hits specification, I can extract the correct (i.e. expected) values for the `sortScore` field from doc values, i.e. the doc values retrieved for inner hits are correct, whereas the doc values for sorting appear not to be\r\n\r\nI will post scripts which demonstrate these points at the earliest opportunity","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401403112","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401403112","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401403112,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTQwMzExMg==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-06-29T16:17:14Z","updated_at":"2018-06-29T16:17:14Z","author_association":"MEMBER","body":"Paging @martijnvg :)  Could the nested sort filter be getting confused and collecting the wrong docs or something?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401723860","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401723860","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401723860,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTcyMzg2MA==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-07-02T09:05:15Z","updated_at":"2018-07-02T13:20:13Z","author_association":"NONE","body":"I've created a gist which uses a simpler mapping and simpler queries to illustrate the points in my previous comment:\r\n\r\nhttps://gist.github.com/dbevacqua/0ea04a3ad472da8e9b2c08559df874e9\r\n\r\nResponses from all three search requests only contain doc 1, which has `nested1.nested2.sortValue` of `1`, but the hit has `\"sort\" : [ 2 ]`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/401802123","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-401802123","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":401802123,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMTgwMjEyMw==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-07-02T13:21:42Z","updated_at":"2018-07-02T13:21:42Z","author_association":"NONE","body":"After some more experimenting I've discovered that the first PUT is unnecessary. Have revised the gist to reflect this.\r\n\r\nhttps://gist.github.com/dbevacqua/0ea04a3ad472da8e9b2c08559df874e9","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/402169625","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-402169625","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":402169625,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMjE2OTYyNQ==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-07-03T14:06:17Z","updated_at":"2018-07-03T14:06:17Z","author_association":"NONE","body":"The problem may be in the `BitSet` passed into `MultiValueMode.select(SortedNumericDocValues, long, BitSet, DocIdSetIterator, int)`. It always seems to have cardinality 0, which means that `prevParentDoc` is always `-1`, so the call to `childDocs.advance(...)` always returns the first child doc in `childDocs`, regardless of whether it's related to the current parent doc.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/402203538","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-402203538","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":402203538,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMjIwMzUzOA==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-07-03T15:46:46Z","updated_at":"2018-07-03T15:46:46Z","author_association":"NONE","body":"I believe this fixes the issue:\r\n\r\n```diff\r\ndiff --git a/server/src/main/java/org/elasticsearch/search/sort/SortBuilder.java b/server/src/main/java/org/elasticsearch/search/sort/SortBuilder.java\r\nindex 9537e28..e161cb0 100644\r\n--- a/server/src/main/java/org/elasticsearch/search/sort/SortBuilder.java\r\n+++ b/server/src/main/java/org/elasticsearch/search/sort/SortBuilder.java\r\n@@ -238,8 +238,7 @@ public abstract class SortBuilder<T extends SortBuilder<T>> implements NamedWrit\r\n \r\n         // apply filters from the previous nested level\r\n         if (nested != null) {\r\n-            parentQuery = Queries.filtered(parentQuery,\r\n-                new ToParentBlockJoinQuery(nested.getInnerQuery(), nested.getRootFilter(), ScoreMode.None));\r\n+            parentQuery = new ToParentBlockJoinQuery(nested.getInnerQuery(), nested.getRootFilter(), ScoreMode.None);\r\n \r\n             if (objectMapper != null) {\r\n                 childQuery = Queries.filtered(childQuery,\r\n```\r\n\r\nAll tests pass, including the (previously failing) one I added based on the gist. I'll prepare a pull request, but perhaps someone can comment on what the intention was with forcing the `ToParentBlockJoinQuery` to be a filter. Is it an optimisation of some kind?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/402385776","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-402385776","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":402385776,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMjM4NTc3Ng==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2018-07-04T07:13:11Z","updated_at":"2018-07-04T07:13:11Z","author_association":"MEMBER","body":"@dbevacqua Thanks for reporting this bug and coming up with a fix! \r\n\r\nIt looks like the conjunction between `parentQuery` and  `new ToParentBlockJoinQuery(nested.getInnerQuery(), nested.getRootFilter(), ScoreMode.None)` is too strict in the case when the nested fields do not exist in all documents.\r\n\r\n> but perhaps someone can comment on what the intention was with forcing the ToParentBlockJoinQuery to be a filter. Is it an optimisation of some kind?\r\n\r\nThe idea was that for an intermediate nested parent doc both the parentQuery and ToParentBlockJoinQuery must match (that nested doc is both a parent and a child), but that is not true in case when nested fields are missing. Whether a must or filter clause if used for that is not really important. In fact for for optimization purposes, both query clauses should be filter, because scoring is not needed.\r\n\r\nI think your fix is good and I think it makes sense to open a PR to iterate further.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/402389756","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-402389756","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":402389756,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMjM4OTc1Ng==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-07-04T07:30:22Z","updated_at":"2018-07-04T07:30:22Z","author_association":"NONE","body":"Thanks @martijnvg. PR here: https://github.com/elastic/elasticsearch/pull/31776","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406254247","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-406254247","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":406254247,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjI1NDI0Nw==","user":{"login":"JulienColin","id":2394029,"node_id":"MDQ6VXNlcjIzOTQwMjk=","avatar_url":"https://avatars2.githubusercontent.com/u/2394029?v=4","gravatar_id":"","url":"https://api.github.com/users/JulienColin","html_url":"https://github.com/JulienColin","followers_url":"https://api.github.com/users/JulienColin/followers","following_url":"https://api.github.com/users/JulienColin/following{/other_user}","gists_url":"https://api.github.com/users/JulienColin/gists{/gist_id}","starred_url":"https://api.github.com/users/JulienColin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JulienColin/subscriptions","organizations_url":"https://api.github.com/users/JulienColin/orgs","repos_url":"https://api.github.com/users/JulienColin/repos","events_url":"https://api.github.com/users/JulienColin/events{/privacy}","received_events_url":"https://api.github.com/users/JulienColin/received_events","type":"User","site_admin":false},"created_at":"2018-07-19T12:09:08Z","updated_at":"2018-07-19T12:09:08Z","author_association":"NONE","body":"Hello @dbevacqua , I recently authored #32130 exposing a comparable problem (however my case is a bit difference because it's reproducible 100% of the times and not depending on timing. gist with kibana commands here https://gist.github.com/cbuescher/f9c8c2132d2667d3e907a6283d3f171a). \r\n\r\nWould you have a simple way to check wether the fix you provided here would also resolve this other issue ? \r\n\r\nIf not , i will build and run your PR myself.\r\n\r\nThank you very much in advance","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406256378","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-406256378","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":406256378,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjI1NjM3OA==","user":{"login":"dbevacqua","id":6534306,"node_id":"MDQ6VXNlcjY1MzQzMDY=","avatar_url":"https://avatars2.githubusercontent.com/u/6534306?v=4","gravatar_id":"","url":"https://api.github.com/users/dbevacqua","html_url":"https://github.com/dbevacqua","followers_url":"https://api.github.com/users/dbevacqua/followers","following_url":"https://api.github.com/users/dbevacqua/following{/other_user}","gists_url":"https://api.github.com/users/dbevacqua/gists{/gist_id}","starred_url":"https://api.github.com/users/dbevacqua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dbevacqua/subscriptions","organizations_url":"https://api.github.com/users/dbevacqua/orgs","repos_url":"https://api.github.com/users/dbevacqua/repos","events_url":"https://api.github.com/users/dbevacqua/events{/privacy}","received_events_url":"https://api.github.com/users/dbevacqua/received_events","type":"User","site_admin":false},"created_at":"2018-07-19T12:17:59Z","updated_at":"2018-07-19T12:18:18Z","author_association":"NONE","body":"@JulienColin running your gist against a server built from 6.2.3 with my PR applied, I believe the correct response is returned (family with id=2 has sort value 30)\r\n\r\n```\r\n  \"hits\": {\r\n    \"total\": 4,\r\n    \"max_score\": null,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"tree\",\r\n        \"_type\": \"family\",\r\n        \"_id\": \"2\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"name\": \"Simpson\",\r\n          \"members\": [\r\n            {\r\n              \"firstName\": \"Homer\",\r\n              \"color\": \"brown\",\r\n              \"levels\": {\r\n                \"strength\": 30\r\n              }\r\n            },\r\n            {\r\n              \"firstName\": \"Lisa\",\r\n              \"color\": \"brown\",\r\n              \"levels\": {\r\n                \"strength\": 40\r\n              }\r\n            },\r\n            {\r\n              \"firstName\": \"Marge\",\r\n              \"color\": \"brown\",\r\n              \"levels\": {\r\n                \"strength\": 60\r\n              }\r\n            }\r\n          ]\r\n        },\r\n        \"sort\": [\r\n          30\r\n        ]\r\n      },\r\n...\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/406262996","html_url":"https://github.com/elastic/elasticsearch/issues/31554#issuecomment-406262996","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31554","id":406262996,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNjI2Mjk5Ng==","user":{"login":"JulienColin","id":2394029,"node_id":"MDQ6VXNlcjIzOTQwMjk=","avatar_url":"https://avatars2.githubusercontent.com/u/2394029?v=4","gravatar_id":"","url":"https://api.github.com/users/JulienColin","html_url":"https://github.com/JulienColin","followers_url":"https://api.github.com/users/JulienColin/followers","following_url":"https://api.github.com/users/JulienColin/following{/other_user}","gists_url":"https://api.github.com/users/JulienColin/gists{/gist_id}","starred_url":"https://api.github.com/users/JulienColin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JulienColin/subscriptions","organizations_url":"https://api.github.com/users/JulienColin/orgs","repos_url":"https://api.github.com/users/JulienColin/repos","events_url":"https://api.github.com/users/JulienColin/events{/privacy}","received_events_url":"https://api.github.com/users/JulienColin/received_events","type":"User","site_admin":false},"created_at":"2018-07-19T12:43:40Z","updated_at":"2018-07-19T12:43:40Z","author_association":"NONE","body":"@dbevacqua thank you very much for your reactivity ! it's amazing , thank you very much for your fix. I hope we can enjoy it in a release soon .","performed_via_github_app":null}]