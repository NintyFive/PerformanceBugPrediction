[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/335087296","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-335087296","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":335087296,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNTA4NzI5Ng==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-10-09T07:55:11Z","updated_at":"2017-10-09T07:55:11Z","author_association":"CONTRIBUTOR","body":"Fuzziness is not applied because the phonetic filter has `replace: false`, which creates synonyms under the hood. The parsed query is `Synonym(last_name:KNR last_name:conner)`. @jimczi Do you have an opinion as to whether this should be fixed / documented?\r\n\r\nHere is a Console recreation if someone needs to iterate on it:\r\n\r\n```\r\nPUT test \r\n{\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"analysis\": {\r\n        \"analyzer\": {\r\n          \"phonetic_analyzer\": {\r\n            \"tokenizer\": \"standard\",\r\n            \"filter\": [ \"lowercase\", \"phonetic_filter\" ]\r\n          }\r\n        },\r\n        \"filter\": {\r\n          \"phonetic_filter\": {\r\n            \"type\": \"phonetic\",\r\n            \"replace\": false\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }, \r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"last_name\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"phonetic_analyzer\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test/doc/1\r\n{\r\n  \"last_name\": \"CONNE\"\r\n}\r\n\r\nPUT test/doc/2\r\n{\r\n  \"last_name\": \"CONNER\"\r\n}\r\n\r\nGET test/_search\r\n{\r\n  \"query\": {\r\n    \"match\": {\r\n      \"last_name\": {\r\n        \"query\": \"CONNER\",\r\n        \"fuzziness\": \"AUTO\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nGET test/_validate/query?rewrite=true\r\n{\r\n  \"query\": {\r\n    \"match\": {\r\n      \"last_name\": {\r\n        \"query\": \"CONNER\",\r\n        \"fuzziness\": \"AUTO\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/335247519","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-335247519","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":335247519,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNTI0NzUxOQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-10-09T18:28:12Z","updated_at":"2017-10-09T18:28:12Z","author_association":"MEMBER","body":"This is not the first time that this issue is reported so I agree that we should do something to support this use case. The `SynonymQuery` has been added in 2.x to handle cases where multiple terms appear in the same position. The `SynonymQuery` tries to score the terms as if you\r\n had indexed them as one term and gives similar score to documents that match different `synonym`. This is confusing because this situation happens not only with `synonym` filter but also with token filters that preserve multiple rewriting of the same term. So for instance the `phonetic` filter can preserve the original term and add the phonetic form as a synonym when `replace` is set to true. When fuzziness is applied to a `match` query, `synonyms` are ignored and we run into situation like the one described in this issue. \r\nI think we could just apply the fuzziness to all terms if they appear at the same position and use a disjunction max query instead of a synonym query. This would break the similar score on synonyms that we usually have with the `SynonymQuery` but IMO it's an acceptable trade off when dealing with fuzziness and analysis expansion. Another option would be to remove the `replace` option (with a deprecation period) but this would not fix the issue with other token filters that keep multiple terms per position so I am leaning toward the first solution. \r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/335446352","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-335446352","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":335446352,"node_id":"MDEyOklzc3VlQ29tbWVudDMzNTQ0NjM1Mg==","user":{"login":"davidlmorton","id":650482,"node_id":"MDQ6VXNlcjY1MDQ4Mg==","avatar_url":"https://avatars1.githubusercontent.com/u/650482?v=4","gravatar_id":"","url":"https://api.github.com/users/davidlmorton","html_url":"https://github.com/davidlmorton","followers_url":"https://api.github.com/users/davidlmorton/followers","following_url":"https://api.github.com/users/davidlmorton/following{/other_user}","gists_url":"https://api.github.com/users/davidlmorton/gists{/gist_id}","starred_url":"https://api.github.com/users/davidlmorton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidlmorton/subscriptions","organizations_url":"https://api.github.com/users/davidlmorton/orgs","repos_url":"https://api.github.com/users/davidlmorton/repos","events_url":"https://api.github.com/users/davidlmorton/events{/privacy}","received_events_url":"https://api.github.com/users/davidlmorton/received_events","type":"User","site_admin":false},"created_at":"2017-10-10T11:44:07Z","updated_at":"2017-10-10T11:44:07Z","author_association":"NONE","body":"I don't know how much my vote matters, but I would prefer that it were fixed rather than simply documented.  Detecting that this is happening and issuing a warning or error would be preferable to silently ignoring the fuzziness setting too.  I would personally be okay with the disjunction max solution's side effect.  Would the synonyms only be under a disjunction max query in the case where fuzziness were applied or always?  What about fuzziness of 'auto' and a list of short synonyms?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/342242550","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-342242550","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":342242550,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MjI0MjU1MA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-11-06T18:34:35Z","updated_at":"2017-11-06T18:34:35Z","author_association":"MEMBER","body":"We've decided that the current behavior is more easy to understand and reason about. See https://github.com/elastic/elasticsearch/pull/26940#issuecomment-342241790.\r\nThe workaround for the example in this issue is to use two fields, one for the phonetic and one for the original form. Then it is easier to apply fuzziness to the original form only since applying fuzziness to phonetic form would lead to unexpected results.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/342356908","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-342356908","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":342356908,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MjM1NjkwOA==","user":{"login":"davidlmorton","id":650482,"node_id":"MDQ6VXNlcjY1MDQ4Mg==","avatar_url":"https://avatars1.githubusercontent.com/u/650482?v=4","gravatar_id":"","url":"https://api.github.com/users/davidlmorton","html_url":"https://github.com/davidlmorton","followers_url":"https://api.github.com/users/davidlmorton/followers","following_url":"https://api.github.com/users/davidlmorton/following{/other_user}","gists_url":"https://api.github.com/users/davidlmorton/gists{/gist_id}","starred_url":"https://api.github.com/users/davidlmorton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidlmorton/subscriptions","organizations_url":"https://api.github.com/users/davidlmorton/orgs","repos_url":"https://api.github.com/users/davidlmorton/repos","events_url":"https://api.github.com/users/davidlmorton/events{/privacy}","received_events_url":"https://api.github.com/users/davidlmorton/received_events","type":"User","site_admin":false},"created_at":"2017-11-07T02:35:21Z","updated_at":"2017-11-07T02:35:21Z","author_association":"NONE","body":"I hope that this at least gets documented, or did I stumble upon an exceptionally unusual use-case?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/342782778","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-342782778","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":342782778,"node_id":"MDEyOklzc3VlQ29tbWVudDM0Mjc4Mjc3OA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-11-08T10:56:21Z","updated_at":"2017-11-08T10:56:21Z","author_association":"MEMBER","body":"I agree it should be documented. I am reopening this issue and will add an update in the docs regarding this behavior. Thanks @davidlmorton !","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/373031361","html_url":"https://github.com/elastic/elasticsearch/issues/26921#issuecomment-373031361","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26921","id":373031361,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MzAzMTM2MQ==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2018-03-14T14:02:27Z","updated_at":"2018-03-14T14:02:27Z","author_association":"CONTRIBUTOR","body":"cc @elastic/es-search-aggs ","performed_via_github_app":null}]