{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/63025","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63025/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63025/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63025/events","html_url":"https://github.com/elastic/elasticsearch/issues/63025","id":711270769,"node_id":"MDU6SXNzdWU3MTEyNzA3Njk=","number":63025,"title":"RestHighLevelClient throws exception parsing RareTerms aggregation results","user":{"login":"ajeydudhe","id":2289680,"node_id":"MDQ6VXNlcjIyODk2ODA=","avatar_url":"https://avatars3.githubusercontent.com/u/2289680?v=4","gravatar_id":"","url":"https://api.github.com/users/ajeydudhe","html_url":"https://github.com/ajeydudhe","followers_url":"https://api.github.com/users/ajeydudhe/followers","following_url":"https://api.github.com/users/ajeydudhe/following{/other_user}","gists_url":"https://api.github.com/users/ajeydudhe/gists{/gist_id}","starred_url":"https://api.github.com/users/ajeydudhe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ajeydudhe/subscriptions","organizations_url":"https://api.github.com/users/ajeydudhe/orgs","repos_url":"https://api.github.com/users/ajeydudhe/repos","events_url":"https://api.github.com/users/ajeydudhe/events{/privacy}","received_events_url":"https://api.github.com/users/ajeydudhe/received_events","type":"User","site_admin":false},"labels":[{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-09-29T16:22:30Z","updated_at":"2020-11-17T16:45:45Z","closed_at":"2020-11-17T16:45:45Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.9.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): \r\njava version \"1.8.0_251\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_251-b08)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.251-b08, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin Ajeys-MacBook-Pro.local 19.6.0 Darwin Kernel Version 19.6.0: Thu Jun 18 20:49:00 PDT 2020; root:xnu-6153.141.1~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nPerforming the RareTerms aggregation using the RestHighLevelClient. The request seems to execute on server side and results are also returned. From the exception stack it looks like the client is not able to parse the RareTerms aggregation result. Also, the AggregationBuilders does not have the helper method for RareTerms aggregation so creating the instance directly. Note that other searches or aggregations work as expected.\r\n\r\n**Steps to reproduce**:\r\nThe search request is created as follllows\r\n```\r\nfinal SearchSourceBuilder searchBuilder = new SearchSourceBuilder();\r\nsearchBuilder.aggregation(new RareTermsAggregationBuilder(\"rare_terms_aggs\").field(\"some.field\").maxDocCount(5));\r\n```\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\njava.io.IOException: Unable to parse response body for Response{requestLine=POST /businesses/_search?typed_keys=true&max_concurrent_shard_requests=5&ignore_unavailable=false&expand_wildcards=open&allow_no_indices=true&ignore_throttled=true&search_type=query_then_fetch&batched_reduce_size=512&ccs_minimize_roundtrips=true HTTP/1.1, host=http://localhost:9200, response=HTTP/1.1 200 OK}\r\n        at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1632)\r\n        at org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1583)\r\n        at org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1553)\r\n        at org.elasticsearch.client.RestHighLevelClient.search(RestHighLevelClient.java:1069)\r\n        at my.code.search.ElasticsearchClient.invoke(ElasticsearchClient.java:105)\r\n        at my.code.search.ElasticsearchClient.search(ElasticsearchClient.java:52)\r\n        at my.code.search.SearchHandler.getBusinessCountByCity(SearchHandler.java:253)\r\n        at my.code.search.SearchIT.testBusinessCountByCity_noRecordsForCitiesWithLessThan5Businesses(SearchIT.java:319)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n        at java.lang.reflect.Method.invoke(Method.java:498)\r\n        at org.testng.internal.MethodInvocationHelper.invokeMethod(MethodInvocationHelper.java:124)\r\n        at org.testng.internal.Invoker.invokeMethod(Invoker.java:583)\r\n        at org.testng.internal.Invoker.invokeTestMethod(Invoker.java:719)\r\n        at org.testng.internal.Invoker.invokeTestMethods(Invoker.java:989)\r\n        at org.testng.internal.TestMethodWorker.invokeTestMethods(TestMethodWorker.java:125)\r\n        at org.testng.internal.TestMethodWorker.run(TestMethodWorker.java:109)\r\n        at org.testng.TestRunner.privateRun(TestRunner.java:648)\r\n        at org.testng.TestRunner.run(TestRunner.java:505)\r\n        at org.testng.SuiteRunner.runTest(SuiteRunner.java:455)\r\n        at org.testng.SuiteRunner.runSequentially(SuiteRunner.java:450)\r\n        at org.testng.SuiteRunner.privateRun(SuiteRunner.java:415)\r\n        at org.testng.SuiteRunner.run(SuiteRunner.java:364)\r\n        at org.testng.SuiteRunnerWorker.runSuite(SuiteRunnerWorker.java:52)\r\n        at org.testng.SuiteRunnerWorker.run(SuiteRunnerWorker.java:84)\r\n        at org.testng.TestNG.runSuitesSequentially(TestNG.java:1208)\r\n        at org.testng.TestNG.runSuitesLocally(TestNG.java:1137)\r\n        at org.testng.TestNG.runSuites(TestNG.java:1049)\r\n        at org.testng.TestNG.run(TestNG.java:1017)\r\n        at org.apache.maven.surefire.testng.TestNGExecutor.run(TestNGExecutor.java:135)\r\n        at org.apache.maven.surefire.testng.TestNGDirectoryTestSuite.executeSingleClass(TestNGDirectoryTestSuite.java:112)\r\n        at org.apache.maven.surefire.testng.TestNGDirectoryTestSuite.execute(TestNGDirectoryTestSuite.java:99)\r\n        at org.apache.maven.surefire.testng.TestNGProvider.invoke(TestNGProvider.java:146)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.invokeProviderInSameClassLoader(ForkedBooter.java:384)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.runSuitesInProcess(ForkedBooter.java:345)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.execute(ForkedBooter.java:126)\r\n        at org.apache.maven.surefire.booter.ForkedBooter.main(ForkedBooter.java:418)\r\nCaused by: org.elasticsearch.common.xcontent.NamedObjectNotFoundException: [1:208] unknown field [srareterms]\r\n        at org.elasticsearch.common.xcontent.NamedXContentRegistry.parseNamedObject(NamedXContentRegistry.java:132)\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.namedObject(AbstractXContentParser.java:385)\r\n        at org.elasticsearch.common.xcontent.XContentParserUtils.parseTypedKeysObject(XContentParserUtils.java:153)\r\n        at org.elasticsearch.search.aggregations.Aggregations.fromXContent(Aggregations.java:142)\r\n        at org.elasticsearch.action.search.SearchResponse.innerFromXContent(SearchResponse.java:306)\r\n        at org.elasticsearch.action.search.SearchResponse.fromXContent(SearchResponse.java:265)\r\n        at org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:1892)\r\n        at org.elasticsearch.client.RestHighLevelClient.lambda$performRequestAndParseEntity$8(RestHighLevelClient.java:1554)\r\n        at org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1630)\r\n        ... 37 common frames omitted\r\n```\r\n","closed_by":{"login":"swallez","id":213730,"node_id":"MDQ6VXNlcjIxMzczMA==","avatar_url":"https://avatars2.githubusercontent.com/u/213730?v=4","gravatar_id":"","url":"https://api.github.com/users/swallez","html_url":"https://github.com/swallez","followers_url":"https://api.github.com/users/swallez/followers","following_url":"https://api.github.com/users/swallez/following{/other_user}","gists_url":"https://api.github.com/users/swallez/gists{/gist_id}","starred_url":"https://api.github.com/users/swallez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/swallez/subscriptions","organizations_url":"https://api.github.com/users/swallez/orgs","repos_url":"https://api.github.com/users/swallez/repos","events_url":"https://api.github.com/users/swallez/events{/privacy}","received_events_url":"https://api.github.com/users/swallez/received_events","type":"User","site_admin":false},"performed_via_github_app":null}