{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53388","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53388/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53388/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53388/events","html_url":"https://github.com/elastic/elasticsearch/issues/53388","id":579121574,"node_id":"MDU6SXNzdWU1NzkxMjE1NzQ=","number":53388,"title":"Rollover API failing with 400 in case settings name don't have \"index.\" prefix or \"index\" section in json","user":{"login":"shwetathareja","id":2943091,"node_id":"MDQ6VXNlcjI5NDMwOTE=","avatar_url":"https://avatars3.githubusercontent.com/u/2943091?v=4","gravatar_id":"","url":"https://api.github.com/users/shwetathareja","html_url":"https://github.com/shwetathareja","followers_url":"https://api.github.com/users/shwetathareja/followers","following_url":"https://api.github.com/users/shwetathareja/following{/other_user}","gists_url":"https://api.github.com/users/shwetathareja/gists{/gist_id}","starred_url":"https://api.github.com/users/shwetathareja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shwetathareja/subscriptions","organizations_url":"https://api.github.com/users/shwetathareja/orgs","repos_url":"https://api.github.com/users/shwetathareja/repos","events_url":"https://api.github.com/users/shwetathareja/events{/privacy}","received_events_url":"https://api.github.com/users/shwetathareja/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":30486044,"node_id":"MDU6TGFiZWwzMDQ4NjA0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eregression","name":">regression","color":"d7e102","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"},{"id":2040343033,"node_id":"MDU6TGFiZWwyMDQwMzQzMDMz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.9.0","name":"v7.9.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2020-03-11T09:28:57Z","updated_at":"2020-11-05T05:16:40Z","closed_at":"2020-11-05T05:16:39Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.6\r\n\r\n**Plugins installed**: []\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRollover API takes index settings as input parameters. The settings can specified as one of the below options: \r\n```\r\n1.  \"settings\": {\r\n      \"index\" : {\r\n    \t\"number_of_shards\": 2\r\n      }\r\n  }\r\n 2.  \"settings\": {\r\n    \"index.number_of_shards\": 2\r\n  }\r\n3. \"settings\": {\r\n    \"number_of_shards\": 2\r\n  }\r\n```\r\n\r\nBut, with this [PR](https://github.com/elastic/elasticsearch/pull/50388). the #3 option doesn't work and throws error as\r\n\r\n```\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"illegal_argument_exception\",\r\n        \"reason\" : \"unknown setting [number_of_shards] did you mean [index.number_of_shards]?\"\r\n      }\r\n    ],\r\n    \"type\" : \"illegal_argument_exception\",\r\n    \"reason\" : \"unknown setting [number_of_shards] did you mean [index.number_of_shards]?\"\r\n  },\r\n  \"status\" : 400\r\n}\r\n```\r\n\r\n**Fix:**\r\nThere is normalize and settings validation logic in onlyCreateIndex method and after refactoring this code is not getting triggered during rollover flow which calls applyCreateIndexRequest method.\r\n```\r\nSettings.Builder updatedSettingsBuilder = Settings.builder();\r\n        Settings build = updatedSettingsBuilder.put(request.settings()).normalizePrefix(IndexMetaData.INDEX_SETTING_PREFIX).build();\r\n        indexScopedSettings.validate(build, true); // we do validate here - index setting must be consistent\r\n        request.settings(build);\r\n```\r\n\r\nThe normalize call should also run during rollover flow otherwise it breaks the expected behavior.\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\n1. curl -XPUT localhost:9200/abc-000001\r\n2. curl -XPUT localhost:9200/abc-000001/_alias/abc\r\n3. curl -X POST \"localhost:9200/abc/_rollover?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n\"conditions\": {\r\n\"max_age\":   \"1s\"\r\n},\r\n\"settings\": {\r\n\"number_of_shards\": 2\r\n}\r\n}\r\n'\r\n```\r\n**Tried running this in 7.5 with no issue and rollover works as expected.**\r\n","closed_by":{"login":"jbaiera","id":875779,"node_id":"MDQ6VXNlcjg3NTc3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/875779?v=4","gravatar_id":"","url":"https://api.github.com/users/jbaiera","html_url":"https://github.com/jbaiera","followers_url":"https://api.github.com/users/jbaiera/followers","following_url":"https://api.github.com/users/jbaiera/following{/other_user}","gists_url":"https://api.github.com/users/jbaiera/gists{/gist_id}","starred_url":"https://api.github.com/users/jbaiera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbaiera/subscriptions","organizations_url":"https://api.github.com/users/jbaiera/orgs","repos_url":"https://api.github.com/users/jbaiera/repos","events_url":"https://api.github.com/users/jbaiera/events{/privacy}","received_events_url":"https://api.github.com/users/jbaiera/received_events","type":"User","site_admin":false},"performed_via_github_app":null}