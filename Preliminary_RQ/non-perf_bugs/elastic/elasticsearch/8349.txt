{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8349","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8349/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8349/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8349/events","html_url":"https://github.com/elastic/elasticsearch/issues/8349","id":47814413,"node_id":"MDU6SXNzdWU0NzgxNDQxMw==","number":8349,"title":"Issue with icu collation when upgrading from 0.20.2 to 1.3.4","user":{"login":"mashudong","id":3242209,"node_id":"MDQ6VXNlcjMyNDIyMDk=","avatar_url":"https://avatars2.githubusercontent.com/u/3242209?v=4","gravatar_id":"","url":"https://api.github.com/users/mashudong","html_url":"https://github.com/mashudong","followers_url":"https://api.github.com/users/mashudong/followers","following_url":"https://api.github.com/users/mashudong/following{/other_user}","gists_url":"https://api.github.com/users/mashudong/gists{/gist_id}","starred_url":"https://api.github.com/users/mashudong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mashudong/subscriptions","organizations_url":"https://api.github.com/users/mashudong/orgs","repos_url":"https://api.github.com/users/mashudong/repos","events_url":"https://api.github.com/users/mashudong/events{/privacy}","received_events_url":"https://api.github.com/users/mashudong/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2014-11-05T09:12:18Z","updated_at":"2014-11-06T03:23:54Z","closed_at":"2014-11-05T11:39:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## 1. ICU version\n\nElasticSearch 0.20.2 : elasticsearch-analysis-icu-1.7.0\nElasticSearch 1.3.4 : elasticsearch-analysis-icu-2.3.0\n## 2. config/elasticsearch.yml\n\n```\nindex:\n  analysis: \n    filter:\n      chinese_collator:\n          type: icu_collation\n          language: zh-cn\n    analyzer:      \n      keyword_chinese_collator:\n          type: custom\n          tokenizer: keyword\n          filter: [chinese_collator]\n```\n## 3. Mapping\n\n``` sh\ncurl -XDELETE localhost:9200/index1?pretty\n\ncurl -XPUT localhost:9200/index1?pretty\n\ncurl localhost:9200/index1/type1/_mapping?pretty -d '\n{\n  \"type1\" : {\n    \"properties\" : {\n      \"beisen\" : {\n        \"type\" : \"multi_field\",\n        \"fields\" : {\n          \"beisen\" : { \"type\" : \"string\", \"analyzer\" : \"standard\" },\n          \"forsort\" : { \"type\" : \"string\", \"analyzer\" : \"keyword_chinese_collator\" }\n        }\n      }\n    }\n  }\n}'\n```\n## 4. Index some docs under 0.20.2\n\n``` sh\ncurl 'localhost:9200/index1/type1/1?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"李媛媛\"\n}'\n\ncurl 'localhost:9200/index1/type1/2?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘震宇\"\n}'\n\ncurl 'localhost:9200/index1/type1/3?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘振东\"\n}'\n\n\ncurl 'localhost:9200/index1/type1/4?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"陆燕春\"\n}'\n\n\ncurl 'localhost:9200/index1/type1/5?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘秀东\"\n}'\n\ncurl 'localhost:9200/index1/type1/6?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘新颖\"\n}'\n\ncurl 'localhost:9200/index1/type1/7?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘小远\"\n}'\n\ncurl 'localhost:9200/index1/type1/8?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘晓航\"\n}'\n\n\ncurl 'localhost:9200/index1/type1/9?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘晓航\"\n}'\n\n\ncurl 'localhost:9200/index1/type1/10?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"李君\"\n}'\n\ncurl 'localhost:9200/index1/type1/11?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"李锋br\"\n}'\n\ncurl 'localhost:9200/index1/type1/12?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"李锋\"\n}'\n\ncurl 'localhost:9200/index1/type1/13?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"何平\"\n}'\n\ncurl 'localhost:9200/index1/type1/14?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"郭鹏程\"\n}'\n\ncurl 'localhost:9200/index1/type1/15?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"黄黄\"\n}'\n\ncurl 'localhost:9200/index1/type1/16?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"高高\"\n}'\n```\n## 5. Optimize\n\n``` sh\ncurl 'localhost:9200/_optimize?max_num_segments=1&pretty'\n```\n\nThis step is _critical_, if it is skipped, the issue will not occur.\n## 6. Upgrade to 1.3.4 & Index more docs\n\n``` sh\ncurl 'localhost:9200/index1/type1/17?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"刘六\"\n}'\n\ncurl 'localhost:9200/index1/type1/18?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"张三\"\n}'\n\ncurl 'localhost:9200/index1/type1/19?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"李四\"\n}'\n\n\ncurl 'localhost:9200/index1/type1/20?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"王五\"\n}'\n\n\ncurl 'localhost:9200/index1/type1/21?routing=beisen&pretty' -d '\n{\n  \"beisen\" : \"李三\"\n}'\n```\n## 7. Search \n\n``` sh\ncurl 'localhost:9200/index1/type1/_search?routing=beisen&pretty' -d '\n{\n  \"size\" : 100,\n  \"sort\" : [\n    { \"beisen.forsort\" : \"asc\" }\n  ],\n  \"fields\" : \"\"\n}'\n```\n\nThe result order is:\n\n```\n  \"_id\" : \"21\",\n  \"_id\" : \"19\",\n  \"_id\" : \"17\",\n  \"_id\" : \"20\",\n  \"_id\" : \"16\",\n  \"_id\" : \"14\",\n  \"_id\" : \"13\",\n  \"_id\" : \"15\",\n  \"_id\" : \"18\",\n  \"_id\" : \"12\",\n  \"_id\" : \"11\",\n  \"_id\" : \"10\",\n  \"_id\" : \"1\",\n  \"_id\" : \"7\",\n  \"_id\" : \"8\",\n  \"_id\" : \"9\",\n  \"_id\" : \"6\",\n  \"_id\" : \"5\",\n  \"_id\" : \"3\",\n  \"_id\" : \"2\",\n  \"_id\" : \"4\",\n```\n\nBut the expected order is:\n\n```\n  \"_id\" : \"16\",\n  \"_id\" : \"14\",\n  \"_id\" : \"13\",\n  \"_id\" : \"15\",\n  \"_id\" : \"12\",\n  \"_id\" : \"11\",\n  \"_id\" : \"10\",\n  \"_id\" : \"21\",\n  \"_id\" : \"19\",\n  \"_id\" : \"1\",\n  \"_id\" : \"17\",\n  \"_id\" : \"7\",\n  \"_id\" : \"8\",\n  \"_id\" : \"9\",\n  \"_id\" : \"6\",\n  \"_id\" : \"5\",\n  \"_id\" : \"3\",\n  \"_id\" : \"2\",\n  \"_id\" : \"4\",\n  \"_id\" : \"20\",\n  \"_id\" : \"18\",\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}