{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38086","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38086/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38086/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38086/events","html_url":"https://github.com/elastic/elasticsearch/issues/38086","id":405215778,"node_id":"MDU6SXNzdWU0MDUyMTU3Nzg=","number":38086,"title":"[ML] Improve file structure finder timestamp recognition","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"assignees":[{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-01-31T12:07:32Z","updated_at":"2019-06-03T13:17:12Z","closed_at":"2019-06-03T12:44:07Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The file structure finder currently only supports a fixed set of timestamp formats.  If a file is uploaded that has a different timestamp format then the file structure finder can return a suboptimal config and even fail in a hard-to-diagnose manner.  See for example elastic/kibana#29578\r\n\r\nFor highly structured formats like JSON and CSV, if the timestamp is not recognised then the only problem is that the timestamp field will be classified as a `keyword` rather than a `date`.\r\n\r\nFor semi-structured text logs the problem is worse because the lines in the file are grouped into messages using the assumption that the timestamp will appear on the first line of each message, so failure to detect a timestamp has a catastrophic effect on the understanding of the file structure.  In this case we at least return an error saying we couldn't find the timestamp format.  An even worse case is when we don't detect the real timestamp format that appears in every message, but a tiny fraction of messages also contain some other timestamp that we do recognise the format of.  This causes us to group huge numbers of lines into messages leading to timeouts or confusing error messages that don't sensibly say what the underlying problem is - see https://github.com/elastic/kibana/issues/29578#issuecomment-459317274\r\n\r\nThere are a number of things that could be done to improve this:\r\n\r\n- [x] For semi-structured text logs, cap the number of characters (default 10000, arg to override) that can be combined into a single message.  Then if a very small proportion of long lines contain a timestamp we'll fail with an error instead of timing out.  The error could suggest that the underlying problem might be failure to detect the real per-message timestamp format.\r\n- [x] Allow an arbitrary timestamp format to be supplied as an override, not just one from the list of built-in formats.  (This requires code to build an appropriate Grok pattern from the supplied timestamp format, which is non-trivial and the reason why arbitrary overrides were not permitted in the initial release.)\r\n- [x] Be more advanced in automatically finding timestamp formats.  This breaks down into:\r\n  - [x] Consider the `%{DATE}` and `%{DATESTAMP}` Grok patterns, which correspond to dd/MM/yyyy or MM/dd/yyyy (followed by a time in the case of the second).\r\n  - [x] Look across messages and also at the current locale to pick which of dd/MM and MM/dd is most likely.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}