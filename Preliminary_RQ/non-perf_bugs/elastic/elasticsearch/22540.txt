{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22540","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22540/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22540/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22540/events","html_url":"https://github.com/elastic/elasticsearch/issues/22540","id":199964511,"node_id":"MDU6SXNzdWUxOTk5NjQ1MTE=","number":22540,"title":"Custom analyzer is not applied for wildcard queries","user":{"login":"andreybratukhin","id":426632,"node_id":"MDQ6VXNlcjQyNjYzMg==","avatar_url":"https://avatars0.githubusercontent.com/u/426632?v=4","gravatar_id":"","url":"https://api.github.com/users/andreybratukhin","html_url":"https://github.com/andreybratukhin","followers_url":"https://api.github.com/users/andreybratukhin/followers","following_url":"https://api.github.com/users/andreybratukhin/following{/other_user}","gists_url":"https://api.github.com/users/andreybratukhin/gists{/gist_id}","starred_url":"https://api.github.com/users/andreybratukhin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreybratukhin/subscriptions","organizations_url":"https://api.github.com/users/andreybratukhin/orgs","repos_url":"https://api.github.com/users/andreybratukhin/repos","events_url":"https://api.github.com/users/andreybratukhin/events{/privacy}","received_events_url":"https://api.github.com/users/andreybratukhin/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":408109539,"node_id":"MDU6TGFiZWw0MDgxMDk1Mzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.1.1","name":"v5.1.1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-01-10T23:37:17Z","updated_at":"2017-01-11T17:58:36Z","closed_at":"2017-01-11T10:32:43Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version**: 5.1.1\r\n\r\n\r\n**Steps to reproduce**:\r\n It seems this change (https://github.com/elastic/elasticsearch/pull/21919) introduces inconsistent behavior for prefix and wildcard queries. Here is example of my settings:\r\n\r\n```\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"default\": {\r\n          \"tokenizer\": \"whitespace\",\r\n          \"filter\": [\"lowercase\"]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nPut document: /tweets/tweet/1\r\n```\r\n{\r\n  \"text\": \"DEF-ABC\"\r\n}\r\n```\r\n\r\nTry to search: /_search\r\n```\r\n{\r\n  \"query\": {\r\n    \"query_string\": {\r\n       \"query\": \"*DEF*\", \"analyze_wildcard\": true\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nNo results, because org.elasticsearch.index.analysis.CustomAnalyzer doesn't apply token filters any more.\r\n\r\nPrefix search: /_search\r\n```\r\n{\r\n  \"query\": {\r\n    \"query_string\": {\r\n       \"query\": \"DEF*\", \"analyze_wildcard\": true\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIt returns a document as expected because org.apache.lucene.queryparser.classic.MapperQueryParser::getPossiblyAnalyzedPrefixQuery applies token filters during parsing of search terms.\r\n\r\nI didn't test other queries but it breaks wildcard queries because it's not possible to apply any custom analyzer to search term for wildcard search term.\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}