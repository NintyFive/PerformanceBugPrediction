{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26318","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26318/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26318/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26318/events","html_url":"https://github.com/elastic/elasticsearch/issues/26318","id":251881336,"node_id":"MDU6SXNzdWUyNTE4ODEzMzY=","number":26318,"title":"Cannot configure logging for rest client.","user":{"login":"tsachev","id":142505,"node_id":"MDQ6VXNlcjE0MjUwNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/142505?v=4","gravatar_id":"","url":"https://api.github.com/users/tsachev","html_url":"https://github.com/tsachev","followers_url":"https://api.github.com/users/tsachev/followers","following_url":"https://api.github.com/users/tsachev/following{/other_user}","gists_url":"https://api.github.com/users/tsachev/gists{/gist_id}","starred_url":"https://api.github.com/users/tsachev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsachev/subscriptions","organizations_url":"https://api.github.com/users/tsachev/orgs","repos_url":"https://api.github.com/users/tsachev/repos","events_url":"https://api.github.com/users/tsachev/events{/privacy}","received_events_url":"https://api.github.com/users/tsachev/received_events","type":"User","site_admin":false},"labels":[{"id":407508641,"node_id":"MDU6TGFiZWw0MDc1MDg2NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20Low%20Level%20REST%20Client","name":":Core/Features/Java Low Level REST Client","color":"0e8a16","default":false,"description":"Minimal dependencies Java Client for Elasticsearch"},{"id":151561891,"node_id":"MDU6TGFiZWwxNTE1NjE4OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Logging","name":":Core/Infra/Logging","color":"0e8a16","default":false,"description":"Log management and logging utilities"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"assignees":[{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2017-08-22T08:44:46Z","updated_at":"2017-08-24T18:31:37Z","closed_at":"2017-08-22T21:18:36Z","author_association":"NONE","active_lock_reason":null,"body":"This affects the 5.6.0-SNAPSHOT version where commons-logging dependency is shaded (#25208).\r\nThe problem with commons logging is that it depends on service loader SPI (META-INF/services),\r\nSo if I want to provide an alternative logging backend like log4j-jcl, jcl-over-slf4j or other I cannot do it since it searches for the relocated LogFactory.\r\n\r\nHere is the log if I enable diagonstics with \r\n```\r\nSystem.setProperty(org.elasticsearch.client.commons.logging.LogFactory.DIAGNOSTICS_DEST_PROPERTY, \"STDERR\");\r\n```\r\n\r\n```\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Extension directories (java.ext.dir): null\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Application classpath (java.class.path): /usr/lib/jvm/java-8-jdk/jre/lib/charsets.jar:/usr/lib/jvm/java-8-jdk/jre/lib/deploy.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/cldrdata.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/dnsns.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/jaccess.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/jfxrt.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/localedata.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/nashorn.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/sunec.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/sunjce_provider.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/sunpkcs11.jar:/usr/lib/jvm/java-8-jdk/jre/lib/ext/zipfs.jar:/usr/lib/jvm/java-8-jdk/jre/lib/javaws.jar:/usr/lib/jvm/java-8-jdk/jre/lib/jce.jar:/usr/lib/jvm/java-8-jdk/jre/lib/jfr.jar:/usr/lib/jvm/java-8-jdk/jre/lib/jfxswt.jar:/usr/lib/jvm/java-8-jdk/jre/lib/jsse.jar:/usr/lib/jvm/java-8-jdk/jre/lib/management-agent.jar:/usr/lib/jvm/java-8-jdk/jre/lib/plugin.jar:/usr/lib/jvm/java-8-jdk/jre/lib/resources.jar:/usr/lib/jvm/java-8-jdk/jre/lib/rt.jar:/home/tsachev/tick42/metrics-viewer/es-rest-client-demo/target/classes:/home/tsachev/.m2/repository/org/apache/logging/log4j/log4j-api/2.8.2/log4j-api-2.8.2.jar:/home/tsachev/.m2/repository/org/apache/logging/log4j/log4j-core/2.8.2/log4j-core-2.8.2.jar:/home/tsachev/.m2/repository/org/apache/logging/log4j/log4j-jcl/2.8.2/log4j-jcl-2.8.2.jar:/home/tsachev/.m2/repository/commons-logging/commons-logging/1.2/commons-logging-1.2.jar:/home/tsachev/.m2/repository/org/elasticsearch/client/elasticsearch-rest-client/5.6.0-SNAPSHOT/elasticsearch-rest-client-5.6.0-SNAPSHOT.jar:/home/tsachev/apps/idea-IU-171.3780.107/lib/idea_rt.jar\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Class org.elasticsearch.client.commons.logging.LogFactory was loaded via classloader sun.misc.Launcher$AppClassLoader@414493378\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Ancestry of classloader which loaded org.elasticsearch.client.commons.logging.LogFactory is sun.misc.Launcher$AppClassLoader@414493378 == 'sun.misc.Launcher$AppClassLoader@18b4aac2'\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Ancestry of classloader which loaded org.elasticsearch.client.commons.logging.LogFactory is ClassLoader tree:sun.misc.Launcher$AppClassLoader@414493378 (SYSTEM)  --> sun.misc.Launcher$ExtClassLoader@1706377736 --> BOOT\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] BOOTSTRAP COMPLETED\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] LogFactory implementation requested for the first time for context classloader sun.misc.Launcher$AppClassLoader@414493378\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] sun.misc.Launcher$AppClassLoader@414493378 == 'sun.misc.Launcher$AppClassLoader@18b4aac2'\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] ClassLoader tree:sun.misc.Launcher$AppClassLoader@414493378 (SYSTEM)  --> sun.misc.Launcher$ExtClassLoader@1706377736 --> BOOT\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] No properties file of name 'commons-logging.properties' found.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] Looking for system property [org.apache.commons.logging.LogFactory] to define the LogFactory subclass to use...\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] No system property [org.apache.commons.logging.LogFactory] defined.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] Looking for a resource file of name [META-INF/services/org.apache.commons.logging.LogFactory] to define the LogFactory subclass to use...\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP]  Creating an instance of LogFactory class org.apache.logging.log4j.jcl.LogFactoryImpl as specified by file 'META-INF/services/org.apache.commons.logging.LogFactory' which was present in the path of the context classloader.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] Factory class org.apache.logging.log4j.jcl.LogFactoryImpl loaded from classloader sun.misc.Launcher$AppClassLoader@414493378 does not extend 'org.elasticsearch.client.commons.logging.LogFactory' as loaded by this classloader.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [BAD CL TREE] sun.misc.Launcher$AppClassLoader@414493378 == 'sun.misc.Launcher$AppClassLoader@18b4aac2'\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [BAD CL TREE] ClassLoader tree:sun.misc.Launcher$AppClassLoader@414493378 (SYSTEM)  --> sun.misc.Launcher$ExtClassLoader@1706377736 --> BOOT\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [CUSTOM LOG FACTORY] sun.misc.Launcher$AppClassLoader@414493378 == 'sun.misc.Launcher$AppClassLoader@18b4aac2'\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [CUSTOM LOG FACTORY] ClassLoader tree:sun.misc.Launcher$AppClassLoader@414493378 (SYSTEM)  --> sun.misc.Launcher$ExtClassLoader@1706377736 --> BOOT\r\n\r\n>>> THE PROBLEM\r\n\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [CUSTOM LOG FACTORY] org.apache.logging.log4j.jcl.LogFactoryImpl does not implement LogFactory.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] The application has specified that a custom LogFactory implementation should be used but Class 'org.apache.logging.log4j.jcl.LogFactoryImpl' cannot be converted to 'org.elasticsearch.client.commons.logging.LogFactory'. Please check the custom implementation. Help can be found @http://commons.apache.org/logging/troubleshooting.html.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] Unable to create LogFactory instance.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] An error occurred while loading the factory class:The chosen LogFactory implementation does not extend LogFactory. Please check your configuration. (Caused by java.lang.ClassCastException: The application has specified that a custom LogFactory implementation should be used but Class 'org.apache.logging.log4j.jcl.LogFactoryImpl' cannot be converted to 'org.elasticsearch.client.commons.logging.LogFactory'. Please check the custom implementation. Help can be found @http://commons.apache.org/logging/troubleshooting.html.)\r\n\r\n\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] A security exception occurred while trying to create an instance of the custom factory class: [The chosen LogFactory implementation does not extend LogFactory. Please check your configuration. (Caused by java.lang.ClassCastException: The application has specified that a custom LogFactory implementation should be used but Class 'org.apache.logging.log4j.jcl.LogFactoryImpl' cannot be converted to 'org.elasticsearch.client.commons.logging.LogFactory'. Please check the custom implementation. Help can be found @http://commons.apache.org/logging/troubleshooting.html.)]. Trying alternative implementations...\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] No properties file available to determine LogFactory subclass from..\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] [LOOKUP] Loading the default LogFactory implementation 'org.apache.commons.logging.impl.LogFactoryImpl' via the same classloader that loaded this LogFactory class (ie not looking in the context classloader).\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] Loaded class org.elasticsearch.client.commons.logging.impl.LogFactoryImpl from classloader sun.misc.Launcher$AppClassLoader@414493378\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Instance created.\r\n[LogFactory from sun.misc.Launcher$AppClassLoader@414493378] Created object org.elasticsearch.client.commons.logging.impl.LogFactoryImpl@2065951873 to manage classloader sun.misc.Launcher$AppClassLoader@414493378\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Discovering a Log implementation...\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Trying to get configuration for item org.elasticsearch.client.commons.logging.Log.allowFlawedContext\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No LogFactory attribute found for org.elasticsearch.client.commons.logging.Log.allowFlawedContext\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No system property found for property org.elasticsearch.client.commons.logging.Log.allowFlawedContext\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No configuration defined for item org.elasticsearch.client.commons.logging.Log.allowFlawedContext\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Trying to get configuration for item org.elasticsearch.client.commons.logging.Log.allowFlawedDiscovery\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No LogFactory attribute found for org.elasticsearch.client.commons.logging.Log.allowFlawedDiscovery\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No system property found for property org.elasticsearch.client.commons.logging.Log.allowFlawedDiscovery\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No configuration defined for item org.elasticsearch.client.commons.logging.Log.allowFlawedDiscovery\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] Trying to get configuration for item org.elasticsearch.client.commons.logging.Log.allowFlawedHierarchy\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No LogFactory attribute found for org.elasticsearch.client.commons.logging.Log.allowFlawedHierarchy\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No system property found for property org.elasticsearch.client.commons.logging.Log.allowFlawedHierarchy\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [ENV] No configuration defined for item org.elasticsearch.client.commons.logging.Log.allowFlawedHierarchy\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Trying to get log class from attribute 'org.apache.commons.logging.Log'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Trying to get log class from attribute 'org.apache.commons.logging.log'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Trying to get log class from system property 'org.apache.commons.logging.Log'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Trying to get log class from system property 'org.apache.commons.logging.log'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] No user-specified Log implementation; performing discovery using the standard supported logging implementations...\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Attempting to instantiate 'org.elasticsearch.client.commons.logging.impl.Log4JLogger'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Trying to load 'org.elasticsearch.client.commons.logging.impl.Log4JLogger' from classloader sun.misc.Launcher$AppClassLoader@414493378\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Class 'org.elasticsearch.client.commons.logging.impl.Log4JLogger' was found at 'jar:file:/home/tsachev/.m2/repository/org/elasticsearch/client/elasticsearch-rest-client/5.6.0-SNAPSHOT/elasticsearch-rest-client-5.6.0-SNAPSHOT.jar!/org/elasticsearch/client/commons/logging/impl/Log4JLogger.class'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] The log adapter 'org.elasticsearch.client.commons.logging.impl.Log4JLogger' is missing dependencies when loaded via classloader sun.misc.Launcher$AppClassLoader@414493378: org/elasticsearch/client/log4j/Category\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Attempting to instantiate 'org.elasticsearch.client.commons.logging.impl.Jdk14Logger'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Trying to load 'org.elasticsearch.client.commons.logging.impl.Jdk14Logger' from classloader sun.misc.Launcher$AppClassLoader@414493378\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Class 'org.elasticsearch.client.commons.logging.impl.Jdk14Logger' was found at 'jar:file:/home/tsachev/.m2/repository/org/elasticsearch/client/elasticsearch-rest-client/5.6.0-SNAPSHOT/elasticsearch-rest-client-5.6.0-SNAPSHOT.jar!/org/elasticsearch/client/commons/logging/impl/Jdk14Logger.class'\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] [INFO] 'org.elasticsearch.client.commons.logging.impl.Jdk14Logger' from classloader sun.misc.Launcher$AppClassLoader@414493378 does not declare optional method setLogFactory(LogFactory)\r\n[LogFactoryImpl@2065951873 from sun.misc.Launcher$AppClassLoader@414493378] Log adapter 'org.elasticsearch.client.commons.logging.impl.Jdk14Logger' from classloader sun.misc.Launcher$AppClassLoader@414493378 has been selected for use.\r\n```\r\n\r\nMaybe its better to leave commons-logging un-shaded. WDYT?","closed_by":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"performed_via_github_app":null}