{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48824","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48824/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48824/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48824/events","html_url":"https://github.com/elastic/elasticsearch/issues/48824","id":516298797,"node_id":"MDU6SXNzdWU1MTYyOTg3OTc=","number":48824,"title":"Aggregations should throw parse exception if no field or script is specified","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":837440720,"node_id":"MDU6TGFiZWw4Mzc0NDA3MjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Erefactoring","name":">refactoring","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"assignees":[{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-11-01T19:13:53Z","updated_at":"2020-02-11T17:47:04Z","closed_at":"2020-02-11T17:47:04Z","author_association":"MEMBER","active_lock_reason":null,"body":"Today if you specify an aggregation with no `field` or `script` like so:\r\n\r\n```json\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"the_terms\": {\r\n      \"terms\": {\r\n        \"size\": 10\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nWe throw an exception:\r\n\r\n```json\r\n{\r\n    \"type\": \"illegal_state_exception\",\r\n    \"reason\": \"value source config is invalid; must have either a field context or a script or marked as unwrapped\"\r\n}\r\n```\r\n\r\nThe problem is that the exception is generated from what is an otherwise invalid ValuesSourceConfig object.  E.g. when resolving we identify that there is no script or field, [generate an invalid VSConfig](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java#L74-L79), then later at the factory layer check to see if the VSConfig is valid and [throw an exception](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/support/ValuesSourceConfig.java#L255-L258).\r\n\r\nBesides being confusing from a code perspective, it also means we don't throw until we've already broadcast the request to the cluster.  We should instead fail during parsing because there is no sensible reason to omit both field and script (I don't think?)\r\n\r\nNote: There are a few instances (e.g. `ParentAggregationBuilder`) that use the mutability of VSConfig which may be why we ended up in this situation.  But even if we don't fix that part of VSConfig, we can head off these scenarios at the parse layer first. \r\n\r\nRelated to https://github.com/elastic/elasticsearch/issues/42949","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}