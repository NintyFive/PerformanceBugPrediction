{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57523","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57523/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57523/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57523/events","html_url":"https://github.com/elastic/elasticsearch/issues/57523","id":629189463,"node_id":"MDU6SXNzdWU2MjkxODk0NjM=","number":57523,"title":"when the old master node is \"stoping\", let the new master rejoin to the old master","user":{"login":"kingfeiyu1","id":65000037,"node_id":"MDQ6VXNlcjY1MDAwMDM3","avatar_url":"https://avatars0.githubusercontent.com/u/65000037?v=4","gravatar_id":"","url":"https://api.github.com/users/kingfeiyu1","html_url":"https://github.com/kingfeiyu1","followers_url":"https://api.github.com/users/kingfeiyu1/followers","following_url":"https://api.github.com/users/kingfeiyu1/following{/other_user}","gists_url":"https://api.github.com/users/kingfeiyu1/gists{/gist_id}","starred_url":"https://api.github.com/users/kingfeiyu1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kingfeiyu1/subscriptions","organizations_url":"https://api.github.com/users/kingfeiyu1/orgs","repos_url":"https://api.github.com/users/kingfeiyu1/repos","events_url":"https://api.github.com/users/kingfeiyu1/events{/privacy}","received_events_url":"https://api.github.com/users/kingfeiyu1/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-06-02T13:08:35Z","updated_at":"2020-07-14T08:13:33Z","closed_at":"2020-07-14T08:13:33Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.2.4\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_161\"\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux es-node1-7478fff9-jswwt 3.10.0-862.el7.x86_64 #1 SMP Fri Apr 20 16:44:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux (K8s)\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe operating environment is k8s. During the es cluster upgrade process, the old master node did not actually shut down after it was stoping. The old master node caught the signal sent by the newly elected master node, thinking it was an old cluster state, let the new master rejoin to the old cluster, and then the old cluster shuts down, causing the new master node to lose its master, and because the new master node shuts down nodeFD and masterFD, the cluster remains unmastered and cannot be recovered\r\n\r\n**Steps to reproduce**:\r\n\r\nRestart the new master node, the remaining nodes choose the master and restart the new master node again, multiple operations occur occasionally\r\n\r\n**Provide logs (if relevant)**:\r\nnode3（old master）：\r\n[2020-05-09 16:38:26.854] INFO  Thread-2                     es es-node3-67cc8ccc7c-8llsn [o.e.n.Node               ] [logcenter-node-3] stopping ...\r\n.......\r\n[2020-05-09 16:38:46.442] WARN  elasticsearch[logcenter-node es es-node3-67cc8ccc7c-8llsn [o.e.d.z.ZenDiscovery     ] [logcenter-node-3] discovered [{logcenter-node-1}{27HAN7cyS1-GaORqoQwlyA}{GJz8BjXBS2O_x1xaPllQlw}{177.177.123.233}{177.177.123.233:9300}] which is also master but with an older cluster_state, telling [{logcenter-node-1}{27HAN7cyS1-GaORqoQwlyA}{GJz8BjXBS2O_x1xaPllQlw}{177.177.123.233}{177.177.123.233:9300}] to rejoin the cluster ([node fd ping])\r\n......\r\n[2020-05-09 16:38:56.136] INFO  Thread-2                     es es-node3-67cc8ccc7c-8llsn [o.e.n.Node               ] [logcenter-node-3] stopped\r\n[2020-05-09 16:38:56.136] INFO  Thread-2                     es es-node3-67cc8ccc7c-8llsn [o.e.n.Node               ] [logcenter-node-3] closing ...\r\n[2020-05-09 16:38:56.155] INFO  Thread-2                     es es-node3-67cc8ccc7c-8llsn [o.e.n.Node               ] [logcenter-node-3] closed\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}