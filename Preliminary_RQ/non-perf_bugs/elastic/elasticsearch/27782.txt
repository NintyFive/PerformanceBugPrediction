{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27782","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27782/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27782/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27782/events","html_url":"https://github.com/elastic/elasticsearch/issues/27782","id":281441006,"node_id":"MDU6SXNzdWUyODE0NDEwMDY=","number":27782,"title":"ES 6.0 regression: \"query must be rewritten first\" exception when using terms lookup filter in nested aggregation","user":{"login":"mrszg","id":16191343,"node_id":"MDQ6VXNlcjE2MTkxMzQz","avatar_url":"https://avatars0.githubusercontent.com/u/16191343?v=4","gravatar_id":"","url":"https://api.github.com/users/mrszg","html_url":"https://github.com/mrszg","followers_url":"https://api.github.com/users/mrszg/followers","following_url":"https://api.github.com/users/mrszg/following{/other_user}","gists_url":"https://api.github.com/users/mrszg/gists{/gist_id}","starred_url":"https://api.github.com/users/mrszg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mrszg/subscriptions","organizations_url":"https://api.github.com/users/mrszg/orgs","repos_url":"https://api.github.com/users/mrszg/repos","events_url":"https://api.github.com/users/mrszg/events{/privacy}","received_events_url":"https://api.github.com/users/mrszg/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2017-12-12T16:08:40Z","updated_at":"2019-04-08T10:59:56Z","closed_at":"2018-02-02T15:04:34Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**\r\n6.0.0, 6.0.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** :\r\nopenjdk version \"1.8.0_151\"\r\nOpenJDK Runtime Environment (build 1.8.0_151-8u151-b12-0ubuntu0.17.10.2-b12)\r\nOpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n\r\n**OS version** :\r\nUbuntu 17.10 with kernel 4.13.0-19-generic\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nQuery with **filter aggregation** based on **terms filter lookup** **nested below other aggregation** terminates with error **\"query must be rewritten first\"**. The same query executed on version 5.6.5 finishes with success. \r\n\r\n**This error is very similar to already reported and closed:  #21301**\r\n\r\n**The only difference is that now query fails when nested aggregation is used.** \r\n\r\n\r\n**Steps to reproduce**:\r\nRecreation steps are based on those provided in issue #21301:\r\n\r\n\r\n1. create index test_posts\r\n\r\n```\r\nPUT test_posts\r\n{\r\n  \"mappings\": {\r\n    \"post\": {\r\n      \"properties\": {\r\n        \"mentionIDs\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n2. create index test_users\r\n\r\n```\r\nPUT test_users\r\n{\r\n  \"mappings\": {\r\n    \"user\": {\r\n      \"properties\": {\r\n        \"notifications\": {\r\n          \"type\": \"keyword\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n3. index some user\r\n\r\n```\r\nPUT test_users/user/USR|CLIENTID|1234\r\n{\r\n  \"notifications\": [\"abc\"]\r\n}\r\n```\r\n\r\n\r\n4. insert some post\r\n\r\n```\r\nPUT test_posts/post/POST|4321\r\n{\r\n  \"mentionIDs\": [\"abc\"]\r\n}\r\n```\r\n\r\n5. execute search (this search finishes with success - it is similar to that from #21301)\r\n\r\n```\r\nGET test_posts/_search\r\n{\r\n  \"aggs\": {\r\n    \"itemsNotify\": {\r\n      \"filter\": {\r\n        \"terms\": {\r\n          \"mentionIDs\": {\r\n            \"index\": \"test_users\",\r\n            \"type\": \"user\",\r\n            \"id\": \"USR|CLIENTID|1234\",\r\n            \"path\": \"notifications\",\r\n            \"routing\": \"CLIENTID\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**6. This search fails with error on ES 6.0.0 and ES 6.0.1:**\r\n\r\n```\r\nGET /test_posts/_search\r\n{\r\n  \"aggs\": {\r\n    \"facets\": {\r\n      \"global\": {},\r\n      \"aggs\": {\r\n        \"filteredFacets\": {\r\n          \"filter\": {\r\n            \"terms\": {\r\n              \"mentionIDs\": {\r\n                \"index\": \"test_users\",\r\n                \"type\": \"user\",\r\n                \"id\": \"USR|CLIENTID|1234\",\r\n                \"path\": \"notifications\",\r\n                \"routing\": \"CLIENTID\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\n\r\nQuery result is:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"unsupported_operation_exception\",\r\n        \"reason\": \"query must be rewritten first\"\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"test_posts\",\r\n        \"node\": \"5ipdZJUdSqKf5gnOkwlkDg\",\r\n        \"reason\": {\r\n          \"type\": \"unsupported_operation_exception\",\r\n          \"reason\": \"query must be rewritten first\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n**Above query finishes with success on ES 5.6.5**\r\n\r\n**Fragment of logs from server**:\r\n[es-query-must-be-rewritten.log](https://github.com/elastic/elasticsearch/files/1552226/es-query-must-be-rewritten.log)\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}