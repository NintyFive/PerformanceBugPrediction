{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42487","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42487/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42487/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42487/events","html_url":"https://github.com/elastic/elasticsearch/issues/42487","id":447974037,"node_id":"MDU6SXNzdWU0NDc5NzQwMzc=","number":42487,"title":"[CI ] IndexRequest serialization trips Asserts during rolling upgrade test","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-05-24T04:28:35Z","updated_at":"2019-05-26T19:33:57Z","closed_at":"2019-05-24T06:31:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The X-Pack rolling-upgrade tests from 6.0.1 to 6.8 are failing\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.8+bwc-tests/70/\r\n```\r\n./gradlew :x-pack:qa:rolling-upgrade:with-system-key:v6.0.1#bwcTest\r\n```\r\n\r\nbecause they are tripping this seqNo assertion in `IndexRequest.writeTo`\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/v6.8.0/server/src/main/java/org/elasticsearch/action/index/IndexRequest.java#L656-L661\r\n```\r\n        if (out.getVersion().onOrAfter(Version.V_6_6_0)) {\r\n            out.writeZLong(ifSeqNo);\r\n            out.writeVLong(ifPrimaryTerm);\r\n        } else if (ifSeqNo != UNASSIGNED_SEQ_NO || ifPrimaryTerm != UNASSIGNED_PRIMARY_TERM) {\r\n            assert false : \"setIfMatch [\" + ifSeqNo + \"], currentDocTem [\" + ifPrimaryTerm + \"]\";\r\n            throw new IllegalStateException(\r\n                \"sequence number based compare and write is not supported until all nodes are on version 7.0 or higher. \" +\r\n                    \"Stream version [\" + out.getVersion() + \"]\");\r\n        }\r\n```\r\n\r\n- The old cluster (v6.0.1) works fine.\r\n- Then we upgrade node-0 to 6.8.x, this seems to be fine\r\n- Then we upgrade node-1 to 6.8.x, this causes node-0 to fail\r\n\r\n```\r\n[2019-05-24T12:16:10,245][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [upgraded-node-0] fatal error in thread [elasticsearch[upgraded-node-0][write][T\r\n#6]], exiting\r\njava.lang.AssertionError: setIfMatch [717], currentDocTem [2]\r\n        at org.elasticsearch.action.index.IndexRequest.writeTo(IndexRequest.java:657) ~[elasticsearch-6.8.1-SNAPSHOT.jar:6.8.1-SNAPSHOT]\r\n        at org.elasticsearch.action.DocWriteRequest.writeDocumentRequest(DocWriteRequest.java:244) ~[elasticsearch-6.8.1-SNAPSHOT.jar:6.8.1-SNAPSHOT]\r\n        at org.elasticsearch.action.bulk.BulkItemRequest.writeTo(BulkItemRequest.java:110) ~[elasticsearch-6.8.1-SNAPSHOT.jar:6.8.1-SNAPSHOT]\r\n        at org.elasticsearch.action.bulk.BulkShardRequest.writeTo(BulkShardRequest.java:73) ~[elasticsearch-6.8.1-SNAPSHOT.jar:6.8.1-SNAPSHOT]\r\n        at org.elasticsearch.action.support.replication.TransportReplicationAction$ConcreteShardRequest.writeTo(TransportReplicationAction.java:1285) ~[elasti\r\ncsearch-6.8.1-SNAPSHOT.jar:6.8.1-SNAPSHOT]\r\n        at org.elasticsearch.action.support.replication.TransportReplicationAction$ConcreteReplicaRequest.writeTo(TransportReplicationAction.java:1341) ~[elas\r\nticsearch-6.8.1-SNAPSHOT.jar:6.8.1-SNAPSHOT]\r\n```\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}