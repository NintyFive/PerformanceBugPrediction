{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/47929","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47929/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47929/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47929/events","html_url":"https://github.com/elastic/elasticsearch/issues/47929","id":505924306,"node_id":"MDU6SXNzdWU1MDU5MjQzMDY=","number":47929,"title":"Dockerised server cannot access bindmounts with the documented group ID","user":{"login":"fedde-s","id":4929431,"node_id":"MDQ6VXNlcjQ5Mjk0MzE=","avatar_url":"https://avatars3.githubusercontent.com/u/4929431?v=4","gravatar_id":"","url":"https://api.github.com/users/fedde-s","html_url":"https://github.com/fedde-s","followers_url":"https://api.github.com/users/fedde-s/followers","following_url":"https://api.github.com/users/fedde-s/following{/other_user}","gists_url":"https://api.github.com/users/fedde-s/gists{/gist_id}","starred_url":"https://api.github.com/users/fedde-s/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fedde-s/subscriptions","organizations_url":"https://api.github.com/users/fedde-s/orgs","repos_url":"https://api.github.com/users/fedde-s/repos","events_url":"https://api.github.com/users/fedde-s/events{/privacy}","received_events_url":"https://api.github.com/users/fedde-s/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"}],"state":"closed","locked":false,"assignee":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"assignees":[{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-10-11T15:39:23Z","updated_at":"2019-11-27T09:03:58Z","closed_at":"2019-11-27T08:36:31Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`docker run --rm docker.elastic.co/elasticsearch/elasticsearch-oss:7.4.0 elasticsearch --version`):\r\n```console\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\nVersion: 7.4.0, Build: oss/docker/22e1767283e61a198cb4db791ea66e3f11ab9910/2019-09-27T08:36:48.569419Z, JVM: 13\r\n```\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (``docker run --rm docker.elastic.co/elasticsearch/elasticsearch-oss:7.4.0 /bin/bash -c 'source \"`dirname \"$0\"`\"/elasticsearch-env && \"$JAVA\" --version' /usr/share/elasticsearch/bin/elasticsearch``):\r\n```console\r\nopenjdk 13 2019-09-17\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 13+33)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13+33, mixed mode, sharing)\r\n```\r\n\r\n**OS version** (`uname -srvm`):\r\n```console\r\nLinux 4.15.0-65-generic #74-Ubuntu SMP Tue Sep 17 17:06:04 UTC 2019 x86_64\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n[The documentation on bind-mounting configuration into an Elasticsearch Docker container](https://www.elastic.co/guide/en/elasticsearch/reference/7.4/docker.html#_b_bind_mounted_configuration) claims that the container will run Elasticsearch as a user with group ID 1000, and [the notes on defaults underneath](https://www.elastic.co/guide/en/elasticsearch/reference/7.4/docker.html#_notes_for_production_use_and_defaults) contain detailed instructions to create a bind-mountable data directory to be accessed by such a user. However, when I follow these instructions, Elasticsearch fails with this message:\r\n```console\r\n\"org.elasticsearch.bootstrap.StartupException: ElasticsearchException[failed to bind service]; nested: AccessDeniedException[/usr/share/elasticsearch/data/nodes];\",\r\n```\r\n\r\nThe output below suggests that [the Dockerfile did add a user with this default group](https://github.com/elastic/elasticsearch/blob/v7.4.0/distribution/docker/src/docker/Dockerfile#L19), but [the command that the entrypoint uses to switch to that user's user ID](https://github.com/elastic/elasticsearch/blob/v7.4.0/distribution/docker/src/docker/bin/docker-entrypoint.sh#L34) does not reference that configuration to set the group ID for the user.\r\n\r\n```console\r\n% docker run --rm -it --entrypoint='/bin/bash' docker.elastic.co/elasticsearch/elasticsearch-oss:7.4.0\r\n[root@0e0c8897af8d elasticsearch]# id\r\nuid=0(root) gid=0(root) groups=0(root)\r\n[root@0e0c8897af8d elasticsearch]# grep elasticsearch /etc/passwd\r\nelasticsearch:x:1000:1000::/usr/share/elasticsearch:/bin/bash\r\n[root@0e0c8897af8d elasticsearch]# grep elasticsearch /etc/group \r\nroot:x:0:elasticsearch\r\nelasticsearch:x:1000:\r\n[root@0e0c8897af8d elasticsearch]# chroot --userspec=1000 / /bin/bash\r\n[elasticsearch@0e0c8897af8d /]$ id\r\nuid=1000(elasticsearch) gid=0(root) groups=0(root)\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. As a user that does not have user ID 1000 on the host, create a folder as per the documentation linked above\r\n```bash\r\nsudo -- sh -c 'mkdir esdatadir && chmod g+rwx esdatadir && chgrp 1000 esdatadir'\r\n```\r\n\r\n 2. Run a container that mounts the folder read-write as its data dir\r\n```bash\r\ndocker run --rm --ulimit nofile=65535:65535 -e \"discovery.type=single-node\" -v \"$PWD/esdatadir:/usr/share/elasticsearch/data\" docker.elastic.co/elasticsearch/elasticsearch-oss:7.4.0\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n<details>\r\n\r\n```console\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\n{\"type\": \"server\", \"timestamp\": \"2019-10-11T15:36:59,291Z\", \"level\": \"WARN\", \"component\": \"o.e.b.ElasticsearchUncaughtExceptionHandler\", \"cluster.name\": \"docker-cluster\", \"node.name\": \"889776d11c03\", \"message\":\r\n\"uncaught exception in thread [main]\",                                                                       \r\n\"stacktrace\": [\"org.elasticsearch.bootstrap.StartupException: ElasticsearchException[failed to bind service]; nested: AccessDeniedException[/usr/share/elasticsearch/data/nodes];\",\r\n\"at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:163) ~[elasticsearch-7.4.0.jar:7.4.0]\",                                                                                                      \"at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:150) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:125) ~[elasticsearch-cli-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.cli.Command.main(Command.java:90) ~[elasticsearch-cli-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:115) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"Caused by: org.elasticsearch.ElasticsearchException: failed to bind service\",\r\n\"at org.elasticsearch.node.Node.<init>(Node.java:614) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.node.Node.<init>(Node.java:255) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:221) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:221) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:349) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:159) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"... 6 more\"\r\n\"Caused by: java.nio.file.AccessDeniedException: /usr/share/elasticsearch/data/nodes\",\r\n\"at sun.nio.fs.UnixException.translateToIOException(UnixException.java:90) ~[?:?]\",\r\n\"at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111) ~[?:?]\",\r\n\"at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116) ~[?:?]\",\r\n\"at sun.nio.fs.UnixFileSystemProvider.createDirectory(UnixFileSystemProvider.java:389) ~[?:?]\",\r\n\"at java.nio.file.Files.createDirectory(Files.java:693) ~[?:?]\",\r\n\"at java.nio.file.Files.createAndCheckIsDirectory(Files.java:800) ~[?:?]\",\r\n\"at java.nio.file.Files.createDirectories(Files.java:786) ~[?:?]\",\r\n\"at org.elasticsearch.env.NodeEnvironment.lambda$new$0(NodeEnvironment.java:272) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.env.NodeEnvironment$NodeLock.<init>(NodeEnvironment.java:209) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.env.NodeEnvironment.<init>(NodeEnvironment.java:269) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.node.Node.<init>(Node.java:275) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.node.Node.<init>(Node.java:255) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:221) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:221) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:349) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:159) ~[elasticsearch-7.4.0.jar:7.4.0]\",\r\n\"... 6 more\"] }\r\n```\r\n\r\n</details>","closed_by":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}