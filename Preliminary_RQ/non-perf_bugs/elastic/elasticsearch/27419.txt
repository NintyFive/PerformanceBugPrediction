{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27419","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27419/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27419/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27419/events","html_url":"https://github.com/elastic/elasticsearch/issues/27419","id":274715520,"node_id":"MDU6SXNzdWUyNzQ3MTU1MjA=","number":27419,"title":"Bug: score of zero for function_score with nested bool filter query","user":{"login":"lukas-gitl","id":7819023,"node_id":"MDQ6VXNlcjc4MTkwMjM=","avatar_url":"https://avatars3.githubusercontent.com/u/7819023?v=4","gravatar_id":"","url":"https://api.github.com/users/lukas-gitl","html_url":"https://github.com/lukas-gitl","followers_url":"https://api.github.com/users/lukas-gitl/followers","following_url":"https://api.github.com/users/lukas-gitl/following{/other_user}","gists_url":"https://api.github.com/users/lukas-gitl/gists{/gist_id}","starred_url":"https://api.github.com/users/lukas-gitl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukas-gitl/subscriptions","organizations_url":"https://api.github.com/users/lukas-gitl/orgs","repos_url":"https://api.github.com/users/lukas-gitl/repos","events_url":"https://api.github.com/users/lukas-gitl/events{/privacy}","received_events_url":"https://api.github.com/users/lukas-gitl/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2017-11-17T00:49:49Z","updated_at":"2017-11-17T17:47:45Z","closed_at":"2017-11-17T09:44:06Z","author_association":"NONE","active_lock_reason":null,"body":">_We are currently blocked by this. I'd much appreciate some feedback._ \r\n\r\n**Problem Description**:\r\n\r\nScore of zero returned when using `function_score` with query that has a `nested bool filter`. Expected is that the function score actually reflects the `random_score` function result.\r\n\r\nUsing `explain` it seems that the query pollutes the score. According to [the documentation](https://www.elastic.co/guide/en/elasticsearch/reference/5.4/query-dsl-function-score-query.html#query-dsl-function-score-query) this should never happen when `boost_mode: replace` is used. Removing the nesting also fixes this.\r\n\r\n[This guy](https://discuss.elastic.co/t/range-filters-with-query-string-and-function-score-returning-zero-results/98472) seems to have the same problem. Unfortunately they never received an answer.\r\n\r\n**Offending query:**\r\n```json\r\n{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": {\r\n        \"nested\": {\r\n          \"path\": \"schedules\",\r\n          \"query\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"range\": {\r\n                    \"schedules.start\": {\r\n                      \"lte\": \"now\"\r\n                    }\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      },\r\n      \"random_score\": {},\r\n      \"score_mode\": \"sum\",\r\n      \"boost_mode\": \"replace\"\r\n    }\r\n  },\r\n  \"explain\": true\r\n}\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nDownload [data.zip](https://github.com/elastic/elasticsearch/files/1480690/data.zip), unzipped it into a folder, cd into the folder and then run `. run.sh`\r\n\r\n**Debug Output**:\r\n```\r\n{\r\n  \"took\" : 3,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 0.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_shard\" : \"[item][2]\",\r\n        \"_node\" : \"Lbt3Gxq7RnSir3byoNpp5w\",\r\n        \"_index\" : \"item\",\r\n        \"_type\" : \"item\",\r\n        \"_id\" : \"7517967e-824e-4bfd-b67c-887cfeeeabb8\",\r\n        \"_score\" : 0.0,\r\n        \"_source\" : {\r\n          \"id\" : \"7517967e-824e-4bfd-b67c-887cfeeeabb8\",\r\n          \"schedules\" : {\r\n            \"start\" : \"2015-01-01\"\r\n          }\r\n        },\r\n        \"_explanation\" : {\r\n          \"value\" : 0.0,\r\n          \"description\" : \"sum of:\",\r\n          \"details\" : [\r\n            {\r\n              \"value\" : 0.0,\r\n              \"description\" : \"function score, product of:\",\r\n              \"details\" : [\r\n                {\r\n                  \"value\" : 0.0,\r\n                  \"description\" : \"Score based on 1 child docs in range from 0 to 0, best match:\",\r\n                  \"details\" : [\r\n                    {\r\n                      \"value\" : 0.0,\r\n                      \"description\" : \"sum of:\",\r\n                      \"details\" : [\r\n                        {\r\n                          \"value\" : 0.0,\r\n                          \"description\" : \"ConstantScore(schedules.start:[-9223372036854775808 TO 9223372036854775807]), product of:\",\r\n                          \"details\" : [\r\n                            {\r\n                              \"value\" : 0.0,\r\n                              \"description\" : \"boost\",\r\n                              \"details\" : [ ]\r\n                            },\r\n                            {\r\n                              \"value\" : 1.0,\r\n                              \"description\" : \"queryNorm\",\r\n                              \"details\" : [ ]\r\n                            }\r\n                          ]\r\n                        },\r\n                        {\r\n                          \"value\" : 0.0,\r\n                          \"description\" : \"match on required clause, product of:\",\r\n                          \"details\" : [\r\n                            {\r\n                              \"value\" : 0.0,\r\n                              \"description\" : \"# clause\",\r\n                              \"details\" : [ ]\r\n                            },\r\n                            {\r\n                              \"value\" : 1.0,\r\n                              \"description\" : \"_type:__schedules, product of:\",\r\n                              \"details\" : [\r\n                                {\r\n                                  \"value\" : 1.0,\r\n                                  \"description\" : \"boost\",\r\n                                  \"details\" : [ ]\r\n                                },\r\n                                {\r\n                                  \"value\" : 1.0,\r\n                                  \"description\" : \"queryNorm\",\r\n                                  \"details\" : [ ]\r\n                                }\r\n                              ]\r\n                            }\r\n                          ]\r\n                        }\r\n                      ]\r\n                    }\r\n                  ]\r\n                },\r\n                {\r\n                  \"value\" : 0.6308505,\r\n                  \"description\" : \"min of:\",\r\n                  \"details\" : [\r\n                    {\r\n                      \"value\" : 0.6308505,\r\n                      \"description\" : \"random score function (seed: -949337162)\",\r\n                      \"details\" : [ ]\r\n                    },\r\n                    {\r\n                      \"value\" : 3.4028235E38,\r\n                      \"description\" : \"maxBoost\",\r\n                      \"details\" : [ ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            },\r\n            {\r\n              \"value\" : 0.0,\r\n              \"description\" : \"match on required clause, product of:\",\r\n              \"details\" : [\r\n                {\r\n                  \"value\" : 0.0,\r\n                  \"description\" : \"# clause\",\r\n                  \"details\" : [ ]\r\n                },\r\n                {\r\n                  \"value\" : 1.0,\r\n                  \"description\" : \"#*:* -_type:__*, product of:\",\r\n                  \"details\" : [\r\n                    {\r\n                      \"value\" : 1.0,\r\n                      \"description\" : \"boost\",\r\n                      \"details\" : [ ]\r\n                    },\r\n                    {\r\n                      \"value\" : 1.0,\r\n                      \"description\" : \"queryNorm\",\r\n                      \"details\" : [ ]\r\n                    }\r\n                  ]\r\n                }\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n----------\r\n\r\n**Elasticsearch version**:\r\n\r\n```json\r\n\"number\" : \"5.1.2\",\r\n\"build_hash\" : \"c8c4c16\",\r\n\"build_date\" : \"2017-01-11T20:18:39.146Z\",\r\n\"build_snapshot\" : false,\r\n\"lucene_version\" : \"6.3.0\"\r\n```\r\n\r\n**Plugins installed**: -\r\n\r\n**JVM version**:\r\n```\r\njava version \"1.8.0_151\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_151-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n```\r\n**OS version**:\r\n```\r\nUbuntu 16.04\r\nLinux fluxbox 4.10.0-38-generic #42~16.04.1-Ubuntu SMP \r\nTue Oct 10 16:32:20 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}