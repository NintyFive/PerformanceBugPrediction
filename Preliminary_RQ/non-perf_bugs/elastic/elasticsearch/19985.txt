{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19985","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19985/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19985/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19985/events","html_url":"https://github.com/elastic/elasticsearch/issues/19985","id":171008566,"node_id":"MDU6SXNzdWUxNzEwMDg1NjY=","number":19985,"title":"Do we need enable BoostingQuery with FVH highlighter?","user":{"login":"chengpohi","id":5118048,"node_id":"MDQ6VXNlcjUxMTgwNDg=","avatar_url":"https://avatars2.githubusercontent.com/u/5118048?v=4","gravatar_id":"","url":"https://api.github.com/users/chengpohi","html_url":"https://github.com/chengpohi","followers_url":"https://api.github.com/users/chengpohi/followers","following_url":"https://api.github.com/users/chengpohi/following{/other_user}","gists_url":"https://api.github.com/users/chengpohi/gists{/gist_id}","starred_url":"https://api.github.com/users/chengpohi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chengpohi/subscriptions","organizations_url":"https://api.github.com/users/chengpohi/orgs","repos_url":"https://api.github.com/users/chengpohi/repos","events_url":"https://api.github.com/users/chengpohi/events{/privacy}","received_events_url":"https://api.github.com/users/chengpohi/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":415784162,"node_id":"MDU6TGFiZWw0MTU3ODQxNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-beta1","name":"v5.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-08-13T13:17:22Z","updated_at":"2016-09-14T14:42:52Z","closed_at":"2016-08-13T13:49:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I have noticed `BoostingQuery` with `FVH` highligher is broken.\n\nSee the `HighlighterSearchIT` `testBoostingQueryTermVector` and `testFastVectorHighlighterPhraseBoost`\n\n```\n@AwaitsFix(bugUrl=\"Broken now that BoostingQuery does not extend BooleanQuery anymore\")\n```\n\nThis is caused by when use `FastVectorHighlighter` to highlight, that will query field by:\n\n```\ncache.fieldMatchFieldQuery = new CustomFieldQuery(highlighterContext.query, hitContext.topLevelReader(),true, field.fieldOptions().requireFieldMatch());\n```\n\nbut for `CustomeFieldQuery` not flatten `BoostQuery`, this will cause `fieldQueryies` are null.\n\n```\n    @Override\n    void flatten(Query sourceQuery, IndexReader reader, Collection<Query> flatQueries, float boost) throws IOException {\n        if (sourceQuery instanceof SpanTermQuery) {\n            super.flatten(new TermQuery(((SpanTermQuery) sourceQuery).getTerm()), reader, flatQueries, boost);\n        } else if (sourceQuery instanceof ConstantScoreQuery) {\n            flatten(((ConstantScoreQuery) sourceQuery).getQuery(), reader, flatQueries, boost);\n        } else if (sourceQuery instanceof FunctionScoreQuery) {\n            flatten(((FunctionScoreQuery) sourceQuery).getSubQuery(), reader, flatQueries, boost);\n        } else if (sourceQuery instanceof MultiPhrasePrefixQuery) {\n            flatten(sourceQuery.rewrite(reader), reader, flatQueries, boost);\n        } else if (sourceQuery instanceof FiltersFunctionScoreQuery) {\n            flatten(((FiltersFunctionScoreQuery) sourceQuery).getSubQuery(), reader, flatQueries, boost);\n        } else if (sourceQuery instanceof MultiPhraseQuery) {\n            MultiPhraseQuery q = ((MultiPhraseQuery) sourceQuery);\n            convertMultiPhraseQuery(0, new int[q.getTermArrays().length], q, q.getTermArrays(), q.getPositions(), reader, flatQueries);\n        } else if (sourceQuery instanceof BlendedTermQuery) {\n            final BlendedTermQuery blendedTermQuery = (BlendedTermQuery) sourceQuery;\n            flatten(blendedTermQuery.rewrite(reader), reader, flatQueries, boost);\n        } else if (sourceQuery instanceof ToParentBlockJoinQuery) {\n            ToParentBlockJoinQuery blockJoinQuery = (ToParentBlockJoinQuery) sourceQuery;\n            flatten(blockJoinQuery.getChildQuery(), reader, flatQueries, boost);\n        } else {\n            super.flatten(sourceQuery, reader, flatQueries, boost);\n        }\n    }\n```\n\nI have created a PR to enable it: https://github.com/elastic/elasticsearch/pull/19984\n\nIs there anyone can review and give some feedback?\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}