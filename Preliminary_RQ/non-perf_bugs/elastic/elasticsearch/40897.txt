{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40897","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40897/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40897/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40897/events","html_url":"https://github.com/elastic/elasticsearch/issues/40897","id":429744937,"node_id":"MDU6SXNzdWU0Mjk3NDQ5Mzc=","number":40897,"title":"HLClient forces using `include_type_name` from 6.7","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"labels":[{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":30486044,"node_id":"MDU6TGFiZWwzMDQ4NjA0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eregression","name":">regression","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-04-05T13:04:09Z","updated_at":"2019-04-08T13:32:26Z","closed_at":"2019-04-08T13:32:26Z","author_association":"MEMBER","active_lock_reason":null,"body":"Here is a Java code I tested against an elasticsearch node running a 6.7.1.\r\n\r\nMy `pom.xml`:\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"UTF-8\"?>\r\n<project xmlns=\"http://maven.apache.org/POM/4.0.0\"\r\n         xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n         xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\">\r\n    <modelVersion>4.0.0</modelVersion>\r\n\r\n    <groupId>fr.pilato.test.elasticsearch</groupId>\r\n    <artifactId>hlclient</artifactId>\r\n    <version>1.0-SNAPSHOT</version>\r\n\r\n    <properties>\r\n        <java.compiler.version>1.8</java.compiler.version>\r\n    </properties>\r\n\r\n    <build>\r\n        <plugins>\r\n            <plugin>\r\n                <groupId>org.apache.maven.plugins</groupId>\r\n                <artifactId>maven-compiler-plugin</artifactId>\r\n                <version>3.8.0</version>\r\n                <configuration>\r\n                    <source>${java.compiler.version}</source>\r\n                    <target>${java.compiler.version}</target>\r\n                    <encoding>UTF-8</encoding>\r\n                    <optimize>true</optimize>\r\n                    <showDeprecation>true</showDeprecation>\r\n                    <showWarnings>true</showWarnings>\r\n                    <compilerArgument>-Xlint:all,-serial,-path,-rawtypes,-unchecked</compilerArgument>\r\n                </configuration>\r\n            </plugin>\r\n        </plugins>\r\n    </build>\r\n\r\n    <dependencies>\r\n        <dependency>\r\n            <groupId>org.elasticsearch.client</groupId>\r\n            <artifactId>elasticsearch-rest-high-level-client</artifactId>\r\n            <version>6.6.2</version>\r\n        </dependency>\r\n    </dependencies>\r\n\r\n</project>\r\n```\r\n\r\nMy code:\r\n\r\n```java\r\npackage fr.pilato.test.elasticsearch.hlclient;\r\n\r\nimport org.apache.http.HttpHost;\r\nimport org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\r\nimport org.elasticsearch.client.RequestOptions;\r\nimport org.elasticsearch.client.RestClient;\r\nimport org.elasticsearch.client.RestHighLevelClient;\r\nimport org.elasticsearch.common.xcontent.XContentType;\r\n\r\nimport java.io.IOException;\r\n\r\npublic class App {\r\n    public static void main(String[] args) throws IOException {\r\n        RestHighLevelClient client = new RestHighLevelClient(\r\n            RestClient.builder(HttpHost.create(\"http://localhost:9200\")));\r\n        try {\r\n            CreateIndexRequest cir = new CreateIndexRequest(\"foo\");\r\n            cir.source(\"{\\n\" +\r\n                    \"  \\\"mappings\\\": {\\n\" +\r\n                    \"    \\\"_doc\\\": {\\n\" +\r\n                    \"      \\\"properties\\\": {\\n\" +\r\n                    \"        \\\"content\\\": {\\n\" +\r\n                    \"          \\\"type\\\": \\\"text\\\"\\n\" +\r\n                    \"        }\\n\" +\r\n                    \"      }\\n\" +\r\n                    \"    }\\n\" +\r\n                    \"  }\\n\" +\r\n                    \"}\\n\", XContentType.JSON);\r\n            client.indices().create(cir, RequestOptions.DEFAULT);\r\n        } catch (Exception e) {\r\n            e.printStackTrace(System.err);\r\n        } finally {\r\n            client.close();\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThis is running well with the usual deprecation warnings:\r\n\r\n```\r\nAVERTISSEMENT: request [PUT http://localhost:9200/foo?master_timeout=30s&timeout=30s] returned 2 warnings: [299 Elasticsearch-6.7.1-2f32220 \"the default number of shards will change from [5] to [1] in 7.0.0; if you wish to continue using the default of [5] shards, you must manage this on the create index request or with an index template\"],[299 Elasticsearch-6.7.1-2f32220 \"[types removal] The parameter include_type_name should be explicitly specified in create index requests to prepare for 7.0. In 7.0 include_type_name will default to 'false', and requests are expected to omit the type name in mapping definitions.\"]\r\n```\r\n\r\nWhen I switch the exact same code to `6.7.1`:\r\n\r\n```xml\r\n<dependency>\r\n    <groupId>org.elasticsearch.client</groupId>\r\n    <artifactId>elasticsearch-rest-high-level-client</artifactId>\r\n    <version>6.7.1</version>\r\n</dependency>\r\n```\r\n\r\nIt's still working well with a slightly different message though:\r\n\r\n```\r\nAVERTISSEMENT: request [PUT http://localhost:9200/foo?master_timeout=30s&include_type_name=true&timeout=30s] returned 1 warnings: [299 Elasticsearch-6.7.1-2f32220 \"the default number of shards will change from [5] to [1] in 7.0.0; if you wish to continue using the default of [5] shards, you must manage this on the create index request or with an index template\"]\r\n```\r\n\r\nBut this line is now deprecated:\r\n\r\n```java\r\nclient.indices().create(cir, RequestOptions.DEFAULT);\r\n```\r\n\r\nTo remove the compilation warning, I need to change this import:\r\n\r\n```java\r\nimport org.elasticsearch.action.admin.indices.create.CreateIndexRequest;\r\n```\r\n\r\nTo:\r\n\r\n```java\r\nimport org.elasticsearch.client.indices.CreateIndexRequest;\r\n```\r\n\r\nRunning the exact same code now fails with:\r\n\r\n```\r\nElasticsearchStatusException[Elasticsearch exception [type=illegal_argument_exception, reason=The mapping definition cannot be nested under a type [_doc] unless include_type_name is set to true.]]\r\n\tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:177)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:2053)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseResponseException(RestHighLevelClient.java:2030)\r\n\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1777)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1749)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1708)\r\n\tat org.elasticsearch.client.IndicesClient.create(IndicesClient.java:152)\r\n\tat fr.pilato.test.elasticsearch.hlclient.App.main(App.java:50)\r\n\tSuppressed: org.elasticsearch.client.ResponseException: method [PUT], host [http://localhost:9200], URI [/foo?master_timeout=30s&include_type_name=false&timeout=30s], status line [HTTP/1.1 400 Bad Request]\r\n{\"error\":{\"root_cause\":[{\"type\":\"illegal_argument_exception\",\"reason\":\"The mapping definition cannot be nested under a type [_doc] unless include_type_name is set to true.\"}],\"type\":\"illegal_argument_exception\",\"reason\":\"The mapping definition cannot be nested under a type [_doc] unless include_type_name is set to true.\"},\"status\":400}\r\n\t\tat org.elasticsearch.client.RestClient$SyncResponseListener.get(RestClient.java:936)\r\n\t\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:233)\r\n\t\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1764)\r\n\t\t... 4 more\r\n\tCaused by: org.elasticsearch.client.ResponseException: method [PUT], host [http://localhost:9200], URI [/foo?master_timeout=30s&include_type_name=false&timeout=30s], status line [HTTP/1.1 400 Bad Request]\r\n{\"error\":{\"root_cause\":[{\"type\":\"illegal_argument_exception\",\"reason\":\"The mapping definition cannot be nested under a type [_doc] unless include_type_name is set to true.\"}],\"type\":\"illegal_argument_exception\",\"reason\":\"The mapping definition cannot be nested under a type [_doc] unless include_type_name is set to true.\"},\"status\":400}\r\n\t\tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:552)\r\n\t\tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:537)\r\n\t\tat org.apache.http.concurrent.BasicFuture.completed(BasicFuture.java:119)\r\n\t\tat org.apache.http.impl.nio.client.DefaultClientExchangeHandlerImpl.responseCompleted(DefaultClientExchangeHandlerImpl.java:177)\r\n\t\tat org.apache.http.nio.protocol.HttpAsyncRequestExecutor.processResponse(HttpAsyncRequestExecutor.java:436)\r\n\t\tat org.apache.http.nio.protocol.HttpAsyncRequestExecutor.inputReady(HttpAsyncRequestExecutor.java:326)\r\n\t\tat org.apache.http.impl.nio.DefaultNHttpClientConnection.consumeInput(DefaultNHttpClientConnection.java:265)\r\n\t\tat org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:81)\r\n\t\tat org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:39)\r\n\t\tat org.apache.http.impl.nio.reactor.AbstractIODispatch.inputReady(AbstractIODispatch.java:114)\r\n\t\tat org.apache.http.impl.nio.reactor.BaseIOReactor.readable(BaseIOReactor.java:162)\r\n\t\tat org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvent(AbstractIOReactor.java:337)\r\n\t\tat org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvents(AbstractIOReactor.java:315)\r\n\t\tat org.apache.http.impl.nio.reactor.AbstractIOReactor.execute(AbstractIOReactor.java:276)\r\n\t\tat org.apache.http.impl.nio.reactor.BaseIOReactor.execute(BaseIOReactor.java:104)\r\n\t\tat org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor$Worker.run(AbstractMultiworkerIOReactor.java:588)\r\n\t\tat java.base/java.lang.Thread.run(Thread.java:844)\r\n```\r\n","closed_by":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}