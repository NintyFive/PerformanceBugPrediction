[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/469108073","html_url":"https://github.com/elastic/elasticsearch/issues/39617#issuecomment-469108073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39617","id":469108073,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2OTEwODA3Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-03-04T03:40:59Z","updated_at":"2019-03-04T03:40:59Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/473232912","html_url":"https://github.com/elastic/elasticsearch/issues/39617#issuecomment-473232912","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39617","id":473232912,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MzIzMjkxMg==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-03-15T10:21:06Z","updated_at":"2019-03-15T10:21:06Z","author_association":"MEMBER","body":"The reproduce line from the build failure does not work but if I append `-Dtests.iters=100` then I repeatedly get failures\r\n\r\n```\r\n./gradlew :server:unitTest \\\r\n  -Dtests.seed=70955D0C70684381 \\\r\n  -Dtests.class=org.elasticsearch.common.rounding.DateTimeUnitTests \\\r\n  -Dtests.method=\"testConversion\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.jvm.argline=\"-XX:-UseConcMarkSweepGC -XX:+UseG1GC\" \\\r\n  -Dtests.locale=es-UY \\\r\n  -Dtests.timezone=IET \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8 \\\r\n  -Dtests.iters=100\r\n```\r\n\r\n```\r\nExpected: is <1380360797088L>\r\n     but: was <1380357197088L>\r\n\tat __randomizedtesting.SeedInfo.seed([70955D0C70684381:769DD8365DA71C15]:0)\r\n\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n\tat org.junit.Assert.assertThat(Assert.java:956)\r\n\tat org.junit.Assert.assertThat(Assert.java:923)\r\n\tat org.elasticsearch.common.rounding.DateTimeUnitTests.testConversion(DateTimeUnitTests.java:79)\r\n```\r\n\r\nNote the difference between expected and actual is exactly 1 hour. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/479005045","html_url":"https://github.com/elastic/elasticsearch/issues/39617#issuecomment-479005045","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39617","id":479005045,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3OTAwNTA0NQ==","user":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"created_at":"2019-04-02T13:50:35Z","updated_at":"2019-04-02T13:50:35Z","author_association":"CONTRIBUTOR","body":"Observed again in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+intake/855/console\r\n\r\nI had to increase iters to 10000 to get this reproduce:\r\n\r\n```\r\nTests with failures:\r\n  - org.elasticsearch.common.rounding.DateTimeUnitTests.testConversion {seed=[9A3AD580E64E70D9:7AC01F44B5E7C498]}\r\n  - org.elasticsearch.common.rounding.DateTimeUnitTests.testConversion {seed=[9A3AD580E64E70D9:6F42C4DDF2CC87D2]}\r\n  - org.elasticsearch.common.rounding.DateTimeUnitTests.testConversion {seed=[9A3AD580E64E70D9:1B76DB3A1BE294FD]}\r\n  - org.elasticsearch.common.rounding.DateTimeUnitTests.testConversion {seed=[9A3AD580E64E70D9:16A6ADE38CA15E8F]}\r\n  - org.elasticsearch.common.rounding.DateTimeUnitTests.testConversion {seed=[9A3AD580E64E70D9:DB1203E1230DC27F]}\r\n```\r\n\r\nI will backport the mute to 7.x.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/481694432","html_url":"https://github.com/elastic/elasticsearch/issues/39617#issuecomment-481694432","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39617","id":481694432,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MTY5NDQzMg==","user":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"created_at":"2019-04-10T13:38:10Z","updated_at":"2019-04-10T13:38:10Z","author_association":"CONTRIBUTOR","body":"Backport #40738 has now been merged into 7.x","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/486266256","html_url":"https://github.com/elastic/elasticsearch/issues/39617#issuecomment-486266256","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39617","id":486266256,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4NjI2NjI1Ng==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2019-04-24T14:29:36Z","updated_at":"2019-04-24T14:30:13Z","author_association":"CONTRIBUTOR","body":"I think the test might be incorrect as it is just using getOffset. The rules of calculating the time in a different zone could be more tricky around daylight saving time changes.\r\nAs per [javadoc](https://docs.oracle.com/javase/8/docs/api/java/time/zone/ZoneRules.html#getOffset-java.time.LocalDateTime-) :)\r\n`The mapping from a local date-time to an offset is not straightforward. `\r\n I think we don't need this test - we can trust java got it right \r\n\r\nmore explanation:\r\nThe test was tricky because it was using a current date (`Instant.now()`) and it was making this harder to reproduce. This is the data it actually failed on. \r\n```\r\npublic void testConversion() {\r\n        long millis =1380403997088L;//\r\n//        millis = randomLongBetween(0, Instant.now().toEpochMilli());\r\n        DateTimeZone zone = DateTimeZone.forID(\"Pacific/Auckland\");//randomDateTimeZone();\r\n        ZoneId zoneId = zone.toTimeZone().toZoneId();\r\n\r\n        int offsetSeconds = zoneId.getRules().getOffset(Instant.ofEpochMilli(millis)).getTotalSeconds();\r\n        long parsedMillisJavaTime = ZonedDateTime.ofInstant(Instant.ofEpochMilli(millis), zoneId)\r\n\r\n            .minusSeconds(offsetSeconds).toInstant().toEpochMilli();\r\n\r\n        long parsedMillisJodaTime = zone.convertLocalToUTC(millis, false);\r\n        assertThat(parsedMillisJavaTime, is(parsedMillisJodaTime));\r\n    }\r\n```\r\n\r\nso the millis equal to \r\n2013-09-29T10:33:17.088+13:00[Pacific/Auckland] which happens to be last Sunday of september in 2013. This is the day when the daylight saving time change occurs:\r\n```\r\nThe main islands use New Zealand Standard Time (NZST), 12 hours in advance of Coordinated Universal Time (UTC)\r\n\r\nDuring summer months—from the last Sunday in September until the first Sunday in April—daylight saving time is observed and clocks are advanced one hour. New Zealand Daylight Time (NZDT) is 13 hours ahead of UTC\r\n```\r\n\r\n2013-09-29T23:33:17.088+13:00 at Pacific/Auckland should be 2013-09-28T21:33:17.088Z[UTC]. And this is what we would get from\r\n```\r\nZonedDateTime.ofInstant(Instant.ofEpochMilli(millis), zoneId).withZoneSameInstant(ZoneOffset.UTC)`\r\n```\r\n\r\n\r\nBut just subtracting 13h(the offset returned in offsetSeconds)  won’t work at this scenario\r\n     ","performed_via_github_app":null}]