{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/56016","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56016/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56016/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56016/events","html_url":"https://github.com/elastic/elasticsearch/issues/56016","id":609878312,"node_id":"MDU6SXNzdWU2MDk4NzgzMTI=","number":56016,"title":"Remove  pre-filter phase in search","user":{"login":"easyice","id":23521001,"node_id":"MDQ6VXNlcjIzNTIxMDAx","avatar_url":"https://avatars2.githubusercontent.com/u/23521001?v=4","gravatar_id":"","url":"https://api.github.com/users/easyice","html_url":"https://github.com/easyice","followers_url":"https://api.github.com/users/easyice/followers","following_url":"https://api.github.com/users/easyice/following{/other_user}","gists_url":"https://api.github.com/users/easyice/gists{/gist_id}","starred_url":"https://api.github.com/users/easyice/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/easyice/subscriptions","organizations_url":"https://api.github.com/users/easyice/orgs","repos_url":"https://api.github.com/users/easyice/repos","events_url":"https://api.github.com/users/easyice/events{/privacy}","received_events_url":"https://api.github.com/users/easyice/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-04-30T11:58:23Z","updated_at":"2020-08-31T07:43:08Z","closed_at":"2020-04-30T13:49:43Z","author_association":"NONE","active_lock_reason":null,"body":"The PR [#25658](https://github.com/elastic/elasticsearch/pull/25658) add pre-filter  in search phase,It used to skip shard if not document that is within request date range.this will send *can_match* RPC to datanode to get if can match.\r\n\r\nThe pre-filter used in *Range* query in Date field，this Feature use Lucene PointValues.getMinPackedValue、PointValues.getMaxPackedValue to compare Is there an intersection.\r\n\r\nBut,This is not necessary.because Lucene will skip any segments if the segment is OUTSIDE the query range（for any Numeric field）,this call CELL_OUTSIDE_QUERY.ref to [here](https://github.com/apache/lucene-solr/blob/branch_8_4/lucene/core/src/java/org/apache/lucene/util/bkd/BKDReader.java#L763) Lucene use segment's MinPackedValue/MaxPackedValue to get Relation,if Relation is CELL_OUTSIDE_QUERY,it will do nothing,so skip the segment \r\n\r\nTherefore, the pre-filter cannot reduce the query time.\r\n\r\nI test in my cluster: three nodes, on three physical machine,34c，196g\r\n\r\n**Index data for test**\r\n\r\nI use filebeat indices with nginx log ,the indices are below：\r\n\r\n```\r\ncurl -s \"localhost:9200/_cat/indices?pretty\"|grep filebeat\r\ngreen  open filebeat-7.4.2-2020.03.17-000068   wGACPeiCTcq5ZQZ8x-2KVA 5 1   82769921       0  100.4gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.03.06-000059   KfPPN_0rSJ6oshutjAyHDg 5 1   80906072       0  100.9gb  50.4gb\r\ngreen  open filebeat-7.4.2-2020.03.28-000076   soro-fURTLq3dFjJHdjhoA 5 1   82393361       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.25-000073   M49qQDJKRjmwSxjtfNaSUQ 5 1   84743158       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.20-000070   wvI7qHwOQBeqFeQTL8Tstw 5 1   84957634       0  100.2gb  50.1gb\r\ngreen  open filebeat-7.4.2-2020.03.31-000080   UWbFXK3xRCeUTsU78RWMQw 5 1   82266053       0  100.1gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.31-000081   epT7qYaQRCeRyW2cncWLGA 5 1   82956677       0  100.6gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.03.09-000062   p0294PCmTCCCdy67xGKRIQ 5 1   82141141       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.04.03-000085   hB36R_XhRJmtAV85g2t9rQ 5 1   84546938       0  100.8gb  50.4gb\r\ngreen  open filebeat-7.4.2-2020.03.03-000056   aK9D91ZgSDSm42x-kmb_3A 5 1   84180704       0    101gb  50.5gb\r\ngreen  open filebeat-7.4.2-2020.03.08-000061   CTGADML7Qqm0otDI_uiZMA 5 1   83529134       0  100.6gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.04.02-000084   Md7rz9ZhT6CePzEw4kRucw 5 1   84989895       0  100.9gb  50.4gb\r\ngreen  open filebeat-7.4.2-2020.04.02-000083   _g9-bVxtSVSgWJohP6GJPw 5 1   83201742       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.04.05-000087   fgaHJ_79QTilBANgN0O0lw 5 1   85151909       0  100.4gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.03.05-000058   tsupTkWkT4e-V0bW1MSQew 5 1   82591651       0  100.7gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.03.27-000075   TCpnlHpfTVS7QT-pIT0JLQ 5 1   82757462       0  100.3gb  50.1gb\r\ngreen  open filebeat-7.4.2-2020.03.22-000071   _E7BMpjHTaWhnjmIdBt_mA 5 1   84568381       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.11-000064   3o5XdU7dSaiYjk4-ul6Eow 5 1   84889940       0  100.5gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.03.13-000066   blh3f4SsRLGfC0o2DyY37Q 5 1   86548359       0  100.6gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.03.02-000055   H82hNj3CSeaPdBJYahu-kA 5 1   83627197       0  100.4gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.04.04-000086   MDHfXBKuQXWxQZE424lmaA 5 1   84946525       0  100.1gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.07-000060   ImfjAWq1T2K6mwNOZyCH4w 5 1   81787735       0    100gb    50gb\r\nyellow open filebeat-7.4.2-2020.04.07-000089   M0ziF2jLQae6528PTVE4Zg 5 1 4055505356       0    4.4tb   2.4tb\r\ngreen  open filebeat-7.4.2-2020.03.18-000069   wSKM0Y-HRe6uqv59NBAC1Q 5 1   84133931       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.29-000077   E040p77iQe2LbNgB_-r-pg 5 1   83258912       0  100.6gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.03.24-000072   b5V9qrg9TJK39JCOjzhkCg 5 1   85055904       0  100.5gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.03.30-000079   6plN3nLtSQyElDoQOhC-Vg 5 1   82709268       0  100.6gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.03.30-000078   fIAMmc7lTV2FdqMPJaixHg 5 1   82681575       0  100.3gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.04.06-000088   8AWMk0cLQiWiQiNYiu0KOg 5 1   85362231       0  100.5gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.03.26-000074   HouNhgWLT1-r17U3DahJgA 5 1   84449316       0  100.5gb  50.3gb\r\ngreen  open filebeat-7.4.2-2020.03.15-000067   aUwEt33BQG2kd4f7-V8lzA 5 1   85806838       0    101gb  50.4gb\r\ngreen  open filebeat-7.4.2-2020.03.12-000065   m2l6FqAyQCyq_Baw27aL0A 5 1   85869226       0  100.3gb  50.1gb\r\ngreen  open filebeat-7.4.2-2020.03.04-000057   sfmYBZX-SIeXDssuyI7WYQ 5 1   81905152       0  100.2gb  50.1gb\r\ngreen  open filebeat-7.4.2-2020.04.01-000082   HqFiWgXZQ1qngfSpgySHBg 5 1   83104024       0  100.4gb  50.2gb\r\ngreen  open filebeat-7.4.2-2020.03.01-000054   YKPl_f36Rh-ZDbD99DO6Nw 5 1   83255572       0    100gb    50gb\r\ngreen  open filebeat-7.4.2-2020.03.10-000063   5p9Xbhc5TaamtXly1l_RIA 5 1   81494789       0    100gb    50gb\r\n```\r\n\r\nit has 11227 segments:\r\n```\r\ncurl  -s \"localhost:9200/_cat/segments?pretty\"|grep filebeat | wc -l\r\n11227\r\n```\r\n\r\nthe doc is more than 10000：\r\n\r\n\r\n```\r\nPOST filebeat-7.4.2-*/_search?size=0\r\n{\r\n  \"query\": {\r\n    \"range\": {\r\n      \"nginx.bytes.body_sent\": {\r\n        \"gte\": 0\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\n{\r\n  \"took\" : 5491,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 180,\r\n    \"successful\" : 180,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 10000,\r\n      \"relation\" : \"gte\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  }\r\n}\r\n```\r\n\r\n**Compare query results**\r\n\r\nThe first,perform Range search in date field，this will match none,and it took 31ms\r\n\r\n```\r\nPOST filebeat-7.4.2-*/_search\r\n{\r\n  \"size\":0,\r\n  \"query\": {\r\n    \"range\": {\r\n      \"@timestamp\": {\r\n        \"gte\": \"2021-01-01\",\r\n        \"lte\":\"2022-01-01\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n{\r\n  \"took\" : 31,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 180,\r\n    \"successful\" : 180,\r\n    \"skipped\" : 179,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 0,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  }\r\n}\r\n```\r\n\r\nstep2 ,add ?pre_filter_shard_size=1000 param to skip pre-filter phase,the response took 23ms\r\n```\r\n{\r\n  \"took\" : 23,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 180,\r\n    \"successful\" : 180,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 0,\r\n      \"relation\" : \"eq\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\nstep 3，perform Range search in long field，this will match none,and it took 50ms\r\n\r\n```\r\nPOST filebeat-7.4.2-*/_search?size=0\r\n{\r\n  \"query\": {\r\n    \"range\": {\r\n      \"nginx.bytes.body_sent\": {\r\n        \"gte\": -2,\r\n        \"lte\":-1\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n{\r\n  \"took\" : 50,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 180,\r\n    \"successful\" : 180,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 0,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  }\r\n}\r\n```\r\n\r\nthe query times are similar in two request.the pre-filter has no improvement,so i think it can remove from Elasticsearch\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}