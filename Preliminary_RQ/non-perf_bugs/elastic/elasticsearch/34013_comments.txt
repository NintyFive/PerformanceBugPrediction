[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/424087400","html_url":"https://github.com/elastic/elasticsearch/issues/34013#issuecomment-424087400","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34013","id":424087400,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNDA4NzQwMA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-09-24T19:00:42Z","updated_at":"2018-09-24T19:00:42Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/424633373","html_url":"https://github.com/elastic/elasticsearch/issues/34013#issuecomment-424633373","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34013","id":424633373,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNDYzMzM3Mw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-09-26T08:37:37Z","updated_at":"2018-09-26T08:37:37Z","author_association":"CONTRIBUTOR","body":"Another test in the same docs file failed in the same way in 6.4 and I suspect the root cause is the same.\r\n\r\nThe repro command is this, although it didn't reproduce locally for me:\r\n\r\n```\r\n./gradlew :x-pack:docs:integTestRunner \\\r\n  -Dtests.seed=6668AB67F4819461 \\\r\n  -Dtests.class=org.elasticsearch.smoketest.XDocsClientYamlTestSuiteIT \\\r\n  -Dtests.method=\"test {yaml=en/rest-api/security/clear-cache/line_47}\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=th \\\r\n  -Dtests.timezone=Pacific/Galapagos\r\n```\r\n\r\nThe error in the test log is this:\r\n\r\n```\r\n   > Throwable #1: org.elasticsearch.test.rest.yaml.ClientYamlTestResponseException: org.elasticsearch.client.ResponseException: method [GET], host [http://[::1]:40403], URI [/_xpack/security/user?error_trace=true], status line [HTTP/1.1 503 Service Unavailable]\r\n   > {\"error\":{\"root_cause\":[],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[],\"stack_trace\":\"Failed to execute phase [query], all shards failed\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:293)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:133)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:254)\\n\\tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:101)\\n\\tat org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48)\\n\\tat org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:222)\\n\\tat org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:176)\\n\\tat org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48)\\n\\tat org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:222)\\n\\tat org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73)\\n\\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51)\\n\\tat org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:526)\\n\\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1068)\\n\\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1165)\\n\\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1149)\\n\\tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:66)\\n\\tat org.elasticsearch.action.search.SearchTransportService$6$1.onFailure(SearchTransportService.java:384)\\n\\tat org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:341)\\n\\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:335)\\n\\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:329)\\n\\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:1019)\\n\\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723)\\n\\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\\n\\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41)\\n\\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\\n\\tat java.base/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1135)\\n\\tat java.base/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635)\\n\\tat java.base/java.lang.Thread.run(Thread.java:844)\\n\"},\"status\":503}\r\n```\r\n\r\nThese are the log messages in the server log around the time the error occurred:\r\n\r\n```\r\n[2018-09-26T06:05:37,760][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [.security-6/-VvwEk-qQyCVyi-EtdpUTg] deleting index\r\n[2018-09-26T06:05:37,917][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [.security-6] creating index, cause [api], templates [security-index-template], shards [1]/[0], mappings [doc]\r\n[2018-09-26T06:05:37,946][DEBUG][o.e.a.s.TransportSearchAction] [node-0] All shards failed for phase: [query]\r\n[2018-09-26T06:05:37,974][INFO ][o.e.c.r.a.AllocationService] [node-0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.security-6][0]] ...]).\r\n[2018-09-26T06:05:38,094][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [.security-6/WAbCr-IhRKqL_sRxyHbn6A] deleting index\r\n[2018-09-26T06:05:38,385][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [.security-6] creating index, cause [api], templates [security-index-template], shards [1]/[0], mappings [doc]\r\n[2018-09-26T06:05:38,486][INFO ][o.e.c.r.a.AllocationService] [node-0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.security-6][0]] ...]).\r\n```\r\n\r\nThe timestamp on the error itself is 2018-09-26T06:05:38,234, so during the period between when the .security-6 was deleted and when it was recreated.  So I suspect the problem here is that the docs tests are repeatedly deleting and recreating the .security-6 index without making sure that the test code runs while the index exists.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/427046026","html_url":"https://github.com/elastic/elasticsearch/issues/34013#issuecomment-427046026","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34013","id":427046026,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNzA0NjAyNg==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2018-10-04T14:43:39Z","updated_at":"2018-10-04T14:43:39Z","author_association":"CONTRIBUTOR","body":"We believe this is caused because the tests clean out the security index after each test but don't wait for it to be recreated before the test. I've started working on cleaning up some of the other x-pack test cleanup code and eventually I'll get to security. And when I do, this issue is waiting for me.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/429884940","html_url":"https://github.com/elastic/elasticsearch/issues/34013#issuecomment-429884940","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34013","id":429884940,"node_id":"MDEyOklzc3VlQ29tbWVudDQyOTg4NDk0MA==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2018-10-15T14:51:12Z","updated_at":"2018-10-15T14:51:12Z","author_association":"CONTRIBUTOR","body":"Reproduced again https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+periodic/171/console\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :x-pack:docs:integTestRunner \\\r\n  -Dtests.seed=CA88C7EBB4D1EE93 \\\r\n  -Dtests.class=org.elasticsearch.smoketest.XDocsClientYamlTestSuiteIT \\\r\n  -Dtests.method=\"test {yaml=en/rest-api/security/clear-cache/line_39}\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ar-QA \\\r\n  -Dtests.timezone=Greenwich \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461972257","html_url":"https://github.com/elastic/elasticsearch/issues/34013#issuecomment-461972257","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34013","id":461972257,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTk3MjI1Nw==","user":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T22:42:45Z","updated_at":"2019-02-08T22:42:45Z","author_association":"CONTRIBUTOR","body":"I ran the tests for this doc page in a loop a couple hundred times and couldn't reproduce. [Here's the failures](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-1y,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'class:org.elasticsearch.smoketest.XDocsClientYamlTestSuiteIT%20AND%20test:%22test%20%7Byaml%3Den%2Frest-api%2Fsecurity%2F*%22%20AND%20stacktrace:%22all%20shards%20failed%22'),sort:!(time,desc))) for security docs pages with stack traces that look like the ones here. It seems like there were a handful of them in fall 2018 and none since then","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/464002376","html_url":"https://github.com/elastic/elasticsearch/issues/34013#issuecomment-464002376","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34013","id":464002376,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NDAwMjM3Ng==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2019-02-15T11:05:30Z","updated_at":"2019-02-15T11:05:30Z","author_association":"CONTRIBUTOR","body":"As these haven't failed since late October last year, it looks related to https://github.com/elastic/elasticsearch/issues/33864. Could it be that the failures here were also caused/affected by the watcher issue that was resolved in https://github.com/elastic/elasticsearch/pull/35271 ?\r\n\r\nI'm going to close this for now, we can reopen if any such failure re-emerges. ","performed_via_github_app":null}]