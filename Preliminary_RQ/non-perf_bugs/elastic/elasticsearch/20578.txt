{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20578","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20578/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20578/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20578/events","html_url":"https://github.com/elastic/elasticsearch/issues/20578","id":178008384,"node_id":"MDU6SXNzdWUxNzgwMDgzODQ=","number":20578,"title":"restart a node, then tomorrow, lots of shards lost","user":{"login":"xushjie1987","id":8140286,"node_id":"MDQ6VXNlcjgxNDAyODY=","avatar_url":"https://avatars0.githubusercontent.com/u/8140286?v=4","gravatar_id":"","url":"https://api.github.com/users/xushjie1987","html_url":"https://github.com/xushjie1987","followers_url":"https://api.github.com/users/xushjie1987/followers","following_url":"https://api.github.com/users/xushjie1987/following{/other_user}","gists_url":"https://api.github.com/users/xushjie1987/gists{/gist_id}","starred_url":"https://api.github.com/users/xushjie1987/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xushjie1987/subscriptions","organizations_url":"https://api.github.com/users/xushjie1987/orgs","repos_url":"https://api.github.com/users/xushjie1987/repos","events_url":"https://api.github.com/users/xushjie1987/events{/privacy}","received_events_url":"https://api.github.com/users/xushjie1987/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-09-20T09:19:19Z","updated_at":"2018-02-13T19:27:36Z","closed_at":"2017-04-29T13:00:51Z","author_association":"NONE","active_lock_reason":null,"body":"# <!--\n\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**:\n\n**Plugins installed**: [2.1.1-2.4.0]\n\n**JVM version**:1.8\n\n**OS version**:centos7\n\n**Description of the problem including expected versus actual behavior**:\n\n{\n    \"error\": {\n        \"root_cause\": [\n            {\n                \"type\": \"remote_transport_exception\",\n                \"reason\": \"[node3][10.174.9.215:9300][cluster:admin/reroute]\"\n            }\n        ],\n        \"type\": \"illegal_argument_exception\",\n        \"reason\": \"[allocate] allocation of [ai-2016.09.17][0] on node {node4}{X7AdQqLZQTSKOhhOIFGoJg}{10.45.149.165}{10.45.149.165:9300}{max_local_storage_nodes=1, master=true} is not allowed, reason: [YES(below shard recovery limit of [2])][YES(node passes include/exclude/require filters)][YES(allocation disabling is ignored)][YES(total shard limit disabled: [index: -1, cluster: -1] <= 0)][YES(primary is already active)][YES(shard not primary or relocation disabled)][YES(shard is not allocated to same node or host)][YES(no allocation awareness enabled)][YES(enough disk for shard on node, free: [334.2gb])][NO(target node version [2.1.1] is older than source node version [2.4.0])][YES(allocation disabling is ignored)]\"\n    },\n    \"status\": 400\n}\n\n**Steps to reproduce**:\n1. disable allocation\n   {\n   \"transient\": {\n       \"cluster.routing.allocation.enable\": \"none\"\n   }\n   }\n2. execute synced flush\n3. kill one node (e.g. node1)\n4. ...tomorrow...\n5. restart node1, change the elasticsearch version to 2.4.0, but configuration not changed.\n6. enable allocation\n   {\n   \"transient\": {\n       \"cluster.routing.allocation.enable\": \"none\"\n   }\n   }\n   1. then the cluster become \"red\", some indices's primary shard become UNASSIGNED\n   2. my index is created based day-time, for example: \n      ct-2016.09.20       9     p      STARTED       599284 230.3mb 10.174.9.234  node2 \n      ct-2016.09.19       0     p      STARTED       599909 231.7mb 10.174.9.224  node5 \n      ct-2016.09.19       0     r      STARTED       599909 228.2mb 10.174.9.177  node1 \n      ct-2016.09.17       8     p      STARTED       600222 229.7mb 10.174.9.177  node1 \n      ct-2016.09.17       8     r      UNASSIGNED  \n7. then i wait for a long time, lots of shards still UNASSIGNED\n   1. so i have to do cluster reroute:\n      curl -XPOST \"xxx:9200/_cluster/reroute\" -d \"{\n          \"commands\" : [ \n              {\n                  \"allocate\" : {\n                      \"index\" : \"ct-2016.09.17\",\n                      \"shard\" : 12,\n                      \"node\" : \"\",\n                      \"allow_primary\" : true\n                  }\n              }\n          ]\n      }\"\n   2. then the UNASSIGNED primary shard become STARTED, but its size become 0!!!\n      ct-2016.09.17       12    p      STARTED            0    159b 10.174.9.177  node1 \n      ct-2016.09.17       12    r      UNASSIGNED  \n      ct-2016.09.17       9     p      STARTED            0    159b 10.174.9.177  node1 \n      ct-2016.09.17       9     r      UNASSIGNED  \n      ct-2016.09.17       11    p      STARTED            0    159b 10.174.9.177  node1 \n      ct-2016.09.17       11    r      UNASSIGNED  \n   3. when i try to reroute the UNASSIGNED replica shard, i get exception: \n      {\n      \"error\": {\n      \"root_cause\": [\n          {\n              \"type\": \"remote_transport_exception\",\n              \"reason\": \"[node3][10.174.9.215:9300][cluster:admin/reroute]\"\n          }\n      ],\n      \"type\": \"illegal_argument_exception\",\n      \"reason\": \"[allocate] allocation of [ai-2016.09.17][0] on node {node4}{X7AdQqLZQTSKOhhOIFGoJg}{10.45.149.165}{10.45.149.165:9300}{max_local_storage_nodes=1, master=true} is not allowed, reason: [YES(below shard recovery limit of [2])][YES(node passes include/exclude/require filters)][YES(allocation disabling is ignored)][YES(total shard limit disabled: [index: -1, cluster: -1] <= 0)][YES(primary is already active)][YES(shard not primary or relocation disabled)][YES(shard is not allocated to same node or host)][YES(no allocation awareness enabled)][YES(enough disk for shard on node, free: [334.2gb])][NO(target node version [2.1.1] is older than source node version [2.4.0])][YES(allocation disabling is ignored)]\"\n      },\n      \"status\": 400\n      }\n   4. i tried restart today, not wait for tomorrow, there isn't any question.\n\nPS: I'm sorry, i found there's a bash script register to the crontab, it delete the old index in the night, but why couldn't i reroute the UNASSIGNED shard to or from new version elasticsearch from or old version elasticsearch?\n\n**Provide logs (if relevant)**:\n\n<!--\nIf you are filing a feature request, please remove the above bug\nreport block and provide responses for all of the below items.\n-->\n\n**Describe the feature**:\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}