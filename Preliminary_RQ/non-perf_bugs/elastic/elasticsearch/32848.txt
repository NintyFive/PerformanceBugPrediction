{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32848","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32848/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32848/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32848/events","html_url":"https://github.com/elastic/elasticsearch/issues/32848","id":350461441,"node_id":"MDU6SXNzdWUzNTA0NjE0NDE=","number":32848,"title":"[IllegalStateException] last() should not be called in this context","user":{"login":"jinhucheung","id":19590194,"node_id":"MDQ6VXNlcjE5NTkwMTk0","avatar_url":"https://avatars1.githubusercontent.com/u/19590194?v=4","gravatar_id":"","url":"https://api.github.com/users/jinhucheung","html_url":"https://github.com/jinhucheung","followers_url":"https://api.github.com/users/jinhucheung/followers","following_url":"https://api.github.com/users/jinhucheung/following{/other_user}","gists_url":"https://api.github.com/users/jinhucheung/gists{/gist_id}","starred_url":"https://api.github.com/users/jinhucheung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jinhucheung/subscriptions","organizations_url":"https://api.github.com/users/jinhucheung/orgs","repos_url":"https://api.github.com/users/jinhucheung/repos","events_url":"https://api.github.com/users/jinhucheung/events{/privacy}","received_events_url":"https://api.github.com/users/jinhucheung/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2018-08-14T14:45:54Z","updated_at":"2018-08-27T14:22:49Z","closed_at":"2018-08-27T14:22:49Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):  6.3.1\r\n\r\n**Plugins installed**:  [jcseg]\r\n\r\n**JVM version** (`java -version`): 1.8.0_172\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):  4.4.0-127-generic #153-Ubuntu \r\ndao\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nAn error `last() should not be called in this context` occurred when get the total number of hits\r\n\r\n**Steps to reproduce**:\r\n\r\nI search keyword 'layui' via [elasticsearch-rails](https://github.com/elastic/elasticsearch-rails), then get an error when getting the total count of hits\r\n\r\nruby code\r\n\r\n```ruby\r\n\r\ncodes = Code.__elasticsearch__.search(query_options)\r\ncodes = codes.records(includes: [:user, :lang, :category])\r\ncodes.total_count     #=> get an error\r\n```\r\n\r\nquery options:\r\n\r\n```json\r\n{  \r\n   \"from\":0,\r\n   \"size\":15,\r\n   \"query\":{  \r\n      \"bool\":{  \r\n         \"must\":[  \r\n            {  \r\n               \"multi_match\":{  \r\n                  \"query\":\"layui\",\r\n                  \"fields\":[  \r\n                     \"code_pieces.content^1.0\",\r\n                     \"code_pieces.title^1.0\",\r\n                     \"name_with_summary^100.0\"\r\n                  ]\r\n               }\r\n            }\r\n         ],\r\n         \"filter\": [  \r\n            {  \r\n               \"term\":{  \r\n                  \"in_square\":{  \r\n                     \"value\":true\r\n                  }\r\n               }\r\n            },\r\n            {  \r\n               \"term\":{  \r\n                  \"public\":{  \r\n                     \"value\":1\r\n                  }\r\n               }\r\n            }\r\n         ]\r\n      }\r\n   },\r\n   \"sort\":[  \r\n      {  \r\n         \"_score\":{  \r\n            \"order\":\"desc\"\r\n         }\r\n      }\r\n   ],\r\n   \"highlight\":{  \r\n      \"pre_tags\":[  \r\n         \"<em>\"\r\n      ],\r\n      \"post_tags\":[  \r\n         \"</em>\"\r\n      ],\r\n      \"fragment_size\":200,\r\n      \"number_of_fragments\":3,\r\n      \"fields\":{  \r\n         \"name_with_summary\": {},\r\n         \"code_pieces.content\": {},\r\n         \"code_pieces.title\": {}\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n\r\nindex  settings:\r\n\r\n```json\r\n{\r\n  \"code_index_production\" : {\r\n    \"aliases\" : { },\r\n    \"mappings\" : {\r\n      \"code\" : {\r\n        \"properties\" : {\r\n          \"category_id\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"code_pieces\" : {\r\n            \"properties\" : {\r\n              \"content\" : {\r\n                \"type\" : \"text\",\r\n                \"index_options\" : \"offsets\",\r\n                \"analyzer\" : \"jcseg\"\r\n              },\r\n              \"content_type\" : {\r\n                \"type\" : \"integer\"\r\n              },\r\n              \"id\" : {\r\n                \"type\" : \"integer\"\r\n              },\r\n              \"title\" : {\r\n                \"type\" : \"text\",\r\n                \"index_options\" : \"offsets\",\r\n                \"analyzer\" : \"jcseg_complex\"\r\n              }\r\n            }\r\n          },\r\n          \"created_at\" : {\r\n            \"type\" : \"date\"\r\n          },\r\n          \"enterprise_id\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"forks_count\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"id\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"in_square\" : {\r\n            \"type\" : \"boolean\"\r\n          },\r\n          \"lang_id\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"lang_name\" : {\r\n            \"type\" : \"keyword\"\r\n          },\r\n          \"name_with_summary\" : {\r\n            \"type\" : \"text\",\r\n            \"index_options\" : \"offsets\",\r\n            \"analyzer\" : \"jcseg_complex\"\r\n          },\r\n          \"notes_count\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"pieces_count\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"public\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"root_id\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"stars_count\" : {\r\n            \"type\" : \"integer\"\r\n          },\r\n          \"summary\" : {\r\n            \"type\" : \"text\",\r\n            \"index_options\" : \"offsets\",\r\n            \"analyzer\" : \"jcseg_complex\"\r\n          },\r\n          \"updated_at\" : {\r\n            \"type\" : \"date\"\r\n          },\r\n          \"user_id\" : {\r\n            \"type\" : \"integer\"\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"number_of_shards\" : \"1\",\r\n        \"provided_name\" : \"code_index_production\",\r\n        \"creation_date\" : \"1533553788519\",\r\n        \"number_of_replicas\" : \"1\",\r\n        \"uuid\" : \"3f-KmuKSTeC4MuCy14tkiw\",\r\n        \"version\" : {\r\n          \"created\" : \"6030199\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n018-08-14T18:13:49,947][DEBUG][o.e.a.s.TransportSearchAction] [elasticsearch_node_001] [code_index_production][0], node[pPuDMK87ROSebXfQOmgmuw], [P], s[STARTED], a[id=0wGOjF3OS6mXGyMKgPYi5A]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[code_index_production], indicesOptions=IndicesOptions[id=38, ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_aliases_to_multiple_indices=true, forbid_closed_indices=true, ignore_aliases=false], types=[code], routing='null', preference='null', requestCache=null, scroll=null, maxConcurrentShardRequests=5, batchedReduceSize=512, preFilterShardSize=128, allowPartialSearchResults=true, source={\"from\":0,\"size\":15,\"query\":{\"bool\":{\"must\":[{\"multi_match\":{\"query\":\"layui\",\"fields\":[\"code_pieces.content^1.0\",\"code_pieces.title^1.0\",\"name_with_summary^100.0\"],\"type\":\"best_fields\",\"operator\":\"OR\",\"slop\":0,\"prefix_length\":0,\"max_expansions\":50,\"zero_terms_query\":\"NONE\",\"auto_generate_synonyms_phrase_query\":true,\"fuzzy_transpositions\":true,\"boost\":1.0}}],\"filter\":[{\"term\":{\"in_square\":{\"value\":true,\"boost\":1.0}}},{\"term\":{\"public\":{\"value\":1,\"boost\":1.0}}}],\"adjust_pure_negative\":true,\"boost\":1.0}},\"sort\":[{\"_score\":{\"order\":\"desc\"}}],\"highlight\":{\"pre_tags\":[\"<em>\"],\"post_tags\":[\"</em>\"],\"fragment_size\":200,\"number_of_fragments\":3,\"fields\":{\"name_with_summary\":{},\"code_pieces.content\":{},\"code_pieces.title\":{}}}}}]\r\norg.elasticsearch.transport.RemoteTransportException: [elasticsearch_node_001][192.168.1.111:9300][indices:data/read/search[phase/query]]\r\nCaused by: java.lang.IllegalStateException: last() should not be called in this context\r\n\tat org.apache.lucene.search.uhighlight.BoundedBreakIteratorScanner.last(BoundedBreakIteratorScanner.java:175) ~[elasticsearch-6.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:28:05]\r\n\tat org.apache.lucene.search.uhighlight.SplittingBreakIterator.preceding(SplittingBreakIterator.java:218) ~[lucene-highlighter-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:28:05]\r\n\tat org.apache.lucene.search.uhighlight.FieldHighlighter.highlightOffsetsEnums(FieldHighlighter.java:163) ~[lucene-highlighter-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:28:05]\r\n\tat org.apache.lucene.search.uhighlight.FieldHighlighter.highlightFieldForDoc(FieldHighlighter.java:80) ~[lucene-highlighter-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:28:05]\r\n\tat org.apache.lucene.search.uhighlight.UnifiedHighlighter.highlightFieldsAsObjects(UnifiedHighlighter.java:629) ~[lucene-highlighter-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:28:05]\r\n\tat org.apache.lucene.search.uhighlight.CustomUnifiedHighlighter.highlightField(CustomUnifiedHighlighter.java:107) ~[elasticsearch-6.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:28:05]\r\n\tat org.elasticsearch.search.fetch.subphase.highlight.UnifiedHighlighter.highlight(UnifiedHighlighter.java:131) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.fetch.subphase.highlight.HighlightPhase.hitExecute(HighlightPhase.java:114) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:162) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:393) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:368) ~[elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:329) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:1019) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:725) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.1.jar:6.3.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]\r\n```\r\n\r\nthanks a lot for elasticsearch\r\n\r\nJim Cheung\r\n\r\n","closed_by":{"login":"jinhucheung","id":19590194,"node_id":"MDQ6VXNlcjE5NTkwMTk0","avatar_url":"https://avatars1.githubusercontent.com/u/19590194?v=4","gravatar_id":"","url":"https://api.github.com/users/jinhucheung","html_url":"https://github.com/jinhucheung","followers_url":"https://api.github.com/users/jinhucheung/followers","following_url":"https://api.github.com/users/jinhucheung/following{/other_user}","gists_url":"https://api.github.com/users/jinhucheung/gists{/gist_id}","starred_url":"https://api.github.com/users/jinhucheung/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jinhucheung/subscriptions","organizations_url":"https://api.github.com/users/jinhucheung/orgs","repos_url":"https://api.github.com/users/jinhucheung/repos","events_url":"https://api.github.com/users/jinhucheung/events{/privacy}","received_events_url":"https://api.github.com/users/jinhucheung/received_events","type":"User","site_admin":false},"performed_via_github_app":null}