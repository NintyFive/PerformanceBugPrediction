[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/637769168","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-637769168","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":637769168,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNzc2OTE2OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-06-02T19:49:19Z","updated_at":"2020-06-02T19:49:19Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features (:Core/Features/Data streams)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/637992886","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-637992886","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":637992886,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNzk5Mjg4Ng==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-06-03T06:45:48Z","updated_at":"2020-06-03T06:45:48Z","author_association":"MEMBER","body":"The `ActionNotFoundTransportException` is expected to be printed in the logs. After each test data streams get cleaned. If a node doesn't support data streams then that request fails with either a 405 or a 500 (action not found error). This is has been taken into account when [executing the delete data stream api.](https://github.com/elastic/elasticsearch/blob/7.x/test/framework/src/main/java/org/elasticsearch/test/rest/ESRestTestCase.java#L661)\r\n\r\nI think the reason that this test fails is that at some stage during the rolling upgrade the cluster is unable to elect a new master node returning health response:\r\n\r\n```\r\n[2020-06-02T19:24:45,332][WARN ][o.e.c.c.ClusterFormationFailureHelper] [v6.8.10-2] master not discovered yet, this node has not previously joined a bootstrapped (v7+) cluster, and [cluster.initial_master_nodes] is empty on this node: have discovered [{v6.8.10-2}{VOcLb7ZATs2T0VZfffUBEw}{FIQSWqWYRHG2-5gdHMidwA}{127.0.0.1}{127.0.0.1:41073}{dilmrt}{ml.machine_memory=101097877504, upgraded=true, xpack.installed=true, transform.node=true, testattr=test, ml.max_open_jobs=20}, {v6.8.10-0}{GB6AeCEERkOKsU3uEWcjaw}{vN-5IJqDT6uhzW4oDb4gBw}{127.0.0.1}{127.0.0.1:40145}{dilmrt}{testattr=test, ml.machine_memory=101097877504, upgraded=true, ml.max_open_jobs=20, xpack.installed=true, transform.node=true}, {v6.8.10-1}{RDhVCXM8QsenwjJI1i0fjA}{OS1dKo8NTIyPPuJaOpLXKw}{127.0.0.1}{127.0.0.1:44217}{dilmrt}{testattr=test, ml.machine_memory=101097877504, upgraded=true, ml.max_open_jobs=20, xpack.installed=true, transform.node=true}]; discovery will continue using [[::1]:43287, 127.0.0.1:40145, [::1]:40321, 127.0.0.1:44217] from hosts providers and [{v6.8.10-2}{VOcLb7ZATs2T0VZfffUBEw}{FIQSWqWYRHG2-5gdHMidwA}{127.0.0.1}{127.0.0.1:41073}{dilmrt}{ml.machine_memory=101097877504, upgraded=true, xpack.installed=true, transform.node=true, testattr=test, ml.max_open_jobs=20}] from last-known cluster state; node term 0, last-accepted version 455 in term 0\r\n```\r\n\r\n```\r\n[2020-06-02T19:24:45,421][DEBUG][o.e.a.s.m.TransportMasterNodeAction] [v6.8.10-0] timed out while retrying [cluster:monitor/health] after failure (timeout [30s])\r\n[2020-06-02T19:24:45,421][WARN ][r.suppressed             ] [v6.8.10-0] path: /_cluster/health, params: {wait_for_status=yellow, wait_for_nodes=>=3}\r\n```\r\n\r\nIt looks like the reason for this is that `internal:cluster/request_pre_vote` is unauthorized for `test_user`:\r\n\r\n```\r\n» WARN ][o.e.x.s.a.AuthorizationService] [v6.8.0-2] denying access as action [internal:cluster/request_pre_vote] is not an index or cluster action\r\n»   ↑ repeated 39 times ↑\r\n» WARN ][o.e.x.s.a.AuthorizationService] [v6.8.0-2] denying access as action [internal:discovery/request_peers] is not an index or cluster action\r\n»   ↑ repeated 232 times ↑\r\n```\r\n\r\n```\r\n[2020-06-02T19:24:44,726][DEBUG][o.e.c.c.PreVoteCollector ] [v6.8.10-1] TransportResponseHandler{PreVoteCollector{state=Tuple [v1=null, v2=PreVoteResponse{currentTerm=0, lastAcceptedTerm=0, lastAcceptedVersion=455}]}, node={v6.8.10-2}{VOcLb7ZATs2T0VZfffUBEw}{FIQSWqWYRHG2-5gdHMidwA}{127.0.0.1}{127.0.0.1:41073}{dilmrt}{testattr=test, ml.machine_memory=101097877504, upgraded=true, ml.max_open_jobs=20, xpack.installed=true, transform.node=true}} failed\r\norg.elasticsearch.transport.RemoteTransportException: [v6.8.10-2][127.0.0.1:41073][internal:cluster/request_pre_vote]\r\nCaused by: org.elasticsearch.ElasticsearchSecurityException: action [internal:cluster/request_pre_vote] is unauthorized for user [test_user]\r\n\tat org.elasticsearch.xpack.core.security.support.Exceptions.authorizationError(Exceptions.java:34) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.AuthorizationService.denialException(AuthorizationService.java:593) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.AuthorizationService.authorizeAction(AuthorizationService.java:274) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.AuthorizationService.maybeAuthorizeRunAs(AuthorizationService.java:231) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.AuthorizationService.lambda$authorize$1(AuthorizationService.java:196) ~[?:?]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.security.authz.RBACEngine.lambda$resolveAuthorizationInfo$1(RBACEngine.java:121) ~[?:?]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.security.authz.store.CompositeRolesStore.getRoles(CompositeRolesStore.java:238) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.RBACEngine.getRoles(RBACEngine.java:127) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.RBACEngine.resolveAuthorizationInfo(RBACEngine.java:115) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authz.AuthorizationService.authorize(AuthorizationService.java:198) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.transport.ServerTransportFilter$NodeProfile.lambda$inbound$1(ServerTransportFilter.java:129) ~[?:?]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$authenticateAsync$2(AuthenticationService.java:326) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$lookForExistingAuthentication$6(AuthenticationService.java:388) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lookForExistingAuthentication(AuthenticationService.java:399) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.authenticateAsync(AuthenticationService.java:323) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.access$000(AuthenticationService.java:264) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.authc.AuthenticationService.authenticate(AuthenticationService.java:176) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.transport.ServerTransportFilter$NodeProfile.inbound(ServerTransportFilter.java:120) ~[?:?]\r\n\tat org.elasticsearch.xpack.security.transport.SecurityServerTransportInterceptor$ProfileSecuredRequestHandler.messageReceived(SecurityServerTransportInterceptor.java:313) ~[?:?]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:72) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.transport.InboundHandler$RequestHandler.doRun(InboundHandler.java:263) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:695) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-7.9.0-SNAPSHOT.jar:7.9.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_241]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_241]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_241]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/637999292","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-637999292","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":637999292,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNzk5OTI5Mg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2020-06-03T07:00:25Z","updated_at":"2020-06-03T07:00:25Z","author_association":"MEMBER","body":"This is unexpected: `Caused by: org.elasticsearch.ElasticsearchSecurityException: action [internal:cluster/request_pre_vote] is unauthorized for user [test_user]\r\n`, shouldn't this be executed as system user? cc: @elastic/es-security ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638167583","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638167583","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638167583,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODE2NzU4Mw==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2020-06-03T12:33:51Z","updated_at":"2020-06-03T12:33:51Z","author_association":"CONTRIBUTOR","body":"Thanks mvg! I hadn't realized that was expected.\n\nOn Wed, Jun 3, 2020, 03:00 Martijn van Groningen <notifications@github.com>\nwrote:\n\n> This is unexpected: Caused by:\n> org.elasticsearch.ElasticsearchSecurityException: action\n> [internal:cluster/request_pre_vote] is unauthorized for user [test_user] ,\n> shouldn't this be executed as system user? cc: @elastic/es-security\n> <https://github.com/orgs/elastic/teams/es-security>\n>\n> —\n> You are receiving this because you authored the thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/elastic/elasticsearch/issues/57554#issuecomment-637999292>,\n> or unsubscribe\n> <https://github.com/notifications/unsubscribe-auth/AABUXITJ3ELCAHW5GE6GKCTRUXYJPANCNFSM4NRAZHCQ>\n> .\n>\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638350722","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638350722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638350722,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODM1MDcyMg==","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"created_at":"2020-06-03T17:43:42Z","updated_at":"2020-06-03T17:43:42Z","author_association":"CONTRIBUTOR","body":"> This is unexpected: Caused by: org.elasticsearch.ElasticsearchSecurityException: action [internal:cluster/request_pre_vote] is unauthorized for user [test_user] , shouldn't this be executed as system user?\r\n\r\nIt should, but I can't explain it. I followed the callers of `Coordinator#startElectionScheduler` and I didn't spot any circumstances that it could run under a user context.\r\nIt started failing yesterday https://gradle-enterprise.elastic.co/s/n65kap2hjrxwg/console-log?task=:x-pack:qa:rolling-upgrade:v6.8.10%23upgradedClusterTest .\r\n\r\n@elastic/es-distributed are you aware of anything that changed in the past couple of days that could interfere with master election scheduling?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638685790","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638685790","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638685790,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODY4NTc5MA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-06-04T08:12:03Z","updated_at":"2020-06-04T08:12:03Z","author_association":"CONTRIBUTOR","body":"I'm not aware of any recent changes that could have caused this, but I have a suspicion how this could have happened (it's a scenario @DaveCTurner discussed with me some days ago): During the rolling restart, one of the 6.x nodes is restarted. A 7.x node receives the disconnect event (precisely, LeaderChecker receives this event via the ConnectionListener that it has registered), and triggers election scheduling etc. that is then running under the wrong context. `ConnectionListener.onNodeDisconnected` is called through the connection's close listener, which is triggered by the underlying transport thread (e.g. Netty) when a disconnect is detected, so is a system-initiated event, where it's unclear under what context it is running (needs deeper digging).\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638722919","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638722919","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638722919,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODcyMjkxOQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-06-04T09:09:43Z","updated_at":"2020-06-04T09:09:43Z","author_association":"CONTRIBUTOR","body":"Some more digging shows that we're polluting the transport event loop threads with various thread contexts. This explains why calls that come from the event loop (such as the disconnect event) can come in under some prior thread context.\r\n\r\nWhile we need to figure out what the thread context for the `ConnectionListener`s should be (probably the ones with which they were added), we should also make sure that we do not leave transport threads with arbitrary thread contexts.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638742652","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638742652","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638742652,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODc0MjY1Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-06-04T09:45:21Z","updated_at":"2020-06-04T09:45:21Z","author_association":"CONTRIBUTOR","body":"More digging shows that the pollution is caused by #56961 as this now restores some thread context in `Netty4MessageChannelHandler.write`. /cc: @original-brownbear ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638744962","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638744962","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638744962,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODc0NDk2Mg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2020-06-04T09:49:41Z","updated_at":"2020-06-04T09:49:41Z","author_association":"MEMBER","body":"Ah nasty thanks for tracking this down @ywelsch . Should I look into a fix for this or do you know a quick-fix here?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638875462","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638875462","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638875462,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODg3NTQ2Mg==","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"created_at":"2020-06-04T14:12:43Z","updated_at":"2020-06-04T14:12:43Z","author_association":"CONTRIBUTOR","body":"Great investigation on this one @ywelsch !\r\n\r\nIIUC we should be able to assert (actually throw IllegalStateException) that the thread context on the `transport_worker` thread right before serialization is empty (i.e. system context). Similarly the thread context on various connection listener event handlers.\r\n\r\nMy reasoning is that leaking thread context between threads like this is Security's worst nightmare, although this particular case is really not that bad.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/638878822","html_url":"https://github.com/elastic/elasticsearch/issues/57554#issuecomment-638878822","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57554","id":638878822,"node_id":"MDEyOklzc3VlQ29tbWVudDYzODg3ODgyMg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-06-04T14:18:19Z","updated_at":"2020-06-04T14:18:19Z","author_association":"CONTRIBUTOR","body":"correct, I'm working on a PR that adds those kind of assertions.","performed_via_github_app":null}]