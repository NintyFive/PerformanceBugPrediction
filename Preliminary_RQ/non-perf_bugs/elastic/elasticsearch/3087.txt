{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3087","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3087/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3087/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3087/events","html_url":"https://github.com/elastic/elasticsearch/issues/3087","id":14718287,"node_id":"MDU6SXNzdWUxNDcxODI4Nw==","number":3087,"title":"update delete fields appearing several times in the document","user":{"login":"iksnalybok","id":3304227,"node_id":"MDQ6VXNlcjMzMDQyMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/3304227?v=4","gravatar_id":"","url":"https://api.github.com/users/iksnalybok","html_url":"https://github.com/iksnalybok","followers_url":"https://api.github.com/users/iksnalybok/followers","following_url":"https://api.github.com/users/iksnalybok/following{/other_user}","gists_url":"https://api.github.com/users/iksnalybok/gists{/gist_id}","starred_url":"https://api.github.com/users/iksnalybok/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iksnalybok/subscriptions","organizations_url":"https://api.github.com/users/iksnalybok/orgs","repos_url":"https://api.github.com/users/iksnalybok/repos","events_url":"https://api.github.com/users/iksnalybok/events{/privacy}","received_events_url":"https://api.github.com/users/iksnalybok/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2013-05-24T11:48:57Z","updated_at":"2013-05-24T14:07:51Z","closed_at":"2013-05-24T12:49:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Let's explain with an example.\n\nFirst create the index:\n\n``` bash\ncurl -XPUT \"http://127.0.0.1:9200/index/\" -d '\n{\n    \"settings\" : {\n        \"index\" : {\n            \"number_of_shards\" : 1,\n            \"number_of_replicas\" : 0,\n            \"analysis\" : {\n                \"analyzer\" : {\n                    \"A\" : {\n                        \"tokenizer\" : \"whitespace\",\n                        \"filter\" : [ \"asciifolding\", \"lowercase\" ]\n                    }\n                }\n            }\n        }\n    },\n    \"mappings\" : {\n        \"type\" : {\n            \"_all\"       : { \"enabled\" : \"true\", \"analyzer\": \"A\" },\n            \"_source\"    : { \"enabled\" : \"true\" },\n            \"_timestamp\" : { \"enabled\" : \"true\" },\n            \"properties\" : {\n                \"firstname\" : { \"type\" : \"string\", \"analyzer\" : \"A\" },\n                \"lastname\"  : { \"type\" : \"string\", \"analyzer\" : \"A\" }\n            }\n        }\n    }\n}'\n```\n\nThen add a document:\n\n``` bash\ncurl -XPOST \"localhost:9200/index/type/1\" -d '\n{\n    \"lastname\"  : \"Doe\"   , \"firstname\" : \"John\",\n    \"lastname\"  : \"Martin\", \"firstname\" : \"Jean\", \"firstname\" : \"Albert\",\n    \"lastname\"  : \"Smith\" , \"firstname\" : \"Adam\"\n}'\n```\n\nHere firstname and lastname are keys that appears many times.\n\nWhen searching for the document, we see all values:\n\n``` bash\ncurl -XGET \"http://127.0.0.1:9200/index/_search?pretty=true&format=yaml\" -d '{\n \"query\": { \"match_all\": {} }\n}'\n=>  _source:\n      lastname: \"Doe\"\n      firstname: \"John\"\n      lastname: \"Martin\"\n      firstname: \"Jean\"\n      firstname: \"Albert\"\n      lastname: \"Smith\"\n      firstname: \"Adam\"\n```\n\nAfter updating nothing, we see only the last values of each field:\n\n``` bash\ncurl -XPOST 'localhost:9200/index/type/1/_update' -d '{\n   \"script\" : \"\"\n}'\ncurl -XGET \"http://127.0.0.1:9200/index/_search?pretty=true&format=yaml\" -d '{\n   \"query\": { \"match_all\": {} }\n}'\n=>  _source:\n      lastname: \"Smith\"\n      firstname: \"Adam\"\n```\n\nI know that using an array works\n\n``` bash\ncurl -XPOST \"localhost:9200/index/type/1\" -d '\n{\n    \"lastname\"  : [ \"Doe\", \"Martin\", \"Smith\" ],\n    \"firstname\" : [ \"John\", \"Jean\", \"Albert\", \"Adam\" ]\n}'\n```\n\nbut then I loose the mapping between lastnames and firstnames.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}