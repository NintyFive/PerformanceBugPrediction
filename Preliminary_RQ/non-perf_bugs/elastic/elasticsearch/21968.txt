{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21968","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21968/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21968/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21968/events","html_url":"https://github.com/elastic/elasticsearch/issues/21968","id":193448517,"node_id":"MDU6SXNzdWUxOTM0NDg1MTc=","number":21968,"title":"Server crashes when doing \"histogram\" aggregation on date field with small interval","user":{"login":"yaronuliel","id":5229872,"node_id":"MDQ6VXNlcjUyMjk4NzI=","avatar_url":"https://avatars2.githubusercontent.com/u/5229872?v=4","gravatar_id":"","url":"https://api.github.com/users/yaronuliel","html_url":"https://github.com/yaronuliel","followers_url":"https://api.github.com/users/yaronuliel/followers","following_url":"https://api.github.com/users/yaronuliel/following{/other_user}","gists_url":"https://api.github.com/users/yaronuliel/gists{/gist_id}","starred_url":"https://api.github.com/users/yaronuliel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yaronuliel/subscriptions","organizations_url":"https://api.github.com/users/yaronuliel/orgs","repos_url":"https://api.github.com/users/yaronuliel/repos","events_url":"https://api.github.com/users/yaronuliel/events{/privacy}","received_events_url":"https://api.github.com/users/yaronuliel/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":166507771,"node_id":"MDU6TGFiZWwxNjY1MDc3NzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Circuit%20Breakers","name":":Core/Infra/Circuit Breakers","color":"0e8a16","default":false,"description":"Track estimates of memory consumption to prevent overload"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2016-12-05T09:31:33Z","updated_at":"2018-03-14T09:37:54Z","closed_at":"2018-03-13T13:48:21Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**:\r\n5.0.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\nVersion 8 Update 112 (build 1.8.0_112-b16)\r\n\r\n**OS version**:\r\nmacOS sierra Version 10.12.1 (16B2555)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI ran a search on an index with (only) 22 records, the search included `histogram` aggregation on a field with date mapping using the default structure that Kibana generates for histogram aggregation\r\n\r\n```\r\n\"histogram\": {\r\n    \"field\": \"birthdate\",\r\n    \"interval\": 50\r\n}\r\n```\r\n\r\nI expected it to either throw an error (using `histogram` instead of `date_histogram` on a field that was mapped as `date`) - or, return the values as I requested (if you regard this as a valid query)\r\nInstead, I didn't get any result until the server crashed\r\n\r\n\r\n**Steps to reproduce**:\r\n 1. Create index with a field that has a date mapping\r\n```\r\nPUT /someindex/\r\n{\r\n   \"mappings\": {\r\n      \"sometype\": {\r\n         \"properties\": {\r\n            \"birthdate\": {\r\n               \"type\": \"date\",\r\n               \"format\": \"dateOptionalTime\"\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n 2. Index some documents in the index (issue didn't happen with 0 or 1 records in the index)\r\n\r\n 3. Run this query\r\n```\r\nGET /sports/_search\r\n{\r\n  \"query\":{\r\n    \"match_all\": {}\r\n  },\r\n  \"size\":0,\r\n  \"aggs\": {\r\n    \"dh\": {\r\n      \"histogram\": {\r\n        \"field\": \"birthdate\",\r\n        \"interval\": 50\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n4. There is no response, and eventually the server crashes\r\n\r\n**Logs:**\r\n```\r\n[2016-12-05T11:15:17,749][INFO ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][532] overhead, spent [317ms] collecting in the last [1.2s]\r\n[2016-12-05T11:26:01,322][INFO ][o.e.c.m.MetaDataCreateIndexService] [DSSchuT] [sports] creating index, cause [api], templates [], shards [5]/[1], mappings [athlete]\r\n[2016-12-05T11:26:51,655][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1224] overhead, spent [511ms] collecting in the last [1s]\r\n[2016-12-05T11:26:52,657][INFO ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][young][1225][5] duration [747ms], collections [1]/[1s], total [747ms]/[1.6s], memory [339.6mb]->[714mb]/[1.9gb], all_pools {[young] [2mb]->[138.3mb]/[266.2mb]}{[survivor] [33.2mb]->[33.2mb]/[33.2mb]}{[old] [304.3mb]->[542.4mb]/[1.6gb]}\r\n[2016-12-05T11:26:52,657][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1225] overhead, spent [747ms] collecting in the last [1s]\r\n[2016-12-05T11:26:53,661][INFO ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][young][1226][6] duration [864ms], collections [1]/[1s], total [864ms]/[2.5s], memory [714mb]->[970.1mb]/[1.9gb], all_pools {[young] [138.3mb]->[162.9mb]/[266.2mb]}{[survivor] [33.2mb]->[33.2mb]/[33.2mb]}{[old] [542.4mb]->[773.8mb]/[1.6gb]}\r\n[2016-12-05T11:26:53,661][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1226] overhead, spent [864ms] collecting in the last [1s]\r\n[2016-12-05T11:26:55,279][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][young][1227][7] duration [1.5s], collections [1]/[1.6s], total [1.5s]/[4s], memory [970.1mb]->[1gb]/[1.9gb], all_pools {[young] [162.9mb]->[4.4mb]/[266.2mb]}{[survivor] [33.2mb]->[33.2mb]/[33.2mb]}{[old] [773.8mb]->[1gb]/[1.6gb]}\r\n[2016-12-05T11:26:55,280][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1227] overhead, spent [1.5s] collecting in the last [1.6s]\r\n[2016-12-05T11:26:56,430][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][young][1228][8] duration [1s], collections [1]/[1.1s], total [1s]/[5s], memory [1gb]->[1.3gb]/[1.9gb], all_pools {[young] [4.4mb]->[4.7mb]/[266.2mb]}{[survivor] [33.2mb]->[33.2mb]/[33.2mb]}{[old] [1gb]->[1.2gb]/[1.6gb]}\r\n[2016-12-05T11:26:56,430][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1228] overhead, spent [1s] collecting in the last [1.1s]\r\n[2016-12-05T11:26:58,003][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][young][1229][9] duration [1s], collections [1]/[1.5s], total [1s]/[6s], memory [1.3gb]->[1.5gb]/[1.9gb], all_pools {[young] [4.7mb]->[4.9mb]/[266.2mb]}{[survivor] [33.2mb]->[33.2mb]/[33.2mb]}{[old] [1.2gb]->[1.5gb]/[1.6gb]}\r\n[2016-12-05T11:26:58,004][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1229] overhead, spent [1s] collecting in the last [1.5s]\r\n[2016-12-05T11:27:02,508][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1230] overhead, spent [4.3s] collecting in the last [4.5s]\r\n[2016-12-05T11:27:06,409][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1231] overhead, spent [3.7s] collecting in the last [3.9s]\r\n[2016-12-05T11:27:11,770][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1232] overhead, spent [4.5s] collecting in the last [5.3s]\r\n[2016-12-05T11:27:15,295][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1233] overhead, spent [3.5s] collecting in the last [3.5s]\r\n[2016-12-05T11:27:51,842][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1234] overhead, spent [4.4s] collecting in the last [4.4s]\r\njava.lang.OutOfMemoryError: Java heap space\r\nDumping heap to java_pid58913.hprof ...\r\nHeap dump file created [172966857 bytes in 37.036 secs]\r\n[2016-12-05T11:29:11,594][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[DSSchuT][search][T#3]], exiting\r\njava.lang.OutOfMemoryError: Java heap space\r\n[2016-12-05T11:29:11,603][WARN ][o.e.m.j.JvmGcMonitorService] [DSSchuT] [gc][1235] overhead, spent [1.8m] collecting in the last [1.8m]\r\n[2016-12-05T11:29:11,594][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[DSSchuT][management][T#2]], exiting\r\njava.lang.OutOfMemoryError: Java heap space\r\n\tat java.util.HashMap$EntrySet.iterator(HashMap.java:1013) ~[?:1.8.0_112]\r\n\tat org.elasticsearch.common.settings.Settings.convertMapsToArrays(Settings.java:151) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.common.settings.Settings.convertMapsToArrays(Settings.java:166) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.common.settings.Settings.getAsStructuredMap(Settings.java:104) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.common.settings.Settings.toXContent(Settings.java:574) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.admin.cluster.node.info.NodesInfoResponse.toXContent(NodesInfoResponse.java:93) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.rest.action.RestActions.nodesResponse(RestActions.java:183) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.rest.action.RestActions$NodesResponseRestListener.buildResponse(RestActions.java:278) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.rest.action.RestActions$NodesResponseRestListener.buildResponse(RestActions.java:269) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.rest.action.RestBuilderListener.buildResponse(RestBuilderListener.java:38) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.rest.action.RestResponseListener.processResponse(RestResponseListener.java:37) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.rest.action.RestActionListener.onResponse(RestActionListener.java:47) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:91) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:87) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.TransportAction$ResponseFilterChain.proceed(TransportAction.java:224) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.ingest.IngestActionFilter.apply(IngestActionFilter.java:89) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.TransportAction$ResponseFilterChain.proceed(TransportAction.java:222) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.TransportAction$FilteredActionListener.onResponse(TransportAction.java:249) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.TransportAction$FilteredActionListener.onResponse(TransportAction.java:235) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction.finishHim(TransportNodesAction.java:262) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction.onOperation(TransportNodesAction.java:237) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction.access$200(TransportNodesAction.java:160) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction$1.handleResponse(TransportNodesAction.java:214) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction$1.handleResponse(TransportNodesAction.java:206) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleResponse(TransportService.java:951) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processResponse(TransportService.java:1028) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1012) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1002) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.transport.DelegatingTransportChannel.sendResponse(DelegatingTransportChannel.java:58) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry$TransportChannelWrapper.sendResponse(RequestHandlerRegistry.java:111) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$NodeTransportHandler.messageReceived(TransportNodesAction.java:270) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n\tat org.elasticsearch.action.support.nodes.TransportNodesAction$NodeTransportHandler.messageReceived(TransportNodesAction.java:266) ~[elasticsearch-5.0.2.jar:5.0.2]\r\n```\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}