{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9293","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9293/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9293/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9293/events","html_url":"https://github.com/elastic/elasticsearch/issues/9293","id":54302074,"node_id":"MDU6SXNzdWU1NDMwMjA3NA==","number":9293,"title":"Aggregations: Ability to calculate the derivative of a histogram","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2015-01-14T09:44:32Z","updated_at":"2017-01-20T02:55:59Z","closed_at":"2015-04-29T15:35:52Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Purpose\n\nComputes the derivative of all the metrics in the sub-aggregation tree. If no metric aggregations are present in the sub-aggregation tree then it will compute the derivative of the doc count. The original sub-aggregation tree is destroyed in the computation of this aggregation as is not included in the output.\n### Validation of sub-aggregation tree\n\nAccepts a single:\n- date histogram\n- histogram\n- derivative\n\nwhich contain one or more single-value numeric metric aggregation only.\n### Missing Buckets\n\nData is not always complete and gaps may exist at any point. For example, a derivative may be calculated on a daily date_histogram spanning the date 01/01/2015 to 31/01/2015, but there may not be any data points for 05/01/2015 and 10/01/2015-15/01/2015. We need to be able to deal with situation in a manner which is intuitive for the user. This means that the derivative transformer needs to be aware of the keys in the histogram buckets and the expected interval between each bucket. There are three policies we can adopt for dealing with gaps in the data. These are outlined in the sub-sections below. We should probably support all three policies and allow the user to specify which policy to use on the request.\n#### Fill gaps with zero values\n\nProbably the simplest solution to implement. When a gap is identified, buckets are artificially inserted for each missing date with a value of '0'. The derivative is then calculated taking into account these artificial buckets. We should probably add a flag to the output to indicate that these are artificial values and not derived from real values at that date.\n#### Skip calculation for gaps\n\nFilling gap with zero's is not always a good idea. For example, imagine a situation where you are calculating the derivative of the water pressure for a power plant. The pressure is supposed to be a non-zero value. Here recording a value of zero is a lot different to no value recorded; a value of zero (which would be reflected as a plummeting water pressure in the derivative) means a serious problem that probably warrants an evacuation, whereas no value would indicate something is wrong with the pressure sensor and warrants further investigation by an engineer. For this situation we would use the following policy:\n\nGap's in the input histogram are also present in the output of the derivative. This means that for the example in the above section the derivative would be calculated for the ranges only:\n- 01/01/2015-04/01/2015\n- 06/01/2015-09/01/2015\n- 16/01/2015-31/01/2015\n\nI think this should be the default policy for missing values since it assumes nothing about the way a user expects gaps to be dealt with and accurately reflects the source data instead of inserting artificial values\n#### Interpolate values for gaps\n\nSometimes a user will not want gaps on the graph and also not want zero values. This would be required if you had a system that tries to post a value every 10s but sometimes the value is dropped for some reason (a ping? or values from a UDP connection?). In this instance you want the result to look like a continuous stream even if there are gaps. \n\nThis policy would interpolate the values for any missing values. We should probably add a flag to the output to indicate that these are estimated values and not derived from real values at that date.\n### Example 1: First Derivative\n#### Goal\n\nCalculate the first derivative of the daily maximum price and the daily average price\n#### Request\n\n``` javascript\n{\n  \"aggs\": {\n    \"first_derivative\": {\n      \"derivative\": {},\n      \"aggs\": {\n        \"my_date_histo\": {\n          \"date_histogram\": {\n            \"field\": \"@timestamp\",\n            \"interval\": \"day\"\n          },\n          \"aggs\": {\n            \"avg_price\": {\n              \"avg\": {\n                \"field\": \"price\"\n              }\n            },\n            \"max_price\": {\n              \"max\": {\n                \"field\": \"price\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n#### Response\n\n``` javascript\n{\n    ...\n    \"aggregations\": {\n        \"first_derivative\": {\n            \"buckets\": [\n                {\n                    \"key\": \"2014-12-01T00:00:00.000Z\",\n                    \"from\": \"2014-12-01T00:00:00.000Z\",\n                    \"to\": \"2015-12-02T00:00:00.000Z\",\n                    \"avg_price\": {\n                        \"value\": 23.00\n                    },\n                    \"max_price\": {\n                        \"value\": 56.00\n                    }\n                },\n                {\n                    \"key\": \"2014-12-02T00:00:00.000Z\",\n                    \"from\": \"2014-12-02T00:00:00.000Z\",\n                    \"to\": \"2015-12-03T00:00:00.000Z\",\n                    \"avg_price\": {\n                        \"value\": 50.00\n                    },\n                    \"max_price\": {\n                        \"value\": 28.00\n                    }\n                },\n                {\n                    \"key\": \"2014-12-03T00:00:00.000Z\",\n                    \"from\": \"2014-12-03T00:00:00.000Z\",\n                    \"to\": \"2015-12-04T00:00:00.000Z\",\n                    \"avg_price\": {\n                        \"value\": -6.00\n                    },\n                    \"max_price\": {\n                        \"value\": -1.00\n                    }\n                },\n                ...\n            ]\n        }\n    }\n    ...\n}\n```\n### Example 2: Second Derivative\n#### Goal\n\nCalculate the second derivative of the daily maximum price and the daily average price\n#### Request\n\n``` javascript\n{\n  \"aggs\": {\n    \"second_derivative\": {\n      \"derivative\": {},\n      \"aggs\": {\n        \"first_derivative\": {\n          \"derivative\": {},\n          \"aggs\": {\n            \"my_date_histo\": {\n              \"date_histogram\": {\n                \"field\": \"@timestamp\",\n                \"interval\": \"day\"\n              },\n              \"aggs\": {\n                \"avg_price\": {\n                  \"avg\": {\n                    \"field\": \"price\"\n                  }\n                },\n                \"max_price\": {\n                  \"max\": {\n                    \"field\": \"price\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n#### Response\n\n``` javascript\n{\n    ...\n    \"aggregations\": {\n        \"second_derivative\": {\n            \"buckets\": [\n                {\n                    \"key\": \"2014-12-01T00:00:00.000Z\",\n                    \"from\": \"2014-12-01T00:00:00.000Z\",\n                    \"to\": \"2015-12-02T00:00:00.000Z\",\n                    \"avg_price\": {\n                        \"value\": 23.00\n                    },\n                    \"max_price\": {\n                        \"value\": 56.00\n                    }\n                },\n                {\n                    \"key\": \"2014-12-02T00:00:00.000Z\",\n                    \"from\": \"2014-12-02T00:00:00.000Z\",\n                    \"to\": \"2015-12-03T00:00:00.000Z\",\n                    \"avg_price\": {\n                        \"value\": 50.00\n                    },\n                    \"max_price\": {\n                        \"value\": 28.00\n                    }\n                },\n                {\n                    \"key\": \"2014-12-03T00:00:00.000Z\",\n                    \"from\": \"2014-12-03T00:00:00.000Z\",\n                    \"to\": \"2015-12-04T00:00:00.000Z\",\n                    \"avg_price\": {\n                        \"value\": -6.00\n                    },\n                    \"max_price\": {\n                        \"value\": -1.00\n                    }\n                },\n                ...\n            ]\n        }\n    }\n    ...\n}\n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}