[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/524932133","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-524932133","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":524932133,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNDkzMjEzMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-26T16:36:56Z","updated_at":"2019-08-26T16:36:56Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/524991942","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-524991942","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":524991942,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNDk5MTk0Mg==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-08-26T19:14:52Z","updated_at":"2019-08-26T19:14:52Z","author_association":"MEMBER","body":"@maihde loss of precision happens during the indexing process due to conversion from double to a specially encoded 32 bit integers. It is done by encodeLatitude and encodeLongitude methods of [GeoEncodingUtils](https://github.com/apache/lucene-solr/blob/master/lucene/core/src/java/org/apache/lucene/geo/GeoEncodingUtils.java#L55) in lucene. Most of geo_point handling in Elasticsearch is done using double. That's why you couldn't find it in elasticsearch code.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525320942","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-525320942","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":525320942,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTMyMDk0Mg==","user":{"login":"maihde","id":229922,"node_id":"MDQ6VXNlcjIyOTkyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/229922?v=4","gravatar_id":"","url":"https://api.github.com/users/maihde","html_url":"https://github.com/maihde","followers_url":"https://api.github.com/users/maihde/followers","following_url":"https://api.github.com/users/maihde/following{/other_user}","gists_url":"https://api.github.com/users/maihde/gists{/gist_id}","starred_url":"https://api.github.com/users/maihde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maihde/subscriptions","organizations_url":"https://api.github.com/users/maihde/orgs","repos_url":"https://api.github.com/users/maihde/repos","events_url":"https://api.github.com/users/maihde/events{/privacy}","received_events_url":"https://api.github.com/users/maihde/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T14:14:59Z","updated_at":"2019-08-27T14:14:59Z","author_association":"NONE","body":"@imotov thank you for investigating and providing a prompt answer.  I have confirmed that the geo_centroid values in the result are indeed quantized per the algorithm in GeoEncodingUtils.  So in that respect, the code is working as expected and I believe this ticket can be closed.\r\n\r\nOn a side-note, this quantization appears to have the undesirable effect where that a point can actually be quantized into an adjacent bucket (see three points in upper left).\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63776666-cddaa080-c8af-11e9-86a1-8b93854530c9.png)\r\n\r\nThis could perhaps be a rendering issue in the maps, which I'm still investigating.  While I find it acceptable that the geo_centroid is affected by quantization, I'm slightly concerned if there are situations where the actual point is not contained within the bounds of the bucket itself.\r\n\r\n\r\n\r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525441533","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-525441533","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":525441533,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTQ0MTUzMw==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-08-27T19:07:50Z","updated_at":"2019-08-27T19:07:50Z","author_association":"MEMBER","body":"> I'm slightly concerned if there are situations where the actual point is not contained within the bounds of the bucket itself.\r\n\r\nI am not sure I follow. Could you provide a numeric example or maybe a short script that reproduces the issue?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525778219","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-525778219","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":525778219,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTc3ODIxOQ==","user":{"login":"maihde","id":229922,"node_id":"MDQ6VXNlcjIyOTkyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/229922?v=4","gravatar_id":"","url":"https://api.github.com/users/maihde","html_url":"https://github.com/maihde","followers_url":"https://api.github.com/users/maihde/followers","following_url":"https://api.github.com/users/maihde/following{/other_user}","gists_url":"https://api.github.com/users/maihde/gists{/gist_id}","starred_url":"https://api.github.com/users/maihde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maihde/subscriptions","organizations_url":"https://api.github.com/users/maihde/orgs","repos_url":"https://api.github.com/users/maihde/repos","events_url":"https://api.github.com/users/maihde/events{/privacy}","received_events_url":"https://api.github.com/users/maihde/received_events","type":"User","site_admin":false},"created_at":"2019-08-28T14:44:51Z","updated_at":"2019-08-28T15:54:34Z","author_association":"NONE","body":"@imotov as mentioned, yesterday when I responded, I didn't yet know if this issue displayed in the Kibana map was a rendering error or an aggregation error.    As you can see in the image, there are multiple points that are plotting outside of their aggregation box.  \r\n\r\nTLDR; my investigation so far indicates this is a Kibana Map rendering issue and not a aggregation issue; but for completeness I've provided the details here.\r\n\r\nUsing this example data:\r\n\r\n```\r\n#!/usr/bin/env bash\r\n\r\ncurl -X DELETE \"localhost:9200/test\"\r\n\r\ncurl -X PUT \"localhost:9200/test\"\r\n\r\ncurl -X PUT \"localhost:9200/test/_mapping?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"properties\": {\r\n        \"location\": {\r\n            \"type\": \"geo_point\"\r\n        }\r\n    }\r\n}'\r\n\r\ncurl -X POST \"localhost:9200/test/_doc?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"location\": [-73.973052180399, 40.76183775395998]\r\n}'\r\n\r\nsleep 1\r\n\r\ncurl -X GET 'localhost:9200/test/_search?size=10' -H 'Content-Type: application/json' -d'\r\n{\r\n    \"query\": {\r\n        \"match_all\": {}\r\n    },\r\n    \"aggs\": {\r\n        \"grid\": {\r\n            \"geotile_grid\": {\r\n                \"field\": \"location\",\r\n                \"precision\": 25\r\n            },\r\n            \"aggs\": {\r\n                \"center\":  {\r\n                    \"geo_centroid\": {\r\n                        \"field\": \"location\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}'\r\n```\r\n\r\nI get a bucket with the key `25/9882427/12609789`.  From the perspective of aggregation this looks good, because the point is contained within the bounds of the box.\r\n\r\n```python\r\n>>> bnd = mercantile.bounds(9882427, 12609789, 25)\r\n>>> bnd\r\nLngLatBbox(west=-73.97306084632874, south=40.76183722175493, east=-73.97305011749268, north=40.76184534809789)\r\n>>> bnd.west <= lon <= bnd.east\r\nTrue\r\n>>> bnd.south <= lat <= bnd.north\r\nTrue\r\n```\r\n\r\nUnfortunately, when this is rendered in Kibana it looks like this:\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63865864-490b8780-c980-11e9-94fa-7cdc7dad4c46.png)\r\n\r\nThis point is clearly rendered outside of the box.  Within Kibana `convert_to_geojson.js` the bounds are calculated as such:\r\n\r\n```\r\n_geo_tile_utils.getTileBoundingBox(\"25/9882427/12609789\")\r\nbottom: 40.76184\r\nleft: -73.97306\r\nright: -73.97305\r\ntop: 40.76185\r\n```\r\n\r\nAs you can see the point's latitude of 40.76183775395998 lies outside of the bottom/top bounds returned by `getTileBoundingBox`.  This seems to be due to the fact that `getTileBoundingBox` isn't safe to call at high precision zoom levels because it rounds to five decimal points.  So the bounds of:\r\n\r\n```\r\ntop: 40.761845348097886\r\nbottom: 40.761837221754924\r\n```\r\n\r\nWhich **do** contain the point are rounded to a value that **does not** contain the point.\r\n\r\nIf it were up to me to fix, I would use the tile zoom level to select an appropriate resolutions.  For example at precision 25 there are 33554432 tiles in the North/South dimensions.  Which means that each bin is 5.364418029785156e-06 degrees high. \r\n\r\n```python\r\n# I'm using Python right now, but obviously this would be translated into\r\n# appropriate javascript for Kibana\r\nnecessary_digits = math.ceil(abs(math.log10(180.0/tileCount))) + 1\r\nrnd_digits = math.max(DECIMAL_DEGREES_PRECISION, necessary_digits)\r\n```\r\n\r\nThis would cause the rounding to use 6 digits (instead of 5) and the point would then correctly fall within the bounds of the box.\r\n\r\nIf you would like me to create a new ticket for this rendering issue let me know; otherwise we can co-opt this ticket to discuss this issue and how to resolve it.\r\n\r\nThe rendering issue gets worse if you zoom into precision 26:\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63866010-90921380-c980-11e9-92e8-2d67ee5c7110.png)\r\n\r\nZooming out to precision 24 looks like this:\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63866076-ab648800-c980-11e9-9539-44a4f167dde2.png)\r\n\r\nI don't see containment until I zoom out to level 23:\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63866128-c33c0c00-c980-11e9-961f-1b7491f53868.png)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525806901","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-525806901","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":525806901,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTgwNjkwMQ==","user":{"login":"maihde","id":229922,"node_id":"MDQ6VXNlcjIyOTkyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/229922?v=4","gravatar_id":"","url":"https://api.github.com/users/maihde","html_url":"https://github.com/maihde","followers_url":"https://api.github.com/users/maihde/followers","following_url":"https://api.github.com/users/maihde/following{/other_user}","gists_url":"https://api.github.com/users/maihde/gists{/gist_id}","starred_url":"https://api.github.com/users/maihde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maihde/subscriptions","organizations_url":"https://api.github.com/users/maihde/orgs","repos_url":"https://api.github.com/users/maihde/repos","events_url":"https://api.github.com/users/maihde/events{/privacy}","received_events_url":"https://api.github.com/users/maihde/received_events","type":"User","site_admin":false},"created_at":"2019-08-28T15:51:27Z","updated_at":"2019-08-28T15:55:02Z","author_association":"NONE","body":"With this patch:\r\n\r\n```\r\n--- a/x-pack/plugins/maps/public/shared/layers/sources/es_geo_grid_source/geo_tile_utils.js\r\n+++ b/x-pack/plugins/maps/public/shared/layers/sources/es_geo_grid_source/geo_tile_utils.js\r\n@@ -40,12 +40,16 @@ function sinh(x) {\r\n function tileToLatitude(y, tileCount) {\r\n   const radians = Math.atan(sinh(Math.PI - (2 * Math.PI * y / tileCount)));\r\n   const lat = 180 / Math.PI * radians;\r\n-  return _.round(lat, DECIMAL_DEGREES_PRECISION);\r\n+  const min_precision = Math.ceil(Math.abs(Math.log10(180 / tileCount))) + 1;\r\n+  const precision = Math.max(DECIMAL_DEGREES_PRECISION, min_precision)\r\n+  return _.round(lat, precision);\r\n }\r\n \r\n function tileToLongitude(x, tileCount) {\r\n   const lon = (x / tileCount * 360) - 180;\r\n-  return _.round(lon, DECIMAL_DEGREES_PRECISION);\r\n+  const min_precision = Math.ceil(Math.abs(Math.log10(360 / tileCount))) + 1;\r\n+  const precision = Math.max(DECIMAL_DEGREES_PRECISION, min_precision)\r\n+  return _.round(lon, precision);\r\n }\r\n```\r\nHere is what it looks like now (the point is now properly contained in the box)\r\n\r\nZoom Level 24:\r\n![image](https://user-images.githubusercontent.com/229922/63871519-0484e980-c98a-11e9-94be-bc356f51fe51.png)\r\n\r\nZoom Level 25:\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63871536-0fd81500-c98a-11e9-85dc-a5330b8074da.png)\r\n\r\nZoom Level 26:\r\n\r\n![image](https://user-images.githubusercontent.com/229922/63871572-1d8d9a80-c98a-11e9-824f-578735574089.png)\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/525848535","html_url":"https://github.com/elastic/elasticsearch/issues/45982#issuecomment-525848535","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45982","id":525848535,"node_id":"MDEyOklzc3VlQ29tbWVudDUyNTg0ODUzNQ==","user":{"login":"maihde","id":229922,"node_id":"MDQ6VXNlcjIyOTkyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/229922?v=4","gravatar_id":"","url":"https://api.github.com/users/maihde","html_url":"https://github.com/maihde","followers_url":"https://api.github.com/users/maihde/followers","following_url":"https://api.github.com/users/maihde/following{/other_user}","gists_url":"https://api.github.com/users/maihde/gists{/gist_id}","starred_url":"https://api.github.com/users/maihde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maihde/subscriptions","organizations_url":"https://api.github.com/users/maihde/orgs","repos_url":"https://api.github.com/users/maihde/repos","events_url":"https://api.github.com/users/maihde/events{/privacy}","received_events_url":"https://api.github.com/users/maihde/received_events","type":"User","site_admin":false},"created_at":"2019-08-28T17:41:55Z","updated_at":"2019-08-28T17:41:55Z","author_association":"NONE","body":"Closing and referencing  instead #46089.","performed_via_github_app":null}]