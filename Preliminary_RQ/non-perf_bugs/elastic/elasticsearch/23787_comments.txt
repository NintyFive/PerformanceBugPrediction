[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290564760","html_url":"https://github.com/elastic/elasticsearch/issues/23787#issuecomment-290564760","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23787","id":290564760,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDU2NDc2MA==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2017-03-30T22:36:02Z","updated_at":"2017-03-30T22:38:00Z","author_association":"CONTRIBUTOR","body":"I dug into this a little to learn more about how things work.\r\n\r\nLooks like nothing in the MetadataUpdateSettingsService actually verifies the contents of these analyzers. (any json metadata objects would be accepted)\r\n\r\nThere is some verification code in place [here](https://github.com/talevy/elasticsearch/blob/4f694a3312a8bf57794ac9c3613ca6b5a2b52c58/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataUpdateSettingsService.java#L281)\r\n\r\nWhen it finally reaches a point that it is prepared with a temporary IndexService for checking the metadata update, it never verifies the analyzers, like [how is verified during a true new IndexService creation](https://github.com/talevy/elasticsearch/blob/9a0b216c36e3debb9d48374ced1e58d6568429bd/core/src/main/java/org/elasticsearch/index/IndexService.java#L150)\r\n\r\nSince there AnalyzerRegistry in the updateMetadata context, I do not see a way to achieve the same as is done during index creation without more refactoring. If the IndexService kept the AnalysisRegistry that is passed-in around, then it would be as easy to bring that same verification logic into the update code. [Here](https://github.com/talevy/elasticsearch/blob/9a0b216c36e3debb9d48374ced1e58d6568429bd/core/src/main/java/org/elasticsearch/index/IndexService.java#L607) is where the indexSettings are updated and ready to be verified\r\n\r\nI may have an incomplete view into how to properly tackle this, but thought I'd leave these notes just in case it helps","performed_via_github_app":null}]