{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138/events","html_url":"https://github.com/elastic/elasticsearch/issues/22138","id":195228908,"node_id":"MDU6SXNzdWUxOTUyMjg5MDg=","number":22138,"title":"filtering a date of a child, breaks boost_mode on the parent level","user":{"login":"hrahal","id":1941264,"node_id":"MDQ6VXNlcjE5NDEyNjQ=","avatar_url":"https://avatars3.githubusercontent.com/u/1941264?v=4","gravatar_id":"","url":"https://api.github.com/users/hrahal","html_url":"https://github.com/hrahal","followers_url":"https://api.github.com/users/hrahal/followers","following_url":"https://api.github.com/users/hrahal/following{/other_user}","gists_url":"https://api.github.com/users/hrahal/gists{/gist_id}","starred_url":"https://api.github.com/users/hrahal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hrahal/subscriptions","organizations_url":"https://api.github.com/users/hrahal/orgs","repos_url":"https://api.github.com/users/hrahal/repos","events_url":"https://api.github.com/users/hrahal/events{/privacy}","received_events_url":"https://api.github.com/users/hrahal/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-12-13T11:31:51Z","updated_at":"2016-12-15T10:08:17Z","closed_at":"2016-12-15T10:08:17Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**:\r\n\r\n**OS version**:  OS X 10.11.6\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI'm dealing with a schema that relates, companies to branches to employees,\r\n\r\nso I'm using a parent -> child -> grand-child approach with the following mapping: \r\n\r\n\r\n**Steps to reproduce**:\r\n 1. insert mapping\r\n\r\n```\r\nPUT 127.0.0.1:9200/elastic_issue\r\n\r\n{\r\n\t\"mappings\": {\r\n\t\t\"company\": {\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"name\": {\r\n\t\t\t\t\t\"type\": \"keyword\"\r\n\t\t\t\t},\r\n\t\t\t\t\"company_id\": {\r\n\t\t\t\t\t\"type\": \"long\"\r\n\t\t\t\t},\r\n\t\t\t\t\"state\": {\r\n\t\t\t\t\t\"type\": \"keyword\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"branch\": {\r\n\t\t\t\"_parent\": {\r\n\t\t\t\t\"type\": \"company\"\r\n\t\t\t},\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"opening_date\": {\r\n\t\t\t\t\t\"type\": \"date\",\r\n\t\t\t\t\t\"format\": \"epoch_millis\"\r\n\t\t\t\t},\r\n                                \"opening_date_long\": {\r\n\t\t\t\t\t\"type\": \"long\"\r\n\t\t\t\t}\r\n\t\t\t\t\"name\": {\r\n\t\t\t\t\t\"type\": \"keyword\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"employee\": {\r\n\t\t\t\"_parent\": {\r\n\t\t\t\t\"type\": \"branch\"\r\n\t\t\t},\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"name\": {\r\n\t\t\t\t\t\"type\": \"keyword\"\r\n\t\t\t\t},\r\n\t\t\t\t\"salary\": {\r\n\t\t\t\t\t\"type\": \"long\"\r\n\t\t\t\t},\r\n\t\t\t\t\"bonus\": {\r\n\t\t\t\t\t\"type\": \"long\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n \r\n2. insert data for company, branch and employee\r\n\r\n```\r\n127.0.0.1:9200/elastic_issue/company/1\r\n\r\n{\r\n\t\"name\": \"blue sky\",\r\n\t\"company_id\": 1,\r\n\t\"state\": \"ON\"\r\n}\r\n\r\n127.0.0.1:9200/elastic_issue/branch/11?parent=1&routing=1\r\n\r\n{\r\n\t\"opening_date\": 1481624898000,\r\n\t\"opening_date_long\": 1481624898000,\r\n\t\"name\": \"zalka\"\r\n}\r\n\r\n127.0.0.1:9200/elastic_issue/employee/xyz?parent=11&routing=1\r\n\r\n{ \r\n\t\"name\": \"rick\",\r\n\t\"salary\": 1500,\r\n\t\"bonus\": 300\r\n}\r\n```\r\n\r\nMY requirements heavily depend on scoring on each level.\r\n\r\nwhat I'm expecting to achieve is the following: \r\n\r\nemployees that have a salary of a certain range, will take a specific weight value,\r\nsame for their bonus and the company they work for, etc..\r\n\r\nthe forumla is:\r\n\r\nscore = salary weight + bonus weight + company weight + state wight\r\n\r\n3. query\r\n\r\n```\r\n\r\n{\r\n\t\"query\": {\r\n\t\t\"function_score\": {\r\n\t\t\t\"score_mode\": \"sum\",\r\n\t\t\t\"boost_mode\": \"sum\",\r\n\t\t\t\"query\": {\r\n\t\t\t\t\"bool\": {\r\n\t\t\t\t\t\"must\": {\r\n\t\t\t\t\t\t\"has_child\": {\r\n\t\t\t\t\t\t\t\"type\": \"branch\",\r\n\t\t\t\t\t\t\t\"score_mode\": \"max\",\r\n\t\t\t\t\t\t\t\"inner_hits\": {\r\n\t\t\t\t\t\t\t    \"size\": 1\r\n\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\t\"function_score\": {\r\n\t\t\t\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\t\t\t\"bool\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\"must\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\"has_child\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"type\": \"employee\",\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"score_mode\": \"max\",\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"inner_hits\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"size\": 1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"function_score\": {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"score_mode\": \"sum\",\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"boost_mode\": \"sum\",\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\"functions\": [\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\"filter\":{\"range\":{\"salary\":{\"gte\":0,\"lt\":1000}}},\"weight\":1},\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\"filter\":{\"range\":{\"salary\":{\"gte\":1000,\"lt\":2000}}},\"weight\":2},\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\"filter\":{\"range\":{\"bonus\":{\"gte\":0,\"lt\":33}}},\"weight\":2},\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\"filter\":{\"range\":{\"bonus\":{\"gte\":33,\"lt\":66}}},\"weight\":3},\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t{\"filter\":{\"range\":{\"bonus\":{\"gte\":66,\"lt\":100}}},\"weight\":1}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t]\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t},\r\n\t\t\t\t\t\t\t\t\t\t\t\"filter\": [\r\n\t\t\t\t\t\t\t\t\t\t\t    {\r\n\t\t\t\t\t\t\t\t\t\t\t        \"range\": {\r\n\t\t\t\t\t\t\t\t\t\t\t            \"opening_date\": {\r\n\t\t\t\t\t\t\t\t\t\t\t                \"gte\": 1481624898000\r\n\t\t\t\t\t\t\t\t\t\t\t            }\r\n\t\t\t\t\t\t\t\t\t\t\t        }\r\n\t\t\t\t\t\t\t\t\t\t\t    }\r\n\t\t\t\t\t\t\t\t\t\t\t ]\r\n\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\"functions\": [\r\n\t\t\t\t{\r\n\t\t\t\t\t\"filter\": {\r\n\t\t\t\t\t\t\"terms\": {\r\n\t\t\t\t\t\t\t\"company_id\": [1]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"weight\": 2\r\n\t\t\t\t},\r\n\t\t\t\t{\r\n\t\t\t\t\t\"filter\": {\r\n\t\t\t\t\t\t\"terms\": {\r\n\t\t\t\t\t\t\t\"state\": [\"ON\"]\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"weight\": 1\r\n\t\t\t\t}\r\n\t\t\t]\r\n\t\t}\r\n\t},\r\n\t\"track_scores\": true\r\n}\r\n```\r\n\r\nat this point the employees scores are being added and passed to the parent - branch,\r\n\r\nbut when it reaches the company level the scoring breaks and the child score (branch) gets **multiplied** by the sum of the company score instead of being **summed up**\r\n\r\nthe reason behind this is the **date range filter** that is on the branch level \r\n```\r\n{\r\n\t\"filter\": [{\r\n\t\t\"range\": {\r\n\t\t\t\"opening_date\": {\r\n\t\t\t\t\"gte\": 1481624898000\r\n\t\t\t}\r\n\t\t}\r\n\t}]\r\n}\r\n```\r\n\r\nwhen mapping this attribute to **date** it breaks the parent score function.\r\n\r\nhowever if replaced by mapping **long** mapping it works all fine,\r\n\r\nso you can try:\r\n\r\n```\r\n{\r\n\t\"filter\": [{\r\n\t\t\"range\": {\r\n\t\t\t\"opening_date_long\": {\r\n\t\t\t\t\"gte\": 1481624898000\r\n\t\t\t}\r\n\t\t}\r\n\t}]\r\n}\r\n```\r\n\r\nthis works fine.\r\n\r\nfor me it seems that the date range filter is breaking the function_score \"boost_mode\": \"sum\" and forcing the child score to get **multiplied** by its parent opposed to a custom mode, \"sum\", \"avg\", etc...\r\n\r\nI tried reproducing this on another machine and it gave the same results\r\n\r\nusing the explain API I realised: \r\n\r\n```\r\n127.0.0.1:9200/elastic_issue/_search?explain=true\r\n\r\n{\r\n\t\"_shard\": \"[elastic_issue][3]\",\r\n\t\"_node\": \"5rSiUGoaRQi3agxKCMJ31g\",\r\n\t\"_index\": \"elastic_issue\",\r\n\t\"_type\": \"company\",\r\n\t\"_id\": \"1\",\r\n\t\"_score\": 9,\r\n\t\"_source\": {\r\n\t\t\"name\": \"blue sky\",\r\n\t\t\"company_id\": 1,\r\n\t\t\"state\": \"ON\"\r\n\t},\r\n\t\"_explanation\": {\r\n\t\t\"value\": 9,\r\n\t\t\"description\": \"function score, product of:\",\r\n\t\t\"details\": [{\r\n\t\t\t\"value\": 3,\r\n\t\t\t\"description\": \"A match, join value 1\",\r\n\t\t\t\"details\": []\r\n\t\t}, {\r\n\t\t\t\"value\": 3,\r\n\t\t\t\"description\": \"min of:\",\r\n\t\t\t\"details\": [{\r\n\t\t\t\t\"value\": 3,\r\n\t\t\t\t\"description\": \"function score, score mode [sum]\",\r\n\t\t\t\t\"details\": [{\r\n\t\t\t\t\t\"value\": 2,\r\n\t\t\t\t\t\"description\": \"function score, product of:\",\r\n\t\t\t\t\t\"details\": [{\r\n\t\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\t\"description\": \"match filter: company_id:[1 TO 1]\",\r\n\t\t\t\t\t\t\"details\": []\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\"value\": 2,\r\n\t\t\t\t\t\t\"description\": \"product of:\",\r\n\t\t\t\t\t\t\"details\": [{\r\n\t\t\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\t\t\"description\": \"constant score 1.0 - no function provided\",\r\n\t\t\t\t\t\t\t\"details\": []\r\n\t\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\t\"value\": 2,\r\n\t\t\t\t\t\t\t\"description\": \"weight\",\r\n\t\t\t\t\t\t\t\"details\": []\r\n\t\t\t\t\t\t}]\r\n\t\t\t\t\t}]\r\n\t\t\t\t}, {\r\n\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\"description\": \"function score, product of:\",\r\n\t\t\t\t\t\"details\": [{\r\n\t\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\t\"description\": \"match filter: state:ON\",\r\n\t\t\t\t\t\t\"details\": []\r\n\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\t\"description\": \"product of:\",\r\n\t\t\t\t\t\t\"details\": [{\r\n\t\t\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\t\t\"description\": \"constant score 1.0 - no function provided\",\r\n\t\t\t\t\t\t\t\"details\": []\r\n\t\t\t\t\t\t}, {\r\n\t\t\t\t\t\t\t\"value\": 1,\r\n\t\t\t\t\t\t\t\"description\": \"weight\",\r\n\t\t\t\t\t\t\t\"details\": []\r\n\t\t\t\t\t\t}]\r\n\t\t\t\t\t}]\r\n\t\t\t\t}]\r\n\t\t\t}, {\r\n\t\t\t\t\"value\": 3.4028235e+38,\r\n\t\t\t\t\"description\": \"maxBoost\",\r\n\t\t\t\t\"details\": []\r\n\t\t\t}]\r\n\t\t}]\r\n\t},\r\n\t\"inner_hits\": {\r\n\t\t\"branch\": {\r\n\t\t\t\"hits\": {\r\n\t\t\t\t\"total\": 1,\r\n\t\t\t\t\"max_score\": 3,\r\n\t\t\t\t\"hits\": [{\r\n\t\t\t\t\t\"_type\": \"branch\",\r\n\t\t\t\t\t\"_id\": \"11\",\r\n\t\t\t\t\t\"_score\": 3,\r\n\t\t\t\t\t\"_routing\": \"1\",\r\n\t\t\t\t\t\"_parent\": \"1\",\r\n\t\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\t\"opening_date\": 1481624898000,\r\n\t\t\t\t\t\t\"opening_date_long\": 1481624898000,\r\n\t\t\t\t\t\t\"name\": \"zalka\"\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"inner_hits\": {\r\n\t\t\t\t\t\t\"employee\": {\r\n\t\t\t\t\t\t\t\"hits\": {\r\n\t\t\t\t\t\t\t\t\"total\": 1,\r\n\t\t\t\t\t\t\t\t\"max_score\": 3,\r\n\t\t\t\t\t\t\t\t\"hits\": [{\r\n\t\t\t\t\t\t\t\t\t\"_type\": \"employee\",\r\n\t\t\t\t\t\t\t\t\t\"_id\": \"xyz\",\r\n\t\t\t\t\t\t\t\t\t\"_score\": 3,\r\n\t\t\t\t\t\t\t\t\t\"_routing\": \"1\",\r\n\t\t\t\t\t\t\t\t\t\"_parent\": \"11\",\r\n\t\t\t\t\t\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\t\t\t\t\t\"name\": \"rick\",\r\n\t\t\t\t\t\t\t\t\t\t\"salary\": 1500,\r\n\t\t\t\t\t\t\t\t\t\t\"bonus\": 300\r\n\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t}]\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}]\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```  \r\n\r\nin the _explanation: \r\n\r\nthe first description is being: \r\n\r\n\"description\": \"function score, product of:\"\r\n\r\nmeaning its a multiplication factor although I'm forcing \"boost_mode\": \"sum\"\r\n\r\nwhereas changing the filter to \"opening_date_long\" *long* instead of *date*\r\n\r\nthe first description will change to: \r\n\r\n\"description\": \"sum of\",\r\n\r\nworks fine again.\r\n\r\nnasty!\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}