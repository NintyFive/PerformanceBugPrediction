{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/60864","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60864/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60864/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60864/events","html_url":"https://github.com/elastic/elasticsearch/issues/60864","id":675492111,"node_id":"MDU6SXNzdWU2NzU0OTIxMTE=","number":60864,"title":"Bundled JDK breaks in elasticsearch:7.8.1 Docker image when using custom uid","user":{"login":"blightbow","id":1294297,"node_id":"MDQ6VXNlcjEyOTQyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1294297?v=4","gravatar_id":"","url":"https://api.github.com/users/blightbow","html_url":"https://github.com/blightbow","followers_url":"https://api.github.com/users/blightbow/followers","following_url":"https://api.github.com/users/blightbow/following{/other_user}","gists_url":"https://api.github.com/users/blightbow/gists{/gist_id}","starred_url":"https://api.github.com/users/blightbow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/blightbow/subscriptions","organizations_url":"https://api.github.com/users/blightbow/orgs","repos_url":"https://api.github.com/users/blightbow/repos","events_url":"https://api.github.com/users/blightbow/events{/privacy}","received_events_url":"https://api.github.com/users/blightbow/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"assignees":[{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2020-08-08T09:06:28Z","updated_at":"2020-11-11T22:03:18Z","closed_at":"2020-08-24T10:04:39Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n```\r\n# docker image ls elasticsearch:7.8.1\r\nREPOSITORY          TAG                 IMAGE ID            CREATED             SIZE\r\nelasticsearch       7.8.1               a529963ec236        2 weeks ago         811MB\r\n```\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nBundled JDK\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n`Linux 3.10.0-1127.13.1.el7.x86_64 #1 SMP Fri Jun 12 14:34:17 EDT 2020 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nPrevious versions of the docker image (7.5.1) were compatible with admin defined UIDs. This no longer works in image version 7.8.1 due to permissions being made more restrictive within the container. The container will die on startup due to being unable to execute the bundled JDK with the following message:\r\n\r\n`could not find java in bundled jdk at /usr/share/elasticsearch/jdk/bin/java`\r\n\r\nThis is due to the permissions of /usr/share/elasticsearch/jdk/, which do not allow traversal by users other than the default uid 1000 user. I am reporting this as a bug because 1) this used to work before, 2) it breaks existing production environments that attempt to upgrade to newer versions of the image, and 3) the change imposes a mandatory uid number on the host operating system for any programs that need to interact with volumes mounted to the container. (in particular the config and data directories)\r\n\r\nNote that the permission problems may extend past ownership of /usr/share/elasticsearch/jdk/. These were not immediately noticed as the inability to execute the bundled JDK masks any other problems.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem,\r\nincluding (e.g.) index creation, mappings, settings, query etc.  The easier\r\nyou make for us to reproduce it, the more likely that somebody will take the\r\ntime to look at it.\r\n\r\n```\r\n# docker container ls -a\r\nCONTAINER ID        IMAGE                 COMMAND                  CREATED             STATUS                      PORTS               NAMES\r\nd8df6f4626fa        elasticsearch:7.8.1   \"/tini -- /usr/local…\"   35 minutes ago      Exited (1) 34 minutes ago                       es04\r\n94a0e797302f        elasticsearch:7.8.1   \"/tini -- /usr/local…\"   35 minutes ago      Exited (1) 34 minutes ago                       es03\r\n3d6d1f310268        elasticsearch:7.8.1   \"/tini -- /usr/local…\"   35 minutes ago      Exited (1) 34 minutes ago                       es02\r\nd90c21bff7da        elasticsearch:7.8.1   \"/tini -- /usr/local…\"   35 minutes ago      Exited (1) 34 minutes ago                       es01\r\n3d388d582d4f        elasticsearch:7.8.1   \"/tini -- /usr/local…\"   35 minutes ago      Exited (1) 34 minutes ago                       client\r\nd3401f540a92        elasticsearch:7.8.1   \"/tini -- /usr/local…\"   35 minutes ago      Exited (1) 34 minutes ago                       master\r\n# docker inspect client | jq .[0].Config.User\r\n\"17805:17805\"\r\n# docker commit client esbroken\r\nsha256:d9145fd993db3ed1cd0209e0f702d067f0a278b7a98d767e672fe2bbe00a21e7\r\n# docker run -it esbroken /bin/bash\r\nbash-4.2$ id\r\nuid=17805 gid=17805 groups=17805\r\nbash-4.2$ /usr/share/elasticsearch/jdk/bin/java -version\r\nbash: /usr/share/elasticsearch/jdk/bin/java: Permission denied\r\nbash-4.2$ ls -l /usr/share/elasticsearch/jdk/bin/java\r\nls: cannot access /usr/share/elasticsearch/jdk/bin/java: Permission denied\r\nbash-4.2$ ls -l /usr/share/elasticsearch/jdk/bin/\r\nls: cannot open directory /usr/share/elasticsearch/jdk/bin/: Permission denied\r\nbash-4.2$ ls -l /usr/share/elasticsearch/jdk/\r\ntotal 16\r\ndrwxr-x---.  2 elasticsearch root 4096 Jul 21 16:42 bin\r\ndrwxr-x---.  5 elasticsearch root  123 Jul 21 16:42 conf\r\ndrwxr-x---.  3 elasticsearch root  132 Jul 21 16:42 include\r\ndrwxr-x---.  2 elasticsearch root 4096 Jul 21 16:42 jmods\r\ndrwxr-x---. 74 elasticsearch root 4096 Jul 21 16:42 legal\r\ndrwxr-x---.  1 elasticsearch root   22 Jul 21 16:42 lib\r\ndrwxr-x---.  3 elasticsearch root   18 Jul 21 16:42 man\r\n-rw-r--r--.  1 elasticsearch root 1272 Jul 21 16:42 release\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n\r\n","closed_by":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"performed_via_github_app":null}