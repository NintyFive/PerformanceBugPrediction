[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/559468999","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-559468999","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":559468999,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTQ2ODk5OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-11-28T12:07:05Z","updated_at":"2019-11-28T12:07:05Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/559481062","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-559481062","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":559481062,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTQ4MTA2Mg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-11-28T12:44:51Z","updated_at":"2019-11-28T12:44:51Z","author_association":"CONTRIBUTOR","body":"There's more information about why in the `jstack` from the test suite timeout (see https://gradle-enterprise.elastic.co/s/5i6pq2myin76e/tests/zcquf3hc3eoda-uha67ucurjrey):\r\n\r\n```\r\n\t- waiting on org.elasticsearch.common.util.concurrent.BaseFuture$Sync@2ed421c0\r\n\tat java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\r\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)\r\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)\r\n\tat java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)\r\n\tat org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:252)\r\n\tat org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:87)\r\n\tat org.elasticsearch.common.util.concurrent.FutureUtils.get(FutureUtils.java:57)\r\n\tat org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:34)\r\n\tat org.elasticsearch.xpack.ml.integration.MlNativeDataFrameAnalyticsIntegTestCase.stopAnalytics(MlNativeDataFrameAnalyticsIntegTestCase.java:118)\r\n\tat org.elasticsearch.xpack.ml.integration.RegressionIT.testStopAndRestart(RegressionIT.java:207)\r\n```\r\n\r\nSo basically a request to stop the job never returned.\r\n\r\nLogging from the client side of the test was simply:\r\n\r\n```\r\n[2019-11-28T09:40:46,337][INFO ][o.e.x.m.i.RegressionIT   ] [testStopAndRestart] before test\r\n[2019-11-28T09:40:46,338][INFO ][o.e.x.m.i.RegressionIT   ] [testStopAndRestart] [RegressionIT#testStopAndRestart]: setting up test\r\n[2019-11-28T09:40:46,340][INFO ][o.e.p.PluginsService     ] [testStopAndRestart] no modules loaded\r\n[2019-11-28T09:40:46,340][INFO ][o.e.p.PluginsService     ] [testStopAndRestart] loaded plugin [org.elasticsearch.index.reindex.ReindexPlugin]\r\n[2019-11-28T09:40:46,340][INFO ][o.e.p.PluginsService     ] [testStopAndRestart] loaded plugin [org.elasticsearch.transport.Netty4Plugin]\r\n[2019-11-28T09:40:46,340][INFO ][o.e.p.PluginsService     ] [testStopAndRestart] loaded plugin [org.elasticsearch.xpack.core.XPackClientPlugin]\r\n[2019-11-28T09:40:46,587][INFO ][o.e.t.ExternalTestCluster] [testStopAndRestart] Setup ExternalTestCluster [integTest] made of [3] nodes\r\n[2019-11-28T09:40:47,373][INFO ][o.e.x.m.i.RegressionIT   ] [testStopAndRestart] [RegressionIT#testStopAndRestart]: all set up test\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/559787104","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-559787104","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":559787104,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTc4NzEwNA==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-11-29T13:17:32Z","updated_at":"2019-11-29T13:19:51Z","author_association":"CONTRIBUTOR","body":"I have one suspicion which I still need to validate:\r\nWe do not seem to call `finishHandler.accept` if the process had a failure:\r\nhttps://github.com/elastic/elasticsearch/blob/6bcea532a0900dc65b670404ae470a4a4a0babe8/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/dataframe/process/AnalyticsProcessManager.java#L190\r\n\r\n(another issue to investigate is *why* did the process have this failure)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/559795078","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-559795078","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":559795078,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTc5NTA3OA==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-11-29T13:46:20Z","updated_at":"2019-11-29T13:46:20Z","author_association":"CONTRIBUTOR","body":"The comment above may not be relevant, as:\r\n1. we call `task.updateState(DataFrameAnalyticsState.FAILED, processContext.getFailureReason())` instead of `finishHandler.accept` which seems to be doing roughly the same thing.\r\n2. This is in the scope of \"start\" call, not \"stop\" (which is the one hanging on CI).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/561065025","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-561065025","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":561065025,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MTA2NTAyNQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-12-03T08:55:00Z","updated_at":"2019-12-03T08:55:00Z","author_association":"CONTRIBUTOR","body":"Fix is now merged in master and 7.x.\r\n\r\nLet's monitor if the fix helped using this link:\r\nhttps://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-30d,mode:quick,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:e58bf320-7efd-11e8-bf69-63c8ef516157,key:branch,negate:!t,params:(query:move-jobs,type:phrase),type:phrase,value:move-jobs),query:(match:(branch:(query:move-jobs,type:phrase))))),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'%22RegressionIT%20testStopAndRestart%22'),sort:!(time,desc))","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/561534332","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-561534332","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":561534332,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MTUzNDMzMg==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-12-04T08:35:36Z","updated_at":"2019-12-04T08:35:36Z","author_association":"CONTRIBUTOR","body":"Unfortunately, the test failed again on 7.x (the build contained the fix).\r\nRequires further investigation.\r\n\r\nhttps://build-stats.elastic.co/app/kibana#/doc/b646ed00-7efc-11e8-bf69-63c8ef516157/build-*/t?id=20191203105801-5DD051AE&_g=()","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/564055594","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-564055594","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":564055594,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NDA1NTU5NA==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2019-12-10T14:24:17Z","updated_at":"2019-12-10T14:24:17Z","author_association":"CONTRIBUTOR","body":"On the failed CI test, when the C++ process was closing, it failed with:\r\n```\r\n ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-0] [regression_stop_and_restart] Marking task failed; [regression_stop_and_restart] Error closing data frame analyzer process [null]\r\n```\r\n\r\nIt looks like it's seen fatal error, but there is no associated message.\r\n@droberts195 has an idea that such an error without a message may be a manifestation of unhandled fatal signal like SIGSEGV, SIGILL or SIGBUS\r\n\r\nI'll try to figure out if there is something common among those failed runs. So far, I discovered that this particular failure only happens on `7.x`, never on `master`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/570209946","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-570209946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":570209946,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MDIwOTk0Ng==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-01-02T13:39:56Z","updated_at":"2020-01-02T13:39:56Z","author_association":"CONTRIBUTOR","body":"There are still related CI failures (approx. 1 per day).\r\nThis time, the stack traces are:\r\n\r\n```\r\n 9731 [2019-12-30T23:42:45,599][INFO ][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-2] [regression_stop_and_restart] Closing process\r\n 9732 [2019-12-30T23:42:45,601][ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-2] [regression_stop_and_restart] Error closing data frame analyzer process\r\n 9733 java.nio.channels.ClosedChannelException: null\r\n 9734     at sun.nio.ch.FileChannelImpl.ensureOpen(FileChannelImpl.java:110) ~[?:?]\r\n 9735     at sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:199) ~[?:?]\r\n 9736     at java.nio.channels.Channels.writeFullyImpl(Channels.java:78) ~[?:1.8.0_231]\r\n 9737     at java.nio.channels.Channels.writeFully(Channels.java:101) ~[?:1.8.0_231]\r\n 9738     at java.nio.channels.Channels.access$000(Channels.java:61) ~[?:1.8.0_231]\r\n 9739     at java.nio.channels.Channels$1.write(Channels.java:174) ~[?:1.8.0_231]\r\n 9740     at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82) ~[?:1.8.0_231]\r\n 9741     at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140) ~[?:1.8.0_231]\r\n 9742     at java.io.FilterOutputStream.close(FilterOutputStream.java:158) ~[?:1.8.0_231]\r\n 9743     at org.elasticsearch.xpack.ml.process.AbstractNativeProcess.close(AbstractNativeProcess.java:166) ~[?:?]\r\n 9744     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.closeProcess(AnalyticsProcessManager.java:310) ~[?:?]\r\n 9745     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.processData(AnalyticsProcessManager.java:179) ~[?:?]\r\n 9746     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.lambda$runJob$1(AnalyticsProcessManager.java:120) ~[?:?]\r\n 9747     at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:633) [elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]\r\n 9748     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_231]\r\n 9749     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_231]\r\n 9750     at java.lang.Thread.run(Thread.java:748) [?:1.8.0_231]\r\n 97\r\n```\r\n\r\non Dec 31\r\n\r\nand:\r\n\r\n```\r\n11536 [2020-01-01T01:36:43,243][ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-1] [regression_stop_and_restart] Error closing data frame analyzer process^M\r\n11537 java.io.IOException: Stream Closed^M\r\n11538     at java.io.FileOutputStream.writeBytes(Native Method) ~[?:1.8.0_221]^M\r\n11539     at java.io.FileOutputStream.write(FileOutputStream.java:326) ~[?:1.8.0_221]^M\r\n11540     at java.io.BufferedOutputStream.flushBuffer(BufferedOutputStream.java:82) ~[?:1.8.0_221]^M\r\n11541     at java.io.BufferedOutputStream.flush(BufferedOutputStream.java:140) ~[?:1.8.0_221]^M\r\n11542     at java.io.FilterOutputStream.close(FilterOutputStream.java:158) ~[?:1.8.0_221]^M\r\n11543     at org.elasticsearch.xpack.ml.process.AbstractNativeProcess.close(AbstractNativeProcess.java:166) ~[?:?]^M\r\n11544     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.closeProcess(AnalyticsProcessManager.java:310) ~[?:?]^M\r\n11545     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.processData(AnalyticsProcessManager.java:179) ~[?:?]^M\r\n11546     at org.elasticsearch.xpack.ml.dataframe.process.AnalyticsProcessManager.lambda$runJob$1(AnalyticsProcessManager.java:120) ~[?:?]^M\r\n11547     at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:633) [elasticsearch-7.6.0-SNAPSHOT.jar:7.6.0-SNAPSHOT]^M\r\n11548     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_221]^M\r\n11549     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_221]^M\r\n11550     at java.lang.Thread.run(Thread.java:748) [?:1.8.0_221]^M\r\n11551 [2020-01-01T01:36:43,244][ERROR][o.e.x.m.d.p.AnalyticsProcessManager] [integTest-1] [regression_stop_and_restart] Marking task failed; [regression_stop_and_restart] Error closing data frame analy      zer process [Stream Closed]^M\r\n```\r\n\r\non Jan 1\r\n\r\nIt seems to me that there is a race between `close()` and `kill()` methods both trying to close the stream. The first one may succeed but the other one fails.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/570252089","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-570252089","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":570252089,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MDI1MjA4OQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-01-02T16:02:11Z","updated_at":"2020-01-02T16:08:47Z","author_association":"CONTRIBUTOR","body":"I've found this issue: https://bugs.openjdk.java.net/browse/JDK-8054565\r\n\r\nIt explains that in Java 8 `FilterOutputStream::close` method may not obey the contract of `Closeable` i.e. the second call to `close()` may throw the exception.\r\nThe issue is fixed in Java 9.\r\nThis issue describes the conditions that our tests suffers from perfectly (fails only in 7.x branch and only in 'compatibility' CI runs) but let me confirm that by looking at the `FilterOutputStream` implementation.\r\nI'll post the investigation result here.\r\nAnother question is how does it work for anomaly detection and why it does not suffer from similar problem - to be investigated.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/570260886","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-570260886","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":570260886,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MDI2MDg4Ng==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-01-02T16:30:27Z","updated_at":"2020-01-02T16:30:27Z","author_association":"CONTRIBUTOR","body":"Looking at Java 8 source code it is clearly visible that the bug fix is not there (no additional `closed` and `closeLock` member variables in `FilterOutputStream` class):\r\nhttps://hg.openjdk.java.net/jdk8/jdk8/jdk/file/687fd7c7986d/src/share/classes/java/io/FilterOutputStream.java\r\n\r\nAdditionally, the java home setting in the failing build is Java 8:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+multijob-windows-compatibility/os=windows-2012-r2/348/injectedEnvVars/\r\n\r\nThe combination of these two factors lets me conclude that the failed CI test run is indeed a result of the JDK issue mentioned in the previous post.\r\n\r\nOne way to fix it would be to add `closeLock` equivalent to `AbstractNativeProcess` class or some other means of synchronisation protecting against calling `close()` twice.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/571940551","html_url":"https://github.com/elastic/elasticsearch/issues/49680#issuecomment-571940551","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49680","id":571940551,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MTk0MDU1MQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-01-08T08:22:00Z","updated_at":"2020-01-08T08:22:00Z","author_association":"CONTRIBUTOR","body":"A number of fixes were applied and the last CI failure of this test was a week ago.\r\nhttps://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-30d,mode:quick,to:now))&_a=(columns:!(_source),filters:!(('$state':(store:appState),meta:(alias:!n,disabled:!f,index:e58bf320-7efd-11e8-bf69-63c8ef516157,key:branch,negate:!t,params:(query:move-jobs,type:phrase),type:phrase,value:move-jobs),query:(match:(branch:(query:move-jobs,type:phrase))))),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'%22RegressionIT%20testStopAndRestart%22'),sort:!(time,desc))\r\n\r\nClosing this issue for now.","performed_via_github_app":null}]