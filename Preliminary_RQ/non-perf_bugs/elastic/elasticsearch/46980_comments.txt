[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534180897","html_url":"https://github.com/elastic/elasticsearch/issues/46980#issuecomment-534180897","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46980","id":534180897,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDE4MDg5Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-09-23T16:37:20Z","updated_at":"2019-09-23T16:37:20Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534184439","html_url":"https://github.com/elastic/elasticsearch/issues/46980#issuecomment-534184439","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46980","id":534184439,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDE4NDQzOQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2019-09-23T16:46:23Z","updated_at":"2019-09-23T16:46:23Z","author_association":"CONTRIBUTOR","body":"I did some evaluations using [vector microbenchmarks](https://github.com/jtibshirani/elasticsearch/pull/3) using bfloat16 and the performance seems to be the same as the current one (no degradation here).  While we expect the index size should be twice less.\r\n\r\n```\r\n101 dims:\r\n\r\nBenchmark                                      Mode  Cnt     Score     Error  Units\r\nVectorFunctionBenchmark.decode                 avgt   30   130.149 ±   2.135  ns/op\r\nVectorFunctionBenchmark.decodeWithByteBuffer   avgt   30    91.631 ±   2.550  ns/op\r\nVectorFunctionBenchmark.decode2                avgt   30    89.729 ±   1.483  ns/op\r\nVectorFunctionBenchmark.decodeAndDotProduct    avgt   30   116.309 ±   2.941  ns/op\r\nVectorFunctionBenchmark.decodeAndDotProduct2   avgt   30   110.884 ±   2.892  ns/op\r\nVectorFunctionBenchmark.decodeThenDotProduct   avgt   30   202.915 ±   8.571  ns/op\r\nVectorFunctionBenchmark.decodeThenDotProduct2  avgt   30   217.538 ±   8.137  ns/op\r\n---\r\n512 dims\r\n\r\nBenchmark                                      Mode  Cnt     Score      Error  Units\r\nVectorFunctionBenchmark.decode                 avgt   30   655.794 ±    5.692  ns/op\r\nVectorFunctionBenchmark.decodeWithByteBuffer   avgt   30   466.574 ±   11.378  ns/op\r\nVectorFunctionBenchmark.decode2                avgt   30   486.196 ±    2.956  ns/op\r\nVectorFunctionBenchmark.decodeAndDotProduct    avgt   30   577.492 ±    4.647  ns/op\r\nVectorFunctionBenchmark.decodeAndDotProduct2   avgt   30   576.239 ±    6.285  ns/op\r\nVectorFunctionBenchmark.decodeThenDotProduct   avgt   30  1094.865 ±   82.736  ns/op\r\nVectorFunctionBenchmark.decodeThenDotProduct2  avgt   30  1036.428 ±    9.929  ns/op\r\n---\r\n1024 dims\r\n\r\nBenchmark                                      Mode  Cnt      Score      Error  Units\r\nVectorFunctionBenchmark.decode                 avgt   30   1332.739 ±   70.256  ns/op\r\nVectorFunctionBenchmark.decodeWithByteBuffer   avgt   30   1377.953 ±   42.123  ns/op\r\nVectorFunctionBenchmark.decode2                avgt   30    977.151 ±   94.401  ns/op\r\nVectorFunctionBenchmark.decodeAndDotProduct    avgt   30   1191.034 ±   63.363  ns/op\r\nVectorFunctionBenchmark.decodeAndDotProduct2   avgt   30   1126.698 ±   12.526  ns/op\r\nVectorFunctionBenchmark.decodeThenDotProduct   avgt   30   2434.391 ±   32.408  ns/op\r\nVectorFunctionBenchmark.decodeThenDotProduct2  avgt   30   2109.840 ±   42.336  ns/op\r\n```\r\n\r\nA vector is encoded in the following way:\r\n```java\r\n    public static BytesRef encode2(float[] values) {\r\n        final short SHORT_BYTES = VectorFunctions.INT_BYTES/2;\r\n        byte[] buf = new byte[SHORT_BYTES * values.length];\r\n        int offset = 0;\r\n        int intValue;\r\n        for (float value: values) {\r\n            intValue = Float.floatToIntBits(value);\r\n            buf[offset++] = (byte) (intValue >> 24);\r\n            buf[offset++] = (byte) (intValue >> 16);\r\n        }\r\n        return new BytesRef(buf, 0, offset);\r\n    }\r\n```\r\nand decoded in this way:\r\n```java\r\n    static float[] decode2(BytesRef vectorBR) {\r\n        if (vectorBR == null) {\r\n            throw new IllegalArgumentException(\"A document doesn't have a value for a vector field!\");\r\n        }\r\n        int dimCount = vectorBR.length / (INT_BYTES / 2);\r\n        float[] vector = new float[dimCount];\r\n        int offset = vectorBR.offset;\r\n        for (int dim = 0; dim < dimCount; dim++) {\r\n            int intValue = ((vectorBR.bytes[offset++] & 0xFF) << 24) | ((vectorBR.bytes[offset++] & 0xFF) << 16);\r\n            vector[dim] = Float.intBitsToFloat(intValue);\r\n        }\r\n        return vector;\r\n    }\r\n```\r\n\r\n`decodeAndDotProduct2`   and `decodeThenDotProduct2` work like their corresponding `decodeAndDotProduct`   and `decodeThenDotProduct`, but use for a vector decoding instructions in `decode2`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534297109","html_url":"https://github.com/elastic/elasticsearch/issues/46980#issuecomment-534297109","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46980","id":534297109,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDI5NzEwOQ==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2019-09-23T21:42:56Z","updated_at":"2019-09-23T21:42:56Z","author_association":"MEMBER","body":"@mayya-sharipova this seems like a really interesting exploration! It would be nice to push the change to my `vector-benchmarks` branch (perhaps with the methods renamed to `decodeBFloat16` / `encodeBFloat16`) to have everything in one place. Also, we could add a check to `VectorFunctionBenchmark#testVectorFunctions` to ensure the encoding/ decoding works as expected.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592802356","html_url":"https://github.com/elastic/elasticsearch/issues/46980#issuecomment-592802356","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46980","id":592802356,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjgwMjM1Ng==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2020-02-29T01:21:01Z","updated_at":"2020-02-29T01:21:01Z","author_association":"MEMBER","body":"@mayya-sharipova maybe we could close this out for now (and the PR https://github.com/elastic/elasticsearch/pull/47058) since we decided not to switch to bfloat16 in the near future?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/593447013","html_url":"https://github.com/elastic/elasticsearch/issues/46980#issuecomment-593447013","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46980","id":593447013,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MzQ0NzAxMw==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2020-03-02T15:05:31Z","updated_at":"2020-03-02T15:05:31Z","author_association":"CONTRIBUTOR","body":"@jtibshirani Thanks, closing this.","performed_via_github_app":null}]