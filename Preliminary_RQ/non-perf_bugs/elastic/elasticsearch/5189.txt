{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5189","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5189/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5189/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5189/events","html_url":"https://github.com/elastic/elasticsearch/issues/5189","id":27938741,"node_id":"MDU6SXNzdWUyNzkzODc0MQ==","number":5189,"title":"Leaking file handles?","user":{"login":"consulthys","id":1280019,"node_id":"MDQ6VXNlcjEyODAwMTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1280019?v=4","gravatar_id":"","url":"https://api.github.com/users/consulthys","html_url":"https://github.com/consulthys","followers_url":"https://api.github.com/users/consulthys/followers","following_url":"https://api.github.com/users/consulthys/following{/other_user}","gists_url":"https://api.github.com/users/consulthys/gists{/gist_id}","starred_url":"https://api.github.com/users/consulthys/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/consulthys/subscriptions","organizations_url":"https://api.github.com/users/consulthys/orgs","repos_url":"https://api.github.com/users/consulthys/repos","events_url":"https://api.github.com/users/consulthys/events{/privacy}","received_events_url":"https://api.github.com/users/consulthys/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":34,"created_at":"2014-02-20T05:42:06Z","updated_at":"2014-04-18T11:45:12Z","closed_at":"2014-03-25T08:13:32Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I know this issue has been raised a couple times in the past, but none of them has provided me a solution so far. I've also seen similar issues being raised in forums.\n\nWe're running ES 0.90.7 on a two-node EC2 cluster with the following settings:\n- Total RAM 17GB\n- ES_HEAP_SIZE 9GB\n- open files (ulimit -n) 65535\n\nWe have five different indexes (13GB, 7GB, 4GB, 22MB, 4MB), we are running about 150K indexing operations per day (mostly new docs, but also some updates). Depending on days, we're running between 60K and 120K search operations.\n\nHere is a recurrent pattern that has been consistently happening over the past couple months and which requires us to restart the cluster every 3/4 days or so.\nThe graphics below show the evolution of the heap size, the process CPU and the open file handles from one restart (~12PM on Feb 15th) to the next one (~8PM on Feb 19th). Initially, everything runs smoothly. Node 2 was the master in that run and was the one processing the ActiveMQ river. \n\nThen on Feb 18th around 12PM (orange vertical bar), something starts happening. At that time, the same things keep happening on the master node:\n- the process CPU starts increasing and stays high\n- the file handles count keeps increasing (but more steeply)\n- The GC doesn't seem to be able to release memory\n\n![capture decran 2014-02-20 a 05 26 24](https://f.cloud.github.com/assets/1280019/2215402/70a7e0ba-99f0-11e3-8756-05c31daa3561.png)\n\nEverything keeps running more or less smoothly for a day or so up until the file handles are exhausted. Just before they do, we restart the problematic node (green vertical bar), the second node becomes the master and the same pattern repeats with that node.\n\nAnother thing worth noting is that about 90% of the open file handles are marked (deleted) and belong 99% to the biggest index, i.e. the one that is 13GB.\n\nWe're going to upgrade to 0.90.11 anytime soon to see if Lucene 4.6.1 will be of any help, but in the meantime, we'd appreciate any kind of insights as to why this kind of things is happening.\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}