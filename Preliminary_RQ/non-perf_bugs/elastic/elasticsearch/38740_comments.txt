[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462389923","html_url":"https://github.com/elastic/elasticsearch/issues/38740#issuecomment-462389923","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38740","id":462389923,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjM4OTkyMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-11T16:19:22Z","updated_at":"2019-02-11T16:19:22Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462586951","html_url":"https://github.com/elastic/elasticsearch/issues/38740#issuecomment-462586951","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38740","id":462586951,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjU4Njk1MQ==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T02:24:15Z","updated_at":"2019-02-12T02:24:15Z","author_association":"CONTRIBUTOR","body":"I can't reproduce this using the standard snapshots. I suspect it is something to do with the builds that  Kibana is running (there may still be a real bug, it's just that your listed reproduction steps aren't enough to trigger it).\r\n\r\nI don't understand where this index name comes from: `.reindexed-v7-security-6`\r\nThat's not the name of the default security index, and I'm not aware of anything that creates that index. Do you know why your CI has it?\r\n\r\nThe security code uses `doc` for its type. If your `.security` index has `_doc`, then something strange has happened.\r\n\r\nMy steps were\r\n\r\n1. downloaded the latest snapshots of 7.0.0-beta1 and 8.0.0-SNAPSHOT _(details below)_\r\n2. Set the 7.0.0 config to\r\n   ```\r\n   node.name: node1\r\n   cluster.name: es7-8-test\r\n   xpack.license.self_generated.type: trial\r\n   xpack.security.enabled: true\r\n   xpack.watcher.enabled: false\r\n   xpack.monitoring.enabled: false\r\n   ```\r\n3. set the bootstrap password for 7.0.0\r\n4. started ES 7.0.0\r\n5. Created a user\r\n   ```\r\n   PUT /_security/user/foo\r\n   {\r\n     \"password\": \"magic123\", \"roles\": []\r\n   }\r\n   ```\r\n6. Shutdown that node\r\n7. Copied the 7.0.0 config and the data directory to the 8.0.0 directory\r\n8. Set the bootstrap password for 8.0.0\r\n9. Started 8.0.0\r\n10. Change the user's password\r\n   ```\r\n   PUT /_security/user/foo/_password\r\n   {\r\n     \"password\": \"hunter\"\r\n   }\r\n   ```\r\n\r\n**ES 7.0.0 build details**\r\n- `commit` https://github.com/elastic/elasticsearch/commits/9fae0a4\r\n- `build_id` 7.0.0-beta1-715764f6\r\n- `build start_time` Mon, 11 Feb 2019 18:08:19 GMT\r\n- `package` elasticsearch-7.0.0-beta1-darwin-x86_64.tar.gz\r\n\r\n**ES 8.0.0 build details**\r\n- `commit` https://github.com/elastic/elasticsearch/commits/4e9b1cf\r\n- `build_id` 8.0.0-fcd45d56\r\n- `build start_time` \"Sat, 9 Feb 2019 07:39:22 GMT\r\n- `package` elasticsearch-8.0.0-SNAPSHOT-darwin-x86_64.tar.gz\r\n\r\n\r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462892063","html_url":"https://github.com/elastic/elasticsearch/issues/38740#issuecomment-462892063","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38740","id":462892063,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2Mjg5MjA2Mw==","user":{"login":"joshdover","id":1813008,"node_id":"MDQ6VXNlcjE4MTMwMDg=","avatar_url":"https://avatars2.githubusercontent.com/u/1813008?v=4","gravatar_id":"","url":"https://api.github.com/users/joshdover","html_url":"https://github.com/joshdover","followers_url":"https://api.github.com/users/joshdover/followers","following_url":"https://api.github.com/users/joshdover/following{/other_user}","gists_url":"https://api.github.com/users/joshdover/gists{/gist_id}","starred_url":"https://api.github.com/users/joshdover/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshdover/subscriptions","organizations_url":"https://api.github.com/users/joshdover/orgs","repos_url":"https://api.github.com/users/joshdover/repos","events_url":"https://api.github.com/users/joshdover/events{/privacy}","received_events_url":"https://api.github.com/users/joshdover/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T19:07:58Z","updated_at":"2019-02-12T19:07:58Z","author_association":"MEMBER","body":"Great, this is helpful. I think I have found the issue.\r\n\r\n> The security code uses `doc` for its type. If your `.security` index has `_doc`, then something strange has happened.\r\n\r\nThe mapping with type `_doc` gets created when using the Upgrade Assistant in 8.0 to reindex 7.x indices in preparation for 9.0. Because the Upgrade Assistant uses the typeless API in 7.0+ (which I believe is the only way to create new indices), I'm guessing Elasticsearch creates a mapping with `_doc` under the hood. Seems to me the internal mappings for `.security` need to be updated to use `_doc` or no type at all.\r\n\r\nThe only change needed in your steps to reproduce the issue would be between steps (9) and (10). Before Step 10:\r\n- Startup Kibana 8.0 against ES 8.0\r\n- Start the reindex. Currently this has to be done via API b/c the Elasticsearch Deprecations API does not mark any indices in 8.0 as need to be reindexed for the next Lucene version, so the UI does not show them.\r\n  - `curl -u elastic:changeme -XPOST localhost:5601/api/upgrade_assistant/reindex/.security-6 -H 'kbn-xsrf: true'`\r\n- Wait for the reindex to complete. You'll need to wait until the `reindexOp.status` field of this response is equal to `1`:\r\n  - `curl -u elastic:changeme -XGET localhost:5601/api/upgrade_assistant/reindex/.security-6`\r\n- Look at the new mappings for `.security`, verify you see `_doc` now instead of `doc`.\r\n  - `curl \"localhost:9200/.security/_mappings?include_type_name=true\" -u elastic:changeme`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463045779","html_url":"https://github.com/elastic/elasticsearch/issues/38740#issuecomment-463045779","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38740","id":463045779,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzA0NTc3OQ==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2019-02-13T03:46:08Z","updated_at":"2019-02-13T03:46:45Z","author_association":"CONTRIBUTOR","body":"@joshdover \r\nThanks for your investigation. I'd like to close this issue and open a new one about the security index not being compatible with the Kibana upgrade assistant for 7.x to 8.x\r\n\r\nIt's not particularly surprising that this doesn't work - we haven't done any work in master to support security upgrades from 7 to 8.\r\n\r\nPer https://github.com/elastic/elasticsearch/issues/38678#issuecomment-462211056, we very much hope that security will stop using a regular index by the time we get to 8, so we're not likely to prioritise work that would change the type used in the security inde (or move to type-less APIs) until we have a better feel about where we're going with \"system indices\" in 7.x/8.0\r\n\r\nFor now can you just not run the upgrade assistant on the security index?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463092979","html_url":"https://github.com/elastic/elasticsearch/issues/38740#issuecomment-463092979","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38740","id":463092979,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzA5Mjk3OQ==","user":{"login":"Blackiie","id":47506707,"node_id":"MDQ6VXNlcjQ3NTA2NzA3","avatar_url":"https://avatars1.githubusercontent.com/u/47506707?v=4","gravatar_id":"","url":"https://api.github.com/users/Blackiie","html_url":"https://github.com/Blackiie","followers_url":"https://api.github.com/users/Blackiie/followers","following_url":"https://api.github.com/users/Blackiie/following{/other_user}","gists_url":"https://api.github.com/users/Blackiie/gists{/gist_id}","starred_url":"https://api.github.com/users/Blackiie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Blackiie/subscriptions","organizations_url":"https://api.github.com/users/Blackiie/orgs","repos_url":"https://api.github.com/users/Blackiie/repos","events_url":"https://api.github.com/users/Blackiie/events{/privacy}","received_events_url":"https://api.github.com/users/Blackiie/received_events","type":"User","site_admin":false},"created_at":"2019-02-13T07:43:22Z","updated_at":"2019-02-13T07:43:22Z","author_association":"NONE","body":"Emm ok no entiendo muy bien pero tratarÃ© de comprenderlo ðŸ˜€. Gracias por la\natencion!!\nEl 12 feb. 2019 19:47, \"Tim Vernum\" <notifications@github.com> escribiÃ³:\n\n> @joshdover <https://github.com/joshdover>\n> Thanks for your investigation. I'd like to close this issue and open a new\n> one about the security index not being compatible with the Kibana upgrade\n> assistant for 7.x to 8.x\n>\n> It's not particularly surprising that this doesn't work - we haven't done\n> any work in master to support security upgrades from 7 to 8.\n>\n> Per #38678 <https://github.com/elastic/elasticsearch/issues/38678>, we\n> very much hope that security will stop using a regular index by the time we\n> get to 8, so we're not likely to prioritise work that would change the type\n> used in the security inde (or move to type-less APIs) until we have a\n> better feel about where we're going with \"system indices\" in 7.x/8.0\n>\n> For now can you just not run the upgrade assistant on the security index?\n>\n> â€”\n> You are receiving this because you are subscribed to this thread.\n> Reply to this email directly, view it on GitHub\n> <https://github.com/elastic/elasticsearch/issues/38740#issuecomment-463045779>,\n> or mute the thread\n> <https://github.com/notifications/unsubscribe-auth/AtTlEwea3ZAIrR_Nr0uCgUmQM75vzfvWks5vM4rbgaJpZM4a0ig9>\n> .\n>\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463246344","html_url":"https://github.com/elastic/elasticsearch/issues/38740#issuecomment-463246344","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38740","id":463246344,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzI0NjM0NA==","user":{"login":"joshdover","id":1813008,"node_id":"MDQ6VXNlcjE4MTMwMDg=","avatar_url":"https://avatars2.githubusercontent.com/u/1813008?v=4","gravatar_id":"","url":"https://api.github.com/users/joshdover","html_url":"https://github.com/joshdover","followers_url":"https://api.github.com/users/joshdover/followers","following_url":"https://api.github.com/users/joshdover/following{/other_user}","gists_url":"https://api.github.com/users/joshdover/gists{/gist_id}","starred_url":"https://api.github.com/users/joshdover/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joshdover/subscriptions","organizations_url":"https://api.github.com/users/joshdover/orgs","repos_url":"https://api.github.com/users/joshdover/repos","events_url":"https://api.github.com/users/joshdover/events{/privacy}","received_events_url":"https://api.github.com/users/joshdover/received_events","type":"User","site_admin":false},"created_at":"2019-02-13T15:38:23Z","updated_at":"2019-02-13T15:38:23Z","author_association":"MEMBER","body":"@tvernum That works for me. Just wanted to flag this early so it wasn't forgotten about. For our testing purposes, we'll exclude .security for the time being. Thanks!","performed_via_github_app":null}]