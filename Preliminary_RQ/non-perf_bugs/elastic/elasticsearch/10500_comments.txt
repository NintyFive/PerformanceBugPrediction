[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92072113","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-92072113","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":92072113,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMDcyMTEz","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-12T14:39:06Z","updated_at":"2015-04-12T14:39:06Z","author_association":"CONTRIBUTOR","body":"Hi @amarandon \n\nI've just tried this on 1.5.0, and it works correctly. \n\n```\nDELETE myindex\n\nPUT /myindex?pretty\n\n# Insert mapping with geo_shape type\nPUT /myindex/_mapping/mytype?pretty\n{\n  \"mytype\": {\n    \"properties\": {\n      \"location\": {\n        \"type\": \"geo_shape\",\n        \"tree\": \"quadtree\",\n        \"precision\": \"1m\"\n      }\n    }\n  }\n}\n\n# Check that mapping is correct\nGET /myindex/_mapping/?pretty\n\n\nPUT /myindex/mytype/mydocument?pretty\n{\n  \"location\": {\n    \"type\": \"point\",\n    \"coordinates\": [\n      1.44207,\n      43.59959\n    ]\n  }\n}\n\n# Check that we can retrieve our document with a normal query\n\nGET /myindex/mytype/_search?pretty\n{\n    \"query\": {\n        \"geo_shape\": {\n            \"location\": {\n                \"shape\": {\n                    \"type\": \"envelope\",\n                    \"coordinates\": [[0, 50],[2, 40]]\n                }\n            }\n        }\n    }\n}\n\n# Try to submit the same query to the percolator. Works\nPUT /myindex/.percolator/myquery?pretty\n{\n    \"query\": {\n        \"geo_shape\": {\n            \"location\": {\n                \"shape\": {\n                    \"type\": \"envelope\",\n                    \"coordinates\": [[0, 50],[2, 40]]\n                }\n            }\n        }\n    }\n}\n\n# Percolate request works too\nPOST myindex/mytype/_percolate\n{\n  \"doc\": {\n    \"location\": {\n      \"type\": \"point\",\n      \"coordinates\": [\n        1.44207,\n        43.59959\n      ]\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92077735","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-92077735","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":92077735,"node_id":"MDEyOklzc3VlQ29tbWVudDkyMDc3NzM1","user":{"login":"amarandon","id":101934,"node_id":"MDQ6VXNlcjEwMTkzNA==","avatar_url":"https://avatars2.githubusercontent.com/u/101934?v=4","gravatar_id":"","url":"https://api.github.com/users/amarandon","html_url":"https://github.com/amarandon","followers_url":"https://api.github.com/users/amarandon/followers","following_url":"https://api.github.com/users/amarandon/following{/other_user}","gists_url":"https://api.github.com/users/amarandon/gists{/gist_id}","starred_url":"https://api.github.com/users/amarandon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amarandon/subscriptions","organizations_url":"https://api.github.com/users/amarandon/orgs","repos_url":"https://api.github.com/users/amarandon/repos","events_url":"https://api.github.com/users/amarandon/events{/privacy}","received_events_url":"https://api.github.com/users/amarandon/received_events","type":"User","site_admin":false},"created_at":"2015-04-12T15:07:44Z","updated_at":"2015-04-12T15:08:27Z","author_association":"CONTRIBUTOR","body":"Hi @clintongormley Thanks for trying it out. I found out that the issue is triggered by having `index.percolator.map_unmapped_fields_as_string: true` in my config file. I'm in the process of migrating an app built against an earlier version of Elasticsearch and found out that I had to enable that option to keep it working because not all the percolator queries we record have corresponding mappings.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92642140","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-92642140","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":92642140,"node_id":"MDEyOklzc3VlQ29tbWVudDkyNjQyMTQw","user":{"login":"amarandon","id":101934,"node_id":"MDQ6VXNlcjEwMTkzNA==","avatar_url":"https://avatars2.githubusercontent.com/u/101934?v=4","gravatar_id":"","url":"https://api.github.com/users/amarandon","html_url":"https://github.com/amarandon","followers_url":"https://api.github.com/users/amarandon/followers","following_url":"https://api.github.com/users/amarandon/following{/other_user}","gists_url":"https://api.github.com/users/amarandon/gists{/gist_id}","starred_url":"https://api.github.com/users/amarandon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amarandon/subscriptions","organizations_url":"https://api.github.com/users/amarandon/orgs","repos_url":"https://api.github.com/users/amarandon/repos","events_url":"https://api.github.com/users/amarandon/events{/privacy}","received_events_url":"https://api.github.com/users/amarandon/received_events","type":"User","site_admin":false},"created_at":"2015-04-14T06:26:19Z","updated_at":"2015-04-14T06:26:36Z","author_association":"CONTRIBUTOR","body":"@clintongormley Does it still work for you with `index.percolator.map_unmapped_fields_as_string: true` in your config file?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92827618","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-92827618","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":92827618,"node_id":"MDEyOklzc3VlQ29tbWVudDkyODI3NjE4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-14T13:22:03Z","updated_at":"2015-04-14T13:22:03Z","author_association":"CONTRIBUTOR","body":"@amarandon if you're using that option, then I'm not surprised it fails... A geoshape query can't work on a string field.  You need to have the field specified in the mapping before you can create a percolator which uses it.  Otherwise (with that setting enabled) it will assume that the missing field is a string, and... fail\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92855659","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-92855659","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":92855659,"node_id":"MDEyOklzc3VlQ29tbWVudDkyODU1NjU5","user":{"login":"amarandon","id":101934,"node_id":"MDQ6VXNlcjEwMTkzNA==","avatar_url":"https://avatars2.githubusercontent.com/u/101934?v=4","gravatar_id":"","url":"https://api.github.com/users/amarandon","html_url":"https://github.com/amarandon","followers_url":"https://api.github.com/users/amarandon/followers","following_url":"https://api.github.com/users/amarandon/following{/other_user}","gists_url":"https://api.github.com/users/amarandon/gists{/gist_id}","starred_url":"https://api.github.com/users/amarandon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amarandon/subscriptions","organizations_url":"https://api.github.com/users/amarandon/orgs","repos_url":"https://api.github.com/users/amarandon/repos","events_url":"https://api.github.com/users/amarandon/events{/privacy}","received_events_url":"https://api.github.com/users/amarandon/received_events","type":"User","site_admin":false},"created_at":"2015-04-14T13:49:57Z","updated_at":"2015-04-14T13:49:57Z","author_association":"CONTRIBUTOR","body":"@clintongormley But I do have the field specified in the mapping before I create the percolator which uses it. In the test script I provided, we create that mapping explicitly and even check that it's been properly created with a GET request before trying to create a percolator query against it. In other words the geo_shape field is not unmapped and shouldn't be affected by that option.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/92868265","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-92868265","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":92868265,"node_id":"MDEyOklzc3VlQ29tbWVudDkyODY4MjY1","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-14T14:17:44Z","updated_at":"2015-04-14T14:17:44Z","author_association":"CONTRIBUTOR","body":"Gotcha!  And I can recreate, too.  Agreed, this is a bug.\n\n@martijnvg please could you take a look\n\nHere's the full recreation:\n\n```\nPUT /myindex?pretty\n{\n  \"settings\": {\n    \"index.percolator.map_unmapped_fields_as_string\":true\n  }\n}\n\n# Insert mapping with geo_shape type\nPUT /myindex/_mapping/mytype?pretty\n{\n  \"mytype\": {\n    \"properties\": {\n      \"location\": {\n        \"type\": \"geo_shape\",\n        \"tree\": \"quadtree\",\n        \"precision\": \"1m\"\n      }\n    }\n  }\n}\n\n# Check that mapping is correct\nGET /myindex/_mapping/?pretty\n\n\nPUT /myindex/mytype/mydocument?pretty\n{\n  \"location\": {\n    \"type\": \"point\",\n    \"coordinates\": [\n      1.44207,\n      43.59959\n    ]\n  }\n}\n\n# Check that we can retrieve our document with a normal query\n\nGET /myindex/mytype/_search?pretty\n{\n    \"query\": {\n        \"geo_shape\": {\n            \"location\": {\n                \"shape\": {\n                    \"type\": \"envelope\",\n                    \"coordinates\": [[0, 50],[2, 40]]\n                }\n            }\n        }\n    }\n}\n\n# Try to submit the same query to the percolator. Works\nPUT /myindex/.percolator/myquery?pretty\n{\n    \"query\": {\n        \"geo_shape\": {\n            \"location\": {\n                \"shape\": {\n                    \"type\": \"envelope\",\n                    \"coordinates\": [[0, 50],[2, 40]]\n                }\n            }\n        }\n    }\n}\n\n# Percolate request works too\nPOST myindex/mytype/_percolate\n{\n  \"doc\": {\n    \"location\": {\n      \"type\": \"point\",\n      \"coordinates\": [\n        1.44207,\n        43.59959\n      ]\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172350818","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-172350818","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":172350818,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjM1MDgxOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-17T16:53:56Z","updated_at":"2016-01-17T16:53:56Z","author_association":"CONTRIBUTOR","body":"This still fails in 2.2 and master, but it fails when trying to PUT the percolator query with `location is not a geoshape`.\n\n@martijnvg are percolator queries still parse-once, or are they parsed on each execution? If the latter, then could we just remove the `index.percolator.map_unmapped_fields_as_string` setting?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172384041","html_url":"https://github.com/elastic/elasticsearch/issues/10500#issuecomment-172384041","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10500","id":172384041,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjM4NDA0MQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-01-17T21:15:08Z","updated_at":"2016-01-17T21:15:08Z","author_association":"MEMBER","body":"@clintongormley Percolator queries are still parsed once. \n\nThis issue was caused by a bug that if the 'map unmapped fields as strings' was enabled it would even substitute found fields with string fields! The `geo_shape` query has a hard check if what type of field is being returned from the mapping as therefor fails. Luckily this is easy to fix: #16043\n","performed_via_github_app":null}]