{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32623","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32623/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32623/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32623/events","html_url":"https://github.com/elastic/elasticsearch/issues/32623","id":347505478,"node_id":"MDU6SXNzdWUzNDc1MDU0Nzg=","number":32623,"title":"Field Alias error when used in collapse query","user":{"login":"pcsanwald","id":163306,"node_id":"MDQ6VXNlcjE2MzMwNg==","avatar_url":"https://avatars1.githubusercontent.com/u/163306?v=4","gravatar_id":"","url":"https://api.github.com/users/pcsanwald","html_url":"https://github.com/pcsanwald","followers_url":"https://api.github.com/users/pcsanwald/followers","following_url":"https://api.github.com/users/pcsanwald/following{/other_user}","gists_url":"https://api.github.com/users/pcsanwald/gists{/gist_id}","starred_url":"https://api.github.com/users/pcsanwald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pcsanwald/subscriptions","organizations_url":"https://api.github.com/users/pcsanwald/orgs","repos_url":"https://api.github.com/users/pcsanwald/repos","events_url":"https://api.github.com/users/pcsanwald/events{/privacy}","received_events_url":"https://api.github.com/users/pcsanwald/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"assignees":[{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-08-03T19:07:07Z","updated_at":"2019-02-07T08:24:08Z","closed_at":"2018-08-07T23:21:41Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** : 7.x\r\n\r\n\r\n**Plugins installed**: none\r\n**JVM version**: java version \"10\" 2018-03-20\r\n**OS version**: 17.4.0 Darwin Kernel Version 17.4.0: Sun Dec 17 09:19:54 PST 2017; root:xnu-4570.41.2~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nCollapsing on a field alias returns an NPE, rather than the expected result of the collapse as applied to the field pointed to via the alias' path.\r\n\r\n**Steps to reproduce**:\r\n\r\n0. Bring up a local instance of elasticsearch, running latest `master`. \r\n\r\n 1. Index some docs using python script attached (you may need to `pip install elasticsearch`, `pip install faker` for the script to work. Note that `postal_code` is a field alias, pointing to `zip_code`, a long. [populate.py.gz](https://github.com/elastic/elasticsearch/files/2258517/populate.py.gz)\r\n\r\n 2. Run the following query\r\n```\r\ncurl \"http://localhost:9200/twitter/_search/\" \\\r\n     -H 'Content-Type: application/json' \\\r\n     -d $'{\r\n    \"query\": {\r\n        \"match_all\": {}\r\n    },\r\n    \"collapse\" : {\r\n        \"field\" : \"postal_code\",\r\n        \"inner_hits\": [\r\n            {\r\n              \"name\": \"by_postal_code\",\r\n                \"size\": 3,\r\n                \"collapse\" : {\"field\" : \"name\"},\r\n                \"sort\": [\"likes\"]\r\n            }\r\n        ]\r\n    }\r\n  }' | jq '.'\r\n```\r\nObserve the error.\r\n\r\n3. Contrast this response with the same query, but using the `zip_code` field instead\r\n\r\n```\r\ncurl \"http://localhost:9200/twitter/_search/\" \\\r\n     -H 'Content-Type: application/json' \\\r\n     -d $'{\r\n    \"query\": {\r\n        \"match_all\": {}\r\n    },\r\n    \"collapse\" : {\r\n        \"field\" : \"zip_code\",\r\n        \"inner_hits\": [\r\n            {\r\n              \"name\": \"by_postal_code\",\r\n                \"size\": 3,\r\n                \"collapse\" : {\"field\" : \"name\"},\r\n                \"sort\": [\"likes\"]\r\n            }\r\n        ]\r\n    }\r\n  }' | jq '.'\r\n```\r\nThis query returns results as expected.\r\n**Provide logs (if relevant)**: The stacktrace for the error in step 2 is below.\r\n\r\n```\r\n[elasticsearch] [2018-08-03T13:28:42,185][DEBUG][o.e.a.s.TransportSearchAction] [node-0] Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[twitter], indicesOptions=IndicesOptions[ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_aliases_to_multiple_indices=true, forbid_closed_indices=true, ignore_aliases=false], types=[], routing='null', preference='null', requestCache=null, scroll=null, maxConcurrentShardRequests=0, batchedReduceSize=512, preFilterShardSize=128, allowPartialSearchResults=true, source={\"query\":{\"match_all\":{\"boost\":1.0}},\"collapse\":{\"field\":\"postal_code\",\"inner_hits\":{\"name\":\"by_postal_code\",\"ignore_unmapped\":false,\"from\":0,\"size\":3,\"version\":false,\"explain\":false,\"track_scores\":false,\"sort\":[{\"likes\":{\"order\":\"asc\"}}],\"collapse\":{\"field\":\"name\"}}}}}] while moving to [expand] phase\r\n[elasticsearch] java.lang.NullPointerException: null\r\n[elasticsearch]         at org.elasticsearch.action.search.ExpandSearchPhase.run(ExpandSearchPhase.java:79) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.AbstractSearchAsyncAction.executePhase(AbstractSearchAsyncAction.java:160) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:153) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.FetchSearchPhase.moveToNextPhase(FetchSearchPhase.java:205) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.FetchSearchPhase.lambda$innerRun$2(FetchSearchPhase.java:104) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:110) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:44) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:86) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1135) [?:?]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) [?:?]\r\n[elasticsearch]         at java.lang.Thread.run(Thread.java:844) [?:?]\r\n```\r\n","closed_by":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"performed_via_github_app":null}