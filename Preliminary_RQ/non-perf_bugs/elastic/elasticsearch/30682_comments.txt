[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389857535","html_url":"https://github.com/elastic/elasticsearch/issues/30682#issuecomment-389857535","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30682","id":389857535,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTg1NzUzNQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T12:59:20Z","updated_at":"2018-05-17T12:59:20Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389953011","html_url":"https://github.com/elastic/elasticsearch/issues/30682#issuecomment-389953011","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30682","id":389953011,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTk1MzAxMQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T17:51:16Z","updated_at":"2018-05-17T17:51:16Z","author_association":"MEMBER","body":"Since our packaging tests have been green for almost 10 straight days, I think this has to be an environmental issue. As such, I am going to close this. We can help you sort out what the issue might be via another channel.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390121311","html_url":"https://github.com/elastic/elasticsearch/issues/30682#issuecomment-390121311","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30682","id":390121311,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDEyMTMxMQ==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T07:33:01Z","updated_at":"2018-05-18T07:33:01Z","author_association":"CONTRIBUTOR","body":"On closer inspection, the real cause was this:\r\n```\r\nfedora-28:/project/build/packaging/archives$ sudo bats /project/build/packaging/bats/tests/80_upgrade.bats\r\n âœ— [UPGRADE] install old version\r\n   (from function `install_package' in file /project/build/packaging/bats/utils/packages.bash, line 77,\r\n    in test file /project/build/packaging/bats/tests/80_upgrade.bats, line 60)\r\n     `install_package -v $(cat upgrade_from_version)' failed\r\n   error: open of elasticsearch-oss-6.2.5-SNAPSHOT.rpm failed: No such file or directory\r\n```\r\nIndeed that RPM is not on the box ( only 6.3.0 is ) ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390126901","html_url":"https://github.com/elastic/elasticsearch/issues/30682#issuecomment-390126901","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30682","id":390126901,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDEyNjkwMQ==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T07:57:11Z","updated_at":"2018-05-18T07:57:11Z","author_association":"CONTRIBUTOR","body":"There seems to be a mismatch between the tests and the Gradle setup, as `VagrantTestPlugin` has this: \r\n```\r\nif (upgradeFromVersion.onOrAfter('6.3.0')) {\r\n                project.dependencies.add(PACKAGING_CONFIGURATION,\r\n                        \"org.elasticsearch.distribution.${it}:elasticsearch-oss:${upgradeFromVersion}@${it}\")\r\n            }\r\n```\r\nso the elasticsearch**-oss** distribution is only added from `6.3.0` yet the test tried to install it for `6.2.5`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390164363","html_url":"https://github.com/elastic/elasticsearch/issues/30682#issuecomment-390164363","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30682","id":390164363,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDE2NDM2Mw==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T10:22:15Z","updated_at":"2018-05-18T11:16:13Z","author_association":"CONTRIBUTOR","body":"There's this logic that switches the package name in `qa/vagrant/src/test/resources/packaging/tests/80_upgrade.bats`:\r\n```\r\n    # TODO: this needs to conditionally change based on version > 6.3.0\r\n    if [ -f upgrade_is_oss ]; then\r\n      export PACKAGE_NAME=\"elasticsearch-oss\"\r\n    else\r\n      skip \"upgrade cannot happen from pre 6.3.0 to elasticsearch-oss\"\r\n    fi\r\n```\r\n\r\nThe test pass on CI, but this test is skipped:\r\n```\r\n04:23:23 ok 228 # skip (upgrade cannot happen from pre 6.3.0 to elasticsearch-oss) [UPGRADE] install old version\r\n04:23:23 ok 228 # skip (upgrade cannot happen from pre 6.3.0 to elasticsearch-oss) [UPGRADE] install old version\r\n```\r\nI get the same result from CI if I get the testing seed as above, or if I specify and older version:\r\n`../../gradlew clean packagingTest -Pvagrant.boxes=fedora-27  -Dtests.seed=FD628E5E9BAEE17`\r\nor\r\n`../../gradlew clean packagingTest -Pvagrant.boxes=fedora-28 -Dtests.packaging.upgradeVersion=6.2.5-SNAPSHOT`\r\n ( the seed is used only if upgradeVersion is not passed in )\r\n\r\nA  difference between CI and how I ran it locally is that CI calls `clean`, whereas I did not when I ran into the issue first reported here. This plays an important role because `createUpgradeIsOssFile` uses `onlyIf`, so the file is not cleaned up if it shouldn't be there, it's left around if it was there previously. \r\n\r\nFor completeness this is how to reproduce the first issue I ran into:\r\n```\r\n../../gradlew clean createUpgradeIsOssFile -Pvagrant.boxes=fedora-27 -Dtests.packaging.upgradeVersion=6.3.0-SNAPSHOT\r\n../../gradlew packagingTest -Pvagrant.boxes=fedora-27 -Dtests.packaging.upgradeVersion=6.2.5-SNAPSHOT\r\n```\r\n I will reopen the ticket to make some changes to `createUpgradeIsOssFile`  so it isn't as sensitive to `clean` and hopefully save others some trouble.\r\n\r\nUpdate: removed sections that described a failure of the tests as it turned out that was due to a local change.\r\n","performed_via_github_app":null}]