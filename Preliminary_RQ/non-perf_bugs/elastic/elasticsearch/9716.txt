{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9716","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9716/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9716/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9716/events","html_url":"https://github.com/elastic/elasticsearch/issues/9716","id":57898426,"node_id":"MDU6SXNzdWU1Nzg5ODQyNg==","number":9716,"title":"Geoshape query returns incorrect results","user":{"login":"j0r0","id":370737,"node_id":"MDQ6VXNlcjM3MDczNw==","avatar_url":"https://avatars1.githubusercontent.com/u/370737?v=4","gravatar_id":"","url":"https://api.github.com/users/j0r0","html_url":"https://github.com/j0r0","followers_url":"https://api.github.com/users/j0r0/followers","following_url":"https://api.github.com/users/j0r0/following{/other_user}","gists_url":"https://api.github.com/users/j0r0/gists{/gist_id}","starred_url":"https://api.github.com/users/j0r0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/j0r0/subscriptions","organizations_url":"https://api.github.com/users/j0r0/orgs","repos_url":"https://api.github.com/users/j0r0/repos","events_url":"https://api.github.com/users/j0r0/events{/privacy}","received_events_url":"https://api.github.com/users/j0r0/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2015-02-17T08:56:17Z","updated_at":"2015-04-14T13:20:50Z","closed_at":"2015-04-14T13:20:50Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"With version 1.4.1 we had this issue: #8467\nhttps://github.com/elasticsearch/elasticsearch/issues/8467\n\nWith 1.4.1 the workaround returns completely wrong results.\nExample;\n\n```\n{\n  \"size\" : 0,\n  \"query\" : {\n    \"bool\" : {\n      \"must\" : [ {\n        \"range\" : {\n          \"ts\" : {\n            \"from\" : \"2015-02-13T00:00:00.0Z\",\n            \"to\" : \"2015-02-13T23:59:58.0Z\",\n            \"include_lower\" : true,\n            \"include_upper\" : true\n          }\n        }\n      }, {\n        \"geo_shape\" : {\n          \"loc\" : {\n            \"shape\" : {\n              \"type\" : \"polygon\",\n              \"coordinates\" : [ [ [ -179.999, 89.999 ], [ 179.999, 89.999 ], [ 179.999, -89.999 ], [ -179.999, -89.999 ], [ -179.999, 89.999 ] ] ]\n            },\n            \"relation\": \"within\"\n          }\n        }\n      } ]\n    }\n  }\n}\n```\n\nThis returns 4360 results, which is clearly wrong.\n\nAnother query (only polygon changed a bit)\n\n```\nGET track_201502/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"geo_shape\": {\n      \"loc\": {\n        \"shape\": {\n          \"type\": \"polygon\",\n          \"coordinates\": [[[-180,90],[180,90],[180,-90],[-180,-90],[-180,90]]]\n        },\n        \"relation\": \"within\"\n      }\n    }\n        },\n        {\n          \"range\": {\n            \"ts\": {\n              \"from\" : \"2015-02-13T00:00:00.0Z\",\n            \"to\" : \"2015-02-13T23:59:58.0Z\",\n            \"include_lower\" : true,\n            \"include_upper\" : true\n            }\n          }\n        }\n      ]\n    }\n  }\n  ,\n  \"size\": 0\n}\n```\n\nThis returns 6678451 results which is more likely .\nAs you can see the only difference between the 2 queries is the polygon .\nInstead of 180/90 we have 179.999/89.999\nThis was workaround for  #8467\n","closed_by":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"performed_via_github_app":null}