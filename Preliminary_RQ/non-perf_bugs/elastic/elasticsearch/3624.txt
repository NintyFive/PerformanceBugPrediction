{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3624/events","html_url":"https://github.com/elastic/elasticsearch/issues/3624","id":19042303,"node_id":"MDU6SXNzdWUxOTA0MjMwMw==","number":3624,"title":"Memory increase from 0.90.2 to 0.90.3 on java client API","user":{"login":"arey","id":838318,"node_id":"MDQ6VXNlcjgzODMxOA==","avatar_url":"https://avatars2.githubusercontent.com/u/838318?v=4","gravatar_id":"","url":"https://api.github.com/users/arey","html_url":"https://github.com/arey","followers_url":"https://api.github.com/users/arey/followers","following_url":"https://api.github.com/users/arey/following{/other_user}","gists_url":"https://api.github.com/users/arey/gists{/gist_id}","starred_url":"https://api.github.com/users/arey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/arey/subscriptions","organizations_url":"https://api.github.com/users/arey/orgs","repos_url":"https://api.github.com/users/arey/repos","events_url":"https://api.github.com/users/arey/events{/privacy}","received_events_url":"https://api.github.com/users/arey/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"assignees":[{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2013-09-05T13:07:25Z","updated_at":"2013-09-06T10:25:34Z","closed_at":"2013-09-06T00:26:38Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Context\n\nOur Java batch indexes 13 millions of document with the ElasticSearch Java API.\nAnd our ElasticSearch cluster contains a single data node and a single shard.\n## Problem\n\nBy upgrading the ElasticSearch server and client from version 0.90.2 to 0.90.3, the batch stops with an OutOfMemoryError. This memory error only occurs on client side (ie. the batch).\nUntil now, 512 Mb will be enough to run the batch without memory problem (as well as in production environment). With the old 0.19.2 version, we neither had this problem.\nBy updating the Xmx value to 1g, the batch falls again. The Xms has to be set to 1300Mb in order the batch finish with success.\nBy downgrading client version from 0.90.3 to 0.90.2 (the ES cluster still runs with the 0.90.3 version), our batch problem goes away and 512 Mb of memory are enough.\nSo I believe a change between the 0.90.2 and 0.90.3 versions causes ES to require more memory (example: increase byte[] array buffer default size ?)\n## More informations\n\nThe batch uses the BulkRequestBuilder API. Bulk request contains 5 000 request. At most 20 threads could be running in parallel. But they are not writing to ES at the same time.\nAs you can see on the below screenshot, a OutOfMemory hprof dump indicates that 800Mb of byte[] is coming from the org.elasticsearch.common.bytes.BytesArray structure.\nWe have 25 000 org.elasticSearch.action.index.IndexRequest in memory.\n\n![batch_memory_live_objects](https://f.cloud.github.com/assets/838318/1088059/d7c7c4ea-1629-11e3-896e-23074c99be4e.jpg)\n\nDo other ElasticSearch users have this kind of memory problem with the 0.90.3 version?\n\nTo solve our issue, I see many possibilities: \n- Increase batch Xmx to 1300Mb. Our production environnement as more than 40 millions of documents so I fears this value will be not enough. \n- Use the 0.90.2 version of ElasticSearch for our batch\n- Wait a new version of ElasticSearch that fix this problem.\n- Decrease the number of request in bulk\n- Decrease the number of threads\n\nThe last two solutions have a flaw: the batch will run more longer. \n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}