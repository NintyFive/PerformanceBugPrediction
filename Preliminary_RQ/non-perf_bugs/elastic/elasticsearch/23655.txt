{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23655","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23655/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23655/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23655/events","html_url":"https://github.com/elastic/elasticsearch/issues/23655","id":215481275,"node_id":"MDU6SXNzdWUyMTU0ODEyNzU=","number":23655,"title":"Provide better logging on snapshot restore when allocation filtering criteria is not met","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"assignees":[{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2017-03-20T16:41:09Z","updated_at":"2018-03-26T13:32:06Z","closed_at":"2018-03-26T13:32:06Z","author_association":"MEMBER","active_lock_reason":null,"body":"2.x, 5.x\r\n\r\nCurrently, by default, if a snapshot is taken against an index with allocation filtering settings, and the target cluster do not have nodes started with the corresponding node attributes for allocation, it is not clear to the administrator why the restore appears to be stuck. \r\n\r\n- The recovery api will show outstanding recovery at all\r\n- The cluster state api will show the restored shards stuck in INIT state\r\n- There are no threads indicating any outstanding restore action\r\n- Even when logging is turned up to debug mode, there is no logging telling the user why the restore is not happening\r\n\r\nOn 5.x, it's better because we have a [cluster allocate explain api](https://www.elastic.co/guide/en/elasticsearch/reference/master/cluster-allocation-explain.html) that can be used to get an explanation.  However, the above of the restored shards stuck in INIT recovery state can be misleading to users and they may not immediately realize that they have to go run the cluster allocation explain api.\r\n\r\nIt will be a better experience if the snapshot restore process can determine that there are shard allocation filtering settings as part of the restored snapshot and that the target cluster does not have matching attributes - and will write a warning message to the log files indicating that.\r\n\r\nSomething like the following written to the logs will be nice:\r\n\r\n```\r\nCannot find any nodes matching index setting [index.routing.allocation.<setting>] filters [tag:\"<something>\"]```\r\n\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}