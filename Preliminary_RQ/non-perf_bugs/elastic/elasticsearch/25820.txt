{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25820","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25820/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25820/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25820/events","html_url":"https://github.com/elastic/elasticsearch/issues/25820","id":244527437,"node_id":"MDU6SXNzdWUyNDQ1Mjc0Mzc=","number":25820,"title":"Scroll SearchContextMissingException and NPE in ES logs","user":{"login":"qwerty4030","id":874677,"node_id":"MDQ6VXNlcjg3NDY3Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/874677?v=4","gravatar_id":"","url":"https://api.github.com/users/qwerty4030","html_url":"https://github.com/qwerty4030","followers_url":"https://api.github.com/users/qwerty4030/followers","following_url":"https://api.github.com/users/qwerty4030/following{/other_user}","gists_url":"https://api.github.com/users/qwerty4030/gists{/gist_id}","starred_url":"https://api.github.com/users/qwerty4030/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/qwerty4030/subscriptions","organizations_url":"https://api.github.com/users/qwerty4030/orgs","repos_url":"https://api.github.com/users/qwerty4030/repos","events_url":"https://api.github.com/users/qwerty4030/events{/privacy}","received_events_url":"https://api.github.com/users/qwerty4030/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2017-07-20T23:48:14Z","updated_at":"2018-07-04T13:21:04Z","closed_at":"2018-07-04T13:21:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 5.3.3\r\n\r\n**Plugins installed**: [discovery-ec2, repository-s3, x-pack]\r\n\r\n**JVM version** : 1.8.0_131 Java HotSpot(TM) 64-Bit Server VM\r\n\r\n**OS version** : 3.13.0-121-generic AWS Ubuntu 14.04 LTS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nA scroll request in a daily scheduled job *sometimes* fails due to `cause [SearchContextMissingException[No search context found for id [162106278]]`. I'm pretty confident that our code is correct: we use the scroll id from the previous request and the scroll timeout is set to 10 minutes. This error only occurs sometimes within a few minutes of starting the scroll (size is 1000) and about 20k docs have been processed at that point. Around the time of the error I noticed an NPE, IAE, and GC warnings in the ES logs. The index has 10 shards and 1 replica with 10 data nodes. Also around this time we experience a 60% increase in search latency (looking at kibana monitoring).\r\n\r\nUnable to reproduce, but this error has occurred 3 times in the last 7 days (run once per day).\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nException from our code:\r\n```\r\n[ERROR] [19-Jul-2017 13:07:12.930] java.lang.IllegalArgumentException: response shards failed: [shard [_na], reason [RemoteTransportException[[data7][10.206.38.239:9300][indices:data/read/search[phase/query/scroll]]]; nested: SearchContextMissingException[No search context found for id [178138733]]; ], cause [SearchContextMissingException[No search context found for id [178138733]]\r\n\tat org.elasticsearch.search.SearchService.findContext(SearchService.java:438)\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:309)\r\n\tat org.elasticsearch.action.search.SearchTransportService$8.messageReceived(SearchTransportService.java:351)\r\n\tat org.elasticsearch.action.search.SearchTransportService$8.messageReceived(SearchTransportService.java:348)\r\n...\r\n```\r\n\r\nExceptions in ES logs (about 15s before, same logs for many/most of the other nodes):\r\n```\r\n[2017-07-19T13:06:57,579][DEBUG][o.e.a.s.TransportSearchScrollAction] [data7] Failed to execute fetch phase\r\norg.elasticsearch.transport.RemoteTransportException: [data7][10.206.38.239:9300][indices:data/read/search[phase/fetch/id/scroll]]\r\nCaused by: java.lang.NullPointerException\r\n\tat org.elasticsearch.search.DefaultSearchContext.isCancelled(DefaultSearchContext.java:826) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:140) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:417) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.action.search.SearchTransportService$11.messageReceived(SearchTransportService.java:384) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.action.search.SearchTransportService$11.messageReceived(SearchTransportService.java:381) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n...\r\n[2017-07-19T13:06:57,582][DEBUG][o.e.a.s.TransportSearchScrollAction] [data7] Failed to execute fetch phase\r\norg.elasticsearch.transport.RemoteTransportException: [data3][10.206.38.212:9300][indices:data/read/search[phase/fetch/id/scroll]]\r\nCaused by: java.lang.IllegalArgumentException: unable to fetch fields from _source field: _source is disabled in the mappings for index [data-product-5]\r\n\tat org.elasticsearch.search.fetch.subphase.FetchSourceSubPhase.hitExecute(FetchSourceSubPhase.java:48) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:163) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:417) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.action.search.SearchTransportService$11.messageReceived(SearchTransportService.java:384) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.action.search.SearchTransportService$11.messageReceived(SearchTransportService.java:381) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n...\r\n[2017-07-19T13:06:57,629][DEBUG][o.e.a.s.TransportSearchScrollAction] [data4] [178138733] Failed to execute query phase\r\norg.elasticsearch.transport.RemoteTransportException: [data7][10.206.38.239:9300][indices:data/read/search[phase/query/scroll]]\r\nCaused by: org.elasticsearch.search.SearchContextMissingException: No search context found for id [178138733]\r\n\tat org.elasticsearch.search.SearchService.findContext(SearchService.java:438) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:309) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n\tat org.elasticsearch.action.search.SearchTransportService$8.messageReceived(SearchTransportService.java:351) ~[elasticsearch-5.3.3.jar:5.3.3]\r\n...\r\n[2017-07-19T13:07:20,773][WARN ][o.e.m.j.JvmGcMonitorService] [data9] [gc][2070933] overhead, spent [6.9s] collecting in the last [7.4s]\r\n```\r\n\r\n","closed_by":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}