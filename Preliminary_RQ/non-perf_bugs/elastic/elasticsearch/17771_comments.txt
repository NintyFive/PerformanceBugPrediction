[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/210347949","html_url":"https://github.com/elastic/elasticsearch/issues/17771#issuecomment-210347949","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17771","id":210347949,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMDM0Nzk0OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-04-15T08:10:15Z","updated_at":"2016-04-15T08:10:15Z","author_association":"CONTRIBUTOR","body":"> Occasionally one of the queries will return a failure response like this that matches the ES cluster console output but the number of failures is tiny compared to the log spam:\n\nDid you check the shard failures in each search request? I bet there are lots of shard failures (which are responsible for the stack traces) and you're getting incomplete results.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/211184707","html_url":"https://github.com/elastic/elasticsearch/issues/17771#issuecomment-211184707","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17771","id":211184707,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMTE4NDcwNw==","user":{"login":"rnagappan","id":8610755,"node_id":"MDQ6VXNlcjg2MTA3NTU=","avatar_url":"https://avatars3.githubusercontent.com/u/8610755?v=4","gravatar_id":"","url":"https://api.github.com/users/rnagappan","html_url":"https://github.com/rnagappan","followers_url":"https://api.github.com/users/rnagappan/followers","following_url":"https://api.github.com/users/rnagappan/following{/other_user}","gists_url":"https://api.github.com/users/rnagappan/gists{/gist_id}","starred_url":"https://api.github.com/users/rnagappan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rnagappan/subscriptions","organizations_url":"https://api.github.com/users/rnagappan/orgs","repos_url":"https://api.github.com/users/rnagappan/repos","events_url":"https://api.github.com/users/rnagappan/events{/privacy}","received_events_url":"https://api.github.com/users/rnagappan/received_events","type":"User","site_admin":false},"created_at":"2016-04-18T04:00:42Z","updated_at":"2016-04-18T04:00:42Z","author_association":"NONE","body":"Yes, there are many shard failures for each request, so many matching failure messages like this below. The question remains though, why can't MultiSearch manage its own request queue so it does not flood the cluster like this?\n\n```\nshard [[UVvK8FU6TmGS6LDnVczdaA][nuix-334f4c30941040ee894bde64ef3cc932][3]], reason [RemoteTransportException[[SYD-NAGAPPR-WS][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: EsRejectedExecutionException[rejected execution of org.elasticsearch.transport.TransportService$4@a81db35 on EsThreadPoolExecutor[search, queue capacity = 1000, org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor@7bb429e0[Running, pool size = 37, active threads = 37, queued tasks = 990, completed tasks = 120883]]]; ], cause [EsRejectedExecutionException[rejected execution of org.elasticsearch.transport.TransportService$4@a81db35 on EsThreadPoolExecutor[search, queue capacity = 1000, org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor@7bb429e0[Running, pool size = 37, active threads = 37, queued tasks = 990, completed tasks = 120883]]]\nat org.elasticsearch.common.util.concurrent.EsAbortPolicy.rejectedExecution(EsAbortPolicy.java:50)\nat java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:823)\nat java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1369)\nat org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor.execute(EsThreadPoolExecutor.java:85)\nat org.elasticsearch.transport.TransportService.sendLocalRequest(TransportService.java:346)\nat org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:310)\nat org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:282)\nat org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:142)\nat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:85)\nat org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:166)\nat org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.start(TransportSearchTypeAction.java:148)\nat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction.doExecute(TransportSearchQueryThenFetchAction.java:64)\nat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction.doExecute(TransportSearchQueryThenFetchAction.java:53)\nat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:70)\nat org.elasticsearch.action.search.TransportSearchAction.doExecute(TransportSearchAction.java:99)\nat org.elasticsearch.action.search.TransportSearchAction.doExecute(TransportSearchAction.java:44)\nat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:70)\nat org.elasticsearch.action.search.TransportMultiSearchAction.doExecute(TransportMultiSearchAction.java:63)\nat org.elasticsearch.action.search.TransportMultiSearchAction.doExecute(TransportMultiSearchAction.java:39)\nat org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:70)\nat org.elasticsearch.action.support.HandledTransportAction$TransportHandler.messageReceived(HandledTransportAction.java:45)\nat org.elasticsearch.action.support.HandledTransportAction$TransportHandler.messageReceived(HandledTransportAction.java:41)\nat org.elasticsearch.transport.netty.MessageChannelHandler.handleRequest(MessageChannelHandler.java:244)\nat org.elasticsearch.transport.netty.MessageChannelHandler.messageReceived(MessageChannelHandler.java:114)\nat org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\nat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\nat org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)\nat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:296)\nat org.jboss.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(FrameDecoder.java:462)\nat org.jboss.netty.handler.codec.frame.FrameDecoder.callDecode(FrameDecoder.java:443)\nat org.jboss.netty.handler.codec.frame.FrameDecoder.messageReceived(FrameDecoder.java:310)\nat org.jboss.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(SimpleChannelUpstreamHandler.java:70)\nat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\nat org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(DefaultChannelPipeline.java:791)\nat org.elasticsearch.common.netty.OpenChannelsHandler.handleUpstream(OpenChannelsHandler.java:75)\nat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:564)\nat org.jboss.netty.channel.DefaultChannelPipeline.sendUpstream(DefaultChannelPipeline.java:559)\nat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:268)\nat org.jboss.netty.channel.Channels.fireMessageReceived(Channels.java:255)\nat org.jboss.netty.channel.socket.nio.NioWorker.read(NioWorker.java:88)\nat org.jboss.netty.channel.socket.nio.AbstractNioWorker.process(AbstractNioWorker.java:108)\nat org.jboss.netty.channel.socket.nio.AbstractNioSelector.run(AbstractNioSelector.java:337)\nat org.jboss.netty.channel.socket.nio.AbstractNioWorker.run(AbstractNioWorker.java:89)\nat org.jboss.netty.channel.socket.nio.NioWorker.run(NioWorker.java:178)\nat org.jboss.netty.util.ThreadRenamingRunnable.run(ThreadRenamingRunnable.java:108)\nat org.jboss.netty.util.internal.DeadLockProofWorker$1.run(DeadLockProofWorker.java:42)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nat java.lang.Thread.run(Thread.java:745)\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/213371050","html_url":"https://github.com/elastic/elasticsearch/issues/17771#issuecomment-213371050","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17771","id":213371050,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMzM3MTA1MA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-04-22T10:28:01Z","updated_at":"2016-04-22T10:28:01Z","author_association":"MEMBER","body":"Closing this issue in favour of #17926. \n\n@rnagappan There is room for improvement for the multi search api. Unfortunately today there isn't much that can be done to avoid rejected exceptions in your case other then lowering the amount of search requests in the multi search api or adding more nodes to your cluster.\n","performed_via_github_app":null}]