{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3165","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3165/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3165/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3165/events","html_url":"https://github.com/elastic/elasticsearch/issues/3165","id":15450342,"node_id":"MDU6SXNzdWUxNTQ1MDM0Mg==","number":3165,"title":"has_parent query with automatic filter","user":{"login":"q42jaap","id":114642,"node_id":"MDQ6VXNlcjExNDY0Mg==","avatar_url":"https://avatars0.githubusercontent.com/u/114642?v=4","gravatar_id":"","url":"https://api.github.com/users/q42jaap","html_url":"https://github.com/q42jaap","followers_url":"https://api.github.com/users/q42jaap/followers","following_url":"https://api.github.com/users/q42jaap/following{/other_user}","gists_url":"https://api.github.com/users/q42jaap/gists{/gist_id}","starred_url":"https://api.github.com/users/q42jaap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/q42jaap/subscriptions","organizations_url":"https://api.github.com/users/q42jaap/orgs","repos_url":"https://api.github.com/users/q42jaap/repos","events_url":"https://api.github.com/users/q42jaap/events{/privacy}","received_events_url":"https://api.github.com/users/q42jaap/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2013-06-12T13:22:36Z","updated_at":"2013-06-12T15:07:27Z","closed_at":"2013-06-12T15:04:00Z","author_association":"NONE","active_lock_reason":null,"body":"I this poc I'm doing, I'm generating this kind of has_parent filter:\n\n``` json\n{\n  \"facet_filter\": {\n    \"and\": {\n      \"filters\": [\n        {\n          \"type\": { \"value\": \"prices\" }\n        },\n        {\n          \"term\": { \"careType\": \"LO\" }\n        },\n        {\n          \"has_parent\": { // <== this is the filter I'm talking about\n            \"type\": \"accos\",\n            \"query\": {\n              \"filtered\": {\n                \"filter\": {\n                  \"term\": {\n                    \"locationCode\": \"0512\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nI want to filter on parents instead of doing a query (which imposes scoring overhead, which is strange because it's a has_parent filter anyway).\n\nIt would be nice to be able to use a filter directly in the has_parent filter:\n\n``` json\n{\n  \"has_parent\": {\n    \"type\": \"accos\",\n    \"filter\": {\n      \"term\": {\n        \"locationCode\": \"0512\"\n      }\n    }\n  }\n}\n```\n\nI actually think this would also be useful for the has_parent query or the has_child query.\n\nMartijn's favourite has_child/custom_score to sort on a numeric property of child records, looks like this:\n\n``` json\n{\n \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"has_child\": {\n          \"type\": \"prices\",\n          \"score_type\": \"max\",\n          \"query\": {\n            \"custom_score\": {\n              \"script\": \"-doc['pricePerPerson'].value\",\n              \"query\": {\n                \"filtered\": {\n                  \"filter\": {\n                    \"term\": { \"careType\": \"LO\" }\n                  }\n                }\n              }\n            }\n          }\n        }\n      },\n      \"filter\": {\n        \"term\": { \"locationCode\": \"0512\" }\n      }\n    }\n  }\n}\n```\n\ncustom_score's query being a filtered query could collapse the filter part into the custom_score query itself, this is another way to write a more consise (and probably also more optimal) query.\n","closed_by":{"login":"q42jaap","id":114642,"node_id":"MDQ6VXNlcjExNDY0Mg==","avatar_url":"https://avatars0.githubusercontent.com/u/114642?v=4","gravatar_id":"","url":"https://api.github.com/users/q42jaap","html_url":"https://github.com/q42jaap","followers_url":"https://api.github.com/users/q42jaap/followers","following_url":"https://api.github.com/users/q42jaap/following{/other_user}","gists_url":"https://api.github.com/users/q42jaap/gists{/gist_id}","starred_url":"https://api.github.com/users/q42jaap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/q42jaap/subscriptions","organizations_url":"https://api.github.com/users/q42jaap/orgs","repos_url":"https://api.github.com/users/q42jaap/repos","events_url":"https://api.github.com/users/q42jaap/events{/privacy}","received_events_url":"https://api.github.com/users/q42jaap/received_events","type":"User","site_admin":false},"performed_via_github_app":null}