{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9279","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9279/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9279/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9279/events","html_url":"https://github.com/elastic/elasticsearch/issues/9279","id":54235336,"node_id":"MDU6SXNzdWU1NDIzNTMzNg==","number":9279,"title":"Remove _analyzer","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":31,"created_at":"2015-01-13T19:20:16Z","updated_at":"2017-06-29T14:31:39Z","closed_at":"2015-01-26T17:16:00Z","author_association":"MEMBER","active_lock_reason":null,"body":"### Background\n\nThe most important thing about specifying analyzers is the analyzer used at index time needs to be basically the same as the analyzer used at query time.  If completely different analyzers were to be used, you would either produce terms that could never be found at query time, or query for terms that could never exist in the index.  The API for specifying analyzers on fields does allow to set index and query analyzers separately.  This is to allow things like synonyms where you may want to only add synonyms at index time (yields cheaper queries later), or just add them within the query (more flexible since synonyms can be changed dynamically).\n### `_analyzer` today\n\nToday we have multiple ways to specify which analyzer will be used on text fields.  At indexing time, the order to check is as follows:\n1. analyzer for the field\n2. `_analyzer` (proposed to remove here)\n3. type level default analyzer (will be removed in #8874)\n4. index level default analyzer\n\n`_analyzer` is a special field in the document which specifies the name of an analyzer to use as the default for that document.  This means that the same field for one document can use a completely different analyzer than another document.  The typical use case for this is working with documents in many languages, where each document contains a field specifying which language its main data is in (e.g. subject and body fields). Then at query time, either a single query is used with a “magic” analyzer over that field, or a conjunction of queries that use every analyzer the data may have been indexed with.\n### Problems with `_analyzer`\n\nThe typical use case for `_analyzer` has many problems:\n- If using the single analyzer at query time approach, the “magic” analyzer is never good enough.  It cannot possibly cover all the terms that may have been produced by each languages' analyzer, so some terms are never matchable.  For example, “die” in German would be a stop word, while the same word in English is simply a regular word.  Either the magic analyzer removes “die” (in which case English documents about dying can not be found) or it includes it, and German documents that contained it can not match (since the indexing process removed that term).\n- Scoring will be skewed. Text relevance models rely on term statistics to weigh the importance of a term for a given document versus the importance of that term for the entire index.  Because some words may analyze to the same term in different languages, the frequencies of terms can be skewed, which will distort where documents matching these words appear in query results.\n- Mappings code is already complicated, and this feature further complicates following the logic of where Analyzers are set in code.\n- Having multiple ways to set the analyzer used at index or query time is also confusing on users, as they have to decide which way is “better”.\n### Proposal\n\nI propose to remove `_analyzer`, and the associated “analyzer” setting of the match query.  Removing this, along with the type level default in #8874 will simplify specifying analyzers considerably.  There would be no loss of end functionality, since better results can be achieved with multiple fields.\n### Alternatives to `_analyzer`\n- One alternative to dealing with multiple languages is to use n-grams. While this can itself be tricky to deal with, it is worth mentioning.\n- An alternative that is more directly in line with the current uses of _analyzer is having one field per language.  This requires slight modifications to client code for indexing (copy data into the field for the appropriate language, instead of specifying the language in a field) and querying (query the appropriate language field, instead of selecting an analyzer for that language.  This will produce better results since documents from other languages cannot accidentally appear in the results, and relevance results should be as expected for that language.\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}