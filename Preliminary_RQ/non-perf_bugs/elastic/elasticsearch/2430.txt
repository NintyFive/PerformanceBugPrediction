{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2430","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2430/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2430/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2430/events","html_url":"https://github.com/elastic/elasticsearch/issues/2430","id":8562099,"node_id":"MDU6SXNzdWU4NTYyMDk5","number":2430,"title":"High cpu spin in IO thread in http_server_worker, not sure what causes it.","user":{"login":"jordansissel","id":131818,"node_id":"MDQ6VXNlcjEzMTgxOA==","avatar_url":"https://avatars1.githubusercontent.com/u/131818?v=4","gravatar_id":"","url":"https://api.github.com/users/jordansissel","html_url":"https://github.com/jordansissel","followers_url":"https://api.github.com/users/jordansissel/followers","following_url":"https://api.github.com/users/jordansissel/following{/other_user}","gists_url":"https://api.github.com/users/jordansissel/gists{/gist_id}","starred_url":"https://api.github.com/users/jordansissel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jordansissel/subscriptions","organizations_url":"https://api.github.com/users/jordansissel/orgs","repos_url":"https://api.github.com/users/jordansissel/repos","events_url":"https://api.github.com/users/jordansissel/events{/privacy}","received_events_url":"https://api.github.com/users/jordansissel/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2012-11-21T23:22:56Z","updated_at":"2013-06-26T16:12:10Z","closed_at":"2013-06-26T15:42:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Observed behavior: elasticsearch was not listening on any http port.\n\nNot sure what the cause is, but I observed http requests to one elasticsearch node failling. Here's some debugging data I was able to gather \n\ntop -H output (Threads, sorted by cpu usage)\n\n```\n  PID USER      PR  NI  VIRT  RES  SHR S %CPU %MEM    TIME+  COMMAND                                               \n18280 elastics  20   0 19.6g 651m 9248 R   97  4.1  93:34.72 java                                                   \n10703 elastics  20   0 19.6g 651m 9248 S    0  4.1   0:00.00 java                                                   \n10710 elastics  20   0 19.6g 651m 9248 S    0  4.1   0:02.62 java                                                   \n10711 elastics  20   0 19.6g 651m 9248 S    0  4.1   0:22.96 java                                                   \n10712 elastics  20   0 19.6g 651m 9248 S    0  4.1   0:22.95 java                                                   \n```\n\npid/thread 18280 == 0x4768\n\nSent 'kill -QUIT' to the elasticsearch process\n\n```\n~# grep -A10 nid=0x4768 /etc/service/elasticsearch/log/current \n2012-11-21_23:11:43.16649 \"elasticsearch[peon8480][http_server_worker][T#26]{New I/O  worker #90}\" daemon prio=10 tid=0x0000030e1c2b7800 nid=0x4768 runnable [0x0000030fb9daf000]\n2012-11-21_23:11:43.16650    java.lang.Thread.State: RUNNABLE\n2012-11-21_23:11:43.16651       at sun.nio.ch.EPollArrayWrapper.epollWait(Native Method)\n2012-11-21_23:11:43.16651       at sun.nio.ch.EPollArrayWrapper.poll(EPollArrayWrapper.java:228)\n2012-11-21_23:11:43.16652       at sun.nio.ch.EPollSelectorImpl.doSelect(EPollSelectorImpl.java:81)\n2012-11-21_23:11:43.16653       at sun.nio.ch.SelectorImpl.lockAndDoSelect(SelectorImpl.java:87)\n2012-11-21_23:11:43.16654       - locked <0x000003101ce5a268> (a sun.nio.ch.Util$2)\n2012-11-21_23:11:43.16654       - locked <0x000003101ce5a250> (a java.util.Collections$UnmodifiableSet)\n2012-11-21_23:11:43.16656       - locked <0x000003101c7b4d48> (a sun.nio.ch.EPollSelectorImpl)\n2012-11-21_23:11:43.16657       at sun.nio.ch.SelectorImpl.select(SelectorImpl.java:98)\n2012-11-21_23:11:43.16658       at org.elasticsearch.common.netty.channel.socket.nio.SelectorUtil.select(SelectorUtil.java:52)\n\n```\n\nstrace data for a 5 second sample:\n\n```\nroot@peon8480:~# timeout  5 strace -c -p 18280\nProcess 18280 attached - interrupt to quit\nProcess 18280 detached\n% time     seconds  usecs/call     calls    errors syscall\n------ ----------- ----------- --------- --------- ----------------\n 34.26    0.000418           0     48339           epoll_wait\n 34.18    0.000417           0     48339           read\n 31.56    0.000385           0     48338           write\n  0.00    0.000000           0        28           futex\n------ ----------- ----------- --------- --------- ----------------\n100.00    0.001220                145044           total\n```\n\nstrace call info\n\n```\n# strace -p 18280 |& head -10\nProcess 18280 attached - interrupt to quit\nwrite(277, \"\\1\", 1)                     = 1\nepoll_wait(269, {{EPOLLIN, {u32=273, u64=12133744393198764305}}}, 8192, 10) = 1\nread(273, \"\\1\", 128)                    = 1\nwrite(277, \"\\1\", 1)                     = 1\nepoll_wait(269, {{EPOLLIN, {u32=273, u64=12133744393198764305}}}, 8192, 10) = 1\nread(273, \"\\1\", 128)                    = 1\nwrite(277, \"\\1\", 1)                     = 1\nepoll_wait(269, {{EPOLLIN, {u32=273, u64=12133744393198764305}}}, 8192, 10) = 1\nread(273, \"\\1\", 128)                    = 1\n```\n\njstack timed out, so I had no hope of attaching jvisualvm to it to see what was going on.\n\nEnvironmental info:\n\n```\n# /proc/18280/exe -version\njava version \"1.7.0_03\"\nOpenJDK Runtime Environment (IcedTea7 2.1.1pre) (7~u3-2.1.1~pre1-1ubuntu2)\nOpenJDK 64-Bit Server VM (build 22.0-b10, mixed mode)\n\n# uname -srm\nLinux 2.6.32.45-grsec-2.2.2-r3 x86_64\n\n# /home/elasticsearch/elasticsearch-0.19.9/bin/elasticsearch -v\nElasticSearch Version: 0.19.9, JVM: 22.0-b10\n```\n\nlsof data:\n\n```\n# lsof -nPi :9200\nCOMMAND   PID     USER   FD   TYPE   DEVICE SIZE/OFF NODE NAME\njava    11940 logstash   31u  IPv4 13046130      0t0  TCP 127.0.0.1:42704->127.0.0.1:9200 (CLOSE_WAIT)\n\n# lsof -nPp 10703 | grep LISTEN\njava    10703 elasticsearch   29u  IPv4 12970639        0t0      TCP *:9300 (LISTEN)\n```\n\ntcpdump:\n\n```\n# tcpdump -nni any 'port 9200'\ntcpdump: verbose output suppressed, use -v or -vv for full protocol decode\nlistening on any, link-type LINUX_SLL (Linux cooked), capture size 65535 bytes\n23:20:11.013451 IP 127.0.0.1.48170 > 127.0.0.1.9200: Flags [S], seq 2376793071, win 32792, options [mss 16396,sackOK,TS val 650110564 ecr 0,nop,wscale 7], length 0\n23:20:11.013476 IP 127.0.0.1.9200 > 127.0.0.1.48170: Flags [R.], seq 0, ack 2376793072, win 0, length 0\n23:20:12.365484 IP 127.0.0.1.48171 > 127.0.0.1.9200: Flags [S], seq 3795810129, win 32792, options [mss 16396,sackOK,TS val 650110902 ecr 0,nop,wscale 7], length 0\n23:20:12.365508 IP 127.0.0.1.9200 > 127.0.0.1.48171: Flags [R.], seq 0, ack 3795810130, win 0, length 0\n23:20:13.717383 IP 127.0.0.1.48172 > 127.0.0.1.9200: Flags [S], seq 2977786653, win 32792, options [mss 16396,sackOK,TS val 650111240 ecr 0,nop,wscale 7], length 0\n23:20:13.717407 IP 127.0.0.1.9200 > 127.0.0.1.48172: Flags [R.], seq 0, ack 2977786654, win 0, length 0\n```\n","closed_by":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"performed_via_github_app":null}