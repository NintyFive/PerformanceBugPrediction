{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3094","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3094/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3094/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3094/events","html_url":"https://github.com/elastic/elasticsearch/issues/3094","id":14766652,"node_id":"MDU6SXNzdWUxNDc2NjY1Mg==","number":3094,"title":"IllegalAccessError when using an MVEL script filter in the query","user":{"login":"connieyang","id":810950,"node_id":"MDQ6VXNlcjgxMDk1MA==","avatar_url":"https://avatars0.githubusercontent.com/u/810950?v=4","gravatar_id":"","url":"https://api.github.com/users/connieyang","html_url":"https://github.com/connieyang","followers_url":"https://api.github.com/users/connieyang/followers","following_url":"https://api.github.com/users/connieyang/following{/other_user}","gists_url":"https://api.github.com/users/connieyang/gists{/gist_id}","starred_url":"https://api.github.com/users/connieyang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/connieyang/subscriptions","organizations_url":"https://api.github.com/users/connieyang/orgs","repos_url":"https://api.github.com/users/connieyang/repos","events_url":"https://api.github.com/users/connieyang/events{/privacy}","received_events_url":"https://api.github.com/users/connieyang/received_events","type":"User","site_admin":false},"labels":[{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2013-05-26T05:21:25Z","updated_at":"2014-03-28T08:33:22Z","closed_at":"2013-08-21T13:59:36Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nWe have a 2-node ES cluster running 0.90.0 release in our QA environment.  When we started using a script filter in our query, we got the following stack trace after a few queries to ES.  After looking into the issue a bit, the issue seemed to be caused by the use of MVEL in compiled or accelerated mode.  Further research seems to indicate that disabling JIT for MVEL worked around the problem (via -Dmvel2.disable.jit=true).\n\nDisabling MVEL JIT would also mean a performance concern for us.  What's root cause of this issue?  How should we address it?\n\nOur QA environment.\n\n<b>OS</b>\nUbuntu 12.10 (GNU/Linux 3.5.0-17-generic x86_64)\n\n<b>Java version, vendor</b>\njava version \"1.7.0_21\"\nOpenJDK Runtime Environment (IcedTea 2.3.9) (7u21-2.3.9-0ubuntu0.12.10.1)\nOpenJDK 64-Bit Server VM (build 23.7-b01, mixed mode)\n\n<b>Script</b>\n\n<pre>\nif(doc['targeting.keys'] == null || doc['targeting.keys'].values.length == 0)\n      return true;\nforeach (kv : doc['targeting.keys'].values) {\n       var found = 0;\n       foreach (qkey : qkeys) {\n            if (kv == qkey) {\n                 found = 1;\n            }\n       }\n       if(found == 0){\n            return false;\n       }\n }\nreturn true;\n</pre>\n\n\n<b>Stack Trace</b>\n\n<pre>\n[2013-05-23 21:04:55,650][DEBUG][action.search.type       ] [Omen] [indexedbuyitem][0], node[-3mMO7JjTKKhIk92AJt_xQ], [R], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@1d5e469d]\n\njava.lang.IllegalAccessError: org/elasticsearch/index/fielddata/ScriptDocValues$Strings$1\n        at ASMAccessorImpl_1471145441369339522430.getValue(Unknown Source)\n        at org.elasticsearch.common.mvel2.optimizers.dynamic.DynamicGetAccessor.getValue(DynamicGetAccessor.java:73)\n        at org.elasticsearch.common.mvel2.ast.ASTNode.getReducedValueAccelerated(ASTNode.java:108)\n        at org.elasticsearch.common.mvel2.ast.BinaryOperation.getReducedValueAccelerated(BinaryOperation.java:108)\n        at org.elasticsearch.common.mvel2.ast.Or.getReducedValueAccelerated(Or.java:34)\n        at org.elasticsearch.common.mvel2.ast.Or.getReducedValueAccelerated(Or.java:34)\n        at org.elasticsearch.common.mvel2.MVELRuntime.execute(MVELRuntime.java:85)\n        at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getDirectValue(CompiledExpression.java:123)\n        at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getValue(CompiledExpression.java:119)\n        at org.elasticsearch.script.mvel.MvelScriptEngineService$MvelSearchScript.run(MvelScriptEngineService.java:192)\n        at org.elasticsearch.index.query.ScriptFilterParser$ScriptFilter$ScriptDocSet.matchDoc(ScriptFilterParser.java:184)\n        at org.elasticsearch.common.lucene.docset.MatchDocIdSet.get(MatchDocIdSet.java:67)\n        at org.apache.lucene.search.FilteredDocIdSet$1.get(FilteredDocIdSet.java:65)\n        at org.elasticsearch.common.lucene.docset.AndDocIdSet$AndBits.get(AndDocIdSet.java:106)\n        at org.elasticsearch.common.lucene.docset.AndDocIdSet$AndBits.get(AndDocIdSet.java:106)\n        at org.elasticsearch.common.lucene.docset.BitsDocIdSetIterator$FilteredIterator.match(BitsDocIdSetIterator.java:59)\n        at org.apache.lucene.search.FilteredDocIdSetIterator.nextDoc(FilteredDocIdSetIterator.java:60)\n        at org.apache.lucene.search.FilteredDocIdSetIterator.nextDoc(FilteredDocIdSetIterator.java:59)\n        at org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.nextDoc(ConstantScoreQuery.java:185)\n        at org.elasticsearch.common.lucene.search.function.FiltersFunctionScoreQuery$CustomBoostFactorScorer.nextDoc(FiltersFunctionScoreQuery.java:283)\n        at org.apache.lucene.search.Scorer.score(Scorer.java:63)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:605)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:156)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:572)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:524)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:501)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:345)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:127)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:239)\n        at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:141)\n        at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:80)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:205)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAction.java:281)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$3.onFailure(TransportSearchTypeAction.java:213)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$2.handleException(SearchServiceTransportAction.j\n</pre>\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}