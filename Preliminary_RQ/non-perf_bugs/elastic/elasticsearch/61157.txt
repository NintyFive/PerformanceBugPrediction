{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157/events","html_url":"https://github.com/elastic/elasticsearch/issues/61157","id":679232239,"node_id":"MDU6SXNzdWU2NzkyMzIyMzk=","number":61157,"title":"[ML] Incorrect mappings on .ml-config index after upgrading to 7.9.0","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-08-14T15:24:54Z","updated_at":"2020-08-19T11:57:34Z","closed_at":"2020-08-19T11:57:34Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"After upgrading to 7.9.0 it is possible for the `.ml-config` index to end up with incorrect mappings.  This is the exception that is seen when this happens:\r\n\r\n```\r\n{\r\n  \"reason\" : \"mapper [model_plot_config.annotations_enabled] cannot be changed from type [keyword] to [boolean]\",\r\n  \"type\" : \"illegal_argument_exception\",\r\n  \"root_cause\" : [ {\r\n    \"reason\" : \"mapper [model_plot_config.annotations_enabled] cannot be changed from type [keyword] to [boolean]\",\r\n    \"type\" : \"illegal_argument_exception\"\r\n  } ]\r\n}\r\n```\r\n\r\nIn the UI it looks like this:\r\n\r\n![image](https://user-images.githubusercontent.com/7405510/90264948-ce19d600-de49-11ea-90ea-39c061fdf083.png)\r\n\r\nThe mappings are supposed to be upgraded automatically when the cluster is upgraded, but there is a loophole that means this doesn't always happen.\r\n\r\n- If after upgrading you open an anomaly detection job before creating or updating a job then you suffer the problem\r\n- If after upgrading you create or update a job before opening an anomaly detection job then you don't suffer the problem\r\n\r\nThe second scenario can also happen programmatically, because when a job persists model state this causes an update to set the model snapshot ID on the job config.\r\n\r\nSo basically if you upgrade your cluster with ML jobs running and leave them running for 3-4 hours after upgrade then the `.ml-config` index mappings get upgraded as required.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}