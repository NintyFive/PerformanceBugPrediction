{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20067","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20067/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20067/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20067/events","html_url":"https://github.com/elastic/elasticsearch/issues/20067","id":172013378,"node_id":"MDU6SXNzdWUxNzIwMTMzNzg=","number":20067,"title":"Scripts can't handle IP fields","user":{"login":"Bargs","id":6239176,"node_id":"MDQ6VXNlcjYyMzkxNzY=","avatar_url":"https://avatars3.githubusercontent.com/u/6239176?v=4","gravatar_id":"","url":"https://api.github.com/users/Bargs","html_url":"https://github.com/Bargs","followers_url":"https://api.github.com/users/Bargs/followers","following_url":"https://api.github.com/users/Bargs/following{/other_user}","gists_url":"https://api.github.com/users/Bargs/gists{/gist_id}","starred_url":"https://api.github.com/users/Bargs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bargs/subscriptions","organizations_url":"https://api.github.com/users/Bargs/orgs","repos_url":"https://api.github.com/users/Bargs/repos","events_url":"https://api.github.com/users/Bargs/events{/privacy}","received_events_url":"https://api.github.com/users/Bargs/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"}],"state":"closed","locked":false,"assignee":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"assignees":[{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2016-08-18T22:12:17Z","updated_at":"2018-02-14T13:23:14Z","closed_at":"2016-08-22T14:08:54Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: master\n\n**Plugins installed**: none\n\n**JVM version**: 1.8.0_60\n\n**OS version**: OSX El Capitan\n\n**Description of the problem including expected versus actual behavior**:\n\nI tried to create a script_field using Painless that accesses an IP type field. ~~I expected to get the `long` representation of the IP but instead ES threw an error. I tried both implicit and explicit typing, but both threw an error.~~ Realized IP fields aren't stored as longs in 5.0, but I'm still wondering how one might access IP values in painless\n\n**Steps to reproduce**:\n1. Create an index with an IP field (makelogs works well)\n2. Issue a query with the following script_field in the request body:\n\n```\n\"script\": {\n  \"inline\": \"return doc['ip'].value;\",\n  \"lang\": \"painless\"\n}\n```\n\n**ES Response**:\n\n```\n{\n  \"error\": {\n    \"root_cause\": [\n      {\n        \"type\": \"script_exception\",\n        \"reason\": \"runtime error\",\n        \"script_stack\": [\n          \"org.apache.lucene.util.UnicodeUtil.UTF8toUTF16(UnicodeUtil.java:596)\",\n          \"org.apache.lucene.util.BytesRef.utf8ToString(BytesRef.java:152)\",\n          \"org.elasticsearch.index.fielddata.ScriptDocValues$Strings.getValue(ScriptDocValues.java:83)\",\n          \"return doc['ip'].value;\",\n          \"                ^---- HERE\"\n        ],\n        \"script\": \"return doc['ip'].value;\",\n        \"lang\": \"painless\"\n      }\n    ],\n    \"type\": \"search_phase_execution_exception\",\n    \"reason\": \"all shards failed\",\n    \"phase\": \"query_fetch\",\n    \"grouped\": true,\n    \"failed_shards\": [\n      {\n        \"shard\": 0,\n        \"index\": \"logstash-0\",\n        \"node\": \"00s71MPnSRenvz6mflLQeQ\",\n        \"reason\": {\n          \"type\": \"script_exception\",\n          \"reason\": \"runtime error\",\n          \"caused_by\": {\n            \"type\": \"array_index_out_of_bounds_exception\",\n            \"reason\": \"16\"\n          },\n          \"script_stack\": [\n            \"org.apache.lucene.util.UnicodeUtil.UTF8toUTF16(UnicodeUtil.java:596)\",\n            \"org.apache.lucene.util.BytesRef.utf8ToString(BytesRef.java:152)\",\n            \"org.elasticsearch.index.fielddata.ScriptDocValues$Strings.getValue(ScriptDocValues.java:83)\",\n            \"return doc['ip'].value;\",\n            \"                ^---- HERE\"\n          ],\n          \"script\": \"return doc['ip'].value;\",\n          \"lang\": \"painless\"\n        }\n      }\n    ],\n    \"caused_by\": {\n      \"type\": \"script_exception\",\n      \"reason\": \"runtime error\",\n      \"caused_by\": {\n        \"type\": \"array_index_out_of_bounds_exception\",\n        \"reason\": \"16\"\n      },\n      \"script_stack\": [\n        \"org.apache.lucene.util.UnicodeUtil.UTF8toUTF16(UnicodeUtil.java:596)\",\n        \"org.apache.lucene.util.BytesRef.utf8ToString(BytesRef.java:152)\",\n        \"org.elasticsearch.index.fielddata.ScriptDocValues$Strings.getValue(ScriptDocValues.java:83)\",\n        \"return doc['ip'].value;\",\n        \"                ^---- HERE\"\n      ],\n      \"script\": \"return doc['ip'].value;\",\n      \"lang\": \"painless\"\n    }\n  },\n  \"status\": 500\n}\n```\n\n**Provide logs (if relevant)**:\n\n```\nINFO - ? - ? - [2016-08-18 18:10:08,747][WARN ][rest.suppressed          ] path: /logstash-*/_search, params: {index=logstash-*}\nINFO - ? - ? - Failed to execute phase [query_fetch], all shards failed; shardFailures {[00s71MPnSRenvz6mflLQeQ][logstash-0][0]: RemoteTransportException[[00s71MP][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: ScriptException[runtime error]; nested: ArrayIndexOutOfBoundsException[16]; }\nINFO - ? - ? - at org.elasticsearch.action.search.AbstractSearchAsyncAction.onFirstPhaseResult(AbstractSearchAsyncAction.java:225)\nINFO - ? - ? - at org.elasticsearch.action.search.AbstractSearchAsyncAction$1.onFailure(AbstractSearchAsyncAction.java:171)\nINFO - ? - ? - at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51)\nINFO - ? - ? - at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:934)\nINFO - ? - ? - at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1035)\nINFO - ? - ? - at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1013)\nINFO - ? - ? - at org.elasticsearch.transport.TransportService$5.onFailure(TransportService.java:528)\nINFO - ? - ? - at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:496)\nINFO - ? - ? - at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\nINFO - ? - ? - at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nINFO - ? - ? - at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nINFO - ? - ? - at java.lang.Thread.run(Thread.java:745)\nINFO - ? - ? - Caused by: RemoteTransportException[[00s71MP][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: ScriptException[runtime error]; nested: ArrayIndexOutOfBoundsException[16];\nINFO - ? - ? - Caused by: ScriptException[runtime error]; nested: ArrayIndexOutOfBoundsException[16];\nINFO - ? - ? - at org.elasticsearch.painless.ScriptImpl.convertToScriptException(ScriptImpl.java:176)\nINFO - ? - ? - at org.elasticsearch.painless.ScriptImpl.run(ScriptImpl.java:123)\nINFO - ? - ? - at org.elasticsearch.search.fetch.script.ScriptFieldsFetchSubPhase.hitExecute(ScriptFieldsFetchSubPhase.java:52)\nINFO - ? - ? - at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:163)\nINFO - ? - ? - at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:369)\nINFO - ? - ? - at org.elasticsearch.search.action.SearchTransportService$SearchQueryFetchTransportHandler.messageReceived(SearchTransportService.java:339)\nINFO - ? - ? - at org.elasticsearch.search.action.SearchTransportService$SearchQueryFetchTransportHandler.messageReceived(SearchTransportService.java:336)\nINFO - ? - ? - at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\nINFO - ? - ? - at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)\nINFO - ? - ? - at org.elasticsearch.transport.TransportService$5.doRun(TransportService.java:517)\nINFO - ? - ? - at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:510)\nINFO - ? - ? - at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\nINFO - ? - ? - at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nINFO - ? - ? - at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nINFO - ? - ? - at java.lang.Thread.run(Thread.java:745)\nINFO - ? - ? - Caused by: java.lang.ArrayIndexOutOfBoundsException: 16\nINFO - ? - ? - at org.apache.lucene.util.UnicodeUtil.UTF8toUTF16(UnicodeUtil.java:596)\nINFO - ? - ? - at org.apache.lucene.util.BytesRef.utf8ToString(BytesRef.java:152)\nINFO - ? - ? - at org.elasticsearch.index.fielddata.ScriptDocValues$Strings.getValue(ScriptDocValues.java:83)\nINFO - ? - ? - at org.elasticsearch.painless.Executable$Script.execute(return doc['ip'].value; @ <inline script>:17)\nINFO - ? - ? - at org.elasticsearch.painless.ScriptImpl.run(ScriptImpl.java:121)\nINFO - ? - ? - ... 13 more\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}