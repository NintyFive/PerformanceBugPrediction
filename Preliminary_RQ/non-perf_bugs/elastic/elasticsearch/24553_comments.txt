[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300014603","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-300014603","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":300014603,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDAxNDYwMw==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-05-08T23:01:07Z","updated_at":"2017-05-08T23:01:07Z","author_association":"CONTRIBUTOR","body":"I'm assigning this to myself because I recognize the elements in the stacktrace but I'm not going to have a look until the at least tomorrow morning.\r\n\r\n@moshe could you post a gist of the entire stack overflow? It is usually useful to have the root.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300085271","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-300085271","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":300085271,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDA4NTI3MQ==","user":{"login":"moshe","id":7490448,"node_id":"MDQ6VXNlcjc0OTA0NDg=","avatar_url":"https://avatars1.githubusercontent.com/u/7490448?v=4","gravatar_id":"","url":"https://api.github.com/users/moshe","html_url":"https://github.com/moshe","followers_url":"https://api.github.com/users/moshe/followers","following_url":"https://api.github.com/users/moshe/following{/other_user}","gists_url":"https://api.github.com/users/moshe/gists{/gist_id}","starred_url":"https://api.github.com/users/moshe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/moshe/subscriptions","organizations_url":"https://api.github.com/users/moshe/orgs","repos_url":"https://api.github.com/users/moshe/repos","events_url":"https://api.github.com/users/moshe/events{/privacy}","received_events_url":"https://api.github.com/users/moshe/received_events","type":"User","site_admin":false},"created_at":"2017-05-09T07:34:25Z","updated_at":"2017-05-09T07:34:25Z","author_association":"NONE","body":"Hi @nik9000, thanks for your quick response.\r\nI didn't got stacktrace in the log file, just the error and then the lots of `isFinite` method call errors.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300263724","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-300263724","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":300263724,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDI2MzcyNA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-05-09T18:43:37Z","updated_at":"2017-05-09T18:43:37Z","author_association":"CONTRIBUTOR","body":"```\r\n  // TODO: not great that this is recursive... in theory a\r\n  // large automata could exceed java's stack\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300269527","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-300269527","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":300269527,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDI2OTUyNw==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-05-09T19:04:19Z","updated_at":"2017-05-09T19:04:19Z","author_association":"CONTRIBUTOR","body":"So reproduced....","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/300715825","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-300715825","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":300715825,"node_id":"MDEyOklzc3VlQ29tbWVudDMwMDcxNTgyNQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-05-11T08:13:00Z","updated_at":"2017-05-11T08:13:00Z","author_association":"MEMBER","body":"@moshe this stack overflow can happen when searching a very big regular expression or when using a syntax for regexp that can lead to an explosion of states. Are you using `query_string` or `regexp` queries ? Are you searching regular expressions explicitely ?\r\nFor instance the following query:\r\n\r\n`````\r\nPOST /test/_search\r\n{\r\n  \"query\": {\r\n    \"regexp\": {\r\n      \"test\": \"t{1,9500}\"\r\n    }\r\n  }\r\n}\r\n`````\r\nfails with a stack overflow error. We have a protection against the explosion of number of states in a non deterministic automaton but for a deterministic one we don't check the size.\r\nThis is a known issue in Lucene:\r\nhttps://issues.apache.org/jira/browse/LUCENE-5659\r\n... but the fix is controversial. Let's check first why you're hitting this.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308606641","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-308606641","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":308606641,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODYwNjY0MQ==","user":{"login":"xgwu","id":10510416,"node_id":"MDQ6VXNlcjEwNTEwNDE2","avatar_url":"https://avatars2.githubusercontent.com/u/10510416?v=4","gravatar_id":"","url":"https://api.github.com/users/xgwu","html_url":"https://github.com/xgwu","followers_url":"https://api.github.com/users/xgwu/followers","following_url":"https://api.github.com/users/xgwu/following{/other_user}","gists_url":"https://api.github.com/users/xgwu/gists{/gist_id}","starred_url":"https://api.github.com/users/xgwu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xgwu/subscriptions","organizations_url":"https://api.github.com/users/xgwu/orgs","repos_url":"https://api.github.com/users/xgwu/repos","events_url":"https://api.github.com/users/xgwu/events{/privacy}","received_events_url":"https://api.github.com/users/xgwu/received_events","type":"User","site_admin":false},"created_at":"2017-06-15T01:56:27Z","updated_at":"2017-06-15T01:56:27Z","author_association":"NONE","body":"One of our production cluster experienced the same issue recently due to the abuse of regex/fuzzy queries by developers, but could it be better for Elasticsearch (or maybe Lucene) to set a limit like that on non deterministic automaton, such that the cluster won't be entirely brought down?\r\n\r\nThanks!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308652266","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-308652266","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":308652266,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODY1MjI2Ng==","user":{"login":"xgwu","id":10510416,"node_id":"MDQ6VXNlcjEwNTEwNDE2","avatar_url":"https://avatars2.githubusercontent.com/u/10510416?v=4","gravatar_id":"","url":"https://api.github.com/users/xgwu","html_url":"https://github.com/xgwu","followers_url":"https://api.github.com/users/xgwu/followers","following_url":"https://api.github.com/users/xgwu/following{/other_user}","gists_url":"https://api.github.com/users/xgwu/gists{/gist_id}","starred_url":"https://api.github.com/users/xgwu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xgwu/subscriptions","organizations_url":"https://api.github.com/users/xgwu/orgs","repos_url":"https://api.github.com/users/xgwu/repos","events_url":"https://api.github.com/users/xgwu/events{/privacy}","received_events_url":"https://api.github.com/users/xgwu/received_events","type":"User","site_admin":false},"created_at":"2017-06-15T07:30:22Z","updated_at":"2017-06-15T07:39:51Z","author_association":"NONE","body":"After more in-depth investigation, our particular issue was found being caused by prefix query on a very long query string.  By looking at source code,  I see PrefixQuery does not put a limit on maxDeterminizedStates when instantiate an AutomatonQuery.  \r\n``` \r\npublic class PrefixQuery extends AutomatonQuery {\r\n\r\n  /** Constructs a query for terms starting with <code>prefix</code>. */\r\n  public PrefixQuery(Term prefix) {\r\n    // It's OK to pass unlimited maxDeterminizedStates: the automaton is born small and determinized:\r\n    super(prefix, toAutomaton(prefix.bytes()), Integer.MAX_VALUE, true);\r\n    if (prefix == null) {\r\n      throw new NullPointerException(\"prefix must not be null\");\r\n    }\r\n  }\r\n\r\n```\r\n\r\nIs it sensible to limit prefix length & maxDeterminizedStates here?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308657261","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-308657261","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":308657261,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODY1NzI2MQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-06-15T07:54:20Z","updated_at":"2017-06-15T07:54:20Z","author_association":"MEMBER","body":"Thanks for the investigation @xgwu . The automaton is already determinized so the `maxDeterminizedStates` would not catch very long string here. I think the fix is to limit the input on the ES side for queries that uses an automaton. This would not catch regex query like `t{1,9500}` but I have the feeling that most of the problems described in this issue are just about very long strings not filtered.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/308752860","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-308752860","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":308752860,"node_id":"MDEyOklzc3VlQ29tbWVudDMwODc1Mjg2MA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-06-15T14:36:29Z","updated_at":"2017-06-15T14:36:29Z","author_association":"CONTRIBUTOR","body":"I still think the fix is to put protections in Lucene to prevent the stackoverflow or to rewrite the method so it isn't recursive. I don't think we can allow any queries to shoot the node like this. We could catch the StackOverflow and try to recover but I believe those errors are like OOM, hard to be sure that you've fully recovered from it. If we investigate that to the point where we are sure we have recovered from it then we can just catch it and Lucene doesn't have to change.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/312213907","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-312213907","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":312213907,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMjIxMzkwNw==","user":{"login":"hbrxa","id":29794026,"node_id":"MDQ6VXNlcjI5Nzk0MDI2","avatar_url":"https://avatars1.githubusercontent.com/u/29794026?v=4","gravatar_id":"","url":"https://api.github.com/users/hbrxa","html_url":"https://github.com/hbrxa","followers_url":"https://api.github.com/users/hbrxa/followers","following_url":"https://api.github.com/users/hbrxa/following{/other_user}","gists_url":"https://api.github.com/users/hbrxa/gists{/gist_id}","starred_url":"https://api.github.com/users/hbrxa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hbrxa/subscriptions","organizations_url":"https://api.github.com/users/hbrxa/orgs","repos_url":"https://api.github.com/users/hbrxa/repos","events_url":"https://api.github.com/users/hbrxa/events{/privacy}","received_events_url":"https://api.github.com/users/hbrxa/received_events","type":"User","site_admin":false},"created_at":"2017-06-30T08:54:36Z","updated_at":"2017-06-30T08:54:36Z","author_association":"NONE","body":"We filter long strings and do not use regex queries like mentioned above. We have no idea which query produces this error but it kills elastic several times a day. Any clue what kind of query shoots the node? Would be great if this bug could be fixed as soon as possible.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/312247490","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-312247490","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":312247490,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMjI0NzQ5MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-06-30T11:50:12Z","updated_at":"2017-06-30T11:50:12Z","author_association":"CONTRIBUTOR","body":"@hbrxa it sounds like you are suffering from a different bug. please open a new issue with all of the relevant details.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317250768","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-317250768","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":317250768,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzI1MDc2OA==","user":{"login":"segalziv","id":9026326,"node_id":"MDQ6VXNlcjkwMjYzMjY=","avatar_url":"https://avatars1.githubusercontent.com/u/9026326?v=4","gravatar_id":"","url":"https://api.github.com/users/segalziv","html_url":"https://github.com/segalziv","followers_url":"https://api.github.com/users/segalziv/followers","following_url":"https://api.github.com/users/segalziv/following{/other_user}","gists_url":"https://api.github.com/users/segalziv/gists{/gist_id}","starred_url":"https://api.github.com/users/segalziv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/segalziv/subscriptions","organizations_url":"https://api.github.com/users/segalziv/orgs","repos_url":"https://api.github.com/users/segalziv/repos","events_url":"https://api.github.com/users/segalziv/events{/privacy}","received_events_url":"https://api.github.com/users/segalziv/received_events","type":"User","site_admin":false},"created_at":"2017-07-23T12:49:13Z","updated_at":"2017-07-23T13:30:55Z","author_association":"NONE","body":"+1 \r\n\r\nWe had a similar issue (on v5.3.0) , coming from kibana users running a simple regex. The regex doesn't even have to really run as search in order to cause the StackOverflowException - just running _validate on such a query cause the same issue. \r\n\r\nTo reproduce it just type in kibana's Discover: \r\n\r\n`/.{10000,}/`\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323716504","html_url":"https://github.com/elastic/elasticsearch/issues/24553#issuecomment-323716504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24553","id":323716504,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzcxNjUwNA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-08-21T11:10:27Z","updated_at":"2017-08-21T11:10:27Z","author_association":"MEMBER","body":"This issue has been fixed in Lucene:\r\nhttps://issues.apache.org/jira/browse/LUCENE-7914\r\n... and will be available in es 6.0\r\nThe workaround for es 5.x is to check the size of the prefix on the client side in order to prevent the stack overflow (something like a few hundreds chars should be a good limit).","performed_via_github_app":null}]