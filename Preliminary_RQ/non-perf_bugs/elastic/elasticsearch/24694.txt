{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24694","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24694/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24694/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24694/events","html_url":"https://github.com/elastic/elasticsearch/issues/24694","id":228881227,"node_id":"MDU6SXNzdWUyMjg4ODEyMjc=","number":24694,"title":"Arrays of geo_points mess up geohash_grid with geo_centroid","user":{"login":"trevan","id":2044248,"node_id":"MDQ6VXNlcjIwNDQyNDg=","avatar_url":"https://avatars2.githubusercontent.com/u/2044248?v=4","gravatar_id":"","url":"https://api.github.com/users/trevan","html_url":"https://github.com/trevan","followers_url":"https://api.github.com/users/trevan/followers","following_url":"https://api.github.com/users/trevan/following{/other_user}","gists_url":"https://api.github.com/users/trevan/gists{/gist_id}","starred_url":"https://api.github.com/users/trevan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/trevan/subscriptions","organizations_url":"https://api.github.com/users/trevan/orgs","repos_url":"https://api.github.com/users/trevan/repos","events_url":"https://api.github.com/users/trevan/events{/privacy}","received_events_url":"https://api.github.com/users/trevan/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-05-16T00:15:48Z","updated_at":"2017-08-18T13:40:33Z","closed_at":"2017-08-18T13:40:33Z","author_association":"NONE","active_lock_reason":null,"body":"I noticed that the Kibana tilemap visualization using the geo_centroid feature would cause \"incorrect\" points to be displayed.  I think I tracked it down to a minimal test case:\r\n\r\nCreate and populate the test index\r\n```\r\ncurl -H\"Content-Type:application/json\" -XPUT localhost:9200/geo_test -d '{\"mappings\": {\"geo\": {\"properties\": {\"geohash-geo\": {\"type\": \"geo_point\"}}}}}'\r\ncurl -H\"Content-Type:application/json\" -XPOST localhost:9200/geo_test/geo -d '{\"geohash-geo\" : [ \"drt2v2d0pdue\", \"gc7x3w1cwgjy\" ], \"data\": [\"data\"]}'\r\n```\r\n\r\nRequest a geohash_grid aggregation with a geo_centroid sub metric:\r\n```\r\ncurl -H\"Content-Type:application/json\" -XPOST 'localhost:9200/geo_test/_search?pretty' -d '{\"size\":0,\"query\":{\"query_string\":{\"query\":\"*\",\"analyze_wildcard\":true}},\"_source\":{\"excludes\":[]},\"aggs\":{\"2\":{\"geohash_grid\":{\"field\":\"geohash-geo\",\"precision\":2},\"aggs\":{\"3\":{\"geo_centroid\":{\"field\":\"geohash-geo\"}}}}}}'\r\n```\r\n\r\nThe result is:\r\n```\r\n{\r\n  \"took\" : 1,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 0.0,\r\n    \"hits\" : [ ]\r\n  },\r\n  \"aggregations\" : {\r\n    \"2\" : {\r\n      \"buckets\" : [\r\n        {\r\n          \"key\" : \"gc\",\r\n          \"doc_count\" : 1,\r\n          \"3\" : {\r\n            \"location\" : {\r\n              \"lat\" : 47.83049770630896,\r\n              \"lon\" : -38.696453254669905\r\n            },\r\n            \"count\" : 2\r\n          }\r\n        },\r\n        {\r\n          \"key\" : \"dr\",\r\n          \"doc_count\" : 1,\r\n          \"3\" : {\r\n            \"location\" : {\r\n              \"lat\" : 47.83049770630896,\r\n              \"lon\" : -38.696453254669905\r\n            },\r\n            \"count\" : 2\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIt returned with two cells but both have the same geo_centroid location that is midway between the two cells.  I would have expected the location to be contained within the cells.\r\n\r\nThis was seen both in ES 2.3 and a 6.0 build from the end of April.\r\n\r\nEdited to shrink and improve the test case.","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}