[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394239996","html_url":"https://github.com/elastic/elasticsearch/issues/30057#issuecomment-394239996","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30057","id":394239996,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDIzOTk5Ng==","user":{"login":"adhulipa","id":4305228,"node_id":"MDQ6VXNlcjQzMDUyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/4305228?v=4","gravatar_id":"","url":"https://api.github.com/users/adhulipa","html_url":"https://github.com/adhulipa","followers_url":"https://api.github.com/users/adhulipa/followers","following_url":"https://api.github.com/users/adhulipa/following{/other_user}","gists_url":"https://api.github.com/users/adhulipa/gists{/gist_id}","starred_url":"https://api.github.com/users/adhulipa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adhulipa/subscriptions","organizations_url":"https://api.github.com/users/adhulipa/orgs","repos_url":"https://api.github.com/users/adhulipa/repos","events_url":"https://api.github.com/users/adhulipa/events{/privacy}","received_events_url":"https://api.github.com/users/adhulipa/received_events","type":"User","site_admin":false},"created_at":"2018-06-04T05:42:26Z","updated_at":"2018-06-04T05:43:23Z","author_association":"CONTRIBUTOR","body":"@dakrone, @spinscale  I'm pinging you directly because I noticed that you edited this file most recently ([in march](https://github.com/elastic/elasticsearch/commit/2147d217df8039d10e53317ff36d5e6368a67a09), and [february](https://github.com/elastic/elasticsearch/commit/c9d77d20fdb8a46b614515555d5d0697b2c6e5fc)) & I believe you may have the most context about the issue. Also, I'd like to contribute a patch here and wanted to make sure I'm reaching out to the relevant people to give me the go-ahead ðŸ˜„ \r\n\r\n#### Root cause\r\nThe root cause is a `NullPointerException` when `xContentType` is `null` in the `parse()` method in [`WatchParser.java:113`](https://github.com/elastic/elasticsearch/blob/72f57c8e72500cb27dc69e902edf5cd270249c14/x-pack/plugin/watcher/src/main/java/org/elasticsearch/xpack/watcher/watch/WatchParser.java#L113).\r\n\r\nShould the fix just be a matter of a `null` check within the method definition or should we handle `XContentType` being null everywhere else too?\r\n\r\n`XContentType` is null within the request when the `\"Content-Type\"` header parameter is not present in the request. \r\n\r\n#### Repro steps\r\nI reproduced this by running a couple of `curl` requests on my local build of es:\r\n\r\n#####  `#f03c15` Input without `Content-Type`:\r\n```\r\ncurl -XPOST 'elastic-admin:elastic-password@localhost:9200/_xpack/watcher/watch/my_watch' | jq\r\n```\r\n##### `#f03c15` Output with `NPE`:\r\n```\r\n# Aditya at Adityas-MacBook-Pro.local in ~/Projects/elastic/downloads/kibana-7.0.0-alpha1-SNAPSHOT-darwin-x86_64  [22:17:17]\r\nÎ» curl -XPOST 'elastic-admin:elastic-password@localhost:9200/_xpack/watcher/watch/my_watch' | jq\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100   133  100   133    0     0     31      0  0:00:04  0:00:04 --:--:--    31\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"null_pointer_exception\",\r\n        \"reason\": null\r\n      }\r\n    ],\r\n    \"type\": \"null_pointer_exception\",\r\n    \"reason\": null\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n######  `#c5f015` Input with `Content-Type`:\r\n```\r\ncurl -XPOST -H \"Content-Type: application/json\" 'elastic-admin:elastic-password@localhost:9200/_xpack/watcher/watch/my_watch' | jq\r\n```\r\n######  `#c5f015` Output with no `NPE`:\r\n```\r\n# Aditya at Adityas-MacBook-Pro.local in ~/Projects/elastic/downloads/kibana-7.0.0-alpha1-SNAPSHOT-darwin-x86_64  [22:16:04]\r\nÎ» curl -XPOST -H \"Content-Type: application/json\" 'elastic-admin:elastic-password@localhost:9200/_xpack/watcher/watch/my_watch' | jq\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100   203  100   203    0     0      3      0  0:01:07  0:00:57  0:00:10    41\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"parse_exception\",\r\n        \"reason\": \"could not parse watch [my_watch]. null token\"\r\n      }\r\n    ],\r\n    \"type\": \"parse_exception\",\r\n    \"reason\": \"could not parse watch [my_watch]. null token\"\r\n  },\r\n  \"status\": 400\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394340963","html_url":"https://github.com/elastic/elasticsearch/issues/30057#issuecomment-394340963","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30057","id":394340963,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDM0MDk2Mw==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2018-06-04T12:42:23Z","updated_at":"2018-06-04T12:42:23Z","author_association":"MEMBER","body":"I think we should check in the `PutWatchRequest.validate()` method for the existence of this, so we catch this issue in the transport and in the REST layer. This would catch this issue early on, and we can rely in the watch parser that this value is not null.\r\n\r\nIf you want to give it a try, feel free and go ahead!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394579062","html_url":"https://github.com/elastic/elasticsearch/issues/30057#issuecomment-394579062","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30057","id":394579062,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDU3OTA2Mg==","user":{"login":"adhulipa","id":4305228,"node_id":"MDQ6VXNlcjQzMDUyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/4305228?v=4","gravatar_id":"","url":"https://api.github.com/users/adhulipa","html_url":"https://github.com/adhulipa","followers_url":"https://api.github.com/users/adhulipa/followers","following_url":"https://api.github.com/users/adhulipa/following{/other_user}","gists_url":"https://api.github.com/users/adhulipa/gists{/gist_id}","starred_url":"https://api.github.com/users/adhulipa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adhulipa/subscriptions","organizations_url":"https://api.github.com/users/adhulipa/orgs","repos_url":"https://api.github.com/users/adhulipa/repos","events_url":"https://api.github.com/users/adhulipa/events{/privacy}","received_events_url":"https://api.github.com/users/adhulipa/received_events","type":"User","site_admin":false},"created_at":"2018-06-05T04:37:19Z","updated_at":"2018-06-05T06:02:53Z","author_association":"CONTRIBUTOR","body":"Hi @spinscale \r\nI made a fix and tested it out locally:\r\n```\r\nÎ» curl -XPOST 'elastic-admin:elastic-password@localhost:9200/_xpack/watcher/watch/my_watch' | jq\r\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\r\n                                 Dload  Upload   Total   Spent    Left  Speed\r\n100   247  100   247    0     0  29429      0 --:--:-- --:--:-- --:--:-- 30875\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"action_request_validation_exception\",\r\n        \"reason\": \"Validation Failed: 1: Content-Type is missing;\"\r\n      }\r\n    ],\r\n    \"type\": \"action_request_validation_exception\",\r\n    \"reason\": \"Validation Failed: 1: Content-Type is missing;\"\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nBut the tests `./gradlew check` are taking a long time. It's been running for 30mins and has completed only 12%. Is that expected?\r\n\r\nI didn't see any specific tests for `PutWatchRequest`. Should I create a new test file for this file or am I missing something?\r\n\r\nAlso, I opened a [pull request](https://github.com/elastic/elasticsearch/pull/31088) of what I have so far just so that I can get a sense of if I'm doing it correctly or not. \r\n\r\nLooking forward to your feedback. Thanks for all your help! :)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394666018","html_url":"https://github.com/elastic/elasticsearch/issues/30057#issuecomment-394666018","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30057","id":394666018,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDY2NjAxOA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-06-05T10:51:42Z","updated_at":"2018-06-05T10:51:42Z","author_association":"MEMBER","body":"> But the tests ./gradlew check are taking a long time. It's been running for 30mins and has completed only 12%. Is that expected?\r\n\r\nUnfortunaltely running the whole test suite takes quiet long now. It is possible to run the tests for only part of the project though, in your case the changes are in the \"x-pack\" module, so running `./gradlew gradle :x-pack:plugin:check` or maybe even only `./gradlew gradle :x-pack:plugin:watcher:check` should be a good start in this case. We run full CI tests on PRs later anyway that might catch other issues.\r\n\r\n> I didn't see any specific tests for PutWatchRequest. Should I create a new test file for this file or am I missing something?\r\n\r\nI think you are correct, I couldn't find any tests yet. Would be great to start with one then, I will comment on the PR.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394917041","html_url":"https://github.com/elastic/elasticsearch/issues/30057#issuecomment-394917041","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30057","id":394917041,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDkxNzA0MQ==","user":{"login":"adhulipa","id":4305228,"node_id":"MDQ6VXNlcjQzMDUyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/4305228?v=4","gravatar_id":"","url":"https://api.github.com/users/adhulipa","html_url":"https://github.com/adhulipa","followers_url":"https://api.github.com/users/adhulipa/followers","following_url":"https://api.github.com/users/adhulipa/following{/other_user}","gists_url":"https://api.github.com/users/adhulipa/gists{/gist_id}","starred_url":"https://api.github.com/users/adhulipa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adhulipa/subscriptions","organizations_url":"https://api.github.com/users/adhulipa/orgs","repos_url":"https://api.github.com/users/adhulipa/repos","events_url":"https://api.github.com/users/adhulipa/events{/privacy}","received_events_url":"https://api.github.com/users/adhulipa/received_events","type":"User","site_admin":false},"created_at":"2018-06-06T02:10:03Z","updated_at":"2018-06-06T02:10:03Z","author_association":"CONTRIBUTOR","body":"Hey @cbuescher , I'm having trouble with the integ tests. \r\nIs this correct? -> running `./gradlew :x-pack:plugin:watcher:integTest` will only run the integTests for `watcher` plugin which are defined in `elasticsearch/x-pack/plugin/src/test/resources/rest-api-spec/test/watcher/`\r\n\r\nHow can I intentionally break an integ test to understand how the integration tests work?\r\nFor example, I'm changing the `line 50` from `        id: \"my_watch\"\r\n` to `        id: \"not_any_at_all_my_watch\"\r\n` in `watcher/put_watch/70_put_watch_with_index_action_using_id.yml` and calling `./gradlew :x-pack:plugin:watcher:integTest`. Then I should expect a FAILURE, right?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/395005205","html_url":"https://github.com/elastic/elasticsearch/issues/30057#issuecomment-395005205","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30057","id":395005205,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NTAwNTIwNQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-06-06T09:25:42Z","updated_at":"2018-06-06T09:25:42Z","author_association":"MEMBER","body":"> running ./gradlew :x-pack:plugin:watcher:integTest will only run the integTests for watcher plugin which are defined in elasticsearch/x-pack/plugin/src/test/resources/rest-api-spec/test/watcher/\r\n\r\nI would have thought so, but the change that you mentioned doesn't fail, so I guess you either need to run all x-pack tests (\" ./gradlew :x-pack:plugin:integTest\"), but I think you can also filter out only the watcher tests, but then the incantation gets slightly more verbose. Try:\r\n\r\n```\r\n./gradlew :x-pack:plugin:integTestRunner -Dtests.class=org.elasticsearch.xpack.test.rest.XPackRestIT -Dtests.method=\"test {p0=watcher/*}\"\r\n```\r\n\r\nThat seems to work on my machine to run only the watcher tests and will fail with the modification you described above. You can find a little bit more information about the structure of the test files in a somewhat hidden README in `/rest-api-spec/src/main/resources/rest-api-spec/test/README.asciidoc`\r\nIn your special case I think you expect exceptions, so you should take a look at the `catch` clauses in some of the tests. Hope this helps, otherwise don't hesitate to ping me again.","performed_via_github_app":null}]