[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/481488102","html_url":"https://github.com/elastic/elasticsearch/issues/41047#issuecomment-481488102","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41047","id":481488102,"node_id":"MDEyOklzc3VlQ29tbWVudDQ4MTQ4ODEwMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-04-10T00:26:29Z","updated_at":"2019-04-10T00:26:29Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/490039644","html_url":"https://github.com/elastic/elasticsearch/issues/41047#issuecomment-490039644","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41047","id":490039644,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MDAzOTY0NA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-05-07T11:25:41Z","updated_at":"2019-05-07T11:25:41Z","author_association":"CONTRIBUTOR","body":"What happens here is that there is a master node and a data-only node forming a cluster. The master is then restarted and its data folder wiped (and re-bootstrapped), which means that after the restart, the master should form a cluster by itself without the data node and should not let the data node join because of cluster uuid join validation. Unfortunately the condition `internalCluster().client(masterNode).admin().cluster().prepareHealth().setWaitForNodes(\"2\").get()` successfully returns, because the data node joins while the master is still not fully established as master just yet and bypasses the join validation that is done before adding the node to the cluster. Only the join validation when handling the publish request takes place, but at this point the cluster state has been successfully committed, and will subsequently be exposed to the applier. The health check therefore sees the cluster state with the 2 nodes and thinks all is good, even though the data node never accepted this state. What's worse is that it takes 90 seconds for the data node to be kicked out of the cluster (lag detection).\r\n\r\nLogs analyzed: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=ubuntu-14.04&&immutable/324/consoleText\r\n\r\nWe could fix the test by first taking down the data-only node, then restart and wipe the master node, and bringing the data node back up after the master has successfully formed its 1-node cluster. I don't think we should complicate the join validation logic to handle this case differently, given how rare it might happen. WDYT @DaveCTurner ?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/490055502","html_url":"https://github.com/elastic/elasticsearch/issues/41047#issuecomment-490055502","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41047","id":490055502,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MDA1NTUwMg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-05-07T12:18:42Z","updated_at":"2019-05-07T12:18:42Z","author_association":"CONTRIBUTOR","body":"I agree that this doesn't indicate an issue in production code, because it should resolve itself eventually (after 90 seconds). However I think it'd be good to check that it does indeed resolve itself eventually even if we get into this state. Can we reduce `cluster.follower_lag.timeout` to a shorter time and use `assertBusy()` to wait for the lag detector to take effect?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/490065337","html_url":"https://github.com/elastic/elasticsearch/issues/41047#issuecomment-490065337","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41047","id":490065337,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MDA2NTMzNw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-05-07T12:49:21Z","updated_at":"2019-05-07T12:49:21Z","author_association":"CONTRIBUTOR","body":"sure, do you want to make that change?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/494784096","html_url":"https://github.com/elastic/elasticsearch/issues/41047#issuecomment-494784096","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41047","id":494784096,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NDc4NDA5Ng==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-05-22T12:37:56Z","updated_at":"2019-05-22T12:37:56Z","author_association":"CONTRIBUTOR","body":"I've pushed 250973a as a fix","performed_via_github_app":null}]