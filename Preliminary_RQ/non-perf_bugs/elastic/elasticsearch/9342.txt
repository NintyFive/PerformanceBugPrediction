{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9342","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9342/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9342/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9342/events","html_url":"https://github.com/elastic/elasticsearch/issues/9342","id":54662586,"node_id":"MDU6SXNzdWU1NDY2MjU4Ng==","number":9342,"title":"Inner-field indexing problem through the bulk API","user":{"login":"lazdmx","id":1035026,"node_id":"MDQ6VXNlcjEwMzUwMjY=","avatar_url":"https://avatars1.githubusercontent.com/u/1035026?v=4","gravatar_id":"","url":"https://api.github.com/users/lazdmx","html_url":"https://github.com/lazdmx","followers_url":"https://api.github.com/users/lazdmx/followers","following_url":"https://api.github.com/users/lazdmx/following{/other_user}","gists_url":"https://api.github.com/users/lazdmx/gists{/gist_id}","starred_url":"https://api.github.com/users/lazdmx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lazdmx/subscriptions","organizations_url":"https://api.github.com/users/lazdmx/orgs","repos_url":"https://api.github.com/users/lazdmx/repos","events_url":"https://api.github.com/users/lazdmx/events{/privacy}","received_events_url":"https://api.github.com/users/lazdmx/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-01-17T14:02:15Z","updated_at":"2015-01-19T19:47:59Z","closed_at":"2015-01-19T19:47:59Z","author_association":"NONE","active_lock_reason":null,"body":"I have a problem with object's inner-field indexing though bulk API. Simply I cannot get it (inner-field) indexed properly iff part of its name is equals to other type.\n\nSo there is a script to reproduce an error:\n\n``` shell\necho \"Remove test index and add a new one\"\ncurl -X DELETE http://localhost:9200/test\ncurl -X POST http://localhost:9200/test\n\n\necho \"Put mappings\"\ncurl -X PUT http://localhost:9200/test/_mapping/sometype -d '\n  {\n    \"_all\": {\n      \"enabled\": false\n    },\n    \"_source\": {\n      \"includes\": [\n        \"othertype.id\"\n      ]\n    },\n    \"dynamic\": false,\n    \"properties\": {\n      \"othertype\": {\n        \"type\": \"object\",\n        \"dinamic\": false,\n        \"properties\": {\n          \"id\": {\n            \"type\": \"string\",\n            \"index\": \"not_analyzed\",\n            \"include_in_all\": false\n          }\n        }\n      }\n    }\n  }\n'\n\necho \"Put data\"\ncurl -X POST http://localhost:9200/_bulk?refresh=true -d '\n  {\"index\":{\"_id\":\"c1\",\"_type\":\"othertype\",\"_index\":\"test\"}}\n  {\"someref\":{\"id\":\"12345\"}}\n  {\"index\":{\"_id\":\"s1\",\"_type\":\"sometype\",\"_index\":\"test\"}}\n  {\"othertype\":{\"id\":\"c1\"}}\n'\n\n\necho \"Getting data\"\ncurl -X POST http://localhost:9200/test/_search?pretty -d '\n  {\n    \"query\":{\n      \"filtered\": {\n        \"filter\": {\n          \"type\":{\n            \"value\": \"sometype\"\n          }\n        }\n      }\n    },\n    \"script_fields\":{\n      \"terms\":{\n        \"script\":\"doc[field].values\",\n        \"params\":{\n          \"field\":\"othertype.id\"\n        }\n      }\n    }\n  }\n'\n```\n\nFinal output is:\n\n```\n{\n  \"took\" : 1,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"test\",\n      \"_type\" : \"sometype\",\n      \"_id\" : \"s1\",\n      \"_score\" : 1.0,\n      \"fields\" : {\n        \"terms\" : [ [ ] ] #<---- It shouldn't be empty\n      }\n    } ]\n  }\n}\n```\n\nAs you can see, we have a document of type `sometype` but the `othertype.id` field doesn't have any tokens. But if you modify an bulk-data and just rename type `othertype -> othertype2` or `\"someref\":{\"id\":\"12345\"} -> \"someref\": \"12345\"` in first action of bulk op, everything becomes well.\n\nThat is change:\n\n``` bash\ncurl -X POST http://localhost:9200/_bulk?refresh=true -d '\n  {\"index\":{\"_id\":\"c1\",\"_type\":\"othertype\",\"_index\":\"test\"}}\n  {\"someref\":{\"id\":\"12345\"}}\n  {\"index\":{\"_id\":\"s1\",\"_type\":\"sometype\",\"_index\":\"test\"}}\n  {\"othertype\":{\"id\":\"c1\"}}\n'\n```\n\ninto\n\n``` bash\ncurl -X POST http://localhost:9200/_bulk?refresh=true -d '\n  {\"index\":{\"_id\":\"c1\",\"_type\":\"othertype2\",\"_index\":\"test\"}}\n  {\"someref\":{\"id\":\"12345\"}}\n  {\"index\":{\"_id\":\"s1\",\"_type\":\"sometype\",\"_index\":\"test\"}}\n  {\"othertype\":{\"id\":\"c1\"}}\n'\n```\n\nor into\n\n``` bash\ncurl -X POST http://localhost:9200/_bulk?refresh=true -d '\n  {\"index\":{\"_id\":\"c1\",\"_type\":\"othertype\",\"_index\":\"test\"}}\n  {\"someref\": \"12345\"}\n  {\"index\":{\"_id\":\"s1\",\"_type\":\"sometype\",\"_index\":\"test\"}}\n  {\"othertype\":{\"id\":\"c1\"}}\n'\n```\n\nyou will get expected results\n\n```\n{\n  \"took\" : 2,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"test\",\n      \"_type\" : \"sometype\",\n      \"_id\" : \"s1\",\n      \"_score\" : 1.0,\n      \"fields\" : {\n        \"terms\" : [ [ \"c1\" ] ]\n      }\n    } ]\n  }\n}\n```\n\n---\n\nElasticsearch `Version: 1.4.2, Build: 927caff/2014-12-16T14:11:12Z, JVM: 1.8.0_25`\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}