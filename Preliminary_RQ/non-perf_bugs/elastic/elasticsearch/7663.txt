{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7663","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7663/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7663/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7663/events","html_url":"https://github.com/elastic/elasticsearch/issues/7663","id":42317535,"node_id":"MDU6SXNzdWU0MjMxNzUzNQ==","number":7663,"title":"geo_shape query/filter: indexed_shape has no syntax to define _routing value and throws RoutingMissingException, because _routing undefined","user":{"login":"helllamer","id":681744,"node_id":"MDQ6VXNlcjY4MTc0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/681744?v=4","gravatar_id":"","url":"https://api.github.com/users/helllamer","html_url":"https://github.com/helllamer","followers_url":"https://api.github.com/users/helllamer/followers","following_url":"https://api.github.com/users/helllamer/following{/other_user}","gists_url":"https://api.github.com/users/helllamer/gists{/gist_id}","starred_url":"https://api.github.com/users/helllamer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/helllamer/subscriptions","organizations_url":"https://api.github.com/users/helllamer/orgs","repos_url":"https://api.github.com/users/helllamer/repos","events_url":"https://api.github.com/users/helllamer/events{/privacy}","received_events_url":"https://api.github.com/users/helllamer/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2014-09-09T15:16:43Z","updated_at":"2018-05-23T19:15:20Z","closed_at":"2018-05-23T19:15:20Z","author_association":"NONE","active_lock_reason":null,"body":"Currently, GeoShape filter and query supports to pre-indexed shape as argument[1].\nBut, there are no way to define required `_routing` value for pre-indexed shape. This causes RoutingMissingException if routing is mandatory.\n\nelasticsearch version 1.3.2\n\nFor example, mapping is:\n\n```\ncurl -XPOST 'localhost:9200/-inx/ang/_mapping' -d'{\n  \"ang\" : {\n    \"_parent\" : {\n      \"type\" : \"someType\"\n    },\n    \"_routing\" : {\n      \"required\" : true\n    },\n    \"properties\" : {\n      \"to\" : {\n        \"type\" : \"geo_shape\",\n        \"tree_levels\" : 6\n      }\n    }\n  }\n}'\n```\n\nAdd some data:\n\n```\ncurl -XPUT 'localhost:9200/-inx/ang/ouX6eeH5RxKQG3vJ5Ho84A?parent=111' -d '{\n    \"to\" : {\n        \"type\" : \"circle\",\n        \"coordinates\" : [-45.0, 45.0],\n        \"radius\" : \"100m\"\n    }\n}'\n```\n\nLet's make a query:\n\n```\ncurl -XGET 'localhost:9200/_search' -d'{\n  \"query\" : {\n    \"geo_shape\" : {\n      \"to\" : {\n        \"indexed_shape\" : {\n          \"type\" : \"ang\",\n          \"index\" : \"-inx\",\n          \"path\" : \"to\",\n          \"id\" : \"ouX6eeH5RxKQG3vJ5Ho84A\"\n        }\n      }\n    }\n  }\n}'\n```\n\n```\norg.elasticsearch.action.search.SearchPhaseExecutionException: Failed to execute phase [query_fetch], all shards failed; shardFailures {[eryGHbZWSMa-YJiCpgVbcg][-inx][0]: \nRemoteTransportException[[Alistair Smythe][inet[/127.0.0.1:9300]][search/phase/query+fetch]]; nested: SearchParseException[[-inx][0]: from[0],size[10]:\nParse Failure [Failed to parse source [{\"query\":{\"geo_shape\":{\"to\":{\"indexed_shape\":{\"id\":\"ouX6eeH5RxKQG3vJ5Ho84A\",\"type\":\"ang\",\"index\":\"-inx\",\"path\":\"to\"}}}}}]]];\nnested: RoutingMissingException[routing is required for [-inx]/[ang]/[ouX6eeH5RxKQG3vJ5Ho84A]]; }\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAction.java:233) ~[elasticsearch-1.3.2.jar:na]\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onFailure(TransportSearchTypeAction.java:179) ~[elasticsearch-1.3.2.jar:na]\n        at org.elasticsearch.search.action.SearchServiceTransportAction$12.handleException(SearchServiceTransportAction.java:326) ~[elasticsearch-1.3.2.jar:na]\n        at org.elasticsearch.transport.netty.MessageChannelHandler.handleException(MessageChannelHandler.java:185) ~[elasticsearch-1.3.2.jar:na]\n        at org.elasticsearch.transport.netty.MessageChannelHandler.handlerResponseError(MessageChannelHandler.java:175) ~[elasticsearch-1.3.2.jar:na]\n```\n\n[1] http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-geo-shape-filter.html#_pre_indexed_shape\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}