{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20580","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20580/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20580/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20580/events","html_url":"https://github.com/elastic/elasticsearch/issues/20580","id":178032868,"node_id":"MDU6SXNzdWUxNzgwMzI4Njg=","number":20580,"title":"dfs_query_then_fetch does work sometimes","user":{"login":"XGiton","id":7584071,"node_id":"MDQ6VXNlcjc1ODQwNzE=","avatar_url":"https://avatars2.githubusercontent.com/u/7584071?v=4","gravatar_id":"","url":"https://api.github.com/users/XGiton","html_url":"https://github.com/XGiton","followers_url":"https://api.github.com/users/XGiton/followers","following_url":"https://api.github.com/users/XGiton/following{/other_user}","gists_url":"https://api.github.com/users/XGiton/gists{/gist_id}","starred_url":"https://api.github.com/users/XGiton/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/XGiton/subscriptions","organizations_url":"https://api.github.com/users/XGiton/orgs","repos_url":"https://api.github.com/users/XGiton/repos","events_url":"https://api.github.com/users/XGiton/events{/privacy}","received_events_url":"https://api.github.com/users/XGiton/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-09-20T11:20:20Z","updated_at":"2016-09-22T10:02:25Z","closed_at":"2016-09-20T12:14:51Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: Elasticsearch 5.0.0-alpha5\n\n**Plugins installed**: [analyzer-ik]\n\n**JVM version**: jdk1.8.0_101\n\n**OS version**: Ubuntu 14.04\n\n**Description of the problem including expected versus actual behavior**:\n`dfs_query_then_fetch` does not work sometimes. When specifying `search_type=dfs_query_then_fetch`, Scores returned should are based on total information of all shard . Actually the scores returned are still based on local information in each shard.\n\nThis is my query:\n\n```\ncurl -XPOST 'localhost:9200/test-index/enterprise/_search?search_type=dfs_query_then_fetch&explain=true&pretty' -d '\n{\n\"query\": {\"match\": {\"content\": \"腾讯\"}}\n}'\n```\n\nI get result:\n\n```\n\n  \"took\" : 5,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 120,\n    \"max_score\" : 118.87119,\n    \"hits\" : [\n      {\n        \"_shard\" : \"[test-index][2]\",\n        \"_node\" : \"UTT6ATDATvW4r5cBzfnJJg\",\n        \"_index\" : \"test-index\",\n        \"_type\" : \"enterprise\",\n        \"_id\" : \"腾讯个人有限公司\",\n        \"_score\" : 118.87119,\n        \"_source\" : {\n          \"content\" : \"腾讯个人\"\n        },\n        \"_explanation\" : {\n          \"value\" : 120.98468,\n          \"description\" : \"sum of:\",\n          \"details\" : [\n            {\n              \"value\" : 120.98468,\n              \"description\" : \"weight(content:腾讯 in 74204) [PerFieldSimilarity], result of:\",\n              \"details\" : [\n                {\n                  \"value\" : 120.98468,\n                  \"description\" : \"score(doc=74204,freq=1.0 = termFreq=1.0\\n), product of:\",\n                  \"details\" : [\n                    {\n                      \"value\" : 8.0,\n                      \"description\" : \"boost\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 11.487666,\n                      \"description\" : \"idf(docFreq=21, docCount=2096372)\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.3164628,\n                      \"description\" : \"tfNorm, computed from:\",\n                      \"details\" : [\n                        {\n                          \"value\" : 1.0,\n                          \"description\" : \"termFreq=1.0\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 1.2,\n                          \"description\" : \"parameter k1\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 0.75,\n                          \"description\" : \"parameter b\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 9.699715,\n                          \"description\" : \"avgFieldLength\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 4.0,\n                          \"description\" : \"fieldLength\",\n                          \"details\" : [ ]\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ]\n            },\n            {\n              \"value\" : 0.0,\n              \"description\" : \"match on required clause, product of:\",\n              \"details\" : [\n                {\n                  \"value\" : 0.0,\n                  \"description\" : \"# clause\",\n                  \"details\" : [ ]\n                },\n                {\n                  \"value\" : 1.0,\n                  \"description\" : \"_type:enterprise, product of:\",\n                  \"details\" : [\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"boost\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"queryNorm\",\n                      \"details\" : [ ]\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        }\n      },\n      {\n        \"_shard\" : \"[test-index][0]\",\n        \"_node\" : \"UTT6ATDATvW4r5cBzfnJJg\",\n        \"_index\" : \"test-index\",\n        \"_type\" : \"enterprise\",\n        \"_id\" : \"腾讯征信有限公司\",\n        \"_score\" : 111.30547,\n        \"_source\" : {\n          \"content\" : \"腾讯征信\"\n        },\n        \"_explanation\" : {\n          \"value\" : 110.514534,\n          \"description\" : \"sum of:\",\n          \"details\" : [\n            {\n              \"value\" : 110.514534,\n              \"description\" : \"weight(content:腾讯 in 72811) [PerFieldSimilarity], result of:\",\n              \"details\" : [\n                {\n                  \"value\" : 110.514534,\n                  \"description\" : \"score(doc=72811,freq=1.0 = termFreq=1.0\\n), product of:\",\n                  \"details\" : [\n                    {\n                      \"value\" : 8.0,\n                      \"description\" : \"boost\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 11.206198,\n                      \"description\" : \"idf(docFreq=28, docCount=2097175)\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.232739,\n                      \"description\" : \"tfNorm, computed from:\",\n                      \"details\" : [\n                        {\n                          \"value\" : 1.0,\n                          \"description\" : \"termFreq=1.0\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 1.2,\n                          \"description\" : \"parameter k1\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 0.75,\n                          \"description\" : \"parameter b\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 9.702056,\n                          \"description\" : \"avgFieldLength\",\n                          \"details\" : [ ]\n                        },\n                        {\n                          \"value\" : 5.2244897,\n                          \"description\" : \"fieldLength\",\n                          \"details\" : [ ]\n                        }\n                      ]\n                    }\n                  ]\n                }\n              ]\n            },\n            {\n              \"value\" : 0.0,\n              \"description\" : \"match on required clause, product of:\",\n              \"details\" : [\n                {\n                  \"value\" : 0.0,\n                  \"description\" : \"# clause\",\n                  \"details\" : [ ]\n                },\n                {\n                  \"value\" : 1.0,\n                  \"description\" : \"_type:enterprise, product of:\",\n                  \"details\" : [\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"boost\",\n                      \"details\" : [ ]\n                    },\n                    {\n                      \"value\" : 1.0,\n                      \"description\" : \"queryNorm\",\n                      \"details\" : [ ]\n                    }\n                  ]\n                }\n              ]\n            }\n          ]\n        }\n      },\n      ...\n    ]\n  }\n}\n```\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}