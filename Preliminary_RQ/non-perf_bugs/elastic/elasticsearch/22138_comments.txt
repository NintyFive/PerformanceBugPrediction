[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/267019942","html_url":"https://github.com/elastic/elasticsearch/issues/22138#issuecomment-267019942","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138","id":267019942,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NzAxOTk0Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-12-14T12:17:35Z","updated_at":"2016-12-14T12:17:35Z","author_association":"CONTRIBUTOR","body":"I've reduced this to the following:\r\n\r\n```\r\nPUT elastic_issue\r\n{\r\n  \"mappings\": {\r\n    \"branch\": {\r\n      \"properties\": {\r\n        \"opening_date\": {\r\n          \"type\": \"date\",\r\n          \"format\": \"epoch_millis\"\r\n        },\r\n        \"opening_date_long\": {\r\n          \"type\": \"long\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT elastic_issue/branch/11\r\n{\r\n\t\"opening_date\": 1481624898000,\r\n\t\"opening_date_long\": 1481624898000,\r\n\t\"name\": \"zalka\"\r\n}\r\n\r\nGET elastic_issue/_search?explain\r\n{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"score_mode\": \"sum\",\r\n      \"boost_mode\": \"replace\",\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"must\": [\r\n            {\r\n              \"range\": {\r\n                \"opening_date\": {\r\n                  \"gte\": 1481624898000\r\n                }\r\n              }\r\n            },\r\n            {\r\n              \"constant_score\": {\r\n                \"filter\": {\r\n                  \"match_all\": {}\r\n                },\r\n                \"boost\": 200\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"functions\": [\r\n        {\r\n          \"filter\": {\r\n            \"match_all\": {}\r\n          },\r\n          \"weight\": 3\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe explanation from the above starts with:\r\n\r\n```\r\n        \"_explanation\": {\r\n          \"value\": 603,\r\n          \"description\": \"function score, product of:\",\r\n```\r\n\r\neven though the function score says `boost_mode: sum, score_mode: sum`.\r\n\r\nif you change the range query to run on `opening_date` instead of `opening_date_long`, then the explanation changes to:\r\n\r\n```\r\n        \"_explanation\": {\r\n          \"value\": 3,\r\n          \"description\": \"min of:\",\r\n          \"details\": [\r\n```\r\n\r\nwhich doesn't seem right either","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/267020060","html_url":"https://github.com/elastic/elasticsearch/issues/22138#issuecomment-267020060","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138","id":267020060,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NzAyMDA2MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-12-14T12:18:16Z","updated_at":"2016-12-14T12:18:16Z","author_association":"CONTRIBUTOR","body":"@jimczi could you take a look at this please?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/267021297","html_url":"https://github.com/elastic/elasticsearch/issues/22138#issuecomment-267021297","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138","id":267021297,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NzAyMTI5Nw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-12-14T12:25:21Z","updated_at":"2016-12-14T12:25:21Z","author_association":"CONTRIBUTOR","body":"btw @hrahal - regardless of this bug, I would definitely not try to solve your problem using parent-child.  You're essentially trying to impose a relational design onto elasticsearch, and it is bound to fail. Instead, denormalise your data.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/267075839","html_url":"https://github.com/elastic/elasticsearch/issues/22138#issuecomment-267075839","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22138","id":267075839,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NzA3NTgzOQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-12-14T16:10:53Z","updated_at":"2016-12-14T16:10:53Z","author_association":"MEMBER","body":"This one is funky. In 5.x we added a rewrite method on the query builders (like the one for Lucene query) in order to be able to optimize some queries at the ES level. In this example you have a range query on a date field and since the index contains only one document the range query builder is rewritten in a match all docs query. When the inner query of the FunctionScoreQueryBuilder is rewritten we create a new object that contains the new query plus the other parameters of the FunctionScoreQueryBuilder. The `boost_mode` was just ignored during the copy so the default value (which is SUM) is applied.\r\nI opened  https://github.com/elastic/elasticsearch/issues/22172 to fix this issue.","performed_via_github_app":null}]