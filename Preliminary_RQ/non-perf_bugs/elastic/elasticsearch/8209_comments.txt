[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60252175","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-60252175","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":60252175,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjUyMTc1","user":{"login":"miccon","id":455015,"node_id":"MDQ6VXNlcjQ1NTAxNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/455015?v=4","gravatar_id":"","url":"https://api.github.com/users/miccon","html_url":"https://github.com/miccon","followers_url":"https://api.github.com/users/miccon/followers","following_url":"https://api.github.com/users/miccon/following{/other_user}","gists_url":"https://api.github.com/users/miccon/gists{/gist_id}","starred_url":"https://api.github.com/users/miccon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/miccon/subscriptions","organizations_url":"https://api.github.com/users/miccon/orgs","repos_url":"https://api.github.com/users/miccon/repos","events_url":"https://api.github.com/users/miccon/events{/privacy}","received_events_url":"https://api.github.com/users/miccon/received_events","type":"User","site_admin":false},"created_at":"2014-10-23T15:00:37Z","updated_at":"2014-10-23T15:00:37Z","author_association":"NONE","body":"This also leads to 'double' buckets during daylight savings time change:\n\nExample with interval set to day:\n\n```\n\"aggregations\" : {\n    \"histo\" : {\n      \"buckets\" : [ {\n        \"key_as_string\" : \"2014-10-25T22:00:00.000Z\",       // Still daylight saving (midnight 26th)\n        \"key\" : 1414274400000,\n        \"doc_count\" : 0\n      }, {\n        \"key_as_string\" : \"2014-10-26T22:00:00.000Z\",       // Should be 23h in UTC (wrong bucket)\n        \"key\" : 1414360800000,\n        \"doc_count\" : 0\n      }, {\n        \"key_as_string\" : \"2014-10-26T23:00:00.000Z\",       // Winter time (midnight 27th)\n        \"key\" : 1414364400000,\n        \"doc_count\" : 1\n      }, {\n        \"key_as_string\" : \"2014-10-27T23:00:00.000Z\",\n        \"key\" : 1414450800000,\n        \"doc_count\" : 0\n      } ]\n    }\n  }\n```\n\nhttps://gist.github.com/miccon/de967d67cc8fc80fb3d8\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60252809","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-60252809","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":60252809,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjUyODA5","user":{"login":"miccon","id":455015,"node_id":"MDQ6VXNlcjQ1NTAxNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/455015?v=4","gravatar_id":"","url":"https://api.github.com/users/miccon","html_url":"https://github.com/miccon","followers_url":"https://api.github.com/users/miccon/followers","following_url":"https://api.github.com/users/miccon/following{/other_user}","gists_url":"https://api.github.com/users/miccon/gists{/gist_id}","starred_url":"https://api.github.com/users/miccon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/miccon/subscriptions","organizations_url":"https://api.github.com/users/miccon/orgs","repos_url":"https://api.github.com/users/miccon/repos","events_url":"https://api.github.com/users/miccon/events{/privacy}","received_events_url":"https://api.github.com/users/miccon/received_events","type":"User","site_admin":false},"created_at":"2014-10-23T15:04:26Z","updated_at":"2014-10-23T15:04:26Z","author_association":"NONE","body":"In the code the following assertion is triggered (using 1.4, seems to be also present in master)\n\n```\nCaused by: java.lang.AssertionError\n    at org.elasticsearch.search.aggregations.bucket.histogram.InternalHistogram.reduce(InternalHistogram.java:368)\n    at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:140)\n    at org.elasticsearch.search.controller.SearchPhaseController.merge(SearchPhaseController.java:374)\n    at org.elasticsearch.action.search.type.TransportSearchQueryAndFetchAction$AsyncAction$1.doRun(TransportSearchQueryAndFetchAction.java:83)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n    ... 3 more\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/69836229","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-69836229","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":69836229,"node_id":"MDEyOklzc3VlQ29tbWVudDY5ODM2MjI5","user":{"login":"wojcikstefan","id":1718372,"node_id":"MDQ6VXNlcjE3MTgzNzI=","avatar_url":"https://avatars1.githubusercontent.com/u/1718372?v=4","gravatar_id":"","url":"https://api.github.com/users/wojcikstefan","html_url":"https://github.com/wojcikstefan","followers_url":"https://api.github.com/users/wojcikstefan/followers","following_url":"https://api.github.com/users/wojcikstefan/following{/other_user}","gists_url":"https://api.github.com/users/wojcikstefan/gists{/gist_id}","starred_url":"https://api.github.com/users/wojcikstefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wojcikstefan/subscriptions","organizations_url":"https://api.github.com/users/wojcikstefan/orgs","repos_url":"https://api.github.com/users/wojcikstefan/repos","events_url":"https://api.github.com/users/wojcikstefan/events{/privacy}","received_events_url":"https://api.github.com/users/wojcikstefan/received_events","type":"User","site_admin":false},"created_at":"2015-01-13T22:45:16Z","updated_at":"2015-01-13T22:46:03Z","author_association":"NONE","body":"+1\n\nAlthough the title is misleading - the issue has nothing to do with extended bounds.\n\nRunning the commands below:\n\n```\ncurl -sXDELETE 'localhost:9200/test'\ncurl -sXPOST 'localhost:9200/test/test/?pretty=true&refresh=true' -d '{\"date\": \"2014-01-01T0:00:00Z\"}'\ncurl -sXPOST 'localhost:9200/test/test/?pretty=true&refresh=true' -d '{\"date\": \"2014-04-01T0:00:00Z\"}'\ncurl -sXPOST 'localhost:9200/test/test/?pretty=true&refresh=true' -d '{\"date\": \"2014-04-30T0:00:00Z\"}'\ncurl -sXGET 'localhost:9200/_search?pretty=true' -d '                                                                                                                                                                                                                                                                                            \n{\n  \"size\": 0,\n  \"aggs\": {\n    \"histo\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"interval\": \"month\",\n        \"pre_zone\": \"+01:00\",\n        \"pre_zone_adjust_large_interval\": true,\n        \"min_doc_count\": 0\n      }\n    }\n  }\n}'\n```\n\nResults in:\n\n```\n{\n  \"took\" : 6,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 127,\n    \"successful\" : 127,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 30155,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"histo\" : {\n      \"buckets\" : [ {\n        \"key_as_string\" : \"2013-12-31T23:00:00.000Z\",\n        \"key\" : 1388530800000,\n        \"doc_count\" : 1\n      }, {\n        \"key_as_string\" : \"2014-01-31T23:00:00.000Z\",\n        \"key\" : 1391209200000,\n        \"doc_count\" : 0\n      }, {\n        \"key_as_string\" : \"2014-02-28T23:00:00.000Z\",\n        \"key\" : 1393628400000,\n        \"doc_count\" : 0\n      }, {\n        \"key_as_string\" : \"2014-03-28T23:00:00.000Z\",\n        \"key\" : 1396047600000,\n        \"doc_count\" : 0\n      }, {\n        \"key_as_string\" : \"2014-03-31T23:00:00.000Z\",\n        \"key\" : 1396306800000,\n        \"doc_count\" : 2\n      } ]\n    }\n  }\n}\n```\n\nThe bucket keys I'd expect are: `2013-12-31T23:00:00.000Z`, `2014-01-31T23:00:00.000Z`, `2014-02-28T23:00:00.000Z`, `2014-03-31T23:00:00.000Z`. Note that this is only an issue with positive `pre_zone` values and `pre_zone_adjust_large_interval` equal to `true`.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/75256327","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-75256327","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":75256327,"node_id":"MDEyOklzc3VlQ29tbWVudDc1MjU2MzI3","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2015-02-20T15:30:01Z","updated_at":"2015-02-20T15:30:01Z","author_association":"MEMBER","body":"This looks very similar to #9491 and #7673 to me. Probably also fixed the same way. Will see if this behaviour is already fixed with the latest clean up of the `date_histogram` on master.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/75264111","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-75264111","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":75264111,"node_id":"MDEyOklzc3VlQ29tbWVudDc1MjY0MTEx","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2015-02-20T16:12:21Z","updated_at":"2015-02-20T16:12:21Z","author_association":"MEMBER","body":"I tried the script of @wojcikstefan on current master (7c20a8), works there. However, bug is reproducable on 1.x. Will dig into this further.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/75582472","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-75582472","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":75582472,"node_id":"MDEyOklzc3VlQ29tbWVudDc1NTgyNDcy","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2015-02-23T16:56:17Z","updated_at":"2015-02-23T16:56:17Z","author_association":"MEMBER","body":"@jpountz Had a look at these cases and why they still don't work on 1.x an 1.4 even after fix from https://github.com/elasticsearch/elasticsearch/pull/9790. The reason is that using `pre_zone_adjust_large_interval = true` for month and bigger intervals forces the TimeZoneRounding implementation to be TimeTimeZoneRoundingFloor. When calculating next buckets keys when inserting empty buckets we should do the adding of the time duration in local time (where also the rounding takes place).\nAdding the back and forth conversion for preTz in TimeTimeZoneRoundingFloor.nextRoundingValue solved the issue for me. Will issue a PR if you want to have a look.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/75591852","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-75591852","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":75591852,"node_id":"MDEyOklzc3VlQ29tbWVudDc1NTkxODUy","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-02-23T17:40:39Z","updated_at":"2015-02-23T17:40:39Z","author_association":"CONTRIBUTOR","body":"@cbuescher +1 on a PR, your description of the fix looks good to me. Thanks for taking care of this!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/75598992","html_url":"https://github.com/elastic/elasticsearch/issues/8209#issuecomment-75598992","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8209","id":75598992,"node_id":"MDEyOklzc3VlQ29tbWVudDc1NTk4OTky","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2015-02-23T18:16:42Z","updated_at":"2015-02-23T18:16:42Z","author_association":"MEMBER","body":"Fix on 1.4 branch: e869e90\nFix on 1.x branch: f829670\nOnly tests on master: 4ef430d\n","performed_via_github_app":null}]