{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26863","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26863/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26863/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26863/events","html_url":"https://github.com/elastic/elasticsearch/issues/26863","id":262408676,"node_id":"MDU6SXNzdWUyNjI0MDg2NzY=","number":26863,"title":"Suggester does not return top weighted documents","user":{"login":"DCleymans","id":12541466,"node_id":"MDQ6VXNlcjEyNTQxNDY2","avatar_url":"https://avatars2.githubusercontent.com/u/12541466?v=4","gravatar_id":"","url":"https://api.github.com/users/DCleymans","html_url":"https://github.com/DCleymans","followers_url":"https://api.github.com/users/DCleymans/followers","following_url":"https://api.github.com/users/DCleymans/following{/other_user}","gists_url":"https://api.github.com/users/DCleymans/gists{/gist_id}","starred_url":"https://api.github.com/users/DCleymans/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DCleymans/subscriptions","organizations_url":"https://api.github.com/users/DCleymans/orgs","repos_url":"https://api.github.com/users/DCleymans/repos","events_url":"https://api.github.com/users/DCleymans/events{/privacy}","received_events_url":"https://api.github.com/users/DCleymans/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-10-03T12:29:21Z","updated_at":"2017-10-03T13:04:27Z","closed_at":"2017-10-03T13:04:27Z","author_association":"NONE","active_lock_reason":null,"body":"```\r\n{\r\n  \"name\" : \"instance-0000000001\",\r\n  \"cluster_name\" : \"d90d7063ab1ce029fff8ae497e45b933\",\r\n  \"cluster_uuid\" : \"nPbWqX0bSzGMEh84Y793Qg\",\r\n  \"version\" : {\r\n    \"number\" : \"5.5.2\",\r\n    \"build_hash\" : \"b2f0c09\",\r\n    \"build_date\" : \"2017-08-14T12:33:14.154Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"6.6.0\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n```\r\n\r\nWhen using the context suggester with weighted results, the search suggest api does not return the top weighted documents for a search term.  \r\n\r\nI notice a difference in the top ranked documents when I request more documents.\r\n\r\nWe have an index with artist documents and song documents, all for autocompletion purpose. The artists mapping looks like this:\r\n\r\n```\r\n{\r\n  \"autocompletion\": {\r\n    \"mappings\": {\r\n      \"autocompletion_artist\": {\r\n        \"properties\": {\r\n          \"artist-autocompletion\": {\r\n            \"type\": \"completion\",\r\n            \"analyzer\": \"t3_autocompletion_index_analyzer\",\r\n            \"search_analyzer\": \"t3_autocompletion_search_analyzer\",\r\n            \"preserve_separators\": false,\r\n            \"preserve_position_increments\": false,\r\n            \"max_input_length\": 50,\r\n            \"contexts\": [\r\n              {\r\n                \"name\": \"r\",\r\n                \"type\": \"CATEGORY\",\r\n                \"path\": \"region-code\"\r\n              }\r\n            ]\r\n          },\r\n          \"artist-autocompletion-output\": {\r\n            \"type\": \"keyword\"\r\n          },\r\n          \"group-id\": {\r\n            \"type\": \"integer\"\r\n          },\r\n          \"group_id\": {\r\n            \"type\": \"keyword\"\r\n          },\r\n          \"region-code\": {\r\n            \"type\": \"keyword\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nWhen I request the top 3 suggestions for artist documents:\r\n\r\n```\r\n{\r\n\t\"_source\": [\"artist-autocompletion-output\"],\r\n\t\"suggest\": {\r\n\t\t\"artists\": {\r\n\t\t\t\"completion\": {\r\n\t\t\t\t\"field\": \"artist-autocompletion\",\r\n\t\t\t\t\"size\": 3,\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\", \"vl\"]\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"text\": \"prince\"\r\n\t}\r\n}\r\n```\r\n\r\nI get these results:\r\n\r\n```\r\n{\r\n\t\"took\": 1,\r\n\t\"timed_out\": false,\r\n\t\"_shards\": {\r\n\t\t\"total\": 1,\r\n\t\t\"successful\": 1,\r\n\t\t\"failed\": 0\r\n\t},\r\n\t\"hits\": {\r\n\t\t\"total\": 0,\r\n\t\t\"max_score\": 0.0,\r\n\t\t\"hits\": []\r\n\t},\r\n\t\"suggest\": {\r\n\t\t\"artists\": [{\r\n\t\t\t\"text\": \"prince\",\r\n\t\t\t\"offset\": 0,\r\n\t\t\t\"length\": 6,\r\n\t\t\t\"options\": [{\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"510\",\r\n\t\t\t\t\"_score\": 9659.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"Prince\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"551\",\r\n\t\t\t\t\"_score\": 9477.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"Prince & The Revolution\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"7306\",\r\n\t\t\t\t\"_score\": 6114.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"DJ Jazzy Jeff & The Fresh Prince\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}]\r\n\t\t}]\r\n\t}\r\n}\r\n```\r\n\r\nWhen I request 5 documents, the top 3 is already different:\r\n\r\n```\r\n{\r\n\t\"took\": 2,\r\n\t\"timed_out\": false,\r\n\t\"_shards\": {\r\n\t\t\"total\": 1,\r\n\t\t\"successful\": 1,\r\n\t\t\"failed\": 0\r\n\t},\r\n\t\"hits\": {\r\n\t\t\"total\": 0,\r\n\t\t\"max_score\": 0.0,\r\n\t\t\"hits\": []\r\n\t},\r\n\t\"suggest\": {\r\n\t\t\"artists\": [{\r\n\t\t\t\"text\": \"prince\",\r\n\t\t\t\"offset\": 0,\r\n\t\t\t\"length\": 6,\r\n\t\t\t\"options\": [{\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"510\",\r\n\t\t\t\t\"_score\": 9659.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"Prince\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"551\",\r\n\t\t\t\t\"_score\": 9477.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"Prince & The Revolution\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t\"text\": \"Prince Royce\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"40078\",\r\n\t\t\t\t\"_score\": 8032.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"Prince Royce\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"2415\",\r\n\t\t\t\t\"_score\": 7913.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"Will Smith\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}, {\r\n\t\t\t\t\"text\": \"Prince\",\r\n\t\t\t\t\"_index\": \"autocompletion\",\r\n\t\t\t\t\"_type\": \"autocompletion_artist\",\r\n\t\t\t\t\"_id\": \"7306\",\r\n\t\t\t\t\"_score\": 6114.0,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"artist-autocompletion-output\": \"DJ Jazzy Jeff & The Fresh Prince\"\r\n\t\t\t\t},\r\n\t\t\t\t\"contexts\": {\r\n\t\t\t\t\t\"r\": [\"w\"]\r\n\t\t\t\t}\r\n\t\t\t}]\r\n\t\t}]\r\n\t}\r\n}\r\n\r\n```\r\nAs you can see, the result is correctly ordered by weight, but it are not the top weighted documents. It looks like the suggester matches the first x items and then orders those by weight.\r\n\r\nHow can make the suggester to return the top weighted documents?\r\n","closed_by":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"performed_via_github_app":null}