{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30482","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30482/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30482/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30482/events","html_url":"https://github.com/elastic/elasticsearch/issues/30482","id":321488763,"node_id":"MDU6SXNzdWUzMjE0ODg3NjM=","number":30482,"title":"Elasticsearch windows service fails to register service stoppage event","user":{"login":"askids","id":10394218,"node_id":"MDQ6VXNlcjEwMzk0MjE4","avatar_url":"https://avatars0.githubusercontent.com/u/10394218?v=4","gravatar_id":"","url":"https://api.github.com/users/askids","html_url":"https://github.com/askids","followers_url":"https://api.github.com/users/askids/followers","following_url":"https://api.github.com/users/askids/following{/other_user}","gists_url":"https://api.github.com/users/askids/gists{/gist_id}","starred_url":"https://api.github.com/users/askids/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/askids/subscriptions","organizations_url":"https://api.github.com/users/askids/orgs","repos_url":"https://api.github.com/users/askids/repos","events_url":"https://api.github.com/users/askids/events{/privacy}","received_events_url":"https://api.github.com/users/askids/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-05-09T09:04:18Z","updated_at":"2020-11-11T21:56:49Z","closed_at":"2018-05-12T14:43:03Z","author_association":"NONE","active_lock_reason":null,"body":"hi,\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.5.1\r\n**Plugins installed**: [X-pack basic, Readonlyrest 1.16.15, Search Guard SSL]\r\n**JVM version** (`java -version`): JRE 64bit\r\njava version \"1.8.0_152\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_152-b16)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.152-b16, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows 2012 R2 standard\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen Elasticsearch windows service fails due to an uncaught exception, it does not register a service stopped event. Currently, we have monitoring in place for windows services to get an alert, whenever the service is stopped or started. Due to Elasticsearch failing to register the event, we don't get an alert. If I manually stop the service, then we see the windows event getting logged and alert also gets generated.\r\n\r\nES is being run as a single node cluster.\r\n\r\n**Steps to reproduce**:\r\nNot sure how to reproduce it. Logs says that its an out of memory error and there is a ElasticsearchUncaughtExceptionHandler entry.\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2018-05-08T23:01:19,022][WARN ][o.e.c.r.a.DiskThresholdMonitor] [XXXXXXXX-YYYYYYYYY] high disk watermark [90%] exceeded on [OdQ_MbyjRoq8SoTCMZ7gbQ][XXXXXXXX-YYYYYYYYY][D:\\Sites\\xxxxxxxx\\Databases\\yyyyyyyy\\nodes\\0] free: 2.6gb[8.6%], shards will be relocated away from this node\r\n[2018-05-08T23:01:21,141][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246978] overhead, spent [2.1s] collecting in the last [2.2s]\r\n[2018-05-08T23:01:22,149][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246979] overhead, spent [1.6s] collecting in the last [1.8s]\r\n[2018-05-08T23:01:23,340][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246980] overhead, spent [1.1s] collecting in the last [1.1s]\r\n[2018-05-08T23:01:27,975][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:01:28,042][ERROR][o.e.x.m.c.i.IndexStatsCollector] [XXXXXXXX-YYYYYYYYY] collector [index-stats] timed out when collecting data\r\n[2018-05-08T23:01:28,042][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246981] overhead, spent [4.4s] collecting in the last [4.7s]\r\n[2018-05-08T23:01:29,066][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246982] overhead, spent [1s] collecting in the last [1s]\r\n[2018-05-08T23:01:30,263][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246983] overhead, spent [1.1s] collecting in the last [1.1s]\r\n[2018-05-08T23:01:31,875][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246984] overhead, spent [1.5s] collecting in the last [1.6s]\r\n[2018-05-08T23:01:33,050][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246985] overhead, spent [1s] collecting in the last [1.1s]\r\n[2018-05-08T23:01:36,410][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246986] overhead, spent [2.3s] collecting in the last [1.1s]\r\n[2018-05-08T23:01:37,813][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246987] overhead, spent [2.2s] collecting in the last [3.5s]\r\n[2018-05-08T23:01:38,814][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246988] overhead, spent [961ms] collecting in the last [1s]\r\n[2018-05-08T23:01:40,172][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246989] overhead, spent [1.3s] collecting in the last [1.3s]\r\n[2018-05-08T23:01:42,630][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246990] overhead, spent [1s] collecting in the last [1s]\r\n[2018-05-08T23:01:45,018][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246991] overhead, spent [3.6s] collecting in the last [3.7s]\r\n[2018-05-08T23:01:45,024][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:01:47,566][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246992] overhead, spent [2.3s] collecting in the last [2.5s]\r\n[2018-05-08T23:01:47,587][ERROR][o.e.x.m.c.i.IndicesStatsCollector] [XXXXXXXX-YYYYYYYYY] collector [indices-stats] timed out when collecting data\r\n[2018-05-08T23:01:49,736][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246993] overhead, spent [2.1s] collecting in the last [2.1s]\r\n[2018-05-08T23:01:51,027][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246994] overhead, spent [1.2s] collecting in the last [1.2s]\r\n[2018-05-08T23:01:51,039][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:01:52,074][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246995] overhead, spent [1s] collecting in the last [1s]\r\n[2018-05-08T23:01:53,349][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246996] overhead, spent [1.2s] collecting in the last [1.2s]\r\n[2018-05-08T23:01:55,748][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246997] overhead, spent [2.2s] collecting in the last [2.4s]\r\n[2018-05-08T23:01:57,538][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:01:58,879][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246998] overhead, spent [3s] collecting in the last [3.1s]\r\n[2018-05-08T23:02:00,149][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][246999] overhead, spent [1.1s] collecting in the last [1.2s]\r\n[2018-05-08T23:02:01,775][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247000] overhead, spent [1.5s] collecting in the last [1.6s]\r\n[2018-05-08T23:02:02,717][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:04,147][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247001] overhead, spent [2.2s] collecting in the last [2.3s]\r\n[2018-05-08T23:02:06,193][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247002] overhead, spent [1.9s] collecting in the last [2s]\r\n[2018-05-08T23:02:07,824][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:10,758][INFO ][o.e.c.r.a.DiskThresholdMonitor] [XXXXXXXX-YYYYYYYYY] low disk watermark [85%] exceeded on [OdQ_MbyjRoq8SoTCMZ7gbQ][XXXXXXXX-YYYYYYYYY][D:\\Sites\\xxxxxxxx\\Databases\\yyyyyyyy\\nodes\\0] free: 4gb[13.4%], replicas will not be assigned to this node\r\n[2018-05-08T23:02:13,709][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:14,614][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247003] overhead, spent [5.2s] collecting in the last [1.6s]\r\n[2018-05-08T23:02:15,676][INFO ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247004] overhead, spent [3.8s] collecting in the last [7.8s]\r\n[2018-05-08T23:02:18,197][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247005] overhead, spent [2.4s] collecting in the last [2.5s]\r\n[2018-05-08T23:02:24,891][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:24,892][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247006] overhead, spent [6.4s] collecting in the last [1s]\r\n[2018-05-08T23:02:28,373][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247008] overhead, spent [2.3s] collecting in the last [2.3s]\r\n[2018-05-08T23:02:30,932][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247009] overhead, spent [2.5s] collecting in the last [2.5s]\r\n[2018-05-08T23:02:30,937][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:31,998][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247010] overhead, spent [1s] collecting in the last [1s]\r\n[2018-05-08T23:02:41,065][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:42,108][WARN ][o.e.m.j.JvmGcMonitorService] [XXXXXXXX-YYYYYYYYY] [gc][247011] overhead, spent [9.4s] collecting in the last [1.5s]\r\n[2018-05-08T23:02:46,632][INFO ][t.b.r.c.s.SettingsPoller ] [CLUSTERWIDE SETTINGS] Cluster not ready...\r\n[2018-05-08T23:02:52,851][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [XXXXXXXX-YYYYYYYYY] fatal error in thread [elasticsearch[XXXXXXXX-YYYYYYYYY][generic][T#2]], exiting\r\njava.lang.OutOfMemoryError: Java heap space\r\n\tat org.apache.lucene.index.ParallelPostingsArray.<init>(ParallelPostingsArray.java:33) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.FreqProxTermsWriterPerField$FreqProxPostingsArray.<init>(FreqProxTermsWriterPerField.java:205) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.FreqProxTermsWriterPerField$FreqProxPostingsArray.newInstance(FreqProxTermsWriterPerField.java:230) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.ParallelPostingsArray.grow(ParallelPostingsArray.java:46) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.TermsHashPerField$PostingsBytesStartArray.grow(TermsHashPerField.java:250) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.util.BytesRefHash.add(BytesRefHash.java:271) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.TermsHashPerField.add(TermsHashPerField.java:149) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:796) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:447) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:403) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:232) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:478) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1571) ~[lucene-core-6.6.0.jar:6.6.0 5c7a7b65d2aa7ce5ec96458315c661a18b320241 - ishan - 2017-05-30 07:29:46]\r\n\tat org.elasticsearch.index.engine.InternalEngine.update(InternalEngine.java:740) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.engine.InternalEngine.indexIntoLucene(InternalEngine.java:603) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:505) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:556) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.access$300(IndexShard.java:142) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.IndexShard$IndexShardRecoveryPerformer.index(IndexShard.java:1841) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.TranslogRecoveryPerformer.performRecoveryOperation(TranslogRecoveryPerformer.java:165) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.TranslogRecoveryPerformer.recoveryFromSnapshot(TranslogRecoveryPerformer.java:86) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.IndexShard$IndexShardRecoveryPerformer.recoveryFromSnapshot(IndexShard.java:1836) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.engine.InternalEngine.recoverFromTranslog(InternalEngine.java:241) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.engine.InternalEngine.recoverFromTranslog(InternalEngine.java:220) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.engine.InternalEngine.recoverFromTranslog(InternalEngine.java:91) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.internalPerformTranslogRecovery(IndexShard.java:1036) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.performTranslogRecovery(IndexShard.java:990) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.StoreRecovery.internalRecoverFromStore(StoreRecovery.java:360) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromStore$0(StoreRecovery.java:90) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.StoreRecovery$$Lambda$1788/209912095.run(Unknown Source) ~[?:?]\r\n\tat org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:257) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\tat org.elasticsearch.index.shard.StoreRecovery.recoverFromStore(StoreRecovery.java:88) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n```\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}