[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310002864","html_url":"https://github.com/elastic/elasticsearch/issues/25327#issuecomment-310002864","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25327","id":310002864,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDAwMjg2NA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-06-21T08:20:17Z","updated_at":"2017-06-21T08:20:17Z","author_association":"CONTRIBUTOR","body":"What happens if you don't explicitly shut down the threadpool? Note that this should be handled by the `client.close()` and could also be the cause for the `java.lang.IllegalStateException: thread was not started`.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310296944","html_url":"https://github.com/elastic/elasticsearch/issues/25327#issuecomment-310296944","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25327","id":310296944,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDI5Njk0NA==","user":{"login":"luyuekai","id":17737080,"node_id":"MDQ6VXNlcjE3NzM3MDgw","avatar_url":"https://avatars0.githubusercontent.com/u/17737080?v=4","gravatar_id":"","url":"https://api.github.com/users/luyuekai","html_url":"https://github.com/luyuekai","followers_url":"https://api.github.com/users/luyuekai/followers","following_url":"https://api.github.com/users/luyuekai/following{/other_user}","gists_url":"https://api.github.com/users/luyuekai/gists{/gist_id}","starred_url":"https://api.github.com/users/luyuekai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luyuekai/subscriptions","organizations_url":"https://api.github.com/users/luyuekai/orgs","repos_url":"https://api.github.com/users/luyuekai/repos","events_url":"https://api.github.com/users/luyuekai/events{/privacy}","received_events_url":"https://api.github.com/users/luyuekai/received_events","type":"User","site_admin":false},"created_at":"2017-06-22T07:17:26Z","updated_at":"2017-06-22T07:19:17Z","author_association":"NONE","body":"when I deleted the two lines of code, I don't accept that exception.  now my code is this :  \r\n```java  \r\n  public static void destroyInstance(TransportClient client) {\r\n        if (client != null) {\r\n            try {\r\n                client.close();\r\n                client = null;\r\n                Logger.getLogger(\"TransportClient destroyed\");\r\n            } catch (Exception ex) {\r\n                Logger.getLogger(ESClientManager.class.getName()).log(Level.SEVERE, null, ex);\r\n            }\r\n        }\r\n    }\r\n```\r\nBut the first problem still remains.  When I undeployed my application, Glassfish 4.1 logs still  show that:  \r\n```\r\nSevere:   The web application [/demo] created a ThreadLocal with key of type [java.lang.ThreadLocal] \r\n(value [java.lang.ThreadLocal@5cf1451a]) and a value of type \r\n[io.netty.util.internal.InternalThreadLocalMap] (value \r\n[io.netty.util.internal.InternalThreadLocalMap@70dbd415]) \r\nbut failed to remove it when the web application was stopped.\r\n Threads are going to be renewed over time to try and avoid a probable memory leak.\r\n```  \r\nI have no idea about it . What should I do to solve  this problem ?  Thanks a lot @ywelsch ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310298577","html_url":"https://github.com/elastic/elasticsearch/issues/25327#issuecomment-310298577","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25327","id":310298577,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDI5ODU3Nw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-06-22T07:25:38Z","updated_at":"2017-06-22T07:25:38Z","author_association":"CONTRIBUTOR","body":"This seems to be a netty problem (https://github.com/netty/netty/pull/2578), the network library that is used by ES. Can you try calling `io.netty.util.concurrent.FastThreadLocal.destroy()` after `client.close();`. Does that help?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310557275","html_url":"https://github.com/elastic/elasticsearch/issues/25327#issuecomment-310557275","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25327","id":310557275,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDU1NzI3NQ==","user":{"login":"luyuekai","id":17737080,"node_id":"MDQ6VXNlcjE3NzM3MDgw","avatar_url":"https://avatars0.githubusercontent.com/u/17737080?v=4","gravatar_id":"","url":"https://api.github.com/users/luyuekai","html_url":"https://github.com/luyuekai","followers_url":"https://api.github.com/users/luyuekai/followers","following_url":"https://api.github.com/users/luyuekai/following{/other_user}","gists_url":"https://api.github.com/users/luyuekai/gists{/gist_id}","starred_url":"https://api.github.com/users/luyuekai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luyuekai/subscriptions","organizations_url":"https://api.github.com/users/luyuekai/orgs","repos_url":"https://api.github.com/users/luyuekai/repos","events_url":"https://api.github.com/users/luyuekai/events{/privacy}","received_events_url":"https://api.github.com/users/luyuekai/received_events","type":"User","site_admin":false},"created_at":"2017-06-23T02:53:46Z","updated_at":"2017-06-23T02:53:58Z","author_association":"NONE","body":"I have tried as you say. But it doesn't seem to work. And  I also watch the netty's issues about this. Then I tried these methods:  \r\n```java\r\nio.netty.util.internal.InternalThreadLocalMap.remove();\r\nio.netty.util.internal.InternalThreadLocalMap.destroy();\r\nio.netty.util.concurrent.FastThreadLocal.removeAll();\r\nio.netty.util.concurrent.FastThreadLocal.destroy();\r\n```\r\nAll of them don't seem to  work.  I think there is someting wrong about netty. Fortunately, It's not a major issue for me. I can remember it. But  I don't have to solve it as soon as possible. Thanks for your suggestions anyway.\r\nI would appreciate it if you could give me other ideas about it. @ywelsch ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310558967","html_url":"https://github.com/elastic/elasticsearch/issues/25327#issuecomment-310558967","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25327","id":310558967,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDU1ODk2Nw==","user":{"login":"luyuekai","id":17737080,"node_id":"MDQ6VXNlcjE3NzM3MDgw","avatar_url":"https://avatars0.githubusercontent.com/u/17737080?v=4","gravatar_id":"","url":"https://api.github.com/users/luyuekai","html_url":"https://github.com/luyuekai","followers_url":"https://api.github.com/users/luyuekai/followers","following_url":"https://api.github.com/users/luyuekai/following{/other_user}","gists_url":"https://api.github.com/users/luyuekai/gists{/gist_id}","starred_url":"https://api.github.com/users/luyuekai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/luyuekai/subscriptions","organizations_url":"https://api.github.com/users/luyuekai/orgs","repos_url":"https://api.github.com/users/luyuekai/repos","events_url":"https://api.github.com/users/luyuekai/events{/privacy}","received_events_url":"https://api.github.com/users/luyuekai/received_events","type":"User","site_admin":false},"created_at":"2017-06-23T03:08:05Z","updated_at":"2017-06-23T03:08:05Z","author_association":"NONE","body":"When I deploy and undeploy my web application many times. I accept many Exception like this:  \r\n```java\r\nInfo:   fatal error on the network layer\r\n\tat org.elasticsearch.transport.netty4.Netty4Utils.maybeDie(Netty4Utils.java:140)\r\n\tat org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.exceptionCaught(Netty4MessageChannelHandler.java:83)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:264)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:256)\r\n\tat io.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:264)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:256)\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.exceptionCaught(DefaultChannelPipeline.java:1301)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:264)\r\n\tat io.netty.channel.DefaultChannelPipeline.fireExceptionCaught(DefaultChannelPipeline.java:914)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.handleReadException(AbstractNioByteChannel.java:104)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:145)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:624)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:524)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:478)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:438)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\nSevere:   Exception in thread \"Thread-47\"\r\nSevere:   java.lang.OutOfMemoryError: Java heap space\r\n\tat io.netty.buffer.PoolArena$HeapArena.newChunk(PoolArena.java:682)\r\n\tat io.netty.buffer.PoolArena.allocateNormal(PoolArena.java:244)\r\n\tat io.netty.buffer.PoolArena.allocate(PoolArena.java:226)\r\n\tat io.netty.buffer.PoolArena.allocate(PoolArena.java:146)\r\n\tat io.netty.buffer.PooledByteBufAllocator.newHeapBuffer(PooledByteBufAllocator.java:303)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.heapBuffer(AbstractByteBufAllocator.java:162)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.heapBuffer(AbstractByteBufAllocator.java:153)\r\n\tat io.netty.buffer.AbstractByteBufAllocator.ioBuffer(AbstractByteBufAllocator.java:135)\r\n\tat io.netty.channel.DefaultMaxMessagesRecvByteBufAllocator$MaxMessageHandle.allocate(DefaultMaxMessagesRecvByteBufAllocator.java:80)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:122)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:624)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:524)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:478)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:438)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\nInfo:   exception caught on transport layer [[id: 0x8d733bc7, L:/192.168.80.244:58172 - R:/192.168.83.248:9300]], closing connection\r\norg.elasticsearch.ElasticsearchException: java.lang.OutOfMemoryError: Java heap space\r\n\tat org.elasticsearch.transport.netty4.Netty4Transport.exceptionCaught(Netty4Transport.java:321) [transport-netty4-client-5.4.0.jar:5.4.0]\r\n\tat org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.exceptionCaught(Netty4MessageChannelHandler.java:84) [transport-netty4-client-5.4.0.jar:5.4.0]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:264) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:256) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.ChannelInboundHandlerAdapter.exceptionCaught(ChannelInboundHandlerAdapter.java:131) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:264) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireExceptionCaught(AbstractChannelHandlerContext.java:256) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.exceptionCaught(DefaultChannelPipeline.java:1301) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:264) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.DefaultChannelPipeline.fireExceptionCaught(DefaultChannelPipeline.java:914) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.handleReadException(AbstractNioByteChannel.java:104) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:145) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:624) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:524) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:478) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:438) [netty-transport-4.1.9.Final.jar:4.1.9.Final]\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858) [netty-common-4.1.9.Final.jar:4.1.9.Final]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_101]\r\n```\r\nOf course, I can restart Glassfish to avoid this every time I undeploy the application .  However,  I still wish we can solve the problem. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/370864761","html_url":"https://github.com/elastic/elasticsearch/issues/25327#issuecomment-370864761","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25327","id":370864761,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDg2NDc2MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-03-06T17:39:50Z","updated_at":"2018-03-06T17:39:50Z","author_association":"MEMBER","body":"This does not appear to be an Elasticsearch issue, closing.","performed_via_github_app":null}]