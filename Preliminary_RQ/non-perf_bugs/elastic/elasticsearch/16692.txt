{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16692","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16692/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16692/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16692/events","html_url":"https://github.com/elastic/elasticsearch/issues/16692","id":134004420,"node_id":"MDU6SXNzdWUxMzQwMDQ0MjA=","number":16692,"title":"NullPointerException on hasParentQuery when parent does not exist","user":{"login":"serhatcan","id":5612144,"node_id":"MDQ6VXNlcjU2MTIxNDQ=","avatar_url":"https://avatars2.githubusercontent.com/u/5612144?v=4","gravatar_id":"","url":"https://api.github.com/users/serhatcan","html_url":"https://github.com/serhatcan","followers_url":"https://api.github.com/users/serhatcan/followers","following_url":"https://api.github.com/users/serhatcan/following{/other_user}","gists_url":"https://api.github.com/users/serhatcan/gists{/gist_id}","starred_url":"https://api.github.com/users/serhatcan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/serhatcan/subscriptions","organizations_url":"https://api.github.com/users/serhatcan/orgs","repos_url":"https://api.github.com/users/serhatcan/repos","events_url":"https://api.github.com/users/serhatcan/events{/privacy}","received_events_url":"https://api.github.com/users/serhatcan/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-02-16T15:04:55Z","updated_at":"2018-02-14T13:30:04Z","closed_at":"2016-03-03T14:59:46Z","author_association":"NONE","active_lock_reason":null,"body":"Elastic version 2.2.0\n\n> http://localhost:9200/my_index/parent_mapping/\n\nI accidentally wrote *_has_parent *_instead of *_has_child *_and got NullPointerException.\n\n _Parent type does not have any parent of itself._\n\nWhen I wrote has_child instead of has_parent query works as expected.\n\nThis query causes exception\n\n```\n{\n  \"size\": 5,\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"query\": {\n            \"has_parent\": {\n              \"type\": \"child_mapping\",\n              \"score_mode\": \"max\",\n              \"query\": {\n                \"match_all\": {}\n              },\n              \"inner_hits\": {\n                \"from\": 0,\n                \"size\": 5\n              }\n            }\n          }\n        },\n        {\n          \"query\": {\n            \"match_all\": {}\n          }\n        }\n      ]\n    }\n  },\n  \"sort\": [\n    {\n      \"name\": \"asc\"\n    }\n  ]\n}\n\n```\n\nHere is the exception log I received:\n\n```\nRemoteTransportException[[Workit.Local][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: NullPointerExceptio\nn;\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.index.fielddata.plain.ParentChildIndexFieldData.getOrdinalMap(ParentChildIndexFieldData.java:566)\n        at org.elasticsearch.index.query.HasChildQueryParser$LateParsingQuery.rewrite(HasChildQueryParser.java:259)\n        at org.apache.lucene.search.ConstantScoreQuery.rewrite(ConstantScoreQuery.java:55)\n        at org.apache.lucene.search.BooleanQuery.rewrite(BooleanQuery.java:252)\n        at org.apache.lucene.search.BooleanQuery.rewrite(BooleanQuery.java:252)\n        at org.apache.lucene.search.IndexSearcher.rewrite(IndexSearcher.java:836)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.rewrite(ContextIndexSearcher.java:81)\n        at org.elasticsearch.search.internal.DefaultSearchContext.preProcess(DefaultSearchContext.java:232)\n        at org.elasticsearch.search.query.QueryPhase.preProcess(QueryPhase.java:103)\n        at org.elasticsearch.search.SearchService.createContext(SearchService.java:674)\n        at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:618)\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:461)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchSer\nviceTransportAction.java:392)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchSer\nviceTransportAction.java:389)\n        at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n[2016-02-16 16:54:02,014][DEBUG][action.search.type       ] [Workit.Local] All shards failed for phase: [query_fetch]\nRemoteTransportException[[Workit.Local][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: NullPointerExceptio\nn;\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.index.fielddata.plain.ParentChildIndexFieldData.getOrdinalMap(ParentChildIndexFieldData.java:566)\n        at org.elasticsearch.index.query.HasChildQueryParser$LateParsingQuery.rewrite(HasChildQueryParser.java:259)\n        at org.apache.lucene.search.ConstantScoreQuery.rewrite(ConstantScoreQuery.java:55)\n        at org.apache.lucene.search.BooleanQuery.rewrite(BooleanQuery.java:252)\n        at org.apache.lucene.search.BooleanQuery.rewrite(BooleanQuery.java:252)\n        at org.apache.lucene.search.IndexSearcher.rewrite(IndexSearcher.java:836)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.rewrite(ContextIndexSearcher.java:81)\n        at org.elasticsearch.search.internal.DefaultSearchContext.preProcess(DefaultSearchContext.java:232)\n        at org.elasticsearch.search.query.QueryPhase.preProcess(QueryPhase.java:103)\n        at org.elasticsearch.search.SearchService.createContext(SearchService.java:674)\n        at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:618)\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:461)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchSer\nviceTransportAction.java:392)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchSer\nviceTransportAction.java:389)\n        at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n[2016-02-16 16:54:02,024][INFO ][rest.suppressed          ] /my_index/type/_search Params: {index=my_index, type=type}\nFailed to execute phase [query_fetch], all shards failed; shardFailures {[F6pFRctSR4CSS1stcYFiyA][my_index][0]: RemoteTranspor\ntException[[Workit.Local][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: NullPointerException; }\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(TransportSearchTypeAc\ntion.java:228)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$1.onFailure(TransportSearchTypeAction.ja\nva:174)\n        at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:46)\n        at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:821)\n        at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:799)\n        at org.elasticsearch.transport.TransportService$4.onFailure(TransportService.java:361)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: ; nested: NullPointerException;\n        at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:386)\n        at org.elasticsearch.action.search.SearchPhaseExecutionException.guessRootCauses(SearchPhaseExecutionException.java:152)\n        at org.elasticsearch.action.search.SearchPhaseExecutionException.getCause(SearchPhaseExecutionException.java:99)\n        at java.lang.Throwable.printStackTrace(Throwable.java:665)\n        at java.lang.Throwable.printStackTrace(Throwable.java:721)\n        at org.apache.log4j.DefaultThrowableRenderer.render(DefaultThrowableRenderer.java:60)\n        at org.apache.log4j.spi.ThrowableInformation.getThrowableStrRep(ThrowableInformation.java:87)\n        at org.apache.log4j.spi.LoggingEvent.getThrowableStrRep(LoggingEvent.java:413)\n        at org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:313)\n        at org.apache.log4j.WriterAppender.append(WriterAppender.java:162)\n        at org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:251)\n        at org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:66)\n        at org.apache.log4j.Category.callAppenders(Category.java:206)\n        at org.apache.log4j.Category.forcedLog(Category.java:391)\n        at org.apache.log4j.Category.log(Category.java:856)\n        at org.elasticsearch.common.logging.log4j.Log4jESLogger.internalInfo(Log4jESLogger.java:125)\n        at org.elasticsearch.common.logging.support.AbstractESLogger.info(AbstractESLogger.java:90)\n        at org.elasticsearch.rest.BytesRestResponse.convert(BytesRestResponse.java:131)\n        at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:96)\n        at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:87)\n        at org.elasticsearch.rest.action.support.RestActionListener.onFailure(RestActionListener.java:60)\n        at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.raiseEarlyFailure(TransportSearchTypeAct\nion.java:316)\n        ... 10 more\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.index.fielddata.plain.ParentChildIndexFieldData.getOrdinalMap(ParentChildIndexFieldData.java:566)\n        at org.elasticsearch.index.query.HasChildQueryParser$LateParsingQuery.rewrite(HasChildQueryParser.java:259)\n        at org.apache.lucene.search.ConstantScoreQuery.rewrite(ConstantScoreQuery.java:55)\n        at org.apache.lucene.search.BooleanQuery.rewrite(BooleanQuery.java:252)\n        at org.apache.lucene.search.BooleanQuery.rewrite(BooleanQuery.java:252)\n        at org.apache.lucene.search.IndexSearcher.rewrite(IndexSearcher.java:836)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.rewrite(ContextIndexSearcher.java:81)\n        at org.elasticsearch.search.internal.DefaultSearchContext.preProcess(DefaultSearchContext.java:232)\n        at org.elasticsearch.search.query.QueryPhase.preProcess(QueryPhase.java:103)\n        at org.elasticsearch.search.SearchService.createContext(SearchService.java:674)\n        at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:618)\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:461)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchSer\nviceTransportAction.java:392)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchSer\nviceTransportAction.java:389)\n        at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n        ... 3 more\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}