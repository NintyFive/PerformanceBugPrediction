{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37108","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37108/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37108/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37108/events","html_url":"https://github.com/elastic/elasticsearch/issues/37108","id":395574292,"node_id":"MDU6SXNzdWUzOTU1NzQyOTI=","number":37108,"title":"[ML][CI] Unterminated update process task fails tests","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-01-03T13:33:32Z","updated_at":"2019-01-29T15:09:40Z","closed_at":"2019-01-29T15:09:40Z","author_association":"MEMBER","active_lock_reason":null,"body":"https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+multijob-unix-compatibility/os=debian/156/console\r\n\r\nA number of tests failed in `XPackRestIT` because of the autodetect update process tasks had not finished during the post test clean up\r\n```\r\njava.lang.AssertionError: 2 active tasks found:\r\ncluster:internal/xpack/ml/job/update/process    _JTPNiDnTSebLObvZ_0c-Q:23948 -                            transport 1546458770524 19:52:50 31.4s       127.0.0.1 node-0 \r\ncluster:internal/xpack/ml/job/update/process[n] _JTPNiDnTSebLObvZ_0c-Q:23949 _JTPNiDnTSebLObvZ_0c-Q:23948 direct    1546458770524 19:52:50 31.4s       127.0.0.1 node-0 \r\n expected:<0> but was:<2>\r\n\tat __randomizedtesting.SeedInfo.seed([C4836DEA74C9C87C:4CD75230DA35A584]:0)\r\n\tat org.junit.Assert.fail(Assert.java:88)\r\n\tat org.junit.Assert.failNotEquals(Assert.java:834)\r\n\tat org.junit.Assert.assertEquals(Assert.java:645)\r\n\tat org.elasticsearch.test.rest.ESRestTestCase.lambda$waitForPendingTasks$1(ESRestTestCase.java:341)\r\n```\r\n\r\nAll the failures were due to the same unterminated task which was created during `ml/jobs_crud/Test update job`. When a job is updated and autodetect needs to also receive the same change then the autodetect update is scheduled to run later after the API call returns. At the end of the test the job is closed and deleted in the clean up section creating a race between updating autodetect and closing the job. It appears likely the update task that never terminated got involved in a race with closing/deleting the job.\r\n\r\nWrites the autodetect process are queued and executed consecutively in order by `AutodetectWorkerExecutorService` the problem seems to be that [AutodetectWorkerExecutorService.execute](https://github.com/elastic/elasticsearch/blob/master/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/job/process/autodetect/AutodetectProcessManager.java#L776) will accept a new runnable after it has been shutdown. This explains the hung task as it was scheduled after the job closed the stopped the executor and so was never executed.  \r\n\r\n \r\n\r\n  ","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}