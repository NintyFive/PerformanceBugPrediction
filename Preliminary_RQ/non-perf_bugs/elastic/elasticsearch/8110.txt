{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8110","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8110/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8110/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8110/events","html_url":"https://github.com/elastic/elasticsearch/issues/8110","id":45986185,"node_id":"MDU6SXNzdWU0NTk4NjE4NQ==","number":8110,"title":"Reducers - Post processing of aggregation results","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":39,"created_at":"2014-10-16T13:36:39Z","updated_at":"2016-10-31T14:29:49Z","closed_at":"2015-01-14T09:46:05Z","author_association":"MEMBER","active_lock_reason":null,"body":"# Overview\n\nThis feature would introduce a new 'reducers' module, allowing for the processing and transformation of aggregation results. The current aggregation module is very powerful and can compute varied and complex analytics but is limited when calculating analytics which depend on numerous independently calculated aggregated metrics. Currently, the only way to calculate these types of complex metrics is to write client side logic.  The reducer module will add a new phase in the search request where the coordinating node can pass the reduced aggregations for further processing.\n# Key Concepts & Terminology\n- _Reducer_ - A reducer is the computation unit which receives a `bucket aggregation` and uses it's set of buckets to perform calculations and generate a new `aggregation` which represents either a single answer (a new `metric aggregation`) or a new set of buckets (a new `bucket aggregation`). Reducers run after aggregations and act on the result tree returned by aggregations or the result tree of previous reducers. There are 2 types of `reducer`:\n  - _Bucket reducer_ - Take all specified buckets and divide them into groups (`selections`). A `bucket reducer` may create new buckets to add to the `selections` but is not able to modify existing buckets.\n  - _Metric reducer_ - Performs calculations on the input aggregation and outputs a single result (i.e. cannot create buckets)\n## Reducer Structure\n\nThe following snippet captures the basic structure of aggregations:\n\n``` javascript\n\"reducers\" : [\n    {\n        \"<reducer_name>\" : {\n            \"<reducer_type>\" : {\n                <reducer_body>\n            },\n            \"reducers\" : [ \n                {\n                    <sub_reducer_1>\n                },\n                {\n                    <sub_reducer_2>\n                },\n                ...\n           ] \n        }\n    },\n    {\n        \"<reducer_name_2>\" : { ... }\n    },    ...\n]\n```\n\nSome rules for reducers requests:\n- reducers and aggregations are separate in the request structure\n- reducers are specified in order because they can process the output of other reducers\n- reducers can be nested, in which case they only see the data for the bucket they're in, although they can refer to any value in the tree with `_root.path.to.value`\n# Use Cases\n\nSome possible implementations of reducers are detailed below:\n## Bucket Reducers\n- Sliding window - Can be used with the results of a histogram aggregation to produce selections representing a sliding time window of buckets. The reducer would create a selection for each bucket in the histogram aggregation which contains the bucket and the N subsequent buckets (where N is a configurable window size). \n## Metric Reducers\n- Avg/Min/Max/Sum/Stats - Same as their aggregation equivalent except they calculate the result for a particular field in their input aggregation's buckets.\n- Delta - Calculates the range of the values of a field between the input buckets\n- Gradient - Calculates the range of values of two fields between the input buckets and returns the result of the first divided by the second (e.g. change in price divided by change in time)\n## Example\n\nAs an example, imagine that you have sales data in an index and you would like to calculate the derivative of the price field over time. This is useful for determining trends in the data, such as whether sales are increasing linearly over time.\n\nYou might start with the following aggregation:\n\n``` javascript\n{\n  \"aggs\": {\n    \"months\": {\n      \"date_histogram\": {\n        \"field\": \"date\",\n        \"interval\": \"month\"\n      },\n      \"aggs\": {\n        \"avg_price\": {\n          \"avg\": {\n            \"field\": \"price\"\n          }\n        }\n      }\n    }\n  }\n}\n\n```\n\nThe results of these aggregations might look something like the following:\n\n``` javascript\n\"aggregations\": {\n  \"months\": {\n     \"buckets\": [\n        {\n           \"key_as_string\": \"2014/02/01 00:00:00\",\n           \"key\": 1391212800000,\n           \"doc_count\": 6,\n           \"avg_price\": {\n              \"value\": 11\n           }\n        },\n        {\n           \"key_as_string\": \"2014/03/01 00:00:00\",\n           \"key\": 1391212800000,\n           \"doc_count\": 4,\n           \"avg_price\": {\n              \"value\": 19\n           }\n        },\n        {\n           \"key_as_string\": \"2014/04/01 00:00:00\",\n           \"key\": 1391212800000,\n           \"doc_count\": 8,\n           \"avg_price\": {\n              \"value\": 31\n           }\n        }\n     ]\n  }\n}\n```\n\nThe sliding window reducer could then be used to request time windows of two months. A nested delta reducer inside the sliding window reducer could be used to calculate the rate of change of price for each two month selection.\n\n``` javascript\n\"reducers\": [\n  {\n    \"two_months\": {\n      \"sliding_window\": {\n        \"buckets\": \"months\",\n        \"window\": 2\n      },\n      \"reducers\": [\n        {\n          \"price_derivative\": {\n            \"gradient\": {\n              \"field\": \"avg_price.value\"\n            }\n          }\n        }\n      ]\n    }\n  }\n]\n\n```\n\nWhich would produce the following response (derivative value is shown in price per month):\n\n``` javascript\n{\n  \"reducers\": {\n    \"two_months\": {\n      \"selections\": [\n        {\n          \"buckets\": [\n            {\n              \"key_as_string\": \"2014/02/01 00:00:00\",\n              \"key\": 1391212800000,\n              \"doc_count\": 6,\n              \"avg_price\": {\n                \"value\": 11\n              }\n            },\n            {\n              \"key_as_string\": \"2014/03/01 00:00:00\",\n              \"key\": 1391212800000,\n              \"doc_count\": 4,\n              \"avg_price\": {\n                \"value\": 19\n              }\n            }\n          ],\n          \"price_derivative\": {\n            \"value\": 8\n          }\n        },\n        {\n          \"buckets\": [\n            {\n              \"key_as_string\": \"2014/03/01 00:00:00\",\n              \"key\": 1391212800000,\n               \"doc_count\": 4,\n               \"avg_price\": {\n                \"value\": 19\n               }\n            },\n            {\n              \"key_as_string\": \"2014/04/01 00:00:00\",\n              \"key\": 1391212800000,\n              \"doc_count\": 8,\n              \"avg_price\": {\n                \"value\": 31\n              }\n            }\n          ],\n          \"price_derivative\": {\n            \"value\": 12\n          }\n        }\n      ]\n    }\n  }\n}\n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}