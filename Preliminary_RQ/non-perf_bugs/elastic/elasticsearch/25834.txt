{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25834","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25834/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25834/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25834/events","html_url":"https://github.com/elastic/elasticsearch/issues/25834","id":244751068,"node_id":"MDU6SXNzdWUyNDQ3NTEwNjg=","number":25834,"title":"Index Migration Failure for Mapper Attachment after upgrading elasticsearch to 5.5.0 from 5.3.1 ","user":{"login":"frankliu81","id":16039389,"node_id":"MDQ6VXNlcjE2MDM5Mzg5","avatar_url":"https://avatars3.githubusercontent.com/u/16039389?v=4","gravatar_id":"","url":"https://api.github.com/users/frankliu81","html_url":"https://github.com/frankliu81","followers_url":"https://api.github.com/users/frankliu81/followers","following_url":"https://api.github.com/users/frankliu81/following{/other_user}","gists_url":"https://api.github.com/users/frankliu81/gists{/gist_id}","starred_url":"https://api.github.com/users/frankliu81/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frankliu81/subscriptions","organizations_url":"https://api.github.com/users/frankliu81/orgs","repos_url":"https://api.github.com/users/frankliu81/repos","events_url":"https://api.github.com/users/frankliu81/events{/privacy}","received_events_url":"https://api.github.com/users/frankliu81/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-07-21T18:40:42Z","updated_at":"2017-08-17T17:22:23Z","closed_at":"2017-08-17T17:22:22Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n[xOOEXQB-RzGhQp7o7NNH9w.zip](https://github.com/elastic/elasticsearch/files/1166429/xOOEXQB-RzGhQp7o7NNH9w.zip)\r\n\r\n[elasticsearch_unable_to_upgrade_index.log.zip](https://github.com/elastic/elasticsearch/files/1166451/elasticsearch_unable_to_upgrade_index.log.zip)\r\n<!--\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**:\r\n5.5.0 (upgrading\r\n\r\n from 5.3.1 using homebrew on Mac El Capitan)\r\n\r\n**Plugins installed**: []\r\nMapper Attachment plugin\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_131\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_131-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.131-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin frank-liu-mbp15.local 15.6.0 Darwin Kernel Version 15.6.0: Tue Apr 11 16:00:51 PDT 2017; root:xnu-3248.60.11.5.3~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Install ElasticSearch 5.3.1 (I have installed with homebrew).  Install the mapper attachment plugin for document search.  Create the document index using the following snippet on a Document model in Rails and using the elasticsearch_rails gem.\r\n\r\n```\r\nclass Document < ActiveRecord::Base\r\n  mount_uploader :document_attachment, DocumentAttachmentUploader\r\n\r\n  # elasticsearch-rails\r\n  include Elasticsearch::Model\r\n  include Elasticsearch::Model::Callbacks\r\n\r\n  settings index: { number_of_shards: 3 } do\r\n   mappings do\r\n     indexes :title\r\n     indexes :attachment, type: 'attachment'\r\n   end\r\n  end\r\n\r\n  def as_indexed_json(options={})\r\n    self.as_json({\r\n      methods: [:attachment]\r\n    })\r\n  end\r\n\r\n  def attachment\r\n    path_to_attachment = document_attachment.file.file\r\n    Base64.encode64(open(path_to_attachment) { |file| file.read })\r\n  end\r\nend\r\n\r\nDocument.import(force: true)\r\n```\r\n\r\n 2. Install elasticsearch 5.5.0 (this was done on my machine via, homebrew upgrade elasticsearch)\r\n\r\n 3. Start elasticsearch with 'elasticsearch'.  It is unable to start with:\r\nCaused by: java.lang.IllegalStateException: unable to upgrade the mappings for the index [[documents/xOOEXQB-RzGhQp7o7NNH9w]] \r\n\r\n**Provide logs (if relevant)**:\r\nThe log for starting elasticsearch and the offending index folder from \r\n/usr/local/var/elasticsearch/nodes/0 are attached.\r\n","closed_by":{"login":"frankliu81","id":16039389,"node_id":"MDQ6VXNlcjE2MDM5Mzg5","avatar_url":"https://avatars3.githubusercontent.com/u/16039389?v=4","gravatar_id":"","url":"https://api.github.com/users/frankliu81","html_url":"https://github.com/frankliu81","followers_url":"https://api.github.com/users/frankliu81/followers","following_url":"https://api.github.com/users/frankliu81/following{/other_user}","gists_url":"https://api.github.com/users/frankliu81/gists{/gist_id}","starred_url":"https://api.github.com/users/frankliu81/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/frankliu81/subscriptions","organizations_url":"https://api.github.com/users/frankliu81/orgs","repos_url":"https://api.github.com/users/frankliu81/repos","events_url":"https://api.github.com/users/frankliu81/events{/privacy}","received_events_url":"https://api.github.com/users/frankliu81/received_events","type":"User","site_admin":false},"performed_via_github_app":null}