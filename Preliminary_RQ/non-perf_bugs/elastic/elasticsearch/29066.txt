{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29066","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29066/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29066/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29066/events","html_url":"https://github.com/elastic/elasticsearch/issues/29066","id":305213015,"node_id":"MDU6SXNzdWUzMDUyMTMwMTU=","number":29066,"title":"Inconsistent return value across metric aggregations when no docs in bucket contain field","user":{"login":"peteharverson","id":7405507,"node_id":"MDQ6VXNlcjc0MDU1MDc=","avatar_url":"https://avatars1.githubusercontent.com/u/7405507?v=4","gravatar_id":"","url":"https://api.github.com/users/peteharverson","html_url":"https://github.com/peteharverson","followers_url":"https://api.github.com/users/peteharverson/followers","following_url":"https://api.github.com/users/peteharverson/following{/other_user}","gists_url":"https://api.github.com/users/peteharverson/gists{/gist_id}","starred_url":"https://api.github.com/users/peteharverson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/peteharverson/subscriptions","organizations_url":"https://api.github.com/users/peteharverson/orgs","repos_url":"https://api.github.com/users/peteharverson/repos","events_url":"https://api.github.com/users/peteharverson/events{/privacy}","received_events_url":"https://api.github.com/users/peteharverson/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-03-14T15:39:07Z","updated_at":"2018-06-18T14:01:29Z","closed_at":"2018-06-18T14:01:29Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion 6.2.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nDifferent metric aggregations are returning different values when none of the documents in the bucket contain the field used in the aggregation. `avg`, `min` and `max` for example return `null`, whereas the `percentiles` agg returns `NaN`. I would expect the return values to be consistent across aggregations, whether it be `null` or `NaN`.\r\n\r\nRan the following aggregations, where some buckets contained docs without the `test.sslTime` field.\r\n\r\navg agg:\r\n```\r\n\"aggs\": {\r\n    \"2\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"createdDate\",\r\n        \"interval\": \"15m\",\r\n        \"time_zone\": \"Europe/London\",\r\n        \"min_doc_count\": 1\r\n      },\r\n      \"aggs\": {\r\n        \"3\": {\r\n          \"terms\": {\r\n            \"field\": \"test.testId.keyword\",\r\n            \"size\": 5,\r\n            \"order\": {\r\n              \"_term\": \"desc\"\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"1\": {\r\n              \"avg\": {\r\n                \"field\": \"test.sslTime\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n```\r\n\r\nPercentiles agg, to obtain the median:\r\n```\r\n\"aggs\": {\r\n    \"2\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"createdDate\",\r\n        \"interval\": \"15m\",\r\n        \"time_zone\": \"Europe/London\",\r\n        \"min_doc_count\": 1\r\n      },\r\n      \"aggs\": {\r\n        \"3\": {\r\n          \"terms\": {\r\n            \"field\": \"test.testId.keyword\",\r\n            \"size\": 5,\r\n            \"order\": {\r\n              \"_term\": \"desc\"\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"1\": {\r\n              \"percentiles\": {\r\n                \"field\": \"test.sslTime\",\r\n                \"percents\": [\r\n                  50\r\n                ],\r\n                \"keyed\": false\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n```\r\nWIth example of the responses:\r\n\r\nFrom the avg agg:\r\n```\r\n       {\r\n          \"3\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"1\": {\r\n                  \"value\": null\r\n                },\r\n                \"key\": \"VAL1\",\r\n                \"doc_count\": 6\r\n              }\r\n            ]\r\n          },\r\n          \"key_as_string\": \"2018-02-03T11:45:00.000Z\",\r\n          \"key\": 1517658300000,\r\n          \"doc_count\": 6\r\n        }\r\n```\r\n\r\nand from the percentiles agg:\r\n```\r\n     {\r\n          \"3\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"1\": {\r\n                  \"values\": [\r\n                    {\r\n                      \"key\": 50,\r\n                      \"value\": \"NaN\"\r\n                    }\r\n                  ]\r\n                },\r\n                \"key\": \"VAL1\",\r\n                \"doc_count\": 6\r\n              }\r\n            ]\r\n          },\r\n          \"key_as_string\": \"2018-02-03T11:45:00.000Z\",\r\n          \"key\": 1517658300000,\r\n          \"doc_count\": 6\r\n        }\r\n```\r\n\r\n\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}