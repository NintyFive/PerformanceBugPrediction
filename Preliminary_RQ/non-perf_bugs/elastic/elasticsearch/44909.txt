{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44909/events","html_url":"https://github.com/elastic/elasticsearch/issues/44909","id":473402985,"node_id":"MDU6SXNzdWU0NzM0MDI5ODU=","number":44909,"title":"Terms aggregations shows partial results with terms aggregation over invalid field","user":{"login":"greentruff","id":787837,"node_id":"MDQ6VXNlcjc4NzgzNw==","avatar_url":"https://avatars2.githubusercontent.com/u/787837?v=4","gravatar_id":"","url":"https://api.github.com/users/greentruff","html_url":"https://github.com/greentruff","followers_url":"https://api.github.com/users/greentruff/followers","following_url":"https://api.github.com/users/greentruff/following{/other_user}","gists_url":"https://api.github.com/users/greentruff/gists{/gist_id}","starred_url":"https://api.github.com/users/greentruff/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/greentruff/subscriptions","organizations_url":"https://api.github.com/users/greentruff/orgs","repos_url":"https://api.github.com/users/greentruff/repos","events_url":"https://api.github.com/users/greentruff/events{/privacy}","received_events_url":"https://api.github.com/users/greentruff/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2019-07-26T15:02:01Z","updated_at":"2019-07-30T08:28:30Z","closed_at":"2019-07-30T08:28:30Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.8.1\r\nWorks as expected in 6.4.3.\r\nUnexpected behavior for versions 6.5.3 to 6.8.1\r\n\r\n**Plugins installed**: Default plugins in docker image provided Elastic\r\n\r\n**JVM version** (`java -version`): 11.0\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAggregations with a term referrencing a `min` aggregation over an invalid field does not return results per bucket. Other aggregations are not affected.\r\n\r\n**Steps to reproduce**:\r\n\r\nThe following script reproduces the issue on a local default ES instance:\r\n```python\r\nimport requests\r\n\r\nES = 'http://localhost:9200'\r\n\r\n## Set up\r\nrequests.delete(ES + '/parrot')\r\n\r\nrequests.put(ES + '/parrot')\r\n\r\nrequests.post(ES + '/parrot/doc', json={ \"a\": 1, \"b\": 2 })\r\nrequests.post(ES + '/parrot/doc', json={ \"a\": 1, \"b\": 2 })\r\nrequests.post(ES + '/parrot/doc', json={ \"a\": 2, \"b\": 3 })\r\n\r\nrequests.post(ES + '/parrot/_refresh')\r\n\r\nresp = requests.get(ES + '/parrot/_search', json={\r\n    \"size\":0,\r\n    \"timeout\":\"1m\",\r\n    \"query\":{\r\n        \"constant_score\":{\r\n            \"filter\":{\r\n                \"bool\":{\r\n                    \"filter\":[{\"exists\":{\"field\":\"a\",\"boost\":1.0}}],\r\n                    \"adjust_pure_negative\":True,\"boost\":1.0\r\n                }\r\n            },\"boost\":1.0\r\n        }\r\n    },\r\n    \"aggregations\":{\r\n        \"v__max:max\":{\"max\":{\"field\":\"invalid\"}},\r\n        \"a\":{\"terms\":{\"field\":\"a\",\"show_term_doc_count_error\":False,\"order\":[{\"v__max:max\":\"asc\"},{\"_key\":\"asc\"}]},\r\n        \"aggregations\":{\"v__max:max\":{\"max\":{\"field\":\"invalid\"}}}}\r\n    }\r\n})\r\nprint(resp.json())\r\n\r\nresp = requests.get(ES + '/parrot/_search', json={\r\n    \"size\":0,\r\n    \"timeout\":\"1m\",\r\n    \"query\":{\r\n        \"constant_score\":{\r\n            \"filter\":{\r\n                \"bool\":{\r\n                    \"filter\":[{\"exists\":{\"field\":\"a\",\"boost\":1.0}}],\r\n                    \"adjust_pure_negative\":True,\"boost\":1.0\r\n                }\r\n            },\"boost\":1.0\r\n        }\r\n    },\r\n    \"aggregations\":{\r\n        \"v__min:min\":{\"min\":{\"field\":\"invalid\"}},\r\n        \"a\":{\"terms\":{\"field\":\"a\",\"show_term_doc_count_error\":False,\"order\":[{\"v__min:min\":\"asc\"},{\"_key\":\"asc\"}]},\r\n        \"aggregations\":{\"v__min:min\":{\"min\":{\"field\":\"invalid\"}}}}\r\n    }\r\n})\r\nprint(resp.json())\r\n```\r\n\r\nActual behavior:\r\n```\r\n{\r\n  'took':369,\r\n  'timed_out':False,\r\n  '_shards':{\r\n    'total':5,\r\n    'successful':5,\r\n    'skipped':0,\r\n    'failed':0\r\n  },\r\n  'hits':{\r\n    'total':3,\r\n    'max_score':0.0,\r\n    'hits':[\r\n\r\n    ]\r\n  },\r\n  'aggregations':{\r\n    'a':{\r\n      'doc_count_error_upper_bound':0,\r\n      'sum_other_doc_count':0,\r\n      'buckets':[\r\n        {\r\n          'key':1,\r\n          'doc_count':2,\r\n          'v__max:max':{\r\n            'value':None\r\n          }\r\n        },\r\n        {\r\n          'key':2,\r\n          'doc_count':1,\r\n          'v__max:max':{\r\n            'value':None\r\n          }\r\n        }\r\n      ]\r\n    },\r\n    'v__max:max':{\r\n      'value':None\r\n    }\r\n  }\r\n}\r\n```\r\n```\r\n{\r\n  'took':22,\r\n  'timed_out':False,\r\n  '_shards':{\r\n    'total':5,\r\n    'successful':5,\r\n    'skipped':0,\r\n    'failed':0\r\n  },\r\n  'hits':{\r\n    'total':3,\r\n    'max_score':0.0,\r\n    'hits':[\r\n\r\n    ]\r\n  },\r\n  'aggregations':{\r\n    'a':{\r\n      'doc_count_error_upper_bound':0,\r\n      'sum_other_doc_count':0,\r\n      'buckets':[\r\n\r\n      ]\r\n    },\r\n    'v__min:min':{\r\n      'value':None\r\n    }\r\n  }\r\n}\r\n```\r\nThe query with min returns no buckets.\r\n\r\nExpected behavior:\r\n\r\n```\r\n{'took': 256, 'timed_out': False, '_shards': {'total': 5, 'successful': 5, 'skipped': 0, 'failed': 0}, 'hits': {'total': 3, 'max_score': 0.0, 'hits': []}, 'aggregations': {'a': {'doc_count_error_upper_bound': 0, 'sum_other_doc_count': 0, 'buckets': [{'key': 1, 'doc_count': 2, 'v__max:max': {'value': None}}, {'key': 2, 'doc_count': 1, 'v__max:max': {'value': None}}]}, 'v__max:max': {'value': None}}}\r\n```\r\n```\r\n{'took': 156, 'timed_out': False, '_shards': {'total': 5, 'successful': 5, 'skipped': 0, 'failed': 0}, 'hits': {'total': 3, 'max_score': 0.0, 'hits': []}, 'aggregations': {'a': {'doc_count_error_upper_bound': 0, 'sum_other_doc_count': 0, 'buckets': [{'key': 1, 'doc_count': 2, 'v__min:min': {'value': None}}, {'key': 2, 'doc_count': 1, 'v__min:min': {'value': None}}]}, 'v__min:min': {'value': None}}}\r\n```\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}