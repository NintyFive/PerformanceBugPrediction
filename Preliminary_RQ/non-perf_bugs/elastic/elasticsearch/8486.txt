{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8486","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8486/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8486/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8486/events","html_url":"https://github.com/elastic/elasticsearch/issues/8486","id":48807850,"node_id":"MDU6SXNzdWU0ODgwNzg1MA==","number":8486,"title":"Order by scripted_metric sub aggregation","user":{"login":"eryabitskiy","id":994670,"node_id":"MDQ6VXNlcjk5NDY3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/994670?v=4","gravatar_id":"","url":"https://api.github.com/users/eryabitskiy","html_url":"https://github.com/eryabitskiy","followers_url":"https://api.github.com/users/eryabitskiy/followers","following_url":"https://api.github.com/users/eryabitskiy/following{/other_user}","gists_url":"https://api.github.com/users/eryabitskiy/gists{/gist_id}","starred_url":"https://api.github.com/users/eryabitskiy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eryabitskiy/subscriptions","organizations_url":"https://api.github.com/users/eryabitskiy/orgs","repos_url":"https://api.github.com/users/eryabitskiy/repos","events_url":"https://api.github.com/users/eryabitskiy/events{/privacy}","received_events_url":"https://api.github.com/users/eryabitskiy/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":94,"created_at":"2014-11-14T16:18:46Z","updated_at":"2020-05-05T05:12:49Z","closed_at":"2016-12-07T14:37:02Z","author_association":"NONE","active_lock_reason":null,"body":"Since there is a new Scripted metric aggregation (scripted_metric) in 1.4, it is possible to do a lot of amazing stuff. \nFor example it is possible to implement Weighted Average aggregation, which we were missing before.\n\nNow we are really missing a **possibility to sort by scripted_metric results**.\n\n**Live example**:\n\nWe calculate **weightedAvgVis** with scripted_metric and want to get ids with **TOP 5 values of weightedAvgVis**. Since script returns double, it looks logically possible. \n\n``` json\n{  \n   \"from\":0,\n   \"size\":0,\n   \"query\":{  \n      \"match_all\":{   }\n   },\n   \"aggregations\":{  \n      \"idNodes\":{  \n         \"terms\":{  \n            \"field\":\"id\",\n            \"size\":5,\n            \"order\":{  \n               \"weightedAvgVis\":\"asc\"\n            }\n         },\n         \"aggregations\":{  \n            \"weightedAvgVis\":{  \n               \"scripted_metric\":{  \n                  \"init_script\":\"_agg['weightedSum'] = 0d; _agg['countSum'] = 0L;\",\n                  \"map_script\":\"_agg['weightedSum'] = _agg.weightedSum + _source['avgVis'] * _source['count']; _agg['countSum'] = _agg.countSum + _source['count'];\",\n                  \"reduce_script\":\"weightedSum = 0d; countSum = 0L; for(a in _aggs) {weightedSum += a.weightedSum; countSum += a.countSum;};if(countSum == 0L) {return 0d;} else {return weightedSum / countSum}\"\n               }\n            }\n         }\n      }\n   }\n}\n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}