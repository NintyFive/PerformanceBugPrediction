[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237692224","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237692224","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237692224,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzY5MjIyNA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T21:40:46Z","updated_at":"2016-08-04T21:40:46Z","author_association":"CONTRIBUTOR","body":"Hmm I am confused: does it mean that for instance Lucene's JapaneseAnalyzer is not exposed anymore?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237695248","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237695248","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237695248,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzY5NTI0OA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T21:53:35Z","updated_at":"2016-08-04T21:53:35Z","author_association":"MEMBER","body":"@jpountz it is exposed but if you run elasticsearch with kuromoji plugin and create 100 indices with no settings. You get this:\n\n![screen shot 2016-08-04 at 5 50 26 pm](https://cloud.githubusercontent.com/assets/655851/17419547/f932d38e-5a6b-11e6-9e04-7f93693bdac4.png)\n\nBasically, you get 100 Kuromoji Factories of different kinds, 100 Fingerprint analyzers and 100 Serbian Normalization Filter Factories. At the same time you get only one SnowballAnalyzer, for example.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237706745","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237706745","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237706745,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzcwNjc0NQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-08-04T22:46:48Z","updated_at":"2016-08-04T22:46:48Z","author_association":"CONTRIBUTOR","body":"the difference here is that we have some analyzers that are shared across indices but those can't be configured. The Kuromoji factories where always like this since they are tokenizer, tokenfilter and char filter factories. They where always per index never prebuilt. This only applied to analyzers. We have a set of pre-built ones in core which I think is enough we don't need to expose this to plugins. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237727654","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237727654","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237727654,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzcyNzY1NA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-08-05T00:47:54Z","updated_at":"2016-08-05T03:37:49Z","author_association":"MEMBER","body":"Ok, I did a bit more digging. So, basically this is what I've done. I created two one-node clusters with all default settings. One cluster with v2.3.4 node with kuromoji plugin installed and another cluster was just a node with today's master that I started from the kuromoji plugin directory using gradle run. I could retry it with a packaged installation but I don't think it would make any difference. After starting each node I ran a script that created 100 indices with default settings:\n\n```\nfor i in {1..100}; do curl -XPUT localhost:9200/test-$i; done\n```\n\nThen I created a heap dump for each node and analyzed them in YourKit. This is the screenshot for 2.3.4:\n\n![screen shot 2016-08-04 at 8 15 09 pm](https://cloud.githubusercontent.com/assets/655851/17422492/8ab753de-5a80-11e6-8774-04ddddcaec20.png)\n![screen shot 2016-08-04 at 8 33 32 pm](https://cloud.githubusercontent.com/assets/655851/17422748/ca21c854-5a82-11e6-8f9c-2d627159a8a8.png)\n\nAnd this is the picture for the current master:\n\n![screen shot 2016-08-04 at 8 14 55 pm](https://cloud.githubusercontent.com/assets/655851/17422496/a25c8144-5a80-11e6-80cf-9e6ccbf6a1de.png)\n![screen shot 2016-08-04 at 8 37 29 pm](https://cloud.githubusercontent.com/assets/655851/17422813/5a1a2a96-5a83-11e6-981e-ea3780a10c20.png)\n\nI think removal of [KuromojiIndicesAnalysis](https://github.com/elastic/elasticsearch/pull/14355/files#diff-20f0ed6d04eea4b1d70143e98326e68cL44) is the reason why this is happening. \n\nAs you can see in 2.3.4 only JapaneseStopTokenFilterFactory is created 100 times and I think this is because we forgot to register its prebuilt version in KuromojiIndicesAnalysis, which looks like a bug in 2.3.4 (See #19816)\n\nSo, I think @nik9000's and my original question was \"Is there a way to do something similar in master?\"\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237802276","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237802276","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237802276,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzgwMjI3Ng==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-08-05T09:12:50Z","updated_at":"2016-08-05T09:12:50Z","author_association":"CONTRIBUTOR","body":"There are many issues with these pre-bulid analyzers/filters/tokenizers. Some have different behavior depending on the version the index was created. Caching is very very difficult here and we reduced it to the core components here. I really think we simplified this for our users and don't force them to make any difficult decisions but rather trade it for the fact that we create a new instance per index for the analyzers coming from a plugin. \n\nI am convinced that safety first is important here, if we mess up the caching it means the index is corrupt. I think it's ok to have extra instances based on this concern. \nYet, I do think there might be options to cache by version but I wonder if that is worth the trouble? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237834404","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237834404","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237834404,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzgzNDQwNA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-08-05T12:09:09Z","updated_at":"2016-08-05T12:09:09Z","author_association":"CONTRIBUTOR","body":"@imotov @nik9000 I reference this from a commit here https://github.com/s1monw/elasticsearch/commit/35ee27ec9b8c931b229e3b6d5041489f82c6bbf4 I think we can do stuff like this but we have to keep it internal. Don't complicate the interface for the optimization it's crucial to the success of our plugin APIs. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237855251","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237855251","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237855251,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzg1NTI1MQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-08-05T13:49:51Z","updated_at":"2016-08-05T13:49:51Z","author_association":"CONTRIBUTOR","body":"I just had an offline conversation with @nik9000 @imotov and we concluded that it might be the best option to simplify AnalysisService to just hold analyzers and trash the Tokenizer, TokenFilter and CharFilters once it's fully instantiated. The only consumer of those are tests, custom analyzer building (which happens during construction of AnalysisService) as well as the `TransportAnalyzeAction`. In `TransportAnalyzeAction` it's really just needed to build custom analyzers on the fly and I think we shouldn't optimize for this. Rather go the slow path and create the analysis service again configuring a Custom analzyer than complicating the memory footprint and caching of core service. I think we should fix this rather than add caching or expand plugin APIs\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/237869442","html_url":"https://github.com/elastic/elasticsearch/issues/19814#issuecomment-237869442","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19814","id":237869442,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNzg2OTQ0Mg==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2016-08-05T14:44:06Z","updated_at":"2016-08-05T14:44:06Z","author_association":"CONTRIBUTOR","body":"> we shouldn't optimize for this\n\nI've opened #19827 for this.\n\n> simplify AnalysisService\n\nOpened #19828 with the intention of doing that after #19827.\n\nI've also opened #19830 to investigate removing some of the pre-built analysis components, some of which really don't seem needed.\n\nAfter opening those issues, I think this issue can now be solved by adding documentation to `AnalysisPlugin` explaining that you are on your own for caching though, in general, you should avoid caching. I'll push a patch adding such documentation and close this issue.\n","performed_via_github_app":null}]