[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430241580","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-430241580","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":430241580,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI0MTU4MA==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T13:41:00Z","updated_at":"2018-11-06T19:17:09Z","author_association":"CONTRIBUTOR","body":"One thing we can do is:\r\nFirst get all parents are they are now returned  and join them with parents without any nested docs.\r\n\r\nWe can get all parents without any nested docs with the following query:\r\n\r\n```http\r\nGET _search\r\n{\r\n  \"query\": {\r\n    \"must_not\": {\r\n      \"nested\": {\r\n        \"path\": \"nonAvailability\",\r\n        \"query\": {\r\n          \"exists\": {\r\n            \"field\": \"nonAvailability.date\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430243998","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-430243998","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":430243998,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDI0Mzk5OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-10-16T13:47:38Z","updated_at":"2018-10-16T13:47:38Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433605784","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-433605784","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":433605784,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzYwNTc4NA==","user":{"login":"cbismuth","id":21545602,"node_id":"MDQ6VXNlcjIxNTQ1NjAy","avatar_url":"https://avatars1.githubusercontent.com/u/21545602?v=4","gravatar_id":"","url":"https://api.github.com/users/cbismuth","html_url":"https://github.com/cbismuth","followers_url":"https://api.github.com/users/cbismuth/followers","following_url":"https://api.github.com/users/cbismuth/following{/other_user}","gists_url":"https://api.github.com/users/cbismuth/gists{/gist_id}","starred_url":"https://api.github.com/users/cbismuth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbismuth/subscriptions","organizations_url":"https://api.github.com/users/cbismuth/orgs","repos_url":"https://api.github.com/users/cbismuth/repos","events_url":"https://api.github.com/users/cbismuth/events{/privacy}","received_events_url":"https://api.github.com/users/cbismuth/received_events","type":"User","site_admin":false},"created_at":"2018-10-27T09:33:11Z","updated_at":"2018-10-27T09:33:11Z","author_association":"CONTRIBUTOR","body":"Looks interesting! Iâ€™d like to work on this one.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433844178","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-433844178","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":433844178,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzg0NDE3OA==","user":{"login":"cbismuth","id":21545602,"node_id":"MDQ6VXNlcjIxNTQ1NjAy","avatar_url":"https://avatars1.githubusercontent.com/u/21545602?v=4","gravatar_id":"","url":"https://api.github.com/users/cbismuth","html_url":"https://github.com/cbismuth","followers_url":"https://api.github.com/users/cbismuth/followers","following_url":"https://api.github.com/users/cbismuth/following{/other_user}","gists_url":"https://api.github.com/users/cbismuth/gists{/gist_id}","starred_url":"https://api.github.com/users/cbismuth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbismuth/subscriptions","organizations_url":"https://api.github.com/users/cbismuth/orgs","repos_url":"https://api.github.com/users/cbismuth/repos","events_url":"https://api.github.com/users/cbismuth/events{/privacy}","received_events_url":"https://api.github.com/users/cbismuth/received_events","type":"User","site_admin":false},"created_at":"2018-10-29T09:35:25Z","updated_at":"2018-10-29T09:35:25Z","author_association":"CONTRIBUTOR","body":"cURL recreation script created [here](https://gist.github.com/cbismuth/a3ec27f47ac101b946e0f1f67fb0a43f).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/434228593","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-434228593","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":434228593,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNDIyODU5Mw==","user":{"login":"cbismuth","id":21545602,"node_id":"MDQ6VXNlcjIxNTQ1NjAy","avatar_url":"https://avatars1.githubusercontent.com/u/21545602?v=4","gravatar_id":"","url":"https://api.github.com/users/cbismuth","html_url":"https://github.com/cbismuth","followers_url":"https://api.github.com/users/cbismuth/followers","following_url":"https://api.github.com/users/cbismuth/following{/other_user}","gists_url":"https://api.github.com/users/cbismuth/gists{/gist_id}","starred_url":"https://api.github.com/users/cbismuth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbismuth/subscriptions","organizations_url":"https://api.github.com/users/cbismuth/orgs","repos_url":"https://api.github.com/users/cbismuth/repos","events_url":"https://api.github.com/users/cbismuth/events{/privacy}","received_events_url":"https://api.github.com/users/cbismuth/received_events","type":"User","site_admin":false},"created_at":"2018-10-30T09:25:28Z","updated_at":"2018-10-30T09:25:28Z","author_association":"CONTRIBUTOR","body":"Hi @mayya-sharipova, I'm hacking around in the [NestedQueryBuilder](https://github.com/elastic/elasticsearch/blob/7ad71f906a9608e1c168358624f4b0a39b240296/server/src/main/java/org/elasticsearch/index/query/NestedQueryBuilder.java#L267-L304) to tweak the `innerQuery` and make it include parents without nested docs, but I'm not sure I'm going in the right direction.\r\n\r\nCould you please elaborate a little bit more about where you think we can join with parents without any nested docs? Thank you.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/436375812","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-436375812","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":436375812,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjM3NTgxMg==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T19:21:11Z","updated_at":"2018-11-06T19:21:11Z","author_association":"CONTRIBUTOR","body":"@cbismuth  Thank you for working on this. Now I am thinking about this, and it is a little more complex than I thought. We need to add parents without any children docs only in the case of `must_not` query on children. Also the query to find all parents without any children is not simple. \r\n\r\nI would like to ask @jimczi opinion on this. Jim is it really worth doing this considering complexity?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/436546237","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-436546237","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":436546237,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjU0NjIzNw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-11-07T08:37:55Z","updated_at":"2018-11-07T08:37:55Z","author_association":"MEMBER","body":"The `must_not` clause is in a `nested` context so it can only match children documents. The `nested`  query only sees children document in the `innerQuery` and I don't think we should change that. \r\nOne way to circumvent this limitation is to flip the `bool` and `nested` query:\r\n```\r\n{\r\n\t\"query\": {\r\n\t\t\"bool\": {\r\n\t\t\t\"must_not\": [\r\n\t\t\t\t{\r\n\t\t\t\t\t\"nested\" : {\r\n\t\t\t\t\t\t\"path\" : \"nonAvailability\",\r\n\t\t\t\t\t\t\"query\": {\r\n\t\t\t\t\t\t\t\"range\" : {\r\n    \t\t\t\t\t\t\t\"nonAvailability.date\" : {\r\n        \t\t\t\t\t\t\t\"gte\" : \"2018-07-01\",\r\n        \t\t\t\t\t\t\t\"lt\" : \"2018-07-03\",\r\n        \t\t\t\t\t\t\t\"relation\" : \"within\"\r\n    \t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t]\r\n\t\t}\r\n\t}\r\n}\r\n```\r\nThis way the `must_not` clause is executed at the parent level and parent without children can match.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/437527095","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-437527095","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":437527095,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNzUyNzA5NQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-11-09T23:26:21Z","updated_at":"2018-11-09T23:26:21Z","author_association":"CONTRIBUTOR","body":"@jimczi  Thank you for suggestion, Jim . Do you suggest to run your query in addition to the original query?  \r\n\r\nBecause looks like your query by itself doesn't address the user's problem. He wanted to find both with a single request: 1) parent docs without any children +  2) parent docs with  children that don't satisfy certain criteria.   Your query can find parents without any children well, but I think it may miss some parents that should be returned. For example, for parents that have both children that satisfy  and don't satisfy criteria: \r\n\r\n- \"nested -> must_not CRITERIA \" will return them , because they have children that don't satisfy criteria,\r\n-  \"must_not ->nested CRITERIA \" will miss them, because they also have children that satisfy criteria and we are reversing those parents ids.\r\n\r\nI was thinking can we run your query as a part of `nested->must_not` request inside elasticsearch, or should we leave it to users?\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/438036083","html_url":"https://github.com/elastic/elasticsearch/issues/34522#issuecomment-438036083","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34522","id":438036083,"node_id":"MDEyOklzc3VlQ29tbWVudDQzODAzNjA4Mw==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2018-11-12T21:33:48Z","updated_at":"2018-11-12T21:33:48Z","author_association":"CONTRIBUTOR","body":"After investigation with @jimczi, we have decided not to implement anything on the elasticsearch side, as it doesn't worth the complexity. Instead the user can address his problem with one of the following ways depending on his expectations regarding parents with mixed children (that satisfy and don't satisfy `must_not` criterion). \r\n**First** reversing nested and must. This will return parents without any children and parents that have children satisfying `must_not` criterion, but will miss some parents that have both children that satisfy and don't satisfy `must_not` criterion:\r\n\r\n```js\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must_not\": [\r\n        {\r\n          \"nested\": {\r\n            \"path\": \"nonAvailability\",\r\n            \"query\": {\r\n              \"range\": {\r\n                \"nonAvailability.date\": {\r\n                  \"gte\": \"2018-07-01\",\r\n                  \"lt\": \"2018-07-03\",\r\n                  \"relation\": \"within\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n``` \r\n\r\n**Second** is to combine the original query with another bool query that will give us parents without children. The query will be more complex but it should return all necessary parents.\r\n\r\n```js\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"bool\": {\r\n            \"must_not\": {\r\n              \"nested\": {\r\n                \"path\": \"nonAvailability\",\r\n                \"query\": {\r\n                  \"exists\": {\r\n                    \"field\": \"nonAvailability.date\"\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"path\": \"nonAvailability\",\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"must_not\": [\r\n                  {\r\n                    \"range\": {\r\n                      \"nonAvailability.date\" : {\r\n                        \"gte\" : \"2018-07-01\",\r\n                        \"lt\" : \"2018-07-03\",\r\n                        \"relation\" : \"within\"\r\n                      }\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null}]