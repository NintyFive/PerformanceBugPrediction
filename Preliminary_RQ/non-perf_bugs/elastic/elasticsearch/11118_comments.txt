[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101290241","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101290241","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101290241,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTI5MDI0MQ==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-12T13:52:39Z","updated_at":"2015-05-12T14:04:58Z","author_association":"CONTRIBUTOR","body":"I've created a simpler test case for this, and it seems a little clearer that this doesn't currently work.\n\n**Add mappings:**\n\n```\ncurl -XPOST 'http://localhost:9200/grandchildren' -d '{\n  \"mappings\" : {\n    \"parent\" : {\n      \"properties\" : {\n        \"parent-name\" : {\n          \"type\" : \"string\",\n          \"index\" : \"not_analyzed\"\n        }\n      }\n    },\n    \"child\" : {\n      \"_parent\" : {\n        \"type\" : \"parent\"\n      },\n      \"_routing\" : {\n        \"required\" : true\n      },\n      \"properties\" : {\n        \"parent-name\" : {\n          \"type\" : \"string\",\n          \"index\" : \"not_analyzed\"\n        }\n      }\n    },\n    \"grandchild\" : {\n      \"_parent\" : {\n        \"type\" : \"child\"\n      },\n      \"_routing\" : {\n        \"required\" : true\n      },\n      \"properties\" : {\n        \"grandchild-name\" : {\n          \"type\" : \"string\",\n          \"index\" : \"not_analyzed\"\n        }\n      }\n    }\n  }\n}'\n```\n\n**Populate:**\n\n```\ncurl -XPOST 'http://localhost:9200/grandchildren/parent/parent' -d '{ \"parent-name\" : \"Parent\" }'\ncurl -XPOST 'http://localhost:9200/grandchildren/child/child?parent=parent&routing=parent' -d '{ \"child-name\" : \"Child\" }'\ncurl -XPOST 'http://localhost:9200/grandchildren/grandchild/grandchild?parent=child&routing=parent' -d '{ \"grandchild-name\" : \"Grandchild\" }'\n```\n\n**Query:**\n\n```\ncurl -XGET 'http://localhost:9200/grandchildren/_search?pretty' -d '{\n  \"query\" : {\n    \"has_child\" : {\n      \"query\" : {\n        \"has_child\" : {\n          \"query\" : {\n            \"match_all\" : {}\n          },\n          \"child_type\" : \"grandchild\",\n          \"inner_hits\" : {\n            \"name\" : \"grandchild\"\n          }\n        }\n      },\n      \"child_type\" : \"child\",\n      \"inner_hits\" : {\n        \"name\" : \"child\"\n      }\n    }\n  }\n}'\n```\n\n**Result:**\n\n```\n{\n  \"took\" : 2,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"grandchildren\",\n      \"_type\" : \"parent\",\n      \"_id\" : \"parent\",\n      \"_score\" : 1.0,\n      \"_source\":{ \"parent-name\" : \"Parent\" },\n      \"inner_hits\" : {\n        \"grandchild\" : {\n          \"hits\" : {\n            \"total\" : 0,\n            \"max_score\" : null,\n            \"hits\" : [ ]\n          }\n        },\n        \"child\" : {\n          \"hits\" : {\n            \"total\" : 1,\n            \"max_score\" : 1.0,\n            \"hits\" : [ {\n              \"_index\" : \"grandchildren\",\n              \"_type\" : \"child\",\n              \"_id\" : \"child\",\n              \"_score\" : 1.0,\n              \"_source\":{ \"child-name\" : \"Child\" }\n            } ]\n          }\n        }\n      }\n    } ]\n  }\n}\n```\n\nNot only is the grandchild hits empty, but they're also not nested within the child hits, so aren't going to give me what I want anyway. I'm not sure what the intended/expected behaviour would be here, but guess I need to try something else for now.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101294573","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101294573","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101294573,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTI5NDU3Mw==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-12T14:03:05Z","updated_at":"2015-05-12T14:03:05Z","author_association":"CONTRIBUTOR","body":"Above with inner hits at top-level:\n\n**Query:**\n\n```\ncurl -XGET 'http://localhost:9200/grandchildren/_search?pretty' -d '{\n  \"query\" : {\n    \"has_child\" : {\n      \"query\" : {\n        \"has_child\" : {\n          \"query\" : {\n            \"match_all\" : {}\n          },\n          \"child_type\" : \"grandchild\"\n        }\n      },\n      \"child_type\" : \"child\"\n    }\n  },\n  \"inner_hits\" : {\n    \"child\" : {\n      \"type\" : {\n        \"child\" : {\n          \"inner_hits\" : {\n            \"child\" : {\n              \"type\" : {\n                \"grandchild\" : {}\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n\n**Result:**\n\n```\n{\n  \"took\" : 3,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"grandchildren\",\n      \"_type\" : \"parent\",\n      \"_id\" : \"parent\",\n      \"_score\" : 1.0,\n      \"_source\":{ \"parent-name\" : \"Parent\" },\n      \"inner_hits\" : {\n        \"child\" : {\n          \"hits\" : {\n            \"total\" : 1,\n            \"max_score\" : 1.0,\n            \"hits\" : [ {\n              \"_index\" : \"grandchildren\",\n              \"_type\" : \"child\",\n              \"_id\" : \"child\",\n              \"_score\" : 1.0,\n              \"_source\":{ \"child-name\" : \"Child\" },\n              \"inner_hits\" : {\n                \"child\" : {\n                  \"hits\" : {\n                    \"total\" : 1,\n                    \"max_score\" : 1.0,\n                    \"hits\" : [ {\n                      \"_index\" : \"grandchildren\",\n                      \"_type\" : \"grandchild\",\n                      \"_id\" : \"grandchild\",\n                      \"_score\" : 1.0,\n                      \"_source\":{ \"grandchild-name\" : \"Grandchild\" }\n                    } ]\n                  }\n                }\n              }\n            } ]\n          }\n        }\n      }\n    } ]\n  }\n}\n```\n\nHere the grandchild inner hit is correctly found, and nested\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101296674","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101296674","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101296674,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTI5NjY3NA==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-12T14:12:57Z","updated_at":"2015-05-12T14:12:57Z","author_association":"CONTRIBUTOR","body":"[I'm using 1.5.2]\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101652264","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101652264","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101652264,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTY1MjI2NA==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-13T12:44:35Z","updated_at":"2015-05-13T12:45:56Z","author_association":"CONTRIBUTOR","body":"I managed to track down why this wasn't working. When parsing 'has child' queries, inner hits were always being added to the `parseContext`, and never as child inner hits to the parent inner hits.\n\nI've put together a very quick and dirty fix for this (https://github.com/lukens/elasticsearch/commit/fb22d622e7b24074b5f4fe3e26cffd4c38cff75b) which has got it working for my case, but I don't think is suitable for inclusion in a release.\n\nIssues I see with my with my fix:\n1. It's just messy, it doesn't really fix the issue, but just cleans up after it. Children still add their inner hits to the `parseContext`, the parent just removes them again afterwards, and adds them as children to its own inner hits.\n2. The parent removes them again afterwards by mutating a Map it gets from the current `SearchContext`'s `InnerHitsContext`. This is obviously bad and messy, and would be broken if `InnerHitsContext` was changed to return a copy of the map, rather than the map itself. Nasty dependencies between classes.\n3. I think a child can specify inner hits even if a parent doesn't. These would currently get lost. I'm not sure what the behaviour should be here, it should probably be considered an invalid query.\n4. If this was done properly, descendants at different levels could add inner hits with the same name, whereas currently this could cause issues. Maybe you shouldn't be able to have the same name at different levels, but if implemented correctly, there should be no need to enforce this. \n\nI considered submitting as a pull request, but felt it was far too rough and ready.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101740871","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101740871","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101740871,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTc0MDg3MQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-05-13T16:41:55Z","updated_at":"2015-05-13T16:41:55Z","author_association":"MEMBER","body":"@lukens If you want nested inner hits then you need to use the top level inner hits, the inner_hits on a query doesn't support nesting. The fact that your grandparents inner hits is empty is clearly a bug, thanks for bringing this up!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101983466","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101983466","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101983466,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTk4MzQ2Ng==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-14T09:30:04Z","updated_at":"2015-05-14T09:30:51Z","author_association":"CONTRIBUTOR","body":"Hi, it's grandchild, rather than grandparent, that isn't working. Though you also seem to be suggesting it shouldn't be.  Either way, the change I committed shows that it can work, my change just isn't a very nice way to make it work.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101984539","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101984539","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101984539,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTk4NDUzOQ==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-14T09:36:15Z","updated_at":"2015-05-14T09:36:15Z","author_association":"CONTRIBUTOR","body":"Ah, or are you saying it should work, but just shouldn't be nested? I'm not really sure what the point of it would be if it wasn't nested, though that may just be because it doesn't fit my use case, and I can't think of a use case where it would be useful.\n\nI think it would be good if nesting did work, as that would still allow either use case, really.\n\nThe problem with top level inner_hits is that I have to apply the query once in the has_child query, and then again in the inner_hits query, which makes everything slower than it would otherwise need to be.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/101995382","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-101995382","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":101995382,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMTk5NTM4Mg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-05-14T10:20:30Z","updated_at":"2015-05-14T10:20:30Z","author_association":"MEMBER","body":"@lukens yes, I meant grandchild. The reason it is a bug is, because the inner_hits in your response shouldn't be empty.\n\nThe top level inner hits and inner hits defined on a query internally to ES is the same thing and either way of defining inner hits will yield the same performance in terms of query time. The nested inner hits support in the query dsl was left out to reduce complexity and most of the times there is just a single level relationship. Obviously that means for your use case that you need to use top level inner hits. \n\nMaybe the inner hits support in the query dsl should support multi level relationships too, but I think the parsing logic shouldn't be get super complex because this. I need to think more about this. Like you said if it the grandchild isn't nested its hits in the response, then it isn't very helpful.\n\nThe only overhead of top level inner hits is that queries are defined twice, so the request body gets larger. If you're concerned with that, you can consider using search templates, so that you don't you reduce the amount of data send to your cluster.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/102001876","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-102001876","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":102001876,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMjAwMTg3Ng==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-14T10:46:55Z","updated_at":"2015-05-14T10:46:55Z","author_association":"CONTRIBUTOR","body":"Isn't there also an overhead in running the query twice with the top level inner_hits, or does Elasticsearch do something clever so that it only gets run once? (and, if so, does it need to be specified again in the inner hits?)\n\nI've not yet come across search templates, are these compatible with highly dynamic searches?\n\nI'd like try and spend a bit more time on getting nesting working in a less hacky manner, but am under enormous pressure just to get a project completed at the moment. For the case when grandchildren aren't nested in the query, I guess the simple solution is to also not nest them in the response. I don't think this would overcomplicate the parsing too much.\n\nI have a fairly nice way to handle all this in my mind, just not the time to implement it at the moment.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/102005489","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-102005489","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":102005489,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMjAwNTQ4OQ==","user":{"login":"lukens","id":686128,"node_id":"MDQ6VXNlcjY4NjEyOA==","avatar_url":"https://avatars1.githubusercontent.com/u/686128?v=4","gravatar_id":"","url":"https://api.github.com/users/lukens","html_url":"https://github.com/lukens","followers_url":"https://api.github.com/users/lukens/followers","following_url":"https://api.github.com/users/lukens/following{/other_user}","gists_url":"https://api.github.com/users/lukens/gists{/gist_id}","starred_url":"https://api.github.com/users/lukens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukens/subscriptions","organizations_url":"https://api.github.com/users/lukens/orgs","repos_url":"https://api.github.com/users/lukens/repos","events_url":"https://api.github.com/users/lukens/events{/privacy}","received_events_url":"https://api.github.com/users/lukens/received_events","type":"User","site_admin":false},"created_at":"2015-05-14T11:12:21Z","updated_at":"2015-05-14T11:12:21Z","author_association":"CONTRIBUTOR","body":"OK, switching to top level hits doesn't seem to have affected performance, so I can work with that for now. It had seemed much slower before, but once I'd actually got inner_hits on the query working, that ended up just as slow, until I tweaked some other things.\n\nThe \"fix\" I've committed above is probably only really of any use as a reference if you want to go with nesting, as it doesn't solve the problem when not nested. I expect there's something in the inner workings of inner_hits that currently relies on them being nested.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/102351002","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-102351002","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":102351002,"node_id":"MDEyOklzc3VlQ29tbWVudDEwMjM1MTAwMg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-05-15T09:55:48Z","updated_at":"2015-05-15T09:55:48Z","author_association":"MEMBER","body":"> Isn't there also an overhead in running the query twice with the top level inner_hits, or does Elasticsearch do something clever so that it only gets run once? (and, if so, does it need to be specified again in the inner hits?)\n\ninner_hits runs as part of the fetch phase and always executes an additional search to fetch the inner hits. The search being executed is cheap. It only runs an a single shard and just runs a query that fetches top child docs that matches with `_parent:[parent_id]` (all docs associated with parent `parent_id`) and the inner query defined in the `has_child` query. This is a query that ES (actually Lucene) can execute relatively quickly. This mini search is executed for each hit being returned.\n\n> I've not yet come across search templates, are these compatible with highly dynamic searches?\n\nYes, the dynamic part of the search request can be templated.\n\n> The \"fix\" I've committed above is probably only really of any use as a reference if you want to go with nesting, as it doesn't solve the problem when not nested. I expect there's something in the inner workings of inner_hits that currently relies on them being nested.\n\nYes, the inner hits features relies on the fact that grandchild and child are nested. When using the top-level inner hits notation this works out, but when using inner_hits as part of the query dsl this doesn't work out, because grandchild inner hit definition isn't nested under the child inner hit definition.\n\nIn order to fix this properly the query dsl parsing logic should just support nested inner hits. I think the format doesn't need to change in order to support this. Just because the fact the two `has_child` queries are nested should be enough for automatically nest the two inner hit definitions.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136890849","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-136890849","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":136890849,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjg5MDg0OQ==","user":{"login":"alvinchow86","id":5131063,"node_id":"MDQ6VXNlcjUxMzEwNjM=","avatar_url":"https://avatars1.githubusercontent.com/u/5131063?v=4","gravatar_id":"","url":"https://api.github.com/users/alvinchow86","html_url":"https://github.com/alvinchow86","followers_url":"https://api.github.com/users/alvinchow86/followers","following_url":"https://api.github.com/users/alvinchow86/following{/other_user}","gists_url":"https://api.github.com/users/alvinchow86/gists{/gist_id}","starred_url":"https://api.github.com/users/alvinchow86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alvinchow86/subscriptions","organizations_url":"https://api.github.com/users/alvinchow86/orgs","repos_url":"https://api.github.com/users/alvinchow86/repos","events_url":"https://api.github.com/users/alvinchow86/events{/privacy}","received_events_url":"https://api.github.com/users/alvinchow86/received_events","type":"User","site_admin":false},"created_at":"2015-09-01T23:28:25Z","updated_at":"2015-09-01T23:28:25Z","author_association":"NONE","body":"Allso seeing this issue, in my case multi-level nested documents (as in https://github.com/elastic/elasticsearch/issues/13064). Would be great to get a solution to this.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/152989716","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-152989716","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":152989716,"node_id":"MDEyOklzc3VlQ29tbWVudDE1Mjk4OTcxNg==","user":{"login":"lipixun","id":12741165,"node_id":"MDQ6VXNlcjEyNzQxMTY1","avatar_url":"https://avatars0.githubusercontent.com/u/12741165?v=4","gravatar_id":"","url":"https://api.github.com/users/lipixun","html_url":"https://github.com/lipixun","followers_url":"https://api.github.com/users/lipixun/followers","following_url":"https://api.github.com/users/lipixun/following{/other_user}","gists_url":"https://api.github.com/users/lipixun/gists{/gist_id}","starred_url":"https://api.github.com/users/lipixun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lipixun/subscriptions","organizations_url":"https://api.github.com/users/lipixun/orgs","repos_url":"https://api.github.com/users/lipixun/repos","events_url":"https://api.github.com/users/lipixun/events{/privacy}","received_events_url":"https://api.github.com/users/lipixun/received_events","type":"User","site_admin":false},"created_at":"2015-11-02T11:08:31Z","updated_at":"2015-11-02T11:08:31Z","author_association":"NONE","body":"Will this issue be fixed at 2.x? Really looking forward to see the nested inner hits in query dsl.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159920657","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-159920657","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":159920657,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTkyMDY1Nw==","user":{"login":"sumitjainn","id":657557,"node_id":"MDQ6VXNlcjY1NzU1Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/657557?v=4","gravatar_id":"","url":"https://api.github.com/users/sumitjainn","html_url":"https://github.com/sumitjainn","followers_url":"https://api.github.com/users/sumitjainn/followers","following_url":"https://api.github.com/users/sumitjainn/following{/other_user}","gists_url":"https://api.github.com/users/sumitjainn/gists{/gist_id}","starred_url":"https://api.github.com/users/sumitjainn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sumitjainn/subscriptions","organizations_url":"https://api.github.com/users/sumitjainn/orgs","repos_url":"https://api.github.com/users/sumitjainn/repos","events_url":"https://api.github.com/users/sumitjainn/events{/privacy}","received_events_url":"https://api.github.com/users/sumitjainn/received_events","type":"User","site_admin":false},"created_at":"2015-11-26T13:49:40Z","updated_at":"2015-11-26T13:49:40Z","author_association":"NONE","body":"When will this be fixed, its a blocker for us !! \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/166117232","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-166117232","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":166117232,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NjExNzIzMg==","user":{"login":"yehosef","id":149253,"node_id":"MDQ6VXNlcjE0OTI1Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/149253?v=4","gravatar_id":"","url":"https://api.github.com/users/yehosef","html_url":"https://github.com/yehosef","followers_url":"https://api.github.com/users/yehosef/followers","following_url":"https://api.github.com/users/yehosef/following{/other_user}","gists_url":"https://api.github.com/users/yehosef/gists{/gist_id}","starred_url":"https://api.github.com/users/yehosef/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yehosef/subscriptions","organizations_url":"https://api.github.com/users/yehosef/orgs","repos_url":"https://api.github.com/users/yehosef/repos","events_url":"https://api.github.com/users/yehosef/events{/privacy}","received_events_url":"https://api.github.com/users/yehosef/received_events","type":"User","site_admin":false},"created_at":"2015-12-20T13:30:05Z","updated_at":"2015-12-20T13:30:05Z","author_association":"NONE","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170228081","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-170228081","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":170228081,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDIyODA4MQ==","user":{"login":"jCalamari","id":9678999,"node_id":"MDQ6VXNlcjk2Nzg5OTk=","avatar_url":"https://avatars3.githubusercontent.com/u/9678999?v=4","gravatar_id":"","url":"https://api.github.com/users/jCalamari","html_url":"https://github.com/jCalamari","followers_url":"https://api.github.com/users/jCalamari/followers","following_url":"https://api.github.com/users/jCalamari/following{/other_user}","gists_url":"https://api.github.com/users/jCalamari/gists{/gist_id}","starred_url":"https://api.github.com/users/jCalamari/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jCalamari/subscriptions","organizations_url":"https://api.github.com/users/jCalamari/orgs","repos_url":"https://api.github.com/users/jCalamari/repos","events_url":"https://api.github.com/users/jCalamari/events{/privacy}","received_events_url":"https://api.github.com/users/jCalamari/received_events","type":"User","site_admin":false},"created_at":"2016-01-09T11:29:34Z","updated_at":"2016-01-09T11:29:34Z","author_association":"NONE","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172626781","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-172626781","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":172626781,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjYyNjc4MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-18T19:16:53Z","updated_at":"2016-01-18T19:16:53Z","author_association":"CONTRIBUTOR","body":"@martijnvg just pinging you about this as a reminder\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/177969286","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-177969286","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":177969286,"node_id":"MDEyOklzc3VlQ29tbWVudDE3Nzk2OTI4Ng==","user":{"login":"abulhol","id":4851778,"node_id":"MDQ6VXNlcjQ4NTE3Nzg=","avatar_url":"https://avatars3.githubusercontent.com/u/4851778?v=4","gravatar_id":"","url":"https://api.github.com/users/abulhol","html_url":"https://github.com/abulhol","followers_url":"https://api.github.com/users/abulhol/followers","following_url":"https://api.github.com/users/abulhol/following{/other_user}","gists_url":"https://api.github.com/users/abulhol/gists{/gist_id}","starred_url":"https://api.github.com/users/abulhol/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abulhol/subscriptions","organizations_url":"https://api.github.com/users/abulhol/orgs","repos_url":"https://api.github.com/users/abulhol/repos","events_url":"https://api.github.com/users/abulhol/events{/privacy}","received_events_url":"https://api.github.com/users/abulhol/received_events","type":"User","site_admin":false},"created_at":"2016-02-01T13:21:45Z","updated_at":"2016-02-01T13:21:45Z","author_association":"NONE","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/190640006","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-190640006","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":190640006,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDY0MDAwNg==","user":{"login":"JanSchroeder","id":1101687,"node_id":"MDQ6VXNlcjExMDE2ODc=","avatar_url":"https://avatars0.githubusercontent.com/u/1101687?v=4","gravatar_id":"","url":"https://api.github.com/users/JanSchroeder","html_url":"https://github.com/JanSchroeder","followers_url":"https://api.github.com/users/JanSchroeder/followers","following_url":"https://api.github.com/users/JanSchroeder/following{/other_user}","gists_url":"https://api.github.com/users/JanSchroeder/gists{/gist_id}","starred_url":"https://api.github.com/users/JanSchroeder/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JanSchroeder/subscriptions","organizations_url":"https://api.github.com/users/JanSchroeder/orgs","repos_url":"https://api.github.com/users/JanSchroeder/repos","events_url":"https://api.github.com/users/JanSchroeder/events{/privacy}","received_events_url":"https://api.github.com/users/JanSchroeder/received_events","type":"User","site_admin":false},"created_at":"2016-03-01T09:54:42Z","updated_at":"2016-03-01T09:54:42Z","author_association":"NONE","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297616801","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-297616801","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":297616801,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzYxNjgwMQ==","user":{"login":"abhishek5678","id":27953347,"node_id":"MDQ6VXNlcjI3OTUzMzQ3","avatar_url":"https://avatars1.githubusercontent.com/u/27953347?v=4","gravatar_id":"","url":"https://api.github.com/users/abhishek5678","html_url":"https://github.com/abhishek5678","followers_url":"https://api.github.com/users/abhishek5678/followers","following_url":"https://api.github.com/users/abhishek5678/following{/other_user}","gists_url":"https://api.github.com/users/abhishek5678/gists{/gist_id}","starred_url":"https://api.github.com/users/abhishek5678/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abhishek5678/subscriptions","organizations_url":"https://api.github.com/users/abhishek5678/orgs","repos_url":"https://api.github.com/users/abhishek5678/repos","events_url":"https://api.github.com/users/abhishek5678/events{/privacy}","received_events_url":"https://api.github.com/users/abhishek5678/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T05:37:57Z","updated_at":"2017-04-27T05:37:57Z","author_association":"NONE","body":"Hi Everyone,\r\nwhere is document data ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592288642","html_url":"https://github.com/elastic/elasticsearch/issues/11118#issuecomment-592288642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11118","id":592288642,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjI4ODY0Mg==","user":{"login":"MerwaneHAMADI","id":9652976,"node_id":"MDQ6VXNlcjk2NTI5NzY=","avatar_url":"https://avatars0.githubusercontent.com/u/9652976?v=4","gravatar_id":"","url":"https://api.github.com/users/MerwaneHAMADI","html_url":"https://github.com/MerwaneHAMADI","followers_url":"https://api.github.com/users/MerwaneHAMADI/followers","following_url":"https://api.github.com/users/MerwaneHAMADI/following{/other_user}","gists_url":"https://api.github.com/users/MerwaneHAMADI/gists{/gist_id}","starred_url":"https://api.github.com/users/MerwaneHAMADI/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MerwaneHAMADI/subscriptions","organizations_url":"https://api.github.com/users/MerwaneHAMADI/orgs","repos_url":"https://api.github.com/users/MerwaneHAMADI/repos","events_url":"https://api.github.com/users/MerwaneHAMADI/events{/privacy}","received_events_url":"https://api.github.com/users/MerwaneHAMADI/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T03:06:16Z","updated_at":"2020-02-28T03:06:16Z","author_association":"NONE","body":"It looks like this issue is still unsolved, at least in elasticsearch 7.1","performed_via_github_app":null}]