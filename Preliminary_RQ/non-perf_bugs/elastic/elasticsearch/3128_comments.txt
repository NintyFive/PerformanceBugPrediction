[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/18906208","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-18906208","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":18906208,"node_id":"MDEyOklzc3VlQ29tbWVudDE4OTA2MjA4","user":{"login":"kroepke","id":52014,"node_id":"MDQ6VXNlcjUyMDE0","avatar_url":"https://avatars1.githubusercontent.com/u/52014?v=4","gravatar_id":"","url":"https://api.github.com/users/kroepke","html_url":"https://github.com/kroepke","followers_url":"https://api.github.com/users/kroepke/followers","following_url":"https://api.github.com/users/kroepke/following{/other_user}","gists_url":"https://api.github.com/users/kroepke/gists{/gist_id}","starred_url":"https://api.github.com/users/kroepke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kroepke/subscriptions","organizations_url":"https://api.github.com/users/kroepke/orgs","repos_url":"https://api.github.com/users/kroepke/repos","events_url":"https://api.github.com/users/kroepke/events{/privacy}","received_events_url":"https://api.github.com/users/kroepke/received_events","type":"User","site_admin":false},"created_at":"2013-06-04T12:42:18Z","updated_at":"2013-06-04T12:42:18Z","author_association":"NONE","body":"I've been looking at this problem and it basically consumes all its time in <code>org.apache.lucene.search.vectorhighlight.FieldQuery()</code> trying to expand the flat queries in to PhraseQueries for later matching it against the Hits.\n\nPut another way: It's extremely easy to break the fast vector highlighter by asking it to highlight the exact field content, provided that the query terms and stored field terms are the same. In this case the implementation degenerates to a cartesian product of the terms, leading to memory exhaustion.\n\nMoral of the story, beware of automatically generated search queries that come from field contents when also highlighting.\nMaybe a fail safe mode could be added somewhere, stopping the iteration during construction of the FieldQuery object to prevent it bringing down the cluster in seconds.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/18985381","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-18985381","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":18985381,"node_id":"MDEyOklzc3VlQ29tbWVudDE4OTg1Mzgx","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-06-05T15:42:20Z","updated_at":"2013-06-05T15:42:20Z","author_association":"CONTRIBUTOR","body":"This in-fact a bug in Lucene or maybe a really bad situation. not sure if it's a bug per-se. Yet, the problem is that due to the settings `\"generate_number_parts\": \"true\", \"catenate_words\": \"true\",` this creates a MultiPhraseQuery (multiple token on the same position) and  if this one gets too long it kind runs in a very expensive loop. Setting those to \"false\" makes it fast and it seems to produce the right thing too I will look into this more in detail in lucene land\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/18987143","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-18987143","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":18987143,"node_id":"MDEyOklzc3VlQ29tbWVudDE4OTg3MTQz","user":{"login":"kroepke","id":52014,"node_id":"MDQ6VXNlcjUyMDE0","avatar_url":"https://avatars1.githubusercontent.com/u/52014?v=4","gravatar_id":"","url":"https://api.github.com/users/kroepke","html_url":"https://github.com/kroepke","followers_url":"https://api.github.com/users/kroepke/followers","following_url":"https://api.github.com/users/kroepke/following{/other_user}","gists_url":"https://api.github.com/users/kroepke/gists{/gist_id}","starred_url":"https://api.github.com/users/kroepke/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kroepke/subscriptions","organizations_url":"https://api.github.com/users/kroepke/orgs","repos_url":"https://api.github.com/users/kroepke/repos","events_url":"https://api.github.com/users/kroepke/events{/privacy}","received_events_url":"https://api.github.com/users/kroepke/received_events","type":"User","site_admin":false},"created_at":"2013-06-05T15:58:25Z","updated_at":"2013-06-05T15:58:25Z","author_association":"NONE","body":"This definitely is a corner case, I agree, unfortunately our system sometimes generates queries like this based on user action, and these are tricky to filter out (although we will try to, of course).\nThis specific example will generate 4095 queries internally when constructing the FieldQuery object, and so far I haven't quite found a way to have it bail out earlier. Needless to say you run out of memory rather quickly when this happens.\nI agree it's not really a bug, but rather a unfortunate worst-case scenario for the highlighter, but it has very dire consequences once you hit it.\nLet me know if you need anything more from us.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/18997206","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-18997206","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":18997206,"node_id":"MDEyOklzc3VlQ29tbWVudDE4OTk3MjA2","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-06-05T18:27:38Z","updated_at":"2013-06-05T18:27:38Z","author_association":"CONTRIBUTOR","body":"Yeah I know it's tricky though. I wonder if you can just not use phrase for higlighting here. I mean it's pretty intense though. if you use `generate_number_parts\": \"false\", \"catenate_words\": \"false\"` you will not have the problems. you might want to just do this for the search here as a search analyzer or so? I think we will go forward and add a cutoff for this to make sure it doesn't blow up but rather return a not so correct highlighthing result ;), what do you think?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19033913","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19033913","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19033913,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDMzOTEz","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T09:24:52Z","updated_at":"2013-06-06T09:24:52Z","author_association":"CONTRIBUTOR","body":"I got a workaround for this in this patch. I think this is the only reasonable thing to-do here really. The highlights will be different if you get the crazy query but it should return quickly. Let me know what you think?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19034441","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19034441","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19034441,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM0NDQx","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T09:36:04Z","updated_at":"2013-06-06T09:36:04Z","author_association":"CONTRIBUTOR","body":"Fine for me. I mean, I wonder if it even makes sense highlighting this kind of query. I was actually more concerned with cluster stability rather then \"correct highlighting\" behavior. \nWill this make into 0.90.2?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19035734","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19035734","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19035734,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM1NzM0","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T10:05:16Z","updated_at":"2013-06-06T10:05:16Z","author_association":"CONTRIBUTOR","body":"@lmenezes It does - think about phrase queries where each word passes through a SynonymFilter. You still want to be able to highlight such queries. We were seeing similar issues, thx @s1monw for the fix, I'll test it early next week\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19035905","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19035905","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19035905,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM1OTA1","user":{"login":"lmenezes","id":750074,"node_id":"MDQ6VXNlcjc1MDA3NA==","avatar_url":"https://avatars1.githubusercontent.com/u/750074?v=4","gravatar_id":"","url":"https://api.github.com/users/lmenezes","html_url":"https://github.com/lmenezes","followers_url":"https://api.github.com/users/lmenezes/followers","following_url":"https://api.github.com/users/lmenezes/following{/other_user}","gists_url":"https://api.github.com/users/lmenezes/gists{/gist_id}","starred_url":"https://api.github.com/users/lmenezes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lmenezes/subscriptions","organizations_url":"https://api.github.com/users/lmenezes/orgs","repos_url":"https://api.github.com/users/lmenezes/repos","events_url":"https://api.github.com/users/lmenezes/events{/privacy}","received_events_url":"https://api.github.com/users/lmenezes/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T10:09:27Z","updated_at":"2013-06-06T10:09:27Z","author_association":"CONTRIBUTOR","body":"@synhershko I just meant for the case where the query is actually the exact content of an indexed document field.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19035972","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19035972","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19035972,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM1OTcy","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T10:11:10Z","updated_at":"2013-06-06T10:11:10Z","author_association":"CONTRIBUTOR","body":"I think it makes sense to highlight MultiPhraseQueries, I am just concerened about crazy ones that are somewhat generated. I am also all for preventing cluster stability problems and give somewhat bad highlighting instead. I will push this soon\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19036571","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19036571","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19036571,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM2NTcx","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T10:24:04Z","updated_at":"2013-06-06T10:24:04Z","author_association":"CONTRIBUTOR","body":"Speaking of cluster stability problems, and sorry for hijacking the thread, the most imminent problem today is the lack of a timeout concept in Lucene. Once ES hands over control to any Lucene component, you are at risk of that thread running forever. This makes ES timeouts be on a \"best effort basis\" to quote Shay's words, and in practice timeouts are almost never enforced.\n\nThis is basically what happened with this FVH issue, but can also happen with complex searches, and we are seeing nodes come unresponsive after a while in our cluster, presumably because of such issues\n\nIf only Lucene could respect timeouts, that would be great\n\n/cc @bleskes \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19037613","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19037613","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19037613,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM3NjEz","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T10:49:17Z","updated_at":"2013-06-06T10:49:24Z","author_association":"CONTRIBUTOR","body":"> If only Lucene could respect timeouts, that would be great\n\nwhen you think about it, how would you implement it? this is a really tough problem and during searches lucene respects it. Each search with a timeout checks if it has timed out after each collected document so this is pretty accurate. Not sure what you are referring to here.\n\n@lmenezes I pushed the fix it will be in 0.90.2\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19037771","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19037771","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19037771,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM3Nzcx","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T10:53:37Z","updated_at":"2013-06-06T10:53:37Z","author_association":"CONTRIBUTOR","body":"Let me get back to you with more concrete details\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/19038814","html_url":"https://github.com/elastic/elasticsearch/issues/3128#issuecomment-19038814","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3128","id":19038814,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MDM4ODE0","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2013-06-06T11:18:53Z","updated_at":"2013-06-06T11:18:53Z","author_association":"CONTRIBUTOR","body":"@synhershko Rather move the timeout conversation to issue #3129 \n","performed_via_github_app":null}]