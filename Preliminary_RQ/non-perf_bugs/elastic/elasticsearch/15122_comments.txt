[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160704893","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-160704893","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":160704893,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDcwNDg5Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-30T17:51:28Z","updated_at":"2015-11-30T17:51:28Z","author_association":"CONTRIBUTOR","body":"Hi @pkr1234 \n\nDots are no longer allowed because they introduce an ambiguity in field lookup that is impossible to work around.  So your options are:\n- reindex the data (in 1.x) into a new index without dots in the field names\n- delete the old data\n- keep a small 1.x cluster around to look at the old indices when you need to\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160974925","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-160974925","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":160974925,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDk3NDkyNQ==","user":{"login":"pkr1234","id":11294187,"node_id":"MDQ6VXNlcjExMjk0MTg3","avatar_url":"https://avatars2.githubusercontent.com/u/11294187?v=4","gravatar_id":"","url":"https://api.github.com/users/pkr1234","html_url":"https://github.com/pkr1234","followers_url":"https://api.github.com/users/pkr1234/followers","following_url":"https://api.github.com/users/pkr1234/following{/other_user}","gists_url":"https://api.github.com/users/pkr1234/gists{/gist_id}","starred_url":"https://api.github.com/users/pkr1234/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkr1234/subscriptions","organizations_url":"https://api.github.com/users/pkr1234/orgs","repos_url":"https://api.github.com/users/pkr1234/repos","events_url":"https://api.github.com/users/pkr1234/events{/privacy}","received_events_url":"https://api.github.com/users/pkr1234/received_events","type":"User","site_admin":false},"created_at":"2015-12-01T13:48:33Z","updated_at":"2015-12-01T13:48:33Z","author_association":"NONE","body":"Thanks Clinton.\n\nI went for the second option and deleted the data using delete by query and taken another snapshot. But the _restore still fails. I checked the _mapping and the mapping still exists for the offending fields. Is this causing the problem now for restore?\n\nHow do I get around this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160976971","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-160976971","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":160976971,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDk3Njk3MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-01T13:58:01Z","updated_at":"2015-12-01T13:58:01Z","author_association":"CONTRIBUTOR","body":"You have to delete the index itself.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160981560","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-160981560","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":160981560,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDk4MTU2MA==","user":{"login":"pkr1234","id":11294187,"node_id":"MDQ6VXNlcjExMjk0MTg3","avatar_url":"https://avatars2.githubusercontent.com/u/11294187?v=4","gravatar_id":"","url":"https://api.github.com/users/pkr1234","html_url":"https://github.com/pkr1234","followers_url":"https://api.github.com/users/pkr1234/followers","following_url":"https://api.github.com/users/pkr1234/following{/other_user}","gists_url":"https://api.github.com/users/pkr1234/gists{/gist_id}","starred_url":"https://api.github.com/users/pkr1234/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkr1234/subscriptions","organizations_url":"https://api.github.com/users/pkr1234/orgs","repos_url":"https://api.github.com/users/pkr1234/repos","events_url":"https://api.github.com/users/pkr1234/events{/privacy}","received_events_url":"https://api.github.com/users/pkr1234/received_events","type":"User","site_admin":false},"created_at":"2015-12-01T14:19:30Z","updated_at":"2015-12-01T14:19:30Z","author_association":"NONE","body":"That's not an option for me. I keep 45-60 days of logs pushed in by logstash for display by Kibana. These field names appear in all of the indexes logstash-yyyy.mm.dd . \n\nIs there a script that renames the existing fields and reindexes anywhere that I can use? I'm stuck. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160984302","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-160984302","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":160984302,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDk4NDMwMg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-01T14:31:44Z","updated_at":"2015-12-01T14:31:44Z","author_association":"CONTRIBUTOR","body":"The Perl and Python clients provide helpers for reindexing data, eg see:\n- http://elasticsearch-py.readthedocs.org/en/master/helpers.html#reindex\n- https://metacpan.org/pod/Search::Elasticsearch::Bulk#REINDEXING-DOCUMENTS\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/161279448","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-161279448","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":161279448,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MTI3OTQ0OA==","user":{"login":"pkr1234","id":11294187,"node_id":"MDQ6VXNlcjExMjk0MTg3","avatar_url":"https://avatars2.githubusercontent.com/u/11294187?v=4","gravatar_id":"","url":"https://api.github.com/users/pkr1234","html_url":"https://github.com/pkr1234","followers_url":"https://api.github.com/users/pkr1234/followers","following_url":"https://api.github.com/users/pkr1234/following{/other_user}","gists_url":"https://api.github.com/users/pkr1234/gists{/gist_id}","starred_url":"https://api.github.com/users/pkr1234/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pkr1234/subscriptions","organizations_url":"https://api.github.com/users/pkr1234/orgs","repos_url":"https://api.github.com/users/pkr1234/repos","events_url":"https://api.github.com/users/pkr1234/events{/privacy}","received_events_url":"https://api.github.com/users/pkr1234/received_events","type":"User","site_admin":false},"created_at":"2015-12-02T12:37:47Z","updated_at":"2015-12-02T12:52:02Z","author_association":"NONE","body":"Thanks Clinton. The python library is quite easy to install. I can't say the same about the perl library which fails to install using cpan. It complains about 0.20 Hijk. Anyway, I have worked out a way and here are my steps:\n\nA. Open all indexes\n`curl -XPOST http://localhost:9200/logstash-*/_open`\n\nB. Identify my dodgy fields with a \".\" character\n`curl -XGET http://localhost:9200/_all/_mapping?pretty |grep \"\\.\"`\nGrab all fields with dodgy character\n\nC. Search (count) my records with dodgy field\n\n```\n curl -XGET 'http://localhost:9200/_all/_count' -d '{\n   \"query\" : {\n     \"filtered\" : {\n         \"filter\" : {\n            \"exists\" : { \"field\" : \"DODGY.FIELD.NAME\"}\n         }\n     }\n   }\n}'\n```\n\nD. Once we know how many records will be affected and we are OK with purging them. I'm ok with purge but others may not be. I don;t know how to rename it. Maybe you could help us rename it. Anyway, to delete those records.\n\n```\n curl -XDELETE  'http://localhost:9200/_all/_query' -d '{\n   \"query\" : {\n     \"filtered\" : {\n         \"filter\" : {\n            \"exists\" : { \"field\" : \"DODGY.FIELD.NAME\"}\n         }\n     }\n   }\n}'\n\n```\n\nE. Now the records are deleted but the mapping still exists and snapshot restore will still fail. So we need to reindex. So install python library:\n\n```\nyum install python-pip\npip install elasticsearch\n```\n\nI have written a script that reindexes the old index to a new name. It works on 1.5.x version. Older versions of elasticsearch may have a problem if indexes are closed as cat did not list closed indexes. For older versions, simply open all indexes using curl. First argument is elasticsearch host and the second one is the indexname that we want to reindex. The target is indexname + 'a'. It will close the old index after reindex.\n\n```\n#!/usr/bin/python\n\n#########################\n#pkr1234\n# A script to reindex. It takes an index name and reindexes to indexname followed by a character 'a' i.e. logstash-2015.12.02a\n#########################\n\nimport sys\nimport traceback\nimport time\nfrom elasticsearch import Elasticsearch\nfrom elasticsearch.helpers import reindex\n\ndef isempty(name, value):\n    if (value == None):\n        print '[' + name + '] must be defined!'\n        return 1\n    if (len(value.strip()) == 0):\n        print '[' + name + '] cannot be empty!'\n        return 1\n\n    return 0\n\ndef printexit(msg, exitcode):\n    print \"\\n\" + msg + \"\\n\"\n    sys.exit(exitcode)\n\ndef existsindex(indexlist, indexname):\n    # Expects a python list of indexes as in cat\n    found = None\n    for item in indexlist:\n        itemsplitted = item.split()\n        if ('close' in item):\n            indname = itemsplitted[1]\n            indstatus = itemsplitted[0]\n        else:\n            indname = itemsplitted[2]\n            indstatus = itemsplitted[1]\n        if (indname == indexname):\n            found = [indname, indstatus]\n            break\n    return found\n\n\n\nif (len(sys.argv) <> 3):\n    printexit(\"You must supply two arguments: elasticsearch host as first argument and index name as second argument!\", 1)\n\n\nelhost = sys.argv[1]\nelindex = sys.argv[2]\nelnewindex = sys.argv[2] + 'a'\n\nisempty('elhost', elhost)\nisempty('elindex', elindex)\n\nes = None\nesindiceslist = None\n\ntry:\n    es = Elasticsearch(host=elhost)\n    esindiceslist = es.cat.indices().splitlines()\nexcept:\n    traceback.print_exc()\n    printexit(\"Unable to connect to elasticsearch and list indices! [\" + elhost + \"]\", 1)\n\nnelind = existsindex(esindiceslist, elnewindex)\nif (nelind):\n    printexit(\"New index [\" + elnewindex + \"] already exists with status [\" + nelind[1] + \". Cannot create!\", 1)\n\nelind = existsindex(esindiceslist, elindex)\nif (elind == None):\n    printexit(\"Index specified [\" + elindex + \"] does not exist. Cannot reindex!\", 1)\n\n\nif (elind[1] == \"close\"):\n   # We have to open it for reindex to proceed\n   print \"Now opening source [\" + elindex + \"] and sleeping 120 sec..\"\n   es.indices.open(elindex)\n   time.sleep(120)\n\nprint \"Now indexing source [\" + elindex + \"] to target [\" + elnewindex + \"] ..\"\nreindex(client=es,source_index=elindex,target_index=elnewindex)\n\n# Close old index\nes.indices.close(elindex)\n\n# Open new index\nes.indices.open(elnewindex)\n\n\n```\n\n```\nreindex.py 'localhost'  'logstash-2015.12.02' \n```\n\nThis will result in logstash-2015.12.02 being closed and a new index created called logstash-2015.12.02a\n\nF. Call the above script for each and every index that contains dodgy field. Once the reindex is complete, list the indexes:\n\n```\ncurl http://localhost:9200/_cat/indices?pretty\n```\n\nIt will show both old and new indexes (as in 1.5.0). For older elasticsearch, all indexes will have to be opened with a wildcard in a curl command.\n\nG. Once satisfied, delete the old indices (ones not ending in 'a')\n\n```\ncurl -XDELETE http://localhost:9200/[OLDINDEXNAME]\n\n```\n\nH. Once the new indices are created and old ones deleted, take the snapshot using the snapshot API. Take it over to the new 2.0.0 cluster and it should import as it does not have the fields with \".\" character. \n\nHope this helps someone. Ideally, a migration script should've been provided. Reindex is a slow process. I have about 45 days worth of logs (each 1 GB) - it will take a couple of overnight jobs to do it.\n\nFor new events, de-dot filter on logstash does the job fine on the fly renaming dodgy fiedls to underscores.\n\nFor rename - I don't know how to do it. My process is based upon deleting the offending records.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/161288408","html_url":"https://github.com/elastic/elasticsearch/issues/15122#issuecomment-161288408","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15122","id":161288408,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MTI4ODQwOA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-02T13:23:56Z","updated_at":"2015-12-02T13:23:56Z","author_association":"CONTRIBUTOR","body":"> Hope this helps someone. Ideally, a migration script should've been provided. Reindex is a slow process. \n\nWon't help you now, but we're working on making this better: https://github.com/elastic/elasticsearch/pull/15125\n","performed_via_github_app":null}]