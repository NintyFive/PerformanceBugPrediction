{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40772","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40772/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40772/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40772/events","html_url":"https://github.com/elastic/elasticsearch/issues/40772","id":428682464,"node_id":"MDU6SXNzdWU0Mjg2ODI0NjQ=","number":40772,"title":"[ML] Scrolling datafeeds leave open scroll contexts on error","user":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"assignees":[{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-04-03T10:13:54Z","updated_at":"2019-04-03T15:05:22Z","closed_at":"2019-04-03T15:05:22Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Datafeeds that use search/scroll should be clearing the scroll contexts they use after they are done. While they do so under normal circumstances, if there is an error thrown during the search request it appears they leave the scroll contexts open. Given we set the timeout to be `30m`, when an index pattern is used that matches many shards, this could mean quite a few of scroll contexts left open for a while. In combination with the change of the default value for the cluster setting `search.max_open_scroll_context` from unlimited to 500, this could lead to the cluster rejecting other search requests while those scroll contexts wait to be cleared.\r\n\r\n**Steps to reproduce**\r\n\r\nThere are many ways to reproduce this. Here is one.\r\n\r\n1. Setup a data index `foo-1` with a time field (mapped as `date`) and some docs.\r\n\r\ne.g.\r\n```\r\nPOST foo-1/_doc\r\n{\r\n  \"time\": \"2019-01-01T00:00:00Z\",\r\n  \"some_value\": 42.0      \r\n}\r\n```\r\n\r\n2. Setup another data index `foo-2` without that time field.\r\n\r\ne.g.\r\n```\r\nPOST foo-2/_doc\r\n{\r\n  \"some_value\": 42.0      \r\n}\r\n```\r\n\r\n3. Create a simple count job with a datafeed using index pattern `foo-*`\r\n4. Open job and start datafeed\r\n\r\n**Observed behaviour**\r\n\r\nThee datafeed should have an error notification that the search failed because not all indices have a `time` field to sort on. This is as expected.\r\n\r\nNow do:\r\n\r\n```\r\nGET _nodes/stats\r\n```\r\n\r\nand look for `search.open_contexts`. The number there should be `0` (assuming nothing else is using the cluster`. However, it is not as the datafeed did not clear the scroll context.","closed_by":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"performed_via_github_app":null}