[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/354849621","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-354849621","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":354849621,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NDg0OTYyMQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-01-02T19:08:24Z","updated_at":"2018-01-02T19:08:24Z","author_association":"MEMBER","body":"@fvilpoix thanks for opening this issue, I tried to come up with a reproduction on 6.1.1 with a minimal including a few simple example documents but failed so far. If you are able to reproduce this on a minimal setup (reduced mapping, a small number of examples that exhibit this behaviour on a fresh index) and could share this, that would be ideal. Otherwise, can you provide your example mapping and maybe a few documents from your data so we can reproduce this better?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355043213","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-355043213","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":355043213,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTA0MzIxMw==","user":{"login":"fvilpoix","id":1503147,"node_id":"MDQ6VXNlcjE1MDMxNDc=","avatar_url":"https://avatars2.githubusercontent.com/u/1503147?v=4","gravatar_id":"","url":"https://api.github.com/users/fvilpoix","html_url":"https://github.com/fvilpoix","followers_url":"https://api.github.com/users/fvilpoix/followers","following_url":"https://api.github.com/users/fvilpoix/following{/other_user}","gists_url":"https://api.github.com/users/fvilpoix/gists{/gist_id}","starred_url":"https://api.github.com/users/fvilpoix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fvilpoix/subscriptions","organizations_url":"https://api.github.com/users/fvilpoix/orgs","repos_url":"https://api.github.com/users/fvilpoix/repos","events_url":"https://api.github.com/users/fvilpoix/events{/privacy}","received_events_url":"https://api.github.com/users/fvilpoix/received_events","type":"User","site_admin":false},"created_at":"2018-01-03T15:40:19Z","updated_at":"2018-01-03T15:40:19Z","author_association":"NONE","body":"Thanks for your answer.\r\n\r\nI've tried to reduce the dataset to a minimal size in order to reproduce the issue, but as soon as I do a reindexation into a new index, the aggregation works normally.\r\n\r\nYou can find in attachement the mapping of the migrated index from 5.x, thus some significant data. But the Index as ~30.000.000 documents:\r\n\r\n[mapping.json.txt](https://github.com/elastic/elasticsearch/files/1600686/mapping.json.txt)\r\n[data.json.txt](https://github.com/elastic/elasticsearch/files/1600818/data.json.txt)\r\n\r\nThe data has been extracted with the following query :+1: \r\n```\r\nGET engagement-2017/_search\r\n{\r\n  \"aggs\": {\r\n    \"filtered\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"filter\": [\r\n            {\r\n              \"term\": {\r\n                \"media_id\": \"f4ab5b1493891cb5\"\r\n              }\r\n            },\r\n            {\r\n              \"range\": {\r\n                \"@timestamp\": {\r\n                  \"gte\": \"2017-11-11 00:00\",\r\n                  \"lte\": \"2017-11-11 01:00\",\r\n                  \"format\": \"yyyy-MM-dd HH:mm\"\r\n                }\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"__all__\": {\r\n          \"terms\": {\r\n            \"field\": \"eng.visu\",\r\n            \"size\": 9999\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"size\": 999\r\n}\r\n```\r\nYou can see that media_id filter is not fullfilled, as many others are fetched. For this media_id, eng.visu should never contains data > 197.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355277385","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-355277385","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":355277385,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTI3NzM4NQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-01-04T13:05:59Z","updated_at":"2018-01-04T13:06:20Z","author_association":"MEMBER","body":"Thanks, I don't see anything obviously wrong in the mapping or the query. Just a few things to clarify:\r\n* I assume \"engagement-2017\" is an alias, since the mapping mentions \"engagement_from_prod\" as an index name. Can you clarify this and check what indices it points to?\r\n* I see a \"\\_default\\_\", \"doc\" and \"engagement\" type in the mapping, are they all still used after migrating to 6.0? If so, is it possible that they accidentally contain any documents with the same `media_id` with the unexpected \"eng.visu\" data that might have been removed from other types an now still show up (the aggregation runs across all types I think) \r\n\r\n> You can see that media_id filter is not fullfilled, as many others are fetched.\r\n\r\nI don't completely understand what you mean by \"not fullfilled\". If you mean that the \"hits\" in the attached \"data.json.txt\" contain documents with all kinds of `media_id`, I think that is because the query part in is a \"match_all\" and you retrieve 999 hits. Why is this necessary for the aggregation? Maybe I'm missing something.\r\n\r\nOther than that, could you also again send the full query (inklusing the request URL) you use to check that for this media id (\"f4ab5b1493891cb5\") there are no hits with values >197 and if possible the response (maybe redacted to not expose private data)?\r\n  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355295814","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-355295814","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":355295814,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTI5NTgxNA==","user":{"login":"fvilpoix","id":1503147,"node_id":"MDQ6VXNlcjE1MDMxNDc=","avatar_url":"https://avatars2.githubusercontent.com/u/1503147?v=4","gravatar_id":"","url":"https://api.github.com/users/fvilpoix","html_url":"https://github.com/fvilpoix","followers_url":"https://api.github.com/users/fvilpoix/followers","following_url":"https://api.github.com/users/fvilpoix/following{/other_user}","gists_url":"https://api.github.com/users/fvilpoix/gists{/gist_id}","starred_url":"https://api.github.com/users/fvilpoix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fvilpoix/subscriptions","organizations_url":"https://api.github.com/users/fvilpoix/orgs","repos_url":"https://api.github.com/users/fvilpoix/repos","events_url":"https://api.github.com/users/fvilpoix/events{/privacy}","received_events_url":"https://api.github.com/users/fvilpoix/received_events","type":"User","site_admin":false},"created_at":"2018-01-04T14:29:22Z","updated_at":"2018-01-04T14:29:22Z","author_association":"NONE","body":"Thank you for your help!\r\n\r\n* yes, `engagement-2017` is an alias, linked on `engagement_from_prod`. From cerebro:\r\n![image](https://user-images.githubusercontent.com/1503147/34566700-d6038d22-f15f-11e7-96ea-3ae3dc17587c.png)\r\n* There are documents into `doc` and `engagement`. \r\n![image](https://user-images.githubusercontent.com/1503147/34566888-91062ec2-f160-11e7-89e4-84fb23bee0cd.png)\r\nQueries/aggregations are done without any type filter, so I believe it matchs all documents from any type, right?\r\n\r\nYou're right, I've given you the result of the wrong attempt, using an filter aggregation instead of a aggregation with filtered query. Sorry for the wase of time.\r\n\r\nI've done the right one, Data is perfect, but aggregation is weird, as there is data > 197 even that there are none in hits!!! (or I haven't understood how aggregations work :smile:)\r\n\r\n```json\r\nGET engagement-2017/_search?\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"media_id\": \"f4ab5b1493891cb5\"\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"2017-11-11 00:00\",\r\n              \"lte\": \"2017-11-11 01:00\",\r\n              \"format\": \"yyyy-MM-dd HH:mm\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"__all__\": {\r\n      \"terms\": {\r\n        \"field\": \"eng.visu\",\r\n        \"size\": 9999,\r\n        \"order\" : { \"_key\" : \"asc\" }\r\n      }\r\n    }\r\n  },\r\n  \"size\": 200\r\n}\r\n```\r\n[data.json.txt](https://github.com/elastic/elasticsearch/files/1603582/data.json.txt)\r\n\r\n\r\n\r\nHere is the full query asserting no data exists with values > 197:\r\n\r\n```json\r\nGET engagement-2017/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"media_id\": \"f4ab5b1493891cb5\"\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"eng.visu\": {\r\n              \"gt\": 197\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"size\": 9999\r\n} \r\n```\r\n\r\nAnd result:\r\n\r\n```json\r\n{\r\n  \"took\": 49,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 0,\r\n    \"max_score\": null,\r\n    \"hits\": []\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355311313","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-355311313","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":355311313,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTMxMTMxMw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-01-04T15:28:28Z","updated_at":"2018-01-04T15:28:28Z","author_association":"MEMBER","body":"Many thanks, this is strange indeed. Looking at the aggregation result, there are indeed only 159 documents for `\"media_id\": \"f4ab5b1493891cb5\"` but if I sum up the \"doc_counts\" in the terms aggregation buckets I get a total of 829, so something with the aggregation scope seems wrong.\r\n@colings86 would you mind sharing your opinion on this when you have time? I might have missed something obvious.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355363380","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-355363380","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":355363380,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTM2MzM4MA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-01-04T18:40:32Z","updated_at":"2018-01-04T18:40:32Z","author_association":"MEMBER","body":"Thanks @fvilpoix , this is a bug in 6x that appears on indices created in 5x which is why you cannot reproduce when you reindex the data. I am able to reproduce with a fresh install of 6x with an index created in 5x. I opened an issue in Lucene with a patch (https://issues.apache.org/jira/browse/LUCENE-8117) but if we are not able to release a new version of Lucene for the next release (6.2) we'll add a workaround in es directly.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/357743602","html_url":"https://github.com/elastic/elasticsearch/issues/28044#issuecomment-357743602","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28044","id":357743602,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Nzc0MzYwMg==","user":{"login":"fvilpoix","id":1503147,"node_id":"MDQ6VXNlcjE1MDMxNDc=","avatar_url":"https://avatars2.githubusercontent.com/u/1503147?v=4","gravatar_id":"","url":"https://api.github.com/users/fvilpoix","html_url":"https://github.com/fvilpoix","followers_url":"https://api.github.com/users/fvilpoix/followers","following_url":"https://api.github.com/users/fvilpoix/following{/other_user}","gists_url":"https://api.github.com/users/fvilpoix/gists{/gist_id}","starred_url":"https://api.github.com/users/fvilpoix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fvilpoix/subscriptions","organizations_url":"https://api.github.com/users/fvilpoix/orgs","repos_url":"https://api.github.com/users/fvilpoix/repos","events_url":"https://api.github.com/users/fvilpoix/events{/privacy}","received_events_url":"https://api.github.com/users/fvilpoix/received_events","type":"User","site_admin":false},"created_at":"2018-01-15T17:18:54Z","updated_at":"2018-01-15T17:18:54Z","author_association":"NONE","body":"Thanks everyone for the bugfix, I hope it will solve my problem!","performed_via_github_app":null}]