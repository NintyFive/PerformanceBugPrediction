{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27328","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27328/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27328/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27328/events","html_url":"https://github.com/elastic/elasticsearch/issues/27328","id":272484649,"node_id":"MDU6SXNzdWUyNzI0ODQ2NDk=","number":27328,"title":"Nodes in process of shutting down should not respond to discovery pings","user":{"login":"jakommo","id":6436143,"node_id":"MDQ6VXNlcjY0MzYxNDM=","avatar_url":"https://avatars2.githubusercontent.com/u/6436143?v=4","gravatar_id":"","url":"https://api.github.com/users/jakommo","html_url":"https://github.com/jakommo","followers_url":"https://api.github.com/users/jakommo/followers","following_url":"https://api.github.com/users/jakommo/following{/other_user}","gists_url":"https://api.github.com/users/jakommo/gists{/gist_id}","starred_url":"https://api.github.com/users/jakommo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakommo/subscriptions","organizations_url":"https://api.github.com/users/jakommo/orgs","repos_url":"https://api.github.com/users/jakommo/repos","events_url":"https://api.github.com/users/jakommo/events{/privacy}","received_events_url":"https://api.github.com/users/jakommo/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"assignees":[{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2017-11-09T08:58:22Z","updated_at":"2017-11-13T14:19:00Z","closed_at":"2017-11-13T14:19:00Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"It looks like a node that is being shutdown will still reply to an discovery ping.  \r\n\r\nMaster `node-108` is gracefully shutdown, but still listed in the current nodes list. I guess this is because its just some milliseconds after the shutdown started.\r\n\r\n```\r\n[2017-11-08T15:01:00,779][INFO ][o.e.d.z.ZenDiscovery     ] [node-106] master_left [{node-108}{SnsBg56PRuintH0DINacJQ}{Q0yTDGUpQNag1dKS56yoHw}{node108.home.lan}{10.10.10.15:9300}], reason [shut_down]\r\n[2017-11-08T15:01:00,781][WARN ][o.e.d.z.ZenDiscovery     ] [node-106] master left (reason = shut_down), current nodes: nodes: \r\n...\r\n   {node-108}{SnsBg56PRuintH0DINacJQ}{Q0yTDGUpQNag1dKS56yoHw}{node108.home.lan}{10.10.10.15:9300}, master\r\n```\r\n\r\nThen 3 seconds later the ping responses coming back and `node-108` is still listed. I checked the log on `node-108`, but there is nothing later than `2017-11-08T15:01:00,843`, which makes me wonder why it is still listed in the ping list. \r\n\r\n```\r\n[2017-11-08T15:01:03,785][TRACE][o.e.d.z.ZenDiscovery     ] [node-106] full ping responses:\r\n...\r\n        --> ping_response{node [{node-108}{SnsBg56PRuintH0DINacJQ}{Q0yTDGUpQNag1dKS56yoHw}{node108.home.lan}{10.10.10.15:9300}], id[44], master [{node-108}{SnsBg56PRuintH0DINacJQ}{Q0yTDGUpQNag1dKS56yoHw}{node108.home.lan}{10.10.10.15:9300}],cluster_state_version [420], cluster_name[my-cluster]}\r\n...\r\n[2017-11-08T15:01:03,789][WARN ][o.e.d.z.ZenDiscovery     ] [node-106] failed to connect to master [{node-108}{SnsBg56PRuintH0DINacJQ}{Q0yTDGUpQNag1dKS56yoHw}{node108.home.lan}{10.10.10.15:9300}], retrying...\r\n```\r\n\r\nOnly explanation I have is that ping was replied before `2017-11-08T15:01:00,843` already, which would match up with the `ping starting` : `:00,843` vs `:00,782`\r\n\r\n```\r\n[2017-11-08T15:01:00,782][TRACE][o.e.d.z.ZenDiscovery     ] [node-106] starting to ping\r\n[2017-11-08T15:01:00,782][TRACE][o.e.d.z.ZenDiscovery     ] [node-107] starting to ping\r\n```\r\n\r\nThen another ping is sent and 3 seconds later the reply does not list 108 anymore and a new master is elected.\r\n```\r\n[2017-11-08T15:01:03,798][TRACE][o.e.d.z.ZenDiscovery     ] [node-106] starting to ping\r\n[2017-11-08T15:01:06,799][TRACE][o.e.d.z.ZenDiscovery     ] [node-106] full ping responses:\r\n...\r\n        --> ping_response{node [{node-106}{668jPO1YSweDaqRyQxMRwA}{LwYDV2eBQAC3ialrV4qEbQ}{node106.home.lan}{10.10.10.13:9300}], id[39], master [null],cluster_state_version [420], cluster_name[my-cluster]}\r\n[2017-11-08T15:01:06,800][TRACE][o.e.d.z.ZenDiscovery     ] [node-106] candidate Candidate{node={node-106}{668jPO1YSweDaqRyQxMRwA}{LwYDV2eBQAC3ialrV4qEbQ}{node106.home.lan}{10.10.10.13:9300}, clusterStateVersion=420} won election\r\n[2017-11-08T15:01:06,801][DEBUG][o.e.d.z.ZenDiscovery     ] [node-106] elected as master, waiting for incoming joins ([1] needed)\r\n[2017-11-08T15:01:06,822][INFO ][o.e.c.s.ClusterService   ] [node-106] new_master {node-106}{668jPO1YSweDaqRyQxMRwA}{LwYDV2eBQAC3ialrV4qEbQ}{node106.home.lan}{10.10.10.13:9300}, reason: zen-disco-elected-as-master ([5] nodes joined)[{node-113}{1QzSsxO8ToqgUtfYycgmlw}{NUnBCQ_eSeSZjQV5PE1Jtg}{node113.home.lan}{10.10.10.20:9300}, {node-104}{59gFtGGvQGGy0LLVMIAgig}{Eg5gYe77SYuXB6vZfKKicg}{node104.home.lan}{10.10.10.214:9300}, {node-107}{_-P9koqwQAaBDpPyoflXbw}{j6BbufsTQq6kU-TFbAZW5Q}{node107.home.lan}{10.10.10.14:9300}, {node-105}{kt2uxSxNTDe9JhRuuWORYA}{VFf4A4bfTw6WoagiH6lpTw}{node105.home.lan}{10.10.10.215:9300}, {node-103}{TPSttSagTZq2VCDUhX5cGw}{puBEOLAARtmigK1y0lH5yw}{node103.home.lan}{10.10.10.213:9300}]\r\n```\r\n\r\nHad a quick chat with @ywelsch and it looks like a node in shutdown would still reply to a discovery ping request if the shutdown is not yet finished. \r\nSince such a node will be down shortly, it should not reply to a discovery ping. \r\nIt could also speed up master election. I.e. in the above example an extra cycle of 3 seconds was added because the old master was still listed. ","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}