{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10629","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10629/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10629/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10629/events","html_url":"https://github.com/elastic/elasticsearch/issues/10629","id":68914384,"node_id":"MDU6SXNzdWU2ODkxNDM4NA==","number":10629,"title":"Elasticsearch inner_hits query does not return second nested field in object field","user":{"login":"mariusdw","id":11732659,"node_id":"MDQ6VXNlcjExNzMyNjU5","avatar_url":"https://avatars2.githubusercontent.com/u/11732659?v=4","gravatar_id":"","url":"https://api.github.com/users/mariusdw","html_url":"https://github.com/mariusdw","followers_url":"https://api.github.com/users/mariusdw/followers","following_url":"https://api.github.com/users/mariusdw/following{/other_user}","gists_url":"https://api.github.com/users/mariusdw/gists{/gist_id}","starred_url":"https://api.github.com/users/mariusdw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mariusdw/subscriptions","organizations_url":"https://api.github.com/users/mariusdw/orgs","repos_url":"https://api.github.com/users/mariusdw/repos","events_url":"https://api.github.com/users/mariusdw/events{/privacy}","received_events_url":"https://api.github.com/users/mariusdw/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2015-04-16T12:34:14Z","updated_at":"2018-02-14T13:26:49Z","closed_at":"2015-04-30T15:02:14Z","author_association":"NONE","active_lock_reason":null,"body":"Hi All\n\nPlease refer to issue <a href=\"https://github.com/elastic/elasticsearch/issues/10334\">10334</a> that was marked as fixed in the latest release (1.5.1). I have tested this today and it still doesnt work correctly. The ArrayOutOfBoundsException is gone, however I now get incorrect data back.  Only the first entry is returned regardless of which entry has matched the search request.\n\nTo Replicate: Setup the same template and data as in issue <a href=\"https://github.com/elastic/elasticsearch/issues/10334\">10334</a>:\n\n<pre><code>curl -XPOST 'http://localhost:9200/twitter'\n\ncurl -XPOST 'http://localhost:9200/twitter/_mapping/tweet' -d '\n{\n    \"tweet\": {\n        \"properties\": {\n            \"comments\": {\n                \"properties\": {\n                    \"messages\": {\n                        \"type\": \"nested\",\n                        \"properties\": {\n                            \"message\": {\n                                \"type\" : \"string\", \n                                \"index\": \"not_analyzed\"\n                            }   \n                        }\n                    } \n                }\n            }\n        }\n    }\n}'\n\ncurl -XPOST 'http://localhost:9200/twitter/tweet' -d '\n{\n    \"comments\": {\n        \"messages\": [\n            {\"message\": \"Nice website\"},\n            {\"message\": \"Worst ever\"}\n        ]\n    }\n}'\n\n</code></pre>\n\n\nNow search for the message \"Worst ever\"\n\n<pre><code>\ncurl -XGET 'http://localhost:9200/twitter/tweet/_search?pretty' -d '\n{\n    \"query\": {\n        \"nested\": {\n            \"path\": \"comments.messages\",\n            \"query\": {\n                \"match\": {\"comments.messages.message\": \"Worst ever\"}\n            },\n            \"inner_hits\" : {}\n        }\n    }\n}'\n</code></pre>\n\n\nThe following gets returned:\n\n<pre><code>\n{\n  \"took\" : 4,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 1.4054651,\n    \"hits\" : [ {\n      \"_index\" : \"twitter\",\n      \"_type\" : \"tweet\",\n      \"_id\" : \"AUzCMIjnYDWhRGHuJRhC\",\n      \"_score\" : 1.4054651,\n      \"_source\":\n{\n    \"comments\": {\n        \"messages\": [\n            {\"message\": \"Nice website\"},\n            {\"message\": \"Worst ever\"}\n        ]\n    }\n},\n      \"inner_hits\" : {\n        \"comments.messages\" : {\n          \"hits\" : {\n            \"total\" : 1,\n            \"max_score\" : 1.4054651,\n            \"hits\" : [ {\n              \"_index\" : \"twitter\",\n              \"_type\" : \"tweet\",\n              \"_id\" : \"AUzCMIjnYDWhRGHuJRhC\",\n              \"_nested\" : {\n                \"field\" : \"comments\",\n                \"offset\" : 0,\n                \"_nested\" : {\n                  \"field\" : \"messages\",\n                  \"offset\" : 0\n                }\n              },\n              \"_score\" : 1.4054651,\n              \"_source\":{\"message\":\"Nice website\"}\n            } ]\n          }\n        }\n      }\n    } ]\n  }\n}\n</code></pre>\n\n\nThis is clearly the incorrect inner hit. As discussed previously with martijnvg a workaround is if I change the object field in my mapping to be nested as well, like this:\n\n<pre><code>\ncurl -XPOST 'http://localhost:9200/twitter/_mapping/tweet' -d '\n{\n    \"tweet\": {\n        \"properties\": {\n            \"comments\": {\n                \"type\": \"nested\",\n                \"properties\": {\n                    \"messages\": {\n                        \"type\": \"nested\",\n                        \"properties\": {\n                            \"message\": {\n                                \"type\" : \"string\", \n                                \"index\": \"not_analyzed\"\n                            }   \n                        }\n                    } \n                }\n            }\n        }\n    }\n}'\n</code></pre>\n\n\nhowever doing so results in a larger memory footprint which is undesirable. Also note the use case in #10334 in my second post on the issue that explains why I only need a normal object field containing nested fields.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}