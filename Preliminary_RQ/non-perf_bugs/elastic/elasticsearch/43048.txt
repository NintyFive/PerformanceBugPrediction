{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43048","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43048/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43048/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43048/events","html_url":"https://github.com/elastic/elasticsearch/issues/43048","id":454198506,"node_id":"MDU6SXNzdWU0NTQxOTg1MDY=","number":43048,"title":"[CI] AzureDiscoveryClusterFormationTests leaks threads","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1352927464,"node_id":"MDU6TGFiZWwxMzUyOTI3NDY0","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.3.0","name":"v7.3.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2019-06-10T14:27:03Z","updated_at":"2019-06-25T08:18:12Z","closed_at":"2019-06-25T08:18:12Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.2+matrix-java-periodic/ES_BUILD_JAVA=openjdk12,ES_RUNTIME_JAVA=java12,nodes=immutable&&linux&&docker/11/testReport/org.elasticsearch.discovery.azure.classic/AzureDiscoveryClusterFormationTests/classMethod/\r\n\r\nfailed with:\r\n\r\n```\r\nJun 10, 2019 4:32:16 AM com.carrotsearch.randomizedtesting.ThreadLeakControl tryToInterruptAll\r\nSEVERE: There are still zombie threads that couldn't be terminated:\r\n   1) Thread[id=28, name=server-timer, state=TIMED_WAITING, group=TGRP-AzureDiscoveryClusterFormationTests]\r\n        at java.base@12.0.1/java.lang.Object.wait(Native Method)\r\n        at java.base@12.0.1/java.util.TimerThread.mainLoop(Timer.java:553)\r\n        at java.base@12.0.1/java.util.TimerThread.run(Timer.java:506)\r\n   2) Thread[id=29, name=HTTP-Dispatcher, state=RUNNABLE, group=TGRP-AzureDiscoveryClusterFormationTests]\r\n        at java.base@12.0.1/sun.security.ssl.SSLEngineImpl.checkParams(SSLEngineImpl.java:422)\r\n        at java.base@12.0.1/sun.security.ssl.SSLEngineImpl.wrap(SSLEngineImpl.java:133)\r\n        at java.base@12.0.1/sun.security.ssl.SSLEngineImpl.wrap(SSLEngineImpl.java:116)\r\n        at java.base@12.0.1/javax.net.ssl.SSLEngine.wrap(SSLEngine.java:479)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.SSLStreams$EngineWrapper.wrapAndSendX(SSLStreams.java:283)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.SSLStreams.doClosure(SSLStreams.java:436)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.SSLStreams.recvData(SSLStreams.java:410)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.SSLStreams$InputStream.read(SSLStreams.java:522)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.SSLStreams$InputStream.read(SSLStreams.java:591)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.Request.readLine(Request.java:80)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.Request.<init>(Request.java:50)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:551)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.ServerImpl$DefaultExecutor.execute(ServerImpl.java:159)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.ServerImpl$Dispatcher.handle(ServerImpl.java:442)\r\n        at platform/jdk.httpserver@12.0.1/sun.net.httpserver.ServerImpl$Dispatcher.run(ServerImpl.java:408)\r\n        at java.base@12.0.1/java.lang.Thread.run(Thread.java:835)\r\n   3) Thread[id=45, name=elasticsearch[node_s1][generic][T#2], state=RUNNABLE, group=TGRP-AzureDiscoveryClusterFormationTests]\r\n        at java.base@12.0.1/java.net.SocketInputStream.socketRead0(Native Method)\r\n        at java.base@12.0.1/java.net.SocketInputStream.socketRead(SocketInputStream.java:115)\r\n        at java.base@12.0.1/java.net.SocketInputStream.read(SocketInputStream.java:168)\r\n        at java.base@12.0.1/java.net.SocketInputStream.read(SocketInputStream.java:140)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketInputRecord.read(SSLSocketInputRecord.java:448)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketInputRecord.decode(SSLSocketInputRecord.java:165)\r\n        at java.base@12.0.1/sun.security.ssl.SSLTransport.decode(SSLTransport.java:108)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketImpl.decode(SSLSocketImpl.java:1180)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketImpl.readHandshakeRecord(SSLSocketImpl.java:1091)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:402)\r\n        at app//org.apache.http.conn.ssl.SSLConnectionSocketFactory.createLayeredSocket(SSLConnectionSocketFactory.java:436)\r\n        at app//org.apache.http.conn.ssl.SSLConnectionSocketFactory.connectSocket(SSLConnectionSocketFactory.java:384)\r\n        at app//org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)\r\n        at app//org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:374)\r\n        at app//org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:393)\r\n        at app//org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:236)\r\n        at app//org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)\r\n        at app//org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)\r\n        at app//org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:110)\r\n        at app//org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\r\n        at app//org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)\r\n        at app//org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:108)\r\n        at app//com.microsoft.windowsazure.management.compute.HostedServiceOperationsImpl.getDetailed(HostedServiceOperationsImpl.java:1814)\r\n        at app//org.elasticsearch.cloud.azure.classic.management.AzureComputeServiceImpl.lambda$getServiceDetails$0(AzureComputeServiceImpl.java:102)\r\n        at app//org.elasticsearch.cloud.azure.classic.management.AzureComputeServiceImpl$$Lambda$1727/0x0000000801793840.run(Unknown Source)\r\n        at java.base@12.0.1/java.security.AccessController.executePrivileged(AccessController.java:781)\r\n        at java.base@12.0.1/java.security.AccessController.doPrivileged(AccessController.java:551)\r\n        at app//org.elasticsearch.cloud.azure.classic.management.AzureComputeServiceImpl.getServiceDetails(AzureComputeServiceImpl.java:101)\r\n        at app//org.elasticsearch.discovery.azure.classic.AzureSeedHostsProvider.getSeedAddresses(AzureSeedHostsProvider.java:155)\r\n        at app//org.elasticsearch.discovery.DiscoveryModule.lambda$new$3(DiscoveryModule.java:127)\r\n        at app//org.elasticsearch.discovery.DiscoveryModule$$Lambda$1318/0x000000080168c840.getSeedAddresses(Unknown Source)\r\n        at app//org.elasticsearch.discovery.SeedHostsResolver$1.doRun(SeedHostsResolver.java:225)\r\n        at app//org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:758)\r\n        at app//org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at java.base@12.0.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n        at java.base@12.0.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n        at java.base@12.0.1/java.lang.Thread.run(Thread.java:835)\r\n   4) Thread[id=44, name=elasticsearch[node_s0][generic][T#2], state=RUNNABLE, group=TGRP-AzureDiscoveryClusterFormationTests]\r\n        at java.base@12.0.1/java.net.SocketInputStream.socketRead0(Native Method)\r\n        at java.base@12.0.1/java.net.SocketInputStream.socketRead(SocketInputStream.java:115)\r\n        at java.base@12.0.1/java.net.SocketInputStream.read(SocketInputStream.java:168)\r\n        at java.base@12.0.1/java.net.SocketInputStream.read(SocketInputStream.java:140)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketInputRecord.read(SSLSocketInputRecord.java:448)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketInputRecord.decode(SSLSocketInputRecord.java:165)\r\n        at java.base@12.0.1/sun.security.ssl.SSLTransport.decode(SSLTransport.java:108)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketImpl.decode(SSLSocketImpl.java:1180)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketImpl.readHandshakeRecord(SSLSocketImpl.java:1091)\r\n        at java.base@12.0.1/sun.security.ssl.SSLSocketImpl.startHandshake(SSLSocketImpl.java:402)\r\n        at app//org.apache.http.conn.ssl.SSLConnectionSocketFactory.createLayeredSocket(SSLConnectionSocketFactory.java:436)\r\n        at app//org.apache.http.conn.ssl.SSLConnectionSocketFactory.connectSocket(SSLConnectionSocketFactory.java:384)\r\n        at app//org.apache.http.impl.conn.DefaultHttpClientConnectionOperator.connect(DefaultHttpClientConnectionOperator.java:142)\r\n        at app//org.apache.http.impl.conn.PoolingHttpClientConnectionManager.connect(PoolingHttpClientConnectionManager.java:374)\r\n        at app//org.apache.http.impl.execchain.MainClientExec.establishRoute(MainClientExec.java:393)\r\n        at app//org.apache.http.impl.execchain.MainClientExec.execute(MainClientExec.java:236)\r\n        at app//org.apache.http.impl.execchain.ProtocolExec.execute(ProtocolExec.java:186)\r\n        at app//org.apache.http.impl.execchain.RetryExec.execute(RetryExec.java:89)\r\n        at app//org.apache.http.impl.execchain.RedirectExec.execute(RedirectExec.java:110)\r\n        at app//org.apache.http.impl.client.InternalHttpClient.doExecute(InternalHttpClient.java:185)\r\n        at app//org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:83)\r\n        at app//org.apache.http.impl.client.CloseableHttpClient.execute(CloseableHttpClient.java:108)\r\n        at app//com.microsoft.windowsazure.management.compute.HostedServiceOperationsImpl.getDetailed(HostedServiceOperationsImpl.java:1814)\r\n        at app//org.elasticsearch.cloud.azure.classic.management.AzureComputeServiceImpl.lambda$getServiceDetails$0(AzureComputeServiceImpl.java:102)\r\n        at app//org.elasticsearch.cloud.azure.classic.management.AzureComputeServiceImpl$$Lambda$1727/0x0000000801793840.run(Unknown Source)\r\n        at java.base@12.0.1/java.security.AccessController.executePrivileged(AccessController.java:781)\r\n        at java.base@12.0.1/java.security.AccessController.doPrivileged(AccessController.java:551)\r\n        at app//org.elasticsearch.cloud.azure.classic.management.AzureComputeServiceImpl.getServiceDetails(AzureComputeServiceImpl.java:101)\r\n        at app//org.elasticsearch.discovery.azure.classic.AzureSeedHostsProvider.getSeedAddresses(AzureSeedHostsProvider.java:155)\r\n        at app//org.elasticsearch.discovery.DiscoveryModule.lambda$new$3(DiscoveryModule.java:127)\r\n        at app//org.elasticsearch.discovery.DiscoveryModule$$Lambda$1318/0x000000080168c840.getSeedAddresses(Unknown Source)\r\n        at app//org.elasticsearch.discovery.SeedHostsResolver$1.doRun(SeedHostsResolver.java:225)\r\n        at app//org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:758)\r\n        at app//org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at java.base@12.0.1/java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\r\n        at java.base@12.0.1/java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\r\n        at java.base@12.0.1/java.lang.Thread.run(Thread.java:835)\r\n```\r\n\r\nI were unable to reproduce this locally with the reproduction line:\r\n\r\n```\r\n ./gradlew :plugins:discovery-azure-classic:test --tests \"org.elasticsearch.discovery.azure.classic.AzureDiscoveryClusterFormationTests\"   -Dtests.seed=C8A0CB3379E68CC5   -Dtests.security.manager=true   -Dtests.locale=en-US   -Dtests.timezone=Etc/UTC   -Dcompiler.java=12   -Druntime.java=12 \r\n\r\n```\r\n\r\nFollowing warnings at the end of the test might be relevant:\r\n\r\n```\r\n[2019-06-09T18:31:53,071][INFO ][o.a.h.i.e.RetryExec      ] [node_s1] I/O exception (org.apache.http.NoHttpResponseException) caught when processing request to {s}->https://127.0.0.1:43806: The target server failed to respond\r\n[2019-06-09T18:31:53,071][INFO ][o.a.h.i.e.RetryExec      ] [node_s0] I/O exception (org.apache.http.NoHttpResponseException) caught when processing request to {s}->https://127.0.0.1:43806: The target server failed to respond\r\n[2019-06-09T18:31:53,073][INFO ][o.a.h.i.e.RetryExec      ] [node_s1] Retrying request to {s}->https://127.0.0.1:43806\r\n[2019-06-09T18:31:53,073][INFO ][o.a.h.i.e.RetryExec      ] [node_s0] Retrying request to {s}->https://127.0.0.1:43806\r\n```\r\n\r\nGradle build scan link: https://scans.gradle.com/s/rxfo7h4uyrvbw\r\n\r\nWill mute this, since it fails around once per week:\r\n\r\nhttps://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-60d,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:AzureDiscoveryClusterFormationTests),sort:!(time,desc))\r\n\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}