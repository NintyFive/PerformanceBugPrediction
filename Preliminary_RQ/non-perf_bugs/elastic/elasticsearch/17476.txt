{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17476","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17476/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17476/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17476/events","html_url":"https://github.com/elastic/elasticsearch/issues/17476","id":145179921,"node_id":"MDU6SXNzdWUxNDUxNzk5MjE=","number":17476,"title":"Add jna as non optional within the test framework","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2016-04-01T13:24:22Z","updated_at":"2016-05-04T14:26:23Z","closed_at":"2016-05-04T14:26:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"I'm using the test framework 5.0.0-alpha1 from an external plugin (see `pom.xml` snippet):\n\n``` xml\n        <dependency>\n            <groupId>org.elasticsearch.test</groupId>\n            <artifactId>framework</artifactId>\n            <version>${elasticsearch.version}</version>\n            <scope>test</scope>\n        </dependency>\n```\n\nWhen implementing a simple IT like this:\n\n``` java\npublic class BanaPluginTest extends ESIntegTestCase {\n    public void testBanoPlugin() {    }\n}\n```\n\nAnd launching, I'm getting this error:\n\n```\nERROR   0.00s | BanaPluginTest (suite) <<<\n   > Throwable #1: java.lang.NoClassDefFoundError: com/sun/jna/Structure$ByReference\n   >    at java.lang.ClassLoader.defineClass1(Native Method)\n   >    at java.lang.ClassLoader.defineClass(ClassLoader.java:760)\n   >    at java.security.SecureClassLoader.defineClass(SecureClassLoader.java:142)\n   >    at java.net.URLClassLoader.defineClass(URLClassLoader.java:467)\n   >    at java.net.URLClassLoader.access$100(URLClassLoader.java:73)\n   >    at java.net.URLClassLoader$1.run(URLClassLoader.java:368)\n   >    at java.net.URLClassLoader$1.run(URLClassLoader.java:362)\n   >    at java.security.AccessController.doPrivileged(Native Method)\n   >    at java.net.URLClassLoader.findClass(URLClassLoader.java:361)\n   >    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)\n   >    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)\n   >    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)\n   >    at org.elasticsearch.bootstrap.JNANatives.trySetMaxSizeVirtualMemory(JNANatives.java:131)\n   >    at org.elasticsearch.bootstrap.Bootstrap.initializeNatives(Bootstrap.java:138)\n   >    at org.elasticsearch.bootstrap.BootstrapForTesting.<clinit>(BootstrapForTesting.java:77)\n   >    at org.elasticsearch.test.ESTestCase.<clinit>(ESTestCase.java:111)\n   >    at java.lang.Class.forName0(Native Method)\n   >    at java.lang.Class.forName(Class.java:348)\n   >    at com.carrotsearch.randomizedtesting.RandomizedRunner$2.run(RandomizedRunner.java:585)\n   > Caused by: java.lang.ClassNotFoundException: com.sun.jna.Structure$ByReference\n   >    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)\n   >    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)\n   >    at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)\n   >    at java.lang.ClassLoader.loadClass(ClassLoader.java:357)\n   >    ... 19 more\n```\n\nActually `jna` is defined a an optional library in elasticsearch, which is fine, but the test framework uses it.\n\nTo fix that, I have to change my `pom.xml` and add:\n\n``` xml\n        <dependency>\n            <groupId>net.java.dev.jna</groupId>\n            <artifactId>jna</artifactId>\n            <version>4.1.0</version>\n            <scope>test</scope>\n        </dependency>\n```\n\nI think we should declare `jna` not optional in the test framework so it will come by default when anyone uses it.\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}