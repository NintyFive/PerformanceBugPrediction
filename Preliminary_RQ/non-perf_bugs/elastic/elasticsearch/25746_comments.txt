[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315731286","html_url":"https://github.com/elastic/elasticsearch/issues/25746#issuecomment-315731286","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746","id":315731286,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTczMTI4Ng==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T11:35:25Z","updated_at":"2017-07-17T11:35:25Z","author_association":"MEMBER","body":"@pmishev Could you elaborate on what you think it wrong with the behaviour in 5.5.? Looking at your uax_url_email tokenizer and the subsequent pattern filter, the query looks okay to me:\r\n\r\n```\r\nPOST /test1/_analyze\r\n{\r\n  \"analyzer\": \"my_analyzer1\", \r\n  \"text\" : \"somebody@we-example.com\"\r\n}\r\n\r\n{\r\n  \"tokens\": [\r\n    {\r\n      \"token\": \"somebody@we-example.com\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 23,\r\n      \"type\": \"<EMAIL>\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"somebody\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 23,\r\n      \"type\": \"<EMAIL>\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"we\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 23,\r\n      \"type\": \"<EMAIL>\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"example\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 23,\r\n      \"type\": \"<EMAIL>\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"com\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 23,\r\n      \"type\": \"<EMAIL>\",\r\n      \"position\": 0\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nAs documented, the [Patter Capture Token Filter](https://www.elastic.co/guide/en/elasticsearch/reference/current/analysis-pattern-capture-tokenfilter.html) emmits all tokens it produces in the same position, and with the same character offsets. This is the cause for the \"+Synonym\" in the explanation output.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315733861","html_url":"https://github.com/elastic/elasticsearch/issues/25746#issuecomment-315733861","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746","id":315733861,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTczMzg2MQ==","user":{"login":"pmishev","id":5188763,"node_id":"MDQ6VXNlcjUxODg3NjM=","avatar_url":"https://avatars1.githubusercontent.com/u/5188763?v=4","gravatar_id":"","url":"https://api.github.com/users/pmishev","html_url":"https://github.com/pmishev","followers_url":"https://api.github.com/users/pmishev/followers","following_url":"https://api.github.com/users/pmishev/following{/other_user}","gists_url":"https://api.github.com/users/pmishev/gists{/gist_id}","starred_url":"https://api.github.com/users/pmishev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmishev/subscriptions","organizations_url":"https://api.github.com/users/pmishev/orgs","repos_url":"https://api.github.com/users/pmishev/repos","events_url":"https://api.github.com/users/pmishev/events{/privacy}","received_events_url":"https://api.github.com/users/pmishev/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T11:49:34Z","updated_at":"2017-07-17T11:49:34Z","author_association":"NONE","body":"@cbuescher, to illustrate what I mean:\r\n```\r\n\r\nPUT /test1/emails/1\r\n{\r\n  \"email1\": \"somebody@we-example.com\",\r\n  \"email2\": \"somebody@we-example.com\"\r\n}\r\n\r\nGET test1/emails/_search\r\n{\r\n  \"query\": {\r\n    \"match\": {\r\n      \"email1\": {\r\n        \"query\": \"blah@we-example.com\",\r\n        \"operator\": \"and\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThat query will return the document.\r\nHowever it shouldn't, because one of the tokens during search term analysis will be `blah` and such token does not exist within the indexed tokens. And because I used `\"operator\": \"and\"` I expect to NOT get any results from the query.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/316029154","html_url":"https://github.com/elastic/elasticsearch/issues/25746#issuecomment-316029154","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746","id":316029154,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNjAyOTE1NA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-07-18T10:56:17Z","updated_at":"2017-07-18T10:56:17Z","author_association":"MEMBER","body":"There is a note at the end of the documentation for the `pattern_filter`:\r\n> Note: All tokens are emitted in the same position, and with the same character offsets, so when combined with highlighting, the whole original token will be highlighted, not just the matching subset. For instance, querying the above email address for \"smith\" would highlight:\r\n\r\nSo the query parser thinks that all these tokens are at the same position and build them as synonyms. I think it should be clearly stated in the docs that each token will be considered as a full replacement for the email address. Bottom line is that this is the expected behavior with this token filter.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/316353020","html_url":"https://github.com/elastic/elasticsearch/issues/25746#issuecomment-316353020","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746","id":316353020,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNjM1MzAyMA==","user":{"login":"pmishev","id":5188763,"node_id":"MDQ6VXNlcjUxODg3NjM=","avatar_url":"https://avatars1.githubusercontent.com/u/5188763?v=4","gravatar_id":"","url":"https://api.github.com/users/pmishev","html_url":"https://github.com/pmishev","followers_url":"https://api.github.com/users/pmishev/followers","following_url":"https://api.github.com/users/pmishev/following{/other_user}","gists_url":"https://api.github.com/users/pmishev/gists{/gist_id}","starred_url":"https://api.github.com/users/pmishev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmishev/subscriptions","organizations_url":"https://api.github.com/users/pmishev/orgs","repos_url":"https://api.github.com/users/pmishev/repos","events_url":"https://api.github.com/users/pmishev/events{/privacy}","received_events_url":"https://api.github.com/users/pmishev/received_events","type":"User","site_admin":false},"created_at":"2017-07-19T11:14:22Z","updated_at":"2017-07-19T11:14:22Z","author_association":"NONE","body":"Thank you for clarifying that. That explains a lot. \r\nHowever, that makes using token filters that generate additional tokens kind of useless for AND queries, doesn't it?\r\n\r\nPerhaps when `and` operator is used in a match query, the token order should be ignored? \r\nBut perhaps there are other scenarios where that may not be the right thing to do.\r\n\r\nAlternatively perhaps a `pattern_capture` tokenizer should be introduced that is as powerful as the filter, but would generate the tokens in different positions?\r\n","performed_via_github_app":null}]