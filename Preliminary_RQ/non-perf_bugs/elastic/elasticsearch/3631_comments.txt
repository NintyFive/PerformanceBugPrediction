[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23950233","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-23950233","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":23950233,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTUwMjMz","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2013-09-06T15:57:04Z","updated_at":"2013-09-06T15:57:04Z","author_association":"MEMBER","body":"Hey @mattweber \ncan you share the test you ran to obtain the above stacktrace? No way you could reproduce it consistently right?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23957877","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-23957877","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":23957877,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTU3ODc3","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2013-09-06T17:56:44Z","updated_at":"2013-09-06T17:56:44Z","author_association":"CONTRIBUTOR","body":"Hey @javanna,\n\nI was playing around with bulk indexing the [stackoverflow posts.xml data](http://www.clearbits.net/get/2076-aug-2012.torrent).  I was consistently deleting and reindexing the data tweaking settings and measuring the performance difference.  I started to notice this with the following:\n- parent/child mapping described in [this blog post](http://www.fullscale.co/blog/2013/02/19/Using_ElasticSearch_To_Find_Best_Time_To_Ask_Questions_On_StackOverflow.html)\n- 5 shards, no replicas (I reproduced with less shards too) \n- refresh -1\n- bulk size of 100\n- 8 feeding processes\n- translog flush settings doubled from defaults\n- segments per tier 30\n- optimize segments of 5\n- increased index buffer (40% of 6GB heap)\n- bulk threadpool fixed at size 24\n- no searching during feeding or optimize\n\nFeeding would take ~45min for just under 11M docs.  The blog post above has a python feeding script attached, I was basically using an updated version of that which uses python multiprocessing module to break out the work across 8 processes.  Unfortunately I just left on vacation and forgot to commit those changes so I can't provide that script until next week.  Please let me know if you need any more information.  \n\nThanks!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/23958015","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-23958015","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":23958015,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTU4MDE1","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2013-09-06T17:59:03Z","updated_at":"2013-09-06T17:59:03Z","author_association":"CONTRIBUTOR","body":"Ohh and [es2graphite](https://github.com/mattweber/es2graphite) which executes cluster health, node stats, and node info rest calls was running every 10 seconds.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24484936","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24484936","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24484936,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDg0OTM2","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T01:22:21Z","updated_at":"2013-09-16T01:22:21Z","author_association":"CONTRIBUTOR","body":"@javanna \n\nOk, I can still reproduce this.  Here is a gist of my feeding scripts to be used with the posts.xml file downloaded from the torrent linked above, https://gist.github.com/mattweber/d969e9c91b45503ac452.  Here is some info from logs, maybe it has something with the fact I am changing settings right before the optimize? \n\nI am going to try to come up with an easier reproduce method so you don't need to download all the stackoverflow data.  I will keep you updated.  Thanks.\n\n```\n[2013-09-15 18:09:58,437][DEBUG][cluster.service          ] [samcro] cluster state updated, version [8], source [update-settings]\n[2013-09-15 18:09:58,439][INFO ][index.merge.policy       ] [samcro] [stackoverflow][0] updating [segments_per_tier] from [30.0] to [10.0]\n[2013-09-15 18:09:58,439][INFO ][index.shard.service      ] [samcro] [stackoverflow][0] updating refresh_interval from [-1] to [1s]\n[2013-09-15 18:09:58,443][DEBUG][river.cluster            ] [samcro] processing [reroute_rivers_node_changed]: execute\n[2013-09-15 18:09:58,444][DEBUG][river.cluster            ] [samcro] processing [reroute_rivers_node_changed]: no change in cluster_state\n[2013-09-15 18:09:58,469][INFO ][index.translog           ] [samcro] [stackoverflow][0] updating flush_threshold_ops from [10000] to [5000]\n[2013-09-15 18:09:58,469][INFO ][index.translog           ] [samcro] [stackoverflow][0] updating flush_threshold_size from [500mb] to [200mb]\n[2013-09-15 18:09:58,470][INFO ][index.merge.policy       ] [samcro] [stackoverflow][1] updating [segments_per_tier] from [30.0] to [10.0]\n[2013-09-15 18:09:58,470][INFO ][index.shard.service      ] [samcro] [stackoverflow][1] updating refresh_interval from [-1] to [1s]\n[2013-09-15 18:09:58,470][INFO ][index.translog           ] [samcro] [stackoverflow][1] updating flush_threshold_ops from [10000] to [5000]\n[2013-09-15 18:09:58,470][INFO ][index.translog           ] [samcro] [stackoverflow][1] updating flush_threshold_size from [500mb] to [200mb]\n[2013-09-15 18:09:58,560][DEBUG][cluster.service          ] [samcro] processing [update-settings]: done applying updated cluster_state\n[2013-09-15 18:09:58,785][DEBUG][action.admin.indices.optimize] [samcro] [stackoverflow][0], node[s9_7RSkTSUiNThZpuvLU6A], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.admin.indices.optimize.OptimizeRequest@598d2fb7]\norg.elasticsearch.index.engine.FlushNotAllowedEngineException: [stackoverflow][0] already flushing...\n    at org.elasticsearch.index.engine.robin.RobinEngine.flush(RobinEngine.java:818)\n    at org.elasticsearch.index.engine.robin.RobinEngine.optimize(RobinEngine.java:1014)\n    at org.elasticsearch.index.shard.service.InternalIndexShard.optimize(InternalIndexShard.java:512)\n    at org.elasticsearch.action.admin.indices.optimize.TransportOptimizeAction.shardOperation(TransportOptimizeAction.java:115)\n    at org.elasticsearch.action.admin.indices.optimize.TransportOptimizeAction.shardOperation(TransportOptimizeAction.java:49)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction.performOperation(TransportBroadcastOperationAction.java:228)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction.performOperation(TransportBroadcastOperationAction.java:205)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction$1.run(TransportBroadcastOperationAction.java:179)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:722)\n\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24492133","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24492133","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24492133,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDkyMTMz","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T07:11:14Z","updated_at":"2013-09-16T07:11:14Z","author_association":"MEMBER","body":"This can happen during relocation, at that point, flush is not allowed to be executed. optimize operation defaults to performing flush, though you don't have to do it to optimize, in which case, you can set the flush flag to false?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24519443","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24519443","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24519443,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTE5NDQz","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T15:37:19Z","updated_at":"2013-09-16T15:37:19Z","author_association":"CONTRIBUTOR","body":"Hey @kimchy,\n\nThere are no relocations going on when this happens.  It is a single node cluster and I have reproduced it on an index with a single shard.  In fact, it happens more consistently when I have less shards.  It happens pretty much every time when I have 1 or 2 shards.  Once I get up to 3+ shards it doesn't happen as often.  Maybe I am hitting some sort of race condition?\n\nThanks.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24533266","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24533266","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24533266,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTMzMjY2","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T18:35:58Z","updated_at":"2013-09-16T18:35:58Z","author_association":"CONTRIBUTOR","body":"I reproduced using 0.90.4 as well.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24533916","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24533916","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24533916,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTMzOTE2","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T18:44:30Z","updated_at":"2013-09-16T18:44:30Z","author_association":"MEMBER","body":"we also periodically flush due to the transaction log (not just when relocating, apologies for not explaining to details), and if you issue a flush while another flush is happening, then we will throw the mentioned failure as well. We have an internal flag to wait for ongoing flushes, we can expose it through the API.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24534065","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24534065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24534065,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTM0MDY1","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T18:46:45Z","updated_at":"2013-09-16T18:46:45Z","author_association":"CONTRIBUTOR","body":"I am not sure if we should expose it or if we should just set it to `true` (ie. wait for ongoing flushes) on an optimize call. Folks are used to wait on a optimize call and if we fail that they might get confused calling optimize again. I think we should just wait by default?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24535231","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24535231","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24535231,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTM1MjMx","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T19:01:28Z","updated_at":"2013-09-16T19:01:28Z","author_association":"MEMBER","body":"@s1monw agreed, I think its a good default to have when calling optimize, will do it.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24535274","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24535274","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24535274,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTM1Mjc0","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T19:01:58Z","updated_at":"2013-09-16T19:01:58Z","author_association":"CONTRIBUTOR","body":"+1\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/24535349","html_url":"https://github.com/elastic/elasticsearch/issues/3631#issuecomment-24535349","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3631","id":24535349,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NTM1MzQ5","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"created_at":"2013-09-16T19:02:59Z","updated_at":"2013-09-16T19:02:59Z","author_association":"CONTRIBUTOR","body":"Sounds good to me, thanks for the info!\n","performed_via_github_app":null}]