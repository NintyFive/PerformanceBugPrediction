{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2674","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2674/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2674/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2674/events","html_url":"https://github.com/elastic/elasticsearch/issues/2674","id":11284603,"node_id":"MDU6SXNzdWUxMTI4NDYwMw==","number":2674,"title":"Query DSL: Terms filter to allow for terms lookup from another document","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":17100279,"node_id":"MDU6TGFiZWwxNzEwMDI3OQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.0.Beta1","name":"v0.90.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2013-02-22T12:55:26Z","updated_at":"2017-09-18T11:32:46Z","closed_at":"2013-02-22T13:04:16Z","author_association":"MEMBER","active_lock_reason":null,"body":"The terms filter requires providing all the terms as part of the filter itself. Allow to automatically extract them from an external document.\n\nHere is an example:\n\n```\n# index the information for user with id 2, specifically, its friends\ncurl -XPUT localhost:9200/users/user/2 -d '{\n   \"friends\" : [\"1\", \"3\"]\n}'\n\n# index a tweet, from user with id 2\ncurl -XPUT localhost:9200/tweets/tweet/1 -d '{\n   \"user\" : \"2\"\n}'\n\n# search on all the tweets that match the friends of user 2\ncurl -XGET localhost:9200/tweets/_search -d '{\n  \"query\" : {\n    \"filtered\" : {\n        \"filter\" : {\n            \"terms\" : {\n                \"user\" : {\n                    \"index\" : \"users\",\n                    \"type\" : \"user\",\n                    \"id\" : \"2\",\n                    \"path\" : \"friends\"\n                },\n                \"_cache_key\" : \"user_2_friends\"\n            }\n        }\n    }\n  }\n}'\n```\n\nThe above is higly optimized, both in a sense that the list of friends will not be fetched if the filter is already cached in the filter cache, and with internal LRU cache for fetching external values for the terms filter. Also, the entry in teh filter cache will not hold _all_ the terms reducing the memory required for it.\n\n`_cache_key` is recommedned to be set, so its simple to clear the cache associated with it using the clear cache API. For example:\n\n```\ncurl -XPOST 'localhost:9200/tweets/_cache/clear?filter_keys=user_2_friends'\n```\n\nThe structure of the external terms document can also include array of inner objects, for example:\n\n```\ncurl -XPUT localhost:9200/users/user/2 -d '{\n   \"friends\" : [\n     {\n       \"id\" : \"1\"\n     },\n     {\n       \"id\" : \"2\"\n     }\n   ]\n}'\n```\n\nIn which case, the lookup path will be `friends.id`.\n\nThere is an additional cache involved, which caches the lookup of the lookup document to the actual terms. It is by default set to `10mb` LRU size, but can be explicitly set using `indices.cache.filter.terms.size`.\n\nAlso, consider using an index with a single shard and fully replicated across all nodes if the \"reference\" terms data is not large. The lookup terms filter will prefer to execute the get request on a local node if possible, reducing the need for networking.\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}