{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33884","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33884/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33884/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33884/events","html_url":"https://github.com/elastic/elasticsearch/issues/33884","id":362055762,"node_id":"MDU6SXNzdWUzNjIwNTU3NjI=","number":33884,"title":"Access _source in scripted metric aggregation with state context","user":{"login":"ruizmarc","id":5717082,"node_id":"MDQ6VXNlcjU3MTcwODI=","avatar_url":"https://avatars3.githubusercontent.com/u/5717082?v=4","gravatar_id":"","url":"https://api.github.com/users/ruizmarc","html_url":"https://github.com/ruizmarc","followers_url":"https://api.github.com/users/ruizmarc/followers","following_url":"https://api.github.com/users/ruizmarc/following{/other_user}","gists_url":"https://api.github.com/users/ruizmarc/gists{/gist_id}","starred_url":"https://api.github.com/users/ruizmarc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ruizmarc/subscriptions","organizations_url":"https://api.github.com/users/ruizmarc/orgs","repos_url":"https://api.github.com/users/ruizmarc/repos","events_url":"https://api.github.com/users/ruizmarc/events{/privacy}","received_events_url":"https://api.github.com/users/ruizmarc/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-09-20T07:36:52Z","updated_at":"2018-10-24T01:07:54Z","closed_at":"2018-10-24T01:07:54Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.1\r\n\r\n**Plugins installed**: No plugins installed\r\n\r\n**JVM version** (`java -version`):  java version \"1.8.0_25\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Darwin Kernel Version 17.5.0\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI was trying to use an scripted metric aggregation with the new context (state) instead the old one (params). And aggregations are working properly if accessing doc. However, with previous versions I was able to access _source by doing: params._source. With this new context, I cannot access _source with: state._source, nor params._source. \r\n\r\nI was expecting to be able to continue accessing _source as in previous versions because some of my current scripts  are not working with this new version. \r\n\r\nFor our use case it is very convinient to be able to access the _source because we have quite complex structures with deep nested array fields that must be evaluated independently and being able to access _source allows us to do very complex calculations on some of those nested fields. ","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}