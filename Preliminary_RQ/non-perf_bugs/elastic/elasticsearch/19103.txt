{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19103","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19103/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19103/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19103/events","html_url":"https://github.com/elastic/elasticsearch/issues/19103","id":162501938,"node_id":"MDU6SXNzdWUxNjI1MDE5Mzg=","number":19103,"title":"Bulk update with script / upsert broken in 1.7.5 with different JSON key order","user":{"login":"andrewvc","id":131427,"node_id":"MDQ6VXNlcjEzMTQyNw==","avatar_url":"https://avatars2.githubusercontent.com/u/131427?v=4","gravatar_id":"","url":"https://api.github.com/users/andrewvc","html_url":"https://github.com/andrewvc","followers_url":"https://api.github.com/users/andrewvc/followers","following_url":"https://api.github.com/users/andrewvc/following{/other_user}","gists_url":"https://api.github.com/users/andrewvc/gists{/gist_id}","starred_url":"https://api.github.com/users/andrewvc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrewvc/subscriptions","organizations_url":"https://api.github.com/users/andrewvc/orgs","repos_url":"https://api.github.com/users/andrewvc/repos","events_url":"https://api.github.com/users/andrewvc/events{/privacy}","received_events_url":"https://api.github.com/users/andrewvc/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"},{"id":299866753,"node_id":"MDU6TGFiZWwyOTk4NjY3NTM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.7.5","name":"v1.7.5","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-06-27T17:11:48Z","updated_at":"2018-03-20T14:28:04Z","closed_at":"2018-03-20T14:28:04Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"If, in the JSON object of a bulk update with scripted upsert the keys \"upsert\" and \"scripted_upsert\" do not appear as the first keys the whole thing fails. \n\nThis is ONLY in 1.x. This works in 2.x and 5.x\n\nThis works\n\n``````\nPOST /test/type/_bulk\n{\"update\":{\"_id\":\"5\",\"_retry_on_conflict\":1}}\n{\"upsert\":{},\"scripted_upsert\":true,\"script\":{\"script\":\"ctx._source['@timestamp'] = event['@timestamp']; ctx._source['@version'] = event['@version']\",\"params\":{\"event\":{\"@timestamp\":\"2016-06-24T22:35:46.992Z\",\"@version\":\"1\",\"message\":\"sample message here\"}}}}```\n``````\n\nThis does not\n\n```\nPOST /test/type/_bulk\n{\"update\":{\"_id\":\"5\",\"_retry_on_conflict\":1}}\n{\"script\":{\"script\":\"ctx._source['@timestamp'] = event['@timestamp']; ctx._source['@version'] = event['@version']\",\"params\":{\"event\":{\"@timestamp\":\"2016-06-24T22:35:46.992Z\",\"@version\":\"1\",\"message\":\"sample message here\"}}},\"upsert\":{},\"scripted_upsert\":true}\n```\n\nThanks to @pickypg for pinning down the source of this which seems to be [here in UpdateHelper.java](https://github.com/elastic/elasticsearch/blob/v1.7.5/src/main/java/org/elasticsearch/action/update/UpdateHelper.java#L83)\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}