{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8507","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8507/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8507/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8507/events","html_url":"https://github.com/elastic/elasticsearch/issues/8507","id":49113008,"node_id":"MDU6SXNzdWU0OTExMzAwOA==","number":8507,"title":"Exception from geohash_grid aggregation with array of points (ES 1.4.0)","user":{"login":"mvdz","id":9332217,"node_id":"MDQ6VXNlcjkzMzIyMTc=","avatar_url":"https://avatars1.githubusercontent.com/u/9332217?v=4","gravatar_id":"","url":"https://api.github.com/users/mvdz","html_url":"https://github.com/mvdz","followers_url":"https://api.github.com/users/mvdz/followers","following_url":"https://api.github.com/users/mvdz/following{/other_user}","gists_url":"https://api.github.com/users/mvdz/gists{/gist_id}","starred_url":"https://api.github.com/users/mvdz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mvdz/subscriptions","organizations_url":"https://api.github.com/users/mvdz/orgs","repos_url":"https://api.github.com/users/mvdz/repos","events_url":"https://api.github.com/users/mvdz/events{/privacy}","received_events_url":"https://api.github.com/users/mvdz/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2014-11-17T16:34:21Z","updated_at":"2014-11-20T09:36:44Z","closed_at":"2014-11-20T09:36:44Z","author_association":"NONE","active_lock_reason":null,"body":"Using a geohash_grid aggregation used to work on arrays of points, but with ES 1.4.0 an exception occurs instead. The following curl commands reproduce the issue on a clean installation of ES:\n\n```\n# create index with geo_point mapping\ncurl -XPUT localhost:9200/test -d '{\n  \"mappings\": {\n    \"test\": {\n      \"properties\": {\n        \"points\": {\n          \"type\": \"geo_point\",\n          \"geohash_prefix\": true\n        }\n      }\n    }\n  }\n}'\n\n# insert documents\ncurl -XPUT localhost:9200/test/test/1?refresh=true -d '{ \"points\": [[1,2], [2,3]] }'\ncurl -XPUT localhost:9200/test/test/2?refresh=true -d '{ \"points\": [[2,3], [3,4]] }'\n\n# perform aggregation\ncurl -XGET localhost:9200/test/test/_search?pretty -d '{\n  \"size\": 0,\n  \"aggs\": {\n    \"a1\": {\n      \"geohash_grid\": {\n        \"field\": \"points\",\n        \"precision\": 3\n      }\n    }\n  }\n}'\n```\n\nOn Elasticsearch 1.3.5 this produces the expected result:\n\n```\n...\n  \"aggregations\" : {\n    \"a1\" : {\n      \"buckets\" : [ {\n        \"key\" : \"s09\",\n        \"doc_count\" : 2\n      }, {\n        \"key\" : \"s0d\",\n        \"doc_count\" : 1\n      }, {\n        \"key\" : \"s02\",\n        \"doc_count\" : 1\n      } ]\n    }\n  }\n...\n```\n\nHowever on Elasticsearch 1.4.0 this triggers a failure:\n\n```\n{\n  \"took\" : 76,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 3,\n    \"failed\" : 2,\n    \"failures\" : [ {\n      \"index\" : \"test\",\n      \"shard\" : 2,\n      \"status\" : 500,\n      \"reason\" : \"QueryPhaseExecutionException[[test][2]: query[ConstantScore(cache(_type:test))],from[0],size[0]: Query Failed [Failed to execute main query]]; nested: ArrayIndexOutOfBoundsException[1]; \"\n    }, {\n      \"index\" : \"test\",\n      \"shard\" : 3,\n      \"status\" : 500,\n      \"reason\" : \"QueryPhaseExecutionException[[test][3]: query[ConstantScore(cache(_type:test))],from[0],size[0]: Query Failed [Failed to execute main query]]; nested: ArrayIndexOutOfBoundsException[1]; \"\n    } ]\n  },\n  \"hits\" : {\n    \"total\" : 0,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"a1\" : {\n      \"buckets\" : [ ]\n    }\n  }\n}\n```\n\nThe log contains this exception:\n\n```\n[2014-11-17 17:28:25,121][DEBUG][action.search.type       ] [Franklin Storm] [test][3], node[-S9ijRKKQH-IEAr3sUW14Q], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@1fa40d49]\norg.elasticsearch.search.query.QueryPhaseExecutionException: [test][3]: query[ConstantScore(cache(_type:test))],from[0],size[0]: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:163)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:275)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:231)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:228)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:559)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:744)\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 1\n    at org.elasticsearch.search.aggregations.bucket.geogrid.GeoHashGridParser$GeoGridFactory$CellValues.setDocument(GeoHashGridParser.java:154)\n    at org.elasticsearch.search.aggregations.bucket.geogrid.GeoHashGridAggregator.collect(GeoHashGridAggregator.java:73)\n    at org.elasticsearch.search.aggregations.AggregationPhase$AggregationsCollector.collect(AggregationPhase.java:161)\n    at org.elasticsearch.common.lucene.MultiCollector.collect(MultiCollector.java:60)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:193)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163)\n    at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:191)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:309)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:117)\n    ... 7 more\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}