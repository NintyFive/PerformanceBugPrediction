{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/58481","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58481/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58481/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58481/events","html_url":"https://github.com/elastic/elasticsearch/issues/58481","id":644496822,"node_id":"MDU6SXNzdWU2NDQ0OTY4MjI=","number":58481,"title":"Missing bwc java.time layer for 6.8 date_index_name ingest processor","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"},{"id":1967495446,"node_id":"MDU6TGFiZWwxOTY3NDk1NDQ2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Infra","name":"Team:Core/Infra","color":"fef2c0","default":false,"description":"Meta label for core/infra team"},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"assignees":[{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-06-24T10:17:28Z","updated_at":"2020-07-06T09:44:08Z","closed_at":"2020-07-06T09:44:08Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"looks like #34507 was not backported to 6.8\r\nit was meant to be fixed by this #37407 but it missed `IndexNameExpresionResolver` class. It only fixed this in `DateFormat` (used by when creating an index name expression, but not resolving. This is used during simulate and on 'phase1' ingestion with index name processor)\r\nit is not possible to use date formats with `8` prefix in `date_index_name` ingest processors\r\nthis works in simulate but does not work with ingest\r\nsteps to reproduce\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/_ingest/pipeline/index_name \\\r\n  --header 'authorization: Basic ZWxhc3RpYzpwYXNzd29yZA==' \\\r\n  --header 'content-type: application/json' \\\r\n  --data '{\r\n  \"description\": \"Pipeline for routing data to specific index\",\r\n  \"processors\": [\r\n    {\r\n      \"date_index_name\": {\r\n        \"field\": \"my_timestamp\",\r\n        \"date_rounding\": \"d\",\r\n        \"index_name_prefix\": \"x-\",\r\n        \"index_name_format\": \"8YYYY-w\"\r\n      }\r\n    }\r\n  ]\r\n}'\r\n```\r\n\r\nsimulate - ok\r\n```\r\ncurl --request POST \\\r\n  --url http://localhost:9200/_ingest/pipeline/_simulate \\\r\n  --header 'authorization: Basic ZWxhc3RpYzpwYXNzd29yZA==' \\\r\n  --header 'content-type: application/json' \\\r\n  --data '{\r\n  \"pipeline\": {\r\n    \"processors\": [\r\n      {\r\n        \"pipeline\": {\r\n          \"name\": \"index_name\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"docs\": [\r\n    {\r\n      \"_source\": {\r\n \t\t\t\t \"my_timestamp\": \"2020-08-10T01:01:01.000Z\"\r\n      }\r\n    }\r\n  ]\r\n}'\r\n```\r\nsimulate result:\r\n\r\n```\r\n{\r\n  \"docs\": [\r\n    {\r\n      \"doc\": {\r\n        \"_index\": \"<x-{2020-33||/d{8YYYY-w|UTC}}>\",\r\n        \"_type\": \"_type\",\r\n        \"_id\": \"_id\",\r\n        \"_source\": {\r\n          \"my_timestamp\": \"2020-08-10T01:01:01.000Z\"\r\n        },\r\n        \"_ingest\": {\r\n          \"timestamp\": \"2020-06-24T10:53:08.433437Z\"\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n\r\ningestion fail\r\n```\r\ncurl --request PUT \\\r\n  --url 'http://localhost:9200/test1/_doc/1?pipeline=index_name' \\\r\n  --header 'authorization: Basic ZWxhc3RpYzpwYXNzd29yZA==' \\\r\n  --header 'content-type: application/json' \\\r\n  --data '{\r\n  \"my_timestamp\": \"2020-08-10T01:01:01.000Z\"\r\n}'\r\n```\r\ningestion failure result\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"parse_exception\",\r\n        \"reason\": \"failed to parse date field [2020-33] with format [8YYYY-w]\"\r\n      }\r\n    ],\r\n    \"type\": \"parse_exception\",\r\n    \"reason\": \"failed to parse date field [2020-33] with format [8YYYY-w]\",\r\n    \"caused_by\": {\r\n      \"type\": \"illegal_argument_exception\",\r\n      \"reason\": \"Parse failure at index [0] of [2020-33]\"\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\n\r\nit works with joda\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/_ingest/pipeline/index_name \\\r\n  --header 'authorization: Basic ZWxhc3RpYzpwYXNzd29yZA==' \\\r\n  --header 'content-type: application/json' \\\r\n  --data '{\r\n  \"description\": \"Pipeline for routing data to specific index\",\r\n  \"processors\": [\r\n    {\r\n      \"date_index_name\": {\r\n        \"field\": \"my_timestamp\",\r\n        \"date_rounding\": \"d\",\r\n        \"index_name_prefix\": \"x-\",\r\n        \"index_name_format\": \"xxxx-w\"\r\n      }\r\n    }\r\n  ]\r\n}'\r\n```\r\n\r\nsimulate\r\n```\r\ncurl --request POST \\\r\n  --url http://localhost:9200/_ingest/pipeline/_simulate \\\r\n  --header 'authorization: Basic ZWxhc3RpYzpwYXNzd29yZA==' \\\r\n  --header 'content-type: application/json' \\\r\n  --data '{\r\n  \"pipeline\": {\r\n    \"processors\": [\r\n      {\r\n        \"pipeline\": {\r\n          \"name\": \"index_name\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"docs\": [\r\n    {\r\n      \"_source\": {\r\n \t\t\t\t \"my_timestamp\": \"2020-08-10T01:01:01.000Z\"\r\n      }\r\n    }\r\n  ]\r\n}'\r\n```\r\n\r\ningestion ok\r\n```\r\ncurl --request PUT \\\r\n  --url 'http://localhost:9200/test1/_doc/1?pipeline=index_name' \\\r\n  --header 'authorization: Basic ZWxhc3RpYzpwYXNzd29yZA==' \\\r\n  --header 'content-type: application/json' \\\r\n  --data '{\r\n  \"my_timestamp\": \"2020-08-10T01:01:01.000Z\"\r\n}'\r\n```\r\n\r\nresult\r\n```\r\n{\r\n  \"_index\": \"x-2020-33\",\r\n  \"_type\": \"_doc\",\r\n  \"_id\": \"1\",\r\n  \"_version\": 1,\r\n  \"result\": \"created\",\r\n  \"_shards\": {\r\n    \"total\": 2,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"_seq_no\": 0,\r\n  \"_primary_term\": 1\r\n}\r\n```\r\n","closed_by":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"performed_via_github_app":null}