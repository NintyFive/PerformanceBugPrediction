{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23727","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23727/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23727/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23727/events","html_url":"https://github.com/elastic/elasticsearch/issues/23727","id":216562574,"node_id":"MDU6SXNzdWUyMTY1NjI1NzQ=","number":23727,"title":"Bucket Selector aggregation failing with nested and parent/child structures.","user":{"login":"james08","id":8150069,"node_id":"MDQ6VXNlcjgxNTAwNjk=","avatar_url":"https://avatars3.githubusercontent.com/u/8150069?v=4","gravatar_id":"","url":"https://api.github.com/users/james08","html_url":"https://github.com/james08","followers_url":"https://api.github.com/users/james08/followers","following_url":"https://api.github.com/users/james08/following{/other_user}","gists_url":"https://api.github.com/users/james08/gists{/gist_id}","starred_url":"https://api.github.com/users/james08/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james08/subscriptions","organizations_url":"https://api.github.com/users/james08/orgs","repos_url":"https://api.github.com/users/james08/repos","events_url":"https://api.github.com/users/james08/events{/privacy}","received_events_url":"https://api.github.com/users/james08/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-03-23T20:28:06Z","updated_at":"2017-03-28T21:35:21Z","closed_at":"2017-03-28T08:11:52Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n\r\n**Elasticsearch version**:\r\nVersion: 5.2.2, Build: f9d9b74/2017-02-24T17:26:45.835Z, JVM: 1.8.0_121\r\n\r\n**Plugins installed**: []\r\nNone.\r\n\r\n**JVM version**:\r\nJVM: 1.8.0_121\r\n\r\n**OS version**:\r\nMac OS Sierra 10.12.3 \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI'm using a bucket_selector (part of pipeline aggretions). Goal (expected behaviour): for a parent/child or nested relationship: buckets are on a parent field, aggregate over a child field, filter out buckets based on result of that aggregate. I've tested with data in a nested structure and data in a parent/child structure, I've included steps to reproduce both below.\r\n\r\n**Steps to reproduce with nested structure**:\r\n```\r\n\r\nDELETE pipelinetest\r\n \r\nPUT pipelinetest\r\n{\r\n   \"mappings\": {\r\n      \"team\": {\r\n         \"properties\": {\r\n            \"name\": {\r\n               \"type\": \"keyword\"\r\n            },\r\n            \"description\": {\r\n               \"type\": \"text\"\r\n            },\r\n            \"memberCount\": {\r\n               \"type\": \"integer\"\r\n            },\r\n            \"developer\": {\r\n               \"type\": \"nested\",\r\n               \"properties\": {\r\n                  \"gender\": {\r\n                     \"type\": \"keyword\"\r\n                  },\r\n                  \"height\": {\r\n                     \"type\": \"integer\"\r\n                  },\r\n                  \"name\": {\r\n                     \"type\": \"text\"\r\n                  },\r\n                  \"laptop\": {\r\n                     \"type\": \"nested\",\r\n                     \"properties\": {\r\n                        \"color\": {\r\n                           \"type\": \"keyword\"\r\n                        },\r\n                        \"brand\": {\r\n                           \"type\": \"keyword\"\r\n                        },\r\n                        \"hasTouchBar\": {\r\n                           \"type\": \"keyword\"\r\n                        },\r\n                        \"age\": {\r\n                           \"type\": \"integer\"\r\n                        }\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n\r\nPUT pipelinetest/team/1\r\n{\r\n   \"name\": \"Monoceros\",\r\n   \"description\": \"Auckland Analytics\",\r\n   \"memberCount\": 4,\r\n   \"developer\": [\r\n      {\r\n         \"name\": \"James\",\r\n         \"gender\": \"Male\",\r\n         \"height\": \"185\",\r\n         \"laptop\": [\r\n            {\r\n               \"color\": \"Gun Metal\",\r\n               \"brand\": \"Apple\",\r\n               \"hasTouchBar\": \"True\",\r\n               \"age\": \"1\"\r\n            }\r\n         ]\r\n      },\r\n      {\r\n         \"name\": \"John\",\r\n         \"gender\": \"Male\",\r\n         \"height\": \"184\",\r\n         \"laptop\": [\r\n            {\r\n               \"color\": \"Silver\",\r\n               \"brand\": \"Apple\",\r\n               \"hasTouchBar\": \"False\",\r\n               \"age\": \"2\"\r\n            }\r\n         ]\r\n      },\r\n      {\r\n         \"name\": \"Kate\",\r\n         \"gender\": \"Female\",\r\n         \"height\": \"170\",\r\n         \"laptop\": [\r\n            {\r\n               \"color\": \"Silver\",\r\n               \"brand\": \"Apple\",\r\n               \"hasTouchBar\": \"False\",\r\n               \"age\": \"2\"\r\n            }\r\n         ]\r\n      },\r\n      {\r\n         \"name\": \"Samuel\",\r\n         \"gender\": \"Male\",\r\n         \"height\": \"168\",\r\n         \"laptop\": [\r\n            {\r\n               \"color\": \"Gun Metal\",\r\n               \"brand\": \"Apple\",\r\n               \"hasTouchBar\": \"True\",\r\n               \"age\": \"1\"\r\n            },\r\n            {\r\n               \"color\": \"Gun Metal\",\r\n               \"brand\": \"Apple\",\r\n               \"hasTouchBar\": \"True\",\r\n               \"age\": \"1\"\r\n            }\r\n         ]\r\n      }\r\n   ]\r\n}\r\n\r\n\r\nGET pipelinetest/team/_search\r\n{\r\n   \"aggs\": {\r\n      \"developers\": {\r\n         \"nested\": {\r\n            \"path\": \"developer.laptop\"\r\n         },\r\n         \"aggs\": {\r\n            \"sum_age\": {\r\n               \"sum\": {\r\n                  \"field\": \"developer.laptop.age\"\r\n               }\r\n            },\r\n            \"age_bucket_filter\": {\r\n               \"bucket_selector\": {\r\n                  \"buckets_path\": {\r\n                     \"sumAge\": \"sum_age\"\r\n                  },\r\n                  \"script\": \"params.sumAge >= 7\"\r\n               }\r\n            }\r\n         }\r\n      }\r\n   },\r\n   \"size\": 0\r\n}\r\n```\r\n\r\n**Result**\r\n```\r\n{\r\n   \"error\": {\r\n      \"root_cause\": [],\r\n      \"type\": \"reduce_search_phase_exception\",\r\n      \"reason\": \"[reduce] \",\r\n      \"phase\": \"fetch\",\r\n      \"grouped\": true,\r\n      \"failed_shards\": [],\r\n      \"caused_by\": {\r\n         \"type\": \"class_cast_exception\",\r\n         \"reason\": \"org.elasticsearch.search.aggregations.bucket.nested.InternalNested cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\"\r\n      }\r\n   },\r\n   \"status\": 503\r\n}\r\n```\r\n\r\n**Steps to reproduce with parent/child structure**:\r\n```\r\nDELETE pipelinetest\r\n \r\nPUT pipelinetest\r\n{\r\n   \"mappings\": {\r\n       \"team\": {\r\n         \"properties\": {\r\n            \"teamName\": {\r\n               \"type\": \"keyword\"\r\n            },\r\n            \"description\": {\r\n               \"type\": \"text\"\r\n            },\r\n            \"memberCount\": {\r\n               \"type\": \"integer\"\r\n            }\r\n         }\r\n      },\r\n      \"developer\": {\r\n          \"_parent\": {\r\n            \"type\": \"team\"\r\n         },\r\n         \"properties\": {\r\n            \"gender\": {\r\n               \"type\": \"keyword\"\r\n            },\r\n            \"height\": {\r\n               \"type\": \"integer\"\r\n            },\r\n            \"name\": {\r\n               \"type\": \"keyword\"\r\n            }\r\n         }\r\n      },\r\n      \"laptop\": {\r\n         \"_parent\": {\r\n            \"type\": \"developer\"\r\n         },\r\n         \"properties\": {\r\n            \"color\": {\r\n               \"type\": \"keyword\"\r\n            },\r\n            \"brand\": {\r\n               \"type\": \"keyword\"\r\n            },\r\n            \"hasTouchBar\": {\r\n               \"type\": \"keyword\"\r\n            },\r\n            \"age\": {\r\n               \"type\": \"integer\"\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n\r\nPOST pipelinetest/team/_bulk\r\n{\"index\":{\"_id\":\"1\", \"routing\":\"1\"}}\r\n{\"teamName\":\"Monoceros\", \"description\": \"Auckland Analytics\", \"memberCount\":4}\r\n{\"index\":{\"_id\":\"2\", \"routing\":\"1\"}}\r\n{\"teamName\":\"The Avengers\", \"description\": \"They have a hulk.\", \"memberCount\":5}\r\n \r\nPOST pipelinetest/developer/_bulk\r\n{\"index\":{\"_id\":\"1\", \"parent\":\"1\", \"routing\":\"1\"}}\r\n{\"name\": \"James\", \"gender\":\"M\", \"height\":185}\r\n{\"index\":{\"_id\":\"2\", \"_parent\":\"1\", \"routing\":\"1\"}}\r\n{\"name\": \"Kate\",\"gender\":\"F\",\"height\":170}\r\n{\"index\":{\"_id\":\"3\", \"_parent\":\"1\", \"routing\":\"1\"}}\r\n{\"name\": \"Samuel\",\"gender\":\"M\",\"height\":168}\r\n{\"index\":{\"_id\":\"4\", \"_parent\":\"1\", \"routing\":\"1\"}}\r\n{\"name\": \"John\",\"gender\":\"M\",\"height\":184}\r\n{\"index\":{\"_id\":\"5\", \"parent\":\"2\", \"routing\":\"1\"}}\r\n{\"name\": \"Iron Man\", \"gender\":\"M\", \"height\":175}\r\n{\"index\":{\"_id\":\"6\", \"_parent\":\"2\", \"routing\":\"1\"}}\r\n{\"name\": \"Hulk\",\"gender\":\"M\",\"height\":230}\r\n{\"index\":{\"_id\":\"7\", \"_parent\":\"2\", \"routing\":\"1\"}}\r\n{\"name\": \"Thor\",\"gender\":\"M\",\"height\":192}\r\n{\"index\":{\"_id\":\"8\", \"_parent\":\"2\", \"routing\":\"1\"}}\r\n{\"name\": \"Hawk\",\"gender\":\"M\",\"height\":180}\r\n{\"index\":{\"_id\":\"9\", \"_parent\":\"2\", \"routing\":\"1\"}}\r\n{\"name\": \"Black Widow\",\"gender\":\"F\",\"height\":163}\r\n \r\nPOST pipelinetest/laptop/_bulk\r\n{\"index\":{\"_id\":\"1\", \"parent\":\"1\", \"routing\":\"1\"}}\r\n{\"color\": \"gun metal\", \"hasTouchBar\":\"Y\", \"brand\":\"Apple\",\"age\":1}\r\n{\"index\":{\"_id\":\"2\", \"parent\":\"2\", \"routing\":\"1\"}}\r\n{\"color\": \"silver\", \"hasTouchBar\":\"N\", \"brand\":\"Apple\",\"age\":2}\r\n{\"index\":{\"_id\":\"3\", \"parent\":\"3\", \"routing\":\"1\"}}\r\n{\"color\": \"N/A\", \"hasTouchBar\":\"N/A\", \"brand\":\"N/A\",\"age\":0}\r\n{\"index\":{\"_id\":\"4\", \"parent\":\"3\", \"routing\":\"1\"}}\r\n{\"color\": \"gun metal\", \"hasTouchBar\":\"Y\", \"brand\":\"Apple\",\"age\":1}\r\n{\"index\":{\"_id\":\"5\", \"parent\":\"4\", \"routing\":\"1\"}}\r\n{\"color\": \"silver\", \"hasTouchBar\":\"N\", \"brand\":\"Apple\",\"age\":2}\r\n{\"index\":{\"_id\":\"6\", \"parent\":\"5\", \"routing\":\"1\"}}\r\n{\"color\": \"gun metal\", \"hasTouchBar\":\"Y\", \"brand\":\"Apple\",\"age\":1}\r\n{\"index\":{\"_id\":\"7\", \"parent\":\"7\", \"routing\":\"1\"}}\r\n{\"color\": \"silver\", \"hasTouchBar\":\"N\", \"brand\":\"Apple\",\"age\":2}\r\n{\"index\":{\"_id\":\"8\", \"parent\":\"6\", \"routing\":\"1\"}}\r\n{\"color\": \"N/A\", \"hasTouchBar\":\"N/A\", \"brand\":\"N/A\",\"age\":0}\r\n{\"index\":{\"_id\":\"9\", \"parent\":\"8\", \"routing\":\"1\"}}\r\n{\"color\": \"gun metal\", \"hasTouchBar\":\"Y\", \"brand\":\"Apple\",\"age\":1}\r\n{\"index\":{\"_id\":\"10\", \"parent\":\"9\", \"routing\":\"1\"}}\r\n{\"color\": \"silver\", \"hasTouchBar\":\"N\", \"brand\":\"Apple\",\"age\":2}\r\n\r\nGET pipelinetest/_search\r\n{\r\n   \"size\": 0,\r\n   \"aggs\": {\r\n      \"by-team\": {\r\n         \"terms\": {\r\n            \"field\": \"teamName\"\r\n         },\r\n         \"aggs\": {\r\n            \"developers\": {\r\n               \"children\": {\r\n                  \"type\": \"developer\"\r\n               },\r\n               \"aggs\": {\r\n                  \"sum_height\": {\r\n                     \"sum\": {\r\n                        \"field\": \"height\"\r\n                     }\r\n                  },\r\n                  \"sum_bucket_filter\": {\r\n                     \"bucket_selector\": {\r\n                        \"buckets_path\": {\r\n                           \"sumHeight\": \"sum_height\"\r\n                        },\r\n                        \"script\": \"params.sumHeight >= 800\"\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n**Result**\r\n```\r\n{\r\n   \"error\": {\r\n      \"root_cause\": [],\r\n      \"type\": \"reduce_search_phase_exception\",\r\n      \"reason\": \"[reduce] \",\r\n      \"phase\": \"fetch\",\r\n      \"grouped\": true,\r\n      \"failed_shards\": [],\r\n      \"caused_by\": {\r\n         \"type\": \"class_cast_exception\",\r\n         \"reason\": \"org.elasticsearch.search.aggregations.bucket.children.InternalChildren cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\"\r\n      }\r\n   },\r\n   \"status\": 503\r\n}\r\n\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\nError on nested structure:\r\n```\r\n[2017-03-24T08:42:57,118][DEBUG][o.e.a.s.TransportSearchAction] [OqJZzsc] failed to reduce search\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: [reduce]\r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.onFailure(SearchQueryThenFetchAsyncAction.java:151) [elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:581) [elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.2.2.jar:5.2.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\nCaused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.nested.InternalNested cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n\tat org.elasticsearch.search.aggregations.pipeline.bucketselector.BucketSelectorPipelineAggregator.reduce(BucketSelectorPipelineAggregator.java:85) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:136) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.merge(SearchPhaseController.java:489) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.doRun(SearchQueryThenFetchAsyncAction.java:140) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\t... 3 more\r\n```\r\n\r\nError on parent/child structure:\r\n```\r\n[2017-03-24T08:43:54,134][DEBUG][o.e.a.s.TransportSearchAction] [OqJZzsc] failed to reduce search\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: [reduce]\r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.onFailure(SearchQueryThenFetchAsyncAction.java:151) [elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:581) [elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.2.2.jar:5.2.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\nCaused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.children.InternalChildren cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n\tat org.elasticsearch.search.aggregations.pipeline.bucketselector.BucketSelectorPipelineAggregator.reduce(BucketSelectorPipelineAggregator.java:85) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:136) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms$Bucket.reduce(InternalTerms.java:135) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(InternalTerms.java:234) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:134) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.merge(SearchPhaseController.java:489) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.doRun(SearchQueryThenFetchAsyncAction.java:140) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.2.2.jar:5.2.2]\r\n\t... 3 more\r\n```\r\n\r\n\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}