{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1263","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1263/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1263/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1263/events","html_url":"https://github.com/elastic/elasticsearch/issues/1263","id":1439254,"node_id":"MDU6SXNzdWUxNDM5MjU0","number":1263,"title":"NPE in nested queries with range clauses","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2011-08-19T07:58:51Z","updated_at":"2011-12-14T13:05:26Z","closed_at":"2011-08-25T10:02:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hiya\n\nUsing range clauses in nested queries throws an NPE, but the same query as a term query doesn't:\n\n```\n# [Fri Aug 19 09:55:23 2011] Protocol: http, Server: 127.0.0.2:9200\ncurl -XPUT 'http://127.0.0.1:9200/foo/?pretty=1'  -d '\n{\n   \"mappings\" : {\n      \"location\" : {\n         \"properties\" : {\n            \"hours\" : {\n               \"include_in_root\" : 1,\n               \"type\" : \"nested\",\n               \"properties\" : {\n                  \"open\" : {\n                     \"type\" : \"integer\"\n                  },\n                  \"close\" : {\n                     \"type\" : \"integer\"\n                  },\n                  \"day\" : {\n                     \"index\" : \"not_analyzed\",\n                     \"type\" : \"string\"\n                  }\n               }\n            },\n            \"name\" : {\n               \"type\" : \"string\"\n            }\n         }\n      }\n   }\n}\n'\n\n# [Fri Aug 19 09:55:23 2011] Response:\n# {\n#    \"ok\" : true,\n#    \"acknowledged\" : true\n# }\n\n# [Fri Aug 19 09:55:27 2011] Protocol: http, Server: 127.0.0.2:9200\ncurl -XPOST 'http://127.0.0.1:9200/foo/location?pretty=1'  -d '\n{\n   \"hours\" : [\n      {\n         \"open\" : 9,\n         \"close\" : 12,\n         \"day\" : \"monday\"\n      },\n      {\n         \"open\" : 13,\n         \"close\" : 17,\n         \"day\" : \"monday\"\n      }\n   ],\n   \"name\" : \"Test\"\n}\n'\n\n# [Fri Aug 19 09:55:27 2011] Response:\n# {\n#    \"ok\" : true,\n#    \"_index\" : \"foo\",\n#    \"_id\" : \"GjuRCXsVR3qZwNciqA1yuA\",\n#    \"_type\" : \"location\",\n#    \"_version\" : 1\n# }\n\n# [Fri Aug 19 09:55:29 2011] Protocol: http, Server: 127.0.0.2:9200\ncurl -XGET 'http://127.0.0.1:9200/foo/location/_search?pretty=1'  -d '\n{\n   \"query\" : {\n      \"nested\" : {\n         \"query\" : {\n            \"bool\" : {\n               \"must\" : [\n                  {\n                     \"text\" : {\n                        \"hours.day\" : \"monday\"\n                     }\n                  },\n                  {\n                     \"range\" : {\n                        \"hours.close\" : {\n                           \"gte\" : 10\n                        }\n                     }\n                  },\n                  {\n                     \"range\" : {\n                        \"hours.open\" : {\n                           \"lte\" : 10\n                        }\n                     }\n                  }\n               ]\n            }\n         },\n         \"path\" : \"hours\"\n      }\n   }\n}\n'\n\n# [Fri Aug 19 09:55:29 2011] Response:\n# {\n#    \"hits\" : {\n#       \"hits\" : [],\n#       \"max_score\" : null,\n#       \"total\" : 0\n#    },\n#    \"timed_out\" : false,\n#    \"_shards\" : {\n#       \"failures\" : [\n#          {\n#             \"index\" : \"foo\",\n#             \"status\" : 500,\n#             \"reason\" : \"QueryPhaseExecutionException[[foo][1]: qu\n# >             ery[BlockJoinQuery (filtered(+hours.day:monday +hou\n# >             rs.close:[10 TO *] +hours.open:[* TO 10])->FilterCa\n# >             cheFilterWrapper(_type:__hours))],from[0],size[10]:\n# >              Query Failed [Failed to execute main query]]; nest\n# >              ed: \",\n#             \"shard\" : 1\n#          }\n#       ],\n#       \"failed\" : 1,\n#       \"successful\" : 4,\n#       \"total\" : 5\n#    },\n#    \"took\" : 4\n# }\n```\n\nAnd in the logs:\n\n```\n[09:57:37,516][DEBUG][action.search.type       ] [Andrew Gervais] [foo][4], node[Dk6W4_9GQMisu1sTfo3Zyg], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@7e383efa]\norg.elasticsearch.search.query.QueryPhaseExecutionException: [foo][4]: query[BlockJoinQuery (filtered(+hours.day:monday +hours.close:[10 TO *] +hours.open:[* TO 10])->FilterCacheFilterWrapper(_type:__hours))],from[0],size[10]: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:221)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:234)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:134)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:80)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:204)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:191)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:177)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n    at java.lang.Thread.run(Thread.java:636)\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.index.query.NestedQueryParser$LateBindingParentFilter.getDocIdSet(NestedQueryParser.java:171)\n    at org.elasticsearch.index.search.nested.BlockJoinQuery$BlockJoinWeight.scorer(BlockJoinQuery.java:171)\n    at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:116)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:524)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:198)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:391)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:298)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:286)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:217)\n    ... 9 more\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}