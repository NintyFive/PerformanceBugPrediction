{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24647","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24647/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24647/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24647/events","html_url":"https://github.com/elastic/elasticsearch/issues/24647","id":228301650,"node_id":"MDU6SXNzdWUyMjgzMDE2NTA=","number":24647,"title":"\"score_mode\": \"max\" is not working for nested Query and function score","user":{"login":"MaKuehn","id":22023515,"node_id":"MDQ6VXNlcjIyMDIzNTE1","avatar_url":"https://avatars1.githubusercontent.com/u/22023515?v=4","gravatar_id":"","url":"https://api.github.com/users/MaKuehn","html_url":"https://github.com/MaKuehn","followers_url":"https://api.github.com/users/MaKuehn/followers","following_url":"https://api.github.com/users/MaKuehn/following{/other_user}","gists_url":"https://api.github.com/users/MaKuehn/gists{/gist_id}","starred_url":"https://api.github.com/users/MaKuehn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MaKuehn/subscriptions","organizations_url":"https://api.github.com/users/MaKuehn/orgs","repos_url":"https://api.github.com/users/MaKuehn/repos","events_url":"https://api.github.com/users/MaKuehn/events{/privacy}","received_events_url":"https://api.github.com/users/MaKuehn/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2017-05-12T14:02:46Z","updated_at":"2018-02-14T13:26:37Z","closed_at":"2017-06-15T09:29:28Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.4.0\r\n\r\n**Plugins installed**: [X-Pack]\r\n\r\n**JVM version** (`java -version`):java version \"1.8.0_102\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_102-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): macOS Sierra Version 10.12.4 (16E195)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nThe minimum score of the nested document is applied to the parent, although \"score_mode\": \"max\" is specified.\r\n\r\n**Steps to reproduce**:\r\n\r\nCreate Index\r\n```\r\nPUT tests\r\n{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"nestedDoc\": {\r\n          \"type\": \"nested\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIndex a test document\r\n```\r\nPUT tests/test/1\r\n{\r\n  \"topVal\" : 1,\r\n  \"nestedDoc\": [\r\n    {\r\n      \"nestedVal\": 2\r\n    },\r\n    {\r\n      \"nestedVal\": 3\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nVerify the existence of the test document\r\n```\r\nGET tests/_search\r\n```\r\n\r\nDo a nested query with function scoring on the nestedVal. The expected score of the parent document should be 3, the maximum. However, 2 is returned. \"avg\" as score_mode works.\r\n```\r\nGET tests/test/_search\r\n{\r\n  \"explain\": true, \r\n  \"query\": {\r\n    \"nested\" : {\r\n      \"query\" : {\r\n        \"function_score\" : {\r\n          \"query\" : {\r\n            \"match_all\": {}\r\n          },\r\n          \"functions\" : [\r\n            {\r\n              \"filter\" : {\r\n                \"match_all\" : {\r\n                  \"boost\" : 1.0\r\n                }\r\n              },\r\n              \"field_value_factor\" : {\r\n                \"field\" : \"nestedDoc.nestedVal\",\r\n                \"factor\" : 1.0,\r\n                \"missing\" : 0.0,\r\n                \"modifier\" : \"none\"\r\n              }\r\n            }\r\n          ],\r\n          \"score_mode\" : \"sum\",\r\n          \"boost_mode\" : \"replace\"\r\n        }\r\n      },\r\n      \"path\" : \"nestedDoc\",\r\n      \"score_mode\" : \"max\",\r\n      \"inner_hits\" : {\r\n        \"name\" : \"nestedDoc\",\r\n        \"ignore_unmapped\" : true,\r\n        \"from\" : 0,\r\n        \"size\" : 30,\r\n        \"version\" : false,\r\n        \"explain\" : true,\r\n        \"track_scores\" : true,\r\n        \"_source\" : false\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}