{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32834","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32834/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32834/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32834/events","html_url":"https://github.com/elastic/elasticsearch/issues/32834","id":350324380,"node_id":"MDU6SXNzdWUzNTAzMjQzODA=","number":32834,"title":"MultiIndex search with filters aggregation and range filter may return IndexOutOfBoundsException exception","user":{"login":"voidlps","id":3744683,"node_id":"MDQ6VXNlcjM3NDQ2ODM=","avatar_url":"https://avatars2.githubusercontent.com/u/3744683?v=4","gravatar_id":"","url":"https://api.github.com/users/voidlps","html_url":"https://github.com/voidlps","followers_url":"https://api.github.com/users/voidlps/followers","following_url":"https://api.github.com/users/voidlps/following{/other_user}","gists_url":"https://api.github.com/users/voidlps/gists{/gist_id}","starred_url":"https://api.github.com/users/voidlps/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/voidlps/subscriptions","organizations_url":"https://api.github.com/users/voidlps/orgs","repos_url":"https://api.github.com/users/voidlps/repos","events_url":"https://api.github.com/users/voidlps/events{/privacy}","received_events_url":"https://api.github.com/users/voidlps/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"assignees":[{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2018-08-14T08:13:39Z","updated_at":"2018-08-17T16:54:40Z","closed_at":"2018-08-17T16:54:40Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.4\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): docker image\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nIf range query is using non-existing field, other_bucket will never be generated in result.\r\nAnd the equivalent query_string seems working without problem.\r\nEven worse, when using multi-index search, it may lead to Array IndexOutOfBoundsException exception\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\nPUT test1/_doc/1\r\n{\r\n  \"n\": 15\r\n}\r\n\r\nPUT test2/_doc/1\r\n{\r\n  \"m\": 15\r\n}\r\n\r\nPOST test1/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test_other_bucket\": {\r\n      \"filters\": {\r\n        \"other_bucket\": true,\r\n        \"filters\": {\r\n          \"all\": {\r\n            \"match_all\": {}\r\n          },\r\n          \"query_string\": {\r\n            \"query_string\": {\r\n              \"query\": \"m:[10 TO 20]\"\r\n            }\r\n          },\r\n          \"use_range\": {\r\n            \"range\": {\r\n              \"m\": {\r\n                \"gte\": 10,\r\n                \"lte\": 20\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test1/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test_other_bucket\": {\r\n      \"filters\": {\r\n        \"other_bucket\": true,\r\n        \"filters\": {\r\n          \"all\": {\r\n            \"match_all\": {}\r\n          },\r\n          \"query_string\": {\r\n            \"query_string\": {\r\n              \"query\": \"m:[10 TO 20]\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test2/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test_other_bucket\": {\r\n      \"filters\": {\r\n        \"other_bucket\": true,\r\n        \"filters\": {\r\n          \"all\": {\r\n            \"match_all\": {}\r\n          },\r\n          \"query_string\": {\r\n            \"query_string\": {\r\n              \"query\": \"m:[10 TO 20]\"\r\n            }\r\n          },\r\n          \"use_range\": {\r\n            \"range\": {\r\n              \"m\": {\r\n                \"gte\": 10,\r\n                \"lte\": 20\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST test*/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"test_other_bucket\": {\r\n      \"filters\": {\r\n        \"other_bucket\": true,\r\n        \"filters\": {\r\n          \"all\": {\r\n            \"match_all\": {}\r\n          },\r\n          \"query_string\": {\r\n            \"query_string\": {\r\n              \"query\": \"m:[10 TO 20]\"\r\n            }\r\n          },\r\n          \"use_range\": {\r\n            \"range\": {\r\n              \"m\": {\r\n                \"gte\": 10,\r\n                \"lte\": 20\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2018-08-14T07:59:14,013][WARN ][r.suppressed             ] path: /test*/_search, params: {index=test*}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: \r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:274) [elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:657) [elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\nCaused by: java.lang.IndexOutOfBoundsException: Index: 3, Size: 3\r\n\tat java.util.ArrayList.rangeCheck(ArrayList.java:657) ~[?:1.8.0_161]\r\n\tat java.util.ArrayList.get(ArrayList.java:433) ~[?:1.8.0_161]\r\n\tat org.elasticsearch.search.aggregations.bucket.filter.InternalFilters.doReduce(InternalFilters.java:221) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:136) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:77) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:527) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:504) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:421) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:740) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n\t... 5 more\r\n```","closed_by":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"performed_via_github_app":null}