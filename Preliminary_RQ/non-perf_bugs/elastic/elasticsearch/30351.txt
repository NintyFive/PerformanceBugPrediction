{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30351","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30351/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30351/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30351/events","html_url":"https://github.com/elastic/elasticsearch/issues/30351","id":319743263,"node_id":"MDU6SXNzdWUzMTk3NDMyNjM=","number":30351,"title":"update_mapping timeouts cause replica inconsistencies and prevents synced _flush and force_merge commands","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-05-02T23:16:32Z","updated_at":"2018-05-03T07:11:12Z","closed_at":"2018-05-03T07:11:12Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\r\n\r\nDuring bulk indexing to multiple indices and encountering multiple update_mapping timeouts (30s), some indices have shown inconsistencies between primaries and replicas.\r\nThe disk size of indices with these inconsistencies was considerably larger than as expected (as compared to similar data on indices from previous dates), and synced_flush or force_merge commands could not be completed.\r\n\r\n**Elasticsearch version**:\r\n6.2.3\r\n\r\n**Plugins installed**:\r\ningest-attachment\r\ningest-geoip\r\nmapper-murmur3\r\nmapper-size\r\nrepository-azure\r\nrepository-gcs\r\nrepository-s3\r\n\r\n**JVM version**:\r\nopenjdk version \"1.8.0_151\"\r\nOpenJDK Runtime Environment (build 1.8.0_151-8u151-b12-0ubuntu0.16.04.2-b12)\r\nOpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n\r\n**OS version**:\r\nLinux 4.13.0-1011-azure #14-Ubuntu SMP 2018 x86_64 GNU/Linux\r\n\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nDuring indexing to multiple live indices and performing maintenance on our cluster (creating new indices and deleting others), some of the indexing bulks encountered timeouts for some of their update_mappings (30s). Following these timeouts, we began observing inconsistencies between primaries and replicas. The disk size of indices with these inconsistencies was considerably larger than as expected (as compared to similar data on indices from previous dates), and synced_flush or force_merge commands could not be completed - even after stopping indexing to these indices completely.\r\n\r\nHere is an example of a _flush/synced command on one of these indices:\r\n```\r\n{\r\n    \"_shards\": {\r\n        \"total\": 76,\r\n        \"successful\": 72,\r\n        \"failed\": 4\r\n    },\r\n    \"fae12b2c5f73_newlogs_20180502-01\": {\r\n        \"total\": 76,\r\n        \"successful\": 72,\r\n        \"failed\": 4,\r\n        \"failures\": [\r\n            {\r\n                \"shard\": 18,\r\n                \"reason\": \"out of sync replica; num docs on replica [4212470]; num docs on primary [4212473]\",\r\n                \"routing\": {\r\n                    \"state\": \"STARTED\",\r\n                    \"primary\": false,\r\n                    \"node\": \"QeSPYyW7TfOOgR1SdVR42g\",\r\n                    \"relocating_node\": null,\r\n                    \"shard\": 18,\r\n                    \"index\": \"fae12b2c5f73_newlogs_20180502-01\",\r\n                    \"allocation_id\": {\r\n                        \"id\": \"PArVLA9uSyqZ4ZxKHu_yvQ\"\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"shard\": 29,\r\n                \"reason\": \"out of sync replica; num docs on replica [4211285]; num docs on primary [4211289]\",\r\n                \"routing\": {\r\n                    \"state\": \"STARTED\",\r\n                    \"primary\": false,\r\n                    \"node\": \"M_QP7sSsQQ6jhGnAblOESg\",\r\n                    \"relocating_node\": null,\r\n                    \"shard\": 29,\r\n                    \"index\": \"fae12b2c5f73_newlogs_20180502-01\",\r\n                    \"allocation_id\": {\r\n                        \"id\": \"M_ws8hLURsmKzEtNq26SxQ\"\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"shard\": 0,\r\n                \"reason\": \"out of sync replica; num docs on replica [4210878]; num docs on primary [4210883]\",\r\n                \"routing\": {\r\n                    \"state\": \"STARTED\",\r\n                    \"primary\": false,\r\n                    \"node\": \"g8cGEEK0SAGYC_I-FfZprg\",\r\n                    \"relocating_node\": null,\r\n                    \"shard\": 0,\r\n                    \"index\": \"fae12b2c5f73_newlogs_20180502-01\",\r\n                    \"allocation_id\": {\r\n                        \"id\": \"pWX9k1pZTuuWBKHOpNCJHw\"\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"shard\": 25,\r\n                \"reason\": \"out of sync replica; num docs on replica [4211536]; num docs on primary [4211537]\",\r\n                \"routing\": {\r\n                    \"state\": \"STARTED\",\r\n                    \"primary\": false,\r\n                    \"node\": \"FmnjvN8YROKJ6PO8E3QEjA\",\r\n                    \"relocating_node\": null,\r\n                    \"shard\": 25,\r\n                    \"index\": \"fae12b2c5f73_newlogs_20180502-01\",\r\n                    \"allocation_id\": {\r\n                        \"id\": \"5wMI1o01SH2kJW9baYJymw\"\r\n                    }\r\n                }\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nReducing the replica of these indices to 0 and then increasing it back to 1 seems to solve the problem.\r\nHowever, in some of the indices, a weird state was kept for one of its shards (again, when calling _flush/synced):\r\n```\r\n{\r\n    \"_shards\": {\r\n        \"total\": 38,\r\n        \"successful\": 37,\r\n        \"failed\": 1\r\n    },\r\n    \"eebfc6dc8f07_newlogs_20180502-01\": {\r\n        \"total\": 38,\r\n        \"successful\": 37,\r\n        \"failed\": 1,\r\n        \"failures\": [\r\n            {\r\n                \"shard\": 2,\r\n                \"reason\": \"[1] ongoing operations on primary\"\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nFor these indices, the problem was eventually solved by closing the index and re-opening it. Upon opening, some of the primary shards have been declared unassigned by elasticsearch and had to be verified and initialized.\r\n\r\nOverall, this is a very long, time-consuming and resource-consuming operation - recognizing indices are larger than expected, identifying a primary-replica inconsistency, reducing and increasing the replicas, waiting for the replicas to be fully initialized, closing and re-opening the index, and waiting for elasticsearch to fully initialize the unassigned primary shards.\r\n\r\nI believe the initial inconsistency state could be related to #30244, and maybe these discussions as well:\r\nhttps://discuss.elastic.co/t/flush-threads-stuck-es-6-1-2/117707\r\nhttps://discuss.elastic.co/t/unable-to-complete-synced-flush-on-idle-index/118449\r\n\r\nI'd be happy to provide additional data and information as needed.\r\n\r\nThanks.\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}