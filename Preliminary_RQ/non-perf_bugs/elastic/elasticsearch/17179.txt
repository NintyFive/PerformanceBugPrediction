{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17179","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17179/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17179/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17179/events","html_url":"https://github.com/elastic/elasticsearch/issues/17179","id":141768944,"node_id":"MDU6SXNzdWUxNDE3Njg5NDQ=","number":17179,"title":"Cloud-AWS: S3 Repository Across-Account fails verification.","user":{"login":"JamesBromberger","id":1736320,"node_id":"MDQ6VXNlcjE3MzYzMjA=","avatar_url":"https://avatars2.githubusercontent.com/u/1736320?v=4","gravatar_id":"","url":"https://api.github.com/users/JamesBromberger","html_url":"https://github.com/JamesBromberger","followers_url":"https://api.github.com/users/JamesBromberger/followers","following_url":"https://api.github.com/users/JamesBromberger/following{/other_user}","gists_url":"https://api.github.com/users/JamesBromberger/gists{/gist_id}","starred_url":"https://api.github.com/users/JamesBromberger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JamesBromberger/subscriptions","organizations_url":"https://api.github.com/users/JamesBromberger/orgs","repos_url":"https://api.github.com/users/JamesBromberger/repos","events_url":"https://api.github.com/users/JamesBromberger/events{/privacy}","received_events_url":"https://api.github.com/users/JamesBromberger/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2016-03-18T03:55:41Z","updated_at":"2018-02-14T13:57:04Z","closed_at":"2016-12-23T11:16:58Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.2.0\n\n**JVM version**: 1.8.0\n\n**OS version**: Amazon Linux 2015.09.02\n\n**Description of the problem including expected versus actual behavior**: Using Cloud-AWS Plugin to define a repository that is across AWS accounts for escrow backps/snapshots\n\n**Steps to reproduce**:\n1. Create two AWS accounts, A for our primary workload (ElasticSearch), and B for our escrow copy (think: security team)\n2. Create a bucket in B (security-bucket), with an S3 Bucket Policy that permits account A to write to a prefix in this bucket, with a condition that the submitter (in A) set the ACL \"bucket-owner-full-control'. Also permit account A to list and get objects from this prefix, but not DELETE. (NB: does permit overwrite, but S3Versioning can help here - another topic)\n3. In account A, create an IAM Role for EC2 instance that permits access to B's security-bucket, as well as the normal EC2 discovery requirements.\n4. Launch an EC2 instance running ElasticSearch in this Role.\n5. Configure the ElasticSearch instance to have a repository of B's security-bucket\n\n**Provide logs (if relevant)**:\n`{\"error\":{\"root_cause\":[{\"type\":\"repository_verification_exception\",\"reason\":\"[s3backupsec] path [XXX][Dev][Elasticsearch] is not accessible on master node\"}],\"type\":\"repository_verification_exception\",\"reason\":\"[s3backupsec] path [XXX][Dev][Elasticsearch] is not accessible on master node\",\"caused_by\":{\"type\":\"i_o_exception\",\"reason\":\"Unable to upload object XXX/Dev/Elasticsearch/tests-DJJ3cNL_ScqiNn6P-LQOAw/master.dat-temp\",\"caused_by\":{\"type\":\"amazon_s3_exception\",\"reason\":\"Access Denied (Service: Amazon S3; Status Code: 403; Error Code: AccessDenied; Request ID: CBD309137D130093)\"}}},\"status\":500}`\n\n**Describe the feature**:\nI am using ES 2.2.0 , and setting up a cross account trust where the receiving bucket (in another AWS account0 requires \"bucket-owner-full-control\", Using AWS CLi confirms I can put objects with the canned ACl into the prefix I have reserved for this; I can list the objects back, and I can read the content back.\n\nHowever, when trying to set up a backup location in elasticsearch, it fails the verification. My config is:\n`{ \"type\": \"s3\", \"settings\": { \"bucket\": \"XXX-logs\", \"region\": \"ap-southeast-2\", \"server_side_encryption\": \"True\", \"base_path\": \"XXX/Dev/Elasticsearch/\", \"buffer_size\": \"100mb\", \"canned_acl\": \"bucket-owner-full-control\" } }`\n\nHowever when submitting this I get:\n`{\"error\":{\"root_cause\":[{\"type\":\"repository_verification_exception\",\"reason\":\"[s3backupsec] path [XXX][Dev][Elasticsearch] is not accessible on master node\"}],\"type\":\"repository_verification_exception\",\"reason\":\"[s3backupsec] path [XXX][Dev][Elasticsearch] is not accessible on master node\",\"caused_by\":{\"type\":\"i_o_exception\",\"reason\":\"Unable to upload object XXX/Dev/Elasticsearch/tests-DJJ3cNL_ScqiNn6P-LQOAw/master.dat-temp\",\"caused_by\":{\"type\":\"amazon_s3_exception\",\"reason\":\"Access Denied (Service: Amazon S3; Status Code: 403; Error Code: AccessDenied; Request ID: CBD309137D130093)\"}}},\"status\":500}`\n\nWhich from the S3 logs on the target S3 bucket I see a 403 AccessDenied. The only condition that is required by S3 in my case is the bucket-owner-full-control ACL. It appears that the check in index/snapshots/blobstore/BlobStoreIndexShardRepository.java calling org.elasticsearch.repositories.blobstore.BlobStoreRepository.testBlobPrefix() may not have the canned ACL being added, and thus fails to get set up.\n\nThis maybe somewhere around startVerification() in repositories/blobstore/BlobStoreRepository.java.\n\nIn my use case, the target bucket is to be write once (no deletes; escrow copy of the backup, so the corresponding \"ensure moves are supported\" is also likely to fail....\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}