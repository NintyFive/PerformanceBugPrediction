{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1582","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1582/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1582/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1582/events","html_url":"https://github.com/elastic/elasticsearch/issues/1582","id":2701835,"node_id":"MDU6SXNzdWUyNzAxODM1","number":1582,"title":"S3 blob storage gateway: deleting an index named x destroys data for any index with name beginning with x","user":{"login":"alambert","id":69652,"node_id":"MDQ6VXNlcjY5NjUy","avatar_url":"https://avatars2.githubusercontent.com/u/69652?v=4","gravatar_id":"","url":"https://api.github.com/users/alambert","html_url":"https://github.com/alambert","followers_url":"https://api.github.com/users/alambert/followers","following_url":"https://api.github.com/users/alambert/following{/other_user}","gists_url":"https://api.github.com/users/alambert/gists{/gist_id}","starred_url":"https://api.github.com/users/alambert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alambert/subscriptions","organizations_url":"https://api.github.com/users/alambert/orgs","repos_url":"https://api.github.com/users/alambert/repos","events_url":"https://api.github.com/users/alambert/events{/privacy}","received_events_url":"https://api.github.com/users/alambert/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":204518,"node_id":"MDU6TGFiZWwyMDQ1MTg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.18.7","name":"v0.18.7","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2012-01-02T15:08:08Z","updated_at":"2012-01-02T21:08:03Z","closed_at":"2012-01-02T21:08:03Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Thank you for your help in issue #1564. I am using ElasticSearch v0.18.5 with the S3 shared storage gateway and have been experiencing index data loss: after a restart, some indexes will appear with correct mappings but zero documents.\n\nIt looks like this happens because deleting an index named \"x\" causes ES to remove all keys with prefix \n\"clustername/indicies/x\" which includes data for any index whose name begins with \"x\". It should only remove keys with prefix \"clustername/indicies/x/\".\n\nTo reproduce:\n\n<pre>\n$ curl -XPUT 'http://localhost:9200/x/'\n{\"ok\":true,\"acknowledged\":true}\n$ curl -XPUT 'http://localhost:9200/x2/'\n{\"ok\":true,\"acknowledged\":true}\n$ curl -XPOST 'http://localhost:9200/x/_gateway/snapshot'\n{\"ok\":true,\"_shards\":{\"total\":5,\"successful\":4,\"failed\":0}}\n$ curl -XPOST 'http://localhost:9200/x2/_gateway/snapshot'\n{\"ok\":true,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0}}\n$ curl -XDELETE 'http://localhost:9200/x/'\n{\"ok\":true,\"acknowledged\":true}\n</pre>\n\n\nAfter restarting and restoring from the gateway, x2 should have zero documents. After the DELETE request is sent, ES deletes the commit data for index x2:\n\n<pre>\n[2012-01-02 14:53:00,664][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n...\n[2012-01-02 14:53:00,954][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F4%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n</pre>\n\n\nThe full logs for the DELETE request are below:\n\n<pre>\n[2012-01-02 14:53:00,405][DEBUG][cluster.service          ] [aws-e1b-8.xxxxxxxx.net] processing [delete-index [x]]: execute\n[2012-01-02 14:53:00,405][INFO ][cluster.metadata         ] [aws-e1b-8.xxxxxxxx.net] [x] deleting index\n[2012-01-02 14:53:00,409][DEBUG][cluster.service          ] [aws-e1b-8.xxxxxxxx.net] cluster state updated, version [220], source [delete-index [x]]\n[2012-01-02 14:53:00,409][DEBUG][river.cluster            ] [aws-e1b-8.xxxxxxxx.net] processing [reroute_rivers_node_changed]: execute\n[2012-01-02 14:53:00,409][DEBUG][river.cluster            ] [aws-e1b-8.xxxxxxxx.net] processing [reroute_rivers_node_changed]: no change in cluster_state\n[2012-01-02 14:53:00,410][DEBUG][indices.cluster          ] [aws-e1b-8.xxxxxxxx.net] [x] deleting index\n[2012-01-02 14:53:00,410][DEBUG][indices                  ] [aws-e1b-8.xxxxxxxx.net] deleting Index [x]\n[2012-01-02 14:53:00,410][DEBUG][index.service            ] [aws-e1b-8.xxxxxxxx.net] [x] deleting shard_id [0]\n[2012-01-02 14:53:00,410][DEBUG][index.service            ] [aws-e1b-8.xxxxxxxx.net] [x] deleting shard_id [1]\n[2012-01-02 14:53:00,411][DEBUG][index.service            ] [aws-e1b-8.xxxxxxxx.net] [x] deleting shard_id [2]\n[2012-01-02 14:53:00,411][DEBUG][index.shard.service      ] [aws-e1b-8.xxxxxxxx.net] [x][0] state: [STARTED]->[CLOSED], reason [deleting index]\n[2012-01-02 14:53:00,411][DEBUG][index.shard.service      ] [aws-e1b-8.xxxxxxxx.net] [x][1] state: [STARTED]->[CLOSED], reason [deleting index]\n[2012-01-02 14:53:00,411][DEBUG][index.shard.service      ] [aws-e1b-8.xxxxxxxx.net] [x][2] state: [STARTED]->[CLOSED], reason [deleting index]\n[2012-01-02 14:53:00,411][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x/1, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,412][DEBUG][index.service            ] [aws-e1b-8.xxxxxxxx.net] [x] deleting shard_id [3]\n[2012-01-02 14:53:00,412][DEBUG][index.service            ] [aws-e1b-8.xxxxxxxx.net] [x] deleting shard_id [4]\n[2012-01-02 14:53:00,412][DEBUG][index.shard.service      ] [aws-e1b-8.xxxxxxxx.net] [x][3] state: [STARTED]->[CLOSED], reason [deleting index]\n[2012-01-02 14:53:00,413][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x/0, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,413][DEBUG][index.shard.service      ] [aws-e1b-8.xxxxxxxx.net] [x][4] state: [STARTED]->[CLOSED], reason [deleting index]\n[2012-01-02 14:53:00,414][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x/2, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,415][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x/3, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,415][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x/4, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,432][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: 1CF9DDBE56ACAE52\n[2012-01-02 14:53:00,432][DEBUG][indices.memory           ] [aws-e1b-8.xxxxxxxx.net] recalculating shard indexing buffer (reason=removed_shard[x][4]), total is [1gb] with [5] active shards, each shard set to [225.1mb]\n[2012-01-02 14:53:00,437][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: 5439E48D1C6C66E3\n[2012-01-02 14:53:00,437][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F0%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,456][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: D5F6AEE4C87331BA\n[2012-01-02 14:53:00,456][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F0%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,465][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: 4C3580B5A6536906\n[2012-01-02 14:53:00,465][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F3%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,480][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: E4C5A1CD3FCC0A51\n[2012-01-02 14:53:00,480][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F2%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,483][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: BFE115230486752E\n[2012-01-02 14:53:00,483][DEBUG][indices.memory           ] [aws-e1b-8.xxxxxxxx.net] recalculating shard indexing buffer (reason=removed_shard[x][0]), total is [1gb] with [5] active shards, each shard set to [225.1mb]\n[2012-01-02 14:53:00,494][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: 9E9CE9A22BFF2209\n[2012-01-02 14:53:00,494][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F3%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,500][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: ACAC04C51612FE27\n[2012-01-02 14:53:00,500][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F2%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,517][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: EFBA0DA2BAB7D65E\n[2012-01-02 14:53:00,517][DEBUG][indices.memory           ] [aws-e1b-8.xxxxxxxx.net] recalculating shard indexing buffer (reason=removed_shard[x][2]), total is [1gb] with [5] active shards, each shard set to [225.1mb]\n[2012-01-02 14:53:00,518][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: DA077754B6C41906\n[2012-01-02 14:53:00,518][DEBUG][indices.memory           ] [aws-e1b-8.xxxxxxxx.net] recalculating shard indexing buffer (reason=removed_shard[x][3]), total is [1gb] with [5] active shards, each shard set to [225.1mb]\n[2012-01-02 14:53:00,626][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: C97B12628A245B67\n[2012-01-02 14:53:00,626][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F1%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,643][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: C444D05B9C2526EC\n[2012-01-02 14:53:00,643][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx%2F1%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,662][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: A2EC73D53CEF11B5\n[2012-01-02 14:53:00,663][DEBUG][indices.memory           ] [aws-e1b-8.xxxxxxxx.net] recalculating shard indexing buffer (reason=removed_shard[x][1]), total is [1gb] with [5] active shards, each shard set to [225.1mb]\n[2012-01-02 14:53:00,664][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/indices/x, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,701][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: 126AAAFACB6B9E52\n[2012-01-02 14:53:00,701][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F0%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,719][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: AE11CA882DC3B5F2\n[2012-01-02 14:53:00,720][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F0%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,747][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: 611EB0181D55BE54\n[2012-01-02 14:53:00,747][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F1%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,769][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: 756ACDD05674B387\n[2012-01-02 14:53:00,769][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F1%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,789][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: F840A4C6AC34606D\n[2012-01-02 14:53:00,789][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F2%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,811][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: D7CDEDD29EBC7D61\n[2012-01-02 14:53:00,812][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F2%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,833][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: 9617334FDC66FB23\n[2012-01-02 14:53:00,833][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F3%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,904][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: E7B2AC2C2DFE2ED6\n[2012-01-02 14:53:00,904][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F3%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,926][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: A47D9D007502212A\n[2012-01-02 14:53:00,926][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F4%2F__0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,954][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: 38EC545C47C99D65\n[2012-01-02 14:53:00,954][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Findices%2Fx2%2F4%2Fcommit-0 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:00,974][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: A709CE7D578AAF0B\n[2012-01-02 14:53:00,981][DEBUG][gateway.s3               ] [aws-e1b-8.xxxxxxxx.net] writing to gateway org.elasticsearch.gateway.shared.SharedStorageGateway$2@3d761403 ...\n[2012-01-02 14:53:00,984][DEBUG][cluster.service          ] [aws-e1b-8.xxxxxxxx.net] processing [delete-index [x]]: done applying updated cluster_state\n[2012-01-02 14:53:00,984][INFO ][com.amazonaws.request    ] Sending Request: PUT http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Fmetadata%2Fmetadata-2455 Headers: (Content-Length: 77420, Content-Type: application/octet-stream, ) \n[2012-01-02 14:53:01,057][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: BAD343B536EDE0F7\n[2012-01-02 14:53:01,057][INFO ][com.amazonaws.request    ] Sending Request: GET http://xxxxxxxx-app-dev-es.s3.amazonaws.com / Parameters: (prefix: es-amalgam-20111025/metadata/, ) Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:01,105][INFO ][com.amazonaws.request    ] Received successful response: 200, AWS Request ID: 34F9E73651ADB6CD\n[2012-01-02 14:53:01,105][INFO ][com.amazonaws.request    ] Sending Request: DELETE http://xxxxxxxx-app-dev-es.s3.amazonaws.com /es-amalgam-20111025%2Fmetadata%2Fmetadata-2454 Headers: (Content-Type: application/x-www-form-urlencoded; charset=utf-8, ) \n[2012-01-02 14:53:01,131][INFO ][com.amazonaws.request    ] Received successful response: 204, AWS Request ID: 75732598971E7A5F\n[2012-01-02 14:53:01,131][DEBUG][gateway.s3               ] [aws-e1b-8.xxxxxxxx.net] wrote to gateway org.elasticsearch.gateway.shared.SharedStorageGateway$2@3d761403, took 150ms\n</pre>\n\n\nI can provide additional logs if needed. Thank you!\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}