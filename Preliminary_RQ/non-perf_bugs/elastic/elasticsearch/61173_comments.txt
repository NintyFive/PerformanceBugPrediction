[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/675318538","html_url":"https://github.com/elastic/elasticsearch/issues/61173#issuecomment-675318538","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61173","id":675318538,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NTMxODUzOA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-08-18T07:50:05Z","updated_at":"2020-08-18T07:50:05Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security (:Security/Authentication)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/686064432","html_url":"https://github.com/elastic/elasticsearch/issues/61173#issuecomment-686064432","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61173","id":686064432,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjA2NDQzMg==","user":{"login":"djsiroky","id":11220250,"node_id":"MDQ6VXNlcjExMjIwMjUw","avatar_url":"https://avatars2.githubusercontent.com/u/11220250?v=4","gravatar_id":"","url":"https://api.github.com/users/djsiroky","html_url":"https://github.com/djsiroky","followers_url":"https://api.github.com/users/djsiroky/followers","following_url":"https://api.github.com/users/djsiroky/following{/other_user}","gists_url":"https://api.github.com/users/djsiroky/gists{/gist_id}","starred_url":"https://api.github.com/users/djsiroky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djsiroky/subscriptions","organizations_url":"https://api.github.com/users/djsiroky/orgs","repos_url":"https://api.github.com/users/djsiroky/repos","events_url":"https://api.github.com/users/djsiroky/events{/privacy}","received_events_url":"https://api.github.com/users/djsiroky/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T22:36:48Z","updated_at":"2020-09-02T22:36:48Z","author_association":"NONE","body":"To add to this issue, the string-encoded byte array included user's metadata for the JSON response to`GET /_security/_authenticate`  contains replacement characters (�) that would prevent someone from constructing the same SID from the bytes. \r\n\r\nI found this out from an attempt at a workaround where our search client would get the user's metadata, convert the `tokenGroups` string-encoded bytes to SID format using a similar method to the one linked in the code base, and pass that to a search template that would filter on the field containing SIDs in our index.\r\n\r\nSo I suppose this leaves a couple options (as far as I can tell) for the including the `tokenGroups` field in `user.metadata` in a useful manner:\r\n- Encoding the response in a way that SIDs could be reconstructed client-side\r\n- Returning the tokenGroups value in SID format\r\n\r\nDefinitely open to other suggestions, and we may end up just reindexing the field related to security access to another format like the distinguished name, although the ID of the group/user with access seems to ideal since it is less likely to change.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/686233828","html_url":"https://github.com/elastic/elasticsearch/issues/61173#issuecomment-686233828","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61173","id":686233828,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjIzMzgyOA==","user":{"login":"djsiroky","id":11220250,"node_id":"MDQ6VXNlcjExMjIwMjUw","avatar_url":"https://avatars2.githubusercontent.com/u/11220250?v=4","gravatar_id":"","url":"https://api.github.com/users/djsiroky","html_url":"https://github.com/djsiroky","followers_url":"https://api.github.com/users/djsiroky/followers","following_url":"https://api.github.com/users/djsiroky/following{/other_user}","gists_url":"https://api.github.com/users/djsiroky/gists{/gist_id}","starred_url":"https://api.github.com/users/djsiroky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djsiroky/subscriptions","organizations_url":"https://api.github.com/users/djsiroky/orgs","repos_url":"https://api.github.com/users/djsiroky/repos","events_url":"https://api.github.com/users/djsiroky/events{/privacy}","received_events_url":"https://api.github.com/users/djsiroky/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T03:47:08Z","updated_at":"2020-09-03T03:47:08Z","author_association":"NONE","body":"To provide a sample case, here's one of the strings returned in the JSON response to `GET /_security/_authenticate`:\r\n`\r\n \"\\u0001\\u0005\\u0000\\u0000\\u0000\\u0000\\u0000\\u0005\\u0015\\u0000\\u0000\\u0000��2?|�$\\r���(B\\u0019\\u0000\\u0000\"`\r\n\r\nFollowing the logic of `ActiveDirectorySIDUtil.java`:\r\n### Revision\r\nbyte[0] = `\\u0001` = `1`    \r\n`> S-1`\r\n### Number of sub-authorities\r\nbyte[1] = `\\u0005` = `5`    5 sub-authorities\r\n### Identifier Authority (big-endian)\r\nbyte[2-7] = `\\u0000\\u0000\\u0000\\u0000\\u0000\\u0005\\` = `[0, 0, 0, 0, 0, 5]` = `5`\r\n`> S-1-5`\r\n\r\n### 1st SubAuthority (little-endian)\r\nbyte[8-12] = `\\u0015\\u0000\\u0000\\u0000` = `[21, 0, 0, 0]` = `21`\r\n`> S-1-5-21`\r\n\r\n### 2nd SubAuthority (little-endian) (does not match)\r\n#### Expected:\r\nbyte[12-16] = `\\x8a\\xa72?` = `[138, 167, 50, 63]` = `1060284298`\r\n`> S-1-5-21-1060284298`\r\n\r\n#### Actual:\r\nbyte[12-16] = `��2?` = `[63, 63, 50, 63]` = `1060257599`\r\n`> S-1-5-21-1060257599`\r\n\r\nAny additional case with the replacement character present has a similar issue.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/696770333","html_url":"https://github.com/elastic/elasticsearch/issues/61173#issuecomment-696770333","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61173","id":696770333,"node_id":"MDEyOklzc3VlQ29tbWVudDY5Njc3MDMzMw==","user":{"login":"djsiroky","id":11220250,"node_id":"MDQ6VXNlcjExMjIwMjUw","avatar_url":"https://avatars2.githubusercontent.com/u/11220250?v=4","gravatar_id":"","url":"https://api.github.com/users/djsiroky","html_url":"https://github.com/djsiroky","followers_url":"https://api.github.com/users/djsiroky/followers","following_url":"https://api.github.com/users/djsiroky/following{/other_user}","gists_url":"https://api.github.com/users/djsiroky/gists{/gist_id}","starred_url":"https://api.github.com/users/djsiroky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djsiroky/subscriptions","organizations_url":"https://api.github.com/users/djsiroky/orgs","repos_url":"https://api.github.com/users/djsiroky/repos","events_url":"https://api.github.com/users/djsiroky/events{/privacy}","received_events_url":"https://api.github.com/users/djsiroky/received_events","type":"User","site_admin":false},"created_at":"2020-09-22T14:47:10Z","updated_at":"2020-09-22T14:47:10Z","author_association":"NONE","body":"For anyone trying to work around this issue, in particular trying to use document-level security to filter results by the SIDs of the AD security groups someone is a member of, here's what we did as a workaround:\r\n\r\nWrite an AD Security Group / ElasticSearch Role + Role Mapping sync script that:\r\n- Fetches all AD security groups\r\n- For each security group:\r\n  - Create an ES role for that group, with a document filter for the field containing the SIDs with a value of the SID of the current group: `{\r\n  \"bool\": {\r\n    \"filter\": [\r\n      {\"term\":{\"acls\":{\"value\":\"S-1-5-....\"}}}\r\n    ]\r\n  }\r\n}`\r\n  - Create an ES role mapping that adds the role created in the previous step if the user's groups contains the DN of the group\r\n- This script should also handle updated or removed groups to ensure it is in sync with your AD\r\n\r\nThis does not resolve the issue above, but is working for us to bypass it until a more integrated solution becomes available.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/696777655","html_url":"https://github.com/elastic/elasticsearch/issues/61173#issuecomment-696777655","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61173","id":696777655,"node_id":"MDEyOklzc3VlQ29tbWVudDY5Njc3NzY1NQ==","user":{"login":"bytebilly","id":52658645,"node_id":"MDQ6VXNlcjUyNjU4NjQ1","avatar_url":"https://avatars0.githubusercontent.com/u/52658645?v=4","gravatar_id":"","url":"https://api.github.com/users/bytebilly","html_url":"https://github.com/bytebilly","followers_url":"https://api.github.com/users/bytebilly/followers","following_url":"https://api.github.com/users/bytebilly/following{/other_user}","gists_url":"https://api.github.com/users/bytebilly/gists{/gist_id}","starred_url":"https://api.github.com/users/bytebilly/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bytebilly/subscriptions","organizations_url":"https://api.github.com/users/bytebilly/orgs","repos_url":"https://api.github.com/users/bytebilly/repos","events_url":"https://api.github.com/users/bytebilly/events{/privacy}","received_events_url":"https://api.github.com/users/bytebilly/received_events","type":"User","site_admin":false},"created_at":"2020-09-22T14:58:32Z","updated_at":"2020-09-22T14:58:32Z","author_association":"NONE","body":"Thanks for providing details and sharing your workaround.\r\n\r\nI'm curious if the \"wrong\" characters are sent back by Elasticsearch as replacements (0xFF 0xFD) or if they are sent as expected (0x8A 0xA7) and rendered with the replacement on the client side, since it was interpreted as a text string.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/698409796","html_url":"https://github.com/elastic/elasticsearch/issues/61173#issuecomment-698409796","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61173","id":698409796,"node_id":"MDEyOklzc3VlQ29tbWVudDY5ODQwOTc5Ng==","user":{"login":"djsiroky","id":11220250,"node_id":"MDQ6VXNlcjExMjIwMjUw","avatar_url":"https://avatars2.githubusercontent.com/u/11220250?v=4","gravatar_id":"","url":"https://api.github.com/users/djsiroky","html_url":"https://github.com/djsiroky","followers_url":"https://api.github.com/users/djsiroky/followers","following_url":"https://api.github.com/users/djsiroky/following{/other_user}","gists_url":"https://api.github.com/users/djsiroky/gists{/gist_id}","starred_url":"https://api.github.com/users/djsiroky/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djsiroky/subscriptions","organizations_url":"https://api.github.com/users/djsiroky/orgs","repos_url":"https://api.github.com/users/djsiroky/repos","events_url":"https://api.github.com/users/djsiroky/events{/privacy}","received_events_url":"https://api.github.com/users/djsiroky/received_events","type":"User","site_admin":false},"created_at":"2020-09-24T15:14:32Z","updated_at":"2020-09-24T15:14:32Z","author_association":"NONE","body":"Hi @bytebilly, I don't believe that's the case. I've checked the response via `curl`, Insomnia (an REST API tool similar to Postman), and a Node.js script, and each time the response from the server includes:\r\n- Content-Type headers of  `application/json; charset=UTF-8` (telling me the byte array is being string encoded server-side)\r\n- Some form of an encoded string with the replacement characters (these are all different examples, not the same group):\r\nNode: `'\\x01\\x05\\x00\\x00\\x00\\x00\\x00\\x05\\x15\\x00\\x00\\x00��2?|�$\\r���(�Y\\x01\\x00'`\r\nInsomnia: `\"\u0001\u0005\u0005\u0015�S�|cE�P�\\b�7�\\n\"` (Visual Preview view) or `\"\\u0001\\u0005\\u0000\\u0000\\u0000\\u0000\\u0000\\u0005\\u0015\\u0000\\u0000\\u0000��2?|�$\\r���(�u\\u0000\\u0000\"` (Raw Data view)\r\ncurl: `\"\\u0001\\u0005\\u0000\\u0000\\u0000\\u0000\\u0000\\u0005\\u0015\\u0000\\u0000\\u0000��2?|�$\\r���(7*\\u0001\\u0000\"`","performed_via_github_app":null}]