[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159546068","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-159546068","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":159546068,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTU0NjA2OA==","user":{"login":"lukapor","id":3388840,"node_id":"MDQ6VXNlcjMzODg4NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/3388840?v=4","gravatar_id":"","url":"https://api.github.com/users/lukapor","html_url":"https://github.com/lukapor","followers_url":"https://api.github.com/users/lukapor/followers","following_url":"https://api.github.com/users/lukapor/following{/other_user}","gists_url":"https://api.github.com/users/lukapor/gists{/gist_id}","starred_url":"https://api.github.com/users/lukapor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukapor/subscriptions","organizations_url":"https://api.github.com/users/lukapor/orgs","repos_url":"https://api.github.com/users/lukapor/repos","events_url":"https://api.github.com/users/lukapor/events{/privacy}","received_events_url":"https://api.github.com/users/lukapor/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T09:24:29Z","updated_at":"2015-11-25T14:11:25Z","author_association":"NONE","body":"Problem occurs when I using next search query\n\n```\n{\n  \"from\": 0,\n  \"size\": 20,\n  \"sort\": [\n    {\n      \"_score\": {\n        \"missing\": \"_last\",\n        \"order\": \"desc\"\n      }\n    }\n  ],\n  \"highlight\": {\n    \"pre_tags\": [\n      \"<lukituki>\"\n    ],\n    \"post_tags\": [\n      \"</lukituki>\"\n    ],\n    \"fields\": {\n      \"searchText\": { }\n    }\n  },\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"authorizationToken\": {\n              \"value\": \"1859\"\n            }\n          }\n        },\n        {\n          \"term\": {\n            \"deleted\": {\n              \"value\": false\n            }\n          }\n        }\n      ],\n      \"should\": [\n        {\n          \"has_child\": {\n            \"type\": \"stream1boost\",\n            \"score_mode\": \"sum\",\n            \"query\": {\n              \"function_score\": {\n                \"query\": {\n                  \"bool\": {\n                    \"must\": [\n                      {\n                        \"term\": {\n                          \"userAccountId\": {\n                            \"boost\": 0,\n                            \"value\": 1859\n                          }\n                        }\n                      }\n                    ]\n                  }\n                },\n                \"score_mode\": \"sum\",\n                \"boost_mode\": \"max\",\n                \"script_score\": {\n                  \"script\": \"doc['searchBoost'].value\"\n                }\n              }\n            }\n          }\n        }\n      ],\n      \"minimum_should_match\": \"0\"\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159619480","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-159619480","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":159619480,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTYxOTQ4MA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T14:17:18Z","updated_at":"2015-11-25T14:17:29Z","author_association":"CONTRIBUTOR","body":"@lukapor, I edited your messages to apply code formatting.\n\nThis certainly looks like a bug. It'd be super helpful if you could make a gist that recreates this against an empty index using [curl](https://www.elastic.co/help). It'd make reproducing the issue locally super easy.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159630202","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-159630202","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":159630202,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTYzMDIwMg==","user":{"login":"lukapor","id":3388840,"node_id":"MDQ6VXNlcjMzODg4NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/3388840?v=4","gravatar_id":"","url":"https://api.github.com/users/lukapor","html_url":"https://github.com/lukapor","followers_url":"https://api.github.com/users/lukapor/followers","following_url":"https://api.github.com/users/lukapor/following{/other_user}","gists_url":"https://api.github.com/users/lukapor/gists{/gist_id}","starred_url":"https://api.github.com/users/lukapor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukapor/subscriptions","organizations_url":"https://api.github.com/users/lukapor/orgs","repos_url":"https://api.github.com/users/lukapor/repos","events_url":"https://api.github.com/users/lukapor/events{/privacy}","received_events_url":"https://api.github.com/users/lukapor/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T14:50:01Z","updated_at":"2015-11-25T14:50:01Z","author_association":"NONE","body":"Hello,\nunfortunately I do not have script for the generation the index, whereas it creates programming. An easy way to tell just where the problem is.\nI have stream1 object that has a child object stream1boost.\nWhen I search from stream1 one of sort is by most used. There i use child function score. If this is used (\"should\": [{\"has_child\": { ...) the problem occours otherwise not.\n\nI will try to generate script  to reproduce the bug\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159741091","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-159741091","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":159741091,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTc0MTA5MQ==","user":{"login":"lukapor","id":3388840,"node_id":"MDQ6VXNlcjMzODg4NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/3388840?v=4","gravatar_id":"","url":"https://api.github.com/users/lukapor","html_url":"https://github.com/lukapor","followers_url":"https://api.github.com/users/lukapor/followers","following_url":"https://api.github.com/users/lukapor/following{/other_user}","gists_url":"https://api.github.com/users/lukapor/gists{/gist_id}","starred_url":"https://api.github.com/users/lukapor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukapor/subscriptions","organizations_url":"https://api.github.com/users/lukapor/orgs","repos_url":"https://api.github.com/users/lukapor/repos","events_url":"https://api.github.com/users/lukapor/events{/privacy}","received_events_url":"https://api.github.com/users/lukapor/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T21:59:45Z","updated_at":"2015-11-25T21:59:45Z","author_association":"NONE","body":"I attached script to create index mapping, insert data and then query them. On query request will\n[insertData.txt](https://github.com/elastic/elasticsearch/files/44438/insertData.txt)\n[mapping.txt](https://github.com/elastic/elasticsearch/files/44436/mapping.txt)\n[query.txt](https://github.com/elastic/elasticsearch/files/44437/query.txt)\n\n fail.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160323849","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-160323849","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":160323849,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDMyMzg0OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-28T17:45:02Z","updated_at":"2015-11-28T17:45:02Z","author_association":"CONTRIBUTOR","body":"Reduced to the following minimal test case:\n\n```\nPUT /test1\n{\n  \"mappings\": {\n    \"stream1\": {\n    },\n    \"stream1boost\": {\n      \"_parent\": {\n        \"type\": \"stream1\"\n      }\n    }\n  }\n}\n\nPUT /test1/stream1/1\n{\n    \"searchText\": \"stream1\"\n}\n\n\nPUT /test1/stream1boost/1?parent=1\n{\n    \"searchText\": \"stream1\",\n    \"searchBoost\": 1,\n    \"userId\": 1\n}\n\n\nPOST /test1/stream1/_search\n{\n  \"from\": 0,\n  \"size\": 20,\n  \"highlight\": {\n    \"fields\": {\n      \"searchText\": { }\n    }\n  },\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"has_child\": {\n            \"type\": \"stream1boost\",\n            \"query\": {\n              \"match_all\": {}\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160323990","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-160323990","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":160323990,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDMyMzk5MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-28T17:45:35Z","updated_at":"2015-11-28T17:45:35Z","author_association":"CONTRIBUTOR","body":"@martijnvg could you take a look please\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/175632334","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-175632334","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":175632334,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NTYzMjMzNA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-01-27T13:39:37Z","updated_at":"2016-01-27T13:39:37Z","author_association":"MEMBER","body":"The problem here is that the parent/child queries since 2.0 require a top level reader is used. During highlighting we re-execute the query for each hit using the leaf reader the hit was found in. The parent/child queries refuse to work with this now. Before 2.0 highlighting wouldn't have worked all the time with parent/child queries as the child hit maybe in a different leaf reader (segment) then the parent hit.\n\nThe right way for highlighting in this case would be to use `inner_hits` and move the highlighting part from the top level to the inner hits part:\n\n```\nPOST /test1/stream1/_search\n{\n  \"from\": 0,\n  \"size\": 20,\n  \"query\": {\n    \"bool\": {\n      \"should\": [\n        {\n          \"has_child\": {\n            \"type\": \"stream1boost\",\n            \"query\": {\n              \"match\": {\n                \"searchText\": \"stream1\"\n              }\n            },\n            \"inner_hits\": {\n              \"highlight\": {\n                \"fields\": {\n                  \"searchText\": {}\n                }\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nI think that instead of throwing an error highlighting shouldn't try extract terms from `has_child` or `has_parent`, so that if these queries just happen to be part of a bigger query other highlights do get returned in the response.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/175659759","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-175659759","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":175659759,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NTY1OTc1OQ==","user":{"login":"lukapor","id":3388840,"node_id":"MDQ6VXNlcjMzODg4NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/3388840?v=4","gravatar_id":"","url":"https://api.github.com/users/lukapor","html_url":"https://github.com/lukapor","followers_url":"https://api.github.com/users/lukapor/followers","following_url":"https://api.github.com/users/lukapor/following{/other_user}","gists_url":"https://api.github.com/users/lukapor/gists{/gist_id}","starred_url":"https://api.github.com/users/lukapor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukapor/subscriptions","organizations_url":"https://api.github.com/users/lukapor/orgs","repos_url":"https://api.github.com/users/lukapor/repos","events_url":"https://api.github.com/users/lukapor/events{/privacy}","received_events_url":"https://api.github.com/users/lukapor/received_events","type":"User","site_admin":false},"created_at":"2016-01-27T14:37:34Z","updated_at":"2016-01-27T14:37:34Z","author_association":"NONE","body":"I can tell you only that the query works in es2.0, it stop working with version 2.1\n\nMy use case is next\nstream1 holds searchText propertie\nstream1boost is user boost for specific stream (stream1 has multiple stream1boost or none), stream1boost has only searchBoost propertie (weight)\n\nSo I am searching for stream with some prefix query with different sorts (by name, by most used, ..). Results that I want are stream1 and their highlights. When most used sort is selected I use has_child should query with function_score, that calculate score of current streams. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/176100998","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-176100998","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":176100998,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NjEwMDk5OA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-28T10:08:09Z","updated_at":"2016-01-28T10:08:09Z","author_association":"CONTRIBUTOR","body":"> I think that instead of throwing an error highlighting shouldn't try extract terms from has_child or has_parent, so that if these queries just happen to be part of a bigger query other highlights do get returned in the response.\n\nMakes sense.  Without inner hits, you wouldn't expect docs matching a has_child or has_parent query to be returned anyway, so there shouldn't be any highlighting on these docs.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/185988506","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-185988506","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":185988506,"node_id":"MDEyOklzc3VlQ29tbWVudDE4NTk4ODUwNg==","user":{"login":"rpedela","id":1952582,"node_id":"MDQ6VXNlcjE5NTI1ODI=","avatar_url":"https://avatars1.githubusercontent.com/u/1952582?v=4","gravatar_id":"","url":"https://api.github.com/users/rpedela","html_url":"https://github.com/rpedela","followers_url":"https://api.github.com/users/rpedela/followers","following_url":"https://api.github.com/users/rpedela/following{/other_user}","gists_url":"https://api.github.com/users/rpedela/gists{/gist_id}","starred_url":"https://api.github.com/users/rpedela/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rpedela/subscriptions","organizations_url":"https://api.github.com/users/rpedela/orgs","repos_url":"https://api.github.com/users/rpedela/repos","events_url":"https://api.github.com/users/rpedela/events{/privacy}","received_events_url":"https://api.github.com/users/rpedela/received_events","type":"User","site_admin":false},"created_at":"2016-02-19T00:12:40Z","updated_at":"2016-02-19T00:12:40Z","author_association":"NONE","body":"I have the same problem with 2.2. In my case, I need highlighting for the parent and the child. If I remove the top-level highlighting then it works fine.\n\nDoes not work\n\n``` js\n{\n    query: {\n        bool: {\n            should: [\n                {\n                    query_string: 'google'\n                },\n                {\n                    has_child: {\n                        type: 'child_doc',\n                        score_mode: 'max',\n                        query: {\n                            query_string: 'google'\n                        },\n                        inner_hits: {\n                            highlight: {\n                                order: 'score',\n                                fields: {\n                                    title: { number_of_fragments: 0 },\n                                    body: { number_of_fragments: 3 }\n                                }\n                            },\n                            from: 0,\n                            size: 1\n                        }\n                    }\n                }\n            ]\n        }\n    },\n    highlight: {\n        order: 'score',\n        fields: {\n            description: { number_of_fragments: 0 }\n        }\n    }\n}\n```\n\nDoes work, but no highlighting on parent document\n\n``` js\n{\n    query: {\n        bool: {\n            should: [\n                {\n                    query_string: 'google'\n                },\n                {\n                    has_child: {\n                        type: 'child_doc',\n                        score_mode: 'max',\n                        query: {\n                            query_string: 'google'\n                        },\n                        inner_hits: {\n                            highlight: {\n                                order: 'score',\n                                fields: {\n                                    title: { number_of_fragments: 0 },\n                                    body: { number_of_fragments: 3 }\n                                }\n                            },\n                            from: 0,\n                            size: 1\n                        }\n                    }\n                }\n            ]\n        }\n    }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192234177","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192234177","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192234177,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjIzNDE3Nw==","user":{"login":"borjakhet","id":17317250,"node_id":"MDQ6VXNlcjE3MzE3MjUw","avatar_url":"https://avatars3.githubusercontent.com/u/17317250?v=4","gravatar_id":"","url":"https://api.github.com/users/borjakhet","html_url":"https://github.com/borjakhet","followers_url":"https://api.github.com/users/borjakhet/followers","following_url":"https://api.github.com/users/borjakhet/following{/other_user}","gists_url":"https://api.github.com/users/borjakhet/gists{/gist_id}","starred_url":"https://api.github.com/users/borjakhet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borjakhet/subscriptions","organizations_url":"https://api.github.com/users/borjakhet/orgs","repos_url":"https://api.github.com/users/borjakhet/repos","events_url":"https://api.github.com/users/borjakhet/events{/privacy}","received_events_url":"https://api.github.com/users/borjakhet/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T11:01:38Z","updated_at":"2016-03-04T11:02:22Z","author_association":"NONE","body":"I'm having the same results as @rpedela (using ES 2.1). Any fixes?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192286246","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192286246","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192286246,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjI4NjI0Ng==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T13:35:26Z","updated_at":"2016-03-04T13:35:26Z","author_association":"CONTRIBUTOR","body":"> I'm having the same results as @rpedela (using ES 2.1). Any fixes?\n\nI'd try using a highlight_query element that doesn't include parent/child.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192286305","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192286305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192286305,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjI4NjMwNQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T13:35:46Z","updated_at":"2016-03-04T13:35:46Z","author_association":"CONTRIBUTOR","body":"This thing: https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-highlighting.html#_highlight_query\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192287005","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192287005","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192287005,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjI4NzAwNQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T13:38:23Z","updated_at":"2016-03-04T13:38:23Z","author_association":"MEMBER","body":"So the search request body should look like this:\n\n```\n{\n    query: {\n        bool: {\n            should: [\n                {\n                    query_string: 'google'\n                },\n                {\n                    has_child: {\n                        type: 'child_doc',\n                        score_mode: 'max',\n                        query: {\n                            query_string: 'google'\n                        },\n                        inner_hits: {\n                            highlight: {\n                                order: 'score',\n                                fields: {\n                                    title: { number_of_fragments: 0 },\n                                    body: { number_of_fragments: 3 }\n                                }\n                            },\n                            from: 0,\n                            size: 1\n                        }\n                    }\n                }\n            ]\n        }\n    },\n    highlight: {\n        order: 'score',\n        fields: {\n            description: { number_of_fragments: 0 }\n        },\n        highlight_query: {\n            bool: {\n            should: [\n                {\n                    query_string: 'google'\n                }\n            ]\n        }\n    }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192294989","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192294989","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192294989,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjI5NDk4OQ==","user":{"login":"borjakhet","id":17317250,"node_id":"MDQ6VXNlcjE3MzE3MjUw","avatar_url":"https://avatars3.githubusercontent.com/u/17317250?v=4","gravatar_id":"","url":"https://api.github.com/users/borjakhet","html_url":"https://github.com/borjakhet","followers_url":"https://api.github.com/users/borjakhet/followers","following_url":"https://api.github.com/users/borjakhet/following{/other_user}","gists_url":"https://api.github.com/users/borjakhet/gists{/gist_id}","starred_url":"https://api.github.com/users/borjakhet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borjakhet/subscriptions","organizations_url":"https://api.github.com/users/borjakhet/orgs","repos_url":"https://api.github.com/users/borjakhet/repos","events_url":"https://api.github.com/users/borjakhet/events{/privacy}","received_events_url":"https://api.github.com/users/borjakhet/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T14:05:43Z","updated_at":"2016-03-04T14:07:17Z","author_association":"NONE","body":"It's still not working for me.\n\nOriginal code without highlights, working ok.\n\n```\n        {\n            query:\n            {\n                bool:\n                {\n                    must:\n                    [\n                        {\n                            query_string:\n                            {\n                                fields: [ 'title', 'body'],\n                                query: pUserInput,\n\n                            }\n                        },\n                        {\n                           term: {\n                            source_id: pSourceIdInput\n                           }\n                        },\n                        {\n                            has_child:\n                            {\n                                type: \"user_item_relation\",\n                                query:\n                                {\n                                    bool:\n                                    {\n                                        must:\n                                        [\n                                            {\n                                                term:\n                                                {\n                                                    user_id: pUserIdInput\n                                                }\n                                            }\n                                            /*{\n                                                term:\n                                                {\n                                                    favorite: 1\n                                                }\n                                            }*/\n\n                                        ]\n                                    }\n                                }\n                            }\n                        }\n                    ]\n                }\n            }\n        }\n```\n\nCode with highlights, query works ok but no highlights are shown.\n\n```\n        {\n            query:\n            {\n                bool:\n                {\n                    must:\n                    [\n                        {\n                            query_string:\n                            {\n                                fields: [ 'title', 'body'],\n                                query: pUserInput,\n\n                            }\n                        },\n                        {\n                           term: {\n                            source_id: pSourceIdInput\n                           }\n                        },\n                        {\n                            has_child:\n                            {\n                                type: \"user_item_relation\",\n                                query:\n                                {\n                                    bool:\n                                    {\n                                        must:\n                                        [\n                                            {\n                                                term:\n                                                {\n                                                    user_id: pUserIdInput\n                                                }\n                                            }\n                                            /*{\n                                                term:\n                                                {\n                                                    favorite: 1\n                                                }\n                                            }*/\n\n                                        ]\n                                    }\n                                },\n                                inner_hits: {\n                                   highlight: {\n                                     order: 'score',\n                                     fields: {\n                                         title: { number_of_fragments: 0 },\n                                         body: { number_of_fragments: 3 }\n                                     }\n                                  }\n                                 }\n                            }\n                        }\n                    ]\n                }\n            },\n            highlight: {\n                 order: 'score',\n                 fields: {\n                   title: { number_of_fragments: 0 }\n                 },\n                 highlight_query: {\n                   bool: {\n                   should: [\n                     {\n                         query_string:\n                         {\n                             fields: [ 'title', 'body'],\n                             query: pUserInput,\n\n                         }\n                     }\n                   ]\n                 }\n             }\n        }\n    }\n```\n\nWhat I'm doing wrong here? \nThanks in advance.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192297044","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192297044","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192297044,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjI5NzA0NA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T14:12:43Z","updated_at":"2016-03-04T14:12:43Z","author_association":"MEMBER","body":"@borjakhet You still get the same error? This should work, I checked it locally. Maybe try to run with @clintongormley minimal reproduction via Sense / curl commands? So that it is easier to see what happens?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/192299040","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-192299040","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":192299040,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MjI5OTA0MA==","user":{"login":"borjakhet","id":17317250,"node_id":"MDQ6VXNlcjE3MzE3MjUw","avatar_url":"https://avatars3.githubusercontent.com/u/17317250?v=4","gravatar_id":"","url":"https://api.github.com/users/borjakhet","html_url":"https://github.com/borjakhet","followers_url":"https://api.github.com/users/borjakhet/followers","following_url":"https://api.github.com/users/borjakhet/following{/other_user}","gists_url":"https://api.github.com/users/borjakhet/gists{/gist_id}","starred_url":"https://api.github.com/users/borjakhet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borjakhet/subscriptions","organizations_url":"https://api.github.com/users/borjakhet/orgs","repos_url":"https://api.github.com/users/borjakhet/repos","events_url":"https://api.github.com/users/borjakhet/events{/privacy}","received_events_url":"https://api.github.com/users/borjakhet/received_events","type":"User","site_admin":false},"created_at":"2016-03-04T14:20:44Z","updated_at":"2016-03-04T14:20:44Z","author_association":"NONE","body":"It works, it was my API fault, I was reading `_source.title` instead of `highlight.title`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234911202","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-234911202","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":234911202,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDkxMTIwMg==","user":{"login":"vicmosin","id":612207,"node_id":"MDQ6VXNlcjYxMjIwNw==","avatar_url":"https://avatars3.githubusercontent.com/u/612207?v=4","gravatar_id":"","url":"https://api.github.com/users/vicmosin","html_url":"https://github.com/vicmosin","followers_url":"https://api.github.com/users/vicmosin/followers","following_url":"https://api.github.com/users/vicmosin/following{/other_user}","gists_url":"https://api.github.com/users/vicmosin/gists{/gist_id}","starred_url":"https://api.github.com/users/vicmosin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vicmosin/subscriptions","organizations_url":"https://api.github.com/users/vicmosin/orgs","repos_url":"https://api.github.com/users/vicmosin/repos","events_url":"https://api.github.com/users/vicmosin/events{/privacy}","received_events_url":"https://api.github.com/users/vicmosin/received_events","type":"User","site_admin":false},"created_at":"2016-07-25T09:56:01Z","updated_at":"2016-07-25T09:56:57Z","author_association":"NONE","body":"Also have this issue with 2.1.0 and using `highlight_query` only solves it.. Otherwise error is thrown. Should we wait for a bugfix? Current solution looks more like a workaround, even [docs](https://www.elastic.co/guide/en/elasticsearch/reference/2.3/search-request-highlighting.html#_highlight_query) explains the true meaning of using `highlight_query`... \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/236303163","html_url":"https://github.com/elastic/elasticsearch/issues/14999#issuecomment-236303163","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14999","id":236303163,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNjMwMzE2Mw==","user":{"login":"benbenwilde","id":3302573,"node_id":"MDQ6VXNlcjMzMDI1NzM=","avatar_url":"https://avatars3.githubusercontent.com/u/3302573?v=4","gravatar_id":"","url":"https://api.github.com/users/benbenwilde","html_url":"https://github.com/benbenwilde","followers_url":"https://api.github.com/users/benbenwilde/followers","following_url":"https://api.github.com/users/benbenwilde/following{/other_user}","gists_url":"https://api.github.com/users/benbenwilde/gists{/gist_id}","starred_url":"https://api.github.com/users/benbenwilde/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benbenwilde/subscriptions","organizations_url":"https://api.github.com/users/benbenwilde/orgs","repos_url":"https://api.github.com/users/benbenwilde/repos","events_url":"https://api.github.com/users/benbenwilde/events{/privacy}","received_events_url":"https://api.github.com/users/benbenwilde/received_events","type":"User","site_admin":false},"created_at":"2016-07-29T21:52:51Z","updated_at":"2016-07-29T21:56:12Z","author_association":"NONE","body":"+1\nThis was quite confusing for me as I was highlighting on parent and child documents at the same time.\n\nEssentially it seems it will work by merely including a highlight_query clause in every highlight clause, even if it's just a match all.\n\nAlso, I was using 2.3 and thought it would be fixed by now, seeing all the references to 2.1. Looks like it won't come till 2.4.\n","performed_via_github_app":null}]