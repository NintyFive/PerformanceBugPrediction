[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/436187305","html_url":"https://github.com/elastic/elasticsearch/issues/35287#issuecomment-436187305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35287","id":436187305,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjE4NzMwNQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T09:30:47Z","updated_at":"2018-11-06T09:30:47Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/436217379","html_url":"https://github.com/elastic/elasticsearch/issues/35287#issuecomment-436217379","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35287","id":436217379,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjIxNzM3OQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-11-06T11:13:11Z","updated_at":"2018-11-06T11:13:11Z","author_association":"CONTRIBUTOR","body":"This is hiding another assertion error (which is the true cause for the failure here):\r\n\r\n```\r\n2> Lap 06, 2018 8:52:27 AM com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\r\n  2> WARNING: Uncaught exception in thread: Thread[elasticsearch[node_t0][bulk][T#1],5,TGRP-DiscoveryWithServiceDisruptionsIT]\r\n  2> java.lang.AssertionError: version must be set. got -1\r\n  2> \tat __randomizedtesting.SeedInfo.seed([183C381D4B33B132]:0)\r\n  2> \tat org.elasticsearch.index.engine.InternalEngine.indexIntoLucene(InternalEngine.java:597)\r\n  2> \tat org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:504)\r\n  2> \tat org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:557)\r\n  2> \tat org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:546)\r\n  2> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequestOnPrimary(TransportShardBulkAction.java:493)\r\n  2> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:145)\r\n  2> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:114)\r\n  2> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:69)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:975)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:944)\r\n  2> \tat org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:113)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:345)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:270)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:924)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:921)\r\n  2> \tat org.elasticsearch.index.shard.IndexShardOperationsLock.acquire(IndexShardOperationsLock.java:151)\r\n  2> \tat org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationLock(IndexShard.java:1659)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryShardReference(TransportReplicationAction.java:933)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction.access$500(TransportReplicationAction.java:92)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:291)\r\n  2> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:266)\r\n  2> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:248)\r\n  2> \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)\r\n  2> \tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:662)\r\n  2> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:675)\r\n  2> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n  2> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n  2> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n  2> \tat java.lang.Thread.run(Thread.java:748)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/436572006","html_url":"https://github.com/elastic/elasticsearch/issues/35287#issuecomment-436572006","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35287","id":436572006,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNjU3MjAwNg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-11-07T10:07:37Z","updated_at":"2018-11-07T10:07:37Z","author_association":"CONTRIBUTOR","body":"@bleskes I need a second pair of eyes here. I've traced through the code and cannot see how, given the stack trace above, this assertion can trip. The test goes as follows:\r\n- node0 (master), on which the assertion trips, has a replica initially\r\n- node1 has the primary and will be partitioned away from node0 and node2\r\n- replica on node0 is promoted to primary\r\n- Indexing requests might be retried due to disconnect and the original replication requests from node1 might be replicated to node0 while the replica on node0 is transitioning to primary (and in contrast to 6.x, this transition is not happening under the operation block, so less clean).\r\n\r\nNow looking at the above stack trace:\r\n- `testAckedIndexing` does not use auto-generated IDs\r\n- We see `TransportShardBulkAction.executeIndexRequestOnPrimary` in the stack trace, which means that the document to be indexed has `Engine.Operation.Origin.PRIMARY`\r\n- This in turn means that `planIndexingAsPrimary` will be called. As we are later trying to index into Lucene with version `-1` this only leaves `processNormally` as the possible indexing strategy (all other ones either use fixed value (1) or don't index into Lucene.\r\n- `processNormally` determines the version based on version type. `testAckedIndexing` uses the standard (internal versioning). The updated version is calculated based on `currentVersion == Versions.NOT_FOUND ? 1 : currentVersion + 1` where `Versions.NOT_FOUND` is `-1`. The `currentVersion` is either `-1` or `versionValue.getVersion()`, which comes from `resolveDocVersion`. The `resolveDocVersion` either resolves the version through the version map or from the index. The test is only issuing index operations, not deletes, so `resolveDocVersion` should either yield -1 or a positive number, which means that the updated version will always be positive.\r\n- it is therefore a mystery to me how we can end up with an `IndexingStrategy` that has `-1` as version.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/437406211","html_url":"https://github.com/elastic/elasticsearch/issues/35287#issuecomment-437406211","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35287","id":437406211,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNzQwNjIxMQ==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2018-11-09T16:03:57Z","updated_at":"2018-11-09T16:03:57Z","author_association":"MEMBER","body":"@ywelsch and I went through this and sadly, no dice - we couldn't find an explanation. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/445422744","html_url":"https://github.com/elastic/elasticsearch/issues/35287#issuecomment-445422744","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35287","id":445422744,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NTQyMjc0NA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-12-08T02:29:49Z","updated_at":"2018-12-08T02:29:49Z","author_association":"MEMBER","body":"Another instance on 5.6: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+5.6+periodic/311/consoleText","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/459654326","html_url":"https://github.com/elastic/elasticsearch/issues/35287#issuecomment-459654326","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35287","id":459654326,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1OTY1NDMyNg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-02-01T09:05:36Z","updated_at":"2019-02-01T09:05:36Z","author_association":"CONTRIBUTOR","body":"Closing this as this looks to be a 5.6 problem only and we can't figure out the cause. Given that 5.6 is EOL very soon, I don't think we should continue chasing this one.","performed_via_github_app":null}]