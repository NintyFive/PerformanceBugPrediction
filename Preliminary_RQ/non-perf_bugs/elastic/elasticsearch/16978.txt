{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16978","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16978/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16978/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16978/events","html_url":"https://github.com/elastic/elasticsearch/issues/16978","id":138928323,"node_id":"MDU6SXNzdWUxMzg5MjgzMjM=","number":16978,"title":"'us-east-1` is not a valid region when creating s3 bucket","user":{"login":"xuzha","id":1799964,"node_id":"MDQ6VXNlcjE3OTk5NjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1799964?v=4","gravatar_id":"","url":"https://api.github.com/users/xuzha","html_url":"https://github.com/xuzha","followers_url":"https://api.github.com/users/xuzha/followers","following_url":"https://api.github.com/users/xuzha/following{/other_user}","gists_url":"https://api.github.com/users/xuzha/gists{/gist_id}","starred_url":"https://api.github.com/users/xuzha/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xuzha/subscriptions","organizations_url":"https://api.github.com/users/xuzha/orgs","repos_url":"https://api.github.com/users/xuzha/repos","events_url":"https://api.github.com/users/xuzha/events{/privacy}","received_events_url":"https://api.github.com/users/xuzha/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-03-07T09:17:19Z","updated_at":"2018-02-14T13:57:05Z","closed_at":"2017-02-24T17:26:32Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: master\n\n**JVM version**: 1.8\n\n**OS version**: OSX\n\n**Describe the feature**: \n\nWhen we using `us-east-1`, s3 plugin will first get the endpoint by using the `region`, and then use the endpoint to create the client, this is fine. \n\nBut when creating the bucket, s3 plugin will will the `bucket` name to build a `CreateBucketRequest` ([link](https://github.com/elastic/elasticsearch/blob/mase/plugins/repository-s3/src/main/java/org/elasticsearch/cloud/aws/blobstore/S3BlobStore.java#L96)), `us-east-1` is not valid for aws s3 sdk.\n\nReproduce:\n\n```\nPUT _snapshot/test-1\n{\n  \"type\": \"s3\",\n  \"settings\": {\n    \"bucket\": \"test-us-east-1\",\n    \"region\": \"us-east-1\"\n  }\n}\n```\n\n```\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"repository_exception\",\n            \"reason\": \"[test-6] failed to create repository\"\n         }\n      ],\n      \"type\": \"repository_exception\",\n      \"reason\": \"[test-6] failed to create repository\",\n      \"caused_by\": {\n         \"type\": \"creation_exception\",\n         \"reason\": \"Guice creation errors:\\n\\n1) Error injecting constructor, com.amazonaws.services.s3.model.AmazonS3Exception: The specified location-constraint is not valid (Service: Amazon S3; Status Code: 400; Error Code: InvalidLocationConstraint; Request ID: 85CFF34E01878232), S3 Extended Request ID: Ob5XZJsy8IH7HaZy/moMNAgvaH3ZIrHN9fxyimecIp+xtMZI8nE/sc2YVIoTuf2SuEXyoiQP1wE=\\n  at org.elasticsearch.repositories.s3.S3Repository.<init>(Unknown Source)\\n  while locating org.elasticsearch.repositories.s3.S3Repository\\n  while locating org.elasticsearch.repositories.Repository\\n\\n1 error\",\n         \"caused_by\": {\n            \"type\": \"amazon_s3_exception\",\n            \"reason\": \"The specified location-constraint is not valid (Service: Amazon S3; Status Code: 400; Error Code: InvalidLocationConstraint; Request ID: 85CFF34E01878232)\"\n         }\n      }\n   },\n   \"status\": 500\n}\n```\n\nSucceed after removed the region\n\n```\nPUT _snapshot/test-1\n{\n  \"type\": \"s3\",\n  \"settings\": {\n    \"bucket\": \"test-us-east-1\"\n  }\n}\n\n```\n\nSame thing happened if we used `us-west` | `ap-southeast` | `eu-central`... \nI think if we could get the endpoint, we should using the valid region name and let user be able to create buckets.\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}