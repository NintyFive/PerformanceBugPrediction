{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26858","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26858/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26858/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26858/events","html_url":"https://github.com/elastic/elasticsearch/issues/26858","id":262200043,"node_id":"MDU6SXNzdWUyNjIyMDAwNDM=","number":26858,"title":"Delete By Query Request Run on Alias needs Security Rights to Base Index","user":{"login":"c-varberg","id":11681702,"node_id":"MDQ6VXNlcjExNjgxNzAy","avatar_url":"https://avatars0.githubusercontent.com/u/11681702?v=4","gravatar_id":"","url":"https://api.github.com/users/c-varberg","html_url":"https://github.com/c-varberg","followers_url":"https://api.github.com/users/c-varberg/followers","following_url":"https://api.github.com/users/c-varberg/following{/other_user}","gists_url":"https://api.github.com/users/c-varberg/gists{/gist_id}","starred_url":"https://api.github.com/users/c-varberg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/c-varberg/subscriptions","organizations_url":"https://api.github.com/users/c-varberg/orgs","repos_url":"https://api.github.com/users/c-varberg/repos","events_url":"https://api.github.com/users/c-varberg/events{/privacy}","received_events_url":"https://api.github.com/users/c-varberg/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-10-02T19:31:46Z","updated_at":"2017-10-02T20:07:12Z","closed_at":"2017-10-02T19:54:19Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.5.1\r\n\r\n**Plugins installed**: [\"xpack\"]\r\n\r\n**JVM version** (`java -version`): 1.8.0_131\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): CentOS 7.3.1611\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIn order to run the _delete_by_query on an alias the user needs \"delete\" privileges to the actual index. I would expect that as long as the user has read/write rights to the alias they would be able to run a _delete_by_query. It is also confusing as the request will return a 200 OK as long as there isn't actually anything to delete. If it finds something to delete then it fails out with a 403 Forbidden. I'm assuming once it finds something to delete it is trying to issue the actual delete on the index instead of the alias.\r\n\r\nI am specifically trying to do this with a filtered alias, but I have tested it with a non filtered alias and the same results are seen\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Create a new index `PUT testindex`\r\n 2. Add an alias `POST testindex/_alias/testalias`\r\n 3. Create role with read and write rights to alias \r\n`POST _xpack/security/role/testRole\r\n{\r\n    \"indices\": [\r\n      {\r\n        \"names\": [\r\n          \"testalias\"\r\n        ],\r\n        \"privileges\": [\r\n          \"write\",\r\n          \"read\"\r\n        ]\r\n      }\r\n    ]\r\n}`\r\n4. Create user with the role just created\r\n`POST _xpack/security/user/testUser\r\n{\r\n    \"roles\": [\r\n      \"testRole\"\r\n    ],\r\n    \"password\": \"elastic\"\r\n}`\r\n5. Run _delete_by_query on alias using new user (200 OK is returned)\r\n`POST testalias/_delete_by_query\r\n{\r\n  \"query\":{\r\n    \"match_all\": {}\r\n  }\r\n}`\r\n6. Add document to index\r\n`GET testindex/testtype/1\r\n{\r\n  \"name\": \"test\"\r\n}`\r\n7. rerun _delete_by_query on Alias with same user (403 Forbidden Returned)\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n`{\r\n      \"index\": \"testindex\",\r\n      \"type\": \"testtype\",\r\n      \"id\": \"1\",\r\n      \"cause\": {\r\n        \"type\": \"security_exception\",\r\n        \"reason\": \"action [indices:data/write/bulk[s]] is unauthorized for user [testUser]\"\r\n      },\r\n      \"status\": 403\r\n}`\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}