{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4983","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4983/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4983/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4983/events","html_url":"https://github.com/elastic/elasticsearch/issues/4983","id":26741817,"node_id":"MDU6SXNzdWUyNjc0MTgxNw==","number":4983,"title":"Aggregations: Add Child Aggregators to limit parent's bucket meta-data","user":{"login":"markkimsal","id":54099,"node_id":"MDQ6VXNlcjU0MDk5","avatar_url":"https://avatars2.githubusercontent.com/u/54099?v=4","gravatar_id":"","url":"https://api.github.com/users/markkimsal","html_url":"https://github.com/markkimsal","followers_url":"https://api.github.com/users/markkimsal/followers","following_url":"https://api.github.com/users/markkimsal/following{/other_user}","gists_url":"https://api.github.com/users/markkimsal/gists{/gist_id}","starred_url":"https://api.github.com/users/markkimsal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markkimsal/subscriptions","organizations_url":"https://api.github.com/users/markkimsal/orgs","repos_url":"https://api.github.com/users/markkimsal/repos","events_url":"https://api.github.com/users/markkimsal/events{/privacy}","received_events_url":"https://api.github.com/users/markkimsal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":15,"created_at":"2014-02-01T16:27:13Z","updated_at":"2014-10-17T06:36:50Z","closed_at":"2014-10-17T06:36:50Z","author_association":"NONE","active_lock_reason":null,"body":"Having the ability for a sub-aggregate to work off of buckets from the parent aggregate would be helpful in limiting the amount of information that is returned in results.  Currently, the only way to filter a result set by a count of aggregation is to use a has_child query with a score_type of \"sum\" and apply a custom scoring routine which filters scores of a certain amount.\n\nI propose adding a child-aggregate, which can be placed anywhere a sub-aggregate can be placed, but the child only has access to the parent aggregate's buckets instead of access to the documents of the query.\n\nExample:  given a flat log of recorded user actions, where each log document is parented to a user document, find users who had 3 or more failed logins (in a given time period).\n\n```\n{\n   \"min_score\": 0,\n   \"query\": {\n      \"function_score\": {\n         \"boost_mode\": \"multiply\",\n         \"functions\": [\n            {\n               \"script_score\": {\n                  \"params\": {\n                     \"cutoff\": 2\n                  },\n                  \"script\": \"_score < cutoff ? -1 : 1\"\n               }\n            }\n         ],\n         \"query\": {\n            \"has_child\": {\n               \"type\": \"user_actions\",\n               \"score_type\": \"sum\",\n               \"query\": {\n                  \"term\": {\"log_action\": \"login_failed\"  }\n                  }\n               }\n            }\n         }\n}}\n```\n\ngives...\n\n```\n{\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 4,\n    \"hits\" : [ {\n      \"_index\" : \"test\",\n      \"_type\" : \"user\",\n      \"_id\" : \"100\",\n      \"_score\" : 3\n    }, {\n      \"_index\" : \"test\",\n      \"_type\" : \"user\",\n      \"_id\" : \"150\",\n      \"_score\" : 2\n    } ]\n  }\n}\n```\n\nwhereas an aggregate like this\n\n```\n{\n    \"query\": { \n        \"match_all\": {}\n    },\n    \"aggs\": { \n        \"unique_users\": { \n            \"terms\": {\"field\":\"email\"},\n            \"aggs\": { \n                \"action_totals\": { \n                    \"terms\": { \n                        \"field\": \"log_action\"\n                    }\n                } \n            } \n        } \n    } \n}\n```\n\nwould yield too much information in the results...\n\n```\n  \"aggregations\" : {\n    \"unique_users\" : {\n      \"buckets\" : [ {\n        \"key\" : \"user1@example.org\",\n        \"doc_count\" : 24,\n        \"action_totals\" : {\n          \"buckets\" : [ {\n            \"key\" : \"login\",\n            \"doc_count\" : 18\n          }, {\n            \"key\" : \"failed_login\",\n            \"doc_count\" : 5\n          }, {\n            \"key\" : \"change_password\",\n            \"doc_count\" : 1\n          } ]\n        }\n      }, {\n        \"key\" : \"user2@example.org\",\n        \"doc_count\" : 14,\n        \"action_totals\" : {\n          \"buckets\" : [ {\n            \"key\" : \"login\",\n            \"doc_count\" : 11\n          }, {\n            \"key\" : \"failed_login\",\n            \"doc_count\" : 3\n          } ]\n        }\n      },\n```\n\nAdding the ability for child-aggs to work off their parent meta-data\n\n```\n{\n    \"query\": { \n        \"match_all\": {}\n    },\n    \"aggs\": { \n        \"unique_users\": { \n            \"terms\": {\"field\":\"email\"},\n            \"aggs\": { \n                \"action_totals\": { \n                    \"terms\": { \n                        \"field\": \"log_action\"\n                    },\n                    \"child-aggs\": {\n                        \"limiting_range\": {\n                            \"range\": {\n                                \"field\": \"doc_count\",\n                                \"range\": [\n                                {\"from\":3}\n                                ]\n                            }   \n                        },\n                        \"limiting_action\": {\n                            \"term\": {\n                                \"key\": \"failed_login\"\n                            }   \n                        }\n                    }\n                } \n            } \n        } \n    } \n}\n```\n\nWould limit the results to only the interested data\n\n```\n  \"aggregations\" : {\n    \"unique_users\" : {\n      \"buckets\" : [ {\n        \"key\" : \"user1@example.org\",\n        \"doc_count\" : 5,\n        \"action_totals\" : {\n          \"buckets\" : [ {\n            \"key\" : \"failed_login\",\n            \"doc_count\" : 5\n          } ]\n        }\n      }, {\n        \"key\" : \"user2@example.org\",\n        \"doc_count\" : 3,\n        \"action_totals\" : {\n          \"buckets\" : [ {\n            \"key\" : \"failed_login\",\n            \"doc_count\" : 3\n          } ]\n        }\n      },\n```\n\nThis new way of aggregating and limiting does not require a parent-child relationship between the user and the log document types and only requires searching the log type documents to produce the desired results.\n\nNote that the original top-level aggregations have new doc_count values.  Child-aggregates can be thought to be only limiting actions - never creating new buckets (as that is the role of sub-aggregates already).  Their output can replace the parent aggregate's entire result.\n\nLimitations:  child-aggregates must only be run after all information in the parent aggregate has been collected.  Any aggregate that has a limiting child-aggregate would not be allowed to have sub-aggregates, because changing the parent's meta-information would cause discontinuity with the sub-aggregation buckets.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}