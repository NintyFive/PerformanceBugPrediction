{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18412","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18412/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18412/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18412/events","html_url":"https://github.com/elastic/elasticsearch/issues/18412","id":155287301,"node_id":"MDU6SXNzdWUxNTUyODczMDE=","number":18412,"title":"Clarification on filtered nested aggregation operation","user":{"login":"PhaedrusTheGreek","id":4387023,"node_id":"MDQ6VXNlcjQzODcwMjM=","avatar_url":"https://avatars0.githubusercontent.com/u/4387023?v=4","gravatar_id":"","url":"https://api.github.com/users/PhaedrusTheGreek","html_url":"https://github.com/PhaedrusTheGreek","followers_url":"https://api.github.com/users/PhaedrusTheGreek/followers","following_url":"https://api.github.com/users/PhaedrusTheGreek/following{/other_user}","gists_url":"https://api.github.com/users/PhaedrusTheGreek/gists{/gist_id}","starred_url":"https://api.github.com/users/PhaedrusTheGreek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PhaedrusTheGreek/subscriptions","organizations_url":"https://api.github.com/users/PhaedrusTheGreek/orgs","repos_url":"https://api.github.com/users/PhaedrusTheGreek/repos","events_url":"https://api.github.com/users/PhaedrusTheGreek/events{/privacy}","received_events_url":"https://api.github.com/users/PhaedrusTheGreek/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":1967497573,"node_id":"MDU6TGFiZWwxOTY3NDk3NTcz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Docs","name":"Team:Docs","color":"fef2c0","default":false,"description":"Meta label for docs team"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-05-17T15:20:42Z","updated_at":"2020-07-31T16:53:07Z","closed_at":"2020-07-31T16:53:07Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Some clarification would be of use in mixing nested filters with nested aggregations.  \n\nHere is an example of how the confusion might arise:\n\n```\nPOST /my_index\n{\n   \"mappings\": {\n      \"my_type\": {\n         \"properties\": {\n            \"NESTED_FIELD\": {\n               \"type\": \"nested\",\n               \"include_in_parent\": true,\n               \"properties\": {\n                  \"SOME_FIELD\": {\n                     \"type\": \"integer\",\n                     \"doc_values\": true\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nPost some sample data:\n\n```\nPOST /my_index/my_type/\n{\n   \"NESTED_FIELD\": [\n      {\n         \"SOME_FIELD\": 1718570\n      }\n   ]\n}\n\n\nPOST /my_index/my_type/\n{\n   \"NESTED_FIELD\": [\n      {\n         \"SOME_FIELD\": 1718567\n      },\n      {\n         \"SOME_FIELD\": 1718565\n      },\n      {\n         \"SOME_FIELD\": 1718571\n      },\n      {\n         \"SOME_FIELD\": 1718568\n      },\n      {\n         \"SOME_FIELD\": 1718570\n      },\n      {\n         \"SOME_FIELD\": 1718569\n      },\n      {\n         \"SOME_FIELD\": 1718566\n      }\n   ]\n}\n```\n\nThis query looks like it should filter aggs by  `\"NESTED_FIELD.SOME_FIELD\": \"1718565\"`, but the filter has no effect.\n\n```\nGET my_index/_search?size=0\n{\n  \"aggs\": {\n    \"baseFilterAggs\": {\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"NESTED_FIELD\",\n          \"filter\": {\n            \"term\": {\n              \"NESTED_FIELD.SOME_FIELD\": \"1718565\"\n            }\n          }\n        }\n      },\n      \"aggs\": {\n        \"nestedLocId\": {\n          \"nested\": {\n            \"path\": \"NESTED_FIELD\"\n          },\n          \"aggs\": {\n            \"locIdTerms\": {\n              \"terms\": {\n                \"field\": \"NESTED_FIELD.SOME_FIELD\",\n                \"size\": 0\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nWhen written like this, it works as expected:\n\n```\nGET my_index/_search?size=0\n{\n  \"aggs\": {\n    \"nestedAggs\": {\n      \"nested\": {\n        \"path\": \"NESTED_FIELD\"\n      },\n      \"aggs\": {\n        \"hhhhhhh\": {\n          \"filter\": {\n            \"term\": {\n              \"NESTED_FIELD.SOME_FIELD\": \"1718565\"\n            }\n          },\n          \"aggs\": {\n            \"locIdTerms\": {\n              \"terms\": {\n                \"field\": \"NESTED_FIELD.SOME_FIELD\",\n                \"size\": 0\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nto quote @jpountz :\n\n> In the first query, the filter keeps root documents that have at leas one nested document that matches the query. Since the 2nd root document has one nested document that matches, it is selected. Then we run the nested aggregation, which can see all nested docs of this root document.\n> \n> On the other hand the second query first goes to the nested documents, and then only keeps those that match the filter, so there is only one bucket: the one that matches the filter.\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}