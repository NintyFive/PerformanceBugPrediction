{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162/events","html_url":"https://github.com/elastic/elasticsearch/issues/44162","id":466266301,"node_id":"MDU6SXNzdWU0NjYyNjYzMDE=","number":44162,"title":"Range aggregation nested in a filter aggregation yields non-filtered records","user":{"login":"dinamic","id":11616,"node_id":"MDQ6VXNlcjExNjE2","avatar_url":"https://avatars0.githubusercontent.com/u/11616?v=4","gravatar_id":"","url":"https://api.github.com/users/dinamic","html_url":"https://github.com/dinamic","followers_url":"https://api.github.com/users/dinamic/followers","following_url":"https://api.github.com/users/dinamic/following{/other_user}","gists_url":"https://api.github.com/users/dinamic/gists{/gist_id}","starred_url":"https://api.github.com/users/dinamic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinamic/subscriptions","organizations_url":"https://api.github.com/users/dinamic/orgs","repos_url":"https://api.github.com/users/dinamic/repos","events_url":"https://api.github.com/users/dinamic/events{/privacy}","received_events_url":"https://api.github.com/users/dinamic/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-07-10T11:56:22Z","updated_at":"2019-07-12T13:42:56Z","closed_at":"2019-07-10T19:50:47Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.6.13 via docker image (docker.elastic.co/elasticsearch/elasticsearch)\r\n\r\n**Plugins installed**: default setup with x-pack enabled\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\nsh-4.2$ java -version\r\nopenjdk version \"1.8.0_191\"\r\nOpenJDK Runtime Environment (build 1.8.0_191-b12)\r\nOpenJDK 64-Bit Server VM (build 25.191-b12, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nDocker Desktop Edge 2.0.5.0 running on macOS 10.14.5\r\n\r\n```\r\nsh-4.2$ uname -a\r\nLinux 0f12147f0d69 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\nI am trying to use a range aggregation nested in a filter one. The filter contains a term query to discriminate on the status field that we've got. The range aggregation operates in a nested document.\r\n\r\nThe issue that I am running into is that the range aggregation returns documents that should have been discriminated by the filter aggregation earlier.\r\n\r\nI have been looking around whether this is expected behavior but was unable to find any relevant information.\r\n\r\nCould you please tell me if this is a bug or am I doing something wrong?\r\n\r\nHere's the query I'm trying to use: [github_example_query.txt](https://github.com/elastic/elasticsearch/files/3377281/github_example_query.txt). You could see that I filter by `status = completed`, yet the range aggregation gives me records that have their `status` field set to other values.\r\n\r\n\r\n\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}