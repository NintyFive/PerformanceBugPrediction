[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/640486139","html_url":"https://github.com/elastic/elasticsearch/issues/57624#issuecomment-640486139","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624","id":640486139,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MDQ4NjEzOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-06-08T09:27:43Z","updated_at":"2020-06-08T09:27:43Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/641592064","html_url":"https://github.com/elastic/elasticsearch/issues/57624#issuecomment-641592064","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624","id":641592064,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MTU5MjA2NA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2020-06-09T21:29:01Z","updated_at":"2020-06-09T21:29:01Z","author_association":"MEMBER","body":"Are you sure of the timing difference ?  What happens if you run the same query several times, are you still seing a 10x diff ? That shouldn't be the case since you have an aggregation in your request so we should evaluate the same number of docs no  matter what the value of `track_total_hits` is.  I also don't think that your pr changes anything https://github.com/elastic/elasticsearch/pull/57772, the handling of `terminate_after` is done [here](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java#L223) and we set the `forceTermination` to true.\r\nSo something is odd in your reproduction, can  you share the entire boolean query that you're running ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/644986710","html_url":"https://github.com/elastic/elasticsearch/issues/57624#issuecomment-644986710","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624","id":644986710,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NDk4NjcxMA==","user":{"login":"travisby","id":133506,"node_id":"MDQ6VXNlcjEzMzUwNg==","avatar_url":"https://avatars0.githubusercontent.com/u/133506?v=4","gravatar_id":"","url":"https://api.github.com/users/travisby","html_url":"https://github.com/travisby","followers_url":"https://api.github.com/users/travisby/followers","following_url":"https://api.github.com/users/travisby/following{/other_user}","gists_url":"https://api.github.com/users/travisby/gists{/gist_id}","starred_url":"https://api.github.com/users/travisby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/travisby/subscriptions","organizations_url":"https://api.github.com/users/travisby/orgs","repos_url":"https://api.github.com/users/travisby/repos","events_url":"https://api.github.com/users/travisby/events{/privacy}","received_events_url":"https://api.github.com/users/travisby/received_events","type":"User","site_admin":false},"created_at":"2020-06-16T20:10:47Z","updated_at":"2020-06-16T20:10:47Z","author_association":"NONE","body":"I still see roughly a 10x diff even after a few reruns.  \r\n\r\nThe boolean query is empty.  I believe that's the actual query kibana runs to search for its autocomplete.\r\n\r\nOur non-redacted query that reproduces:\r\n\r\n```\r\nPOST /*apps-*/_search?request_cache=false\r\n{\r\n  \"size\": 0,\r\n  \"timeout\": \"1000ms\",\r\n  \"terminate_after\": \"100000\",\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": []\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"suggestions\": {\r\n      \"terms\": {\r\n        \"field\": \"app.keyword\",\r\n        \"include\": \".*\",\r\n        \"execution_hint\": \"map\",\r\n        \"shard_size\": 10\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAnd\r\n\r\n```\r\nPOST /*apps-*/_search?request_cache=false\r\n{\r\n  \"size\": 0,\r\n  \"timeout\": \"1000ms\",\r\n  \"terminate_after\": \"100000\",\r\n  \"track_total_hits\": true,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": []\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"suggestions\": {\r\n      \"terms\": {\r\n        \"field\": \"app.keyword\",\r\n        \"include\": \".*\",\r\n        \"execution_hint\": \"map\",\r\n        \"shard_size\": 10\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nFor each query, I fired off three requests serially (~5s downtime in between or so, human speed)\r\nAnd the timings we received were:\r\n\r\nfirst query: 24147ms, 21307ms, 23462ms all with `terminated_early: false`\r\nsecond query: 3772ms, 3822ms, 1361ms\r\n\r\n(So, not quite 10x but close enough)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/645011658","html_url":"https://github.com/elastic/elasticsearch/issues/57624#issuecomment-645011658","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624","id":645011658,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NTAxMTY1OA==","user":{"login":"travisby","id":133506,"node_id":"MDQ6VXNlcjEzMzUwNg==","avatar_url":"https://avatars0.githubusercontent.com/u/133506?v=4","gravatar_id":"","url":"https://api.github.com/users/travisby","html_url":"https://github.com/travisby","followers_url":"https://api.github.com/users/travisby/followers","following_url":"https://api.github.com/users/travisby/following{/other_user}","gists_url":"https://api.github.com/users/travisby/gists{/gist_id}","starred_url":"https://api.github.com/users/travisby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/travisby/subscriptions","organizations_url":"https://api.github.com/users/travisby/orgs","repos_url":"https://api.github.com/users/travisby/repos","events_url":"https://api.github.com/users/travisby/events{/privacy}","received_events_url":"https://api.github.com/users/travisby/received_events","type":"User","site_admin":false},"created_at":"2020-06-16T21:05:44Z","updated_at":"2020-06-16T21:05:44Z","author_association":"NONE","body":"For #57772 I included the whole reproduction (although there isn't any interesting timing difference since the sample size is so small, I think it's helpful to look at the `timed_out` vs `terminated_after` results and how they change).\r\n\r\nAfter looking at the LOC you pointed out I'm.. surprised that my fix works, but the results seem to show the fix. I'll try to dig in and see why a bit more","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/645054252","html_url":"https://github.com/elastic/elasticsearch/issues/57624#issuecomment-645054252","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57624","id":645054252,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NTA1NDI1Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2020-06-16T23:03:03Z","updated_at":"2020-06-16T23:03:03Z","author_association":"MEMBER","body":"Thanks @travisby, I was able to reproduce the issue and opened a [pr](https://github.com/elastic/elasticsearch/pull/58212) for the fix. Your assumption is correct, `terminate_after` is not handled correctly on requests that set the size to 0 and `track_total_hits` to a value smaller than `terminate_after`. In such case we early terminate the tracking of total hits but that also removes the checks for `terminate_after`. \r\nAs you already figured out, the workaround until the fix is released is to set `track_total_hits` to `true` in the search request. ","performed_via_github_app":null}]