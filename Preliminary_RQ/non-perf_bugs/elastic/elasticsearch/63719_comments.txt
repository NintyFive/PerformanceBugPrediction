[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/709018959","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-709018959","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":709018959,"node_id":"MDEyOklzc3VlQ29tbWVudDcwOTAxODk1OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-10-15T09:05:32Z","updated_at":"2020-10-15T09:05:32Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/709023611","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-709023611","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":709023611,"node_id":"MDEyOklzc3VlQ29tbWVudDcwOTAyMzYxMQ==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-10-15T09:11:13Z","updated_at":"2020-10-15T09:11:13Z","author_association":"CONTRIBUTOR","body":"I have not investigated this from core/infra perspective yet, but looks like \r\n            assertEquals(1712879236854775807L, hits.getAt(0).getSortValues()[0]);\r\nis expected.\r\n That epoch milli is equal to `+54280952-03-25T07:12:55.807Z`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/709025087","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-709025087","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":709025087,"node_id":"MDEyOklzc3VlQ29tbWVudDcwOTAyNTA4Nw==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2020-10-15T09:13:01Z","updated_at":"2020-10-15T09:13:01Z","author_association":"CONTRIBUTOR","body":"also the assertion seems to be almost right\r\n```\r\n            assertThat(exc.toString(), containsString(\"are after 2262\"));\r\n```\r\nsomehow it is singular in the exception thrown\r\n```\r\n is after 2262\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/710149035","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-710149035","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":710149035,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMDE0OTAzNQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-10-16T16:07:17Z","updated_at":"2020-10-16T16:07:33Z","author_association":"MEMBER","body":"Just see another one today:\r\nhttps://gradle-enterprise.elastic.co/s/7xvxfqm7dglsc\r\n\r\ngradlew ':server:internalClusterTest' --tests \"org.elasticsearch.search.sort.FieldSortIT.testCastDate\" \\\r\n  -Dtests.seed=D6B25B5CCFB81908 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=fr \\\r\n  -Dtests.timezone=Etc/GMT+5 \\\r\n  -Druntime.java=11\r\n\r\n\r\n```\r\njava.lang.AssertionError: \r\nExpected: a string containing \"are before the epoch in 1970\"\r\n     but: was \"Failed to execute phase [query], Partial shards failure; shardFailures {[X_u_7958Stitjf_XrN6GaQ][index_date_nanos][0]: org.elasticsearch.transport.RemoteTransportException: [node_s0][127.0.0.1:53643][indices:data/read/search[phase/query]]\r\nCaused by: java.lang.IllegalArgumentException: date[+54280952-03-25T07:12:55.807Z] is after 2262-04-11T23:47:16.854775807 and cannot be stored in nanosecond resolution\r\n\tat org.elasticsearch.common.time.DateUtils.toLong(DateUtils.java:224)\r\n\tat org.elasticsearch.index.mapper.DateFieldMapper$Resolution$2.convert(DateFieldMapper.java:107)\r\n\tat org.elasticsearch.index.mapper.DateFieldMapper$DateFieldType.parseToLong(DateFieldMapper.java:431)\r\n\tat org.elasticsearch.index.mapper.DateFieldMapper$DateFieldType.isFieldWithinQuery(DateFieldMapper.java:462)\r\n\tat org.elasticsearch.search.sort.FieldSortBuilder.isBottomSortShardDisjoint(FieldSortBuilder.java:403)\r\n\tat org.elasticsearch.search.internal.ShardSearchRequest$RequestRewritable.rewrite(ShardSearchRequest.java:448)\r\n\tat org.elasticsearch.search.internal.ShardSearchRequest$RequestRewritable.rewrite(ShardSearchRequest.java:429)\r\n\tat org.elasticsearch.index.query.Rewriteable.rewrite(Rewriteable.java:68)\r\n\tat org.elasticsearch.search.SearchService.canMatch(SearchService.java:1183)\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:392)\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:383)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/712871570","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-712871570","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":712871570,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMjg3MTU3MA==","user":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T13:57:38Z","updated_at":"2020-10-20T13:57:38Z","author_association":"CONTRIBUTOR","body":"I saw this fail on a community PR I'm reviewing:\r\nhttps://gradle-enterprise.elastic.co/s/dbjq6ynusikvs\r\n\r\n```\r\n ./gradlew ':server:internalClusterTest' --tests \"org.elasticsearch.search.sort.FieldSortIT.testCastDate\"\r\n -Dtests.seed=3B88E397C70F0E35\r\n -Dtests.security.manager=true\r\n -Dtests.locale=en\r\n -Dtests.timezone=America/Caracas\r\n -Druntime.java=11\r\n```\r\n\r\nIt did not reproduce locally against master for me with that command.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713091730","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-713091730","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":713091730,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzA5MTczMA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T19:34:51Z","updated_at":"2020-10-20T19:34:51Z","author_association":"CONTRIBUTOR","body":"There seems to be a timing issue here. If I add the seed to the test and debug into the method and take my time when I step over stuff it works. But if I just run it then it doesn't.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713097141","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-713097141","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":713097141,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzA5NzE0MQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T19:45:25Z","updated_at":"2020-10-20T19:45:25Z","author_association":"CONTRIBUTOR","body":"I think this comes because the \"bottom\" sort values from other shards are in millis and the field that has nanos gets confused.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/714407706","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-714407706","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":714407706,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNDQwNzcwNg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-10-22T10:47:21Z","updated_at":"2020-10-22T10:47:21Z","author_association":"MEMBER","body":"I checked the time frame when this error started to appear quite frequently on master and found https://github.com/elastic/elasticsearch/pull/63520 which would fit also because it wasn't backported to 7.11 yet (failures currently only on master), its related to shard exception and the test that fails uses \"setAllowPartialSearchResults(false)\" for the request. I will continue digging.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/714554809","html_url":"https://github.com/elastic/elasticsearch/issues/63719#issuecomment-714554809","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63719","id":714554809,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNDU1NDgwOQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-10-22T15:00:08Z","updated_at":"2020-10-22T15:00:08Z","author_association":"MEMBER","body":"This indeed seems a race between which shard exceptions get thrown first. Before #63520 we'd get two types of exceptions, namely\r\n* '-2042496763000] are before the epoch in 1970 and cannot be converted to nanoseconds' from 'index_date'  which is happening when trying to convert the query date \"1905-...\" to nanoseconds\r\n* [+54280952-03-25T07:12:55.807Z] is after 2262-04-11T23:47:16.854775807 and cannot be stored in nanosecond resolution' from 'index_date_nanos' which happens already when rewriting the request in FieldSortBuilder#isBottomSortShardDisjoint\r\n\r\nBefore #63520 we would always get both exceptions, so the check for the first type that the test expects always succeeds. With #63520 we can get unlucky and the task is cancelled before the expected exception is thrown (due to the other shard exception)\r\n\r\nI'm currently looking at the way FieldSortBuilder#isBottomSortShardDisjoint is supposed to behave on empty shards with nanos, since using Long.MAX_VALUE as an upper limit here doesn't seem to be right in the first place.","performed_via_github_app":null}]