{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5590","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5590/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5590/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5590/events","html_url":"https://github.com/elastic/elasticsearch/issues/5590","id":30370213,"node_id":"MDU6SXNzdWUzMDM3MDIxMw==","number":5590,"title":"IllegalAccessError after a few queries when using script filter in elasticsearch query","user":{"login":"jeroenr","id":332726,"node_id":"MDQ6VXNlcjMzMjcyNg==","avatar_url":"https://avatars1.githubusercontent.com/u/332726?v=4","gravatar_id":"","url":"https://api.github.com/users/jeroenr","html_url":"https://github.com/jeroenr","followers_url":"https://api.github.com/users/jeroenr/followers","following_url":"https://api.github.com/users/jeroenr/following{/other_user}","gists_url":"https://api.github.com/users/jeroenr/gists{/gist_id}","starred_url":"https://api.github.com/users/jeroenr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeroenr/subscriptions","organizations_url":"https://api.github.com/users/jeroenr/orgs","repos_url":"https://api.github.com/users/jeroenr/repos","events_url":"https://api.github.com/users/jeroenr/events{/privacy}","received_events_url":"https://api.github.com/users/jeroenr/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2014-03-28T08:33:22Z","updated_at":"2014-12-30T14:54:13Z","closed_at":"2014-12-30T14:54:13Z","author_association":"NONE","active_lock_reason":null,"body":"I have a 'users' elasticsearch index, where a user looks like:\n\n```\n{\n  \"id\" : 1,\n  \"name\" : \"Jeroen\",\n  \"hours\": [8,9,10,11,12,19,20,21,22,23],\n  \"country\": \"NL\",\n  \"utc_offset\": 1.0\n}\n```\n\nI want to find all users of which the 'hours' field contains the current hour in their local time. So for example, I only want to find the above user when it's between 8.00-12.00 or 20.00-23.00 in the Netherlands.\n\nMy solution for this is using a script filter. I didn't know how to implement this with MVEL, so I installed the javascript plugin. Now my query looks like this:\n\n```\n{\n  \"query\": {\n    \"match_all\": {}\n  },\"filter\": {\n    \"script\": {\n       \"script\": \"var a = doc['hours'].values; var d = new Date(); d.setTime(d.getTime() + doc['utc_offset'].value * 3600 * 1000); a.indexOf('' + d.getHours()) != -1\",\n       \"params\": {}\n    }\n  }\n}\n```\n\nSo this works, but after a while elasticsearch is starting to throw exceptions, like this:\n\n```\n{\n  \"error\": \"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[x9FlNmmsT26hJbrfnyH2uA][users][2]: QueryPhaseExecutionException[[users][2]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: IllegalAccessError[org/elasticsearch/index/fielddata/ScriptDocValues$Strings$1]; }{[x9FlNmmsT26hJbrfnyH2uA][users][3]: QueryPhaseExecutionException[[users][3]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: IllegalAccessError[org/elasticsearch/index/fielddata/ScriptDocValues$Strings$1]; }{[x9FlNmmsT26hJbrfnyH2uA][users][0]: QueryPhaseExecutionException[[users][0]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: IllegalAccessError[org/elasticsearch/index/fielddata/ScriptDocValues$Strings$1]; }{[x9FlNmmsT26hJbrfnyH2uA][users][2]: QueryPhaseExecutionException[[users][3]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: IllegalAccessError[org/elasticsearch/index/fielddata/ScriptDocValues$Strings$1]; }{[x9FlNmmsT26hJbrfnyH2uA][users][4]: QueryPhaseExecutionException[[users][4]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: IllegalAccessError[org/elasticsearch/index/fielddata/ScriptDocValues$Strings$1]; }]\",\n\"status\": 500\n}\n```\n\nA similar issue (#3094) was posted where it was suggested it's a problem with the JIT compiler. As a workaround it was suggested to disable it by using '-Dmvel2.disable.jit=true'. I've tried this, by putting it in ES_JAVA_OPTS in /etc/default/elasticsearch but it didn't seem to have any effect.\n\nWhat am I doing wrong? Or is there an alternative way of performing this query?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}