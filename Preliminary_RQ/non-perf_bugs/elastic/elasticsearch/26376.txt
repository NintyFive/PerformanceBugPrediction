{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26376/events","html_url":"https://github.com/elastic/elasticsearch/issues/26376","id":252778892,"node_id":"MDU6SXNzdWUyNTI3Nzg4OTI=","number":26376,"title":"Bucket_scripts about nested.field will lead Java elasticsearch exception in Some situations","user":{"login":"anhzhi","id":4339562,"node_id":"MDQ6VXNlcjQzMzk1NjI=","avatar_url":"https://avatars2.githubusercontent.com/u/4339562?v=4","gravatar_id":"","url":"https://api.github.com/users/anhzhi","html_url":"https://github.com/anhzhi","followers_url":"https://api.github.com/users/anhzhi/followers","following_url":"https://api.github.com/users/anhzhi/following{/other_user}","gists_url":"https://api.github.com/users/anhzhi/gists{/gist_id}","starred_url":"https://api.github.com/users/anhzhi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anhzhi/subscriptions","organizations_url":"https://api.github.com/users/anhzhi/orgs","repos_url":"https://api.github.com/users/anhzhi/repos","events_url":"https://api.github.com/users/anhzhi/events{/privacy}","received_events_url":"https://api.github.com/users/anhzhi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-08-25T02:06:07Z","updated_at":"2017-11-01T09:23:08Z","closed_at":"2017-08-25T07:28:43Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\r\n\"number\": \"5.3.1\",\r\n\"build_hash\": \"5f9cf58\",\r\n\"build_date\": \"2017-04-17T15:52:53.846Z\",\r\n\"build_snapshot\": false,\r\n\"lucene_version\": \"6.4.2\"\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_45\"\r\n\r\n**OS version** :\r\nUbuntu 14.04.5 LTS\r\nLinux 3.19.0-26-generic #28~14.04.1-Ubuntu SMP\r\n\r\n**Steps to reproduce**:\r\ncc-gossip-test-2017.08.24 is a time-series index with nested path:  snmp.ifXTableStats and snmp.ifXTableStats\r\n```\r\nGET /cc-gossip-test-2017.08.24/_mapping\r\n{\r\n   \"cc-gossip-test-2017.08.24\": {\r\n      \"mappings\": {\r\n         \"_default_\": {\r\n            \"dynamic_templates\": [\r\n               {\r\n                  \"ip_fields\": {\r\n                     \"match\": \"*_ip\",\r\n                     \"match_mapping_type\": \"string\",\r\n                     \"mapping\": {\r\n                        \"type\": \"ip\"\r\n                     }\r\n                  }\r\n               },\r\n               {\r\n                  \"string_fields\": {\r\n                     \"match\": \"*\",\r\n                     \"match_mapping_type\": \"string\",\r\n                     \"mapping\": {\r\n                        \"index\": \"not_analyzed\",\r\n                        \"omit_norms\": true,\r\n                        \"type\": \"string\"\r\n                     }\r\n                  }\r\n               }\r\n            ],\r\n            \"properties\": {\r\n               \"@timestamp\": {\r\n                  \"type\": \"date\"\r\n               }\r\n            }\r\n         },\r\n         \"snmp\": {\r\n            \"dynamic_templates\": [\r\n               {\r\n                  \"ip_fields\": {\r\n                     \"match\": \"*_ip\",\r\n                     \"match_mapping_type\": \"string\",\r\n                     \"mapping\": {\r\n                        \"type\": \"ip\"\r\n                     }\r\n                  }\r\n               },\r\n               {\r\n                  \"string_fields\": {\r\n                     \"match\": \"*\",\r\n                     \"match_mapping_type\": \"string\",\r\n                     \"mapping\": {\r\n                        \"index\": \"not_analyzed\",\r\n                        \"omit_norms\": true,\r\n                        \"type\": \"string\"\r\n                     }\r\n                  }\r\n               }\r\n            ],\r\n            \"properties\": {\r\n               \"@timestamp\": {\r\n                  \"type\": \"date\"\r\n               },\r\n               \"appname\": {\r\n                  \"type\": \"keyword\"\r\n               },\r\n               \"guid\": {\r\n                  \"type\": \"keyword\"\r\n               },\r\n               \"snmp\": {\r\n                  \"properties\": {\r\n                     \"CpuUtilization\": {\r\n                        \"type\": \"long\"\r\n                     },\r\n                     \"MachineIP\": {\r\n                        \"type\": \"keyword\"\r\n                     },\r\n                     \"MemUtilization\": {\r\n                        \"type\": \"long\"\r\n                     },\r\n                     \"PingStats\": {\r\n                        \"type\": \"boolean\"\r\n                     },\r\n                     \"SysDescr\": {\r\n                        \"type\": \"keyword\"\r\n                     },\r\n                     \"SysModel\": {\r\n                        \"type\": \"keyword\"\r\n                     },\r\n                     \"SysName\": {\r\n                        \"type\": \"keyword\"\r\n                     },\r\n                     \"SysUpTime\": {\r\n                        \"type\": \"keyword\"\r\n                     },\r\n                     \"SysVendor\": {\r\n                        \"type\": \"keyword\"\r\n                     },\r\n                     \"ifTableStats\": {\r\n                        \"type\": \"nested\",\r\n                        \"properties\": {\r\n                           \"ifInDiscards\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifName\": {\r\n                              \"type\": \"keyword\"\r\n                           },\r\n                           \"ifOperStatus\": {\r\n                              \"type\": \"long\"\r\n                           }\r\n                        }\r\n                     },\r\n                     \"ifXTableStats\": {\r\n                        \"type\": \"nested\",\r\n                        \"properties\": {\r\n                           \"ifHCInBroadcastPkts\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCInMulticast\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCInOid\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCInPkts\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCOutBroadcastPkts\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCOutMulticastPkts\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCOutOid\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifHCOutPkts\": {\r\n                              \"type\": \"long\"\r\n                           },\r\n                           \"ifName\": {\r\n                              \"type\": \"keyword\"\r\n                           }\r\n                        }\r\n                     }\r\n                  }\r\n               },\r\n               \"tags\": {\r\n                  \"type\": \"keyword\"\r\n               },\r\n               \"type\": {\r\n                  \"type\": \"keyword\"\r\n               }\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n\r\nGET /cc-gossip-test-2017.08.24/_search?size=1\r\n{\r\n   \"took\": 1798,\r\n   \"timed_out\": false,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 5,\r\n      \"failed\": 0\r\n   },\r\n   \"hits\": {\r\n      \"total\": 30400,\r\n      \"max_score\": 1,\r\n      \"hits\": [\r\n         {\r\n            \"_index\": \"cc-gossip-test-2017.08.24\",\r\n            \"_type\": \"snmp\",\r\n            \"_id\": \"AV4TCrbADEKu3Ndpt8QU\",\r\n            \"_score\": 1,\r\n            \"_source\": {\r\n               \"tags\": [\r\n                  \"192.168.10.40\",\r\n                  \"snmp\",\r\n                  \"test\"\r\n               ],\r\n               \"@timestamp\": 1503558022122,\r\n               \"appname\": \"gossip\",\r\n               \"snmp\": {\r\n                  \"SysVendor\": \"Hillstone\",\r\n                  \"MemUtilization\": 11,\r\n                  \"CpuUtilization\": 2,\r\n                  \"SysDescr\": \"Hillstone Security Appliance SG-6000-E5960\",\r\n                  \"SysName\": \"YOUFU-JR-FW-E5960-2\",\r\n                  \"ifXTableStats\": [\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 321,\r\n                        \"ifHCInPkts\": 811365,\r\n                        \"ifHCInBroadcastPkts\": 759,\r\n                        \"ifHCInMulticast\": 871,\r\n                        \"ifHCInOid\": 356495,\r\n                        \"ifName\": \"vswitchif1\",\r\n                        \"ifHCOutPkts\": 548666,\r\n                        \"ifHCOutOid\": 661142,\r\n                        \"ifHCOutBroadcastPkts\": 612\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 839,\r\n                        \"ifHCInPkts\": 272703,\r\n                        \"ifHCInBroadcastPkts\": 121,\r\n                        \"ifHCInMulticast\": 130,\r\n                        \"ifHCInOid\": 680241,\r\n                        \"ifName\": \"ethernet0/0\",\r\n                        \"ifHCOutPkts\": 667500,\r\n                        \"ifHCOutOid\": 498357,\r\n                        \"ifHCOutBroadcastPkts\": 514\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 141,\r\n                        \"ifHCInPkts\": 897571,\r\n                        \"ifHCInBroadcastPkts\": 891,\r\n                        \"ifHCInMulticast\": 963,\r\n                        \"ifHCInOid\": 890749,\r\n                        \"ifName\": \"ethernet0/1\",\r\n                        \"ifHCOutPkts\": 392301,\r\n                        \"ifHCOutOid\": 465144,\r\n                        \"ifHCOutBroadcastPkts\": 966\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 154,\r\n                        \"ifHCInPkts\": 905458,\r\n                        \"ifHCInBroadcastPkts\": 875,\r\n                        \"ifHCInMulticast\": 444,\r\n                        \"ifHCInOid\": 775080,\r\n                        \"ifName\": \"ethernet0/2\",\r\n                        \"ifHCOutPkts\": 577087,\r\n                        \"ifHCOutOid\": 203788,\r\n                        \"ifHCOutBroadcastPkts\": 333\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 410,\r\n                        \"ifHCInPkts\": 196321,\r\n                        \"ifHCInBroadcastPkts\": 193,\r\n                        \"ifHCInMulticast\": 250,\r\n                        \"ifHCInOid\": 251012,\r\n                        \"ifName\": \"ethernet0/3\",\r\n                        \"ifHCOutPkts\": 634786,\r\n                        \"ifHCOutOid\": 466457,\r\n                        \"ifHCOutBroadcastPkts\": 947\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 834,\r\n                        \"ifHCInPkts\": 902,\r\n                        \"ifHCInBroadcastPkts\": 844,\r\n                        \"ifHCInMulticast\": 727,\r\n                        \"ifHCInOid\": 736986,\r\n                        \"ifName\": \"ethernet0/4\",\r\n                        \"ifHCOutPkts\": 309988,\r\n                        \"ifHCOutOid\": 260248,\r\n                        \"ifHCOutBroadcastPkts\": 384\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 121,\r\n                        \"ifHCInPkts\": 937043,\r\n                        \"ifHCInBroadcastPkts\": 957,\r\n                        \"ifHCInMulticast\": 633,\r\n                        \"ifHCInOid\": 973661,\r\n                        \"ifName\": \"ethernet0/5\",\r\n                        \"ifHCOutPkts\": 29120,\r\n                        \"ifHCOutOid\": 771836,\r\n                        \"ifHCOutBroadcastPkts\": 207\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 159,\r\n                        \"ifHCInPkts\": 280022,\r\n                        \"ifHCInBroadcastPkts\": 799,\r\n                        \"ifHCInMulticast\": 343,\r\n                        \"ifHCInOid\": 265569,\r\n                        \"ifName\": \"ethernet0/6\",\r\n                        \"ifHCOutPkts\": 834883,\r\n                        \"ifHCOutOid\": 912451,\r\n                        \"ifHCOutBroadcastPkts\": 802\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 598,\r\n                        \"ifHCInPkts\": 498934,\r\n                        \"ifHCInBroadcastPkts\": 591,\r\n                        \"ifHCInMulticast\": 251,\r\n                        \"ifHCInOid\": 151818,\r\n                        \"ifName\": \"ethernet0/7\",\r\n                        \"ifHCOutPkts\": 884749,\r\n                        \"ifHCOutOid\": 874863,\r\n                        \"ifHCOutBroadcastPkts\": 600\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 925,\r\n                        \"ifHCInPkts\": 765505,\r\n                        \"ifHCInBroadcastPkts\": 294,\r\n                        \"ifHCInMulticast\": 266,\r\n                        \"ifHCInOid\": 419455,\r\n                        \"ifName\": \"ethernet0/8\",\r\n                        \"ifHCOutPkts\": 889155,\r\n                        \"ifHCOutOid\": 18616,\r\n                        \"ifHCOutBroadcastPkts\": 131\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 847,\r\n                        \"ifHCInPkts\": 165705,\r\n                        \"ifHCInBroadcastPkts\": 865,\r\n                        \"ifHCInMulticast\": 347,\r\n                        \"ifHCInOid\": 455523,\r\n                        \"ifName\": \"ethernet0/9\",\r\n                        \"ifHCOutPkts\": 355353,\r\n                        \"ifHCOutOid\": 526783,\r\n                        \"ifHCOutBroadcastPkts\": 550\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 729,\r\n                        \"ifHCInPkts\": 662102,\r\n                        \"ifHCInBroadcastPkts\": 984,\r\n                        \"ifHCInMulticast\": 85,\r\n                        \"ifHCInOid\": 916364,\r\n                        \"ifName\": \"xethernet2/0\",\r\n                        \"ifHCOutPkts\": 355035,\r\n                        \"ifHCOutOid\": 483309,\r\n                        \"ifHCOutBroadcastPkts\": 463\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 426,\r\n                        \"ifHCInPkts\": 927963,\r\n                        \"ifHCInBroadcastPkts\": 762,\r\n                        \"ifHCInMulticast\": 421,\r\n                        \"ifHCInOid\": 727607,\r\n                        \"ifName\": \"xethernet2/1\",\r\n                        \"ifHCOutPkts\": 404410,\r\n                        \"ifHCOutOid\": 802485,\r\n                        \"ifHCOutBroadcastPkts\": 750\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 285,\r\n                        \"ifHCInPkts\": 782108,\r\n                        \"ifHCInBroadcastPkts\": 146,\r\n                        \"ifHCInMulticast\": 15,\r\n                        \"ifHCInOid\": 22182,\r\n                        \"ifName\": \"xethernet2/2\",\r\n                        \"ifHCOutPkts\": 507986,\r\n                        \"ifHCOutOid\": 75500,\r\n                        \"ifHCOutBroadcastPkts\": 35\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 888,\r\n                        \"ifHCInPkts\": 647820,\r\n                        \"ifHCInBroadcastPkts\": 229,\r\n                        \"ifHCInMulticast\": 145,\r\n                        \"ifHCInOid\": 422669,\r\n                        \"ifName\": \"xethernet2/3\",\r\n                        \"ifHCOutPkts\": 429870,\r\n                        \"ifHCOutOid\": 334679,\r\n                        \"ifHCOutBroadcastPkts\": 703\r\n                     },\r\n                     {\r\n                        \"ifHCOutMulticastPkts\": 991,\r\n                        \"ifHCInPkts\": 668256,\r\n                        \"ifHCInBroadcastPkts\": 338,\r\n                        \"ifHCInMulticast\": 362,\r\n                        \"ifHCInOid\": 389453,\r\n                        \"ifName\": \"aggregate1\",\r\n                        \"ifHCOutPkts\": 507659,\r\n                        \"ifHCOutOid\": 154418,\r\n                        \"ifHCOutBroadcastPkts\": 483\r\n                     }\r\n                  ],\r\n                  \"PingStats\": true,\r\n                  \"SysModel\": \"Hillstone\",\r\n                  \"ifTableStats\": [\r\n                     {\r\n                        \"ifInDiscards\": 4,\r\n                        \"ifName\": \"vswitchif1\",\r\n                        \"ifOperStatus\": 1\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 1,\r\n                        \"ifName\": \"ethernet0/0\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 2,\r\n                        \"ifName\": \"ethernet0/1\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 4,\r\n                        \"ifName\": \"ethernet0/2\",\r\n                        \"ifOperStatus\": 1\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 0,\r\n                        \"ifName\": \"ethernet0/3\",\r\n                        \"ifOperStatus\": 1\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 4,\r\n                        \"ifName\": \"ethernet0/4\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 3,\r\n                        \"ifName\": \"ethernet0/5\",\r\n                        \"ifOperStatus\": 1\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 6,\r\n                        \"ifName\": \"ethernet0/6\",\r\n                        \"ifOperStatus\": 1\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 7,\r\n                        \"ifName\": \"ethernet0/7\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 0,\r\n                        \"ifName\": \"ethernet0/8\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 6,\r\n                        \"ifName\": \"ethernet0/9\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 2,\r\n                        \"ifName\": \"xethernet2/0\",\r\n                        \"ifOperStatus\": 1\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 10,\r\n                        \"ifName\": \"xethernet2/1\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 5,\r\n                        \"ifName\": \"xethernet2/2\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 9,\r\n                        \"ifName\": \"xethernet2/3\",\r\n                        \"ifOperStatus\": 0\r\n                     },\r\n                     {\r\n                        \"ifInDiscards\": 4,\r\n                        \"ifName\": \"aggregate1\",\r\n                        \"ifOperStatus\": 0\r\n                     }\r\n                  ],\r\n                  \"SysUpTime\": \"113day 15h21m14s\",\r\n                  \"MachineIP\": \"192.168.254.76\"\r\n               },\r\n               \"guid\": \"test\",\r\n               \"type\": \"snmp\"\r\n            }\r\n         }\r\n      ]\r\n   }\r\n}\r\n```\r\nsnmp.ifXTableStats.ifHCInPkts is a nested field and in long data_type\r\nBucket_scripts about nested.field will lead Java elasticsearch exception in Some situations:\r\n\r\n```\r\nSearch Request:\r\nPOST /cc-gossip-test-2017.08.24/_search\r\n{\r\n   \"from\": 0,\r\n   \"aggs\": {\r\n      \"snmp.ifXTableStats\": {\r\n         \"aggs\": {\r\n            \"snmp.ifXTableStats\": {\r\n               \"filter\": {\r\n                  \"bool\": {\r\n                     \"must\": []\r\n                  }\r\n               },\r\n               \"aggs\": {\r\n                  \"cj6qal8gy00083c5ttt25sajj\": {\r\n                     \"bucket_script\": {\r\n                        \"buckets_path\": {\r\n                           \"_t_a5bd8820\": \"_t_a5bd8820\"\r\n                        },\r\n                        \"script\": {\r\n                           \"lang\": \"groovy\",\r\n                           \"inline\": \"_t_a5bd8820\"\r\n                        }\r\n                     }\r\n                  },\r\n                  \"_t_a5bd8820\": {\r\n                     \"avg\": {\r\n                        \"field\": \"snmp.ifXTableStats.ifHCInPkts\"\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         },\r\n         \"nested\": {\r\n            \"path\": \"snmp.ifXTableStats\"\r\n         }\r\n      }\r\n   },\r\n   \"size\": 0\r\n}\r\n\r\nSearch Response:\r\n{\r\n   \"error\": {\r\n      \"root_cause\": [],\r\n      \"type\": \"reduce_search_phase_exception\",\r\n      \"reason\": \"[reduce] \",\r\n      \"phase\": \"fetch\",\r\n      \"grouped\": true,\r\n      \"failed_shards\": [],\r\n      \"caused_by\": {\r\n         \"type\": \"class_cast_exception\",\r\n         \"reason\": \"org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\"\r\n      }\r\n   },\r\n   \"status\": 503\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n[2017-08-25T10:01:53,169][DEBUG][o.e.a.s.TransportSearchAction] [AmO7Hox] failed to reduce search\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: [reduce] \r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction$2.onFailure(AbstractSearchAsyncAction.java:548) [elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:623) [elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.3.1.jar:5.3.1]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_45]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_45]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_45]\r\nCaused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n        at org.elasticsearch.search.aggregations.pipeline.bucketscript.BucketScriptPipelineAggregator.reduce(BucketScriptPipelineAggregator.java:92) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:109) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.search.aggregations.bucket.InternalSingleBucketAggregation.doReduce(InternalSingleBucketAggregation.java:106) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:107) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:158) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.action.search.SearchPhaseController.merge(SearchPhaseController.java:518) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction$2.doRun(AbstractSearchAsyncAction.java:539) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.3.1.jar:5.3.1]\r\n        ... 3 more\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}