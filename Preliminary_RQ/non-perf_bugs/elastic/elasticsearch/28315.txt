{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28315","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28315/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28315/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28315/events","html_url":"https://github.com/elastic/elasticsearch/issues/28315","id":290068980,"node_id":"MDU6SXNzdWUyOTAwNjg5ODA=","number":28315,"title":"Percolator query not returning document that the query matches","user":{"login":"suresk","id":63801,"node_id":"MDQ6VXNlcjYzODAx","avatar_url":"https://avatars0.githubusercontent.com/u/63801?v=4","gravatar_id":"","url":"https://api.github.com/users/suresk","html_url":"https://github.com/suresk","followers_url":"https://api.github.com/users/suresk/followers","following_url":"https://api.github.com/users/suresk/following{/other_user}","gists_url":"https://api.github.com/users/suresk/gists{/gist_id}","starred_url":"https://api.github.com/users/suresk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/suresk/subscriptions","organizations_url":"https://api.github.com/users/suresk/orgs","repos_url":"https://api.github.com/users/suresk/repos","events_url":"https://api.github.com/users/suresk/events{/privacy}","received_events_url":"https://api.github.com/users/suresk/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2018-01-19T18:38:55Z","updated_at":"2018-03-06T09:37:33Z","closed_at":"2018-01-30T08:13:50Z","author_association":"NONE","active_lock_reason":null,"body":"**Bug Report**\r\n\r\n**Elasticsearch version:** 6.1.0 (it appears as though the behavior is the same in 6.0.1, too)\r\n\r\n**Plugins installed**: None that don't come out of the box.\r\n\r\n**JVM version:** 1.8.0_131\r\n\r\n**OS version:** macOS Sierra\r\n\r\n**Description of the problem including expected versus actual behavior**\r\n\r\nPercolator queries are not matching in instances that I expect them to. Playing around with the debugger, if I force it to skip the extract fields step for a query before it saves (which results in query.extraction_result = failed), subsequent attempts to use that percolated query work as expected. So, it seems possible that this is related to something in the path where queries are ruled out before being fully parsed/executed.\r\n\r\nI will include a query and a document below - when I index the document and then run the provided query against it, the document is found. When I add the same query to a percolator document and query the user against it, it is not found (unless I use a debugger and force it to not extract terms).\r\n\r\nI've had a tough time making sense of some of the code related to the extracted fields/terms, but I'm still trying to see if I can figure out where it is going wrong. Any pointers would be appreciated.\r\n\r\n**Steps to reproduce**\r\n\r\nThe first 3 steps are just meant to show that the percolator query should match by querying the document from the other direction first.\r\n\r\n1. Create a user index\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPUT http://localhost:9200/targeting-users -d '{\r\n  \"mappings\": {\r\n    \"user\": {\r\n      \"properties\": {\r\n        \"address\": {\r\n          \"properties\": {\r\n            \"city\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"country\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"countryId\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"postalCode\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"subdivision\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"subdivisionId\": {\r\n              \"type\": \"long\"\r\n            }\r\n          }\r\n        },\r\n        \"affiliations\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"expirationDate\": {\r\n              \"type\": \"date\",\r\n              \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n            },\r\n            \"location\": {\r\n              \"properties\": {\r\n                \"blockingBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"city\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"country\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"countryId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"description\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"id\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"indexTime\": {\r\n                  \"type\": \"date\",\r\n                  \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n                },\r\n                \"locationId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"orgId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"parentId\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"postalCode\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"subdivision\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"subdivisionId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"targetingLabels\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"teamId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"unverifiedBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"verifiedBrands\": {\r\n                  \"type\": \"long\"\r\n                }\r\n              }\r\n            },\r\n            \"org\": {\r\n              \"properties\": {\r\n                \"categories\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"indexId\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"indexTime\": {\r\n                  \"type\": \"date\",\r\n                  \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n                },\r\n                \"orgId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"orgName\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"type\": {\r\n                  \"type\": \"keyword\"\r\n                }\r\n              }\r\n            },\r\n            \"status\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"team\": {\r\n              \"properties\": {\r\n                \"approvedBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"blockedBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"blockingBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"categories\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"id\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"indexTime\": {\r\n                  \"type\": \"date\",\r\n                  \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n                },\r\n                \"industries\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"manualBrandApproval\": {\r\n                  \"type\": \"boolean\"\r\n                },\r\n                \"memberSegments\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"orgId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"parentId\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"positions\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"privateToImplicitTargeting\": {\r\n                  \"type\": \"boolean\"\r\n                },\r\n                \"teamId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"teamName\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"type\": {\r\n                  \"type\": \"keyword\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"age\": {\r\n          \"type\": \"integer\"\r\n        },\r\n        \"attributes\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"name\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"values\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"categories\": {\r\n          \"type\": \"long\"\r\n        },\r\n        \"expertRanks\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"categoryId\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"expirationDate\": {\r\n              \"type\": \"date\",\r\n              \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n            },\r\n            \"rank\": {\r\n              \"type\": \"integer\"\r\n            }\r\n          }\r\n        },\r\n        \"firstName\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"gender\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"indexTime\": {\r\n          \"type\": \"date\",\r\n          \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n        },\r\n        \"lastLogin\": {\r\n          \"type\": \"date\",\r\n          \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n        },\r\n        \"lastName\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"recommendedTo\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"orgId\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"rating\": {\r\n              \"type\": \"double\"\r\n            }\r\n          }\r\n        },\r\n        \"userId\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"userUuid\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"query\": {\r\n          \"type\": \"percolator\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n2. Index the user\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPUT http://localhost:9200/targeting-users/user/1 -d '{\r\n        \"userId\": 1,\r\n        \"userUuid\": \"XXXXXXXXXXXXXXXXX\",\r\n        \"firstName\": \"Test\",\r\n        \"lastName\": \"User\",\r\n        \"age\": 20,\r\n        \"gender\": \"MALE\",\r\n        \"address\": {\r\n            \"countryId\": 232,\r\n            \"country\": \"US\",\r\n            \"subdivisionId\": 4077,\r\n            \"subdivision\": \"UT\",\r\n            \"postalCode\": null,\r\n            \"city\": null\r\n        },\r\n        \"categories\": [\r\n            46,\r\n            185\r\n        ],\r\n        \"expertRanks\": [],\r\n        \"recommendedTo\": [],\r\n        \"affiliations\": [\r\n            {\r\n                \"org\": {\r\n                    \"type\": \"R\",\r\n                    \"orgId\": 1,\r\n                    \"orgName\": \"Test Company\",\r\n                    \"categories\": [\r\n                        49,\r\n                        177\r\n                    ],\r\n                    \"indexTime\": \"2018-01-04T06:00:26.212\"\r\n                },\r\n                \"team\": {\r\n                    \"type\": \"RETAIL\",\r\n                    \"teamId\": 5,\r\n                    \"teamName\": \"Test Team\",\r\n                    \"orgId\": 1,\r\n                    \"privateToImplicitTargeting\": false,\r\n                    \"manualBrandApproval\": false,\r\n                    \"approvedBrands\": [],\r\n                    \"blockedBrands\": [],\r\n                    \"blockingBrands\": [],\r\n                    \"positions\": [],\r\n                    \"categories\": [],\r\n                    \"memberSegments\": [],\r\n                    \"industries\": [],\r\n                    \"indexTime\": \"2018-01-04T06:00:26.212\"\r\n                },\r\n                \"location\": {\r\n                    \"locationId\": 10,\r\n                    \"teamId\": 5,\r\n                    \"orgId\": 1,\r\n                    \"description\": \"Test Location\",\r\n                    \"countryId\": 232,\r\n                    \"country\": \"US\",\r\n                    \"subdivisionId\": 4077,\r\n                    \"subdivision\": \"UT\",\r\n                    \"postalCode\": \"84111\",\r\n                    \"city\": \"Salt Lake City\",\r\n                    \"blockingBrands\": [\r\n                        2\r\n                    ],\r\n                    \"verifiedBrands\": [\r\n                        7\r\n                    ],\r\n                    \"unverifiedBrands\": [\r\n                        55,\r\n                        80\r\n                    ],\r\n                    \"targetingLabels\": [],\r\n                    \"indexTime\": \"2018-01-04T06:00:26.212\"\r\n                },\r\n                \"status\": \"ACTIVE\",\r\n                \"expirationDate\": null\r\n            }\r\n        ],\r\n        \"attributes\": [],\r\n        \"lastLogin\": null,\r\n        \"indexTime\": \"2018-01-04T06:00:26.180\"\r\n}'\r\n```\r\n\r\n3. Run the following query against the user index\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPOST http://localhost:9200/targeting-users/_search -d '{\r\n\"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"terms\": {\r\n                \"affiliations.team.type\": [\r\n                  \"RETAIL\",\r\n                  \"MANUFACTURER\",\r\n                  \"PARTNER\"\r\n                ],\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"should\": [\r\n                  {\r\n                    \"bool\": {\r\n                      \"must_not\": [\r\n                        {\r\n                          \"exists\": {\r\n                            \"field\": \"affiliations.expirationDate\",\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      ],\r\n                      \"disable_coord\": false,\r\n                      \"adjust_pure_negative\": true,\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  {\r\n                    \"range\": {\r\n                      \"affiliations.expirationDate\": {\r\n                        \"from\": \"now\",\r\n                        \"to\": null,\r\n                        \"include_lower\": true,\r\n                        \"include_upper\": true,\r\n                        \"boost\": 1\r\n                      }\r\n                    }\r\n                  }\r\n                ],\r\n                \"disable_coord\": false,\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"terms\": {\r\n                \"affiliations.status\": [\r\n                  \"ACTIVE\"\r\n                ],\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"filter\": [\r\n                  {\r\n                    \"terms\": {\r\n                      \"affiliations.team.type\": [\r\n                        \"RETAIL\",\r\n                        \"MANUFACTURER\",\r\n                        \"PARTNER\"\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  }\r\n                ],\r\n                \"disable_coord\": false,\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"bool\": {\r\n            \"should\": [\r\n              {\r\n                \"nested\": {\r\n                  \"query\": {\r\n                    \"terms\": {\r\n                      \"affiliations.location.countryId\": [\r\n                        232\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  \"path\": \"affiliations\",\r\n                  \"ignore_unmapped\": false,\r\n                  \"score_mode\": \"none\",\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            ],\r\n            \"disable_coord\": false,\r\n            \"adjust_pure_negative\": true,\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"bool\": {\r\n            \"should\": [\r\n              {\r\n                \"nested\": {\r\n                  \"query\": {\r\n                    \"terms\": {\r\n                      \"affiliations.location.verifiedBrands\": [\r\n                        55\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  \"path\": \"affiliations\",\r\n                  \"ignore_unmapped\": false,\r\n                  \"score_mode\": \"none\",\r\n                  \"boost\": 1\r\n                }\r\n              },\r\n              {\r\n                \"nested\": {\r\n                  \"query\": {\r\n                    \"terms\": {\r\n                      \"affiliations.location.unverifiedBrands\": [\r\n                        55\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  \"path\": \"affiliations\",\r\n                  \"ignore_unmapped\": false,\r\n                  \"score_mode\": \"none\",\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            ],\r\n            \"disable_coord\": false,\r\n            \"adjust_pure_negative\": true,\r\n            \"boost\": 1\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": [\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"filter\": [\r\n                  {\r\n                    \"term\": {\r\n                      \"affiliations.team.manualBrandApproval\": {\r\n                        \"value\": true,\r\n                        \"boost\": 1\r\n                      }\r\n                    }\r\n                  },\r\n                  {\r\n                    \"bool\": {\r\n                      \"must_not\": [\r\n                        {\r\n                          \"terms\": {\r\n                            \"affiliations.team.approvedBrands\": [\r\n                              55\r\n                            ],\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      ],\r\n                      \"disable_coord\": false,\r\n                      \"adjust_pure_negative\": true,\r\n                      \"boost\": 1\r\n                    }\r\n                  }\r\n                ],\r\n                \"disable_coord\": false,\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"term\": {\r\n                \"affiliations.team.blockedBrands\": {\r\n                  \"value\": 55,\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"term\": {\r\n                \"affiliations.team.blockingBrands\": {\r\n                  \"value\": 55,\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"term\": {\r\n                \"affiliations.location.blockingBrands\": {\r\n                  \"value\": 55,\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\": false,\r\n      \"adjust_pure_negative\": true,\r\n      \"boost\": 1\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n**Result:** 1 result\r\n**Expected Results:** 1 result\r\n\r\n4. Now, create the percolator index\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPUT http://localhost:9200/tag-queries -d '{\r\n  \"mappings\": {\r\n    \"tag\": {\r\n      \"properties\": {\r\n        \"address\": {\r\n          \"properties\": {\r\n            \"city\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"country\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"countryId\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"postalCode\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"subdivision\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"subdivisionId\": {\r\n              \"type\": \"long\"\r\n            }\r\n          }\r\n        },\r\n        \"affiliations\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"expirationDate\": {\r\n              \"type\": \"date\",\r\n              \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n            },\r\n            \"location\": {\r\n              \"properties\": {\r\n                \"blockingBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"city\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"country\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"countryId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"description\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"id\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"indexTime\": {\r\n                  \"type\": \"date\",\r\n                  \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n                },\r\n                \"locationId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"orgId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"parentId\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"postalCode\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"subdivision\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"subdivisionId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"targetingLabels\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"teamId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"unverifiedBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"verifiedBrands\": {\r\n                  \"type\": \"long\"\r\n                }\r\n              }\r\n            },\r\n            \"org\": {\r\n              \"properties\": {\r\n                \"categories\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"indexId\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"indexTime\": {\r\n                  \"type\": \"date\",\r\n                  \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n                },\r\n                \"orgId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"orgName\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"type\": {\r\n                  \"type\": \"keyword\"\r\n                }\r\n              }\r\n            },\r\n            \"status\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"team\": {\r\n              \"properties\": {\r\n                \"approvedBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"blockedBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"blockingBrands\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"categories\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"id\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"indexTime\": {\r\n                  \"type\": \"date\",\r\n                  \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n                },\r\n                \"industries\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"manualBrandApproval\": {\r\n                  \"type\": \"boolean\"\r\n                },\r\n                \"memberSegments\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"orgId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"parentId\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"positions\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"privateToImplicitTargeting\": {\r\n                  \"type\": \"boolean\"\r\n                },\r\n                \"teamId\": {\r\n                  \"type\": \"long\"\r\n                },\r\n                \"teamName\": {\r\n                  \"type\": \"keyword\"\r\n                },\r\n                \"type\": {\r\n                  \"type\": \"keyword\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"age\": {\r\n          \"type\": \"integer\"\r\n        },\r\n        \"attributes\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"name\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"values\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"categories\": {\r\n          \"type\": \"long\"\r\n        },\r\n        \"expertRanks\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"categoryId\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"expirationDate\": {\r\n              \"type\": \"date\",\r\n              \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n            },\r\n            \"rank\": {\r\n              \"type\": \"integer\"\r\n            }\r\n          }\r\n        },\r\n        \"firstName\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"gender\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"indexTime\": {\r\n          \"type\": \"date\",\r\n          \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n        },\r\n        \"lastLogin\": {\r\n          \"type\": \"date\",\r\n          \"format\": \"yyyy-MM-dd\\u0027T\\u0027HH:mm:ss.SSS\"\r\n        },\r\n        \"lastName\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"recommendedTo\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"orgId\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"rating\": {\r\n              \"type\": \"double\"\r\n            }\r\n          }\r\n        },\r\n        \"userId\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"userUuid\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"query\": {\r\n          \"type\": \"percolator\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n5. Create a percolator record with the query from step 3\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPUT http://localhost:9200/tag-queries/tag/1 -d '{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"terms\": {\r\n                \"affiliations.team.type\": [\r\n                  \"RETAIL\",\r\n                  \"MANUFACTURER\",\r\n                  \"PARTNER\"\r\n                ],\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"should\": [\r\n                  {\r\n                    \"bool\": {\r\n                      \"must_not\": [\r\n                        {\r\n                          \"exists\": {\r\n                            \"field\": \"affiliations.expirationDate\",\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      ],\r\n                      \"disable_coord\": false,\r\n                      \"adjust_pure_negative\": true,\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  {\r\n                    \"range\": {\r\n                      \"affiliations.expirationDate\": {\r\n                        \"from\": \"now\",\r\n                        \"to\": null,\r\n                        \"include_lower\": true,\r\n                        \"include_upper\": true,\r\n                        \"boost\": 1\r\n                      }\r\n                    }\r\n                  }\r\n                ],\r\n                \"disable_coord\": false,\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"terms\": {\r\n                \"affiliations.status\": [\r\n                  \"ACTIVE\"\r\n                ],\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"filter\": [\r\n                  {\r\n                    \"terms\": {\r\n                      \"affiliations.team.type\": [\r\n                        \"RETAIL\",\r\n                        \"MANUFACTURER\",\r\n                        \"PARTNER\"\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  }\r\n                ],\r\n                \"disable_coord\": false,\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"bool\": {\r\n            \"should\": [\r\n              {\r\n                \"nested\": {\r\n                  \"query\": {\r\n                    \"terms\": {\r\n                      \"affiliations.location.countryId\": [\r\n                        232\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  \"path\": \"affiliations\",\r\n                  \"ignore_unmapped\": false,\r\n                  \"score_mode\": \"none\",\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            ],\r\n            \"disable_coord\": false,\r\n            \"adjust_pure_negative\": true,\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"bool\": {\r\n            \"should\": [\r\n              {\r\n                \"nested\": {\r\n                  \"query\": {\r\n                    \"terms\": {\r\n                      \"affiliations.location.verifiedBrands\": [\r\n                        55\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  \"path\": \"affiliations\",\r\n                  \"ignore_unmapped\": false,\r\n                  \"score_mode\": \"none\",\r\n                  \"boost\": 1\r\n                }\r\n              },\r\n              {\r\n                \"nested\": {\r\n                  \"query\": {\r\n                    \"terms\": {\r\n                      \"affiliations.location.unverifiedBrands\": [\r\n                        55\r\n                      ],\r\n                      \"boost\": 1\r\n                    }\r\n                  },\r\n                  \"path\": \"affiliations\",\r\n                  \"ignore_unmapped\": false,\r\n                  \"score_mode\": \"none\",\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            ],\r\n            \"disable_coord\": false,\r\n            \"adjust_pure_negative\": true,\r\n            \"boost\": 1\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": [\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"filter\": [\r\n                  {\r\n                    \"term\": {\r\n                      \"affiliations.team.manualBrandApproval\": {\r\n                        \"value\": true,\r\n                        \"boost\": 1\r\n                      }\r\n                    }\r\n                  },\r\n                  {\r\n                    \"bool\": {\r\n                      \"must_not\": [\r\n                        {\r\n                          \"terms\": {\r\n                            \"affiliations.team.approvedBrands\": [\r\n                              55\r\n                            ],\r\n                            \"boost\": 1\r\n                          }\r\n                        }\r\n                      ],\r\n                      \"disable_coord\": false,\r\n                      \"adjust_pure_negative\": true,\r\n                      \"boost\": 1\r\n                    }\r\n                  }\r\n                ],\r\n                \"disable_coord\": false,\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"term\": {\r\n                \"affiliations.team.blockedBrands\": {\r\n                  \"value\": 55,\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"term\": {\r\n                \"affiliations.team.blockingBrands\": {\r\n                  \"value\": 55,\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"term\": {\r\n                \"affiliations.location.blockingBrands\": {\r\n                  \"value\": 55,\r\n                  \"boost\": 1\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"affiliations\",\r\n            \"ignore_unmapped\": false,\r\n            \"score_mode\": \"none\",\r\n            \"boost\": 1\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\": false,\r\n      \"adjust_pure_negative\": true,\r\n      \"boost\": 1\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n6. Use the user from step 2 to do a percolator query\r\n\r\n```\r\ncurl -H \"Content-Type: application/json\" -XPOST http://localhost:9200/tag-queries/_search -d '{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"document\": {\r\n        \"userId\": 1,\r\n        \"userUuid\": \"XXXXXXXXXXXXXXXXX\",\r\n        \"firstName\": \"Test\",\r\n        \"lastName\": \"User\",\r\n        \"age\": 20,\r\n        \"gender\": \"MALE\",\r\n        \"address\": {\r\n          \"countryId\": 232,\r\n          \"country\": \"US\",\r\n          \"subdivisionId\": 4077,\r\n          \"subdivision\": \"UT\",\r\n          \"postalCode\": null,\r\n          \"city\": null\r\n        },\r\n        \"categories\": [\r\n          46,\r\n          185\r\n        ],\r\n        \"expertRanks\": [],\r\n        \"recommendedTo\": [],\r\n        \"affiliations\": [\r\n          {\r\n            \"org\": {\r\n              \"type\": \"R\",\r\n              \"orgId\": 1,\r\n              \"orgName\": \"Test Company\",\r\n              \"categories\": [\r\n                49,\r\n                177\r\n              ],\r\n              \"indexTime\": \"2018-01-04T06:00:26.212\"\r\n            },\r\n            \"team\": {\r\n              \"type\": \"RETAIL\",\r\n              \"teamId\": 5,\r\n              \"teamName\": \"Test Team\",\r\n              \"orgId\": 1,\r\n              \"privateToImplicitTargeting\": false,\r\n              \"manualBrandApproval\": false,\r\n              \"approvedBrands\": [],\r\n              \"blockedBrands\": [],\r\n              \"blockingBrands\": [],\r\n              \"positions\": [],\r\n              \"categories\": [],\r\n              \"memberSegments\": [],\r\n              \"industries\": [],\r\n              \"indexTime\": \"2018-01-04T06:00:26.212\"\r\n            },\r\n            \"location\": {\r\n              \"locationId\": 10,\r\n              \"teamId\": 5,\r\n              \"orgId\": 1,\r\n              \"description\": \"Test Location\",\r\n              \"countryId\": 232,\r\n              \"country\": \"US\",\r\n              \"subdivisionId\": 4077,\r\n              \"subdivision\": \"UT\",\r\n              \"postalCode\": \"84111\",\r\n              \"city\": \"Salt Lake City\",\r\n              \"blockingBrands\": [\r\n                2\r\n              ],\r\n              \"verifiedBrands\": [\r\n                7\r\n              ],\r\n              \"unverifiedBrands\": [\r\n                55,\r\n                80\r\n              ],\r\n              \"targetingLabels\": [],\r\n              \"indexTime\": \"2018-01-04T06:00:26.212\"\r\n            },\r\n            \"status\": \"ACTIVE\",\r\n            \"expirationDate\": null\r\n          }\r\n        ],\r\n        \"attributes\": [],\r\n        \"lastLogin\": null,\r\n        \"indexTime\": \"2018-01-04T06:00:26.180\"\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\n**Result:** 0 results\r\n**Expected Result:** 1 result","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}