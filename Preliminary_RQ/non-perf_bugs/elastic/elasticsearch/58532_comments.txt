[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/649439252","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-649439252","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":649439252,"node_id":"MDEyOklzc3VlQ29tbWVudDY0OTQzOTI1Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-06-25T09:57:12Z","updated_at":"2020-06-25T09:57:12Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/652909649","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-652909649","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":652909649,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MjkwOTY0OQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-07-02T09:53:52Z","updated_at":"2020-07-02T09:53:52Z","author_association":"MEMBER","body":"Another instance https://gradle-enterprise.elastic.co/s/vzl2w4brhmiv6/tests/:x-pack:plugin:ml:internalClusterTest/org.elasticsearch.xpack.ml.integration.MlDistributedFailureIT/testFullClusterRestart#1\r\n\r\nMuted on master in 0dffe37","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/652931324","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-652931324","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":652931324,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MjkzMTMyNA==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-07-02T10:41:50Z","updated_at":"2020-07-02T10:41:50Z","author_association":"MEMBER","body":"The test performs a full cluster restart (as you would imagine) then it logs this message and waits for a stable cluster\r\n\r\n`[2020-07-02T13:38:56,971][INFO ][o.e.x.m.i.MlDistributedFailureIT] [testFullClusterRestart] Restarted all nodes`\r\n\r\nThe error is that `ESIntegTestCase.ensureStableCluster(...)` times out after 30 seconds.\r\n\r\nWithin that 30 second window a cluster state green message is logged (this is 28 seconds later, in the other failure the same message occurred 27 seconds later) \r\n\r\n`[2020-07-02T13:39:24,570][INFO ][o.e.c.r.a.AllocationService] [node_t1] current.health=\"GREEN\" message=\"Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[data][0]]]).\" previous.health=\"YELLOW\" reason=\"shards started [[data][0]]\"`\r\n\r\n`ensureStableCluster` sets `setWaitForNoRelocatingShards: true` \r\n\r\nhttps://github.com/elastic/elasticsearch/blob/acf031cdb5f8292730a6c697a8f267523c83ae08/test/framework/src/main/java/org/elasticsearch/test/ESIntegTestCase.java#L1158\r\n\r\nAnd sure enough in the last cluster state we see the `data` index replica shard is in recovery. I think this is why `ensureStableCluster` timed out\r\n\r\n`--------[data][0], node[Mrm365-qTBaAyCuhPZHNKQ], [R], recovery_source[peer recovery], s[INITIALIZING], a[id=uu_2AYoWTIefDl6z1l-2uQ], unassigned_info[[reason=CLUSTER_RECOVERED], at[2020-07-02T09:08:56.982Z], delayed=false, allocation_status[no_attempt]]`\r\n\r\n\r\nIn both the failures here it was the data index that was recovering but build stats has a failure where the `.ml-config` index is recovering.\r\n\r\nhttps://build-stats.elastic.co/app/kibana#/doc/e58bf320-7efd-11e8-bf69-63c8ef516157/failure-1531848256632/t?id=dgvAh3IBRctK8eeC9eTw&_g=()\r\n\r\nThis has been failing fairly regularly since 6th June\r\n\r\nhttps://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-60d,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:MlDistributedFailureIT),sort:!(time,desc)) \r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/652945444","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-652945444","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":652945444,"node_id":"MDEyOklzc3VlQ29tbWVudDY1Mjk0NTQ0NA==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-07-02T11:15:47Z","updated_at":"2020-07-02T11:15:47Z","author_association":"MEMBER","body":"pinging @elastic/es-distributed we have a full cluster restart test that is failing due to `ESIntegTestCase.ensureStableCluster()` timing out post restart. According to [build stats](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-60d,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'MlDistributedFailureIT%20testFullClusterRestart'),sort:!(time,desc))) this has been failing regularly since 6th June is there any change you can think of that may be causing the problems? Thanks ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/653005576","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-653005576","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":653005576,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MzAwNTU3Ng==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2020-07-02T13:28:05Z","updated_at":"2020-07-02T13:28:05Z","author_association":"CONTRIBUTOR","body":"I think this might just be the effect of the test being particularly slow at times (given that we execute a lot of other stuff concurrently with gradle). Looking at the failed test linked to above, it spends already a lot of time until it gets to the point where the nodes are restarted (indexing started at 13:37:57, nodes are restarted at 13:38:45, i.e. nearly 50 seconds later), indicating that the timeout of 30 seconds would just not have been good enough for this particularly slow CI run (the restart completed at 13:38:56, and going to yellow only happened at 13:39:04, i.e. 10 seconds later, and becomes green at 13:39:24, i.e. after 28 seconds. The shards might be rebalanced after that, causing an extra few seconds, which just brings this over the 30 seconds.\r\n\r\nI see two possibilities: Rework the test so that it runs less slowly, or increase the timeout","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/653071844","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-653071844","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":653071844,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MzA3MTg0NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-07-02T15:23:54Z","updated_at":"2020-07-02T15:23:54Z","author_association":"CONTRIBUTOR","body":"The Linux CI workers now run 16 tasks in parallel, as the timeline for https://gradle-enterprise.elastic.co/s/jeoql6ppg2iku shows:\r\n\r\n<img width=\"1614\" alt=\"Screenshot 2020-07-02 at 15 56 18\" src=\"https://user-images.githubusercontent.com/7405510/86374616-ae08cb80-bc7c-11ea-90fc-2a944c46bc33.png\">\r\n\r\nYou can see that `:x-pack:plugin:ml:internalClusterTest` overlapped with the main X-Pack YAML tests, the ML YAML tests that run 3 times with different levels of security permissions, the CCR internal cluster tests and the EQL integration tests.\r\n\r\nThe load on the machine for around 20 minutes was over 60 processes wanting to do stuff, when the machine has 32 cores:\r\n\r\n<img width=\"1321\" alt=\"Screenshot 2020-07-02 at 15 55 37\" src=\"https://user-images.githubusercontent.com/7405510/86374649-b7923380-bc7c-11ea-826d-6edbd23f6e5e.png\">\r\n\r\nAs we push parallelism to its limits we're probably going to have to increase quite a few timeouts.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/653458040","html_url":"https://github.com/elastic/elasticsearch/issues/58532#issuecomment-653458040","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58532","id":653458040,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MzQ1ODA0MA==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-07-03T09:48:27Z","updated_at":"2020-07-03T09:48:27Z","author_association":"MEMBER","body":"Thanks for the comments @ywelsch and @droberts195 \r\n\r\nI was curious because there was a marked increase in failures from 6th June but I'm satisfied this is most likely due to CI infra changes and I can see that in all cases the machine was under heavy load when failures occurred. \r\n\r\nI bumped the timeout to 60s as it was on the edge \r\n\r\n","performed_via_github_app":null}]