{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40405","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40405/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40405/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40405/events","html_url":"https://github.com/elastic/elasticsearch/issues/40405","id":424873161,"node_id":"MDU6SXNzdWU0MjQ4NzMxNjE=","number":40405,"title":"Percolate query ignores \"name\" parameter","user":{"login":"tlinhart","id":12714153,"node_id":"MDQ6VXNlcjEyNzE0MTUz","avatar_url":"https://avatars1.githubusercontent.com/u/12714153?v=4","gravatar_id":"","url":"https://api.github.com/users/tlinhart","html_url":"https://github.com/tlinhart","followers_url":"https://api.github.com/users/tlinhart/followers","following_url":"https://api.github.com/users/tlinhart/following{/other_user}","gists_url":"https://api.github.com/users/tlinhart/gists{/gist_id}","starred_url":"https://api.github.com/users/tlinhart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlinhart/subscriptions","organizations_url":"https://api.github.com/users/tlinhart/orgs","repos_url":"https://api.github.com/users/tlinhart/repos","events_url":"https://api.github.com/users/tlinhart/events{/privacy}","received_events_url":"https://api.github.com/users/tlinhart/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-03-25T12:22:37Z","updated_at":"2019-05-28T07:37:05Z","closed_at":"2019-05-28T07:37:05Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): `6.5.4`\r\n\r\n**Plugins installed**: `[analysis-icu]`\r\n\r\n**JVM version** (`java -version`): `openjdk version \"11.0.1\" 2018-10-16`\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Linux 7a321a3f5b0f 4.4.0-119-generic #143-Ubuntu SMP Mon Apr 2 16:08:24 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\nDeployed as a customized Docker image (following [the documented procedure](https://www.elastic.co/guide/en/elasticsearch/reference/6.5/docker.html#_c_customized_image)) with only `analysis-icu` plugin installed beyond the default.\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nAccording to [the documentation](https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl-percolate-query.html#_parameters_10) (and [given example](https://www.elastic.co/guide/en/elasticsearch/reference/6.5/query-dsl-percolate-query.html#_specifying_multiple_percolate_queries)), providing the `name` parameter in percolate query should result in `_percolator_document_slot` field being suffixed with that value if multiple percolate queries are supplied. However, it's not the case and the field is suffixed with the `field` parameter value as if no `name` was provided. Also, the documentation is inconsistent in specifying if the parameter name should be `name` or `_name`.\r\n\r\n**Steps to reproduce**:\r\n\r\nIssue the percolate query request for two existing documents from `my_index` index (from Kibana Dev Tools):\r\n\r\n```\r\nGET watchers/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"percolate\": {\r\n            \"field\": \"watcher.query\",\r\n            \"index\": \"my_index\",\r\n            \"type\": \"_doc\",\r\n            \"id\": \"5bf8b8aee6b3da2b8d9f5be8\",\r\n            \"name\": \"name1\"\r\n          }\r\n        },\r\n        {\r\n          \"percolate\": {\r\n            \"field\": \"watcher.query\",\r\n            \"index\": \"my_index\",\r\n            \"type\": \"_doc\",\r\n            \"id\": \"5bdaf10f67c85d283c174ad9\",\r\n            \"name\": \"name2\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResponse:\r\n\r\n```\r\n{\r\n  \"took\" : 17,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 2.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"watchers\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"5c988b8adc112234588a07b5\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"watcher.query\" : {\r\n            \"bool\" : {\r\n              \"must\" : {\r\n                \"match_all\" : { }\r\n              },\r\n              \"filter\" : {\r\n                \"bool\" : {\r\n                  \"must\" : [\r\n                    {\r\n                      \"geo_distance\" : {\r\n                        \"distance\" : \"2000m\",\r\n                        \"gps\" : {\r\n                          \"lat\" : 50.132179,\r\n                          \"lon\" : 14.510528\r\n                        }\r\n                      }\r\n                    }\r\n                  ]\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"watcher.user_id\" : \"5b85318b036be43903b294de\",\r\n          \"watcher.search_id\" : \"5c988b8adc112234588a07b5\",\r\n          \"watcher.period\" : \"immediate\"\r\n        },\r\n        \"fields\" : {\r\n          \"_percolator_document_slot_watcher.query\" : [\r\n            0\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nThe `fields` object contains `_percolator_document_slot_watcher.query`, however there should be keys like `_percolator_document_slot_name1` and `_percolator_document_slot_name2` present.\r\n\r\nWhat actually works for my use case but is not documented (at least in the context of percolate query) is providing the `_name` parameter. This works just like any other [named queries](https://www.elastic.co/guide/en/elasticsearch/reference/6.5/search-request-named-queries-and-filters.html) resulting in `matched_queries` key in the output:\r\n\r\nRequest:\r\n\r\n```\r\nGET watchers/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"percolate\": {\r\n            \"field\": \"watcher.query\",\r\n            \"index\": \"my_index\",\r\n            \"type\": \"_doc\",\r\n            \"id\": \"5bf8b8aee6b3da2b8d9f5be8\",\r\n            \"_name\": \"name1\"\r\n          }\r\n        },\r\n        {\r\n          \"percolate\": {\r\n            \"field\": \"watcher.query\",\r\n            \"index\": \"my_index\",\r\n            \"type\": \"_doc\",\r\n            \"id\": \"5bdaf10f67c85d283c174ad9\",\r\n            \"_name\": \"name2\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResponse:\r\n\r\n```\r\n{\r\n  \"took\" : 21,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 2.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"watchers\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"5c988b8adc112234588a07b5\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"watcher.query\" : {\r\n            \"bool\" : {\r\n              \"must\" : {\r\n                \"match_all\" : { }\r\n              },\r\n              \"filter\" : {\r\n                \"bool\" : {\r\n                  \"must\" : [\r\n                    {\r\n                      \"geo_distance\" : {\r\n                        \"distance\" : \"2000m\",\r\n                        \"gps\" : {\r\n                          \"lat\" : 50.132179,\r\n                          \"lon\" : 14.510528\r\n                        }\r\n                      }\r\n                    }\r\n                  ]\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"watcher.user_id\" : \"5b85318b036be43903b294de\",\r\n          \"watcher.search_id\" : \"5c988b8adc112234588a07b5\",\r\n          \"watcher.period\" : \"immediate\"\r\n        },\r\n        \"fields\" : {\r\n          \"_percolator_document_slot_watcher.query\" : [\r\n            0\r\n          ]\r\n        },\r\n        \"matched_queries\" : [\r\n          \"name2\",\r\n          \"name1\"\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}