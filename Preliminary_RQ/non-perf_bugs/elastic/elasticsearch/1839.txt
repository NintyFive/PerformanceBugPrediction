{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1839","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1839/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1839/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1839/events","html_url":"https://github.com/elastic/elasticsearch/issues/1839","id":3944516,"node_id":"MDU6SXNzdWUzOTQ0NTE2","number":1839,"title":"Relocation of shards causes bulk indexing client to hang","user":{"login":"snazy","id":957468,"node_id":"MDQ6VXNlcjk1NzQ2OA==","avatar_url":"https://avatars0.githubusercontent.com/u/957468?v=4","gravatar_id":"","url":"https://api.github.com/users/snazy","html_url":"https://github.com/snazy","followers_url":"https://api.github.com/users/snazy/followers","following_url":"https://api.github.com/users/snazy/following{/other_user}","gists_url":"https://api.github.com/users/snazy/gists{/gist_id}","starred_url":"https://api.github.com/users/snazy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/snazy/subscriptions","organizations_url":"https://api.github.com/users/snazy/orgs","repos_url":"https://api.github.com/users/snazy/repos","events_url":"https://api.github.com/users/snazy/events{/privacy}","received_events_url":"https://api.github.com/users/snazy/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2681337,"node_id":"MDU6TGFiZWwyNjgxMzM3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.19.3","name":"v0.19.3","color":"DDDDDD","default":false,"description":null},{"id":232920,"node_id":"MDU6TGFiZWwyMzI5MjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.20.0.RC1","name":"v0.20.0.RC1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2012-04-03T13:18:29Z","updated_at":"2013-11-20T02:30:49Z","closed_at":"2012-04-05T17:26:09Z","author_association":"NONE","active_lock_reason":null,"body":"I have set up 4 big servers (lots of cores, lots of disks, lots of ram) - each running an elasticsearch node.\nOne client reads rows from a database and continuously submits indexing requests to the cluster. Indexing requests are bundled into bulk requests with 2500 indexing requests.\nThe index has 32 shards.\nMy client is using the Java client API.\n\nSo far so good.\n\nI just wanted to know what happens, if I shutdown a node and restart it again.\nShutdown works fine (except: see below).\nRestart works fine...\nUntil the cluster starts to relocate shards.\n\nWhen a bulk request \"hits\" a shard being relocated, the cliend hangs forever.\n\nI have tried several networking settings, transport client vs. node client - nothing helped.\n\nOne thing fixed the issue for me:\nPreviously, the code was:\n\n```\n            Client client = (TransportClient)...\n            BulkRequestBuilder bulk = client.prepareBulk();\n            for ( 1 to 2500 ) {\n                IndexRequestBuilder request = buildIndexingRequest();\n                request = request.setReplicationType(ReplicationType.ASYNC); // no effect\n                bulk.add(request);\n            }\n            BulkResponse response;\n            response = bulk.execute().actionGet(); // <--- RETURNS NEVER, IF SHARD IS RELOCATED\n            if (response != null && response.hasFailures()) {\n                // some error handling...\n            }\n```\n\nWhen I use actionGet(timeout) with a timeout, the method throws a ElasticSearchTimeoutException in such a situation and I can submit the bulk request again.\n\n```\n                    while (true) {\n                        try {\n                            response = bulk.execute().actionGet(getRetryTimeout()); // <--- TIMES OUT, IF SHARD IS RELOCATED\n                            break;\n                        }\n                        catch (ElasticSearchTimeoutException timeout) {\n                            warning(\"TIMEOUT\", timeout, null, null);\n                        }\n                    }\n```\n\nIn such a situation I see no activity in the elasticsearch threads and no activity in \"my\" calling thread - it just waits in org.elasticsearch.common.util.concurrent.BaseFuture.Sync#acquireSharedInterruptibly forever.\n\nNone of the cluster log files indicate an error.\n\nI do not know if this behaviour affects searches.\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}