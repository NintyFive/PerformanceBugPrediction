{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/39845","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39845/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39845/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39845/events","html_url":"https://github.com/elastic/elasticsearch/issues/39845","id":418812171,"node_id":"MDU6SXNzdWU0MTg4MTIxNzE=","number":39845,"title":"[Rollup] Wrong response status on failed requests","user":{"login":"sebelga","id":2854616,"node_id":"MDQ6VXNlcjI4NTQ2MTY=","avatar_url":"https://avatars0.githubusercontent.com/u/2854616?v=4","gravatar_id":"","url":"https://api.github.com/users/sebelga","html_url":"https://github.com/sebelga","followers_url":"https://api.github.com/users/sebelga/followers","following_url":"https://api.github.com/users/sebelga/following{/other_user}","gists_url":"https://api.github.com/users/sebelga/gists{/gist_id}","starred_url":"https://api.github.com/users/sebelga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sebelga/subscriptions","organizations_url":"https://api.github.com/users/sebelga/orgs","repos_url":"https://api.github.com/users/sebelga/repos","events_url":"https://api.github.com/users/sebelga/events{/privacy}","received_events_url":"https://api.github.com/users/sebelga/received_events","type":"User","site_admin":false},"labels":[{"id":912843355,"node_id":"MDU6TGFiZWw5MTI4NDMzNTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Rollup","name":":Analytics/Rollup","color":"0e8a16","default":false,"description":"Turn fine-grained time-based data into coarser-grained data"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-03-08T14:35:28Z","updated_at":"2019-06-03T15:24:17Z","closed_at":"2019-06-03T15:24:17Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I discovered that Elasticsearch handles differently the response of a common pattern: \"Trigger an action that has already been triggered\".\r\n\r\n## Rollup job --> start\r\n\r\n````\r\nPOST _rollup/job/<job_id>/_start\r\n````\r\n\r\nWhen we try to start a rollup job that is already started, Elasticsearch throws a `500 Internal Server Error` instead of a `400 Bad Request`.\r\n\r\nThis is the error returned\r\n\r\n```\r\nstatus: 500,\r\n  displayName: 'InternalServerError',\r\n  message:\r\n   '[exception] Cannot start task for Rollup Job [my-job] because state was [STARTED]',\r\n  path: '/_rollup/job/my-job/_start',\r\n  query: {},\r\n  body:\r\n   { error:\r\n      { root_cause: [Array],\r\n        type: 'exception',\r\n        reason:\r\n         'Cannot start task for Rollup Job [my-job] because state was [STARTED]' },\r\n     status: 500 },\r\n  statusCode: 500,\r\n```\r\n\r\n## Rollup job --> stop\r\n\r\n```\r\nPOST _rollup/job/<job_id>/_stop\r\n```\r\n\r\nThis action is idempotent. We can call it as many times as we want, we always get a\r\n\r\n```\r\n200 OK\r\n{\r\n  stopped: true\r\n}\r\n```\r\n\r\n## Start trial\r\n\r\n```\r\nPOST _xpack/license/start_trial\r\n```\r\n\r\nIf we compare the above with the `start trial` API, we can see that it is handled differently. If we have already started the trial and we call the request again we get a `403 Forbidden`\r\n\r\n```\r\n{\r\n  \"acknowledged\": true,\r\n  \"trial_was_started\": false,\r\n  \"error_message\": \"Operation failed: Trial was already activated.\"\r\n}\r\n```\r\n\r\nI think it would be nice to align the way ES handle these types of requests and their status code.\r\n\r\nI also realize another wrong status in the Rollup API. When we try to delete a Job that has been started, we receive also a `500 Internal Server Error` instead of a `400 Bad Request`.\r\n\r\n```\r\n{\r\n\tInternal Server Error::{\r\n\t\t\"path\": \"/_rollup/job/my-job\",\r\n\t\t\"query\": {},\r\n\t\t\"statusCode\": 500,\r\n\t\t\"response\": \"{\\\"task_failures\\\":[{\\\"task_id\\\":1464,\\\"node_id\\\":\\\"38IK6IjmQAy2y2tgb7q_Nw\\\",\\\"status\\\":\\\"INTERNAL_SERVER_ERROR\\\",\\\"reason\\\":{\\\"type\\\":\\\"illegal_state_exception\\\",\\\"reason\\\":\\\"Could not delete job [my-job] because indexer state is [STARTED].  Job must be [STOPPED] before deletion.\\\"}}],\\\"acknowledged\\\":false}\"\r\n\t}\r\n```\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}