{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5849","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5849/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5849/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5849/events","html_url":"https://github.com/elastic/elasticsearch/issues/5849","id":31715710,"node_id":"MDU6SXNzdWUzMTcxNTcxMA==","number":5849,"title":"Filter#getDocIdSet returns TermFilter object","user":{"login":"bigwheel","id":826646,"node_id":"MDQ6VXNlcjgyNjY0Ng==","avatar_url":"https://avatars2.githubusercontent.com/u/826646?v=4","gravatar_id":"","url":"https://api.github.com/users/bigwheel","html_url":"https://github.com/bigwheel","followers_url":"https://api.github.com/users/bigwheel/followers","following_url":"https://api.github.com/users/bigwheel/following{/other_user}","gists_url":"https://api.github.com/users/bigwheel/gists{/gist_id}","starred_url":"https://api.github.com/users/bigwheel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bigwheel/subscriptions","organizations_url":"https://api.github.com/users/bigwheel/orgs","repos_url":"https://api.github.com/users/bigwheel/repos","events_url":"https://api.github.com/users/bigwheel/events{/privacy}","received_events_url":"https://api.github.com/users/bigwheel/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2014-04-17T10:16:04Z","updated_at":"2014-12-30T16:11:16Z","closed_at":"2014-12-30T16:11:16Z","author_association":"NONE","active_lock_reason":null,"body":"Last week, my elasticsearch cluster were in strange trouble.\n\nI have started the cluster at Apr 3, and no trouble has been found until Apr 7.\nBut suddenly, search request with same query parameter started to respond different (and broken) response every time\nuntil restarting the cluster.\n\nIn elasticsearch log, following Exception were found for every query.\n\n```\n[2014-04-07 18:49:09,018][DEBUG][action.search.type       ] [search102] [855103] Failed to execute query phase\norg.elasticsearch.search.query.QueryPhaseExecutionException: [index_1][3]:    .....(omit)......         : Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:127)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:309)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:236)\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.executeQuery(TransportSearchDfsQueryThenFetchAction.java:148)\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction$2.run(TransportSearchDfsQueryThenFetchAction.java:132)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:744)\nCaused by: java.lang.IllegalStateException: parentFilter must return FixedBitSet; got org.apache.lucene.queries.TermFilter$1@6f9aefe7\n    at org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinWeight.scorer(ToParentBlockJoinQuery.java:190)\n    at org.apache.lucene.search.QueryWrapperFilter$1.iterator(QueryWrapperFilter.java:59)\n    at org.elasticsearch.common.lucene.search.XBooleanFilter.getDocIdSet(XBooleanFilter.java:156)\n    at org.elasticsearch.common.lucene.search.ApplyAcceptedDocsFilter.getDocIdSet(ApplyAcceptedDocsFilter.java:45)\n    at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:130)\n    at org.apache.lucene.search.FilteredQuery$RandomAccessFilterStrategy.filteredScorer(FilteredQuery.java:531)\n    at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:136)\n    at org.apache.lucene.search.join.ToParentBlockJoinQuery$BlockJoinWeight.scorer(ToParentBlockJoinQuery.java:165)\n    at org.apache.lucene.search.DisjunctionMaxQuery$DisjunctionMaxWeight.scorer(DisjunctionMaxQuery.java:161)\n    at org.apache.lucene.search.BooleanQuery$BooleanWeight.scorer(BooleanQuery.java:317)\n    at org.apache.lucene.search.BooleanQuery$BooleanWeight.scorer(BooleanQuery.java:317)\n    at org.apache.lucene.search.FilteredQuery$LeapFrogFilterStrategy.filteredScorer(FilteredQuery.java:573)\n    at org.apache.lucene.search.FilteredQuery$QueryFirstFilterStrategy.filteredScorer(FilteredQuery.java:603)\n    at org.elasticsearch.common.lucene.search.XFilteredQuery$CustomRandomAccessFilterStrategy.filteredScorer(XFilteredQuery.java:229)\n    at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:136)\n    at org.apache.lucene.search.BooleanQuery$BooleanWeight.scorer(BooleanQuery.java:317)\n    at org.apache.lucene.search.DisjunctionMaxQuery$DisjunctionMaxWeight.scorer(DisjunctionMaxQuery.java:161)\n    at org.apache.lucene.search.FilteredQuery$RandomAccessFilterStrategy.filteredScorer(FilteredQuery.java:531)\n    at org.apache.lucene.search.FilteredQuery$1.scorer(FilteredQuery.java:136)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:618)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:173)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:581)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:533)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:510)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:345)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:116)\n    ... 7 more\n```\n\nThe root of exception is [here](https://github.com/apache/lucene-solr/blob/lucene_solr_4_7_0/lucene/join/src/java/org/apache/lucene/search/join/ToParentBlockJoinQuery.java#L190).\nIn normaly, Filter#getDocIdSet returns DocIdSet instance. But in above case, that method returns termFilter.\n\nCould Filter#getDocIdSet return termFilter?\n\nFor what it's worth, I found that the error caused by one of my cluster's HDD in the day before this trouble, and that HDD was broken in few days after.\nI think this problem might be caused by HDD error but I'm not sure about the conclusion.\n### Environment\n- Hardware\n  - cluster: 3 nodes\n  - node: all physical server (NOT VM)\n  - memory: 32GB\n  - HDD: 100GB (RAID1)\n  - OS: Linux\n- Elasticsearch\n  - version: 1.1.0\n  - index: 11GB\n  - number of replicas: 1\n  - shards: 9\n  - Java Version: OpenJDK 1.7 Update 51\n\nMany thanks\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}