[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223755477","html_url":"https://github.com/elastic/elasticsearch/issues/18736#issuecomment-223755477","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18736","id":223755477,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzc1NTQ3Nw==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-06-04T13:24:01Z","updated_at":"2016-06-04T13:24:01Z","author_association":"CONTRIBUTOR","body":"this works as designed. the only think i can think of is that we should maybe add this to the documentation OR fail to start up if seccomp is enabled and `-XX:OnOutOfMemoryError`is set too.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223757259","html_url":"https://github.com/elastic/elasticsearch/issues/18736#issuecomment-223757259","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18736","id":223757259,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzc1NzI1OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-06-04T14:02:06Z","updated_at":"2016-06-04T14:02:06Z","author_association":"MEMBER","body":"You should just upgrade to 8u92 and use the new flag `ExitOnOutOfMemoryError`, it does not need to fork and is compatible with seccomp.\n\nApplying this patch to Elasticsearch:\n\n``` diff\ndiff --git a/core/src/main/java/org/elasticsearch/node/Node.java b/core/src/main/java/org/elasticsearch/node/Node.java\nindex cf33770..ecd4c47 100644\n--- a/core/src/main/java/org/elasticsearch/node/Node.java\n+++ b/core/src/main/java/org/elasticsearch/node/Node.java\n@@ -261,6 +261,12 @@ public class Node implements Closeable {\n             }\n         }\n\n+        try {\n+            int[] a = new int[16777216];\n+        } catch (OutOfMemoryError e) {\n+            // intentional so we do not otherwise die\n+        }\n+\n         logger.info(\"initialized\");\n     }\n```\n\nso that we are attempting to allocate a 64 MB array _after_ seccomp is installed:\n\n```\n09:53:58 ⏚ [jason:~/elasticsearch/elasticsearch-5.0.0-SNAPSHOT] $ ES_JAVA_OPTS=\"-Xms64m -Xmx64m -XX:+ExitOnOutOfMemoryError\" ./bin/elasticsearch\n[2016-06-04 09:54:08,358][INFO ][node                     ] [Cassandra Nova] version[5.0.0-SNAPSHOT], pid[89211], build[2d57bbd/2016-06-04T12:30:20.088Z], OS[Mac OS X/10.11.5/x86_64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_92/25.92-b14]\n[2016-06-04 09:54:08,359][INFO ][node                     ] [Cassandra Nova] initializing ...\n[2016-06-04 09:54:08,973][INFO ][plugins                  ] [Cassandra Nova] modules [percolator, lang-mustache, lang-painless, ingest-grok, reindex, aggs-matrix-stats, lang-expression, lang-groovy], plugins []\n[2016-06-04 09:54:08,995][INFO ][env                      ] [Cassandra Nova] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable_space [367.7gb], net total_space [464.7gb], spins? [unknown], types [hfs]\n[2016-06-04 09:54:08,995][INFO ][env                      ] [Cassandra Nova] heap size [61.8mb], compressed ordinary object pointers [true]\n[2016-06-04 09:54:10,355][INFO ][node                     ] [Cassandra Nova] initialized\n[2016-06-04 09:54:10,355][INFO ][node                     ] [Cassandra Nova] starting ...\n[2016-06-04 09:54:10,410][INFO ][transport                ] [Cassandra Nova] publish_address {127.0.0.1:9300}, bound_addresses {[fe80::1]:9300}, {[::1]:9300}, {127.0.0.1:9300}\n[2016-06-04 09:54:10,412][WARN ][bootstrap                ] [Cassandra Nova] please set [discovery.zen.minimum_master_nodes] to a majority of the number of master eligible nodes in your cluster\n[2016-06-04 09:54:13,456][INFO ][cluster.service          ] [Cassandra Nova] new_master {Cassandra Nova}{d8Gh-txJRzK0EBO-lZuHqA}{127.0.0.1}{127.0.0.1:9300}, reason: zen-disco-join(elected_as_master, [0] joins received)\n[2016-06-04 09:54:13,473][INFO ][http                     ] [Cassandra Nova] publish_address {127.0.0.1:9200}, bound_addresses {[fe80::1]:9200}, {[::1]:9200}, {127.0.0.1:9200}\n[2016-06-04 09:54:13,473][INFO ][node                     ] [Cassandra Nova] started\njava.lang.OutOfMemoryError: Java heap space\nDumping heap to java_pid89211.hprof ...\nHeap dump file created [25956023 bytes in 0.163 secs]\nTerminating due to java.lang.OutOfMemoryError: Java heap space\n09:54:13 ⏚ [jason:~/elasticsearch/elasticsearch-5.0.0-SNAPSHOT] 3 $ \n```\n\nand without the flag:\n\n```\n09:54:13 ⏚ [jason:~/elasticsearch/elasticsearch-5.0.0-SNAPSHOT] 3 $ ES_JAVA_OPTS=\"-Xms64m -Xmx64m\" ./bin/elasticsearch\n[2016-06-04 09:57:41,286][INFO ][node                     ] [Nathaniel Richards] version[5.0.0-SNAPSHOT], pid[89285], build[2d57bbd/2016-06-04T12:30:20.088Z], OS[Mac OS X/10.11.5/x86_64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_92/25.92-b14]\n[2016-06-04 09:57:41,287][INFO ][node                     ] [Nathaniel Richards] initializing ...\n[2016-06-04 09:57:41,792][INFO ][plugins                  ] [Nathaniel Richards] modules [percolator, lang-mustache, lang-painless, ingest-grok, reindex, aggs-matrix-stats, lang-expression, lang-groovy], plugins []\n[2016-06-04 09:57:41,810][INFO ][env                      ] [Nathaniel Richards] using [1] data paths, mounts [[/ (/dev/disk1)]], net usable_space [367.7gb], net total_space [464.7gb], spins? [unknown], types [hfs]\n[2016-06-04 09:57:41,810][INFO ][env                      ] [Nathaniel Richards] heap size [61.8mb], compressed ordinary object pointers [true]\n[2016-06-04 09:57:43,251][INFO ][node                     ] [Nathaniel Richards] initialized\n[2016-06-04 09:57:43,252][INFO ][node                     ] [Nathaniel Richards] starting ...\n[2016-06-04 09:57:43,328][INFO ][transport                ] [Nathaniel Richards] publish_address {127.0.0.1:9300}, bound_addresses {[fe80::1]:9300}, {[::1]:9300}, {127.0.0.1:9300}\n[2016-06-04 09:57:43,331][WARN ][bootstrap                ] [Nathaniel Richards] please set [discovery.zen.minimum_master_nodes] to a majority of the number of master eligible nodes in your cluster\n[2016-06-04 09:57:46,385][INFO ][cluster.service          ] [Nathaniel Richards] new_master {Nathaniel Richards}{lyd84Tf9R4GficBHI3-gWg}{127.0.0.1}{127.0.0.1:9300}, reason: zen-disco-join(elected_as_master, [0] joins received)\n[2016-06-04 09:57:46,402][INFO ][http                     ] [Nathaniel Richards] publish_address {127.0.0.1:9200}, bound_addresses {[fe80::1]:9200}, {[::1]:9200}, {127.0.0.1:9200}\n[2016-06-04 09:57:46,402][INFO ][node                     ] [Nathaniel Richards] started\njava.lang.OutOfMemoryError: Java heap space\nDumping heap to java_pid89285.hprof ...\nHeap dump file created [26087334 bytes in 0.147 secs]\n[2016-06-04 09:57:46,665][INFO ][node                     ] [Nathaniel Richards] error\njava.lang.OutOfMemoryError: Java heap space\n        at org.elasticsearch.node.Node.start(Node.java:407)\n        at org.elasticsearch.bootstrap.Bootstrap.start(Bootstrap.java:197)\n        at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:256)\n        at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:96)\n        at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:91)\n        at org.elasticsearch.cli.SettingCommand.execute(SettingCommand.java:54)\n        at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:91)\n        at org.elasticsearch.cli.Command.main(Command.java:53)\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:70)\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:63)\n[2016-06-04 09:57:46,667][INFO ][gateway                  ] [Nathaniel Richards] recovered [0] indices into cluster_state\n```\n\nIf you need to do something other than exit on out of memory error then echoing @rmuir and @s1monw, sorry, we are not going to support that.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223777396","html_url":"https://github.com/elastic/elasticsearch/issues/18736#issuecomment-223777396","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18736","id":223777396,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzc3NzM5Ng==","user":{"login":"samcday","id":531550,"node_id":"MDQ6VXNlcjUzMTU1MA==","avatar_url":"https://avatars0.githubusercontent.com/u/531550?v=4","gravatar_id":"","url":"https://api.github.com/users/samcday","html_url":"https://github.com/samcday","followers_url":"https://api.github.com/users/samcday/followers","following_url":"https://api.github.com/users/samcday/following{/other_user}","gists_url":"https://api.github.com/users/samcday/gists{/gist_id}","starred_url":"https://api.github.com/users/samcday/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samcday/subscriptions","organizations_url":"https://api.github.com/users/samcday/orgs","repos_url":"https://api.github.com/users/samcday/repos","events_url":"https://api.github.com/users/samcday/events{/privacy}","received_events_url":"https://api.github.com/users/samcday/received_events","type":"User","site_admin":false},"created_at":"2016-06-04T20:46:19Z","updated_at":"2016-06-04T20:46:19Z","author_association":"NONE","body":"Awesome, I did not know about the `-XX:ExitOnOutOfMemoryError`. We wanted a script to fire so that we could raise a Datadog event for the OOM (then we can easily setup alarms on this occurrence).\n\nFWIW, I don't think it's reasonable to close this issue just yet. I wasted a solid 3 hours trying to figure out why my OOM handler wasn't working. There was _zero_ documentation on this apparently known issue. Can we re-open this and close once there's documentation indicating that `-XX:OnOutOfMemoryError` is intentionally and permanently broken, and `-XX:ExitOnOutOfMemoryError` is the only option?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/224093742","html_url":"https://github.com/elastic/elasticsearch/issues/18736#issuecomment-224093742","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18736","id":224093742,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNDA5Mzc0Mg==","user":{"login":"samcday","id":531550,"node_id":"MDQ6VXNlcjUzMTU1MA==","avatar_url":"https://avatars0.githubusercontent.com/u/531550?v=4","gravatar_id":"","url":"https://api.github.com/users/samcday","html_url":"https://github.com/samcday","followers_url":"https://api.github.com/users/samcday/followers","following_url":"https://api.github.com/users/samcday/following{/other_user}","gists_url":"https://api.github.com/users/samcday/gists{/gist_id}","starred_url":"https://api.github.com/users/samcday/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samcday/subscriptions","organizations_url":"https://api.github.com/users/samcday/orgs","repos_url":"https://api.github.com/users/samcday/repos","events_url":"https://api.github.com/users/samcday/events{/privacy}","received_events_url":"https://api.github.com/users/samcday/received_events","type":"User","site_admin":false},"created_at":"2016-06-06T21:27:15Z","updated_at":"2016-06-06T21:27:15Z","author_association":"NONE","body":"@s1monw  thoughts?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/224096425","html_url":"https://github.com/elastic/elasticsearch/issues/18736#issuecomment-224096425","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18736","id":224096425,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNDA5NjQyNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-06-06T21:38:02Z","updated_at":"2016-06-06T21:38:02Z","author_association":"MEMBER","body":"I opened #18756.\n","performed_via_github_app":null}]