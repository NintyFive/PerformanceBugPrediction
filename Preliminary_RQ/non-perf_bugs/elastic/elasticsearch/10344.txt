{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10344/events","html_url":"https://github.com/elastic/elasticsearch/issues/10344","id":65450265,"node_id":"MDU6SXNzdWU2NTQ1MDI2NQ==","number":10344,"title":"Snapshot repository registration api call causing \"out of memory\" errors","user":{"login":"nicktgr15","id":2852737,"node_id":"MDQ6VXNlcjI4NTI3Mzc=","avatar_url":"https://avatars0.githubusercontent.com/u/2852737?v=4","gravatar_id":"","url":"https://api.github.com/users/nicktgr15","html_url":"https://github.com/nicktgr15","followers_url":"https://api.github.com/users/nicktgr15/followers","following_url":"https://api.github.com/users/nicktgr15/following{/other_user}","gists_url":"https://api.github.com/users/nicktgr15/gists{/gist_id}","starred_url":"https://api.github.com/users/nicktgr15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nicktgr15/subscriptions","organizations_url":"https://api.github.com/users/nicktgr15/orgs","repos_url":"https://api.github.com/users/nicktgr15/repos","events_url":"https://api.github.com/users/nicktgr15/events{/privacy}","received_events_url":"https://api.github.com/users/nicktgr15/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2015-03-31T13:27:18Z","updated_at":"2015-04-02T12:19:00Z","closed_at":"2015-04-02T12:19:00Z","author_association":"NONE","active_lock_reason":null,"body":"We are running an elasticsearch cluster with 27 nodes and we create about 200 new indices per day. \nWe keep data for the last 5 days, so in total we have about 1000 indices.  Every day we take a snapshot of yesterday's 200 indices in S3 (so, no incremental backups). \n\nAfter updating to 1.4.2 we've noticed that when we try to register a snapshots repository we end up with the master node running out of heap space and the cluster going into an unresponsive state. I'm attaching a screenshot where you can see the heap space usage on the master node after making a PUT request to register a snapshots repository.\n\n![jmx-master](https://cloud.githubusercontent.com/assets/2852737/6919795/eb962f3e-d7b1-11e4-8a6f-89763fd6b7f7.png)\n\nAfter inspecting a heap dump taken from the master node we realised that it's trying to list the contents of our s3 repository. At the moment we keep all previous snapshots in our s3 repository which means that it's impossible (in terms of time and resources) to list everything. I'm attaching a screenshot from Memory Analyser where you can see that 51% of the heap space (800 MB) is occupied by a Map storing 5.000.000 entries with PlainBlobMetadata objects as values and s3 locations as keys.\n\n![memoryanalyser_tree](https://cloud.githubusercontent.com/assets/2852737/6919797/f114a09e-d7b1-11e4-90b4-fea6d402a3b0.png)\n\nWe recently updated to 1.4.2. (from 1.1.2) and we don't think we've seen a similar behaviour (i.e. listing s3 repository contents) in 1.1.2. Could be an issue that needs further investigation on your side or could be the way we are using the snapshots service at the moment that is causing us problems?\n\nAny suggestions/feedback would be welcome.\n\nThank you\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}