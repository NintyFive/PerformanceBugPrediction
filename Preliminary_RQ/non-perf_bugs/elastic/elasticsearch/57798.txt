{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57798","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57798/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57798/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57798/events","html_url":"https://github.com/elastic/elasticsearch/issues/57798","id":634469684,"node_id":"MDU6SXNzdWU2MzQ0Njk2ODQ=","number":57798,"title":"Snapshot Repositories Containing a Mix of pre and post v7.6 Snapshots Can Become Corrupted","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-06-08T10:00:13Z","updated_at":"2020-06-08T15:14:57Z","closed_at":"2020-06-08T15:14:46Z","author_association":"MEMBER","active_lock_reason":null,"body":"Repositories that contain both snapshots from before version 7.6 and after 7.6 can become dysfunctional and in some cases corrupted by ES v7.7 clusters as a result of a mistake in how `RepositoryData` is cached. \r\nThe `RepositoryData` is cached including `ShardGenerations` that include numeric generation values that might not be reliable (any failed snapshot finalization that had at least one individual shard snapshot would cause an incorrect shard generation to be tracked).\r\n\r\nThis leads to two stages of broken behavior:\r\n\r\n1. As long as there is still at least one pre-7.6 snapshot in the repository, new `ShardGenerations` will not be physically written to the repository. The issue will show up in errors like while creating new snapshots of affected shards, leading to `PARTIAL` snapshots because the affected shards will never successfully snapshot. \r\n\r\n```\r\n [2020-06-04T00:00:00.206Z][WARN][org.elasticsearch.snapshots.SnapshotShardsService] [instance-0000000012] [[xxx][0]][xxx:xxx/Lnmw3145RGubRA7oiWqUsg] failed to snapshot shard\r\njava.nio.file.NoSuchFileException: Blob [snapshots/585b4ab8ad5e44d8a8144df80846222b/indices/IzG2oACDQbiD_1479qE4IA/0/index-7866] does not exist\r\n```\r\n\r\nAlso, snapshot deletes will log the same error, but will work otherwise. This leads to the second stage of the issue described below.\r\nAt this stage of the problem, the repository can be fixed and further corruption prevented by setting the setting the repository setting `cache_repository_data` to `false`.\r\n\r\n2. Once all the pre-7.6 snapshots have been deleted from a repository the broken `RepositoryGenerations` that were incorrectly cached, will be written to the repository physically.\r\nOnce this has happened the repository is physically corrupted and the only way to fix it at this point is to delete all snapshots referencing the broken shards.\r\n\r\nWe will do two steps of fixing things here:\r\n\r\n- [x] Fix the `RepositoryData` caching #57785 \r\n- [x] Add logic to automatically fix affected `RepositoryData` so that upgrading restores the affected repositories to full functionality\r\n\r\ncc @ywelsch , @paulcoghlan ","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}