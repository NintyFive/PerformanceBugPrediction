{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12164","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12164/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12164/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12164/events","html_url":"https://github.com/elastic/elasticsearch/issues/12164","id":94095035,"node_id":"MDU6SXNzdWU5NDA5NTAzNQ==","number":12164,"title":"Regression with parent-child, object type and aggregations?","user":{"login":"paolociccarese","id":798736,"node_id":"MDQ6VXNlcjc5ODczNg==","avatar_url":"https://avatars0.githubusercontent.com/u/798736?v=4","gravatar_id":"","url":"https://api.github.com/users/paolociccarese","html_url":"https://github.com/paolociccarese","followers_url":"https://api.github.com/users/paolociccarese/followers","following_url":"https://api.github.com/users/paolociccarese/following{/other_user}","gists_url":"https://api.github.com/users/paolociccarese/gists{/gist_id}","starred_url":"https://api.github.com/users/paolociccarese/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/paolociccarese/subscriptions","organizations_url":"https://api.github.com/users/paolociccarese/orgs","repos_url":"https://api.github.com/users/paolociccarese/repos","events_url":"https://api.github.com/users/paolociccarese/events{/privacy}","received_events_url":"https://api.github.com/users/paolociccarese/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-07-09T16:31:12Z","updated_at":"2015-07-10T16:50:35Z","closed_at":"2015-07-10T16:34:51Z","author_association":"NONE","active_lock_reason":null,"body":"I am experiencing a regression when using parent-child relationships and aggregations of \ninner objects in Elasticsearch versions newer than 1.4.4.\n\nHere is a simple made-up mapping that can demonstrate my issue:\n\n```\ncurl -XDELETE 'http://localhost:9200/test'\ncurl -XPOST 'localhost:9200/test' -d '\n{\n  \"mappings\": {\n  \"Gym\": {\n      \"properties\": {\n        \"GymUID\": {\n          \"type\": \"string\",\n          \"include_in_all\": true,\n          \"index\": \"not_analyzed\"\n        },\n        \"Short Description\": {\n          \"type\": \"string\"      \n        }\n       }\n    },\n    \"Member\": {\n      \"_parent\": {\n        \"type\": \"Gym\"\n      },\n      \"properties\": {\n        \"MemberUID\": {\n          \"type\": \"string\",\n          \"include_in_all\": true,\n          \"index\": \"not_analyzed\"\n        },\n        \"Age\": {\n          \"type\": \"integer\",\n          \"null_value\": 0\n        },\n        \"Gender\": {\n          \"type\": \"string\",\n          \"include_in_all\": true,\n          \"index\": \"not_analyzed\"\n        }\n     }\n     },\n     \"Visit\": {\n      \"_parent\": {\n        \"type\": \"Member\"\n      },\n      \"properties\": {\n        \"Location\": {\n          \"properties\": {\n            \"Name\": {\n              \"type\": \"string\",\n              \"include_in_all\": true,\n              \"index\": \"not_analyzed\"\n            }\n          }\n        },\n        \"Member\": {\n          \"properties\": {\n            \"MemberUID\": {\n              \"type\": \"string\",\n              \"include_in_all\": true,\n              \"index\": \"not_analyzed\"\n            },\n            \"Age\": {\n              \"type\": \"integer\",\n              \"null_value\": 0\n            },\n            \"Gender\": {\n              \"type\": \"string\",\n              \"include_in_all\": true,\n              \"index\": \"not_analyzed\"\n            }\n          }\n        },\n        \"VisitUID\": {\n          \"type\": \"string\",\n          \"include_in_all\": true,\n          \"index\": \"not_analyzed\"\n        }\n      }\n    }\n  }\n}\n'\n```\n\nWe can now post some data\n\n```\ncurl -XPOST 'http://localhost:9200/test/Gym/Gym1' -d '{\"GymUID\":1,\"Short Description\":\"Sport center\"}'\ncurl -XPOST 'http://localhost:9200/test/Member/1?parent=Gym1&routing=Gym1' -d '{\"MemberUID\":\"1\",\"Gender\":\"Male\",\"Age\":65}'\ncurl -XPOST 'http://localhost:9200/test/Visit/1?parent=1&routing=Gym1' -d '{\"VisitUID\":\"1\",\"Location\":{\"Name\":\"Paolo Ciccarese house\"},\"Member\":{\"MemberUID\":\"1\",\"Gender\":\"Male\",\"Age\":65}}'\n```\n\nIf now we query for visits of Male members and aggregate by age:\n\n```\ncurl -XGET 'http://localhost:9200/test/Visit/_search?pretty=true&size=1' -d '\n{\n  \"query\":{\n     \"match\":{\"Member.Gender\":\"Male\"} \n  },\n  \"aggs\":{\n     \"members\":{\"terms\":{\"field\":\"Member.Age\"}}\n  }\n}'\n```\n\nThe query returns one result and an empty aggregation for versions after 1.4.4 (I've tried 1.5.2 and 1.6.0).\nIt returns one result and one item in the aggregation bucket with version 1.4.4.\n\nNotice that if I use the same mapping for Visit but without the parents:\n\n```\ncurl -XDELETE 'http://localhost:9200/test'\ncurl -XPOST 'localhost:9200/test' -d '\n{\n  \"mappings\": {\n     \"Visit\": {\n      \"properties\": {\n        \"Location\": {\n          \"properties\": {\n            \"Name\": {\n              \"type\": \"string\",\n              \"include_in_all\": true,\n              \"index\": \"not_analyzed\"\n            }\n          }\n        },\n        \"Member\": {\n          \"properties\": {\n            \"MemberUID\": {\n              \"type\": \"string\",\n              \"include_in_all\": true,\n              \"index\": \"not_analyzed\"\n            },\n            \"Age\": {\n              \"type\": \"integer\",\n              \"null_value\": 0\n            },\n            \"Gender\": {\n              \"type\": \"string\",\n              \"include_in_all\": true,\n              \"index\": \"not_analyzed\"\n            }\n          }\n        },\n        \"VisitUID\": {\n          \"type\": \"string\",\n          \"include_in_all\": true,\n          \"index\": \"not_analyzed\"\n        }\n      }\n    }\n  }\n}\n'\n```\n\nAnd I push the same data\n\n```\ncurl -XPOST 'http://localhost:9200/test/Visit/1' -d '{\"VisitUID\":\"1\",\"Location\":{\"Name\":\"Paolo Ciccarese house\"},\"Member\":{\"MemberUID\":\"1\",\"Gender\":\"Male\",\"Age\":65}}'\n```\n\nThe same query works beautifully:\n\n```\ncurl -XGET 'http://localhost:9200/test/Visit/_search?pretty=true&size=1' -d '\n{\n  \"query\":{\n     \"match\":{\"Member.Gender\":\"Male\"} \n  },\n  \"aggs\":{\n     \"members\":{\"terms\":{\"field\":\"Member.Age\"}}\n  }\n}'\n```\n\nand returns one item in the aggregation bucket no matter which version I use.\n\nAny idea?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}