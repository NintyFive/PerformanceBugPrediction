{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62586","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62586/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62586/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62586/events","html_url":"https://github.com/elastic/elasticsearch/issues/62586","id":703854248,"node_id":"MDU6SXNzdWU3MDM4NTQyNDg=","number":62586,"title":"Unexpected interaction between synonym_filter and lowercase filter in custom analyzer","user":{"login":"cjcenizal","id":1238659,"node_id":"MDQ6VXNlcjEyMzg2NTk=","avatar_url":"https://avatars2.githubusercontent.com/u/1238659?v=4","gravatar_id":"","url":"https://api.github.com/users/cjcenizal","html_url":"https://github.com/cjcenizal","followers_url":"https://api.github.com/users/cjcenizal/followers","following_url":"https://api.github.com/users/cjcenizal/following{/other_user}","gists_url":"https://api.github.com/users/cjcenizal/gists{/gist_id}","starred_url":"https://api.github.com/users/cjcenizal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cjcenizal/subscriptions","organizations_url":"https://api.github.com/users/cjcenizal/orgs","repos_url":"https://api.github.com/users/cjcenizal/repos","events_url":"https://api.github.com/users/cjcenizal/events{/privacy}","received_events_url":"https://api.github.com/users/cjcenizal/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-09-17T19:31:29Z","updated_at":"2020-09-18T08:52:24Z","closed_at":"2020-09-18T08:52:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"To reproduce this strange behavior, create a `config/synonyms.txt` file containing this line:\r\n\r\n```\r\nfoo => bar\r\n```\r\n\r\nThen execute these requests in order. If doing this in Console you'll have to execute them one at a time (otherwise the search results are incorrect):\r\n\r\n```\r\nPUT /x\r\n{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"text_field\": {\r\n        \"type\":\"text\",\r\n        \"fields\":{\r\n          \"raw\":{\r\n            \"type\":\"keyword\"\r\n          }\r\n        },\r\n        \"analyzer\":\"synonym_analyzer\"\r\n      }\r\n    }\r\n  },\r\n  \"settings\":{\r\n    \"analysis\":{\r\n       \"filter\":{\r\n          \"synonym_filter\":{\r\n             \"type\":\"synonym_graph\",\r\n             \"synonyms_path\":\"synonyms.txt\"\r\n          }\r\n       },\r\n       \"analyzer\":{\r\n          \"synonym_analyzer\":{\r\n             \"filter\":[\r\n                \"synonym_filter\",\r\n                \"lowercase\"\r\n             ],\r\n             \"type\":\"custom\",\r\n             \"tokenizer\":\"letter\"\r\n          }\r\n       }\r\n    }\r\n  }\r\n}\r\n\r\nPUT x/_doc/1\r\n{\r\n  \"text_field\":[\r\n    \"Foo\"\r\n  ]\r\n}\r\n\r\n# Returns a result, which is expected\r\nPOST x/_search\r\n{\r\n  \"_source\": [\r\n    \"text_field\"\r\n  ],\r\n  \"size\": 200,\r\n  \"query\": {\r\n    \"simple_query_string\": {\r\n      \"query\": \"Foo\",\r\n      \"fields\": [\r\n        \"text_field\"\r\n      ]\r\n    }\r\n  }\r\n}\r\n\r\n# Returns no results, which is unexpected\r\nPOST x/_search\r\n{\r\n  \"_source\": [\r\n    \"text_field\"\r\n  ],\r\n  \"size\": 200,\r\n  \"query\": {\r\n    \"simple_query_string\": {\r\n      \"query\": \"foo\",\r\n      \"fields\": [\r\n        \"text_field\"\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nFor the last request, I would expect to get back the same result as the second-to-last request. I can \"fix\" this by doing one of two things:\r\n\r\n1. Remove the line from the synonyms file\r\n2. Or reverse the order of the filters so it's `[\"lowercase\", \"synonym_filter\"]`.\r\n\r\nIs this expected behavior or have I found a bug? Thanks!\r\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}