{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27023","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27023/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27023/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27023/events","html_url":"https://github.com/elastic/elasticsearch/issues/27023","id":265813321,"node_id":"MDU6SXNzdWUyNjU4MTMzMjE=","number":27023,"title":"multi_match ignores type when expanding phrase_prefixes","user":{"login":"tsuthers-ccpgames","id":14182316,"node_id":"MDQ6VXNlcjE0MTgyMzE2","avatar_url":"https://avatars2.githubusercontent.com/u/14182316?v=4","gravatar_id":"","url":"https://api.github.com/users/tsuthers-ccpgames","html_url":"https://github.com/tsuthers-ccpgames","followers_url":"https://api.github.com/users/tsuthers-ccpgames/followers","following_url":"https://api.github.com/users/tsuthers-ccpgames/following{/other_user}","gists_url":"https://api.github.com/users/tsuthers-ccpgames/gists{/gist_id}","starred_url":"https://api.github.com/users/tsuthers-ccpgames/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsuthers-ccpgames/subscriptions","organizations_url":"https://api.github.com/users/tsuthers-ccpgames/orgs","repos_url":"https://api.github.com/users/tsuthers-ccpgames/repos","events_url":"https://api.github.com/users/tsuthers-ccpgames/events{/privacy}","received_events_url":"https://api.github.com/users/tsuthers-ccpgames/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-10-16T15:33:26Z","updated_at":"2017-10-20T14:43:17Z","closed_at":"2017-10-20T14:43:17Z","author_association":"NONE","active_lock_reason":null,"body":"Hi all, a quick set of commands for you:\r\n\r\n```\r\ncurl -XPUT -d '{\"settings\": {\"index\":{\"number_of_shards\": 1}}}' http://localhost:9200/personnel/\r\ncurl -XPUT -d '{\"first_name\": \"bob\", \"last_name\": \"smith\"}' http://localhost:9200/personnel/managers/1\r\ncurl -XPUT -d '{\"first_name\": \"bobby\", \"last_name\": \"tanner\"}' http://localhost:9200/personnel/contractors/2\r\ncurl -XGET -d '{\"query\": {\"bool\": {\"should\": [{\"constant_score\": {\"filter\": {\"bool\": {\"must\": {\"multi_match\": {\"query\": \"bob\",\"type\": \"phrase_prefix\",\"max_expansions\": 50,\"fields\": [\"first_name\", \"last_name\"]}}}}}}]}}}' 'http://localhost:9200/personnel/contractors/_search?pretty=true&explain'\r\n```\r\nObserve the following excerpt from the output:\r\n```\r\n\"description\" : \"ConstantScore(((first_name:bobby first_name:bob) | MatchNoDocsQuery(\\\"No terms supplied for org.elasticsearch.common.lucene.search.MultiPhrasePrefixQuery\\\"))), product of:\",\r\n```\r\n\r\nIntuitively, I expected the multi_match to execute over just the contractors type, and thus would not expect \"bob\" from the managers type to be in the set of documents queried by multi_match, but it seems I am mistaken. \r\n\r\nNote that the constant score stuff is not required to repro this. I include it in the demo because it causes the explain argument to highlight the issue better. Without it, it's hard to detect this issue on small datasets.\r\n\r\nThe secondary effects of this issue (missing data in the result sets) can be reproduced on my development cluster with the following style of query:\r\n```\r\n{\"query\":{\"bool\":{\"must\":{\"multi_match\":{\"query\":\"bob\",\"type\":\"phrase_prefix\",\"max_expansions\":50,\"fields\":[\"first_name\",\"last_name\"]}}}}}\r\n```\r\n\r\nThis issue has been seen in production on AWS Elasticsearch 5.3, and reproduced using the curl commands at the top of this issue against a local Elasticsearch 5.6.3.\r\n\r\nAs far as I can tell. this is what's happening:\r\n\r\nWhen running a multi_match phrase_prefix query with a specific type in the URL, Elasticsearch picks a shard. Elasticsearch then expands all documents in the shard, regardless of whether the documents are of the requested type or not. After the phrase_prefix query on the whole shard is complete, it discards any matches with types that do not match the type requested in the URL.\r\n\r\nThis is a problem if one type has many more potential hits than another. The query will hit the max_expansions limit while querying types that are not relevant to the query, and then fail to run the query over the types requested.\r\n\r\nI have attempted without success to apply some kind of pre-filtering to reduce the dataset the multi_match is querying down to just the type I want.\r\n\r\nI am uncertain if this is a bug, a problem with my search strategy or simply that I am lacking a magical invocation to solve the problem. Any ideas?","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}