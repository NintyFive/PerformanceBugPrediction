{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57106","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57106/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57106/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57106/events","html_url":"https://github.com/elastic/elasticsearch/issues/57106","id":624156114,"node_id":"MDU6SXNzdWU2MjQxNTYxMTQ=","number":57106,"title":"How to filter nested object in Elasticsearch 7.5?","user":{"login":"tanobi92","id":11570162,"node_id":"MDQ6VXNlcjExNTcwMTYy","avatar_url":"https://avatars3.githubusercontent.com/u/11570162?v=4","gravatar_id":"","url":"https://api.github.com/users/tanobi92","html_url":"https://github.com/tanobi92","followers_url":"https://api.github.com/users/tanobi92/followers","following_url":"https://api.github.com/users/tanobi92/following{/other_user}","gists_url":"https://api.github.com/users/tanobi92/gists{/gist_id}","starred_url":"https://api.github.com/users/tanobi92/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tanobi92/subscriptions","organizations_url":"https://api.github.com/users/tanobi92/orgs","repos_url":"https://api.github.com/users/tanobi92/repos","events_url":"https://api.github.com/users/tanobi92/events{/privacy}","received_events_url":"https://api.github.com/users/tanobi92/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-05-25T09:02:40Z","updated_at":"2020-05-25T09:26:16Z","closed_at":"2020-05-25T09:26:16Z","author_association":"NONE","active_lock_reason":null,"body":"I have a mapping:\r\n```\r\n{\r\n  \"ntol-2020-05\" : {\r\n    \"mappings\" : {\r\n      {\r\n        \"properties\": {\r\n          \"_createdAt\": {\r\n            \"type\": \"date\"\r\n          },\r\n          \"_logType\": {\r\n            \"type\": \"text\",\r\n            \"fields\": {\r\n              \"keyword\": {\r\n                \"type\": \"keyword\",\r\n                \"ignore_above\": 256\r\n              }\r\n            }\r\n          },\r\n          \"device\": {\r\n            \"properties\": {\r\n              ...\r\n            }\r\n          },\r\n          \"resp\": {\r\n            \"type\": \"nested\",\r\n            \"properties\": {\r\n              \"data\": {\r\n                \"type\": \"nested\",\r\n                \"properties\": {\r\n                  ...\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI filter with three condition:\r\n - \"_logType\" is \"crawler\".\r\n - \"_createdAt\" on \"2020-05-23\".\r\n - Size of \"resp\" = 0.\r\n\r\nI am trying to filter with query:\r\n```\r\nGET ntol-2020-*/_search\r\n    {\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"must\": [\r\n            {\r\n              \"term\": {\r\n                \"_logType\": {\r\n                  \"value\": \"crawler\"\r\n                }\r\n              }\r\n            },\r\n            {\r\n              \"range\": {\r\n                \"_createdAt\": {\r\n                  \"gte\": \"2020-05-23\",\r\n                  \"lte\": \"2020-05-23\",\r\n                  \"time_zone\": \"+07:00\"\r\n                }\r\n              }\r\n            },\r\n            {\r\n              \"nested\": {\r\n                \"path\": \"resp\",\r\n                \"query\": {\r\n                  \"script\": {\r\n                    \"script\": {\r\n                      \"source\": \"doc['resp'].size() > 0\"\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      \"from\": 0,\r\n      \"size\": 10\r\n    }\r\n```\r\nIt return error: \r\n```\r\n{\r\n  \"type\": \"script_exception\",\r\n  \"reason\": \"runtime error\",\r\n  \"script_stack\": [\r\n    \"org.elasticsearch.search.lookup.LeafDocLookup.get(LeafDocLookup.java:94)\",\r\n    \"org.elasticsearch.search.lookup.LeafDocLookup.get(LeafDocLookup.java:41)\",\r\n    \"doc['resp'].size() > 0\",\r\n    \"    ^---- HERE\"\r\n  ],\r\n  \"script\": \"doc['resp'].size() > 0\",\r\n  \"lang\": \"painless\",\r\n  \"caused_by\": {\r\n    \"type\": \"illegal_argument_exception\",\r\n    \"reason\": \"No field found for [resp] in mapping with types []\"\r\n  }\r\n}\r\n```\r\nIf I use script \"doc.containsKey('resp') && doc['resp'].size() > 0\" then It will return hits length = 0.\r\nHelp me. Thanks!","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}