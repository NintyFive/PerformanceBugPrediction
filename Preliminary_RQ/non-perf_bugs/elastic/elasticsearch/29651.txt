{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29651","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29651/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29651/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29651/events","html_url":"https://github.com/elastic/elasticsearch/issues/29651","id":316681693,"node_id":"MDU6SXNzdWUzMTY2ODE2OTM=","number":29651,"title":"composite and cardinality, it can't run in string type","user":{"login":"EnglishVillage","id":19756879,"node_id":"MDQ6VXNlcjE5NzU2ODc5","avatar_url":"https://avatars1.githubusercontent.com/u/19756879?v=4","gravatar_id":"","url":"https://api.github.com/users/EnglishVillage","html_url":"https://github.com/EnglishVillage","followers_url":"https://api.github.com/users/EnglishVillage/followers","following_url":"https://api.github.com/users/EnglishVillage/following{/other_user}","gists_url":"https://api.github.com/users/EnglishVillage/gists{/gist_id}","starred_url":"https://api.github.com/users/EnglishVillage/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/EnglishVillage/subscriptions","organizations_url":"https://api.github.com/users/EnglishVillage/orgs","repos_url":"https://api.github.com/users/EnglishVillage/repos","events_url":"https://api.github.com/users/EnglishVillage/events{/privacy}","received_events_url":"https://api.github.com/users/EnglishVillage/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-04-23T06:44:29Z","updated_at":"2018-04-23T13:02:05Z","closed_at":"2018-04-23T13:01:46Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\nfirst composite agg,then cardinality agg.\r\ncan't run in string type, cardinality result always  = 0\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.2.2\r\n\r\n**Plugins installed**: []\r\nanalysis-pinyin(chinese) and sql\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_111\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\ntest server:\r\nLinux testes1 2.6.32-431.el6.x86_64 #1 SMP Fri Nov 22 03:15:09 UTC 2013 x86_64 x86_64 x86_64 GNU/Linux\r\nserver:\r\nLinux server1 3.10.0-327.22.2.el7.x86_64 #1 SMP Thu Jun 23 17:05:11 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nif long type or date type, it can run.\r\nbut string type,it cat't run...\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1.\r\nmappings:\r\n{\r\n\t\"import_bidding\": {\r\n\t\t\"dynamic_templates\": [\r\n\t\t\t{\r\n\t\t\t\t\"stringfield\": {\r\n\t\t\t\t\t\"mapping\": { \"type\" : \"keyword\", \"doc_values\": \"false\" },\r\n\t\t\t\t\t\"match_mapping_type\": \"string\",\r\n\t\t\t\t\t\"match\": \"*\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t],\r\n\t\t\"properties\": {\r\n\t\t\t\"province\": { \"type\" : \"keyword\" },\r\n\t\t\t\"innCN\": { \"type\" : \"keyword\" },\r\n\t\t\t\"companyNameN\": { \"type\" : \"keyword\" },\r\n\t\t\t\"unitPrice\": { \"type\" : \"double\" }\r\n\t\t}\r\n\t}\r\n}\r\n 2.\r\nsettings:\r\n{\r\n\t\"settings\": {\r\n\t\t\"index.mapping.coerce\": true,\r\n\t\t\"index.mapping.ignore_malformed\": false,\r\n\t\t\"index.number_of_shards\": 3\r\n\t}\r\n}\r\n 3.\r\nquery:\r\n{\r\n\t\"size\": 0,\r\n\t\"timeout\": \"5m\",\r\n\t\"aggregations\": {\r\n\t\t\"innCN\": {\r\n\t\t\t\"composite\": {\r\n\t\t\t\t\"size\": 10,\r\n\t\t\t\t\"sources\": [{\r\n\t\t\t\t\t\"innCN\": {\r\n\t\t\t\t\t\t\"terms\": {\r\n\t\t\t\t\t\t\t\"field\": \"innCN\",\r\n\t\t\t\t\t\t\t\"order\": \"asc\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}, {\r\n\t\t\t\t\t\"companyNameN\": {\r\n\t\t\t\t\t\t\"terms\": {\r\n\t\t\t\t\t\t\t\"field\": \"companyNameN\",\r\n\t\t\t\t\t\t\t\"order\": \"asc\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}]\r\n\t\t\t},\r\n\t\t\t\"aggregations\": {\r\n\t\t\t\t\"unitPrice\": {\r\n\t\t\t\t\t\"percentiles\": {\r\n\t\t\t\t\t\t\"field\": \"unitPrice\",\r\n\t\t\t\t\t\t\"percents\": [50.0],\r\n\t\t\t\t\t\t\"keyed\": true,\r\n\t\t\t\t\t\t\"tdigest\": {\r\n\t\t\t\t\t\t\t\"compression\": 100.0\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n\t\t\t\t\"province\": {\r\n\t\t\t\t\t\"cardinality\": {\r\n\t\t\t\t\t\t\"field\": \"province\",\r\n\t\t\t\t\t\t\"precision_threshold\": 300\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n4.\r\nresult:\r\nprovince value should > 0\r\n[{innCN=阿司匹林, companyNameN=万邦德制药集团股份有限公司, unitPrice=0.0195, province=0.0}, {innCN=阿司匹林, companyNameN=上海上药信谊药厂有限公司, unitPrice=0.03475, province=0.0}, {innCN=阿司匹林, companyNameN=上海信谊百路达药业有限公司, unitPrice=0.042, province=0.0}, {innCN=阿司匹林, companyNameN=上海华源制药股份有限公司, unitPrice=0.048, province=0.0}, {innCN=阿司匹林, companyNameN=临汾宝珠制药有限公司, unitPrice=0.0409, province=0.0}, {innCN=阿司匹林, companyNameN=丹东医创药业有限责任公司, unitPrice=0.0197, province=0.0}, {innCN=阿司匹林, companyNameN=云南白药集团股份有限公司, unitPrice=0.047, province=0.0}, {innCN=阿司匹林, companyNameN=亚宝药业集团股份有限公司, unitPrice=0.026, province=0.0}, {innCN=阿司匹林, companyNameN=亿帆医药股份有限公司, unitPrice=0.158, province=0.0}, {innCN=阿司匹林, companyNameN=内蒙古通辽制药股份有限公司, unitPrice=0.08, province=0.0}]\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}