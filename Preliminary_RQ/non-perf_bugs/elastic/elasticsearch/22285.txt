{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22285","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22285/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22285/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22285/events","html_url":"https://github.com/elastic/elasticsearch/issues/22285","id":196771016,"node_id":"MDU6SXNzdWUxOTY3NzEwMTY=","number":22285,"title":"Broken stats serialization","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"labels":[{"id":146836529,"node_id":"MDU6TGFiZWwxNDY4MzY1Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Stats","name":":Core/Features/Stats","color":"0e8a16","default":false,"description":"Statistics tracking and retrieval APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null},{"id":492594588,"node_id":"MDU6TGFiZWw0OTI1OTQ1ODg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.1.2","name":"v5.1.2","color":"dddddd","default":false,"description":null},{"id":486905930,"node_id":"MDU6TGFiZWw0ODY5MDU5MzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.2.0","name":"v5.2.0","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":22,"created_at":"2016-12-20T20:21:49Z","updated_at":"2018-09-06T14:54:31Z","closed_at":"2016-12-23T14:44:57Z","author_association":"MEMBER","active_lock_reason":null,"body":"We have a serialization bug somewhere in the stats serialization code. I've now seen ~~five~~ six independent reports ([2](https://github.com/elastic/elasticsearch/pull/21478#issuecomment-264607855), [4](https://discuss.elastic.co/t/random-exceptions-on-transport-layer-and-subsequent-node-disconnections/68704), [5](https://discuss.elastic.co/t/remote-transport-exception-in-5-1-1-w-jdk-1-8-0-111/69607) and ~~two~~ three more that are not linkable) of:\r\n\r\n```\r\n[2016-12-12T09:26:50,081][WARN ][o.e.t.n.Netty4Transport  ] [...] exception caught on transport layer [[id: 0xcbdaf621, L:/...:35678 - R:.../...:9300]], closing connection\r\njava.lang.IllegalStateException: Message not fully read (response) for requestId [...], handler [org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler/org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction$1@44aa70c], error [false]; resetting\r\n    at org.elasticsearch.transport.TcpTransport.messageReceived(TcpTransport.java:1257) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n```\r\n\r\nand the related\r\n\r\n```\r\nCaused by: java.io.EOFException: tried to read: 91755306 bytes but only 114054 remaining\r\n```\r\n\r\nand\r\n\r\n```\r\nCaused by: java.lang.IllegalStateException: No routing state mapped for [103]\r\n    at org.elasticsearch.cluster.routing.ShardRoutingState.fromValue(ShardRoutingState.java:71) ~[elasticsearch-5.1.1.jar:5.1.1]\r\n```\r\n\r\nIt seems to always be in some stats response, either a node stats response, or a cluster stats response and it's coming from `TransportBroadcastByNodeAction` and the single action defined by a lambda in `TransportNodesAction$AsyncAction`. We are blowing reading the stream somewhere and then reading garbage subsequently.\r\n\r\nWhatever it is, it's pesky. So far, there is not a reliable reproduction and finding the bug is tricky since these responses serialize the entire world.\r\n\r\nThe first instance of this led to #21478 so that we know the handler name, #22152 so we can detect corruption earlier, and #22223 to clean up some serialization code. Right now, I do not think we've squashed the issue.\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}