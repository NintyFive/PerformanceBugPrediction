[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/533678827","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-533678827","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":533678827,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMzY3ODgyNw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-09-20T19:19:40Z","updated_at":"2019-09-20T19:19:40Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/533899962","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-533899962","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":533899962,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMzg5OTk2Mg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-09-22T17:16:40Z","updated_at":"2019-09-22T17:17:23Z","author_association":"CONTRIBUTOR","body":"```\r\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:329)\r\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.applyStartedShards(AllocationService.java:100)\r\n```\r\n\r\nSince https://github.com/elastic/elasticsearch/pull/44433 (i.e. 7.4.0) `applyStartedShards` no longer calls `reroute`.\r\n\r\n> cluster of 50 nodes and 3,000 indices, 60,000 shard ... about 6,000 shards on one node\r\n\r\nI don't fully understand how these numbers add up, but I can say that this is an unreasonably large number of shards per node. Since #34892 (i.e. 7.0.0) you are forbidden from having so many shards in a cluster of this size.\r\n\r\n> if we could set the `cluster.routing.allocation.disk.include_relocations` to be `false` by default\r\n\r\nI can't recommend this and don't think it will be acceptable as a default. If you set this setting to `false` you will continue to experience the kinds of overshoot fixed by #46079.\r\n\r\nThere may be improvements to make in this area, but we need to investigate whether the issue described here still exists in clusters running a more recent version and with a configuration that's within recommended limits.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/533980597","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-533980597","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":533980597,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMzk4MDU5Nw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-09-23T06:59:50Z","updated_at":"2019-09-23T06:59:50Z","author_association":"CONTRIBUTOR","body":"The time spent finding the initialising and relocating shards when computing relocations is heavily dependent on the number of shards per node. Measuring no-op reroutes in which there are no shards moving (the common case) and the disk threshold decider is in play:\r\n\r\n| Shards  | Nodes | Shards per node | Reroute time without relocations | Reroute time with relocations |\r\n| ------- | ----- | --------------- | -------------------------------- | ----------------------------- |\r\n| 60000   | 10    | 6000            | ~250ms                           | ~15000ms                      |\r\n| 60000   | 60    | 1000            | ~250ms                           | ~4000ms                       |\r\n| 10000   | 10    | 1000            | ~60ms                            | ~250ms                        |\r\n\r\nThis shows that the savings are significant when you have too many shards per node, but much less dramatic in clusters that respect the 1000-shards-per-node limit.\r\n\r\nWe could for instance precompute the `INITIALIZING` and `RELOCATING` shards on each `RoutingNode` rather than scanning for them afresh each time. Given the data above I'm not sure the extra complexity is worth it, but I'm marking this for team discussion to get others' inputs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534868811","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-534868811","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":534868811,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDg2ODgxMQ==","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"created_at":"2019-09-25T06:07:41Z","updated_at":"2019-09-25T06:07:41Z","author_association":"CONTRIBUTOR","body":"It's my pleasure to wait for your reply.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/537505564","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-537505564","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":537505564,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNzUwNTU2NA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-10-02T13:59:36Z","updated_at":"2019-10-02T13:59:36Z","author_association":"CONTRIBUTOR","body":"@kkewwei we discussed this today and think it could be worthwhile to explore adding some precomputation to `RoutingNode` to track the `INITIALIZING` and `RELOCATING` shards for easy access by the disk-based shard allocator. We were not convinced that it is definitely worth pursuing, it depends how simple the change is. Would you be interested in opening a PR for that?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/537509769","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-537509769","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":537509769,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNzUwOTc2OQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-10-02T14:08:49Z","updated_at":"2019-10-02T14:08:49Z","author_association":"CONTRIBUTOR","body":"We also agreed that setting `include_relocations` to `false` is a bad idea, so I've opened https://github.com/elastic/elasticsearch/pull/47443 to deprecate this setting and will remove it in a future release.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/537949190","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-537949190","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":537949190,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNzk0OTE5MA==","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"created_at":"2019-10-03T13:37:32Z","updated_at":"2019-10-03T13:37:32Z","author_association":"CONTRIBUTOR","body":"@DaveCTurner, I would like to do it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/539375697","html_url":"https://github.com/elastic/elasticsearch/issues/46941#issuecomment-539375697","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46941","id":539375697,"node_id":"MDEyOklzc3VlQ29tbWVudDUzOTM3NTY5Nw==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-10-08T07:12:27Z","updated_at":"2019-10-08T07:12:27Z","author_association":"CONTRIBUTOR","body":"Thanks for volunteering @kkewwei, looking forward to seeing your PR.","performed_via_github_app":null}]