{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22825","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22825/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22825/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22825/events","html_url":"https://github.com/elastic/elasticsearch/issues/22825","id":203484040,"node_id":"MDU6SXNzdWUyMDM0ODQwNDA=","number":22825,"title":"Inconsistent results with ingest pipeline _simulate ","user":{"login":"anderssynstad","id":1648315,"node_id":"MDQ6VXNlcjE2NDgzMTU=","avatar_url":"https://avatars1.githubusercontent.com/u/1648315?v=4","gravatar_id":"","url":"https://api.github.com/users/anderssynstad","html_url":"https://github.com/anderssynstad","followers_url":"https://api.github.com/users/anderssynstad/followers","following_url":"https://api.github.com/users/anderssynstad/following{/other_user}","gists_url":"https://api.github.com/users/anderssynstad/gists{/gist_id}","starred_url":"https://api.github.com/users/anderssynstad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/anderssynstad/subscriptions","organizations_url":"https://api.github.com/users/anderssynstad/orgs","repos_url":"https://api.github.com/users/anderssynstad/repos","events_url":"https://api.github.com/users/anderssynstad/events{/privacy}","received_events_url":"https://api.github.com/users/anderssynstad/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"assignees":[{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2017-01-26T20:45:39Z","updated_at":"2018-03-15T15:41:51Z","closed_at":"2018-03-15T15:41:51Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.1\r\n\r\n**Plugins installed**: [none] \r\n\r\n**JVM version**: openjdk-8-jre-headless:amd64 8u121-b13-0ubuntu1.16.04.2\r\n\r\n**OS version**: Ubuntu 16.04.1\r\n\r\n**Description of the problem including expected versus actual behavior**: Ingest pipeline appears to give inconsistent results given the following datasets:\r\n\r\nSET 1:\r\n```\r\ncurl -XPUT localhost:9200/_ingest/pipeline/myingest -d'\r\n{\r\n  \"processors\": [\r\n    {\r\n      \"split\": {\r\n        \"field\": \"dev_environment\",\r\n        \"separator\": \";\",\r\n        \"ignore_missing\": true\r\n      },\r\n      \"foreach\": {\r\n        \"field\": \"dev_environment\",\r\n        \"ignore_failure\": true,\r\n        \"processor\": {\r\n          \"trim\": {\r\n            \"field\": \"_ingest._value\",\r\n            \"ignore_missing\": true\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}'\r\n```\r\n\r\n\r\nSET 2:\r\n```\r\ncurl -XPOST localhost:9200/_ingest/pipeline/myingest/_simulate -d'\r\n{\r\n  \"docs\": [\r\n    { \"_source\": { \"dev_environment\": \"Notepad++; Visual Studio\" }},\r\n    { \"_source\": { \"dev_environment\": \"Notepad++\" }},\r\n    { \"_source\": { \"dev_environment\": \"Sublime; Visual Studio\" }},\r\n    { \"_source\": { }}\r\n  ]\r\n}'\r\n```\r\n\r\n\r\nRunning SET 1 & 2 gives the expected result. But when you combine the two into SET 3:\r\n\r\nSET 3:\r\n```\r\ncurl -XPOST localhost:9200/_ingest/pipeline/_simulate -d'\r\n{\r\n\"pipeline\": {\r\n  \"processors\": [\r\n    {\r\n      \"split\": {\r\n        \"field\": \"dev_environment\",\r\n        \"separator\": \";\",\r\n        \"ignore_missing\": true\r\n      },\r\n      \"foreach\": {\r\n        \"field\": \"dev_environment\",\r\n        \"ignore_failure\": true,\r\n        \"processor\": {\r\n          \"trim\": {\r\n            \"field\": \"_ingest._value\",\r\n            \"ignore_missing\": true\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n},\r\n  \"docs\": [\r\n    { \"_source\": { \"dev_environment\": \"Notepad++; Visual Studio\" }},\r\n    { \"_source\": { \"dev_environment\": \"Notepad++\" }},\r\n    { \"_source\": { \"dev_environment\": \"Sublime; Visual Studio\" }},\r\n    { \"_source\": { }}\r\n  ]\r\n}'\r\n```\r\n\r\n\r\nRunning SET 3 seems to work, but if the trim processor actually fails. If you remove _\"ignore_failure\": true,_ it'll get an exception.\r\n\r\nIn order to get SET 3 to work, one has to fix the processor objects as done in SET 4.\r\n\r\nSET 4:\r\n```\r\ncurl -XPOST localhost:9200/_ingest/pipeline/_simulate -d'\r\n{\r\n\"pipeline\": {\r\n  \"processors\": [\r\n    {\r\n      \"split\": {\r\n        \"field\": \"dev_environment\",\r\n        \"separator\": \";\",\r\n        \"ignore_missing\": true\r\n      }},{\r\n      \"foreach\": {\r\n        \"field\": \"dev_environment\",\r\n        \"ignore_failure\": true,\r\n        \"processor\": {\r\n          \"trim\": {\r\n            \"field\": \"_ingest._value\",\r\n            \"ignore_missing\": true\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n},\r\n  \"docs\": [\r\n    { \"_source\": { \"dev_environment\": \"Notepad++; Visual Studio\" }},\r\n    { \"_source\": { \"dev_environment\": \"Notepad++\" }},\r\n    { \"_source\": { \"dev_environment\": \"Sublime; Visual Studio\" }},\r\n    { \"_source\": { }}\r\n  ]\r\n}'\r\n```\r\n\r\n\r\nSET 4 gives the expected results. \r\n\r\nThe claim is that SET 1 + 2 *should* give the same result as SET 3, but it does not. SET 3 requires syntax change in order to work.\r\n\r\n**Steps to reproduce**:\r\n 1. Run SET 1 + SET 2. Observe they work as expected.\r\n 2. Run SET 3. Observe the trim fails to run.\r\n 3. Run SET 4. Observe change results in expected result.\r\n\r\nSorry for potato code snippets.\r\n","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}