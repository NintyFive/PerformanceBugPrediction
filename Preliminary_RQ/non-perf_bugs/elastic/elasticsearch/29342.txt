{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29342","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29342/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29342/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29342/events","html_url":"https://github.com/elastic/elasticsearch/issues/29342","id":310669070,"node_id":"MDU6SXNzdWUzMTA2NjkwNzA=","number":29342,"title":"There doesn't seem to be a way to know when the o.e.l.LicenseService has finished. Until that point authentication fails on requests","user":{"login":"brett--anderson","id":1491094,"node_id":"MDQ6VXNlcjE0OTEwOTQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1491094?v=4","gravatar_id":"","url":"https://api.github.com/users/brett--anderson","html_url":"https://github.com/brett--anderson","followers_url":"https://api.github.com/users/brett--anderson/followers","following_url":"https://api.github.com/users/brett--anderson/following{/other_user}","gists_url":"https://api.github.com/users/brett--anderson/gists{/gist_id}","starred_url":"https://api.github.com/users/brett--anderson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brett--anderson/subscriptions","organizations_url":"https://api.github.com/users/brett--anderson/orgs","repos_url":"https://api.github.com/users/brett--anderson/repos","events_url":"https://api.github.com/users/brett--anderson/events{/privacy}","received_events_url":"https://api.github.com/users/brett--anderson/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-04-03T02:12:00Z","updated_at":"2018-04-03T08:15:11Z","closed_at":"2018-04-03T08:15:10Z","author_association":"NONE","active_lock_reason":null,"body":"**Elastic Search Version**\r\nVersion: 5.4.0, Build: 780f8c4/2017-04-28T17:43:27.229Z\r\n\r\n**Plugins**\r\nanalysis-icu\r\n\r\n**JVM**\r\nJVM: 1.8.0_131\r\n\r\n**OS**\r\nLinux 4464d613c8d6 4.9.60-linuxkit-aufs #1 SMP Mon Nov 6 16:00:12 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\nInside official Docker image for 5.4, though with a different docker-entrypoint.sh script\r\n\r\n**Problem**\r\nWhen running an initialization script to create a new index on startup, authentication fails with default username and password (elastic:changeme). Waiting a few seconds then manually running the exact same command works perfectly. My current workaround is to call the health status endpoint in a loop until the request doesn't fail from an authentication error, then I run my index init script. This feels hacky.\r\n\r\n**Steps to reproduce**:\r\nDockerfile\r\n```\r\nFROM docker.elastic.co/elasticsearch/elasticsearch:5.4.0\r\nRUN bin/elasticsearch-plugin install analysis-icu\r\n\r\nCOPY docker-entrypoint.sh /docker-entrypoint.sh\r\nCOPY config/elasticsearch.yml config/elasticsearch.yml\r\nCOPY config/setup.sh config/setup.sh\r\nRUN mkdir utils\r\nCOPY utils/wait-for-it.sh utils/wait-for-it.sh\r\n\r\nUSER root\r\nRUN chmod +x /docker-entrypoint.sh utils/wait-for-it.sh config/setup.sh\r\nRUN chown -R elasticsearch:elasticsearch /docker-entrypoint.sh utils/wait-for-it.sh config/setup.sh\r\n\r\nUSER elasticsearch\r\nENTRYPOINT [\"/docker-entrypoint.sh\"]\r\nCMD [\"/usr/share/elasticsearch/bin/elasticsearch\"]\r\n```\r\nelasticsearch.yml\r\n```\r\ncluster.name: \"docker-cluster\"\r\nnetwork.host: 0.0.0.0\r\n\r\n# minimum_master_nodes need to be explicitly set when bound on a public IP\r\n# set to 1 to allow single node clusters\r\n# Details: https://github.com/elastic/elasticsearch/pull/17288\r\ndiscovery.zen.minimum_master_nodes: 1\r\n\r\n# By default the low water mark threshold will stop the node from starting \r\n# if your dev machine doesn't have at least 15% free. This is generally\r\n# less of a mission critical threshold when in Docker on a dev machine\r\ncluster.routing.allocation.disk.threshold_enabled: false\r\n```\r\ndocker-entrypoint.sh\r\n```\r\n#!/bin/sh\r\n\r\n# wait for Elasticsearch to start, then run the setup script to\r\n# create and configure the index.\r\nexec /usr/share/elasticsearch/utils/wait-for-it.sh localhost:9200 -- /usr/share/elasticsearch/config/setup.sh &\r\nexec $@ \r\n```\r\nsetup.sh\r\n```\r\n#!/bin/sh\r\n\r\necho Initiating Elasticsearch Custom Index\r\n# move to the directory of this setup script\r\ncd \"$(dirname \"$0\")\"\r\n\r\n# for some reason even when port 9200 is open Elasticsearch is unable to be accessed as authentication fails\r\n# a few seconds later it works\r\nuntil $(curl -sSf -XGET --insecure --user elastic:changeme 'http://localhost:9200/_cluster/health?wait_for_status=yellow' > /dev/null); do\r\n    printf 'AUTHENTICATION ERROR DUE TO X-PACK, trying again in 5 seconds \\n'\r\n    sleep 5\r\ndone\r\n\r\n# create a new index with the settings in es_index_config.json\r\ncurl -v --insecure --user elastic:changeme -XPUT '0.0.0.0:9200/test?pretty' -H 'Content-Type: application/json' -d @es_index_config.json\r\n```\r\n\r\n [wait-fot-it.sh](https://raw.githubusercontent.com/vishnubob/wait-for-it/master/wait-for-it.sh)\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[WARN ][o.e.x.s.a.AuthenticationService] [TL7bL2I] An unexpected error occurred while attempting to authenticate [elastic] against realm [reserved]\r\norg.elasticsearch.ElasticsearchSecurityException: failed to authenticate user [elastic]\r\n...\r\ncurl: (22) The requested URL returned error: 401\r\n```\r\nThen after the loop in setup.sh waits 5 seconds\r\n```\r\n[2018-04-03T02:00:17,596][INFO ][o.e.l.LicenseService     ] [TL7bL2I] license [bafce55a-1a94-43a4-b3c2-827ec185e237] mode [trial] - valid\r\n* About to connect() to 0.0.0.0 port 9200 (#0)\r\n*   Trying 0.0.0.0...\r\n* Connected to 0.0.0.0 (0.0.0.0) port 9200 (#0)\r\n* Server auth using Basic with user 'elastic'\r\n```\r\n","closed_by":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}