{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23796/events","html_url":"https://github.com/elastic/elasticsearch/issues/23796","id":217880338,"node_id":"MDU6SXNzdWUyMTc4ODAzMzg=","number":23796,"title":"source filtering on nested properties no longer returning empty[] when no nested documents.","user":{"login":"murfee25","id":22906205,"node_id":"MDQ6VXNlcjIyOTA2MjA1","avatar_url":"https://avatars2.githubusercontent.com/u/22906205?v=4","gravatar_id":"","url":"https://api.github.com/users/murfee25","html_url":"https://github.com/murfee25","followers_url":"https://api.github.com/users/murfee25/followers","following_url":"https://api.github.com/users/murfee25/following{/other_user}","gists_url":"https://api.github.com/users/murfee25/gists{/gist_id}","starred_url":"https://api.github.com/users/murfee25/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/murfee25/subscriptions","organizations_url":"https://api.github.com/users/murfee25/orgs","repos_url":"https://api.github.com/users/murfee25/repos","events_url":"https://api.github.com/users/murfee25/events{/privacy}","received_events_url":"https://api.github.com/users/murfee25/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":19,"created_at":"2017-03-29T13:44:01Z","updated_at":"2020-10-20T09:36:09Z","closed_at":"2020-05-13T20:21:15Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.2.2\r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version**: 1.8.0_111\r\n\r\n**OS version**: Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nJust ungraded from 5.0.1 and now hitting this issue.\r\nWhen a document contains no nested documents in its array property and we use source filtering to exclude any nested document property, the result is missing the entire nested documents empty array property.\r\n\r\n**Steps to reproduce**:\r\n 1. Create document with nested document array property\r\n ```\r\n{\r\n  \"mydocument\": {\r\n    \"properties\": {\r\n      \"mynesteddocuments\": {\r\n        \"type\": \"nested\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Add couple of documents, 1 of which should have empty array of nesteddocuments\r\n```\r\n{\r\n  \"strprop\": \"document string property\",\r\n  \"boolprop\": true,\r\n  \"intprop\": 54321,\r\n  \"mynesteddocuments\": []\r\n}\r\n```\r\n 3. Search for the documents with source filtering to exclude say the \"intprop\" property.\r\n```\r\n{\r\n  \"_source\": {\r\n    \"excludes\": [\r\n      \"mynesteddocuments.intprop\"\r\n    ]\r\n  },\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  }\r\n}\r\n```\r\n  4. For documents with nesteddocuments it correctly excludes the \"intprop\" but for the documents with empty nested documents array... this property is completely missing.\r\nPreviously it always returned an empty [] which we relied on in code and it would be painful to have to introduce checks for nulls now.\r\n\r\nBelieve it may be somewhat related to #22557 and #22593\r\n\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}