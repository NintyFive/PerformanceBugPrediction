{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10158","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10158/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10158/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10158/events","html_url":"https://github.com/elastic/elasticsearch/issues/10158","id":62966786,"node_id":"MDU6SXNzdWU2Mjk2Njc4Ng==","number":10158,"title":"Defining Grandparents aggregations, getting a NullPointer","user":{"login":"paolociccarese","id":798736,"node_id":"MDQ6VXNlcjc5ODczNg==","avatar_url":"https://avatars0.githubusercontent.com/u/798736?v=4","gravatar_id":"","url":"https://api.github.com/users/paolociccarese","html_url":"https://github.com/paolociccarese","followers_url":"https://api.github.com/users/paolociccarese/followers","following_url":"https://api.github.com/users/paolociccarese/following{/other_user}","gists_url":"https://api.github.com/users/paolociccarese/gists{/gist_id}","starred_url":"https://api.github.com/users/paolociccarese/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/paolociccarese/subscriptions","organizations_url":"https://api.github.com/users/paolociccarese/orgs","repos_url":"https://api.github.com/users/paolociccarese/repos","events_url":"https://api.github.com/users/paolociccarese/events{/privacy}","received_events_url":"https://api.github.com/users/paolociccarese/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2015-03-19T12:06:35Z","updated_at":"2015-03-28T07:49:21Z","closed_at":"2015-03-28T07:49:21Z","author_association":"NONE","active_lock_reason":null,"body":"I am using Elasticsearch 1.4.4.\nI am defining a parent-child index with three levels (grandparents) following the instructions in the document: https://www.elastic.co/guide/en/elasticsearch/guide/current/grandparents.html\nMy structure is Continent -> Country -> Region\n## MAPPING\n\nI create an index with the following mapping:\n\n```\ncurl -XPOST 'localhost:9200/geo' -d'\n{\n  \"mappings\": {\n    \"continent\": {},\n    \"country\": {\n    \"_parent\": {\n      \"type\": \"continent\" \n    }\n  },\n  \"region\": {\n    \"_parent\": {\n     \"type\": \"country\" \n  }\n}\n}\n}' \n```\n## INDEXING\n\nI index three entities:\n\n```\ncurl -XPOST 'localhost:9200/geo/continent/europe' -d'\n{\n  \"name\":\"Europe\"\n}'\n\ncurl -XPOST 'localhost:9200/geo/country/italy?parent=europe' -d'\n{\n  \"name\":\"Italy\"\n}'\n\ncurl -XPOST 'localhost:9200/geo/region/lombardy?parent=italy&routing=europe' -d'\n{\n  \"name\":\"Lombardia\"\n}'\n```\n## QUERY THAT WORKS\n\nIf I query and aggregate according to the document everything works fine:\n\n```\ncurl -XGET 'localhost:9200/geo/continent/_search?pretty=true' -d '\n{\n\"query\": {\n    \"has_child\": {\n        \"type\": \"country\",\n        \"query\": {\n            \"has_child\": {\n            \"type\": \"region\",\n                \"query\": {\n                    \"match\": {\n                        \"name\": \"Lombardia\"\n                    }\n                }\n            }\n        }\n    }\n},\n\"aggs\": {\n    \"country\": {\n        \"terms\": { \n            \"field\": \"name\"\n        },\n        \"aggs\": {\n            \"countries\": {\n                \"children\": {\n                    \"type\": \"country\"\n                },\n                \"aggs\": {\n                    \"country_names\" : {\n                        \"terms\" :  {\n                            \"field\" : \"country.name\"\n                        }\n                    }                   \n                }\n            }\n        }\n    }\n}\n}'\n```\n## QUERY THAT DOES NOT WORK\n\nHowever, if I try with multi-level aggregations like in:\n\n```\ncurl -XGET 'localhost:9200/geo/continent/_search?pretty=true' -d '\n{\n\"query\": {\n    \"has_child\": {\n        \"type\": \"country\",\n        \"query\": {\n            \"has_child\": {\n            \"type\": \"region\",\n                \"query\": {\n                    \"match\": {\n                        \"name\": \"Lombardia\"\n                    }\n                }\n            }\n        }\n    }\n},\n\"aggs\": {\n    \"continent_names\": {\n        \"terms\": { \n            \"field\": \"name\"\n        },\n        \"aggs\": {\n            \"countries\": {\n                \"children\": {\n                    \"type\": \"country\"\n                },                  \n                \"aggs\": {\n                    \"regions\": {\n                        \"children\": {\n                            \"type\": \"region\"\n                        }, \n                        \"aggs\": {\n                            \"region_names\" : {\n                                \"terms\" :  {\n                                    \"field\" : \"region.name\"\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n}'\n```\n\nI get back the following\n{\n\n  \"error\" : \"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[b5CbW5byQdSSW-rIwta0rA][geo][0]: QueryPhaseExecutionException[[geo][0]: query[filtered(child_filter[country/continent](filtered%28child_filter[region/country]%28filtered%28name:lombardia%29->cache%28_type:region%29%29%29->cache%28_type:country%29))->cache(_type:continent)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: NullPointerException; }{[b5CbW5byQdSSW-rIwta0rA][geo][1]: QueryPhaseExecutionException[[geo][1]: query[filtered(child_filter[country/continent](filtered%28child_filter[region/country]%28filtered%28name:lombardia%29->cache%28_type:region%29%29%29->cache%28_type:country%29))->cache(_type:continent)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: NullPointerException; }{[b5CbW5byQdSSW-rIwta0rA][geo][2]: QueryPhaseExecutionException[[geo][2]: query[filtered(child_filter[country/continent](filtered%28child_filter[region/country]%28filtered%28name:lombardia%29->cache%28_type:region%29%29%29->cache%28_type:country%29))->cache(_type:continent)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: NullPointerException; }{[b5CbW5byQdSSW-rIwta0rA][geo][3]: QueryPhaseExecutionException[[geo][3]: query[filtered(child_filter[country/continent](filtered%28child_filter[region/country]%28filtered%28name:lombardia%29->cache%28_type:region%29%29%29->cache%28_type:country%29))->cache(_type:continent)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: NullPointerException; }{[b5CbW5byQdSSW-rIwta0rA][geo][4]: QueryPhaseExecutionException[[geo][4]: query[filtered(child_filter[country/continent](filtered%28child_filter[region/country]%28filtered%28name:lombardia%29->cache%28_type:region%29%29%29->cache%28_type:country%29))->cache(_type:continent)],from[0],size[10]: Query Failed [Failed to execute main query]]; nested: NullPointerException; }]\",\n\n  \"status\" : 500\n\n}\n\nThe 'grandparents' document says: \"Querying and aggregating across generations works, as long as you step through each generation.\"\n\nHow do I get the last query and aggregation to work across all three levels of the index?\n\nWhat am I missing?\n\nThank you,\nPaolo\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}