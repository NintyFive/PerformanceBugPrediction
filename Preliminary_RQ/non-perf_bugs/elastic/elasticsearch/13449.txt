{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13449","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13449/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13449/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13449/events","html_url":"https://github.com/elastic/elasticsearch/issues/13449","id":105735972,"node_id":"MDU6SXNzdWUxMDU3MzU5NzI=","number":13449,"title":"Top level parent child inner_hits doesn't use correct mapping","user":{"login":"masaruh","id":572174,"node_id":"MDQ6VXNlcjU3MjE3NA==","avatar_url":"https://avatars3.githubusercontent.com/u/572174?v=4","gravatar_id":"","url":"https://api.github.com/users/masaruh","html_url":"https://github.com/masaruh","followers_url":"https://api.github.com/users/masaruh/followers","following_url":"https://api.github.com/users/masaruh/following{/other_user}","gists_url":"https://api.github.com/users/masaruh/gists{/gist_id}","starred_url":"https://api.github.com/users/masaruh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/masaruh/subscriptions","organizations_url":"https://api.github.com/users/masaruh/orgs","repos_url":"https://api.github.com/users/masaruh/repos","events_url":"https://api.github.com/users/masaruh/events{/privacy}","received_events_url":"https://api.github.com/users/masaruh/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-09-10T05:42:08Z","updated_at":"2015-09-19T12:11:18Z","closed_at":"2015-09-14T08:36:09Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"If type is specified, it uses parent's mapping for inner hits:\n\n```\nDELETE test\n\nPUT test\n{\n  \"mappings\": {\n    \"parent\": {},\n    \"child\": {\n      \"_parent\": {\n        \"type\": \"parent\"\n      }\n    }\n  }\n}\n\nPOST test/parent/1\n{\"name\": \"parent1\"}\n\nPOST test/child/1?parent=1\n{\"name\": \"child1\", \"num\": 1}\n\n# Without type\n# This works.\nGET test/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"child\",\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"inner_hits\": {\n        \"sort\":\"num\"\n      }\n    }\n  }\n}\n\n# With type\n# This gets parse failure saying \"No mapping found for [num] in order to sort on\"\nGET test/parent/_search\n{\n  \"query\": {\n    \"has_child\": {\n      \"type\": \"child\",\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"inner_hits\": {\n        \"sort\":\"num\"\n      }\n    }\n  }\n}\n```\n\nLooks like it's because `SubSearchContext` uses `type` for main query while parsing sub search.\n\nNote, this happens in 1.7.1 but not 2.x thanks to great mapping refactoring.\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}