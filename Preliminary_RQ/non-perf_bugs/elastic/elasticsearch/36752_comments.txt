[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448086564","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-448086564","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":448086564,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODA4NjU2NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-12-18T03:46:03Z","updated_at":"2018-12-18T03:46:03Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/451001153","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-451001153","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":451001153,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MTAwMTE1Mw==","user":{"login":"amishra123","id":20824743,"node_id":"MDQ6VXNlcjIwODI0NzQz","avatar_url":"https://avatars3.githubusercontent.com/u/20824743?v=4","gravatar_id":"","url":"https://api.github.com/users/amishra123","html_url":"https://github.com/amishra123","followers_url":"https://api.github.com/users/amishra123/followers","following_url":"https://api.github.com/users/amishra123/following{/other_user}","gists_url":"https://api.github.com/users/amishra123/gists{/gist_id}","starred_url":"https://api.github.com/users/amishra123/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amishra123/subscriptions","organizations_url":"https://api.github.com/users/amishra123/orgs","repos_url":"https://api.github.com/users/amishra123/repos","events_url":"https://api.github.com/users/amishra123/events{/privacy}","received_events_url":"https://api.github.com/users/amishra123/received_events","type":"User","site_admin":false},"created_at":"2019-01-02T22:10:53Z","updated_at":"2019-01-02T22:10:53Z","author_association":"NONE","body":"hi there, I would like to work on this :).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/452886340","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-452886340","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":452886340,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1Mjg4NjM0MA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-01-09T22:05:40Z","updated_at":"2019-01-09T22:05:40Z","author_association":"MEMBER","body":"@amishra123 sure, have at it :)\r\n\r\nFair warning, I only skimmed over the various parts of code when opening this issue, so it may be trickier than I thought once you get deep into the guts of it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521031424","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-521031424","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":521031424,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTAzMTQyNA==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2019-08-13T22:22:28Z","updated_at":"2019-08-13T22:22:28Z","author_association":"CONTRIBUTOR","body":"hi @amishra123, are you still interested in tackling this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/542139802","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-542139802","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":542139802,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MjEzOTgwMg==","user":{"login":"xjtushilei","id":23448336,"node_id":"MDQ6VXNlcjIzNDQ4MzM2","avatar_url":"https://avatars2.githubusercontent.com/u/23448336?v=4","gravatar_id":"","url":"https://api.github.com/users/xjtushilei","html_url":"https://github.com/xjtushilei","followers_url":"https://api.github.com/users/xjtushilei/followers","following_url":"https://api.github.com/users/xjtushilei/following{/other_user}","gists_url":"https://api.github.com/users/xjtushilei/gists{/gist_id}","starred_url":"https://api.github.com/users/xjtushilei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xjtushilei/subscriptions","organizations_url":"https://api.github.com/users/xjtushilei/orgs","repos_url":"https://api.github.com/users/xjtushilei/repos","events_url":"https://api.github.com/users/xjtushilei/events{/privacy}","received_events_url":"https://api.github.com/users/xjtushilei/received_events","type":"User","site_admin":false},"created_at":"2019-10-15T10:08:10Z","updated_at":"2019-10-15T10:08:10Z","author_association":"CONTRIBUTOR","body":"I have encountered the same problem. \r\nThe valuecount performance is too bad. \r\nCan I comment out this part of the code?  Especially to sort the array, etc.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/542242675","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-542242675","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":542242675,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MjI0MjY3NQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-10-15T14:32:06Z","updated_at":"2019-10-15T14:32:06Z","author_association":"MEMBER","body":"Hi @xjtushilei, afraid it's not that easy :)  The data is actually already pre-sorted (most doc values are sorted when they are indexed, or if they are a single-valued field there is no sorting at all).  \r\n\r\nThere's not an easy/simple way to fix this, since we'll need specialized version for each data type.  Fetching the bytes value (and resulting string casting) is simple because it applies to all data types.  But to make it more efficient, we need the aggregator to create a specialized internal aggregator that knows how to use strings vs longs vs geo points, etc.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/542268820","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-542268820","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":542268820,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MjI2ODgyMA==","user":{"login":"xjtushilei","id":23448336,"node_id":"MDQ6VXNlcjIzNDQ4MzM2","avatar_url":"https://avatars2.githubusercontent.com/u/23448336?v=4","gravatar_id":"","url":"https://api.github.com/users/xjtushilei","html_url":"https://github.com/xjtushilei","followers_url":"https://api.github.com/users/xjtushilei/followers","following_url":"https://api.github.com/users/xjtushilei/following{/other_user}","gists_url":"https://api.github.com/users/xjtushilei/gists{/gist_id}","starred_url":"https://api.github.com/users/xjtushilei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xjtushilei/subscriptions","organizations_url":"https://api.github.com/users/xjtushilei/orgs","repos_url":"https://api.github.com/users/xjtushilei/repos","events_url":"https://api.github.com/users/xjtushilei/events{/privacy}","received_events_url":"https://api.github.com/users/xjtushilei/received_events","type":"User","site_admin":false},"created_at":"2019-10-15T15:25:27Z","updated_at":"2019-10-15T15:25:27Z","author_association":"CONTRIBUTOR","body":"Thanks for your answer. @polyfractal   \r\nValuecount is just counting the number, and doing something that I think is meaningless, maybe I don't understand his role. I want to say a phenomenon, I found that ValueCountAgg is slower than SumAgg, which is beyond my common sense. So valueCount can be made much simpler.\r\n\r\nThe optimization I want to do is\r\n1. Remove the sort. I found out why sorting is also needed in SortedBinaryDocValues.advanceExact.I have timed this part of the code, which consumes a lot of time.\r\n\r\n```\r\n                grow();\r\n                for (int i = 0; i < count; ++i) {\r\n                    final CharSequence s = list.get(i);\r\n                    values[i].copyChars(s);\r\n                }\r\n                sort();\r\n``` \r\nI think the sort may not be used.\r\n2. Only take out the data for counting up, do not need to convert to string\r\n\r\n\r\nIs this feasible?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/542280304","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-542280304","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":542280304,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MjI4MDMwNA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-10-15T15:49:56Z","updated_at":"2019-10-15T15:49:56Z","author_association":"MEMBER","body":"Ah, I see the sort you are referring to.  Yes, the purpose of this issue is to remove this sorting behavior, which I agree is unnecessary.  :)\r\n\r\nIt's a side effect of how the aggregation framework is structured, and not as simple as just removing the `sort()` though.  This part of the code is used by other aggregations which rely on the sorted behavior.  It isn't needed for `value_count`, but is needed for other aggs.\r\n\r\nThe reason this is happening is because `value_count` accepts any data type (`ValuesSourceType.ANY`).  The only method that all the different ValuesSources share is `bytesValue()`, which returns or converts the values into a byte representation.  For some fields (like strings) the data is already in a bytes format and no work is done.  Other fields like numerics are converted to strings first, which then needs to be re-sorted.  \r\n\r\nWhich is all redundant work for `value_count`.\r\n\r\nSo the purpose of this ticket is to introduce new, specialized forms of ValueCount for each data type.  These could be either distinct aggregators like how we do it with terms aggs (e.g. `LongValueCountAggregator`, `StringValueCountAggregator`, etc), or a specialized leaf collector inside the single aggregator.  In either case, these specializations would only work with a certain `ValuesSourceType`, and could thus call the \"native\" data access method (`longValues()`, `doubleValues()`) and avoid the need to fall back on the generic `bytesValue()` method.\r\n\r\nI hope that helps!  The answer is basically: yes, the sorting and string conversion is totally unnecessary for `value_count`, but it'll take a little bit of work to change this behavior because of how the agg framework is structured.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/542469487","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-542469487","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":542469487,"node_id":"MDEyOklzc3VlQ29tbWVudDU0MjQ2OTQ4Nw==","user":{"login":"xjtushilei","id":23448336,"node_id":"MDQ6VXNlcjIzNDQ4MzM2","avatar_url":"https://avatars2.githubusercontent.com/u/23448336?v=4","gravatar_id":"","url":"https://api.github.com/users/xjtushilei","html_url":"https://github.com/xjtushilei","followers_url":"https://api.github.com/users/xjtushilei/followers","following_url":"https://api.github.com/users/xjtushilei/following{/other_user}","gists_url":"https://api.github.com/users/xjtushilei/gists{/gist_id}","starred_url":"https://api.github.com/users/xjtushilei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xjtushilei/subscriptions","organizations_url":"https://api.github.com/users/xjtushilei/orgs","repos_url":"https://api.github.com/users/xjtushilei/repos","events_url":"https://api.github.com/users/xjtushilei/events{/privacy}","received_events_url":"https://api.github.com/users/xjtushilei/received_events","type":"User","site_admin":false},"created_at":"2019-10-16T01:22:05Z","updated_at":"2019-10-16T01:22:05Z","author_association":"CONTRIBUTOR","body":"Thanks for your help. I will try it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/610172991","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-610172991","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":610172991,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMDE3Mjk5MQ==","user":{"login":"xjtushilei","id":23448336,"node_id":"MDQ6VXNlcjIzNDQ4MzM2","avatar_url":"https://avatars2.githubusercontent.com/u/23448336?v=4","gravatar_id":"","url":"https://api.github.com/users/xjtushilei","html_url":"https://github.com/xjtushilei","followers_url":"https://api.github.com/users/xjtushilei/followers","following_url":"https://api.github.com/users/xjtushilei/following{/other_user}","gists_url":"https://api.github.com/users/xjtushilei/gists{/gist_id}","starred_url":"https://api.github.com/users/xjtushilei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xjtushilei/subscriptions","organizations_url":"https://api.github.com/users/xjtushilei/orgs","repos_url":"https://api.github.com/users/xjtushilei/repos","events_url":"https://api.github.com/users/xjtushilei/events{/privacy}","received_events_url":"https://api.github.com/users/xjtushilei/received_events","type":"User","site_admin":false},"created_at":"2020-04-07T04:55:30Z","updated_at":"2020-04-07T04:55:30Z","author_association":"CONTRIBUTOR","body":"https://github.com/elastic/elasticsearch/pull/54854  related","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/612109042","html_url":"https://github.com/elastic/elasticsearch/issues/36752#issuecomment-612109042","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36752","id":612109042,"node_id":"MDEyOklzc3VlQ29tbWVudDYxMjEwOTA0Mg==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2020-04-10T16:30:18Z","updated_at":"2020-04-10T16:30:18Z","author_association":"CONTRIBUTOR","body":"Closed by #54854 ","performed_via_github_app":null}]