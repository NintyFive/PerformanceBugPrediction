[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/422752644","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-422752644","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":422752644,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMjc1MjY0NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-09-19T10:45:23Z","updated_at":"2018-09-19T10:45:23Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443899766","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-443899766","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":443899766,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0Mzg5OTc2Ng==","user":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"created_at":"2018-12-03T22:46:07Z","updated_at":"2018-12-03T22:46:07Z","author_association":"CONTRIBUTOR","body":"I believe this is the same issue on master today, doesn't reproduce\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=ubuntu&&virtual/96/console\r\n\r\n[build-unix-96.txt.zip](https://github.com/elastic/elasticsearch/files/2641571/build-unix-96.txt.zip)\r\n\r\n```\r\n  1> [2018-12-03T02:32:03,086][INFO ][o.e.t.RemoteClusterServiceTests] [testCollectSearchShards] after test\r\nFAILURE 4.90s J1 | RemoteClusterServiceTests.testCollectSearchShards <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError\r\n   >    at __randomizedtesting.SeedInfo.seed([730C273FDEA107A9:3D13867A5B6F3009]:0)\r\n   >    at org.elasticsearch.transport.RemoteClusterServiceTests.testCollectSearchShards(RemoteClusterServiceTests.java:855)\r\n   >    at java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :server:test -Dtests.seed=730C273FDEA107A9 -Dtests.class=org.elasticsearch.transport.RemoteClusterServiceTests -Dtests.method=\"testCollectSearchShards\" -Dtests.security.manager=true -Dtests.locale=he-IL -Dtests.timezone=SystemV/YST9 -Dcompiler.java=11 -Druntime.java=8\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448268549","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-448268549","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":448268549,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODI2ODU0OQ==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2018-12-18T15:52:59Z","updated_at":"2018-12-18T15:53:25Z","author_association":"MEMBER","body":"another failure waiting on the latch at https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+intake/838/console\r\n\r\n```\r\n  1> [2018-12-18T14:57:45,065][INFO ][o.e.t.RemoteClusterServiceTests] [testCollectSearchShards] after test\r\nFAILURE 6.53s J2 | RemoteClusterServiceTests.testCollectSearchShards <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError\r\n   >    at __randomizedtesting.SeedInfo.seed([B51888CD81E2A99A:FB072988042C9E3A]:0)\r\n   >    at org.elasticsearch.transport.RemoteClusterServiceTests.testCollectSearchShards(RemoteClusterServiceTests.java:857)\r\n   >    at java.lang.Thread.run(Thread.java:748)\r\n\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/452772741","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-452772741","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":452772741,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1Mjc3Mjc0MQ==","user":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"created_at":"2019-01-09T17:05:52Z","updated_at":"2019-01-09T17:05:52Z","author_association":"CONTRIBUTOR","body":"Failed again: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=centos/169/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454841412","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-454841412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":454841412,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDg0MTQxMg==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2019-01-16T16:21:16Z","updated_at":"2019-01-16T16:21:16Z","author_association":"CONTRIBUTOR","body":"Another one today in 6.x : https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+intake/1026","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463627687","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-463627687","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":463627687,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzYyNzY4Nw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2019-02-14T13:32:24Z","updated_at":"2019-02-14T13:32:24Z","author_association":"MEMBER","body":"I have done quite some digging on this one. I was not able to reproduce this issue even running this test in a loop for hours and hours. Last failure is from January 23rd, at the time this test was failing around one or two times per day. We previously increased the wait for the responses a couple of times. The failure that I have analyzed happens before we even simulate network failures. At the second `collectSearchShards` call, we send a preference `index_not_found` which causes an exception to be returned rather than a response. This has the goal of simulating the default behaviour when an exception is received from all the remote clusters. The latch times out after 5 seconds, meaning that we don't get a response from all the clusters in 5 seconds, which seems unlikely given that we are using mock transport services. I could not find any place where we may miss to notify the listener. I found something interesting in the logs though:\r\n\r\n```\r\n  1> [2019-01-21T12:11:25,820][INFO ][o.e.t.RemoteClusterServiceTests] [testCollectSearchShards] before test\r\n  1> [2019-01-21T12:11:26,324][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10600}, bound_addresses {[::1]:10600}, {127.0.0.1:10600}\r\n  1> [2019-01-21T12:11:26,328][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10601}, bound_addresses {[::1]:10601}, {127.0.0.1:10601}\r\n  1> [2019-01-21T12:11:26,336][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10602}, bound_addresses {[::1]:10602}, {127.0.0.1:10602}\r\n  1> [2019-01-21T12:11:26,340][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10603}, bound_addresses {[::1]:10603}, {127.0.0.1:10603}\r\n  1> [2019-01-21T12:11:26,355][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10604}, bound_addresses {[::1]:10604}, {127.0.0.1:10604}\r\n  1> [2019-01-21T12:11:26,360][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10605}, bound_addresses {[::1]:10605}, {127.0.0.1:10605}\r\n  1> [2019-01-21T12:11:26,364][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10606}, bound_addresses {[::1]:10606}, {127.0.0.1:10606}\r\n  1> [2019-01-21T12:11:26,368][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10607}, bound_addresses {[::1]:10607}, {127.0.0.1:10607}\r\n  1> [2019-01-21T12:11:26,373][INFO ][o.e.t.TransportService   ] [testCollectSearchShards] publish_address {127.0.0.1:10608}, bound_addresses {[::1]:10608}, {127.0.0.1:10608}\r\n  1> [2019-01-21T12:11:34,709][WARN ][o.e.t.TransportService   ] [[elasticsearch[transport_worker][T#2]]] Transport response handler not found of id [50]\r\n  1> [2019-01-21T12:11:34,713][WARN ][o.e.t.TransportService   ] [[elasticsearch[transport_worker][T#2]]] Transport response handler not found of id [55]\r\n  1> [2019-01-21T12:11:34,713][WARN ][o.e.t.TransportService   ] [[elasticsearch[transport_worker][T#2]]] Transport response handler not found of id [49]\r\n  1> [2019-01-21T12:11:34,721][INFO ][o.e.t.RemoteClusterServiceTests] [testCollectSearchShards] after test\r\nFAILURE 8.92s J3 | RemoteClusterServiceTests.testCollectSearchShards <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: expected latch to be counted down after 5s, but was not\r\n   > Expected: is <true>\r\n   >      but: was <false>\r\n   > \tat __randomizedtesting.SeedInfo.seed([B954F1B646535EBB:F74B50F3C39D691B]:0)\r\n   > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   > \tat org.elasticsearch.test.hamcrest.ElasticsearchAssertions.awaitLatch(ElasticsearchAssertions.java:713)\r\n   > \tat org.elasticsearch.transport.RemoteClusterServiceTests.testCollectSearchShards(RemoteClusterServiceTests.java:765)\r\n```\r\n\r\nThe three `Transport response handler not found of id [***]` warnings come back about 8 seconds after the test has started, which seems to indicate that the responses do come back, hence increasing the wait to 10 seconds would have likely made the test succeed. I believe that such warnings indicate that responses have come back late, yet quick enough to hit the sender transport while it was being closed, but before it was shut down. I wonder if this has to do with infra issues in combination with using 9 mock transport services in this specific run. \r\n\r\nI am not too happy with increasing the timeout once more like I proposed in #38198 and #38199, at least unless we understand exactly what slows things down. We could try and decrease the number of remote clusters (hence nodes) that we connect to, but I am not sure that is the problem either. Also, this test and corresponding tested code has been moved on master, 7.0 and 7.x to `TransportSearchAction` and `TransportSearchActionTests`, with few changes that I don't expect could have solved the issue. Also, the test was left unchanged in 6.7 and it did not fail ever since. That again points me to infra issues that have been solved and have not occurred in the last few weeks.\r\n\r\n@tbrooks8 do you have any suggestion on changes to make here or what could have caused this situation?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/465153387","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-465153387","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":465153387,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NTE1MzM4Nw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2019-02-19T14:37:26Z","updated_at":"2019-02-19T14:37:26Z","author_association":"MEMBER","body":"Closing this one as  it has not failed in a month or so. I think that infra changes have helped with this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500244184","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-500244184","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":500244184,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDI0NDE4NA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-06-09T20:50:04Z","updated_at":"2019-06-09T20:50:04Z","author_association":"MEMBER","body":"Another instance: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.2+intake/35/consoleText\r\n\r\n```\r\norg.elasticsearch.action.search.TransportSearchActionTests > testCollectSearchShards FAILED\r\n    java.lang.IllegalStateException: failed to connect to remote clusters\r\n        at __randomizedtesting.SeedInfo.seed([45078AC0A9FE43BB:B182B852C30741B]:0)\r\n        at org.elasticsearch.transport.RemoteClusterService.initializeRemoteClusters(RemoteClusterService.java:431)\r\n        at org.elasticsearch.transport.TransportService.doStart(TransportService.java:241)\r\n        at org.elasticsearch.common.component.AbstractLifecycleComponent.start(AbstractLifecycleComponent.java:59)\r\n        at org.elasticsearch.action.search.TransportSearchActionTests.testCollectSearchShards(TransportSearchActionTests.java:611)\r\n\r\n        Caused by:\r\n        java.util.concurrent.ExecutionException: ConnectTransportException[[][127.0.0.1:10311] connect_timeout[30s]]\r\n            at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.getValue(BaseFuture.java:266)\r\n            at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:239)\r\n            at org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:65)\r\n            at org.elasticsearch.transport.RemoteClusterService.initializeRemoteClusters(RemoteClusterService.java:425)\r\n            ... 3 more\r\n\r\n            Caused by:\r\n            ConnectTransportException[[][127.0.0.1:10311] connect_timeout[30s]]\r\nREPRODUCE WITH: ./gradlew :server:test --tests \"org.elasticsearch.action.search.TransportSearchActionTests.testCollectSearchShards\" -Dtests.seed=45078AC0A9FE43BB -Dtests.security.manager=true -Dtests.locale=sv-SE -Dtests.timezone=PRT -Dcompiler.java=12 -Druntime.java=8\r\n\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500899718","html_url":"https://github.com/elastic/elasticsearch/issues/33852#issuecomment-500899718","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33852","id":500899718,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDg5OTcxOA==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2019-06-11T15:40:46Z","updated_at":"2019-06-11T15:40:46Z","author_association":"MEMBER","body":"heya @dnhatn at first glance this seems like a different failure? This is a connect timeout, while historically we have had latches awaits time out here on this test. ","performed_via_github_app":null}]