[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353581914","html_url":"https://github.com/elastic/elasticsearch/issues/27954#issuecomment-353581914","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954","id":353581914,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MzU4MTkxNA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-22T11:40:59Z","updated_at":"2017-12-22T11:40:59Z","author_association":"CONTRIBUTOR","body":"Hi @mikeurbach. Firstly, thanks so much for putting the effort into providing a small reproduction for this. It makes it so much easier to see what's going on. I can reproduce this undesirable hit with version 6.1.1 and on `master`.\r\n\r\nIn some sense, I think this is expected behaviour: `distance_error_pct` applies at both index and search time, and allows for an error which is a proportion of the size of the shape in question. The query containing points which are far apart is much larger and therefore includes a wider margin of error, which intersects the returned document.\r\n\r\nHowever, regarding the following:\r\n\r\n> This appears to only be happening when I enable the `\"tree\": \"quadtree\"` option for this field. I couldn't reproduce with the default geohash tree. I've tried with different precision and distance error percent settings, but the issue remains, and it occurs with the default settings.\r\n\r\nI can't reproduce this effect. Reducing `distance_error_pct` from `0.05` to `0.005` is enough to prevent the test case you give from returning any hits, and if I switch `tree` from `quadtree` to `geohash` then I still get the hit.\r\n\r\n@nknize I'm wondering if it makes sense to apply `distance_error_pct` in this way for `MultiPoint` shapes (and indeed for the other `Multi*` shapes) as opposed to applying it to each individual `Point` (resp. `*`). What do you think?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353656372","html_url":"https://github.com/elastic/elasticsearch/issues/27954#issuecomment-353656372","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954","id":353656372,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MzY1NjM3Mg==","user":{"login":"mikeurbach","id":1182100,"node_id":"MDQ6VXNlcjExODIxMDA=","avatar_url":"https://avatars0.githubusercontent.com/u/1182100?v=4","gravatar_id":"","url":"https://api.github.com/users/mikeurbach","html_url":"https://github.com/mikeurbach","followers_url":"https://api.github.com/users/mikeurbach/followers","following_url":"https://api.github.com/users/mikeurbach/following{/other_user}","gists_url":"https://api.github.com/users/mikeurbach/gists{/gist_id}","starred_url":"https://api.github.com/users/mikeurbach/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikeurbach/subscriptions","organizations_url":"https://api.github.com/users/mikeurbach/orgs","repos_url":"https://api.github.com/users/mikeurbach/repos","events_url":"https://api.github.com/users/mikeurbach/events{/privacy}","received_events_url":"https://api.github.com/users/mikeurbach/received_events","type":"User","site_admin":false},"created_at":"2017-12-22T18:56:19Z","updated_at":"2017-12-22T18:56:19Z","author_association":"NONE","body":"Thanks for the explanation. I was wondering if `distance_error_pct` applied at search time, but I was not completely sure from the docs. Re-reading the geo_shape query documentation, I can see how the `distance_error_pct` configured in the mapping will be applied at search time as well.\r\n\r\n> The geo_shape query uses the same grid square representation as the geo_shape mapping to find documents that have a shape that intersects with the query shape. It will also use the same PrefixTree configuration as defined for the field mapping.\r\n\r\nRegarding the difference between using the `geohash` and `quadtree` tree implementation, I have a more specific example. If I use the default settings, I don't get the false positive with the following mapping:\r\n```\r\n{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"location\": {\r\n          \"type\": \"geo_shape\",\r\n          \"tree\": \"geohash\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nBut I do get the false positive when I switch to the following:\r\n```\r\n{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"location\": {\r\n          \"type\": \"geo_shape\",\r\n          \"tree\": \"quadtree\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nI understand that this is a pretty outlandish case, but it was surprising to me that one tree implementation returns a false positive with the default precision settings while the other does not.\r\n\r\nIt seems like the behavior is indeed expected, and if I really need more accuracy for these huge MultiPoints, I can tune the parameters as you mentioned. Thanks again for the clarification.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/447021130","html_url":"https://github.com/elastic/elasticsearch/issues/27954#issuecomment-447021130","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954","id":447021130,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NzAyMTEzMA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-12-13T15:59:36Z","updated_at":"2018-12-13T15:59:36Z","author_association":"MEMBER","body":"Depends on #32039 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/452105862","html_url":"https://github.com/elastic/elasticsearch/issues/27954#issuecomment-452105862","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954","id":452105862,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MjEwNTg2Mg==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-01-07T22:32:36Z","updated_at":"2019-01-07T22:32:36Z","author_association":"MEMBER","body":"We still cannot resolve this one since BKD-tree backed geoshapes don't support MultiPoint queries.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/715309548","html_url":"https://github.com/elastic/elasticsearch/issues/27954#issuecomment-715309548","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954","id":715309548,"node_id":"MDEyOklzc3VlQ29tbWVudDcxNTMwOTU0OA==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2020-10-23T12:24:38Z","updated_at":"2020-10-23T12:24:38Z","author_association":"CONTRIBUTOR","body":"I am closing this issue as BKD-backed geoshapes support multi-points and they do not show this behaviour.","performed_via_github_app":null}]