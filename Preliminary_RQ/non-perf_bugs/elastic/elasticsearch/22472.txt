{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22472","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22472/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22472/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22472/events","html_url":"https://github.com/elastic/elasticsearch/issues/22472","id":199228046,"node_id":"MDU6SXNzdWUxOTkyMjgwNDY=","number":22472,"title":"Add support for a default alias","user":{"login":"scottsom","id":23276852,"node_id":"MDQ6VXNlcjIzMjc2ODUy","avatar_url":"https://avatars1.githubusercontent.com/u/23276852?v=4","gravatar_id":"","url":"https://api.github.com/users/scottsom","html_url":"https://github.com/scottsom","followers_url":"https://api.github.com/users/scottsom/followers","following_url":"https://api.github.com/users/scottsom/following{/other_user}","gists_url":"https://api.github.com/users/scottsom/gists{/gist_id}","starred_url":"https://api.github.com/users/scottsom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/scottsom/subscriptions","organizations_url":"https://api.github.com/users/scottsom/orgs","repos_url":"https://api.github.com/users/scottsom/repos","events_url":"https://api.github.com/users/scottsom/events{/privacy}","received_events_url":"https://api.github.com/users/scottsom/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-01-06T16:07:01Z","updated_at":"2018-02-13T20:37:25Z","closed_at":"2017-01-17T12:31:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This feature seeks to add the concept of a default alias. When configured, it would allow users to perform an action on an alias or index that does not exist and have it fallback to some default configuration instead of throwing an error.\r\n\r\n## Problem\r\n\r\nIn the [Designing for Scale guide](https://www.elastic.co/guide/en/elasticsearch/guide/current/scale.html), it is suggested to use an [alias per user](https://www.elastic.co/guide/en/elasticsearch/guide/current/faking-it.html), which allows you to easily move the [big users to their own dedicated index](https://www.elastic.co/guide/en/elasticsearch/guide/current/one-big-user.html).\r\n\r\nThere are a few problems with this approach:\r\n- When indexing documents, it requires special client code to check if the alias exists and if not, create it.\r\n- It can consume a significant amount of cluster state as the number of users in our index grows. As called out in the guide, [cluster state does not scale](https://www.elastic.co/guide/en/elasticsearch/guide/current/finite-scale.html).\r\n\r\nTo some extent, this is the problem we were looking to solve in #22274 by allowing users to be dispersed to a subset of shards instead of just one when using custom routing. By picking a larger partition size then you don't need to pull out the big users into their own dedicated index. If all users fit in the shared index then you don't need aliases.\r\n\r\nHowever, that has some drawbacks too. First, it would be an operational burden to just have a single giant index (e.g. to do a reindex you need to double your cluster size). Second, you would pick your partition size to be as large as your expected biggest user (plus some buffer). This can be problematic for imbalanced user distributions since it leads to a sub-optimal partitioning scheme. For example, imagine you had one huge system account or just a few large users and a long-tail for the rest. This means most of the users are hitting more shards per request than they need to.\r\n\r\n## Proposal\r\n\r\nWhen creating an alias per user, they generally all look the same with one value changing:\r\n\r\n```json\r\n{\r\n  \"index\": \"shared_v1\",\r\n  \"routing\": \"<alias>\",\r\n  \"filter\": {\r\n    \"term\": {\r\n      \"user_id\": \"<alias>\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nWe can use this to accept what is essentially an alias template such that we can compute the alias at request time rather than maintaining the state for all of them.\r\n\r\nFor example, you might define a default alias like this:\r\n```json\r\n# POST /_aliases\r\n{\r\n    \"default_alias\" : {\r\n        \"index\": \"shared_v1\",\r\n        \"routing\": true,\r\n        \"field\": \"user_id\"\r\n    }\r\n}\r\n```\r\n\r\nWhen a request is made against an index or alias then Elasticsearch will attempt to resolve it as it does now. If the resolution fails then it checks for the default alias definition and uses that instead of throwing an exception.\r\n\r\nIf _routing_ is true then the alias is passed as the custom routing value.\r\nIf _field_ is set then that field is used in a term filter with the alias as the value.\r\n\r\nFor example, searching on the non-existent alias, 42, with the above configuration is equivalent to having created the alias:\r\n\r\n```json\r\n{\r\n  \"index\": \"shared_v1\",\r\n  \"routing\": \"42\",\r\n  \"filter\": {\r\n    \"term\": {\r\n      \"user_id\": \"42\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe procedure for moving a big user (42) to a dedicated index would look like this:\r\n\r\n1. Create a new index, 42_v1.\r\n2. Copy all data from shared_v1 to 42_v1 where user_id is 42.\r\n3. Create the alias, 42, pointing to 42_v1 with no routing or term filter.\r\n4. Delete documents from shared_v1 where user_id is 42.\r\n\r\nFinally, if you want to recreate the shared index then you can do:\r\n\r\n1. Create a new index, shared_v2.\r\n2. Copy all data from shared_v1 to shared_v2.\r\n3. Update the default alias to point to shared_v2.\r\n4. Drop shared_v1.\r\n\r\nNow you can grow to millions of users and our aliases are essentially a whitelist of the big users who need a dedicated index while the other users remain stateless.","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}