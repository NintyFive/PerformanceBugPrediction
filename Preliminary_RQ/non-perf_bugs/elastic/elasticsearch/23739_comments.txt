[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/289651166","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-289651166","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":289651166,"node_id":"MDEyOklzc3VlQ29tbWVudDI4OTY1MTE2Ng==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-03-28T03:19:40Z","updated_at":"2017-03-28T03:19:40Z","author_association":"MEMBER","body":"I can not reproduce this, but I see the problem. I will think about a fix.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330565364","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-330565364","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":330565364,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDU2NTM2NA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2017-09-19T14:52:10Z","updated_at":"2017-09-19T14:52:10Z","author_association":"CONTRIBUTOR","body":"Another: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+5.6+oracle-periodic/642/console\r\n\r\n```\r\n04:55:10    > Throwable #1: java.lang.AssertionError: \r\n04:55:10    > Expected: an empty collection\r\n04:55:10    >      but: <[Attempted to append to non-started appender mock]>\r\n04:55:10    > \tat __randomizedtesting.SeedInfo.seed([B9C15C2426A1FB86:1037C9BB68BE165A]:0)\r\n04:55:10    > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n04:55:10    > \tat org.elasticsearch.test.ESTestCase.checkStaticState(ESTestCase.java:386)\r\n04:55:10    > \tat org.elasticsearch.test.ESTestCase.after(ESTestCase.java:268)\r\n04:55:10    > \tat java.lang.Thread.run(Thread.java:748)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/383071541","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-383071541","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":383071541,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MzA3MTU0MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-04-20T11:47:43Z","updated_at":"2018-04-20T11:47:43Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409173255","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-409173255","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":409173255,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTE3MzI1NQ==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T10:27:43Z","updated_at":"2018-07-31T10:27:43Z","author_association":"MEMBER","body":"Another one in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.4+matrix-java-periodic/ES_BUILD_JAVA=java10,ES_RUNTIME_JAVA=java8,nodes=virtual&&linux/8/console:\r\n\r\n```\r\n09:59:18 FAILURE 0.10s J1 | ClusterApplierServiceTests.testClusterStateUpdateLogging <<< FAILURES!\r\n09:59:18    > Throwable #1: java.lang.AssertionError: \r\n09:59:18    > Expected: an empty collection\r\n09:59:18    >      but: <[Attempted to append to non-started appender mock]>\r\n09:59:18    > \tat __randomizedtesting.SeedInfo.seed([D88B37E396481A0F:717DA27CD857F7D3]:0)\r\n09:59:18    > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n09:59:18    > \tat org.elasticsearch.test.ESTestCase.checkStaticState(ESTestCase.java:462)\r\n09:59:18    > \tat org.elasticsearch.test.ESTestCase.after(ESTestCase.java:341)\r\n09:59:18    > \tat java.lang.Thread.run(Thread.java:748)\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433434747","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-433434747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":433434747,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzQzNDc0Nw==","user":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"created_at":"2018-10-26T14:51:33Z","updated_at":"2018-10-26T14:51:33Z","author_association":"CONTRIBUTOR","body":"Just got one of those on `6.5`: https://www.google.com/url?q=https://elasticsearch-ci.elastic.co/job/elastic%2Belasticsearch%2B6.5%2Bintake/5/console&source=gmail&ust=1540651005282000&usg=AFQjCNF_9sE9Aq1oAqlBTJ04FUO4OLmk0w\r\n\r\nSame failure.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/437538659","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-437538659","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":437538659,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNzUzODY1OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-11-10T00:40:07Z","updated_at":"2018-11-10T00:40:07Z","author_association":"MEMBER","body":"In this test, we submit [some cluster state updates](https://github.com/elastic/elasticsearch/blob/b093116a1e82e8e06c3ae61dc841a30304193785/server/src/test/java/org/elasticsearch/cluster/service/ClusterApplierServiceTests.java#L168). We wait for the [cluster apply listener to be signaled on success](https://github.com/elastic/elasticsearch/blob/b093116a1e82e8e06c3ae61dc841a30304193785/server/src/test/java/org/elasticsearch/cluster/service/ClusterApplierServiceTests.java#L173) before [tearing down the test](https://github.com/elastic/elasticsearch/blob/b093116a1e82e8e06c3ae61dc841a30304193785/server/src/test/java/org/elasticsearch/cluster/service/ClusterApplierServiceTests.java#L181). When we tear down the test, we clean up the mock appender that we added (so it won't interfere with other tests in the same JVM). The problem is that the applier thread will be still be running our submitted cluster state update, because the [on success signal happens early](https://github.com/elastic/elasticsearch/blob/086ada4c08905724b96fb74031e61978e0b458da/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java#L405). There are logging statements that occur [after](https://github.com/elastic/elasticsearch/blob/086ada4c08905724b96fb74031e61978e0b458da/server/src/main/java/org/elasticsearch/cluster/service/ClusterApplierService.java#L407) the on success. If these logging statements happen on the applier thread after we have removed and stopped the mock appender, this assertion trips. It's a race condition. There is a better way to write this test, and this latch. Instead of counting down in on success, we can count down in the mock appender itself, after it sees the expected log message (override `append`). With this approach, we can also [address that we are not making any assertions here](https://github.com/elastic/elasticsearch/blob/b093116a1e82e8e06c3ae61dc841a30304193785/server/src/test/java/org/elasticsearch/cluster/service/ClusterApplierServiceTests.java#L167).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/440633795","html_url":"https://github.com/elastic/elasticsearch/issues/23739#issuecomment-440633795","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23739","id":440633795,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MDYzMzc5NQ==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-11-21T11:39:21Z","updated_at":"2018-11-21T11:39:21Z","author_association":"MEMBER","body":"Despite the recent change, I see a couple of recent test failures on master, see https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+intake/246/console , https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+intake/245/console , https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+intake/244/console . Strange that these three look to be consecutive runs that all failed for the same reason.\r\n\r\nAlso, should the same changes be applied to MasterServiceTests#testClusterStateUpdateLogging on 6.x? That one fails as well: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+intake/238/console . Reopening.","performed_via_github_app":null}]