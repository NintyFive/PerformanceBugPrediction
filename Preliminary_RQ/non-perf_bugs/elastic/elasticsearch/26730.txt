{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26730","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26730/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26730/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26730/events","html_url":"https://github.com/elastic/elasticsearch/issues/26730","id":259355195,"node_id":"MDU6SXNzdWUyNTkzNTUxOTU=","number":26730,"title":"Delete snapshot api complains that there is no space left on device","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-09-21T02:14:07Z","updated_at":"2018-03-27T09:08:31Z","closed_at":"2018-03-27T09:08:31Z","author_association":"MEMBER","active_lock_reason":null,"body":"Reproducible on 5.5.\r\n\r\n- Create a node with a file system repository path pointed to a mount for a small volume.\r\n- Create a snapshot repository to this mount path.\r\n- Create a few snapshots.\r\n- Then use dd or other means to generate a large file in that volume that causes it to use all space.\r\n- Use the delete snapshot api to delete the snapshot.  The api call will fail complaining that there is no space left on the device.\r\n\r\n```\r\n{\"error\":{\"root_cause\":[{\"type\":\"repository_exception\",\"reason\":\"[backup] failed to delete snapshot [snapshot4/fv_jj1JOQMilPvL4jHjExQ]\"}],\"type\":\"repository_exception\",\"reason\":\"[backup] failed to delete snapshot [snapshot4/fv_jj1JOQMilPvL4jHjExQ]\",\"caused_by\":{\"type\":\"i_o_exception\",\"reason\":\"No space left on device\"}},\"status\":500}\r\n```\r\n\r\nThe only indication of a delete snapshot call actually creating files is that we appear to be creating a new \"index generation\" within the snapshot metadata store.\r\n\r\n```\r\n[2017-09-21T03:46:42,183][DEBUG][o.e.s.SnapshotsService   ] [TwOmS-G] deleted snapshot is not running - deleting files\r\n[2017-09-21T03:46:42,184][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] processing [delete snapshot]: took [3ms] done applying updated cluster_state (version: 7, uuid: VlTYntZNRdmhxQBSB0i8yQ)\r\n[2017-09-21T03:46:42,200][DEBUG][o.e.r.f.FsRepository     ] [TwOmS-G] Repository [backup] writing new index generational blob [index-6]\r\n[2017-09-21T03:46:42,202][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] processing [remove snapshot deletion metadata]: execute\r\n[2017-09-21T03:46:42,202][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] cluster state updated, version [8], source [remove snapshot deletion metadata]\r\n[2017-09-21T03:46:42,202][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] publishing cluster state version [8]\r\n[2017-09-21T03:46:42,202][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] applying cluster state version 8\r\n[2017-09-21T03:46:42,202][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] set local cluster state to version 8\r\n[2017-09-21T03:46:42,206][WARN ][r.suppressed             ] path: /_snapshot/backup/snapshot4, params: {repository=backup, snapshot=snapshot4}\r\norg.elasticsearch.repositories.RepositoryException: [backup] failed to delete snapshot [snapshot4/fv_jj1JOQMilPvL4jHjExQ]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.deleteSnapshot(BlobStoreRepository.java:494) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat org.elasticsearch.snapshots.SnapshotsService.lambda$deleteSnapshotFromRepository$6(SnapshotsService.java:1263) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]\r\nCaused by: java.io.IOException: No space left on device\r\n\tat sun.nio.ch.FileDispatcherImpl.write0(Native Method) ~[?:?]\r\n\tat sun.nio.ch.FileDispatcherImpl.write(FileDispatcherImpl.java:60) ~[?:?]\r\n\tat sun.nio.ch.IOUtil.writeFromNativeBuffer(IOUtil.java:93) ~[?:?]\r\n\tat sun.nio.ch.IOUtil.write(IOUtil.java:65) ~[?:?]\r\n\tat sun.nio.ch.FileChannelImpl.write(FileChannelImpl.java:211) ~[?:?]\r\n\tat java.nio.channels.Channels.writeFullyImpl(Channels.java:78) ~[?:1.8.0_144]\r\n\tat java.nio.channels.Channels.writeFully(Channels.java:101) ~[?:1.8.0_144]\r\n\tat java.nio.channels.Channels.access$000(Channels.java:61) ~[?:1.8.0_144]\r\n\tat java.nio.channels.Channels$1.write(Channels.java:174) ~[?:1.8.0_144]\r\n\tat org.elasticsearch.common.io.Streams.copy(Streams.java:80) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat org.elasticsearch.common.blobstore.fs.FsBlobContainer.writeBlob(FsBlobContainer.java:131) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.writeAtomic(BlobStoreRepository.java:953) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.writeIndexGen(BlobStoreRepository.java:842) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.deleteSnapshot(BlobStoreRepository.java:441) ~[elasticsearch-5.5.0.jar:5.5.0]\r\n\t... 5 more\r\n[2017-09-21T03:46:42,216][DEBUG][o.e.c.s.ClusterService   ] [TwOmS-G] processing [remove snapshot deletion metadata]: took [13ms] done applying updated cluster_state (version: 8, uuid: NByDoHeYRl2rCXeiPn2LTA)\r\n```\r\n\r\nThis behavior seems counterintuitive.  Naturally, when the repository path gets full, admins will attempt to delete older snapshots to so that snapshot will delete the segment files from the repository that are not referenced in any of the snapshots to reclaim space.  Because the delete snapshot api actually ends up creating new files, they are not able to quickly recover space using our APIs.  Are we somehow creating the new index generation in the snapshot metadata store first (before deleting the older index generation files?), instead of doing it in reverse order?","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}