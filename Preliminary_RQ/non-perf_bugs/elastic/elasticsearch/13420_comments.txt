[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/138960574","html_url":"https://github.com/elastic/elasticsearch/issues/13420#issuecomment-138960574","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13420","id":138960574,"node_id":"MDEyOklzc3VlQ29tbWVudDEzODk2MDU3NA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-09-09T16:16:19Z","updated_at":"2015-09-09T16:16:39Z","author_association":"MEMBER","body":"@ericrenard if you define the `nested_path` option and set it to `categories` then it work as expected:\n\n``` json\n{\n  \"size\": 0,\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"match_all\": {}\n      }\n    }\n  },\n  \"aggs\": {\n    \"categories\": {\n      \"nested\": {\n        \"path\": \"categories\"\n      },\n      \"aggs\": {\n        \"filteredcategories\": {\n          \"filter\": {\n            \"bool\": {\n              \"must\": {\n                \"term\": {\n                  \"categories.type\": 1\n                }\n              }\n            }\n          },\n          \"aggs\": {\n            \"top_categories\": {\n              \"terms\": {\n                \"field\": \"categories.id\"\n              },\n              \"aggs\": {\n                \"top_items\": {\n                  \"reverse_nested\": {},\n                  \"aggs\": {\n                    \"top_items_per_categories\": {\n                      \"top_hits\": {\n                        \"sort\": [\n                          {\n                            \"categories.rank\": {\n                              \"order\": \"asc\",\n                              \"mode\": \"max\",\n                              \"nested_path\": \"categories\"\n                            }\n                          }\n                        ]\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThe problem is that nested sorting inside `top_hits` can't detect automatically with the nested path should be. Also there are cases where the `nested_path` is selected incorrectly in a regular search request.\n\nI think the automatic detection of the nested path should be removed, because nested sorting is clearer when you tell it what to do. There is a TODO in the code, but I lost track of it. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/139031615","html_url":"https://github.com/elastic/elasticsearch/issues/13420#issuecomment-139031615","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13420","id":139031615,"node_id":"MDEyOklzc3VlQ29tbWVudDEzOTAzMTYxNQ==","user":{"login":"ericrenard","id":6536793,"node_id":"MDQ6VXNlcjY1MzY3OTM=","avatar_url":"https://avatars0.githubusercontent.com/u/6536793?v=4","gravatar_id":"","url":"https://api.github.com/users/ericrenard","html_url":"https://github.com/ericrenard","followers_url":"https://api.github.com/users/ericrenard/followers","following_url":"https://api.github.com/users/ericrenard/following{/other_user}","gists_url":"https://api.github.com/users/ericrenard/gists{/gist_id}","starred_url":"https://api.github.com/users/ericrenard/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ericrenard/subscriptions","organizations_url":"https://api.github.com/users/ericrenard/orgs","repos_url":"https://api.github.com/users/ericrenard/repos","events_url":"https://api.github.com/users/ericrenard/events{/privacy}","received_events_url":"https://api.github.com/users/ericrenard/received_events","type":"User","site_admin":false},"created_at":"2015-09-09T20:07:23Z","updated_at":"2015-09-09T20:07:23Z","author_association":"NONE","body":"Yeah, you're right, it works with nested_path, thanks !\nOnly thing left for me to figure out is if I can reference the current bucket key in the top hits sort, ideally I want to sort by the rank of the category of the current bucket.\n","performed_via_github_app":null}]