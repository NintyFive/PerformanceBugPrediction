{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37406","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37406/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37406/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37406/events","html_url":"https://github.com/elastic/elasticsearch/issues/37406","id":398808471,"node_id":"MDU6SXNzdWUzOTg4MDg0NzE=","number":37406,"title":"auth: basic auth if credentials in LDAP backend changed","user":{"login":"Alufolie303","id":8692923,"node_id":"MDQ6VXNlcjg2OTI5MjM=","avatar_url":"https://avatars3.githubusercontent.com/u/8692923?v=4","gravatar_id":"","url":"https://api.github.com/users/Alufolie303","html_url":"https://github.com/Alufolie303","followers_url":"https://api.github.com/users/Alufolie303/followers","following_url":"https://api.github.com/users/Alufolie303/following{/other_user}","gists_url":"https://api.github.com/users/Alufolie303/gists{/gist_id}","starred_url":"https://api.github.com/users/Alufolie303/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alufolie303/subscriptions","organizations_url":"https://api.github.com/users/Alufolie303/orgs","repos_url":"https://api.github.com/users/Alufolie303/repos","events_url":"https://api.github.com/users/Alufolie303/events{/privacy}","received_events_url":"https://api.github.com/users/Alufolie303/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-01-14T09:36:47Z","updated_at":"2019-01-14T10:42:41Z","closed_at":"2019-01-14T10:05:15Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): Version: 6.5.0, Build: default/deb/816e6f6/2018-11-09T18:58:36.352602Z, JVM: 1.8.0_191\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_191\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 4.4.0-139-generic #165-Ubuntu SMP Wed Oct 24 10:58:50 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWith active Kibana/ Elasticsearch session and after changing account credentials in LDAP backend basic auth comes up in the Kibana Webinterface, instead of the expected Kibana login interface. I don't know if there is a LDAP Sync or something similar, to be sure the old credentials are not cached, wait 24h after changing the password in the backend. Maybe someone knows the correct behaviour or can give a link to the code/ documentation.\r\n\r\nI'm just using LDAP auth. Maybe someone can check if AD auth is also affected.\r\n\r\nexpected behavior:\r\nAsking for username/ password in Kibana UI.\r\n\r\nactual behavior:\r\nPrompting for username/ password in basic auth popup.\r\n\r\n<details>\r\n  <summary>LDAP Config:</summary>\r\n\r\n```\r\nxpack.security.authc.realms:\r\n    realm1:\r\n        type: native\r\n        order: 0\r\n        enabled: true\r\n\r\n    realm2:\r\n        type: ldap\r\n        order: 1\r\n        enabled: true\r\n        url: \"ldaps://ldap.example.com:636\"\r\n        bind_dn: \"cn=Public,dc=example,dc=com\"\r\n        bind_password: password\r\n        user_search:\r\n            base_dn: \"ou=people,ou=de,dc=example,dc=com\"\r\n            attribute: uid\r\n```\r\n\r\n</details>\r\n\r\n\r\n**Steps to reproduce**:\r\n1. Authenticate to Elasticsearch/ Kibana and close your browser\r\n2. Change Password in LDAP authentication backend\r\n4. wait some time for LDAP resync ( to be sure wait >24h)\r\n3. re-open Kibana in your browser\r\n4. Basic-Auth prompt comes up\r\n\r\n**Provide logs (if relevant)**:\r\n<details>\r\n  <summary>elasticsearch debug log entries</summary>\r\n\r\n```\r\n[2019-01-14T09:00:21,850][DEBUG][o.e.x.s.a.l.LdapRealm    ] [ES-NODE] Exception occurred during authenticate for ldap/realm2\r\ncom.unboundid.ldap.sdk.LDAPBindException: invalid credentials\r\n        at com.unboundid.ldap.sdk.LDAPConnection.bind(LDAPConnection.java:2273) ~[unboundid-ldapsdk-4.0.8.jar:4.0.8]\r\n        at com.unboundid.ldap.sdk.LDAPConnectionPool.bindAndRevertAuthentication(LDAPConnectionPool.java:1619) ~[unboundid-ldapsdk-4.0.8.jar:4.0.8]\r\n        at org.elasticsearch.xpack.security.authc.ldap.support.LdapUtils$1.lambda$doRun$0(LdapUtils.java:136) ~[x-pack-security-6.5.0.jar:6.5.0]\r\n        at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_191]\r\n        at org.elasticsearch.xpack.security.authc.ldap.support.LdapUtils.privilegedConnect(LdapUtils.java:75) ~[x-pack-security-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.xpack.security.authc.ldap.support.LdapUtils$1.doRun(LdapUtils.java:136) [x-pack-security-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_191]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_191]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_191]\r\n[2019-01-14T09:00:21,869][WARN ][o.e.x.s.a.AuthenticationService] [ES-NODE] Authentication to realm realm2 failed - authenticate failed (Caused by LDAPException(resultCode=49 (invalid credentials), errorMessage='invalid credentials', ldapSDKVersion=4.0.8, revision=28812))\r\n[2019-01-14T09:00:21,869][DEBUG][r.suppressed             ] [ES-NODE] path: /_xpack/security/_authenticate, params: {}\r\norg.elasticsearch.ElasticsearchSecurityException: unable to authenticate user [username] for REST request [/_xpack/security/_authenticate]\r\n        at org.elasticsearch.xpack.core.security.support.Exceptions.authenticationError(Exceptions.java:18) ~[?:?]\r\n        at org.elasticsearch.xpack.core.security.authc.DefaultAuthenticationFailureHandler.createAuthenticationError(DefaultAuthenticationFailureHandler.java:161) ~[?:?]\r\n        at org.elasticsearch.xpack.core.security.authc.DefaultAuthenticationFailureHandler.failedAuthentication(DefaultAuthenticationFailureHandler.java:89) ~[?:?]\r\n        at org.elasticsearch.xpack.security.authc.AuthenticationService$AuditableRestRequest.authenticationFailed(AuthenticationService.java:573) ~[?:?]\r\n        at org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.consumeUser(AuthenticationService.java:363) ~[?:?]\r\n        at org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$consumeToken$14(AuthenticationService.java:301) ~[?:?]\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60) ~[elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) ~[elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.xpack.core.common.IteratingActionListener.onResponse(IteratingActionListener.java:115) ~[?:?]\r\n        at org.elasticsearch.xpack.security.authc.AuthenticationService$Authenticator.lambda$consumeToken$11(AuthenticationService.java:286) ~[?:?]\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60) ~[elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.xpack.security.authc.support.CachingUsernamePasswordRealm.lambda$authenticateWithCache$4(CachingUsernamePasswordRealm.java:172) ~[?:?]\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.xpack.security.authc.ldap.LdapRealm$LdapSessionActionListener.onFailure(LdapRealm.java:277) [x-pack-security-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.action.support.ContextPreservingActionListener.onFailure(ContextPreservingActionListener.java:50) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.action.ActionRunnable.onFailure(ActionRunnable.java:42) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.xpack.security.authc.ldap.support.LdapUtils$1.onFailure(LdapUtils.java:142) [x-pack-security-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:708) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.5.0.jar:6.5.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_191]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_191]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_191]\r\n```\r\n</details>","closed_by":{"login":"Alufolie303","id":8692923,"node_id":"MDQ6VXNlcjg2OTI5MjM=","avatar_url":"https://avatars3.githubusercontent.com/u/8692923?v=4","gravatar_id":"","url":"https://api.github.com/users/Alufolie303","html_url":"https://github.com/Alufolie303","followers_url":"https://api.github.com/users/Alufolie303/followers","following_url":"https://api.github.com/users/Alufolie303/following{/other_user}","gists_url":"https://api.github.com/users/Alufolie303/gists{/gist_id}","starred_url":"https://api.github.com/users/Alufolie303/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alufolie303/subscriptions","organizations_url":"https://api.github.com/users/Alufolie303/orgs","repos_url":"https://api.github.com/users/Alufolie303/repos","events_url":"https://api.github.com/users/Alufolie303/events{/privacy}","received_events_url":"https://api.github.com/users/Alufolie303/received_events","type":"User","site_admin":false},"performed_via_github_app":null}