{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9920","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9920/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9920/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9920/events","html_url":"https://github.com/elastic/elasticsearch/issues/9920","id":59232232,"node_id":"MDU6SXNzdWU1OTIzMjIzMg==","number":9920,"title":"Aggregations and fielddata caching behavior after filtering","user":{"login":"amreha2002","id":7381334,"node_id":"MDQ6VXNlcjczODEzMzQ=","avatar_url":"https://avatars2.githubusercontent.com/u/7381334?v=4","gravatar_id":"","url":"https://api.github.com/users/amreha2002","html_url":"https://github.com/amreha2002","followers_url":"https://api.github.com/users/amreha2002/followers","following_url":"https://api.github.com/users/amreha2002/following{/other_user}","gists_url":"https://api.github.com/users/amreha2002/gists{/gist_id}","starred_url":"https://api.github.com/users/amreha2002/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amreha2002/subscriptions","organizations_url":"https://api.github.com/users/amreha2002/orgs","repos_url":"https://api.github.com/users/amreha2002/repos","events_url":"https://api.github.com/users/amreha2002/events{/privacy}","received_events_url":"https://api.github.com/users/amreha2002/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-02-27T12:50:22Z","updated_at":"2015-02-28T03:56:28Z","closed_at":"2015-02-28T03:56:28Z","author_association":"NONE","active_lock_reason":null,"body":"I'm working with terms aggregations. I've 100M+ documents in one index with 100+ types. I'm trying to run the aggs query on one single type with only hundreds of docs.\nEverytime I run this query:\n1- It takes a lot of time 3-4 minutes \n2- It blocks the cache, preventing other queries to run on the node till the cache is manually cleared.\n\nI tried using all types of filters, filtered, filter agg, querystring, match query, terms aggs with tiny size and shard_size, even the post filter. But still the field data cache ignores whats mentioned in any of these and caches that field for all documents in that index.\n\nAccording to ES documentation, this functionality was intentionally made as a sort of search prediction for later queries.\n[\"The logic is: if you need access to documents X, Y, and Z for this query, you will probably need access to other documents in the next query. It is cheaper to load all values once, and to keep them in memory, than to have to scan the inverted index on every request.\"](http://www.elasticsearch.org/guide/en/elasticsearch/guide/current/_limiting_memory_usage.html)\n\nI found a lot of alternatives but still I am not sure if any of them will solve my problem:\n1- Creating an index for every type (Still the filtering won't work but at least it will only cache 1 type not all other types)\n2- Using doc values instead caching in memory (Much slower, Cache will never get blocked, doesn't support working with text field yet, so it's useless in my case)\n3- Expanding the memory, sharding, creating other nodes and giving a lot of space for the cache ( It will still be slow as I run more than 10 different aggs query, every query has a different field than the previous one. So the cache will always miss and every time I run a query it will take a lot of time to fill the cache that might get dropped on the next query to fill it with a new field)\n\nIs there any workaround to disable that feature or at least an older version of ES that doesn't support  it? Any help on this issue would be really appreciated.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}