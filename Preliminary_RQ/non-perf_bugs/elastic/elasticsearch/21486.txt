{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21486","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21486/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21486/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21486/events","html_url":"https://github.com/elastic/elasticsearch/issues/21486","id":188702891,"node_id":"MDU6SXNzdWUxODg3MDI4OTE=","number":21486,"title":"Accent search over ingest attachment processor not working properly with brazilian filter [ES 5.0]","user":{"login":"evertramos","id":905951,"node_id":"MDQ6VXNlcjkwNTk1MQ==","avatar_url":"https://avatars1.githubusercontent.com/u/905951?v=4","gravatar_id":"","url":"https://api.github.com/users/evertramos","html_url":"https://github.com/evertramos","followers_url":"https://api.github.com/users/evertramos/followers","following_url":"https://api.github.com/users/evertramos/following{/other_user}","gists_url":"https://api.github.com/users/evertramos/gists{/gist_id}","starred_url":"https://api.github.com/users/evertramos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/evertramos/subscriptions","organizations_url":"https://api.github.com/users/evertramos/orgs","repos_url":"https://api.github.com/users/evertramos/repos","events_url":"https://api.github.com/users/evertramos/events{/privacy}","received_events_url":"https://api.github.com/users/evertramos/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-11-11T07:43:39Z","updated_at":"2017-01-10T16:08:03Z","closed_at":"2016-11-11T07:48:15Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0\r\n\r\n**Plugins installed**: [ingest-attachment]\r\n\r\n**JVM version**: OpenJDK version \"1.8.0_102\"\r\n\r\n**OS version**: boot2docker and Ubuntu 14.0 (docker version of elasticsearch 5.0 container)\r\n\r\n**Description of the problem including expected versus actual behavior**: \r\n\r\nAfter ingesting a PDF file with ingest-attachment plugin, using *brazilian* filter, the query (_search) does not bring the results as it should be, when using words with *accents* (as of the brazilian portuguese word \"prodigo\" which should bring all records as \"pr贸digo\", as well).\r\n\r\nIf we use regular indexing, by regular I mean without processors, it does work perfectly as of [mentioned in this issue.](https://github.com/elastic/elasticsearch/issues/21437)\r\n\r\nBut, the real issue is when you ingest a file through ingest-attachment, the filter used on the index field property does not respond properly.\r\n\r\nAs we can see and prove on the test below:\r\n\r\n````\r\n// PUT /i (Create Index)\r\n{\r\n    \"mappings\" : {\r\n        \"docs\" : {\r\n            \"properties\" : {\r\n                \"name\" : { \r\n                \t\"type\" : \"text\",\r\n                \t\"analyzer\" : \"brazilian\"\r\n            \t},\r\n                \"content\" : { \r\n                \t\"type\" : \"text\",\r\n                \t\"analyzer\" : \"brazilian\"\r\n            \t}\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n// PUT /_ingest/pipeline/attachment (Create Pipeline)\r\n{\r\n  \"description\" : \"Extract attachment information\",\r\n  \"processors\" : [\r\n    {\r\n      \"attachment\" : {\r\n        \"field\" : \"content\",\r\n        \"indexed_chars\" : -1\r\n      }\r\n    }\r\n  ]\r\n}\r\n\r\n// POST /i/docs/1 (Index file 1)\r\n{\r\n\t\"name\": \"file1\"\r\n}\r\n\r\n// POST /i/docs/2 (Index file 2)\r\n{\r\n\t\"name\": \"file2\"\r\n}\r\n\r\n// PUT /i/docs/1?pipeline=attachment (Ingest file1 base62 encoded with word \"pr贸digo\")\r\n{\r\n  \"content\": \"ZmlsaG8gcHLDs2RpZ28=\"\r\n}\r\n\r\n// PUT /i/docs/2?pipeline=attachment (Ingest file2 base62 encoded with word  \"prodigo\")\r\n{\r\n  \"content\": \"ZmlsaG8gcHJvZGlnbw==\"\r\n}\r\n````\r\n\r\nAfter the environment set we can query and see the results:\r\n````\r\n// GET i/_search?q=attachment.content:prodigo (Results to:)\r\n{\r\n  \"took\": 2,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 1,\r\n    \"max_score\": 0.25811607,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"i\",\r\n        \"_type\": \"docs\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 0.25811607,\r\n        \"_source\": {\r\n          \"attachment\": {\r\n            \"content_type\": \"text/plain; charset=ISO-8859-1\",\r\n            \"language\": \"sk\",\r\n            \"content\": \"filho prodigo\",\r\n            \"content_length\": 14\r\n          },\r\n          \"content\": \"ZmlsaG8gcHJvZGlnbw==\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n\r\n// GET /i/_search?q=attachment.content:pr贸digo (Results to:)\r\n{\r\n  \"took\": 12,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 1,\r\n    \"max_score\": 0.25811607,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"i\",\r\n        \"_type\": \"docs\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 0.25811607,\r\n        \"_source\": {\r\n          \"attachment\": {\r\n            \"content_type\": \"text/plain; charset=UTF-8\",\r\n            \"language\": \"sk\",\r\n            \"content\": \"filho pr贸digo\",\r\n            \"content_length\": 14\r\n          },\r\n          \"content\": \"ZmlsaG8gcHLDs2RpZ28=\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n````\r\n\r\nWhere we can see that when searching the same term with or without accent the query it is not bringing the expected result which should be both files for any of the queries above mentioned.\r\n\r\nP.S.: Please note that I mentioned PDF but used a small base64 enconded string in order to reduce size of text, but the results are the same.","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}