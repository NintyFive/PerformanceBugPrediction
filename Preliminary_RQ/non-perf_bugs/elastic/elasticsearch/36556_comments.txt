[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/446634017","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-446634017","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":446634017,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NjYzNDAxNw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-12-12T15:44:57Z","updated_at":"2018-12-12T15:44:57Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/447437728","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-447437728","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":447437728,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NzQzNzcyOA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-12-14T19:58:58Z","updated_at":"2018-12-14T19:58:58Z","author_association":"CONTRIBUTOR","body":"The test looks like it was on its way to succeeding: the stale master's attempt to hijack the majority was indeed rejected. But then everything just stopped for a couple of seconds. Here are two consecutive log messages:\r\n\r\n```\r\n  1> [2018-12-12T02:59:28,338][DEBUG][o.e.c.c.FollowersChecker ] [node_t2] FollowerChecker{discoveryNode={node_t1}{dwb5ZtKJQuKob831mBwHbQ}{UwM2TS65SCGUGxFjgmAeRA}{127.0.0.1}{127.0.0.1:41016}, failureCountSinceLastSu\r\n  1> [2018-12-12T02:59:30,327][DEBUG][o.e.c.c.FollowersChecker ] [node_t1] FollowerChecker{discoveryNode={node_t0}{8_x-CYYnQZWpDuebKkt0dA}{d-sWRk6tRU2tuHuNiJX-Rg}{127.0.0.1}{127.0.0.1:58859}, failureCountSinceLastSu\r\n```\r\n\r\nThe failure detector is set to be quite enthusiastic in `AbstractDisruptionTestCase`: a single 1-second pause is enough to trip it, so the inexplicable pause means the master fails and then recovers, resulting in 4 master transitions instead of 2.\r\n\r\nI can't think of a good way to tell that this disruption to the master was external and not to do with the stale master. Maybe we should tone down the failure detector a bit if this is happening too much?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/447912106","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-447912106","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":447912106,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0NzkxMjEwNg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-12-17T16:42:05Z","updated_at":"2018-12-17T16:42:05Z","author_association":"CONTRIBUTOR","body":"Chalking this failure up to some more widespread issues that CI was having that day with tests pausing and hitting timeouts, so there's no more action to take here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461852274","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-461852274","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":461852274,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTg1MjI3NA==","user":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T16:04:03Z","updated_at":"2019-02-08T16:04:03Z","author_association":"CONTRIBUTOR","body":"This has happened again today in the `7.0` branch: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.0+multijob-darwin-compatibility/4/consoleText\r\n\r\nSame failure:\r\n\r\n```\r\nFAILURE 4.91s J1 | MasterDisruptionIT.testStaleMasterNotHijackingMajority <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: [node_t2] Each node should only record two master node transitions\r\n   > Expected: a collection with size <2>\r\n   >      but: collection size was <4>\r\n   > \tat __randomizedtesting.SeedInfo.seed([3B285D3A59ED58:5F3D65521B823254]:0)\r\n   > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   > \tat org.elasticsearch.discovery.MasterDisruptionIT.testStaleMasterNotHijackingMajority(MasterDisruptionIT.java:176)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nReproduce:\r\n\r\n```\r\n./gradlew :server:integTest -Dtests.seed=3B285D3A59ED58 -Dtests.class=org.elasticsearch.discovery.MasterDisruptionIT -Dtests.method=\"testStaleMasterNotHijackingMajority\" -Dtests.security.manager=true -Dtests.locale=lt-LT -Dtests.timezone=Asia/Chongqing -Dcompiler.java=11 -Druntime.java=8\r\n```\r\n\r\nI'm reopening as might need more investigation @DaveCTurner ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461909236","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-461909236","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":461909236,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTkwOTIzNg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T19:00:15Z","updated_at":"2019-02-08T19:00:15Z","author_association":"CONTRIBUTOR","body":"Thanks @dimitris-athanasiou. This failure was still a \"CI just stopped doing stuff\" issue but for just over a second which is kinda reasonable:\r\n\r\n```\r\n  1> [2019-02-08T23:33:14,039][TRACE][o.e.c.s.MasterService    ] [node_t2] will process [node-left[{node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127.0.0.1:64226} followers check retry count exceeded]]\r\n  1> [2019-02-08T23:33:14,039][DEBUG][o.e.c.s.MasterService    ] [node_t2] processing [node-left[{node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127.0.0.1:64226} followers check retry count exceeded]]: execute\r\n  1> [2019-02-08T23:33:14,048][WARN ][o.e.t.TransportService   ] [node_t2] Received response for a request that has timed out, sent [2006ms] ago, timed out [1123ms] ago, action [internal:coordination/fault_detection/leader_check], node [{node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127.0.0.1:6422\r\n  1> [2019-02-08T23:33:14,049][TRACE][o.e.c.s.MasterService    ] [node_t2] cluster state updated, source [node-left[{node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127.0.0.1:64226} followers check retry count exceeded]]\r\n  1> [2019-02-08T23:33:14,049][INFO ][o.e.c.s.MasterService    ] [node_t2] node-left[{node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127.0.0.1:64226} followers check retry count exceeded], term: 2, version: 6, reason: removed {{node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127\r\n  1> [2019-02-08T23:33:14,049][DEBUG][o.e.c.s.MasterService    ] [node_t2] publishing cluster state version [6]\r\n  1> org.elasticsearch.transport.RemoteTransportException: [node_t2][127.0.0.1:64227][internal:coordination/fault_detection/follower_check]\r\n  1> [2019-02-08T23:33:14,088][DEBUG][o.e.c.c.PublicationTransportHandler] [node_t2] resending full cluster state to node {node_t0}{GPBmjAIJQx6eIa5B5QBpDQ}{EB_YqBPyRViZdiGSh8n1Vw}{127.0.0.1}{127.0.0.1:64226} reason RemoteTransportException[[node_t0][127.0.0.1:64226][internal:cluster/coordination/publish_state]]; nested\r\n  1> [2019-02-08T23:33:14,088][DEBUG][o.e.c.c.PublicationTransportHandler] [node_t2] received diff cluster state version [5] with uuid [hW7jR-WDTQCQtBkGQdctwg], diff size [249]\r\n  1> [2019-02-08T23:33:15,275][DEBUG][o.e.c.c.C.CoordinatorPublication] [node_t2] cancel: [Publication{term=2, version=6}] cancelled before committing (reason: timed out after 1s)\r\n  1> [2019-02-08T23:33:15,276][DEBUG][o.e.c.c.C.CoordinatorPublication] [node_t2] onPossibleCompletion: [Publication{term=2, version=6}] commit failed\r\n  1> [2019-02-08T23:33:15,276][DEBUG][o.e.c.c.C.CoordinatorPublication] [node_t2] publication ended unsuccessfully: Publication{term=2, version=6}\r\n  1> [2019-02-08T23:33:15,276][DEBUG][o.e.c.c.Coordinator      ] [node_t2] Publication.onCompletion(false): coordinator becoming CANDIDATE in term 2 (was LEADER, lastKnownLeader was [Optional[{node_t2}{42gzLYX5Q66FoCoE5OUbqg}{Sf3osMk2QhSZVinkWvs09g}{127.0.0.1}{127.0.0.1:64227}]])\r\n```\r\n\r\nAs this test is structured today we rely on that timeout being a bit sensitive, but I will think about some alternatives.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/470984376","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-470984376","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":470984376,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MDk4NDM3Ng==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-03-08T16:15:03Z","updated_at":"2019-03-08T16:15:03Z","author_association":"CONTRIBUTOR","body":"The same test failed in the same way again in the macOS build like the previous one:\r\n\r\n```\r\nFAILURE 6.22s J1 | MasterDisruptionIT.testStaleMasterNotHijackingMajority <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: [node_t2] Each node should only record two master node transitions\r\n   > Expected: a collection with size <2>\r\n   >      but: collection size was <4>\r\n   > \tat __randomizedtesting.SeedInfo.seed([C64F0105C19FC26:5362BD1F7DC2232A]:0)\r\n   > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   > \tat org.elasticsearch.discovery.MasterDisruptionIT.testStaleMasterNotHijackingMajority(MasterDisruptionIT.java:176)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThe build log is https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+7.x+multijob-darwin-compatibility/60/console\r\n\r\nThere's a question mark over that macOS CI worker, as every build on it fails for one reason or another.  Since the problem is not being observed in Linux builds I won't mute the test.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/471883249","html_url":"https://github.com/elastic/elasticsearch/issues/36556#issuecomment-471883249","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36556","id":471883249,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MTg4MzI0OQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-03-12T07:12:01Z","updated_at":"2019-03-12T07:12:01Z","author_association":"MEMBER","body":"@DaveCTurner I can reproduce this fairly reliably on OSX, running:\r\n\r\n```\r\nwhile ./gradlew :server:integTest -Dtests.seed=17D9B38A9300AD04 -Dtests.class=org.elasticsearch.discovery.MasterDisruptionIT -Dtests.method=\"testStaleMasterNotHijackingMajority\" -Dtests.security.manager=true -Dtests.locale=et-EE -Dtests.timezone=Africa/Dar_es_Salaam -Dcompiler.java=11 -Druntime.java=8\r\n```\r\n\r\n(takes ~10 iterations on average to fail on `master`)","performed_via_github_app":null}]