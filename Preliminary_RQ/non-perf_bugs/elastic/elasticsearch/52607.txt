{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52607","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52607/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52607/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52607/events","html_url":"https://github.com/elastic/elasticsearch/issues/52607","id":568633439,"node_id":"MDU6SXNzdWU1Njg2MzM0Mzk=","number":52607,"title":"[CI] GoogleCloudStorageBlobContainerRetriesTests.testReadLargeBlobWithRetries fails reproducibly","user":{"login":"mark-vieira","id":4106672,"node_id":"MDQ6VXNlcjQxMDY2NzI=","avatar_url":"https://avatars2.githubusercontent.com/u/4106672?v=4","gravatar_id":"","url":"https://api.github.com/users/mark-vieira","html_url":"https://github.com/mark-vieira","followers_url":"https://api.github.com/users/mark-vieira/followers","following_url":"https://api.github.com/users/mark-vieira/following{/other_user}","gists_url":"https://api.github.com/users/mark-vieira/gists{/gist_id}","starred_url":"https://api.github.com/users/mark-vieira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mark-vieira/subscriptions","organizations_url":"https://api.github.com/users/mark-vieira/orgs","repos_url":"https://api.github.com/users/mark-vieira/repos","events_url":"https://api.github.com/users/mark-vieira/events{/privacy}","received_events_url":"https://api.github.com/users/mark-vieira/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-02-20T23:11:22Z","updated_at":"2020-02-21T15:32:17Z","closed_at":"2020-02-21T08:13:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"We've encountered two failures of `GoogleCloudStorageBlobContainerRetriesTests.testReadLargeBlobWithRetries`. This failure reproduces locally for me.\r\n\r\n```\r\norg.elasticsearch.repositories.gcs.GoogleCloudStorageBlobContainerRetriesTests > testReadLargeBlobWithRetries FAILED\r\n    com.google.cloud.storage.StorageException: Connection closed prematurely: bytesRead = 2097151, Content-Length = 2097152\r\n        at __randomizedtesting.SeedInfo.seed([8062D6DCDCB1069C:FAFB08A56F33DF3]:0)\r\n        at com.google.cloud.storage.spi.v1.HttpStorageRpc.translate(HttpStorageRpc.java:227)\r\n        at com.google.cloud.storage.spi.v1.HttpStorageRpc.read(HttpStorageRpc.java:690)\r\n        at com.google.cloud.storage.BlobReadChannel$1.call(BlobReadChannel.java:127)\r\n        at com.google.cloud.storage.BlobReadChannel$1.call(BlobReadChannel.java:124)\r\n        at com.google.api.gax.retrying.DirectRetryingExecutor.submit(DirectRetryingExecutor.java:105)\r\n        at com.google.cloud.RetryHelper.run(RetryHelper.java:76)\r\n        at com.google.cloud.RetryHelper.runWithRetries(RetryHelper.java:50)\r\n        at com.google.cloud.storage.BlobReadChannel.read(BlobReadChannel.java:123)\r\n        at org.elasticsearch.repositories.gcs.GoogleCloudStorageRetryingInputStream$1.lambda$read$0(GoogleCloudStorageRetryingInputStream.java:83)\r\n        at java.base/java.security.AccessController.doPrivileged(Native Method)\r\n        at org.elasticsearch.repositories.gcs.SocketAccess.doPrivilegedIOException(SocketAccess.java:44)\r\n        at org.elasticsearch.repositories.gcs.GoogleCloudStorageRetryingInputStream$1.read(GoogleCloudStorageRetryingInputStream.java:83)\r\n        at java.base/sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:65)\r\n        at java.base/sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:109)\r\n        at java.base/sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:103)\r\n        at org.elasticsearch.repositories.gcs.GoogleCloudStorageRetryingInputStream.read(GoogleCloudStorageRetryingInputStream.java:126)\r\n        at java.base/java.io.InputStream.read(InputStream.java:205)\r\n        at org.elasticsearch.common.io.Streams.doCopy(Streams.java:86)\r\n        at org.elasticsearch.common.io.Streams.copy(Streams.java:79)\r\n        at org.elasticsearch.common.io.Streams.copy(Streams.java:61)\r\n        at org.elasticsearch.common.io.Streams.readFully(Streams.java:252)\r\n        at org.elasticsearch.repositories.gcs.GoogleCloudStorageBlobContainerRetriesTests.testReadLargeBlobWithRetries(GoogleCloudStorageBlobContainerRetriesTests.java:228)\r\n\r\n        Caused by:\r\n        java.io.IOException: Connection closed prematurely: bytesRead = 2097151, Content-Length = 2097152\r\n            at com.google.api.client.http.javanet.NetHttpResponse$SizeValidatingInputStream.throwIfFalseEOF(NetHttpResponse.java:204)\r\n            at com.google.api.client.http.javanet.NetHttpResponse$SizeValidatingInputStream.read(NetHttpResponse.java:166)\r\n            at java.base/java.io.FilterInputStream.read(FilterInputStream.java:107)\r\n            at com.google.api.client.util.ByteStreams.copy(ByteStreams.java:49)\r\n            at com.google.api.client.util.IOUtils.copy(IOUtils.java:87)\r\n            at com.google.api.client.util.IOUtils.copy(IOUtils.java:59)\r\n            at com.google.api.client.http.HttpResponse.download(HttpResponse.java:386)\r\n            at com.google.cloud.storage.spi.v1.HttpStorageRpc.read(HttpStorageRpc.java:684)\r\n            ... 20 more\r\nREPRODUCE WITH: ./gradlew ':plugins:repository-gcs:test' --tests \"org.elasticsearch.repositories.gcs.GoogleCloudStorageBlobContainerRetriesTests.testReadLargeBlobWithRetries\" -Dtests.seed=8062D6DCDCB1069C -Dtests.security.manager=true -Dtests.locale=zh -Dtests.timezone=MET -Dcompiler.java=13\r\n```\r\n\r\n`master` - https://gradle-enterprise.elastic.co/s/bcwgezylwlugc/tests/avmwsupzrdux6-q3hb3jtfyd7iq\r\n`7.x` - https://gradle-enterprise.elastic.co/s/cr2apsim5ep4y/tests/avmwsupzrdux6-q3hb3jtfyd7iq\r\n\r\nLooks like we are barfing after reading exactly 2MB of data. Seems a bit suspect.","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}