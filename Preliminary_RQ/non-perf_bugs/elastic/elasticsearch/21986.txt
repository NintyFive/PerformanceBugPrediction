{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21986","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21986/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21986/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21986/events","html_url":"https://github.com/elastic/elasticsearch/issues/21986","id":193597538,"node_id":"MDU6SXNzdWUxOTM1OTc1Mzg=","number":21986,"title":"Terminate node on repeated iSCSI connection errors to underlying storage","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-12-05T20:08:59Z","updated_at":"2016-12-09T12:50:00Z","closed_at":"2016-12-09T12:50:00Z","author_association":"MEMBER","active_lock_reason":null,"body":"1.7.x\r\n\r\nCurrently, when there are repeated iSCSI connection errors thrown by the kernel:\r\n\r\n\r\n```\r\nDec  1 12:55:13 node_name iscsid: Kernel reported iSCSI connection 4:0 error (1020 - ISCSI_ERR_TCP_CONN_CLOSE: TCP connection closed) state (3)\r\nDec  1 12:55:13 node_name iscsid: Kernel reported iSCSI connection 3:0 error (1020 - ISCSI_ERR_TCP_CONN_CLOSE: TCP connection closed) state (3)\r\nDec  1 12:55:15 node_name iscsid: connect to 10.7.15.14:3260 failed (Connection refused)\r\nDec  1 12:55:16 node_name iscsid: connect to 10.7.15.13:3260 failed (Connection refused)\r\nDec  1 12:55:19 node_name iscsid: connect to 10.7.15.14:3260 failed (Connection refused)\r\nDec  1 12:55:19 node_name iscsid: connect to 10.7.15.13:3260 failed (Connection refused)\r\nDec  1 12:55:55 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:55:56 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:01 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:02 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:07 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:08 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:14 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:14 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:20 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:20 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:26 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:26 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:32 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:32 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:38 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:38 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:44 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:44 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:50 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:50 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:56:56 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:56:56 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:57:02 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:57:03 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:57:08 node_name iscsid: connect to 10.7.15.14:3260 failed (No route to host)\r\nDec  1 12:57:09 node_name iscsid: connect to 10.7.15.13:3260 failed (No route to host)\r\nDec  1 12:57:12 node_name kernel: session4: session recovery timed out after 120 secs\r\nDec  1 12:57:12 node_name multipathd: 8:64: mark as failed\r\nDec  1 12:57:12 node_name multipathd: mpatha: remaining active paths: 3\r\nDec  1 12:57:12 node_name kernel: sd 14:0:0:1: rejecting I/O to offline device\r\n```\r\n[messages_c.txt.zip](https://github.com/elastic/elasticsearch/files/632154/messages_c.txt.zip)\r\n\r\nThe master node will throw repeated timeout errors on monitoring apis:\r\n\r\n```\r\n[2016-12-01 13:32:21,896][DEBUG][action.admin.cluster.node.stats] [master_node] failed to execute on node [REYaXyK1S3CLWL_3SaMxww]\r\norg.elasticsearch.transport.ReceiveTimeoutTransportException: [problem_node][inet[problem_node/10.7.3.78:9300]][cluster:monitor/nodes/stats[n]] request_id [344895239] timed out after [15000ms]\r\n\tat org.elasticsearch.transport.TransportService$TimeoutHandler.run(TransportService.java:529)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\n```\r\n\r\nThe problem_node itself does not write any log entries out.  A thread dump on the node shows a lot of blocked threads.\r\n\r\n[ES_ThreadDump.txt.zip](https://github.com/elastic/elasticsearch/files/632144/ES_ThreadDump.txt.zip)\r\n\r\nThe master_node does not end up dropping the problem node from the cluster and the problem node has to be shutdown manually.  It will be helpful for admins if the ES node can kill itself so that admins can tell quite quickly that something has gone wrong.\r\n\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}