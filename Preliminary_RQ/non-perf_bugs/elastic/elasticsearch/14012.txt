{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14012","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14012/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14012/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14012/events","html_url":"https://github.com/elastic/elasticsearch/issues/14012","id":110353085,"node_id":"MDU6SXNzdWUxMTAzNTMwODU=","number":14012,"title":"unknown reason for ElasticsearchException Missing value for field","user":{"login":"dblado","id":926459,"node_id":"MDQ6VXNlcjkyNjQ1OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/926459?v=4","gravatar_id":"","url":"https://api.github.com/users/dblado","html_url":"https://github.com/dblado","followers_url":"https://api.github.com/users/dblado/followers","following_url":"https://api.github.com/users/dblado/following{/other_user}","gists_url":"https://api.github.com/users/dblado/gists{/gist_id}","starred_url":"https://api.github.com/users/dblado/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dblado/subscriptions","organizations_url":"https://api.github.com/users/dblado/orgs","repos_url":"https://api.github.com/users/dblado/repos","events_url":"https://api.github.com/users/dblado/events{/privacy}","received_events_url":"https://api.github.com/users/dblado/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2015-10-08T01:14:41Z","updated_at":"2016-04-11T14:14:53Z","closed_at":"2015-10-13T09:37:07Z","author_association":"NONE","active_lock_reason":null,"body":"I added a geo_distance filter to a query received an error:\n\nElasticsearchException[Missing value for field [reviews_length]]\n\nI really thought all of my documents had the reviews_length field so I checked, and:\n\n```\ncurl -XGET http://localhost:9200/vendop/vendor/_search -d '{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"missing\": {\n          \"field\": \"reviews_length\"\n        }\n      }\n    }\n  }\n}'\n```\n\nproduces:\n\n```\n{\n\"took\": 1,\n\"timed_out\": false,\n\"_shards\": {\n\"total\": 5,\n\"successful\": 5,\n\"failed\": 0\n},\n\"hits\": {\n\"total\": 0,\n\"max_score\": null,\n\"hits\": [ ]\n}\n}\n```\n\nThe complete query is:\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"geo_distance\": {\n                \"distance\": \"50mi\",\n                \"location2.coordinates\": [\n                  -122.4194155,\n                  37.7749295\n                ]\n              }\n            }\n          ]\n        }\n      },\n      \"query\": {\n        \"bool\": {\n          \"minimum_should_match\": \"60%\",\n          \"should\": [\n            {\n              \"function_score\": {\n                \"query\": {\n                  \"match\": {\n                    \"name.lower_raw\": \"molding\"\n                  }\n                },\n                \"functions\": [\n                  {\n                    \"boost_factor\": 20\n                  }\n                ]\n              }\n            },\n            {\n              \"function_score\": {\n                \"query\": {\n                  \"match\": {\n                    \"name\": {\n                      \"query\": \"molding\",\n                      \"fuzziness\": \"auto\"\n                    }\n                  }\n                },\n                \"functions\": [\n                  {\n                    \"boost_factor\": 10\n                  }\n                ]\n              }\n            },\n            {\n              \"multi_match\": {\n                \"query\": \"molding\",\n                \"fields\": [\n                  \"_all\"\n                ]\n              }\n            },\n            {\n              \"function_score\": {\n                \"functions\": [\n                  {\n                    \"field_value_factor\": {\n                      \"field\": \"reviews_length\",\n                      \"factor\": 0.01\n                    }\n                  }\n                ]\n              }\n            },\n            {\n              \"function_score\": {\n                \"query\": {\n                  \"terms\": {\n                    \"services\": [\n                      \"523e900941233f628f8eee71\",\n                      \"523e900941233f628f8eee72\",\n                      \"54359cfeae304c2f77d6adb6\",\n                      \"523e900941233f628f8eee70\",\n                      \"53dfabeb2a2dfa23de430fcf\",\n                      \"53dfabde2a2dfa23de430fce\"\n                    ]\n                  }\n                },\n                \"functions\": [\n                  {\n                    \"boost_factor\": 25\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"size\": 20\n}\n```\n\nIf I add this range filter to query.filtered.filter.bool.must, I still get the error but only on one of the shards (so there are search results).\n\n```\n            {\n              \"range\": {\n                \"reviews_length\": {\n                  \"gte\": 0\n                }\n              }\n            }\n```\n\nthe field is defined in the mapping as:\n\n```\n        \"reviews_length\": {\n          \"type\": \"long\"\n        }\n```\n\nI tried putting together a full test case but I couldn't reproduce the problem with a very abbreviated data set. I have tried rebuilding my index but still run into this issue. What is interesting is that if I remove the minimum_should_match from the query (or change it to <40% the problem goes away.\n\nI'm sure there is just something I'm missing in the docs. I'm using 1.4.2 in prod so I can't use the 'missing' parameter to 'field_value_factor' yet -- and shouldn't have to since none of my documents have the reviews_length field missing.\n\nIf it helps, here is the debug log from ES:\n\n```\n[2015-10-07 18:11:26,126][DEBUG][action.search.type       ] [White Rabbit] All shards failed for phase: [query]\norg.elasticsearch.search.query.QueryPhaseExecutionException: [vendop_v1][0]: query[filtered(filtered((function score (name.lower_raw:molding,function=boost[20.0]) function score (name:molding~2,function=boost[10.0]) function score (child_filter[review/vendor](filtered(_all:molding)->cache(_type:review)),function=boost[4.0]) _all:molding function score (ConstantScore(*:*),function=org.elasticsearch.common.lucene.search.function.FieldValueFactorFunction@6e1aca5f) function score (services:523e900941233f628f8eee71 services:523e900941233f628f8eee72 services:54359cfeae304c2f77d6adb6 services:523e900941233f628f8eee70 services:53dfabeb2a2dfa23de430fcf services:547ba915ae304c5e979f40f0 services:5227a9b0c64c8c1739698315 services:5328a646c61e3610d056ca90 services:52450165a4283d7aaa000000 services:533afb1fc61e3662d1cecdc2 services:523e900941233f628f8eee6f services:53dfabcd2a2dfa23de430fcd services:523e900941233f628f8eee74 services:547a7a6d2a2dfa2aaac69fb3 services:523e900941233f628f8eee75 services:53f39ac2ae304c77eaa2289e services:53dfabde2a2dfa23de430fce,function=boost[25.0]))~3)->BooleanFilter(+GeoDistanceFilter(location2.coordinates, SLOPPY_ARC, 80467.2, 37.7749295, -122.4194155)))->cache(+_type:vendor +org.elasticsearch.index.search.nested.NonNestedDocsFilter@8b805655)],from[0],size[20]: Query Failed [Failed to execute main query]\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:163)\n    at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:289)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:300)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:231)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:228)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:559)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.ElasticsearchException: Missing value for field [reviews_length]\n    at org.elasticsearch.common.lucene.search.function.FieldValueFactorFunction.score(FieldValueFactorFunction.java:71)\n    at org.elasticsearch.common.lucene.search.function.FunctionScoreQuery$FunctionFactorScorer.innerScore(FunctionScoreQuery.java:170)\n    at org.elasticsearch.common.lucene.search.function.CustomBoostFactorScorer$AnyNextDoc.score(CustomBoostFactorScorer.java:133)\n    at org.elasticsearch.common.lucene.search.function.CustomBoostFactorScorer.score(CustomBoostFactorScorer.java:71)\n    at org.apache.lucene.search.MinShouldMatchSumScorer.evaluateSmallestDocInHeap(MinShouldMatchSumScorer.java:170)\n    at org.apache.lucene.search.MinShouldMatchSumScorer.nextDoc(MinShouldMatchSumScorer.java:142)\n    at org.apache.lucene.search.FilteredQuery$QueryFirstScorer.nextDoc(FilteredQuery.java:176)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:192)\n    at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163)\n    at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:191)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:491)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:448)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:281)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:269)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:157)\n    ... 8 more\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}