{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35880","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35880/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35880/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35880/events","html_url":"https://github.com/elastic/elasticsearch/issues/35880","id":384042430,"node_id":"MDU6SXNzdWUzODQwNDI0MzA=","number":35880,"title":"Order by aggs result will cause nested percentiles return NaN","user":{"login":"tengattack","id":1846356,"node_id":"MDQ6VXNlcjE4NDYzNTY=","avatar_url":"https://avatars2.githubusercontent.com/u/1846356?v=4","gravatar_id":"","url":"https://api.github.com/users/tengattack","html_url":"https://github.com/tengattack","followers_url":"https://api.github.com/users/tengattack/followers","following_url":"https://api.github.com/users/tengattack/following{/other_user}","gists_url":"https://api.github.com/users/tengattack/gists{/gist_id}","starred_url":"https://api.github.com/users/tengattack/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tengattack/subscriptions","organizations_url":"https://api.github.com/users/tengattack/orgs","repos_url":"https://api.github.com/users/tengattack/repos","events_url":"https://api.github.com/users/tengattack/events{/privacy}","received_events_url":"https://api.github.com/users/tengattack/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-11-25T03:04:42Z","updated_at":"2018-11-26T10:32:49Z","closed_at":"2018-11-26T10:32:23Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.3\r\n\r\n**Plugins installed**: [\"readonlyrest\", \"x-pack\"]\r\n\r\n**JVM version** (`java -version`):\r\n```\r\njava version \"1.8.0_161\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_161-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Linux data00 3.10.0-693.2.2.el7.x86_64 #1 SMP Tue Sep 12 22:26:13 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\nrequest:\r\n```js\r\nPOST filebeat-6.0.1-2018.11.25/_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"1543111691803\",\r\n              \"lte\": \"1543112591803\",\r\n              \"format\": \"epoch_millis\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"query_string\": {\r\n            \"analyze_wildcard\": true,\r\n            \"query\": \"fileset.module:nginx AND fileset.name:access\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"4\": {\r\n      \"terms\": {\r\n        \"field\": \"beat.name\",\r\n        \"size\": 2,\r\n        \"order\": {\r\n          \"3[90.0]\": \"desc\"\r\n        },\r\n        \"min_doc_count\": 1\r\n      },\r\n      \"aggs\": {\r\n        \"3\": {\r\n          \"percentiles\": {\r\n            \"field\": \"nginx.access.upstream_response_time\",\r\n            \"percents\": [\r\n              \"90\",\r\n              \"95\",\r\n              \"99\"\r\n            ]\r\n          }\r\n        },\r\n        \"2\": {\r\n          \"date_histogram\": {\r\n            \"interval\": \"2s\",\r\n            \"field\": \"@timestamp\",\r\n            \"min_doc_count\": 0,\r\n            \"extended_bounds\": {\r\n              \"min\": \"1543111691803\",\r\n              \"max\": \"1543112591803\"\r\n            },\r\n            \"format\": \"epoch_millis\"\r\n          },\r\n          \"aggs\": {\r\n            \"1\": {\r\n              \"percentiles\": {\r\n                \"field\": \"nginx.access.upstream_response_time\",\r\n                \"percents\": [\r\n                  \"90\",\r\n                  \"95\",\r\n                  \"99\"\r\n                ]\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nresponse:\r\n```js highlight=\"24,30\"\r\n{\r\n  \"took\": 562,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 453835,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"4\": {\r\n      \"doc_count_error_upper_bound\": -1,\r\n      \"sum_other_doc_count\": 453736,\r\n      \"buckets\": [\r\n        {\r\n          \"2\": {\r\n            \"buckets\": [\r\n              {\r\n                \"1\": {\r\n                  \"values\": {\r\n                    \"90.0\": \"NaN\",\r\n                    \"95.0\": \"NaN\",\r\n                    \"99.0\": \"NaN\"\r\n                  }\r\n                },\r\n                \"key_as_string\": \"1543111690000\",\r\n                \"key\": 1543111690000,\r\n                \"doc_count\": 0\r\n              },\r\n              ...\r\n            ]\r\n          },\r\n          \"3\": {\r\n            \"values\": {\r\n              \"90.0\": 1.194000005722046,\r\n              \"95.0\": 1.194000005722046,\r\n              \"99.0\": 1.194000005722046\r\n            }\r\n          },\r\n          \"key\": \"uat00\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"2\": {\r\n            \"buckets\": [...]\r\n          },\r\n          \"3\": {\r\n            \"values\": {\r\n              \"90.0\": 0.16159999817609771,\r\n              \"95.0\": 0.9663000166416168,\r\n              \"99.0\": 1.2026199758052827\r\n            }\r\n          },\r\n          \"key\": \"data00\",\r\n          \"doc_count\": 98\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\nWIP\r\n\r\n\r\nWe can see the nested percentiles aggs always NaN.\r\n\r\nIs there anything wrong with my query? Thanks","closed_by":{"login":"tengattack","id":1846356,"node_id":"MDQ6VXNlcjE4NDYzNTY=","avatar_url":"https://avatars2.githubusercontent.com/u/1846356?v=4","gravatar_id":"","url":"https://api.github.com/users/tengattack","html_url":"https://github.com/tengattack","followers_url":"https://api.github.com/users/tengattack/followers","following_url":"https://api.github.com/users/tengattack/following{/other_user}","gists_url":"https://api.github.com/users/tengattack/gists{/gist_id}","starred_url":"https://api.github.com/users/tengattack/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tengattack/subscriptions","organizations_url":"https://api.github.com/users/tengattack/orgs","repos_url":"https://api.github.com/users/tengattack/repos","events_url":"https://api.github.com/users/tengattack/events{/privacy}","received_events_url":"https://api.github.com/users/tengattack/received_events","type":"User","site_admin":false},"performed_via_github_app":null}