[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/391256344","html_url":"https://github.com/elastic/elasticsearch/issues/30781#issuecomment-391256344","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30781","id":391256344,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MTI1NjM0NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-23T07:58:38Z","updated_at":"2018-05-23T07:58:38Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/391276929","html_url":"https://github.com/elastic/elasticsearch/issues/30781#issuecomment-391276929","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30781","id":391276929,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MTI3NjkyOQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-05-23T09:09:14Z","updated_at":"2018-05-23T09:09:14Z","author_association":"CONTRIBUTOR","body":"This is a known issue, offset correction with the pattern replace char filter is hard. When the replacement is longer than the captured group, the current approach is to map every new index to the end index of the replaced string. For instance say you configure \"abc\" to be replaced with \"abcde\", then `a` in the replaced string will point to `a` in the original string, same for `b` and `c`, but both `d` and `e` will point to `c` in the original string. So if you want to extract `bc` in the original string, we first compute the start and end offsets of this string in the replacement string, which gives `[1, 3)`. We then translate to offsets in the original string with the rules that I explained above, which gives `[1, 2)` since the character at offset 3 (`d`) points to offset 2 in the original string (`c`). But the substring of `abc` for indices `[1, 2)` is `b` and not `bc` as expected. This is the issue you are seeing.\r\n\r\nThe algorithm could be changed to meet your needs, but unfortunately this would break other users too, I don't think there is an easy way to fix it for everybody.\r\n\r\nYou might be able to work around the issue by slightly changing your regular expression so that it doesn't add a whitespace at the end of every token. Would `([\\\\W&&[^#\\\\s]]+)` work for instance?","performed_via_github_app":null}]