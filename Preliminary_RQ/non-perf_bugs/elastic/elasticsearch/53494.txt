{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53494","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53494/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53494/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53494/events","html_url":"https://github.com/elastic/elasticsearch/issues/53494","id":580069186,"node_id":"MDU6SXNzdWU1ODAwNjkxODY=","number":53494,"title":"Term Vectors doesn't work on artificial docs with keyword fields","user":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-12T16:42:35Z","updated_at":"2020-03-13T18:26:55Z","closed_at":"2020-03-13T15:17:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Steps to reproduce:\r\n```\r\nPUT test_termvector\r\n{\r\n    \"mappings\": {\r\n    \"properties\": {\r\n      \"words\": {\r\n        \"type\": \"keyword\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT test_termvector/_doc/1?refresh\r\n{\r\n  \"words\": [\r\n    \"b\",\r\n    \"b\",\r\n    \"b\",\r\n    \"a\",\r\n    \"e\",\r\n    \"f\",\r\n    \"f\"\r\n  ]\r\n}\r\n\r\n# we can get terms score without artifical documents\r\nGET test_termvector/_termvectors/1\r\n{\r\n  \"fields\": [\r\n    \"words\"\r\n  ],\r\n  \"term_statistics\": false,\r\n  \"field_statistics\": false,\r\n  \"positions\": false,\r\n  \"offsets\": false,\r\n  \"filter\": {\r\n    \"max_num_terms\": 3\r\n  }\r\n}\r\n\r\n{\r\n  \"_index\" : \"test_termvector\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"1\",\r\n  \"_version\" : 1,\r\n  \"found\" : true,\r\n  \"took\" : 0,\r\n  \"term_vectors\" : {\r\n    \"words\" : {\r\n      \"terms\" : {\r\n        \"b\" : {\r\n          \"term_freq\" : 3,\r\n          \"score\" : 3.0\r\n        },\r\n        \"e\" : {\r\n          \"term_freq\" : 1,\r\n          \"score\" : 1.0\r\n        },\r\n        \"f\" : {\r\n          \"term_freq\" : 2,\r\n          \"score\" : 2.0\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\n# we **cannot** get terms score with artifical documents of keyword type\r\nGET test_termvector/_termvectors\r\n{\r\n  \"doc\": {\r\n    \"words\": [\r\n      \"b\",\r\n      \"b\",\r\n      \"b\",\r\n      \"a\",\r\n      \"e\",\r\n      \"f\",\r\n      \"f\"\r\n    ]\r\n  },\r\n  \"fields\": [\r\n    \"words\"\r\n  ],\r\n  \"term_statistics\": false,\r\n  \"field_statistics\": false,\r\n  \"positions\": false,\r\n  \"offsets\": false,\r\n  \"filter\": {\r\n    \"max_num_terms\": 3\r\n  }\r\n}\r\n\r\n{\r\n  \"_index\" : \"test_termvector\",\r\n  \"_type\" : \"_doc\",\r\n  \"_version\" : 0,\r\n  \"found\" : true,\r\n  \"took\" : 0,\r\n  \"term_vectors\" : { }\r\n}\r\n```\r\n\r\nIssue is spotted in `ParseContext#getValues()` where  `field.stringValue()` returns `null` for keyword fields. Need to check for the `KeywordFieldType` and convert BytesRef to UTF8 string.","closed_by":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"performed_via_github_app":null}