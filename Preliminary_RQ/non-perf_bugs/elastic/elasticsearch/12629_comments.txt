[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/382696520","html_url":"https://github.com/elastic/elasticsearch/issues/12629#issuecomment-382696520","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12629","id":382696520,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MjY5NjUyMA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-04-19T11:08:59Z","updated_at":"2018-04-19T11:08:59Z","author_association":"CONTRIBUTOR","body":"I looked into trying to make this test be smaller without being less useful.\r\n\r\nThis test was introduced in https://github.com/elastic/elasticsearch/pull/9149 as a fix for https://github.com/elastic/elasticsearch/issues/9023. I'll admit I don't completely follow what happened in #9149 - the words indicate there was an unexpected sign inversion, but it looks like a bigger change; the key seems to be the following:\r\n\r\n```diff\r\ndiff --git a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java\r\nindex 5484498237..7c75b2a061 100644\r\n--- a/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java\r\n+++ b/src/main/java/org/elasticsearch/cluster/routing/allocation/allocator/BalancedShardsAllocator.java\r\n@@ -393,8 +393,7 @@ public class BalancedShardsAllocator extends AbstractComponent implements Shards\r\n                             final ModelNode maxNode = modelNodes[highIdx];\r\n                             advance_range:\r\n                             if (maxNode.numShards(index) > 0) {\r\n-                                float delta = weights[highIdx] - weights[lowIdx];\r\n-                                delta = lessThan(delta, threshold) ? delta : sorter.weight(Operation.THRESHOLD_CHECK, maxNode) - sorter.weight(Operation.THRESHOLD_CHECK, minNode);\r\n+                                float delta = absDelta(weights[lowIdx], weights[highIdx]);\r\n                                 if (lessThan(delta, threshold)) {\r\n                                     if (lowIdx > 0 && highIdx-1 > 0 // is there a chance for a higher delta?\r\n                                         && (weights[highIdx-1] - weights[0] > threshold) // check if we need to break at all\r\n```\r\n\r\nMy best guess is that the bug was that `sorter.weight(Operation.THRESHOLD_CHECK, maxNode)` was less than `sorter.weight(Operation.THRESHOLD_CHECK, minNode)`. However, this condition is long-gone, and this code is now quite different from how it was then, so I cannot see a way to make this test fail meaningfully.\r\n\r\nAdditionally, the only real failure of this test that I can find is a PR build (`build-1463180427010/t/20161125152515-B0401F02`) in November 2016 (in which lots of other allocation tests also failed).\r\n\r\n@s1monw can you suggest a way forward here? Perhaps one of the following:\r\n\r\n- Find a way to make it fail meaningfully again (so that I can work on finding a smaller input that triggers the same failure).\r\n- Move this to a test suite more appropriate for slower tests.\r\n- Remove it entirely.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/514632324","html_url":"https://github.com/elastic/elasticsearch/issues/12629#issuecomment-514632324","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12629","id":514632324,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDYzMjMyNA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-07-24T13:29:23Z","updated_at":"2019-07-24T13:29:23Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/514635634","html_url":"https://github.com/elastic/elasticsearch/issues/12629#issuecomment-514635634","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12629","id":514635634,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNDYzNTYzNA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-07-24T13:37:58Z","updated_at":"2019-07-24T13:37:58Z","author_association":"CONTRIBUTOR","body":"I looked at this again recently. This test now runs in ~1sec on my laptop (after warming up) and CI reports it taking ~3seconds. That's still a bit much, but nothing like as bad as the 10s reported above.\r\n\r\nI think we could perhaps replace it with a more generic test that builds up a large-ish cluster with a large-ish number of indices and asserts that the cluster is appropriately balanced at the end. I say this tentatively because it'll be a bit delicate to get an assertion that's usefully strong without being false.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/516855836","html_url":"https://github.com/elastic/elasticsearch/issues/12629#issuecomment-516855836","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12629","id":516855836,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNjg1NTgzNg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2019-07-31T13:46:04Z","updated_at":"2019-07-31T13:46:04Z","author_association":"CONTRIBUTOR","body":"We discussed this in today's team meeting and decided to close this issue. The test is acceptably fast these days and a number of us have all thought about how to generalise or improve this test without any success.","performed_via_github_app":null}]