{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21620","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21620/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21620/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21620/events","html_url":"https://github.com/elastic/elasticsearch/issues/21620","id":190028151,"node_id":"MDU6SXNzdWUxOTAwMjgxNTE=","number":21620,"title":"NullPointerException caused by multiple indices search w/ nested, inner_hits","user":{"login":"inbeom","id":712260,"node_id":"MDQ6VXNlcjcxMjI2MA==","avatar_url":"https://avatars0.githubusercontent.com/u/712260?v=4","gravatar_id":"","url":"https://api.github.com/users/inbeom","html_url":"https://github.com/inbeom","followers_url":"https://api.github.com/users/inbeom/followers","following_url":"https://api.github.com/users/inbeom/following{/other_user}","gists_url":"https://api.github.com/users/inbeom/gists{/gist_id}","starred_url":"https://api.github.com/users/inbeom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inbeom/subscriptions","organizations_url":"https://api.github.com/users/inbeom/orgs","repos_url":"https://api.github.com/users/inbeom/repos","events_url":"https://api.github.com/users/inbeom/events{/privacy}","received_events_url":"https://api.github.com/users/inbeom/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2016-11-17T12:02:40Z","updated_at":"2018-02-14T13:26:46Z","closed_at":"2016-12-22T14:09:20Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.0.0, 5.0.1\r\n\r\n**Plugins installed**: [Kibana]\r\n\r\n**JVM version**: 1.8.0_92\r\n\r\n**OS version**: Elastic.co Cloud (5.0.0) / OS X El Capitan (5.0.1)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nRequesting `nested` query on multiple indices with `inner_hits` and `ignore_unmapped: true` causes a NullPointerException on indices which do not have the desired `nested` property. \r\n\r\nIt shows correct `hits.total` while not returning all the matched document(s) in `hits.hits`.\r\n\r\n**Steps to reproduce**:\r\n\r\nI've successfully reproduced the behavior using two indices while only one of them having the nested property.\r\n\r\n```sh\r\ncurl -XDELETE localhost:9200/people\r\ncurl -XPUT -d '{\r\n  \"mappings\": {\r\n    \"employee\": {\r\n      \"properties\": {\r\n        \"companyId\": { \"type\": \"string\" }\r\n      }\r\n    }\r\n  }\r\n}' localhost:9200/people\r\n\r\ncurl -XDELETE localhost:9200/things\r\ncurl -XPUT -d '{\r\n  \"mappings\": {\r\n    \"product\": {\r\n      \"properties\": {\r\n        \"companyId\": { \"type\": \"string\" },\r\n        \"parts\": { \"type\": \"nested\", \"properties\": { \"companyId\": { \"type\": \"string\" } } }\r\n      }\r\n    }\r\n  }\r\n}' localhost:9200/things\r\n\r\ncurl -XPUT -d '{ \"companyId\": \"foo\" }' localhost:9200/people/employee/1\r\ncurl -XPUT -d '{ \"companyId\": \"foo\", \"parts\": [{ \"companyId\": \"foo\" }] }' localhost:9200/things/product/1\r\n\r\nsleep 1\r\n\r\n# Fails\r\ncurl -d '{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"nested\": {\r\n            \"path\": \"parts\",\r\n            \"query\": { \"term\": { \"parts.companyId\": \"foo\" } },\r\n            \"ignore_unmapped\": true,\r\n            \"inner_hits\": {}\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"companyId\": \"foo\"\r\n          }\r\n        }\r\n      ],\r\n      \"minimum_should_match\": 1\r\n    }\r\n  }\r\n}' localhost:9200/people,things/_search\r\n\r\n# Succeeds\r\ncurl -d '{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"nested\": {\r\n            \"path\": \"parts\",\r\n            \"query\": { \"term\": { \"parts.companyId\": \"foo\" } },\r\n            \"ignore_unmapped\": true\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"companyId\": \"foo\"\r\n          }\r\n        }\r\n      ],\r\n      \"minimum_should_match\": 1\r\n    }\r\n  }\r\n}' localhost:9200/people,things/_search\r\n```\r\n\r\nThe failing request responds with the body:\r\n\r\n```json\r\n{\r\n  \"took\": 31,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 10,\r\n    \"successful\": 9,\r\n    \"failed\": 1,\r\n    \"failures\": [\r\n      {\r\n        \"shard\": 3,\r\n        \"index\": \"people\",\r\n        \"node\": \"LuRj8eynRU-s1Wfvn9VELw\",\r\n        \"reason\": {\r\n          \"type\": \"null_pointer_exception\",\r\n          \"reason\": null\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"hits\": {\r\n    \"total\": 2,\r\n    \"max_score\": 0.5753642,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"things\",\r\n        \"_type\": \"product\",\r\n        \"_id\": \"1\",\r\n        \"_score\": 0.5753642,\r\n        \"_source\": {\r\n          \"companyId\": \"foo\",\r\n          \"parts\": [\r\n            {\r\n              \"companyId\": \"foo\"\r\n            }\r\n          ]\r\n        },\r\n        \"inner_hits\": {\r\n          \"parts\": {\r\n            \"hits\": {\r\n              \"total\": 1,\r\n              \"max_score\": 0.2876821,\r\n              \"hits\": [\r\n                {\r\n                  \"_nested\": {\r\n                    \"field\": \"parts\",\r\n                    \"offset\": 0\r\n                  },\r\n                  \"_score\": 0.2876821,\r\n                  \"_source\": {\r\n                    \"companyId\": \"foo\"\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2016-11-17T20:40:33,561][DEBUG][o.e.a.s.TransportSearchAction] [LuRj8ey] [12] Failed to execute fetch phase\r\norg.elasticsearch.transport.RemoteTransportException: [LuRj8ey][127.0.0.1:9300][indices:data/read/search[phase/fetch/id]]\r\nCaused by: java.lang.NullPointerException\r\n        at org.elasticsearch.search.fetch.subphase.InnerHitsContext$NestedInnerHits.topDocs(InnerHitsContext.java:135) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitExecute(InnerHitsFetchSubPhase.java:55) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:161) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:474) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$13(SearchTransportService.java:311) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:520) [elasticsearch-5.0.1.jar:5.0.1]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.1.jar:5.0.1]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_92]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_92]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_92]\r\n```\r\n\r\nThanks.","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}