{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18692","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18692/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18692/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18692/events","html_url":"https://github.com/elastic/elasticsearch/issues/18692","id":158015128,"node_id":"MDU6SXNzdWUxNTgwMTUxMjg=","number":18692,"title":"FVH + hunspell breaks when searching multiple fields","user":{"login":"rpedela","id":1952582,"node_id":"MDQ6VXNlcjE5NTI1ODI=","avatar_url":"https://avatars1.githubusercontent.com/u/1952582?v=4","gravatar_id":"","url":"https://api.github.com/users/rpedela","html_url":"https://github.com/rpedela","followers_url":"https://api.github.com/users/rpedela/followers","following_url":"https://api.github.com/users/rpedela/following{/other_user}","gists_url":"https://api.github.com/users/rpedela/gists{/gist_id}","starred_url":"https://api.github.com/users/rpedela/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rpedela/subscriptions","organizations_url":"https://api.github.com/users/rpedela/orgs","repos_url":"https://api.github.com/users/rpedela/repos","events_url":"https://api.github.com/users/rpedela/events{/privacy}","received_events_url":"https://api.github.com/users/rpedela/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-06-01T21:49:50Z","updated_at":"2016-11-28T09:47:08Z","closed_at":"2016-11-25T15:49:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.2\n**JVM version**: 1.8.0_91\n**OS version**: Ubuntu 14.04\n**Hunspell dictionary**: http://extensions.openoffice.org/en/project/english-dictionaries-apache-openoffice\n\nWhen using the fast vector highlighter and the hunspell stemmer, the highlights for a given field change depending on which fields are searched. If I disable stemming, use `kstem`, or use the plain highlighter then everything works as expected. It appears to be some weird interaction between FVH, hunspell, and my particular search query.\n\n**Index**:\n\n``` sh\ncurl -XPUT 'http://localhost:9200/highlight_test' -d '{\n    \"settings\": {\n        \"analysis\": {\n            \"filter\": {\n                \"en_US\": {\n                    \"type\": \"hunspell\",\n                    \"language\": \"en_US\"\n                }\n            },\n            \"analyzer\": {\n                \"en_US\": {\n                    \"tokenizer\": \"standard\",\n                    \"filter\": [\n                        \"lowercase\",\n                        \"en_US\"\n                    ]\n                }\n            }\n        }\n    },\n    \"mappings\": {\n        \"default\": {\n            \"_all\": {\n                \"enabled\": false\n            },\n            \"properties\": {\n                \"raw_text\": {\n                    \"analyzer\": \"en_US\",\n                    \"type\": \"string\",\n                    \"term_vector\": \"with_positions_offsets\"\n                },\n                \"title\": {\n                    \"analyzer\": \"en_US\",\n                    \"type\": \"string\"\n                }\n            }\n        }\n    }\n}'\n\ncurl -XPUT 'http://localhost:9200/highlight_test/default/1' -d '{\n    \"raw_text\": \"EX-99.2\\n10\\nf8k072915ex99ii_globalpart.htm\\nGLOBAL PARTNER ACQUISITION CORP. ANNOUNCES CLOSING OF INITIAL PUBLIC OFFERING\\n\\n\\n\\nExhibit 99.2\\n\\n\\n\\n\\n\\n\\n\\n\\nGlobal Partner\\nAcquisition Corp. Announces Closing of Initial Public Offering\\n\\n\\n\\n\\n\\nNEW YORK, August 4, 2015 /PRNewswire/\\n-- Global Partner Acquisition Corporation (NASDAQ:GPACU) (the \\\"Company\\\") announced today that it closed its initial\\npublic offering of 15,525,000 units, including 2,025,000 units issued pursuant to the full exercise by the underwriters of their\\nover-allotment option. The offering was priced at $10.00 per unit, resulting in gross proceeds of $155,250,000. The Company is\\na newly organized blank check company formed for the purpose of effecting a merger or other business combination with a target\\ncompany. The proceeds of the offering will be used to fund such business combination.\\n\\n\\n\\n\\n\\nThe Companys units began trading\\non the NASDAQ Capital Market under the ticker symbol “GPACU” on July 30, 2015. Each unit consists of one share of the\\nCompanys common stock and one warrant. Each warrant will entitle the holder thereof to purchase one-half of one share of the Companys\\ncommon stock at $5.75 per half share. Once the securities comprising the units begin separate trading, the common stock and warrants\\nare expected to be listed on the NASDAQ Stock Market under the ticker symbols “GPAC” and “GPACW,” respectively.\\n\\n\\n\\n\\n\\nDeutsche Bank Securities Inc. acted\\nas sole book-running manager for the offering.\\n\\n\\n\\n\\n\\nThe offering is being made only\\nby means of a prospectus, copies of which may be obtained from Deutsche Bank Securities Inc., 60 Wall Street, New York, NY 10005-2836,\\nAttention: Prospectus Group, Telephone: (800) 503-4611, Email: prospectus.cpdg@db.com.\\n\\n\\n\\n\\n\\nA registration statement relating\\nto these securities has been filed with, and declared effective by, the Securities and Exchange Commission on July 29, 2015.\\n\\n\\n\\n\\n\\nThis press release shall not constitute\\nan offer to sell or the solicitation of an offer to buy, nor shall there be any sale of these securities in any state or jurisdiction\\nin which such an offer, solicitation or sale would be unlawful prior to registration or qualification under the securities laws\\nof any such state or jurisdiction.\\n\\n\\n\\n\\n\\nFor more information, please contact: pzepf@globalpartnerac.com.\\n\\n\\n\\n\\n\\nFORWARD-LOOKING STATEMENTS\\n\\n\\n\\n\\n\\nThis press release contains statements\\nthat constitute “forward-looking statements,” including with respect to the anticipated use of the net proceeds. No\\nassurance can be given that the net proceeds of the offering will be used as indicated. Forward-looking statements are subject\\nto numerous conditions, many of which are beyond the control of the Company, including those set forth in the Risk Factors section\\nof the Companys registration statement and preliminary prospectus for the offering filed with the Securities and Exchange Commission\\n(“SEC”). Copies are available on the SECs website, www.sec.gov. The Company undertakes no obligation to update\\nthese statements for revisions or changes after the date of this release, except as required by law.\\n\\n\\n\\n\\n\\nContact:\\n\\n\\nPaul Zepf\\n\\n\\nChief Executive Officer\\n\\n\\nGlobal Partner Acquisition Corporation\\n\\n\\npzepf@globalpartnerac.com\",\n    \"title\": \"EX-99.2 - Global Partner Acquisition Corp. Announces Closing Of Initial Public Offering\"\n}'\n```\n\n**Search**:\n\n``` sh\ncurl -XGET 'http://localhost:9200/highlight_test/default/_search' -d '{\n    \"fields\": [],\n    \"query\": {\n        \"bool\": {\n            \"must\": {\n                \"multi_match\": {\n                    \"query\": \"initial public offering\",\n                    \"type\": \"best_fields\",\n                    \"operator\": \"and\",\n                    \"fields\": [\n                        \"raw_text\",\n                        \"title\"\n                    ]\n                }\n            },\n            \"should\": [\n                {\n                    \"multi_match\": {\n                        \"query\": \"initial public offering\",\n                        \"type\": \"phrase\",\n                        \"boost\": 100,\n                        \"fields\": [\n                            \"raw_text\",\n                            \"title\"\n                        ]\n                    }\n                },\n                {\n                    \"multi_match\": {\n                        \"query\": \"initial public offering\",\n                        \"type\": \"phrase\",\n                        \"slop\": 10,\n                        \"boost\": 10,\n                        \"fields\": [\n                            \"raw_text\",\n                            \"title\"\n                        ]\n                    }\n                }\n            ]\n        }\n    },\n    \"highlight\": {\n        \"order\": \"score\",\n        \"fields\": {\n            \"raw_text\": {\n                \"number_of_fragments\": 1\n            }\n        }\n    }\n}'\n```\n\n**Expected Result**:\nIf I only search `raw_text` in the above query rather than both `title` and `raw_text`, then I will receive a great highlight.\n\n``` js\n{\n    \"took\": 1,\n    \"timed_out\": false,\n    \"_shards\": {\n        \"total\": 5,\n        \"successful\": 5,\n        \"failed\": 0\n    },\n    \"hits\": {\n        \"total\": 1,\n        \"max_score\": 0.09119049,\n        \"hits\": [\n            {\n                \"_index\": \"highlight_test\",\n                \"_type\": \"default\",\n                \"_id\": \"1\",\n                \"_score\": 0.09119049,\n                \"highlight\": {\n                    \"raw_text\": [\n                        \"ACQUISITION CORP. ANNOUNCES CLOSING OF <em>INITIAL PUBLIC OFFERING</em>\\n\\n\\n\\nExhibit 99.2\\n\\n\\n\\n\\n\\n\\n\\n\\nGlobal Partner\"\n                    ]\n                }\n            }\n        ]\n    }\n}\n```\n\n**Actual Result**:\nNotice that the highlight for `raw_text` is different and worse than the expected result.\n\n``` js\n{\n    \"took\": 2,\n    \"timed_out\": false,\n    \"_shards\": {\n        \"total\": 5,\n        \"successful\": 5,\n        \"failed\": 0\n    },\n    \"hits\": {\n        \"total\": 1,\n        \"max_score\": 0.33662215,\n        \"hits\": [\n            {\n                \"_index\": \"highlight_test\",\n                \"_type\": \"default\",\n                \"_id\": \"1\",\n                \"_score\": 0.33662215,\n                \"highlight\": {\n                    \"raw_text\": [\n                        \"as sole book-running manager for the <em>offering</em>.\\n\\n\\n\\n\\n\\nThe <em>offering</em> is being made only\\nby means of a prospectus\"\n                    ]\n                }\n            }\n        ]\n    }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}