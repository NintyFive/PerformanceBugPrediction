{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51839","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51839/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51839/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51839/events","html_url":"https://github.com/elastic/elasticsearch/issues/51839","id":559408162,"node_id":"MDU6SXNzdWU1NTk0MDgxNjI=","number":51839,"title":"Clarify the difference between `cluster.routing.allocation.total_shards_per_node` and `cluster.max_shards_per_node`","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":1967495446,"node_id":"MDU6TGFiZWwxOTY3NDk1NDQ2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Infra","name":"Team:Core/Infra","color":"fef2c0","default":false,"description":"Meta label for core/infra team"},{"id":1967497573,"node_id":"MDU6TGFiZWwxOTY3NDk3NTcz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Docs","name":"Team:Docs","color":"fef2c0","default":false,"description":"Meta label for docs team"}],"state":"closed","locked":false,"assignee":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"assignees":[{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2020-02-04T00:03:43Z","updated_at":"2020-11-16T13:33:05Z","closed_at":"2020-11-16T13:33:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I've seen some confusion about the differences between [`cluster.routing.allocation.total_shards_per_node`](https://www.elastic.co/guide/en/elasticsearch/reference/current/allocation-total-shards.html) and [`cluster.max_shards_per_node`](https://www.elastic.co/guide/en/elasticsearch/reference/7.5/misc-cluster.html), which is reasonable given the similarity in their names and the brevity of their documentation.  I think the docs could be clarified fairly easily with just a few additions to the docs for each setting. Below are some notes I wrote up elsewhere about the difference between these two settings - these should probably be condensed down before being included in the docs rather than pasted directly.\r\n\r\n---\r\n\r\n- `cluster.routing.allocation.total_shards_per_node` is checked at allocation time to control how many shards will be allocated to any given node. To give an example: If this setting is set to 100, and there are 3 data nodes - A with 100 shards, B with 98 shards, and C with 1 shard, and node C dies and its shard needs to be reallocated, they can only go to node B, because node A already has 100 shards.\r\n- `cluster.max_shards_per_node` controls how many shards are allowed to exist in the cluster as a whole, and is checked at shard creation time, but does not pay attention to how many shards any individual node has. To give an example: If this setting is set to 100, and there are 3 data nodes A with 100 shards, B with 98 shards, and C with 98 shards, there are 296 shards total in the cluster. The limit is `number_of_data_nodes * cluster.max_shards_per_node = 3 * 100 = 300`, so up to 4 new shards can be created in the cluster.  If you try to create an index with 3 shards/1 replica, this would result in the creation of 6 total shards (3 primaries and 3 replicas), which would take the cluster over the limit of 300 and the request will be rejected.\r\n\r\nTo summarize: `cluster.routing.allocation.total_shards_per_node` controls how many shards each individual node can have allocated to it at any given time, while `cluster.max_shards_per_node` controls how many shards the cluster can have in it as a whole, scaled by number of data nodes, but regardless of how many shards any particular node might have allocated to it.\r\n\r\nSome notes:\r\n\r\n- Hitting the limit from `cluster.max_shards_per_node` will result in requests that would create more shards being rejected. This is to prevent the most extreme cases of oversharding.\r\n- `cluster.max_shards_per_node` counts both primary and replica shards for open indices. Closed indices don't count, so if you see a cluster hitting this limit, closing some indices will help. Frozen indices count as open, at time of writing, although if we get feedback that counting them as closed would be useful that's open to changing.\r\n- Operations that create shards include but are not limited to: Creating an index, increasing the number of replicas on an index, resizing or cloning an index, restoring an index from a snapshot.\r\n- `cluster.max_shards_per_node` uses the number of *data* nodes to determine the limit. Non-data nodes (dedicated master, ingest-only, etc.) don't count. A cluster with no data nodes has no limit (apparently some users will set up master nodes first, create indices and such, and then add data nodes later, this is to enable that use case).","closed_by":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"performed_via_github_app":null}