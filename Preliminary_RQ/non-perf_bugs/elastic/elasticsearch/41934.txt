{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41934","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41934/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41934/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41934/events","html_url":"https://github.com/elastic/elasticsearch/issues/41934","id":441601768,"node_id":"MDU6SXNzdWU0NDE2MDE3Njg=","number":41934,"title":"“totalTermFreq must be at least docFreq” error after upgrading to 7.0.1","user":{"login":"TheRealChrisS","id":23656603,"node_id":"MDQ6VXNlcjIzNjU2NjAz","avatar_url":"https://avatars3.githubusercontent.com/u/23656603?v=4","gravatar_id":"","url":"https://api.github.com/users/TheRealChrisS","html_url":"https://github.com/TheRealChrisS","followers_url":"https://api.github.com/users/TheRealChrisS/followers","following_url":"https://api.github.com/users/TheRealChrisS/following{/other_user}","gists_url":"https://api.github.com/users/TheRealChrisS/gists{/gist_id}","starred_url":"https://api.github.com/users/TheRealChrisS/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TheRealChrisS/subscriptions","organizations_url":"https://api.github.com/users/TheRealChrisS/orgs","repos_url":"https://api.github.com/users/TheRealChrisS/repos","events_url":"https://api.github.com/users/TheRealChrisS/events{/privacy}","received_events_url":"https://api.github.com/users/TheRealChrisS/received_events","type":"User","site_admin":false},"labels":[{"id":418189364,"node_id":"MDU6TGFiZWw0MTgxODkzNjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Ranking","name":":Search/Ranking","color":"0e8a16","default":false,"description":"Scoring, rescoring, rank evaluation."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1306883601,"node_id":"MDU6TGFiZWwxMzA2ODgzNjAx","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.1","name":"v7.0.1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-05-08T07:57:53Z","updated_at":"2019-05-09T12:25:07Z","closed_at":"2019-05-09T12:25:07Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 7.0.1, Build: default/tar/e4efcb5/2019-04-29T12:56:03.145736Z, JVM: 1.8.0_202\r\n\r\n**Plugins installed**:\r\nJust the plugins which are shipped with ES\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_202\"\r\nOpenJDK Runtime Environment (AdoptOpenJDK)(build 1.8.0_202-b08)\r\nOpenJDK 64-Bit Server VM (AdoptOpenJDK)(build 25.202-b08, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 3.10.0-514.21.1.el7.x86_64 #1 SMP Thu May 25 17:04:51 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAfter upgrading from 6.7.1 I get lots of “totalTermFreq must be at least docFreq” errors.\r\n\r\n**Steps to reproduce**:\r\n\r\nI don't have a simple example of how to reproduce because it only happens when I index tons of data. Until now I wasn't able to reproduce it with just a few documents.\r\n\r\nBut I'll share what I've figured out so far.\r\nAlso see the following discussion, there a two other guys encountering the same problem:\r\nhttps://discuss.elastic.co/t/totaltermfreq-must-be-at-least-docfreq-error-after-upgrading-to-7-0-1/179977\r\n\r\n\r\nI search using multi-match queries with cross_fields. Changing it to best_fields helps, but is not what I want.\r\n\r\nIn my environment it seems that array fields are causing the problem.\r\n\r\nI've got a mapping like:\r\n\r\n```\r\n{\r\n\t\"properties\": {\r\n\t\t\"description\": {\r\n\t\t\t\"type\": \"text\",\r\n\t\t\t\"similarity\": \"custom_similarity\",\r\n\t\t\t\"term_vector\" : \"with_positions_offsets\",\r\n\t\t\t\"analyzer\": \"standard_analyzer\",\r\n\t\t\t\"search_analyzer\": \"standard_search_analyzer\",\r\n\t\t\t\"fields\": {\r\n\t\t\t\t\"ngram\": {\r\n\t\t\t\t\t\"type\": \"text\",\r\n\t\t\t\t\t\"similarity\": \"custom_similarity\",\r\n\t\t\t\t\t\"analyzer\": \"ngram_analyzer\",\r\n\t\t\t\t\t\"search_analyzer\": \"standard_search_analyzer\"\r\n\t\t\t\t},\r\n\t\t\t\t\"edge_ngram_prefix\": {\r\n\t\t\t\t\t\"type\": \"text\",\r\n\t\t\t\t\t\"similarity\": \"custom_similarity\",\r\n\t\t\t\t\t\"analyzer\": \"edge_ngram_1_analyzer\",\r\n\t\t\t\t\t\"search_analyzer\": \"standard_search_analyzer\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t},\r\n\t\t\"tags\": {\r\n\t\t\t\"type\": \"text\",\r\n\t\t\t\"similarity\": \"custom_similarity\",\r\n\t\t\t\"analyzer\": \"standard_analyzer\",\r\n\t\t\t\"search_analyzer\": \"standard_search_analyzer\",\r\n\t\t\t\"fields\": {\r\n\t\t\t\t\"keyword\": {\r\n\t\t\t\t\t\"type\": \"keyword\",\r\n\t\t\t\t\t\"ignore_above\": 256\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\nAnd I post data like:\r\n\r\n```\r\nPOST /some_index/_doc\r\n{\r\n\t\"description\": \"Some description\",\r\n\t\"tags\": [\"foo\", \"bar\", \"foo bar\"]\r\n}\r\n```\r\nWhen I search in both fields the query fails.\r\n\r\nThe query looks like:\r\n\r\n```\r\n{  \r\n   \"from\":0,\r\n   \"size\":100,\r\n   \"query\":{  \r\n      \"bool\":{  \r\n         \"must\":[  \r\n            {  \r\n               \"function_score\":{  \r\n                  \"query\":{  \r\n                     \"bool\":{  \r\n                        \"must\":[  \r\n                           {  \r\n                              \"function_score\":{  \r\n                                 \"query\":{  \r\n                                    \"multi_match\":{  \r\n                                       \"query\":\"foo\",\r\n                                       \"fields\":[  \r\n                                          \"description^3.0\",\r\n                                          \"description.edge_ngram_prefix^0.90000004\",\r\n                                          \"description.ngram^0.6\",\r\n                                          \"tags^1.0\"\r\n                                       ],\r\n                                       \"type\":\"cross_fields\",\r\n                                       \"operator\":\"AND\",\r\n                                       \"slop\":0,\r\n                                       \"prefix_length\":0,\r\n                                       \"max_expansions\":50,\r\n                                       \"tie_breaker\":0.05,\r\n                                       \"zero_terms_query\":\"NONE\",\r\n                                       \"auto_generate_synonyms_phrase_query\":true,\r\n                                       \"fuzzy_transpositions\":true,\r\n                                       \"boost\":1.0\r\n                                    }\r\n                                 },\r\n                                 \"functions\":[  \r\n                                    {  \r\n                                       \"filter\":{  \r\n                                          \"match_all\":{  \r\n                                             \"boost\":1.0\r\n                                          }\r\n                                       },\r\n                                       \"field_value_factor\":{  \r\n                                          \"field\":\"boost\",\r\n                                          \"factor\":1.0,\r\n                                          \"modifier\":\"none\"\r\n                                       }\r\n                                    }\r\n                                 ],\r\n                                 \"score_mode\":\"sum\",\r\n                                 \"max_boost\":3.4028235E38,\r\n                                 \"boost\":1.0\r\n                              }\r\n                           }\r\n                        ],\r\n                        \"adjust_pure_negative\":true,\r\n                        \"boost\":1.0\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         ],\r\n         \"adjust_pure_negative\":true,\r\n         \"boost\":1.0\r\n      }\r\n   }\r\n}\r\n```\r\n\r\nWhen I remove all those array fields from the query I do no longer get this error.\r\n\r\nSo problem seems to have something to do with the cross_fields option and array fields.\r\n\r\nLet me know if you need more details, logs, etc.\r\n\r\nEdit:\r\nI also deleted and reindexed the data. But that didn't help, also.","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}