{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13362","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13362/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13362/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13362/events","html_url":"https://github.com/elastic/elasticsearch/issues/13362","id":105045163,"node_id":"MDU6SXNzdWUxMDUwNDUxNjM=","number":13362,"title":"Template not applied to some documents","user":{"login":"jimmyjones2","id":2991805,"node_id":"MDQ6VXNlcjI5OTE4MDU=","avatar_url":"https://avatars2.githubusercontent.com/u/2991805?v=4","gravatar_id":"","url":"https://api.github.com/users/jimmyjones2","html_url":"https://github.com/jimmyjones2","followers_url":"https://api.github.com/users/jimmyjones2/followers","following_url":"https://api.github.com/users/jimmyjones2/following{/other_user}","gists_url":"https://api.github.com/users/jimmyjones2/gists{/gist_id}","starred_url":"https://api.github.com/users/jimmyjones2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimmyjones2/subscriptions","organizations_url":"https://api.github.com/users/jimmyjones2/orgs","repos_url":"https://api.github.com/users/jimmyjones2/repos","events_url":"https://api.github.com/users/jimmyjones2/events{/privacy}","received_events_url":"https://api.github.com/users/jimmyjones2/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-09-05T19:47:29Z","updated_at":"2015-09-06T16:24:55Z","closed_at":"2015-09-06T14:20:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I've distilled this from logstash, it appears that the template is not applied to the last document in some cases, so the value of field2 (cat) doesn't get included in all, so the following query:\n\n``` json\nGET /repro/_search\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"query_string\": {\n          \"query\": \"bye cat\"\n        }\n      }\n    }\n  }\n}\n```\n\nreturns both documents the first time, then after waiting 20s when additional fields are added to the same document and the index recreated, only one is returned.\n\n``` bash\ncurl -XDELETE localhost:9200/repro\ncurl -XDELETE localhost:9200/_template/repro\ncurl -XPUT localhost:9200/_template/repro -d '{\"template\":\"repro\",\"mappings\":{\"_default_\":{\"include_in_all\":false,\"_all\":{\"analyzer\":\"keyword\"},\"properties\":{\"field1\":{\"type\":\"string\"},\"field2\":{\"type\":\"string\",\"include_in_all\":true}}}}}'\ncurl -XPOST localhost:9200/_bulk --data-binary '\n{\"index\":{\"_id\":null,\"_index\":\"repro\",\"_type\":\"logs\"}}\n{\"field1\":\"hello\",\"field2\":\"bye\"}\n{\"index\":{\"id\":null,\"_index\":\"repro\",\"_type\":\"logs\"}}\n{\"field1\":\"dog\",\"field2\":\"cat\"}\n\n'\nsleep 20\ncurl -XDELETE localhost:9200/repro\ncurl -XPOST localhost:9200/_bulk --data-binary '\n{\"index\":{\"_id\":null,\"_index\":\"repro\",\"_type\":\"logs\"}}\n{\"field1\":\"hello\",\"field2\":\"bye\",\"@version\":\"1\"}\n{\"index\":{\"_id\":null,\"_index\":\"repro\",\"_type\":\"logs\"}}\n{\"field1\":\"dog\",\"field2\":\"cat\",\"@version\":\"1\"}\n\n'\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}