{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21927","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21927/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21927/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21927/events","html_url":"https://github.com/elastic/elasticsearch/issues/21927","id":193049537,"node_id":"MDU6SXNzdWUxOTMwNDk1Mzc=","number":21927,"title":"The need to allow min_doc_count >shard_min_doc_count in significant_terms aggregation","user":{"login":"voidlps","id":3744683,"node_id":"MDQ6VXNlcjM3NDQ2ODM=","avatar_url":"https://avatars2.githubusercontent.com/u/3744683?v=4","gravatar_id":"","url":"https://api.github.com/users/voidlps","html_url":"https://github.com/voidlps","followers_url":"https://api.github.com/users/voidlps/followers","following_url":"https://api.github.com/users/voidlps/following{/other_user}","gists_url":"https://api.github.com/users/voidlps/gists{/gist_id}","starred_url":"https://api.github.com/users/voidlps/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/voidlps/subscriptions","organizations_url":"https://api.github.com/users/voidlps/orgs","repos_url":"https://api.github.com/users/voidlps/repos","events_url":"https://api.github.com/users/voidlps/events{/privacy}","received_events_url":"https://api.github.com/users/voidlps/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2016-12-02T07:11:43Z","updated_at":"2016-12-16T16:37:25Z","closed_at":"2016-12-16T16:37:25Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n\r\n**Describe the feature**: \r\nIn significant terms aggergation: allow min_doc_count > shard_min_doc_count is required when need to set shard_min_doc_count=0 to get correct bg_count in some cases\r\n\r\n**Use-case description:**\r\nIn  index per time frame scenario, running significant_terms on different time-range requires to set shard_size=0,shard_min_doc_count=0 to get correct score.  In this case, setting min_doc_count to a larger number is still meaningful\r\n\r\n \r\nthere is the use-case we get very unexpected behaviour using default values:\r\n1. environment: logstash created one index per day \r\n2. do a significant terms to logstash-* multiple indexes, with foreground [now-1h to now] / background [now-1d to now] using background-filter to check if there are something special in the log in last hour\r\n  \r\nwe found the in many cases, we have some terms looks like very common, and bg_doc_count number seems incorrecnt, looks like it counts contains only documents of current day.  Esp at the hour just after midnight or the next.\r\n  \r\nA very special case to reproduce is, we have indexes logstash-20161201 & logstash-20161202, now=20161202 03:00 the foreground=[20161202 02:00-20161202 03:00], background=[20161201 03:00-201602 03:00], \r\nwe may see the the many common term like \"json\" is reported as significant term, with bg_doc_count value having only doc with \"json\" in index logstash-20161202, but not  logstash-20161201\r\n\r\nBy reading document carefully and some source code, we understand where the issue comes from:\r\n*the bg_count of \"json\" from shards of  logstash-20161201 will not be counted*  \r\n\r\nbecause default value of shard_min_doc_count=1 will let the term \"json\" has no chance to be selected to let reducer count it \r\nsince the foreground has no intersection to index logstash-20161201, so all terms of those shards will with doc_count=0\r\n\r\nonly when set min_doc_count=0,shard_size=0,shard_min_doc_count=0, we get the behaviour we expected originally.\r\n\r\nHowever we still would like to set min_doc_count to some number instead extracting a long list to filter later in application, but min_doc_count > shard_min_doc_count is not allowed.  Any value set to min_doc_count cannot correct the behaviour.\r\n\r\n \r\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}