[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504529826","html_url":"https://github.com/elastic/elasticsearch/issues/43497#issuecomment-504529826","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43497","id":504529826,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDUyOTgyNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-21T18:38:48Z","updated_at":"2019-06-21T18:38:48Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504637379","html_url":"https://github.com/elastic/elasticsearch/issues/43497#issuecomment-504637379","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43497","id":504637379,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDYzNzM3OQ==","user":{"login":"davin4u","id":6419941,"node_id":"MDQ6VXNlcjY0MTk5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/6419941?v=4","gravatar_id":"","url":"https://api.github.com/users/davin4u","html_url":"https://github.com/davin4u","followers_url":"https://api.github.com/users/davin4u/followers","following_url":"https://api.github.com/users/davin4u/following{/other_user}","gists_url":"https://api.github.com/users/davin4u/gists{/gist_id}","starred_url":"https://api.github.com/users/davin4u/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davin4u/subscriptions","organizations_url":"https://api.github.com/users/davin4u/orgs","repos_url":"https://api.github.com/users/davin4u/repos","events_url":"https://api.github.com/users/davin4u/events{/privacy}","received_events_url":"https://api.github.com/users/davin4u/received_events","type":"User","site_admin":false},"created_at":"2019-06-22T06:53:38Z","updated_at":"2019-06-22T06:57:04Z","author_association":"NONE","body":"The same error, here is my configuration and index settings:\r\n\r\nES version which i use: 7.1.0\r\n\r\ndocker-compose.yml:\r\n\r\n```\r\nelasticsearch:\r\n        image: elasticsearch:7.1.0\r\n        restart: always\r\n        ports:\r\n            - \"9200:9200\"\r\n            - \"9300:9300\"\r\n        volumes:\r\n            - ./esdata71:/usr/share/elasticsearch/data\r\n        environment:\r\n            - bootstrap.memory_lock=true\r\n            - \"ES_JAVA_OPTS=-Xms512m -Xmx512m\"\r\n            - discovery.type=single-node\r\n        ulimits:\r\n            memlock:\r\n                soft: -1\r\n                hard: -1\r\n```\r\n\r\nIndex settings:\r\n\r\n```\r\n[\r\n        \"max_ngram_diff\" => 10,\r\n        \"analysis\" => [\r\n            \"tokenizer\" => [\r\n                \"edge_trigrams_tokenizer\" => [\r\n                    \"type\"    => \"edge_ngram\",\r\n                    \"min_gram\"=> 3,\r\n                    \"max_gram\"=> 20,\r\n                    \"token_chars\" => [\"letter\", \"whitespace\", \"punctuation\", \"symbol\", \"digit\"]\r\n\r\n                ],\r\n                \"trigrams_tokenizer\" => [\r\n                    \"type\"    => \"ngram\",\r\n                    \"min_gram\"=> 3,\r\n                    \"max_gram\"=> 10,\r\n                    \"token_chars\" => [\"letter\", \"whitespace\", \"punctuation\", \"symbol\", \"digit\"]\r\n                ],\r\n                \"short_trigrams_tokenizer\" => [\r\n                    \"type\" => \"edge_ngram\",\r\n                    \"min_gram\" => 1,\r\n                    \"max_gram\" => 3,\r\n                    \"token_chars\" => [\"letter\", \"whitespace\", \"punctuation\", \"symbol\", \"digit\"]\r\n                ]\r\n            ],\r\n            \"analyzer\"=> [\r\n                \"edge_trigrams\"=> [\r\n                    \"type\"=>  \"custom\",\r\n                    \"tokenizer\"=> \"edge_trigrams_tokenizer\",\r\n                    \"filter\"=>   [\r\n                        \"lowercase\", \"asciifolding\"\r\n                    ],\r\n                    \"char_filter\" => [\"synonym\"]\r\n                ],\r\n                \"trigrams\"=> [\r\n                    \"type\"=>  \"custom\",\r\n                    \"tokenizer\"=> \"trigrams_tokenizer\",\r\n                    \"filter\"=>   [\r\n                        \"lowercase\", \"asciifolding\"\r\n                    ],\r\n                    \"char_filter\" => [\"synonym\"]\r\n                ]\r\n            ],\r\n            \"char_filter\" => [\r\n                \"synonym\" => [\r\n                    \"type\" => \"mapping\",\r\n                    \"mappings\" => [\r\n                        \"v.d => van de\",\r\n                        \"v/d => van de\",\r\n                        \"vd => van de\",\r\n                        \"vh => van het\",\r\n                        \"v/h => van het\",\r\n                        \"v.h => van het\",\r\n                        \"dl => de la\",\r\n                        \"d/l => de la\",\r\n                        \"d'la => de la\",\r\n                        \"du => de le\",\r\n                        \"de l' => de la\"\r\n                    ]\r\n                ]\r\n            ]\r\n        ]\r\n    ]\r\n```\r\n\r\nMapping settings:\r\n\r\n```\r\n\"name\"        => [\r\n        'type'      => 'text',\r\n        'analyzer'  => 'edge_trigrams'\r\n    ],\r\n    \"last_name\" => [\r\n        'type'      => 'text',\r\n        'analyzer'  => 'edge_trigrams'\r\n    ],\r\n    \"exact_name\" => [\r\n        'type'      => 'text',\r\n        'analyzer'  => 'trigrams'\r\n    ],\r\n    \"birth_year\" => [\r\n        'type'      => 'text',\r\n        'analyzer'  => 'standard'\r\n    ],\r\n    \"sex\" => [\r\n        'type'      => 'text',\r\n        'analyzer'  => 'standard'\r\n    ],\r\n    \"active\" => [\r\n        'type'      => 'boolean'\r\n    ]\r\n```\r\n\r\nData from Elasticsearch log:\r\n\r\n```\r\n\"Caused by: java.lang.NullPointerException\",\r\n\"at org.apache.lucene.search.ReqOptSumScorer.setMinCompetitiveScore(ReqOptSumScorer.java:299) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.apache.lucene.search.ScoreCachingWrappingScorer.setMinCompetitiveScore(ScoreCachingWrappingScorer.java:59) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.apache.lucene.search.TopScoreDocCollector.updateMinCompetitiveScore(TopScoreDocCollector.java:242) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.apache.lucene.search.TopScoreDocCollector$SimpleTopScoreDocCollector$1.collect(TopScoreDocCollector.java:78) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.elasticsearch.common.lucene.MinimumScoreCollector.collect(MinimumScoreCollector.java:57) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:263) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:214) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:652) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:177) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:443) ~[lucene-core-8.0.0.jar:8.0.0 2ae4746365c1ee72a0047ced7610b2096e438979 - jimczi - 2019-03-08 11:58:55]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:275) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:115) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:349) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:393) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n\"at org.elasticsearch.search.SearchService.access$100(SearchService.java:124) ~[elasticsearch-7.1.0.jar:7.1.0]\",\r\n```\r\n\r\nSo, from the top line i noticed that error appears in the file ReqOptSumScorer.java:299\r\n\r\nand on the 299 line i see next:\r\n`maxScorePropagator.setMinCompetitiveScore(minScore);`\r\n\r\nvariable is defined on line 54:\r\n\r\n```\r\nif (scoreMode == ScoreMode.TOP_SCORES) {\r\n     this.maxScorePropagator = new MaxScoreSumPropagator(Arrays.asList(reqScorer, optScorer));\r\n} else {\r\n     this.maxScorePropagator = null;\r\n}\r\n```\r\n\r\nso i assume that in my case it goes to \"else\" section and variable is NULL.\r\n\r\nquery which i use:\r\n\r\n```\r\ncurl -X GET \"localhost:9200/people/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n\t\t\t\"query\": {\r\n\t\t\t\t\"bool\": {\r\n\t\t\t\t\t\"should\": [\r\n\t\t\t\t\t\t{\"match\":{\"name\":\"andrew\"}}\r\n\t\t\t\t\t],\r\n\t\t\t\t\t\"must\": [\r\n\t\t\t\t\t    {\"match\":{\"birth_year\":\"2005\"}}\r\n\t\t\t\t\t]\r\n\t\t\t\t}\r\n\t\t\t},\r\n\r\n\t                \"sort\":{\"_score\":{\"order\":\"desc\"}},\"from\":0,\"size\":\"15\",\"min_score\":5\r\n}\r\n' | python -m json.tool\r\n```\r\n\r\nThe problem appears only sometimes so i assume it depends somehow on the index data. For example with different \"min_score\" the error can appear or not, or with different \"birth_year\" and so on.","performed_via_github_app":null}]