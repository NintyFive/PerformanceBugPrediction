{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15600","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15600/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15600/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15600/events","html_url":"https://github.com/elastic/elasticsearch/issues/15600","id":123455197,"node_id":"MDU6SXNzdWUxMjM0NTUxOTc=","number":15600,"title":"Data inconsistency with different queries","user":{"login":"pseverino","id":12476010,"node_id":"MDQ6VXNlcjEyNDc2MDEw","avatar_url":"https://avatars3.githubusercontent.com/u/12476010?v=4","gravatar_id":"","url":"https://api.github.com/users/pseverino","html_url":"https://github.com/pseverino","followers_url":"https://api.github.com/users/pseverino/followers","following_url":"https://api.github.com/users/pseverino/following{/other_user}","gists_url":"https://api.github.com/users/pseverino/gists{/gist_id}","starred_url":"https://api.github.com/users/pseverino/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pseverino/subscriptions","organizations_url":"https://api.github.com/users/pseverino/orgs","repos_url":"https://api.github.com/users/pseverino/repos","events_url":"https://api.github.com/users/pseverino/events{/privacy}","received_events_url":"https://api.github.com/users/pseverino/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2015-12-22T10:29:58Z","updated_at":"2018-03-22T17:36:19Z","closed_at":"2018-03-22T17:36:19Z","author_association":"NONE","active_lock_reason":null,"body":"Hi guys,\n\nI was doing some work with Kibana and I got some inconsistent results in my data, after that I did some more digging around with queries using REST and I discovered some problems with ES.\n\nSo I have some millions of events in my index and I get completely different results from different queries,  I think the problem is when I use aggregations inside of another aggregation. Let me show you the queries and the results:\n\nAggs 1:\n\n```\n\"aggs\" : {\n  \"3\" : {\n    \"filter\" : { \"term\" : { \"type\" : \"type1\" } },\n    \"aggs\" : {\n      \"1\" : { \n        \"filter\" : { \"term\" : { \"domain\" : \"X\" } },   \n        \"aggs\" : {\n          \"distinct\" : { \"cardinality\" : { \"field\" : \"remote_addr\" } }\n        }\n      }\n    }\n  }\n}\n```\n\nResult 1:\n\n```\n\"hits\" : {\n  \"total\" : 13785806,\n  \"max_score\" : 0.0,\n  \"hits\" : [ ]\n},\n\"aggregations\" : {\n  \"3\" : {\n    \"doc_count\" : 617159,\n    \"1\" : {\n      \"doc_count\" : 617159,\n      \"distinct\" : {\n        \"value\" : 293193,\n        \"value_as_string\" : \"0.4.121.73\"\n      }\n    }\n  }\n}\n```\n\nAggs 2:\n\n```\n\"aggs\" : {\n  \"3\" : {\n    \"filter\" : { \"term\" : { \"type\" : \"type1\" } },\n    \"aggs\" : {\n      \"distinct\" : { \"cardinality\" : { \"field\" : \"remote_addr\" } }\n    }\n  }\n}\n```\n\nResult 2:\n\n```\n\"aggregations\" : {\n  \"3\" : {\n    \"doc_count\" : 617159,\n    \"distinct\" : {\n      \"value\" : 293193,\n      \"value_as_string\" : \"0.4.121.73\"\n    }\n  }\n}\n```\n\nAggs 3:\n\n```\n\"aggs\": {\n \"2\": {\n   \"terms\": {\n     \"field\": \"domain\",\n     \"size\": 5,\n     \"order\": {\n       \"2-orderAgg\": \"desc\"\n     }\n   },\n   \"aggs\": {\n     \"3\": {\n       \"terms\": {\n         \"field\": \"type\",\n         \"size\": 1,\n         \"order\": {\n           \"1\": \"desc\"\n         }\n       },\n       \"aggs\": {\n         \"1\": {\n           \"cardinality\": {\n             \"field\": \"remote_addr\"\n           }\n         }\n       }\n     },\n     \"2-orderAgg\": {\n       \"cardinality\": {\n         \"field\": \"remote_addr\"\n       }\n     }\n   }\n }\n}\n```\n\nResult 3:\n\n```\n\"aggregations\" : {\n  \"2\" : {\n    \"doc_count_error_upper_bound\" : -1,\n    \"sum_other_doc_count\" : 6767717,\n    \"buckets\" : [ {\n      \"key\" : \"X\",\n      \"doc_count\" : 617159,\n      \"3\" : {\n        \"doc_count_error_upper_bound\" : 0,\n        \"sum_other_doc_count\" : 0,\n        \"buckets\" : [ {\n          \"key\" : \"type1\",\n          \"doc_count\" : 617159,\n          \"1\" : {\n            \"value\" : 368688,\n            \"value_as_string\" : \"0.5.160.48\"\n          }\n        } ]\n      },\n      \"2-orderAgg\" : {\n        \"value\" : 283687,\n        \"value_as_string\" : \"0.4.84.39\"\n      }\n    }\n    ...\n    } ]\n  }\n}\n```\n\nSo something is going wrong inside ES by this results.\nWe can conclude:\n- The index has 13785806 documents\n- 617159 documents have domain with value \"X\"\n- 617159 documents have the type with value \"type1\"\n  ? We can see with aggs3 that the document with domain=\"X\" and type=\"type1\" are the same, so how can we have different cardinalities for this sets in aggs3? Notice that the cardinality in the inner set is even bigger that the one on the outside set...\n\nDo you have any ideas about this? I think this really is an ES bug, but could be any kind of error from my part? (I know comparing filters and eggs could be misleading, but the results are too different...)\n\nOther info:\n- I experienced the error with ES 2.1.0 and after I upgraded to 2.1.1 the error persists\n- About the data types\n  -  Domain is a string, not analyzed, doc values active\n  -  Type is a string, not analyzed, doc values active\n  -  Remote_addr  is an ip, not analyzed, doc values active\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}