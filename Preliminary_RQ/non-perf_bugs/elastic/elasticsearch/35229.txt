{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35229","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35229/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35229/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35229/events","html_url":"https://github.com/elastic/elasticsearch/issues/35229","id":377074703,"node_id":"MDU6SXNzdWUzNzcwNzQ3MDM=","number":35229,"title":"Snapshots on large indices fail on some shards when master election occurs","user":{"login":"clandry94","id":5351125,"node_id":"MDQ6VXNlcjUzNTExMjU=","avatar_url":"https://avatars0.githubusercontent.com/u/5351125?v=4","gravatar_id":"","url":"https://api.github.com/users/clandry94","html_url":"https://github.com/clandry94","followers_url":"https://api.github.com/users/clandry94/followers","following_url":"https://api.github.com/users/clandry94/following{/other_user}","gists_url":"https://api.github.com/users/clandry94/gists{/gist_id}","starred_url":"https://api.github.com/users/clandry94/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clandry94/subscriptions","organizations_url":"https://api.github.com/users/clandry94/orgs","repos_url":"https://api.github.com/users/clandry94/repos","events_url":"https://api.github.com/users/clandry94/events{/privacy}","received_events_url":"https://api.github.com/users/clandry94/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-11-03T17:18:24Z","updated_at":"2018-12-14T12:24:30Z","closed_at":"2018-12-14T12:24:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.1\r\n\r\n**Plugins installed**: [analysis-kuromoji, analysis-icu, repository-gcs]\r\n\r\n**JVM version** (`java -version`): 10.0.2\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux 4.14.56+\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nExpected: Creating a snapshot for a large index (> 8TB) with high number of shards (>800) on a cluster that has dedicated master nodes completes successfully even if a master election occurs mid snapshot. \r\n\r\nActual: Creating a snapshot for a large index (> 8TB) with high number of shards (>800) on a cluster that has dedicated master nodes fails on some shards with `IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: FileAlreadyExistsException` if a master election occurs during the snapshot. \r\n\r\nI think that this issue may be known and handled in the case that an election occurs during the `finalizeSnapshot` step as seen here https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java#L550. This seems like a similar bug. Perhaps the new master attempts to also create a snapshot of the shard, overwriting the successful snapshot with the failed? \r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Create a cluster with dedicated master nodes\r\n 2. Create a large index pointed at a GCS repo with specs higher than above (>8TB index size and >800 shards)\r\n 3. Perform a snapshot (snapshots at this size will take between 30m and 2 hours)\r\n\r\n**Provide logs (if relevant)**:\r\nSnapshot status in `_cat/snapshots/<repo name>`\r\n`2018-10-16t19-57-07 PARTIAL 1539719828  19:57:08   1539722642 20:44:02    46.8m      70              2716             4         2720`\r\n\r\nSnippet of errors seen in logs from viewing snapshot status in API\r\n```\r\n{\r\n          \"index\" : \"<index_name>\",\r\n          \"index_uuid\" : \"<index_name>\",\r\n          \"shard_id\" : 178,\r\n          \"reason\" : \"IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: FileAlreadyExistsException[indices/Y0qyoa00TuaVx0iYLpVbXw/178/__1oc: Precondition Failed]; \",\r\n          \"node_id\" : \"lkwyayn5QVGh8okWvRIJpg\",\r\n          \"status\" : \"INTERNAL_SERVER_ERROR\"\r\n        },\r\n        {\r\n          \"index\" : \"<index_name>,\r\n          \"index_uuid\" : \"<index_name>\",\r\n          \"shard_id\" : 45,\r\n          \"reason\" : \"IndexShardSnapshotFailedException[com.google.cloud.storage.StorageException: Error writing request body to server]; nested: StorageException[Error writing request body to server]; nested: IOException[Error writing request body to server]; \",\r\n          \"node_id\" : \"xlJM3LeIS2SlitmN71R6fA\",\r\n          \"status\" : \"INTERNAL_SERVER_ERROR\"\r\n        },\r\n}\r\n```","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}