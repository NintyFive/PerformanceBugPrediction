{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34465","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34465/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34465/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34465/events","html_url":"https://github.com/elastic/elasticsearch/issues/34465","id":370206375,"node_id":"MDU6SXNzdWUzNzAyMDYzNzU=","number":34465,"title":"[ILM] Rollover action errors after restart","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"assignees":[{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2018-10-15T15:02:41Z","updated_at":"2018-11-05T16:20:44Z","closed_at":"2018-11-05T16:20:44Z","author_association":"MEMBER","active_lock_reason":null,"body":"4 node cluster with 1 hot, 2 warm and 1 cold node\r\n\r\n1. Create a policy:\r\n```\r\nPUT _ilm/my_lifecycle3\r\n{\r\n  \"policy\": {\r\n    \"phases\": {\r\n      \"hot\": {\r\n        \"actions\": {\r\n          \"rollover\": {\r\n            \"max_age\": \"30s\"\r\n          }\r\n        }\r\n      },\r\n      \"warm\": {\r\n        \"actions\": {\r\n          \"forcemerge\": {\r\n            \"max_num_segments\": 1\r\n          },\r\n          \"allocate\": {\r\n            \"number_of_replicas\": 1,\r\n            \"include\": {\r\n              \"box_type\": \"warm\"\r\n            },\r\n            \"exclude\": {},\r\n            \"require\": {}\r\n          }\r\n        }\r\n      },\r\n      \"cold\": {\r\n        \"minimum_age\": \"1m\",\r\n        \"actions\": {\r\n          \"allocate\": {\r\n            \"number_of_replicas\": 0,\r\n            \"include\": {\r\n              \"box_type\": \"cold\"\r\n            },\r\n            \"exclude\": {},\r\n            \"require\": {}\r\n          }\r\n        }\r\n      },\r\n      \"delete\": {\r\n        \"minimum_age\": \"2m\",\r\n        \"actions\": {\r\n          \"delete\": {}\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n2. Create an index template:\r\n```\r\nPUT _template/my_template\r\n{\r\n  \"index_patterns\": [\"test-*\"],\r\n  \"settings\": {\r\n    \"number_of_shards\": 2,\r\n    \"number_of_replicas\": 0,\r\n    \"index.lifecycle.name\": \"my_lifecycle3\",\r\n    \"index.lifecycle.rollover_alias\": \"test-alias\",\r\n    \"index.routing.allocation.include.box_type\": \"hot\"\r\n  }\r\n}\r\n```\r\n\r\n3.  create the first index:\r\n```\r\nPUT test-000001\r\n{\r\n  \"aliases\": {\r\n    \"test-alias\":{\r\n      \"is_write_index\": true\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n4. Check the index is on the `attempt_rollover` step using the explain api:\r\n```\r\nGET test-*/_ilm/explain?human\r\n```\r\n\r\n5. Shutdown all nodes\r\n\r\n6. Restart all nodes\r\n\r\n7. Wait for the 2nd index to appear using the explain API:\r\n```\r\nGET test-*/_ilm/explain?human\r\n```\r\n\r\n8. Observe that the first index is in the ERROR state with a response something like the following\r\n```\r\n{\r\n  \"indices\": {\r\n    \"test-000001\": {\r\n      \"index\": \"test-000001\",\r\n      \"managed\": true,\r\n      \"policy\": \"my_lifecycle3\",\r\n      \"skip\": false,\r\n      \"lifecycle_date\": \"2018-10-15T14:49:32.281Z\",\r\n      \"phase\": \"hot\",\r\n      \"phase_time\": \"2018-10-15T14:49:32.531Z\",\r\n      \"action\": \"rollover\",\r\n      \"action_time\": \"2018-10-15T14:49:32.531Z\",\r\n      \"step\": \"ERROR\",\r\n      \"step_time\": \"2018-10-15T14:50:18.632Z\",\r\n      \"failed_step\": \"attempt_rollover\",\r\n      \"step_info\": {\r\n        \"type\": \"resource_already_exists_exception\",\r\n        \"reason\": \"index [test-000002/cRr06akcS4mJXfZniAFfGQ] already exists\",\r\n        \"index_uuid\": \"cRr06akcS4mJXfZniAFfGQ\",\r\n        \"index\": \"test-000002\"\r\n      },\r\n      \"phase_execution\": {\r\n        \"policy\": \"my_lifecycle3\",\r\n        \"phase_definition\": {\r\n          \"minimum_age\": \"0ms\",\r\n          \"actions\": {\r\n            \"rollover\": {\r\n              \"max_age\": \"30s\"\r\n            }\r\n          }\r\n        },\r\n        \"version\": 1,\r\n        \"modified_date\": \"2018-10-15T14:49:24.641Z\",\r\n        \"modified_date_in_millis\": 1539614964641\r\n      }\r\n    },\r\n    \"test-000002\": {\r\n      \"index\": \"test-000002\",\r\n      \"managed\": true,\r\n      \"policy\": \"my_lifecycle3\",\r\n      \"skip\": false,\r\n      \"lifecycle_date\": \"2018-10-15T14:50:17.338Z\",\r\n      \"phase\": \"new\",\r\n      \"phase_time\": \"2018-10-15T14:50:18.725Z\",\r\n      \"action\": \"complete\",\r\n      \"action_time\": \"2018-10-15T14:50:18.384Z\",\r\n      \"step\": \"complete\",\r\n      \"step_time\": \"2018-10-15T14:50:18.384Z\"\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIt seems like in this scenario the rollover step might be getting run twice?","closed_by":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"performed_via_github_app":null}