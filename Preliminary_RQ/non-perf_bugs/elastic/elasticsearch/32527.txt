{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32527","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32527/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32527/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32527/events","html_url":"https://github.com/elastic/elasticsearch/issues/32527","id":346407252,"node_id":"MDU6SXNzdWUzNDY0MDcyNTI=","number":32527,"title":"Failed to search against Search Template with conditional clauses","user":{"login":"Wing333","id":22282496,"node_id":"MDQ6VXNlcjIyMjgyNDk2","avatar_url":"https://avatars1.githubusercontent.com/u/22282496?v=4","gravatar_id":"","url":"https://api.github.com/users/Wing333","html_url":"https://github.com/Wing333","followers_url":"https://api.github.com/users/Wing333/followers","following_url":"https://api.github.com/users/Wing333/following{/other_user}","gists_url":"https://api.github.com/users/Wing333/gists{/gist_id}","starred_url":"https://api.github.com/users/Wing333/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Wing333/subscriptions","organizations_url":"https://api.github.com/users/Wing333/orgs","repos_url":"https://api.github.com/users/Wing333/repos","events_url":"https://api.github.com/users/Wing333/events{/privacy}","received_events_url":"https://api.github.com/users/Wing333/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-08-01T00:41:09Z","updated_at":"2019-10-30T16:01:08Z","closed_at":"2019-10-30T16:01:07Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.2\r\n\r\n**Plugins installed**: [n/a]\r\n\r\n**JVM version** (`java -version`): java version \"1.8.0_181\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_181-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux version 2.6.32-131.0.15.el6.x86_64 (mockbuild@x86-007.build.bos.redhat.com) (gcc version 4.4.4 20100726 (Red Hat 4.4.4-13) (GCC) ) #1 SMP Tue May 10 15:42:40 EDT 2011\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nFailed to search against template with conditional clauses.\r\nExpected: search successfully.\r\nActual behavior: search failed with error:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"general_script_exception\",\r\n        \"reason\": \"Failed to compile inline script [{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\":{\\\"match\\\":{\\\"line\\\":\\\"{{text}}\\\"}},\\\"filter\\\":{{{#line_no}}\\\"range\\\":{\\\"line_no\\\":{{{#start}}\\\"gte\\\":\\\"{{start}}\\\"{{#end}},{{/end}}{{/start}}{{#end}}\\\"lte\\\":\\\"{{end}}\\\"{{/end}}}}{{/line_no}}}}}}] using lang [mustache]\"\r\n      }\r\n    ],\r\n    \"type\": \"general_script_exception\",\r\n    \"reason\": \"Failed to compile inline script [{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\":{\\\"match\\\":{\\\"line\\\":\\\"{{text}}\\\"}},\\\"filter\\\":{{{#line_no}}\\\"range\\\":{\\\"line_no\\\":{{{#start}}\\\"gte\\\":\\\"{{start}}\\\"{{#end}},{{/end}}{{/start}}{{#end}}\\\"lte\\\":\\\"{{end}}\\\"{{/end}}}}{{/line_no}}}}}}] using lang [mustache]\",\r\n    \"caused_by\": {\r\n      \"type\": \"mustache_exception\",\r\n      \"reason\": \"Improperly closed variable in query-template:1\"\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\nThis is a sample query presented as an example in\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/6.2/search-template.html#_conditional_clauses:\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": {\r\n        \"match\": {\r\n          \"line\": \"{{text}}\" \r\n        }\r\n      },\r\n      \"filter\": {\r\n        {{#line_no}} \r\n          \"range\": {\r\n            \"line_no\": {\r\n              {{#start}} \r\n                \"gte\": \"{{start}}\" \r\n                {{#end}},{{/end}} \r\n              {{/start}} \r\n              {{#end}} \r\n                \"lte\": \"{{end}}\" \r\n              {{/end}} \r\n            }\r\n          }\r\n        {{/line_no}} \r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAnd this is the escaped string documented in the same page:\r\n```\r\n\"source\": \"{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\":{\\\"match\\\":{\\\"line\\\":\\\"{{text}}\\\"}},\\\"filter\\\":{{{#line_no}}\\\"range\\\":{\\\"line_no\\\":{{{#start}}\\\"gte\\\":\\\"{{start}}\\\"{{#end}},{{/end}}{{/start}}{{#end}}\\\"lte\\\":\\\"{{end}}\\\"{{/end}}}}{{/line_no}}}}}}\"\r\n```\r\n\r\nIf I validate above query as below:\r\n```\r\nGET _render/template\r\n{\r\n  \"source\": \"{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\":{\\\"match\\\":{\\\"line\\\":\\\"{{text}}\\\"}},\\\"filter\\\":{{{#line_no}}\\\"range\\\":{\\\"line_no\\\":{{{#start}}\\\"gte\\\":\\\"{{start}}\\\"{{#end}},{{/end}}{{/start}}{{#end}}\\\"lte\\\":\\\"{{end}}\\\"{{/end}}}}{{/line_no}}}}}}\",\r\n  \"params\": {\r\n    \"text\": \"words to search for\",\r\n    \"line_no\": {\r\n      \"start\": 10,\r\n      \"end\": 20\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIt will fail with error:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"general_script_exception\",\r\n        \"reason\": \"Failed to compile inline script [{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\":{\\\"match\\\":{\\\"line\\\":\\\"{{text}}\\\"}},\\\"filter\\\":{{{#line_no}}\\\"range\\\":{\\\"line_no\\\":{{{#start}}\\\"gte\\\":\\\"{{start}}\\\"{{#end}},{{/end}}{{/start}}{{#end}}\\\"lte\\\":\\\"{{end}}\\\"{{/end}}}}{{/line_no}}}}}}] using lang [mustache]\"\r\n      }\r\n    ],\r\n    \"type\": \"general_script_exception\",\r\n    \"reason\": \"Failed to compile inline script [{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\":{\\\"match\\\":{\\\"line\\\":\\\"{{text}}\\\"}},\\\"filter\\\":{{{#line_no}}\\\"range\\\":{\\\"line_no\\\":{{{#start}}\\\"gte\\\":\\\"{{start}}\\\"{{#end}},{{/end}}{{/start}}{{#end}}\\\"lte\\\":\\\"{{end}}\\\"{{/end}}}}{{/line_no}}}}}}] using lang [mustache]\",\r\n    \"caused_by\": {\r\n      \"type\": \"mustache_exception\",\r\n      \"reason\": \"Improperly closed variable in query-template:1\"\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\nHowever if I escape the original query (and also remove spaces afterwards, but this is optional and does not affect the result) as below:\r\n```\r\nGET _render/template\r\n{\r\n  \"source\": \"{\\r\\n\\\"query\\\":{\\r\\n\\\"bool\\\":{\\r\\n\\\"must\\\":{\\r\\n\\\"match\\\":{\\r\\n\\\"line\\\":\\\"{{text}}\\\"\\r\\n}\\r\\n},\\r\\n\\\"filter\\\":{\\r\\n{{#line_no}}\\r\\n\\\"range\\\":{\\r\\n\\\"line_no\\\":{\\r\\n{{#start}}\\r\\n\\\"gte\\\":\\\"{{start}}\\\"\\r\\n{{#end}},{{/end}}\\r\\n{{/start}}\\r\\n{{#end}}\\r\\n\\\"lte\\\":\\\"{{end}}\\\"\\r\\n{{/end}}\\r\\n}\\r\\n}\\r\\n{{/line_no}}\\r\\n}\\r\\n}\\r\\n}\\r\\n}\",\r\n  \"params\": {\r\n    \"text\": \"words to search for\",\r\n    \"line_no\": {\r\n      \"start\": 10,\r\n      \"end\": 20\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThen it will work:\r\n```\r\n{\r\n  \"template_output\": {\r\n    \"query\": {\r\n      \"bool\": {\r\n        \"must\": {\r\n          \"match\": {\r\n            \"line\": \"words to search for\"\r\n          }\r\n        },\r\n        \"filter\": {\r\n          \"range\": {\r\n            \"line_no\": {\r\n              \"gte\": \"10\",\r\n              \"lte\": \"20\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI'm wondering why it does not work in the first case?","closed_by":{"login":"wchrisdean","id":53786748,"node_id":"MDQ6VXNlcjUzNzg2NzQ4","avatar_url":"https://avatars2.githubusercontent.com/u/53786748?v=4","gravatar_id":"","url":"https://api.github.com/users/wchrisdean","html_url":"https://github.com/wchrisdean","followers_url":"https://api.github.com/users/wchrisdean/followers","following_url":"https://api.github.com/users/wchrisdean/following{/other_user}","gists_url":"https://api.github.com/users/wchrisdean/gists{/gist_id}","starred_url":"https://api.github.com/users/wchrisdean/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wchrisdean/subscriptions","organizations_url":"https://api.github.com/users/wchrisdean/orgs","repos_url":"https://api.github.com/users/wchrisdean/repos","events_url":"https://api.github.com/users/wchrisdean/events{/privacy}","received_events_url":"https://api.github.com/users/wchrisdean/received_events","type":"User","site_admin":false},"performed_via_github_app":null}