{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36939","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36939/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36939/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36939/events","html_url":"https://github.com/elastic/elasticsearch/issues/36939","id":393474646,"node_id":"MDU6SXNzdWUzOTM0NzQ2NDY=","number":36939,"title":"Refering to a result from a GROUP BY subquery returns ","user":{"login":"eariasp","id":45455173,"node_id":"MDQ6VXNlcjQ1NDU1MTcz","avatar_url":"https://avatars0.githubusercontent.com/u/45455173?v=4","gravatar_id":"","url":"https://api.github.com/users/eariasp","html_url":"https://github.com/eariasp","followers_url":"https://api.github.com/users/eariasp/followers","following_url":"https://api.github.com/users/eariasp/following{/other_user}","gists_url":"https://api.github.com/users/eariasp/gists{/gist_id}","starred_url":"https://api.github.com/users/eariasp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eariasp/subscriptions","organizations_url":"https://api.github.com/users/eariasp/orgs","repos_url":"https://api.github.com/users/eariasp/repos","events_url":"https://api.github.com/users/eariasp/events{/privacy}","received_events_url":"https://api.github.com/users/eariasp/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-21T14:19:40Z","updated_at":"2018-12-28T10:03:39Z","closed_at":"2018-12-28T10:03:38Z","author_association":"NONE","active_lock_reason":null,"body":"Installation and machine:\r\nES 6.4.3 installation in a ES aws hosted instance\r\n\r\nDescription:\r\nAn a query using a subquery involving a GROUP BY this error is launched:\r\n\r\n```\r\nServer error [Server encountered an error []. [Failed to execute phase [fetch], \r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:293)\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:91)\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:708)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: ScriptException[compile error]; nested: IllegalArgumentException[Variable [doc] is not defined.];\r\n\tat org.elasticsearch.painless.PainlessScriptEngine.convertToScriptException(PainlessScriptEngine.java:510)\r\n\tat org.elasticsearch.painless.PainlessScriptEngine.compile(PainlessScriptEngine.java:430)\r\n\tat org.elasticsearch.painless.PainlessScriptEngine.compile(PainlessScriptEngine.java:170)\r\n\tat org.elasticsearch.script.ScriptService.compile(ScriptService.java:334)\r\n\tat org.elasticsearch.search.aggregations.pipeline.bucketselector.BucketSelectorPipelineAggregator.reduce(BucketSelectorPipelineAggregator.java:86)\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:138)\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:90)\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:525)\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:502)\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:419)\r\n\tat org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:738)\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:101)\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:44)\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:86)\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n\t... 5 more\r\nCaused by: java.lang.IllegalArgumentException: Variable [doc] is not defined.\r\n\tat org.elasticsearch.painless.PainlessScript$Script.compile(InternalSqlScriptUtils.nullSafeFilter(InternalSqlScriptUtils.eq(InternalSqlScriptUtils.docValue(doc,params.v0),params.v1)):97)\r\n\tat org.elasticsearch.painless.Locals.getVariable(Locals.java:179)\r\n\tat org.elasticsearch.painless.Locals.getVariable(Locals.java:177)\r\n\tat org.elasticsearch.painless.node.EVariable.analyze(EVariable.java:54)\r\n\tat org.elasticsearch.painless.node.PSubCallInvoke.analyze(PSubCallInvoke.java:61)\r\n\tat org.elasticsearch.painless.node.PCallInvoke.analyze(PCallInvoke.java:89)\r\n\tat org.elasticsearch.painless.node.PSubCallInvoke.analyze(PSubCallInvoke.java:61)\r\n\tat org.elasticsearch.painless.node.PCallInvoke.analyze(PCallInvoke.java:89)\r\n\tat org.elasticsearch.painless.node.PSubCallInvoke.analyze(PSubCallInvoke.java:61)\r\n\tat org.elasticsearch.painless.node.PCallInvoke.analyze(PCallInvoke.java:89)\r\n\tat org.elasticsearch.painless.node.SExpression.analyze(SExpression.java:54)\r\n\tat org.elasticsearch.painless.node.SSource.analyze(SSource.java:227)\r\n\tat org.elasticsearch.painless.node.SSource.analyze(SSource.java:185)\r\n\tat org.elasticsearch.painless.Compiler.compile(Compiler.java:225)\r\n\tat org.elasticsearch.painless.PainlessScriptEngine$5.run(PainlessScriptEngine.java:423)\r\n\tat org.elasticsearch.painless.PainlessScriptEngine$5.run(PainlessScriptEngine.java:419)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat org.elasticsearch.painless.PainlessScriptEngine.compile(PainlessScriptEngine.java:419)\r\n\t... 19 more\r\n]]\r\n```\r\n\r\nSteps to reproduce:\r\n\r\n 1. load data:\r\n\r\n```\r\ncurl -X DELETE \"localhost:9200/test_groupby_subquery\"\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery\"\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_mapping/_doc\" -H 'Content-Type: application/json' -d'\r\n{\r\n\"properties\": {\r\n\"id\": { \"type\": \"long\" } \r\n}\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/1\" -H 'Content-Type: application/json' -d' { \"id\": \"1\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/2\" -H 'Content-Type: application/json' -d' { \"id\": \"2\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/3\" -H 'Content-Type: application/json' -d' { \"id\": \"3\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/4\" -H 'Content-Type: application/json' -d' { \"id\": \"4\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/5\" -H 'Content-Type: application/json' -d' { \"id\": \"5\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/6\" -H 'Content-Type: application/json' -d' { \"id\": \"6\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/7\" -H 'Content-Type: application/json' -d' { \"id\": \"7\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/8\" -H 'Content-Type: application/json' -d' { \"id\": \"8\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/9\" -H 'Content-Type: application/json' -d' { \"id\": \"9\"} '\r\ncurl -X PUT \"localhost:9200/test_groupby_subquery/_doc/10\" -H 'Content-Type: application/json' -d' { \"id\": \"10\"} '\r\n```\r\n\r\n 2. in a ES sql client execute:\r\n`select * from (select id from test_groupby_subquery GROUP by id) where id = 3;`\r\n\r\nThis should return a row with the value 3.","closed_by":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}