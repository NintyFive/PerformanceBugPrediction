{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17067","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17067/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17067/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17067/events","html_url":"https://github.com/elastic/elasticsearch/issues/17067","id":140144476,"node_id":"MDU6SXNzdWUxNDAxNDQ0NzY=","number":17067,"title":"Getting the nested objects in sorted order.","user":{"login":"himaniJoshi","id":15976885,"node_id":"MDQ6VXNlcjE1OTc2ODg1","avatar_url":"https://avatars3.githubusercontent.com/u/15976885?v=4","gravatar_id":"","url":"https://api.github.com/users/himaniJoshi","html_url":"https://github.com/himaniJoshi","followers_url":"https://api.github.com/users/himaniJoshi/followers","following_url":"https://api.github.com/users/himaniJoshi/following{/other_user}","gists_url":"https://api.github.com/users/himaniJoshi/gists{/gist_id}","starred_url":"https://api.github.com/users/himaniJoshi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/himaniJoshi/subscriptions","organizations_url":"https://api.github.com/users/himaniJoshi/orgs","repos_url":"https://api.github.com/users/himaniJoshi/repos","events_url":"https://api.github.com/users/himaniJoshi/events{/privacy}","received_events_url":"https://api.github.com/users/himaniJoshi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-03-11T10:07:10Z","updated_at":"2016-03-11T11:39:48Z","closed_at":"2016-03-11T11:39:48Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\nI first want to declare that I have been introduced to  the world of elasticsearch just a week back, so there could be some obvious points I might be missing while addressing my problems.\n\nHowever, there is one particular problem, I just can't seem to find a solution to, after exhaustively trying to find and answer, so I would like some help here.\n\nI have created a dummy index to explain my problem.\n\nThe mapping is : \n\n```\n{\"mappings\": {\n\"person\" : {\n  \"_source\": {\n    \"enabled\": false\n  }, \n  \"properties\": {\n    \"name\" :  {\n      \"type\" : \"string\"\n    },\n    \"age\" :{\n      \"type\"  :\"long\"\n    },\n    \"city\" : {\n      \"type\" : \"string\"\n    },\n    \"attributes\" : {\n      \"type\": \"nested\",\n      \"include_in_all\": true,\n      \"properties\": {\n        \"attributeName\": {\n          \"type\" : \"string\"\n        },\n        \"id\"  :{\n          \"type\" : \"string\",\n          \"store\" :  true\n        },\n        \"rating\" : {\n          \"type\" : \"long\"\n        }\n      }\n    }\n  }\n}}}\n```\n\n'attributes' is nested, and we are storing the 'attributes.id'\n\nI populated this with following entries:\n\n```\n{\"name\" : \"abc1\",\n\"age\" : 21,\n\"city\" : \"Delhi\",\n\"attributes\" : [\n  {\n    \"id\" : 1,\n    \"rating\"  : 5,\n    \"attributeName\"  : \"at1\"\n  },\n  {\"id\" : 2,\n    \"rating\" : 7,\n    \"attributeName\"  : \"at2\"\n  }\n]}\n\n\n {\"name\" : \"abc2\",\n \"age\" : 24,\n \"city\" : \"Mumbai\",\n \"attributes\" : [\n  {\n    \"id\" : 4,\n    \"rating\"  : 4,\n    \"attributeName\"  : \"at4\"\n  },\n  {\"id\" : 3,\n    \"rating\" : 8,\n    \"attributeName\"  : \"at3\"\n  }\n]}\n\n\n\n {\"name\" : \"abc3\",\n \"age\" : 26,\n \"city\" : \"Delhi\",\n \"attributes\" : [\n  {\n    \"id\" : 5,\n    \"rating\"  : 9,\n    \"attributeName\"  : \"at5\"\n  },\n  {\"id\" : 6,\n    \"rating\" : 6,\n    \"attributeName\"  : \"at6\"\n  }\n]}\n```\n\nNow my problem required me to make a query that applies some filter on city, and some filter on attributes.rating, and gives me back just the attribute ids. There doesn't seem to be an exact solution for this, but I have been able to get it working by using inner_hits and adding id to the inner_hits' fields. Like this:\n\n```\n{\"query\" :{\n          \"bool\": {\n            \"must\": [\n               {\n                \"match\" : {\n                  \"city\" : \"Delhi\"\n                }\n              },\n              {\n                \"nested\": {\n                  \"path\": \"attributes\",\n                  \"query\": {\n                    \"bool\": {\n                      \"must\": [\n                       {\n                          \"range\": {\n                            \"attributes.rating\": {\n                              \"gt\": 5\n                            }\n                          }\n                        }\n                      ]\n                    }\n                  },\n                  \"inner_hits\" : {\n                      \"fields\"  : [\"attributes.id\"]\n                  }\n                }\n              }\n            ]\n          }\n        }}\n```\n\nThis gives me the following response:\n\n```\n{\"took\": 9,\n\"timed_out\": false,\n\"_shards\": {\n\"total\": 5,\n\"successful\": 5,\n\"failed\": 0\n},\n\"hits\": {\n\"total\": 2,\n\"max_score\": 1.724915,\n\"hits\": [\n  {\n    \"_index\": \"test\",\n    \"_type\": \"person\",\n    \"_id\": \"1\",\n    \"_score\": 1.724915,\n    \"inner_hits\": {\n      \"attributes\": {\n        \"hits\": {\n          \"total\": 1,\n          \"max_score\": 1,\n          \"hits\": [\n            {\n              \"_index\": \"test\",\n              \"_type\": \"person\",\n              \"_id\": \"1\",\n              \"_nested\": {\n                \"field\": \"attributes\",\n                \"offset\": 1\n              },\n              \"_score\": 1,\n              \"fields\": {\n                \"attributes.id\": [\n                  \"2\"\n                ]\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  {\n    \"_index\": \"test\",\n    \"_type\": \"person\",\n    \"_id\": \"3\",\n    \"_score\": 1.724915,\n    \"inner_hits\": {\n      \"attributes\": {\n        \"hits\": {\n          \"total\": 2,\n          \"max_score\": 1,\n          \"hits\": [\n            {\n              \"_index\": \"test\",\n              \"_type\": \"person\",\n              \"_id\": \"3\",\n              \"_nested\": {\n                \"field\": \"attributes\",\n                \"offset\": 1\n              },\n              \"_score\": 1,\n              \"fields\": {\n                \"attributes.id\": [\n                  \"6\"\n                ]\n              }\n            },\n            {\n              \"_index\": \"test\",\n              \"_type\": \"person\",\n              \"_id\": \"3\",\n              \"_nested\": {\n                \"field\": \"attributes\",\n                \"offset\": 0\n              },\n              \"_score\": 1,\n              \"fields\": {\n                \"attributes.id\": [\n                  \"5\"\n                ]\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n]}}\n```\n\nThe second part of my problem requires me to return the attribute id in sorted order.\nSo from above query how can I get attribute.id, sorted by rating in ascending order. This means that i should get Ids in sequence 6, 2, 5. However, since in my response I get the parent, not the nested doc, and since 5 and 6 are in one parent, and 2 in another, does my problem even have a solution?\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}