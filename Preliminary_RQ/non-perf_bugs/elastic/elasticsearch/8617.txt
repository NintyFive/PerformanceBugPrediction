{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8617","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8617/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8617/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8617/events","html_url":"https://github.com/elastic/elasticsearch/issues/8617","id":49828780,"node_id":"MDU6SXNzdWU0OTgyODc4MA==","number":8617,"title":" Memory leak related issue with Threadlocals in elasticsearch","user":{"login":"prachicsa","id":9909499,"node_id":"MDQ6VXNlcjk5MDk0OTk=","avatar_url":"https://avatars1.githubusercontent.com/u/9909499?v=4","gravatar_id":"","url":"https://api.github.com/users/prachicsa","html_url":"https://github.com/prachicsa","followers_url":"https://api.github.com/users/prachicsa/followers","following_url":"https://api.github.com/users/prachicsa/following{/other_user}","gists_url":"https://api.github.com/users/prachicsa/gists{/gist_id}","starred_url":"https://api.github.com/users/prachicsa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prachicsa/subscriptions","organizations_url":"https://api.github.com/users/prachicsa/orgs","repos_url":"https://api.github.com/users/prachicsa/repos","events_url":"https://api.github.com/users/prachicsa/events{/privacy}","received_events_url":"https://api.github.com/users/prachicsa/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-11-23T15:39:51Z","updated_at":"2015-08-29T11:36:59Z","closed_at":"2015-08-29T11:36:58Z","author_association":"NONE","active_lock_reason":null,"body":" have a web service, where every time a button is pressed from UI, it connects to elastic search and fires a query. This is the code which is executed every time. The issue is that after a while, intermittently, the UI hangs.\n\nprivate static final String CONFIG_CLUSTER_NAME = \"cluster.name\";\n\nprivate static final String CLUSTER_NAME = \"sample_es\";\nprivate static final String[] transportAddress = {\n    //Machine details\n};\n\nprivate static final int transportPort = 9300;\n\n```\n    public static Client initClient(){\n    settings = ImmutableSettings.settingsBuilder().put(CONFIG_CLUSTER_NAME, CLUSTER_NAME).build();\n\n    Client client = new TransportClient(settings);\n    for (int i=0 ; i < transportAddress.length-1 ; i++){\n        ((TransportClient)client).addTransportAddress(new InetSocketTransportAddress(transportAddress[i], transportPort));\n    }\n    logger.info(\"TransportClient Created\"); \n    return client;  \n```\n\n}\n\npublic static int query( String query) throws Exception\n{\n    Client client = null;\n    try{\n\n```\n        client = initClient();\n\n        //Query search code\n\n}catch(Exception e){\n        e.printStackTrace();\n}finally{\n    if(client != null){\n        client.close();\n        logger.info(\"TransportClient Closed\");\n    }\n}\n    return result_count;\n```\n\n}\n\nWhenever we restart the tomcat server, this is the error message we are seeing in logs. How should we fix this?\n\n[org.elasticsearch.common.util.concurrent.jsr166y.ThreadLocalRandom$1](value\n[org.elasticsearch.common.util.concurrent.jsr166y.ThreadLocalRandom$1@5838ce3e]) and a value of type\n[org.elasticsearch.common.util.concurrent.jsr166y.ThreadLocalRandom](value \n[org.elasticsearch.common.util.concurrent.jsr166y.ThreadLocalRandom@796c75b1]) but failed to remove it\nwhen the web application was stopped. This is very likely to create a memory leak.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}