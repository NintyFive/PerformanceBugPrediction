[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/442454687","html_url":"https://github.com/elastic/elasticsearch/issues/36001#issuecomment-442454687","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36001","id":442454687,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MjQ1NDY4Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-11-28T13:55:23Z","updated_at":"2018-11-28T13:55:23Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/443998330","html_url":"https://github.com/elastic/elasticsearch/issues/36001#issuecomment-443998330","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36001","id":443998330,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0Mzk5ODMzMA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-12-04T07:25:38Z","updated_at":"2018-12-04T07:25:38Z","author_association":"MEMBER","body":"This is failing again on 6.x in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+multijob-unix-compatibility/os=centos/96/consoleFull with (see stack trace for more details):\r\n\r\n```\r\nCurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED]\r\n```\r\n\r\nReproduction line:\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :client:rest-high-level:integTestRunner \\\r\n  -Dtests.seed=EAA6597678B5DE87 \\\r\n  -Dtests.class=org.elasticsearch.client.TasksIT \\\r\n  -Dtests.method=\"testGetInvalidTask\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=sr-Latn-ME \\\r\n  -Dtests.timezone=America/Porto_Velho \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\n<details>\r\n    <summary>Stack trace</summary>\r\n    <pre>\r\n07:44:59    > Throwable #1: ElasticsearchStatusException[Elasticsearch exception [type=no_shard_available_action_exception, reason=No shard available for [get [.tasks][task][doesNotExistNodeName:123]: routing [null]]]]; nested: ElasticsearchException[Elasticsearch exception [type=illegal_index_shard_state_exception, reason=CurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED]]];\r\n07:44:59    > \tat __randomizedtesting.SeedInfo.seed([EAA6597678B5DE87:5476CCFF2E32D344]:0)\r\n07:44:59    > \tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:177)\r\n07:44:59    > \tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:2042)\r\n07:44:59    > \tat org.elasticsearch.client.RestHighLevelClient.parseResponseException(RestHighLevelClient.java:2018)\r\n07:44:59    > \tat org.elasticsearch.client.RestHighLevelClient$2.onFailure(RestHighLevelClient.java:1993)\r\n07:44:59    > \tat org.elasticsearch.client.RestClient$FailureTrackingResponseListener.onDefinitiveFailure(RestClient.java:850)\r\n07:44:59    > \tat org.elasticsearch.client.RestClient$1.retryIfPossible(RestClient.java:588)\r\n07:44:59    > \tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:550)\r\n07:44:59    > \tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:531)\r\n07:44:59    > \tat org.apache.http.concurrent.BasicFuture.completed(BasicFuture.java:119)\r\n07:44:59    > \tat org.apache.http.impl.nio.client.DefaultClientExchangeHandlerImpl.responseCompleted(DefaultClientExchangeHandlerImpl.java:177)\r\n07:44:59    > \tat org.apache.http.nio.protocol.HttpAsyncRequestExecutor.processResponse(HttpAsyncRequestExecutor.java:436)\r\n07:44:59    > \tat org.apache.http.nio.protocol.HttpAsyncRequestExecutor.inputReady(HttpAsyncRequestExecutor.java:326)\r\n07:44:59    > \tat org.apache.http.impl.nio.DefaultNHttpClientConnection.consumeInput(DefaultNHttpClientConnection.java:265)\r\n07:44:59    > \tat org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:81)\r\n07:44:59    > \tat org.apache.http.impl.nio.client.InternalIODispatch.onInputReady(InternalIODispatch.java:39)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.AbstractIODispatch.inputReady(AbstractIODispatch.java:114)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.BaseIOReactor.readable(BaseIOReactor.java:162)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvent(AbstractIOReactor.java:337)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.AbstractIOReactor.processEvents(AbstractIOReactor.java:315)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.AbstractIOReactor.execute(AbstractIOReactor.java:276)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.BaseIOReactor.execute(BaseIOReactor.java:104)\r\n07:44:59    > \tat org.apache.http.impl.nio.reactor.AbstractMultiworkerIOReactor$Worker.run(AbstractMultiworkerIOReactor.java:588)\r\n07:44:59    > \tat java.lang.Thread.run(Thread.java:748)\r\n07:44:59    > \tSuppressed: org.elasticsearch.client.ResponseException: method [GET], host [http://[::1]:39814], URI [/_tasks/doesNotExistNodeName:123?wait_for_completion=false], status line [HTTP/1.1 503 Service Unavailable]\r\n07:44:59    > {\"error\":{\"root_cause\":[{\"type\":\"illegal_index_shard_state_exception\",\"reason\":\"CurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED]\",\"index_uuid\":\"gWoZj4bWR12DZMhpSR2vWw\",\"shard\":\"0\",\"index\":\".tasks\"}],\"type\":\"no_shard_available_action_exception\",\"reason\":\"No shard available for [get [.tasks][task][doesNotExistNodeName:123]: routing [null]]\",\"caused_by\":{\"type\":\"illegal_index_shard_state_exception\",\"reason\":\"CurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED]\",\"index_uuid\":\"gWoZj4bWR12DZMhpSR2vWw\",\"shard\":\"0\",\"index\":\".tasks\"}},\"status\":503}\r\n07:44:59    > \t\tat org.elasticsearch.client.RestClient$1.completed(RestClient.java:546)\r\n07:44:59    > \t\t... 16 more\r\n07:44:59    > Caused by: [.tasks/gWoZj4bWR12DZMhpSR2vWw][[.tasks][0]] ElasticsearchException[Elasticsearch exception [type=illegal_index_shard_state_exception, reason=CurrentState[RECOVERING] operations only allowed when shard state is one of [POST_RECOVERY, STARTED]]]\r\n07:44:59    > \tat org.elasticsearch.ElasticsearchException.innerFromXContent(ElasticsearchException.java:509)\r\n07:44:59    > \tat org.elasticsearch.ElasticsearchException.fromXContent(ElasticsearchException.java:420)\r\n07:44:59    > \tat org.elasticsearch.ElasticsearchException.innerFromXContent(ElasticsearchException.java:450)\r\n07:44:59    > \tat org.elasticsearch.ElasticsearchException.failureFromXContent(ElasticsearchException.java:616)\r\n07:44:59    > \tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:169)\r\n07:44:59    > \t... 22 more\r\n</pre>\r\n</details>\r\n\r\nThis does not reproduce locally. First of all, I think the reason is that we need to remove the restriction on `Dtests.method` and run all tests in this class. In the build output we can see:\r\n\r\n```\r\n07:44:59   1> [2018-12-04T02:44:58,342][INFO ][o.e.c.TasksIT            ] [testGetValidTask] before test\r\n07:44:59   1> [2018-12-04T02:44:58,344][INFO ][o.e.c.TasksIT            ] [testGetValidTask] initializing REST clients against [http://[::1]:39814]\r\n07:44:59   1> [2018-12-04T02:44:58,674][INFO ][o.e.c.TasksIT            ] [testGetValidTask] There are still tasks running after this test that might break subsequent tests [indices:admin/create, indices:data/write/reindex].\r\n07:44:59   1> [2018-12-04T02:44:58,674][INFO ][o.e.c.TasksIT            ] [testGetValidTask] after test\r\n07:44:59   1> [2018-12-04T02:44:58,677][INFO ][o.e.c.TasksIT            ] [testGetInvalidTask] before test\r\n07:44:59   1> [2018-12-04T02:44:58,805][INFO ][o.e.c.TasksIT            ] [testGetInvalidTask] There are still tasks running after this test that might break subsequent tests [indices:admin/create, indices:data/write/index, indices:data/write/reindex].\r\n07:44:59   1> [2018-12-04T02:44:58,805][INFO ][o.e.c.TasksIT            ] [testGetInvalidTask] after test\r\n```\r\n\r\nAs there are warnings about running tasks in `testGetValidTask`, I wonder whether a `waitForPendingTasks()` invocation is missing at the end of `#testGetValidTask()`?\r\n\r\n@markharwood as you have recently added these tests, can you please have a closer look?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461268980","html_url":"https://github.com/elastic/elasticsearch/issues/36001#issuecomment-461268980","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36001","id":461268980,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTI2ODk4MA==","user":{"login":"andyb-elastic","id":29205940,"node_id":"MDQ6VXNlcjI5MjA1OTQw","avatar_url":"https://avatars2.githubusercontent.com/u/29205940?v=4","gravatar_id":"","url":"https://api.github.com/users/andyb-elastic","html_url":"https://github.com/andyb-elastic","followers_url":"https://api.github.com/users/andyb-elastic/followers","following_url":"https://api.github.com/users/andyb-elastic/following{/other_user}","gists_url":"https://api.github.com/users/andyb-elastic/gists{/gist_id}","starred_url":"https://api.github.com/users/andyb-elastic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyb-elastic/subscriptions","organizations_url":"https://api.github.com/users/andyb-elastic/orgs","repos_url":"https://api.github.com/users/andyb-elastic/repos","events_url":"https://api.github.com/users/andyb-elastic/events{/privacy}","received_events_url":"https://api.github.com/users/andyb-elastic/received_events","type":"User","site_admin":false},"created_at":"2019-02-07T02:42:24Z","updated_at":"2019-02-07T02:42:24Z","author_association":"CONTRIBUTOR","body":"Ran this test class in a loop a couple hundred times and wasn't able to reproduce. It looks like there was a [about a month-long period](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-1y,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:'class:org.elasticsearch.client.TasksIT%20AND%20stacktrace:%22no_shard_available_action_exception%22'),sort:!(time,desc))) where a test in this class failed with that stacktrace since it was [added in May 2018](https://github.com/elastic/elasticsearch/pull/30906). There hasn't been a failure of this kind in this class since 17 December 2018","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/461887363","html_url":"https://github.com/elastic/elasticsearch/issues/36001#issuecomment-461887363","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36001","id":461887363,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MTg4NzM2Mw==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2019-02-08T17:48:34Z","updated_at":"2019-02-08T17:48:34Z","author_association":"CONTRIBUTOR","body":"Ran this test in a loop on 6.7 and could not reproduce the error or the warnings about still-running tasks.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/523928492","html_url":"https://github.com/elastic/elasticsearch/issues/36001#issuecomment-523928492","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36001","id":523928492,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMzkyODQ5Mg==","user":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"created_at":"2019-08-22T14:23:23Z","updated_at":"2019-08-22T14:23:23Z","author_association":"CONTRIBUTOR","body":"I went thru a bunch of old build emails and cannot find any failures in recent history so I am closing this. Feel free to open if these start occurring again.","performed_via_github_app":null}]