{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43517","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43517/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43517/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43517/events","html_url":"https://github.com/elastic/elasticsearch/issues/43517","id":459572129,"node_id":"MDU6SXNzdWU0NTk1NzIxMjk=","number":43517,"title":"Nested search failing with _source disabled","user":{"login":"sronsiek","id":1255835,"node_id":"MDQ6VXNlcjEyNTU4MzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1255835?v=4","gravatar_id":"","url":"https://api.github.com/users/sronsiek","html_url":"https://github.com/sronsiek","followers_url":"https://api.github.com/users/sronsiek/followers","following_url":"https://api.github.com/users/sronsiek/following{/other_user}","gists_url":"https://api.github.com/users/sronsiek/gists{/gist_id}","starred_url":"https://api.github.com/users/sronsiek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sronsiek/subscriptions","organizations_url":"https://api.github.com/users/sronsiek/orgs","repos_url":"https://api.github.com/users/sronsiek/repos","events_url":"https://api.github.com/users/sronsiek/events{/privacy}","received_events_url":"https://api.github.com/users/sronsiek/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-06-23T12:47:04Z","updated_at":"2019-08-01T00:53:38Z","closed_at":"2019-08-01T00:53:38Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\nVersion: 7.0.1, Build: default/docker/e4efcb5/2019-04-29T12:56:03.145736Z, JVM: 12.0.1\r\n\r\n**Plugins installed**: []\r\n\r\nbin/elasticsearch-plugin install --batch ingest-attachment\r\n\r\n**JVM version** (`java -version`):\r\n\r\nopenjdk version \"12.0.1\" 2019-04-16\r\nOpenJDK Runtime Environment (build 12.0.1+12)\r\nOpenJDK 64-Bit Server VM (build 12.0.1+12, mixed mode, sharing)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nElastic is running in the official elastic docker container\r\n\r\nLinux elastic 4.4.76-1-default #1 SMP Fri Jul 14 08:48:13 UTC 2017 (9a2885c) x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI have been upgrading an existing application from Elastic v2.1.2 to v7.0.1.\r\n\r\nThe mapping for document types has _source disabled.\r\n\r\nOne feature we use is a nested field 'history'. Each record contains an history array, each element of which contains several properties (author, created_at, state).\r\n\r\nSearch on these fields worked fine in v2.1.2, but used a, now deprecated, 'include_in_parent' flag. In v7.0.1, queries containing are seen to fail with null-pointer exceptions. A lot of bug-chasing later I found the feature can be made to work, if I add ANY one of the history properties with _source enabled in the mapping. After this all searches started working - even when they were on history fields other than the one included in _source. In the queries, _source is set to false, both at top level and within inner_hits, since all we need is the parent doc _id.  \r\n  \r\n**Steps to reproduce**:\r\n\r\n1. Create template with mapping & settings (without the workaround):\r\n\r\n```\r\ncurl -H 'Content-Type: application/json' -X PUT http://localhost:9200/_template/test_doc -d '\r\n{\r\n  \"index_patterns\": \"test_doc*\",\r\n  \"mappings\": {\r\n    \"_source\": {\r\n      \"enabled\": false\r\n    },\r\n    \"properties\": {\r\n      \"doc_body\": {\r\n        \"fields\": {\r\n          \"keyword\": {\r\n            \"ignore_above\": 256,\r\n            \"type\": \"keyword\"\r\n          }\r\n        },\r\n        \"type\": \"text\"\r\n      },\r\n      \"history\": {\r\n        \"properties\": {\r\n          \"author\": {\r\n            \"fields\": {\r\n              \"keyword\": {\r\n                \"ignore_above\": 256,\r\n                \"type\": \"keyword\"\r\n              }\r\n            },\r\n            \"type\": \"text\"\r\n          },\r\n          \"created_at\": {\r\n            \"type\": \"date\"\r\n          },\r\n          \"state\": {\r\n            \"index\": true,\r\n            \"type\": \"keyword\"\r\n          }\r\n        },\r\n        \"type\": \"nested\"\r\n      },\r\n      \"id\": {\r\n        \"index\": true,\r\n        \"type\": \"long\"\r\n      }\r\n    }\r\n  },\r\n  \"order\": 0,\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"default\": {\r\n          \"filter\": [\r\n            \"lowercase\"\r\n          ],\r\n          \"tokenizer\": \"whitespace\"\r\n        }\r\n      }\r\n    },\r\n    \"index\": {\r\n      \"max_inner_result_window\": 1000\r\n    },\r\n    \"number_of_replicas\": 0,\r\n    \"number_of_shards\": 1,\r\n    \"refresh_interval\": \"1s\"\r\n  }\r\n}'\r\n```\r\n\r\n2. Insert first record (also creating the index):\r\n\r\n```\r\ncurl -H 'Content-Type: application/json' -X POST http://localhost:9200/test_doc/_doc/1 -d '\r\n{\r\n    \"id\": 1000,\r\n    \"doc_body\": \"This is some body text\",\r\n    \"history\": [\r\n        {\r\n            \"author\": \"Freddy\",\r\n            \"created_at\": \"2019-06-23T13:10\",\r\n            \"state\": \"created\"\r\n        },\r\n        {\r\n            \"author\": \"Mike\",\r\n            \"created_at\": \"2019-06-23T13:12\",\r\n            \"state\": \"created\"\r\n        }\r\n    ]\r\n}'\r\n```\r\n\r\n3. Perform a search on nested data:\r\n\r\n```\r\ncurl -H 'Content-Type: application/json' -X POST http://localhost:9200/test_doc/_search -d '\r\n{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"filter\": {\r\n                \"nested\": {\r\n                    \"path\": \"history\",\r\n                    \"inner_hits\": {\r\n                        \"size\": 50,\r\n                        \"name\": \"history\"\r\n                    },\r\n                    \"query\": {\r\n                        \"range\": {\r\n                            \"history.created_at\": {\r\n                                \"gte\": \"2012-01-01\"\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"size\": \"100\",\r\n    \"sort\": [\r\n        {\r\n            \"id\": \"desc\"\r\n        }\r\n    ]\r\n}'\r\n```\r\nresults in:\r\n\r\n`{\"error\":{\"root_cause\":[{\"type\":\"null_pointer_exception\",\"reason\":null}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"test_doc\",\"node\":\"MZot1_RnSvqSm6g7wCuisw\",\"reason\":{\"type\":\"null_pointer_exception\",\"reason\":null}}],\"caused_by\":{\"type\":\"null_pointer_exception\",\"reason\":null,\"caused_by\":{\"type\":\"null_pointer_exception\",\"reason\":null}}},\"status\":500}`\r\n\r\nplus a lengthy exception stack in the elastic log (attached).\r\n\r\nNow, changing the _source setting in the template:\r\n\r\n```\r\n  \"mappings\": {\r\n    \"_source\": {\r\n      \"enabled\": false\r\n    },\r\n```\r\nwith:\r\n```\r\n  \"mappings\": {\r\n    \"_source\": {\r\n      \"includes\": [\r\n        \"history.created_at\"\r\n      ]\r\n    },\r\n```\r\nand repeating the steps will work as expected.\r\n\r\nPossibly also relevant, elasticsearch.yml contains:\r\n\r\n`discovery.type: single-node `\r\n\r\nFor Info: Aggregated searches do not appear to be affected by this issue - seen to work in both cases.\r\n\r\n[elastic_exception.log](https://github.com/elastic/elasticsearch/files/3317863/elastic_exception.log)\r\n\r\n","closed_by":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"performed_via_github_app":null}