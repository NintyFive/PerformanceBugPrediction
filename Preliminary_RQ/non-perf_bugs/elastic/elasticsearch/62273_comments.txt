[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/692202942","html_url":"https://github.com/elastic/elasticsearch/issues/62273#issuecomment-692202942","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62273","id":692202942,"node_id":"MDEyOklzc3VlQ29tbWVudDY5MjIwMjk0Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-09-14T17:31:34Z","updated_at":"2020-09-14T17:31:34Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Ranking)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/706095962","html_url":"https://github.com/elastic/elasticsearch/issues/62273#issuecomment-706095962","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62273","id":706095962,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNjA5NTk2Mg==","user":{"login":"diegomansua","id":878407,"node_id":"MDQ6VXNlcjg3ODQwNw==","avatar_url":"https://avatars0.githubusercontent.com/u/878407?v=4","gravatar_id":"","url":"https://api.github.com/users/diegomansua","html_url":"https://github.com/diegomansua","followers_url":"https://api.github.com/users/diegomansua/followers","following_url":"https://api.github.com/users/diegomansua/following{/other_user}","gists_url":"https://api.github.com/users/diegomansua/gists{/gist_id}","starred_url":"https://api.github.com/users/diegomansua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diegomansua/subscriptions","organizations_url":"https://api.github.com/users/diegomansua/orgs","repos_url":"https://api.github.com/users/diegomansua/repos","events_url":"https://api.github.com/users/diegomansua/events{/privacy}","received_events_url":"https://api.github.com/users/diegomansua/received_events","type":"User","site_admin":false},"created_at":"2020-10-09T10:13:30Z","updated_at":"2020-10-09T10:13:30Z","author_association":"NONE","body":"I was considering using this functionality when I saw it was getting deprecated.\r\n\r\nWe are building sparse vectors for named entities in articles where the value for a given named entity is its weight (some calculated relevance for that entity in the article), e.g.\r\n\r\n```\r\n{\r\n  \"Donald_Trump\": 0.9,\r\n  \"Mike_pence\": 0.4,\r\n  \"White_House\": 0.3,\r\n  ...\r\n}\r\n```\r\n\r\nThen given a document I was planning to use the `cosineSimilaritySparse` function to find the closest articles (kind of an easy way to find \"nearest neighbours\") in the index to that one (there would be other features, including dense vectors, but this was going to be one of the main ones).\r\n\r\nI don't think this can be achieved with `rank_features` but please correct me if I'm wrong.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/708320446","html_url":"https://github.com/elastic/elasticsearch/issues/62273#issuecomment-708320446","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62273","id":708320446,"node_id":"MDEyOklzc3VlQ29tbWVudDcwODMyMDQ0Ng==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2020-10-14T10:43:42Z","updated_at":"2020-10-14T10:43:42Z","author_association":"CONTRIBUTOR","body":"@diegomansua Thank you for letting us know about your use case. I actually think `rank_features` can be useful in your case.\r\nYou can model your entities as `rank_features`: \r\n```js\r\nPUT my_index\r\n{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"topics\": {\r\n        \"type\": \"rank_features\"\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT my_index/_doc/1?refresh\r\n{\r\n  \"topics\": {\r\n    \"Donald_Trump\": 0.9,\r\n    \"Mike_pence\": 0.4,\r\n    \"White_House\": 0.3\r\n  }\r\n}\r\n\r\nPUT my_index/_doc/2?refresh\r\n{\r\n  \"topics\": {\r\n    \"Donald_Trump\": 0.1,\r\n    \"Mike_pence\": 0.9,\r\n    \"White_House\": 0.2\r\n  }\r\n}\r\n```\r\n\r\nAnd use a bool query with a number of `rank_feature` query for each topic  as a proxy to find nearest neighbours. Documents that have the highest entity weights on these topics, will also be scored higher.  An additional bonus, this query should be very fast.\r\n\r\n```js\r\nGET my_index/_search\r\n{\r\n  \"query\": {\r\n    \"bool\" : {\r\n      \"should\" : [\r\n          {\r\n            \"rank_feature\" : {\r\n              \"field\": \"topics.White_House\"\r\n            }\r\n          },\r\n          {\r\n            \"rank_feature\" : {\r\n              \"field\": \"topics.Mike_pence\"\r\n            }\r\n          }\r\n        ]\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/708441661","html_url":"https://github.com/elastic/elasticsearch/issues/62273#issuecomment-708441661","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62273","id":708441661,"node_id":"MDEyOklzc3VlQ29tbWVudDcwODQ0MTY2MQ==","user":{"login":"diegomansua","id":878407,"node_id":"MDQ6VXNlcjg3ODQwNw==","avatar_url":"https://avatars0.githubusercontent.com/u/878407?v=4","gravatar_id":"","url":"https://api.github.com/users/diegomansua","html_url":"https://github.com/diegomansua","followers_url":"https://api.github.com/users/diegomansua/followers","following_url":"https://api.github.com/users/diegomansua/following{/other_user}","gists_url":"https://api.github.com/users/diegomansua/gists{/gist_id}","starred_url":"https://api.github.com/users/diegomansua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diegomansua/subscriptions","organizations_url":"https://api.github.com/users/diegomansua/orgs","repos_url":"https://api.github.com/users/diegomansua/repos","events_url":"https://api.github.com/users/diegomansua/events{/privacy}","received_events_url":"https://api.github.com/users/diegomansua/received_events","type":"User","site_admin":false},"created_at":"2020-10-14T14:29:48Z","updated_at":"2020-10-14T14:29:48Z","author_association":"NONE","body":"Thank you @mayya-sharipova I will give it a go.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/709931755","html_url":"https://github.com/elastic/elasticsearch/issues/62273#issuecomment-709931755","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62273","id":709931755,"node_id":"MDEyOklzc3VlQ29tbWVudDcwOTkzMTc1NQ==","user":{"login":"diegomansua","id":878407,"node_id":"MDQ6VXNlcjg3ODQwNw==","avatar_url":"https://avatars0.githubusercontent.com/u/878407?v=4","gravatar_id":"","url":"https://api.github.com/users/diegomansua","html_url":"https://github.com/diegomansua","followers_url":"https://api.github.com/users/diegomansua/followers","following_url":"https://api.github.com/users/diegomansua/following{/other_user}","gists_url":"https://api.github.com/users/diegomansua/gists{/gist_id}","starred_url":"https://api.github.com/users/diegomansua/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/diegomansua/subscriptions","organizations_url":"https://api.github.com/users/diegomansua/orgs","repos_url":"https://api.github.com/users/diegomansua/repos","events_url":"https://api.github.com/users/diegomansua/events{/privacy}","received_events_url":"https://api.github.com/users/diegomansua/received_events","type":"User","site_admin":false},"created_at":"2020-10-16T09:19:36Z","updated_at":"2020-10-16T15:45:03Z","author_association":"NONE","body":"@mayya-sharipova I was running some tests yesterday. And whereas it's true that `rank_features` can help, the problem I have is that I don't think it can replicate a characteristic that the `sparse_vector` datatype plus `cosineSimilaritySparse` function have: the cosine similarity of a document with itself is 1.\r\n\r\nThis is important to us because as I mentioned we were planning to use this in combination with other features. More specifically after experimentation we have found that to get the best results when measuring the similarity of two documents in our case is to get the weighted average of:\r\n\r\n- Cosine similarity of BERT-based sentence (dense) vectors (weight 0.8).\r\n- Cosine similarity of named entity salience (sparse) vectors (weight 0.2).\r\n\r\nAs I say this works well for us (and similarity of a document with itself is 1) and it's what we're doing outside ElasticSearch with a clustering algorithm to group similar documents together. We were planning to use ES in the exact same way but rather than to group documents together we wanted to be able to find the nearest neighbours of a given document.\r\n\r\nI see that the `cosineSimilaritySparse` function has been removed along the `sparse_vector` datatype so if I want to 100% replicate our current logic inside ES I don't think I have other choice than to store the sparse vectors in a (non-`dynamic`) `object` and then recreate the `cosineSimilaritySparse` function in a Painless script. Ugly, I know!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/719720874","html_url":"https://github.com/elastic/elasticsearch/issues/62273#issuecomment-719720874","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62273","id":719720874,"node_id":"MDEyOklzc3VlQ29tbWVudDcxOTcyMDg3NA==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2020-10-30T18:22:25Z","updated_at":"2020-10-30T18:22:25Z","author_association":"CONTRIBUTOR","body":"We had a discussion within our search team, and have made a decision not to reintroduce sparse vectors.\r\nThe main reason is poor performance of sparse vectors involving scanning across all documents, and there are currently no ways or plans to optimize this. They are not suited for production scale.\r\n\r\nSome other alternatives we are looking into:\r\n- [Adding linear function to rank_features](https://github.com/elastic/elasticsearch/issues/49859)\r\n- [Adding vector similarity functions to rank_features](https://github.com/elastic/elasticsearch/issues/64436)\r\n- [Fully numeric flattened field](https://github.com/elastic/elasticsearch/issues/61550)\r\n\r\nFor this reason I am closing this issue. \r\n\r\n@wmelton @diegomansua Thank you for providing your use cases. Please submit new feature requests if you have other suggestions besides sparse vectors.\r\n\r\n\r\n","performed_via_github_app":null}]