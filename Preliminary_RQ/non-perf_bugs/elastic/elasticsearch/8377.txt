{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8377","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8377/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8377/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8377/events","html_url":"https://github.com/elastic/elasticsearch/issues/8377","id":48050617,"node_id":"MDU6SXNzdWU0ODA1MDYxNw==","number":8377,"title":"1.4.0 failed to compile and run native script score function","user":{"login":"andyxukq","id":3887449,"node_id":"MDQ6VXNlcjM4ODc0NDk=","avatar_url":"https://avatars3.githubusercontent.com/u/3887449?v=4","gravatar_id":"","url":"https://api.github.com/users/andyxukq","html_url":"https://github.com/andyxukq","followers_url":"https://api.github.com/users/andyxukq/followers","following_url":"https://api.github.com/users/andyxukq/following{/other_user}","gists_url":"https://api.github.com/users/andyxukq/gists{/gist_id}","starred_url":"https://api.github.com/users/andyxukq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andyxukq/subscriptions","organizations_url":"https://api.github.com/users/andyxukq/orgs","repos_url":"https://api.github.com/users/andyxukq/repos","events_url":"https://api.github.com/users/andyxukq/events{/privacy}","received_events_url":"https://api.github.com/users/andyxukq/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"assignees":[{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2014-11-07T05:48:12Z","updated_at":"2014-11-10T15:59:57Z","closed_at":"2014-11-10T01:23:03Z","author_association":"NONE","active_lock_reason":null,"body":"Hi y'all, \n\nAfter upgrading to 1.4.0, I failed to compile my native(Java) score functions which worked well with 1.3.4.\nThe first issue I ran into is that my function extended `AbstractDoubleSearchScript` and call `score()` to get document score from Lucene, apparently it won't work now with 1.4.0.\n\nI wonder if any of you could tell me which method should be called to get the original score of one document. An example of my function looks like:\n\n```\npublic class BasicScorer extends AbstractDoubleSearchScript {\n\n  public static final String NAME = \"basic-scorer\";\n\n  public static class Factory implements NativeScriptFactory {\n    @Override\n    public ExecutableScript newScript(@Nullable Map<String, Object> params) {\n      return new BasicScorer();\n  }\n\n  private BasicScorer() {\n  }\n\n  @Override\n  public double runAsDouble() {\n      return score() * ((ScriptDocValues.Doubles) doc().get(\"rank\")).getValue();\n  }\n}\n```\n\nThe second issue is when I just remove the 'score()' method and query ElasticSearch with following parameter:\n\n```\n...\n     \"script_score\": {\n        \"script\": \"basic-scorer\",\n        \"lang\": \"native\"\n      }\n...\n```\n\nfollowing error was logged:\n\n```\n    at org.elasticsearch.search.query.QueryParseElement.parse(QueryParseElement.java:33)\n    at org.elasticsearch.search.SearchService.parseSource(SearchService.java:665)\n    ... 9 more\nCaused by: java.lang.UnsupportedOperationException\n    at org.elasticsearch.script.AbstractSearchScript.setScorer(AbstractSearchScript.java:104)\n    at org.elasticsearch.common.lucene.search.function.ScriptScoreFunction.<init>(ScriptScoreFunction.java:86)\n\n```\n\nI noticed there were some groovy script function changes, but I don't think that should affect the interface of native score function.\n\nRegards,\nAndy\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}