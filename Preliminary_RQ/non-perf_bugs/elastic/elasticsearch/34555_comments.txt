[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430632503","html_url":"https://github.com/elastic/elasticsearch/issues/34555#issuecomment-430632503","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34555","id":430632503,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDYzMjUwMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-10-17T13:40:12Z","updated_at":"2018-10-17T13:40:12Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430943421","html_url":"https://github.com/elastic/elasticsearch/issues/34555#issuecomment-430943421","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34555","id":430943421,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDk0MzQyMQ==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2018-10-18T09:38:20Z","updated_at":"2018-10-18T09:38:20Z","author_association":"CONTRIBUTOR","body":"For reference, the forum discussion is here: https://discuss.elastic.co/t/indexoutofboundsexception-after-update-from-6-2-to-6-4/152670\r\n\r\nThis is the relevant bit of the stack trace:\r\n```\r\nCaused by: java.lang.IndexOutOfBoundsException\r\n    at java.nio.Buffer.checkIndex(Buffer.java:540) ~[?:1.8.0_171]\r\n    at java.nio.DirectByteBuffer.get(DirectByteBuffer.java:253) ~[?:1.8.0_171]\r\n    at org.apache.lucene.store.ByteBufferGuard.getByte(ByteBufferGuard.java:118) ~[lucene-core-7.4.0.jar:7.4.0 9060ac689c270b02143f375de0348b7f626adebc - jpountz - 2018-06-18 16:51:45]\r\n    at org.apache.lucene.store.ByteBufferIndexInput$SingleBufferImpl.readByte(ByteBufferIndexInput.java:385) ~[lucene-core-7.4.0.jar:7.4.0 9060ac689c270b02143f375de0348b7f626adebc - jpountz - 2018-06-18 16:51:45]\r\n    at org.apache.lucene.codecs.lucene70.Lucene70NormsProducer$7.longValue(Lucene70NormsProducer.java:263) ~[lucene-core-7.4.0.jar:7.4.0 9060ac689c270b02143f375de0348b7f626adebc - jpountz - 2018-06-18 16:51:45]\r\n    at org.apache.lucene.search.similarities.BM25Similarity$BM25DocScorer.score(BM25Similarity.java:257) ~[lucene-core-7.4.0.jar:7.4.0 9060ac689c270b02143f375de0348b7f626adebc - jpountz - 2018-06-18 16:51:45]\r\n```\r\n... which is a bit scary, because it looks like a bug decoding norms in lucene.\r\n\r\nDoes this happen even after a reindex?  And if so, are you able to share the mappings and documents for this index so that we can reproduce this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/430979649","html_url":"https://github.com/elastic/elasticsearch/issues/34555#issuecomment-430979649","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34555","id":430979649,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMDk3OTY0OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-10-18T11:53:28Z","updated_at":"2018-10-18T11:53:28Z","author_association":"MEMBER","body":"The bug is in Elasticsearch, the `nested` aggregator does some buffering of documents and this confuses the scorer that is used by the `top_hits` aggregator after it.\r\nCan you try to change the sort of your `top_hits` aggregation to:\r\n````\r\n\"top_hits\": {\r\n   \"sort\": \"_doc\",\r\n   \"size\": 1\r\n}\r\n`````\r\nThis should fix the issue you're seeing. By default the `top_hits` aggregator uses the score of the query to sort the documents. However in a nested context the score is always the score of the root document.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/431026874","html_url":"https://github.com/elastic/elasticsearch/issues/34555#issuecomment-431026874","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34555","id":431026874,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMTAyNjg3NA==","user":{"login":"atanasovdragan","id":17385942,"node_id":"MDQ6VXNlcjE3Mzg1OTQy","avatar_url":"https://avatars2.githubusercontent.com/u/17385942?v=4","gravatar_id":"","url":"https://api.github.com/users/atanasovdragan","html_url":"https://github.com/atanasovdragan","followers_url":"https://api.github.com/users/atanasovdragan/followers","following_url":"https://api.github.com/users/atanasovdragan/following{/other_user}","gists_url":"https://api.github.com/users/atanasovdragan/gists{/gist_id}","starred_url":"https://api.github.com/users/atanasovdragan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/atanasovdragan/subscriptions","organizations_url":"https://api.github.com/users/atanasovdragan/orgs","repos_url":"https://api.github.com/users/atanasovdragan/repos","events_url":"https://api.github.com/users/atanasovdragan/events{/privacy}","received_events_url":"https://api.github.com/users/atanasovdragan/received_events","type":"User","site_admin":false},"created_at":"2018-10-18T14:18:18Z","updated_at":"2018-10-18T14:18:18Z","author_association":"NONE","body":"@jimczi Thanks, it works! However it is still a bug and I guess this is only a workaround. I wonder why this was not an issue on 6.2 version previously?\r\n\r\nThank you very much! It was a real headache. :smiley: ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/431082068","html_url":"https://github.com/elastic/elasticsearch/issues/34555#issuecomment-431082068","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34555","id":431082068,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMTA4MjA2OA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-10-18T16:48:56Z","updated_at":"2018-10-18T16:48:56Z","author_association":"MEMBER","body":"> However it is still a bug and I guess this is only a workaround.\r\n\r\nYes this is why I left the issue open. We need to fix the `nested` aggregator when  scores is required in a sub-aggregation.","performed_via_github_app":null}]