{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10336","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10336/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10336/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10336/events","html_url":"https://github.com/elastic/elasticsearch/issues/10336","id":65395450,"node_id":"MDU6SXNzdWU2NTM5NTQ1MA==","number":10336,"title":"Use of javascript in mapping `transform` fails","user":{"login":"lukas-vlcek","id":205174,"node_id":"MDQ6VXNlcjIwNTE3NA==","avatar_url":"https://avatars2.githubusercontent.com/u/205174?v=4","gravatar_id":"","url":"https://api.github.com/users/lukas-vlcek","html_url":"https://github.com/lukas-vlcek","followers_url":"https://api.github.com/users/lukas-vlcek/followers","following_url":"https://api.github.com/users/lukas-vlcek/following{/other_user}","gists_url":"https://api.github.com/users/lukas-vlcek/gists{/gist_id}","starred_url":"https://api.github.com/users/lukas-vlcek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukas-vlcek/subscriptions","organizations_url":"https://api.github.com/users/lukas-vlcek/orgs","repos_url":"https://api.github.com/users/lukas-vlcek/repos","events_url":"https://api.github.com/users/lukas-vlcek/events{/privacy}","received_events_url":"https://api.github.com/users/lukas-vlcek/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-03-31T08:19:29Z","updated_at":"2016-01-14T14:02:05Z","closed_at":"2016-01-14T14:02:05Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Below reproduction shows that while it is possible to use `groovy` in mapping `transform` the same operation fails when `javascript` is used.\n\nTested with Elasticsearch `1.4.1`, `1.4.4` and `1.5.0`.\n### Reproduction\n\nDownload fresh Elasticsearch (`1.4.1`) and install lang-javascript plugin (`2.4.1`):\n\n``` bash\n    wget https://download.elasticsearch.org/elasticsearch/elasticsearch/elasticsearch-1.4.1.zip\n    unzip elasticsearch-1.4.1.zip\n    cd elasticsearch-1.4.1\n    ./bin/plugin install elasticsearch/elasticsearch-lang-javascript/2.4.1\n```\n\nEnable scripting:\n\n``` bash\n    echo script.disable_dynamic: false | tee -a config/elasticsearch.yml > /dev/null\n    cat config/elasticsearch.yml | grep script\n    # script.disable_dynamic: false\n```\n\nStart node:\n\n``` bash\n    ./bin/elasticsearch -d\n```\n\nAfter node is ready check we have a fresh empty cluster with javascript plugin only:\n\n``` bash\n    curl 'http://localhost:9200/_cat/health?v'\n    # epoch      timestamp cluster       status node.total node.data shards pri relo init unassign \n    #1427789340 10:09:00  elasticsearch green           1         1      0   0    0    0        0 \n\n    curl 'localhost:9200/_cat/plugins?v'\n    # name      component       version type url\n    # Maur-Konn lang-javascript 2.4.1   j\n```\n\nCreate index with `transform` script:\n\n``` bash\n    curl -X PUT 'localhost:9200/test_javascript' -d '{\n      \"mappings\": {\n        \"test\": {\n          \"transform\": {\n            \"script\":\"true\",\n            \"lang\": \"javascript\"\n          }\n        }\n      }\n    }'\n    # {\"acknowledged\":true}\n\n    curl -X PUT 'localhost:9200/test_groovy' -d '{\n      \"mappings\": {\n        \"test\": {\n          \"transform\": {\n            \"script\":\"true\",\n            \"lang\": \"groovy\"\n          }\n        }\n      }\n    }'\n    # {\"acknowledged\":true}\n\n    curl -X GET 'localhost:9200/test*/_mapping?pretty'\n    #{\n    #  \"test_groovy\" : {\n    #    \"mappings\" : {\n    #      \"test\" : {\n    #        \"transform\" : {\n    #          \"script\" : \"true\",\n    #          \"lang\" : \"groovy\"\n    #        },\n    #        \"properties\" : { }\n    #      }\n    #    }\n    #  },\n    #  \"test_javascript\" : {\n    #    \"mappings\" : {\n    #      \"test\" : {\n    #        \"transform\" : {\n    #          \"script\" : \"true\",\n    #          \"lang\" : \"javascript\"\n    #        },\n    #        \"properties\" : { }\n    #      }\n    #    }\n    #  }\n    #}\n```\n\nIndex document into test indices:\n\n``` bash\n    curl -X POST 'localhost:9200/test_groovy/test' -d '{ \"foo\": \"bar\" }'\n    # {\"_index\":\"test_groovy\",\"_type\":\"test\",\"_id\":\"AUxu4fLdiRC7ona2R0WV\",\"_version\":1,\"created\":true}\n\n    curl -X POST 'localhost:9200/test_javascript/test' -d '{ \"foo\": \"bar\" }'\n    # {\"error\":\"MapperParsingException[failed to parse]; nested: ElasticsearchIllegalArgumentException[failed to execute script]; nested: NullPointerException; \",\"status\":400}\n```\n\nCheck log file:\n\n```\nless logs/elasticsearch.log\n\n[2015-03-31 10:10:59,993][DEBUG][action.index             ] [Maur-Konn] [test_javascript][2], node[KF0FaHAPSAybJxQpwMPCow], [P], s[STARTED]: Failed to execute [index {[test_javascript][test][AUxu4jHGiRC7ona2R0WW], source[{ \"foo\": \"bar\" }]}]\norg.elasticsearch.index.mapper.MapperParsingException: failed to parse\n        at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:562)\n        at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:490)\n        at org.elasticsearch.index.shard.service.InternalIndexShard.prepareCreate(InternalIndexShard.java:392)\n        at org.elasticsearch.action.index.TransportIndexAction.shardOperationOnPrimary(TransportIndexAction.java:198)\n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.performOnPrimary(TransportShardReplicationOperationAction.java:511)\n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction$1.run(TransportShardReplicationOperationAction.java:419)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.ElasticsearchIllegalArgumentException: failed to execute script\n        at org.elasticsearch.index.mapper.DocumentMapper$ScriptTransform.transformSourceAsMap(DocumentMapper.java:836)\n        at org.elasticsearch.index.mapper.DocumentMapper.transformSourceAsMap(DocumentMapper.java:606)\n        at org.elasticsearch.index.mapper.DocumentMapper.transform(DocumentMapper.java:612)\n        at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:507)\n        ... 8 more\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.script.javascript.JavaScriptScriptEngineService.executable(JavaScriptScriptEngineService.java:113)\n        at org.elasticsearch.script.ScriptService.executable(ScriptService.java:467)\n        at org.elasticsearch.script.ScriptService.executable(ScriptService.java:463)\n        at org.elasticsearch.index.mapper.DocumentMapper$ScriptTransform.transformSourceAsMap(DocumentMapper.java:828)\n        ... 11 more\n\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}