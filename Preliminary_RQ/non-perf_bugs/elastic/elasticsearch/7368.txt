{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7368","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7368/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7368/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7368/events","html_url":"https://github.com/elastic/elasticsearch/issues/7368","id":40791205,"node_id":"MDU6SXNzdWU0MDc5MTIwNQ==","number":7368,"title":"Suggester:  No results returned for certain geo precisions","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":121618939,"node_id":"MDU6TGFiZWwxMjE2MTg5Mzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.3.3","name":"v1.3.3","color":"dddddd","default":false,"description":null},{"id":111540092,"node_id":"MDU6TGFiZWwxMTE1NDAwOTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.4.0.Beta1","name":"v1.4.0.Beta1","color":"dddddd","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2014-08-21T10:27:41Z","updated_at":"2014-09-08T15:11:32Z","closed_at":"2014-08-29T13:09:28Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"An encoding issue in GeolocationContextMapping means that certain precision levels are being skipped and consequently cannot be queried.\nPartial YAML test here: \n\n```\nsetup:\n  - do:\n      indices.create:\n          index: test\n          body:\n            mappings:\n              test:\n                \"properties\":\n                  \"suggest_geo_multi_level\":\n                     \"type\" : \"completion\"\n                     \"context\":\n                        \"location\":\n                            \"type\" : \"geo\"\n                            \"precision\" : [1,2,3,4,5,6,7,8,9,10,11,12]\n  - do:\n      index:\n        index: test\n        type:  test\n        id:    1\n        body:\n          suggest_geo_multi_level:\n            input: \"Hotel Marriot in Amsterdam\"\n            context:\n              location:\n                lat : 52.22\n                lon : 4.53\n```\n\nThis call works:\n\n```\n  - do:\n      suggest:\n        index: test\n        body:\n          result:\n            text: \"hote\"\n            completion:\n              field: suggest_geo_multi_level\n              context:\n                location:\n                  lat : 52.22\n                  lon : 4.53\n                  precision : 3                  \n  - length: { result: 1  }\n```\n\nbut a precision length of 4 does not. In fact precisions 1,2,3 and 12 work and all others fail.\nSo there are gaps in the encoding of the data.\nThe reason is that the encoding logic is given precisions in this order:  [12, 3, 10, 6, 2, 1, 7, 11, 9, 5, 4, 8]\nand the encoding logic mistakenly truncates the \"geohash\" string while in this loop:\n\n```\n    for (String geohash : geohashes) {\n        for (int p : mapping.precision) {\n            int precision = Math.min(p, geohash.length());\n            geohash = geohash.substring(0, precision);\n            if(mapping.neighbors) {\n                GeoHashUtils.addNeighbors(geohash, precision, locations);\n            }\n            locations.add(geohash);\n        }\n    }\n```\n\nThe required fix is to not change the \"geohash\" string value in the inner loop which ensures all precisions are then encoded correctly.\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}