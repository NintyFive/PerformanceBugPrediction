{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26072","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26072/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26072/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26072/events","html_url":"https://github.com/elastic/elasticsearch/issues/26072","id":248260767,"node_id":"MDU6SXNzdWUyNDgyNjA3Njc=","number":26072,"title":"Scripted updates on /_bulk endpoint requires JSON to be in particular order","user":{"login":"rubyroobs","id":5933494,"node_id":"MDQ6VXNlcjU5MzM0OTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/5933494?v=4","gravatar_id":"","url":"https://api.github.com/users/rubyroobs","html_url":"https://github.com/rubyroobs","followers_url":"https://api.github.com/users/rubyroobs/followers","following_url":"https://api.github.com/users/rubyroobs/following{/other_user}","gists_url":"https://api.github.com/users/rubyroobs/gists{/gist_id}","starred_url":"https://api.github.com/users/rubyroobs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rubyroobs/subscriptions","organizations_url":"https://api.github.com/users/rubyroobs/orgs","repos_url":"https://api.github.com/users/rubyroobs/repos","events_url":"https://api.github.com/users/rubyroobs/events{/privacy}","received_events_url":"https://api.github.com/users/rubyroobs/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-08-06T17:37:43Z","updated_at":"2017-08-07T17:26:50Z","closed_at":"2017-08-07T17:26:50Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): `5.5.1 (19c13d0)`\r\n\r\n**Plugins installed**: `X-Pack`\r\n\r\n**JVM version** (`java -version`): `1.8.0_131 (Oracle)`\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Linux <hostname> 4.4.0-87-generic #110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**: When submitting an update with a script to the `/_bulk` endpoint, the request fails if the `params` key is before the `script` key in the JSON with `Validation Failed: ...: script or doc is missing;`, but succeeds in the opposite order. I'm not sure if this is intentional, but I'd assume not - especially as the [JSON RFC](http://www.rfc-editor.org/rfc/rfc7159.txt) states objects are unordered. This is causing issues for me with the Golang JSON library as it is putting params first by default (opting for lexicographical order).\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create a simple type mapping `ourtype` with a nested object array `nesting` and index an object (noting the ID). The array can either have initial values or be completely empty.\r\n 2. Try submitting the following request to `/_bulk`:\r\n```\r\n{\"update\":{\"_id\":\"<id>\",\"_index\":\"testing-index\",\"_type\":\"ourtype\"}}\r\n{\"params\":{\"insertion\":{\"nested_field\":\"hey\"}},\"script\":\"if (ctx._source.nesting == null) { ctx._source.nesting = [params['insertion']] } else { ctx._source.nesting.add(params['insertion']) }\"}\r\n```\r\nYou will find it returns with a validation exception and spits back a `Validation Failed: 1: script or doc is missing;`\r\n 3. Take the previous request, but change the ordering on the 2nd JSON object so the `script` comes before the `params`, i.e.:\r\n```\r\n{\"update\":{\"_id\":\"<id>\",\"_index\":\"testing-index\",\"_type\":\"ourtype\"}}\r\n{\"script\":\"if (ctx._source.nesting == null) { ctx._source.nesting = [params['insertion']] } else { ctx._source.nesting.add(params['insertion']) }\",\"params\":{\"insertion\":{\"nested_field\":\"hey\"}}}\r\n```\r\nThe request runs through as expected (i.e. no errors).\r\n\r\n**Provide logs (if relevant)**:\r\nError returned in step 2:\r\n```\r\n{\"error\":{\"root_cause\":[{\"type\":\"action_request_validation_exception\",\"reason\":\"Validation Failed: 1: script or doc is missing;\"}],\"type\":\"action_request_validation_exception\",\"reason\":\"Validation Failed: 1: script or doc is missing;\"},\"status\":400}\r\n```\r\n\r\n","closed_by":{"login":"rubyroobs","id":5933494,"node_id":"MDQ6VXNlcjU5MzM0OTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/5933494?v=4","gravatar_id":"","url":"https://api.github.com/users/rubyroobs","html_url":"https://github.com/rubyroobs","followers_url":"https://api.github.com/users/rubyroobs/followers","following_url":"https://api.github.com/users/rubyroobs/following{/other_user}","gists_url":"https://api.github.com/users/rubyroobs/gists{/gist_id}","starred_url":"https://api.github.com/users/rubyroobs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rubyroobs/subscriptions","organizations_url":"https://api.github.com/users/rubyroobs/orgs","repos_url":"https://api.github.com/users/rubyroobs/repos","events_url":"https://api.github.com/users/rubyroobs/events{/privacy}","received_events_url":"https://api.github.com/users/rubyroobs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}