{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49218","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49218/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49218/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49218/events","html_url":"https://github.com/elastic/elasticsearch/issues/49218","id":523900232,"node_id":"MDU6SXNzdWU1MjM5MDAyMzI=","number":49218,"title":"PainlessScriptEngine.generateStatefulFactory fails with ASM 7.1/7.2","user":{"login":"vlsi","id":213894,"node_id":"MDQ6VXNlcjIxMzg5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/213894?v=4","gravatar_id":"","url":"https://api.github.com/users/vlsi","html_url":"https://github.com/vlsi","followers_url":"https://api.github.com/users/vlsi/followers","following_url":"https://api.github.com/users/vlsi/following{/other_user}","gists_url":"https://api.github.com/users/vlsi/gists{/gist_id}","starred_url":"https://api.github.com/users/vlsi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vlsi/subscriptions","organizations_url":"https://api.github.com/users/vlsi/orgs","repos_url":"https://api.github.com/users/vlsi/repos","events_url":"https://api.github.com/users/vlsi/events{/privacy}","received_events_url":"https://api.github.com/users/vlsi/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"assignees":[{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-11-16T21:48:06Z","updated_at":"2019-11-20T15:07:34Z","closed_at":"2019-11-20T15:07:34Z","author_association":"NONE","active_lock_reason":null,"body":"PainlessScriptEngine.generateStatefulFactory fails with ASM 7.1/7.2\r\n\r\nThe failure is discovered with https://github.com/apache/calcite/tree/master/elasticsearch tests\r\n\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): elasticsearch-7.4.2.jar, lang-painless-7.4.2.jar\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"11\" 2018-09-25\r\nOpenJDK Runtime Environment 18.9 (build 11+28)\r\nOpenJDK 64-Bit Server VM 18.9 (build 11+28, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin ....local 18.7.0 Darwin Kernel Version 18.7.0: Thu Jun 20 18:42:21 PDT 2019; root:xnu-4903.270.47~4/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nApache Calcite tests do not work if ASM 7.1 or later is used.\r\n\r\n```\r\n   Caused by: org.elasticsearch.script.GeneralScriptException: Failed to compile inline script [params._source.loc[0]] using lang [painless]\r\n        at org.elasticsearch.script.ScriptService.compile(ScriptService.java:361) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.parseSource(SearchService.java:846) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.createContext(SearchService.java:586) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:545) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:348) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.lambda$executeQueryPhase$1(SearchService.java:340) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.action.ActionListener.lambda$map$2(ActionListener.java:145) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:62) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        ... 9 more\r\n    Caused by: java.lang.IllegalArgumentException\r\n        at org.objectweb.asm.Type.getTypeInternal(Type.java:443) ~[asm-7.2.jar:7.2]\r\n        at org.objectweb.asm.Type.getType(Type.java:177) ~[asm-7.2.jar:7.2]\r\n        at org.elasticsearch.painless.PainlessScriptEngine.generateStatefulFactory(PainlessScriptEngine.java:199) ~[lang-painless-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.painless.PainlessScriptEngine.compile(PainlessScriptEngine.java:143) ~[lang-painless-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.script.ScriptService.compile(ScriptService.java:356) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.parseSource(SearchService.java:846) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.createContext(SearchService.java:586) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:545) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:348) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.search.SearchService.lambda$executeQueryPhase$1(SearchService.java:340) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.action.ActionListener.lambda$map$2(ActionListener.java:145) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:62) ~[elasticsearch-7.4.2.jar:7.4.2]\r\n        ... 9 more\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nI'm afraid \"build Apache Calcite\" does not sound like a minimal test case, however I can provide such instructions if you want.\r\n\r\nHere's the Elastic code:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/master/modules/lang-painless/src/main/java/org/elasticsearch/painless/PainlessScriptEngine.java#L233\r\n\r\nPainless uses `Type.getType(String)` with **String** arguments like `package/package/Class$Factory`, however, `Type.getType(String)` expects JVM descriptor like `J` for boolean, `Ljava/lang/String;` for `java.lang.String` and so on.\r\n\r\nSee tests here: \r\n https://gitlab.ow2.org/asm/asm/blob/8486f1034f5634e4e2d2e95faa3bcbee4a199bd7/asm/src/test/java/org/objectweb/asm/TypeTest.java#L117\r\n\r\nI guess you need to use `Type.getObjectType`: https://gitlab.ow2.org/asm/asm/blob/8486f1034f5634e4e2d2e95faa3bcbee4a199bd7/asm/src/test/java/org/objectweb/asm/TypeTest.java#L131-133\r\n\r\n","closed_by":{"login":"jdconrad","id":2126764,"node_id":"MDQ6VXNlcjIxMjY3NjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/2126764?v=4","gravatar_id":"","url":"https://api.github.com/users/jdconrad","html_url":"https://github.com/jdconrad","followers_url":"https://api.github.com/users/jdconrad/followers","following_url":"https://api.github.com/users/jdconrad/following{/other_user}","gists_url":"https://api.github.com/users/jdconrad/gists{/gist_id}","starred_url":"https://api.github.com/users/jdconrad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jdconrad/subscriptions","organizations_url":"https://api.github.com/users/jdconrad/orgs","repos_url":"https://api.github.com/users/jdconrad/repos","events_url":"https://api.github.com/users/jdconrad/events{/privacy}","received_events_url":"https://api.github.com/users/jdconrad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}