{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29809","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29809/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29809/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29809/events","html_url":"https://github.com/elastic/elasticsearch/issues/29809","id":317448144,"node_id":"MDU6SXNzdWUzMTc0NDgxNDQ=","number":29809,"title":"[ML] Make max open jobs setting a dynamic cluster-wide setting","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"assignees":[{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2017-09-28T09:46:35Z","updated_at":"2019-03-06T09:45:14Z","closed_at":"2019-03-06T09:45:14Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @droberts195:*\r\n\r\nI discussed this with @bleskes this morning.\r\n\r\nCurrently we have the following interrelated problems/limitations:\r\n\r\n* `xpack.ml.max_open_jobs` is a node setting rather than a cluster setting\r\n* `xpack.ml.max_open_jobs` cannot be dynamically changed\r\n* We copy the value of `xpack.ml.max_open_jobs` to a node attribute called `ml.max_open_jobs` so that the value for each node is available to the master node\r\n* There is nothing to stop a user independently changing the value of the `ml.max_open_jobs` node attribute\r\n* The `xpack.ml.max_open_jobs` is used to size a fixed-size thread pool that is used to communicate with native `autodetect` processes - the fixed-size nature of this thread pool is the main reason why the setting has to be known so early in the node startup sequence and cannot be changed later\r\n\r\nWe agreed that it would be good if the setting could be made a dynamic cluster setting and the node attribute could be removed.  Some changes that would achieve this are:\r\n\r\n* Change from using a fixed size thread pool to a scaling thread pool for communicating with the `autodetect` process\r\n* Set the maximum size of this scaling thread pool to some high number - this will result in a hardcoded absolute maximum for the number of jobs running on a node, but can be so high that it will never kick in in reality, as the node will likely run out of another resource before hitting it (2000?)\r\n* Make `xpack.ml.max_open_jobs` a cluster setting whose maximum permitted value is consistent with the maximum size of the scaling thread pool, but that can be freely modified within these bounds\r\n* Document that decreasing `xpack.ml.max_open_jobs` will not cause currently running jobs to be relocated - new jobs will not be opened on a node until it has capacity, but existing jobs will continue to run even if that puts the node over its (recently reduced) limit\r\n* Remove the `ml.max_open_jobs` node attribute when safe to do so from a BWC perspective\r\n\r\nIn the very short term we should also validate that the user has not independently set the `ml.max_open_jobs` node attribute.  When X-Pack is installed the only way this node attribute gets set should be via the ML startup code.  Otherwise a user could mistakenly think that changing the node attribute is the best way to change the maximum number of open jobs, causing inconsistencies that are hard to understand and debug.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}