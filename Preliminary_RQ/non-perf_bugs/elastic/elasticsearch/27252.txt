{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27252","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27252/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27252/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27252/events","html_url":"https://github.com/elastic/elasticsearch/issues/27252","id":270957897,"node_id":"MDU6SXNzdWUyNzA5NTc4OTc=","number":27252,"title":"Bootstrap checks prevent usage of -XX:+UseCGroupMemoryLimitForHeap with Docker","user":{"login":"pdecat","id":318490,"node_id":"MDQ6VXNlcjMxODQ5MA==","avatar_url":"https://avatars1.githubusercontent.com/u/318490?v=4","gravatar_id":"","url":"https://api.github.com/users/pdecat","html_url":"https://github.com/pdecat","followers_url":"https://api.github.com/users/pdecat/followers","following_url":"https://api.github.com/users/pdecat/following{/other_user}","gists_url":"https://api.github.com/users/pdecat/gists{/gist_id}","starred_url":"https://api.github.com/users/pdecat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pdecat/subscriptions","organizations_url":"https://api.github.com/users/pdecat/orgs","repos_url":"https://api.github.com/users/pdecat/repos","events_url":"https://api.github.com/users/pdecat/events{/privacy}","received_events_url":"https://api.github.com/users/pdecat/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-11-03T12:10:44Z","updated_at":"2020-11-11T21:57:12Z","closed_at":"2017-11-03T12:43:48Z","author_association":"NONE","active_lock_reason":null,"body":"As of Java SE 8u131, the JVM can be aware of Docker memory limits in the absence of setting a maximum Java heap via `-Xmx` with the JVM command line options `-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap` (see https://blogs.oracle.com/java-platform-group/java-se-support-for-docker-cpu-and-memory-limits).\r\n\r\nHowever the current bootstrap checks prevent using this new JVM feature as it requires setting `-Xms` and `-Xmx` (container memory requests and limits are both set to 2000MiB):\r\n\r\n```\r\nVM settings:                                  \r\n    Stack Size: 1.00M                         \r\n    Max. Heap Size (Estimated): 1.94G         \r\n    Ergonomics Machine Class: server          \r\n    Using VM: OpenJDK 64-Bit Server VM        \r\n\r\n[2017-11-03T12:05:46,831][INFO ][o.e.n.Node               ] [es-client-mnlgq] initializing ...                                                                                            \r\n[2017-11-03T12:05:46,996][INFO ][o.e.e.NodeEnvironment    ] [es-client-mnlgq] using [1] data paths, mounts [[/ (overlay)]], net usable_space [79.2gb], net total_space [94.2gb], spins? [possibly], types [overlay]\r\n[2017-11-03T12:05:46,997][INFO ][o.e.e.NodeEnvironment    ] [es-client-mnlgq] heap size [1.9gb], compressed ordinary object pointers [true]                                               \r\n[2017-11-03T12:05:47,001][INFO ][o.e.n.Node               ] [es-client-mnlgq] node name [es-client-mnlgq], node ID [*******]                                               \r\n[2017-11-03T12:05:47,001][INFO ][o.e.n.Node               ] [es-client-mnlgq] version[5.6.3], pid[1], build[1a2f265/2017-10-06T20:33:39.012Z], OS[Linux/4.4.70+/amd64], JVM[Oracle Corporation/OpenJDK 64-Bit Server VM/1.8.0_141/25.141-b16]\r\n[2017-11-03T12:05:47,002][INFO ][o.e.n.Node               ] [es-client-mnlgq] JVM arguments [-XX:+UnlockExperimentalVMOptions, -XX:+UseCGroupMemoryLimitForHeap, -XX:MinRAMFraction=1, -XX:MaxRAMFraction=1, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -Djdk.io.permissionsUseCanonicalPath=true, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Dlog4j.skipJansi=true, -Des.cgroups.hierarchy.override=/, -Des.path.home=/usr/share/elasticsearch]\r\n[2017-11-03T12:05:50,826][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [aggs-matrix-stats]                                                                           \r\n[2017-11-03T12:05:50,827][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [ingest-common]                                                                               [2017-11-03T12:05:50,828][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [lang-expression]                                                                             \r\n[2017-11-03T12:05:50,828][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [lang-groovy]                                                                                 [2017-11-03T12:05:50,829][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [lang-mustache]                                                                               \r\n[2017-11-03T12:05:50,831][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [lang-painless]                                                                               \r\n[2017-11-03T12:05:50,832][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [parent-join]                                                                                 \r\n[2017-11-03T12:05:50,832][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [percolator]                                                                                  \r\n[2017-11-03T12:05:50,832][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [reindex]                                                                                     \r\n[2017-11-03T12:05:50,832][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [transport-netty3]                                                                            \r\n[2017-11-03T12:05:50,833][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded module [transport-netty4]                                                                            \r\n[2017-11-03T12:05:50,835][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded plugin [ingest-geoip]                                                                                \r\n[2017-11-03T12:05:50,835][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded plugin [ingest-user-agent]                                                                           \r\n[2017-11-03T12:05:50,835][INFO ][o.e.p.PluginsService     ] [es-client-mnlgq] loaded plugin [x-pack]                                                                                      \r\n[2017-11-03T12:05:54,826][INFO ][o.e.d.DiscoveryModule    ] [es-client-mnlgq] using discovery type [zen]                                                                                  \r\n[2017-11-03T12:05:56,065][INFO ][o.e.n.Node               ] [es-client-mnlgq] initialized    \r\n[2017-11-03T12:05:56,066][INFO ][o.e.n.Node               ] [es-client-mnlgq] starting ...   \r\n[2017-11-03T12:05:56,452][INFO ][o.e.t.TransportService   ] [es-client-mnlgq] publish_address {10.32.4.83:9300}, bound_addresses {10.32.4.83:9300}                                        \r\n[2017-11-03T12:05:56,472][INFO ][o.e.b.BootstrapChecks    ] [es-client-mnlgq] bound or publishing to a non-loopback or non-link-local address, enforcing bootstrap checks                 \r\nERROR: [1] bootstrap checks failed            \r\n[1]: initial heap size [33554432] not equal to maximum heap size [2097152000]; this can cause resize pauses and prevents mlockall from locking the entire heap                            \r\n[2017-11-03T12:05:56,486][INFO ][o.e.n.Node               ] [es-client-mnlgq] stopping ...   \r\n[2017-11-03T12:05:56,551][INFO ][o.e.n.Node               ] [es-client-mnlgq] stopped        \r\n[2017-11-03T12:05:56,552][INFO ][o.e.n.Node               ] [es-client-mnlgq] closing ...    \r\n[2017-11-03T12:05:56,592][INFO ][o.e.n.Node               ] [es-client-mnlgq] closed         \r\n```\r\n\r\nUsing docker image `docker.elastic.co/elasticsearch/elasticsearch:5.6.3`:\r\n\r\n* Elasticsearch version: 5.6.3\r\n* JVM version: `openjdk version \"1.8.0_141` / `OpenJDK Runtime Environment (build 1.8.0_141-b16)` / `OpenJDK 64-Bit Server VM (build 25.141-b16, mixed mode)`\r\n* OS version: `Linux es-client-4tws2 4.4.70+ #1 SMP Fri Oct 6 05:36:11 PDT 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Steps to reproduce**:\r\n\r\nStart containers with the following `elasticsearch.yml` configuration file:\r\n\r\n```\r\ncluster.name: \"my-cluster\"\r\nnode.name: \"${NODE_NAME}\"\r\n\r\nnode.data: false\r\nnode.master: false\r\nnode.ingest: false\r\nhttp.enabled: true\r\n\r\nxpack.ml.enabled: false\r\nxpack.monitoring.enabled: false\r\nxpack.security.enabled: false\r\nxpack.watcher.enabled: false\r\n\r\nbootstrap.memory_lock: false\r\n\r\nnetwork.host: _eth0:ipv4_\r\n\r\ndiscovery.zen.minimum_master_nodes: 2\r\ndiscovery.zen.ping.unicast.hosts: elasticsearch-discovery\r\ndiscovery.zen.ping.unicast.hosts.resolve_timeout: 30s\r\n```\r\n\r\nand `jvm.options` (only 5 first lines are customized from base configuration):\r\n\r\n```\r\n-XshowSettings:vm\r\n-XX:+UnlockExperimentalVMOptions -XX:+UseCGroupMemoryLimitForHeap\r\n-XX:MinRAMFraction=1 -XX:MaxRAMFraction=1\r\n# -Xms2g\r\n# -Xmx2g\r\n-XX:+UseConcMarkSweepGC\r\n-XX:CMSInitiatingOccupancyFraction=75\r\n-XX:+UseCMSInitiatingOccupancyOnly\r\n-XX:+AlwaysPreTouch\r\n-server\r\n-Xss1m\r\n-Djava.awt.headless=true\r\n-Dfile.encoding=UTF-8\r\n-Djna.nosys=true\r\n-Djdk.io.permissionsUseCanonicalPath=true\r\n-Dio.netty.noUnsafe=true\r\n-Dio.netty.noKeySetOptimization=true\r\n-Dio.netty.recycler.maxCapacityPerThread=0\r\n-Dlog4j.shutdownHookEnabled=false\r\n-Dlog4j2.disable.jmx=true\r\n-Dlog4j.skipJansi=true\r\n```\r\n\r\nIt would be great to be able to use those new JVM features.","closed_by":{"login":"pdecat","id":318490,"node_id":"MDQ6VXNlcjMxODQ5MA==","avatar_url":"https://avatars1.githubusercontent.com/u/318490?v=4","gravatar_id":"","url":"https://api.github.com/users/pdecat","html_url":"https://github.com/pdecat","followers_url":"https://api.github.com/users/pdecat/followers","following_url":"https://api.github.com/users/pdecat/following{/other_user}","gists_url":"https://api.github.com/users/pdecat/gists{/gist_id}","starred_url":"https://api.github.com/users/pdecat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pdecat/subscriptions","organizations_url":"https://api.github.com/users/pdecat/orgs","repos_url":"https://api.github.com/users/pdecat/repos","events_url":"https://api.github.com/users/pdecat/events{/privacy}","received_events_url":"https://api.github.com/users/pdecat/received_events","type":"User","site_admin":false},"performed_via_github_app":null}