{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43453","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43453/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43453/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43453/events","html_url":"https://github.com/elastic/elasticsearch/issues/43453","id":458845889,"node_id":"MDU6SXNzdWU0NTg4NDU4ODk=","number":43453,"title":"Shard allocation awareness and search routing","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-06-20T19:58:45Z","updated_at":"2019-09-04T19:48:03Z","closed_at":"2019-09-04T19:48:03Z","author_association":"MEMBER","active_lock_reason":null,"body":"Today when shard allocation awareness is activated we try to route searches to nodes that have _any_ awareness attribute in common with the coordinating node. However the routing of these search can have a negative effect on the cluster for different reasons:\r\n\r\n- Users can overload a single zone if they don't route the search requests to nodes with different attributes.\r\n\r\n- Nodes are picked without checking the stats of the adaptive replica selection so an overloaded node will continue to receive the same amount of traffic even if we have evidence\r\n(service time) that it behaves poorly compared to other. \r\n\r\nFor these reasons I'd like to propose three options to enhance the situation:\r\n\r\n1. Completely decouple allocation awareness and search routing. We'd apply adaptive replica selection by default (or round robin if it is deactivated) even if nodes have allocation awareness attributes.\r\n\r\n2. Apply search routing based on allocation awareness attributes only if the adaptive replica selection is deactivated. \r\n\r\n3. Add an option in the search preference to reference the awareness attributes that should be used for routing.\r\n\r\n1 might be a bit radical so I have a slight preference for 2 and 3 since users that relies on this feature could restore the current behavior by changing a cluster setting (2) or an option in their search requests (3). The benefit of all these options is that we'd use adaptive replica selection by default in all cases. \r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}