[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/470900508","html_url":"https://github.com/elastic/elasticsearch/issues/39835#issuecomment-470900508","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39835","id":470900508,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3MDkwMDUwOA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-03-08T11:40:32Z","updated_at":"2019-03-08T11:40:32Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/598487547","html_url":"https://github.com/elastic/elasticsearch/issues/39835#issuecomment-598487547","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39835","id":598487547,"node_id":"MDEyOklzc3VlQ29tbWVudDU5ODQ4NzU0Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2020-03-13T00:16:59Z","updated_at":"2020-03-13T00:16:59Z","author_association":"MEMBER","body":"Since we reverted #42510 I think it makes sense to re-evaluate a simple solution to automatically execute the can match phase despite the default. This shouldn't be an issue going forward in Kibana since they plan to use the new async search which sets the `pre_filter_shard_size` to  1 by default but we should make the change in blocking `_search` nevertheless. We've improved the handling of queries on frozen indices that didn't run the can match phase by avoiding the usage of the throttled [search thread pool](https://github.com/elastic/elasticsearch/pull/51708) on shards that cannot match the date range filter so it shouldn't be required to run the can match phase for these indices anymore. However the `can_match_phase` is now also used to [pre-sort shards on sorted queries](https://github.com/elastic/elasticsearch/pull/49092) so we could automatically run this phase if it can [optimize the query phase](https://github.com/elastic/elasticsearch/pull/51852) significantly.\r\n@javanna WDYT ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/598616572","html_url":"https://github.com/elastic/elasticsearch/issues/39835#issuecomment-598616572","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39835","id":598616572,"node_id":"MDEyOklzc3VlQ29tbWVudDU5ODYxNjU3Mg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-03-13T08:56:08Z","updated_at":"2020-03-13T08:56:08Z","author_association":"MEMBER","body":"heya @jimczi what do you mean with \"automatically execute the can match phase despite the default\"?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/598631921","html_url":"https://github.com/elastic/elasticsearch/issues/39835#issuecomment-598631921","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39835","id":598631921,"node_id":"MDEyOklzc3VlQ29tbWVudDU5ODYzMTkyMQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2020-03-13T09:32:13Z","updated_at":"2020-03-13T09:32:13Z","author_association":"MEMBER","body":"Defaulting to a static value of `128` is not flexible enough so today we require our users to set this value correctly. What I meant is that we should consider the default (`pre_filter_shard_size` is not present in the request) dynamic in order to be able:\r\n- Automatically run the can_match phase if frozen indices are part of the query\r\n  - or if a primary field sort is used (sort by a field).\r\n  - ... (we can add more conditions here)\r\n\r\nUsers would be able to opt-out by setting `pre_filter_shard_size` to a static value in their requests but that shouldn't be needed in the majority of cases.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/598723064","html_url":"https://github.com/elastic/elasticsearch/issues/39835#issuecomment-598723064","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39835","id":598723064,"node_id":"MDEyOklzc3VlQ29tbWVudDU5ODcyMzA2NA==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-03-13T13:35:48Z","updated_at":"2020-03-13T13:35:48Z","author_association":"MEMBER","body":"++ to having a more dynamic default, good idea @jimczi . We could then probably open a discussion on the need for the request parameter, and whether it still needs to be a threshold based on number of shards. Maybe it should become something to force enabling/disabling the execution of the can match phase.","performed_via_github_app":null}]