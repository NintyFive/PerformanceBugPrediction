{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21885","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21885/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21885/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21885/events","html_url":"https://github.com/elastic/elasticsearch/issues/21885","id":192575428,"node_id":"MDU6SXNzdWUxOTI1NzU0Mjg=","number":21885,"title":"Query with filter returns wrong documents","user":{"login":"Thermi","id":3606849,"node_id":"MDQ6VXNlcjM2MDY4NDk=","avatar_url":"https://avatars2.githubusercontent.com/u/3606849?v=4","gravatar_id":"","url":"https://api.github.com/users/Thermi","html_url":"https://github.com/Thermi","followers_url":"https://api.github.com/users/Thermi/followers","following_url":"https://api.github.com/users/Thermi/following{/other_user}","gists_url":"https://api.github.com/users/Thermi/gists{/gist_id}","starred_url":"https://api.github.com/users/Thermi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Thermi/subscriptions","organizations_url":"https://api.github.com/users/Thermi/orgs","repos_url":"https://api.github.com/users/Thermi/repos","events_url":"https://api.github.com/users/Thermi/events{/privacy}","received_events_url":"https://api.github.com/users/Thermi/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-11-30T14:12:38Z","updated_at":"2016-12-01T08:40:46Z","closed_at":"2016-12-01T08:40:46Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version**:  2.4.2\r\n\r\n**Plugins installed**: [cloud-aws]\r\n\r\n**JVM version**: 1.8.0.111\r\n\r\n**OS version**: CentOS 7.\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWe're running queries with filters on an ElasticSearch cluster. The query returns documents that have values that are not allowed by the filter. The attached es_trace.txt contains a representation of the `curl` commands as they would be used on the command line. We're using elastalert by yelp to try to alert when certain fields are out of range or generally, when nodes are loaded too much or other problems appear. elastalert does not use curl directly. When it's used in debug mode, it only prints out the HTTP requests it does as curl commands.\r\n\r\nThe relevant parts are the following:\r\n**Steps to reproduce**:\r\n 1. A query with the range filter is run on an ElasticSearch cluster.\r\n```\r\n                  \"range\": {\r\n                    \"Metrics.cpu/node_utilization.value\": {\r\n                      \"gte\": 0.8,\r\n                      \"lte\": 1.0\r\n                    }\r\n                  }\r\n```\r\n2. The cluster returns a document with values outside of the defined range\r\n```\r\n    \"cpu/node_utilization\": {\r\n        \"value\": 0.522\r\n    }\r\n```\r\n**Provide logs (if relevant)**:\r\n\r\nAttached [es_trace.txt](https://github.com/elastic/elasticsearch/files/621983/es_trace.txt) shows compatible CURL commands.\r\nAttached [heapster-mapping-formatted.txt](https://github.com/elastic/elasticsearch/files/621982/heapster-mapping-formatted.txt) shows the mapping the indice uses.\r\n\r\nelastalert rule (Represented as `curl` command in es_trace.txt):\r\n```\r\nname: CPU usage for master node ip-10-0-0-50.eu-west-1.compute.internal\r\ntype: frequency\r\nindex: heapster-cpu-*\r\ntimestamp_field: CpuMetricsTimestamp\r\nnum_events: 1\r\ntimeframe:\r\n    minutes: 15\r\n\r\nfilter:\r\n- and:\r\n   - term:\r\n       \"MetricsTags.type\" : \"node\"\r\n   - term:\r\n       \"MetricsTags.hostname.raw\": \"ip-10-0-0-50.eu-west-1.compute.internal\"\r\n   - range:\r\n       \"Metrics.cpu/node_utilization.value\":\r\n         gte: 0.800\r\n         lte: 1.000\r\n```\r\n\r\nelastalert output and the matched document:\r\n```\r\nINFO:elastalert:CPU usage for master node ip-10-0-0-50.eu-west-1.compute.internal\r\n\r\nAt least 1 events occurred between 2016-10-31 00:00 UTC and 2016-10-31 00:15 UTC\r\n\r\nCpuMetricsTimestamp: 2016-10-31T00:15:00Z\r\nMetrics: {\r\n    \"cpu/limit\": {\r\n        \"value\": 110\r\n    }, \r\n    \"cpu/node_allocatable\": {\r\n        \"value\": 1000\r\n    }, \r\n    \"cpu/node_capacity\": {\r\n        \"value\": 1000\r\n    }, \r\n    \"cpu/node_reservation\": {\r\n        \"value\": 0.51\r\n    }, \r\n    \"cpu/node_utilization\": {\r\n        \"value\": 0.522\r\n    }, \r\n    \"cpu/request\": {\r\n        \"value\": 510\r\n    }, \r\n    \"cpu/usage\": {\r\n        \"value\": 1424597826878037\r\n    }, \r\n    \"cpu/usage_rate\": {\r\n        \"value\": 522\r\n    }\r\n}\r\nMetricsTags: {\r\n    \"host_id\": \"i-0a7fdff8610772107\", \r\n    \"hostname\": \"ip-10-0-0-50.eu-west-1.compute.internal\", \r\n    \"labels\": \"beta.kubernetes.io/arch:amd64,beta.kubernetes.io/instance-type:m3.medium,beta.kubernetes.io/os:linux,controller:true,failure-domain.beta.kubernetes.io/region:eu-west-1,failure\r\n-domain.beta.kubernetes.io/zone:eu-west-1a,kubernetes.io/hostname:ip-10-0-0-50.eu-west-1.compute.internal\", \r\n    \"nodename\": \"ip-10-0-0-50.eu-west-1.compute.internal\", \r\n    \"type\": \"node\"\r\n}\r\n_id: 143be7ec-9eff-11e6-9941-2aa42b43b130\r\n_index: heapster-2016.10.31\r\n_type: cpu\r\n```\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}