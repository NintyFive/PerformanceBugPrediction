{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51286","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51286/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51286/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51286/events","html_url":"https://github.com/elastic/elasticsearch/issues/51286","id":553364865,"node_id":"MDU6SXNzdWU1NTMzNjQ4NjU=","number":51286,"title":"Don't set term_vector when request has many fields","user":{"login":"Fylhtq42","id":34159267,"node_id":"MDQ6VXNlcjM0MTU5MjY3","avatar_url":"https://avatars0.githubusercontent.com/u/34159267?v=4","gravatar_id":"","url":"https://api.github.com/users/Fylhtq42","html_url":"https://github.com/Fylhtq42","followers_url":"https://api.github.com/users/Fylhtq42/followers","following_url":"https://api.github.com/users/Fylhtq42/following{/other_user}","gists_url":"https://api.github.com/users/Fylhtq42/gists{/gist_id}","starred_url":"https://api.github.com/users/Fylhtq42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Fylhtq42/subscriptions","organizations_url":"https://api.github.com/users/Fylhtq42/orgs","repos_url":"https://api.github.com/users/Fylhtq42/repos","events_url":"https://api.github.com/users/Fylhtq42/events{/privacy}","received_events_url":"https://api.github.com/users/Fylhtq42/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2020-01-22T07:43:39Z","updated_at":"2020-01-27T09:25:29Z","closed_at":"2020-01-27T09:25:29Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (7.5.1):\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (11.0.6):\r\n\r\n**OS version** (Windows 10 - vesrion 1903):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI have 2 requests. First for creating Index, second for creating Mapping. In the second request I set up `term_vector` to attachment.content. Always I have no problem with this. But 1 week ago I added one more field to my document. And this logic was broken. But more important elastic response is  \r\n`{\r\n  \"acknowledged\" : true\r\n}` anyway but he doesn't set up 'term_vector' to 'content'. \r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create index\r\nPut: http://localhost:9200/attachment-v2?pretty=true&error_trace=true\r\n<details><summary>Request Body</summary>\r\n<p>\r\n\r\n```json\r\n{\r\n    \"settings\": {\r\n        \"index.number_of_replicas\": 2,\r\n        \"analysis\": {\r\n            \"analyzer\": {\r\n                \"ru\": {\r\n                    \"char_filter\": [],\r\n                    \"filter\": [],\r\n                    \"tokenizer\": \"standard\",\r\n                    \"type\": \"custom\"\r\n                },\r\n                \"strict\": {\r\n                    \"char_filter\": [],\r\n                    \"filter\": [],\r\n                    \"tokenizer\": \"standard\",\r\n                    \"type\": \"custom\"\r\n                }\r\n            }\r\n        },\r\n        \"index.number_of_shards\": 10\r\n    }\r\n}\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n 2. Create Mapping\r\nPUT: http://localhost:9200/attachment-v2/_mapping?pretty=true&error_trace=true\r\n<details><summary>Request Body</summary>\r\n<p>\r\n\r\n```json\r\n{\r\n    \"date_detection\": true,\r\n    \"numeric_detection\": true,\r\n    \"properties\": {\r\n        \"name\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"sourceId\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"attachment\": {\r\n            \"properties\": {\r\n                \"author\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                },\r\n                \"containsMetadata\": {\r\n                    \"type\": \"boolean\"\r\n                },\r\n                \"content\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                },\r\n                \"content_length\": {\r\n                    \"type\": \"long\"\r\n                },\r\n                \"content_type\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                },\r\n                \"date\": {\r\n                    \"type\": \"date\"\r\n                },\r\n                \"detect_language\": {\r\n                    \"type\": \"boolean\"\r\n                },\r\n                \"indexed_chars\": {\r\n                    \"type\": \"long\"\r\n                },\r\n                \"keywords\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                },\r\n                \"language\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                },\r\n                \"name\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                },\r\n                \"title\": {\r\n                    \"fields\": {\r\n                        \"keyword\": {\r\n                            \"ignore_above\": 256,\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"text\"\r\n                }\r\n            },\r\n            \"type\": \"object\"\r\n        },\r\n        \"join\": {\r\n            \"relations\": {\r\n                \"notification\": \"attachment\"\r\n            },\r\n            \"type\": \"join\"\r\n        },\r\n        \"$type\": {\r\n            \"fields\": {\r\n                \"keyword\": {\r\n                    \"ignore_above\": 256,\r\n                    \"type\": \"keyword\"\r\n                }\r\n            },\r\n            \"type\": \"text\"\r\n        },\r\n        \"test66\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test65\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test64\": {\r\n            \"type\": \"short\"\r\n        },\r\n        \"test63\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test62\": {\r\n            \"analyzer\": \"ru\",\r\n            \"term_vector\": \"with_positions_offsets\",\r\n            \"fields\": {\r\n                \"raw\": {\r\n                    \"analyzer\": \"strict\",\r\n                    \"type\": \"text\"\r\n                }\r\n            },\r\n            \"type\": \"text\"\r\n        },\r\n        \"test61\": {\r\n            \"type\": \"double\"\r\n        },\r\n        \"test60\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test59\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test58\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test57\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test56\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test55\": {\r\n            \"properties\": {\r\n                \"test54\": {\r\n                    \"type\": \"keyword\"\r\n                },\r\n                \"test53\": {\r\n                    \"type\": \"keyword\"\r\n                },\r\n                \"test52\": {\r\n                    \"type\": \"keyword\"\r\n                }\r\n            },\r\n            \"type\": \"object\"\r\n        },\r\n        \"test51\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test50\": {\r\n            \"type\": \"short\"\r\n        },\r\n        \"test49\": {\r\n            \"type\": \"short\"\r\n        },\r\n        \"test48\": {\r\n            \"analyzer\": \"ru\",\r\n            \"position_increment_gap\": 0,\r\n            \"term_vector\": \"with_positions_offsets\",\r\n            \"fields\": {\r\n                \"raw\": {\r\n                    \"analyzer\": \"strict\",\r\n                    \"position_increment_gap\": 100,\r\n                    \"type\": \"text\"\r\n                }\r\n            },\r\n            \"type\": \"text\"\r\n        },\r\n        \"test47\": {\r\n            \"type\": \"boolean\"\r\n        },\r\n        \"test46\": {\r\n            \"type\": \"short\"\r\n        },\r\n        \"test45\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test44\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test43\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test42\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test41\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test40\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test38\": {\r\n            \"properties\": {\r\n                \"test39\": {\r\n                    \"type\": \"integer\"\r\n                },\r\n                \"test37\": {\r\n                    \"properties\": {\r\n                        \"test36\": {\r\n                            \"type\": \"keyword\"\r\n                        },\r\n                        \"test35\": {\r\n                            \"type\": \"keyword\"\r\n                        },\r\n                        \"test34\": {\r\n                            \"type\": \"boolean\"\r\n                        },\r\n                        \"test33\": {\r\n                            \"type\": \"boolean\"\r\n                        },\r\n                        \"test32\": {\r\n                            \"type\": \"double\"\r\n                        },\r\n                        \"test31\": {\r\n                            \"type\": \"double\"\r\n                        },\r\n                        \"test30\": {\r\n                            \"type\": \"keyword\"\r\n                        },\r\n                        \"test29\": {\r\n                            \"type\": \"keyword\"\r\n                        }\r\n                    },\r\n                    \"type\": \"nested\"\r\n                }\r\n            },\r\n            \"type\": \"nested\"\r\n        },\r\n        \"test28\": {\r\n            \"type\": \"double\"\r\n        },\r\n        \"test27\": {\r\n            \"type\": \"double\"\r\n        },\r\n        \"test26\": {\r\n            \"type\": \"boolean\"\r\n        },\r\n        \"test25\": {\r\n            \"type\": \"boolean\"\r\n        },\r\n        \"test24\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test23\": {\r\n            \"index\": false,\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test22\": {\r\n            \"type\": \"short\"\r\n        },\r\n        \"test21\": {\r\n            \"type\": \"short\"\r\n        },\r\n        \"test20\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test19\": {\r\n            \"properties\": {\r\n                \"test18\": {\r\n                    \"type\": \"keyword\"\r\n                },\r\n                \"test17\": {\r\n                    \"type\": \"keyword\"\r\n                },\r\n                \"test16\": {\r\n                    \"type\": \"keyword\"\r\n                }\r\n            },\r\n            \"type\": \"object\"\r\n        },\r\n        \"test15\": {\r\n            \"properties\": {\r\n                \"test14\": {\r\n                    \"index\": false,\r\n                    \"type\": \"keyword\"\r\n                },\r\n                \"test13\": {\r\n                    \"index\": false,\r\n                    \"type\": \"keyword\"\r\n                },\r\n                \"test12\": {\r\n                    \"index\": false,\r\n                    \"type\": \"keyword\"\r\n                }\r\n            },\r\n            \"type\": \"object\"\r\n        },\r\n        \"test11\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test10\": {\r\n            \"type\": \"date\"\r\n        },\r\n        \"test9\": {\r\n            \"type\": \"keyword\"\r\n        },\r\n        \"test8\": {\r\n            \"index\": false,\r\n            \"type\": \"boolean\"\r\n        },\r\n        \"test7\": {\r\n            \"index\": false,\r\n            \"type\": \"double\"\r\n        },\r\n        \"test6\": {\r\n            \"index\": false,\r\n            \"type\": \"double\"\r\n        },\r\n        \"customerRequirements\": {\r\n            \"properties\": {\r\n                \"test5\": {\r\n                    \"index\": false,\r\n                    \"type\": \"double\"\r\n                },\r\n                \"test4\": {\r\n                    \"index\": false,\r\n                    \"type\": \"double\"\r\n                },\r\n                \"test3\": {\r\n                    \"index\": false,\r\n                    \"type\": \"double\"\r\n                },\r\n                \"test2\": {\r\n                    \"index\": false,\r\n                    \"type\": \"double\"\r\n                },\r\n                \"test1\": {\r\n                    \"index\": false,\r\n                    \"type\": \"double\"\r\n                }\r\n            },\r\n            \"type\": \"object\"\r\n        },\r\n        \"attachment.content\": {\r\n            \"term_vector\": \"with_positions_offsets\",\r\n            \"type\": \"text\"\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n</p>\r\n</details> \r\n\r\n 3. Now you can see that term_vector is not set in \"attachment.content\" in document mapping \r\nbut if you delete index then repeat first step then delete field test6 in the second request and PUT it again and you will see that \"attachment.content\" has term_vector. \r\n\r\n**Provide logs (if relevant)**:\r\n[badshort.log](https://github.com/elastic/elasticsearch/files/4095761/badshort.log)\r\n[good.log](https://github.com/elastic/elasticsearch/files/4095808/good.log)\r\n\r\nIn our system we have more plugins, analysis and version elastic is 7.2 but I reproduced this with pure elastic 7.51 and with 2 simple requests.\r\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}