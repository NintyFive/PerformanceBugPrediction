[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135850479","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-135850479","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":135850479,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTg1MDQ3OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2015-08-28T18:10:33Z","updated_at":"2015-08-28T18:15:28Z","author_association":"MEMBER","body":"An Oracle JVM will warn but not fail if `-XX:+UseCompressedOops` is set and in conflict with the heap size:\n\n```\n13:59:30 [jason:~/src/oops] $ java -Xmx32g -XX:+UseCompressedOops Oops  \nJava HotSpot(TM) 64-Bit Server VM warning: Max heap size too large for Compressed Oops\nHello, oops!\n```\n\nYou can also see how it will be on if you're under the threshold:\n\n```\n14:00:04 [jason:~/src/oops] $ java -Xmx30g -XX:+UseCompressedOops -XX:+UnlockDiagnosticVMOptions -XX:+PrintCompressedOopsMode Oops\nProtected page at the reserved heap base: 0x000000010af80000 / 524288 bytes\nheap address: 0x000000010b000000, size: 30802 MB, Compressed Oops with base: 0x000000010afff000\nHello, oops!\n```\n\nBut not if you're over the threshold:\n\n```\n14:03:12 [jason:~/src/oops] $ java -Xmx32g -XX:+UseCompressedOops -XX:+UnlockDiagnosticVMOptions -XX:+PrintCompressedOopsMode Oops\nJava HotSpot(TM) 64-Bit Server VM warning: Max heap size too large for Compressed Oops\nHello, oops!\n14:03:12 [jason:~/src/oops] $\n```\n\nYou can also see it on with:\n\n```\n14:06:51 [jason:~/src/oops] $ java -Xmx30g -XX:+UseCompressedOops -XX:+PrintFlagsFinal Oops | grep Oops\n     bool UseCompressedOops                        := true            {lp64_product}\n```\n\nAnd by default:\n\n```\n14:06:52 [jason:~/src/oops] $ java -Xmx30g -XX:+PrintFlagsFinal Oops | grep Oops\n     bool UseCompressedOops                        := true            {lp64_product}\n```\n\nBut not if we go over the limit:\n\n```\n14:07:43 [jason:~/src/oops] $ java -Xmx32g -XX:+PrintFlagsFinal Oops | grep Oops\n     bool UseCompressedOops                         = false           {lp64_product}     \n```\n\nEven if we specify the flag:\n\n```\n14:08:23 [jason:~/src/oops] $ java -Xmx32g -XX:+UseCompressedOops -XX:+PrintFlagsFinal Oops | grep Oops\nJava HotSpot(TM) 64-Bit Server VM warning: Max heap size too large for Compressed Oops\n     bool UseCompressedOops                        := false           {lp64_product}  \n```\n\nIn short, I don't think there's anything to do here.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135854130","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-135854130","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":135854130,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTg1NDEzMA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2015-08-28T18:27:04Z","updated_at":"2015-08-28T18:27:04Z","author_association":"CONTRIBUTOR","body":"> In short, I don't think there's anything to do here.\n\nCan we get at `UseCompressedOops` from Java or is that lost to us?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/135994951","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-135994951","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":135994951,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNTk5NDk1MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2015-08-29T14:49:56Z","updated_at":"2015-08-29T14:49:56Z","author_association":"MEMBER","body":"> Can we get at `UseCompressedOops` from Java or is that lost to us?\n\nIt can be obtained from a management bean on the OpenJDK line of JVMs.\n\nThe IBM JVM has a similar concept (compressed pointers below 25 GB heaps) but uses a different flag. I'm not familiar enough with that VM to know kind of introspection is available at runtime (I suspect it's possible, I just don't know).\n\nThat said, I'm just not sure if this is a path that we should go down.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136363211","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136363211","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136363211,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM2MzIxMQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T12:55:38Z","updated_at":"2015-08-31T12:55:38Z","author_association":"CONTRIBUTOR","body":"> That said, I'm just not sure if this is a path that we should go down.\n\nThe trouble with the path we are on is that this is one of the first things you'll want to know when helping people with high memory usage issues. Its not required by any means but its kind of \"advanced\" not to use it. I mean, its one of those things that you want to have tested and profiled before doing in a high traffic environment.\n\nI could see us adding a setting that stopped elasticsearch if it couldn't verify that compressed oops was enabled with a helpful message. The user could disable the setting in elasticsearch.yaml and go on but they'd have to intentionally do it.\n\nThat intentionality is what I'm looking for - right now compressed oops is something we think we rely on but we never test. We even wave our hands at the border. \"Max heap is 30GB\", \"max heap is 31.5GB\", stuff like that. If we had a error or even a warning if we went over the compressed oops boundary then we wouldn't have to be so hand wavy.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136369334","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136369334","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136369334,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM2OTMzNA==","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T13:22:17Z","updated_at":"2015-08-31T13:22:17Z","author_association":"CONTRIBUTOR","body":"> That intentionality is what I'm looking for - right now compressed oops is something we think we rely on but we never test.\n\nWhat relies on this: where are jazillions of objects being created? In most cases at least lucene datastructures are using large byte[] or addressing into memory mapped files.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136371157","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136371157","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136371157,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM3MTE1Nw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T13:28:58Z","updated_at":"2015-08-31T13:28:58Z","author_association":"MEMBER","body":"> That intentionality is what I'm looking for - right now compressed oops is something we think we rely on but we never test. \n\nAre you sure that this is correct?\n\nTo be clear, I think that we merely recommend it as a performance optimization and to avoid heaps getting too large increasing the likelihood of long-running garbage collection cycles destroying the cluster.  But I don't see that as a reason to completely prevent users that think they need very large heaps from having them. And given that, I don't see the need to add configuration complexity to Elasticsearch so that `UseCompressedOops` being disabled is prevented by default.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136372647","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136372647","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136372647,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM3MjY0Nw==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T13:33:18Z","updated_at":"2015-08-31T13:33:18Z","author_association":"CONTRIBUTOR","body":"> What relies on this: where are jazillions of objects being created? In most cases at least lucene datastructures are using large byte[] or addressing into memory mapped files.\n\nI haven't dug into it. Its an old, old bit of advice. Honestly @pickypg will probably know better than I what happens without it.\n\n> > That intentionality is what I'm looking for - right now compressed oops is something we think we rely on but we never test.\n> > Are you sure that this is correct?\n\nI am 100% sure its recommended.\n\n> To be clear, I think that we merely recommend it as a performance optimization and to avoid heaps getting too large increasing the likelihood of long-running garbage collection cycles destroying the cluster. But I don't see that as a reason to completely prevent users that think they need very large heaps from having them.\n\nThat is a good point - if its really just a question of GC pauses then Elasticsearch shouldn't bother checking the flag.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136373043","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136373043","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136373043,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM3MzA0Mw==","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T13:34:25Z","updated_at":"2015-08-31T13:34:25Z","author_association":"MEMBER","body":"Historically, I recommended heaps smaller than 30gb in order to get compression since both ES and Lucene ended up allocating a lot of objects (and non paged ones). It also served as a relatively safe number for not going crazy when it comes to heap size and GC.\n\nNow, many of the data structures, in both Lucene and ES, are properly paged and \"bulked\", and with doc values, this starts to become less of a concern. I wonder how much compressed ops matter now, compared to 2 years ago.\n\nIn general, to me, less than 30gb has been a good number for long GC now days (G1 excluded), so I don't think we need to add this as a flag. We did a lot to improve memory in ES and Lucene, wondering how things like doc values by default, and future improvement will end up our recommendation for heap sizes. For now, it is still safe to say max is 30gb, as we learn more.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136374303","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136374303","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136374303,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM3NDMwMw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T13:40:04Z","updated_at":"2015-08-31T13:40:04Z","author_association":"MEMBER","body":"It seems that we've reached some consensus that we shouldn't add this. I'm going to close this issue unless someone thinks otherwise?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/136374703","html_url":"https://github.com/elastic/elasticsearch/issues/13187#issuecomment-136374703","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13187","id":136374703,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNjM3NDcwMw==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2015-08-31T13:40:50Z","updated_at":"2015-08-31T13:40:50Z","author_association":"CONTRIBUTOR","body":"> It seems that we've reached some consensus that we shouldn't add this. I'm going to close this issue unless someone thinks otherwise?\n\nFine by me.\n","performed_via_github_app":null}]