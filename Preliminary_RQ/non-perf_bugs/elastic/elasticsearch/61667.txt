{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/61667","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61667/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61667/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61667/events","html_url":"https://github.com/elastic/elasticsearch/issues/61667","id":687638141,"node_id":"MDU6SXNzdWU2ODc2MzgxNDE=","number":61667,"title":"SIGSEGV on bulk upsert (10 parallel requests of 10'000 documents each)","user":{"login":"neseleznev","id":6990568,"node_id":"MDQ6VXNlcjY5OTA1Njg=","avatar_url":"https://avatars2.githubusercontent.com/u/6990568?v=4","gravatar_id":"","url":"https://api.github.com/users/neseleznev","html_url":"https://github.com/neseleznev","followers_url":"https://api.github.com/users/neseleznev/followers","following_url":"https://api.github.com/users/neseleznev/following{/other_user}","gists_url":"https://api.github.com/users/neseleznev/gists{/gist_id}","starred_url":"https://api.github.com/users/neseleznev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neseleznev/subscriptions","organizations_url":"https://api.github.com/users/neseleznev/orgs","repos_url":"https://api.github.com/users/neseleznev/repos","events_url":"https://api.github.com/users/neseleznev/events{/privacy}","received_events_url":"https://api.github.com/users/neseleznev/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-08-28T01:08:57Z","updated_at":"2020-08-30T16:09:00Z","closed_at":"2020-08-30T16:08:59Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.9.0 and 7.8.1 (docker images `docker.elastic.co/elasticsearch/elasticsearch:7.9.0` and `...:7.8.1` respectively)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 14.0.1+7 â€• Provided with both docker images\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux ... 5.4.0-42-generic #46-Ubuntu SMP Fri Jul 10 00:24:02 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhile sending bulk upsert requests, fatal error occurs and container dies.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. I was uploading 10_000_000 documents by chunks of 10_000 in parallel 10 threads (1000 chunks overall).\r\nCPU load was around 800% all the time, which is expected, because I assume 10 threads ideally consume 1000% of CPU.\r\n![image](https://user-images.githubusercontent.com/6990568/91509674-9d26b000-e8e3-11ea-8398-1cb95d40bbd7.png)\r\n\r\n 2. Suddenly after ~6mln documents inserted, I faced JVM errors and container stopped\r\n![image](https://user-images.githubusercontent.com/6990568/91509654-926c1b00-e8e3-11ea-9e9f-27294552a45a.png)\r\n\r\n**Logs**:\r\nWith 7.8.1 I faced\r\n![image](https://user-images.githubusercontent.com/6990568/91509716-baf41500-e8e3-11ea-9fd5-32adf5212387.png)\r\n\r\nWith 7.9.0 output was a bit different. First there was logs abiut GC degradation I suppose:\r\n```\r\n{\"type\": \"server\", \"timestamp\": \"2020-08-28T00:48:27,563Z\", \"level\": \"INFO\", \"component\": \"o.e.m.j.JvmGcMonitorService\", \"cluster.name\": \"docker-cluster\", \"node.name\": \"25c1d19a493d\", \"message\": \"[gc][122] overhead, spent [264ms] collecting in the last [1s]\", \"cluster.uuid\": \"UgCEBjasTNWVwFbgCxG6Ew\", \"node.id\": \"6IqB6oKsRJKCu8j_Far2qg\"  }\r\n```\r\nbut then it failed:\r\n![image](https://user-images.githubusercontent.com/6990568/91509722-c47d7d00-e8e3-11ea-8729-3f3c2ebfeb2b.png)\r\n\r\nSame in text:\r\n```\r\n#\r\n# A fatal error has been detected by the Java Runtime Environment:\r\n#\r\n#  SIGSEGV (0xb) at pc=0x00007ff3a4334812, pid=6, tid=182\r\n#\r\n# JRE version: OpenJDK Runtime Environment AdoptOpenJDK (14.0.1+7) (build 14.0.1+7)\r\n# Java VM: OpenJDK 64-Bit Server VM AdoptOpenJDK (14.0.1+7, mixed mode, sharing, tiered, compressed oops, g1 gc, linux-amd64)\r\n# Problematic frame:\r\n# V  [libjvm.so+0x712812]  void G1ScanCardClosure::do_oop_work<unsigned int>(unsigned int*)+0x162\r\n#\r\n# Core dump will be written. Default location: Core dumps may be processed with \"/usr/share/apport/apport %p %s %c %d %P %E\" (or dumping to /usr/share/elasticsearch/core.6)\r\n#\r\n# An error report file with more information is saved as:\r\n# logs/hs_err_pid6.log\r\n#\r\n# If you would like to submit a bug report, please visit:\r\n#   https://github.com/AdoptOpenJDK/openjdk-support/issues\r\n#\r\n```\r\n\r\n__________\r\n\r\nAfter couple of attempts, I successfully inserted all the 10_000_000 documents\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}