{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13727","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13727/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13727/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13727/events","html_url":"https://github.com/elastic/elasticsearch/issues/13727","id":107851618,"node_id":"MDU6SXNzdWUxMDc4NTE2MTg=","number":13727,"title":"Met split-brain issue when the azure vm connection was lost","user":{"login":"OsmondX","id":6813739,"node_id":"MDQ6VXNlcjY4MTM3Mzk=","avatar_url":"https://avatars1.githubusercontent.com/u/6813739?v=4","gravatar_id":"","url":"https://api.github.com/users/OsmondX","html_url":"https://github.com/OsmondX","followers_url":"https://api.github.com/users/OsmondX/followers","following_url":"https://api.github.com/users/OsmondX/following{/other_user}","gists_url":"https://api.github.com/users/OsmondX/gists{/gist_id}","starred_url":"https://api.github.com/users/OsmondX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/OsmondX/subscriptions","organizations_url":"https://api.github.com/users/OsmondX/orgs","repos_url":"https://api.github.com/users/OsmondX/repos","events_url":"https://api.github.com/users/OsmondX/events{/privacy}","received_events_url":"https://api.github.com/users/OsmondX/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-09-23T05:19:14Z","updated_at":"2015-09-23T08:45:09Z","closed_at":"2015-09-23T08:45:08Z","author_association":"NONE","active_lock_reason":null,"body":"Hi all,\n\nRecently we met 3 times split-brain issue of my elasticsearch cluster hold on azure VM.\n\nI have three nodes, each node can be data//master node.  I have set the discovery.zen.minimum_master_nodes to 2 and use azure discovery plugin.\n\nRecently azure often maintain their host machines, this cause the network instability between VMs and also caused split-brain issue for my elasticsearch cluster.\n\nWe found that the node which has already joined in to one master can be forced to rejoin to another master, and then the split-brain issue happened!\n\nFrom the log we can see that:\n    09-22 16:38:27, node1 lost connection.\n    09-22 16:45:15, node2 lost connection, node 3 became master(node1 has recovered)\n    09-22 16:45:24, node3 lost connection, node 2 became master.\n    09-22 16:45:43, node3 recovered and became master again!.\n\nBelow is the error or warns for these three nodes when is split-brain issue happened:\n##### Node1(search-prod-wus1):\n\n[2015-09-22 16:45:15,618][INFO ][cluster.service          ] [caps-prod-wus1] master {new [caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]], previous [caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]]}, removed {[caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]],}, reason: zen-disco-receive(from master [[caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]]])\n[2015-09-22 16:45:20,566][WARN ][index.store              ] [caps-prod-wus1] [32c3c289eef54e42be5913a63dfd280a][2] Can't open file to read checksums\njava.io.FileNotFoundException: No such file [_89i0_es090_0.doc]\n[2015-09-22 16:45:21,019][WARN ][index.store              ] [caps-prod-wus1] [32c3c289eef54e42be5913a63dfd280a][2] Can't open file to read checksums\njava.io.FileNotFoundException: No such file [_89i0_es090_0.doc]\n[2015-09-22 16:45:24,364][INFO ][cluster.service          ] [caps-prod-wus1] master {new [caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]], previous [caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]]}, removed {[caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]],}, added {[caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]],}, reason: zen-disco-receive(from master [[caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]]])\n[2015-09-22 16:45:43,059][INFO ][cluster.service          ] [caps-prod-wus1] master {new [caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]], previous [caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]]}, removed {[caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]],}, added {[caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]],}, reason: zen-disco-receive(from master [[caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]]])\n#### Nodes(search-prod-wus2):\n\n[2015-09-22 16:38:37,162][WARN ][action.index             ] [caps-prod-wus2] Failed to perform index on remote replica [caps-prod-wus1][vcBwbCeJTQ61Mw2aOqaflg][search-prod-wbp][inet[/10.3.0.5:9300]][32c3c289eef54e42be5913a63dfd280a][3]\norg.elasticsearch.transport.NodeDisconnectedException: [caps-prod-wus1][inet[/10.3.0.5:9300]][index/replica] disconnected\n[2015-09-22 16:38:37,162][WARN ][cluster.action.shard     ] [caps-prod-wus2] [32c3c289eef54e42be5913a63dfd280a][3] sending failed shard for [32c3c289eef54e42be5913a63dfd280a][3], node[vcBwbCeJTQ61Mw2aOqaflg], [R], s[STARTED], indexUUID [vLXa7OmETyGPGrI82L4SVg], reason [Failed to perform [index] on replica, message [NodeDisconnectedException[[caps-prod-wus1][inet[/10.3.0.5:9300]][index/replica] disconnected]]]\n[2015-09-22 16:38:37,162][WARN ][action.index             ] [caps-prod-wus2] Failed to perform index on remote replica [caps-prod-wus1][vcBwbCeJTQ61Mw2aOqaflg][search-prod-wbp][inet[/10.3.0.5:9300]][32c3c289eef54e42be5913a63dfd280a][3]\norg.elasticsearch.transport.SendRequestTransportException: [caps-prod-wus1][inet[/10.3.0.5:9300]][index/replica]\n[2015-09-22 16:38:37,162][WARN ][cluster.action.shard     ] [caps-prod-wus2] [32c3c289eef54e42be5913a63dfd280a][3] sending failed shard for [32c3c289eef54e42be5913a63dfd280a][3], node[vcBwbCeJTQ61Mw2aOqaflg], [R], s[STARTED], indexUUID [vLXa7OmETyGPGrI82L4SVg], reason [Failed to perform [index] on replica, message [SendRequestTransportException[[caps-prod-wus1][inet[/10.3.0.5:9300]][index/replica]]; nested: NodeNotConnectedException[[caps-prod-wus1][inet[/10.3.0.5:9300]] Node not connected]; ]]\n\n[2015-09-22 16:45:24,005][INFO ][cluster.service          ] [caps-prod-wus2] removed {[caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]],}, reason: zen-disco-node_failed([caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]]), reason transport disconnected (with verified connect)\n#### Node3(search-prod-wus3):\n\n[2015-09-22 16:38:38,677][WARN ][action.index             ] [caps-prod-wus3] Failed to perform index on remote replica [caps-prod-wus1][vcBwbCeJTQ61Mw2aOqaflg][search-prod-wbp][inet[/10.3.0.5:9300]][32c3c289eef54e42be5913a63dfd280a][2]\norg.elasticsearch.transport.SendRequestTransportException: [caps-prod-wus1][inet[/10.3.0.5:9300]][index/replica]\n[2015-09-22 16:45:15,156][INFO ][discovery.azure          ] [caps-prod-wus3] master_left [[caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]]], reason [transport disconnected (with verified connect)]\n[2015-09-22 16:45:15,156][INFO ][cluster.service          ] [caps-prod-wus3] master {new [caps-prod-wus3][qQYWMttZScaqbAfBPkV5gw][search-prod-wbu][inet[/10.3.0.6:9300]], previous [caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]]}, removed {[caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]],}, reason: zen-disco-master_failed ([caps-prod-wus2][9v_FW_4AQ7KQ4fA5CLPdTg][search-prod-wus][inet[/10.3.0.4:9300]])\n\n[2015-09-22 16:45:43,126][WARN ][index.store              ] [caps-prod-wus3] [0222d67c4146405497a70df65629e634][0] Can't open file to read checksums\njava.io.FileNotFoundException: No such file [_3app.fdt]\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}