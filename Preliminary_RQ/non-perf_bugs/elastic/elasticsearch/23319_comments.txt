[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/281923022","html_url":"https://github.com/elastic/elasticsearch/issues/23319#issuecomment-281923022","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23319","id":281923022,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MTkyMzAyMg==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-23T08:07:45Z","updated_at":"2017-02-23T08:07:45Z","author_association":"CONTRIBUTOR","body":"You are not counting the same thing in both cases. In the `hits` section, you are counting root documents while in the `aggs` section you are counting the number of nested documents under the `product.brand` path. If you want counts to be comparable, you need to use a [reverse nested](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-reverse-nested-aggregation.html) aggregation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/282530600","html_url":"https://github.com/elastic/elasticsearch/issues/23319#issuecomment-282530600","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23319","id":282530600,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MjUzMDYwMA==","user":{"login":"neoform","id":3719298,"node_id":"MDQ6VXNlcjM3MTkyOTg=","avatar_url":"https://avatars3.githubusercontent.com/u/3719298?v=4","gravatar_id":"","url":"https://api.github.com/users/neoform","html_url":"https://github.com/neoform","followers_url":"https://api.github.com/users/neoform/followers","following_url":"https://api.github.com/users/neoform/following{/other_user}","gists_url":"https://api.github.com/users/neoform/gists{/gist_id}","starred_url":"https://api.github.com/users/neoform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neoform/subscriptions","organizations_url":"https://api.github.com/users/neoform/orgs","repos_url":"https://api.github.com/users/neoform/repos","events_url":"https://api.github.com/users/neoform/events{/privacy}","received_events_url":"https://api.github.com/users/neoform/received_events","type":"User","site_admin":false},"created_at":"2017-02-26T03:43:53Z","updated_at":"2017-02-26T03:43:53Z","author_association":"NONE","body":"I do apologize if this isn't a bug, but I'm at a complete loss as to why the results seem so inconsistent, since everything I've read has suggested they should indeed match (and in some cases, they do match... just not most cases). \r\n\r\n```javascript\r\n{\r\n  \"size\": 0,\r\n  \"_source\": false,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"nested\": {\r\n            \"path\": \"product\",\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"filter\": [\r\n                  {\r\n                    \"term\": {\r\n                      \"product.status_id\": 1\r\n                    }\r\n                  },\r\n                  {\r\n                    \"nested\": {\r\n                      \"path\": \"product.brand\",\r\n                      \"query\": {\r\n                        \"bool\": {\r\n                          \"filter\": [\r\n                            {\r\n                              \"term\": {\r\n                                \"product.brand.id\": 23107 <-- additional product.brand.id filter\r\n                              }\r\n                            }\r\n                          ]\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            }\r\n          }\r\n        }\r\n    ]\r\n  }\r\n},\r\n\"aggs\": {\r\n  \"brands\": {\r\n    \"global\": {}, <---- global scope\r\n      \"aggs\": {\r\n        \"brands\": {\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"nested\": {\r\n                    \"path\": \"product\",\r\n                    \"query\": {\r\n                      \"bool\": {\r\n                        \"filter\": [\r\n                          {\r\n                            \"term\": {\r\n                              \"product.status_id\": 1 <-- same filter as above minus product.brand.id\r\n                            }\r\n                          }\r\n                        ]\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"brands\": {\r\n              \"nested\": {\r\n                \"path\": \"product.brand\"\r\n              },\r\n              \"aggs\": {\r\n                \"brands\": {\r\n                  \"terms\": {\r\n                    \"field\": \"product.brand.id\",\r\n                    \"size\": 5\r\n                  },\r\n                  \"aggs\": {\r\n                    \"brands\": {\r\n                      \"reverse_nested\": {} <-- get root doc count\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\n{\r\n  \"took\": 226,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 2890, <-- doc count\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"brands\": {\r\n      \"doc_count\": 1354323,\r\n      \"brands\": {\r\n        \"doc_count\": 442506,\r\n        \"brands\": {\r\n          \"doc_count\": 500478,\r\n          \"brands\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 465820,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": 11317,\r\n                \"doc_count\": 9877,\r\n                \"brands\": {\r\n                  \"doc_count\": 9877\r\n                }\r\n              },\r\n              {\r\n                \"key\": 28221,\r\n                \"doc_count\": 6805,\r\n                \"brands\": {\r\n                  \"doc_count\": 6805\r\n                }\r\n              },\r\n              {\r\n                \"key\": 40330,\r\n                \"doc_count\": 6243,\r\n                \"brands\": {\r\n                  \"doc_count\": 6243\r\n                }\r\n              },\r\n              {\r\n                \"key\": 23107, <--- same product.brand.id as used in main query\r\n                \"doc_count\": 6132,\r\n                \"brands\": {\r\n                  \"doc_count\": 2948 <--- main query doc count is 2890\r\n                }\r\n              },\r\n              {\r\n                \"key\": 23083,\r\n                \"doc_count\": 5601,\r\n                \"brands\": {\r\n                  \"doc_count\": 5599\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/282660740","html_url":"https://github.com/elastic/elasticsearch/issues/23319#issuecomment-282660740","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23319","id":282660740,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MjY2MDc0MA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-27T08:48:33Z","updated_at":"2017-02-27T08:48:33Z","author_association":"CONTRIBUTOR","body":"In the aggregation, you are filtering on root documents that have at least one product that has `1` as a `product.status_id`, but you do not filter out other products. So if a root document has at least 1 product that matches `product.status_id:1`, then the aggregation will run on all products, not only those that match.\r\n\r\nThis happens because you filter before doing the nested aggregation on `product`. You should do the nested aggregation on product first and then filter if you want to fix it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/282895076","html_url":"https://github.com/elastic/elasticsearch/issues/23319#issuecomment-282895076","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23319","id":282895076,"node_id":"MDEyOklzc3VlQ29tbWVudDI4Mjg5NTA3Ng==","user":{"login":"neoform","id":3719298,"node_id":"MDQ6VXNlcjM3MTkyOTg=","avatar_url":"https://avatars3.githubusercontent.com/u/3719298?v=4","gravatar_id":"","url":"https://api.github.com/users/neoform","html_url":"https://github.com/neoform","followers_url":"https://api.github.com/users/neoform/followers","following_url":"https://api.github.com/users/neoform/following{/other_user}","gists_url":"https://api.github.com/users/neoform/gists{/gist_id}","starred_url":"https://api.github.com/users/neoform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neoform/subscriptions","organizations_url":"https://api.github.com/users/neoform/orgs","repos_url":"https://api.github.com/users/neoform/repos","events_url":"https://api.github.com/users/neoform/events{/privacy}","received_events_url":"https://api.github.com/users/neoform/received_events","type":"User","site_admin":false},"created_at":"2017-02-27T23:46:29Z","updated_at":"2017-02-27T23:46:29Z","author_association":"NONE","body":"I'm at a loss as to what the agg query should look like then, since I get the \"Child query must not match same docs with parent filter. Combine them as must clauses (+) to find a problem doc.\" error when I move the filters into nested aggs...","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283002727","html_url":"https://github.com/elastic/elasticsearch/issues/23319#issuecomment-283002727","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23319","id":283002727,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzAwMjcyNw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-02-28T10:29:43Z","updated_at":"2017-02-28T10:29:43Z","author_association":"CONTRIBUTOR","body":"Can you try this?\r\n\r\n```json\r\nGET _search\r\n{\r\n  \"size\": 0,\r\n  \"_source\": false,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"nested\": {\r\n            \"path\": \"product\",\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"filter\": [\r\n                  {\r\n                    \"term\": {\r\n                      \"product.status_id\": 1\r\n                    }\r\n                  },\r\n                  {\r\n                    \"nested\": {\r\n                      \"path\": \"product.brand\",\r\n                      \"query\": {\r\n                        \"bool\": {\r\n                          \"filter\": [\r\n                            {\r\n                              \"term\": {\r\n                                \"product.brand.id\": 23107\r\n                              }\r\n                            }\r\n                          ]\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"brands\": {\r\n      \"global\": {},\r\n      \"aggs\": {\r\n        \"brands\": {\r\n          \"nested\": {\r\n            \"path\": \"product\"\r\n          },\r\n          \"aggs\": {\r\n            \"brands\": {\r\n              \"filter\": {\r\n                \"term\": {\r\n                  \"product.status_id\": 1\r\n                }\r\n              },\r\n              \"aggs\": {\r\n                \"brands\": {\r\n                  \"nested\": {\r\n                    \"path\": \"product.brand\"\r\n                  },\r\n                  \"aggs\": {\r\n                    \"brands\": {\r\n                      \"terms\": {\r\n                        \"field\": \"product.brand.id\",\r\n                        \"size\": 5\r\n                      },\r\n                      \"aggs\": {\r\n                        \"brands\": {\r\n                          \"reverse_nested\": {}\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283030772","html_url":"https://github.com/elastic/elasticsearch/issues/23319#issuecomment-283030772","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23319","id":283030772,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzAzMDc3Mg==","user":{"login":"neoform","id":3719298,"node_id":"MDQ6VXNlcjM3MTkyOTg=","avatar_url":"https://avatars3.githubusercontent.com/u/3719298?v=4","gravatar_id":"","url":"https://api.github.com/users/neoform","html_url":"https://github.com/neoform","followers_url":"https://api.github.com/users/neoform/followers","following_url":"https://api.github.com/users/neoform/following{/other_user}","gists_url":"https://api.github.com/users/neoform/gists{/gist_id}","starred_url":"https://api.github.com/users/neoform/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neoform/subscriptions","organizations_url":"https://api.github.com/users/neoform/orgs","repos_url":"https://api.github.com/users/neoform/repos","events_url":"https://api.github.com/users/neoform/events{/privacy}","received_events_url":"https://api.github.com/users/neoform/received_events","type":"User","site_admin":false},"created_at":"2017-02-28T12:50:56Z","updated_at":"2017-02-28T12:50:56Z","author_association":"NONE","body":"Wow, ok that actually makes sense. And the values are correct now. Thank you.","performed_via_github_app":null}]