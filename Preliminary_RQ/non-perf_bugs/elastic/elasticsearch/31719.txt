{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31719","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31719/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31719/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31719/events","html_url":"https://github.com/elastic/elasticsearch/issues/31719","id":337415462,"node_id":"MDU6SXNzdWUzMzc0MTU0NjI=","number":31719,"title":"Unable to access doc values by using expression script within nested aggregated top_hits.","user":{"login":"bhagat95","id":10414935,"node_id":"MDQ6VXNlcjEwNDE0OTM1","avatar_url":"https://avatars1.githubusercontent.com/u/10414935?v=4","gravatar_id":"","url":"https://api.github.com/users/bhagat95","html_url":"https://github.com/bhagat95","followers_url":"https://api.github.com/users/bhagat95/followers","following_url":"https://api.github.com/users/bhagat95/following{/other_user}","gists_url":"https://api.github.com/users/bhagat95/gists{/gist_id}","starred_url":"https://api.github.com/users/bhagat95/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bhagat95/subscriptions","organizations_url":"https://api.github.com/users/bhagat95/orgs","repos_url":"https://api.github.com/users/bhagat95/repos","events_url":"https://api.github.com/users/bhagat95/events{/privacy}","received_events_url":"https://api.github.com/users/bhagat95/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-07-02T08:24:11Z","updated_at":"2018-08-13T16:13:20Z","closed_at":"2018-08-13T16:13:20Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 5.4.1\r\n\r\n**JVM version** (`java -version`): 1.8.0_131\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): 6.1 (Windows Server)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nUnable to access doc values by using expression script within nested aggregated top_hits. It works fine if I remove parent aggregation(dealers)/ change script `lang `to painless.\r\n\r\n**Steps to reproduce**:\r\n\r\nIndex structure:\r\n```\r\n     {\r\n        \"_index\": \"stockv21\",\r\n        \"_type\": \"stock\",\r\n        \"_id\": \"D1422435\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          ...\r\n           \"dealerId\": \"D2345\"\r\n           \"lattitude\": 68255.9964,\r\n           \"longitude\": 262151.9964\r\n         }\r\n        ...\r\n     }\r\n```\r\n\r\n\r\nQuery:\r\n```\r\nGET stock/_search\r\n{\r\n  \"from\": 0,\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"dealers\": {\r\n      \"terms\": {\r\n          \"field\":\"dealerId\"\r\n      },\r\n      \"aggs\": {\r\n        \"stocks\": {\r\n          \"top_hits\": {\r\n                 \"sort\": [\r\n                      {\r\n                         \"_script\": {\r\n                            \"type\": \"number\",\r\n                            \"script\": {\r\n                               \"lang\": \"expression\",\r\n                               \"inline\": \"doc['longitude'].value\"\r\n                            }\r\n                         }\r\n                      }\r\n                 ]\r\n              }\r\n          }\r\n      }\r\n    }\r\n  }\r\n```\r\n\r\nOutput:\r\n```\r\n{\r\n   \"error\": {\r\n      \"root_cause\": [\r\n         {\r\n            \"type\": \"null_pointer_exception\",\r\n            \"reason\": null\r\n         }\r\n      ],\r\n      \"type\": \"search_phase_execution_exception\",\r\n      \"reason\": \"all shards failed\",\r\n      \"phase\": \"query\",\r\n      \"grouped\": true,\r\n      \"failed_shards\": [\r\n         {\r\n            \"shard\": 0,\r\n            \"index\": \"stockv21\",\r\n            \"node\": \"93Y1YbqaRVG8J3kuLnc5ow\",\r\n            \"reason\": {\r\n               \"type\": \"null_pointer_exception\",\r\n               \"reason\": null\r\n            }\r\n         }\r\n      ]\r\n   },\r\n   \"status\": 500\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\norg.elasticsearch.transport.RemoteTransportException: [93Y1Ybq][172.16.0.11:9300][indices:data/read/search[phase/query]]\r\nCaused by: java.lang.NullPointerException\r\n[2018-07-02T14:50:17,461][DEBUG][o.e.a.s.TransportSearchAction] [93Y1Ybq] [stagingstockv21][2], node[93Y1YbqaRVG8J3kuLnc5ow], [P], s[STARTED], a[id=ISv9ED1-TpecavcZ_PA84g]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[stagingstock], indicesOptions=IndicesOptions[id=38, ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_alisases_to_multiple_indices=true, forbid_closed_indices=true], types=[], routing='null', preference='null', requestCache=null, scroll=null, source={\r\n  \"aggregations\" : {\r\n    \"dealers\" : {\r\n      \"terms\" : {\r\n        \"field\" : \"dealerId\",\r\n        \"size\" : 4,\r\n        \"min_doc_count\" : 1,\r\n        \"shard_min_doc_count\" : 0,\r\n        \"show_term_doc_count_error\" : false,\r\n        \"order\" : [\r\n          {\r\n            \"_count\" : \"desc\"\r\n          },\r\n          {\r\n            \"_term\" : \"asc\"\r\n          }\r\n        ]\r\n      },\r\n      \"aggregations\" : {\r\n        \"stocks\" : {\r\n          \"top_hits\" : {\r\n            \"from\" : 0,\r\n            \"size\" : 4,\r\n            \"version\" : false,\r\n            \"explain\" : false,\r\n            \"sort\" : [\r\n              {\r\n                \"_script\" : {\r\n                  \"script\" : {\r\n                    \"inline\" : \"doc['longitude'].value\",\r\n                    \"lang\" : \"expression\"\r\n                  },\r\n                  \"type\" : \"number\",\r\n                  \"order\" : \"asc\"\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}}]\r\norg.elasticsearch.transport.RemoteTransportException: [93Y1Ybq][172.16.0.11:9300][indices:data/read/search[phase/query]]\r\nCaused by: java.lang.NullPointerException\r\n[2018-07-02T14:50:17,461][DEBUG][o.e.a.s.TransportSearchAction] [93Y1Ybq] All shards failed for phase: [query]\r\norg.elasticsearch.ElasticsearchException$1: null\r\n\tat org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:618) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:126) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:241) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:87) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:47) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$1.onFailure(InitialSearchPhase.java:155) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1050) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1154) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1132) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$7.onFailure(TransportService.java:638) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:623) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\nCaused by: java.lang.NullPointerException\r\n[2018-07-02T14:50:17,465][WARN ][r.suppressed             ] path: /stagingstock/_search, params: {index=stagingstock}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:272) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:130) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:241) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:87) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:47) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$1.onFailure(InitialSearchPhase.java:155) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1050) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1154) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1132) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.transport.TransportService$7.onFailure(TransportService.java:638) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:623) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\nCaused by: org.elasticsearch.ElasticsearchException$1\r\n\tat org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:618) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.SearchPhaseExecutionException.guessRootCauses(SearchPhaseExecutionException.java:170) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.SearchPhaseExecutionException.getCause(SearchPhaseExecutionException.java:111) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:139) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:122) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.impl.MutableLogEvent.getThrownProxy(MutableLogEvent.java:338) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.pattern.ExtendedThrowablePatternConverter.format(ExtendedThrowablePatternConverter.java:63) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.pattern.PatternFormatter.format(PatternFormatter.java:38) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.layout.PatternLayout$PatternSerializer.toSerializable(PatternLayout.java:333) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.layout.PatternLayout.toText(PatternLayout.java:232) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:217) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:57) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.directEncodeEvent(AbstractOutputStreamAppender.java:177) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.tryAppend(AbstractOutputStreamAppender.java:170) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:161) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:156) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:129) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:120) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:448) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:433) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:417) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:403) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:63) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.core.Logger.logMessage(Logger.java:146) [log4j-core-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.spi.ExtendedLoggerWrapper.logMessage(ExtendedLoggerWrapper.java:217) [log4j-api-2.8.2.jar:2.8.2]\r\n\tat org.elasticsearch.common.logging.PrefixLogger.logMessage(PrefixLogger.java:67) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2091) [log4j-api-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:1983) [log4j-api-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1845) [log4j-api-2.8.2.jar:2.8.2]\r\n\tat org.apache.logging.log4j.spi.AbstractLogger.warn(AbstractLogger.java:2546) [log4j-api-2.8.2.jar:2.8.2]\r\n\tat org.elasticsearch.rest.BytesRestResponse.build(BytesRestResponse.java:139) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:101) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:92) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.rest.action.RestActionListener.onFailure(RestActionListener.java:58) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.support.TransportAction$1.onFailure(TransportAction.java:94) [elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.raisePhaseFailure(AbstractSearchAsyncAction.java:220) [elasticsearch-5.4.1.jar:5.4.1]\r\n\t... 16 more\r\nCaused by: java.lang.NullPointerException","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}