{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10071","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10071/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10071/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10071/events","html_url":"https://github.com/elastic/elasticsearch/issues/10071","id":60791078,"node_id":"MDU6SXNzdWU2MDc5MTA3OA==","number":10071,"title":"Bug when fvh highlighting a phrase query on an ngrammed field","user":{"login":"bsander","id":517850,"node_id":"MDQ6VXNlcjUxNzg1MA==","avatar_url":"https://avatars1.githubusercontent.com/u/517850?v=4","gravatar_id":"","url":"https://api.github.com/users/bsander","html_url":"https://github.com/bsander","followers_url":"https://api.github.com/users/bsander/followers","following_url":"https://api.github.com/users/bsander/following{/other_user}","gists_url":"https://api.github.com/users/bsander/gists{/gist_id}","starred_url":"https://api.github.com/users/bsander/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bsander/subscriptions","organizations_url":"https://api.github.com/users/bsander/orgs","repos_url":"https://api.github.com/users/bsander/repos","events_url":"https://api.github.com/users/bsander/events{/privacy}","received_events_url":"https://api.github.com/users/bsander/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2015-03-12T09:26:12Z","updated_at":"2016-11-24T19:21:35Z","closed_at":"2016-11-24T19:21:35Z","author_association":"NONE","active_lock_reason":null,"body":"Not really sure how to accurately describe this bug. I've narrowed it down to a combination of the following elements:\n- Fast Vector Highligter\n- Phrase query with slop\n- Performing a search where at least one of the words is a prefix of another word in the query (in the case below: `in` and `internet`.\n\nSteps to reproduce:\n\n``` bash\n#1. Create index with mapping\ncurl -XPUT \"http://localhost:9200/bugtest\" -d'\n{\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"suggest_analyzer\": {\n          \"type\": \"custom\",\n          \"tokenizer\": \"my_edgeNgram\",\n          \"filter\": [\n            \"lowercase\"\n          ]\n        }\n      },\n      \"tokenizer\": {\n        \"my_edgeNgram\": {\n          \"type\": \"edgeNGram\",\n          \"min_gram\": 1,\n          \"max_gram\": 20,\n          \"token_chars\": [\n            \"letter\"\n          ]\n        }\n      }\n    }\n  },\n  \"mappings\": {\n    \"case\": {\n      \"properties\": {\n        \"text\": {\n          \"type\": \"string\",\n          \"term_vector\": \"with_positions_offsets\",\n          \"index_analyzer\": \"suggest_analyzer\",\n          \"search_analyzer\": \"simple\"\n        }\n      }\n    }\n  }\n}'\n\n#2. Put a document in it that will match the query\ncurl -XPUT \"http://localhost:9200/bugtest/case/1\" -d'\n{\n  \"text\": \"Something is happening in the internet..\"\n}'\n\n#3. Perform a highlighted phrase query where the first token is a prefix of the second\ncurl -XPOST \"http://localhost:9200/bugtest/_search\" -d'\n{\n  \"query\": {\n    \"match\": {\n      \"text\": {\n        \"query\": \"in internet\",\n        \"type\": \"phrase\",\n        \"slop\": 50\n      }\n    }\n  },\n  \"fields\": [],\n  \"highlight\": {\n    \"fields\": {\n      \"text\": {}\n    }\n  }\n}'\n```\n\nThis results in the following error on es 1.4.4:\n\n``` json\n{\n   \"took\": 2,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 4,\n      \"failed\": 1,\n      \"failures\": [\n         {\n            \"index\": \"bugtest\",\n            \"shard\": 2,\n            \"status\": 500,\n            \"reason\": \"FetchPhaseExecutionException[[bugtest][2]: query[text:\\\"in internet\\\"~50],from[0],size[10]: Fetch Failed [Failed to highlight field [text]]]; nested: StringIndexOutOfBoundsException[String index out of range: -2]; \"\n         }\n      ]\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 0.039147545,\n      \"hits\": []\n   }\n}\n```\n\nAs said, this only happens when a search is performed where the first word is a prefix of the second. When I change the query just one letter to `is internet` everything works as expected.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}