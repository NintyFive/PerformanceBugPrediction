{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5458","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5458/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5458/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5458/events","html_url":"https://github.com/elastic/elasticsearch/issues/5458","id":29694758,"node_id":"MDU6SXNzdWUyOTY5NDc1OA==","number":5458,"title":"filtering aggregations ","user":{"login":"jxstanford","id":787382,"node_id":"MDQ6VXNlcjc4NzM4Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/787382?v=4","gravatar_id":"","url":"https://api.github.com/users/jxstanford","html_url":"https://github.com/jxstanford","followers_url":"https://api.github.com/users/jxstanford/followers","following_url":"https://api.github.com/users/jxstanford/following{/other_user}","gists_url":"https://api.github.com/users/jxstanford/gists{/gist_id}","starred_url":"https://api.github.com/users/jxstanford/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jxstanford/subscriptions","organizations_url":"https://api.github.com/users/jxstanford/orgs","repos_url":"https://api.github.com/users/jxstanford/repos","events_url":"https://api.github.com/users/jxstanford/events{/privacy}","received_events_url":"https://api.github.com/users/jxstanford/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2014-03-18T23:25:12Z","updated_at":"2016-02-25T12:50:51Z","closed_at":"2014-07-24T14:39:43Z","author_association":"NONE","active_lock_reason":null,"body":"When doing a nested aggregation against a specific doc type, and with a filter of a specific doc type, the results still return unfiltered results.  Here's an example:\n\n```\nPOST _all/summary_phys/_search\n{\n  \"aggs\": {\n    \"summary_phys_events\": {\n      \"filter\": {\n        \"type\": {\"value\": \"summary_phys\"}\n      },\n      \"aggs\": {\n        \"events_by_date\": {\n          \"date_histogram\": {\n            \"field\": \"@timestamp\",\n            \"interval\": \"300s\",\n            \"min_doc_count\": 0\n          },\n          \"aggs\": {\n            \"events_by_host\": {\n              \"terms\": {\n                \"field\": \"host.raw\",\n                \"min_doc_count\": 0\n              },\n              \"aggs\": {\n                \"avg_used\": {\n                  \"avg\": {\n                    \"field\": \"used\"\n                  }\n                },\n                \"max_used\": {\n                  \"max\": {\n                    \"field\": \"used\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nI get buckets with entries matching hosts that do not show up in this doc type.  For example, I have only 3 values for host in this doc type [compute-4, compute-2, compute-3], but I will get buckets back with hosts from other doc types like:\n\n```\n\"events_by_host\": {\n                  \"buckets\": [\n                     {\n                        \"key\": \"compute-4\",\n                        \"doc_count\": 11,\n                        \"max_used\": {\n                           \"value\": 4608\n                        },\n                        \"avg_used\": {\n                           \"value\": 3677.090909090909\n                        }\n                     },\n                     {\n                        \"key\": \"compute-2\",\n                        \"doc_count\": 8,\n                        \"max_used\": {\n                           \"value\": 4608\n                        },\n                        \"avg_used\": {\n                           \"value\": 2304\n                        }\n                     },\n                     {\n                        \"key\": \"compute-3\",\n                        \"doc_count\": 2,\n                        \"max_used\": {\n                           \"value\": 4608\n                        },\n                        \"avg_used\": {\n                           \"value\": 4608\n                        }\n                     },\n                     {\n                        \"key\": \"10.10.11.22:49509\",\n                        \"doc_count\": 0,\n                        \"max_used\": {\n                           \"value\": null\n                        },\n                        \"avg_used\": {\n                           \"value\": null\n                        }\n                     },\n                     {\n                        \"key\": \"controller\",\n                        \"doc_count\": 0,\n                        \"max_used\": {\n                           \"value\": null\n                        },\n                        \"avg_used\": {\n                           \"value\": null\n                        }\n                     },\n                     {\n                        \"key\": \"object-1\",\n                        \"doc_count\": 0,\n                        \"max_used\": {\n                           \"value\": null\n                        },\n                        \"avg_used\": {\n                           \"value\": null\n                        }\n                     }\n                  ]\n            }\n```\n\nI believe that the extra hosts should be picked up by the aggregation filter if not by the URL path.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}