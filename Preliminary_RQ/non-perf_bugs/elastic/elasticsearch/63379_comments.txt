[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704706131","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704706131","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704706131,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDcwNjEzMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T05:41:46Z","updated_at":"2020-10-07T05:41:46Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704706784","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704706784","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704706784,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDcwNjc4NA==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T05:43:46Z","updated_at":"2020-10-07T05:43:46Z","author_association":"CONTRIBUTOR","body":"I'm going to mute `testDeleteExpiredDataNoThrottle` on master and 7.x\r\n\r\n`testDeleteExpiredDataWithStandardThrottle` seems to be OK (despite being the test that was recently unmuted in #63134)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704781965","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704781965","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704781965,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDc4MTk2NQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T08:32:02Z","updated_at":"2020-10-07T08:32:02Z","author_association":"CONTRIBUTOR","body":"This failed once last week with the dreaded \"All shards failed\".  But that is very intermittent and didn't cause a timeout.\r\n\r\nThe first timeout occurred in the [1st PR build](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-2/9901/) of #63349.  In fact it took 5 attempts ([2nd failure](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-2/9910/), [3rd failure](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-2/9917/), [4th failure](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-2/9931/)) at rerunning the PR CI to get green checks, and all the PR CI failures were for this same test.  Then after that PR was merged there have been masses of failures.  The first failure on master was in the intake build of [#63349](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob+fast+part2/2440/).\r\n\r\nSo, although it seems bizarre, something in Lucene 8.7.0-snapshot-66c49a35402 seems to be causing this.  It may still be something bad the ML code is doing that Lucene now takes offence at, but there's definitely an interaction.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704810709","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704810709","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704810709,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDgxMDcwOQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T09:24:41Z","updated_at":"2020-10-07T09:24:41Z","author_association":"CONTRIBUTOR","body":"The code that's locking up in the test client is this:\r\n\r\n```\r\n        SearchResponse searchResponse;\r\n        if (scrollId == null) {\r\n            searchResponse = initScroll();\r\n        } else {\r\n            SearchScrollRequest searchScrollRequest = new SearchScrollRequest(scrollId).scroll(CONTEXT_ALIVE_DURATION);\r\n            searchResponse = client.searchScroll(searchScrollRequest).actionGet(); // <-- lockup here\r\n        }\r\n```\r\n\r\nSo it's continuing a scroll that's different to before.  Since these are external cluster tests I need to look separately at what's happening server side when this happens.  There are no error messages in the server-side logs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704866041","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704866041","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704866041,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDg2NjA0MQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T11:14:34Z","updated_at":"2020-10-07T11:14:34Z","author_association":"CONTRIBUTOR","body":"@droberts195  Sorry for the trouble. We have fixed a bug in Lucene, and currently building a new Lucene snapshot for ugprade.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704866262","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704866262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704866262,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDg2NjI2Mg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T11:15:00Z","updated_at":"2020-10-07T11:15:00Z","author_association":"CONTRIBUTOR","body":"I watched this going wrong on my laptop and my best guess would be that the scroll goes into an infinite loop, thinking it's never finished.\r\n\r\nDuring the 20 minute timeout 2 JVMs burn a lot of CPU:\r\n\r\n```\r\n4576  java         72.0 08:12.28 139/1  1    445   881M   0B    0B   4099 4099 running  *0[1]          0.00000 0.00000    512  291423   1066  39644     19752\r\n4700  java         47.7 04:56.94 107    1    346   639M+  0B    0B   4099 4099 sleeping *0[1]          0.00000 0.00000    512  215442+  434   23041+    11486+\r\n```\r\n\r\nIn that example PID 4576 is one of the 3 external cluster nodes and PID 4700 is the test client.  So there's actually a lot of back-and-forth of communications between client and server even though the client appeared deadlocked from just looking at the Gradle scan.\r\n\r\nThere is no deadlock on the server side.  Sometimes you can see evidence of the search taking place on the server side, e.g.:\r\n\r\n```\r\n\"elasticsearch[javaRestTest-1][search][T#11]\" #103 daemon prio=5 os_prio=31 cpu=936.73ms elapsed=121.17s tid=0x00007f91d3d0a800 nid=0x1ef03 runnable  [0x000070000cdc4000]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at org.elasticsearch.search.query.QueryPhase.searchWithCollector(QueryPhase.java:336)\r\n        at org.elasticsearch.search.query.QueryPhase.executeInternal(QueryPhase.java:296)\r\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:148)\r\n        at org.elasticsearch.search.SearchService.lambda$executeFetchPhase$2(SearchService.java:562)\r\n        at org.elasticsearch.search.SearchService$$Lambda$6238/0x00000008012ebc40.get(Unknown Source)\r\n        at org.elasticsearch.search.SearchService$$Lambda$5242/0x000000080110c440.get(Unknown Source)\r\n        at org.elasticsearch.action.ActionRunnable.lambda$supply$0(ActionRunnable.java:58)\r\n        at org.elasticsearch.action.ActionRunnable$$Lambda$5243/0x000000080110c840.accept(Unknown Source)\r\n        at org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44)\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:733)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(java.base@11/ThreadPoolExecutor.java:1128)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(java.base@11/ThreadPoolExecutor.java:628)\r\n        at java.lang.Thread.run(java.base@11/Thread.java:834)\r\n```\r\n\r\nHowever, these stacks appear and disappear during the 20 minutes - there isn't one that locks up.\r\n\r\nSo, it very much looks like some change with the sorting means the scroll never finishes.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/704892979","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-704892979","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":704892979,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDg5Mjk3OQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2020-10-07T12:11:50Z","updated_at":"2020-10-07T13:49:12Z","author_association":"CONTRIBUTOR","body":"The [PR](https://github.com/elastic/elasticsearch/pull/63395) for the  upgrade to the new Lucene snapshot has been merged.  We can run these tests again and see if we can run into the same issue with timeouts. \r\n\r\nThis has been done on master, 7.x  and 7.10 branches.  We can try to enable the tests on these branches.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/720612458","html_url":"https://github.com/elastic/elasticsearch/issues/63379#issuecomment-720612458","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63379","id":720612458,"node_id":"MDEyOklzc3VlQ29tbWVudDcyMDYxMjQ1OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-11-02T17:25:11Z","updated_at":"2020-11-02T17:25:11Z","author_association":"CONTRIBUTOR","body":"This problem was solved by the second Lucene upgrade - closing","performed_via_github_app":null}]