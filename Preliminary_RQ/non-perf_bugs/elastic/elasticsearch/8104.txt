{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8104","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8104/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8104/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8104/events","html_url":"https://github.com/elastic/elasticsearch/issues/8104","id":45956626,"node_id":"MDU6SXNzdWU0NTk1NjYyNg==","number":8104,"title":"Question: shard awareness allocation and shard allocation filtering","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2014-10-16T07:34:05Z","updated_at":"2014-10-16T09:42:37Z","closed_at":"2014-10-16T09:27:37Z","author_association":"NONE","active_lock_reason":null,"body":"We have two kinds of nodes: those with ssds (used for indexing and search recent data), those with large spinning disks (used for archiving old indices).\n\nI'd like to setup a mechanism to move old indices from ssds to spinning disks.\n\nThe first solution uses reroute command in cluster api. However it feels unnatural since you have to do it shard by shard and decide the target node.\n\nWhat I want to achieve is the following:\n1. stick recent indices (the current one being written) to ssds. They have 2 copies.\n2. at some point (disk on ssds is above 65%), one copy is moved to larger boxes (1 copy is still on ssd to help search, 1 copy on large box)\n3. when disk is scarce on ssd boxes (90%), we simply drop the copy present on ssd. Since we don't care that much of old data having only one copy is not an issue.\n\nI have tried to implement this with shard awareness allocation and allocation filtering but it does not seem to work as expected.\n\nNodes have `flavor` attribute depending on their hardware (`ssd` or `iodisk`).\nCluster is using shard awareness based on `flavor` attribute (`cluster.routing.allocation.awareness.attributes: flavor`).\n1. My index template has `routing.allocation.require: ssd` to impose two have all copies on ssds first. \n2. At some point, I drop the requirement (effectively `routing.allocation.require: *``). I expect flavor awareness to move one copy to large (iodisk) boxes.\n3. At a later point, I'll set `number_of_replicas` to 0 and change `routing.allocation.require` to `iodisk` to drop the shard copy on ssds\n\nSadly allocation filtering and shard awareness do not seem to cooperate well :\nwhen an new index is created, one copy goes to ssds and the other is not allocated anywhere (index stays in yellow state).\n\nUsing `curl -XPUT localhost:9200/_cluster/settings -d '{\"transient\":{\"logger.cluster.routing.allocation\":\"trace\"}}'`,\nI have observed what happen when a new index is created.\n\n```\n[2014-10-16 06:53:19,462][TRACE][cluster.routing.allocation.decider] [bungeearchive01-par.storage.criteo.preprod] Can not allocate [[2014-10-16.01][3], node[null], [R], s[UNASSIGNED]] on node [qK34VLdhTferCQs2oNJOyg] due to [SameShardAllocationDecider]\n[2014-10-16 06:53:19,463][TRACE][cluster.routing.allocation.decider] [bungeearchive01-par.storage.criteo.preprod] Can not allocate [[2014-10-16.01][3], node[null], [R], s[UNASSIGNED]] on node [gE7OTgevSUuoj44RozxK0Q] due to [AwarenessAllocationDecider]\n[2014-10-16 06:53:19,463][TRACE][cluster.routing.allocation.decider] [bungeearchive01-par.storage.criteo.preprod] Can not allocate [[2014-10-16.01][3], node[null], [R], s[UNASSIGNED]] on node [Y2k9qXfsTx6X2iQTxg9RBQ] due to [AwarenessAllocationDecider]\n[2014-10-16 06:53:19,463][TRACE][cluster.routing.allocation.decider] [bungeearchive01-par.storage.criteo.preprod] Can not allocate [[2014-10-16.01][3], node[null], [R], s[UNASSIGNED]] on node [FwWc2XPPRWuje2KH6AlDEQ] due to [FilterAllocationDecider]\n[2014-10-16 06:53:19,492][TRACE][cluster.routing.allocation.allocator] [bungeearchive01-par.storage.criteo.preprod] No Node found to assign shard [[2014-10-16.01][3], node[null], [R], s[UNASSIGNED]]\n```\n\nThis transcript shows that \n- shard 3 primary replica is on node qK34VLdhTferCQs2oNJOyg (flavor:ssd) which prevent its copy to placed there\n- it cannot be placed on gE7OTgevSUuoj44RozxK0Q (ssd as well) because it tries to maximizes dispersion accross flavors\n- it cannot be placed on Y2k9qXfsTx6X2iQTxg9RBQ for the same reason\n- it cannot be placed on FwWc2XPPRWuje2KH6AlDEQ (flavor: iodisk) because of the filter\n\nQuestions:\n- am I doing it wrong?\n- should I stick with a set of reroute command?\n- are awareness and filtering supposed to cooperate?\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}