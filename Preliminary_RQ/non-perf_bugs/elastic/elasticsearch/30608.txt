{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608/events","html_url":"https://github.com/elastic/elasticsearch/issues/30608","id":323162631,"node_id":"MDU6SXNzdWUzMjMxNjI2MzE=","number":30608,"title":"Bucket path name resolution fails with siblings and child aggregations with the same name","user":{"login":"ruizmarc","id":5717082,"node_id":"MDQ6VXNlcjU3MTcwODI=","avatar_url":"https://avatars3.githubusercontent.com/u/5717082?v=4","gravatar_id":"","url":"https://api.github.com/users/ruizmarc","html_url":"https://github.com/ruizmarc","followers_url":"https://api.github.com/users/ruizmarc/followers","following_url":"https://api.github.com/users/ruizmarc/following{/other_user}","gists_url":"https://api.github.com/users/ruizmarc/gists{/gist_id}","starred_url":"https://api.github.com/users/ruizmarc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ruizmarc/subscriptions","organizations_url":"https://api.github.com/users/ruizmarc/orgs","repos_url":"https://api.github.com/users/ruizmarc/repos","events_url":"https://api.github.com/users/ruizmarc/events{/privacy}","received_events_url":"https://api.github.com/users/ruizmarc/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"assignees":[{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2018-05-15T10:43:00Z","updated_at":"2018-05-18T14:00:47Z","closed_at":"2018-05-16T14:10:27Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.4\r\n\r\n**Plugins installed**: No plugins installed\r\n\r\n**JVM version** (`java -version`):  java version \"1.8.0_25\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Darwin Kernel Version 17.5.0\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen trying to use a pipeline aggregation on a date histogram, bucket_path cannot properly be resolved if it is pointing to a child aggregation of the date histogram if a sibling aggregation (pipeline aggregation's sibling)  has the same name as the child aggregation of the date histogram. (see example). \r\n\r\nI would expect that elasticsearch could properly resolve the path, as it doesn't seem to exist an ambiguation. Maybe I'm wrong with this and it should behave as it is behaving... \r\n\r\n**Steps to reproduce**:\r\n\r\nHere you have a simple query example that allows to reproduce the problem\r\n\r\n```\r\n{\r\n  \"query\": { \"match_all\": {} },\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"sessionsCount\": {\r\n      \"filter\": {\r\n        \"bool\": {\r\n          \"must\": [\r\n            {\r\n              \"terms\": {\r\n                \"status\": [\r\n                  \"FINISHED\"\r\n                ]\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    },\r\n    \"monthlyAverageSessions\": {\r\n      \"avg_bucket\": {\r\n        \"buckets_path\": \"monthBuckets>sessionsCount>_count\",\r\n        \"gap_policy\": \"insert_zeros\"\r\n      }\r\n    },\r\n    \"monthBuckets\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"startTimestamp\",\r\n        \"interval\": \"month\"\r\n      },\r\n      \"aggs\": {\r\n        \"sessionsCount\": {\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"must\": [\r\n                {\r\n                  \"terms\": {\r\n                    \"status\": [\r\n                      \"FINISHED\"\r\n                    ]\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nAnd this is the error that I receive. \r\n\r\n`\"{\\\"error\\\":{\\\"root_cause\\\":[],\\\"type\\\":\\\"search_phase_execution_exception\\\",\\\"reason\\\":\\\"\\\",\\\"phase\\\":\\\"fetch\\\",\\\"grouped\\\":true,\\\"failed_shards\\\":[],\\\"caused_by\\\":{\\\"type\\\":\\\"class_cast_exception\\\",\\\"reason\\\":\\\"org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\\\"}},\\\"status\\\":503}\"`\r\n\r\nAny of both aggregations works fine if they are not together (sessionsCount and monthlyAverageSessions). And it also works well if I change the name of the first aggregation (sessionsCount) to a different one (sessions for example). So it looks like a naming problem. \r\n\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}