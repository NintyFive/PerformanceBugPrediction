{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45534","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45534/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45534/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45534/events","html_url":"https://github.com/elastic/elasticsearch/issues/45534","id":480554624,"node_id":"MDU6SXNzdWU0ODA1NTQ2MjQ=","number":45534,"title":"PutIndexTemplate request exception using high level rest client","user":{"login":"TalRefaeli","id":25720406,"node_id":"MDQ6VXNlcjI1NzIwNDA2","avatar_url":"https://avatars1.githubusercontent.com/u/25720406?v=4","gravatar_id":"","url":"https://api.github.com/users/TalRefaeli","html_url":"https://github.com/TalRefaeli","followers_url":"https://api.github.com/users/TalRefaeli/followers","following_url":"https://api.github.com/users/TalRefaeli/following{/other_user}","gists_url":"https://api.github.com/users/TalRefaeli/gists{/gist_id}","starred_url":"https://api.github.com/users/TalRefaeli/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TalRefaeli/subscriptions","organizations_url":"https://api.github.com/users/TalRefaeli/orgs","repos_url":"https://api.github.com/users/TalRefaeli/repos","events_url":"https://api.github.com/users/TalRefaeli/events{/privacy}","received_events_url":"https://api.github.com/users/TalRefaeli/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-08-14T08:43:19Z","updated_at":"2019-08-15T08:43:07Z","closed_at":"2019-08-15T08:43:07Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: 7.3.0\r\nJVM version (Both client and ES): openjdk 1.8.0.201\r\nOS: Windows 10\r\n\r\nException during put index template request using high level rest client.\r\n\r\nWe are upgrading elasticsearch from 5.6.12 to 7.3.0.\r\nWe store our index templates inside json files, and then use the client source() method to put all the json body inside the high level client request.\r\nAfter the upgrade we adjusted the json template \r\nRunning the following code will not work even though it was taken from elasticsearch official [documentation](https://www.elastic.co/guide/en/elasticsearch/client/java-rest/master/java-rest-high-put-template.html):\r\n```\r\nRestHighLevelClient = client = new RestHighLevelClient(RestClient.builder(new HttpHost(\"localhost\", 9400, \"http\")));\r\nPutIndexTemplateRequest request = new PutIndexTemplateRequest(\"my-template\");\r\nrequest.source(\"{\\n\" +\r\n\t\t\"  \\\"index_patterns\\\": [\\n\" +\r\n\t\t\"    \\\"log-*\\\",\\n\" +\r\n\t\t\"    \\\"pattern-1\\\"\\n\" +\r\n\t\t\"  ],\\n\" +\r\n\t\t\"  \\\"order\\\": 1,\\n\" +\r\n\t\t\"  \\\"settings\\\": {\\n\" +\r\n\t\t\"    \\\"number_of_shards\\\": 1\\n\" +\r\n\t\t\"  },\\n\" +\r\n\t\t\"  \\\"mappings\\\": {\\n\" +\r\n\t\t\"    \\\"properties\\\": {\\n\" +\r\n\t\t\"      \\\"message\\\": {\\n\" +\r\n\t\t\"        \\\"type\\\": \\\"text\\\"\\n\" +\r\n\t\t\"      }\\n\" +\r\n\t\t\"    }\\n\" +\r\n\t\t\"  },\\n\" +\r\n\t\t\"  \\\"aliases\\\": {\\n\" +\r\n\t\t\"    \\\"alias-1\\\": {},\\n\" +\r\n\t\t\"    \\\"{index}-alias\\\": {}\\n\" +\r\n\t\t\"  }\\n\" +\r\n\t\t\"}\", XContentType.JSON);\r\nclient.indices().putTemplate(request, RequestOptions.DEFAULT);\r\n```\r\n\r\nExpected: index template created.\r\nActual: Exception is thrown.\r\n\r\nException:\r\n```\r\nElasticsearchStatusException[Elasticsearch exception [type=mapper_parsing_exception, reason=Failed to parse mapping [properties]: Root mapping definition has unsupported parameters:  [message : {type=text}]]]; nested: ElasticsearchException[Elasticsearch exception [type=mapper_parsing_exception, reason=Root mapping definition has unsupported parameters:  [message : {type=text}]]];\r\n\tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:177)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:1727)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseResponseException(RestHighLevelClient.java:1704)\r\n\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1467)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1424)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1394)\r\n\tat org.elasticsearch.client.IndicesClient.putTemplate(IndicesClient.java:1049)\r\n\r\n...\r\n\r\nSuppressed: org.elasticsearch.client.ResponseException: method [PUT], host [http://localhost:9400], URI [/_template/my-template?master_timeout=30s&include_type_name=true], status line [HTTP/1.1 400 Bad Request]\r\nWarnings: [[types removal] Specifying include_type_name in put index template requests is deprecated. The parameter will be removed in the next major version.]\r\n{\"error\":{\"root_cause\":[{\"type\":\"mapper_parsing_exception\",\"reason\":\"Root mapping definition has unsupported parameters:  [message : {type=text}]\"}],\"type\":\"mapper_parsing_exception\",\"reason\":\"Failed to parse mapping [properties]: Root mapping definition has unsupported parameters:  [message : {type=text}]\",\"caused_by\":{\"type\":\"mapper_parsing_exception\",\"reason\":\"Root mapping definition has unsupported parameters:  [message : {type=text}]\"}},\"status\":400}\r\n\t\tat org.elasticsearch.client.RestClient.convertResponse(RestClient.java:253)\r\n\t\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:231)\r\n\t\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:205)\r\n\t\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1454)\r\n\t\t... 32 more\r\nCaused by: ElasticsearchException[Elasticsearch exception [type=mapper_parsing_exception, reason=Root mapping definition has unsupported parameters:  [message : {type=text}]]]\r\n\tat org.elasticsearch.ElasticsearchException.innerFromXContent(ElasticsearchException.java:491)\r\n\tat org.elasticsearch.ElasticsearchException.fromXContent(ElasticsearchException.java:402)\r\n\tat org.elasticsearch.ElasticsearchException.innerFromXContent(ElasticsearchException.java:432)\r\n\tat org.elasticsearch.ElasticsearchException.failureFromXContent(ElasticsearchException.java:598)\r\n\tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:169)\r\n\t... 35 more\r\n```\r\n\r\n\r\nTo reproduce:\r\n1. Run elasticsearch server.\r\n2. Run the java code above.\r\n\r\nThe problem seem to be related to the put-template-request object of high level rest client which incorrectly manipulates the origin json provided by source() method.\r\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}