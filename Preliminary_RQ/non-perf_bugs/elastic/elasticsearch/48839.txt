{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48839","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48839/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48839/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48839/events","html_url":"https://github.com/elastic/elasticsearch/issues/48839","id":516807967,"node_id":"MDU6SXNzdWU1MTY4MDc5Njc=","number":48839,"title":"Upgrading ES 5.6.9 to 6.4.0 Fails","user":{"login":"TomasKuznetsov","id":26360621,"node_id":"MDQ6VXNlcjI2MzYwNjIx","avatar_url":"https://avatars0.githubusercontent.com/u/26360621?v=4","gravatar_id":"","url":"https://api.github.com/users/TomasKuznetsov","html_url":"https://github.com/TomasKuznetsov","followers_url":"https://api.github.com/users/TomasKuznetsov/followers","following_url":"https://api.github.com/users/TomasKuznetsov/following{/other_user}","gists_url":"https://api.github.com/users/TomasKuznetsov/gists{/gist_id}","starred_url":"https://api.github.com/users/TomasKuznetsov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TomasKuznetsov/subscriptions","organizations_url":"https://api.github.com/users/TomasKuznetsov/orgs","repos_url":"https://api.github.com/users/TomasKuznetsov/repos","events_url":"https://api.github.com/users/TomasKuznetsov/events{/privacy}","received_events_url":"https://api.github.com/users/TomasKuznetsov/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-11-03T10:26:35Z","updated_at":"2019-11-04T13:18:26Z","closed_at":"2019-11-04T13:18:26Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n\r\n\r\n##### Elasticsearch version: 5.6.9\r\n\r\n\r\n##### Installed plugins:\r\n\r\n- discovery-ec2\r\n\r\n- repository-s3\r\n\r\n- x-pack\r\n\r\n\r\n##### JVM version:\r\n\r\n- openjdk version \"1.8.0_222\"\r\n\r\n- OpenJDK Runtime Environment (build 1.8.0_222-8u222-b10-1ubuntu1~16.04.1-b10) \r\n\r\n- OpenJDK 64-Bit Server VM (build 25.222-b10, mixed mode)\r\n\r\n\r\n##### OS version:\r\n\r\n- Distributor ID:\tUbuntu\r\n\r\n- Description:\tUbuntu 16.04.6 LTS\r\n\r\n- Release:\t16.04\r\n\r\n- Codename:\txenial\r\n\r\n\r\n##### Description:\r\n\r\nWe have a cluster that consists of 3 master nodes, 2 data nodes, and 2 client nodes.\r\nWe try to perform a rolling upgrade from version 5.6.9 to 6.4.0 and encounter this error:\r\n\r\n\r\n![es error](https://user-images.githubusercontent.com/26360621/68083302-cd223580-fe2f-11e9-9b9a-ea40fac8f68b.png)\r\n\r\n\r\nWe have tried multiple ways of upgrading and they all ended up in the same way, none of the upgraded nodes can join the cluster and they all get the same error, here are some of the things we have tried: \r\n\r\n1. Remove x-pack from all the instances and do a rolling restart and then start a rolling upgrade.\r\n\r\n2. Tried a combination of settings to disable x-pack,  `node.ml: false` and `xpack.ml.enabled: false`, on all or off all, perform a rolling restart and then rolling upgrade.\r\n\r\n3. Upgrade one Data / Master node\r\n\r\n4. Add another three master nodes with the new version, wait for them to join the existing cluster and then drain the old master nodes and start the data nodes rolling upgrade\r\n\r\nThe only way we managed to get it working was by upgrading all three masters at the same time. after all three masters have been upgraded they joined the old data nodes and client nodes. but it's not a valid solution for us and a huge risk.\r\n\r\nIt seems like the main issue is that elasticsearch nodes without x-pack can't join a cluster that has nodes with x-pack installed.\r\nWe use elasticsearch 6 open source, so x-pack is not an option. \r\nWe even reproduced this error without upgrading, we removed the x-pack plugin from one of the nodes in the cluster and restarted elasticsearch service. the node couldn't join the cluster till we removed the x-pack from the master nodes and restarted them.\r\n\r\n\r\n##### Steps to reproduce:\r\n\r\n 1. Create elasticsearch cluster (5.6.9) that consists of three master nodes, two data nodes, and two client nodes. (x-pack plugin must be installed)\r\n 2. Follow elasticsearch rolling upgrade guide (we use puppet to install elasticsearch 6 open source)\r\n\r\n##### logs:\r\n\r\n![es log](https://user-images.githubusercontent.com/26360621/68083622-7ae31380-fe33-11e9-8b46-5963a78b7e87.png)\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}