{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22997","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22997/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22997/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22997/events","html_url":"https://github.com/elastic/elasticsearch/issues/22997","id":205581807,"node_id":"MDU6SXNzdWUyMDU1ODE4MDc=","number":22997,"title":"In some cases FVH returns StringIndexOutOfBoundsException","user":{"login":"oleg-andreyev","id":1244112,"node_id":"MDQ6VXNlcjEyNDQxMTI=","avatar_url":"https://avatars1.githubusercontent.com/u/1244112?v=4","gravatar_id":"","url":"https://api.github.com/users/oleg-andreyev","html_url":"https://github.com/oleg-andreyev","followers_url":"https://api.github.com/users/oleg-andreyev/followers","following_url":"https://api.github.com/users/oleg-andreyev/following{/other_user}","gists_url":"https://api.github.com/users/oleg-andreyev/gists{/gist_id}","starred_url":"https://api.github.com/users/oleg-andreyev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oleg-andreyev/subscriptions","organizations_url":"https://api.github.com/users/oleg-andreyev/orgs","repos_url":"https://api.github.com/users/oleg-andreyev/repos","events_url":"https://api.github.com/users/oleg-andreyev/events{/privacy}","received_events_url":"https://api.github.com/users/oleg-andreyev/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-02-06T13:22:27Z","updated_at":"2017-02-07T17:46:41Z","closed_at":"2017-02-07T17:46:41Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.4.1\r\n\r\n**Lucena version**: 5.5.2\r\n\r\n**Plugins installed**: delete-by-query, head\r\n\r\n**JVM version**: 1.8.0_60\r\n\r\n**OS version**: centos-release-6-8.el6.centos.12.3.x86_64\r\n\r\n**Steps to reproduce**:\r\n<details>\r\n\r\n```\r\n# bug\r\nDELETE es_bug_test\r\n\r\nPUT es_bug_test\r\n{\r\n  \"mappings\": {\r\n    \"product\": {\r\n      \"properties\": {\r\n        \"description\": {\r\n          \"type\": \"string\",\r\n          \"analyzer\": \"generic_text\",\r\n          \"search_analyzer\": \"generic_text_search\",\r\n          \"fielddata\": {\r\n            \"format\": \"disabled\"\r\n          }\r\n        },\r\n        \"clean_description\": {\r\n          \"type\": \"string\",\r\n          \"analyzer\": \"generic_text\",\r\n          \"search_analyzer\": \"generic_text_search\",\r\n          \"norms\": {\r\n            \"enabled\": false\r\n          },\r\n          \"index_options\": \"docs\",\r\n          \"store\": true,\r\n          \"fielddata\": {\r\n            \"format\": \"disabled\"\r\n          },\r\n          \"term_vector\": \"with_positions_offsets\"\r\n        },\r\n        \"full_name\": {\r\n          \"type\": \"multi_field\",\r\n          \"fields\": {\r\n            \"regular\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"generic_text\",\r\n              \"search_analyzer\": \"generic_text_search\"\r\n            },\r\n            \"wo_norms\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"generic_text\",\r\n              \"search_analyzer\": \"generic_text_search\",\r\n              \"norms\": {\r\n                \"enabled\": false\r\n              }\r\n            },\r\n            \"wo_norms_freqs\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"generic_text\",\r\n              \"search_analyzer\": \"generic_text_search\",\r\n              \"norms\": {\r\n                \"enabled\": false\r\n              },\r\n              \"index_options\": \"docs\"\r\n            },\r\n            \"long_terms\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"long_terms\",\r\n              \"norms\": {\r\n                \"enabled\": false\r\n              },\r\n              \"index_options\": \"docs\"\r\n            },\r\n            \"small_terms\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"small_terms\",\r\n              \"norms\": {\r\n                \"enabled\": false\r\n              }\r\n            },\r\n            \"small_w_norms\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"small_terms\"\r\n            },\r\n            \"sorting\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"op_keyword\",\r\n              \"norms\": {\r\n                \"enabled\": false\r\n              },\r\n              \"index_options\": \"docs\"\r\n            },\r\n            \"highlighting\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"generic_text\",\r\n              \"search_analyzer\": \"generic_text_search\",\r\n              \"store\": true,\r\n              \"term_vector\": \"with_positions_offsets\"\r\n            },\r\n            \"spelling\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"spell\",\r\n              \"search_analyzer\": \"standard\"\r\n            },\r\n            \"spelling_word\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"standard\"\r\n            },\r\n            \"related\": {\r\n              \"type\": \"string\",\r\n              \"analyzer\": \"related_searches\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"settings\": {\r\n    \"number_of_shards\": \"1\",\r\n    \"number_of_replicas\": 0,\r\n    \"max_result_window\": 130000,\r\n    \"index\": {\r\n      \"analysis\": {\r\n        \"analyzer\": {\r\n          \"related_searches\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\",\r\n            \"filter\": [\r\n              \"len5_20\",\r\n              \"lowercase\",\r\n              \"asciifolding\",\r\n              \"related_search_delimiter\",\r\n              \"stop\"\r\n            ]\r\n          },\r\n          \"small_terms\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\",\r\n            \"filter\": [\r\n              \"short_word_delimiter\",\r\n              \"len1_4\",\r\n              \"lowercase\",\r\n              \"asciifolding\",\r\n              \"op_synonyms\",\r\n              \"stop\",\r\n              \"snow_english\",\r\n              \"unique\"\r\n            ]\r\n          },\r\n          \"generic_text\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\",\r\n            \"filter\": [\r\n              \"short_word_delimiter\",\r\n              \"lowercase\",\r\n              \"asciifolding\",\r\n              \"op_synonyms\",\r\n              \"stop\",\r\n              \"snow_english\"\r\n            ],\r\n            \"char_filter\": \"html_strip\"\r\n          },\r\n          \"generic_text_search\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\",\r\n            \"filter\": [\r\n              \"short_word_delimiter\",\r\n              \"lowercase\",\r\n              \"asciifolding\",\r\n              \"stop\",\r\n              \"snow_english\"\r\n            ],\r\n            \"char_filter\": \"html_strip\"\r\n          },\r\n          \"spell\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\",\r\n            \"filter\": [\r\n              \"lowercase\",\r\n              \"op_synonyms\",\r\n              \"spell_ngram\"\r\n            ]\r\n          },\r\n          \"op_keyword\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"keyword\",\r\n            \"filter\": [\r\n              \"lowercase\",\r\n              \"trim\"\r\n            ]\r\n          },\r\n          \"long_terms\": {\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"whitespace\",\r\n            \"filter\": [\r\n              \"len5_20\",\r\n              \"lowercase\",\r\n              \"asciifolding\",\r\n              \"op_synonyms\",\r\n              \"stop\",\r\n              \"snow_english\",\r\n              \"unique\"\r\n            ]\r\n          }\r\n        },\r\n        \"filter\": {\r\n          \"spell_ngram\": {\r\n            \"type\": \"nGram\",\r\n            \"min_gram\": 3,\r\n            \"max_gram\": 4\r\n          },\r\n          \"len1_4\": {\r\n            \"type\": \"length\",\r\n            \"min\": 1,\r\n            \"max\": 4\r\n          },\r\n          \"len5_20\": {\r\n            \"type\": \"length\",\r\n            \"min\": 5,\r\n            \"max\": 20\r\n          },\r\n          \"snow_english\": {\r\n            \"type\": \"snowball\",\r\n            \"language\": \"English\"\r\n          },\r\n          \"short_word_delimiter\": {\r\n            \"type\": \"word_delimiter\",\r\n            \"generate_word_parts\": true,\r\n            \"generate_number_parts\": true,\r\n            \"catenate_words\": true,\r\n            \"catenate_numbers\": true,\r\n            \"catenate_all\": true,\r\n            \"split_on_case_change\": true,\r\n            \"preserve_original\": true\r\n          },\r\n          \"related_search_delimiter\": {\r\n            \"type\": \"word_delimiter\",\r\n            \"generate_word_parts\": false,\r\n            \"generate_number_parts\": true,\r\n            \"catenate_words\": false,\r\n            \"catenate_numbers\": false,\r\n            \"catenate_all\": false,\r\n            \"split_on_case_change\": false,\r\n            \"preserve_original\": false,\r\n            \"split_on_numerics\": true,\r\n            \"stem_english_possessive\": true\r\n          },\r\n          \"op_synonyms\": {\r\n            \"type\": \"synonym\",\r\n            \"ignore_case\": true,\r\n            \"expand\": true,\r\n            \"synonyms\": [\r\n              \"riflescopes, rifle scopes\",\r\n              \"riflescope, rifle scope\"\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST es_bug_test/product\r\n{\r\n  \"full_name\": \"Pelican Storm Cases Photographer's Organizer for Pelican Storm Casess\",\r\n  \"clean_description\": \"\\nPelican Storm Case Photographer's Organizers present the professional photographer with an array of compartments including an assortment of elastic strapping and mesh nylon zipper pockets to house, protect and organize all photo gear in your Storm Case. The Storm Case Accessory is water resistant and durable enough for any type of environment. Velcro straps are provided to ensure a tight and organized fit, while the dry box accessory also offers expandable folder pockets that will help you store important gear for the next photo shoot such as rechargeable batteries, digital camera, and all other kinds of digital camera accessories.\\nAvailable Options for Storm Case Photographer's Organizer\\n\\niM2300-PHOTOPALLET: Storm Case Photographer's Organizer for iM2300 Water Proof Storm Case\\niM24XX-PHOTOPALLET: Storm Case Photographer's Organizer for iM2400 Waterproof Storm Case\\niM26XX-PHOTOPALLET: Storm Case Photographer's Organizer for iM2600 and iM2620 Water Resistant Storm Cases\\n\\n\\n\\nFeatures of Pelican Storm Cases Photo Organizer\\n\\nElastic strapping\\nMesh nylon zipper pockets\\nWater resistant\\nVelcro straps provided\\n\\n\\n\\nPackage Content\\n\\nPelican Storm Case Photographer's Organizer for Storm Cases\\n\\n\",\r\n  \"description\": \"<div id=\\\"product-caption-block-description\\\" class=\\\"product-caption-block\\\">\\n<p><strong>Pelican Storm Case Photographer's Organizers</strong> present the professional photographer with an array of compartments including an assortment of elastic strapping and mesh nylon zipper pockets to house, protect and organize all <strong>photo gear</strong> in your <strong><a href=\\\"http://www.dummy-web-site.com/storm-cases-brand.html\\\">Storm Case</a></strong>. The <strong><a href=\\\"http://www.dummy-web-site.com/storm-cases-dry-box-accessories.html\\\">Storm Case Accessory</a></strong> is water resistant and durable enough for any type of environment. <strong>Velcro straps</strong> are provided to ensure a tight and organized fit, while the <strong><a href=\\\"http://www.dummy-web-site.com/dry-box-accessories.html\\\">dry box accessory</a></strong> also offers expandable <strong>folder pockets</strong> that will help you store important gear for the next photo shoot such as <strong><a href=\\\"http://www.dummy-web-site.com/batteries.html\\\">rechargeable batteries</a></strong>, <strong><a href=\\\"http://www.dummy-web-site.com/cameras.html\\\">digital camera</a></strong>, and all other kinds of <strong><a href=\\\"http://www.dummy-web-site.com/digital-camera-accessories.html\\\">digital camera accessories</a></strong>.</p>\\n<h3>Available Options for Storm Case Photographer's Organizer</h3>\\n<ul>\\n<li>iM2300-PHOTOPALLET: Storm Case Photographer's Organizer for iM2300 Water Proof Storm Case</li>\\n<li>iM24XX-PHOTOPALLET: Storm Case Photographer's Organizer for iM2400 Waterproof Storm Case</li>\\n<li>iM26XX-PHOTOPALLET: Storm Case Photographer's Organizer for iM2600 and iM2620 Water Resistant Storm Cases</li>\\n</ul>\\n</div>\\n<div id=\\\"product-caption-block-features\\\" class=\\\"product-caption-block\\\">\\n<h3>Features of Pelican Storm Cases Photo Organizer</h3>\\n<ul>\\n<li>Elastic strapping</li>\\n<li>Mesh nylon zipper pockets</li>\\n<li>Water resistant</li>\\n<li>Velcro straps provided</li>\\n</ul>\\n</div>\\n<div id=\\\"product-caption-block-package-content\\\" class=\\\"product-caption-block\\\">\\n<h3>Package Content</h3>\\n<ul>\\n<li><strong>Pelican Storm Case Photographer's Organizer for Storm Cases</strong></li>\\n</ul>\\n</div>\"\r\n}\r\n\r\nPOST es_bug_test/_refresh\r\n\r\nGET es_bug_test/product/_search\r\n\r\nGET es_bug_test/product/_search\r\n{\r\n  \"highlight\": {\r\n    \"require_field_match\": false,\r\n    \"pre_tags\": [\r\n      \"<strong>\"\r\n    ],\r\n    \"post_tags\": [\r\n      \"</strong>\"\r\n    ],\r\n    \"fields\": {\r\n      \"full_name.highlighting\": {\r\n        \"number_of_fragments\": 0\r\n      },\r\n      \"clean_description\": {\r\n        \"fragment_size\": 100,\r\n        \"number_of_fragments\": 7\r\n      }\r\n    }\r\n  },\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"function_score\": {\r\n            \"score_mode\": \"multiply\",\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"must\": [\r\n                  {\r\n                    \"bool\": {\r\n                      \"minimum_should_match\": \"100%\",\r\n                      \"should\": [\r\n                        {\r\n                          \"dis_max\": {\r\n                            \"queries\": [\r\n                              {\r\n                                \"query_string\": {\r\n                                  \"default_field\": \"full_name.wo_norms_freqs\",\r\n                                  \"query\": \"pelican\",\r\n                                  \"default_operator\": \"and\",\r\n                                  \"minimum_should_match\": \"100%\",\r\n                                  \"boost\": 1.5\r\n                                }\r\n                              },\r\n                              {\r\n                                \"query_string\": {\r\n                                  \"default_field\": \"clean_description\",\r\n                                  \"query\": \"pelican\",\r\n                                  \"default_operator\": \"and\",\r\n                                  \"minimum_should_match\": \"100%\",\r\n                                  \"boost\": 0.2\r\n                                }\r\n                              },\r\n                              {\r\n                                \"query_string\": {\r\n                                  \"default_field\": \"full_name.regular\",\r\n                                  \"query\": \"pelican\",\r\n                                  \"auto_generate_phrase_queries\": true,\r\n                                  \"phrase_slop\": 3,\r\n                                  \"use_dis_max\": true,\r\n                                  \"tie_breaker\": 0.1,\r\n                                  \"boost\": 0.2\r\n                                }\r\n                              }\r\n                            ],\r\n                            \"tie_breaker\": 0.1\r\n                          }\r\n                        },\r\n                        {\r\n                          \"dis_max\": {\r\n                            \"queries\": [\r\n                              {\r\n                                \"query_string\": {\r\n                                  \"default_field\": \"full_name.wo_norms_freqs\",\r\n                                  \"query\": \"im26xx\\\\-photopallet\",\r\n                                  \"default_operator\": \"and\",\r\n                                  \"minimum_should_match\": \"100%\",\r\n                                  \"boost\": 1.5\r\n                                }\r\n                              },\r\n                              {\r\n                                \"query_string\": {\r\n                                  \"default_field\": \"clean_description\",\r\n                                  \"query\": \"im26xx\\\\-photopallet\",\r\n                                  \"default_operator\": \"and\",\r\n                                  \"minimum_should_match\": \"100%\",\r\n                                  \"boost\": 0.2\r\n                                }\r\n                              },\r\n                              {\r\n                                \"query_string\": {\r\n                                  \"default_field\": \"full_name.regular\",\r\n                                  \"query\": \"im26xx\\\\-photopallet\",\r\n                                  \"auto_generate_phrase_queries\": true,\r\n                                  \"phrase_slop\": 3,\r\n                                  \"use_dis_max\": true,\r\n                                  \"tie_breaker\": 0.1,\r\n                                  \"boost\": 0.2\r\n                                }\r\n                              }\r\n                            ],\r\n                            \"tie_breaker\": 0.1\r\n                          }\r\n                        }\r\n                      ]\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\n**Provide logs (if relevant)**:\r\n<details>\r\n\r\n```\r\n[2017-02-06 15:12:07,722][DEBUG][action.search            ] [localhost] [es_bug_test][0], node[-1KvMUg-QKuwDtkQ8aVv8w], [P], v[2], s[STARTED], a[id=YnoIc0ktQ3myY7vBUeiXFg]: Failed to execute [org.elasticsearch.action.search.SearchRequest@52d5aa43]\r\nRemoteTransportException[[localhost][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [clean_description]]]; nested: StringIndexOutOfBoundsException[String index out of range: -16];\r\nCaused by: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [clean_description]]]; nested: StringIndexOutOfBoundsException[String index out of range: -16];\r\n        at org.elasticsearch.search.highlight.FastVectorHighlighter.highlight(FastVectorHighlighter.java:169)\r\n        at org.elasticsearch.search.highlight.HighlightPhase.hitExecute(HighlightPhase.java:140)\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:188)\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:490)\r\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\r\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:77)\r\n        at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n        at java.lang.Thread.run(Unknown Source)\r\nCaused by: java.lang.StringIndexOutOfBoundsException: String index out of range: -16\r\n        at java.lang.String.substring(Unknown Source)\r\n        at org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.makeFragment(BaseFragmentsBuilder.java:179)\r\n        at org.elasticsearch.search.highlight.vectorhighlight.SimpleFragmentsBuilder.makeFragment(SimpleFragmentsBuilder.java:43)\r\n        at org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.createFragments(BaseFragmentsBuilder.java:144)\r\n        at org.apache.lucene.search.vectorhighlight.FastVectorHighlighter.getBestFragments(FastVectorHighlighter.java:186)\r\n        at org.elasticsearch.search.highlight.FastVectorHighlighter.highlight(FastVectorHighlighter.java:146)\r\n        ... 12 more\r\n[2017-02-06 15:12:07,723][DEBUG][action.search            ] [localhost] All shards failed for phase: [query_fetch]\r\nRemoteTransportException[[localhost][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [clean_description]]]; nested: StringIndexOutOfBoundsException[String index out of range: -16];\r\nCaused by: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [clean_description]]]; nested: StringIndexOutOfBoundsException[String index out of range: -16];\r\n        at org.elasticsearch.search.highlight.FastVectorHighlighter.highlight(FastVectorHighlighter.java:169)\r\n        at org.elasticsearch.search.highlight.HighlightPhase.hitExecute(HighlightPhase.java:140)\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:188)\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:490)\r\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\r\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:77)\r\n        at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n        at java.lang.Thread.run(Unknown Source)\r\nCaused by: java.lang.StringIndexOutOfBoundsException: String index out of range: -16\r\n        at java.lang.String.substring(Unknown Source)\r\n        at org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.makeFragment(BaseFragmentsBuilder.java:179)\r\n        at org.elasticsearch.search.highlight.vectorhighlight.SimpleFragmentsBuilder.makeFragment(SimpleFragmentsBuilder.java:43)\r\n        at org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.createFragments(BaseFragmentsBuilder.java:144)\r\n        at org.apache.lucene.search.vectorhighlight.FastVectorHighlighter.getBestFragments(FastVectorHighlighter.java:186)\r\n        at org.elasticsearch.search.highlight.FastVectorHighlighter.highlight(FastVectorHighlighter.java:146)\r\n        ... 12 more\r\n[2017-02-06 15:12:07,723][WARN ][rest.suppressed          ] path: /es_bug_test/product/_search, params: {index=es_bug_test, type=product}\r\nFailed to execute phase [query_fetch], all shards failed; shardFailures {[-1KvMUg-QKuwDtkQ8aVv8w][es_bug_test][0]: RemoteTransportException[[localhost][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]]; nested: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [clean_description]]]; nested: StringIndexOutOfBoundsException[String index out of range: -16]; }\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onFirstPhaseResult(AbstractSearchAsyncAction.java:206)\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction$1.onFailure(AbstractSearchAsyncAction.java:152)\r\n        at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:46)\r\n        at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:872)\r\n        at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:850)\r\n        at org.elasticsearch.transport.TransportService$4.onFailure(TransportService.java:387)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\r\n        at java.lang.Thread.run(Unknown Source)\r\nCaused by: [String index out of range: -16]; nested: StringIndexOutOfBoundsException[String index out of range: -16];\r\n        at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:386)\r\n        at org.elasticsearch.action.search.SearchPhaseExecutionException.guessRootCauses(SearchPhaseExecutionException.java:152)\r\n        at org.elasticsearch.action.search.SearchPhaseExecutionException.getCause(SearchPhaseExecutionException.java:99)\r\n        at java.lang.Throwable.printStackTrace(Unknown Source)\r\n        at java.lang.Throwable.printStackTrace(Unknown Source)\r\n        at org.apache.log4j.DefaultThrowableRenderer.render(DefaultThrowableRenderer.java:60)\r\n        at org.apache.log4j.spi.ThrowableInformation.getThrowableStrRep(ThrowableInformation.java:87)\r\n        at org.apache.log4j.spi.LoggingEvent.getThrowableStrRep(LoggingEvent.java:413)\r\n        at org.apache.log4j.WriterAppender.subAppend(WriterAppender.java:313)\r\n        at org.apache.log4j.WriterAppender.append(WriterAppender.java:162)\r\n        at org.apache.log4j.AppenderSkeleton.doAppend(AppenderSkeleton.java:251)\r\n        at org.apache.log4j.helpers.AppenderAttachableImpl.appendLoopOnAppenders(AppenderAttachableImpl.java:66)\r\n        at org.apache.log4j.Category.callAppenders(Category.java:206)\r\n        at org.apache.log4j.Category.forcedLog(Category.java:391)\r\n        at org.apache.log4j.Category.log(Category.java:856)\r\n        at org.elasticsearch.common.logging.log4j.Log4jESLogger.internalWarn(Log4jESLogger.java:135)\r\n        at org.elasticsearch.common.logging.support.AbstractESLogger.warn(AbstractESLogger.java:109)\r\n        at org.elasticsearch.rest.BytesRestResponse.convert(BytesRestResponse.java:134)\r\n        at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:96)\r\n        at org.elasticsearch.rest.BytesRestResponse.<init>(BytesRestResponse.java:87)\r\n        at org.elasticsearch.rest.action.support.RestActionListener.onFailure(RestActionListener.java:60)\r\n        at org.elasticsearch.action.support.TransportAction$1.onFailure(TransportAction.java:95)\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.raiseEarlyFailure(AbstractSearchAsyncAction.java:294)\r\n        ... 10 more\r\nCaused by: java.lang.StringIndexOutOfBoundsException: String index out of range: -16\r\n        at java.lang.String.substring(Unknown Source)\r\n        at org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.makeFragment(BaseFragmentsBuilder.java:179)\r\n        at org.elasticsearch.search.highlight.vectorhighlight.SimpleFragmentsBuilder.makeFragment(SimpleFragmentsBuilder.java:43)\r\n        at org.apache.lucene.search.vectorhighlight.BaseFragmentsBuilder.createFragments(BaseFragmentsBuilder.java:144)\r\n        at org.apache.lucene.search.vectorhighlight.FastVectorHighlighter.getBestFragments(FastVectorHighlighter.java:186)\r\n        at org.elasticsearch.search.highlight.FastVectorHighlighter.highlight(FastVectorHighlighter.java:146)\r\n        at org.elasticsearch.search.highlight.HighlightPhase.hitExecute(HighlightPhase.java:140)\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:188)\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:490)\r\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:392)\r\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryFetchTransportHandler.messageReceived(SearchServiceTransportAction.java:389)\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:77)\r\n        at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        ... 3 more\r\n\r\n```\r\n\r\n</details>\r\n\r\nException: `Failed to highlight field [clean_description]`, but if I remove:\r\n\r\n```\r\n...\r\n{\r\n\"query_string\": {\r\n  \"default_field\": \"full_name.regular\",\r\n  \"query\": \"pelican\",\r\n  \"auto_generate_phrase_queries\": true,\r\n  \"phrase_slop\": 3,\r\n  \"use_dis_max\": true,\r\n  \"tie_breaker\": 0.1,\r\n  \"boost\": 0.2\r\n}\r\n...\r\n{\r\n\"query_string\": {\r\n  \"default_field\": \"full_name.regular\",\r\n  \"query\": \"im26xx\\\\-photopallet\",\r\n  \"auto_generate_phrase_queries\": true,\r\n  \"phrase_slop\": 3,\r\n  \"use_dis_max\": true,\r\n  \"tie_breaker\": 0.1,\r\n  \"boost\": 0.2\r\n}\r\n...\r\n```\r\nno exception is thrown","closed_by":{"login":"oleg-andreyev","id":1244112,"node_id":"MDQ6VXNlcjEyNDQxMTI=","avatar_url":"https://avatars1.githubusercontent.com/u/1244112?v=4","gravatar_id":"","url":"https://api.github.com/users/oleg-andreyev","html_url":"https://github.com/oleg-andreyev","followers_url":"https://api.github.com/users/oleg-andreyev/followers","following_url":"https://api.github.com/users/oleg-andreyev/following{/other_user}","gists_url":"https://api.github.com/users/oleg-andreyev/gists{/gist_id}","starred_url":"https://api.github.com/users/oleg-andreyev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/oleg-andreyev/subscriptions","organizations_url":"https://api.github.com/users/oleg-andreyev/orgs","repos_url":"https://api.github.com/users/oleg-andreyev/repos","events_url":"https://api.github.com/users/oleg-andreyev/events{/privacy}","received_events_url":"https://api.github.com/users/oleg-andreyev/received_events","type":"User","site_admin":false},"performed_via_github_app":null}