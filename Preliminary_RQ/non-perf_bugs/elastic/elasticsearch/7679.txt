{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7679","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7679/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7679/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7679/events","html_url":"https://github.com/elastic/elasticsearch/issues/7679","id":42477111,"node_id":"MDU6SXNzdWU0MjQ3NzExMQ==","number":7679,"title":"Aggregation returns data in incorrect buckets when field defined in different index types have different data types","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-09-11T00:22:40Z","updated_at":"2014-09-11T08:49:13Z","closed_at":"2014-09-11T08:49:13Z","author_association":"MEMBER","active_lock_reason":null,"body":"This may be related to \"Field resolution should be unambiguous #4081\" (or can potentially be prevented via #4081).  Not sure.  Feel free to attach this to 4081 if it is indeed the same issue.\n\nRepro test case:  https://gist.github.com/ppf2/4fdf1acaf40e9e1b4a3b\n\nIn short:\n- created_at is defined in 2 different index types (typeDate and typeDouble) with 2 different data types.\n- When issuing a date_histogram query against created_at, if you run this against the typeDouble first, the subsequent query that runs against the typeDate will return incorrect bucketing information (and incorrect fielddata value).\n- So in this case when a query runs against typeDate (after another query has run against typeDouble), the aggregation is returning the right document, except that the fielddata value it read appears to be derived from the created_at value of the typeDouble.\n- After clearing the cache for the index and re-running the typeDate query, it works correctly. \n\nThe following is the response for the typeDate query that is run after the typeDouble query.  Even though the query has typeDate type specified, it is getting confused by the fielddata value of the typeDouble type.\n\n```\n{\n   \"took\": 3,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 1,\n      \"successful\": 1,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 0,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"NAME\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"1970-01-01T00:00:00.000Z\",\n               \"key\": 0,\n               \"doc_count\": 1,\n               \"top\": {\n                  \"hits\": {\n                     \"total\": 1,\n                     \"max_score\": 1,\n                     \"hits\": [\n                        {\n                           \"_index\": \"date_histogram\",\n                           \"_type\": \"typeDate\",\n                           \"_id\": \"daterecord\",\n                           \"_score\": 1,\n                           \"_source\": {\n                              \"created_at\": \"2014-09-10T19:32:15\"\n                           },\n                           \"fields\": {\n                              \"created_at\": [\n                                 6.9681908771e-312\n                              ]\n                           }\n                        }\n                     ]\n                  }\n               }\n            }\n         ]\n      }\n   }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}