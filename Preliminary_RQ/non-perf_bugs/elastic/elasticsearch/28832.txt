{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28832","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28832/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28832/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28832/events","html_url":"https://github.com/elastic/elasticsearch/issues/28832","id":300505448,"node_id":"MDU6SXNzdWUzMDA1MDU0NDg=","number":28832,"title":"OutOfMemoryError occured in master node due to cardinality aggregation","user":{"login":"wyukawa","id":125312,"node_id":"MDQ6VXNlcjEyNTMxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/125312?v=4","gravatar_id":"","url":"https://api.github.com/users/wyukawa","html_url":"https://github.com/wyukawa","followers_url":"https://api.github.com/users/wyukawa/followers","following_url":"https://api.github.com/users/wyukawa/following{/other_user}","gists_url":"https://api.github.com/users/wyukawa/gists{/gist_id}","starred_url":"https://api.github.com/users/wyukawa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wyukawa/subscriptions","organizations_url":"https://api.github.com/users/wyukawa/orgs","repos_url":"https://api.github.com/users/wyukawa/repos","events_url":"https://api.github.com/users/wyukawa/events{/privacy}","received_events_url":"https://api.github.com/users/wyukawa/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-02-27T06:11:27Z","updated_at":"2018-03-13T11:29:19Z","closed_at":"2018-03-13T11:29:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.1.2\r\n\r\n**Plugins installed**: []\r\nx-pack monitoring\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_151\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentOS 7.4\r\n```\r\n# uname -a\r\nLinux ... 3.10.0-693.5.2.el7.x86_64 #1 SMP Fri Oct 20 20:32:50 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nOutOfMemoryError occured in master/kibana node due to cardinality aggregation.\r\nWe have 3 master nodes.\r\n\r\nJava heap of master node is 4GB.\r\nAfter this issue, I increase java heap to 12GB.\r\n\r\n**Steps to reproduce**:\r\n\r\nI'm sorry not to reproduce...\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1.\r\n 2.\r\n 3.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nelasticsearch log\r\n```\r\n[2018-02-21T22:24:58,264][ERROR][o.e.t.n.Netty4Utils      ] fatal error on the network layer\r\n        at org.elasticsearch.transport.netty4.Netty4Utils.maybeDie(Netty4Utils.java:185)\r\n        at org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.exceptionCaught(Netty4MessageChannelHandler.java:73)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeExceptionCaught(AbstractChannelHandlerContext.java:285)\r\n        at io.netty.channel.AbstractChannelHandlerContext.notifyHandlerException(AbstractChannelHandlerContext.java:850)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:364)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:310)\r\n        at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:297)\r\n        at io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:413)\r\n        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:265)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.logging.LoggingHandler.channelRead(LoggingHandler.java:241)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1334)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:926)\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:134)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:644)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:544)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:498)\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:458)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858)\r\n        at java.lang.Thread.run(Thread.java:748)\r\n[2018-02-21T22:24:58,264][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [...] fatal error in thread [Thread-19], exiting\r\njava.lang.OutOfMemoryError: Java heap space\r\n```\r\n\r\nI analyze heap dump with MAT.\r\n\r\nHere is the result.\r\n\r\n![](https://gyazo.com/86bcdb2a146a93367665554df8d6e18d.png)\r\n\r\n```\r\n  at org.elasticsearch.common.util.BigArrays.newIntArray(JZ)Lorg/elasticsearch/common/util/IntArray; (BigArrays.java:564)\r\n  at org.elasticsearch.common.util.BigArrays.newIntArray(J)Lorg/elasticsearch/common/util/IntArray; (BigArrays.java:573)\r\n  at org.elasticsearch.search.aggregations.metrics.cardinality.HyperLogLogPlusPlus$Hashset.values(J)Lorg/elasticsearch/common/util/IntArray; (HyperLogLogPlusPlus.java:540)\r\n  at org.elasticsearch.search.aggregations.metrics.cardinality.HyperLogLogPlusPlus.merge(JLorg/elasticsearch/search/aggregations/metrics/cardinality/HyperLogLogPlusPlus;J)V (HyperLogLogPlusPlus.java:211)\r\n  at org.elasticsearch.search.aggregations.metrics.cardinality.InternalCardinality.merge(Lorg/elasticsearch/search/aggregations/metrics/cardinality/InternalCardinality;)V (InternalCardinality.java:106)\r\n  at org.elasticsearch.search.aggregations.metrics.cardinality.InternalCardinality.doReduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalCardinality.java:93)\r\n  at org.elasticsearch.search.aggregations.InternalAggregation.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalAggregation.java:120)\r\n  at org.elasticsearch.search.aggregations.InternalAggregations.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (InternalAggregations.java:77)\r\n  at org.elasticsearch.search.aggregations.bucket.histogram.InternalDateHistogram$Bucket.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/bucket/histogram/InternalDateHistogram$Bucket; (InternalDateHistogram.java:135)\r\n  at org.elasticsearch.search.aggregations.bucket.histogram.InternalDateHistogram.reduceBuckets(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Ljava/util/List; (InternalDateHistogram.java:345)\r\n  at org.elasticsearch.search.aggregations.bucket.histogram.InternalDateHistogram.doReduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalDateHistogram.java:436)\r\n  at org.elasticsearch.search.aggregations.InternalAggregation.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalAggregation.java:120)\r\n  at org.elasticsearch.search.aggregations.InternalAggregations.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (InternalAggregations.java:77)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms$Bucket.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/bucket/terms/InternalTerms$Bucket; (InternalTerms.java:142)\r\n  at org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalTerms.java:286)\r\n  at org.elasticsearch.search.aggregations.InternalAggregation.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregation; (InternalAggregation.java:120)\r\n  at org.elasticsearch.search.aggregations.InternalAggregations.reduce(Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (InternalAggregations.java:77)\r\n  at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(Ljava/util/List;Ljava/util/List;Lorg/elasticsearch/search/aggregations/InternalAggregation$ReduceContext;)Lorg/elasticsearch/search/aggregations/InternalAggregations; (SearchPhaseController.java:523)\r\n  at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(Ljava/util/Collection;Ljava/util/List;Ljava/util/List;Lorg/elasticsearch/action/search/SearchPhaseController$TopDocsStats;IZ)Lorg/elasticsearch/action/search/SearchPhaseController$ReducedQueryPhase; (SearchPhaseController.java:500)\r\n  at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(Ljava/util/Collection;ZZ)Lorg/elasticsearch/action/search/SearchPhaseController$ReducedQueryPhase; (SearchPhaseController.java:417)\r\n  at org.elasticsearch.action.search.SearchPhaseController$1.reduce()Lorg/elasticsearch/action/search/SearchPhaseController$ReducedQueryPhase; (SearchPhaseController.java:736)\r\n  at org.elasticsearch.action.search.FetchSearchPhase.innerRun()V (FetchSearchPhase.java:102)\r\n  at org.elasticsearch.action.search.FetchSearchPhase.access$000(Lorg/elasticsearch/action/search/FetchSearchPhase;)V (FetchSearchPhase.java:45)\r\n  at org.elasticsearch.action.search.FetchSearchPhase$1.doRun()V (FetchSearchPhase.java:87)\r\n  at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun()V (ThreadContext.java:637)\r\n  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run()V (AbstractRunnable.java:37)\r\n  at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun()V (TimedRunnable.java:41)\r\n  at org.elasticsearch.common.util.concurrent.AbstractRunnable.run()V (AbstractRunnable.java:37)\r\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(Ljava/util/concurrent/ThreadPoolExecutor$Worker;)V (ThreadPoolExecutor.java:1149)\r\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run()V (ThreadPoolExecutor.java:624)\r\n  at java.lang.Thread.run()V (Thread.java:748)\r\n```\r\n\r\nI guess cardinality aggregation is related to this issue.\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-cardinality-aggregation.html\r\n\r\nIf it's possible to specify default precision_threshold value in kibana, it seems to be good.\r\nBut I couldn't https://github.com/elastic/kibana/issues/6859\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}