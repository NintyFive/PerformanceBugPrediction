{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38692","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38692/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38692/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38692/events","html_url":"https://github.com/elastic/elasticsearch/issues/38692","id":408656297,"node_id":"MDU6SXNzdWU0MDg2NTYyOTc=","number":38692,"title":"Precision loss of include/exclude filter values in terms aggregation","user":{"login":"cyberhuman","id":979624,"node_id":"MDQ6VXNlcjk3OTYyNA==","avatar_url":"https://avatars2.githubusercontent.com/u/979624?v=4","gravatar_id":"","url":"https://api.github.com/users/cyberhuman","html_url":"https://github.com/cyberhuman","followers_url":"https://api.github.com/users/cyberhuman/followers","following_url":"https://api.github.com/users/cyberhuman/following{/other_user}","gists_url":"https://api.github.com/users/cyberhuman/gists{/gist_id}","starred_url":"https://api.github.com/users/cyberhuman/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cyberhuman/subscriptions","organizations_url":"https://api.github.com/users/cyberhuman/orgs","repos_url":"https://api.github.com/users/cyberhuman/repos","events_url":"https://api.github.com/users/cyberhuman/events{/privacy}","received_events_url":"https://api.github.com/users/cyberhuman/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-02-11T07:03:46Z","updated_at":"2019-11-15T14:34:17Z","closed_at":"2019-11-15T14:34:17Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.4.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n```\r\nopenjdk version \"1.8.0_181\"\r\nOpenJDK Runtime Environment (build 1.8.0_181-8u181-b13-2~deb9u1-b13)\r\nOpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux 4.18.0-2-amd64 #1 SMP Debian 4.18.10-2 (2018-10-07) x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen trying to filter the values for which buckets are created when using terms aggregation on a long field, it's not possible to use values larger than 53 bits. When specifying one in a list of include values, no bucket is created most of the time, and when specifying one in a list of exclude values, the respective bucket is not excluded. I expect that for fields of the long type, the full 64 bit range works.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. `PUT /test '{\"mappings\":{\"_doc\":{\"properties\":{\"field1\":{\"type\":\"long\"}}}}}'`\r\n 2. `POST /test/_doc '{\"field1\":0}'`\r\n 2. `POST /test/_doc '{\"field1\":123456}'`\r\n 2. `POST /test/_doc '{\"field1\":4094779560956318341}'`\r\n 3. `POST /test/_doc/_search '{\"size\":0,\"aggs\":{\"by_field1\":{\"terms\":{\"field\":\"field1\",\"include\":[0,123456,4094779560956318341]}}}}` returns only buckets for 0 and 123456\r\n 3. `POST /test/_doc/_search '{\"size\":0,\"aggs\":{\"by_field1\":{\"terms\":{\"field\":\"field1\",\"exclude\":[0,123456,4094779560956318341]}}}}` returns only bucket for 4094779560956318341\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nThe reason is apparently here:\r\nhttps://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/bucket/terms/IncludeExclude.java#L633-L642\r\nand here:\r\nhttps://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/DocValueFormat.java#L118-L126","closed_by":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"performed_via_github_app":null}