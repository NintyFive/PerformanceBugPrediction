{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18279","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18279/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18279/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18279/events","html_url":"https://github.com/elastic/elasticsearch/issues/18279","id":154281136,"node_id":"MDU6SXNzdWUxNTQyODExMzY=","number":18279,"title":"Hot swappable path.data disks","user":{"login":"PhaedrusTheGreek","id":4387023,"node_id":"MDQ6VXNlcjQzODcwMjM=","avatar_url":"https://avatars0.githubusercontent.com/u/4387023?v=4","gravatar_id":"","url":"https://api.github.com/users/PhaedrusTheGreek","html_url":"https://github.com/PhaedrusTheGreek","followers_url":"https://api.github.com/users/PhaedrusTheGreek/followers","following_url":"https://api.github.com/users/PhaedrusTheGreek/following{/other_user}","gists_url":"https://api.github.com/users/PhaedrusTheGreek/gists{/gist_id}","starred_url":"https://api.github.com/users/PhaedrusTheGreek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/PhaedrusTheGreek/subscriptions","organizations_url":"https://api.github.com/users/PhaedrusTheGreek/orgs","repos_url":"https://api.github.com/users/PhaedrusTheGreek/repos","events_url":"https://api.github.com/users/PhaedrusTheGreek/events{/privacy}","received_events_url":"https://api.github.com/users/PhaedrusTheGreek/received_events","type":"User","site_admin":false},"labels":[{"id":862527366,"node_id":"MDU6TGFiZWw4NjI1MjczNjY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Resiliency","name":":Core/Infra/Resiliency","color":"0e8a16","default":false,"description":"Keep running when everything is ok. Die quickly if things go horribly wrong."},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":111053151,"node_id":"MDU6TGFiZWwxMTEwNTMxNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/resiliency","name":"resiliency","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":16,"created_at":"2016-05-11T16:04:28Z","updated_at":"2018-03-16T20:38:46Z","closed_at":"2018-03-13T08:11:27Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"It seems that when making use of `path.data` over multiple physical disks, that when a disk is removed, the system should recover automatically.   Currently, searches and or indexing requests over missing shards throw exceptions, and no allocation/recovery occurs.   The only way to bring the data back online is to restart the node, or to reinsert the original disk with existing data.  \n\nIt would be great if Elasticsearch could:\n- Automatically recover when disks are removed\n- Automatically make use of a newly returned empty disk\n\nSteps to Test / Reproduce:\n\n1) Set up `path.data` over 2 disks, and start 2 elasticsearch nodes locally\n\n```\npath.data: [\"/Volumes/KINGSTON\", \"/Volumes/SDCARD\"]\n```\n\n2) Index some data over 5 shards.\n\n```\nindex    shard prirep state   docs  store ip        node\ntest1003 4     r      STARTED    2 10.1kb 127.0.0.1 Jacqueline Falsworth\ntest1003 4     p      STARTED    2 10.1kb 127.0.0.1 Vindicator\ntest1003 3     r      STARTED    6 24.4kb 127.0.0.1 Jacqueline Falsworth\ntest1003 3     p      STARTED    6 24.5kb 127.0.0.1 Vindicator\ntest1003 1     r      STARTED   10 40.6kb 127.0.0.1 Jacqueline Falsworth\ntest1003 1     p      STARTED   10 45.5kb 127.0.0.1 Vindicator\ntest1003 2     r      STARTED    2 10.1kb 127.0.0.1 Jacqueline Falsworth\ntest1003 2     p      STARTED    2 10.1kb 127.0.0.1 Vindicator\ntest1003 0     r      STARTED    3 10.1kb 127.0.0.1 Jacqueline Falsworth\ntest1003 0     p      STARTED    3 10.1kb 127.0.0.1 Vindicator\n```\n\n3) Remove the disk that contains most/all of the data\n\nExceptions start to show in logs\n\n```\n2016-05-11 11:50:18,961][DEBUG][action.admin.indices.stats] [Vindicator] [indices:monitor/stats] failed to execute operation for shard [[[test1003/01ABN7pTQDCoTa80WMdAvg]][0], node[AMr_NWrVSFCuNV-YCOfsVg], [P], s[STARTED], a[id=IMwYwgWrTLCZYa08WJRNvg]]\nElasticsearchException[failed to refresh store stats]; nested: NoSuchFileException[/Volumes/KINGSTON/elasticsearch/nodes/0/indices/01ABN7pTQDCoTa80WMdAvg/0/index];\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1411)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1396)\n    at org.elasticsearch.common.util.SingleObjectCache.getOrRefresh(SingleObjectCache.java:54)\n    at org.elasticsearch.index.store.Store.stats(Store.java:321)\n    at org.elasticsearch.index.shard.IndexShard.storeStats(IndexShard.java:632)\n    at org.elasticsearch.action.admin.indices.stats.CommonStats.<init>(CommonStats.java:137)\n    at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:166)\n    at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:47)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.onShardOperation(TransportBroadcastByNodeAction.java:414)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:393)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:380)\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:65)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:468)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.nio.file.NoSuchFileException: /Volumes/KINGSTON/elasticsearch/nodes/0/indices/01ABN7pTQDCoTa80WMdAvg/0/index\n    at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)\n    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)\n    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)\n    at sun.nio.fs.UnixFileSystemProvider.newDirectoryStream(UnixFileSystemProvider.java:407)\n    at java.nio.file.Files.newDirectoryStream(Files.java:457)\n    at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:215)\n    at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:234)\n    at org.elasticsearch.index.store.FsDirectoryService$1.listAll(FsDirectoryService.java:135)\n    at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n    at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.estimateSize(Store.java:1417)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1409)\n    ... 18 more\n[2016-05-11 11:50:26,796][WARN ][monitor.fs               ] [Vindicator] Failed to fetch fs stats - returning empty instance\n```\n\nbut `_cat/shards` shows everything is OK\n\n```\nindex    shard prirep state   docs store ip        node\ntest1003 4     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 4     p      STARTED            127.0.0.1 Vindicator\ntest1003 3     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 3     p      STARTED            127.0.0.1 Vindicator\ntest1003 1     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 1     p      STARTED            127.0.0.1 Vindicator\ntest1003 2     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 2     p      STARTED            127.0.0.1 Vindicator\ntest1003 0     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 0     p      STARTED            127.0.0.1 Vindicator\n```\n\n3) Post a `_refresh`\n\nNo change\n\n4) Index some data\n\n```\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"index_failed_engine_exception\",\n            \"reason\": \"Index failed for [test1003#AVSghrSCuf6DFWq498vy]\",\n            \"index_uuid\": \"01ABN7pTQDCoTa80WMdAvg\",\n            \"shard\": \"1\",\n            \"index\": \"test1003\"\n         }\n      ],\n      \"type\": \"index_failed_engine_exception\",\n      \"reason\": \"Index failed for [test1003#AVSghrSCuf6DFWq498vy]\",\n      \"index_uuid\": \"01ABN7pTQDCoTa80WMdAvg\",\n      \"shard\": \"1\",\n      \"index\": \"test1003\",\n      \"caused_by\": {\n         \"type\": \"i_o_exception\",\n         \"reason\": \"Input/output error: NIOFSIndexInput(path=\\\"/Volumes/KINGSTON/elasticsearch/nodes/0/indices/01ABN7pTQDCoTa80WMdAvg/1/index/_a.cfs\\\") [slice=_a_Lucene50_0.tim]\",\n         \"caused_by\": {\n            \"type\": \"i_o_exception\",\n            \"reason\": \"Input/output error\"\n         }\n      }\n   },\n   \"status\": 500\n}\n```\n\nLogs show an exception\n\n```\n[2016-05-11 11:52:26,911][DEBUG][action.admin.indices.stats] [Vindicator] [indices:monitor/stats] failed to execute operation for shard [[[test1003/01ABN7pTQDCoTa80WMdAvg]][0], node[AMr_NWrVSFCuNV-YCOfsVg], [P], s[STARTED], a[id=IMwYwgWrTLCZYa08WJRNvg]]\nElasticsearchException[failed to refresh store stats]; nested: NoSuchFileException[/Volumes/KINGSTON/elasticsearch/nodes/0/indices/01ABN7pTQDCoTa80WMdAvg/0/index];\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1411)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1396)\n    at org.elasticsearch.common.util.SingleObjectCache.getOrRefresh(SingleObjectCache.java:54)\n    at org.elasticsearch.index.store.Store.stats(Store.java:321)\n    at org.elasticsearch.index.shard.IndexShard.storeStats(IndexShard.java:632)\n    at org.elasticsearch.action.admin.indices.stats.CommonStats.<init>(CommonStats.java:137)\n    at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:166)\n    at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:47)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.onShardOperation(TransportBroadcastByNodeAction.java:414)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:393)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:380)\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:65)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:468)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.nio.file.NoSuchFileException: /Volumes/KINGSTON/elasticsearch/nodes/0/indices/01ABN7pTQDCoTa80WMdAvg/0/index\n    at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)\n    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)\n    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)\n    at sun.nio.fs.UnixFileSystemProvider.newDirectoryStream(UnixFileSystemProvider.java:407)\n    at java.nio.file.Files.newDirectoryStream(Files.java:457)\n    at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:215)\n    at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:234)\n    at org.elasticsearch.index.store.FsDirectoryService$1.listAll(FsDirectoryService.java:135)\n    at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n    at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.estimateSize(Store.java:1417)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1409)\n    ... 18 more\n```\n\n`_cat/shards` still show all shards STARTED\n\n```\nindex    shard prirep state   docs store ip        node\ntest1003 4     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 4     p      STARTED            127.0.0.1 Vindicator\ntest1003 3     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 3     p      STARTED            127.0.0.1 Vindicator\ntest1003 1     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 1     p      STARTED            127.0.0.1 Vindicator\ntest1003 2     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 2     p      STARTED            127.0.0.1 Vindicator\ntest1003 0     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 0     p      STARTED            127.0.0.1 Vindicator\n```\n\n5) Wait 5 minutes,  Search some data:\n\nNo change\n\n```\n{\n   \"took\": 15,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 3,\n      \"failed\": 2,\n      \"failures\": [\n         {\n            \"shard\": 0,\n            \"index\": \"test1003\",\n            \"node\": \"AMr_NWrVSFCuNV-YCOfsVg\",\n            \"reason\": {\n               \"type\": \"i_o_exception\",\n               \"reason\": \"Input/output error: NIOFSIndexInput(path=\\\"/Volumes/KINGSTON/elasticsearch/nodes/0/indices/01ABN7pTQDCoTa80WMdAvg/0/index/_0.cfs\\\") [slice=_0.fdt]\",\n               \"caused_by\": {\n                  \"type\": \"i_o_exception\",\n                  \"reason\": \"Input/output error\"\n               }\n            }\n         },\n         {\n            \"shard\": 1,\n            \"index\": \"test1003\",\n            \"node\": \"wK5mnEIaT82Wz3wdTAjv6Q\",\n            \"reason\": {\n               \"type\": \"i_o_exception\",\n               \"reason\": \"Input/output error: NIOFSIndexInput(path=\\\"/Volumes/KINGSTON/elasticsearch/nodes/1/indices/01ABN7pTQDCoTa80WMdAvg/1/index/_2.cfs\\\") [slice=_2.fdt]\",\n               \"caused_by\": {\n                  \"type\": \"i_o_exception\",\n                  \"reason\": \"Input/output error\"\n               }\n            }\n         }\n      ]\n   },\n   \"hits\": {\n      \"total\": 23,\n      \"max_score\": 1,\n      \"hits\": []\n   }\n}\n```\n\n```\nindex    shard prirep state   docs store ip        node\ntest1003 4     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 4     p      STARTED            127.0.0.1 Vindicator\ntest1003 3     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 3     p      STARTED            127.0.0.1 Vindicator\ntest1003 1     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 1     p      STARTED            127.0.0.1 Vindicator\ntest1003 2     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 2     p      STARTED            127.0.0.1 Vindicator\ntest1003 0     r      STARTED            127.0.0.1 Jacqueline Falsworth\ntest1003 0     p      STARTED            127.0.0.1 Vindicator\n```\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}