{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5306","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5306/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5306/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5306/events","html_url":"https://github.com/elastic/elasticsearch/issues/5306","id":28545228,"node_id":"MDU6SXNzdWUyODU0NTIyOA==","number":5306,"title":"Aggregations that can count only parent documents with matching children documents","user":{"login":"chaos-generator","id":2170884,"node_id":"MDQ6VXNlcjIxNzA4ODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/2170884?v=4","gravatar_id":"","url":"https://api.github.com/users/chaos-generator","html_url":"https://github.com/chaos-generator","followers_url":"https://api.github.com/users/chaos-generator/followers","following_url":"https://api.github.com/users/chaos-generator/following{/other_user}","gists_url":"https://api.github.com/users/chaos-generator/gists{/gist_id}","starred_url":"https://api.github.com/users/chaos-generator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chaos-generator/subscriptions","organizations_url":"https://api.github.com/users/chaos-generator/orgs","repos_url":"https://api.github.com/users/chaos-generator/repos","events_url":"https://api.github.com/users/chaos-generator/events{/privacy}","received_events_url":"https://api.github.com/users/chaos-generator/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null},{"id":113234020,"node_id":"MDU6TGFiZWwxMTMyMzQwMjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/stalled","name":"stalled","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2014-03-01T00:42:29Z","updated_at":"2018-02-14T13:29:20Z","closed_at":"2016-11-06T15:06:05Z","author_association":"NONE","active_lock_reason":null,"body":"Feature request: \nAggregations that can count only parent documents with matching children documents. \n\nI've been working on a BI system with ES 0.90 and we needed count \"users\" which have certain attributes, for instance let's say gender and star sign. A user is a parent-level document and the attributes are child documents. \n\nFrom the sample above, we were doing so by creating a query for each combination of male / female and the star signs and querying individually, as one can imagine, this was slow, but the results are exactly what we want. We could run this in roughly 2 minutes.\n\nWe considered using the msearch query to get these results in a single query and we ended up with something similar to this: https://gist.github.com/chaos-generator/9133118\nThe sample above runs in 40 seconds give or take.\n\nAnd along came elastic search 1.0.0 and now we have aggregations, so we simplified our query to this: https://gist.github.com/chaos-generator/9133139\nThis runs lightning fast and we get the results in 200ms on average, which is ideal for us, BUT we get the total number of documents with the attributes, rather than the count on the parent documents.\n\nOur problem, as you can see in the msearch gist, is that we have a parent level document and child documents, which would only be updated if another document with the exact same attributes came in, this means that a parent level user document can have three child documents that will have gender and star sign, but I only want to count the parent document, rather than each individual child document.\n\nAs we don't know in advance the attributes our users will be searching, we cannot use a script in index time to help us do this aggregation. We tried to use a script in search time like this:  https://gist.github.com/chaos-generator/9133321 , but it didn't work as we wanted too:\n\nYou can use this gist to simulate the issue we have: https://gist.github.com/chaos-generator/9143655\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}