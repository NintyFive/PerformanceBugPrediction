{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25119","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25119/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25119/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25119/events","html_url":"https://github.com/elastic/elasticsearch/issues/25119","id":234342232,"node_id":"MDU6SXNzdWUyMzQzNDIyMzI=","number":25119,"title":"snapshots fail if HDFS is not available when Elasticsearch starts","user":{"login":"inqueue","id":6099128,"node_id":"MDQ6VXNlcjYwOTkxMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/6099128?v=4","gravatar_id":"","url":"https://api.github.com/users/inqueue","html_url":"https://github.com/inqueue","followers_url":"https://api.github.com/users/inqueue/followers","following_url":"https://api.github.com/users/inqueue/following{/other_user}","gists_url":"https://api.github.com/users/inqueue/gists{/gist_id}","starred_url":"https://api.github.com/users/inqueue/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inqueue/subscriptions","organizations_url":"https://api.github.com/users/inqueue/orgs","repos_url":"https://api.github.com/users/inqueue/repos","events_url":"https://api.github.com/users/inqueue/events{/privacy}","received_events_url":"https://api.github.com/users/inqueue/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jbaiera","id":875779,"node_id":"MDQ6VXNlcjg3NTc3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/875779?v=4","gravatar_id":"","url":"https://api.github.com/users/jbaiera","html_url":"https://github.com/jbaiera","followers_url":"https://api.github.com/users/jbaiera/followers","following_url":"https://api.github.com/users/jbaiera/following{/other_user}","gists_url":"https://api.github.com/users/jbaiera/gists{/gist_id}","starred_url":"https://api.github.com/users/jbaiera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbaiera/subscriptions","organizations_url":"https://api.github.com/users/jbaiera/orgs","repos_url":"https://api.github.com/users/jbaiera/repos","events_url":"https://api.github.com/users/jbaiera/events{/privacy}","received_events_url":"https://api.github.com/users/jbaiera/received_events","type":"User","site_admin":false},"assignees":[{"login":"jbaiera","id":875779,"node_id":"MDQ6VXNlcjg3NTc3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/875779?v=4","gravatar_id":"","url":"https://api.github.com/users/jbaiera","html_url":"https://github.com/jbaiera","followers_url":"https://api.github.com/users/jbaiera/followers","following_url":"https://api.github.com/users/jbaiera/following{/other_user}","gists_url":"https://api.github.com/users/jbaiera/gists{/gist_id}","starred_url":"https://api.github.com/users/jbaiera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbaiera/subscriptions","organizations_url":"https://api.github.com/users/jbaiera/orgs","repos_url":"https://api.github.com/users/jbaiera/repos","events_url":"https://api.github.com/users/jbaiera/events{/privacy}","received_events_url":"https://api.github.com/users/jbaiera/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2017-06-07T21:04:43Z","updated_at":"2017-06-16T19:24:03Z","closed_at":"2017-06-16T19:24:03Z","author_association":"MEMBER","active_lock_reason":null,"body":"_cloned from https://github.com/elastic/elasticsearch-hadoop/issues/997_\r\n\r\nElasticsearch 2.4.4 + repository-hdfs\r\n\r\nSnapshots fail if the HDFS repo is not available when Elasticsearch starts, even though the repo was brought up while the Elasticsearch service is running. \r\n\r\nRepro:\r\n1) Stopped ES\r\n2) Stopped Hadoop HDFS\r\n3) Started ES while HDFS is down\r\n4) Started HDFS\r\n5) Attempted to GET /_snapshot/repo and then attempted to PUT /_snapshot/repo\r\n\r\nThe API command fails with:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"repository_missing_exception\",\r\n        \"reason\": \"[may2017] missing\"\r\n      }\r\n    ],\r\n    \"type\": \"repository_missing_exception\",\r\n    \"reason\": \"[may2017] missing\"\r\n  },\r\n  \"status\": 404\r\n}\r\n```\r\n\r\nFull cluster log is available upon request.\r\n```\r\n[2017-05-16 19:28:14,286][WARN ][repositories             ] [cops-4] failed to create repository [hdfs][may2017]\r\norg.elasticsearch.common.inject.CreationException: Guice creation errors:\r\n\r\n1) Error injecting constructor, java.net.ConnectException: Call From node-4.dev.domain.com/10.237.50.1 to node-2.dev.domain.com:8020 failed on connection exception: java.net.ConnectException: Connection refused; For more details see:  http://wiki.apache.org/hadoop/ConnectionRefused\r\n  at org.elasticsearch.repositories.hdfs.HdfsRepository.<init>(Unknown Source)\r\n  while locating org.elasticsearch.repositories.hdfs.HdfsRepository\r\n  while locating org.elasticsearch.repositories.Repository\r\n\r\n1 error\r\n\tat org.elasticsearch.common.inject.internal.Errors.throwCreationExceptionIfErrorsExist(Errors.java:360)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:178)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:110)\r\n\tat org.elasticsearch.common.inject.InjectorImpl.createChildInjector(InjectorImpl.java:154)\r\n\tat org.elasticsearch.common.inject.ModulesBuilder.createChildInjector(ModulesBuilder.java:55)\r\n\tat org.elasticsearch.repositories.RepositoriesService.createRepositoryHolder(RepositoriesService.java:404)\r\n\tat org.elasticsearch.repositories.RepositoriesService.clusterChanged(RepositoriesService.java:299)\r\n\tat org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:622)\r\n\tat org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:784)\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\nCaused by: java.net.ConnectException: Call From node-4.dev.domain.com/10.237.50.1 to node-2.dev.domain.com:8020 failed on connection exception: java.net.ConnectException: Connection refused; For more details see:  http://wiki.apache.org/hadoop/ConnectionRefused\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n\tat java.lang.reflect.Constructor.newInstance(Constructor.java:423)\r\n\tat org.apache.hadoop.net.NetUtils.wrapWithMessage(NetUtils.java:792)\r\n\tat org.apache.hadoop.net.NetUtils.wrapException(NetUtils.java:732)\r\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1480)\r\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1407)\r\n\tat org.apache.hadoop.ipc.ProtobufRpcEngine$Invoker.invoke(ProtobufRpcEngine.java:229)\r\n\tat com.sun.proxy.$Proxy22.getFileInfo(Unknown Source)\r\n\tat org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolTranslatorPB.getFileInfo(ClientNamenodeProtocolTranslatorPB.java:771)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler.invokeMethod(RetryInvocationHandler.java:187)\r\n\tat org.apache.hadoop.io.retry.RetryInvocationHandler.invoke(RetryInvocationHandler.java:102)\r\n\tat com.sun.proxy.$Proxy23.getFileInfo(Unknown Source)\r\n\tat org.apache.hadoop.hdfs.DFSClient.getFileInfo(DFSClient.java:2116)\r\n\tat org.apache.hadoop.hdfs.DistributedFileSystem$22.doCall(DistributedFileSystem.java:1305)\r\n\tat org.apache.hadoop.hdfs.DistributedFileSystem$22.doCall(DistributedFileSystem.java:1301)\r\n\tat org.apache.hadoop.fs.FileSystemLinkResolver.resolve(FileSystemLinkResolver.java:81)\r\n\tat org.apache.hadoop.hdfs.DistributedFileSystem.getFileStatus(DistributedFileSystem.java:1317)\r\n\tat org.apache.hadoop.fs.FileSystem.isFile(FileSystem.java:1450)\r\n\tat org.elasticsearch.repositories.hdfs.HdfsRepository.doGetFileSystem(HdfsRepository.java:125)\r\n\tat org.elasticsearch.repositories.hdfs.HdfsRepository.access$000(HdfsRepository.java:57)\r\n\tat org.elasticsearch.repositories.hdfs.HdfsRepository$2.run(HdfsRepository.java:102)\r\n\tat org.elasticsearch.repositories.hdfs.HdfsRepository$2.run(HdfsRepository.java:99)\r\n\tat java.security.AccessController.doPrivileged(Native Method)\r\n\tat org.elasticsearch.repositories.hdfs.HdfsRepository.getFileSystem(HdfsRepository.java:99)\r\n\tat org.elasticsearch.repositories.hdfs.SecurityUtils.execute(SecurityUtils.java:34)\r\n\tat org.elasticsearch.hadoop.hdfs.blobstore.HdfsBlobStore.mkdirs(HdfsBlobStore.java:58)\r\n\tat org.elasticsearch.hadoop.hdfs.blobstore.HdfsBlobStore.<init>(HdfsBlobStore.java:54)\r\n\tat org.elasticsearch.repositories.hdfs.HdfsRepository.<init>(HdfsRepository.java:90)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\r\n\tat sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\r\n\tat java.lang.reflect.Constructor.newInstance(Constructor.java:423)\r\n\tat org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:50)\r\n\tat org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\r\n\tat org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:104)\r\n\tat org.elasticsearch.common.inject.FactoryProxy.get(FactoryProxy.java:54)\r\n\tat org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\r\n\tat org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:886)\r\n\tat org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\r\n\tat org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\r\n\tat org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:46)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:201)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:193)\r\n\tat org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:879)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:193)\r\n\tat org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:175)\r\n\t... 12 more\r\nCaused by: java.net.ConnectException: Connection refused\r\n\tat sun.nio.ch.SocketChannelImpl.checkConnect(Native Method)\r\n\tat sun.nio.ch.SocketChannelImpl.finishConnect(SocketChannelImpl.java:717)\r\n\tat org.apache.hadoop.net.SocketIOWithTimeout.connect(SocketIOWithTimeout.java:206)\r\n\tat org.apache.hadoop.net.NetUtils.connect(NetUtils.java:531)\r\n\tat org.apache.hadoop.net.NetUtils.connect(NetUtils.java:495)\r\n\tat org.apache.hadoop.ipc.Client$Connection.setupConnection(Client.java:609)\r\n\tat org.apache.hadoop.ipc.Client$Connection.setupIOstreams(Client.java:707)\r\n\tat org.apache.hadoop.ipc.Client$Connection.access$2800(Client.java:370)\r\n\tat org.apache.hadoop.ipc.Client.getConnection(Client.java:1529)\r\n\tat org.apache.hadoop.ipc.Client.call(Client.java:1446)\r\n\t... 57 more\r\n```\r\n\r\nIs there any way to try establishing a connection to the repo after Elasticsearch has started?\r\n\r\n@imotov @jbaiera ","closed_by":{"login":"inqueue","id":6099128,"node_id":"MDQ6VXNlcjYwOTkxMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/6099128?v=4","gravatar_id":"","url":"https://api.github.com/users/inqueue","html_url":"https://github.com/inqueue","followers_url":"https://api.github.com/users/inqueue/followers","following_url":"https://api.github.com/users/inqueue/following{/other_user}","gists_url":"https://api.github.com/users/inqueue/gists{/gist_id}","starred_url":"https://api.github.com/users/inqueue/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inqueue/subscriptions","organizations_url":"https://api.github.com/users/inqueue/orgs","repos_url":"https://api.github.com/users/inqueue/repos","events_url":"https://api.github.com/users/inqueue/events{/privacy}","received_events_url":"https://api.github.com/users/inqueue/received_events","type":"User","site_admin":false},"performed_via_github_app":null}