[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64443765","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64443765","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64443765,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NDQzNzY1","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-25T18:04:47Z","updated_at":"2014-11-25T18:04:47Z","author_association":"CONTRIBUTOR","body":"Hi @Thibaut-Fatus \n\nScripts are always executed locally, so you need to have the same scripts on all nodes. The master nodes are only involved if they are executing a script - there is nothing special about their role in scripting. You could e.g. use a shared file system to ensure that all nodes have the same scripts.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64544831","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64544831","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64544831,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NTQ0ODMx","user":{"login":"Thibaut-Fatus","id":7557608,"node_id":"MDQ6VXNlcjc1NTc2MDg=","avatar_url":"https://avatars1.githubusercontent.com/u/7557608?v=4","gravatar_id":"","url":"https://api.github.com/users/Thibaut-Fatus","html_url":"https://github.com/Thibaut-Fatus","followers_url":"https://api.github.com/users/Thibaut-Fatus/followers","following_url":"https://api.github.com/users/Thibaut-Fatus/following{/other_user}","gists_url":"https://api.github.com/users/Thibaut-Fatus/gists{/gist_id}","starred_url":"https://api.github.com/users/Thibaut-Fatus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Thibaut-Fatus/subscriptions","organizations_url":"https://api.github.com/users/Thibaut-Fatus/orgs","repos_url":"https://api.github.com/users/Thibaut-Fatus/repos","events_url":"https://api.github.com/users/Thibaut-Fatus/events{/privacy}","received_events_url":"https://api.github.com/users/Thibaut-Fatus/received_events","type":"User","site_admin":false},"created_at":"2014-11-26T10:40:07Z","updated_at":"2014-11-26T10:40:07Z","author_association":"NONE","body":"Thank you for the insight,\n\nHowever I'm very surprised.. Lets say our configuration was:\n-- node0 with script0\n-- node1 with script1\n\nwhere script{i} are only stored locally on node{i}\n\nWe were testing this on our development hardware, each of us connected to his own node running on our localhost, on the same cluster. (2 different machines, we were _not_ using a connection pool when firing requests)\n\nOur understanding was that scripts are executed locally, and thus need to be locally stored on each nodes _which you confirm_. \n\nWhat we've seen is that:\n**if node{i} is master, both users could execute script{i}, none of them could exectute script{j}.**\n\n######\nA bit more details:\n-- node0 (master) can only execute script0 (this is expected)\n-- **node1 (slave) can only execute script0 which is not stored locally (this is not expected ?)**\n-- none of them can exectute script1\n\nAnd shutting down node0 to have node1 as a master leads to the opposite situation where:\n-- **node0 (slave) can only execute script1 (this is surprising)**\n-- node1 (master) can only execute script1 (this is expected)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64547420","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64547420","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64547420,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NTQ3NDIw","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-26T11:02:25Z","updated_at":"2014-11-26T11:02:25Z","author_association":"CONTRIBUTOR","body":"@Thibaut-Fatus I think where you are getting confused is this: the node that you send the request to may or may not be the node that executes the request.\n\nThe node receiving the request acts as the \"coordinating node\", eg for a search request, it will forward a per-shard search request to a copy of every shard in the index (which may or may not be on the same node).  Each shard will execute the request (including scripts) then return the results to the coordinating node, which then reduces the shard-level results to the final results returned to the user.\n\nScripts in files are never transferred between nodes by Elasticsearch, and master nodes have nothing at all to do with scripting.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64547569","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64547569","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64547569,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NTQ3NTY5","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-26T11:03:43Z","updated_at":"2014-11-26T11:03:43Z","author_association":"CONTRIBUTOR","body":"To add to the above: if you send the same search request to the same node repeatedly, the coordinating node will round-robin through shard copies, eg the first request might execute on node 1, and the second request on node 2 etc\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64573838","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64573838","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64573838,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NTczODM4","user":{"login":"Thibaut-Fatus","id":7557608,"node_id":"MDQ6VXNlcjc1NTc2MDg=","avatar_url":"https://avatars1.githubusercontent.com/u/7557608?v=4","gravatar_id":"","url":"https://api.github.com/users/Thibaut-Fatus","html_url":"https://github.com/Thibaut-Fatus","followers_url":"https://api.github.com/users/Thibaut-Fatus/followers","following_url":"https://api.github.com/users/Thibaut-Fatus/following{/other_user}","gists_url":"https://api.github.com/users/Thibaut-Fatus/gists{/gist_id}","starred_url":"https://api.github.com/users/Thibaut-Fatus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Thibaut-Fatus/subscriptions","organizations_url":"https://api.github.com/users/Thibaut-Fatus/orgs","repos_url":"https://api.github.com/users/Thibaut-Fatus/repos","events_url":"https://api.github.com/users/Thibaut-Fatus/events{/privacy}","received_events_url":"https://api.github.com/users/Thibaut-Fatus/received_events","type":"User","site_admin":false},"created_at":"2014-11-26T11:33:00Z","updated_at":"2014-11-26T11:33:00Z","author_association":"NONE","body":"@clintongormley I'm aware that the coordinating node could be any node in the cluster, and more than that that it can change from one request to the next one. And even if the fact that script files were not transferred between nodes was a question (we thought it might exist some synchro process between nodes), we also were aware that this wouldn't be done during a request.\n\nI'm still not fully confident that this explains our observation..\n\nThere is a point I can't understand regarding my comprehension of how ES works:\n\n(FYI we have 2 nodes, replication factor 2, 1 master, and the scripts update only one document, no params passed, it just tries to add a new entry to the json object)\n\nOur replication factor is 1, we had 2 nodes, green, thus the data must be stored on each of them. One explaination I see, and I hope there is another, is that the coordinator always selects the master to execute the request, thus requests with scripts stored on master work. **But I'm very concerned with this since it means that a coordinator could possibly chose always the same node to execute a request even if replication is > 0 ?**\n\nWhat scares me is that this explaination is compliant with the fact that we _always_ see an error when the request asks to execute a script stored only on slave node. \n\nIt might be that the coordinator asks the 2 nodes, master failed when the script does not exist locally, thus the coordinator refuses the response from the slave node even if it was correct. This would be a satisfying explaination.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64600688","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64600688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64600688,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NjAwNjg4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-26T13:00:05Z","updated_at":"2014-11-26T13:00:05Z","author_association":"CONTRIBUTOR","body":"@Thibaut-Fatus Ah you're talking about scripted updated.  OK, these are a bit different.  The script is always executed on the primary shard, then the new document is replicated in its entirety to the replica shard (so the replica doesn't execute the script).\n\nIn fact, there is an issue open (https://github.com/elasticsearch/elasticsearch/issues/8369) to change this behaviour to work better in a distributed environment.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64601066","html_url":"https://github.com/elastic/elasticsearch/issues/8651#issuecomment-64601066","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8651","id":64601066,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NjAxMDY2","user":{"login":"Thibaut-Fatus","id":7557608,"node_id":"MDQ6VXNlcjc1NTc2MDg=","avatar_url":"https://avatars1.githubusercontent.com/u/7557608?v=4","gravatar_id":"","url":"https://api.github.com/users/Thibaut-Fatus","html_url":"https://github.com/Thibaut-Fatus","followers_url":"https://api.github.com/users/Thibaut-Fatus/followers","following_url":"https://api.github.com/users/Thibaut-Fatus/following{/other_user}","gists_url":"https://api.github.com/users/Thibaut-Fatus/gists{/gist_id}","starred_url":"https://api.github.com/users/Thibaut-Fatus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Thibaut-Fatus/subscriptions","organizations_url":"https://api.github.com/users/Thibaut-Fatus/orgs","repos_url":"https://api.github.com/users/Thibaut-Fatus/repos","events_url":"https://api.github.com/users/Thibaut-Fatus/events{/privacy}","received_events_url":"https://api.github.com/users/Thibaut-Fatus/received_events","type":"User","site_admin":false},"created_at":"2014-11-26T13:03:31Z","updated_at":"2014-11-26T13:03:31Z","author_association":"NONE","body":"@clintongormley indeed this sounds like what we've seen ! Thanks a lot, hope this would get better with time.\n","performed_via_github_app":null}]