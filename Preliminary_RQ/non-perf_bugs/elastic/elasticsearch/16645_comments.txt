[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183653713","html_url":"https://github.com/elastic/elasticsearch/issues/16645#issuecomment-183653713","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645","id":183653713,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzY1MzcxMw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-13T11:56:56Z","updated_at":"2016-02-13T11:56:56Z","author_association":"CONTRIBUTOR","body":"> Or the test is incorrect, bulk broadcast deletes shouldn't be allowed, but they are working anyway under certain conditions.\n\nI'd say the test is incorrect.  Could they be working when the custom routing just happens to map to the same shard as default routing would?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/184135390","html_url":"https://github.com/elastic/elasticsearch/issues/16645#issuecomment-184135390","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645","id":184135390,"node_id":"MDEyOklzc3VlQ29tbWVudDE4NDEzNTM5MA==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2016-02-15T09:43:45Z","updated_at":"2016-02-15T09:43:45Z","author_association":"MEMBER","body":"Wow, the change was made almost a year ago, yet I see there is something missing in bulk. Seems like bulk has always worked differently around routing required hence why the test was left unchanged. This looks like an actual bug, digging and coming up with a PR.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/184251436","html_url":"https://github.com/elastic/elasticsearch/issues/16645#issuecomment-184251436","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645","id":184251436,"node_id":"MDEyOklzc3VlQ29tbWVudDE4NDI1MTQzNg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2016-02-15T15:22:36Z","updated_at":"2016-02-15T15:22:36Z","author_association":"MEMBER","body":"I did some digging, here are my findings. \n\nAs part of #10136 I should have removed broadcast delete from bulk as well, but I didn't realize it had a completely different code path for bulk, so it was left behind, which is why the test was still testing the broadcast delete.\n\nThe leftover broadcast delete for bulk is broken in many ways though:\n- one delete item becomes multiple delete requests, one per shard. but the response item is only one, so if one fails, you'll see the failure in the bulk response only if it was the last one returned from the shards.\n- the same delete request object was reused throughout the different shards. As a result, the version in the request was updated with the result of the last delete executed, which affects the following delete operations (if the shards are on the same node) by setting a version that is not `-3` (match_any) but rather `1`. This may cause stuff like `VersionConflictEngineException[[type1][1]: version conflict, current version [2] is higher or equal to the one provided [1]]` depending on the execution order and the number of shards.\n\nI have no idea why this test started failing only recently, but the reason why it failed was that in some cases the broadcast delete on the shard that contained the document to delete caused a version conflict, which may get returned or not as part of the bulk response (anyways the response wasn't checked in the test). I think the follow-up is simply to remove any leftover of broadcast delete and return a bulk item failure in case routing is required but it is not specified.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/187051789","html_url":"https://github.com/elastic/elasticsearch/issues/16645#issuecomment-187051789","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16645","id":187051789,"node_id":"MDEyOklzc3VlQ29tbWVudDE4NzA1MTc4OQ==","user":{"login":"itcuihao","id":9942270,"node_id":"MDQ6VXNlcjk5NDIyNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/9942270?v=4","gravatar_id":"","url":"https://api.github.com/users/itcuihao","html_url":"https://github.com/itcuihao","followers_url":"https://api.github.com/users/itcuihao/followers","following_url":"https://api.github.com/users/itcuihao/following{/other_user}","gists_url":"https://api.github.com/users/itcuihao/gists{/gist_id}","starred_url":"https://api.github.com/users/itcuihao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/itcuihao/subscriptions","organizations_url":"https://api.github.com/users/itcuihao/orgs","repos_url":"https://api.github.com/users/itcuihao/repos","events_url":"https://api.github.com/users/itcuihao/events{/privacy}","received_events_url":"https://api.github.com/users/itcuihao/received_events","type":"User","site_admin":false},"created_at":"2016-02-22T07:28:29Z","updated_at":"2016-02-22T07:28:29Z","author_association":"NONE","body":"This code is what role ?Thanks.\n","performed_via_github_app":null}]