[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/499805809","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-499805809","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":499805809,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5OTgwNTgwOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-07T08:40:17Z","updated_at":"2019-06-07T08:40:17Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/499805879","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-499805879","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":499805879,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5OTgwNTg3OQ==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-06-07T08:40:32Z","updated_at":"2019-06-07T08:40:32Z","author_association":"CONTRIBUTOR","body":"ping @s1monw ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/499876352","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-499876352","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":499876352,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5OTg3NjM1Mg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-06-07T13:03:38Z","updated_at":"2019-06-07T13:04:32Z","author_association":"MEMBER","body":"To make `LocalCheckpointTracker#contains` work correctly, we started restoring the LocalCheckpointTracker from an index commit (in #34474). However, that change causes both FollowingEngine and InternalEngine wrongly to ignore deletes. We fixed the issue by using  _id of soft-deletes to resolve the indexing strategy (#35230). Sadly, the new PrunePostingsMergePolicy (in #40741) would make the problem appear again. InternalEngine can incorrectly ignore deletes in following situation (copied from  #35230).\r\n\r\n1. Delete doc with seq=1 => engine will add a delete tombstone to Lucene  \r\n\r\n2. Flush a commit consisting of only the delete tombstone\r\n\r\n3. Force merge the commit. The new commit has one document but without _id (new step comparing to #35230)\r\n\r\n4. Index doc with seq=0 => engine will add that doc to Lucene but soft-deleted  \r\n\r\n5. Restart an engine with the merged commit (step 3); the engine will fill its LocalCheckpointTracker with the delete tombstone in the commit\r\n\r\n5. Replay the local translog in reverse order: index#0 then delete#1 \r\n\r\n6. When process index#0, an engine will add it into Lucene as a live doc because no _id exists in the current commit (we have one document but its _id is pruned).  The engine will advance the local checkpoint to 1 (seq#1 was restored from the commit - step 4).  \r\n\r\n7. When process delete#1, an engine will skip it because seq_no=1 is less than or equal to the local checkpoint. \r\n\r\nWe should have no document after recovering from translog, but here we have one. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/499888829","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-499888829","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":499888829,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5OTg4ODgyOQ==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-06-07T13:40:39Z","updated_at":"2019-06-07T13:41:15Z","author_association":"CONTRIBUTOR","body":"I wonder if we can revert the work from #35230, since we now initialize\r\n```\r\n            maxSeqNoOfUpdatesOrDeletes = new AtomicLong(SequenceNumbers.max(localCheckpointTracker.getMaxSeqNo(), translog.getMaxSeqNo()));\r\n```\r\n(#41161)\r\n\r\nAccording to comments here https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/index/engine/InternalEngine.java#L265 that initialization is an alternative solution to #35230? Sounds plausible, but I guess there could be something I am missing?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/499959278","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-499959278","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":499959278,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5OTk1OTI3OA==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-06-07T16:53:05Z","updated_at":"2019-06-07T16:53:05Z","author_association":"CONTRIBUTOR","body":"another failure on master: https://scans.gradle.com/s/6tkiqql4r3jra/tests/nfxodyych4uas-rx2ilcccihjwi?openStackTraces=WzBd","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500021136","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-500021136","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":500021136,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDAyMTEzNg==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-06-07T20:05:33Z","updated_at":"2019-06-07T20:05:33Z","author_association":"CONTRIBUTOR","body":"We discussed my suggestion above on another channel and came to the conclusion that doing this would violate the invariant that LocalCheckpointTracker is a cache of the checkpoint information in lucene.\r\n\r\nInstead we can fix this during ID pruning by not pruning out IDs after local-checkpoint of safe commit.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500093337","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-500093337","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":500093337,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDA5MzMzNw==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-06-08T04:30:36Z","updated_at":"2019-06-08T04:30:36Z","author_association":"MEMBER","body":"I have muted this test on master and 7.x","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500216416","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-500216416","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":500216416,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDIxNjQxNg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-06-09T14:31:23Z","updated_at":"2019-06-09T14:31:23Z","author_association":"MEMBER","body":"> Instead we can fix this during ID pruning by not pruning out IDs after local-checkpoint of safe commit.\r\n\r\nI am working on this solution.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501261676","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-501261676","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":501261676,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTI2MTY3Ng==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T12:59:26Z","updated_at":"2019-06-12T12:59:26Z","author_association":"CONTRIBUTOR","body":"Given the benchmark results, another option might be to recreate the version map in addition to the local checkpoint tracker. The version map would then truly reflect all operations above local checkpoint at all times.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501543756","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-501543756","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":501543756,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTU0Mzc1Ng==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-06-13T04:26:42Z","updated_at":"2019-06-13T04:26:42Z","author_association":"MEMBER","body":"> another option might be to recreate the version map in addition to the local checkpoint tracker.\r\n\r\nGreat suggestion. I am working on this alternative. It will be ready soon.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/503078358","html_url":"https://github.com/elastic/elasticsearch/issues/42979#issuecomment-503078358","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42979","id":503078358,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMzA3ODM1OA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-18T12:16:38Z","updated_at":"2019-06-18T12:16:38Z","author_association":"CONTRIBUTOR","body":"@dnhatn Can we close this one now?","performed_via_github_app":null}]