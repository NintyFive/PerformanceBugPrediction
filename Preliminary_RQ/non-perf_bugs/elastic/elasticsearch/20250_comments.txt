[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/243797560","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-243797560","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":243797560,"node_id":"MDEyOklzc3VlQ29tbWVudDI0Mzc5NzU2MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-08-31T15:15:53Z","updated_at":"2016-08-31T15:15:53Z","author_association":"CONTRIBUTOR","body":"@danielmitterdorfer could you take a look at this please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/243993433","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-243993433","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":243993433,"node_id":"MDEyOklzc3VlQ29tbWVudDI0Mzk5MzQzMw==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T07:01:49Z","updated_at":"2016-09-01T07:01:49Z","author_association":"MEMBER","body":"@clintongormley Yes, I can have a look.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244054063","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244054063","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244054063,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDA1NDA2Mw==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T11:42:27Z","updated_at":"2016-09-01T11:42:38Z","author_association":"MEMBER","body":"First of all, this is a great reproduction scenario. Thanks a lot.\n\nIn my tests, the majority of memory (around 570MB) was allocated in [`org.elasticsearch.search.query.QueryPhase.execute(SearchContext, IndexSearcher)`](https://github.com/elastic/elasticsearch/blob/2.3/core/src/main/java/org/elasticsearch/search/query/QueryPhase.java#L384) which calls Lucene's `IndexSearcher`. As - at this point - Lucene allocates memory on-heap I fear (A) that we cannot do much about that and (B) that this is not the intent of the request circuit breaker. We could estimate the expected size but I doubt that this is easy to predict.\n\nI think some of the confusion comes from the fact that we call this a \"request\" circuit breaker so you may think that this limits the total memory allocated in the context of a request. So maybe it makes sense to change the name of this breaker to make the intent clearer?\n\nWhat do you think about all this @dakrone?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244054909","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244054909","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244054909,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDA1NDkwOQ==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T11:46:43Z","updated_at":"2016-09-01T11:46:43Z","author_association":"MEMBER","body":"Btw, also the new in-flight request circuit breaker (added in 2.4) will not help because the actual request is just roughly 8MB large (so this is not the problem).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244065147","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244065147","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244065147,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDA2NTE0Nw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T12:35:53Z","updated_at":"2016-09-01T12:35:53Z","author_association":"CONTRIBUTOR","body":"I think the problem is more about expectations than naming since users seem to expect it to be a 100% correct thing while it is only a best-effort in practice (we cannot intercept every object allocation). But its goal **is** to abort requests that may use too much memory?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244067408","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244067408","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244067408,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDA2NzQwOA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T12:45:51Z","updated_at":"2016-09-01T12:45:51Z","author_association":"MEMBER","body":"@jpountz  my (implicit) reasoning was that it's the name that triggers this expectation. I agree with everything else that you've said.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244080982","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244080982","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244080982,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDA4MDk4Mg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T13:38:13Z","updated_at":"2016-09-01T13:38:32Z","author_association":"MEMBER","body":"Maybe we can add a limit for the number of disjuncts in the DisjunctionMaxQuery ? This would be similar to the BooleanQuery which throws an exception if the number of clauses is greater than 1024 (by default). \nI also tried with the BM25 similarity and it's worst, the query needs more than 400MB just for the norms (we allocate an array of 256 floats for each term query => 400,000 \\* 256 \\* 4). \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244082050","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244082050","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244082050,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDA4MjA1MA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T13:41:57Z","updated_at":"2016-09-01T13:41:57Z","author_association":"CONTRIBUTOR","body":"+1 @jimferenczi \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/244143838","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-244143838","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":244143838,"node_id":"MDEyOklzc3VlQ29tbWVudDI0NDE0MzgzOA==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-09-01T17:00:58Z","updated_at":"2016-09-01T17:00:58Z","author_association":"MEMBER","body":"I agree with Adrien that the expectation is certainly that something named \"request\" breaker will encompass all memory used by a request. I don't think it should be renamed, though, we may want to try and fold different allocations (like the dismax allocations) into it if possible so it eventually grows to be a true request breaker.\n\nIf we know the size of an array for each term, is it possible for us to hook into the disjunct generation so we can calculate the memory usage based on the number of disjuncts?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/374797281","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-374797281","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":374797281,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDc5NzI4MQ==","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"created_at":"2018-03-20T23:57:48Z","updated_at":"2018-03-20T23:57:48Z","author_association":"CONTRIBUTOR","body":"@jimczi - Is this still something we want to do? This issue has not been active in a while.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/528807412","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-528807412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":528807412,"node_id":"MDEyOklzc3VlQ29tbWVudDUyODgwNzQxMg==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2019-09-06T10:46:58Z","updated_at":"2019-09-06T10:46:58Z","author_association":"MEMBER","body":"> Maybe we can add a limit for the number of disjuncts in the DisjunctionMaxQuery ?\r\n\r\nThis has been implemented in Lucene in https://issues.apache.org/jira/browse/LUCENE-8811 and will be included in Lucene 9. As this will address the issue that has been originally brought up here, I'm closing this ticket.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/528811801","html_url":"https://github.com/elastic/elasticsearch/issues/20250#issuecomment-528811801","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20250","id":528811801,"node_id":"MDEyOklzc3VlQ29tbWVudDUyODgxMTgwMQ==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2019-09-06T11:04:12Z","updated_at":"2019-09-06T11:04:12Z","author_association":"MEMBER","body":"The follow-up work to make this limit configurable in Elasticsearch is now tracked in https://github.com/elastic/elasticsearch/issues/46433.","performed_via_github_app":null}]