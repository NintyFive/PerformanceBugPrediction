[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689300967","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689300967","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689300967,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTMwMDk2Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T04:52:19Z","updated_at":"2020-09-09T04:52:19Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra (:Core/Infra/Core)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689307691","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689307691","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689307691,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTMwNzY5MQ==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T05:14:18Z","updated_at":"2020-09-09T05:14:18Z","author_association":"MEMBER","body":"@iverase Git bisect shows that the issue in introduced by the Lucene version upgrade with commit e236054e095d2c5c927ad67064f0c1648ba9c673 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689318394","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689318394","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689318394,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTMxODM5NA==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T05:41:51Z","updated_at":"2020-09-09T05:41:51Z","author_association":"MEMBER","body":"Some more digging based on the stacktrace:\r\n\r\n* Lucene Apache Lucene recently changed in its master branch to use Inflater/Deflater's ability to provide a custom dictionary. \r\n* Deflater code in Java 11 internally [uses reflection](https://github.com/openjdk/jdk11u/blob/master/src/java.base/share/classes/java/util/zip/Deflater.java#L991). This code is introduced [since JDK 10](https://bugs.openjdk.java.net/browse/JDK-8193507). \r\n* Since JDK 12, the above usage of reflection is [removed](https://bugs.openjdk.java.net/browse/JDK-8212129).\r\n\r\nSo in theory, this error should happen for both JDK 10 and 11. But somehow, the tests do not fail for JDK 10. Only JDK 11 has this problem. I guess a possible fix is grant lucene code more security permissions. I could use help from Lucene experts to comment on this.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689325255","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689325255","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689325255,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTMyNTI1NQ==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T05:58:33Z","updated_at":"2020-09-09T06:41:53Z","author_association":"CONTRIBUTOR","body":"Thanks @ywangd for the investigation. The piece of code that is hitting the error was newly introduced as a work around of a Java bug. The Lucene issue is here:\r\n\r\nhttps://issues.apache.org/jira/browse/LUCENE-9500\r\n\r\nAnd the java bug is here:\r\n\r\nhttps://bugs.openjdk.java.net/browse/JDK-8252739\r\n\r\nIt makes sense that it fails in JDK11 but not in JDK10 because the bug is only present in 11 (and not all versions). So it seems the error happens when trying to initialise the BugfixDeflater_JDK8252739 class.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689428123","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689428123","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689428123,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTQyODEyMw==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T08:57:33Z","updated_at":"2020-09-09T08:59:51Z","author_association":"CONTRIBUTOR","body":"One thing I notice is that if I add the following line to the security.policy:\r\n\r\n```\r\n//// Everything else:\r\n\r\ngrant {\r\n  permission java.lang.RuntimePermission \"accessDeclaredMembers\";\r\n  ....\r\n```\r\n\r\nThe error goes away. On the other hand my expectations is that the following block should fix it:\r\n\r\n```\r\ngrant codeBase \"${codebase.lucene-core}\" {\r\n  // needed to allow MMapDirectory's \"unmap hack\" (die unmap hack, die)\r\n  // java 8 package\r\n  permission java.lang.RuntimePermission \"accessClassInPackage.sun.misc\";\r\n  // java 9 \"package\"\r\n  permission java.lang.RuntimePermission \"accessClassInPackage.jdk.internal.ref\";\r\n  permission java.lang.reflect.ReflectPermission \"suppressAccessChecks\";\r\n  // NOTE: also needed for RAMUsageEstimator size calculations\r\n  permission java.lang.RuntimePermission \"accessDeclaredMembers\";\r\n};\r\n```\r\nAs it is granting the permission to the Lucene-core jar, but not sure if I am reading this correctly.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689464760","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689464760","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689464760,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTQ2NDc2MA==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T10:08:43Z","updated_at":"2020-09-09T10:08:43Z","author_association":"CONTRIBUTOR","body":"This seems to be a Lucene bug. We open:\r\n\r\nhttps://issues.apache.org/jira/browse/LUCENE-9517","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/689580128","html_url":"https://github.com/elastic/elasticsearch/issues/62143#issuecomment-689580128","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62143","id":689580128,"node_id":"MDEyOklzc3VlQ29tbWVudDY4OTU4MDEyOA==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-09-09T13:56:39Z","updated_at":"2020-09-09T13:56:39Z","author_association":"MEMBER","body":"> This seems to be a Lucene bug. We open:\r\n> \r\n> https://issues.apache.org/jira/browse/LUCENE-9517\r\n\r\nThanks! I know close to nothing about Lucene, but now I believe this is the right fix. Without a `doPrivileged` block, the permission check is performed across the whole call stack. This basically means that you have to grant `accessDeclaredMembers` to everything to make it work as shown in your previous comment and it feels wrong.","performed_via_github_app":null}]