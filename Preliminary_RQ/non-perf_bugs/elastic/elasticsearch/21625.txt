{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21625","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21625/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21625/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21625/events","html_url":"https://github.com/elastic/elasticsearch/issues/21625","id":190071456,"node_id":"MDU6SXNzdWUxOTAwNzE0NTY=","number":21625,"title":"Term vectors query returns nothing in nested inner objects if term vectors are stored in the index","user":{"login":"gronostajo","id":1347866,"node_id":"MDQ6VXNlcjEzNDc4NjY=","avatar_url":"https://avatars3.githubusercontent.com/u/1347866?v=4","gravatar_id":"","url":"https://api.github.com/users/gronostajo","html_url":"https://github.com/gronostajo","followers_url":"https://api.github.com/users/gronostajo/followers","following_url":"https://api.github.com/users/gronostajo/following{/other_user}","gists_url":"https://api.github.com/users/gronostajo/gists{/gist_id}","starred_url":"https://api.github.com/users/gronostajo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gronostajo/subscriptions","organizations_url":"https://api.github.com/users/gronostajo/orgs","repos_url":"https://api.github.com/users/gronostajo/repos","events_url":"https://api.github.com/users/gronostajo/events{/privacy}","received_events_url":"https://api.github.com/users/gronostajo/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"assignees":[{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false}],"milestone":null,"comments":21,"created_at":"2016-11-17T15:03:04Z","updated_at":"2019-05-09T15:20:05Z","closed_at":"2019-05-07T06:47:19Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.0.0, 2.4.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_112-b15 64-bit\r\n\r\n**OS version**: Windows 10 v. 1607 (build 14393.447)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen making a `_termvectors` query to an object in a `\"type\": \"nested\"` field, response is returned with `\"term_vectors\" : { }` if vectors are stored (`\"store\": true` in mapping). If the object isn't nested or term vectors aren't stored, the object returned is filled properly (examples below). When TV storing is enabled then despite the fact that I'm unable to retrieve them, highlighting seems to be significantly faster, as if term vectors were present.\r\n\r\n\r\n**Steps to reproduce**:\r\n1. `PUT /mcve`\r\n\r\n```\r\n2.  PUT /mcve/ex/_mapping\r\n    {\r\n      \"properties\": {\r\n        \"parent\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"value\": {\"type\": \"text\", \"term_vector\": \"with_positions_offsets\", \"store\": true}\r\n          }\r\n        }\r\n      }\r\n    }\r\n```\r\n\r\n```\r\n3.  PUT /mcve/ex/ample\r\n    {\r\n      \"parent\": {\r\n        \"value\": \"hello world\"\r\n      }\r\n    }\r\n```\r\n\r\n```\r\n4.  PUT /mcve/ex/ample/_termvectors\r\n    {\r\n      \"fields\": [\"parent.value\"]\r\n    }\r\n```\r\n\r\nResponse:\r\n\r\n```\r\n{\r\n  \"_index\" : \"mcve\",\r\n  \"_type\" : \"ex\",\r\n  \"_id\" : \"ample\",\r\n  \"_version\" : 1,\r\n  \"found\" : true,\r\n  \"took\" : 1,\r\n  \"term_vectors\" : { }\r\n}\r\n```\r\n\r\nHowever, if I disable storing term vectors by changing this line in mapping:\r\n\r\n    \"value\": {\"type\": \"text\", \"term_vector\": \"with_positions_offsets\", \"store\": true}\r\n\r\nto this:\r\n\r\n    \"value\": {\"type\": \"text\"}\r\n\r\nthe result will be:\r\n\r\n```\r\n{\r\n  \"_index\" : \"mcve\",\r\n  \"_type\" : \"ex\",\r\n  \"_id\" : \"ample\",\r\n  \"_version\" : 1,\r\n  \"found\" : true,\r\n  \"took\" : 60,\r\n  \"term_vectors\" : {\r\n    \"parent.value\" : {\r\n      \"field_statistics\" : {\r\n        \"sum_doc_freq\" : 2,\r\n        \"doc_count\" : 1,\r\n        \"sum_ttf\" : 2\r\n      },\r\n      \"terms\" : {\r\n        /* ...snip... */\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nBut highlighting queries will be slower (tested on a ~80 MB index with ~600 documents), as if term vectors were in fact built previously.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n--\r\n\r\n[Related SO question](http://stackoverflow.com/q/40527963/1937994)","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}