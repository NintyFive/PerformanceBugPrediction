[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412784665","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-412784665","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":412784665,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjc4NDY2NQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T07:47:12Z","updated_at":"2018-08-14T07:47:12Z","author_association":"MEMBER","body":"> you need huge json document (I got issues with ~500 000 bytes json) with >250 nested objects\r\n\r\nIf you have big documents then retrieving the `_source` might be an issue in terms of performance but that's only the default behavior. For most of the cases this is enough but you've realized that in your case disabling `_source` and retrieving `doc_values` only is faster. I guess it is expected since you retrieve only a subset of the fields that are present in your nested documents ? Can you post a full recreation and some numbers of your perf tests ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412784755","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-412784755","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":412784755,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjc4NDc1NQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T07:47:35Z","updated_at":"2018-08-14T07:47:35Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412827516","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-412827516","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":412827516,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgyNzUxNg==","user":{"login":"s-Oleksii","id":1547602,"node_id":"MDQ6VXNlcjE1NDc2MDI=","avatar_url":"https://avatars0.githubusercontent.com/u/1547602?v=4","gravatar_id":"","url":"https://api.github.com/users/s-Oleksii","html_url":"https://github.com/s-Oleksii","followers_url":"https://api.github.com/users/s-Oleksii/followers","following_url":"https://api.github.com/users/s-Oleksii/following{/other_user}","gists_url":"https://api.github.com/users/s-Oleksii/gists{/gist_id}","starred_url":"https://api.github.com/users/s-Oleksii/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s-Oleksii/subscriptions","organizations_url":"https://api.github.com/users/s-Oleksii/orgs","repos_url":"https://api.github.com/users/s-Oleksii/repos","events_url":"https://api.github.com/users/s-Oleksii/events{/privacy}","received_events_url":"https://api.github.com/users/s-Oleksii/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T10:30:19Z","updated_at":"2018-08-14T10:30:19Z","author_association":"NONE","body":"@jimczi \r\n> only is faster\r\n\r\n**NO! Not only faster, Scalable!**\r\n\r\nI need all source of matched nested documents, my statement is: \"whatever the default behavior is - it should not be non-scalable\", do you agree with it? I have docs with 50 nested objects and it works fine, but with 250 nested objects performance goes down ~10x (from 20ms to 200ms approx). So it is like y = 2 * x linear dependency, elastic is intended to be used in highly loaded, multi-user environments so this linear algo seem to be awful.\r\nI can't post data which I use because it's proprietary.\r\n\r\nI don't see any sense of keeping default behavior which obviously can wreck your production's thoughoutput at some point. \r\n\r\nIn my case I also have another level of nested objects under 1st level of nested objects, such things can't be retrieved by docvalues\r\n\r\nIs it possible to store _source for each nested document? That would resolve scalability issue\r\n\r\nBtw, currently I decided to store whole json inside each nested document as a string in order to get it using docvalues","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412878390","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-412878390","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":412878390,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjg3ODM5MA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T13:50:40Z","updated_at":"2018-08-14T13:50:40Z","author_association":"MEMBER","body":"> NO! Not only faster, Scalable!\r\n\r\nNo need to yell ! I think there are ways to make it faster without changing how it is stored internally. For instance we parse the whole `_source` in json for each `inner_hit`. So the more nested documents you have the more it takes to build the \"new\" source of the `inner_hits`. We could cache the parsed json source and reuse it for `inner_hits` that appear in the same root document. I don't know how much this would save (we'd need some benchmarks) but that shouldn't be too difficult to do. I'll mark this issue with an adoptme tags because I don't have time to work on this now, would you like to work on this issue @serdyuk-alex ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413472523","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-413472523","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":413472523,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzQ3MjUyMw==","user":{"login":"s-Oleksii","id":1547602,"node_id":"MDQ6VXNlcjE1NDc2MDI=","avatar_url":"https://avatars0.githubusercontent.com/u/1547602?v=4","gravatar_id":"","url":"https://api.github.com/users/s-Oleksii","html_url":"https://github.com/s-Oleksii","followers_url":"https://api.github.com/users/s-Oleksii/followers","following_url":"https://api.github.com/users/s-Oleksii/following{/other_user}","gists_url":"https://api.github.com/users/s-Oleksii/gists{/gist_id}","starred_url":"https://api.github.com/users/s-Oleksii/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s-Oleksii/subscriptions","organizations_url":"https://api.github.com/users/s-Oleksii/orgs","repos_url":"https://api.github.com/users/s-Oleksii/repos","events_url":"https://api.github.com/users/s-Oleksii/events{/privacy}","received_events_url":"https://api.github.com/users/s-Oleksii/received_events","type":"User","site_admin":false},"created_at":"2018-08-16T08:47:57Z","updated_at":"2018-08-16T08:47:57Z","author_association":"NONE","body":"@jimczi Can you give tips where I need to look at in the code? \r\nI need following starting points: \r\ndocument creation in index, _source storage\r\n_source fetched after search completed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/413482012","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-413482012","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":413482012,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzQ4MjAxMg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-08-16T09:23:24Z","updated_at":"2018-08-16T09:23:24Z","author_association":"MEMBER","body":"You can start by looking at `org.elasticsearch.search.fetch.FetchPhase` and more precisely `FetchPhase#createNestedSearchHit` which re-parses the `_source` of the root object for every nested documents:https://github.com/elastic/elasticsearch/blob/15ff3da653c5dd9eae7f7a654a9ee6a931d478b7/server/src/main/java/org/elasticsearch/search/fetch/FetchPhase.java#L288","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/668274033","html_url":"https://github.com/elastic/elasticsearch/issues/32818#issuecomment-668274033","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32818","id":668274033,"node_id":"MDEyOklzc3VlQ29tbWVudDY2ODI3NDAzMw==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2020-08-03T22:34:12Z","updated_at":"2020-09-03T22:32:30Z","author_association":"MEMBER","body":"I merged #60494, which avoids reloading and reparsing the root document's _source for every inner hit. I suspect this would make a significant positive difference in your case.\r\n\r\nI'm going to close this issue for now, but please open a new one if you continue to see poor performance. Note there's already another issue about a high `inner_hits` overhead (but that doesn't seem related to loading _source): #56210.","performed_via_github_app":null}]