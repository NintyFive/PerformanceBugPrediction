{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38707","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38707/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38707/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38707/events","html_url":"https://github.com/elastic/elasticsearch/issues/38707","id":408717499,"node_id":"MDU6SXNzdWU0MDg3MTc0OTk=","number":38707,"title":"Reindex automatic type conversion failure","user":{"login":"synFK","id":42768670,"node_id":"MDQ6VXNlcjQyNzY4Njcw","avatar_url":"https://avatars2.githubusercontent.com/u/42768670?v=4","gravatar_id":"","url":"https://api.github.com/users/synFK","html_url":"https://github.com/synFK","followers_url":"https://api.github.com/users/synFK/followers","following_url":"https://api.github.com/users/synFK/following{/other_user}","gists_url":"https://api.github.com/users/synFK/gists{/gist_id}","starred_url":"https://api.github.com/users/synFK/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synFK/subscriptions","organizations_url":"https://api.github.com/users/synFK/orgs","repos_url":"https://api.github.com/users/synFK/repos","events_url":"https://api.github.com/users/synFK/events{/privacy}","received_events_url":"https://api.github.com/users/synFK/received_events","type":"User","site_admin":false},"labels":[{"id":1315850572,"node_id":"MDU6TGFiZWwxMzE1ODUwNTcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Reindex","name":":Distributed/Reindex","color":"0e8a16","default":false,"description":"Issues relating to reindex that are not caused by issues further down"}],"state":"closed","locked":false,"assignee":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"assignees":[{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2019-02-11T10:32:43Z","updated_at":"2019-07-02T13:57:39Z","closed_at":"2019-07-02T12:15:15Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 6.6.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_191\r\n\r\n**OS version**: Linux 4.4.0-116-generic #140-Ubuntu SMP x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen using the Reindex API and an explicit mapping on the destination index the automatic type conversion fails.\r\n(Remote) Source cluster runs Elasticsearch 2.4.5. Destination is 6.6.0. While the source index has a field named \"_result.user.id_\" of type `string` (analyzed) with a subfield \"_raw_\" of type `string` (not_analyzed), the destination index has a mapping with type `long` for this field. It also has the option `dynamic` set to `strict`. After reindexing a set of documents, the type of this field in the destination index is `string` while the mapping explicitly states a long. No exceptions occured while reindexing.\r\nFor testing purposes I add another field of type `long` to the destination index mapping called \"_id2_\" which I set to a constant string value \"12345\" with the aid of a little painless script. This string value is successfully auto converted to 12345 during reindexing.\r\n\r\n**Steps to reproduce**:\r\n 1. Source mapping:\r\n```\r\n\"searches\": {\r\n  \"properties\": {\r\n    \"result\": {\r\n      \"properties\": {\r\n        \"user\": {\r\n          \"properties\": {\r\n            \"id\": {\r\n              \"type\": \"string\",\r\n              \"fields\": {\r\n                \"raw\": {\r\n                  \"type\": \"string\",\r\n                  \"ignore_above\": 256,\r\n                  \"index\": \"not_analyzed\"\r\n                }\r\n              },\r\n              \"norms\": {\r\n                \"enabled\": false\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Destination template:\r\n```\r\n{\r\n  \"order\": 0,\r\n  \"index_patterns\": [ \"the_index-*\" ],\r\n  \"settings\": {\r\n    \"number_of_replicas\": 0,\r\n    \"number_of_shards\": 1,\r\n    \"refresh_interval\": \"5s\",\r\n    \"index.lifecycle.name\": \"default_lifecycle_policy\",\r\n    \"index.lifecycle.rollover_alias\": \"new_searches\"\r\n  },\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"result\": {\r\n          \"properties\": {\r\n            \"user\": {\r\n              \"properties\": {\r\n                \"id\": {\r\n                  \"type\": \"long\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 3. reindex body:\r\n```\r\n{\r\n  \"size\": 100\r\n  \"source\": {\r\n    \"remote\": {\r\n      \"host\": \"<source_host>\"\r\n    },\r\n    \"index\": \"old_searches\",\r\n    \"type\": \"searches\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"new_searches\",\r\n    \"type\": \"_doc\"\r\n  }\r\n}\r\n```\r\n 4. create index: `curl -X PUT <dest_host>/the_index-000001 -H \"Content-Type: application/json\"`\r\n 5. reindex: `curl -X POST <dest_host>/_reindex -H \"Content-Type: application/json\" -d \"$reindex_body\"`\r\n\r\n**Logs (not relevant)**:\r\n```\r\n{\r\n  \"took\" : 1082,\r\n  \"timed_out\" : false,\r\n  \"total\" : 100,\r\n  \"updated\" : 0,\r\n  \"created\" : 100,\r\n  \"deleted\" : 0,\r\n  \"batches\" : 1,\r\n  \"version_conflicts\" : 0,\r\n  \"noops\" : 0,\r\n  \"retries\" : {\r\n    \"bulk\" : 0,\r\n    \"search\" : 0\r\n  },\r\n  \"throttled_millis\" : 0,\r\n  \"requests_per_second\" : -1.0,\r\n  \"throttled_until_millis\" : 0,\r\n  \"failures\" : [ ]\r\n}\r\n```\r\n","closed_by":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"performed_via_github_app":null}