{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53835","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53835/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53835/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53835/events","html_url":"https://github.com/elastic/elasticsearch/issues/53835","id":584773239,"node_id":"MDU6SXNzdWU1ODQ3NzMyMzk=","number":53835,"title":"Potential NPE in AbstractBigArray.grow","user":{"login":"mattweber","id":173955,"node_id":"MDQ6VXNlcjE3Mzk1NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/173955?v=4","gravatar_id":"","url":"https://api.github.com/users/mattweber","html_url":"https://github.com/mattweber","followers_url":"https://api.github.com/users/mattweber/followers","following_url":"https://api.github.com/users/mattweber/following{/other_user}","gists_url":"https://api.github.com/users/mattweber/gists{/gist_id}","starred_url":"https://api.github.com/users/mattweber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mattweber/subscriptions","organizations_url":"https://api.github.com/users/mattweber/orgs","repos_url":"https://api.github.com/users/mattweber/repos","events_url":"https://api.github.com/users/mattweber/events{/privacy}","received_events_url":"https://api.github.com/users/mattweber/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-20T00:20:21Z","updated_at":"2020-03-20T13:28:26Z","closed_at":"2020-03-20T10:14:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I have a plugin that uses `BigArrays` obtained from `getHttpTransports`.  Occasionally, I will get NPE errors during resize and I have no idea what is triggering it.  Based on the stacktrace below the NPE is [here](https://github.com/elastic/elasticsearch/blob/v7.6.0/server/src/main/java/org/elasticsearch/common/util/AbstractBigArray.java#L100) and is the [recycler cache](https://github.com/elastic/elasticsearch/blob/v7.6.0/server/src/main/java/org/elasticsearch/common/util/AbstractBigArray.java#L34).  The only way the recycler is null when using a recycling version of big arrays is after [doClose](https://github.com/elastic/elasticsearch/blob/v7.6.0/server/src/main/java/org/elasticsearch/common/util/AbstractBigArray.java#L162) is called.  I am not closing and the exception happens inside of my try-with-resources block so it has not been automatically closed. \r\n\r\nThis is an example of how I am using big arrays and what is triggering the resize and NPE.\r\n```\r\ntry (final BytesStreamOutput respOut = new ReleasableBytesStreamOutput(bigArrays)) {\r\n    XContentFactory.jsonBuilder(respOut).value(searchResponse).flush();\r\n    // do stuff with respOut\r\n}\r\n```\r\n\r\nRelevant part of the stacktrace.\r\n```\r\n\"at org.elasticsearch.common.util.AbstractBigArray.grow(AbstractBigArray.java:100) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.util.AbstractBigArray.registerNewPage(AbstractBigArray.java:108) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.util.AbstractBigArray.newBytePage(AbstractBigArray.java:118) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.util.BigByteArray.resize(BigByteArray.java:143) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.util.BigArrays.resizeInPlace(BigArrays.java:440) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.util.BigArrays.resize(BigArrays.java:487) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.util.BigArrays.grow(BigArrays.java:505) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.io.stream.BytesStreamOutput.ensureCapacity(BytesStreamOutput.java:158) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.io.stream.ReleasableBytesStreamOutput.ensureCapacity(ReleasableBytesStreamOutput.java:71) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.io.stream.BytesStreamOutput.writeBytes(BytesStreamOutput.java:90) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.io.stream.StreamOutput.write(StreamOutput.java:517) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at com.fasterxml.jackson.core.json.UTF8JsonGenerator._flushBuffer(UTF8JsonGenerator.java:2039) ~[jackson-core-2.8.11.jar:2.8.11]\",\r\n\"at com.fasterxml.jackson.core.json.UTF8JsonGenerator.flush(UTF8JsonGenerator.java:1051) ~[jackson-core-2.8.11.jar:2.8.11]\",\r\n\"at org.elasticsearch.common.xcontent.json.JsonXContentGenerator.flush(JsonXContentGenerator.java:459) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.json.JsonXContentGenerator.writeRawField(JsonXContentGenerator.java:351) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\r\n\"at org.elasticsearch.common.xcontent.json.JsonXContentGenerator.writeRawField(JsonXContentGenerator.java:333) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.XContentBuilder.rawField(XContentBuilder.java:976) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.XContentHelper.writeRawField(XContentHelper.java:322) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.search.SearchHit.toInnerXContent(SearchHit.java:629) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.search.SearchHit.toXContent(SearchHit.java:565) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.search.SearchHits.toXContent(SearchHits.java:217) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.action.search.SearchResponseSections.toXContent(SearchResponseSections.java:106) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.action.search.SearchResponse.innerToXContent(SearchResponse.java:254) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.action.search.SearchResponse.toXContent(SearchResponse.java:234) ~[elasticsearch-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.XContentBuilder.value(XContentBuilder.java:857) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.XContentBuilder.value(XContentBuilder.java:850) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.XContentBuilder.unknownValue(XContentBuilder.java:828) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n\"at org.elasticsearch.common.xcontent.XContentBuilder.value(XContentBuilder.java:804) ~[elasticsearch-x-content-7.6.0.jar:7.6.0]\",\r\n```","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}