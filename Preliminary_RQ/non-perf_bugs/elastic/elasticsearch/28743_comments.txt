[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366968215","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366968215","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366968215,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk2ODIxNQ==","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T12:53:02Z","updated_at":"2018-02-20T12:53:02Z","author_association":"CONTRIBUTOR","body":"@elastic/es-distributed ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366973659","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366973659","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366973659,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk3MzY1OQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T13:15:30Z","updated_at":"2018-02-20T13:15:30Z","author_association":"MEMBER","body":"This looks like another Netty's recycler issue, but it should be disabled in 5.2.2 thanks to #22452.\r\n\r\n@redlus Can you please provide the JVM options for the node `esdatacold2-prod`? They are printed out in the logs at startup time (something like `[INFO ][o.e.n.Node] [node-0] JVM arguments [...]` ) or you can list them using `curl -XGET 'http://localhost:9200/_nodes/node-0/jvm?pretty'`\r\n\r\nAlso, a heap dump would help to identify the objects that fill the memory.\r\n\r\n```\r\nelasticsearch[esdatacold2-prod][[transport_server_worker.default]][T#14] [DAEMON] RUNNABLE tid: 60\r\njava.lang.OutOfMemoryError.<init>() OutOfMemoryError.java:48\r\nio.netty.buffer.PoolArena$HeapArena.newUnpooledChunk(int) PoolArena.java:661\r\n\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366987228","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366987228","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366987228,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk4NzIyOA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:05:43Z","updated_at":"2018-02-20T14:05:43Z","author_association":"MEMBER","body":"@tlrx The JVM arguments are not logged at startup nor available in the API in 5.2.2, that is only since 5.4.1 (#24450, #24451). Here, to have the JVM arguments, the user needs to shell into an instance running Elasticsearch and execute `jps -l -m -v` and share the output.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366989064","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366989064","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366989064,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk4OTA2NA==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:12:11Z","updated_at":"2018-02-20T14:12:11Z","author_association":"MEMBER","body":"Thanks @jasontedor. I thought it was older but I admit I didn't double checked.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366994701","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366994701","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366994701,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5NDcwMQ==","user":{"login":"farin99","id":683343,"node_id":"MDQ6VXNlcjY4MzM0Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/683343?v=4","gravatar_id":"","url":"https://api.github.com/users/farin99","html_url":"https://github.com/farin99","followers_url":"https://api.github.com/users/farin99/followers","following_url":"https://api.github.com/users/farin99/following{/other_user}","gists_url":"https://api.github.com/users/farin99/gists{/gist_id}","starred_url":"https://api.github.com/users/farin99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/farin99/subscriptions","organizations_url":"https://api.github.com/users/farin99/orgs","repos_url":"https://api.github.com/users/farin99/repos","events_url":"https://api.github.com/users/farin99/events{/privacy}","received_events_url":"https://api.github.com/users/farin99/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:30:59Z","updated_at":"2018-02-20T14:30:59Z","author_association":"NONE","body":"We will upload the full memory dump (17 GB, 6GB compressed), until then here is an export form yourKit of the objects by class. Hope it will help.\r\n[Objects-by-class.csv.zip](https://github.com/elastic/elasticsearch/files/1740399/Objects-by-class.csv.zip)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366994753","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366994753","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366994753,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5NDc1Mw==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:31:11Z","updated_at":"2018-02-20T14:31:11Z","author_association":"NONE","body":"@tlrx here are the JVM options, along with GC/memory pools if relevant:\r\n\r\n```\r\n{\r\n  \"jvm\": {\r\n    \"pid\": 77144,\r\n    \"version\": \"1.8.0_151\",\r\n    \"vm_name\": \"OpenJDK 64-Bit Server VM\",\r\n    \"vm_version\": \"25.151-b12\",\r\n    \"vm_vendor\": \"Oracle Corporation\",\r\n    \"start_time_in_millis\": 1519136454276,\r\n    \"mem\": {\r\n      \"heap_init_in_bytes\": 16106127360,\r\n      \"heap_max_in_bytes\": 16036397056,\r\n      \"non_heap_init_in_bytes\": 2555904,\r\n      \"non_heap_max_in_bytes\": 0,\r\n      \"direct_max_in_bytes\": 16036397056\r\n    },\r\n    \"gc_collectors\": [\r\n      \"ParNew\",\r\n      \"ConcurrentMarkSweep\"\r\n    ],\r\n    \"memory_pools\": [\r\n      \"Code Cache\",\r\n      \"Metaspace\",\r\n      \"Compressed Class Space\",\r\n      \"Par Eden Space\",\r\n      \"Par Survivor Space\",\r\n      \"CMS Old Gen\"\r\n    ],\r\n    \"using_compressed_ordinary_object_pointers\": \"true\"\r\n  }\r\n}\r\n```\r\n\r\nThe heap dump is pretty large, but I'll upload it soon.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366996540","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366996540","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366996540,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5NjU0MA==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:36:53Z","updated_at":"2018-02-20T14:37:13Z","author_association":"MEMBER","body":"> We will upload the full memory dump (17 GB, 6GB compressed), until then here is an export form yourKit of the objects by class. Hope it will help.\r\n\r\n@farin99 @redlus A full memory dump might contain sensitive data so I'm not sure you want to make it public. But an overview of the biggest objects can help.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366997065","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366997065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366997065,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5NzA2NQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:38:09Z","updated_at":"2018-02-20T14:38:09Z","author_association":"MEMBER","body":"Thanks @redlus. Can you apply [Jason's comment](https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366987228) and provide the output please?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366998022","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366998022","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366998022,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5ODAyMg==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:40:23Z","updated_at":"2018-02-20T14:51:09Z","author_association":"NONE","body":"@tlrx for sure..:\r\n77144 org.elasticsearch.bootstrap.Elasticsearch -p /var/run/elasticsearch/elasticsearch.pid --quiet -Edefault.path.logs=/var/log/elasticsearch -Edefault.path.data=/var/lib/elasticsearch -Edefault.path.conf=/etc/elasticsearch -Xms15g -Xmx15g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError -XX:MaxGCPauseMillis=800 -Des.path.home=/usr/share/elasticsearch","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366998857","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366998857","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366998857,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5ODg1Nw==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:42:59Z","updated_at":"2018-02-20T14:42:59Z","author_association":"NONE","body":"@tlrx also, does the .csv file @farin99 uploaded contain the object requested?\r\ne.g.\r\n![image](https://user-images.githubusercontent.com/7827282/36430128-114a998a-165d-11e8-849d-740507df2b36.png)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366999842","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366999842","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366999842,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5OTg0Mg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:46:20Z","updated_at":"2018-02-20T14:46:20Z","author_association":"MEMBER","body":"@redlus You have to run this as the same user that runs the Elasticsearch process and on a machine where one of the instances in your cluster is running.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/366999892","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-366999892","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":366999892,"node_id":"MDEyOklzc3VlQ29tbWVudDM2Njk5OTg5Mg==","user":{"login":"farin99","id":683343,"node_id":"MDQ6VXNlcjY4MzM0Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/683343?v=4","gravatar_id":"","url":"https://api.github.com/users/farin99","html_url":"https://github.com/farin99","followers_url":"https://api.github.com/users/farin99/followers","following_url":"https://api.github.com/users/farin99/following{/other_user}","gists_url":"https://api.github.com/users/farin99/gists{/gist_id}","starred_url":"https://api.github.com/users/farin99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/farin99/subscriptions","organizations_url":"https://api.github.com/users/farin99/orgs","repos_url":"https://api.github.com/users/farin99/repos","events_url":"https://api.github.com/users/farin99/events{/privacy}","received_events_url":"https://api.github.com/users/farin99/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:46:28Z","updated_at":"2018-02-20T14:46:28Z","author_association":"NONE","body":"Here is an overview of the biggest objects \r\n[Objects-with-biggest-retained-size.csv.zip](https://github.com/elastic/elasticsearch/files/1740456/Objects-with-biggest-retained-size.csv.zip)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367001641","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367001641","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367001641,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAwMTY0MQ==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T14:51:52Z","updated_at":"2018-02-20T14:51:52Z","author_association":"NONE","body":"@jasontedor right, I've amended the previous comment with the correct information.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367005562","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367005562","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367005562,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAwNTU2Mg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T15:03:37Z","updated_at":"2018-02-20T15:03:37Z","author_association":"MEMBER","body":"Do you set `index.merge.scheduler.max_thread_count` on your cold nodes with the spinning disks? If so, would you please share the value that you're setting it to? If not, would you please set `index.merge.scheduler.max_thread_count` to `1`?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367007864","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367007864","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367007864,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAwNzg2NA==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T15:10:38Z","updated_at":"2018-02-20T15:10:38Z","author_association":"NONE","body":"We haven't changed this setting, so I believe it is set to the default (4, in our case).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367010159","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367010159","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367010159,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAxMDE1OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T15:17:45Z","updated_at":"2018-02-20T15:17:45Z","author_association":"MEMBER","body":"I encourage you to change this setting to `1` for your cold nodes with spinning disks. Please let us know what impact this has on your cluster after making this change.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367012596","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367012596","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367012596,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAxMjU5Ng==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T15:24:30Z","updated_at":"2018-02-20T15:24:30Z","author_association":"NONE","body":"I will try changing this setting to check if it affects the crash. However, the fact that a default setting actually causes the process to crash is a bit bizarre. Shouldn't there be some kind of protection against such cases?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367019535","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367019535","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367019535,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAxOTUzNQ==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T15:45:10Z","updated_at":"2018-02-20T15:45:10Z","author_association":"NONE","body":"Two quick questions about merge thread count:\r\n1. This seems to be an index setting. Is there a way to set this per node?\r\n2. How many threads would the merge module run if two indices with different max_thread_count settings are located in the same node (with a spinning disk)? i.e., one index with 4 and one index with 1.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367020155","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367020155","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367020155,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzAyMDE1NQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T15:46:55Z","updated_at":"2018-02-20T15:46:55Z","author_association":"MEMBER","body":"> This seems to be an index setting. Is there a way to set this per node?\r\n\r\nNo, you can only set this an index setting; you would have to set this as part your migration to your cold tier.\r\n\r\n> How many threads would the merge module run if two indices with different max_thread_count settings are located in the same node (with a spinning disk)? i.e., one index with 4 and one index with 1.\r\n\r\nUp to five concurrent threads could be running here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367063585","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367063585","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367063585,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzA2MzU4NQ==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-20T17:59:33Z","updated_at":"2018-02-20T17:59:33Z","author_association":"NONE","body":"@tlrx @jasontedor\r\nIf this helps, I now have the full compressed dump available. We can discuss how to privately let you access this file (to prevent this information from being publicly available).\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367293215","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367293215","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367293215,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzI5MzIxNQ==","user":{"login":"farin99","id":683343,"node_id":"MDQ6VXNlcjY4MzM0Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/683343?v=4","gravatar_id":"","url":"https://api.github.com/users/farin99","html_url":"https://github.com/farin99","followers_url":"https://api.github.com/users/farin99/followers","following_url":"https://api.github.com/users/farin99/following{/other_user}","gists_url":"https://api.github.com/users/farin99/gists{/gist_id}","starred_url":"https://api.github.com/users/farin99/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/farin99/subscriptions","organizations_url":"https://api.github.com/users/farin99/orgs","repos_url":"https://api.github.com/users/farin99/repos","events_url":"https://api.github.com/users/farin99/events{/privacy}","received_events_url":"https://api.github.com/users/farin99/received_events","type":"User","site_admin":false},"created_at":"2018-02-21T11:10:37Z","updated_at":"2018-02-21T12:30:57Z","author_association":"NONE","body":"> Up to five concurrent threads could be running here.\r\n\r\n@jasontedor so if I have 100  indexes (index.merge.scheduler.max_thread_count=4 in each one ), I could have 400 threads running at the same time? Are they limited by a thread pool of any kind? \r\n\r\n> I encourage you to change this setting to 1 for your cold nodes with spinning disks. Please let us know what impact this has on your cluster after making this change.\r\n\r\nHow will this prevent many threads from running on a spinning disk node if such a node has 100 indices set to 1 thread per index?\r\n\r\nRegarding the dump, there are many threads in WAITING state. Most of them has the same call stack :\r\n```\r\nelasticsearch[esdatacold2-prod][bulk][T#6] [DAEMON] State: WAITING tid: 115\r\nsun.misc.Unsafe.park(boolean, long) Unsafe.java\r\njava.util.concurrent.locks.LockSupport.park(Object) LockSupport.java:175\r\njava.util.concurrent.LinkedTransferQueue.awaitMatch(LinkedTransferQueue$Node, LinkedTransferQueue$Node, Object, boolean, long) LinkedTransferQueue.java:737\r\njava.util.concurrent.LinkedTransferQueue.xfer(Object, boolean, int, long) LinkedTransferQueue.java:647\r\njava.util.concurrent.LinkedTransferQueue.take() LinkedTransferQueue.java:1269\r\norg.elasticsearch.common.util.concurrent.SizeBlockingQueue.take() SizeBlockingQueue.java:161\r\njava.util.concurrent.ThreadPoolExecutor.getTask() ThreadPoolExecutor.java:1074\r\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor$Worker) ThreadPoolExecutor.java:1134\r\njava.util.concurrent.ThreadPoolExecutor\r\n```\r\n[All threads callstacks can be found here](https://pastebin.com/6q8GtSeg)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367422133","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367422133","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367422133,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzQyMjEzMw==","user":{"login":"redlus","id":7827282,"node_id":"MDQ6VXNlcjc4MjcyODI=","avatar_url":"https://avatars3.githubusercontent.com/u/7827282?v=4","gravatar_id":"","url":"https://api.github.com/users/redlus","html_url":"https://github.com/redlus","followers_url":"https://api.github.com/users/redlus/followers","following_url":"https://api.github.com/users/redlus/following{/other_user}","gists_url":"https://api.github.com/users/redlus/gists{/gist_id}","starred_url":"https://api.github.com/users/redlus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/redlus/subscriptions","organizations_url":"https://api.github.com/users/redlus/orgs","repos_url":"https://api.github.com/users/redlus/repos","events_url":"https://api.github.com/users/redlus/events{/privacy}","received_events_url":"https://api.github.com/users/redlus/received_events","type":"User","site_admin":false},"created_at":"2018-02-21T18:24:06Z","updated_at":"2018-02-21T18:24:06Z","author_association":"NONE","body":"@jasontedor \r\n\r\n> I encourage you to change this setting to 1 for your cold nodes with spinning disks. Please let us know what impact this has on your cluster after making this change.\r\n\r\nI'm running one of the spinning disk nodes for the last couple of hours after setting index.merge.scheduler.max_thread_count=1 to all of the indices it contains. These indices are marked for rerouting to other nodes (with SSD disks), and for now everything seems to work.\r\n\r\n-----\r\n\r\nThis poses two issues:\r\n\r\n> How many threads would the merge module run if two indices with different max_thread_count settings are located in the same node (with a spinning disk)? i.e., one index with 4 and one index with 1.\r\n> > Up to five concurrent threads could be running here.\r\n\r\n1. The fact that the default setting of this parameter causes spinning disk nodes to crash is troubling. There must be some memory / thread pool bug which should be isolated here. Also, if I understand correctly, rerouting many indices into such spinning disk nodes may actually cause an out of memory exception again - as more threads handle merging (as it is 1 thread per index). This thought is alarming is well.\r\n@tlrx, is there any other information needed to tackle this, or the dump information we have already provided is enough?\r\n\r\n> This seems to be an index setting. Is there a way to set this per node?\r\n> > No, you can only set this an index setting; you would have to set this as part your migration to your cold tier.\r\n\r\n2. A strategy where this parameter is set per index is odd in my opinion. When I want to move these indices to other nodes I must actually monitor when the reroute has finished and only when they reside in the new (SSD) nodes I can re-set index.merge.scheduler.max_thread_count back to 4 - otherwise risking a crash in these (originating) HDD nodes. This is especially true if the effect of such a parameter is based on hardware (the node) and not the data (the shards/indices).\r\n#feature_request...","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367425081","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367425081","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367425081,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzQyNTA4MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-21T18:33:21Z","updated_at":"2018-02-21T18:33:21Z","author_association":"MEMBER","body":"For the issues that you raise, please see #28555, I think it covers everything?\r\n\r\nThis is the first time that I have ever seen this lead to out of memory issues. Previously we assumed spinning and required adjustment if on SSD, today we do the opposite. We do document that on spinning disks users should set this setting to 1.\r\n\r\nI am going to close this as we've solved your immediate production issue and I think the issues you raised are covered in an existing issue.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/367652458","html_url":"https://github.com/elastic/elasticsearch/issues/28743#issuecomment-367652458","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28743","id":367652458,"node_id":"MDEyOklzc3VlQ29tbWVudDM2NzY1MjQ1OA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-02-22T11:28:29Z","updated_at":"2018-02-22T11:28:29Z","author_association":"MEMBER","body":"I forgot to reply to this concern, sorry:\r\n\r\n>Regarding the dump, there are many threads in WAITING state. Most of them has the same call stack :\r\n```\r\nelasticsearch[esdatacold2-prod][bulk][T#6] [DAEMON] State: WAITING tid: 115\r\nsun.misc.Unsafe.park(boolean, long) Unsafe.java\r\njava.util.concurrent.locks.LockSupport.park(Object) LockSupport.java:175\r\njava.util.concurrent.LinkedTransferQueue.awaitMatch(LinkedTransferQueue$Node, LinkedTransferQueue$Node, Object, boolean, long) LinkedTransferQueue.java:737\r\njava.util.concurrent.LinkedTransferQueue.xfer(Object, boolean, int, long) LinkedTransferQueue.java:647\r\njava.util.concurrent.LinkedTransferQueue.take() LinkedTransferQueue.java:1269\r\norg.elasticsearch.common.util.concurrent.SizeBlockingQueue.take() SizeBlockingQueue.java:161\r\njava.util.concurrent.ThreadPoolExecutor.getTask() ThreadPoolExecutor.java:1074\r\njava.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor$Worker) ThreadPoolExecutor.java:1134\r\njava.util.concurrent.ThreadPoolExecutor\r\n```\r\n\r\nThis is normal, these are threads that are parked waiting for a task to execute.","performed_via_github_app":null}]