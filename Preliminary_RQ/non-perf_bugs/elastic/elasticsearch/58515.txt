{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/58515","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58515/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58515/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58515/events","html_url":"https://github.com/elastic/elasticsearch/issues/58515","id":644908608,"node_id":"MDU6SXNzdWU2NDQ5MDg2MDg=","number":58515,"title":"SLM Throwing IllegalArgumentException during snapshot retention ","user":{"login":"LukeEvans","id":1682349,"node_id":"MDQ6VXNlcjE2ODIzNDk=","avatar_url":"https://avatars3.githubusercontent.com/u/1682349?v=4","gravatar_id":"","url":"https://api.github.com/users/LukeEvans","html_url":"https://github.com/LukeEvans","followers_url":"https://api.github.com/users/LukeEvans/followers","following_url":"https://api.github.com/users/LukeEvans/following{/other_user}","gists_url":"https://api.github.com/users/LukeEvans/gists{/gist_id}","starred_url":"https://api.github.com/users/LukeEvans/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/LukeEvans/subscriptions","organizations_url":"https://api.github.com/users/LukeEvans/orgs","repos_url":"https://api.github.com/users/LukeEvans/repos","events_url":"https://api.github.com/users/LukeEvans/events{/privacy}","received_events_url":"https://api.github.com/users/LukeEvans/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-06-24T20:07:33Z","updated_at":"2020-06-25T19:35:09Z","closed_at":"2020-06-25T19:33:57Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nFound in 7.7.1\r\n\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIt seems while SLM is checking for eligible snapshots to remove, if the number successful snapshots is less than the `minimumSnapshotCount`,  the following stack trace is seen:\r\n\r\n```\r\n[instance-0000000039] error during snapshot retention task\r\njava.lang.IllegalArgumentException: -5\r\n\tat java.util.stream.ReferencePipeline.limit(ReferencePipeline.java:469) ~[?:?]\r\n\tat org.elasticsearch.xpack.core.slm.SnapshotRetentionConfiguration.lambda$getSnapshotDeletionPredicate$6(SnapshotRetentionConfiguration.java:195) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask.snapshotEligibleForDeletion(SnapshotRetentionTask.java:245) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask$1.lambda$onResponse$0(SnapshotRetentionTask.java:163) ~[?:?]\r\n\tat java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:176) ~[?:?]\r\n\tat java.util.ArrayList$ArrayListSpliterator.forEachRemaining(ArrayList.java:1624) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474) ~[?:?]\r\n\tat java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:913) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) ~[?:?]\r\n\tat java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:578) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask$1.lambda$onResponse$1(SnapshotRetentionTask.java:164) ~[?:?]\r\n\tat java.util.stream.Collectors.lambda$uniqKeysMapAccumulator$1(Collectors.java:178) ~[?:?]\r\n\tat java.util.stream.ReduceOps$3ReducingSink.accept(ReduceOps.java:169) ~[?:?]\r\n\tat java.util.concurrent.ConcurrentHashMap$EntrySpliterator.forEachRemaining(ConcurrentHashMap.java:3652) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474) ~[?:?]\r\n\tat java.util.stream.ReduceOps$ReduceOp.evaluateSequential(ReduceOps.java:913) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) ~[?:?]\r\n\tat java.util.stream.ReferencePipeline.collect(ReferencePipeline.java:578) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask$1.onResponse(SnapshotRetentionTask.java:161) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask$1.onResponse(SnapshotRetentionTask.java:152) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask.lambda$getAllRetainableSnapshots$9(SnapshotRetentionTask.java:267) ~[?:?]\r\n\tat org.elasticsearch.xpack.slm.SnapshotRetentionTask.lambda$getAllRetainableSnapshots$12(SnapshotRetentionTask.java:285) ~[?:?]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:70) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:64) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.ActionListener$2.onResponse(ActionListener.java:89) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.admin.cluster.snapshots.get.TransportGetSnapshotsAction.masterOperation(TransportGetSnapshotsAction.java:151) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.admin.cluster.snapshots.get.TransportGetSnapshotsAction.masterOperation(TransportGetSnapshotsAction.java:58) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:99) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.lambda$doStart$3(TransportMasterNodeAction.java:170) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:692) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.7.0.jar:7.7.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:832) [?:?]\r\n```\r\n\r\n**Steps to reproduce**:\r\nUnknown \r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}