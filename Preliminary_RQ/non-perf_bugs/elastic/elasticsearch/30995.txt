{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30995","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30995/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30995/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30995/events","html_url":"https://github.com/elastic/elasticsearch/issues/30995","id":328052281,"node_id":"MDU6SXNzdWUzMjgwNTIyODE=","number":30995,"title":"repository-s3 ignores endpoint setting and protocol","user":{"login":"kozmaz87","id":4070837,"node_id":"MDQ6VXNlcjQwNzA4Mzc=","avatar_url":"https://avatars1.githubusercontent.com/u/4070837?v=4","gravatar_id":"","url":"https://api.github.com/users/kozmaz87","html_url":"https://github.com/kozmaz87","followers_url":"https://api.github.com/users/kozmaz87/followers","following_url":"https://api.github.com/users/kozmaz87/following{/other_user}","gists_url":"https://api.github.com/users/kozmaz87/gists{/gist_id}","starred_url":"https://api.github.com/users/kozmaz87/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kozmaz87/subscriptions","organizations_url":"https://api.github.com/users/kozmaz87/orgs","repos_url":"https://api.github.com/users/kozmaz87/repos","events_url":"https://api.github.com/users/kozmaz87/events{/privacy}","received_events_url":"https://api.github.com/users/kozmaz87/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-05-31T09:01:01Z","updated_at":"2018-06-07T08:28:52Z","closed_at":"2018-06-07T08:28:52Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n<!-- Bug report -->\r\n\r\n**Version: 6.2.4, Build: ccec39f/2018-04-12T20:37:28.497551Z, JVM: 1.8.0_171** (`bin/elasticsearch --version`):\r\n\r\n**Plugins installed**: [discovery-ec2, repository-s3, search-guard-6]\r\n\r\n**JVM version** (`java -version`): \r\nopenjdk version \"1.8.0_171\"\r\nOpenJDK Runtime Environment (build 1.8.0_171-8u171-b11-0ubuntu0.16.04.1-b11)\r\nOpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux ip-10-52-6-89 4.4.0-1057-aws #66-Ubuntu SMP Thu May 3 12:49:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen calling the s3 snapshot functionality over the API as described by documentation: https://www.elastic.co/guide/en/elasticsearch/plugins/current/repository-s3-client.html the endpoint and protocol attributes are largely ignored. The protocol changes but the port remains 443 and the endpoint is just ignored no matter having specified it in the call settings or the keystore. Elasticsearch just goes to a non-regional endpoint. My use case is in a private subnet of an AWS VPC. I can make a gateway to a regional endpoint of S3 but not to s3.amazonaws.com. When I provide the endpoint: s3.eu-west-2.amazonaws.com it gets ignored.\r\n\r\n```\r\n\r\n{\"error\":{\"root_cause\":[{\"type\":\"sdk_client_exception\",\"reason\":\"sdk_client_exception: Unable to execute HTTP request: Connect to es-snapshot-bucket-name.s3.amazonaws.com:443 [es-snapshot-bucket-name.s3.amazonaws.com/52.216.132.171] failed: connect timed out\"}],\"type\":\"repository_exception\",\"reason\":\"[my_s3_repository] failed to create repository\",\"caused_by\":{\"type\":\"sdk_client_exception\",\"reason\":\"sdk_client_exception: Unable to execute HTTP request: Connect to es-snapshot-bucket-name.s3.amazonaws.com:443 [es-snapshot-bucket-name.s3.amazonaws.com/52.216.132.171] failed: connect timed out\",\"caused_by\":{\"type\":\"i_o_exception\",\"reason\":\"Connect to es-snapshot-bucket-name.s3.amazonaws.com:443 [es-snapshot-bucket-name.s3.amazonaws.com/52.216.132.171] failed: connect timed out\",\"caused_by\":{\"type\":\"i_o_exception\",\"reason\":\"connect timed out\"}}}},\"status\":500}\r\n\r\n```\r\nEven though\r\n```\r\nroot@ip-10-52-6-89:/usr/share/elasticsearch/bin# netcat -v s3.eu-west-2.amazonaws.com 80\r\nConnection to s3.eu-west-2.amazonaws.com 80 port [tcp/http] succeeded!\r\n^C\r\nroot@ip-10-52-6-89:/usr/share/elasticsearch/bin# netcat -v s3.eu-west-2.amazonaws.com 443\r\nConnection to s3.eu-west-2.amazonaws.com 443 port [tcp/https] succeeded!\r\n^C\r\n```\r\n**Steps to reproduce**:\r\nCreate private subnet with no generic internet gateway. Create S3 endpoint with VPC endpoints API. \r\nTry snapshotting ES deployed in these private subnets having defined endpoint to be your regional endpoint you created the gateway for. See it fail.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}