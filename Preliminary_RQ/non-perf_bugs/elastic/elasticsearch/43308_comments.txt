[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/502926279","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-502926279","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":502926279,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMjkyNjI3OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-18T03:00:03Z","updated_at":"2019-06-18T03:00:03Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/503721338","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-503721338","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":503721338,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMzcyMTMzOA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-06-19T19:50:07Z","updated_at":"2019-06-19T19:50:07Z","author_association":"MEMBER","body":"We use `span` queries here in order to avoid the combinatorial explosion on multi-word synonyms (see https://issues.apache.org/jira/browse/LUCENE-7699 for some context).\r\n The score for `span` queries is computed from all terms that appear in the query even if only a small portion of them matches in the document. So it is expected that a query with a lot of multi-word synonyms have a bigger score than without. However I don't consider this as an issue since the score should be comparable between documents and we don't want to give higher scores to documents that match an alternative path. Can you explain why this is a problem for you and what you think would be the expected behavior ? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/504772241","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-504772241","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":504772241,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNDc3MjI0MQ==","user":{"login":"bbfsdev","id":1877419,"node_id":"MDQ6VXNlcjE4Nzc0MTk=","avatar_url":"https://avatars0.githubusercontent.com/u/1877419?v=4","gravatar_id":"","url":"https://api.github.com/users/bbfsdev","html_url":"https://github.com/bbfsdev","followers_url":"https://api.github.com/users/bbfsdev/followers","following_url":"https://api.github.com/users/bbfsdev/following{/other_user}","gists_url":"https://api.github.com/users/bbfsdev/gists{/gist_id}","starred_url":"https://api.github.com/users/bbfsdev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bbfsdev/subscriptions","organizations_url":"https://api.github.com/users/bbfsdev/orgs","repos_url":"https://api.github.com/users/bbfsdev/repos","events_url":"https://api.github.com/users/bbfsdev/events{/privacy}","received_events_url":"https://api.github.com/users/bbfsdev/received_events","type":"User","site_admin":false},"created_at":"2019-06-23T17:39:52Z","updated_at":"2019-06-23T17:39:52Z","author_association":"NONE","body":"Hello @jimczi I read your comment and the Lucene issue. I cannot say that I fully understand combinatorial explosion and span queries but there are few things in that case that work as I would not expect:\r\n\r\n1. The explain of the query shows that the high score (several orders higher than expected) is a result of sum of matches of multi-phrase query and the document. **But the words that are shown in the explain don't appear in the document at all nor in the query**. Basically elastic gives higher score when matching a query and a document on words that don't appear both in the query, nor in the document. This is the unexpected behavior. Those words appear in other documents. Please see the steps to reproduce.\r\n2. For elastic version 6.5.4, the behavior is not reproducible, meaning it returns logical score as expected. For versions 7.1.1 and 6.7.2 the behavior reproduces. So if that was not a bug or an issue I would expect similar behavior in all versions.\r\n\r\nIf that is expected, I would love to better understand why and how should I work with this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508161118","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-508161118","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":508161118,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODE2MTExOA==","user":{"login":"bbfsdev","id":1877419,"node_id":"MDQ6VXNlcjE4Nzc0MTk=","avatar_url":"https://avatars0.githubusercontent.com/u/1877419?v=4","gravatar_id":"","url":"https://api.github.com/users/bbfsdev","html_url":"https://github.com/bbfsdev","followers_url":"https://api.github.com/users/bbfsdev/followers","following_url":"https://api.github.com/users/bbfsdev/following{/other_user}","gists_url":"https://api.github.com/users/bbfsdev/gists{/gist_id}","starred_url":"https://api.github.com/users/bbfsdev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bbfsdev/subscriptions","organizations_url":"https://api.github.com/users/bbfsdev/orgs","repos_url":"https://api.github.com/users/bbfsdev/repos","events_url":"https://api.github.com/users/bbfsdev/events{/privacy}","received_events_url":"https://api.github.com/users/bbfsdev/received_events","type":"User","site_admin":false},"created_at":"2019-07-03T16:18:28Z","updated_at":"2019-07-03T16:18:28Z","author_association":"NONE","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508161396","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-508161396","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":508161396,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODE2MTM5Ng==","user":{"login":"bbfsdev","id":1877419,"node_id":"MDQ6VXNlcjE4Nzc0MTk=","avatar_url":"https://avatars0.githubusercontent.com/u/1877419?v=4","gravatar_id":"","url":"https://api.github.com/users/bbfsdev","html_url":"https://github.com/bbfsdev","followers_url":"https://api.github.com/users/bbfsdev/followers","following_url":"https://api.github.com/users/bbfsdev/following{/other_user}","gists_url":"https://api.github.com/users/bbfsdev/gists{/gist_id}","starred_url":"https://api.github.com/users/bbfsdev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bbfsdev/subscriptions","organizations_url":"https://api.github.com/users/bbfsdev/orgs","repos_url":"https://api.github.com/users/bbfsdev/repos","events_url":"https://api.github.com/users/bbfsdev/events{/privacy}","received_events_url":"https://api.github.com/users/bbfsdev/received_events","type":"User","site_admin":false},"created_at":"2019-07-03T16:19:15Z","updated_at":"2019-07-03T16:19:15Z","author_association":"NONE","body":"@jimczi Friendly ping.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508241454","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-508241454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":508241454,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODI0MTQ1NA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-07-03T20:21:24Z","updated_at":"2019-07-03T20:21:24Z","author_association":"MEMBER","body":"Sorry for the late reply @bbfsdev , I am able to reproduce the issue and found the bug. We're expanding every position with multiple terms (different stemming for the same term for instance) to span prefix queries so this explains why the final query is so big. \r\nThat's the version of the query with the bug:\r\n````\r\nGET test/_validate/query?explain\r\n>>\r\n{\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"failed\": 0\r\n    },\r\n    \"valid\": true,\r\n    \"explanations\": [\r\n        {\r\n            \"index\": \"test\",\r\n            \"valid\": true,\r\n            \"explanation\": \"spanNear([spanOr([SpanMultiTermQueryWrapper(content.language:מבוא*), SpanMultiTermQueryWrapper(content.language:בוא*)]), content.language:ספר, spanOr([spanNear([content.language:זוהר, content.language:עם], 0, true), content.language:זוהר, spanNear([content.language:ספר, content.language:זוהר], 0, true), content.language:זוהר])], 0, true)\"\r\n        }\r\n    ]\r\n}\r\n````\r\n\r\nI opened https://github.com/elastic/elasticsearch/pull/43941 to fix the bug, thanks for reporting!\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510901795","html_url":"https://github.com/elastic/elasticsearch/issues/43308#issuecomment-510901795","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43308","id":510901795,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDkwMTc5NQ==","user":{"login":"nmdoliveira","id":11424676,"node_id":"MDQ6VXNlcjExNDI0Njc2","avatar_url":"https://avatars3.githubusercontent.com/u/11424676?v=4","gravatar_id":"","url":"https://api.github.com/users/nmdoliveira","html_url":"https://github.com/nmdoliveira","followers_url":"https://api.github.com/users/nmdoliveira/followers","following_url":"https://api.github.com/users/nmdoliveira/following{/other_user}","gists_url":"https://api.github.com/users/nmdoliveira/gists{/gist_id}","starred_url":"https://api.github.com/users/nmdoliveira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nmdoliveira/subscriptions","organizations_url":"https://api.github.com/users/nmdoliveira/orgs","repos_url":"https://api.github.com/users/nmdoliveira/repos","events_url":"https://api.github.com/users/nmdoliveira/events{/privacy}","received_events_url":"https://api.github.com/users/nmdoliveira/received_events","type":"User","site_admin":false},"created_at":"2019-07-12T14:12:46Z","updated_at":"2019-07-12T14:12:46Z","author_association":"NONE","body":"Hi @jimczi, I don't know if this is the right place to ask, but I believe I have a very similar problem in version 6.7.0 with a `multi_match` `phrase_prefix` query with `max_expansions` set to 100.\r\n\r\nEvery expansion used to match on the document (which I'm assuming is analogous to synonyms) contributes with a small score, but then all of them are summed to get the final score, which makes some documents score really high just because they needed more expansions to match.\r\n\r\nI indexed some fields with `index_prefixes` to improve this query (as made possible by https://github.com/elastic/elasticsearch/pull/37436), and this seems to fix their score, but they get much smaller scores than the fields that do not have `index_prefixes` and match because of prefix expansions.\r\n\r\nDo you think  #43941 is going to fix this case too?\r\n\r\nThanks, and please let me know if I should open a separate issue.","performed_via_github_app":null}]