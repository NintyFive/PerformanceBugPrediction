{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13095","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13095/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13095/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13095/events","html_url":"https://github.com/elastic/elasticsearch/issues/13095","id":102973768,"node_id":"MDU6SXNzdWUxMDI5NzM3Njg=","number":13095,"title":"RecoveryFailedException: NegativeArraySizeException when marking and sending shard","user":{"login":"kjelle","id":598905,"node_id":"MDQ6VXNlcjU5ODkwNQ==","avatar_url":"https://avatars2.githubusercontent.com/u/598905?v=4","gravatar_id":"","url":"https://api.github.com/users/kjelle","html_url":"https://github.com/kjelle","followers_url":"https://api.github.com/users/kjelle/followers","following_url":"https://api.github.com/users/kjelle/following{/other_user}","gists_url":"https://api.github.com/users/kjelle/gists{/gist_id}","starred_url":"https://api.github.com/users/kjelle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kjelle/subscriptions","organizations_url":"https://api.github.com/users/kjelle/orgs","repos_url":"https://api.github.com/users/kjelle/repos","events_url":"https://api.github.com/users/kjelle/events{/privacy}","received_events_url":"https://api.github.com/users/kjelle/received_events","type":"User","site_admin":false},"labels":[{"id":144457604,"node_id":"MDU6TGFiZWwxNDQ0NTc2MDQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Settings","name":":Core/Infra/Settings","color":"0e8a16","default":false,"description":"Settings infrastructure and APIs"},{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2015-08-25T08:17:41Z","updated_at":"2016-01-28T13:00:44Z","closed_at":"2016-01-28T13:00:44Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: 1.7.1 - 24 data nodes, 3 masters, 3 clients.\n\n```\nSettings (transient)\nindices.recovery.translog_size 512kb\nindices.recovery.concurrent_streams 3\nindices.recovery.translog_ops 1000\nindices.recovery.max_bytes_per_sec 40mb\nindices.recovery.file_chunk_size 512kb\ncluster.routing.allocation.cluster_concurrent_rebalance 2\ncluster.routing.allocation.node_concurrent_recoveries 2\n\nSettings (yml)\nindex.refresh_interval 60s\nindices.recovery.max_bytes_per_sec 200mb\n```\n\nI get Exceptions when ES moves shards or enables replication. Some replications are stuck in INITIALIZATION. It tries to INIT, then falls back to UNASSIGNED. Some INIt on replicas and some relocations seems to run OK (/_cat/recovery).\n\nI would estiamte this is affected by almost all indices (see many in the log). And it seems not to be only one shard per index. The consistent error is the **Caused by: java.lang.NegativeArraySizeException**. The last Caused by seems to go into recursion and we get a ton of **Suppressed: ..**\n\nThe exceptions comes \"now and then\". If I increase indices.recovery to concurrent_streams 24, max_bytes_per_sec 512mb it doesn't increase the Exception rate. **However**, if I increase node_concurrent_recoveries beyond 2, e.g. to 3, the number of Exceptions explodes - flooding with tens or hundreds per second on each node. \n\n```\n[2015-08-25 07:46:23,207][WARN ][indices.cluster          ] [l03-data-01] [[storm-today][9]] marking and sending shard failed due to [failed recovery]\norg.elasticsearch.indices.recovery.RecoveryFailedException: [storm-today][9]: Recovery failed from [l05-data-04][yQg00N7RTzOGHT3UQ-6Sjg]l05][inet[/192.168.1.18:9304]]{rack_id=A25, master=false} into [l03-data-01][7fzOuK7ZRFuhN0a1UlcXIQ][l03][inet[192.168.1.16/192.168.1.16:9301]]{rack_id=A25, master=false}\n        at org.elasticsearch.indices.recovery.RecoveryTarget.doRecovery(RecoveryTarget.java:280)\n        at org.elasticsearch.indices.recovery.RecoveryTarget.access$700(RecoveryTarget.java:70)\n        at org.elasticsearch.indices.recovery.RecoveryTarget$RecoveryRunner.doRun(RecoveryTarget.java:561)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.transport.RemoteTransportException: [l05-data-04][inet[/192.168.1.18:9304]][internal:index/shard/recovery/start_recovery]\nCaused by: org.elasticsearch.index.engine.RecoveryEngineException: [storm-today][9] Phase[1] Execution failed\n        at org.elasticsearch.index.engine.InternalEngine.recover(InternalEngine.java:883)\n        at org.elasticsearch.index.shard.IndexShard.recover(IndexShard.java:780)\n        at org.elasticsearch.indices.recovery.RecoverySource.recover(RecoverySource.java:125)\n        at org.elasticsearch.indices.recovery.RecoverySource.access$200(RecoverySource.java:49)\n        at org.elasticsearch.indices.recovery.RecoverySource$StartRecoveryTransportRequestHandler.messageReceived(RecoverySource.java:146)\n        at org.elasticsearch.indices.recovery.RecoverySource$StartRecoveryTransportRequestHandler.messageReceived(RecoverySource.java:132)\n        at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.doRun(MessageChannelHandler.java:279)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.indices.recovery.RecoverFilesRecoveryException: [storm-today][9] Failed to transfer [13] files with total size of [11.2gb]\n        at org.elasticsearch.indices.recovery.RecoverySourceHandler.phase1(RecoverySourceHandler.java:430)\n        at org.elasticsearch.index.engine.InternalEngine.recover(InternalEngine.java:878)\n        ... 10 more\nCaused by: java.lang.NegativeArraySizeException\n        at org.elasticsearch.indices.recovery.RecoverySourceHandler$3.doRun(RecoverySourceHandler.java:280)\n        ... 4 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n        Suppressed: java.lang.NegativeArraySizeException\n                ... 5 more\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}