[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160666876","html_url":"https://github.com/elastic/elasticsearch/issues/15115#issuecomment-160666876","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15115","id":160666876,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDY2Njg3Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-30T15:46:39Z","updated_at":"2015-11-30T15:46:39Z","author_association":"CONTRIBUTOR","body":"Hi @underyx \n\nCompletion fields shouldn't support multi-fields, because a completion field can accept a structured object which wouldn't work with (eg) a `string` subfield.  I've marked this as a bug because we should complain about this at mapping time.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160667716","html_url":"https://github.com/elastic/elasticsearch/issues/15115#issuecomment-160667716","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15115","id":160667716,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDY2NzcxNg==","user":{"login":"underyx","id":1060436,"node_id":"MDQ6VXNlcjEwNjA0MzY=","avatar_url":"https://avatars0.githubusercontent.com/u/1060436?v=4","gravatar_id":"","url":"https://api.github.com/users/underyx","html_url":"https://github.com/underyx","followers_url":"https://api.github.com/users/underyx/followers","following_url":"https://api.github.com/users/underyx/following{/other_user}","gists_url":"https://api.github.com/users/underyx/gists{/gist_id}","starred_url":"https://api.github.com/users/underyx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/underyx/subscriptions","organizations_url":"https://api.github.com/users/underyx/orgs","repos_url":"https://api.github.com/users/underyx/repos","events_url":"https://api.github.com/users/underyx/events{/privacy}","received_events_url":"https://api.github.com/users/underyx/received_events","type":"User","site_admin":false},"created_at":"2015-11-30T15:48:53Z","updated_at":"2015-11-30T15:48:53Z","author_association":"NONE","body":"I see, thank you, @clintongormley!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/373667454","html_url":"https://github.com/elastic/elasticsearch/issues/15115#issuecomment-373667454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15115","id":373667454,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MzY2NzQ1NA==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-03-16T10:15:02Z","updated_at":"2018-03-16T10:15:02Z","author_association":"MEMBER","body":"@elastic/es-search-aggs ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/423655020","html_url":"https://github.com/elastic/elasticsearch/issues/15115#issuecomment-423655020","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15115","id":423655020,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMzY1NTAyMA==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2018-09-21T20:01:56Z","updated_at":"2018-09-21T20:10:04Z","author_association":"CONTRIBUTOR","body":"Hi,\r\nI was trying to reproduce that issue with the oldest version supported 5.2.1 (same for the 6.4) , and it is **not** possible to index a document with a multi-field of completion type.\r\n \r\nIt is however still possible to create a mapping with multi-fields of type completion. Should this be prevented?\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/cities \\\r\n  --header 'content-type: application/json' \r\n>>\r\n{\"acknowledged\":true,\"shards_acknowledged\":true}\r\n```\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/cities/citytype/_mapping \\\r\n  --header 'content-type: application/json' \\\r\n  --data '\r\n{\r\n  \"citytype\" : {\r\n        \"properties\" : {\r\n            \"city\" : { \r\n                \"type\": \"completion\",\r\n                            \"preserve_separators\": false,\r\n                            \"fields\": {\r\n                                    \"analyzed\": {\r\n                                            \"type\": \"completion\",\r\n                                            \"analyzer\": \"standard\"\r\n                                    }\r\n                            }\r\n            }\r\n        }\r\n    }\r\n}'\r\n{\"acknowledged\":true}\r\n```\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/cities/citytype/1 \\\r\n  --header 'content-type: application/json' \\\r\n  --data '\r\n{\r\n    \"city\" : {\r\n        \"input\": [ \"Krak\", \"Cracow\" ],\r\n        \"weight\" : 34\r\n    }\r\n}’\r\n>>\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [\r\n            {\r\n                \"type\": \"parse_exception\",\r\n                \"reason\": \"failed to parse expected text or object gotEND_OBJECT\"\r\n            }\r\n        ],\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse\",\r\n        \"caused_by\": {\r\n            \"type\": \"parse_exception\",\r\n            \"reason\": \"failed to parse expected text or object gotEND_OBJECT\"\r\n        }\r\n    },\r\n    \"status\": 400\r\n}\r\n```\r\n\r\nSee gist with curl requests and responses\r\nhttps://gist.github.com/pgomulka/d3444a8ea93f0672392fb518aaacc839\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/424706008","html_url":"https://github.com/elastic/elasticsearch/issues/15115#issuecomment-424706008","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15115","id":424706008,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNDcwNjAwOA==","user":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"created_at":"2018-09-26T13:00:24Z","updated_at":"2018-09-27T10:48:39Z","author_association":"CONTRIBUTOR","body":"Creating documents on mappings with completion type fields with multi-fields **fails** when the document is provided with completion field in a form of array or object. This is because sub multi-field of different then completion type is not able to parse that format. \r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/citiesx2 \\\r\n  --header 'content-type: application/json' \\\r\n  --data '\r\n{\r\n  \"mappings\": {\r\n    \"citytype\": {\r\n      \"properties\": {\r\n        \"city\": {\r\n          \"type\": \"completion\",\r\n          \"preserve_separators\": false,\r\n          \"fields\": {\r\n            \"analyzed\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n\r\ncurl --request PUT --url http://localhost:9200/citiesx2/citytype/12 --header 'content-type: application/json’ --data '\r\n{\r\n  \"city\" : {\r\n        \"input\":[\"New york\", \"NY\"],\r\n        \"weight\": 34\r\n    }\r\n}\r\n>>>\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [\r\n            {\r\n                \"type\": \"mapper_parsing_exception\",\r\n                \"reason\": \"failed to parse [city.analyzed]\"\r\n            }\r\n        ],\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse [city.analyzed]\",\r\n        \"caused_by\": {\r\n            \"type\": \"illegal_state_exception\",\r\n            \"reason\": \"Can't get text on a END_OBJECT at 6:2\"\r\n        }\r\n    },\r\n    \"status\": 400\r\n}\r\n```\r\nSub multi-field of type completion, fails due to reusing a context with a parser being already at the end of the object.\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/subfieldcompletion \\\r\n  --header 'content-type: application/json' \\\r\n  --data '\r\n{\r\n  \"mappings\": {\r\n    \"citytype\": {\r\n      \"properties\": {\r\n        \"city\": {\r\n          \"type\": \"completion\",\r\n          \"preserve_separators\": false,\r\n          \"fields\": {\r\n            \"analyzed\": {\r\n              \"type\": \"completion\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n’\r\n\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/subfieldcompletion/citytype/12 \\\r\n  --header 'content-type: application/json' \\\r\n  --data '\r\n{\r\n  \"city\"  : {\r\n        \"input\": [ “New York\", “NY\" ],\r\n        \"weight\" : 34\r\n    }\r\n}’\r\n>>\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [\r\n            {\r\n                \"type\": \"parse_exception\",\r\n                \"reason\": \"failed to parse expected text or object gotEND_OBJECT\"\r\n            }\r\n        ],\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse\",\r\n        \"caused_by\": {\r\n            \"type\": \"parse_exception\",\r\n            \"reason\": \"failed to parse expected text or object gotEND_OBJECT\"\r\n        }\r\n    },\r\n    \"status\": 400\r\n}\r\n```\r\nThe issue was initially created to prevent mappings with completion type fields with multi-field. However we already support that, it works fine when indexing document with completion type field in String format.\r\n```\r\ncurl --request PUT \\\r\n  --url http://localhost:9200/subfieldcompletion2/citytype/12 \\\r\n  --header 'content-type: application/json' \\\r\n  --data '\r\n{\r\n  \"city\"  : \"New York\"\r\n}'\r\n```\r\nIt is possible to fix that by modifying the CompletionFieldMapper to provide multiFields mapper with a context with already parsed externalValue. Also The CompletionFieldMapper itself, should support externalValues from context (it is not at the moment)\r\nWill create a PR with a fix instead of validation shortly.","performed_via_github_app":null}]