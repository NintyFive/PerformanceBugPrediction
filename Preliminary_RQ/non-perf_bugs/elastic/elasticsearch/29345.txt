{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29345","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29345/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29345/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29345/events","html_url":"https://github.com/elastic/elasticsearch/issues/29345","id":310730203,"node_id":"MDU6SXNzdWUzMTA3MzAyMDM=","number":29345,"title":"Inaccurate values when calculating SUM or AVG aggregations","user":{"login":"aurimasplu","id":33485896,"node_id":"MDQ6VXNlcjMzNDg1ODk2","avatar_url":"https://avatars0.githubusercontent.com/u/33485896?v=4","gravatar_id":"","url":"https://api.github.com/users/aurimasplu","html_url":"https://github.com/aurimasplu","followers_url":"https://api.github.com/users/aurimasplu/followers","following_url":"https://api.github.com/users/aurimasplu/following{/other_user}","gists_url":"https://api.github.com/users/aurimasplu/gists{/gist_id}","starred_url":"https://api.github.com/users/aurimasplu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aurimasplu/subscriptions","organizations_url":"https://api.github.com/users/aurimasplu/orgs","repos_url":"https://api.github.com/users/aurimasplu/repos","events_url":"https://api.github.com/users/aurimasplu/events{/privacy}","received_events_url":"https://api.github.com/users/aurimasplu/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-04-03T07:51:09Z","updated_at":"2018-04-04T06:04:02Z","closed_at":"2018-04-03T14:11:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** : 6.1.1-1\r\n\r\n**Plugins installed**: X-pack\r\n\r\n**JVM version**: java-1.8.0-openjdk-1.8.0.151-5.b12.el7_4.x86_64\r\n\r\n**OS version** :  RHEL 7.4\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen running sum or avg aggregations within terms aggregation getting inaccurate results.\r\n\r\n**Steps to reproduce**:\r\n\r\nI run this query:\r\n```\r\n{\r\n\t\"size\": 1000,\r\n\t\t\"_source\": [\r\n\t\t\"tag.agent_host\",\r\n\t\t\"tag.ifDescr\",\r\n\t\t\"interface.ifHCInOctets\"\r\n\t],\r\n\t\"query\": {\r\n\t\t\"bool\": {\r\n\t\t\t\"filter\": [{\r\n\t\t\t\t\t\"range\": {\r\n\t\t\t\t\t\t\"@timestamp\": {\r\n\t\t\t\t\t\t\t\"gte\": \"1522330307503\",\r\n\t\t\t\t\t\t\t\"lte\": \"1522330607503\",\r\n\t\t\t\t\t\t\t\"format\": \"epoch_millis\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}, {\r\n\t\t\t\t\t\"query_string\": {\r\n\t\t\t\t\t\t\"analyze_wildcard\": true,\r\n\t\t\t\t\t\t\"query\": \"tag.agent_host:testrouter1.testdomain.net AND tag.ifDescr:GigabitEthernet*0 AND _exists_:interface.ifHCInOctets\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t]\r\n\t\t}\r\n\t},\r\n\t\"aggs\": {\r\n\t\t\"DBF_Device\": {\r\n\t\t\t\"terms\": {\r\n\t\t\t\t\"field\": \"tag.agent_host\",\r\n\t\t\t\t\"size\": 10\r\n\t\t\t},\r\n\t\t\t\"aggs\": {\r\n\t\t\t\t\"DBF_Interface\": {\r\n\t\t\t\t\t\"terms\": {\r\n\t\t\t\t\t\t\"field\": \"tag.ifDescr\",\r\n\t\t\t\t\t\t\"size\": 10\r\n\t\t\t\t\t},\r\n\t\t\t\t\t\"aggs\": {\r\n\t\t\t\t\t\t\"DBF_Metric_SUM\": {\r\n\t\t\t\t\t\t\t\"sum\": {\r\n\t\t\t\t\t\t\t\t\"field\": \"interface.ifHCInOctets\"\r\n\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\n```\r\n\r\n\r\nand get this response:\r\n\r\n\r\n```\r\n{\r\n    \"took\": 154,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 1155,\r\n        \"successful\": 1155,\r\n        \"skipped\": 1123,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 5,\r\n        \"max_score\": 0,\r\n        \"hits\": [\r\n            {\r\n                \"_index\": \"test-index-2018.03.29\",\r\n                \"_type\": \"metrics\",\r\n                \"_id\": \"QrH1cWIBrVLc4RYS48TM\",\r\n                \"_score\": 0,\r\n                \"_source\": {\r\n                    \"tag\": {\r\n                        \"agent_host\": \"testrouter1.testdomain.net\",\r\n                        \"ifDescr\": \"GigabitEthernet0/0/0\"\r\n                    },\r\n                    \"interface\": {\r\n                        **\"ifHCInOctets\": 402423415108**\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"_index\": \"test-index-2018.03.29\",\r\n                \"_type\": \"metrics\",\r\n                \"_id\": \"BsP4cWIBrVLc4RYSomgl\",\r\n                \"_score\": 0,\r\n                \"_source\": {\r\n                    \"tag\": {\r\n                        \"agent_host\": \"testrouter1.testdomain.net\",\r\n                        \"ifDescr\": \"GigabitEthernet0/0/0\"\r\n                    },\r\n                    \"interface\": {\r\n                        **\"ifHCInOctets\": 402849967058**\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"_index\": \"test-index-2018.03.29\",\r\n                \"_type\": \"metrics\",\r\n                \"_id\": \"x7f2cWIBrVLc4RYSzXP8\",\r\n                \"_score\": 0,\r\n                \"_source\": {\r\n                    \"tag\": {\r\n                        \"agent_host\": \"testrouter1.testdomain.net\",\r\n                        \"ifDescr\": \"GigabitEthernet0/0/0\"\r\n                    },\r\n                    \"interface\": {\r\n                        **\"ifHCInOctets\": 402533814871**\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"_index\": \"test-index-2018.03.29\",\r\n                \"_type\": \"metrics\",\r\n                \"_id\": \"e733cWIBrVLc4RYSt7HE\",\r\n                \"_score\": 0,\r\n                \"_source\": {\r\n                    \"tag\": {\r\n                        \"agent_host\": \"testrouter1.testdomain.net\",\r\n                        \"ifDescr\": \"GigabitEthernet0/0/0\"\r\n                    },\r\n                    \"interface\": {\r\n                        **\"ifHCInOctets\": 402662297513**\r\n                    }\r\n                }\r\n            },\r\n            {\r\n                \"_index\": \"test-index-2018.03.29\",\r\n                \"_type\": \"metrics\",\r\n                \"_id\": \"wsn5cWIBrVLc4RYSjcrG\",\r\n                \"_score\": 0,\r\n                \"_source\": {\r\n                    \"tag\": {\r\n                        \"agent_host\": \"testrouter1.testdomain.net\",\r\n                        \"ifDescr\": \"GigabitEthernet0/0/0\"\r\n                    },\r\n                    \"interface\": {\r\n                        **\"ifHCInOctets\": 402989750842**\r\n                    }\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"aggregations\": {\r\n        \"DBF_Device\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n                {\r\n                    \"key\": \"testrouter1.testdomain.net\",\r\n                    \"doc_count\": 5,\r\n                    \"DBF_Interface\": {\r\n                        \"doc_count_error_upper_bound\": 0,\r\n                        \"sum_other_doc_count\": 0,\r\n                        \"buckets\": [\r\n                            {\r\n                                \"key\": \"GigabitEthernet0/0/0\",\r\n                                \"doc_count\": 5,\r\n                                \"DBF_Metric_SUM\": {\r\n                                    **\"value\": 2013459218432**\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\nWhen calculating output by myself from hits section I get that SUM of ifHCInOctets fields is **2013459245392** but when elastic calculates its SUM aggregation result is **2013459218432** which is lesser by 26960. \r\nI also tried adding various sorting or removing child element- result always remained inaccurate. Same problem appears with avg aggregation.\r\n\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}