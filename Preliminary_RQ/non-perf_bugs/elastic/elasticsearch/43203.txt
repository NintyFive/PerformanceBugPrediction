{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43203","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43203/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43203/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43203/events","html_url":"https://github.com/elastic/elasticsearch/issues/43203","id":455805672,"node_id":"MDU6SXNzdWU0NTU4MDU2NzI=","number":43203,"title":"[ML] If stopping _all data frames, then querying _all stats is not correct","user":{"login":"sophiec20","id":4185750,"node_id":"MDQ6VXNlcjQxODU3NTA=","avatar_url":"https://avatars2.githubusercontent.com/u/4185750?v=4","gravatar_id":"","url":"https://api.github.com/users/sophiec20","html_url":"https://github.com/sophiec20","followers_url":"https://api.github.com/users/sophiec20/followers","following_url":"https://api.github.com/users/sophiec20/following{/other_user}","gists_url":"https://api.github.com/users/sophiec20/gists{/gist_id}","starred_url":"https://api.github.com/users/sophiec20/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sophiec20/subscriptions","organizations_url":"https://api.github.com/users/sophiec20/orgs","repos_url":"https://api.github.com/users/sophiec20/repos","events_url":"https://api.github.com/users/sophiec20/events{/privacy}","received_events_url":"https://api.github.com/users/sophiec20/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-06-13T15:23:21Z","updated_at":"2019-06-26T15:35:15Z","closed_at":"2019-06-26T15:35:15Z","author_association":"NONE","active_lock_reason":null,"body":"Found in 7.2.0-BC5\r\n\r\n1. Create and start 100 data frame transforms (same transform, incrementing id,  scripted, and can be on small source indices) - give them time to complete\r\n2.  Check in UI - all transforms are visible in list and show 100% progress\r\n3. Run `POST _data_frame/transforms/_all/_stop`\r\n4. Check in UI - the first 10 transforms show 100%, the rest shows 0%\r\n\r\nFor example, this system contains transforms from farequote-airline-100 to farequote-airline-205. \r\nAll transforms completed 100%.\r\nAll data frames contain 19 documents.\r\nAll were stopped using `POST _data_frame/transform/_all/_stop`.\r\nHowever when querying using `GET _data_frame/transform/_all/_stats`, then the 10th transform shows checkpoint 0, stats 0 and has a missing progress object.\r\n\r\n```\r\n...\r\n  {\r\n      \"id\" : \"farequote-airline-109\",\r\n      \"state\" : {\r\n        \"task_state\" : \"stopped\",\r\n        \"indexer_state\" : \"stopped\",\r\n        \"checkpoint\" : 1,\r\n        \"progress\" : {\r\n          \"total_docs\" : 86274,\r\n          \"docs_remaining\" : 0,\r\n          \"percent_complete\" : 100.0\r\n        }\r\n      },\r\n      \"stats\" : {\r\n        \"pages_processed\" : 2,\r\n        \"documents_processed\" : 86274,\r\n        \"documents_indexed\" : 19,\r\n        \"trigger_count\" : 1,\r\n        \"index_time_in_ms\" : 7,\r\n        \"index_total\" : 1,\r\n        \"index_failures\" : 0,\r\n        \"search_time_in_ms\" : 4,\r\n        \"search_total\" : 2,\r\n        \"search_failures\" : 0\r\n      },\r\n      \"checkpointing\" : {\r\n        \"operations_behind\" : 0\r\n      }\r\n    },\r\n    {\r\n      \"id\" : \"farequote-airline-110\",\r\n      \"state\" : {\r\n        \"task_state\" : \"stopped\",\r\n        \"indexer_state\" : \"stopped\",\r\n        \"checkpoint\" : 0\r\n      },\r\n      \"stats\" : {\r\n        \"pages_processed\" : 0,\r\n        \"documents_processed\" : 0,\r\n        \"documents_indexed\" : 0,\r\n        \"trigger_count\" : 0,\r\n        \"index_time_in_ms\" : 0,\r\n        \"index_total\" : 0,\r\n        \"index_failures\" : 0,\r\n        \"search_time_in_ms\" : 0,\r\n        \"search_total\" : 0,\r\n        \"search_failures\" : 0\r\n      },\r\n      \"checkpointing\" : {\r\n        \"operations_behind\" : 0\r\n      }\r\n    },\r\n...\r\n```\r\n\r\nHowever when querying using `GET _data_frame/transform/farequote-airline-110/_stats` then the correct progress is returned.\r\n\r\n```\r\n{\r\n  \"count\" : 1,\r\n  \"transforms\" : [\r\n    {\r\n      \"id\" : \"farequote-airline-110\",\r\n      \"state\" : {\r\n        \"task_state\" : \"stopped\",\r\n        \"indexer_state\" : \"stopped\",\r\n        \"checkpoint\" : 1,\r\n        \"progress\" : {\r\n          \"total_docs\" : 86274,\r\n          \"docs_remaining\" : 0,\r\n          \"percent_complete\" : 100.0\r\n        }\r\n      },\r\n      \"stats\" : {\r\n        \"pages_processed\" : 2,\r\n        \"documents_processed\" : 86274,\r\n        \"documents_indexed\" : 19,\r\n        \"trigger_count\" : 1,\r\n        \"index_time_in_ms\" : 16,\r\n        \"index_total\" : 1,\r\n        \"index_failures\" : 0,\r\n        \"search_time_in_ms\" : 14,\r\n        \"search_total\" : 2,\r\n        \"search_failures\" : 0\r\n      },\r\n      \"checkpointing\" : {\r\n        \"operations_behind\" : 0\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n\r\nNote that if I repeat the test, but stop the transform by explicitly naming the transform id, then the `_all/_stats` returns the correct 100% responses.\r\n\r\nNote that if I query `_all/_stats` at the point when all transforms are not yet stopped, then `_all/_stats` returns the correct 100% responses.\r\n\r\nWeird ... but managed to repeat this.","closed_by":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"performed_via_github_app":null}