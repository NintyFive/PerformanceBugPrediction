[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602173335","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602173335","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602173335,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjE3MzMzNQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-03-22T09:57:09Z","updated_at":"2020-03-22T09:57:09Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml/Transform)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602174081","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602174081","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602174081,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjE3NDA4MQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-22T10:04:27Z","updated_at":"2020-03-22T10:04:27Z","author_association":"CONTRIBUTOR","body":"> It's interesting that the other tests in that file haven't failed for the same reason\r\n\r\nGah, actually that's wrong, other tests _have_ failed for exactly the same reason, it just so happens that the first 3 I looked at were all the one in the original description:\r\n\r\n* `mixed_cluster/80_transform_jobs_crud/Test GET, stop, start, old continuous transforms` failed in https://gradle-enterprise.elastic.co/s/ulg75vmequhq4\r\n* `mixed_cluster/80_transform_jobs_crud/Test put batch transform on mixed cluster` failed in https://gradle-enterprise.elastic.co/s/7dt3jvptc2ubs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602177071","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602177071","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602177071,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjE3NzA3MQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-22T10:28:46Z","updated_at":"2020-03-22T10:28:46Z","author_association":"CONTRIBUTOR","body":"Since the tests are interdependent I opened #53932 to mute _all_ the transforms tests in the mixed and upgraded clusters in the 7.x branch.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602202209","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602202209","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602202209,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjIwMjIwOQ==","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"created_at":"2020-03-22T13:38:04Z","updated_at":"2020-03-22T13:44:13Z","author_association":"CONTRIBUTOR","body":"Thanks for raising and sorry for the breakage - I wonder why these failures didn't occur on the CI run for the backport PR. \n\nI'll take a look at this first thing my Monday morning if not sooner, hopefully it's a simple fix. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602231058","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602231058","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602231058,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjIzMTA1OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-22T15:59:33Z","updated_at":"2020-03-22T16:01:52Z","author_association":"CONTRIBUTOR","body":"> I wonder why these failures didn't occur on the CI run for the backport PR\r\n\r\nThese tests don't fail in every test run.  It's probably one third or even maybe one sixth of runs that fail due to this problem.  It must take a combination of factors to make it happen, for example:\r\n\r\n* Request sent to an old version coordinating node when the master node upgraded to 7.7\r\n* Request sent to a 7.7 coordinating node when the master is still on the old version\r\n* Request sent to an old version master node when the node running the transform persistent task has been upgraded to 7.7\r\n* Request sent to a 7.7 master node when the node running the transform persistent task is still on the old version\r\n* Some other test in the suite fixes the problem if run before one of the ones that's failed (remember cleanup cannot happen in between the rolling upgrade tests so side effects of one test can affect others), so the failure only occurs when that test is randomly selected to run after one of the \"at risk\" tests\r\n\r\nI am not sure exactly which set of conditions causes the problem but it will be something along the lines of one of those things.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602563211","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602563211","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602563211,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjU2MzIxMQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-03-23T12:34:07Z","updated_at":"2020-03-23T15:19:38Z","author_association":"CONTRIBUTOR","body":"As well as the YAML tests, `TransformSurvivesUpgradeIT.testTransformRollingUpgrade` is failing for the same underlying reason.  An example is https://gradle-enterprise.elastic.co/s/ctg75mohgspuw\r\n\r\nThe test failure message is:\r\n\r\n```\r\nExpected: one of {<STARTED>, <INDEXING>}\r\n     but: was <FAILED>\r\n```\r\n\r\nBut the reason the transform is in the `failed` state is that it cannot create a notifications index.  From the server-side logs `x-pack/qa/rolling-upgrade/build/testclusters/v7.4.1-0/logs/v7.4.1.log` says:\r\n\r\n```\r\n[2020-03-23T11:09:41,387][ERROR][o.e.x.t.t.TransformTask  ] [v7.4.1-0] [continuous-transform-upgrade-job] transform has failed; experienced: [Failed to create internal index mappings[java.lang.IllegalArgumentException: unknown setting [index.hidden] please check that any required plugins are installed, or check the breaking changes documentation for removed settings]].\r\n```\r\n\r\nAt the time that error happened the node it happened on, `v7.4.1-0`, _had_ been upgraded to version 7.7.0.  The master node at this time was `v7.4.1-2`, which had been elected a bit earlier:\r\n\r\n```\r\n[2020-03-23T11:08:00,751][INFO ][o.e.c.s.MasterService    ] [v7.4.1-2] elected-as-master ([2] nodes joined)[{v7.4.1-2}{CczcekDATT6GVtXDY3yBoA}{Of0quIhcRfmFkiGHqCgjrw}{127.0.0.1}{127.0.0.1:41750}{dilm}{ml.machine_memory=101204275200, xpack.installed=true, testattr=test, ml.max_open_jobs=20} elect leader, {v7.4.1-1}{-W9TLLMBSeGPVb-r1pmpdA}{Bce67W_MSUavZqa6LTbbIA}{127.0.0.1}{127.0.0.1:38268}{dilm}{testattr=test, ml.machine_memory=101204275200, ml.max_open_jobs=20, xpack.installed=true} elect leader, _BECOME_MASTER_TASK_, _FINISH_ELECTION_], term: 2, version: 1, reason: master node changed {previous [], current [{v7.4.1-2}{CczcekDATT6GVtXDY3yBoA}{Of0quIhcRfmFkiGHqCgjrw}{127.0.0.1}{127.0.0.1:41750}{dilm}{ml.machine_memory=101204275200, xpack.installed=true, testattr=test, ml.max_open_jobs=20}]}, added {{v7.4.1-1}{-W9TLLMBSeGPVb-r1pmpdA}{Bce67W_MSUavZqa6LTbbIA}{127.0.0.1}{127.0.0.1:38268}{dilm}{testattr=test, ml.machine_memory=101204275200, ml.max_open_jobs=20, xpack.installed=true},}\r\n```\r\n\r\nAt the time of the problem `v7.4.1-2` was still on version 7.4.1, so the problematic scenario appears to be:\r\n\r\n* Transform persistent task running on a 7.7 node when the master is still on the old version\r\n\r\nThe sequence in https://gradle-enterprise.elastic.co/s/ctg75mohgspuw is:\r\n\r\n1. All 3 nodes start off running 7.4.1; `v7.4.2-2` is master\r\n2. Transform gets started and its persistent task gets assigned to `v7.4.1-1`\r\n3. The node `v7.4.1-0` gets stopped\r\n4. The node `v7.4.1-0` gets restarted on version 7.7.0\r\n5. The node `v7.4.1-1` gets stopped\r\n6. The transform gets reassigned to `v7.4.1-0` so that it can continue operation\r\n7. The node `v7.4.1-1` gets restarted on version 7.7.0\r\n8. Problem occurs as 7.7.0 node `v7.4.1-0` sends a request to 7.4.1 node `v7.4.1-2` that it does not understand\r\n\r\nThe problem would not have occurred if the transform had been reassigned to `v7.4.1-2` instead of `v7.4.1-0` when `v7.4.1-1` was stopped.  This is one reason why the problem is intermittent.\r\n\r\nThe problem also would not have occurred if `v7.4.1-1` had originally been elected master and then `v7.4.1-0` had taken over as master when `v7.4.1-1` was stopped.  This is another reason why the problem is intermittent.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602666702","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602666702","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602666702,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjY2NjcwMg==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2020-03-23T15:17:08Z","updated_at":"2020-03-23T15:17:28Z","author_association":"MEMBER","body":"I addressed a similar issue for Watcher by continuing use of the template without the setting until all nodes have been upgraded, see #52974.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602667504","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602667504","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602667504,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjY2NzUwNA==","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"created_at":"2020-03-23T15:18:22Z","updated_at":"2020-03-23T15:18:22Z","author_association":"CONTRIBUTOR","body":"Thanks for digging in @droberts195, that's really helpful. \r\n\r\nWhile I was writing this comment, @jaymode suggested the same thing I was just about to say I was going to try: Just adding some version guards around the logic that adds the `hidden` settings until all nodes have been upgraded.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602698428","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602698428","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602698428,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjY5ODQyOA==","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"created_at":"2020-03-23T16:08:03Z","updated_at":"2020-03-23T17:14:54Z","author_association":"CONTRIBUTOR","body":"~~This reproduces reliably on 7.x (once you unmute)~~ This also doesn't reproduce with:\r\n```\r\n./gradlew :x-pack:qa:rolling-upgrade:v7.4.0#bwcTest -Dtests.class=\"org.elasticsearch.upgrades.UpgradeClusterClientYamlTestSuiteIT\" -Dtests.method=\"test {p0=mixed_cluster/80_transform_jobs_crud/*\"\r\n```\r\n\r\nJust keeping this around because ~~I always have to go and look up how to run these things since the reproduce line doesn't work.~~ I'm still trying to figure out how to run these damn tests right.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/602891973","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-602891973","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":602891973,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjg5MTk3Mw==","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"created_at":"2020-03-23T22:32:22Z","updated_at":"2020-03-23T22:32:22Z","author_association":"CONTRIBUTOR","body":"I muted `TransformSurvivesUpgradeIT.testTransformRollingUpgrade` in 7.x in https://github.com/elastic/elasticsearch/pull/54037.\r\n\r\nI'll unmute in https://github.com/elastic/elasticsearch/pull/54036.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603524693","html_url":"https://github.com/elastic/elasticsearch/issues/53931#issuecomment-603524693","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53931","id":603524693,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzUyNDY5Mw==","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"created_at":"2020-03-24T21:54:19Z","updated_at":"2020-03-24T21:54:19Z","author_association":"CONTRIBUTOR","body":"This should be fixed by https://github.com/elastic/elasticsearch/pull/54036, so I'm closing this issue. Please reopen if we see these failures again - I'll try to keep an eye on the build over the next couple days to be sure.","performed_via_github_app":null}]