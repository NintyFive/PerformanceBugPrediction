{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21192","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21192/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21192/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21192/events","html_url":"https://github.com/elastic/elasticsearch/issues/21192","id":186226360,"node_id":"MDU6SXNzdWUxODYyMjYzNjA=","number":21192,"title":"unsupported_operation_exception on percolate with nested aggregation","user":{"login":"lupova","id":16113167,"node_id":"MDQ6VXNlcjE2MTEzMTY3","avatar_url":"https://avatars3.githubusercontent.com/u/16113167?v=4","gravatar_id":"","url":"https://api.github.com/users/lupova","html_url":"https://github.com/lupova","followers_url":"https://api.github.com/users/lupova/followers","following_url":"https://api.github.com/users/lupova/following{/other_user}","gists_url":"https://api.github.com/users/lupova/gists{/gist_id}","starred_url":"https://api.github.com/users/lupova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lupova/subscriptions","organizations_url":"https://api.github.com/users/lupova/orgs","repos_url":"https://api.github.com/users/lupova/repos","events_url":"https://api.github.com/users/lupova/events{/privacy}","received_events_url":"https://api.github.com/users/lupova/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-10-31T08:11:34Z","updated_at":"2016-11-05T15:52:53Z","closed_at":"2016-11-05T15:52:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.3\r\n\r\n**Plugins installed**: [NONE]\r\n\r\n**JVM version*1.8.0_91*:\r\n\r\n**OS version**: WIN 7 Ent. SP1\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen I am running nested aggregation on perolate action, it's return INTERNAL_SERVER_ERROR with unsupported_operation_exception.\r\n\r\n**Steps to reproduce**:\r\n 1. Create index:\r\n```\r\n PUT news-feed-index\r\n{\r\n        \"mappings\": { \r\n            \"news\": {\r\n            \"properties\": {\r\n                \"subject\": {\"type\": \"string\"},\r\n                \"body\": {\"type\": \"string\"},\r\n                \"priority\": {\"type\": \"integer\"}\r\n                         }\r\n                     }\r\n    \r\n                 }\r\n     \r\n}\r\n```\r\n 2. Update percolator mapping:\r\n```\r\nPUT news-feed-index/.percolator/_mapping\r\n{\r\n        \".percolator\" : {\r\n                \"properties\" : {\r\n                        \"query\" : {\r\n                                \"type\" : \"object\",\r\n                                \"enabled\" : false\r\n                        },\r\n                        \"ruleName\": {\"type\": \"string\"},\r\n                        \"creationInfo\":{\r\n                            \"type\": \"nested\", \r\n                            \"properties\": {\r\n                                \"user\": {\r\n                                    \"type\": \"string\"\r\n                            },\r\n                            \"timestamp\": {\r\n                                \"type\": \"integer\"\r\n                            }\r\n                                                       \r\n                        }\r\n                }\r\n        }\r\n    }\r\n}\r\n```\r\n 3. Put percolator:\r\n```\r\nPUT /news-feed-index/.percolator/11\r\n{\r\n   \"creationInfo\": [\r\n       {\r\n        \"user\" : \"lupa\",\r\n        \"timestamp\": 1\r\n       }],\r\n   \r\n   \"query\" : { \r\n       \"match\" : {\r\n           \"subject\" : \"lazy\"\r\n       }\r\n   }\r\n}\r\n\r\n```\r\n4. Execute percolate with nested aggregation:\r\n```\r\nPOST /news-feed-index/news/_percolate/\r\n{\r\n  \"doc\": {\r\n     \"subject\": \"lazy dog\",\r\n     \"body\": \"\",\r\n     \"priority\":1\r\n  },\r\n \"aggs\": {\r\n    \"root\": {\r\n        \"nested\": {\r\n            \"path\": \"creationInfo\"\r\n        },\r\n        \"aggs\": {\r\n            \"users\":{\r\n                \"terms\": {\r\n                    \"field\": \"creationInfo.user\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\n```\r\n5. Get error result:\r\n```\r\n{\r\n   \"took\": 5,\r\n   \"_shards\": {\r\n      \"total\": 5,\r\n      \"successful\": 4,\r\n      \"failed\": 1,\r\n      \"failures\": [\r\n         {\r\n            \"shard\": 4,\r\n            \"index\": \"news-feed-index\",\r\n            \"status\": \"INTERNAL_SERVER_ERROR\",\r\n            \"reason\": {\r\n               \"type\": \"unsupported_operation_exception\",\r\n               \"reason\": null\r\n            }\r\n         }\r\n      ]\r\n   },\r\n   \"total\": 0,\r\n   \"matches\": []\r\n}\r\n\r\n\r\n\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}