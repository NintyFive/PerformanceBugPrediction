{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27053","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27053/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27053/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27053/events","html_url":"https://github.com/elastic/elasticsearch/issues/27053","id":266931863,"node_id":"MDU6SXNzdWUyNjY5MzE4NjM=","number":27053,"title":"Include _index and _id for root search hit of nested -> top hits aggregation","user":{"login":"ppf2","id":7216393,"node_id":"MDQ6VXNlcjcyMTYzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/7216393?v=4","gravatar_id":"","url":"https://api.github.com/users/ppf2","html_url":"https://github.com/ppf2","followers_url":"https://api.github.com/users/ppf2/followers","following_url":"https://api.github.com/users/ppf2/following{/other_user}","gists_url":"https://api.github.com/users/ppf2/gists{/gist_id}","starred_url":"https://api.github.com/users/ppf2/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ppf2/subscriptions","organizations_url":"https://api.github.com/users/ppf2/orgs","repos_url":"https://api.github.com/users/ppf2/repos","events_url":"https://api.github.com/users/ppf2/events{/privacy}","received_events_url":"https://api.github.com/users/ppf2/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2017-10-19T17:51:46Z","updated_at":"2018-04-05T13:06:17Z","closed_at":"2017-11-28T13:07:11Z","author_association":"MEMBER","active_lock_reason":null,"body":"This issue (https://github.com/elastic/elasticsearch/issues/18091) reported against inner hits prompted a breaking change on 5.0+ (https://www.elastic.co/guide/en/elasticsearch/reference/current/breaking_50_search_changes.html#_inner_hits):\r\n\r\n>Nested inner hits will now no longer include _index, _type and _id keys. For nested inner hits these values are always the same as the _index, _type and _id keys of the root search hit.\r\n\r\nHowever, it looks like we missed one use case when implementing the breaking change.  The above also affects top hits aggregation under a nested agg.\r\n\r\nTake this query as an example:\r\n\r\n```\r\nGET some_index/_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"match_all\": {}\r\n  },\r\n  \"aggregations\": {\r\n    \"nested_0\": {\r\n      \"nested\": {\r\n        \"path\": \"something.concepts\"\r\n      },\r\n      \"aggregations\": {\r\n        \"top_hits_1\": {\r\n          \"top_hits\": {\r\n            \"sort\": [\r\n              {\r\n                \"something.concepts.count\": {\r\n                  \"order\": \"desc\"\r\n                }\r\n              }\r\n            ],\r\n            \"from\": 0,\r\n            \"size\": 1,\r\n            \"version\": false,\r\n            \"explain\": false\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nWill return something like the following on 2.x:\r\n\r\n```\r\n          \"hits\": [\r\n            {\r\n              \"_index\": \"some_index\",\r\n              \"_type\": \"type\",\r\n              \"_id\": \"1\",\r\n              \"_nested\": {\r\n                \"field\": \"something\",\r\n                \"offset\": 0,\r\n                \"_nested\": {\r\n                  \"field\": \"concepts\",\r\n                  \"offset\": 0\r\n                }\r\n              },\r\n              \"_score\": null,\r\n              \"_source\": {\r\n                \"keywords\": \"a\",\r\n                \"count\": 999\r\n              },\r\n              \"sort\": [\r\n                999\r\n              ]\r\n            }\r\n          ]\r\n```\r\n\r\nAnd on 5.x, it returns:\r\n\r\n```\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 2,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"nested_0\": {\r\n      \"doc_count\": 4,\r\n      \"top_hits_1\": {\r\n        \"hits\": {\r\n          \"total\": 4,\r\n          \"max_score\": null,\r\n          \"hits\": [\r\n            {\r\n              \"_nested\": {\r\n                \"field\": \"something\",\r\n                \"offset\": 0,\r\n                \"_nested\": {\r\n                  \"field\": \"concepts\",\r\n                  \"offset\": 0\r\n                }\r\n              },\r\n              \"_score\": null,\r\n              \"_source\": {\r\n                \"keywords\": \"a\",\r\n                \"count\": 999\r\n              },\r\n              \"sort\": [\r\n                999\r\n              ]\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nOn 5.0+, how does one determine the \"root search hit\" within the top hits aggregation now?  It will be helpful if we can include the root search hit's _id, _index, and _type (well,  maybe not type in the future).\r\n\r\n@martijnvg \r\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}