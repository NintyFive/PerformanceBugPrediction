{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62790","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62790/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62790/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62790/events","html_url":"https://github.com/elastic/elasticsearch/issues/62790","id":706663207,"node_id":"MDU6SXNzdWU3MDY2NjMyMDc=","number":62790,"title":"Foreach processor vulnerable to modifying field during iteration","user":{"login":"probakowski","id":3896475,"node_id":"MDQ6VXNlcjM4OTY0NzU=","avatar_url":"https://avatars1.githubusercontent.com/u/3896475?v=4","gravatar_id":"","url":"https://api.github.com/users/probakowski","html_url":"https://github.com/probakowski","followers_url":"https://api.github.com/users/probakowski/followers","following_url":"https://api.github.com/users/probakowski/following{/other_user}","gists_url":"https://api.github.com/users/probakowski/gists{/gist_id}","starred_url":"https://api.github.com/users/probakowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/probakowski/subscriptions","organizations_url":"https://api.github.com/users/probakowski/orgs","repos_url":"https://api.github.com/users/probakowski/repos","events_url":"https://api.github.com/users/probakowski/events{/privacy}","received_events_url":"https://api.github.com/users/probakowski/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"},{"id":2205552170,"node_id":"MDU6TGFiZWwyMjA1NTUyMTcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.10.0","name":"v7.10.0","color":"dddddd","default":false,"description":""},{"id":2314171596,"node_id":"MDU6TGFiZWwyMzE0MTcxNTk2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.9.2","name":"v7.9.2","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-09-22T20:14:52Z","updated_at":"2020-09-23T12:47:40Z","closed_at":"2020-09-23T07:39:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): `7.5` and later\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nCurrently when processor used inside `foreach` modifies field, that `foreach` is iterating over, it can leads to unexpected results. Especially when it appends anything to the field `foreach` will iterate over new items as well which leads to infinite loop and it will eventually bring the whole cluster down.\r\n\r\n**Steps to reproduce**:\r\n```json\r\nPOST /_ingest/pipeline/_simulate\r\n{\r\n  \"pipeline\": {\r\n    \"description\": \"do something\",\r\n    \"processors\": [\r\n      {\r\n        \"foreach\": {\r\n          \"field\": \"names\",\r\n          \"processor\": {\r\n            \"append\": {\r\n              \"field\": \"names\",\r\n              \"value\": \"whatever\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"docs\": [\r\n    {\r\n      \"_index\": \"index\",\r\n      \"_id\": \"id\",\r\n      \"_source\": {\r\n        \"names\": [\r\n          \"anything\"\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\nYou can invoke it couple of times to make effect faster. Eventually cluster will become unresponsive. On `7.7` and later it should fail pretty fast and nothing will work, on previous versions it will accumulate over time (it took around a day for my cloud instance without any other traffic) and will cause all sorts of slowness (like Kibana loading in 1min or just throwing 500 error)\r\n\r\nRelates to #50514 and #51104","closed_by":{"login":"probakowski","id":3896475,"node_id":"MDQ6VXNlcjM4OTY0NzU=","avatar_url":"https://avatars1.githubusercontent.com/u/3896475?v=4","gravatar_id":"","url":"https://api.github.com/users/probakowski","html_url":"https://github.com/probakowski","followers_url":"https://api.github.com/users/probakowski/followers","following_url":"https://api.github.com/users/probakowski/following{/other_user}","gists_url":"https://api.github.com/users/probakowski/gists{/gist_id}","starred_url":"https://api.github.com/users/probakowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/probakowski/subscriptions","organizations_url":"https://api.github.com/users/probakowski/orgs","repos_url":"https://api.github.com/users/probakowski/repos","events_url":"https://api.github.com/users/probakowski/events{/privacy}","received_events_url":"https://api.github.com/users/probakowski/received_events","type":"User","site_admin":false},"performed_via_github_app":null}