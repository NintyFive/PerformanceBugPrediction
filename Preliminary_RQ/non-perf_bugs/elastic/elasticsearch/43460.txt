{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43460","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43460/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43460/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43460/events","html_url":"https://github.com/elastic/elasticsearch/issues/43460","id":458900494,"node_id":"MDU6SXNzdWU0NTg5MDA0OTQ=","number":43460,"title":"Composite terms aggregation fails on aliased indexes with dynamic templates","user":{"login":"c-dante","id":6332726,"node_id":"MDQ6VXNlcjYzMzI3MjY=","avatar_url":"https://avatars2.githubusercontent.com/u/6332726?v=4","gravatar_id":"","url":"https://api.github.com/users/c-dante","html_url":"https://github.com/c-dante","followers_url":"https://api.github.com/users/c-dante/followers","following_url":"https://api.github.com/users/c-dante/following{/other_user}","gists_url":"https://api.github.com/users/c-dante/gists{/gist_id}","starred_url":"https://api.github.com/users/c-dante/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/c-dante/subscriptions","organizations_url":"https://api.github.com/users/c-dante/orgs","repos_url":"https://api.github.com/users/c-dante/repos","events_url":"https://api.github.com/users/c-dante/events{/privacy}","received_events_url":"https://api.github.com/users/c-dante/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-06-20T21:50:32Z","updated_at":"2019-06-21T13:52:48Z","closed_at":"2019-06-21T07:45:28Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n**Using docker image**: `docker.elastic.co/elasticsearch/elasticsearch:7.1.1`\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.1.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): \r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Linux amp 5.0.13-arch1-1-ARCH #1 SMP PREEMPT Sun May 5 18:05:41 UTC 2019 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nExpected: Running a composite aggregate with `after` on dynamic, alias'd indexes don't fail on undefined fields.\r\n\r\nActual: If an aliased index is missing a field, it crashes with number format excetion\r\n\r\n**Steps to reproduce**:\r\nHere's a gist with the set up + logs\r\nhttps://gist.github.com/c-dante/9c973425f0dfd6ed3b22ec0c538e03e8\r\n\r\nSpark notes of the process:\r\n1. Make an index template and alias with dynamic field templates: (`_templates/my-idx`)\r\n2. Have 1 index in the alias be empty (never sees the dynamic fields): (`/my-idx-default`)\r\n3. Have another index have fields and documents: (`/my-idx-content`)\r\n4. A composite aggregate on the outer index: (post to `/my-idx`)\r\n5. Run the same aggregate with `after`, it crashes with number format.\r\n\r\nThis looks to be a further case of https://discuss.elastic.co/t/rollup-job-numberformatexception/178195\r\n\r\n**Provide logs (if relevant)**:\r\nHere's a shorter snippet of the logs, gist has full from request\r\n```\r\n{\"type\": \"server\", \"timestamp\": \"2019-06-20T21:41:31,046+0000\", \"level\": \"DEBUG\", \"component\": \"o.e.a.s.TransportSearchAction\", \"cluster.name\": \"docker-cluster\", \"node.name\": \"a510efed5d96\", \"cluster.uuid\": \"YkYTpw71QJyC6JxUx5rhwA\", \"node.id\": \"LMPLncMjR9uEuQWxX9h9iQ\",  \"message\": \"[my-idx-default][4], node[LMPLncMjR9uEuQWxX9h9iQ], [P], s[STARTED], a[id=eT9ydoflR-KYQnQz6dRQ3Q]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[my-idx], indicesOptions=IndicesOptions[ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_aliases_to_multiple_indices=true, forbid_closed_indices=true, ignore_aliases=false, ignore_throttled=true], types=[], routing='null', preference='null', requestCache=null, scroll=null, maxConcurrentShardRequests=0, batchedReduceSize=512, preFilterShardSize=128, allowPartialSearchResults=true, localClusterAlias=null, getOrCreateAbsoluteStartMillis=-1, ccsMinimizeRoundtrips=true, source={\\\"size\\\":0,\\\"aggregations\\\":{\\\"test\\\":{\\\"composite\\\":{\\\"size\\\":1,\\\"sources\\\":[{\\\"k_0\\\":{\\\"terms\\\":{\\\"field\\\":\\\"k_0\\\",\\\"missing_bucket\\\":false,\\\"order\\\":\\\"asc\\\"}}}],\\\"after\\\":{\\\"k_0\\\":\\\"apple\\\"}}}}}}] lastShard [true]\" , \r\n\"stacktrace\": [\"org.elasticsearch.transport.RemoteTransportException: [a510efed5d96][172.17.0.2:9300][indices:data/read/search[phase/query]]\",\r\n\"Caused by: java.lang.NumberFormatException: For input string: \\\"apple\\\"\",\r\n\"at jdk.internal.math.FloatingDecimal.readJavaFormatString(FloatingDecimal.java:2054) ~[?:?]\",\r\n\"at jdk.internal.math.FloatingDecimal.parseDouble(FloatingDecimal.java:110) ~[?:?]\",\r\n\"at java.lang.Double.parseDouble(Double.java:549) ~[?:?]\",\r\n\"at org.elasticsearch.search.DocValueFormat$1.parseLong(DocValueFormat.java:119) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at org.elasticsearch.search.aggregations.bucket.composite.LongValuesSource.setAfter(LongValuesSource.java:154) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at org.elasticsearch.search.aggregations.bucket.composite.CompositeValuesCollectorQueue.<init>(CompositeValuesCollectorQueue.java:86) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at org.elasticsearch.search.aggregations.bucket.composite.CompositeAggregator.<init>(CompositeAggregator.java:94) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at org.elasticsearch.search.aggregations.bucket.composite.CompositeAggregationFactory.createInternal(CompositeAggregationFactory.java:49) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at org.elasticsearch.search.aggregations.AggregatorFactory.create(AggregatorFactory.java:217) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at org.elasticsearch.search.aggregations.AggregatorFactories.createTopLevelAggregators(AggregatorFactories.java:214) ~[elasticsearch-7.1.1.jar:7.1.1]\",\r\n\"at ...\r\n```\r\n\r\nAnd the response:\r\n```json\r\n{\r\n    \"took\": 13,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 10,\r\n        \"successful\": 5,\r\n        \"skipped\": 0,\r\n        \"failed\": 5,\r\n        \"failures\": [\r\n            {\r\n                \"shard\": 0,\r\n                \"index\": \"my-idx-default\",\r\n                \"node\": \"LMPLncMjR9uEuQWxX9h9iQ\",\r\n                \"reason\": {\r\n                    \"type\": \"number_format_exception\",\r\n                    \"reason\": \"For input string: \\\"apple\\\"\"\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"hits\": {\r\n        \"total\": {\r\n            \"value\": 4,\r\n            \"relation\": \"eq\"\r\n        },\r\n        \"max_score\": null,\r\n        \"hits\": []\r\n    },\r\n    \"aggregations\": {\r\n        \"test\": {\r\n            \"after_key\": {\r\n                \"k_0\": \"banana\"\r\n            },\r\n            \"buckets\": [\r\n                {\r\n                    \"key\": {\r\n                        \"k_0\": \"banana\"\r\n                    },\r\n                    \"doc_count\": 1\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}