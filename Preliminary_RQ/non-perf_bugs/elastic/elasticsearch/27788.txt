{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27788","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27788/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27788/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27788/events","html_url":"https://github.com/elastic/elasticsearch/issues/27788","id":281683462,"node_id":"MDU6SXNzdWUyODE2ODM0NjI=","number":27788,"title":"The missing parameter does not accept an IP when executing a terms aggregation on a field of type ip","user":{"login":"abdonpijpelink","id":9715543,"node_id":"MDQ6VXNlcjk3MTU1NDM=","avatar_url":"https://avatars1.githubusercontent.com/u/9715543?v=4","gravatar_id":"","url":"https://api.github.com/users/abdonpijpelink","html_url":"https://github.com/abdonpijpelink","followers_url":"https://api.github.com/users/abdonpijpelink/followers","following_url":"https://api.github.com/users/abdonpijpelink/following{/other_user}","gists_url":"https://api.github.com/users/abdonpijpelink/gists{/gist_id}","starred_url":"https://api.github.com/users/abdonpijpelink/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abdonpijpelink/subscriptions","organizations_url":"https://api.github.com/users/abdonpijpelink/orgs","repos_url":"https://api.github.com/users/abdonpijpelink/repos","events_url":"https://api.github.com/users/abdonpijpelink/events{/privacy}","received_events_url":"https://api.github.com/users/abdonpijpelink/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-12-13T09:43:45Z","updated_at":"2017-12-18T19:50:59Z","closed_at":"2017-12-18T19:50:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.0.0, Build: 8f0685b/2017-11-10T18:41:22.859Z, JVM: 1.8.0_77\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_77\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_77-b03)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.77-b03, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin MacBook-1265.local 16.7.0 Darwin Kernel Version 16.7.0: Thu Jun 15 17:36:27 PDT 2017; root:xnu-3789.70.16~2/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nProviding an IP as the value of the `missing` parameter, when executing a `terms` aggregation on a field of type `ip` results in the following 503 error:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"\",\r\n    \"phase\": \"fetch\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [],\r\n    \"caused_by\": {\r\n      \"type\": \"illegal_argument_exception\",\r\n      \"reason\": \"encoded bytes are of incorrect length\",\r\n      \"caused_by\": {\r\n        \"type\": \"unknown_host_exception\",\r\n        \"reason\": \"addr is of illegal length\"\r\n      }\r\n    }\r\n  },\r\n  \"status\": 503\r\n}\r\n```\r\nLooking at the code that raises the exception (stack trace pasted below) it seems that the code expects a byte array of length 4 or 16. As a workaround, the IP can be encoded as a character array instead (for example `\"\\u0000\\u0000\\u0000\\u0000\"`).\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create an index with a field mapped as type `ip`:\r\n```\r\nPUT iptest\r\n{\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"ip\": {\r\n          \"type\": \"ip\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Index a document that is missing the `ip` field:\r\n```\r\nPUT iptest/doc/1\r\n{\r\n  \"foo\": \"bar\"\r\n}\r\n```\r\n 3. Execute a `terms` agg, providing an IP address as the value of the `missing` parameter. This results in a 503 error:\r\n```\r\nGET iptest/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggregations\": {\r\n    \"ip\": {\r\n      \"terms\": {\r\n        \"field\": \"ip\",\r\n        \"missing\": \"0.0.0.0\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n4. Pass a 4-character string as the value of `missing`. This is executed successfully:\r\n```\r\nGET iptest/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggregations\": {\r\n    \"ip\": {\r\n      \"terms\": {\r\n        \"field\": \"ip\",\r\n        \"missing\": \"\\u0000\\u0000\\u0000\\u0000\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2017-12-13T09:12:41,550][WARN ][r.suppressed             ] path: /iptest/_search, params: {index=iptest}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: \r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:272) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:623) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.0.0.jar:6.0.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_77]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_77]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_77]\r\nCaused by: java.lang.IllegalArgumentException: encoded bytes are of incorrect length\r\n\tat org.apache.lucene.document.InetAddressPoint.decode(InetAddressPoint.java:187) ~[lucene-misc-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1dbb3f03bf207140b - sarowe - 2017-10-02 14:36:35]\r\n\tat org.elasticsearch.search.DocValueFormat$4.format(DocValueFormat.java:298) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.StringTerms$Bucket.getKeyAsString(StringTerms.java:75) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.StringTerms$Bucket.getKey(StringTerms.java:64) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(InternalTerms.java:274) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:120) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:77) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:523) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:500) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:417) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:736) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\t... 3 more\r\nCaused by: java.net.UnknownHostException: addr is of illegal length\r\n\tat java.net.InetAddress.getByAddress(InetAddress.java:1042) ~[?:1.8.0_77]\r\n\tat java.net.InetAddress.getByAddress(InetAddress.java:1439) ~[?:1.8.0_77]\r\n\tat org.apache.lucene.document.InetAddressPoint.decode(InetAddressPoint.java:184) ~[lucene-misc-7.0.1.jar:7.0.1 8d6c3889aa543954424d8ac1dbb3f03bf207140b - sarowe - 2017-10-02 14:36:35]\r\n\tat org.elasticsearch.search.DocValueFormat$4.format(DocValueFormat.java:298) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.StringTerms$Bucket.getKeyAsString(StringTerms.java:75) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.StringTerms$Bucket.getKey(StringTerms.java:64) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.bucket.terms.InternalTerms.doReduce(InternalTerms.java:274) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:120) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:77) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:523) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:500) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:417) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:736) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.0.0.jar:6.0.0]\r\n\t... 3 more\r\n\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}