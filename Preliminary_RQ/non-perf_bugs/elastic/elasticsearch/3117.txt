{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3117","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3117/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3117/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3117/events","html_url":"https://github.com/elastic/elasticsearch/issues/3117","id":14926871,"node_id":"MDU6SXNzdWUxNDkyNjg3MQ==","number":3117,"title":"\"index_options\" cannot be changed by deleting and recreating type mapping","user":{"login":"mashudong","id":3242209,"node_id":"MDQ6VXNlcjMyNDIyMDk=","avatar_url":"https://avatars2.githubusercontent.com/u/3242209?v=4","gravatar_id":"","url":"https://api.github.com/users/mashudong","html_url":"https://github.com/mashudong","followers_url":"https://api.github.com/users/mashudong/followers","following_url":"https://api.github.com/users/mashudong/following{/other_user}","gists_url":"https://api.github.com/users/mashudong/gists{/gist_id}","starred_url":"https://api.github.com/users/mashudong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mashudong/subscriptions","organizations_url":"https://api.github.com/users/mashudong/orgs","repos_url":"https://api.github.com/users/mashudong/repos","events_url":"https://api.github.com/users/mashudong/events{/privacy}","received_events_url":"https://api.github.com/users/mashudong/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2013-05-30T06:25:32Z","updated_at":"2013-11-04T18:34:31Z","closed_at":"2013-11-04T18:34:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Field \"index_options\" cannot be changed from \"docs\" to \"positions\"\nby deleting and recreating type mapping if you've already indexed\nsome docs.\n\nTried version: 0.20.2, 0.20.6\n\nThe problem is caused by the fact that mapping deletion does not \ndelete lucene index file on disk, and lucene will merge new field \ninfo with the ElasticSearch already _deleted_ field info. \nThe code is as follows:\n\nvoid org.apache.lucene.index.FieldInfo.update(...)\n\n```\n  if (this.indexOptions != indexOptions) {\n    // downgrade\n    this.indexOptions = this.indexOptions.compareTo(indexOptions) < 0 ? this.indexOptions : indexOptions;\n    this.storePayloads = false;\n  }\n```\n\nand the index_options will always be \"docs\". The result is that no\nposition info is stored and phrase query simply not work.\n\ncurl script to reproduce the bug as follows:\n\ncurl -XDELETE localhost:9200/index1?pretty\n\ncurl -XPUT localhost:9200/index1?pretty -d '\n{\n  \"index.number_of_shards\" : 1\n}\n'\ncurl localhost:9200/index1/_settings?pretty\n\ncurl -XPUT localhost:9200/index1?pretty\n\ncurl -XPOST 'localhost:9200/index1/type1/_mapping?pretty' -d '\n{\n  \"type1\" : {\n    \"properties\" : {\n        \"beisen\" : {\n         \"type\" : \"string\",\n         \"analyzer\" : \"standard\",\n         \"index_options\" : \"docs\"\n       }\n     }\n  }\n}'\n\ncurl localhost:9200/index1/_mapping?pretty\n\ncurl localhost:9200/index1/type1/111?pretty -d '\n{\n  \"beisen\" : \"北森测评\"\n}\n'\n\ncurl localhost:9200/index1/type1/_search?pretty -d '\n{\n  \"query\" : {\n    \"text\" : {\n      \"beisen\" : {\n        \"query\" : \"北森\",\n        \"type\" : \"phrase\"\n      }\n    }\n  }\n}\n'\n\nThe above query will find nothing, because the \"index_options\" in the mapping \nis \"docs\", no position info is store, the result is expected.\n\n---\n\ncurl -XDELETE localhost:9200/index1/type1/_mapping?pretty\n\ncurl -XPOST 'localhost:9200/index1/type1/_mapping?pretty' -d '\n{\n  \"type1\" : {\n    \"properties\" : {\n        \"beisen\" : {\n         \"type\" : \"string\",\n         \"analyzer\" : \"standard\",\n         \"index_options\" : \"positions\"\n       }\n     }\n  }\n}'\n\ncurl localhost:9200/index1/_mapping?pretty\n\ncurl localhost:9200/index1/type1/111?pretty -d '\n{\n  \"beisen\" : \"北森测评\"\n}\n'\n\ncurl localhost:9200/index1/type1/_search?pretty -d '\n{\n  \"query\" : {\n    \"text\" : {\n      \"beisen\" : {\n        \"query\" : \"北森\",\n        \"type\" : \"phrase\"\n      }\n    }\n  }\n}\n'\n\nDelete the mapping and recreate with \"index_options\" : \"positions\",\nnow position info should be stored according to the mapping, so we \nexpect the above query returns our doc, but still nothing returned, disappointing...\n\n---\n\ncurl -XDELETE localhost:9200/index1?pretty\n\ncurl -XPUT localhost:9200/index1?pretty -d '\n{\n  \"index.number_of_shards\" : 1\n}\n'\n\ncurl -XPOST 'localhost:9200/index1/type1/_mapping?pretty' -d '\n{\n  \"type1\" : {\n    \"properties\" : {\n        \"beisen\" : {\n         \"type\" : \"string\",\n         \"analyzer\" : \"standard\",\n         \"index_options\" : \"positions\"\n       }\n     }\n  }\n}'\n\ncurl localhost:9200/index1/_mapping?pretty\n\ncurl localhost:9200/index1/type1/111?pretty -d '\n{\n  \"beisen\" : \"北森测评\"\n}\n'\n\ncurl localhost:9200/index1/type1/_search?pretty -d '\n{\n  \"query\" : {\n    \"text\" : {\n      \"beisen\" : {\n        \"query\" : \"北森\",\n        \"type\" : \"phrase\"\n      }\n    }\n  }\n}\n'\n\nDelete the index (lucene index files on disk got cleared), and \nrecreate with \"index_options\" : \"positions\", now it works the \nway we expected.\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}