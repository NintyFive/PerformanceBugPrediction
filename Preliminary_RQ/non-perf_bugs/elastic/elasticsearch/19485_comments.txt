[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/233455438","html_url":"https://github.com/elastic/elasticsearch/issues/19485#issuecomment-233455438","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19485","id":233455438,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMzQ1NTQzOA==","user":{"login":"seang-es","id":6352850,"node_id":"MDQ6VXNlcjYzNTI4NTA=","avatar_url":"https://avatars1.githubusercontent.com/u/6352850?v=4","gravatar_id":"","url":"https://api.github.com/users/seang-es","html_url":"https://github.com/seang-es","followers_url":"https://api.github.com/users/seang-es/followers","following_url":"https://api.github.com/users/seang-es/following{/other_user}","gists_url":"https://api.github.com/users/seang-es/gists{/gist_id}","starred_url":"https://api.github.com/users/seang-es/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/seang-es/subscriptions","organizations_url":"https://api.github.com/users/seang-es/orgs","repos_url":"https://api.github.com/users/seang-es/repos","events_url":"https://api.github.com/users/seang-es/events{/privacy}","received_events_url":"https://api.github.com/users/seang-es/received_events","type":"User","site_admin":false},"created_at":"2016-07-18T20:54:01Z","updated_at":"2016-07-18T20:54:01Z","author_association":"NONE","body":"Also happens with XML content:\n\n```\nPOST test-index/shakespeare/2\n{\n  \"play_name\": \"Henry V\",\n  \"speech_number\": 2,\n  \"text_entry\": \"<Script><text>March all one way and be no more opposed</text></Script>\"\n}\n\nGET /test-index/_search\n{\n\n \"size\" : 10,\n \"query\" : {\n   \"match\" : {\n     \"speech_number\" : {\n       \"query\" : \"2\"\n     }\n   }\n },\n \"highlight\" : {\n   \"tags_schema\" : \"styled\",\n   \"fields\" : {\n     \"text_entry\" : {\n       \"number_of_fragments\" : 0,\n       \"highlight_query\" : {\n         \"match\" : {\n           \"text_entry\" : {\n             \"query\" : \"finance\"\n           }\n         }\n       },\n       \"no_match_size\" : 100000000\n     }\n   }\n }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/233635249","html_url":"https://github.com/elastic/elasticsearch/issues/19485#issuecomment-233635249","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19485","id":233635249,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMzYzNTI0OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-19T13:38:52Z","updated_at":"2016-07-19T13:38:52Z","author_association":"CONTRIBUTOR","body":"You can never rely on valid JSON, XML, HTML, etc being returned from a highlighting request. For example:\n\n```\nPUT t/t/1\n{\n  \"text\": \"<p>one <b>two three four five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten five six seven eight nine ten</b></p>\"\n}\n\nGET _search\n{\n  \"highlight\": {\n    \"fields\": {\n      \"text\": {\n        \"highlight_query\": {\n          \"match\": {\n            \"text\": \"one two\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nreturns:\n\n```\n    \"highlight\": {\n      \"text\": [\n        \"<p><em>one</em> <b><em>two</em> three four five six seven eight nine ten five six seven eight nine ten five six seven\"\n      ]\n    }\n```\n\nAs for why `no_match_size` is dropping the final `}` or `>`, it's because it is using the character offsets returned by the analyzer to determine the end of the text.  \n\nThis example:\n\n```\nPUT t/t/1\n{\n  \"text\": \"one two three!!!!!\"\n}\n\nPUT t/t/2\n{\n  \"text\": \"three four five!!!!!a\"\n}\n\nGET _search\n{\n  \"highlight\": {\n    \"fields\": {\n      \"text\": {\n        \"highlight_query\": {\n          \"match\": {\n            \"text\": \"foo\"\n          }\n        },\n        \"no_match_size\": 1000\n      }\n    }\n  }\n}\n```\n\nreturns highlights `one two three` and `three four five!!!!!a`\n\nCuriously, searching for `three` DOES include the trailing punctuation:`one two <em>three</em>!!!!!` and `<em>three</em> four five!!!!!a`.\n\nPotentially we could make these two cases use the same logic.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234497204","html_url":"https://github.com/elastic/elasticsearch/issues/19485#issuecomment-234497204","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19485","id":234497204,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDQ5NzIwNA==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T09:24:06Z","updated_at":"2016-07-22T09:24:06Z","author_association":"CONTRIBUTOR","body":"Closing, as per @clintongormley comments. Highlighting has never attempted to preserve any valid markup contained in the text it is highlighting because this is too complex and not compatible with the goals of summarising text.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234501589","html_url":"https://github.com/elastic/elasticsearch/issues/19485#issuecomment-234501589","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19485","id":234501589,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDUwMTU4OQ==","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T09:43:52Z","updated_at":"2016-07-22T09:43:52Z","author_association":"CONTRIBUTOR","body":"One suggestion though - for structured text consider storing it not as a blob of marked-up text but instead as regular JSON e.g. an array of \"chapter\" objects each of which have text fields. Then consider indexing using `nested` documents and the `inner_hits` query to select the best chapters that match your text query. \n","performed_via_github_app":null}]