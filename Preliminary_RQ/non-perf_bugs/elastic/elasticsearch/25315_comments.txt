[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310016626","html_url":"https://github.com/elastic/elasticsearch/issues/25315#issuecomment-310016626","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","id":310016626,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDAxNjYyNg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-06-21T09:07:15Z","updated_at":"2017-06-21T09:07:15Z","author_association":"MEMBER","body":"@BLZB0B Are you able to share the 62 documents that matched with that query? (sending it me privately is good too) This would make it easier to reproduce the error. I haven't been able yet to figure out what the cause is.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310047588","html_url":"https://github.com/elastic/elasticsearch/issues/25315#issuecomment-310047588","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","id":310047588,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDA0NzU4OA==","user":{"login":"BLZB0B","id":17888955,"node_id":"MDQ6VXNlcjE3ODg4OTU1","avatar_url":"https://avatars1.githubusercontent.com/u/17888955?v=4","gravatar_id":"","url":"https://api.github.com/users/BLZB0B","html_url":"https://github.com/BLZB0B","followers_url":"https://api.github.com/users/BLZB0B/followers","following_url":"https://api.github.com/users/BLZB0B/following{/other_user}","gists_url":"https://api.github.com/users/BLZB0B/gists{/gist_id}","starred_url":"https://api.github.com/users/BLZB0B/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BLZB0B/subscriptions","organizations_url":"https://api.github.com/users/BLZB0B/orgs","repos_url":"https://api.github.com/users/BLZB0B/repos","events_url":"https://api.github.com/users/BLZB0B/events{/privacy}","received_events_url":"https://api.github.com/users/BLZB0B/received_events","type":"User","site_admin":false},"created_at":"2017-06-21T11:17:50Z","updated_at":"2017-06-21T11:17:50Z","author_association":"NONE","body":"Hi Martijn,\r\n\r\nI've sent a link to your gmail account..\r\n\r\nRegards\r\n\r\nPhil\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310097405","html_url":"https://github.com/elastic/elasticsearch/issues/25315#issuecomment-310097405","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","id":310097405,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDA5NzQwNQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-06-21T14:32:20Z","updated_at":"2017-06-21T19:04:40Z","author_association":"MEMBER","body":"@BLZB0B I've taken a look at the document that causes this error and your mapping and the reason this happens is because the logic that extracts the relevant nested part from the `_source` doesn't work well when a nested object field is wrapped inside an object field. \r\n\r\nIn your case the `calculatedPrices` nested field is wrapped in a `products` object field, which is again wrapped in a `doc` object field. The extract nested source logic falsely assumes that all `calculatedPrices` elements are in the first level, while these elements actually are on the third level.\r\n\r\nI think the nested source extraction logic can be fixed to flatten all the levels that don't use a nested field mapper, but it is going to make the this logic more complicated and unfortunately it is already complicated. I currently lean towards throwing a descriptive error (including a hint with a workaround) in the case of when nested fields are wrapped by regular object fields. Also if we in the future decide to change how the source is stored (as is descibed in #9034) then the extraction of the nested source is no longer needed.\r\n\r\nThere are two workarounds:\r\n* Change `doc` and `products` field to be of type `nested` then the extract nested source logic should work. This does also mean that you need to nested the `nested` query, so for the query you shared, you will need to first use `nested` query for `doc` level then for the `doc.products` level and then `doc.products.calculatedPrices` level.\r\n* The workaround that you're already using; disabling fetching the nested source (`_source` to `false` inside inner hits definition) and enable fetching nested doc values fields (using `docvalue_fields` parameter in the inner hits definition).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310430315","html_url":"https://github.com/elastic/elasticsearch/issues/25315#issuecomment-310430315","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","id":310430315,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDQzMDMxNQ==","user":{"login":"BLZB0B","id":17888955,"node_id":"MDQ6VXNlcjE3ODg4OTU1","avatar_url":"https://avatars1.githubusercontent.com/u/17888955?v=4","gravatar_id":"","url":"https://api.github.com/users/BLZB0B","html_url":"https://github.com/BLZB0B","followers_url":"https://api.github.com/users/BLZB0B/followers","following_url":"https://api.github.com/users/BLZB0B/following{/other_user}","gists_url":"https://api.github.com/users/BLZB0B/gists{/gist_id}","starred_url":"https://api.github.com/users/BLZB0B/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BLZB0B/subscriptions","organizations_url":"https://api.github.com/users/BLZB0B/orgs","repos_url":"https://api.github.com/users/BLZB0B/repos","events_url":"https://api.github.com/users/BLZB0B/events{/privacy}","received_events_url":"https://api.github.com/users/BLZB0B/received_events","type":"User","site_admin":false},"created_at":"2017-06-22T16:20:18Z","updated_at":"2017-06-22T16:20:18Z","author_association":"NONE","body":"Thanks Martijn,\r\n\r\nI've updated our mapping as suggested and are getting results back with \"inner_hits\": { } rather than the error mentioned above.\r\n\r\nA more useful error message would help as you suggested.\r\n\r\nI have a question related to the above but not part of the bug, so will switch to the forum rather than ask here if that's OK.\r\n\r\nRegards\r\n\r\nPhil","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310669206","html_url":"https://github.com/elastic/elasticsearch/issues/25315#issuecomment-310669206","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","id":310669206,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDY2OTIwNg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-06-23T13:44:55Z","updated_at":"2017-06-23T13:44:55Z","author_association":"MEMBER","body":"This was discussed in the fix it friday meeting and there was agreement on making the nested source extraction not more complicated than it already is. So we should throw a descriptive error and document the two possible workarounds.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/310691174","html_url":"https://github.com/elastic/elasticsearch/issues/25315#issuecomment-310691174","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","id":310691174,"node_id":"MDEyOklzc3VlQ29tbWVudDMxMDY5MTE3NA==","user":{"login":"BLZB0B","id":17888955,"node_id":"MDQ6VXNlcjE3ODg4OTU1","avatar_url":"https://avatars1.githubusercontent.com/u/17888955?v=4","gravatar_id":"","url":"https://api.github.com/users/BLZB0B","html_url":"https://github.com/BLZB0B","followers_url":"https://api.github.com/users/BLZB0B/followers","following_url":"https://api.github.com/users/BLZB0B/following{/other_user}","gists_url":"https://api.github.com/users/BLZB0B/gists{/gist_id}","starred_url":"https://api.github.com/users/BLZB0B/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BLZB0B/subscriptions","organizations_url":"https://api.github.com/users/BLZB0B/orgs","repos_url":"https://api.github.com/users/BLZB0B/repos","events_url":"https://api.github.com/users/BLZB0B/events{/privacy}","received_events_url":"https://api.github.com/users/BLZB0B/received_events","type":"User","site_admin":false},"created_at":"2017-06-23T15:08:28Z","updated_at":"2017-06-23T15:08:28Z","author_association":"NONE","body":"Thanks @martijnvg ","performed_via_github_app":null}]