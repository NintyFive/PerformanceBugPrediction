{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16535","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16535/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16535/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16535/events","html_url":"https://github.com/elastic/elasticsearch/issues/16535","id":132422604,"node_id":"MDU6SXNzdWUxMzI0MjI2MDQ=","number":16535,"title":"multi_match query different scoring results 1.7 - 2.1","user":{"login":"mfussenegger","id":38700,"node_id":"MDQ6VXNlcjM4NzAw","avatar_url":"https://avatars0.githubusercontent.com/u/38700?v=4","gravatar_id":"","url":"https://api.github.com/users/mfussenegger","html_url":"https://github.com/mfussenegger","followers_url":"https://api.github.com/users/mfussenegger/followers","following_url":"https://api.github.com/users/mfussenegger/following{/other_user}","gists_url":"https://api.github.com/users/mfussenegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mfussenegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfussenegger/subscriptions","organizations_url":"https://api.github.com/users/mfussenegger/orgs","repos_url":"https://api.github.com/users/mfussenegger/repos","events_url":"https://api.github.com/users/mfussenegger/events{/privacy}","received_events_url":"https://api.github.com/users/mfussenegger/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-02-09T13:44:19Z","updated_at":"2016-02-09T14:57:20Z","closed_at":"2016-02-09T14:57:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"We're in the progress of upgrading to ES 2.1 and have noticed that some queries now have different results.\nI'm trying to figure out the root cause. So far my guess is that it is a analyzer change within Lucene.\n\nHere is the mapping I'm using:\n\n```\n{\n    \"settings\": {\n        \"number_of_shards\": 2\n    },\n    \"mappings\": {\n        \"default\": {\n            \"dynamic\": \"true\",\n            \"_all\": {\n                \"enabled\": false\n            },\n            \"properties\": {\n                \"description\": {\n                    \"type\": \"string\",\n                    \"index\": \"not_analyzed\",\n                    \"doc_values\": true,\n                    \"copy_to\": [\n                        \"name_description_ft\"\n                    ]\n                },\n                \"id\": {\n                    \"type\": \"string\",\n                    \"index\": \"not_analyzed\",\n                    \"doc_values\": true\n                },\n                \"kind\": {\n                    \"type\": \"string\",\n                    \"index\": \"not_analyzed\",\n                    \"doc_values\": true\n                },\n                \"name\": {\n                    \"type\": \"string\",\n                    \"index\": \"not_analyzed\",\n                    \"doc_values\": true,\n                    \"copy_to\": [\n                        \"name_description_ft\"\n                    ]\n                },\n                \"name_description_ft\": {\n                    \"type\": \"string\",\n                    \"analyzer\": \"english\"\n                }\n            }\n        }\n    }\n}\n```\n\nHere are the records:\n\n```\n{\"index\": {\"_id\": \"1\"}}\n{\"id\":\"1\",\"name\":\"North West Ripple\",\"kind\":\"Galaxy\",\"description\":\"Relative to life on NowWhat, living on an affluent world in the North West ripple of the Galaxy is said to be easier by a factor of about seventeen million.\"}\n{\"index\": {\"_id\": \"2\"}}\n{\"id\":\"2\",\"name\":\"Outer Eastern Rim\",\"kind\":\"Galaxy\",\"description\":\"The Outer Eastern Rim of the Galaxy where the Guide has supplanted the Encyclopedia Galactica among its more relaxed civilisations.\"}\n{\"index\": {\"_id\": \"3\"}}\n{\"id\":\"3\",\"name\":\"Galactic Sector QQ7 Active J Gamma\",\"kind\":\"Galaxy\",\"description\":\"Galactic Sector QQ7 Active J Gamma contains the Sun Zarss, the planet Preliumtarn of the famed Sevorbeupstry and Quentulus Quazgar Mountains.\"}\n{\"index\": {\"_id\": \"4\"}}\n{\"id\":\"4\",\"name\":\"Aldebaran\",\"kind\":\"Star System\",\"description\":\"Max Quordlepleen claims that the only thing left after the end of the Universe will be the sweets trolley and a fine selection of Aldebaran liqueurs.\"}\n{\"index\": {\"_id\": \"5\"}}\n{\"id\":\"5\",\"name\":\"Algol\",\"kind\":\"Star System\",\"description\":\"Algol is the home of the Algolian Suntiger, the tooth of which is one of the ingredients of the Pan Galactic Gargle Blaster.\"}\n{\"index\": {\"_id\": \"6\"}}\n{\"id\":\"6\",\"name\":\"Alpha Centauri\",\"kind\":\"Star System\",\"description\":\"4.1 light-years northwest of earth\"}\n{\"index\": {\"_id\": \"7\"}}\n{\"id\":\"7\",\"name\":\"Altair\",\"kind\":\"Star System\",\"description\":\"The Altairian dollar is one of three freely convertible currencies in the galaxy, though by the time of the novels it had apparently recently collapsed.\"}\n{\"index\": {\"_id\": \"8\"}}\n{\"id\":\"8\",\"name\":\"Allosimanius Syneca\",\"kind\":\"Planet\",\"description\":\"Allosimanius Syneca is a planet noted for ice, snow, mind-hurtling beauty and stunning cold.\"}\n{\"index\": {\"_id\": \"9\"}}\n{\"id\":\"9\",\"name\":\"Argabuthon\",\"kind\":\"Planet\",\"description\":\"It is also the home of Prak, a man placed into solitary confinement after an overdose of truth drug caused him to tell the Truth in its absolute and final form, causing anyone to hear it to go insane.\"}\n{\"index\": {\"_id\": \"10\"}}\n{\"id\":\"10\",\"name\":\"Arkintoofle Minor\",\"kind\":\"Planet\",\"description\":\"Motivated by the fact that the only thing in the Universe that travels faster than light is bad news, the Hingefreel people native to Arkintoofle Minor constructed a starship driven by bad news.\"}\n{\"index\": {\"_id\": \"11\"}}\n{\"id\":\"11\",\"name\":\"Bartledan\",\"kind\":\"Planet\",\"description\":\"An Earthlike planet on which Arthur Dent lived for a short time, Bartledan is inhabited by Bartledanians, a race that appears human but only physically.\"}\n{\"index\": {\"_id\": \"12\"}}\n{\"id\":\"12\",\"name\":\"\",\"kind\":\"Planet\",\"description\":\"This Planet doesn't really exist\"}\n{\"index\": {\"_id\": \"13\"}}\n{\"id\":\"13\",\"name\":null,\"kind\":\"Galaxy\",\"description\":\"The end of the Galaxy.%\"}\n```\n\nAnd this is the query:\n\n```\n{\n    \"explain\": true,\n    \"query\": {\n        \"multi_match\": {\n            \"fields\": [\"kind^0.8\", \"name_description_ft^0.6\"],\n            \"query\": \"planet earth\"\n        }\n    }\n}\n```\n\nIn 1.7 the top 2 hits are\n\n```\n            {\n                \"_id\": \"6\",\n                \"_score\": 0.22184466,\n                \"_source\": {\n                    \"id\": \"6\",\n                    \"name\": \"Alpha Centauri\",\n                    \"kind\": \"Star System\",\n                    \"description\": \"4.1 light-years northwest of earth\"\n                }\n            },\n            {\n                \"_id\": \"12\",\n                \"_score\": 0.21719791,\n                \"_source\": {\n                    \"id\": \"12\",\n                    \"name\": \"\",\n                    \"kind\": \"Planet\",\n                    \"description\": \"This Planet doesn't really exist\"\n                }\n            },\n```\n\nand in 2.1 they are:\n\n```\n             {\n                \"_id\": \"6\",\n                \"_score\": 0.2600391,\n                \"_source\": {\n                    \"id\": \"6\",\n                    \"name\": \"Alpha Centauri\",\n                    \"kind\": \"Star System\",\n                    \"description\": \"4.1 light-years northwest of earth\"\n                }\n            },\n            {\n                \"_id\": \"11\",\n                \"_score\": 0.15168947,\n                \"_source\": {\n                    \"id\": \"11\",\n                    \"name\": \"Bartledan\",\n                    \"kind\": \"Planet\",\n                    \"description\": \"An Earthlike planet on which Arthur Dent lived for a short time, Bartledan is inhabited by Bartledanians, a race that appears human but only physically.\"\n                }\n            },\n```\n\nI've also tried to do a snapshot on 1.7 and then restore the snapshot in 2.1. This results in 2.1 producing the same result as in 1.7 which is why I assume that something at indexing time is now handled differently.\n\nI've also tried to see if the `_analyze` API returns a different result somewhere. But all descriptions are tokenized the same in 1.7 and 2.1 - the only difference is that in one version position is starting from 0 and in the other version it's starting from 1.\n\nMaybe I'm missing something obvious here, \n","closed_by":{"login":"mfussenegger","id":38700,"node_id":"MDQ6VXNlcjM4NzAw","avatar_url":"https://avatars0.githubusercontent.com/u/38700?v=4","gravatar_id":"","url":"https://api.github.com/users/mfussenegger","html_url":"https://github.com/mfussenegger","followers_url":"https://api.github.com/users/mfussenegger/followers","following_url":"https://api.github.com/users/mfussenegger/following{/other_user}","gists_url":"https://api.github.com/users/mfussenegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mfussenegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfussenegger/subscriptions","organizations_url":"https://api.github.com/users/mfussenegger/orgs","repos_url":"https://api.github.com/users/mfussenegger/repos","events_url":"https://api.github.com/users/mfussenegger/events{/privacy}","received_events_url":"https://api.github.com/users/mfussenegger/received_events","type":"User","site_admin":false},"performed_via_github_app":null}