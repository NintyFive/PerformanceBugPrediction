[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/32453512","html_url":"https://github.com/elastic/elasticsearch/issues/4754#issuecomment-32453512","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","id":32453512,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDUzNTEy","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-01-16T09:31:00Z","updated_at":"2014-01-16T09:31:00Z","author_association":"CONTRIBUTOR","body":"There is indeed an issue in the case of `DFS_QUERY_AND_FETCH` because the facet executor is initialized and requests a recycled object in executeDfsPhase while facets are built (and recycled objects released) in executeFetchPhase. For reference, here are a stack trace of allocation and release:\n\n```\nat org.elasticsearch.common.recycler.ThreadLocalRecycler$TV.<init>(ThreadLocalRecycler.java:67)\n    at org.elasticsearch.common.recycler.ThreadLocalRecycler.obtain(ThreadLocalRecycler.java:57)\n    at org.elasticsearch.common.recycler.Recycler$Sizing.obtain(Recycler.java:47)\n    at org.elasticsearch.cache.recycler.CacheRecycler.longIntMap(CacheRecycler.java:236)\n    at org.elasticsearch.search.facet.terms.longs.TermsLongFacetExecutor.<init>(TermsLongFacetExecutor.java:71)\n    at org.elasticsearch.search.facet.terms.TermsFacetParser.parse(TermsFacetParser.java:214)\n    at org.elasticsearch.search.facet.FacetParseElement.parse(FacetParseElement.java:94)\n    at org.elasticsearch.search.SearchService.parseSource(SearchService.java:569)\n    at org.elasticsearch.search.SearchService.createContext(SearchService.java:484)\n    at org.elasticsearch.search.SearchService.createContext(SearchService.java:469)\n    at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:462)\n    at org.elasticsearch.search.SearchService.executeDfsPhase(SearchService.java:168)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteDfs(SearchServiceTransportAction.java:168)\nat org.elasticsearch.action.search.type.TransportSearchDfsQueryAndFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchDfsQueryAndFetchAction.java:77)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:216)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:203)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:186)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:722)\n```\n\n```\nat org.elasticsearch.common.recycler.ThreadLocalRecycler$TV.release(ThreadLocalRecycler.java:88)\n    at org.elasticsearch.search.facet.terms.longs.TermsLongFacetExecutor.buildFacet(TermsLongFacetExecutor.java:104)\n    at org.elasticsearch.search.facet.FacetPhase.execute(FacetPhase.java:200)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:129)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:357)\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/32619092","html_url":"https://github.com/elastic/elasticsearch/issues/4754#issuecomment-32619092","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","id":32619092,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNjE5MDky","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-01-17T16:13:26Z","updated_at":"2014-01-17T16:13:26Z","author_association":"CONTRIBUTOR","body":"Even though this assertion failure shows that the recycler is not used optimally (the reference is acquired and used in different phases), I think this doesn't break anything. Since facets are going to be progressively replaced by aggregations, I'm wondering if we should just remove the assertion instead of trying to fix the issue?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/32770955","html_url":"https://github.com/elastic/elasticsearch/issues/4754#issuecomment-32770955","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","id":32770955,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzcwOTU1","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2014-01-20T15:53:12Z","updated_at":"2014-01-20T15:53:12Z","author_association":"CONTRIBUTOR","body":"so I don't want to loose the ability to fail if it's not released in the same thread to be honest. can we somehow only special case the broken facet impls?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/37459982","html_url":"https://github.com/elastic/elasticsearch/issues/4754#issuecomment-37459982","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","id":37459982,"node_id":"MDEyOklzc3VlQ29tbWVudDM3NDU5OTgy","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2014-03-12T20:26:53Z","updated_at":"2014-03-12T20:26:53Z","author_association":"CONTRIBUTOR","body":"@jpountz can we actually close this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/38147377","html_url":"https://github.com/elastic/elasticsearch/issues/4754#issuecomment-38147377","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","id":38147377,"node_id":"MDEyOklzc3VlQ29tbWVudDM4MTQ3Mzc3","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-03-20T09:20:17Z","updated_at":"2014-03-20T09:20:17Z","author_association":"CONTRIBUTOR","body":"Closed via f7e887b5576fdadb729b608491b0ba55fd30dc86\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/41263106","html_url":"https://github.com/elastic/elasticsearch/issues/4754#issuecomment-41263106","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4754","id":41263106,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjYzMTA2","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-04-24T10:03:28Z","updated_at":"2014-04-24T10:03:28Z","author_association":"CONTRIBUTOR","body":"For reference, the root cause of this issue has been fixed in #5821\n","performed_via_github_app":null}]