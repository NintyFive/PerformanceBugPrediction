{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26581","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26581/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26581/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26581/events","html_url":"https://github.com/elastic/elasticsearch/issues/26581","id":256816869,"node_id":"MDU6SXNzdWUyNTY4MTY4Njk=","number":26581,"title":"Bug: Suggest request for a CustomSuggester fail  with \"ReduceSearchPhaseException\" in Multi-DataNode scenarios.","user":{"login":"UD1412","id":4610373,"node_id":"MDQ6VXNlcjQ2MTAzNzM=","avatar_url":"https://avatars0.githubusercontent.com/u/4610373?v=4","gravatar_id":"","url":"https://api.github.com/users/UD1412","html_url":"https://github.com/UD1412","followers_url":"https://api.github.com/users/UD1412/followers","following_url":"https://api.github.com/users/UD1412/following{/other_user}","gists_url":"https://api.github.com/users/UD1412/gists{/gist_id}","starred_url":"https://api.github.com/users/UD1412/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UD1412/subscriptions","organizations_url":"https://api.github.com/users/UD1412/orgs","repos_url":"https://api.github.com/users/UD1412/repos","events_url":"https://api.github.com/users/UD1412/events{/privacy}","received_events_url":"https://api.github.com/users/UD1412/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2017-09-11T19:33:12Z","updated_at":"2017-09-11T20:32:45Z","closed_at":"2017-09-11T20:32:45Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 1.7 and above\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): Jdk 1.8\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nThe CustomSuggester needs to return a \"CustomSuggestion\" type of object which has some additional attribute in the 'Options' and a custom sort comparator.\r\nThe 'suggest' requests work as expected when all shards are present on a single data Node. \r\nHowever, if # Data Nodes >1, then the suggest fails with the following error in the reduce phase.\r\n_\"Can't merge suggest result, this might be caused by suggest calls across multiple indices with different analysis chains. Suggest entries have different sizes actual [0] expected [1]);\"_\r\n\r\n**Reason:**\r\nIn the  _'merge'_ API of 'SearcPhaseController.java' where the suggest results from different shards are merged, the suggest results from the coordinating Node are of type 'CustomSuggestion' but the results from all other data nodes are **down-casted** to Suggest.Suggestion type. This causes the reduce phase to fail.\r\n\r\n**Steps to reproduce**:\r\n 1. Define CustomSuggestion class( extends Suggestion class). The 'Option' of the CustomSuggestion.Entry has an additional attribute ( This can be any attribute. string, int float. eg: int _'randomAttribute'_. Let's say this has a constant value =1).\r\n2. Define CustomSuggester to return CustomSuggestion type of response.\r\n3. Register the Custom Suggester in the Suggest Module.\r\n4. Create a cluster with a single Data node.\r\n         Issue request against the 'CustomSuggester'.  All request succeed. The Options in the returned response contain the _'randomAttribute'_ as well.\r\n5. Create a cluster with a >1 Data node.\r\n         Issue request against the 'CustomSuggester'.  Request fail with ReduceSearchPhaseException, while merging the results in the co-ordinating node.\r\n6. On Debugging, you will notice that some results from some shards are of type \"CustomSuggestion\" and some are of type \"Suggestion\". \r\n\r\n**Questions**\r\nWhy does this down casting ing happen?\r\nHow can I register the suggester so that the response is not downcasted to the Base Suggestion class?\r\n\r\n**Provide logs (if relevant)**:\r\n2017-09-11 10:14:13,318][WARN ][transport.netty          ] [localhost-1] Message not fully read (response) for [96] handler org.elasticsearch.search.action.SearchServiceTransportAction$6@35c82c9d, error [false], resetting\r\n[2017-09-11 10:14:13,319][WARN ][transport.netty          ] [localhost-1] Message not fully read (response) for [93] handler org.elasticsearch.search.action.SearchServiceTransportAction$6@5bcb6480, error [false], resetting\r\n[2017-09-11 10:14:13,319][DEBUG][action.search.type       ] [localhost-1] failed to reduce search\r\norg.elasticsearch.action.search.ReduceSearchPhaseException: Failed to execute phase [fetch], [reduce] \r\n\tat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.onFailure(TransportSearchQueryThenFetchAction.java:159)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:41)\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\nCaused by: org.elasticsearch.ElasticsearchIllegalStateException: Can't merge suggest result, this might be caused by suggest calls across multiple indices with different analysis chains. Suggest entries have different sizes actual [0] expected [1]\r\n\tat org.elasticsearch.search.suggest.Suggest$Suggestion.reduce(Suggest.java:256)\r\n\tat org.elasticsearch.search.suggest.Suggest.reduce(Suggest.java:185)\r\n\tat org.elasticsearch.search.controller.SearchPhaseController.merge(SearchPhaseController.java:396)\r\n\tat org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.doRun(TransportSearchQueryThenFetchAction.java:147)\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\r\n\t... 3 more\r\n","closed_by":{"login":"UD1412","id":4610373,"node_id":"MDQ6VXNlcjQ2MTAzNzM=","avatar_url":"https://avatars0.githubusercontent.com/u/4610373?v=4","gravatar_id":"","url":"https://api.github.com/users/UD1412","html_url":"https://github.com/UD1412","followers_url":"https://api.github.com/users/UD1412/followers","following_url":"https://api.github.com/users/UD1412/following{/other_user}","gists_url":"https://api.github.com/users/UD1412/gists{/gist_id}","starred_url":"https://api.github.com/users/UD1412/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/UD1412/subscriptions","organizations_url":"https://api.github.com/users/UD1412/orgs","repos_url":"https://api.github.com/users/UD1412/repos","events_url":"https://api.github.com/users/UD1412/events{/privacy}","received_events_url":"https://api.github.com/users/UD1412/received_events","type":"User","site_admin":false},"performed_via_github_app":null}