{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50539","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50539/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50539/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50539/events","html_url":"https://github.com/elastic/elasticsearch/issues/50539","id":544219644,"node_id":"MDU6SXNzdWU1NDQyMTk2NDQ=","number":50539,"title":"NPE when having two \"should\" sub-queries with one has_parent w/ inner_hits","user":{"login":"gbeskales","id":1866288,"node_id":"MDQ6VXNlcjE4NjYyODg=","avatar_url":"https://avatars3.githubusercontent.com/u/1866288?v=4","gravatar_id":"","url":"https://api.github.com/users/gbeskales","html_url":"https://github.com/gbeskales","followers_url":"https://api.github.com/users/gbeskales/followers","following_url":"https://api.github.com/users/gbeskales/following{/other_user}","gists_url":"https://api.github.com/users/gbeskales/gists{/gist_id}","starred_url":"https://api.github.com/users/gbeskales/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gbeskales/subscriptions","organizations_url":"https://api.github.com/users/gbeskales/orgs","repos_url":"https://api.github.com/users/gbeskales/repos","events_url":"https://api.github.com/users/gbeskales/events{/privacy}","received_events_url":"https://api.github.com/users/gbeskales/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"assignees":[{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-12-31T16:00:46Z","updated_at":"2020-01-07T19:54:44Z","closed_at":"2020-01-07T17:20:10Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 6.8.2, Build: oss/tar/b506955/2019-07-24T15:24:41.545295Z, JVM: 1.8.0_232\r\n\r\n**Plugins installed**: \r\n\"repository-azure\",  \"repository-gcs\", \"repository-hdfs\", \"repository-s3\"\r\n\r\n\r\n**JVM version** (`java -version`):\r\n\r\nopenjdk version \"1.8.0_232\"\r\nOpenJDK Runtime Environment (build 1.8.0_232-8u232-b09-0ubuntu1~18.04.1-b09)\r\nOpenJDK 64-Bit Server VM (build 25.232-b09, mixed mode\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux george-P51 4.15.0-72-generic #81-Ubuntu SMP Tue Nov 26 12:20:02 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\njava.lang.NullPointerException is thrown when having a bool query with two should sub-queries and when only one of them have \"has_parent\" with \"inner_hits\".\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\ncurl -X PUT \"localhost:9200/my_index\"\r\n\r\ncurl -X PUT \"localhost:9200/my_index/_mapping/_doc\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"properties\": {\r\n    \"entity_type\": {\r\n      \"type\": \"keyword\"\r\n    },\r\n    \"my_join_field\": {\r\n      \"type\": \"join\",\r\n      \"relations\": {\r\n        \"question\": [\"answer\"],\r\n        \"person\": [\"phone\"]\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/my_index/_doc/1?refresh\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"text\": \"This is a question\",\r\n  \"my_join_field\": {\r\n    \"name\": \"question\"\r\n  },\r\n  \"entity_type\": \"question\"\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/my_index/_doc/2?routing=1&refresh\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"text\": \"This is an answer\",\r\n  \"my_join_field\": {\r\n    \"name\": \"answer\", \r\n    \"parent\": \"1\" \r\n  },\r\n  \"entity_type\": \"answer\"\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/my_index/_doc/3?refresh\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"text\": \"This is a person\",\r\n  \"my_join_field\": {\r\n    \"name\": \"person\"\r\n  },\r\n  \"entity_type\": \"person\"\r\n}\r\n'\r\n\r\ncurl -X PUT \"localhost:9200/my_index/_doc/4?routing=3&refresh\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"text\": \"This is an phone\",\r\n  \"my_join_field\": {\r\n    \"name\": \"phone\", \r\n    \"parent\": \"3\" \r\n  },\r\n  \"entity_type\": \"phone\"\r\n}\r\n'\r\n\r\ncurl -X GET \"localhost:9200/my_index/_search?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"term\": {\r\n            \"entity_type\": \"person\"\r\n          }\r\n        },\r\n        {\r\n          \"bool\": {\r\n            \"filter\": [\r\n              {\r\n                \"term\": {\r\n                  \"entity_type\": \"answer\"\r\n                }\r\n              },\r\n              {\r\n                \"bool\": {\r\n                  \"should\": [\r\n                    {\r\n                      \"has_parent\": {\r\n                        \"query\": {\r\n                          \"match_all\": {}\r\n                        },\r\n                        \"parent_type\": \"question\",\r\n                        \"inner_hits\": {\r\n                          \"name\": \"inner_hit\"\r\n                        }\r\n                      }\r\n                    }\r\n                  ]\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2019-12-31T10:51:12,807][DEBUG][o.e.a.s.TransportSearchAction] [mtFKkTf] [20] Failed to execute fetch phase\r\norg.elasticsearch.transport.RemoteTransportException: [mtFKkTf][127.0.0.1:9300][indices:data/read/search[phase/fetch/id]]\r\nCaused by: java.lang.NullPointerException\r\n\tat org.elasticsearch.index.mapper.IdFieldMapper$IdFieldType.termsQuery(IdFieldMapper.java:152) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.index.mapper.IdFieldMapper$IdFieldType.termQuery(IdFieldMapper.java:128) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.join.query.ParentChildInnerHitContextBuilder$JoinFieldInnerHitSubContext.topDocs(ParentChildInnerHitContextBuilder.java:159) ~[?:?]\r\n\tat org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitsExecute(InnerHitsFetchSubPhase.java:53) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:175) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService.lambda$executeFetchPhase$3(SearchService.java:541) ~[elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:381) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.8.2.jar:6.8.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_232]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_232]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_232]\r\n```","closed_by":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"performed_via_github_app":null}