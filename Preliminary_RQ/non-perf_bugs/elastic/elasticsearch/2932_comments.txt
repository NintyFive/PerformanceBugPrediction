[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17003411","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17003411","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17003411,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDAzNDEx","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-04-25T12:21:59Z","updated_at":"2013-04-25T12:21:59Z","author_association":"CONTRIBUTOR","body":"hey, can you maybe provide a self-contained test that reproduces this. Do you know where the NPE is thrown ie. can you see something in the logs?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17235010","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17235010","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17235010,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjM1MDEw","user":{"login":"alambert","id":69652,"node_id":"MDQ6VXNlcjY5NjUy","avatar_url":"https://avatars2.githubusercontent.com/u/69652?v=4","gravatar_id":"","url":"https://api.github.com/users/alambert","html_url":"https://github.com/alambert","followers_url":"https://api.github.com/users/alambert/followers","following_url":"https://api.github.com/users/alambert/following{/other_user}","gists_url":"https://api.github.com/users/alambert/gists{/gist_id}","starred_url":"https://api.github.com/users/alambert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alambert/subscriptions","organizations_url":"https://api.github.com/users/alambert/orgs","repos_url":"https://api.github.com/users/alambert/repos","events_url":"https://api.github.com/users/alambert/events{/privacy}","received_events_url":"https://api.github.com/users/alambert/received_events","type":"User","site_admin":false},"created_at":"2013-04-30T15:38:05Z","updated_at":"2013-04-30T15:38:05Z","author_association":"CONTRIBUTOR","body":"cc @spinscale @imotov \n\nI think I've been able to repro this in our dev cluster running the 0.90.0 release. This is causing all shards' searches to fail with \"SendRequestTransportException[....spindle-dev.net[inet/10.252.166.47:7200]search/phase/query/id]; nested: NullPointerException\" It looks like writeTo() in AggregatedDfs is calling out.writeString(entry.getKey()) (line 106) but entry.getKey() is returning null. I'm still trying to find the query that's causing this, but it's definitely using DFS_QUERY_THEN_FETCH.\n\nThe thread stack is:\n\n<pre>\nThread 18766: (state = BLOCKED)\n - org.elasticsearch.common.io.stream.HandlesStreamOutput.writeString(java.lang.String) @bci=1, line=55 (Interpreted frame)\n - org.elasticsearch.search.dfs.AggregatedDfs.writeTo(org.elasticsearch.common.io.stream.StreamOutput) @bci=174, line=106 (Interpreted frame)\n - org.elasticsearch.search.query.QuerySearchRequest.writeTo(org.elasticsearch.common.io.stream.StreamOutput) @bci=18, line=69 (Interpreted frame)\n - org.elasticsearch.transport.netty.NettyTransport.sendRequest(org.elasticsearch.cluster.node.DiscoveryNode, long, java.lang.String, org.elasticsearch.transport.TransportRequest, org.elasticsearch.transport.TransportRequestOptions) @bci=143, line=546 (Interpreted frame)\n - org.elasticsearch.transport.TransportService.sendRequest(org.elasticsearch.cluster.node.DiscoveryNode, java.lang.String, org.elasticsearch.transport.TransportRequest, org.elasticsearch.transport.TransportRequestOptions, org.elasticsearch.transport.TransportResponseHandler) @bci=86, line=184 (Interpreted frame)\n - org.elasticsearch.transport.TransportService.sendRequest(org.elasticsearch.cluster.node.DiscoveryNode, java.lang.String, org.elasticsearch.transport.TransportRequest, org.elasticsearch.transport.TransportResponseHandler) @bci=9, line=171 (Interpreted frame)\n - org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(org.elasticsearch.cluster.node.DiscoveryNode, org.elasticsearch.search.query.QuerySearchRequest, org.elasticsearch.search.action.SearchServiceListener) @bci=76, line=181 (Interpreted frame)\n - org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.executeQuery(org.elasticsearch.search.dfs.DfsSearchResult, java.util.concurrent.atomic.AtomicInteger, org.elasticsearch.search.query.QuerySearchRequest, org.elasticsearch.cluster.node.DiscoveryNode) @bci=21, line=148 (Interpreted frame)\n - org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.moveToSecondPhase() @bci=135, line=107 (Interpreted frame)\n - org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.onFirstPhaseResult(org.elasticsearch.cluster.routing.ShardRouting, org.elasticsearch.search.SearchPhaseResult, org.elasticsearch.cluster.routing.ShardIterator) @bci=72, line=229 (Interpreted frame)\n - org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$3.onResult(org.elasticsearch.search.SearchPhaseResult) @bci=13, line=208 (Interpreted frame)\n - org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$3.onResult(java.lang.Object) @bci=5, line=205 (Interpreted frame)\n - org.elasticsearch.search.action.SearchServiceTransportAction$1.handleResponse(org.elasticsearch.search.dfs.DfsSearchResult) @bci=5, line=122 (Interpreted frame)\n - org.elasticsearch.search.action.SearchServiceTransportAction$1.handleResponse(org.elasticsearch.transport.TransportResponse) @bci=5, line=113 (Interpreted frame)\n - org.elasticsearch.transport.netty.MessageChannelHandler.handleResponse(org.elasticsearch.common.io.stream.StreamInput, org.elasticsearch.transport.TransportResponseHandler) @bci=75, line=156 (Interpreted frame)\n - org.elasticsearch.transport.netty.MessageChannelHandler.messageReceived(org.elasticsearch.common.netty.channel.ChannelHandlerContext, org.elasticsearch.common.netty.channel.MessageEvent) @bci=490, line=127 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(org.elasticsearch.common.netty.channel.ChannelHandlerContext, org.elasticsearch.common.netty.channel.ChannelEvent) @bci=13, line=70 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.DefaultChannelPipeline.sendUpstream(org.elasticsearch.common.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext, org.elasticsearch.common.netty.channel.ChannelEvent) @bci=9, line=564 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendUpstream(org.elasticsearch.common.netty.channel.ChannelEvent) @bci=22, line=791 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.Channels.fireMessageReceived(org.elasticsearch.common.netty.channel.ChannelHandlerContext, java.lang.Object, java.net.SocketAddress) @bci=16, line=296 (Interpreted frame)\n - org.elasticsearch.common.netty.handler.codec.frame.FrameDecoder.unfoldAndFireMessageReceived(org.elasticsearch.common.netty.channel.ChannelHandlerContext, java.net.SocketAddress, java.lang.Object) @bci=123, line=462 (Interpreted frame)\n - org.elasticsearch.common.netty.handler.codec.frame.FrameDecoder.callDecode(org.elasticsearch.common.netty.channel.ChannelHandlerContext, org.elasticsearch.common.netty.channel.Channel, org.elasticsearch.common.netty.buffer.ChannelBuffer, java.net.SocketAddress) @bci=97, line=443 (Interpreted frame)\n - org.elasticsearch.common.netty.handler.codec.frame.FrameDecoder.messageReceived(org.elasticsearch.common.netty.channel.ChannelHandlerContext, org.elasticsearch.common.netty.channel.MessageEvent) @bci=62, line=303 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.SimpleChannelUpstreamHandler.handleUpstream(org.elasticsearch.common.netty.channel.ChannelHandlerContext, org.elasticsearch.common.netty.channel.ChannelEvent) @bci=13, line=70 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.DefaultChannelPipeline.sendUpstream(org.elasticsearch.common.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext, org.elasticsearch.common.netty.channel.ChannelEvent) @bci=9, line=564 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.DefaultChannelPipeline.sendUpstream(org.elasticsearch.common.netty.channel.ChannelEvent) @bci=55, line=559 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.Channels.fireMessageReceived(org.elasticsearch.common.netty.channel.Channel, java.lang.Object, java.net.SocketAddress) @bci=16, line=268 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.Channels.fireMessageReceived(org.elasticsearch.common.netty.channel.Channel, java.lang.Object) @bci=3, line=255 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.socket.nio.NioWorker.read(java.nio.channels.SelectionKey) @bci=179, line=88 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.socket.nio.AbstractNioWorker.process(java.nio.channels.Selector) @bci=70, line=107 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.socket.nio.AbstractNioSelector.run() @bci=368, line=312 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.socket.nio.AbstractNioWorker.run() @bci=1, line=88 (Interpreted frame)\n - org.elasticsearch.common.netty.channel.socket.nio.NioWorker.run() @bci=1, line=178 (Interpreted frame)\n - org.elasticsearch.common.netty.util.ThreadRenamingRunnable.run() @bci=55, line=108 (Interpreted frame)\n - org.elasticsearch.common.netty.util.internal.DeadLockProofWorker$1.run() @bci=14, line=42 (Interpreted frame)\n - java.util.concurrent.ThreadPoolExecutor.runWorker(java.util.concurrent.ThreadPoolExecutor$Worker) @bci=95, line=1145 (Interpreted frame)\n - java.util.concurrent.ThreadPoolExecutor$Worker.run() @bci=5, line=615 (Interpreted frame)\n - java.lang.Thread.run() @bci=11, line=722 (Interpreted frame)\n</pre>\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17580664","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17580664","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17580664,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NTgwNjY0","user":{"login":"waterdh","id":880484,"node_id":"MDQ6VXNlcjg4MDQ4NA==","avatar_url":"https://avatars1.githubusercontent.com/u/880484?v=4","gravatar_id":"","url":"https://api.github.com/users/waterdh","html_url":"https://github.com/waterdh","followers_url":"https://api.github.com/users/waterdh/followers","following_url":"https://api.github.com/users/waterdh/following{/other_user}","gists_url":"https://api.github.com/users/waterdh/gists{/gist_id}","starred_url":"https://api.github.com/users/waterdh/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/waterdh/subscriptions","organizations_url":"https://api.github.com/users/waterdh/orgs","repos_url":"https://api.github.com/users/waterdh/repos","events_url":"https://api.github.com/users/waterdh/events{/privacy}","received_events_url":"https://api.github.com/users/waterdh/received_events","type":"User","site_admin":false},"created_at":"2013-05-08T01:02:20Z","updated_at":"2013-05-08T01:02:20Z","author_association":"NONE","body":"I met the same problem, had to change the search_type\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17608946","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17608946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17608946,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NjA4OTQ2","user":{"login":"alambert","id":69652,"node_id":"MDQ6VXNlcjY5NjUy","avatar_url":"https://avatars2.githubusercontent.com/u/69652?v=4","gravatar_id":"","url":"https://api.github.com/users/alambert","html_url":"https://github.com/alambert","followers_url":"https://api.github.com/users/alambert/followers","following_url":"https://api.github.com/users/alambert/following{/other_user}","gists_url":"https://api.github.com/users/alambert/gists{/gist_id}","starred_url":"https://api.github.com/users/alambert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alambert/subscriptions","organizations_url":"https://api.github.com/users/alambert/orgs","repos_url":"https://api.github.com/users/alambert/repos","events_url":"https://api.github.com/users/alambert/events{/privacy}","received_events_url":"https://api.github.com/users/alambert/received_events","type":"User","site_admin":false},"created_at":"2013-05-08T14:21:19Z","updated_at":"2013-05-08T14:21:19Z","author_association":"CONTRIBUTOR","body":"I ran into this again; on both instances, it was after an 0.20.6->0.90.0 migration. Restarting ES globally didn't help.\n\nI tried a global optimize down to one segment, though, and after that the query started working again:\n\ncurl -XPOST -v 'http://es-host:9200/_optimize?wait_for_merge=true&max_num_segments=1'\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17616383","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17616383","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17616383,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NjE2Mzgz","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-05-08T16:13:30Z","updated_at":"2013-05-08T16:13:30Z","author_association":"CONTRIBUTOR","body":"cool, thanks for the update this give me more confidence that this (#3012) is the actual cause\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17841687","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17841687","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17841687,"node_id":"MDEyOklzc3VlQ29tbWVudDE3ODQxNjg3","user":{"login":"mfussenegger","id":38700,"node_id":"MDQ6VXNlcjM4NzAw","avatar_url":"https://avatars0.githubusercontent.com/u/38700?v=4","gravatar_id":"","url":"https://api.github.com/users/mfussenegger","html_url":"https://github.com/mfussenegger","followers_url":"https://api.github.com/users/mfussenegger/followers","following_url":"https://api.github.com/users/mfussenegger/following{/other_user}","gists_url":"https://api.github.com/users/mfussenegger/gists{/gist_id}","starred_url":"https://api.github.com/users/mfussenegger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mfussenegger/subscriptions","organizations_url":"https://api.github.com/users/mfussenegger/orgs","repos_url":"https://api.github.com/users/mfussenegger/repos","events_url":"https://api.github.com/users/mfussenegger/events{/privacy}","received_events_url":"https://api.github.com/users/mfussenegger/received_events","type":"User","site_admin":false},"created_at":"2013-05-13T21:23:22Z","updated_at":"2013-05-13T21:23:22Z","author_association":"CONTRIBUTOR","body":"After calling _optimize?wait_for_merge=true&max_num_segments=1 the DFS query also works again for me.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/17860193","html_url":"https://github.com/elastic/elasticsearch/issues/2932#issuecomment-17860193","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2932","id":17860193,"node_id":"MDEyOklzc3VlQ29tbWVudDE3ODYwMTkz","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2013-05-14T07:10:01Z","updated_at":"2013-05-14T07:10:01Z","author_association":"CONTRIBUTOR","body":"@mfussenegger yeah that is expected with the fix I added, thanks for reporting back\n","performed_via_github_app":null}]