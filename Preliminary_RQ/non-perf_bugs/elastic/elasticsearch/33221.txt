{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33221","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33221/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33221/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33221/events","html_url":"https://github.com/elastic/elasticsearch/issues/33221","id":354952493,"node_id":"MDU6SXNzdWUzNTQ5NTI0OTM=","number":33221,"title":"[HighLevelRest] UpdateRequest with Script works incorrectly","user":{"login":"casper1149","id":4508785,"node_id":"MDQ6VXNlcjQ1MDg3ODU=","avatar_url":"https://avatars3.githubusercontent.com/u/4508785?v=4","gravatar_id":"","url":"https://api.github.com/users/casper1149","html_url":"https://github.com/casper1149","followers_url":"https://api.github.com/users/casper1149/followers","following_url":"https://api.github.com/users/casper1149/following{/other_user}","gists_url":"https://api.github.com/users/casper1149/gists{/gist_id}","starred_url":"https://api.github.com/users/casper1149/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casper1149/subscriptions","organizations_url":"https://api.github.com/users/casper1149/orgs","repos_url":"https://api.github.com/users/casper1149/repos","events_url":"https://api.github.com/users/casper1149/events{/privacy}","received_events_url":"https://api.github.com/users/casper1149/received_events","type":"User","site_admin":false},"labels":[{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-08-29T00:36:45Z","updated_at":"2018-08-30T22:00:17Z","closed_at":"2018-08-30T22:00:17Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\r\n\r\nElasticsearch version: 6.4.0\r\n\r\nDocumentation: https://www.elastic.co/guide/en/elasticsearch/client/java-rest/6.4/java-rest-high-document-update.html#java-rest-high-document-update\r\n\r\nJVM version: 1.8.0\r\n\r\nOS version: MacOSX 17.6.0 Darwin Kernel\r\n\r\nI have an index with next mapping\r\n```\r\n{\r\n  \"_doc\": {\r\n    \"properties\": {\r\n      \"steps\": {\r\n        \"type\": \"nested\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI indexed a simple document\r\n```\r\nPUT myindex/_doc/1\r\n{\r\n  \"steps\": []\r\n}\r\n```\r\n\r\nIn order to update the \"steps\" array I created next query\r\n```\r\nPOST myindex/_doc/1/_update\r\n{\r\n  \"script\": {\r\n    \"source\": \"ctx._source.steps.add(params.step)\",\r\n    \"lang\": \"painless\",\r\n    \"params\": {\r\n      \"step\": {\r\n        \"field1\": {\r\n          \"field2\": \"value\",\r\n          \"field3\": \"value\"\r\n        },\r\n        \"field4\": \"value\",\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAnd it works just fine, however when I try to do the same using the Java High Level Rest Client, something goes wrong, here is my code\r\n```\r\nJsonNode jsonNode = objectMapper.convertValue(step, JsonNode.class);\r\nUpdateRequest updateRequest = new UpdateRequest()\r\n    .index(\"myindex\")\r\n    .type(\"_doc\")\r\n    .id(\"1\")\r\n    .setRefreshPolicy(WriteRequest.RefreshPolicy.IMMEDIATE)\r\n    .script(new Script(ScriptType.INLINE, \"painless\",\r\n        \"ctx._source.steps.add(params.step)\", singletonMap(\"step\", jsonNode)));\r\nclient.update(updateRequest, RequestOptions.DEFAULT);\r\n```\r\n\r\nthe \"jsonNode\" looks like this when I print it\r\n```\r\n{\r\n\"field4\":\"value\",\r\n\"field1\":{\"field2\":\"value\",\"field3\":\"value\"}\r\n}\r\n```\r\n\r\nthe \"singletonMap\" also looks correct\r\n\r\nAs a result in Kibana I can see next result\r\n```\r\n          \"steps\": [\r\n            [\r\n              [],\r\n              [\r\n                [],\r\n                []\r\n              ]\r\n            ]\r\n           ]\r\n```","closed_by":{"login":"casper1149","id":4508785,"node_id":"MDQ6VXNlcjQ1MDg3ODU=","avatar_url":"https://avatars3.githubusercontent.com/u/4508785?v=4","gravatar_id":"","url":"https://api.github.com/users/casper1149","html_url":"https://github.com/casper1149","followers_url":"https://api.github.com/users/casper1149/followers","following_url":"https://api.github.com/users/casper1149/following{/other_user}","gists_url":"https://api.github.com/users/casper1149/gists{/gist_id}","starred_url":"https://api.github.com/users/casper1149/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casper1149/subscriptions","organizations_url":"https://api.github.com/users/casper1149/orgs","repos_url":"https://api.github.com/users/casper1149/repos","events_url":"https://api.github.com/users/casper1149/events{/privacy}","received_events_url":"https://api.github.com/users/casper1149/received_events","type":"User","site_admin":false},"performed_via_github_app":null}