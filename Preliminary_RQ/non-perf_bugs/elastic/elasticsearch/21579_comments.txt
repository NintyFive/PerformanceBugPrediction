[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260882566","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-260882566","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":260882566,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDg4MjU2Ng==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-11-16T08:20:21Z","updated_at":"2016-11-16T08:20:21Z","author_association":"CONTRIBUTOR","body":"can you tell what version of ES are you using and can you paste the stacktrace from the logs please\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261031415","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-261031415","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":261031415,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTAzMTQxNQ==","user":{"login":"DoychinDoychev","id":23104056,"node_id":"MDQ6VXNlcjIzMTA0MDU2","avatar_url":"https://avatars1.githubusercontent.com/u/23104056?v=4","gravatar_id":"","url":"https://api.github.com/users/DoychinDoychev","html_url":"https://github.com/DoychinDoychev","followers_url":"https://api.github.com/users/DoychinDoychev/followers","following_url":"https://api.github.com/users/DoychinDoychev/following{/other_user}","gists_url":"https://api.github.com/users/DoychinDoychev/gists{/gist_id}","starred_url":"https://api.github.com/users/DoychinDoychev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DoychinDoychev/subscriptions","organizations_url":"https://api.github.com/users/DoychinDoychev/orgs","repos_url":"https://api.github.com/users/DoychinDoychev/repos","events_url":"https://api.github.com/users/DoychinDoychev/events{/privacy}","received_events_url":"https://api.github.com/users/DoychinDoychev/received_events","type":"User","site_admin":false},"created_at":"2016-11-16T18:34:21Z","updated_at":"2016-11-16T18:35:39Z","author_association":"NONE","body":"Thanks for the reply,\n\nI actually missed the block causing the issue in the `NOT WORKING` example\n\n```\n\"connected_users\": {\n          \"bucket_script\": {\n            \"buckets_path\": {\n              \"follow\": \"follow>follow-values\",\n              \"dislike\": \"dislike>dislike-values\"\n            },\n            \"script\": \"follow - dislike\",\n            \"gap_policy\": \"insert_zeros\"\n          }\n        }\n```\n\nthis is the update that i made.\n\nES traceback:\n\n```\n[2016-11-16 18:28:54,950][WARN ][rest.suppressed          ] path: /activity/stream/_search, params: {index=activity, type=stream}\nFailed to execute phase [fetch], [reduce]\n        at org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.onFailure(SearchQueryThenFetchAsyncAction.java:146)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.search.aggregations.bucket.range.date.InternalDateRange$Factory.createBucket(InternalDateRange.java:141)\n        at org.elasticsearch.search.aggregations.bucket.range.date.InternalDateRange$Factory.createBucket(InternalDateRange.java:115)\n        at org.elasticsearch.search.aggregations.bucket.range.InternalRange.createBucket(InternalRange.java:286)\n        at org.elasticsearch.search.aggregations.bucket.range.InternalRange.createBucket(InternalRange.java:43)\n        at org.elasticsearch.search.aggregations.pipeline.bucketscript.BucketScriptPipelineAggregator.reduce(BucketScriptPipelineAggregator.java:141)\n        at org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:155)\n        at org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:170)\n        at org.elasticsearch.search.controller.SearchPhaseController.merge(SearchPhaseController.java:411)\n        at org.elasticsearch.action.search.SearchQueryThenFetchAsyncAction$2.doRun(SearchQueryThenFetchAsyncAction.java:132)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n        ... 3 more\n```\n\nES version: `2.4.0`\n\n`s1monw` let me know if i can assist with anything else ;)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261067435","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-261067435","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":261067435,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTA2NzQzNQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2016-11-16T20:49:53Z","updated_at":"2016-11-16T20:49:53Z","author_association":"CONTRIBUTOR","body":"@colings86 can you take a look at this please\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261201101","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-261201101","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":261201101,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTIwMTEwMQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2016-11-17T09:45:38Z","updated_at":"2016-11-17T09:45:38Z","author_association":"MEMBER","body":"@s1monw sure\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261246477","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-261246477","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":261246477,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTI0NjQ3Nw==","user":{"login":"DoychinDoychev","id":23104056,"node_id":"MDQ6VXNlcjIzMTA0MDU2","avatar_url":"https://avatars1.githubusercontent.com/u/23104056?v=4","gravatar_id":"","url":"https://api.github.com/users/DoychinDoychev","html_url":"https://github.com/DoychinDoychev","followers_url":"https://api.github.com/users/DoychinDoychev/followers","following_url":"https://api.github.com/users/DoychinDoychev/following{/other_user}","gists_url":"https://api.github.com/users/DoychinDoychev/gists{/gist_id}","starred_url":"https://api.github.com/users/DoychinDoychev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DoychinDoychev/subscriptions","organizations_url":"https://api.github.com/users/DoychinDoychev/orgs","repos_url":"https://api.github.com/users/DoychinDoychev/repos","events_url":"https://api.github.com/users/DoychinDoychev/events{/privacy}","received_events_url":"https://api.github.com/users/DoychinDoychev/received_events","type":"User","site_admin":false},"created_at":"2016-11-17T13:30:09Z","updated_at":"2016-11-17T13:30:09Z","author_association":"NONE","body":"thanks guys! :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261520707","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-261520707","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":261520707,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTUyMDcwNw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2016-11-18T12:27:58Z","updated_at":"2016-11-18T12:28:32Z","author_association":"MEMBER","body":"I have reproduced this on 2.4.0 with the following script:\n\n``` js\nDELETE test\n\nPUT test\n{\n    \"settings\": {\n        \"number_of_shards\": 1,\n        \"number_of_replicas\": 0\n    },\n    \"mappings\": {\n      \"doc\": {\n        \"properties\": {\n          \"d\": {\n            \"type\": \"date\"\n          }\n        }\n      }\n    }\n}\n\nPOST test/doc/1\n{\n    \"a\": 1,\n    \"b\": 1,\n    \"c\": 2,\n    \"d\": \"2016-11-18\"\n}\n\nPOST test/doc/2\n{\n    \"a\": 2,\n    \"b\": 1,\n    \"c\": 2,\n    \"d\": \"2016-11-17\"\n}\n\nPOST test/doc/3\n{\n    \"a\": 3,\n    \"b\": 1,\n    \"c\": 2,\n    \"d\": \"2016-11-16\"\n}\n\nPOST test/doc/4\n{\n    \"a\": 4,\n    \"b\": 1,\n    \"c\": 2,\n    \"d\": \"2016-11-15\"\n}\n\nGET test/_search\n{\n    \"size\": 0,\n    \"aggs\": {\n      \"range\": {\n        \"date_range\": {\n          \"field\": \"d\",\n          \"ranges\": [\n            {\n              \"to\": \"now-1d/d\"\n            },\n            {\n              \"from\": \"now-1d/d\"\n            }\n          ]\n        },\n        \"aggs\": {\n          \"b\": {\n            \"avg\": {\n              \"field\": \"b\"\n            }\n          },\n          \"c\": {\n            \"avg\": {\n              \"field\": \"c\"\n            }\n          },\n          \"diff\": {\n            \"bucket_script\": {\n              \"buckets_path\": {\n                \"b\": \"b\",\n                \"c\": \"c\"\n              },\n              \"script\": {\n                \"inline\": \"c - b\"\n              }\n            }\n          }\n        }\n      }\n    }\n}\n```\n\nThe bug is in this snippet of `InternalDateRange`:\n\n``` java\n@Override\n        public Bucket createBucket(InternalAggregations aggregations, Bucket prototype) {\n            return new Bucket(prototype.getKey(), ((Number) prototype.getFrom()).doubleValue(), ((Number) prototype.getTo()).doubleValue(),\n                    prototype.getDocCount(), aggregations, prototype.getKeyed(), prototype.getFormatter());\n        }\n```\n\nThe problem is that the `createBucket` method does not account for the case where either `from` or `to` are `null` in the prototype and so will throw a `NullPointerException` in this case.\n\nIn 5.0.0 onwards this is not an issue (and so not reproducible) as the range aggregation stores an explicit `Double` rather than an `Object` that need to be cast to a `Number` to get its `double` value\n\nI'll work on a fix for the 2.4 branch\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261712987","html_url":"https://github.com/elastic/elasticsearch/issues/21579#issuecomment-261712987","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21579","id":261712987,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTcxMjk4Nw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-11-19T13:09:06Z","updated_at":"2016-11-19T13:09:06Z","author_association":"CONTRIBUTOR","body":"Closed by https://github.com/elastic/elasticsearch/pull/21659\n","performed_via_github_app":null}]