{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52333","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52333/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52333/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52333/events","html_url":"https://github.com/elastic/elasticsearch/issues/52333","id":564843465,"node_id":"MDU6SXNzdWU1NjQ4NDM0NjU=","number":52333,"title":"Missing text from highlighted searched response when field contains exclamation mark","user":{"login":"andreiniculescu86","id":49227294,"node_id":"MDQ6VXNlcjQ5MjI3Mjk0","avatar_url":"https://avatars1.githubusercontent.com/u/49227294?v=4","gravatar_id":"","url":"https://api.github.com/users/andreiniculescu86","html_url":"https://github.com/andreiniculescu86","followers_url":"https://api.github.com/users/andreiniculescu86/followers","following_url":"https://api.github.com/users/andreiniculescu86/following{/other_user}","gists_url":"https://api.github.com/users/andreiniculescu86/gists{/gist_id}","starred_url":"https://api.github.com/users/andreiniculescu86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andreiniculescu86/subscriptions","organizations_url":"https://api.github.com/users/andreiniculescu86/orgs","repos_url":"https://api.github.com/users/andreiniculescu86/repos","events_url":"https://api.github.com/users/andreiniculescu86/events{/privacy}","received_events_url":"https://api.github.com/users/andreiniculescu86/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-02-13T17:35:45Z","updated_at":"2020-02-13T17:56:45Z","closed_at":"2020-02-13T17:56:45Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n**Bug report** \r\n\r\nWhen highlighting a searched text the resulted highlighted text does not contain all the text from the queried field.\r\n\r\n(I apologise if this is as expected or I am missing something)\r\n\r\n**Elasticsearch version**: 7.1.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** : 1.8.0_221\r\n\r\n**OS version**: Linux XPS 5.3.0-28-generic #30~18.04.1-Ubuntu SMP Fri Jan 17 06:14:09 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen searching for a text and requesting results query highlight, if the matched document field contains exclamation mark, then the returned highlighted text does not contain part of the text that contains the exclamation mark\r\n\r\ndocument: `{ \"name\" : \"Yahoo! Inc [Please refer to Altaba Inc and Verizon Communications Inc]\"}`\r\nsearching with highlight for \"inc\" wildcard\r\n\r\n_expected:_\r\nhighlighed text should be:\r\n`\"Yahoo! <em>Inc</em> [Please refer to Altaba <em>Inc</em> and Verizon Communications <em>Inc</em>]\"`\r\n\r\n_actual:_\r\n\"Yahoo!\" is missing from the response. Got:\r\n`\"<em>Inc</em> [Please refer to Altaba <em>Inc</em> and Verizon Communications <em>Inc</em>]\"`\r\n\r\nI think this was something to do with the ! mark. If I remove that then everything is OK.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Add document to a new index\r\n `  \r\nPOST test/_doc/\r\n{\r\n  \"name\" : \"Yahoo! Inc [Please refer to Altaba Inc and Verizon Communications Inc]\"\r\n} `\r\n\r\n 2. no other settings / mapping\r\n 3. Run the query\r\n`GET test/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"wildcard\": {\r\n            \"name\": {\r\n              \"wildcard\": \"inc*\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"fields\": {\r\n         \"name\" : {}\r\n    }\r\n  }\r\n}`\r\n\r\n4. Got following results:\r\n`\"hits\" : [\r\n      {\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"511tP3ABoqekxkoUshVf\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"name\" : \"Yahoo! Inc [Please refer to Altaba Inc and Verizon Communications Inc]\"\r\n        },\r\n        \"highlight\" : {\r\n          \"name\" : [\r\n            \"<em>Inc</em> [Please refer to Altaba <em>Inc</em> and Verizon Communications <em>Inc</em>]\"\r\n          ]\r\n        }\r\n      }\r\n    ]`\r\n\r\n5. expecting highlight:\r\n`\"Yahoo! <em>Inc</em> [Please refer to Altaba <em>Inc</em> and Verizon Communications <em>Inc</em>]\"`\r\n\r\nI managed to make it run as expected only by setting the `\"number_of_fragments\" : 0`\r\nWhich was enough for my use case.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"williamrandolph","id":3253644,"node_id":"MDQ6VXNlcjMyNTM2NDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3253644?v=4","gravatar_id":"","url":"https://api.github.com/users/williamrandolph","html_url":"https://github.com/williamrandolph","followers_url":"https://api.github.com/users/williamrandolph/followers","following_url":"https://api.github.com/users/williamrandolph/following{/other_user}","gists_url":"https://api.github.com/users/williamrandolph/gists{/gist_id}","starred_url":"https://api.github.com/users/williamrandolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/williamrandolph/subscriptions","organizations_url":"https://api.github.com/users/williamrandolph/orgs","repos_url":"https://api.github.com/users/williamrandolph/repos","events_url":"https://api.github.com/users/williamrandolph/events{/privacy}","received_events_url":"https://api.github.com/users/williamrandolph/received_events","type":"User","site_admin":false},"performed_via_github_app":null}