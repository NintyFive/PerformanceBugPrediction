{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16711","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16711/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16711/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16711/events","html_url":"https://github.com/elastic/elasticsearch/issues/16711","id":134461019,"node_id":"MDU6SXNzdWUxMzQ0NjEwMTk=","number":16711,"title":"Percolator not supporting nested aggregations","user":{"login":"tarass","id":842980,"node_id":"MDQ6VXNlcjg0Mjk4MA==","avatar_url":"https://avatars0.githubusercontent.com/u/842980?v=4","gravatar_id":"","url":"https://api.github.com/users/tarass","html_url":"https://github.com/tarass","followers_url":"https://api.github.com/users/tarass/followers","following_url":"https://api.github.com/users/tarass/following{/other_user}","gists_url":"https://api.github.com/users/tarass/gists{/gist_id}","starred_url":"https://api.github.com/users/tarass/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tarass/subscriptions","organizations_url":"https://api.github.com/users/tarass/orgs","repos_url":"https://api.github.com/users/tarass/repos","events_url":"https://api.github.com/users/tarass/events{/privacy}","received_events_url":"https://api.github.com/users/tarass/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-02-18T02:11:18Z","updated_at":"2016-03-24T15:23:15Z","closed_at":"2016-03-24T15:23:15Z","author_association":"NONE","active_lock_reason":null,"body":"I wanted to aggregate my percolation results with a nested aggregation. However, it appears that code path isn't implemented. Martijn (@martijnvg) you appeared to know the issue.\n\nPercolateContext.java\n\n```\n@Override\npublic MapperService.SmartNameObjectMapper smartNameObjectMapper(String name) {\nthrow new UnsupportedOperationException();\n}\n```\n\nIs there support for this coming soon? It would be nice utility that would help avoid duplicating percolators.\n\nHere is the script to reproduce the problem\n\n```\nPUT /classify\n{\n  \"mappings\":{\n    \".percolator\":{\n      \"properties\": {\n        \"query\" : {\n          \"type\" : \"object\",\n          \"enabled\" : false\n        },\n        \"isa\":{\n          \"type\": \"nested\",\n          \"properties\":{\n            \"feature\":{\n              \"type\": \"string\"\n            },\n            \"id\": {\n              \"type\": \"string\"\n            }\n          }\n        }\n      }\n    },\n    \"thing\":{\n      \"properties\":{\n        \"name\":{\n          \"type\":\"string\"\n        }\n      }\n    }\n  }\n}\n\nPOST classify/.percolator/1234\n{\n  \"query\": {\n    \"match\": {\n      \"name\": \"arts\"\n    }\n  },\n  \"type\": \"thing\",\n  \"isa\":[{\n    \"feature\": \"Category\",\n    \"id\": \"theatre\"\n  },\n  {\n    \"feature\": \"Ambience\",\n    \"id\": \"classy\"\n  }\n  ]\n}\n\nGET /classify/thing/_percolate\n{\n  \"doc\": {\n    \"name\": \"Academy of Arts\"\n  },\n  \"aggs\":{\n    \"isa\":{\n      \"nested\": {\n        \"path\": \"isa\"\n      },\n      \"aggs\": {\n        \"features\": {\n          \"terms\": {\n            \"field\": \"isa.feature\"\n          },\n          \"aggs\": {\n            \"kinds\": {\n              \"terms\": {\n                \"field\": \"isa.id\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}