{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9333","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9333/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9333/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9333/events","html_url":"https://github.com/elastic/elasticsearch/issues/9333","id":54578070,"node_id":"MDU6SXNzdWU1NDU3ODA3MA==","number":9333,"title":"Date histogram - Getting different results for buckets every-time the query is run","user":{"login":"amruthkesav","id":429041,"node_id":"MDQ6VXNlcjQyOTA0MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/429041?v=4","gravatar_id":"","url":"https://api.github.com/users/amruthkesav","html_url":"https://github.com/amruthkesav","followers_url":"https://api.github.com/users/amruthkesav/followers","following_url":"https://api.github.com/users/amruthkesav/following{/other_user}","gists_url":"https://api.github.com/users/amruthkesav/gists{/gist_id}","starred_url":"https://api.github.com/users/amruthkesav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/amruthkesav/subscriptions","organizations_url":"https://api.github.com/users/amruthkesav/orgs","repos_url":"https://api.github.com/users/amruthkesav/repos","events_url":"https://api.github.com/users/amruthkesav/events{/privacy}","received_events_url":"https://api.github.com/users/amruthkesav/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2015-01-16T14:00:16Z","updated_at":"2015-09-09T08:57:09Z","closed_at":"2015-01-16T15:48:58Z","author_association":"NONE","active_lock_reason":null,"body":"Hi I am using date histogram query in this fashion\n\n```\n{\n    \"size\": 0,\n    \"timeout\": 120000,\n    \"aggs\": {\n        \"filter_wrapper\": {\n            \"aggs\": {\n                \"timestamp\": {\n                    \"date_histogram\": {\n                        \"field\": \"timestamp\",\n                        \"interval\": \"60.0m\",\n                        \"time_zone\": \"+05:30\"\n                    },\n                    \"aggs\": {\n                        \"Net_Units\": {\n                            \"sum\": {\n                                \"field\": \"net_units\"\n                            }\n                        }\n                    }\n                }\n            },\n            \"filter\": {\n                \"and\": [\n                    {\n                        \"range\": {\n                            \"timestamp\": {\n                                \"gte\": 1421260200000,\n                                \"lt\": 1421346599000\n                            }\n                        }\n                    },\n                    {\n                        \"and\": [\n                            {},\n                            {\n                                \"terms\": {\n                                    \"super_category\": [\n                                        \"HomeDecor\",\n                                        \"HomeFurnishing\",\n                                        \"HomeImprovementTool\",\n                                        \"HouseHold\"\n                                    ]\n                                }\n                            }\n                        ]\n                    }\n                ]\n            }\n        }\n    }\n}\n```\n\nOne of the buckets is returning different result on every run\n\nOn the 1st run it gave this - \n\n```\n{\n    key_as_string: 2015-01-15T11:30:00.000Z\n    key: 1421321400000\n    doc_count: 1505\n    Net_Units: {\n        value: 1418\n    }\n}\n```\n\nIf I run the query again and again I get this occasionally\n\n```\n{\n    key_as_string: 2015-01-15T11:30:00.000Z\n    key: 1421321400000\n    doc_count: 1423\n    Net_Units: {\n        value: 1375\n    }\n}\n```\n\nLooks like the number of documents examined for the aggregation itself is mismatching.\n\nThis is the index status when the query was fired\n\n```\n{\n    index: {\n        primary_size_in_bytes: 29353091854\n        size_in_bytes: 59508084118\n    }\n    translog: {\n        operations: 21542\n    }\n    docs: {\n        num_docs: 52530831\n        max_doc: 60617583\n        deleted_docs: 8086752\n    }\n    merges: {\n        current: 0\n        current_docs: 0\n        current_size_in_bytes: 0\n        total: 1163319\n        total_time_in_millis: 85319972\n        total_docs: 782345554\n        total_size_in_bytes: 605584878237\n    }\n    refresh: {\n        total: 6501097\n        total_time_in_millis: 173868772\n    }\n    flush: {\n        total: 17782\n        total_time_in_millis: 2120436\n    }\n    shards: {\n        0: [\n            {\n                routing: {\n                    state: STARTED\n                    primary: true\n                    node: o9roxqp5Qs6ZITvepJCDTw\n                    relocating_node: null\n                    shard: 0\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 5599632911\n                }\n                translog: {\n                    id: 1409740133203\n                    operations: 1326\n                }\n                docs: {\n                    num_docs: 10507345\n                    max_doc: 11622029\n                    deleted_docs: 1114684\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 234922\n                    total_time_in_millis: 17348559\n                    total_docs: 148914491\n                    total_size_in_bytes: 117112040612\n                }\n                refresh: {\n                    total: 3051652\n                    total_time_in_millis: 76429882\n                }\n                flush: {\n                    total: 7699\n                    total_time_in_millis: 828736\n                }\n            }\n            {\n                routing: {\n                    state: STARTED\n                    primary: false\n                    node: 4fBi7WiBSYei42iGyNVLyg\n                    relocating_node: null\n                    shard: 0\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 5707077556\n                }\n                translog: {\n                    id: 1409740133198\n                    operations: 4449\n                }\n                docs: {\n                    num_docs: 10505767\n                    max_doc: 11775261\n                    deleted_docs: 1269494\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 112612\n                    total_time_in_millis: 8886822\n                    total_docs: 94811362\n                    total_size_in_bytes: 71078185520\n                }\n                refresh: {\n                    total: 456090\n                    total_time_in_millis: 10018330\n                }\n                flush: {\n                    total: 1356\n                    total_time_in_millis: 141418\n                }\n            }\n        ]\n        1: [\n            {\n                routing: {\n                    state: STARTED\n                    primary: false\n                    node: CH7tOBUCSzmIyiO_bQcq9Q\n                    relocating_node: null\n                    shard: 1\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 6165560358\n                }\n                translog: {\n                    id: 1409740133254\n                    operations: 4990\n                }\n                docs: {\n                    num_docs: 10508000\n                    max_doc: 12657246\n                    deleted_docs: 2149246\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 6771\n                    total_time_in_millis: 629412\n                    total_docs: 5655838\n                    total_size_in_bytes: 4363216808\n                }\n                refresh: {\n                    total: 28497\n                    total_time_in_millis: 680439\n                }\n                flush: {\n                    total: 58\n                    total_time_in_millis: 5569\n                }\n            }\n            {\n                routing: {\n                    state: STARTED\n                    primary: true\n                    node: NtCQtOj6TbCZhOtRXc-TsQ\n                    relocating_node: null\n                    shard: 1\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 6165600927\n                }\n                translog: {\n                    id: 1409740133255\n                    operations: 526\n                }\n                docs: {\n                    num_docs: 10508000\n                    max_doc: 12656056\n                    deleted_docs: 2148056\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 43654\n                    total_time_in_millis: 3960933\n                    total_docs: 37337683\n                    total_size_in_bytes: 28101440785\n                }\n                refresh: {\n                    total: 165483\n                    total_time_in_millis: 4504477\n                }\n                flush: {\n                    total: 601\n                    total_time_in_millis: 80196\n                }\n            }\n        ]\n        2: [\n            {\n                routing: {\n                    state: STARTED\n                    primary: false\n                    node: 8feFE_czSOSG6Volvrg17A\n                    relocating_node: null\n                    shard: 2\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 6520241401\n                }\n                translog: {\n                    id: 1409740133014\n                    operations: 101\n                }\n                docs: {\n                    num_docs: 10505438\n                    max_doc: 13473487\n                    deleted_docs: 2968049\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 58741\n                    total_time_in_millis: 4736398\n                    total_docs: 43401787\n                    total_size_in_bytes: 33349547432\n                }\n                refresh: {\n                    total: 466161\n                    total_time_in_millis: 12714445\n                }\n                flush: {\n                    total: 1356\n                    total_time_in_millis: 174188\n                }\n            }\n            {\n                routing: {\n                    state: STARTED\n                    primary: true\n                    node: wiGuvgYFTQW_yN8aWqTMfw\n                    relocating_node: null\n                    shard: 2\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 5613227919\n                }\n                translog: {\n                    id: 1409740133021\n                    operations: 4565\n                }\n                docs: {\n                    num_docs: 10506496\n                    max_doc: 11643481\n                    deleted_docs: 1136985\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 155413\n                    total_time_in_millis: 10855943\n                    total_docs: 98868285\n                    total_size_in_bytes: 76311439708\n                }\n                refresh: {\n                    total: 481274\n                    total_time_in_millis: 15566507\n                }\n                flush: {\n                    total: 1363\n                    total_time_in_millis: 185328\n                }\n            }\n        ]\n        3: [\n            {\n                routing: {\n                    state: STARTED\n                    primary: false\n                    node: 92-ZpTAeQpOSp5orwn2AQg\n                    relocating_node: null\n                    shard: 3\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 6109367546\n                }\n                translog: {\n                    id: 1409740133323\n                    operations: 1301\n                }\n                docs: {\n                    num_docs: 10502892\n                    max_doc: 12679433\n                    deleted_docs: 2176541\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 133019\n                    total_time_in_millis: 9724210\n                    total_docs: 83235787\n                    total_size_in_bytes: 65998616212\n                }\n                refresh: {\n                    total: 470023\n                    total_time_in_millis: 13486243\n                }\n                flush: {\n                    total: 1360\n                    total_time_in_millis: 198709\n                }\n            }\n            {\n                routing: {\n                    state: STARTED\n                    primary: true\n                    node: GzGVrwdURXSGXAIhRvc7SA\n                    relocating_node: null\n                    shard: 3\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 6319438857\n                }\n                translog: {\n                    id: 1409740133326\n                    operations: 446\n                }\n                docs: {\n                    num_docs: 10502892\n                    max_doc: 13035768\n                    deleted_docs: 2532876\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 154860\n                    total_time_in_millis: 9967135\n                    total_docs: 80535899\n                    total_size_in_bytes: 66278258139\n                }\n                refresh: {\n                    total: 480530\n                    total_time_in_millis: 15116009\n                }\n                flush: {\n                    total: 1363\n                    total_time_in_millis: 187720\n                }\n            }\n        ]\n        4: [\n            {\n                routing: {\n                    state: STARTED\n                    primary: false\n                    node: lDSfV78VR2SwKAYuAmVtaQ\n                    relocating_node: null\n                    shard: 4\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 5652745403\n                }\n                translog: {\n                    id: 1409740133193\n                    operations: 1524\n                }\n                docs: {\n                    num_docs: 10506098\n                    max_doc: 11643535\n                    deleted_docs: 1137437\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 109249\n                    total_time_in_millis: 8770793\n                    total_docs: 91359115\n                    total_size_in_bytes: 67361165648\n                }\n                refresh: {\n                    total: 425467\n                    total_time_in_millis: 9998433\n                }\n                flush: {\n                    total: 1275\n                    total_time_in_millis: 150416\n                }\n            }\n            {\n                routing: {\n                    state: STARTED\n                    primary: true\n                    node: X5xzx3zlTlOe8GZ-7mrkqg\n                    relocating_node: null\n                    shard: 4\n                    index: f_scp_oms\n                }\n                state: STARTED\n                index: {\n                    size_in_bytes: 5655191240\n                }\n                translog: {\n                    id: 1409740133195\n                    operations: 2314\n                }\n                docs: {\n                    num_docs: 10506098\n                    max_doc: 11660249\n                    deleted_docs: 1154151\n                }\n                merges: {\n                    current: 0\n                    current_docs: 0\n                    current_size_in_bytes: 0\n                    total: 154078\n                    total_time_in_millis: 10439767\n                    total_docs: 98225307\n                    total_size_in_bytes: 75630967373\n                }\n                refresh: {\n                    total: 475920\n                    total_time_in_millis: 15354007\n                }\n                flush: {\n                    total: 1351\n                    total_time_in_millis: 168156\n                }\n            }\n        ]\n    }\n}\n```\n\nI am using transport client to connect to Elastic search with cluster property set.\nIs this a known issue?\nLet me know if you need additional info about the problem.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}