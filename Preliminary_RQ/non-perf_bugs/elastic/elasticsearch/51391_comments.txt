[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578055905","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578055905","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578055905,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODA1NTkwNQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-01-24T09:30:55Z","updated_at":"2020-01-24T09:30:55Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Analysis)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578055912","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578055912","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578055912,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODA1NTkxMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-01-24T09:30:56Z","updated_at":"2020-01-24T09:30:56Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security (:Security/Authorization)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578061975","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578061975","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578061975,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODA2MTk3NQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-01-24T09:50:19Z","updated_at":"2020-01-24T09:50:19Z","author_association":"CONTRIBUTOR","body":"The other possibility would be that we introduce an ML analyze endpoint that:\r\n\r\n* Only works on supplied strings, never a field in a named index\r\n* Defaults to ML's default categorization analyzer if no analyzer is specified\r\n* Is secured by the `manage_ml` cluster privilege\r\n\r\nFor example, `GET /_ml/anomaly_detectors/_categorization/analyze` or something like that.  Then anyone who has permission to create an ML job will be able to use it.\r\n\r\nIf there's a wider need for a lower privilege analyze endpoint that only works on strings, not index fields, then the ML UI could certainly use that instead of a new ML endpoint.  (The ML UI can find out what the default categorization analyzer from the ML info endpoint.)  But if ML would be the only user of the lower privilege analyze endpoint then there are some benefits to having a slightly more specialised ML endpoint.\r\n\r\nWe probably shouldn't do both though, so let us know whether there's a wider need for a lower privilege analyze endpoint.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578102879","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578102879","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578102879,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODEwMjg3OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2020-01-24T12:00:33Z","updated_at":"2020-01-24T12:00:33Z","author_association":"MEMBER","body":"Another possibility could be to authorize `cluster:admin/analyze` directly in the `manage_ml` privilege ? We already have the distinction for requests that contain an index and use `indices:admin/analyze` rather than the [cluster privilege](https://github.com/elastic/elasticsearch/blob/17581f2f6f52369b93d15fa534ce9c1fa6d0846a/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/SecurityActionMapper.java#L41) so this change wouldn't expose the API with indices to ml users. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578113266","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578113266","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578113266,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODExMzI2Ng==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-01-24T12:34:24Z","updated_at":"2020-01-24T12:34:24Z","author_association":"CONTRIBUTOR","body":"> Another possibility could be to authorize `cluster:admin/analyze` directly in the `manage_ml` privilege ?\r\n\r\nYes, true.  That would certainly be the path of least effort - just a one line in the core code and maybe a couple more in tests.  I can make that change if nobody objects or has a good reason to go with one of the other options.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578156137","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578156137","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578156137,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODE1NjEzNw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2020-01-24T14:37:22Z","updated_at":"2020-01-24T14:37:22Z","author_association":"MEMBER","body":"Ah, I didn't realize that we already did that @jimczi, thanks for pointing it out. It's a little sneaky that it happens in security rather than in core, IMO.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/578742500","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-578742500","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":578742500,"node_id":"MDEyOklzc3VlQ29tbWVudDU3ODc0MjUwMA==","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"created_at":"2020-01-27T13:19:46Z","updated_at":"2020-01-27T13:19:46Z","author_association":"CONTRIBUTOR","body":"Thank you for pitching in @droberts195 @jimczi and @jasontedor .\r\n\r\nI see that the analyze API can generate both \"index\" and \"cluster\" wide transport actions (from the authz point of view). I was not aware of the hack in the `SecurityActionMapper` which authorizes the same action in different ways, depending on the request. I agree with @jasontedor that the REST handler should instead delegate to two different transport actions, one for index-scope analyzers and the other one for general, cluster wide analyzers; in this way Security code avoids making assumptions about how ES core interprets different request formats. I think we should remediate this for version 8.\r\n\r\nEven if we were to have this separation today, I don't see any better options for an existing privilege under which we should group the analyze transport actions. That is, given the potential DoS of the analyzer (both using index or general analyzers) we don't have a non-`manage` better option.\r\n\r\nGiven this, I see two courses of actions:\r\n\r\n- Create a new API as @droberts195 suggests, under the `cluster:admin/xpack/ml/*` namespace, which internally uses the analyze transport action. I don't like adding the analyze action under the `manage_ml` privilege as @jimczi suggested because a privilege should have a consistent \"story\" about what it allows for (privileges are not a set of permitted actions, their strength is that they allow to a set of closely related actions). We have \"built-in\" roles for privileges that should go together for certain stack features/components, which segues to the other course of action:\r\n- Add the analyze action to the `kibana_system` built-in reserved role and make the ML UI component use the ES client of the `kibana` itself (instead of the client associated with the privileges of the end user).\r\n\r\nI don't have any preference among the two options, and I'm willing to help with either (but I'm probably not the best person to write the ML action that does a particular form of analyze or to adjust the ML UI component). @droberts195 @pheyos let me know if this makes sense, and if I can help with anything.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/583515628","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-583515628","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":583515628,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MzUxNTYyOA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-02-07T17:28:31Z","updated_at":"2020-02-07T17:28:31Z","author_association":"CONTRIBUTOR","body":"Thanks for the suggestions @albertzaharovits.\r\n\r\nI think we should go with:\r\n\r\n> * Add the analyze action to the `kibana_system` built-in reserved role and make the ML UI component use the ES client of the `kibana` itself (instead of the client associated with the privileges of the end user).\r\n\r\nThis is similar to what we'll be doing for all ML UI calls to Elasticsearch in 8.0 when the ML in Spaces project reaches its conclusion.  So we might as well start with this single call in 7.7.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631470127","html_url":"https://github.com/elastic/elasticsearch/issues/51391#issuecomment-631470127","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51391","id":631470127,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTQ3MDEyNw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T13:21:59Z","updated_at":"2020-05-20T13:21:59Z","author_association":"CONTRIBUTOR","body":"Although we worked around this in a way that worked for the ML UI, #56994 is a case of a user suffering from the same problem.","performed_via_github_app":null}]