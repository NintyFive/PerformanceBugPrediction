{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6380","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6380/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6380/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6380/events","html_url":"https://github.com/elastic/elasticsearch/issues/6380","id":34787144,"node_id":"MDU6SXNzdWUzNDc4NzE0NA==","number":6380,"title":"CORS: Allowed to configure allow-credentials header to work via SSL","user":{"login":"erikringsmuth","id":1128965,"node_id":"MDQ6VXNlcjExMjg5NjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1128965?v=4","gravatar_id":"","url":"https://api.github.com/users/erikringsmuth","html_url":"https://github.com/erikringsmuth","followers_url":"https://api.github.com/users/erikringsmuth/followers","following_url":"https://api.github.com/users/erikringsmuth/following{/other_user}","gists_url":"https://api.github.com/users/erikringsmuth/gists{/gist_id}","starred_url":"https://api.github.com/users/erikringsmuth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erikringsmuth/subscriptions","organizations_url":"https://api.github.com/users/erikringsmuth/orgs","repos_url":"https://api.github.com/users/erikringsmuth/repos","events_url":"https://api.github.com/users/erikringsmuth/events{/privacy}","received_events_url":"https://api.github.com/users/erikringsmuth/received_events","type":"User","site_admin":false},"labels":[{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":111540092,"node_id":"MDU6TGFiZWwxMTE1NDAwOTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.4.0.Beta1","name":"v1.4.0.Beta1","color":"dddddd","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"assignees":[{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2014-06-02T16:06:04Z","updated_at":"2016-05-06T08:46:22Z","closed_at":"2014-08-05T15:34:00Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Elasticsearch supports CORS and Basic Authentication but not together. A browser sending a cross-origin request will omit credentials unless the XHR `withCredentials` field is set to `true`. If `withCredentials = true` there are two additional checks the browser must perform on the preflight response before sending the real request.\n- Preflight response `Access-Control-Allow-Origin` must be the Origin (host), not `*`\n- Preflight response must have header `Access-Control-Allow-Credentials: true`\n\nThe W3C spec [http://www.w3.org/TR/access-control/#resource-sharing-check-0](http://www.w3.org/TR/access-control/#resource-sharing-check-0) explains the CORS withCredentials check.\n\nThese headers can be added with 2 lines of code in `org.elasticsearch.http.netty.NettyHttpChannel.java` at line 95.\n\n``` java\n// Add support for cross-origin Ajax requests (CORS)\nresp.headers().add(\"Access-Control-Allow-Origin\", transport.settings().get(\"http.cors.allow-origin\", HttpHeaders.getHeader(nettyRequest, \"Origin\", \"*\")));\nresp.headers().add(\"Access-Control-Allow-Credentials\", transport.settings().get(\"http.cors.allow-credentials\", \"true\"));\n```\n\nThis would make the `Access-Control-Allow-Origin` header fall back to the `Origin` header before falling back to `*`. It would also add the new header `Access-Control-Allow-Credentials: true`.\n## Reproduce steps\n1. Start an elasticsearch instance on `localhost:9200`\n2. Open a browser window with any domain other than `localhost:9200`. I'm using an empty Chrome tab in my example.\n3. Run this JavaScript to send a request with basic authentication\n\n``` js\nvar xhr = new XMLHttpRequest();\nxhr.open('POST', 'http://user:passwd@localhost:9200', true);\nxhr.withCredentials = true;\nxhr.setRequestHeader('Content-Type', 'application/json');\nxhr.send('{\"query\":{\"match_all\":{}}}');\n```\n\nPreflight Request\n\n```\nOPTIONS http://localhost:9200/ HTTP/1.1\nHost: localhost:9200\nConnection: keep-alive\nCache-Control: no-cache\nAuthorization: Basic YWRtaW46d2VzdA==\nAccess-Control-Request-Method: POST\nPragma: no-cache\nOrigin: https://www.google.com\nUser-Agent: Mozilla/5.0 (Windows NT 6.1; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/34.0.1847.116 Safari/537.36\nAccess-Control-Request-Headers: content-type\nAccept: */*\nAccept-Encoding: gzip,deflate,sdch\nAccept-Language: en-US,en;q=0.8,et;q=0.6\n```\n\nPreflight Response\n\n```\nHTTP/1.1 200 OK\nAccess-Control-Allow-Origin: *\nAccess-Control-Max-Age: 3\nAccess-Control-Allow-Methods: OPTIONS, HEAD, GET, POST, PUT, DELETE\nAccess-Control-Allow-Headers: X-Requested-With, Content-Type, Content-Length\nContent-Type: text/plain; charset=UTF-8\nContent-Length: 0\n```\n\nThe browser throws an error at this point saying the `Access-Control-Allow-Origin` and `Access-Control-Allow-Credentials` headers are bad.\n### Notes\n\nAfter you make the code changes the browser will start to cache preflight requests. When this happens you will only see the real request in Fiddler. To clear the cache, close the window and open a new one.\n\nThe XHR must be a [non-simple request](http://www.w3.org/TR/access-control/#simple-method). This is a rather vague spec but a POST with a content type of application/json should do it.\n\nIE skips most of these checks so don't bother testing in IE.\n\nThe example preflight request header `Authorization: Basic YWRtaW46d2VzdA==` is a bug in Chrome and shouldn't be included until the real request. There is a bug open for this here https://code.google.com/p/chromium/issues/detail?id=377541. Firefox works correctly and doesn't include the credentials on the preflight.\n","closed_by":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"performed_via_github_app":null}