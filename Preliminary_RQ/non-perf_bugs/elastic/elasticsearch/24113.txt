{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24113","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24113/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24113/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24113/events","html_url":"https://github.com/elastic/elasticsearch/issues/24113","id":221835127,"node_id":"MDU6SXNzdWUyMjE4MzUxMjc=","number":24113,"title":"Request breaker leaking on connection dropped/reset","user":{"login":"jklap","id":6716825,"node_id":"MDQ6VXNlcjY3MTY4MjU=","avatar_url":"https://avatars1.githubusercontent.com/u/6716825?v=4","gravatar_id":"","url":"https://api.github.com/users/jklap","html_url":"https://github.com/jklap","followers_url":"https://api.github.com/users/jklap/followers","following_url":"https://api.github.com/users/jklap/following{/other_user}","gists_url":"https://api.github.com/users/jklap/gists{/gist_id}","starred_url":"https://api.github.com/users/jklap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jklap/subscriptions","organizations_url":"https://api.github.com/users/jklap/orgs","repos_url":"https://api.github.com/users/jklap/repos","events_url":"https://api.github.com/users/jklap/events{/privacy}","received_events_url":"https://api.github.com/users/jklap/received_events","type":"User","site_admin":false},"labels":[{"id":166507771,"node_id":"MDU6TGFiZWwxNjY1MDc3NzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Circuit%20Breakers","name":":Core/Infra/Circuit Breakers","color":"0e8a16","default":false,"description":"Track estimates of memory consumption to prevent overload"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-04-14T15:49:47Z","updated_at":"2017-04-26T13:51:54Z","closed_at":"2017-04-26T02:44:52Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.2.2\r\n\r\n**Plugins installed**: [search-guard-5]\r\n\r\n**JVM version**: OpenJDK 1.8.0_121\r\n\r\n**OS version**: Red Hat Enterprise Linux Server release 7.3 (Maipo)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWe are currently running Elastic with fluentd pushing in log data via a bulk index. Yesterday we ran some large tests (~1 million rows of log data) pushing in a large number of rows in a short period of time.\r\n\r\nSome of those pushes from fluentd timed out (it had a 5 second response timeout check), likely because Elastic was dealing with the volume and starting heavy GC.\r\n\r\nDuring this the request breaker filled and stayed full (example below not the real deal since I didn't copy & paste it-- can't remember if the estimated was slightly above or below the limit):\r\n\r\n```\r\n2017-04-13 14:23:49 -0400 [warn]: temporarily failed to flush the buffer. next_retry=2017-04-13 14:23:48 -0400 error_class=\"Elasticsearch::Transport::Transport::Errors::ServiceUnavailable\" error=\"[503] {\\\"error\\\":{\\\"root_cause\\\":[{\\\"type\\\":\\\"circuit_breaking_exception\\\",\\\"reason\\\":\\\"[parent] Data too large, data for [<http_request>] would be larger than limit of [2242655027/2gb]\\\",\\\"bytes_wanted\\\":2267000752,\\\"bytes_limit\\\":2242655027}],\\\"type\\\":\\\"circuit_breaking_exception\\\",\\\"reason\\\":\\\"[parent] Data too large, data for [<http_request>] would be larger than limit of [2242655027/2gb]\\\",\\\"bytes_wanted\\\":2267000752,\\\"bytes_limit\\\":2242655027},\\\"status\\\":503}\" plugin_id=\"catchall-elastic-access\"\r\n```\r\n\r\n```\r\n\"limit_size_in_bytes\": 1922275737,\r\n\"limit_size\": \"1.7gb\",\r\n\"estimated_size_in_bytes\": 2242655027,\r\n\"estimated_size\": \"2gb\",\r\n```\r\n\r\nFluentd would continue to retry pushing over the rest of the queued date every 30 minutes but Elastic never recovered until it was restarted.\r\n\r\nOnce I restarted Elastic, the last two bulk index requests were pushed from fluentd and the request breaker was left at 0.\r\n\r\nThis morning I when through the process end-to-end again and encountered the same behavior (including the fluentd request timeout).\r\n\r\nI can reproduce this manually (and consistently) using Paw (http://paw.cloud) with the below bulk request by executing the request and then executing the request again before the first request completed (which I'm assuming is abruptly closing the first request's connection):\r\n\r\n```\r\n{ \"index\" : { \"_index\" : \"logstash-test\", \"_type\" : \"test\" } }\r\n{\"method\":\"GET\",\"remoteHost\":\"192.168.0.11\",\"responseTime\":\"3\",\"requestURI\":\"/test\",\"message\":\"GET /authds/status?details\",\"responseCode\":\"200\",\"file\":\"access_log.2017-04-13.txt\",\"bytes\":\"454\",\"host\":\"localhost\",\"http\":\"HTTP/1.0\",\"user\":\"tester\",\"@timestamp\":\"2017-08-28T19:46:40-04:00\",\"tag\":\"access\"}\r\n```\r\n\r\nWith the above request, each time I abort the request the request breaker grows by 16,440.\r\n\r\nAlso note: A large number of those requests had invalid timestamps and hence Elastic threw errors on the @timetamp parsing (noted here because it happened, but not sure it contributed to the issue)\r\n* [stacktrace.txt](https://github.com/elastic/elasticsearch/files/922303/stacktrace.txt)","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}