[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261514342","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-261514342","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":261514342,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTUxNDM0Mg==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2016-11-18T11:49:56Z","updated_at":"2016-11-18T11:49:56Z","author_association":"MEMBER","body":"When using search templates functions like `toJson` you need to carefully consider the parameters you pass to the script. \n\nIn your example, `{{#toJson}}clauses{{/toJson}}` refers to an array containing 3 strings \"kuipstoel\", \"brunello\", \"cognac\" so it must be used as an array in your query.\n\nIn 5.0, you can search directly using a search template like this:\n\n```\nPOST /_search/template \n{\n    \"inline\": \"{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\": [{\\\"terms\\\": {\\\"clauses\\\": {{#toJson}}clauses{{/toJson}} }}] }}}\", \n    \"params\": {\n        \"clauses\": [\n            \"kuipstoel\",\"brunello\",\"cognac\"\n        ]\n   }\n}\n```\n\nThe search template will be compiled and cached before being executed as the following query:\n\n```\n{\"query\":{\"bool\":{\"must\": [{\"terms\": {\"clauses\": [\"kuipstoel\",\"brunello\",\"cognac\"] }}] }}}\n```\n\nIn 5.0, you can store it like this (here under the name `test`):\n\n```\nPOST /_search/template/test \n{\n    \"template\": \"{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\": [{\\\"terms\\\": {\\\"clauses\\\": {{#toJson}}clauses{{/toJson}} }}] }}}\"\n}\n```\n\nAnd then use it to search documents:\n\n```\nGET /_search/template \n{\"id\":\"test\", \"params\":{\"clauses\":[\"a\",\"b\",\"c\"]}}\n```\n\nTo complete your example, you could also store a template like this:\n\n```\nPOST /_search/template/test\n{                                                                    \n    \"template\": \"{\\\"query\\\":{\\\"bool\\\":{\\\"must\\\": {{#toJson}}clauses{{/toJson}} }}}\"   \n}\n```\n\nbut if you look carefully at the structure of the query you can see that it expects an array of queries (that's the format expected by the `must` clause of a `bool` query). \n\nSo you have to pass the right parameters:\n\n```\nGET /_search/template \n{\n  \"id\":\"test\", \n  \"params\": { \n    \"clauses\":  [\n      {\n        \"terms\": {\n          \"clauses\": [\"a\",\"b\",\"c\"]\n        }\n      }\n    ]\n  }\n}\n\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261520768","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-261520768","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":261520768,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTUyMDc2OA==","user":{"login":"borissmidt","id":5995670,"node_id":"MDQ6VXNlcjU5OTU2NzA=","avatar_url":"https://avatars2.githubusercontent.com/u/5995670?v=4","gravatar_id":"","url":"https://api.github.com/users/borissmidt","html_url":"https://github.com/borissmidt","followers_url":"https://api.github.com/users/borissmidt/followers","following_url":"https://api.github.com/users/borissmidt/following{/other_user}","gists_url":"https://api.github.com/users/borissmidt/gists{/gist_id}","starred_url":"https://api.github.com/users/borissmidt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borissmidt/subscriptions","organizations_url":"https://api.github.com/users/borissmidt/orgs","repos_url":"https://api.github.com/users/borissmidt/repos","events_url":"https://api.github.com/users/borissmidt/events{/privacy}","received_events_url":"https://api.github.com/users/borissmidt/received_events","type":"User","site_admin":false},"created_at":"2016-11-18T12:28:22Z","updated_at":"2016-11-18T12:28:22Z","author_association":"NONE","body":"So if i see this correctly then the tojson has a different syntax from the other templates. \ni.e. \nin this example the querry is a normal querry\n\n```\nGET /_search/template\n{\n    \"inline\" : {\n      \"query\": { \"match\" : { \"{{my_field}}\" : \"{{my_value}}\" } },\n      \"size\" : \"{{my_size}}\"\n    },\n    \"params\" : {\n        \"my_field\" : \"foo\",\n        \"my_value\" : \"bar\",\n        \"my_size\" : 5\n    }\n}\n```\n\nWhile with `#tojson` you have to make the full  querry a string. \n\nI actually just need to inline arrays but the tojson seems to be the only function that allows me to do that without generating an empty string field \"\". \n\nPS the example i used was just the one from the website. I have a different more complex query which is called from a java client.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261524828","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-261524828","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":261524828,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTUyNDgyOA==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2016-11-18T12:51:47Z","updated_at":"2016-11-18T12:51:47Z","author_association":"MEMBER","body":"> So if i see this correctly then the tojson has a different syntax from the other templates.\n> While with #tojson you have to make the full querry a string. \n\nBy the nature of the function, ie generating JSON, and because you are using a REST JSON API to store this template, yes it has to be used in a inline query in order to build the query itself. \n\nYou can also create a file `config/scripts/test.mustache` containing\n\n```\n{\n    \"query\": {\n        \"bool\": {\n            \"must\": {{#toJson}}clauses{{/toJson}}\n        }\n    }\n}\n\n```\n\nThis way you don't have to make the full query a string.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261525859","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-261525859","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":261525859,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTUyNTg1OQ==","user":{"login":"borissmidt","id":5995670,"node_id":"MDQ6VXNlcjU5OTU2NzA=","avatar_url":"https://avatars2.githubusercontent.com/u/5995670?v=4","gravatar_id":"","url":"https://api.github.com/users/borissmidt","html_url":"https://github.com/borissmidt","followers_url":"https://api.github.com/users/borissmidt/followers","following_url":"https://api.github.com/users/borissmidt/following{/other_user}","gists_url":"https://api.github.com/users/borissmidt/gists{/gist_id}","starred_url":"https://api.github.com/users/borissmidt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borissmidt/subscriptions","organizations_url":"https://api.github.com/users/borissmidt/orgs","repos_url":"https://api.github.com/users/borissmidt/repos","events_url":"https://api.github.com/users/borissmidt/events{/privacy}","received_events_url":"https://api.github.com/users/borissmidt/received_events","type":"User","site_admin":false},"created_at":"2016-11-18T12:57:38Z","updated_at":"2016-11-18T12:57:38Z","author_association":"NONE","body":"Ok thanks for the help. \n\nMaybe this could be added to the wiki?\nBecause its not stated clearly that you have to stringify your string when using the `#json` and not with the other mustache functions.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/261527429","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-261527429","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":261527429,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MTUyNzQyOQ==","user":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"created_at":"2016-11-18T13:06:34Z","updated_at":"2016-11-18T13:06:34Z","author_association":"MEMBER","body":"I think it is already documented at https://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-template.html\n\nBut if you think the documentation could be improved on this point, please feel free to contribute :) There is an \"edit\" button on the page.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321970787","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-321970787","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":321970787,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTk3MDc4Nw==","user":{"login":"ebuildy","id":1219817,"node_id":"MDQ6VXNlcjEyMTk4MTc=","avatar_url":"https://avatars0.githubusercontent.com/u/1219817?v=4","gravatar_id":"","url":"https://api.github.com/users/ebuildy","html_url":"https://github.com/ebuildy","followers_url":"https://api.github.com/users/ebuildy/followers","following_url":"https://api.github.com/users/ebuildy/following{/other_user}","gists_url":"https://api.github.com/users/ebuildy/gists{/gist_id}","starred_url":"https://api.github.com/users/ebuildy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ebuildy/subscriptions","organizations_url":"https://api.github.com/users/ebuildy/orgs","repos_url":"https://api.github.com/users/ebuildy/repos","events_url":"https://api.github.com/users/ebuildy/events{/privacy}","received_events_url":"https://api.github.com/users/ebuildy/received_events","type":"User","site_admin":false},"created_at":"2017-08-12T09:59:36Z","updated_at":"2017-08-12T09:59:36Z","author_association":"CONTRIBUTOR","body":"So in conclusion, it's not possible to store a template (via ``POST /_search/template/{NAME}`` method) containing ``{{#toJson}}``?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321971723","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-321971723","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":321971723,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTk3MTcyMw==","user":{"login":"borissmidt","id":5995670,"node_id":"MDQ6VXNlcjU5OTU2NzA=","avatar_url":"https://avatars2.githubusercontent.com/u/5995670?v=4","gravatar_id":"","url":"https://api.github.com/users/borissmidt","html_url":"https://github.com/borissmidt","followers_url":"https://api.github.com/users/borissmidt/followers","following_url":"https://api.github.com/users/borissmidt/following{/other_user}","gists_url":"https://api.github.com/users/borissmidt/gists{/gist_id}","starred_url":"https://api.github.com/users/borissmidt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borissmidt/subscriptions","organizations_url":"https://api.github.com/users/borissmidt/orgs","repos_url":"https://api.github.com/users/borissmidt/repos","events_url":"https://api.github.com/users/borissmidt/events{/privacy}","received_events_url":"https://api.github.com/users/borissmidt/received_events","type":"User","site_admin":false},"created_at":"2017-08-12T10:12:22Z","updated_at":"2017-08-12T10:13:11Z","author_association":"NONE","body":"@ebuildy it is possible, First you create your template request and then you post it as a stringified post the \\n don't matter they are put in because i just use a tool to convert from template to string.:\r\n```\r\nPOST _search/template/marketplace_singleproductpages\r\n{\r\n  \"template\":\"{\\n  \\\"_source\\\": [\\n    \\\"url\\\"  ],\\n  \\\"size\\\": 100,\\n  \\\"query\\\": {}}\"\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323462033","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-323462033","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":323462033,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ2MjAzMw==","user":{"login":"timtutt","id":1517492,"node_id":"MDQ6VXNlcjE1MTc0OTI=","avatar_url":"https://avatars2.githubusercontent.com/u/1517492?v=4","gravatar_id":"","url":"https://api.github.com/users/timtutt","html_url":"https://github.com/timtutt","followers_url":"https://api.github.com/users/timtutt/followers","following_url":"https://api.github.com/users/timtutt/following{/other_user}","gists_url":"https://api.github.com/users/timtutt/gists{/gist_id}","starred_url":"https://api.github.com/users/timtutt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/timtutt/subscriptions","organizations_url":"https://api.github.com/users/timtutt/orgs","repos_url":"https://api.github.com/users/timtutt/repos","events_url":"https://api.github.com/users/timtutt/events{/privacy}","received_events_url":"https://api.github.com/users/timtutt/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T21:12:15Z","updated_at":"2017-08-18T21:12:15Z","author_association":"NONE","body":"@borissmidt -  Does that mean there is currently no way to do this with the Elasticsearch apis. In the javascript API for instance the put template allows you to specify an id as a template, but not the full URL to post. I have a number of templates that I automatically load using some scripts, but using toJson in this manner does not seem possible. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323503896","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-323503896","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":323503896,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzUwMzg5Ng==","user":{"login":"borissmidt","id":5995670,"node_id":"MDQ6VXNlcjU5OTU2NzA=","avatar_url":"https://avatars2.githubusercontent.com/u/5995670?v=4","gravatar_id":"","url":"https://api.github.com/users/borissmidt","html_url":"https://github.com/borissmidt","followers_url":"https://api.github.com/users/borissmidt/followers","following_url":"https://api.github.com/users/borissmidt/following{/other_user}","gists_url":"https://api.github.com/users/borissmidt/gists{/gist_id}","starred_url":"https://api.github.com/users/borissmidt/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/borissmidt/subscriptions","organizations_url":"https://api.github.com/users/borissmidt/orgs","repos_url":"https://api.github.com/users/borissmidt/repos","events_url":"https://api.github.com/users/borissmidt/events{/privacy}","received_events_url":"https://api.github.com/users/borissmidt/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T06:15:53Z","updated_at":"2017-08-19T06:15:53Z","author_association":"NONE","body":"@timtutt, it is possible to do if you post the templates as a string. The last part of the url is the id.\r\nto save the template:\r\nPost /_seach/template [id]\r\nTo use the template:\r\nGet /_search/ template\r\n{\r\nid:[id],\r\nparams:{a:hello}\r\n}\r\n\r\nYou should take s a look at the documentation since it explains it better.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/338746673","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-338746673","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":338746673,"node_id":"MDEyOklzc3VlQ29tbWVudDMzODc0NjY3Mw==","user":{"login":"RomainXie","id":13447287,"node_id":"MDQ6VXNlcjEzNDQ3Mjg3","avatar_url":"https://avatars1.githubusercontent.com/u/13447287?v=4","gravatar_id":"","url":"https://api.github.com/users/RomainXie","html_url":"https://github.com/RomainXie","followers_url":"https://api.github.com/users/RomainXie/followers","following_url":"https://api.github.com/users/RomainXie/following{/other_user}","gists_url":"https://api.github.com/users/RomainXie/gists{/gist_id}","starred_url":"https://api.github.com/users/RomainXie/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/RomainXie/subscriptions","organizations_url":"https://api.github.com/users/RomainXie/orgs","repos_url":"https://api.github.com/users/RomainXie/repos","events_url":"https://api.github.com/users/RomainXie/events{/privacy}","received_events_url":"https://api.github.com/users/RomainXie/received_events","type":"User","site_admin":false},"created_at":"2017-10-23T18:06:32Z","updated_at":"2017-10-23T18:18:59Z","author_association":"NONE","body":"@borissmidt \r\nTry to save a template with {{#tojoin}} will get a error back.\r\nMy template is \r\n\r\n```\r\nPOST _scripts/test-json\r\n{\r\n  \"script\": {\r\n    \"lang\": \"mustache\",\r\n    \"source\": {\"query\": {\"filter\": {\"bool\": {\"must\": [{\"terms\": {\"beat.hostname\": {{#tojson}}hostname{{/tojson}} } }] } } } }\r\n  }\r\n}\r\n```\r\n\r\nThe error message:\r\n\r\n```\r\n      \"caused_by\": {\r\n        \"type\": \"i_o_exception\",\r\n        \"reason\": \"Unexpected character ('{' (code 123)): was expecting double-quote to start field name\\n at [Source: org.elasticsearch.common.bytes.BytesReference$MarkSupportingStreamInputWrapper@5f8a9c1a; line: 10, column: 36]\"\r\n      }\r\n```\r\n\r\nAfter change the template like below, the syntax is correct. But I can not get the result.\r\n\r\n```\r\nPOST _scripts/test-json\r\n{\r\n  \"script\": {\r\n    \"lang\": \"mustache\",\r\n    \"source\": {\"query\": {\"filter\": {\"bool\": {\"must\": [{\"terms\": {\"beat.hostname\": [\"{{hostname}}\"] } }] } } } }\r\n  }\r\n}\r\n```\r\n\r\nA test call:\r\n\r\n```\r\nGET /_search/template\r\n{\r\n  \"id\": \"test-json\",\r\n  \"params\": {\r\n    \"hostname\": [\"begon\", \"testhost\"]\r\n  }\r\n}\r\n```\r\n\r\nIs something I missed?\r\nMy version is 5.6.3\r\n\r\nThanks\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/338755416","html_url":"https://github.com/elastic/elasticsearch/issues/21648#issuecomment-338755416","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21648","id":338755416,"node_id":"MDEyOklzc3VlQ29tbWVudDMzODc1NTQxNg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2017-10-23T18:35:43Z","updated_at":"2017-10-23T18:35:43Z","author_association":"MEMBER","body":"@RomainXie please ask questions at https://discuss.elastic.co/. Thank you.","performed_via_github_app":null}]