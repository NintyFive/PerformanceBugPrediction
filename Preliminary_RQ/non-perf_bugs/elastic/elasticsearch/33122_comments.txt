[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415851842","html_url":"https://github.com/elastic/elasticsearch/issues/33122#issuecomment-415851842","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33122","id":415851842,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTg1MTg0Mg==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2018-08-24T18:58:25Z","updated_at":"2018-08-24T18:58:25Z","author_association":"CONTRIBUTOR","body":"Hi @pakein. I think there are two things that would help resolve this issue you're running into \r\n\r\n* which version of ES are you running?\r\n* would you be able to share more context into the creation of your index template with the mapping details that is resulting in you hitting this branch in the code?\r\n\r\nthanks","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415851925","html_url":"https://github.com/elastic/elasticsearch/issues/33122#issuecomment-415851925","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33122","id":415851925,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTg1MTkyNQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-08-24T18:58:46Z","updated_at":"2018-08-24T18:58:46Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/415955802","html_url":"https://github.com/elastic/elasticsearch/issues/33122#issuecomment-415955802","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33122","id":415955802,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNTk1NTgwMg==","user":{"login":"pakein","id":1241770,"node_id":"MDQ6VXNlcjEyNDE3NzA=","avatar_url":"https://avatars2.githubusercontent.com/u/1241770?v=4","gravatar_id":"","url":"https://api.github.com/users/pakein","html_url":"https://github.com/pakein","followers_url":"https://api.github.com/users/pakein/followers","following_url":"https://api.github.com/users/pakein/following{/other_user}","gists_url":"https://api.github.com/users/pakein/gists{/gist_id}","starred_url":"https://api.github.com/users/pakein/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pakein/subscriptions","organizations_url":"https://api.github.com/users/pakein/orgs","repos_url":"https://api.github.com/users/pakein/repos","events_url":"https://api.github.com/users/pakein/events{/privacy}","received_events_url":"https://api.github.com/users/pakein/received_events","type":"User","site_admin":false},"created_at":"2018-08-25T09:18:54Z","updated_at":"2018-08-25T09:24:38Z","author_association":"NONE","body":"I use 6.3.0， i read the code of 6.4.0, it seems have the same problem\r\n\r\nmy code， the client api addMapping（type，XContentBuilder ） is confused，it seems XContentBuilder do not need the type\r\n```\r\nXContentBuilder build;            \r\nbuild.startObject()  \r\n// map size > 1, not wrap by type\r\n builder.startObject(\"_all\");\r\n builder.field(\"enabled\", false);\r\n builder.endObject();\r\nbuilder.startObject(\"properties\");\r\n........\r\nbuilder.endObject();\r\nbuild.endObject();\r\naddMapping（“type”， build) \r\n```\r\n\r\ncontains  ***** is my comment \r\nMetaDataIndexTemplateService.validateAndAddTemplate\r\n ```\r\nMap<String, Map<String, Object>> mappingsForValidation = new HashMap<>();\r\n            for (Map.Entry<String, String> entry : request.mappings.entrySet()) {\r\n                try {\r\n\r\n//************* direct write meta, not check entry.value ********************\r\n                    templateBuilder.putMapping(entry.getKey(), entry.getValue());\r\n                } catch (Exception e) {\r\n                    throw new MapperParsingException(\"Failed to parse mapping [{}]: {}\", e, entry.getKey(), e.getMessage());\r\n                }\r\n                mappingsForValidation.put(entry.getKey(), MapperService.parseMapping(xContentRegistry, entry.getValue()));\r\n            }\r\n\r\n//************ call MappingService,  check and add type  see below. *************\r\ndummyIndexService.mapperService().merge(mappingsForValidation, MergeReason.MAPPING_UPDATE, false);\r\n````\r\n\r\nMappingService\r\n```\r\nprivate Tuple<String, Map<String, Object>> extractMapping(String type, Map<String, Object> root) throws MapperParsingException {\r\n        if (root.size() == 0) {\r\n            // if we don't have any keys throw an exception\r\n            throw new MapperParsingException(\"malformed mapping no root object found\");\r\n        }\r\n        String rootName = root.keySet().iterator().next();\r\n        \r\n     // ************* add type, so the request is success, this can throw exception ?? *****************\r\n        Tuple<String, Map<String, Object>> mapping;\r\n        if (type == null || type.equals(rootName)) {\r\n            mapping = new Tuple<>(rootName, (Map<String, Object>) root.get(rootName));\r\n        } else {\r\n            mapping = new Tuple<>(type, root);\r\n        }\r\n        return mapping;\r\n    }\r\n\r\n```\r\n\r\nwhen read meta from file , check mapping size == 1, so read meta fail.\r\n\r\nIndexTemplateMetaData\r\n```\r\nMap<String, Object> mapping = parser.mapOrdered();\r\n//*****************  mapping size != 1 , there has not type *************\r\n                            if (mapping.size() == 1) {\r\n                                String mappingType = mapping.keySet().iterator().next();\r\n                                String mappingSource = Strings.toString(XContentFactory.jsonBuilder().map(mapping));\r\n\r\n                                if (mappingSource == null) {\r\n                                    // crap, no mapping source, warn?\r\n                                } else {\r\n                                    builder.putMapping(mappingType, mappingSource);\r\n                                }\r\n                            }\r\n```\r\n\r\n\r\nSo i think when XContentBuilder do not contain type , the rpc request may throw exception.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426245867","html_url":"https://github.com/elastic/elasticsearch/issues/33122#issuecomment-426245867","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33122","id":426245867,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjI0NTg2Nw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-10-02T11:55:32Z","updated_at":"2018-10-02T11:55:32Z","author_association":"MEMBER","body":"hi @pakein , I have a hard time understanding what the problem is. Could you elaborate on what the request that you send looks like, what result you would expect and what is happening instead? I think that would be very helpful to troubleshoot this issue on our end. Thanks!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/437282796","html_url":"https://github.com/elastic/elasticsearch/issues/33122#issuecomment-437282796","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33122","id":437282796,"node_id":"MDEyOklzc3VlQ29tbWVudDQzNzI4Mjc5Ng==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-11-09T08:12:28Z","updated_at":"2018-11-09T08:12:28Z","author_association":"MEMBER","body":"No further feedback received. @pakein if you have the requested \r\ninformation please add it in a comment and we can look at re-opening \r\nthis issue.\r\n","performed_via_github_app":null}]