{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37189","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37189/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37189/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37189/events","html_url":"https://github.com/elastic/elasticsearch/issues/37189","id":396501198,"node_id":"MDU6SXNzdWUzOTY1MDExOTg=","number":37189,"title":"[CI] CoreFullClusterRestartIT fails with fatal error","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-01-07T14:09:47Z","updated_at":"2019-01-07T14:32:08Z","closed_at":"2019-01-07T14:32:08Z","author_association":"MEMBER","active_lock_reason":null,"body":"The test suite fails with `java.net.ConnectException: Connection refused` errors inspecting the logs there is a fatal error that takes down one of the nodes.\r\n\r\n```\r\n2019-01-07T02:31:31,052][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [node-0] fatal error in thread [elasticsearch[node-0][clusterApplierService#updateTask][T#1]], exiting\r\njava.lang.AssertionError: existing values: [[299 Elasticsearch-7.0.0-SNAPSHOT-da3d8fb \"[search.remote.foo.seeds] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version.\" \"Mon, 07 Jan 2019 02:31:31 GMT\", 299 Elasticsearch-7.0.0-SNAPSHOT-da3d8fb \"[search.remote.foo.skip_unavailable] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version.\" \"Mon, 07 Jan 2019 02:31:31 GMT\", 299 Elasticsearch-7.0.0-SNAPSHOT-da3d8fb \"[search.remote.foo.seeds] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version.\" \"Mon, 07 Jan 2019 02:31:30 GMT\", 299 Elasticsearch-7.0.0-SNAPSHOT-da3d8fb \"[search.remote.foo.skip_unavailable] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version.\" \"Mon, 07 Jan 2019 02:31:30 GMT\"]], existing unique values [[[search.remote.foo.skip_unavailable] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version., [search.remote.foo.seeds] setting was deprecated in Elasticsearch and will be removed in a future release! See the breaking changes documentation for the next major version.]]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ThreadContextStruct.putResponse(ThreadContext.java:528) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ThreadContextStruct.access$1100(ThreadContext.java:403) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext.addResponseHeader(ThreadContext.java:331) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.logging.DeprecationLogger.deprecated(DeprecationLogger.java:313) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.logging.DeprecationLogger.deprecatedAndMaybeLog(DeprecationLogger.java:148) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting.checkDeprecation(Setting.java:470) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting.getRaw(Setting.java:449) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting.lambda$listSetting$33(Setting.java:1208) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting$ListSetting.lambda$new$0(Setting.java:1282) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting$ListSetting.innerGetRaw(Setting.java:1292) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting.getRaw(Setting.java:450) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting$Updater.hasChanged(Setting.java:951) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting$AffixSetting$1.lambda$getValue$2(Setting.java:683) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183) ~[?:?]\r\n\tat java.util.stream.DistinctOps$1$2.accept(DistinctOps.java:175) ~[?:?]\r\n\tat java.util.stream.ReferencePipeline$3$1.accept(ReferencePipeline.java:195) ~[?:?]\r\n\tat java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:177) ~[?:?]\r\n\tat java.util.HashMap$KeySpliterator.forEachRemaining(HashMap.java:1603) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474) ~[?:?]\r\n\tat java.util.stream.StreamSpliterators$WrappingSpliterator.forEachRemaining(StreamSpliterators.java:312) ~[?:?]\r\n\tat java.util.stream.Streams$ConcatSpliterator.forEachRemaining(Streams.java:735) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474) ~[?:?]\r\n\tat java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150) ~[?:?]\r\n\tat java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173) ~[?:?]\r\n\tat java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) ~[?:?]\r\n\tat java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497) ~[?:?]\r\n\tat org.elasticsearch.common.settings.Setting$AffixSetting$1.getValue(Setting.java:677) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.Setting$AffixSetting$1.getValue(Setting.java:666) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.AbstractScopedSettings$SettingUpdater.apply(AbstractScopedSettings.java:547) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.AbstractScopedSettings$1.getValue(AbstractScopedSettings.java:283) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.AbstractScopedSettings$1.getValue(AbstractScopedSettings.java:255) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.AbstractScopedSettings$SettingUpdater.updater(AbstractScopedSettings.java:561) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.settings.AbstractScopedSettings.applySettings(AbstractScopedSettings.java:184) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.applyChanges(ClusterApplierService.java:461) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.runTask(ClusterApplierService.java:418) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService$UpdateTask.run(ClusterApplierService.java:162) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:660) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:244) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:207) ~[elasticsearch-7.0.0-SNAPSHOT.jar:7.0.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\n```\r\n\r\nHere's one of the reproduce command from https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+bwc-tests/298/console but it does not reproduce:\r\n```\r\n./gradlew :x-pack:qa:full-cluster-restart:with-system-key:v6.2.2#upgradedClusterTestRunner \\\r\n  -Dtests.seed=DE4C6A3F891A30E9 \\\r\n  -Dtests.class=org.elasticsearch.xpack.restart.CoreFullClusterRestartIT \\\r\n  -Dtests.method=\"testSnapshotRestore\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=es-DO \\\r\n  -Dtests.timezone=America/Cambridge_Bay \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nI've found 2 instances of this failure both on master:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+bwc-tests/298/console\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+bwc-tests/296/console\r\n\r\nLog files from the 2 upgraded nodes are attached for build 298.\r\n[upgraded-node0.log](https://github.com/elastic/elasticsearch/files/2732975/upgraded-node0.log)\r\n[upgraded-node-1.log](https://github.com/elastic/elasticsearch/files/2732977/upgraded-node-1.log)\r\n\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}