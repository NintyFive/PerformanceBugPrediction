{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13619","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13619/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13619/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13619/events","html_url":"https://github.com/elastic/elasticsearch/issues/13619","id":106804888,"node_id":"MDU6SXNzdWUxMDY4MDQ4ODg=","number":13619,"title":"VersionConflictEngineException with script update in cluster","user":{"login":"falkorichter","id":50506,"node_id":"MDQ6VXNlcjUwNTA2","avatar_url":"https://avatars2.githubusercontent.com/u/50506?v=4","gravatar_id":"","url":"https://api.github.com/users/falkorichter","html_url":"https://github.com/falkorichter","followers_url":"https://api.github.com/users/falkorichter/followers","following_url":"https://api.github.com/users/falkorichter/following{/other_user}","gists_url":"https://api.github.com/users/falkorichter/gists{/gist_id}","starred_url":"https://api.github.com/users/falkorichter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/falkorichter/subscriptions","organizations_url":"https://api.github.com/users/falkorichter/orgs","repos_url":"https://api.github.com/users/falkorichter/repos","events_url":"https://api.github.com/users/falkorichter/events{/privacy}","received_events_url":"https://api.github.com/users/falkorichter/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-09-16T15:59:55Z","updated_at":"2016-07-27T18:25:03Z","closed_at":"2015-09-16T17:22:53Z","author_association":"NONE","active_lock_reason":null,"body":"We´re having problems with VersionConflictEngineExceptions all the time. The update should happen as a script and increment a number value (see sample document below)\n\nWe´re running a cluster of two els instances and I can only imagine that the synchronization is causing the conflict version in one node. I would expect the update not to throw this kind of exception in a cluster, as each update is atomically. We are running four application servers that execute this code and the Exceptions are thrown randomly on all instances.\n\nstacktrace:\n\n```\nCaused by: org.elasticsearch.index.engine.VersionConflictEngineException: [kpi][4] [opportunity][1442415600000]: version conflict, current [5933], provided [5932]\n        at org.elasticsearch.index.engine.internal.InternalEngine.innerIndex(InternalEngine.java:582) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.index.engine.internal.InternalEngine.index(InternalEngine.java:522) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.index.shard.service.InternalIndexShard.index(InternalIndexShard.java:425) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.index.TransportIndexAction.shardOperationOnPrimary(TransportIndexAction.java:193) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.performOnPrimary(TransportShardReplicationOperationAction.java:512) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.doStart(TransportShardReplicationOperationAction.java:426) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.start(TransportShardReplicationOperationAction.java:342) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction.doExecute(TransportShardReplicationOperationAction.java:97) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.index.TransportIndexAction.innerExecute(TransportIndexAction.java:134) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.index.TransportIndexAction.doExecute(TransportIndexAction.java:112) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.index.TransportIndexAction.doExecute(TransportIndexAction.java:60) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:75) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:217) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:170) [elasticsearch-1.4.4.jar:]\n        at org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$AsyncSingleAction$1.run(TransportInstanceSingleOperationAction.java:187) [elasticsearch-1.4.4.jar:]\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [rt.jar:1.8.0_20]\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [rt.jar:1.8.0_20]\n        at java.lang.Thread.run(Thread.java:745) [rt.jar:1.8.0_20]\n```\n\nsample document:\n\n```\n{\n  \"_index\": \"kpi\",\n  \"_type\": \"opportunity\",\n  \"_id\": \"1442412000000\",\n  \"_version\": 14742,\n  \"found\": true,\n  \"_source\": {\n    \"timestamp\": \"2015-09-16T14:00:00.249+0000\",\n    \"own\": 224,\n    \"shared\": 2,\n    \"network\": 3941,\n    \"unknown\": 10575\n  }\n}\n```\n\neach update script looks like this (one of the lines, only one increment per script):\n\n```\nctx._source.own+=1;\nctx._source.shared+=1;\nctx._source.network+=1;\nctx._source.unknown+=1;\n```\n","closed_by":{"login":"falkorichter","id":50506,"node_id":"MDQ6VXNlcjUwNTA2","avatar_url":"https://avatars2.githubusercontent.com/u/50506?v=4","gravatar_id":"","url":"https://api.github.com/users/falkorichter","html_url":"https://github.com/falkorichter","followers_url":"https://api.github.com/users/falkorichter/followers","following_url":"https://api.github.com/users/falkorichter/following{/other_user}","gists_url":"https://api.github.com/users/falkorichter/gists{/gist_id}","starred_url":"https://api.github.com/users/falkorichter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/falkorichter/subscriptions","organizations_url":"https://api.github.com/users/falkorichter/orgs","repos_url":"https://api.github.com/users/falkorichter/repos","events_url":"https://api.github.com/users/falkorichter/events{/privacy}","received_events_url":"https://api.github.com/users/falkorichter/received_events","type":"User","site_admin":false},"performed_via_github_app":null}