{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30560","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30560/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30560/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30560/events","html_url":"https://github.com/elastic/elasticsearch/issues/30560","id":322714451,"node_id":"MDU6SXNzdWUzMjI3MTQ0NTE=","number":30560,"title":"[suggestion] Restore the removed option `index.compound_on_flush` to reduce write amplification ?","user":{"login":"micoq","id":1741616,"node_id":"MDQ6VXNlcjE3NDE2MTY=","avatar_url":"https://avatars3.githubusercontent.com/u/1741616?v=4","gravatar_id":"","url":"https://api.github.com/users/micoq","html_url":"https://github.com/micoq","followers_url":"https://api.github.com/users/micoq/followers","following_url":"https://api.github.com/users/micoq/following{/other_user}","gists_url":"https://api.github.com/users/micoq/gists{/gist_id}","starred_url":"https://api.github.com/users/micoq/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/micoq/subscriptions","organizations_url":"https://api.github.com/users/micoq/orgs","repos_url":"https://api.github.com/users/micoq/repos","events_url":"https://api.github.com/users/micoq/events{/privacy}","received_events_url":"https://api.github.com/users/micoq/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":16,"created_at":"2018-05-14T08:17:01Z","updated_at":"2018-09-04T12:43:14Z","closed_at":"2018-09-04T12:43:14Z","author_association":"NONE","active_lock_reason":null,"body":"Compound segment format helps to reduce the number of used file descriptors but to write this kind of segment (*.cfs *.cfe), Lucene first write a complete segment (*.fdx *.fdt ...), reread it and finally write the compound segment.\r\n\r\nWhile it helps to reduce the number of file descriptors (2 files instead of ~14), this option increase the disk load and latency in heavy indexing environments.\r\n\r\nIn Elasticsearch, there was two options to control the compound format creation:\r\n- `index.compound_on_flush` for flushes (defaults to true)\r\n- `index.compound_format` for merges (defaults to 10% of the shard size)\r\n\r\nThe former was removed since ES 5.0 (#10778).\r\n\r\nIn our case, disable the second option reduces the CPU %wait from 5% to 1% on our cluster with the same load (doc/s).\r\n\r\nFor the first option, I made some tests in a raw Lucene index (not directly in Elasticsearch) and I observed a slightly better indexing speed (approximately 10%) with compound format disabled (tested on SSDs and rotating disks with NIOFSDirectory and Lucene 7.0.0).\r\n\r\nHowever, for small segments (<1 MB) and small refresh interval (Lucene flush, <1s) the compound format performs better (since the latency came from the file creation, not from the data copy).\r\n\r\nES version: 5.5.0\r\nCluster size: 5 nodes (4 data nodes)\r\nShards: ~1700\r\nCurrent indexing speed: 6000 docs/s (up to 20000)\r\nStorage: 10k rpm disks","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}