[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448657301","html_url":"https://github.com/elastic/elasticsearch/issues/36849#issuecomment-448657301","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36849","id":448657301,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODY1NzMwMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-12-19T16:27:53Z","updated_at":"2018-12-19T16:27:53Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448680017","html_url":"https://github.com/elastic/elasticsearch/issues/36849#issuecomment-448680017","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36849","id":448680017,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODY4MDAxNw==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2018-12-19T17:33:18Z","updated_at":"2018-12-19T17:33:18Z","author_association":"MEMBER","body":"Muted on the 6.x branch in https://github.com/elastic/elasticsearch/commit/e31f80cd17e614b1bca239066659795351618c25\r\n\r\nThe problem is a version conflict exception updating the job\r\n\r\n```\r\n[2018-12-19T15:03:24,126][INFO ][o.e.x.m.j.p.a.AutodetectCommunicator] [node-2] [restore-model-snapshot-job] job closed\r\n[2018-12-19T15:03:24,159][ERROR][o.e.x.m.j.p.a.o.AutoDetectResultProcessor] [node-2] [restore-model-snapshot-job] Failed to update job with new established model memory [29606]\r\norg.elasticsearch.transport.RemoteTransportException: [node-0][127.0.0.1:37085][cluster:admin/xpack/ml/job/update]\r\nCaused by: org.elasticsearch.index.engine.VersionConflictEngineException: [doc][anomaly_detector-restore-model-snapshot-job]: version conflict, current version [7] is different than the one provided [6]\r\n```\r\n\r\nFrom the order of the log messages AutodetectCommunicator logs `[restore-model-snapshot-job] job closed` before the update fails so there is a problem in `AutoDetectResultProcessor.awaitCompletion()` in that it has not waited properly for completion probably because `jobUpdateSemaphore` can be acquired before the update starts. It is a bit racy this class and needs a rethink\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/448995801","html_url":"https://github.com/elastic/elasticsearch/issues/36849#issuecomment-448995801","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36849","id":448995801,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0ODk5NTgwMQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-12-20T13:14:17Z","updated_at":"2018-12-20T13:14:17Z","author_association":"CONTRIBUTOR","body":"I had a PR build fail with a similar version conflict exception: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-2/3034/console\r\n\r\n```\r\n11:39:25 [2018-12-20T11:38:44,673][ERROR][o.e.x.m.j.p.a.o.AutoDetectResultProcessor] [node-1] [overall-buckets-test] Failed to update job with new established model memory [30196]\r\n11:39:25 org.elasticsearch.index.engine.VersionConflictEngineException: [doc][anomaly_detector-overall-buckets-test]: version conflict, current version [5] is different than the one provided [4]\r\n```\r\n\r\nThe job this happened to was:\r\n\r\n```\r\n11:39:25 [2018-12-20T11:33:05,769][WARN ][o.e.x.m.j.p.a.o.AutoDetectResultProcessor] [node-1] [lookback-job-stopped-then-killed] some results not processed due to the process being killed\r\n```\r\n\r\nSo it's not surprising that results were still being processed at the time the job completion code ran.\r\n\r\nIt's further evidence of a race though, and now these updates are not going via the cluster state thread we need to be more careful to ensure updates to the job only come from one thread at any phase in the job lifecycle.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/450867879","html_url":"https://github.com/elastic/elasticsearch/issues/36849#issuecomment-450867879","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36849","id":450867879,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1MDg2Nzg3OQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-01-02T13:50:01Z","updated_at":"2019-01-02T13:50:01Z","author_association":"MEMBER","body":"Closed by #36856 and the test was un-muted in 8d40f4b7ee77363842f6c83e3ddfdfc4f6fda9d6","performed_via_github_app":null}]