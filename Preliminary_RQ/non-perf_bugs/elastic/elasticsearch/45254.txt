{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45254","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45254/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45254/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45254/events","html_url":"https://github.com/elastic/elasticsearch/issues/45254","id":477531988,"node_id":"MDU6SXNzdWU0Nzc1MzE5ODg=","number":45254,"title":"Scripting: ctx._now is different when using Bulk API compared to Update API","user":{"login":"pangyikhei","id":13398082,"node_id":"MDQ6VXNlcjEzMzk4MDgy","avatar_url":"https://avatars2.githubusercontent.com/u/13398082?v=4","gravatar_id":"","url":"https://api.github.com/users/pangyikhei","html_url":"https://github.com/pangyikhei","followers_url":"https://api.github.com/users/pangyikhei/followers","following_url":"https://api.github.com/users/pangyikhei/following{/other_user}","gists_url":"https://api.github.com/users/pangyikhei/gists{/gist_id}","starred_url":"https://api.github.com/users/pangyikhei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pangyikhei/subscriptions","organizations_url":"https://api.github.com/users/pangyikhei/orgs","repos_url":"https://api.github.com/users/pangyikhei/repos","events_url":"https://api.github.com/users/pangyikhei/events{/privacy}","received_events_url":"https://api.github.com/users/pangyikhei/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-08-06T18:33:17Z","updated_at":"2019-08-07T01:14:42Z","closed_at":"2019-08-07T01:14:42Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.2.0\r\n\r\n**Plugins installed**: [\"ingest-attachment\", \"analysis-icu\"]\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"11.0.3\" 2019-04-16\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 11.0.3+7)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 11.0.3+7, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nWindows Server 2016 Datacenter, Windows Server 2012 Standard, Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen using the Bulk API, an update operation with a script that sets a field to the value of ctx._now seems to set a numeric value around 1 billion. When using the Update API directly, the value that gets set appears to be the expected milliseconds from Unix epoch time.\r\n\r\nIt is expected for the update through the bulk API to be the same as a direct update using the Update API.\r\n\r\n**Steps to reproduce**:\r\n\r\nUsing Kibana to send the requests:\r\n\r\n```\r\nPUT test/_doc/1\r\n{\r\n    \"test\" : 1565112875490\r\n}\r\n```\r\n\r\nUsing Update API:\r\n```\r\n# This works as expected, setting the test field's value to the milliseconds from epoch time.\r\nPOST test/_update/1\r\n{\r\n    \"script\" : {\r\n        \"source\": \"ctx._source.test = ctx._now\",\r\n        \"lang\": \"painless\"\r\n    }\r\n}\r\n```\r\n\r\nResponse of `GET test/_doc/1`:\r\n```json\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"1\",\r\n  \"_version\" : 4,\r\n  \"_seq_no\" : 3,\r\n  \"_primary_term\" : 1,\r\n  \"found\" : true,\r\n  \"_source\" : {\r\n    \"test\" : 1565115899006\r\n  }\r\n}\r\n\r\n```\r\n\r\nBulk Request:\r\n```\r\n# This seems to set an much smaller value\r\nPOST _bulk\r\n{\"update\": {\"_id\":\"1\", \"_index\": \"test\"}}\r\n{\"script\": {\"source\":\"ctx._source.test = ctx._now\", \"lang\": \"painless\"}}\r\n```\r\n\r\nResponse of `GET test/_doc/1`:\r\n```json\r\n{\r\n  \"_index\" : \"test\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"1\",\r\n  \"_version\" : 3,\r\n  \"_seq_no\" : 2,\r\n  \"_primary_term\" : 1,\r\n  \"found\" : true,\r\n  \"_source\" : {\r\n    \"test\" : 1218165137\r\n  }\r\n}\r\n```\r\n\r\nPossibly related issues:\r\n#23169\r\n#23175\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}