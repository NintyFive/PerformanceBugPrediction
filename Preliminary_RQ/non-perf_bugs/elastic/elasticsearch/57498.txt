{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57498","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57498/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57498/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57498/events","html_url":"https://github.com/elastic/elasticsearch/issues/57498","id":628862510,"node_id":"MDU6SXNzdWU2Mjg4NjI1MTA=","number":57498,"title":"[Optimization]: During reroute async fetch data in GatewayAllocator, send request in generic threadpool instead of masterService#updateTask","user":{"login":"shwetathareja","id":2943091,"node_id":"MDQ6VXNlcjI5NDMwOTE=","avatar_url":"https://avatars3.githubusercontent.com/u/2943091?v=4","gravatar_id":"","url":"https://api.github.com/users/shwetathareja","html_url":"https://github.com/shwetathareja","followers_url":"https://api.github.com/users/shwetathareja/followers","following_url":"https://api.github.com/users/shwetathareja/following{/other_user}","gists_url":"https://api.github.com/users/shwetathareja/gists{/gist_id}","starred_url":"https://api.github.com/users/shwetathareja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/shwetathareja/subscriptions","organizations_url":"https://api.github.com/users/shwetathareja/orgs","repos_url":"https://api.github.com/users/shwetathareja/repos","events_url":"https://api.github.com/users/shwetathareja/events{/privacy}","received_events_url":"https://api.github.com/users/shwetathareja/received_events","type":"User","site_admin":false},"labels":[{"id":146854632,"node_id":"MDU6TGFiZWwxNDY4NTQ2MzI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Network","name":":Distributed/Network","color":"0e8a16","default":false,"description":"Http and internode communication implementations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2020-06-02T03:00:13Z","updated_at":"2020-08-18T15:01:00Z","closed_at":"2020-08-18T15:01:00Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.1\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThis cluster had roughly ~ 50K shards and multiple nodes were disconnected from master and during hot_threads dump observed that master#updateTask thread was spending lot of time sending these TransportNodesListGatewayStartedShards requests. These are async calls and response handling is done in separate threadpool but transport sendRequest seems to be still executing in master#updateTask. The sending logic could also move to separate threadpool.\r\n\r\n\r\nThough with this #42855 this wont happen in the context of JoinExecutor but when reroute task is scheduled, it will happen.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n80.1% (8s out of 10s) cpu usage by thread 'elasticsearch[7b5db5][masterService#updateTask][T#1]'\r\n     7/10 snapshots sharing following 54 elements\r\n       sun.nio.ch.EPollArrayWrapper.interrupt(Native Method)\r\n       sun.nio.ch.EPollArrayWrapper.interrupt(EPollArrayWrapper.java:317)\r\n       sun.nio.ch.EPollSelectorImpl.wakeup(EPollSelectorImpl.java:207)\r\n       io.netty.channel.nio.NioEventLoop.wakeup(NioEventLoop.java:719)\r\n       io.netty.util.concurrent.SingleThreadEventExecutor.execute(SingleThreadEventExecutor.java:799)\r\n       io.netty.channel.AbstractChannelHandlerContext.safeExecute(AbstractChannelHandlerContext.java:1013)\r\n       io.netty.channel.AbstractChannelHandlerContext.write(AbstractChannelHandlerContext.java:825)\r\n       io.netty.channel.AbstractChannelHandlerContext.writeAndFlush(AbstractChannelHandlerContext.java:794)\r\n       io.netty.channel.DefaultChannelPipeline.writeAndFlush(DefaultChannelPipeline.java:1066)\r\n       io.netty.channel.AbstractChannel.writeAndFlush(AbstractChannel.java:309)\r\n       org.elasticsearch.transport.netty4.Netty4TcpChannel.sendMessage(Netty4TcpChannel.java:139)\r\n       org.elasticsearch.transport.OutboundHandler.internalSendMessage(OutboundHandler.java:80)\r\n       org.elasticsearch.transport.OutboundHandler.sendMessage(OutboundHandler.java:70)\r\n       org.elasticsearch.transport.TcpTransport.sendRequestToChannel(TcpTransport.java:680)\r\n       org.elasticsearch.transport.TcpTransport.sendRequestToChannel(TcpTransport.java:669)\r\n       org.elasticsearch.transport.TcpTransport.access$300(TcpTransport.java:100)\r\n       org.elasticsearch.transport.TcpTransport$NodeChannels.sendRequest(TcpTransport.java:272)\r\n       org.elasticsearch.transport.TransportService.sendRequestInternal(TransportService.java:633)\r\n       org.elasticsearch.transport.TransportService$$Lambda$1519/1694636980.sendRequest(Unknown Source)\r\n       org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:543)\r\n       org.elasticsearch.transport.TransportService.sendRequest(TransportService.java:531)\r\n       org.elasticsearch.action.support.nodes.TransportNodesAction$AsyncAction.start(TransportNodesAction.java:182)\r\n       org.elasticsearch.action.support.nodes.TransportNodesAction.doExecute(TransportNodesAction.java:82)\r\n       org.elasticsearch.action.support.nodes.TransportNodesAction.doExecute(TransportNodesAction.java:51)\r\n       org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:145)\r\n       com.amazon.opendistro.elasticsearch.performanceanalyzer.action.PerformanceAnalyzerActionFilter.apply(PerformanceAnalyzerActionFilter.java:77)\r\n       org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:143)\r\n       org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:121)\r\n       org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:64)\r\n       org.elasticsearch.gateway.TransportNodesListGatewayStartedShards.list(TransportNodesListGatewayStartedShards.java:91)\r\n       org.elasticsearch.gateway.AsyncShardFetch.asyncFetch(AsyncShardFetch.java:283)\r\n       org.elasticsearch.gateway.AsyncShardFetch.fetchData(AsyncShardFetch.java:126)\r\n       org.elasticsearch.gateway.GatewayAllocator$InternalPrimaryShardAllocator.fetchData(GatewayAllocator.java:159)\r\n       org.elasticsearch.gateway.PrimaryShardAllocator.makeAllocationDecision(PrimaryShardAllocator.java:86)\r\n       org.elasticsearch.gateway.BaseGatewayShardAllocator.allocateUnassigned(BaseGatewayShardAllocator.java:59)\r\n       org.elasticsearch.gateway.GatewayAllocator.innerAllocatedUnassigned(GatewayAllocator.java:114)\r\n       org.elasticsearch.gateway.GatewayAllocator.allocateUnassigned(GatewayAllocator.java:104)\r\n       org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:410)\r\n       org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:378)\r\n       org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:361)\r\n       org.elasticsearch.cluster.coordination.JoinTaskExecutor.execute(JoinTaskExecutor.java:155)\r\n       org.elasticsearch.cluster.coordination.JoinHelper$1.execute(JoinHelper.java:118)\r\n       org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:687)\r\n       org.elasticsearch.cluster.service.MasterService.calculateTaskOutputs(MasterService.java:310)\r\n       org.elasticsearch.cluster.service.MasterService.runTasks(MasterService.java:210)\r\n       org.elasticsearch.cluster.service.MasterService$Batcher.run(MasterService.java:142)\r\n       org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150)\r\n       org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188)\r\n       org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:690)\r\n       org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:252)\r\n       org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:215)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)\r\n       java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\n\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}