{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/45771","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45771/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45771/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45771/events","html_url":"https://github.com/elastic/elasticsearch/issues/45771","id":483292589,"node_id":"MDU6SXNzdWU0ODMyOTI1ODk=","number":45771,"title":"Some search results contain invalid UTF-8 in highlight field","user":{"login":"emiksk","id":11749627,"node_id":"MDQ6VXNlcjExNzQ5NjI3","avatar_url":"https://avatars0.githubusercontent.com/u/11749627?v=4","gravatar_id":"","url":"https://api.github.com/users/emiksk","html_url":"https://github.com/emiksk","followers_url":"https://api.github.com/users/emiksk/followers","following_url":"https://api.github.com/users/emiksk/following{/other_user}","gists_url":"https://api.github.com/users/emiksk/gists{/gist_id}","starred_url":"https://api.github.com/users/emiksk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/emiksk/subscriptions","organizations_url":"https://api.github.com/users/emiksk/orgs","repos_url":"https://api.github.com/users/emiksk/repos","events_url":"https://api.github.com/users/emiksk/events{/privacy}","received_events_url":"https://api.github.com/users/emiksk/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-08-21T09:03:48Z","updated_at":"2019-08-22T04:24:40Z","closed_at":"2019-08-22T04:24:39Z","author_association":"NONE","active_lock_reason":null,"body":"## Description of the problem including expected versus actual behavior\r\nIn some rare cases, Elasticsearch returns a search result containing an invalid UTF-8 character (such as \"\\uD83C\") at the end of the highlight field.\r\nSome clients cannot handle a response like this; they throw an exception.\r\n\r\nI posted the same issue to elastic/elasticsearch-php#934 too.\r\n#9538 (a little similar issue) is tagged as \"won't fix\" because the guidance says \"don't put invalid utf-8 in the index if you can't handle it\". However, I'm following the guidance in the case of this issue.\r\n\r\nCould you help me work around this problem?\r\nThank you.\r\n\r\n## Environment\r\nI could reproduce this issue with the the docker image, elasticsearch/6.8.0:d0b291d7093b.\r\n\r\n## Steps to reproduce\r\n 1. index.json: The settings and mappings for an index\r\n```\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"default\": {\r\n          \"filter\": [\r\n            \"cjk_bigram_filter\"\r\n          ],\r\n          \"tokenizer\": \"standard\"\r\n        }\r\n      },\r\n      \"filter\": {\r\n        \"cjk_bigram_filter\": {\r\n          \"type\": \"cjk_bigram\",\r\n          \"ignored_scripts\": [],\r\n          \"output_unigrams\": true\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"data\": {\r\n          \"type\": \"text\",\r\n          \"term_vector\": \"with_positions_offsets\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n 2. document.json: The document data for testing\r\n```\r\n{\r\n  \"data\": \"【This is the text for reproducing the issue】\r\n【今日の作業】\r\n・10:00-11:30 ミーティング（フリースペース）\r\n・13:00-13:30 🌸タスク🌸:定型データ入力\r\n・13:30-14:00 ...\"\r\n}\r\n```\r\n\r\n 3. search.json: The body to search\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": {\r\n        \"query_string\": {\r\n          \"query\": \"\\\"ミーティング\\\"\",\r\n          \"fields\": [\r\n            \"data\"\r\n          ],\r\n          \"default_operator\": \"and\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"pre_tags\": [\r\n      \"4bde2e4c-58b8-42fc-acaf-cb20f60fec4b\"\r\n    ],\r\n    \"post_tags\": [\r\n      \"ea7a3b14-470c-482b-a889-64ad09c26e92\"\r\n    ],\r\n    \"fragment_size\": 52,\r\n    \"number_of_fragments\": 1,\r\n    \"fields\": {\r\n      \"data\": {\r\n        \"fragment_size\": 52,\r\n        \"type\": \"fvh\"\r\n      }\r\n    },\r\n    \"highlight_query\": {\r\n      \"bool\": {\r\n        \"must\": {\r\n          \"query_string\": {\r\n            \"query\": \"\\\"ミーティング\\\"\",\r\n            \"fields\": [\r\n              \"data\"\r\n            ],\r\n            \"default_operator\": \"and\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n4. You can reproduce the issue by the following procedure.\r\n```\r\n# Elasticsearch v6.8.0 is running on localhost with the default port.\r\n$ curl -XPUT -H 'Content-Type: application/json' localhost:9200/test -d @index.json\r\n$ curl -XPOST -H 'Content-Type: application/json' localhost:9200/test/_doc/1 -d @document.json\r\n$ curl -XPOST -H 'Content-Type: application/json' localhost:9200/test/_search?pretty -d @search.json\r\n# The search result is... \r\n{\r\n  \"took\" : 26,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 4.7742524,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test\",\r\n        \"_type\" : \"doc\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 4.7742524,\r\n        \"_source\" : {\r\n          \"data\" : \"【This is the text for reproducing the issue】【今日の作業】・10:00-11:30  ミーティング（フリースペース）・13:00-13:30 \\uD83C\\uDF38タスク\\uD83C\\uDF38:定型データ入力・13:30-14:00 ...\"\r\n        },\r\n        \"highlight\" : {\r\n          \"data\" : [\r\n            \"issue】【今日の作業】・10:00-11:30 4bde2e4c-58b8-42fc-acaf-cb20f60fec4bミーティン グea7a3b14-470c-482b-a889-64ad09c26e92（フリースペース）・13:00-13:30 \\uD83C\"\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nThe above search result contains the invalid UTF-8 character, \"\\uD83C\", at the end of highlight.data[0].\r\n\"data\"[0]: \"...・13:00-13:30 **\\uD83C**\"","closed_by":{"login":"emiksk","id":11749627,"node_id":"MDQ6VXNlcjExNzQ5NjI3","avatar_url":"https://avatars0.githubusercontent.com/u/11749627?v=4","gravatar_id":"","url":"https://api.github.com/users/emiksk","html_url":"https://github.com/emiksk","followers_url":"https://api.github.com/users/emiksk/followers","following_url":"https://api.github.com/users/emiksk/following{/other_user}","gists_url":"https://api.github.com/users/emiksk/gists{/gist_id}","starred_url":"https://api.github.com/users/emiksk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/emiksk/subscriptions","organizations_url":"https://api.github.com/users/emiksk/orgs","repos_url":"https://api.github.com/users/emiksk/repos","events_url":"https://api.github.com/users/emiksk/events{/privacy}","received_events_url":"https://api.github.com/users/emiksk/received_events","type":"User","site_admin":false},"performed_via_github_app":null}