{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16158","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16158/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16158/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16158/events","html_url":"https://github.com/elastic/elasticsearch/issues/16158","id":128003803,"node_id":"MDU6SXNzdWUxMjgwMDM4MDM=","number":16158,"title":"Snapshot to Azure Blob-storage is failing with IndexShardSnapshotFailedException (nested: IOException; nested: StorageException)","user":{"login":"tejasavora","id":1454824,"node_id":"MDQ6VXNlcjE0NTQ4MjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1454824?v=4","gravatar_id":"","url":"https://api.github.com/users/tejasavora","html_url":"https://github.com/tejasavora","followers_url":"https://api.github.com/users/tejasavora/followers","following_url":"https://api.github.com/users/tejasavora/following{/other_user}","gists_url":"https://api.github.com/users/tejasavora/gists{/gist_id}","starred_url":"https://api.github.com/users/tejasavora/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tejasavora/subscriptions","organizations_url":"https://api.github.com/users/tejasavora/orgs","repos_url":"https://api.github.com/users/tejasavora/repos","events_url":"https://api.github.com/users/tejasavora/events{/privacy}","received_events_url":"https://api.github.com/users/tejasavora/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-01-21T19:42:21Z","updated_at":"2018-02-14T13:53:26Z","closed_at":"2016-07-04T11:10:45Z","author_association":"NONE","active_lock_reason":null,"body":"I am trying to take a snapshot of our existing indices to Azure Cloud Storage and it is failing with `IndexShardSnapshotFailedException (nested: IOException; nested: StorageException)`\n\nWe are using:\n`ES Version: 2.1.1`\n`Cloud-Azure Version: Latest (2.1.1)` - installed using `plugin install cloud-azure`\n\nConfiguration in `elasticsearch.yml` is:\n\n```\ncloud:\n    azure:\n        storage:\n            account: \"azurecloudstoragenameXXX\"\n            key: \"azurecloudstoragekeyXXX\"\n```\n\nI am trying to create a new repository using following:\n\n```\nPUT _snapshot/onazure?verify=false\n{\n  \"type\" : \"azure\",\n  \"settings\" : {\n    \"container\" : \"esbackup\",\n    \"compressed\" : true\n  }\n}\n```\n\nOnce the repository has been created, I am trying to take a snapshot using following:\n\n```\nPUT _snapshot/onazure/snapshot-1-01212016-1920\n{\n  \"indices\": [\n    \"index1\",\n    \"index2\",\n    \"index3\",\n    \"index4\"\n  ]\n}\n```\n\nEvery time, I am trying to take a snapshot, it is failing with the following exception and fails to take a snapshot. Exception:\n\n```\n[2016-01-21 19:19:03,328][WARN ][snapshots                ] [node-1] [[index1][1]] [onazure:snapshot-1-01212016-1920] failed to create snapshot\n[index1][[index1][1]] IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: IOException; nested: StorageException[Value for one of the query parameters specified in the request URI is invalid.];\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$SnapshotContext.snapshot(BlobStoreIndexShardRepository.java:606)\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.snapshot(BlobStoreIndexShardRepository.java:191)\n    at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:340)\n    at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:76)\n    at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:296)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.io.IOException\n    at com.microsoft.azure.storage.core.Utility.initIOException(Utility.java:598)\n    at com.microsoft.azure.storage.blob.BlobOutputStream$1.call(BlobOutputStream.java:374)\n    at com.microsoft.azure.storage.blob.BlobOutputStream$1.call(BlobOutputStream.java:358)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    ... 3 more\nCaused by: com.microsoft.azure.storage.StorageException: Value for one of the query parameters specified in the request URI is invalid.\n    at com.microsoft.azure.storage.StorageException.translateException(StorageException.java:162)\n    at com.microsoft.azure.storage.core.StorageRequest.materializeException(StorageRequest.java:307)\n    at com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:177)\n    at com.microsoft.azure.storage.blob.CloudBlockBlob.uploadBlockInternal(CloudBlockBlob.java:714)\n    at com.microsoft.azure.storage.blob.CloudBlockBlob.uploadBlock(CloudBlockBlob.java:686)\n    at com.microsoft.azure.storage.blob.BlobOutputStream$1.call(BlobOutputStream.java:362)\n    ... 7 more\n[2016-01-21 19:19:04,407][INFO ][snapshots                ] [node-1] snapshot [onazure:snapshot-1-01212016-1920] is done\n```\n\nI tried running the snapshot with only one index which has almost (250 GB) of data, and it is still failing.\n\nHowever, if I use an index (individually or in group while taking a snapshot) which is almost ~5MB in size, I do not get any exception from log. It says: snapshot is done - however, if I check the `esbackup` container underneath the blob storage, it does not contain any blobs.\n\nAlso, tried with `\"compressed\": false` setting and it is not working with that setting as well.\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}