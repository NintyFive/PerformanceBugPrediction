{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54865","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54865/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54865/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54865/events","html_url":"https://github.com/elastic/elasticsearch/issues/54865","id":595705024,"node_id":"MDU6SXNzdWU1OTU3MDUwMjQ=","number":54865,"title":"Java sniffer client breaks when \"Accept-Encoding\" is used as a default header","user":{"login":"ollik1","id":19903912,"node_id":"MDQ6VXNlcjE5OTAzOTEy","avatar_url":"https://avatars1.githubusercontent.com/u/19903912?v=4","gravatar_id":"","url":"https://api.github.com/users/ollik1","html_url":"https://github.com/ollik1","followers_url":"https://api.github.com/users/ollik1/followers","following_url":"https://api.github.com/users/ollik1/following{/other_user}","gists_url":"https://api.github.com/users/ollik1/gists{/gist_id}","starred_url":"https://api.github.com/users/ollik1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ollik1/subscriptions","organizations_url":"https://api.github.com/users/ollik1/orgs","repos_url":"https://api.github.com/users/ollik1/repos","events_url":"https://api.github.com/users/ollik1/events{/privacy}","received_events_url":"https://api.github.com/users/ollik1/received_events","type":"User","site_admin":false},"labels":[{"id":407508641,"node_id":"MDU6TGFiZWw0MDc1MDg2NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20Low%20Level%20REST%20Client","name":":Core/Features/Java Low Level REST Client","color":"0e8a16","default":false,"description":"Minimal dependencies Java Client for Elasticsearch"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-04-07T08:54:04Z","updated_at":"2020-09-04T16:47:09Z","closed_at":"2020-09-04T16:43:13Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.3.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): openjdk version \"11.0.6\" 2020-01-14 LTS\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):Linux 4.9.87-linuxkit-aufs #1 SMP Wed Mar 14 15:12:16 UTC 2018 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**: When using the Java sniffer client with a default header `Accept-Encoding: gzip`, a JSON deserialization exception is thrown when parsing the response. The sniffer should either clear the header or handle the compressed response. Also throwing an exception when building the sniffer with a REST client with such a default header would be an improvement. In its current state the error message is quite confusing.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. `RestClientBuilder builder = RestClient.builder(...).setDefaultHeaders(new Header[] {new BasicHeader(HttpHeaders.ACCEPT_ENCODING, \"gzip\")});`\r\n 2. `new ElasticsearchNodesSniffer(restClient).sniff();`\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\ncom.fasterxml.jackson.core.JsonParseException: Illegal character ((CTRL-CHAR, code 31)): only regular white space (\\r, \\n, \\t) is allowed between tokens\r\n at [Source: (org.apache.http.nio.entity.ContentInputStream); line: 1, column: 2]\r\n\r\n\tat com.fasterxml.jackson.core.JsonParser._constructError(JsonParser.java:1840)\r\n\tat com.fasterxml.jackson.core.base.ParserMinimalBase._reportError(ParserMinimalBase.java:712)\r\n\tat com.fasterxml.jackson.core.base.ParserMinimalBase._throwInvalidSpace(ParserMinimalBase.java:690)\r\n\tat com.fasterxml.jackson.core.json.UTF8StreamJsonParser._skipWSOrEnd(UTF8StreamJsonParser.java:2976)\r\n\tat com.fasterxml.jackson.core.json.UTF8StreamJsonParser.nextToken(UTF8StreamJsonParser.java:716)\r\n\tat org.elasticsearch.client.sniff.ElasticsearchNodesSniffer.readHosts(ElasticsearchNodesSniffer.java:111)\r\n\tat org.elasticsearch.client.sniff.ElasticsearchNodesSniffer.sniff(ElasticsearchNodesSniffer.java:105)\r\n```\r\n","closed_by":{"login":"swallez","id":213730,"node_id":"MDQ6VXNlcjIxMzczMA==","avatar_url":"https://avatars2.githubusercontent.com/u/213730?v=4","gravatar_id":"","url":"https://api.github.com/users/swallez","html_url":"https://github.com/swallez","followers_url":"https://api.github.com/users/swallez/followers","following_url":"https://api.github.com/users/swallez/following{/other_user}","gists_url":"https://api.github.com/users/swallez/gists{/gist_id}","starred_url":"https://api.github.com/users/swallez/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/swallez/subscriptions","organizations_url":"https://api.github.com/users/swallez/orgs","repos_url":"https://api.github.com/users/swallez/repos","events_url":"https://api.github.com/users/swallez/events{/privacy}","received_events_url":"https://api.github.com/users/swallez/received_events","type":"User","site_admin":false},"performed_via_github_app":null}