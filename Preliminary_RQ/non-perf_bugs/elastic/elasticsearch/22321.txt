{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22321/events","html_url":"https://github.com/elastic/elasticsearch/issues/22321","id":197137403,"node_id":"MDU6SXNzdWUxOTcxMzc0MDM=","number":22321,"title":"index_out_of_bounds_exception and null_pointer_exception in nested aggregates (global -> terms -> top_hits)","user":{"login":"Chakrygin","id":6216874,"node_id":"MDQ6VXNlcjYyMTY4NzQ=","avatar_url":"https://avatars2.githubusercontent.com/u/6216874?v=4","gravatar_id":"","url":"https://api.github.com/users/Chakrygin","html_url":"https://github.com/Chakrygin","followers_url":"https://api.github.com/users/Chakrygin/followers","following_url":"https://api.github.com/users/Chakrygin/following{/other_user}","gists_url":"https://api.github.com/users/Chakrygin/gists{/gist_id}","starred_url":"https://api.github.com/users/Chakrygin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Chakrygin/subscriptions","organizations_url":"https://api.github.com/users/Chakrygin/orgs","repos_url":"https://api.github.com/users/Chakrygin/repos","events_url":"https://api.github.com/users/Chakrygin/events{/privacy}","received_events_url":"https://api.github.com/users/Chakrygin/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2016-12-22T10:03:49Z","updated_at":"2018-01-05T10:41:37Z","closed_at":"2018-01-05T10:41:37Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.1\r\n\r\n**Plugins installed**: -\r\n\r\n**JVM version**: jre1.8.0_111\r\n\r\n**OS version**: Windows 7, Ubuntu 16\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nindex_out_of_bounds_exception in nested aggregates (global -> terms -> top_hits)\r\n\r\n**Steps to reproduce**:\r\n 1. Test data:\r\n\r\n\r\n```\r\nPOST _bulk\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206357\"}}\r\n{\"id\":21206357,\"name\":\"AEG PW 5570 FA Inox, 5 in 1 напольные весы\",\"content\":\"AEG PW 5570 FA Inox, 5 in 1 напольные весы,Напольные весы,AEG\",\"brand_id\":24566662,\"brand_name\":\"AEG\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206358\"}}\r\n{\"id\":21206358,\"name\":\"AEG PW 5571 FA Glas, 6 in 1 напольные весы\",\"content\":\"AEG PW 5571 FA Glas, 6 in 1 напольные весы,Напольные весы,AEG\",\"brand_id\":24566662,\"brand_name\":\"AEG\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206499\"}}\r\n{\"id\":21206499,\"name\":\"Clatronic PW 3368, Glas напольные весы\",\"content\":\"Clatronic PW 3368, Glas напольные весы,Напольные весы,Clatronic\",\"brand_id\":26303064,\"brand_name\":\"Clatronic\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206500\"}}\r\n{\"id\":21206500,\"name\":\"Clatronic PW 3369, Black Glas напольные весы\",\"content\":\"Clatronic PW 3369, Black Glas напольные весы,Напольные весы,Clatronic\",\"brand_id\":26303064,\"brand_name\":\"Clatronic\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206501\"}}\r\n{\"id\":21206501,\"name\":\"Clatronic PW 3370 напольные весы\",\"content\":\"Clatronic PW 3370 напольные весы,Напольные весы,Clatronic\",\"brand_id\":26303064,\"brand_name\":\"Clatronic\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21891718\"}}\r\n{\"id\":21891718,\"name\":\"Vitek VT-1983(BK) весы напольные\",\"content\":\"Vitek VT-1983(BK) весы напольные,Напольные весы,Vitek,dbntr витэк витек мшеул\",\"brand_id\":26303458,\"brand_name\":\"Vitek\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"22452029\"}}\r\n{\"id\":22452029,\"name\":\"Vitek VT-1986, Green весы напольные\",\"content\":\"Vitek VT-1986, Green весы напольные,Напольные весы,Vitek,dbntr витэк витек мшеул\",\"brand_id\":26303458,\"brand_name\":\"Vitek\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"22453024\"}}\r\n{\"id\":22453024,\"name\":\"Tefal PP1121 Classic Fashion Love напольные весы\",\"content\":\"Tefal PP1121 Classic Fashion Love напольные весы,Напольные весы,Tefal,Тефаль, Тефал\",\"brand_id\":18819636,\"brand_name\":\"Tefal\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"33677014\"}}\r\n{\"id\":33677014,\"name\":\"Вытяжка классическая ELIKOR Бельведер 60П-650-П3Г бежевый/дуб неокр\",\"content\":\"Вытяжка классическая ELIKOR Бельведер 60П-650-П3Г бежевый/дуб неокр,Вытяжка,Каминная,Пристенная,Elikor,ELIKOR\",\"brand_id\":24595342,\"brand_name\":\"Elikor\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037591\"}}\r\n{\"id\":35037591,\"name\":\"Lacroix для iPhone 5/5S Paseo Hard Black\",\"content\":\"Lacroix для iPhone 5/5S Paseo Hard Black,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037593\"}}\r\n{\"id\":35037593,\"name\":\"Lacroix для iPhone 5/5S Paseo Hard Gold\",\"content\":\"Lacroix для iPhone 5/5S Paseo Hard Gold,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037595\"}}\r\n{\"id\":35037595,\"name\":\"Lacroix для iPhone 5/5S Suiting Folio Black\",\"content\":\"Lacroix для iPhone 5/5S Suiting Folio Black,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037599\"}}\r\n{\"id\":35037599,\"name\":\"Lacroix для iPhone 6/6S Butterfly Hard Pink\",\"content\":\"Lacroix для iPhone 6/6S Butterfly Hard Pink,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037601\"}}\r\n{\"id\":35037601,\"name\":\"Lacroix для iPhone 6/6S Paseo Hard Gold\",\"content\":\"Lacroix для iPhone 6/6S Paseo Hard Gold,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037619\"}}\r\n{\"id\":35037619,\"name\":\"Lacroix для iPhone 6+/6S+ Butterfly Hard Black\",\"content\":\"Lacroix для iPhone 6+/6S+ Butterfly Hard Black,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037621\"}}\r\n{\"id\":35037621,\"name\":\"Lacroix для iPhone 6+/6S+Butterfly Hard White\",\"content\":\"Lacroix для iPhone 6+/6S+Butterfly Hard White,Чехол для сотового телефона,Чехол,ChristianLacroix\",\"brand_id\":35037587,\"brand_name\":\"ChristianLacroix\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037629\"}}\r\n{\"id\":35037629,\"name\":\"Kenzo для iPhone 5/5S Big K Folio Kaki\",\"content\":\"Kenzo для iPhone 5/5S Big K Folio Kaki,Чехол для сотового телефона,Чехол,Kenzo,кензо кинзо cenzo лутящ rtypj\",\"brand_id\":18571406,\"brand_name\":\"Kenzo\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037635\"}}\r\n{\"id\":35037635,\"name\":\"Kenzo для iPhone 5/5S Chick Flip Blue\",\"content\":\"Kenzo для iPhone 5/5S Chick Flip Blue,Чехол для сотового телефона,Чехол,Kenzo,кензо кинзо cenzo лутящ rtypj\",\"brand_id\":18571406,\"brand_name\":\"Kenzo\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037649\"}}\r\n{\"id\":35037649,\"name\":\"Kenzo для iPhone 5/5S Leo Pack (folio+covers)\",\"content\":\"Kenzo для iPhone 5/5S Leo Pack (folio+covers),Чехол для сотового телефона,Чехол,Kenzo,кензо кинзо cenzo лутящ rtypj\",\"brand_id\":18571406,\"brand_name\":\"Kenzo\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"35037661\"}}\r\n{\"id\":35037661,\"name\":\"Kenzo для iPhone 5/5S/5SE Tiger Hard Violine\",\"content\":\"Kenzo для iPhone 5/5S/5SE Tiger Hard Violine,Чехол для сотового телефона,Чехол,Kenzo,кензо кинзо cenzo лутящ rtypj\",\"brand_id\":18571406,\"brand_name\":\"Kenzo\"}\r\n```\r\n\r\n 2. Search request:\r\n\r\n\r\n```\r\nPOST /test/test/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"multi_match\": {\r\n            \"query\": \"apple iphone\",\r\n            \"fields\": [\r\n              \"name\",\r\n              \"content\"\r\n            ]\r\n          }\r\n        }\r\n      ],\r\n      \"filter\": [\r\n        {\r\n          \"term\": {\r\n            \"brand_id\": {\r\n              \"value\": 26303000\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"global\": {\r\n      \"global\": {},\r\n      \"aggs\": {\r\n        \"brand\": {\r\n          \"terms\": {\r\n            \"field\": \"brand_id\"\r\n          },\r\n          \"aggs\": {\r\n            \"name\": {\r\n              \"top_hits\": {\r\n                \"size\": 1\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n 3. Error:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"index_out_of_bounds_exception\",\r\n        \"reason\": null\r\n      },\r\n      {\r\n        \"type\": \"null_pointer_exception\",\r\n        \"reason\": null\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"test\",\r\n        \"node\": \"LgkZnevWR1CcVVbV9ybVPA\",\r\n        \"reason\": {\r\n          \"type\": \"index_out_of_bounds_exception\",\r\n          \"reason\": null\r\n        }\r\n      },\r\n      {\r\n        \"shard\": 3,\r\n        \"index\": \"test\",\r\n        \"node\": \"LgkZnevWR1CcVVbV9ybVPA\",\r\n        \"reason\": {\r\n          \"type\": \"null_pointer_exception\",\r\n          \"reason\": null\r\n        }\r\n      }\r\n    ],\r\n    \"caused_by\": {\r\n      \"type\": \"index_out_of_bounds_exception\",\r\n      \"reason\": null\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nnull_pointer_exception in nested aggregates (global -> terms -> top_hits)\r\n\r\n\r\n**Steps to reproduce**:\r\n 1. Test data:\r\n\r\n\r\n```\r\nPOST _bulk\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206358\"}}\r\n{\"id\":21206358,\"name\":\"AEG PW 5571 FA Glas, 6 in 1 напольные весы\",\"content\":\"AEG PW 5571 FA Glas, 6 in 1 напольные весы,Напольные весы,AEG\",\"brand_id\":24566662,\"brand_name\":\"AEG\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21206500\"}}\r\n{\"id\":21206500,\"name\":\"Clatronic PW 3369, Black Glas напольные весы\",\"content\":\"Clatronic PW 3369, Black Glas напольные весы,Напольные весы,Clatronic\",\"brand_id\":26303064,\"brand_name\":\"Clatronic\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"21891718\"}}\r\n{\"id\":21891718,\"name\":\"Vitek VT-1983(BK) весы напольные\",\"content\":\"Vitek VT-1983(BK) весы напольные,Напольные весы,Vitek,dbntr витэк витек мшеул\",\"brand_id\":26303458,\"brand_name\":\"Vitek\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"22453024\"}}\r\n{\"id\":22453024,\"name\":\"Tefal PP1121 Classic Fashion Love напольные весы\",\"content\":\"Tefal PP1121 Classic Fashion Love напольные весы,Напольные весы,Tefal,Тефаль, Тефал\",\"brand_id\":18819636,\"brand_name\":\"Tefal\"}\r\n{\"index\":{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"33677014\"}}\r\n{\"id\":33677014,\"name\":\"Вытяжка классическая ELIKOR Бельведер 60П-650-П3Г бежевый/дуб неокр\",\"content\":\"Вытяжка классическая ELIKOR Бельведер 60П-650-П3Г бежевый/дуб неокр,Вытяжка,Каминная,Пристенная,Elikor,ELIKOR\",\"brand_id\":24595342,\"brand_name\":\"Elikor\"}\r\n```\r\n\r\n 2. Search request:\r\n\r\n(see above)\r\n\r\n 3. Error:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"null_pointer_exception\",\r\n        \"reason\": null\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"test\",\r\n        \"node\": \"LgkZnevWR1CcVVbV9ybVPA\",\r\n        \"reason\": {\r\n          \"type\": \"null_pointer_exception\",\r\n          \"reason\": null\r\n        }\r\n      }\r\n    ],\r\n    \"caused_by\": {\r\n      \"type\": \"null_pointer_exception\",\r\n      \"reason\": null\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}