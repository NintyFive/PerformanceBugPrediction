{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23476","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23476/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23476/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23476/events","html_url":"https://github.com/elastic/elasticsearch/issues/23476","id":211620317,"node_id":"MDU6SXNzdWUyMTE2MjAzMTc=","number":23476,"title":"Enriching context suggester to work with nested model","user":{"login":"nilabhsagar","id":20436609,"node_id":"MDQ6VXNlcjIwNDM2NjA5","avatar_url":"https://avatars0.githubusercontent.com/u/20436609?v=4","gravatar_id":"","url":"https://api.github.com/users/nilabhsagar","html_url":"https://github.com/nilabhsagar","followers_url":"https://api.github.com/users/nilabhsagar/followers","following_url":"https://api.github.com/users/nilabhsagar/following{/other_user}","gists_url":"https://api.github.com/users/nilabhsagar/gists{/gist_id}","starred_url":"https://api.github.com/users/nilabhsagar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nilabhsagar/subscriptions","organizations_url":"https://api.github.com/users/nilabhsagar/orgs","repos_url":"https://api.github.com/users/nilabhsagar/repos","events_url":"https://api.github.com/users/nilabhsagar/events{/privacy}","received_events_url":"https://api.github.com/users/nilabhsagar/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2017-03-03T08:04:03Z","updated_at":"2018-02-14T13:26:39Z","closed_at":"2017-04-21T14:10:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The nested model presents great capability, however when it comes to context suggestion on nested model, presently there is no way to provide nested fields as context. Because of this limitation user has to manually construct and index context values. Also, To retain the hierarchical relation these context values need to be indexed as a separate type. This increases complexity and maintenance effort and is relatively slow. The below example shows the above problem:\r\n\r\nIn the example user types in \"Dennis\" with a pre selected context(ProdName) value as \"Health Plan One\". We can see the problem in the current vs expected output.\r\n\r\n![image](https://cloud.githubusercontent.com/assets/20436609/23542956/ed6ab71a-0015-11e7-9cd7-06e28687b35f.png)\r\n\r\n\r\nThis feature aims to solve above problem.  \r\n\r\nAddresses this: https://discuss.elastic.co/t/context-suggestor-in-elastic-search-applied-on-the-nested-fields/44946\r\n\r\n**Features**\r\n\r\n- **Flexible Filtering:** Suggestions should be filtered with fields specified as filters in the mapping.\r\n- **Read Input from other Fields:** This enables the suggester field values to be picked from other input fields in the documents, however the old behavior of inline input values being specified in the suggest field will be supported as well.\r\n- **Nested Support:** Both the suggest field and the filters can be nested to any level.\r\n\r\nMapping, Query and Response interfaces will follow/extend the interfaces of context suggester.\r\n\r\n## Proposed Mapping\r\nFor this functionality to work a field of type \"filteredsuggest\" can be defined at mapping time.\r\n**Format:**\r\n```\r\n{\r\n       ...\r\n      \"suggest_field_name\": {\r\n      \"type\": \"filteredsuggest\",\r\n      \"parent_path\": <Nested path for this suggestion field>,\r\n      \"input_fields\": \"Read suggestion value from field/(s),\r\n      \"filters\": {\r\n        <Category filters>\r\n      }\r\n    }\r\n}\r\n```\r\n**Filters**\r\nFilters suggestions by criteria considering the nested hierarchy. At present the supported filter type is \"category\". This will be defined as below:\r\n```\r\n\"filters\": {\r\n\t\"Name-of-filter\": {\r\n\t  \"type\": \"category\",\r\n\t  \"path\": \"Field path reference to read the filter value\"\r\n\t},\r\n\t...\r\n}\r\n```\r\n### Example\r\nFollowing shows a field mapping for a filteredsuggest field named \"name_suggest\" defined at root level:\r\n\r\n```\r\nPUT {INDEX_NAME}  \r\n{\r\n  \"mappings\": {\r\n    \"Provider\": {\r\n      \"properties\": {\r\n        \"name\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"Products\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"ProdName\": {\r\n              \"type\": \"text\"\r\n            },\r\n            \"ProdType\": {\r\n              \"type\": \"text\"\r\n            },\r\n            \"Hospitals\": {\r\n              \"type\": \"nested\",\r\n              \"properties\": {\r\n                \"HospName\": {\r\n                  \"type\": \"text\"\r\n                },\r\n                \"HospType\": {\r\n                  \"type\": \"text\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"name_suggest\": {\r\n          \"type\": \"filteredsuggest\",\r\n          \"parent_path\": \"\",\r\n          \"input_fields\": \"name\",\r\n          \"filters\": {\r\n            \"ProdType\": {\r\n              \"type\": \"category\",\r\n              \"path\": \"Products.ProdType\"\r\n            },\r\n            \"HospType\": {\r\n              \"type\": \"category\",\r\n              \"path\": \"Products.Hospitals.HospType\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nFollowing shows a field mapping for a filteredsuggest field named \"hosp_name_suggest\" defined at Hospital level:\r\n\r\n```\r\nPUT {INDEX_NAME} \r\n{\r\n  \"mappings\": {\r\n    \"Provider\": {\r\n      \"properties\": {\r\n        \"name\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"Products\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"ProdName\": {\r\n              \"type\": \"text\"\r\n            },\r\n            \"ProdType\": {\r\n              \"type\": \"text\"\r\n            },\r\n            \"Hospitals\": {\r\n              \"type\": \"nested\",\r\n              \"properties\": {\r\n                \"HospName\": {\r\n                  \"type\": \"text\"\r\n                },\r\n                \"HospType\": {\r\n                  \"type\": \"text\"\r\n                },\r\n                \"hosp_name_suggest\": {\r\n                  \"type\": \"filteredsuggest\",\r\n                  \"parent_path\": \"Products.Hospitals\",\r\n                  \"input_fields\": \"Products.Hospitals.HospName\",\r\n                  \"filters\": {\r\n                    \"ProdType\": {\r\n                      \"type\": \"category\",\r\n                      \"path\": \"Products.ProdType\"\r\n                    },\r\n                    \"HospType\": {\r\n                      \"type\": \"category\",\r\n                      \"path\": \"Products.Hospitals.HospType\"\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## Proposed Indexing\r\n\r\nAt index time a document may or may not have suggest field instance. By default the suggest field input and filter values will be picked from the referenced fields as per mapping. This may be overridden by explicitly specifying the suggest field at document level and providing values for input.\r\n\r\nIndex Document with explicit input values for name_suggest mapping - document 1\r\n```\r\nPOST {INDEX_NAME}/{TYPE_NAME}\r\n{\r\n  \"name\": \"Simon\",\r\n  \"Products\": [\r\n    {\r\n      \"ProdName\": \"Health Plan One\",\r\n      \"ProdType\": \"TypeA\",\r\n      \"Hospitals\": [\r\n        {\r\n          \"HospName\": \"Sakara hospital\",\r\n          \"HospType\": \"MultiSpec\"\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"ProdName\": \"Health Plan One EEE\",\r\n      \"ProdType\": \"TypeB\",\r\n      \"Hospitals\": [\r\n        {\r\n          \"HospName\": \"Sagar hospital\",\r\n          \"HospType\": \"Specialist-Heart\"\r\n        }\r\n      ]\r\n    }\r\n  ],\r\n  \"name_suggest\": {\r\n    \"input\": [\"Simon\",\"Simon Robinson\",\"Samuel\"]\r\n  }\r\n}\r\n```\r\n\r\nSuggest Field Input Derived from other fields for name_suggest, hosp_name_suggest mapping- document 2\r\n```\r\nPOST {INDEX_NAME}/{TYPE_NAME}\r\n{\r\n  \"name\": \"Simon\",\r\n  \"Products\": [\r\n    {\r\n      \"ProdName\": \"Health Plan One\",\r\n      \"ProdType\": \"TypeA\",\r\n      \"Hospitals\": [\r\n        {\r\n          \"HospName\": \"Sakara hospital\",\r\n          \"HospType\": \"MultiSpec\"\r\n        }\r\n      ]\r\n    },\r\n    {\r\n      \"ProdName\": \"Health Plan One EEE\",\r\n      \"ProdType\": \"TypeB\",\r\n      \"Hospitals\": [\r\n        {\r\n          \"HospName\": \"Sagar hospital\",\r\n          \"HospType\": \"Specialist-Heart\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n## Proposed Query\r\n\r\nWithout filters - name_suggest; with document 1 indexed\r\n```\r\nPOST {INDEX}/_search\r\n{\r\n  \"suggest\": {\r\n    \"name_suggestion\": {\r\n      \"prefix\": \"sim\",\r\n      \"filteredsuggest\": {\r\n        \"field\": \"name_suggest\",\r\n        \"size\": 10\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe response is as below:\r\n```\r\n{\r\n\t...\r\n\t\"suggest\" : {\r\n    \"name_suggestion\" : [\r\n      {\r\n        \"text\" : \"sim\",\r\n        \"offset\" : 0,\r\n        \"length\" : 3,\r\n        \"options\" : [\r\n          {\r\n            \"text\" : \"Simon\",\r\n            \"score\" : 1.0\r\n          },\r\n          {\r\n            \"text\" : \"Simon Robinson\",\r\n            \"score\" : 1.0\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nWith filters - name_suggest; with document 2 indexed\r\n```\r\nPOST {INDEX}/_search\r\n{\r\n  \"suggest\": {\r\n    \"name_suggestion\": {\r\n      \"prefix\": \"sim\",\r\n      \"filteredsuggest\": {\r\n        \"field\": \"name_suggest\",\r\n        \"size\": 10,\r\n        \"filters\": {\r\n          \"ProdType\": \"TypeB\",\r\n          \"HospType\": \"Specialist-Heart\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe response is as below:\r\n```\r\n{\r\n\t...\r\n\t\"suggest\" : {\r\n    \"name_suggestion\" : [\r\n      {\r\n        \"text\" : \"sim\",\r\n        \"offset\" : 0,\r\n        \"length\" : 3,\r\n        \"options\" : [\r\n          {\r\n            \"text\" : \"Simon\",\r\n            \"score\" : 1.0\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nWith filters and fuzziness - name_suggest; with document 1 indexed\r\n```\r\nPOST {INDEX}/_search\r\n{\r\n  \"suggest\": {\r\n    \"name_suggestion\": {\r\n      \"prefix\": \"sim\",\r\n      \"filteredsuggest\": {\r\n        \"field\": \"name_suggest\",\r\n        \"size\": 10,\r\n        \"fuzzy\": {\r\n          \"fuzziness\": 2\r\n        },\r\n        \"filters\": {\r\n          \"ProdType\": \"TypeB\",\r\n          \"HospType\": \"Specialist-Heart\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe response is as below:\r\n```\r\n{\r\n\t...\r\n\t\"suggest\" : {\r\n    \"name_suggestion\" : [\r\n      {\r\n        \"text\" : \"sim\",\r\n        \"offset\" : 0,\r\n        \"length\" : 3,\r\n        \"options\" : [\r\n          {\r\n            \"text\" : \"Samuel\",\r\n            \"score\" : 2.0\r\n          },\r\n          {\r\n            \"text\" : \"Simon\",\r\n            \"score\" : 2.0\r\n          },\r\n          {\r\n            \"text\" : \"Simon Robinson\",\r\n            \"score\" : 2.0\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nWithout filters - hosp_name_suggest; with document 2 indexed\r\n```\r\nPOST {INDEX}/_search\r\n{\r\n  \"suggest\": {\r\n    \"name_suggestion\": {\r\n      \"prefix\": \"sa\",\r\n      \"filteredsuggest\": {\r\n        \"field\": \"Products.Hospitals.hosp_name_suggest\",\r\n        \"size\": 10\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe response is as below:\r\n```\r\n{\r\n\t...\r\n\t\"suggest\" : {\r\n    \"name_suggestion\" : [\r\n      {\r\n        \"text\" : \"sa\",\r\n        \"offset\" : 0,\r\n        \"length\" : 2,\r\n        \"options\" : [\r\n          {\r\n            \"text\" : \"Sagar hospital\",\r\n            \"score\" : 1.0\r\n          },\r\n          {\r\n            \"text\" : \"Sakara hospital\",\r\n            \"score\" : 1.0\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nWith filters - hosp_name_suggest; with document 2 indexed\r\nPOST {INDEX}/_search\r\n```\r\n{\r\n  \"suggest\": {\r\n    \"name_suggestion\": {\r\n      \"prefix\": \"sa\",\r\n      \"filteredsuggest\": {\r\n        \"field\": \"Products.Hospitals.hosp_name_suggest\",\r\n        \"size\": 10,\r\n        \"filters\": {\r\n          \"ProdType\": \"TypeB\",\r\n          \"HospType\": \"Specialist-Heart\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe response is as below:\r\n```\r\n{\r\n\t...\r\n\t\"suggest\" : {\r\n    \"name_suggestion\" : [\r\n      {\r\n        \"text\" : \"sa\",\r\n        \"offset\" : 0,\r\n        \"length\" : 2,\r\n        \"options\" : [\r\n          {\r\n            \"text\" : \"Sagar hospital\",\r\n            \"score\" : 1.0\r\n          }\r\n        ]\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}