{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24192","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24192/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24192/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24192/events","html_url":"https://github.com/elastic/elasticsearch/issues/24192","id":222772273,"node_id":"MDU6SXNzdWUyMjI3NzIyNzM=","number":24192,"title":"gcs-repository snapshot creation times out systematically","user":{"login":"thaDude","id":578631,"node_id":"MDQ6VXNlcjU3ODYzMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/578631?v=4","gravatar_id":"","url":"https://api.github.com/users/thaDude","html_url":"https://github.com/thaDude","followers_url":"https://api.github.com/users/thaDude/followers","following_url":"https://api.github.com/users/thaDude/following{/other_user}","gists_url":"https://api.github.com/users/thaDude/gists{/gist_id}","starred_url":"https://api.github.com/users/thaDude/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thaDude/subscriptions","organizations_url":"https://api.github.com/users/thaDude/orgs","repos_url":"https://api.github.com/users/thaDude/repos","events_url":"https://api.github.com/users/thaDude/events{/privacy}","received_events_url":"https://api.github.com/users/thaDude/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-04-19T15:12:59Z","updated_at":"2017-04-19T15:41:35Z","closed_at":"2017-04-19T15:41:35Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.2.2\r\n**Plugins installed**: x-pack, repository-gcs, custom update plugin\r\n**JVM version**: 1.8.0_121\r\n**OS version**: Debian 8.7\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n`gcs-repository` snapshot creation times out systematically after 20-30 mins with 1-2 shards of 63 not being snapshot correctly. It is not always the same index/shards that fail.\r\n\r\nRepository configuration looks like:\r\n```\r\n{\r\n  \"type\": \"gcs\",\r\n  \"settings\": {\r\n    \"bucket\": \"backup.<replaced>.com\",\r\n    \"service_account\": \"_default_\",\r\n    \"base_path\": \"elasticsearch/snapshots-v5\",\r\n    \"compress\": \"true\",\r\n    \"max_snapshot_bytes_per_sec\": \"100mb\"\r\n  }\r\n}\r\n```\r\n\r\nWe never encountered this issue with filesystem-type snapshots. Total data size is ~180GB for 63 primary shards. We are not network bound when creating the snapshot. I am not sure the `max_snapshot_bytes_per_sec` value is taken into account for GCS snapshot creation but we are far from the 100mb/sec, typically between 20-40mb/sec. The cluster is typically not under heavy load at the time of snapshotting.\r\n\r\nThe logs look like:\r\n```\r\nelasticsearch[host-001][snapshot][T#3] WARN SnapshotShardsService - [[<idx_prefix_replaced>_4][0]] [gcs_repository:production-20170416/FRMNyP3cQ5Wac169TkoqCg] failed to create snapshot [<idx_prefix_replaced>_4/XUIEUgG-Q9yDguJXHHaVhw][[<idx_prefix_replaced>_4][0]] IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: SocketTimeoutException[Read timed out];\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1366)\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:961)\r\n    at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:382)\r\n    at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:88)\r\n    at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:335)\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshotFile(BlobStoreRepository.java:1422)\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1364)\r\nelasticsearch[host-003][snapshot][T#3] WARN SnapshotShardsService - [[<idx_prefix_replaced>_0][2]] [gcs_repository:production-20170416/FRMNyP3cQ5Wac169TkoqCg] failed to create snapshot [<idx_prefix_replaced>_0/mij0Os3cQHK936GRI32VyQ][[<idx_prefix_replaced>_0][2]] IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: GoogleJsonResponseException[503 Service Unavailable\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1366)\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:961)\r\n    at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:382)\r\n    at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:88)\r\n    at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:335)\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshotFile(BlobStoreRepository.java:1422)\r\n    at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1364)\r\nelasticsearch[host-004][clusterService#updateTask][T#1] INFO SnapshotShardsService - snapshot [gcs_repository:production-20170416/FRMNyP3cQ5Wac169TkoqCg] is done\r\n```\r\n\r\nand the snapshot REST API confirms this:\r\n```\r\n{\r\n  \"snapshots\": [\r\n    {\r\n      \"snapshot\": \"production-20170416\",\r\n      \"uuid\": \"FRMNyP3cQ5Wac169TkoqCg\",\r\n      \"version_id\": 5020299,\r\n      \"version\": \"5.2.2\",\r\n      \"indices\": [\r\n        <index>\r\n      ],\r\n      \"state\": \"PARTIAL\",\r\n      \"start_time\": \"2017-04-16T03:25:01.398Z\",\r\n      \"start_time_in_millis\": 1492313101398,\r\n      \"end_time\": \"2017-04-16T03:45:05.453Z\",\r\n      \"end_time_in_millis\": 1492314305453,\r\n      \"duration_in_millis\": 1204055,\r\n      \"failures\": [\r\n        {\r\n          \"index\": \"<idx_prefix_replaced>_4\",\r\n          \"index_uuid\": \"<idx_prefix_replaced>_4\",\r\n          \"shard_id\": 0,\r\n          \"reason\": \"IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: SocketTimeoutException[Read timed out]; \",\r\n          \"node_id\": \"fgf_Y7ZiQBSYmTg7vOeiHw\",\r\n          \"status\": \"INTERNAL_SERVER_ERROR\"\r\n        },\r\n        {\r\n          \"index\": \"<idx_prefix_replaced>_0\",\r\n          \"index_uuid\": \"<idx_prefix_replaced>_0\",\r\n          \"shard_id\": 2,\r\n          \"reason\": \"IndexShardSnapshotFailedException[Failed to perform snapshot (index files)]; nested: GoogleJsonResponseException[503 Service Unavailable\\nService Unavailable]; \",\r\n          \"node_id\": \"d1yE_amoTu6XF-6cPuL7SQ\",\r\n          \"status\": \"INTERNAL_SERVER_ERROR\"\r\n        }\r\n      ],\r\n      \"shards\": {\r\n        \"total\": 63,\r\n        \"failed\": 2,\r\n        \"successful\": 61\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nI inquired in the discussion [group](https://discuss.elastic.co/t/snapshot-to-gcs-repository-times-out/82768) without much success.","closed_by":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}