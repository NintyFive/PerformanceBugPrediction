{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46091","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46091/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46091/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46091/events","html_url":"https://github.com/elastic/elasticsearch/issues/46091","id":486531129,"node_id":"MDU6SXNzdWU0ODY1MzExMjk=","number":46091,"title":"CI failures due to indices not being cleaned up as expected","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"labels":[{"id":106454670,"node_id":"MDU6TGFiZWwxMDY0NTQ2NzA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Build","name":":Delivery/Build","color":"0e8a16","default":false,"description":"Build or test infrastructure"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":48,"created_at":"2019-08-28T18:07:25Z","updated_at":"2020-11-11T21:48:05Z","closed_at":"2019-09-20T14:39:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"There appears to be some kind of problem with the cleanup code that ensures all indices are cleaned up between tests. It's difficult to be sure, but there seems to be a trend of a wide variety of tests failing because of a `ResourceAlreadyExistsException` when creating an index with no visible cause in the test itself.\r\n\r\nI noticed this in [this master intake build](https://gradle-enterprise.elastic.co/s/2sowkhxgqyggu/), which is `IndexLifecycleIT.testStartStopILM`, which creates an index as one of the first operations it does - the cluster should be blank at this point.\r\n\r\nLooking at build stats for failures with messages containing `resource_already_exists_exception`, we can see it was very quiet prior to July 23, and has built more and more, suggesting this may be related to recent build changes:\r\n![Screen Shot 2019-08-28 at 11 56 40 AM](https://user-images.githubusercontent.com/1522844/63880409-eb306d00-c98a-11e9-9135-123215325052.png)\r\n[Note: This graph excludes a 10 minute period on Aug. 15 which had 608 failures, to make the scale clearer]\r\n\r\nThere is no clear relation between the tests which fail due to indices already existing that shouldn't and a specific functional area. It appears to happen most often to client and YAML tests, although not exclusively. In a few spot checks I've seen:\r\n- `IndexLifecycleIT.testStartStopILM`\r\n- `CCSDuelIT.testPagination`\r\n- `test {yaml=search/240_date_nanos/date_nanos requires dates after 1970 and before 2262}`\r\n- `IndicesClientIT.testCloseExistingIndex`\r\n- `DatafeedJobsRestIT.testLookbackWithGeo`\r\n\r\nAll of these appear to have failed while creating indices when the cluster should be a blank slate.\r\n\r\nI believe this is also the cause of https://github.com/elastic/elasticsearch/issues/45605 and https://github.com/elastic/elasticsearch/issues/45805","closed_by":{"login":"alpar-t","id":2565652,"node_id":"MDQ6VXNlcjI1NjU2NTI=","avatar_url":"https://avatars1.githubusercontent.com/u/2565652?v=4","gravatar_id":"","url":"https://api.github.com/users/alpar-t","html_url":"https://github.com/alpar-t","followers_url":"https://api.github.com/users/alpar-t/followers","following_url":"https://api.github.com/users/alpar-t/following{/other_user}","gists_url":"https://api.github.com/users/alpar-t/gists{/gist_id}","starred_url":"https://api.github.com/users/alpar-t/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alpar-t/subscriptions","organizations_url":"https://api.github.com/users/alpar-t/orgs","repos_url":"https://api.github.com/users/alpar-t/repos","events_url":"https://api.github.com/users/alpar-t/events{/privacy}","received_events_url":"https://api.github.com/users/alpar-t/received_events","type":"User","site_admin":false},"performed_via_github_app":null}