{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5021","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5021/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5021/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5021/events","html_url":"https://github.com/elastic/elasticsearch/issues/5021","id":26959460,"node_id":"MDU6SXNzdWUyNjk1OTQ2MA==","number":5021,"title":"Aggregations return different counts when invoked twice in a row","user":{"login":"thanodnl","id":273145,"node_id":"MDQ6VXNlcjI3MzE0NQ==","avatar_url":"https://avatars2.githubusercontent.com/u/273145?v=4","gravatar_id":"","url":"https://api.github.com/users/thanodnl","html_url":"https://github.com/thanodnl","followers_url":"https://api.github.com/users/thanodnl/followers","following_url":"https://api.github.com/users/thanodnl/following{/other_user}","gists_url":"https://api.github.com/users/thanodnl/gists{/gist_id}","starred_url":"https://api.github.com/users/thanodnl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thanodnl/subscriptions","organizations_url":"https://api.github.com/users/thanodnl/orgs","repos_url":"https://api.github.com/users/thanodnl/repos","events_url":"https://api.github.com/users/thanodnl/events{/privacy}","received_events_url":"https://api.github.com/users/thanodnl/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":74899026,"node_id":"MDU6TGFiZWw3NDg5OTAyNg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0","name":"v1.0.0","color":"dddddd","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2014-02-05T13:31:09Z","updated_at":"2014-02-07T08:53:01Z","closed_at":"2014-02-07T08:53:01Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi,\n\nA couple of days ago I started a thread on the mailing list (https://groups.google.com/forum/?fromgroups=#!topic/elasticsearch/c_xLCPOpvjc) about this issue, and the responses on it are slim.\n\nThe problem exists in the aggregations api since version 1.0.0.RC1 and is confirmed by me to also occur in 1.0.0.RC2.\n\nThe problem is that when you do a terms aggregation on an index sharded in multiple shards (10 in my case) it start to return inconsistent numbers. With this I mean that the numbers are different the second time compared to the first time. You cannot show these numbers to users as when they reload the analytics it shows totally different numbers than before without anything changing to the data.\n\nI created a test suit as a gist for you to recreate the problem your self. It is hosted at: https://gist.github.com/thanodnl/8803745.\n\nBut since it contains datafiles it is kind of bugged in the web interface of github. Best you can clone this gist by running: `$ git clone https://gist.github.com/8803745.git`\n\ncd into the newly created directory and run: `$ ./aggsbug.load.sh` to load the test set into your local database. This can take a couple of minutes since it is loading ~1M documents. I tried to recreate it with a smaller set, but then the issue is not appearing.\n\nOnce the data is loaded you can run a contained test with: `$ ./aggsbug.test.sh`. This will call the same aggregation twice, store the output, and later print the diff of the output.\n\nIf you recreated the bug the output of the test should be something like:\n\n```\n$ ./aggsbug.test.sh\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  1088  100   950  100   138    192     27  0:00:05  0:00:04  0:00:01   206\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  1086  100   948  100   138   2867    417 --:--:-- --:--:-- --:--:--  2872\ndiff in 2 aggs calls:\n2c2\n<   \"took\" : 4918,\n\n---\n>   \"took\" : 325,\n18c18\n<         \"doc_count\" : 3599\n\n---\n>         \"doc_count\" : 3228\n21c21\n<         \"doc_count\" : 2517\n\n---\n>         \"doc_count\" : 2254\n24c24\n<         \"doc_count\" : 2207\n\n---\n>         \"doc_count\" : 2007\n27c27\n<         \"doc_count\" : 2207\n\n---\n>         \"doc_count\" : 1971\n30c30\n<         \"doc_count\" : 1660\n\n---\n>         \"doc_count\" : 1478\n33c33\n<         \"doc_count\" : 1534\n\n---\n>         \"doc_count\" : 1401\n36c36\n<         \"doc_count\" : 1468\n\n---\n>         \"doc_count\" : 1330\n39c39\n<         \"doc_count\" : 1079\n\n---\n>         \"doc_count\" : 952\n```\n\nWhen ran against 1.0.0.Beta2 the output is what is to be expected:\n\n```\n$ ./aggsbug.test.sh\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  1087  100   949  100   138    208     30  0:00:04  0:00:04 --:--:--   208\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  1086  100   948  100   138   1525    222 --:--:-- --:--:-- --:--:--  1526\ndiff in 2 aggs calls:\n2c2\n<   \"took\" : 4525,\n\n---\n>   \"took\" : 611,\n```\n\nYou see the output of the aggs is not occurring in the diff during the test, and the only diff between the two runs is the time it took to calculate the result.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}