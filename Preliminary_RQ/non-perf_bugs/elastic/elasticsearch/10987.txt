{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10987","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10987/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10987/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10987/events","html_url":"https://github.com/elastic/elasticsearch/issues/10987","id":73345067,"node_id":"MDU6SXNzdWU3MzM0NTA2Nw==","number":10987,"title":"IllegalStateException on indexing with completion suggester","user":{"login":"Duetting","id":6123072,"node_id":"MDQ6VXNlcjYxMjMwNzI=","avatar_url":"https://avatars3.githubusercontent.com/u/6123072?v=4","gravatar_id":"","url":"https://api.github.com/users/Duetting","html_url":"https://github.com/Duetting","followers_url":"https://api.github.com/users/Duetting/followers","following_url":"https://api.github.com/users/Duetting/following{/other_user}","gists_url":"https://api.github.com/users/Duetting/gists{/gist_id}","starred_url":"https://api.github.com/users/Duetting/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Duetting/subscriptions","organizations_url":"https://api.github.com/users/Duetting/orgs","repos_url":"https://api.github.com/users/Duetting/repos","events_url":"https://api.github.com/users/Duetting/events{/privacy}","received_events_url":"https://api.github.com/users/Duetting/received_events","type":"User","site_admin":false},"labels":[{"id":146833729,"node_id":"MDU6TGFiZWwxNDY4MzM3Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Suggesters","name":":Search/Suggesters","color":"0e8a16","default":false,"description":"\"Did you mean\" and suggestions as you type"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"areek","id":753679,"node_id":"MDQ6VXNlcjc1MzY3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/753679?v=4","gravatar_id":"","url":"https://api.github.com/users/areek","html_url":"https://github.com/areek","followers_url":"https://api.github.com/users/areek/followers","following_url":"https://api.github.com/users/areek/following{/other_user}","gists_url":"https://api.github.com/users/areek/gists{/gist_id}","starred_url":"https://api.github.com/users/areek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/areek/subscriptions","organizations_url":"https://api.github.com/users/areek/orgs","repos_url":"https://api.github.com/users/areek/repos","events_url":"https://api.github.com/users/areek/events{/privacy}","received_events_url":"https://api.github.com/users/areek/received_events","type":"User","site_admin":false},"assignees":[{"login":"areek","id":753679,"node_id":"MDQ6VXNlcjc1MzY3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/753679?v=4","gravatar_id":"","url":"https://api.github.com/users/areek","html_url":"https://github.com/areek","followers_url":"https://api.github.com/users/areek/followers","following_url":"https://api.github.com/users/areek/following{/other_user}","gists_url":"https://api.github.com/users/areek/gists{/gist_id}","starred_url":"https://api.github.com/users/areek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/areek/subscriptions","organizations_url":"https://api.github.com/users/areek/orgs","repos_url":"https://api.github.com/users/areek/repos","events_url":"https://api.github.com/users/areek/events{/privacy}","received_events_url":"https://api.github.com/users/areek/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2015-05-05T15:25:25Z","updated_at":"2015-05-14T20:49:42Z","closed_at":"2015-05-14T20:49:41Z","author_association":"NONE","active_lock_reason":null,"body":"I'm getting a `java.lang.IllegalStateException: from state (0) already had transitions added` exception if i try to index certain documents with a mapping that has fields with `\"type\": \"completion\"`.\n\nThis happens at least in Version 1.5.1 and 1.5.2 and seems to work correctly up to 1.3.9.\n\nFirst i create a new index:\n`curl -XPUT localhost:9200/ses_firma/`\nThen i add the mapping with:\n`curl -s -XPUT localhost:9200/ses_firma/_mapping/firma --data-binary @MappingFirma.txt`\n\n```\n{\n    \"firma\": {\n        \"_source\": {\n            \"enabled\": false\n        },\n        \"_id\": {\n            \"path\": \"oid\",\n            \"store\": true\n        },\n        \"properties\": {\n            \"adressen\": {\n                \"properties\": {\n                    \"ort\": {\n                        \"type\": \"string\"\n                    },\n                    \"postleitzahl\": {\n                        \"type\": \"string\"\n                    },\n                    \"strasse\": {\n                        \"type\": \"string\"\n                    },\n                    \"bundesland\": {\n                        \"include_in_all\": false,\n                        \"properties\": {\n                            \"name\": {\n                                \"include_in_all\": false,\n                                \"type\": \"string\"\n                            }\n                        }\n                    },\n                    \"postfach\": {\n                        \"type\": \"string\"\n                    },\n                    \"land\": {\n                        \"include_in_all\": false,\n                        \"properties\": {\n                            \"iso\": {\n                                \"include_in_all\": false,\n                                \"type\": \"string\"\n                            },\n                            \"archiv\": {\n                                \"type\": \"boolean\"\n                            },\n                            \"name\": {\n                                \"include_in_all\": false,\n                                \"type\": \"string\"\n                            }\n                        }\n                    },\n                    \"oid\": {\n                        \"type\": \"string\"\n                    },\n                    \"postfachplz\": {\n                        \"type\": \"string\"\n                    }\n                }\n            },\n            \"bemerkung\": {\n                \"type\": \"string\",\n                \"fields\": {\n                    \"suggest\": {\n                        \"max_input_length\": 50,\n                        \"payloads\": false,\n                        \"analyzer\": \"simple\",\n                        \"context\": {\n                            \"type_context\": {\n                                \"path\": \"_type\",\n                                \"default\": [\n                                    \"*\"\n                                    ,\n                                    \"firma\"\n                                ],\n                                \"type\": \"category\"\n                            }\n                        },\n                        \"preserve_position_increments\": true,\n                        \"type\": \"completion\",\n                        \"preserve_separators\": true\n                    }\n                }\n            },\n            \"standardadresse\": {\n                \"properties\": {\n                    \"ort\": {\n                        \"type\": \"string\"\n                    },\n                    \"postleitzahl\": {\n                        \"type\": \"string\"\n                    },\n                    \"strasse\": {\n                        \"type\": \"string\"\n                    },\n                    \"bundesland\": {\n                        \"include_in_all\": false,\n                        \"properties\": {\n                            \"name\": {\n                                \"include_in_all\": false,\n                                \"type\": \"string\"\n                            }\n                        }\n                    },\n                    \"postfach\": {\n                        \"type\": \"string\"\n                    },\n                    \"land\": {\n                        \"include_in_all\": false,\n                        \"properties\": {\n                            \"iso\": {\n                                \"include_in_all\": false,\n                                \"type\": \"string\"\n                            },\n                            \"archiv\": {\n                                \"type\": \"boolean\"\n                            },\n                            \"name\": {\n                                \"include_in_all\": false,\n                                \"type\": \"string\"\n                            }\n                        }\n                    },\n                    \"oid\": {\n                        \"type\": \"string\"\n                    },\n                    \"postfachplz\": {\n                        \"type\": \"string\"\n                    }\n                }\n            },\n            \"abkuerzung\": {\n                \"type\": \"string\",\n                \"fields\": {\n                    \"suggest\": {\n                        \"max_input_length\": 50,\n                        \"payloads\": false,\n                        \"analyzer\": \"simple\",\n                        \"context\": {\n                            \"type_context\": {\n                                \"path\": \"_type\",\n                                \"default\": [\n                                    \"*\"\n                                    ,\n                                    \"firma\"\n                                ],\n                                \"type\": \"category\"\n                            }\n                        },\n                        \"preserve_position_increments\": true,\n                        \"type\": \"completion\",\n                        \"preserve_separators\": true\n                    }\n                }\n            },\n            \"telefonnummern\": {\n                \"properties\": {\n                    \"nummer\": {\n                        \"type\": \"string\"\n                    }\n                }\n            },\n            \"oid\": {\n                \"type\": \"string\"\n            },\n            \"email\": {\n                \"type\": \"string\",\n                \"fields\": {\n                    \"suggest\": {\n                        \"max_input_length\": 50,\n                        \"payloads\": false,\n                        \"analyzer\": \"keyword\",\n                        \"context\": {\n                            \"type_context\": {\n                                \"path\": \"_type\",\n                                \"default\": [\n                                    \"*\"\n                                    ,\n                                    \"firma\"\n                                ],\n                                \"type\": \"category\"\n                            }\n                        },\n                        \"preserve_position_increments\": true,\n                        \"type\": \"completion\",\n                        \"preserve_separators\": true\n                    }\n                }\n            },\n            \"firmenname\": {\n                \"type\": \"string\",\n                \"fields\": {\n                    \"suggest\": {\n                        \"max_input_length\": 50,\n                        \"payloads\": false,\n                        \"analyzer\": \"simple\",\n                        \"context\": {\n                            \"type_context\": {\n                                \"path\": \"_type\",\n                                \"default\": [\n                                    \"*\"\n                                    ,\n                                    \"firma\"\n                                ],\n                                \"type\": \"category\"\n                            }\n                        },\n                        \"preserve_position_increments\": true,\n                        \"type\": \"completion\",\n                        \"preserve_separators\": true\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nThen indexing the following documents:\n`curl -s -XPOST localhost:9200/_bulk --data-binary @BulkError.txt`\n\n```\n{\"index\":{\"_index\":\"ses_firma\",\"_type\":\"firma\",\"_version_type\":\"external_gte\",\"_version\":3}}\n{\"firmenname\":\"Alfred Reiter Bau GmbH\",\"abkuerzung\":\"ROTTMEIER\",\"email\":\"\",\"adressen\":[{\"strasse\":\"Salvatorbergstr. 21\",\"postleitzahl\":\"84048\",\"ort\":\"Mainburg\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Bayern\"},\"oid\":\"452d44ff-b34d-4f40-b5be-5169b2621960\"}],\"standardadresse\":{\"strasse\":\"Salvatorbergstr. 21\",\"postleitzahl\":\"84048\",\"ort\":\"Mainburg\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Bayern\"},\"oid\":\"452d44ff-b34d-4f40-b5be-5169b2621960\"},\"telefonnummern\":[{\"nummer\":\"08751/5171\"},{\"nummer\":\"08751/9400\"},{\"nummer\":\"0170/7369223\"},{\"nummer\":\"08751/9400\"},{\"nummer\":\"0170/2847356 Alfred\"}],\"bemerkung\":\"info@reiter-bau.de\",\"oid\":\"40d50149-aafa-4727-9c9b-0b95ae41d4bb\"}\n{\"index\":{\"_index\":\"ses_firma\",\"_type\":\"firma\",\"_version_type\":\"external_gte\",\"_version\":3}}\n{\"firmenname\":\"Volkswagen Bankdirect\",\"abkuerzung\":\"VOLKSWAGEN\",\"email\":\"\",\"adressen\":[{\"strasse\":\"Gifthorner Str. 57\",\"postleitzahl\":\"38112\",\"ort\":\"Braunschweig\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Niedersachsen\"},\"oid\":\"60672aff-dbb4-4291-9b3f-fd2ebc177cb6\"}],\"standardadresse\":{\"strasse\":\"Gifthorner Str. 57\",\"postleitzahl\":\"38112\",\"ort\":\"Braunschweig\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Niedersachsen\"},\"oid\":\"60672aff-dbb4-4291-9b3f-fd2ebc177cb6\"},\"telefonnummern\":[{\"nummer\":\"0531/2121732\"},{\"nummer\":\"0531/2122836\"},{\"nummer\":\"0531/2122880\"}],\"bemerkung\":\"VOLKSWAGEN\",\"oid\":\"2c1dc58b-e5a2-4513-aea6-1327714b07b8\"}\n{\"index\":{\"_index\":\"ses_firma\",\"_type\":\"firma\",\"_version_type\":\"external_gte\",\"_version\":3}}\n{\"firmenname\":\"Die Bayerische\",\"abkuerzung\":\"BBV\",\"email\":\"\",\"adressen\":[{\"strasse\":\"Thomas-Dehler-Str. 25\",\"postleitzahl\":\"81737\",\"ort\":\"München\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Bayern\"},\"oid\":\"1482071b-c049-4802-8a40-e37aba535317\"}],\"standardadresse\":{\"strasse\":\"Thomas-Dehler-Str. 25\",\"postleitzahl\":\"81737\",\"ort\":\"München\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Bayern\"},\"oid\":\"1482071b-c049-4802-8a40-e37aba535317\"},\"telefonnummern\":[{\"nummer\":\"Kfz 089/6787-2222\"},{\"nummer\":\"089/6787-0\"},{\"nummer\":\"089/6787-9150\"}],\"bemerkung\":\"BBV\",\"oid\":\"2786c191-b882-4c2d-a61f-1f962f74cdcd\"}\n```\n\nand i get the aforementioned error on all three documents. There are documents that work correctly but i can cut out all content (e. g. \"firmenname\":\"\") from all fields of these documents from above apart from the oid field and i nevertheless get the exception.\n\nHere is the call stack for one of the errors from the log file:\n\n```\n[2015-05-05 11:05:32,818][DEBUG][action.bulk              ] [Amina Synge] [ses_firma][0] failed to execute bulk item (index) index {[ses_firma][firma][40d50149-aafa-4727-9c9b-0b95ae41d4bb], source[{\"firmenname\":\"Alfred\",\"abkuerzung\":\"\",\"email\":\"\",\"adressen\":[{\"strasse\":\"Salvatorbergstr. 21\",\"postleitzahl\":\"84048\",\"ort\":\"Mainburg\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Bayern\"},\"oid\":\"452d44ff-b34d-4f40-b5be-5169b2621960\"}],\"standardadresse\":{\"strasse\":\"Salvatorbergstr. 21\",\"postleitzahl\":\"84048\",\"ort\":\"Mainburg\",\"land\":{\"name\":\"Deutschland\",\"iso\":\"DEU\",\"archiv\":false},\"bundesland\":{\"name\":\"Bayern\"},\"oid\":\"452d44ff-b34d-4f40-b5be-5169b2621960\"},\"telefonnummern\":[{\"nummer\":\"08751/5171\"},{\"nummer\":\"08751/9400\"},{\"nummer\":\"0170/7369223\"},{\"nummer\":\"08751/9400\"},{\"nummer\":\"0170/2847356 Alfred\"}],\"bemerkung\":\"\",\"oid\":\"40d50149-aafa-4727-9c9b-0b95ae41d4bb\"}\n]}\norg.elasticsearch.index.engine.IndexFailedEngineException: [ses_firma][0] Index failed for [firma#40d50149-aafa-4727-9c9b-0b95ae41d4bb]\n    at org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:368)\n    at org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:498)\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.shardIndexOperation(TransportShardBulkAction.java:427)\n    at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:149)\n    at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.performOnPrimary(TransportShardReplicationOperationAction.java:515)\n    at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction$1.run(TransportShardReplicationOperationAction.java:422)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(Unknown Source)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(Unknown Source)\n    at java.lang.Thread.run(Unknown Source)\nCaused by: java.lang.IllegalStateException: from state (0) already had transitions added\n    at org.apache.lucene.util.automaton.Automaton.addTransition(Automaton.java:158)\n    at org.apache.lucene.search.suggest.analyzing.XAnalyzingSuggester.replaceSep(XAnalyzingSuggester.java:302)\n    at org.apache.lucene.search.suggest.analyzing.XAnalyzingSuggester.toFiniteStrings(XAnalyzingSuggester.java:932)\n    at org.elasticsearch.search.suggest.completion.AnalyzingCompletionLookupProvider.toFiniteStrings(AnalyzingCompletionLookupProvider.java:371)\n    at org.elasticsearch.search.suggest.completion.CompletionTokenStream.incrementToken(CompletionTokenStream.java:63)\n    at org.apache.lucene.index.DefaultIndexingChain$PerField.invert(DefaultIndexingChain.java:618)\n    at org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:359)\n    at org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:318)\n    at org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:241)\n    at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:465)\n    at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1526)\n    at org.apache.lucene.index.IndexWriter.addDocument(IndexWriter.java:1252)\n    at org.elasticsearch.index.engine.InternalEngine.innerIndex(InternalEngine.java:431)\n    at org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:362)\n    ... 8 more\n```\n\nI tried this on three different machines also with a completely new installed Elasticsearch instance.\n\nBest Regards,\nMarkus Dütting\n","closed_by":{"login":"areek","id":753679,"node_id":"MDQ6VXNlcjc1MzY3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/753679?v=4","gravatar_id":"","url":"https://api.github.com/users/areek","html_url":"https://github.com/areek","followers_url":"https://api.github.com/users/areek/followers","following_url":"https://api.github.com/users/areek/following{/other_user}","gists_url":"https://api.github.com/users/areek/gists{/gist_id}","starred_url":"https://api.github.com/users/areek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/areek/subscriptions","organizations_url":"https://api.github.com/users/areek/orgs","repos_url":"https://api.github.com/users/areek/repos","events_url":"https://api.github.com/users/areek/events{/privacy}","received_events_url":"https://api.github.com/users/areek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}