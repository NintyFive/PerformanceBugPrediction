{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/60173","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60173/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60173/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60173/events","html_url":"https://github.com/elastic/elasticsearch/issues/60173","id":665264112,"node_id":"MDU6SXNzdWU2NjUyNjQxMTI=","number":60173,"title":"Elastic Snapshots cause out of memory exceptions","user":{"login":"ecovadis-devops","id":61793312,"node_id":"MDQ6VXNlcjYxNzkzMzEy","avatar_url":"https://avatars1.githubusercontent.com/u/61793312?v=4","gravatar_id":"","url":"https://api.github.com/users/ecovadis-devops","html_url":"https://github.com/ecovadis-devops","followers_url":"https://api.github.com/users/ecovadis-devops/followers","following_url":"https://api.github.com/users/ecovadis-devops/following{/other_user}","gists_url":"https://api.github.com/users/ecovadis-devops/gists{/gist_id}","starred_url":"https://api.github.com/users/ecovadis-devops/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ecovadis-devops/subscriptions","organizations_url":"https://api.github.com/users/ecovadis-devops/orgs","repos_url":"https://api.github.com/users/ecovadis-devops/repos","events_url":"https://api.github.com/users/ecovadis-devops/events{/privacy}","received_events_url":"https://api.github.com/users/ecovadis-devops/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2020-07-24T15:59:47Z","updated_at":"2020-07-30T07:41:57Z","closed_at":"2020-07-30T07:41:57Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): ECK 1.1.2 ELK 7.7.1\r\n\r\n**Plugins installed**: [repository-azure]\r\n\r\n**JVM version** (`java -version`): Default by ECK docker image\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Default by ECK docker image\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe run 8 ELK 7.7.1 clusters on ECK 1.1.2 on Azure AKS. They are of different sizes - with Heap size from 2 to 12 GB (heap size is always 50% of the available memory) and data size from 20 GB to 700 GB. All of them are usually healthy and have >~50% of heap size and disk size free.\r\n\r\nWe have automatic snapshot setup every ~6 hours on all of them. It happens randomly - one every few snapshots, on random instances, that the snapshot will cause heap memory to suddenly jump to 100%, cause OOM exception and crash at least one of cluster nodes (all clusters have 2 nodes). \r\n![image](https://user-images.githubusercontent.com/61793312/88409590-6e458780-cdd5-11ea-9be9-66e345ae70e5.png)\r\nIt happens on big and small instances, but is not really predictable. \r\nIt seems that this issue started after an upgrade to ELK 7.7.1, earlier we run ECK 1.0 and ELK 7.6.1 and we did not notice this issue. \r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Setup an ECK 1.1.2 with ELK 7.7.1 cluster on Azure AKS with repository-azure plugin\r\n 2. Configure automatic snapshots - for instance every hour\r\n 3. Watch for sudden spikes in Heap Memory usage, happening exactly when the snapshot starts\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}