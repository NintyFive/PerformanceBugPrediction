{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35336","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35336/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35336/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35336/events","html_url":"https://github.com/elastic/elasticsearch/issues/35336","id":378295004,"node_id":"MDU6SXNzdWUzNzgyOTUwMDQ=","number":35336,"title":"[ML] Audit Messages are logged deleting a missing job","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":962378555,"node_id":"MDU6TGFiZWw5NjIzNzg1NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.5.0","name":"v6.5.0","color":"Dddddd","default":false,"description":""},{"id":1102494662,"node_id":"MDU6TGFiZWwxMTAyNDk0NjYy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.6.0","name":"v6.6.0","color":"dddddd","default":false,"description":""},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-11-07T13:48:37Z","updated_at":"2019-02-07T10:33:25Z","closed_at":"2018-11-08T09:57:08Z","author_association":"MEMBER","active_lock_reason":null,"body":"![no-known-job](https://user-images.githubusercontent.com/2353640/48134604-54c37b80-e292-11e8-8aa9-a64f336b0570.png)\r\n\r\nThe screen shot above shows an error message 'Error deleting job' in this case there had been no attempt to delete the job. The problem is that deleting an unknown job causes the auditor to log a message [here](https://github.com/elastic/elasticsearch/blob/409050e8de4cacbfac4b68ab12bbb928437a4499/x-pack/plugin/ml/src/main/java/org/elasticsearch/xpack/ml/action/TransportDeleteJobAction.java#L173) before returning a 404. \r\n\r\nThis issue was spotted running the ml sample scripts downloadable from https://www.elastic.co/guide/en/elastic-stack-overview/6.5/ml-gs-data.html#ml-gs-sampledata which always delete the job before creating it. If the job does not exist then the error message is audited with that job id and when the job is created it now has the error associated with it. It's common practice in test scripts to clean the environment first by deleting jobs.\r\n\r\n### Reproduce \r\nDelete a job \r\n`\r\nDELETE _xpack/ml/anomaly_detectors/not-a-job\r\n`\r\nThen search the .ml-notifications index\r\n`\r\nGET .ml-notifications/_search {\r\n    \"query\": {\r\n        \"match_all\": {}\r\n    }\r\n}\r\n`\r\n\r\nAnd 2 messages have been indexed:\r\n```\r\n\"hits\" : {\r\n    \"total\" : 2,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \".ml-notifications\",\r\n        \"_type\" : \"audit_message\",\r\n        \"_id\" : \"E0Fe7mYBhHmym0_kaqEW\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"job_id\" : \"farequote\",\r\n          \"message\" : \"Error deleting job: No known job with id 'not-a-job'\",\r\n          \"level\" : \"error\",\r\n          \"timestamp\" : 1541597456916,\r\n          \"node_name\" : \"node-0\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \".ml-notifications\",\r\n        \"_type\" : \"audit_message\",\r\n        \"_id\" : \"FEFe7mYBhHmym0_kaqHY\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"job_id\" : \"farequote\",\r\n          \"message\" : \"Deleting job by task with id 'JSEDHs3IQ-6lWgFssejABw:20'\",\r\n          \"level\" : \"info\",\r\n          \"timestamp\" : 1541597456803,\r\n          \"node_name\" : \"node-0\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n```\r\n\r\nThe solution is not to audit messages for jobs that do not exist\r\n\r\n\r\n","closed_by":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"performed_via_github_app":null}