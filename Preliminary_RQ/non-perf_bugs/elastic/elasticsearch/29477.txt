{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29477","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29477/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29477/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29477/events","html_url":"https://github.com/elastic/elasticsearch/issues/29477","id":313343184,"node_id":"MDU6SXNzdWUzMTMzNDMxODQ=","number":29477,"title":"need help for parent child aggregation","user":{"login":"chiragob","id":11608316,"node_id":"MDQ6VXNlcjExNjA4MzE2","avatar_url":"https://avatars1.githubusercontent.com/u/11608316?v=4","gravatar_id":"","url":"https://api.github.com/users/chiragob","html_url":"https://github.com/chiragob","followers_url":"https://api.github.com/users/chiragob/followers","following_url":"https://api.github.com/users/chiragob/following{/other_user}","gists_url":"https://api.github.com/users/chiragob/gists{/gist_id}","starred_url":"https://api.github.com/users/chiragob/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chiragob/subscriptions","organizations_url":"https://api.github.com/users/chiragob/orgs","repos_url":"https://api.github.com/users/chiragob/repos","events_url":"https://api.github.com/users/chiragob/events{/privacy}","received_events_url":"https://api.github.com/users/chiragob/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-04-11T14:14:15Z","updated_at":"2018-04-13T08:52:46Z","closed_at":"2018-04-13T08:52:46Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**: need help for aggregation\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.6\r\n\r\n**Need help for aggregation**:\r\n**Use parent-child mapping to capture a Product and child for override product**\r\n\r\nwe are store product catalogue in elasticsearch using parent child combination. user can override master product and store as child product. i have issue in aggregation. when we aggregate data at that time it will give all record count for linename based on parent child. if child has linename then parent doc will be exclude and child have no line name then linename get from parent record.\r\n\r\n\r\n```\r\nPUT /pdm\r\n{\r\n  \"mappings\": {\r\n    \"product\": {\r\n        \"properties\": {\r\n               \"product_name\": {\r\n                  \"type\": \"text\",\r\n                  \"fielddata\": true,\r\n                  \"fields\": {\r\n                     \"keyword\": {\r\n                        \"type\": \"keyword\",\r\n                        \"ignore_above\": 256\r\n                     }\r\n                  }\r\n               },\r\n               \"linename\": {\r\n                  \"type\": \"text\",\r\n                  \"fielddata\": true,\r\n                  \"fields\": {\r\n                     \"keyword\": {\r\n                        \"type\": \"keyword\",\r\n                        \"ignore_above\": 256\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n    },\r\n    \"dist_product\": {\r\n      \"_parent\": {\r\n        \"type\": \"product\" \r\n      },\r\n      \"properties\": {\r\n        \"product_name\": {\r\n                  \"type\": \"text\",\r\n                  \"fielddata\": true,\r\n                  \"fields\": {\r\n                     \"keyword\": {\r\n                        \"type\": \"keyword\",\r\n                        \"ignore_above\": 256\r\n                     }\r\n                  }\r\n               },\r\n               \"linename\": {\r\n                  \"type\": \"text\",\r\n                  \"fielddata\": true,\r\n                  \"fields\": {\r\n                     \"keyword\": {\r\n                        \"type\": \"keyword\",\r\n                        \"ignore_above\": 256\r\n                     }\r\n                  }\r\n               }       \r\n       }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n#**Index 3 parents and several children.**\r\n```\r\nPOST /pdm/product/_bulk\r\n{ \"index\": { \"_id\": \"101\" }}\r\n{ \"product_name\": \"Zip-It Document Holder\", \"linename\": \"Sweda\"}\r\n{ \"index\": { \"_id\": \"102\" }}\r\n{ \"product_name\": \"Stratus Reversible Umbrella\", \"linename\": \"Sweda\"}\r\n{ \"index\": { \"_id\": \"103\" }}\r\n{ \"product_name\": \"Leatherette Tumbler\", \"linename\": \"Sweda\"}\r\n```\r\n\r\n#**children**\r\n```\r\nPOST /pdm/dist_product/_bulk\r\n{ \"index\": { \"_id\": 1, \"parent\": \"101\" }}\r\n{ \"linename\": \"Greco\" }\r\n{ \"index\": { \"_id\": 2, \"parent\": \"102\" }}\r\n{ \"linename\": \"Greco\"}\r\n```\r\n\r\n#**aggregation query**\r\n\r\n```\r\nPOST /pdm/_search\r\n{  \r\n   \"size\": 0, \r\n   \"aggs\":{  \r\n      \"my-linename\":{  \r\n           \"terms\":{  \r\n              \"field\":\"linename\"\r\n           }\r\n        }\r\n   }\r\n}\r\n```\r\n\r\n**Result are as below**\r\n```\r\n\"aggregations\": {\r\n      \"my-linename\": {\r\n         \"doc_count_error_upper_bound\": 0,\r\n         \"sum_other_doc_count\": 0,\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"sweda\",\r\n               \"doc_count\": 3\r\n            },\r\n            {\r\n               \"key\": \"greco\",\r\n               \"doc_count\": 2\r\n            }\r\n         ]\r\n      }\r\n   }\r\n```\r\n\r\n**expected Result should be as below**\r\n```\r\n\"my-linename\": {\r\n         \"doc_count_error_upper_bound\": 0,\r\n         \"sum_other_doc_count\": 0,\r\n         \"buckets\": [\r\n            {\r\n               \"key\": \"greco\",\r\n               \"doc_count\": 2\r\n            },\r\n            {\r\n               \"key\": \"sweda\",\r\n               \"doc_count\": 1\r\n            }\r\n         ]\r\n      }\r\n```\r\nplease give me suggestion to achieve above result  ","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}