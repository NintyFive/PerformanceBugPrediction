{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57332","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57332/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57332/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57332/events","html_url":"https://github.com/elastic/elasticsearch/issues/57332","id":627041942,"node_id":"MDU6SXNzdWU2MjcwNDE5NDI=","number":57332,"title":"[Transform] scripted group_by fails for continuos transform","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"assignees":[{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-05-29T06:51:54Z","updated_at":"2020-09-17T10:01:21Z","closed_at":"2020-08-05T14:56:50Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Affected versions:** 7.7 - 7.9.1 (fixed >= 7.9.2)\r\n\r\nContinuous transform minimize the amount of updates by querying only changed buckets, the logic uses a combination of query features for that. For terms it relies on terms query.\r\n\r\nIf a script is used in `group_by` instead of a field, this change detection logic causes the transform to fail (after it switches to continuous mode, not directly after start but after checkpoint 1) as it expects a field:\r\n\r\n```\r\ntask encountered irrecoverable failure: field name cannot be null\r\n```\r\n\r\nBecause scripts offer freedom to build a bucket key, we can't use them to detect changes on them. We could construct a [script query](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-query.html), however this would be very expensive.\r\n\r\n**Mitigation**: don't use scripts in `group_by` together with continuous transform. Scripts in queries are very expensive, so independent of change detection it's highly recommended to _not_ use scripts in production, but only in the development/data exploration phase.\r\n\r\n### Possible solutions\r\n\r\n**Update**: We finally decided to go with option B, keeping the other ideas for documentation.\r\n\r\n~~## A Disallow scripted group_by in continuous mode~~\r\n\r\n~~This would be easiest, however if you have only 1 scripted group_by but `n` non scripted `group_by`'s this would limit functionality unnecessary.~~\r\n\r\n## B Disable change detection for scripted group_by\r\n\r\nThis would let continuous mode do a full rerun if all `group_by`'s are using a script. On larger scale this leads to performance problems. If there are other non-scripted `group_by`'s or the amount of data is small this might still be an acceptable solution. \r\n\r\n~~B.2: For this solution we could also consider using `_update` instead of index.~~\r\n\r\n~~## C Implement change detection based on scripted query~~\r\n\r\n~~I am not 100% sure this is possible. This solution would use a [script query](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-script-query.html) instead of a terms query. This solution might not be better than solution B: disabling change detection.~~\r\n\r\n## General solution remarks\r\n\r\nBecause data might be small **A** would limit functionality, I therefore tend towards **B**. It would be possible to disallow certain combinations like only disallow if no `group_by` implements change detection, but again this sounds like to much of a restriction. Instead we should warn the user about potential problems. Solution **C** might be good in the long run, but takes significant more time to verify, implement and test, so **B** seems to be the best short term solution.\r\n\r\nThe user that reported the issue made a workaround for https://github.com/elastic/elasticsearch/issues/48243, therefore supporting missing_bucket should be prioritized.\r\n\r\n**Update**\r\n\r\nIf transform can not apply any change detection a warning (job message + log) is raised regarding performance.","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}