{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16849","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16849/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16849/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16849/events","html_url":"https://github.com/elastic/elasticsearch/issues/16849","id":137187383,"node_id":"MDU6SXNzdWUxMzcxODczODM=","number":16849,"title":"Aggregations returns wrong results ","user":{"login":"ofer-velich","id":7073481,"node_id":"MDQ6VXNlcjcwNzM0ODE=","avatar_url":"https://avatars0.githubusercontent.com/u/7073481?v=4","gravatar_id":"","url":"https://api.github.com/users/ofer-velich","html_url":"https://github.com/ofer-velich","followers_url":"https://api.github.com/users/ofer-velich/followers","following_url":"https://api.github.com/users/ofer-velich/following{/other_user}","gists_url":"https://api.github.com/users/ofer-velich/gists{/gist_id}","starred_url":"https://api.github.com/users/ofer-velich/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ofer-velich/subscriptions","organizations_url":"https://api.github.com/users/ofer-velich/orgs","repos_url":"https://api.github.com/users/ofer-velich/repos","events_url":"https://api.github.com/users/ofer-velich/events{/privacy}","received_events_url":"https://api.github.com/users/ofer-velich/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-02-29T08:35:52Z","updated_at":"2016-02-29T09:49:26Z","closed_at":"2016-02-29T08:57:23Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 1.7.3\n\n**OS version**: Ubuntu 14.04\n\n**Description of the problem including expected versus actual behavior**:\n\nAggregations returns wrong results on one of my indices - running avg or max or min on a small set of double field called \"time\", it looks like it's ignoring the floating point \n\n**the index has the following mapping:**\n\nPlease note that we have two \"time\" fields on the same index, One under the \"root\" object witch is mapped as double, And one under the \"event.properties\"  witch is mapped as long.\n\n```\n{\n    indexname: {\n        mappings: {\n            web-api: {\n                properties: {\n                    ....\n                    event: {\n                        properties: {\n                            time: {\n                                type: \"long\"\n                            },\n                            ....\n                        }\n                    },\n                    .....\n                    time: {\n                        type: \"double\"\n                    },\n                    .....\n                }\n            }\n        }\n    }\n}\n```\n\n**when i run the following query and aggs i get wrong results:**\n\n```\ncurl -XGET elasticsearch:9200/indexname/web-api/_search -d '\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"query_string\": {\n          \"query\": \"_exists_: time\"\n        }\n      },\n      \"filter\": {\n        \"range\": {\n          \"@timestamp\": {\n            \"gte\":  1456733280000,\n            \"lte\":  1456733306000\n          }\n        }\n      }\n    }\n  }\n  , \"size\": 2\n  , \"aggs\": {\n    \"min-agg\": {\n      \"min\": {\n        \"field\": \"time\"\n      }\n    },\n    \"max-agg\": {\n      \"max\": {\n        \"field\": \"time\"\n      }\n    },\n    \"avg-agg\": {\n      \"avg\": {\n        \"field\": \"time\"\n      }\n    }\n  }\n}\n' \n```\n\n**Results:**\n\n```\n{\n   \"took\": 2,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 8,\n      \"successful\": 8,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 2,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"indexname\",\n            \"_type\": \"web-api\",\n            \"_id\": \"AVMsEjtIrdN06BhGvXc-\",\n            \"_score\": 1,\n            \"_source\": {\n               ....\n               \"@timestamp\": \"2016-02-29T08:08:13.929+00:00\",\n               ....\n               \"time\": 1741.3100000023842\n            }\n         },\n         {\n            \"_index\": \"indexname\",\n            \"_type\": \"web-api\",\n            \"_id\": \"AVMsEjvO9e5_IXiSdhbm\",\n            \"_score\": 1,\n            \"_source\": {\n               ....\n               \"@timestamp\": \"2016-02-29T08:08:14.388+00:00\",\n               ....\n               \"time\": 2377.314999997616\n            }\n         }\n      ]\n   },\n   \"aggregations\": {\n      \"max-agg\": {\n         \"value\": 4657446186044490000\n      },\n      \"min-agg\": {\n         \"value\": 4655373177816613000\n      },\n      \"avg-agg\": {\n         \"value\": 4656409681930551000\n      }\n   }\n}\n```\n\nAny idea, why we are getting those results ??\n\nThanks\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}