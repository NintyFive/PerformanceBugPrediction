[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/320162073","html_url":"https://github.com/elastic/elasticsearch/issues/26050#issuecomment-320162073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26050","id":320162073,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMDE2MjA3Mw==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-08-04T05:46:55Z","updated_at":"2017-08-04T05:46:55Z","author_association":"MEMBER","body":"Thanks for the suggestion @jlecour! @rjernst, @nik9000, @jasontedor do you have any thoughts on this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/320224494","html_url":"https://github.com/elastic/elasticsearch/issues/26050#issuecomment-320224494","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26050","id":320224494,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMDIyNDQ5NA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-04T11:19:39Z","updated_at":"2017-08-04T11:20:42Z","author_association":"MEMBER","body":"I have a different understanding of the purpose of `ucf` from what seems to be the case here. My understanding is that `ucf` is primarily for use cases where configuration files are generated during post-install; that is, they are *not* part of the shipped package, so can not be marked as configuration files, so do not receive the automatic conflict resolution that `dpkg` provides. Instead, `ucf` enables this functionality for invocation in the post-install scripts for such configuration files. We do not need this, we do not generate configuration files in post-install instead shipping all configuration files as part of the shipped package. I do not see a need for us to transition away from the automatic management that `dpkg` provides; it's simple, and well-understood.\r\n\r\nHere are the changes in shipped configuration file during the 5.x series:\r\n - from 5.0 to 5.5, the elasticsearch.yml only saw comment changes; these are easily resolved\r\n - from 5.0 to 5.5, the jvm.options file removed `-XX:+DisableExplicitGC`, added `-Xss1m`, added `-Dio.netty.recycler.maxCapacityPerThread=0`, added commented-out GC log rotation, and a few comments were modified\r\n - from 5.0 to 5.5, the log4j2.properties changed to support a system properties that we set for controlling the log files\r\n\r\nI don't think we'll see many changes to the elasticsearch.yml, so the chance of conflicts there is minimal and they are going to be easy to resolve.\r\n\r\nOther than heap size, the vast majority of users should accept the JVM defaults that we ship with, so there should rarely be conflicts and they should all be straightforward to resolve.\r\n\r\nFor the log4j2.properties, I can see some users customizing these but I think these conflicts are rare (we do not make changes to this file frequently), and would be easy to resolve.\r\n\r\nWhile `ucf` can be used for configuration files like those that we ship (i.e., not just ones produced during post-installation), the only advantage that it buys us a three-way merge for conflicts. Given the above, I do not see the need to add `ucf` for this. Additionally, I'm keen to keep the Debian and RPM distributions as close as possible.\r\n\r\nSo, I do not yet see a compelling reason to migrate to using `ucf` to manage the configuration files.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321674216","html_url":"https://github.com/elastic/elasticsearch/issues/26050#issuecomment-321674216","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26050","id":321674216,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTY3NDIxNg==","user":{"login":"jlecour","id":5142,"node_id":"MDQ6VXNlcjUxNDI=","avatar_url":"https://avatars3.githubusercontent.com/u/5142?v=4","gravatar_id":"","url":"https://api.github.com/users/jlecour","html_url":"https://github.com/jlecour","followers_url":"https://api.github.com/users/jlecour/followers","following_url":"https://api.github.com/users/jlecour/following{/other_user}","gists_url":"https://api.github.com/users/jlecour/gists{/gist_id}","starred_url":"https://api.github.com/users/jlecour/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jlecour/subscriptions","organizations_url":"https://api.github.com/users/jlecour/orgs","repos_url":"https://api.github.com/users/jlecour/repos","events_url":"https://api.github.com/users/jlecour/events{/privacy}","received_events_url":"https://api.github.com/users/jlecour/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T21:09:59Z","updated_at":"2017-08-10T21:10:54Z","author_association":"CONTRIBUTOR","body":"Hi @danielmitterdorfer, thank you for you answer.\r\n\r\nProviding a way to resolve 3-way merges of configuration files (like the main YAML file) is exactly why I brought this topic to attention.\r\n\r\nOf course, confilcts can be resolved manually when dpkg finds that the file has changed from the default (which always happens, at least to customize the network and the cluster/node names).\r\nEach time the config file has a change of comments, the user has to parse the whole file visually of programmaticaly to find if something meaningful has changed or not.\r\nWith ucf, there is still an interactive choice to make (\"resolve 3-way merge\") but the resolution itself is automatic in a typical situation. It might even become an option for non-interactive frontends.\r\n\r\nI've tried to do this and the results seems really good to me.\r\n1. i've downloaded the 5.0 package and extracted the YAML file\r\n2. i've done the same for the 5.5 package\r\n3. I've copied the 5.0 config and customized it, for a few common variables.\r\n\r\nWith the help of ucf, I have a 5.5 config with all my customizations, but programmed automatically\r\nI didn't need to convert the default files to any other format. Generating a config file at post-install time doesn't mean that they have to contains variables or any logic.\r\n\r\nHere is the exact series of steps :\r\n\r\nFetch the packages and initialize ucf for the config file\r\n~~~\r\n# cd /tmp\r\n# wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.0.0.deb\r\n# mkdir es50\r\n# cd es50\r\n# ar x ../elasticsearch-5.0.0.deb\r\n# tar xzf data.tar.gz\r\n# cd /tmp\r\n# wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-5.5.1.deb\r\n# mkdir es55\r\n# cd es55\r\n# ar x ../elasticsearch-5.5.1.deb\r\n# tar xzf data.tar.gz\r\n#  ucf -v --three-way /tmp/es50/etc/elasticsearch/elasticsearch.yml /tmp/elasticsearch.yml\r\n: The new file is /tmp/es50/etc/elasticsearch/elasticsearch.yml\r\n: The Destination file is /tmp/elasticsearch.yml\r\n: The Source directory is /tmp/es50/etc/elasticsearch\r\n: The State directory is /var/lib/ucf\r\nCreating config file /tmp/elasticsearch.yml with new version\r\n~~~\r\n\r\ncustomize the config file\r\n~~~.diff\r\n--- es50/etc/elasticsearch/elasticsearch.yml\t2016-10-26 00:40:43.000000000 -0400\r\n+++ elasticsearch.yml\t2017-08-10 16:52:16.835867854 -0400\r\n@@ -17,0 +18 @@\r\n+cluster.name: my-cluster\r\n@@ -23,0 +25 @@\r\n+node.name: my-node\r\n@@ -55,0 +58 @@\r\n+network.host: [_local_];\r\n~~~\r\n\r\nLet's update the config file :\r\n~~~\r\n# ucf -v --three-way /tmp/es55/etc/elasticsearch/elasticsearch.yml /tmp/elasticsearch.yml\r\n: The new file is /tmp/es55/etc/elasticsearch/elasticsearch.yml\r\n: The Destination file is /tmp/elasticsearch.yml\r\n: The Source directory is /tmp/es55/etc/elasticsearch\r\n: The State directory is /var/lib/ucf\r\nThe hash file exists\r\negrep [[:space:]]\\/tmp\\/elasticsearch\\.yml$ /var/lib/ucf/hashfile\r\nee49e0f90de02a818891a18ebf91c35a  /tmp/elasticsearch.yml\r\nMerging changes into the new version\r\n(egrep -v \"[[:space:]]\\/tmp\\/elasticsearch\\.yml$\" \"/var/lib/ucf/hashfile\";\r\n31655f8d9bce94581724510ebc90ed75  /tmp/elasticsearch.yml\r\n~~~\r\n\r\nAnd now the file is properly updated/merged as you can in the diff between the 5.0 config and the one after the upgrade :\r\n~~~.diff\r\n--- /tmp/es50/etc/elasticsearch/elasticsearch.yml\t2016-10-26 00:40:43.000000000 -0400\r\n+++ /tmp/elasticsearch.yml\t2017-08-10 16:58:19.771858018 -0400\r\n@@ -10,2 +10,2 @@\r\n-# Please see the documentation for further information on configuration options:\r\n-# <http://www.elastic.co/guide/en/elasticsearch/reference/current/setup-configuration.html>\r\n+# Please consult the documentation for further information on configuration options:\r\n+# https://www.elastic.co/guide/en/elasticsearch/reference/index.html\r\n@@ -17,0 +18 @@\r\n+cluster.name: my-cluster\r\n@@ -23,0 +25 @@\r\n+node.name: my-node\r\n@@ -55,0 +58 @@\r\n+network.host: [_local_];\r\n@@ -61,2 +64 @@\r\n-# For more information, see the documentation at:\r\n-# <http://www.elastic.co/guide/en/elasticsearch/reference/current/modules-network.html>\r\n+# For more information, consult the network module documentation.\r\n@@ -71 +73 @@\r\n-# Prevent the \"split brain\" by configuring the majority of nodes (total number of nodes / 2 + 1):\r\n+# Prevent the \"split brain\" by configuring the majority of nodes (total number of master-eligible nodes / 2 + 1):\r\n@@ -75,2 +77 @@\r\n-# For more information, see the documentation at:\r\n-# <http://www.elastic.co/guide/en/elasticsearch/reference/current/modules-discovery.html>\r\n+# For more information, consult the zen discovery module documentation.\r\n@@ -84,2 +85 @@\r\n-# For more information, see the documentation at:\r\n-# <http://www.elastic.co/guide/en/elasticsearch/reference/current/modules-gateway.html>\r\n+# For more information, consult the gateway module documentation.\r\n@@ -88,4 +87,0 @@\r\n-#\r\n-# Disable starting multiple nodes on a single system:\r\n-#\r\n-#node.max_local_storage_nodes: 1\r\n~~~\r\n\r\nSo, I think ucf does the job pretty well, with significantly less attention/action from the user's perspective. I can't speak from first principle about the amount of work on the packaging side, but it seems reasonable.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324890220","html_url":"https://github.com/elastic/elasticsearch/issues/26050#issuecomment-324890220","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26050","id":324890220,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDg5MDIyMA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T11:13:00Z","updated_at":"2017-08-25T11:13:00Z","author_association":"MEMBER","body":"While I agree that `ucf` seems nice and helpful, @jasontedor has reasoned that the configuration changes only seldom and in addition we want the Debian and RPM distributions to stay as close as possible for maintenance reasons. Hence I'm closing it for the time being and in case we'll pick it up in the future, we can reopen.","performed_via_github_app":null}]