{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22119","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22119/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22119/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22119/events","html_url":"https://github.com/elastic/elasticsearch/issues/22119","id":195014720,"node_id":"MDU6SXNzdWUxOTUwMTQ3MjA=","number":22119,"title":"SearchTemplateRequestBuilder breaking change from 5.0 to 5.1","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":30486044,"node_id":"MDU6TGFiZWwzMDQ4NjA0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eregression","name":">regression","color":"d7e102","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-12-12T16:11:35Z","updated_at":"2018-02-14T13:42:33Z","closed_at":"2017-05-15T09:45:55Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.1\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI'm using the following Java code against a Node running elasticsearch 5.0.1:\r\n\r\nMy `pom.xml` file:\r\n\r\n```xml\r\n<dependencies>\r\n    <dependency>\r\n        <groupId>org.elasticsearch.client</groupId>\r\n        <artifactId>transport</artifactId>\r\n        <version>5.0.1</version>\r\n    </dependency>\r\n</dependencies>\r\n```\r\n\r\nMy code:\r\n\r\n```java\r\nclient.admin().cluster().preparePutStoredScript()\r\n        .setScriptLang(\"mustache\")\r\n        .setId(\"template_gender\")\r\n        .setSource(new BytesArray(\r\n                \"{\\n\" +\r\n                        \"    \\\"template\\\" : {\\n\" +\r\n                        \"        \\\"query\\\" : {\\n\" +\r\n                        \"            \\\"match\\\" : {\\n\" +\r\n                        \"                \\\"gender\\\" : \\\"{{param_gender}}\\\"\\n\" +\r\n                        \"            }\\n\" +\r\n                        \"        }\\n\" +\r\n                        \"    }\\n\" +\r\n                        \"}\")).get();\r\n\r\nMap<String, Object> template_params = new HashMap<>();\r\ntemplate_params.put(\"param_gender\", \"male\");\r\n\r\nSearchTemplateResponse str = new SearchTemplateRequestBuilder(client)\r\n        .setScript(\"template_gender\")\r\n        .setScriptType(ScriptService.ScriptType.STORED)\r\n        .setRequest(new SearchRequest())\r\n        .setScriptParams(template_params)\r\n        .get();\r\nSearchResponse sr = str.getResponse();\r\n```\r\n\r\nEverything works fine.\r\n\r\nThen I upgrade the server to 5.1.1. Note that I don't upgrade the TransportClient version.\r\n\r\nIt now fails with:\r\n\r\n```\r\njava.lang.IllegalStateException: Error reading ScriptType id [15] from stream, expected one of [2 [file], 1 [stored], 0 [inline]]\r\n\r\n\tat org.elasticsearch.script.ScriptType.readFrom(ScriptType.java:79)\r\n\tat org.elasticsearch.script.mustache.SearchTemplateRequest.readFrom(SearchTemplateRequest.java:147)\r\n\tat org.elasticsearch.transport.TcpTransport.handleRequest(TcpTransport.java:1340)\r\n\tat org.elasticsearch.transport.TcpTransport.messageReceived(TcpTransport.java:1242)\r\n\tat org.elasticsearch.transport.netty4.Netty4MessageChannelHandler.channelRead(Netty4MessageChannelHandler.java:74)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:351)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:293)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:280)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:396)\r\n\tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:248)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:351)\r\n\tat io.netty.channel.ChannelInboundHandlerAdapter.channelRead(ChannelInboundHandlerAdapter.java:86)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:351)\r\n\tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1334)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:373)\r\n\tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:359)\r\n\tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:926)\r\n\tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:129)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:651)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:536)\r\n\tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:490)\r\n\tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:450)\r\n\tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:873)\r\n\tat java.lang.Thread.run(Thread.java:745)\r\n```\r\n\r\nIt means that we changed the serialization between 5.0 and 5.1.\r\nIt also means to me that we probably can not do rolling upgrades when people are using the Search Template feature (not tested though).\r\nAlso probably means that people can't upgrade their client application to 5.1.1 then smoothly upgrade their nodes from 5.0 to 5.1. Not tested yet but will do it soonish.\r\n\r\nI believe this has been introduced by #21136 which has been backported to 5.1 with https://github.com/elastic/elasticsearch/commit/02d8522e7d166f11ff456cbc0774ef62904bd68c.\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}