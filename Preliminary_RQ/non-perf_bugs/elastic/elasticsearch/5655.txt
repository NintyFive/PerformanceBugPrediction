{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5655","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5655/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5655/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5655/events","html_url":"https://github.com/elastic/elasticsearch/issues/5655","id":30640992,"node_id":"MDU6SXNzdWUzMDY0MDk5Mg==","number":5655,"title":"error w/ arcDistance* in script","user":{"login":"dblado","id":926459,"node_id":"MDQ6VXNlcjkyNjQ1OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/926459?v=4","gravatar_id":"","url":"https://api.github.com/users/dblado","html_url":"https://github.com/dblado","followers_url":"https://api.github.com/users/dblado/followers","following_url":"https://api.github.com/users/dblado/following{/other_user}","gists_url":"https://api.github.com/users/dblado/gists{/gist_id}","starred_url":"https://api.github.com/users/dblado/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dblado/subscriptions","organizations_url":"https://api.github.com/users/dblado/orgs","repos_url":"https://api.github.com/users/dblado/repos","events_url":"https://api.github.com/users/dblado/events{/privacy}","received_events_url":"https://api.github.com/users/dblado/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2014-04-01T21:45:41Z","updated_at":"2014-04-02T19:46:40Z","closed_at":"2014-04-02T19:46:40Z","author_association":"NONE","active_lock_reason":null,"body":"Been experimenting w/ ES 1.1.0 and seeing this error:\n\n[2014-03-31 18:37:47,807][DEBUG][action.search.type       ] [Spidercide] [_river][0], node[8g5DHgKoR6G-3lwIojQcPQ], [P], s[STARTED]: Failed to execute [org.elasticsearch.action.search.SearchRequest@15029ae] lastShard [true]\norg.elasticsearch.search.SearchParseException: [_river][0]: from[-1],size[-1]: Parse Failure [Failed to parse source [{\"sort\":[{\"modified\":{\"order\":\"desc\"}},\"_score\"],\"from\":0,\"script_fields\":{\"distance\":{\"params\":{\"lat\":37.7749295,\"lon\":-122.4194155},\"script\":\"doc['location2.coordinates'].arcDistanceInMiles(lat, lon)\"}},\"fields\":[\"_source\"],\"facets\":{\"services\":{\"facet_filter\":{\"and\":[{\"terms\":{\"services\":[\"52431dc3c61e364f922ce716\"],\"execution\":\"and\"}}]},\"terms\":{\"field\":\"services\",\"size\":200}},\"proficiencies\":{\"facet_filter\":{\"and\":[{\"terms\":{\"services\":[\"52431dc3c61e364f922ce716\"],\"execution\":\"and\"}}]},\"terms\":{\"field\":\"good_at\",\"size\":50}}},\"filter\":{\"bool\":{\"must\":[{\"terms\":{\"services\":[\"52431dc3c61e364f922ce716\"],\"execution\":\"and\"}}]}},\"query\":{\"match_all\":{}},\"size\":20}]]\n    at org.elasticsearch.search.SearchService.parseSource(SearchService.java:634)\n    at org.elasticsearch.search.SearchService.createContext(SearchService.java:507)\n    at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:480)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:252)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:202)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryThenFetchAction.java:80)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:216)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:203)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:186)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:724)\nCaused by: org.elasticsearch.search.SearchParseException: [_river][0]: from[-1],size[-1]: Parse Failure [No mapping found for [modified] in order to sort on]\n    at org.elasticsearch.search.sort.SortParseElement.addSortField(SortParseElement.java:198)\n    at org.elasticsearch.search.sort.SortParseElement.addCompoundSortField(SortParseElement.java:172)\n    at org.elasticsearch.search.sort.SortParseElement.parse(SortParseElement.java:80)\n    at org.elasticsearch.search.SearchService.parseSource(SearchService.java:622)\n    ... 11 more\n[2014-03-31 18:37:47,840][DEBUG][action.search.type       ] [Spidercide] [9733] Failed to execute fetch phase\njava.lang.RuntimeException: cannot invoke method: arcDistanceInMiles\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.MethodAccessor.getValue(MethodAccessor.java:63)\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.MapAccessorNest.getValue(MapAccessorNest.java:54)\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.VariableAccessor.getValue(VariableAccessor.java:37)\n    at org.elasticsearch.common.mvel2.optimizers.dynamic.DynamicGetAccessor.getValue(DynamicGetAccessor.java:73)\n    at org.elasticsearch.common.mvel2.ast.ASTNode.getReducedValueAccelerated(ASTNode.java:108)\n    at org.elasticsearch.common.mvel2.MVELRuntime.execute(MVELRuntime.java:86)\n    at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getDirectValue(CompiledExpression.java:123)\n    at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getValue(CompiledExpression.java:119)\n    at org.elasticsearch.script.mvel.MvelScriptEngineService$MvelSearchScript.run(MvelScriptEngineService.java:191)\n    at org.elasticsearch.search.fetch.script.ScriptFieldsFetchSubPhase.hitExecute(ScriptFieldsFetchSubPhase.java:74)\n    at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:211)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:452)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteFetch(SearchServiceTransportAction.java:406)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.executeFetch(TransportSearchQueryThenFetchAction.java:150)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.run(TransportSearchQueryThenFetchAction.java:134)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:724)\nCaused by: java.lang.reflect.InvocationTargetException\n    at sun.reflect.GeneratedMethodAccessor15.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:606)\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.MethodAccessor.getValue(MethodAccessor.java:48)\n    ... 17 more\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.index.fielddata.ScriptDocValues$GeoPoints.arcDistanceInMiles(ScriptDocValues.java:365)\n    ... 21 more\n[2014-03-31 18:37:47,840][DEBUG][action.search.type       ] [Spidercide] [9732] Failed to execute fetch phase\njava.lang.RuntimeException: cannot invoke method: arcDistanceInMiles\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.MethodAccessor.getValue(MethodAccessor.java:63)\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.MapAccessorNest.getValue(MapAccessorNest.java:54)\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.VariableAccessor.getValue(VariableAccessor.java:37)\n    at org.elasticsearch.common.mvel2.optimizers.dynamic.DynamicGetAccessor.getValue(DynamicGetAccessor.java:73)\n    at org.elasticsearch.common.mvel2.ast.ASTNode.getReducedValueAccelerated(ASTNode.java:108)\n    at org.elasticsearch.common.mvel2.MVELRuntime.execute(MVELRuntime.java:86)\n    at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getDirectValue(CompiledExpression.java:123)\n    at org.elasticsearch.common.mvel2.compiler.CompiledExpression.getValue(CompiledExpression.java:119)\n    at org.elasticsearch.script.mvel.MvelScriptEngineService$MvelSearchScript.run(MvelScriptEngineService.java:191)\n    at org.elasticsearch.search.fetch.script.ScriptFieldsFetchSubPhase.hitExecute(ScriptFieldsFetchSubPhase.java:74)\n    at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:211)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:452)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteFetch(SearchServiceTransportAction.java:406)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction.executeFetch(TransportSearchQueryThenFetchAction.java:150)\n    at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.run(TransportSearchQueryThenFetchAction.java:134)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:724)\nCaused by: java.lang.reflect.InvocationTargetException\n    at sun.reflect.GeneratedMethodAccessor15.invoke(Unknown Source)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:606)\n    at org.elasticsearch.common.mvel2.optimizers.impl.refl.nodes.MethodAccessor.getValue(MethodAccessor.java:48)\n    ... 17 more\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.index.fielddata.ScriptDocValues$GeoPoints.arcDistanceInMiles(ScriptDocValues.java:365)\n    ... 21 more\n\nThe error doesn't cause anything to actually not work -- which is to show the distance to the vendor listing.  Here is the query that produces the error:\n\n```\n{\n  \"sort\": [\n    {\n      \"modified\": {\n        \"order\": \"desc\"\n      }\n    },\n    \"_score\"\n  ],\n  \"from\": 0,\n  \"script_fields\": {\n    \"distance\": {\n      \"params\": {\n        \"lat\": 37.7749295,\n        \"lon\": -122.4194155\n      },\n      \"script\": \"doc['location2.coordinates'].arcDistanceInMiles(lat, lon)\"\n    }\n  },\n  \"fields\": [\n    \"_source\"\n  ],\n  \"facets\": {\n    \"services\": {\n      \"facet_filter\": {\n        \"and\": [\n          {\n            \"terms\": {\n              \"services\": [\n                \"52431dc3c61e364f922ce716\"\n              ],\n              \"execution\": \"and\"\n            }\n          }\n        ]\n      },\n      \"terms\": {\n        \"field\": \"services\",\n        \"size\": 200\n      }\n    },\n    \"proficiencies\": {\n      \"facet_filter\": {\n        \"and\": [\n          {\n            \"terms\": {\n              \"services\": [\n                \"52431dc3c61e364f922ce716\"\n              ],\n              \"execution\": \"and\"\n            }\n          }\n        ]\n      },\n      \"terms\": {\n        \"field\": \"good_at\",\n        \"size\": 50\n      }\n    }\n  },\n  \"filter\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"terms\": {\n            \"services\": [\n              \"52431dc3c61e364f922ce716\"\n            ],\n            \"execution\": \"and\"\n          }\n        }\n      ]\n    }\n  },\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"size\": 20\n}\n```\n\nWhen, I remove the offending script, the error goes away but so does the functionality!  Any idea what's going on here?\n","closed_by":{"login":"dblado","id":926459,"node_id":"MDQ6VXNlcjkyNjQ1OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/926459?v=4","gravatar_id":"","url":"https://api.github.com/users/dblado","html_url":"https://github.com/dblado","followers_url":"https://api.github.com/users/dblado/followers","following_url":"https://api.github.com/users/dblado/following{/other_user}","gists_url":"https://api.github.com/users/dblado/gists{/gist_id}","starred_url":"https://api.github.com/users/dblado/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dblado/subscriptions","organizations_url":"https://api.github.com/users/dblado/orgs","repos_url":"https://api.github.com/users/dblado/repos","events_url":"https://api.github.com/users/dblado/events{/privacy}","received_events_url":"https://api.github.com/users/dblado/received_events","type":"User","site_admin":false},"performed_via_github_app":null}