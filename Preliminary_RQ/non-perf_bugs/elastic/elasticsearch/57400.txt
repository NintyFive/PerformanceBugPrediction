{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57400","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57400/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57400/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57400/events","html_url":"https://github.com/elastic/elasticsearch/issues/57400","id":628214321,"node_id":"MDU6SXNzdWU2MjgyMTQzMjE=","number":57400,"title":" Maybe memory leak still in IndicesQueryCache$ElasticsearchLRUQueryCache (6.5.3)","user":{"login":"wuyunfeng","id":5183061,"node_id":"MDQ6VXNlcjUxODMwNjE=","avatar_url":"https://avatars1.githubusercontent.com/u/5183061?v=4","gravatar_id":"","url":"https://api.github.com/users/wuyunfeng","html_url":"https://github.com/wuyunfeng","followers_url":"https://api.github.com/users/wuyunfeng/followers","following_url":"https://api.github.com/users/wuyunfeng/following{/other_user}","gists_url":"https://api.github.com/users/wuyunfeng/gists{/gist_id}","starred_url":"https://api.github.com/users/wuyunfeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wuyunfeng/subscriptions","organizations_url":"https://api.github.com/users/wuyunfeng/orgs","repos_url":"https://api.github.com/users/wuyunfeng/repos","events_url":"https://api.github.com/users/wuyunfeng/events{/privacy}","received_events_url":"https://api.github.com/users/wuyunfeng/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":26,"created_at":"2020-06-01T07:22:46Z","updated_at":"2020-10-21T23:40:42Z","closed_at":"2020-07-27T04:56:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.5.3\r\n**Plugins installed**: \r\n[ respository-hdfs, analysis-ik]\r\n\r\n**JVM version** (`java -version`):\r\n1.8\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentos 7.x\r\n**Description of the problem including expected versus actual behavior**:\r\nOur cluster have 13 nodes (master/data),  about 20 index with 108 shards,  400GB disk-usage total,  number_of_replicas: 1.\r\n\r\n```\r\nGET _nodes/stats/indices/segments\r\n```\r\n\r\n```\r\n\"indices\": {\r\n            \"segments\": {\r\n               \"count\": 309,\r\n               \"memory_in_bytes\": 252406692,\r\n               \"terms_memory_in_bytes\": 220566093,\r\n               \"stored_fields_memory_in_bytes\": 24673184,\r\n               \"term_vectors_memory_in_bytes\": 4013664,\r\n               \"norms_memory_in_bytes\": 50176,\r\n               \"points_memory_in_bytes\": 2801227,\r\n               \"doc_values_memory_in_bytes\": 302348,\r\n               \"index_writer_memory_in_bytes\": 2476343,\r\n               \"version_map_memory_in_bytes\": 26305,\r\n               \"fixed_bit_set_memory_in_bytes\": 11819960,\r\n               \"max_unsafe_auto_id_timestamp\": -1,\r\n               \"file_sizes\": {}\r\n            }\r\n         }\r\n      }\r\n```\r\n\r\n```\r\nGET _nodes/stats/indices/query_cache\r\n```\r\n\r\n```\r\n         \"indices\": {\r\n            \"query_cache\": {\r\n               \"memory_size_in_bytes\": 460797529,\r\n               \"total_count\": 281194614,\r\n               \"hit_count\": 8502228,\r\n               \"miss_count\": 272692386,\r\n               \"cache_size\": 17142,\r\n               \"cache_count\": 17142,\r\n               \"evictions\": 0\r\n            }\r\n         }\r\n```\r\n\r\nContinuously growing memory usage eventually leading to periodically FullGC result in Cluster not available. All nodes have 128G  physical  memory，31G JVM Heap, 26cores.\r\n\r\nI just dump the heap and analysis the heap with `MAT`, found ElasticsearchLRUQueryCache retained about 21,613,314,000 heap size.\r\n\r\nOverView:\r\n\r\n![image](https://user-images.githubusercontent.com/5183061/83385777-66dcb000-a41c-11ea-9eae-83b85605349b.png)\r\n\r\nProblem Suspect  1 `org.elasticsearch.indices.IndicesQueryCache$ElasticsearchLRUQueryCache`: \r\n\r\nShortest Paths To the Accumulation Point\r\n![image](https://user-images.githubusercontent.com/5183061/83384368-b66dac80-a419-11ea-8ccb-3385d5529d3b.png)\r\n\r\nAccumulated Objects in Dominator Tree\r\n![image](https://user-images.githubusercontent.com/5183061/83384398-c4bbc880-a419-11ea-9f67-b89b1f0225dc.png)\r\n\r\nAccumulated Objects by Class in Dominator Tree\r\n![image](https://user-images.githubusercontent.com/5183061/83384447-e1580080-a419-11ea-9129-0ddb8696716e.png)\r\n\r\nAll Accumulated Objects by Class \r\n![image](https://user-images.githubusercontent.com/5183061/83384474-eb79ff00-a419-11ea-915e-38a42f64ac7c.png)\r\n![image](https://user-images.githubusercontent.com/5183061/83384493-f16fe000-a419-11ea-8c45-a1e07202e39b.png)\r\n\r\nI notice some user which  use older version(2.4.2) encountered similar problem which was resolved by @jpountz ：\r\n\r\nhttps://github.com/elastic/elasticsearch/issues/22742\r\nhttps://issues.apache.org/jira/browse/LUCENE-7652\r\n\r\nbut periodically FullGC on all node of the cluster about one-week  recently. It seems some query maybe reference the `SegmentReader` indirectly， and I puzzled with the `17,830,353,512`  retained heap size by `org.apache.lucene.index.SegmentReader`  seems the old `segment reader` which were closed but still has some reference? \r\n\r\nFrom `All Accumulated Objects by Class`, I noticed `20,886,047,792 ` Shallow Heap by `long[]` about 1,379,835 Objects.  this long[] is the  `bit set` cached by LRUQueryCache and some meta data of the `reader` such as `StoredFieldsReader` 、`doc value producer` etc?\r\n\r\n\r\nClass_Histogram\r\n\r\n![image](https://user-images.githubusercontent.com/5183061/83390294-2b45e400-a424-11ea-94fc-0a5e46b06f81.png)\r\n\r\n\r\n`FixedBits` have 40,096  objects and retained heap >= 23,494,510,832, which just `long[] bits`\r\n\r\n `FixedBits` was used for  `SegmentReader#liveDocs or hardLiveDocs` and `LRUQueryCache`.\r\n","closed_by":{"login":"wuyunfeng","id":5183061,"node_id":"MDQ6VXNlcjUxODMwNjE=","avatar_url":"https://avatars1.githubusercontent.com/u/5183061?v=4","gravatar_id":"","url":"https://api.github.com/users/wuyunfeng","html_url":"https://github.com/wuyunfeng","followers_url":"https://api.github.com/users/wuyunfeng/followers","following_url":"https://api.github.com/users/wuyunfeng/following{/other_user}","gists_url":"https://api.github.com/users/wuyunfeng/gists{/gist_id}","starred_url":"https://api.github.com/users/wuyunfeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wuyunfeng/subscriptions","organizations_url":"https://api.github.com/users/wuyunfeng/orgs","repos_url":"https://api.github.com/users/wuyunfeng/repos","events_url":"https://api.github.com/users/wuyunfeng/events{/privacy}","received_events_url":"https://api.github.com/users/wuyunfeng/received_events","type":"User","site_admin":false},"performed_via_github_app":null}