[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277980716","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-277980716","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":277980716,"node_id":"MDEyOklzc3VlQ29tbWVudDI3Nzk4MDcxNg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-07T12:09:48Z","updated_at":"2017-02-07T12:09:48Z","author_association":"CONTRIBUTOR","body":"First, your second query is malformed - I'm getting a JSON error and it is just too messy to try to clean up myself - I don't understand exactly what you're trying to do there.  Please try to paste valid code when opening an issue.\r\n\r\nSecond, your two queries do different things.  Filters inside function queries are used to apply a function to matching docs only, but they don't filter the docs returned (which the bool filter does).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277987576","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-277987576","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":277987576,"node_id":"MDEyOklzc3VlQ29tbWVudDI3Nzk4NzU3Ng==","user":{"login":"gm42","id":16498973,"node_id":"MDQ6VXNlcjE2NDk4OTcz","avatar_url":"https://avatars3.githubusercontent.com/u/16498973?v=4","gravatar_id":"","url":"https://api.github.com/users/gm42","html_url":"https://github.com/gm42","followers_url":"https://api.github.com/users/gm42/followers","following_url":"https://api.github.com/users/gm42/following{/other_user}","gists_url":"https://api.github.com/users/gm42/gists{/gist_id}","starred_url":"https://api.github.com/users/gm42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gm42/subscriptions","organizations_url":"https://api.github.com/users/gm42/orgs","repos_url":"https://api.github.com/users/gm42/repos","events_url":"https://api.github.com/users/gm42/events{/privacy}","received_events_url":"https://api.github.com/users/gm42/received_events","type":"User","site_admin":false},"created_at":"2017-02-07T12:41:36Z","updated_at":"2017-02-07T12:41:36Z","author_association":"CONTRIBUTOR","body":"@clintongormley my point was more that they are called in the same way, `filter`, yet they are acting differently.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277988702","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-277988702","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":277988702,"node_id":"MDEyOklzc3VlQ29tbWVudDI3Nzk4ODcwMg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-07T12:45:57Z","updated_at":"2017-02-07T12:45:57Z","author_association":"CONTRIBUTOR","body":"Sure, but that's what the docs are for ;)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277990639","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-277990639","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":277990639,"node_id":"MDEyOklzc3VlQ29tbWVudDI3Nzk5MDYzOQ==","user":{"login":"gm42","id":16498973,"node_id":"MDQ6VXNlcjE2NDk4OTcz","avatar_url":"https://avatars3.githubusercontent.com/u/16498973?v=4","gravatar_id":"","url":"https://api.github.com/users/gm42","html_url":"https://github.com/gm42","followers_url":"https://api.github.com/users/gm42/followers","following_url":"https://api.github.com/users/gm42/following{/other_user}","gists_url":"https://api.github.com/users/gm42/gists{/gist_id}","starred_url":"https://api.github.com/users/gm42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gm42/subscriptions","organizations_url":"https://api.github.com/users/gm42/orgs","repos_url":"https://api.github.com/users/gm42/repos","events_url":"https://api.github.com/users/gm42/events{/privacy}","received_events_url":"https://api.github.com/users/gm42/received_events","type":"User","site_admin":false},"created_at":"2017-02-07T12:54:23Z","updated_at":"2017-02-07T12:56:23Z","author_association":"CONTRIBUTOR","body":"@clintongormley but wouldn't be worth adding a note, which could as well be your quote:\r\n\r\n> Filters inside function queries are used to apply a function to matching docs only, but they don't filter the docs returned (which the bool filter does).\r\n> \r\n\r\nI cannot estimate how much of a \"noob\" doubt this would be, but by reading https://www.elastic.co/guide/en/elasticsearch/reference/2.4/query-dsl-bool-query.html and https://www.elastic.co/guide/en/elasticsearch/reference/2.4/query-dsl-function-score-query.html I could not infer what you just said.\r\n\r\n**Edit:** I guess the reason I could not see the problem is that I was using `min_score`, hence the filtering was still happening in my case.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/277998352","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-277998352","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":277998352,"node_id":"MDEyOklzc3VlQ29tbWVudDI3Nzk5ODM1Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-07T13:24:05Z","updated_at":"2017-02-07T13:24:05Z","author_association":"CONTRIBUTOR","body":"It may well be that the docs could be improved - I can see that the way they're written today assumes some knowledge, eg:\r\n\r\n> The function_score allows you to modify the score of documents that are retrieved by a query. This can be useful if, for example, a score function is computationally expensive and it is sufficient to compute the score on a filtered set of documents.\r\n\r\nThis explains the purpose: you get back the results returned by a query, but you can alter the score of a subset of those docs by using a filter to match the subset.  But it doesn't make clear that the assumption you had was incorrect.\r\n\r\nFancy sending a PR to make this clearer?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278009071","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-278009071","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":278009071,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODAwOTA3MQ==","user":{"login":"gm42","id":16498973,"node_id":"MDQ6VXNlcjE2NDk4OTcz","avatar_url":"https://avatars3.githubusercontent.com/u/16498973?v=4","gravatar_id":"","url":"https://api.github.com/users/gm42","html_url":"https://github.com/gm42","followers_url":"https://api.github.com/users/gm42/followers","following_url":"https://api.github.com/users/gm42/following{/other_user}","gists_url":"https://api.github.com/users/gm42/gists{/gist_id}","starred_url":"https://api.github.com/users/gm42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gm42/subscriptions","organizations_url":"https://api.github.com/users/gm42/orgs","repos_url":"https://api.github.com/users/gm42/repos","events_url":"https://api.github.com/users/gm42/events{/privacy}","received_events_url":"https://api.github.com/users/gm42/received_events","type":"User","site_admin":false},"created_at":"2017-02-07T14:06:06Z","updated_at":"2017-02-07T14:06:06Z","author_association":"CONTRIBUTOR","body":"Sure, will provide. I ended up using `function_score` + `min_score` because of a missing feature (function score in post-filter IIRC), so it took some effort to figure out what was causing the performance issue.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278893385","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-278893385","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":278893385,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODg5MzM4NQ==","user":{"login":"gm42","id":16498973,"node_id":"MDQ6VXNlcjE2NDk4OTcz","avatar_url":"https://avatars3.githubusercontent.com/u/16498973?v=4","gravatar_id":"","url":"https://api.github.com/users/gm42","html_url":"https://github.com/gm42","followers_url":"https://api.github.com/users/gm42/followers","following_url":"https://api.github.com/users/gm42/following{/other_user}","gists_url":"https://api.github.com/users/gm42/gists{/gist_id}","starred_url":"https://api.github.com/users/gm42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gm42/subscriptions","organizations_url":"https://api.github.com/users/gm42/orgs","repos_url":"https://api.github.com/users/gm42/repos","events_url":"https://api.github.com/users/gm42/events{/privacy}","received_events_url":"https://api.github.com/users/gm42/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T09:10:04Z","updated_at":"2017-02-10T09:10:04Z","author_association":"CONTRIBUTOR","body":"I did not have time to arrange the PR, but I would like to propose changes in two paragraphs instead one.\r\n\r\nLet me re-formulate the question from OP: what is the (internal) technical reason for MinScore/ConstantScoreFilter to have such performance correlation with amount of concurrent queries? Feel free to cite Lucene internals if needed.\r\n\r\nIf I know the answer to this, I might be able to provide a better documentation improvement (without the low-level details); I can infer it's due to \"returning all the docs\" part, but still quite surprising.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278895490","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-278895490","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":278895490,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODg5NTQ5MA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T09:20:22Z","updated_at":"2017-02-10T09:20:22Z","author_association":"CONTRIBUTOR","body":"Filters in the function_score query are used to apply a function to a limited subset of all the results of the query.  (eg if the hotel room has a balcony, then increase the score by 1). So these filters don't affect what hits are returned - that is determined by the query.  \r\n\r\nFor min_score to work, ALL documents returned by the query need to be scored, and then filtered out one by one.  This is much less efficient than including a filter in the query which says: only return hotel rooms which have a balcony.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/278898327","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-278898327","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":278898327,"node_id":"MDEyOklzc3VlQ29tbWVudDI3ODg5ODMyNw==","user":{"login":"gm42","id":16498973,"node_id":"MDQ6VXNlcjE2NDk4OTcz","avatar_url":"https://avatars3.githubusercontent.com/u/16498973?v=4","gravatar_id":"","url":"https://api.github.com/users/gm42","html_url":"https://github.com/gm42","followers_url":"https://api.github.com/users/gm42/followers","following_url":"https://api.github.com/users/gm42/following{/other_user}","gists_url":"https://api.github.com/users/gm42/gists{/gist_id}","starred_url":"https://api.github.com/users/gm42/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gm42/subscriptions","organizations_url":"https://api.github.com/users/gm42/orgs","repos_url":"https://api.github.com/users/gm42/repos","events_url":"https://api.github.com/users/gm42/events{/privacy}","received_events_url":"https://api.github.com/users/gm42/received_events","type":"User","site_admin":false},"created_at":"2017-02-10T09:34:31Z","updated_at":"2017-02-10T09:34:31Z","author_association":"CONTRIBUTOR","body":"Ah! That makes sense, thank you so much @clintongormley!\r\n\r\nAs I understand it's like document scores are being \"buffered\" at some step and only afterwards filtered (this at least would explain the observation).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/515982070","html_url":"https://github.com/elastic/elasticsearch/issues/23013#issuecomment-515982070","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23013","id":515982070,"node_id":"MDEyOklzc3VlQ29tbWVudDUxNTk4MjA3MA==","user":{"login":"vino-jay","id":22311746,"node_id":"MDQ6VXNlcjIyMzExNzQ2","avatar_url":"https://avatars0.githubusercontent.com/u/22311746?v=4","gravatar_id":"","url":"https://api.github.com/users/vino-jay","html_url":"https://github.com/vino-jay","followers_url":"https://api.github.com/users/vino-jay/followers","following_url":"https://api.github.com/users/vino-jay/following{/other_user}","gists_url":"https://api.github.com/users/vino-jay/gists{/gist_id}","starred_url":"https://api.github.com/users/vino-jay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vino-jay/subscriptions","organizations_url":"https://api.github.com/users/vino-jay/orgs","repos_url":"https://api.github.com/users/vino-jay/repos","events_url":"https://api.github.com/users/vino-jay/events{/privacy}","received_events_url":"https://api.github.com/users/vino-jay/received_events","type":"User","site_admin":false},"created_at":"2019-07-29T13:02:44Z","updated_at":"2019-07-29T13:02:44Z","author_association":"NONE","body":"It's bad to use the ScriptPlugin.About 1 million datas but cost 10 seconds。\r\nHow to improve the performance？\r\nGET test_index/_search\r\n{\r\n  \"from\": 0,\r\n  \"size\": 20,\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"filter\" : [\r\n          {\r\n            \"range\" : {\r\n              \"les_start_time\" : {\r\n                \"from\" : \"2019-06-13 21:00:00\",\r\n                \"to\" : \"2019-07-26 10:00:00\",\r\n                \"include_lower\" : true,\r\n                \"include_upper\" : false,\r\n                \"boost\" : 1.0\r\n              }\r\n            }\r\n          }\r\n        ]\r\n        }\r\n      },\r\n      \"functions\": [\r\n        {\r\n          \"script_score\": {\r\n            \"script\": {\r\n              \"source\": \"qi_sv_abnormal_score\",\r\n              \"lang\": \"abnormal_scoring_script\",\r\n              \"params\": {\"esScoreFields\":\"teacher_voice_pct,student_voice_pct\"}\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"score_mode\": \"multiply\",\r\n      \"boost_mode\": \"replace\"\r\n    }\r\n  }\r\n}","performed_via_github_app":null}]