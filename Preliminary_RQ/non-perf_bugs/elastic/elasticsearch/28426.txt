{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28426","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28426/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28426/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28426/events","html_url":"https://github.com/elastic/elasticsearch/issues/28426","id":292498751,"node_id":"MDU6SXNzdWUyOTI0OTg3NTE=","number":28426,"title":"testTranslogReplayWithFailure fails due a lingring store corruption","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"}],"state":"closed","locked":false,"assignee":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"assignees":[{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2018-01-29T17:44:50Z","updated_at":"2018-02-13T20:24:42Z","closed_at":"2018-01-30T09:03:17Z","author_association":"MEMBER","active_lock_reason":null,"body":"testTranslogReplayWithFailure checks what happens when we hit exceptions during translog recovery. If we don't manage to be successful as we keep on hitting errors, we disable random error throwing and open the engine engine again, this time expecting it to work.\r\n\r\nHowever, we refresh on flush at the end of translog recovery which apparently can result in the store being marked as corrupted and causing all future engine opening to fail.  It's unclear to me what recent change made this go south (it started failing around Jan 2nd.\r\n\r\n```\r\n  > Caused by: org.apache.lucene.index.CorruptIndexException: failed engine (reason: [refresh failed source[version_table_flush]]) (resource=preexisting_corruption)\r\n   >    at org.elasticsearch.index.store.Store.failIfCorrupted(Store.java:627)\r\n   >    at org.elasticsearch.index.store.Store.failIfCorrupted(Store.java:607)\r\n   >    at org.elasticsearch.index.store.Store.readLastCommittedSegmentsInfo(Store.java:185)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.loadTranslogUUIDFromLastCommit(InternalEngine.java:562)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.openTranslog(InternalEngine.java:485)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:180)\r\n   >    ... 45 more\r\n   > Caused by: java.io.IOException: failed engine (reason: [refresh failed source[version_table_flush]])\r\n   >    at org.elasticsearch.index.engine.Engine.failEngine(Engine.java:906)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:1380)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.flush(InternalEngine.java:1530)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.recoverFromTranslogInternal(InternalEngine.java:470)\r\n   >    at org.elasticsearch.index.engine.InternalEngine.recoverFromTranslog(InternalEngine.java:388)\r\n   >    at org.elasticsearch.index.engine.EngineTestCase.createEngine(EngineTestCase.java:341)\r\n   >    at org.elasticsearch.index.engine.EngineTestCase.createEngine(EngineTestCase.java:302)\r\n   >    at org.elasticsearch.index.engine.EngineTestCase.createEngine(EngineTestCase.java:291)\r\n   >    at org.elasticsearch.index.engine.EngineTestCase.createEngine(EngineTestCase.java:260)\r\n   >    at org.elasticsearch.index.engine.InternalEngineTests.testTranslogReplayWithFailure(InternalEngineTests.java:2406)\r\n```\r\n\r\nReproduce line (which works):\r\n```\r\n./gradlew :server:test -Dtests.seed=37BF283A8349DE8A -Dtests.class=org.elasticsearch.index.engine.InternalEngineTests -Dtests.method=\"testTranslogReplayWithFailure\" -Dtests.security.manager=true -Dtests.locale=hu -Dtests.timezone=Israel\r\n```\r\n\r\nFull build:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=fedora/1980/consoleText","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}