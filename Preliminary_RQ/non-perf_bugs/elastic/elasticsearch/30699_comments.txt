[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389988713","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-389988713","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":389988713,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTk4ODcxMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T19:53:05Z","updated_at":"2018-05-17T19:53:05Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389991018","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-389991018","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":389991018,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTk5MTAxOA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T20:00:59Z","updated_at":"2018-05-17T20:00:59Z","author_association":"MEMBER","body":"@hub-cap Can you take a look? I am happy to discuss.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/392876305","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-392876305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":392876305,"node_id":"MDEyOklzc3VlQ29tbWVudDM5Mjg3NjMwNQ==","user":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"created_at":"2018-05-29T17:59:30Z","updated_at":"2018-05-29T17:59:30Z","author_association":"CONTRIBUTOR","body":"Im adding the logs because its quite likely this will disappear over time.\r\n\r\n```\r\n  1> [0030-05-16T23:11:35,675][INFO ][o.e.n.Node               ] [node_s1] started\r\n  1> [0030-05-16T23:11:35,732][DEBUG][o.e.x.w.s.WatcherIndexTemplateRegistry] [node_s1] adding index template [.triggered_watches], because it doesn't exist\r\n  1> [0030-05-16T23:11:35,732][DEBUG][o.e.x.w.s.WatcherIndexTemplateRegistry] [node_s1] adding index template [.watch-history-7], because it doesn't exist\r\n  1> [0030-05-16T23:11:35,732][DEBUG][o.e.x.w.s.WatcherIndexTemplateRegistry] [node_s1] adding index template [.watches], because it doesn't exist\r\n  1> [0030-05-16T23:11:35,733][INFO ][o.e.g.GatewayService     ] [node_s1] recovered [0] indices into cluster_state\r\n  1> [0030-05-16T23:11:35,737][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s1] adding template [.triggered_watches] for index patterns [.triggered_watches*]\r\n  1> [0030-05-16T23:11:35,750][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s1] adding template [.watch-history-7] for index patterns [.watcher-history-7*]\r\n  1> [0030-05-16T23:11:35,759][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s1] adding template [.watches] for index patterns [.watches*]\r\n  1> [0030-05-16T23:11:36,040][INFO ][o.e.l.LicenseService     ] [node_s0] license [9ec38660-b86b-40e8-b0a1-44bb82b00b64] mode [trial] - valid\r\n  1> [0030-05-16T23:11:36,216][INFO ][o.e.l.LicenseService     ] [node_s1] license [9ec38660-b86b-40e8-b0a1-44bb82b00b64] mode [trial] - valid\r\n  1> [0030-05-16T23:11:36,222][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s1] adding template [random_index_template] for index patterns [*]\r\n  1> [0030-05-16T23:11:36,235][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] [ActivateWatchTests#testDeactivateAndActivate]: all set up test\r\n  1> [0030-05-16T23:11:36,240][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_s1] [.watches] creating index, cause [api], templates [.watches, random_index_template], shards [2]/[0], mappings [doc]\r\n  1> [0030-05-16T23:11:36,240][INFO ][o.e.c.r.a.AllocationService] [node_s1] updating number_of_replicas to [1] for indices [.watches]\r\n  1> [0030-05-16T23:11:36,420][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_s1] [.triggered_watches] creating index, cause [api], templates [.triggered_watches, random_index_template], shards [1]/[0], mappings [doc]\r\n  1> [0030-05-16T23:11:36,421][INFO ][o.e.c.r.a.AllocationService] [node_s1] updating number_of_replicas to [1] for indices [.triggered_watches]\r\n  1> [0030-05-16T23:11:36,574][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_s1] [.watcher-history-7-2018.05.17] creating index, cause [api], templates [.watch-history-7, random_index_template], shards [1]/[0], mappings [doc]\r\n  1> [0030-05-16T23:11:36,574][INFO ][o.e.c.r.a.AllocationService] [node_s1] updating number_of_replicas to [1] for indices [.watcher-history-7-2018.05.17]\r\n  1> [0030-05-16T23:11:36,664][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] creating watch history index [.watcher-history-7-2018.05.17]\r\n  1> [0030-05-16T23:11:36,735][INFO ][o.e.c.r.a.AllocationService] [node_s1] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.watcher-history-7-2018.05.17][0]] ...]).\r\n  1> [0030-05-16T23:11:36,742][DEBUG][o.e.x.w.t.a.a.ActivateWatchTests] indices [.watcher-history-7-2018.05.17, .watches, .triggered_watches] are green\r\n  1> [0030-05-16T23:11:36,743][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] waiting to start watcher, current states [Tuple [v1=node_s1, v2=STARTED], Tuple [v1=node_s0, v2=STARTED]]\r\n  1> [0030-05-16T23:11:36,768][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s1] adding watch [_id] to trigger service\r\n  1> [0030-05-16T23:11:36,825][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s0] watch [_id] should not be triggered\r\n  1> [0030-05-16T23:11:36,903][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] Waiting for watch to be executed at least once\r\n  1> [0030-05-16T23:11:37,821][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:37.821Z] (scheduled time was [2018-05-17T08:41:37.768Z])\r\n  1> [0030-05-16T23:11:37,875][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] executing watch [_id]\r\n  1> [0030-05-16T23:11:37,881][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_s1] [actions] creating index, cause [auto(bulk api)], templates [random_index_template], shards [7]/[0], mappings []\r\n  1> [0030-05-16T23:11:38,218][INFO ][o.e.c.r.a.AllocationService] [node_s1] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[actions][1]] ...]).\r\n  1> [0030-05-16T23:11:38,232][INFO ][o.e.c.m.MetaDataMappingService] [node_s1] [actions/hNl-YuA4QeCc_0n50OTh7Q] create_mapping [action1]\r\n  1> [0030-05-16T23:11:38,297][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s1] adding watch [_id] to trigger service\r\n  1> [0030-05-16T23:11:38,338][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s0] watch [_id] should not be triggered\r\n  1> [0030-05-16T23:11:38,365][INFO ][o.e.c.m.MetaDataMappingService] [node_s1] [.watcher-history-7-2018.05.17/cqrtFbcaTE6aYRZRLB-JYw] update_mapping [doc]\r\n  1> [0030-05-16T23:11:38,417][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_1ca5ba84-0a91-4767-9352-c647722ee3c9-2018-05-17T08:41:37.821Z]\r\n  1> [0030-05-16T23:11:38,417][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_1ca5ba84-0a91-4767-9352-c647722ee3c9-2018-05-17T08:41:37.821Z]\r\n  1> [0030-05-16T23:11:39,377][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:39.377Z] (scheduled time was [2018-05-17T08:41:39.303Z])\r\n  1> [0030-05-16T23:11:39,448][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] executing watch [_id]\r\n  1> [0030-05-16T23:11:39,483][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s1] removing watch [_id] to trigger service\r\n  1> [0030-05-16T23:11:39,484][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s1] adding watch [_id] to trigger service\r\n  1> [0030-05-16T23:11:39,494][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] failed to execute watch [_id]\r\n  1> org.elasticsearch.index.engine.VersionConflictEngineException: [doc][_id]: version conflict, current version [3] is different than the one provided [2]\r\n  1> \tat org.elasticsearch.index.engine.InternalEngine.planIndexingAsPrimary(InternalEngine.java:931) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.engine.InternalEngine.index(InternalEngine.java:798) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.index(IndexShard.java:724) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.applyIndexOperation(IndexShard.java:693) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.applyIndexOperationOnPrimary(IndexShard.java:658) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.lambda$executeIndexRequestOnPrimary$2(TransportShardBulkAction.java:569) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeOnPrimaryWhileHandlingMappingUpdates(TransportShardBulkAction.java:588) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequestOnPrimary(TransportShardBulkAction.java:567) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeIndexRequest(TransportShardBulkAction.java:142) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.executeBulkItemRequest(TransportShardBulkAction.java:248) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.performOnPrimary(TransportShardBulkAction.java:125) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:112) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:74) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:1018) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryShardReference.perform(TransportReplicationAction.java:996) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.ReplicationOperation.execute(ReplicationOperation.java:103) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:357) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.onResponse(TransportReplicationAction.java:297) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:959) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$1.onResponse(TransportReplicationAction.java:956) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShardOperationPermits.acquire(IndexShardOperationPermits.java:270) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShardOperationPermits.acquire(IndexShardOperationPermits.java:237) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.index.shard.IndexShard.acquirePrimaryOperationPermit(IndexShard.java:2213) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction.acquirePrimaryShardReference(TransportReplicationAction.java:968) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction.access$500(TransportReplicationAction.java:98) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$AsyncPrimaryAction.doRun(TransportReplicationAction.java:318) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:293) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:280) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:66) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:656) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:724) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_162]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_162]\r\n  1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_162]\r\n  1> [0030-05-16T23:11:39,526][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_02ec1a21-0eb2-462b-a2ac-4df36490d5d1-2018-05-17T08:41:39.377Z]\r\n  1> [0030-05-16T23:11:39,527][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_02ec1a21-0eb2-462b-a2ac-4df36490d5d1-2018-05-17T08:41:39.377Z]\r\n  1> [0030-05-16T23:11:39,627][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s0] watch [_id] should not be triggered\r\n  1> [0030-05-16T23:11:39,701][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] Ensured no more watches are being executed\r\n  1> [0030-05-16T23:11:40,137][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] Sleeping for 5 seconds, watch history count [2]\r\n  1> [0030-05-16T23:11:40,885][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:40.885Z] (scheduled time was [2018-05-17T08:41:40.484Z])\r\n  1> [0030-05-16T23:11:40,900][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] not executing watch [_id]\r\n  1> [0030-05-16T23:11:40,930][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_abf3ff21-3a67-4e15-9ab2-9d19d60f423a-2018-05-17T08:41:40.886Z]\r\n  1> [0030-05-16T23:11:40,931][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_abf3ff21-3a67-4e15-9ab2-9d19d60f423a-2018-05-17T08:41:40.886Z]\r\n  1> [0030-05-16T23:11:41,887][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:41.887Z] (scheduled time was [2018-05-17T08:41:41.484Z])\r\n  1> [0030-05-16T23:11:41,898][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] not executing watch [_id]\r\n  1> [0030-05-16T23:11:41,917][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_10796f1d-24d7-4641-a476-e4636e36314e-2018-05-17T08:41:41.888Z]\r\n  1> [0030-05-16T23:11:41,918][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_10796f1d-24d7-4641-a476-e4636e36314e-2018-05-17T08:41:41.888Z]\r\n  1> [0030-05-16T23:11:42,889][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:42.889Z] (scheduled time was [2018-05-17T08:41:42.484Z])\r\n  1> [0030-05-16T23:11:42,896][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] not executing watch [_id]\r\n  1> [0030-05-16T23:11:42,916][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_01f560b6-3fb0-4f0c-9fe3-ba484294d68c-2018-05-17T08:41:42.889Z]\r\n  1> [0030-05-16T23:11:42,916][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_01f560b6-3fb0-4f0c-9fe3-ba484294d68c-2018-05-17T08:41:42.889Z]\r\n  1> [0030-05-16T23:11:43,890][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:43.890Z] (scheduled time was [2018-05-17T08:41:43.484Z])\r\n  1> [0030-05-16T23:11:43,895][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] not executing watch [_id]\r\n  1> [0030-05-16T23:11:43,906][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_97a15f56-5930-4e82-b458-e2b6b870ed61-2018-05-17T08:41:43.890Z]\r\n  1> [0030-05-16T23:11:43,906][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_97a15f56-5930-4e82-b458-e2b6b870ed61-2018-05-17T08:41:43.890Z]\r\n  1> [0030-05-16T23:11:44,892][DEBUG][o.e.x.w.t.s.e.TickerScheduleTriggerEngine] [node_s1] triggered job [_id] at [2018-05-17T08:41:44.892Z] (scheduled time was [2018-05-17T08:41:44.484Z])\r\n  1> [0030-05-16T23:11:44,897][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] not executing watch [_id]\r\n  1> [0030-05-16T23:11:44,905][DEBUG][o.e.x.w.h.HistoryStore   ] [node_s1] indexed watch history record [_id_e4aee542-c8e5-4fba-9dde-2a9884437840-2018-05-17T08:41:44.892Z]\r\n  1> [0030-05-16T23:11:44,905][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] finished [_id]/[_id_e4aee542-c8e5-4fba-9dde-2a9884437840-2018-05-17T08:41:44.892Z]\r\n  1> [0030-05-16T23:11:45,184][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] [#testDeactivateAndActivate]: clearing watcher state\r\n  1> [0030-05-16T23:11:45,185][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] waiting to stop watcher, current states [Tuple [v1=node_s1, v2=STARTED], Tuple [v1=node_s0, v2=STARTED]]\r\n  1> [0030-05-16T23:11:45,189][INFO ][o.e.x.w.WatcherService   ] [node_s0] stopping watch service, reason [watcher manually marked to shutdown by cluster state update]\r\n  1> [0030-05-16T23:11:45,192][INFO ][o.e.x.w.WatcherService   ] [node_s1] stopping watch service, reason [watcher manually marked to shutdown by cluster state update]\r\n  1> [0030-05-16T23:11:45,194][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] waiting to stop watcher, current states [Tuple [v1=node_s1, v2=STOPPED], Tuple [v1=node_s0, v2=STOPPED]]\r\n  1> [0030-05-16T23:11:45,195][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] [ActivateWatchTests#testDeactivateAndActivate]: cleaning up after test\r\n  1> [0030-05-16T23:11:45,213][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_s1] [.watcher-history-7-2018.05.17/cqrtFbcaTE6aYRZRLB-JYw] deleting index\r\n  1> [0030-05-16T23:11:45,213][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_s1] [actions/hNl-YuA4QeCc_0n50OTh7Q] deleting index\r\n  1> [0030-05-16T23:11:45,213][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_s1] [.triggered_watches/kEV-bkZoTOasgYLDdGBZUg] deleting index\r\n  1> [0030-05-16T23:11:45,213][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_s1] [.watches/a0PftyaGQKCi3mJSP0RuJA] deleting index\r\n  1> [0030-05-16T23:11:45,286][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s1] removing template [random_index_template]\r\n  1> [0030-05-16T23:11:45,292][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] [ActivateWatchTests#testDeactivateAndActivate]: cleaned up after test\r\n  1> [0030-05-16T23:11:45,292][INFO ][o.e.x.w.t.a.a.ActivateWatchTests] [testDeactivateAndActivate]: after test\r\n  2> REPRODUCE WITH: ./gradlew :x-pack:plugin:watcher:test -Dtests.seed=35E260511772D8B6 -Dtests.class=org.elasticsearch.xpack.watcher.transport.action.activate.ActivateWatchTests -Dtests.method=\"testDeactivateAndActivate\" -Dtests.security.manager=true -Dtests.locale=ja-JP-u-ca-japanese-x-lvariant-JP -Dtests.timezone=Pacific/Marquesas\r\nFAILURE 10.5s J1 | ActivateWatchTests.testDeactivateAndActivate <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: \r\n   > Expected: is <2L>\r\n   >      but: was <7L>\r\n   > \tat __randomizedtesting.SeedInfo.seed([35E260511772D8B6:95BA18ACD82B0ECA]:0)\r\n   > \tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   > \tat org.elasticsearch.xpack.watcher.transport.action.activate.ActivateWatchTests.testDeactivateAndActivate(ActivateWatchTests.java:97)\r\n   > \tat java.lang.Thread.run(Thread.java:748)```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/393260070","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-393260070","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":393260070,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MzI2MDA3MA==","user":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"created_at":"2018-05-30T18:02:34Z","updated_at":"2018-05-30T20:49:51Z","author_association":"CONTRIBUTOR","body":"Something interesting to note is that when I attempt to run this and slow it down with a debugger, i can repro the conflict (and I believe that there is code to retry on conflict), but i always see the following line after.\r\n\r\n```\r\n2018-05-30T23:42:13,433][DEBUG][o.e.x.w.e.ExecutionService] [node_sd4] executing watch [_id]\r\n[2018-05-30T23:42:13,441][DEBUG][o.e.x.w.h.HistoryStore   ] [node_sd4] indexed watch history record [_id_6e92b1ac-7781-49c3-8c51-7fee439b1c21-2018-05-30T17:56:53.753Z]\r\n...\r\n```\r\n\r\nWhereas with the logs above, the `\"executing watch...\"` is not present. \r\n\r\n### edit\r\n\r\nI was wrong, it is up there, \r\n```\r\n  1> [0030-05-16T23:11:37,875][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] executing watch [_id]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/394766311","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-394766311","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":394766311,"node_id":"MDEyOklzc3VlQ29tbWVudDM5NDc2NjMxMQ==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2018-06-05T16:03:50Z","updated_at":"2018-06-06T07:54:42Z","author_association":"MEMBER","body":"so, I stared at this test and its output a bit today, and I think the most important lines are the following:\r\n\r\n```\r\n39,448][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] executing watch [_id]\r\n39,483][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s1] removing watch [_id] to trigger service\r\n39,484][DEBUG][o.e.x.w.WatcherIndexingListener] [node_s1] adding watch [_id] to trigger service\r\n39,494][DEBUG][o.e.x.w.e.ExecutionService] [node_s1] failed to execute watch [_id]\r\n org.elasticsearch.index.engine.VersionConflictEngineException: [doc][_id]: version conflict, current version [3] is different than the one provided [2]\r\n```\r\n\r\nWhat happens here, is that the deactivate watch action first removes the watch from the trigger service. However, then the `ExecutionService.updateWatchStatus()` method is called and adds the watch back to the trigger service. However the index operation fails due to a version conflict exception.\r\n\r\nThe `WatcherIndexingListener.postIndex(ShardId, Engine.Index, Exception)` logging message is never logged, which means to me that in the mean time this node lost the authority (because the shard might have been moved to another node) over the local watcher shard and thus `triggerService.remove()` is never called.\r\n\r\nThis brings the question, if the `postIndex` method is the right place for this or if this should be executed in the caller code depending on success or failure, because that `triggerservice.remove()` might only make sense if put watch action, a ack watch or a activate watch action is executed, but not if the execution service is called. This requires some more thinking (and also a lot of this is speculation because it is super hard to reproduce this bug so far).\r\n\r\nJust as a side note: This does not mean that watches are executed more often than needed, because the watch is still not active, it only creates additional watch records telling that the watch is not active - which is why the failing assertion occurs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/465856565","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-465856565","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":465856565,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NTg1NjU2NQ==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2019-02-21T04:21:15Z","updated_at":"2019-02-21T04:21:15Z","author_association":"CONTRIBUTOR","body":"@hub-cap Are you still working on this?\r\nI have a plan for how to rework it to avoid the sleep and skip the inactive watch records, if you don't have something in progress.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466097978","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-466097978","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":466097978,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjA5Nzk3OA==","user":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"created_at":"2019-02-21T17:50:39Z","updated_at":"2019-02-21T17:50:39Z","author_association":"CONTRIBUTOR","body":"I do not have anything in progress here @tvernum. this fell off my radar a while ago :) Feel free to reassign it if you have something that will fix/close it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/496939102","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-496939102","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":496939102,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NjkzOTEwMg==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-05-29T13:34:58Z","updated_at":"2019-05-29T13:34:58Z","author_association":"CONTRIBUTOR","body":"Removed explicit sleep's and un-muted this test on PR #42396.  \r\n\r\nIf (when?) this test fails again please obtain the following information before muting the test:\r\n\r\n* Copy of the relevant failure\r\n* Copy of the reproduce line\r\n* The Jenkins build link \r\n* The Gradle scan link\r\n* The relevant cluster logs from \"Google Cloud Storage Upload Report\" (link found in Jenkins build)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500446416","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-500446416","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":500446416,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDQ0NjQxNg==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-06-10T14:53:20Z","updated_at":"2019-06-10T14:53:20Z","author_association":"CONTRIBUTOR","body":"This failed again here:\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=fedora-29&&immutable/23/testReport/org.elasticsearch.xpack.watcher.transport.action.activate/ActivateWatchTests/testDeactivateAndActivate/\r\n\r\nwith:\r\n```\r\njava.lang.AssertionError: All incoming requests on node [node_sd1] should have finished. Expected 0 but got 254\r\nExpected: <0L>\r\n     but: was <254L>\r\n\tat __randomizedtesting.SeedInfo.seed([F5D256C04064759:AF055D91CB5F9125]:0)\r\n\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\r\n\tat org.junit.Assert.assertThat(Assert.java:956)\r\n\tat org.elasticsearch.test.InternalTestCluster.lambda$assertRequestsFinished$35(InternalTestCluster.java:2297)\r\n\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:862)\r\n\tat org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:836)\r\n\tat org.elasticsearch.test.InternalTestCluster.assertRequestsFinished(InternalTestCluster.java:2294)\r\n\tat org.elasticsearch.test.InternalTestCluster.assertAfterTest(InternalTestCluster.java:2272)\r\n\tat org.elasticsearch.test.ESIntegTestCase.afterInternal(ESIntegTestCase.java:567)\r\n\tat org.elasticsearch.test.ESIntegTestCase.cleanUpCluster(ESIntegTestCase.java:2066)\r\n```\r\n\r\nGradle scan link:\r\n\r\nhttps://scans.gradle.com/s/jkajvplgqp2w6\r\n\r\nReproduce line:\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :x-pack:plugin:watcher:test --tests \"org.elasticsearch.xpack.watcher.transport.action.activate.ActivateWatchTests.testDeactivateAndActivate\" \\\r\n  -Dtests.seed=F5D256C04064759 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=ms \\\r\n  -Dtests.timezone=Etc/GMT-11 \\\r\n  -Dcompiler.java=12 \\\r\n  -Druntime.java=11\r\n```\r\n(did not reproduce locally for me).\r\n\r\nLogs from google storage:\r\n[log-files.tar.gz](https://github.com/elastic/elasticsearch/files/3272514/log-files.tar.gz)\r\n\r\nThis is the only failure since this was un-muted, so will leave this un-muted to allow getting data from further failures if necessary.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/505086083","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-505086083","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":505086083,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNTA4NjA4Mw==","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"created_at":"2019-06-24T16:36:13Z","updated_at":"2019-06-24T16:36:13Z","author_association":"CONTRIBUTOR","body":"This failed again: https://scans.gradle.com/s/wc2lqwkyuk2co","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/539028450","html_url":"https://github.com/elastic/elasticsearch/issues/30699#issuecomment-539028450","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30699","id":539028450,"node_id":"MDEyOklzc3VlQ29tbWVudDUzOTAyODQ1MA==","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"created_at":"2019-10-07T14:06:03Z","updated_at":"2019-10-07T14:06:03Z","author_association":"CONTRIBUTOR","body":"This has been addressed by https://github.com/elastic/elasticsearch/pull/47667 ... basically there is not a tight coupling between de-activating a watch and when the history will be written. Waiting some arbitrary time for something to NOT happen is error prone . The fix to remove the history assertion, and rely on the other aspects of the test to prove correctness.  ","performed_via_github_app":null}]