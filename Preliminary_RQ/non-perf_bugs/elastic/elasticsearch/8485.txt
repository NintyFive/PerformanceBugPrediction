{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8485","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8485/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8485/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8485/events","html_url":"https://github.com/elastic/elasticsearch/issues/8485","id":48793648,"node_id":"MDU6SXNzdWU0ODc5MzY0OA==","number":8485,"title":"unexpected results from aggregartions","user":{"login":"mruediger","id":377833,"node_id":"MDQ6VXNlcjM3NzgzMw==","avatar_url":"https://avatars1.githubusercontent.com/u/377833?v=4","gravatar_id":"","url":"https://api.github.com/users/mruediger","html_url":"https://github.com/mruediger","followers_url":"https://api.github.com/users/mruediger/followers","following_url":"https://api.github.com/users/mruediger/following{/other_user}","gists_url":"https://api.github.com/users/mruediger/gists{/gist_id}","starred_url":"https://api.github.com/users/mruediger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mruediger/subscriptions","organizations_url":"https://api.github.com/users/mruediger/orgs","repos_url":"https://api.github.com/users/mruediger/repos","events_url":"https://api.github.com/users/mruediger/events{/privacy}","received_events_url":"https://api.github.com/users/mruediger/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2014-11-14T14:13:15Z","updated_at":"2014-11-17T11:11:04Z","closed_at":"2014-11-17T11:11:04Z","author_association":"NONE","active_lock_reason":null,"body":"Hi. I am trying to use elasticsearch to store metrics of our cluster. The collection is done using sensu and the values in elasticsearch still have the fields \"key\",\"value\" and \"timestamp\" that you would see in graphite. When I create a average/max/min histogram over our metrics I get weird results. The average cpu utilisation of our cluster is 1.22907852E-315 according to elasticsearch. At first glance I suspected a overflow issue, but there are simply not enough results to cause that.\n\nThe json I am using is the following:\n\n```\n{\n  \"size\": 5,\n  \"query\": {\n    \"bool\": {\n      \"must\": [ { \"match\": { \"host\": \"poolnode-03\" } },\n                { \"match\": { \"metric\": \"cpu_metrics\" } },\n                { \"range\": {\n                    \"@timestamp\": {\n                       \"gte\" : \"2014-11-12T17:50:00\",\n                       \"lte\" : \"2014-11-12T17:51:00\"\n                    }\n                  }\n                }]\n    }     \n  },        \n  \"aggs\": {\n    \"cpu_histogram\": {\n      \"date_histogram\": {\n        \"field\": \"@timestamp\",\n        \"interval\": \"5000ms\",\n        \"min_doc_count\": 1\n      },\n      \"aggs\": {\n        \"avg_cpu\": { \"avg\": { \"field\": \"value\" } },\n        \"max_cpu\": { \"max\": { \"field\": \"value\" } },\n        \"min_cpu\": { \"min\": { \"field\": \"value\" } }\n      }\n    }\n  }\n}\n```\n\nThe result looks like this: \n\n```\n{\n  \"took\" : 13,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 408,\n    \"max_score\" : 3.4773107,\n    \"hits\" : [ {\n      \"_index\" : \"sensu\",\n      \"_type\" : \"cpu_metrics\",\n      \"_id\" : \"AUmlIK4cRrcdtiDjFlbQ\",\n      \"_score\" : 3.4773107,\n      \"_source\":{\"host\":\"poolnode-03\",\"metric\":\"cpu_metrics\",\"name\":\"poolnode-03.cpu.total.iowait\",\"value\":11637,\"@timestamp\":\"2014-11-12T17:50:22+00:00\"}\n    }, {\n      \"_index\" : \"sensu\",\n      \"_type\" : \"cpu_metrics\",\n      \"_id\" : \"AUmlIK4cRrcdtiDjFlbV\",\n      \"_score\" : 3.4773107,\n      \"_source\":{\"host\":\"poolnode-03\",\"metric\":\"cpu_metrics\",\"name\":\"poolnode-03.cpu.cpu0.user\",\"value\":15686755,\"@timestamp\":\"2014-11-12T17:50:22+00:00\"}\n    }, {\n      \"_index\" : \"sensu\",\n      \"_type\" : \"cpu_metrics\",\n      \"_id\" : \"AUmlIK4cRrcdtiDjFlbe\",\n      \"_score\" : 3.4773107,\n      \"_source\":{\"host\":\"poolnode-03\",\"metric\":\"cpu_metrics\",\"name\":\"poolnode-03.cpu.cpu1.user\",\"value\":12541923,\"@timestamp\":\"2014-11-12T17:50:22+00:00\"}\n    }, {\n      \"_index\" : \"sensu\",\n      \"_type\" : \"cpu_metrics\",\n      \"_id\" : \"AUmlIK4cRrcdtiDjFlbj\",\n      \"_score\" : 3.4773107,\n      \"_source\":{\"host\":\"poolnode-03\",\"metric\":\"cpu_metrics\",\"name\":\"poolnode-03.cpu.cpu1.irq\",\"value\":3,\"@timestamp\":\"2014-11-12T17:50:22+00:00\"}\n    }, {\n      \"_index\" : \"sensu\",\n      \"_type\" : \"cpu_metrics\",\n      \"_id\" : \"AUmlIK4cRrcdtiDjFlbo\",\n      \"_score\" : 3.4773107,\n      \"_source\":{\"host\":\"poolnode-03\",\"metric\":\"cpu_metrics\",\"name\":\"poolnode-03.cpu.ctxt\",\"value\":4585398711,\"@timestamp\":\"2014-11-12T17:50:22+00:00\"}\n    } ]\n  },\n  \"aggregations\" : {\n    \"cpu_histogram\" : {\n      \"buckets\" : [ {\n        \"key_as_string\" : \"2014-11-12T17:50:00.000Z\",\n        \"key\" : 1415814600000,\n        \"doc_count\" : 68,\n        \"min_cpu\" : {\n          \"value\" : 0.0\n        },\n        \"avg_cpu\" : {\n          \"value\" : 1.22906508E-315\n        },\n        \"max_cpu\" : {\n          \"value\" : 2.2995982737E-314\n        }\n      }, {\n        \"key_as_string\" : \"2014-11-12T17:50:10.000Z\",\n        \"key\" : 1415814610000,\n        \"doc_count\" : 68,\n        \"min_cpu\" : {\n          \"value\" : 0.0\n        },\n        \"avg_cpu\" : {\n          \"value\" : 1.229071915E-315\n        },\n        \"max_cpu\" : {\n          \"value\" : 2.2996008E-314\n        }\n      }, {\n        \"key_as_string\" : \"2014-11-12T17:50:20.000Z\",\n        \"key\" : 1415814620000,\n        \"doc_count\" : 68,\n        \"min_cpu\" : {\n          \"value\" : 0.0\n        },\n        \"avg_cpu\" : {\n          \"value\" : 1.229073614E-315\n        },\n        \"max_cpu\" : {\n          \"value\" : 2.29960331E-314\n        }\n      }, {\n        \"key_as_string\" : \"2014-11-12T17:50:30.000Z\",\n        \"key\" : 1415814630000,\n        \"doc_count\" : 68,\n        \"min_cpu\" : {\n          \"value\" : 0.0\n        },\n        \"avg_cpu\" : {\n          \"value\" : 1.22907528E-315\n        },\n        \"max_cpu\" : {\n          \"value\" : 2.2996057756E-314\n        }\n      }, {\n        \"key_as_string\" : \"2014-11-12T17:50:40.000Z\",\n        \"key\" : 1415814640000,\n        \"doc_count\" : 68,\n        \"min_cpu\" : {\n          \"value\" : 0.0\n        },\n        \"avg_cpu\" : {\n          \"value\" : 1.229076895E-315\n        },\n        \"max_cpu\" : {\n          \"value\" : 2.2996081945E-314\n        }\n      }, {\n        \"key_as_string\" : \"2014-11-12T17:50:50.000Z\",\n        \"key\" : 1415814650000,\n        \"doc_count\" : 68,\n        \"min_cpu\" : {\n          \"value\" : 0.0\n        },\n        \"avg_cpu\" : {\n          \"value\" : 1.22907852E-315\n        },\n        \"max_cpu\" : {\n          \"value\" : 2.2996107306E-314\n        }\n      } ]\n    }\n  }\n}\n```\n\nI checked the mapping of the type and everything looks good:\n\n```\n{\n  \"sensu\" : {\n    \"mappings\" : {\n      \"cpu_metrics\" : {\n        \"properties\" : {\n          \"@timestamp\" : {\n            \"type\" : \"date\",\n            \"format\" : \"dateOptionalTime\"\n          },\n          \"host\" : {\n            \"type\" : \"string\"\n          },\n          \"metric\" : {\n            \"type\" : \"string\"\n          },\n          \"name\" : {\n            \"type\" : \"string\"\n          },\n          \"value\" : {\n            \"type\" : \"long\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nI suspect I misunderstood some of the syntax and the error is on my side, but after studying the documentation for quite a while I still cannot figure out what is wrong with my search.\n\nThanks,\nMathias\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}