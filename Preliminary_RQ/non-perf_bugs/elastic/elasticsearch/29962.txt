{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29962","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29962/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29962/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29962/events","html_url":"https://github.com/elastic/elasticsearch/issues/29962","id":317450010,"node_id":"MDU6SXNzdWUzMTc0NTAwMTA=","number":29962,"title":"Improve user experience when encountering .security index in old format from 5.x","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-11-14T01:45:05Z","updated_at":"2019-11-01T15:45:21Z","closed_at":"2019-11-01T15:45:21Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @jasontedor:*\n\nToday it is possible to end up in a state with a `.security` index in the old 5.x format in a 6.x cluster:\r\n - perform a full cluster restart upgrade from 5.x without having upgraded the `.security` index\r\n - restore a snapshot into a fresh cluster taken on 5.x when the `.security` index is in the old 5.x format\r\n\r\nThese lead to the native realm being non-operational. The best course of course of action for the user at this point is to create a file realm user, execute the upgrade API, and then remove the file realm user. The error message when the system is in this state does not give the user enough actionable information to discover this course of action:\r\n\r\n```\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"security_exception\",\r\n        \"reason\" : \"error attempting to authenticate request\",\r\n        \"header\" : {\r\n          \"WWW-Authenticate\" : \"Basic realm=\\\"security\\\" charset=\\\"UTF-8\\\"\"\r\n        }\r\n      }\r\n    ],\r\n    \"type\" : \"security_exception\",\r\n    \"reason\" : \"error attempting to authenticate request\",\r\n    \"caused_by\" : {\r\n      \"type\" : \"illegal_state_exception\",\r\n      \"reason\" : \"Security index is not on the current version - the native realm will not be operational until the upgrade API is run on the security index\"\r\n    },\r\n    \"header\" : {\r\n      \"WWW-Authenticate\" : \"Basic realm=\\\"security\\\" charset=\\\"UTF-8\\\"\"\r\n    }\r\n  },\r\n  \"status\" : 401\r\n}\r\n```\r\n\r\nAt a minimum, we need to give a more actionable error message here. We should also think through whether or not we should block the restore (it's worth considering, but I am not convinced it's worth it). Note: we can not prevent this scenario from arising in the full cluster restart case.\r\n\r\nLastly, we should document this as a known issue for the 6.0.0 release with more actionable information in the release notes.","closed_by":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"performed_via_github_app":null}