{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16852","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16852/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16852/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16852/events","html_url":"https://github.com/elastic/elasticsearch/issues/16852","id":137224649,"node_id":"MDU6SXNzdWUxMzcyMjQ2NDk=","number":16852,"title":"ES client node may get OOM if the data node lags","user":{"login":"Dieken","id":2365,"node_id":"MDQ6VXNlcjIzNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/2365?v=4","gravatar_id":"","url":"https://api.github.com/users/Dieken","html_url":"https://github.com/Dieken","followers_url":"https://api.github.com/users/Dieken/followers","following_url":"https://api.github.com/users/Dieken/following{/other_user}","gists_url":"https://api.github.com/users/Dieken/gists{/gist_id}","starred_url":"https://api.github.com/users/Dieken/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Dieken/subscriptions","organizations_url":"https://api.github.com/users/Dieken/orgs","repos_url":"https://api.github.com/users/Dieken/repos","events_url":"https://api.github.com/users/Dieken/events{/privacy}","received_events_url":"https://api.github.com/users/Dieken/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-02-29T11:19:06Z","updated_at":"2016-03-05T12:11:07Z","closed_at":"2016-02-29T13:07:40Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:  2.2.0\n\n**JVM version**:  Oracle JDK 1.8.0_60-b27\n\n**OS version**: CentOS 6.6\n\n**Description of the problem including expected versus actual behavior**:\n\n**Steps to reproduce**:\n1.  get some ES client nodes (node.client: true) in front of some ES data nodes(node.data: true)\n2.  ingest documents in a very high traffic volume to ES client nodes\n3.  sometimes the data nodes lag (maybe doing index merge), but ES client nodes still receive documents and may get OOM,  the expected behaviour is ES client nodes refuse new requests or just disable channel read for a while.\n\nIn my use case, I allocate 10G heap for ES client node,  it can accumulate about 6G requests and then gets OOM soon, here is the jhat analysis on the heap dump(it's almost OOM but not yet, sorry for the bad typesetting below),  I confirmed most \"class [B\" instances are referenced by org.elasticsearch.http.netty.NettyHttpRequest.\n\n```\nClass   Instance Count  Total Size\nclass [B    955327  6514870246\nclass [C    40860058    1838467108\nclass java.lang.String  40852528    490230336\nclass org.elasticsearch.action.index.IndexResponse  6605067     429329355\nclass org.elasticsearch.action.bulk.BulkItemResponse    9517699     266495572\nclass [Ljava.lang.Object;   249443  165445416\nclass org.elasticsearch.action.bulk.BulkItemResponse$Failure    2912632     116505280\nclass [I    953017  100724932\nclass org.elasticsearch.action.index.IndexRequest   468109  68812023\nclass org.jboss.netty.buffer.BigEndianHeapChannelBuffer     2079219     49901256\nclass java.lang.StackTraceElement   1206188     33773264\nclass [Ljava.util.HashMap$Node;     113947  18542872\nclass java.util.HashMap     345776  16597248\nclass org.jboss.netty.buffer.SlicedChannelBuffer    475522  15216704\nclass [Lorg.jboss.netty.buffer.ChannelBuffer;   45252   12156088\nclass [Ljava.lang.StackTraceElement;    88263   11062296\nclass org.elasticsearch.action.bulk.BulkItemRequest     472770  9928170\nclass java.util.HashMap$Node    350723  9820244\nclass [S    117658  9414512\nclass org.elasticsearch.common.bytes.ChannelBufferBytesReference    477579  3820632\nclass [Lorg.elasticsearch.action.bulk.BulkItemRequest;  4706    3805056\nclass org.elasticsearch.transport.RemoteTransportException  58822   3764608\nclass com.chenlb.mmseg4j.CharNode$TreeNode  248024  2728264\nclass org.jboss.netty.buffer.CompositeChannelBuffer     42523   1913535\nclass java.util.ArrayList   115491  1847856\nclass java.net.InetAddress$InetAddressHolder    67734   1625616\nclass com.fasterxml.jackson.core.json.UTF8StreamJsonParser  7477    1622509\nclass java.net.InetSocketAddress$InetSocketAddressHolder    75698   1513960\nclass org.elasticsearch.common.util.concurrent.EsRejectedExecutionException     29411   1441139\nclass [Lorg.elasticsearch.action.ActionWriteResponse$ShardInfo$Failure;     87248   1395968\nclass org.elasticsearch.action.ActionWriteResponse$ShardInfo    87247   1395952\nclass com.fasterxml.jackson.core.json.JsonReadContext   22435   1256360\nclass java.net.Inet4Address     67734   1083744\nclass org.jboss.netty.buffer.TruncatedChannelBuffer     38175   1068900\nclass org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext   19147   957350\nclass org.jboss.netty.handler.codec.http.DefaultHttpHeaders$HeaderEntry     14257   741364\nclass java.lang.Class   7129    655868\nclass org.elasticsearch.cluster.routing.ShardRouting    5902    625612\nclass java.net.InetSocketAddress    75698   605584\nclass sun.nio.ch.SocketChannelImpl  4035    589110\nclass org.jboss.netty.channel.socket.nio.NioAcceptedSocketChannel   2944    562304\nclass com.fasterxml.jackson.core.io.IOContext   7477    545821\nclass java.util.concurrent.ConcurrentHashMap$Node   19442   544376\nclass com.fasterxml.jackson.core.sym.ByteQuadsCanonicalizer     7480    508640\nclass java.lang.Character   248083  496166\nclass org.elasticsearch.common.transport.InetSocketTransportAddress     60871   486968\nclass com.fasterxml.jackson.core.util.TextBuffer    7477    486005\nclass [D    16  369768\nclass org.elasticsearch.cluster.routing.PlainShardIterator  17418   348360\nclass [Ljava.util.concurrent.ConcurrentHashMap$Node;    60  327680\nclass com.fasterxml.jackson.core.json.ByteSourceJsonBootstrapper    7477    314034\nclass [Lorg.jboss.netty.handler.codec.http.DefaultHttpHeaders$HeaderEntry;  2044    310688\nclass org.elasticsearch.action.bulk.BulkShardRequest    4706    310596\nclass org.elasticsearch.cluster.ClusterStateObserver    4705    305825\nclass java.util.Collections$UnmodifiableRandomAccessList    18381   294096\nclass org.elasticsearch.cluster.routing.IndexShardRoutingTable  2951    286247\nclass org.elasticsearch.action.bulk.TransportBulkAction$2   4705    263480\nclass com.carrotsearch.hppc.ObjectObjectHashMap     5264    257936\nclass com.chenlb.mmseg4j.CharNode   12726   254520\nclass sun.nio.cs.US_ASCII$Decoder   5260    241960\nclass org.jboss.netty.channel.socket.nio.NioClientSocketChannel     1092    235872\nclass org.jboss.netty.channel.AbstractChannel$ChannelCloseFuture    4038    218052\nclass org.jboss.netty.channel.socket.nio.DefaultNioSocketChannelConfig  4034    193632\nclass org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase  4705    188200\nclass [Ljava.io.Closeable;  7690    184560 \n```\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}