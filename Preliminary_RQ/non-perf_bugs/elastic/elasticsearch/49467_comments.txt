[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/557269081","html_url":"https://github.com/elastic/elasticsearch/issues/49467#issuecomment-557269081","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49467","id":557269081,"node_id":"MDEyOklzc3VlQ29tbWVudDU1NzI2OTA4MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-11-21T20:58:37Z","updated_at":"2019-11-21T20:58:37Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/566602022","html_url":"https://github.com/elastic/elasticsearch/issues/49467#issuecomment-566602022","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49467","id":566602022,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NjYwMjAyMg==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2019-12-17T15:52:35Z","updated_at":"2019-12-17T15:52:35Z","author_association":"MEMBER","body":"The timeout failure is not a one off I've found another recently: https://gradle-enterprise.elastic.co/s/xjcyfh4xigvvm\r\n\r\nIn both cases the suite times out and jstack shows this stack trace on the client:\r\n```\r\n\"TEST-SetUpgradeModeIT.testEnableUpgradeMode-seed#[33082EFCEF9D5830]\" ID=96 WAITING on org.elasticsearch.common.util.concurrent.BaseFuture$Sync@1d211a26\r\n    at sun.misc.Unsafe.park(Native Method)\r\n    - waiting on org.elasticsearch.common.util.concurrent.BaseFuture$Sync@1d211a26\r\n    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)\r\n    at java.util.concurrent.locks.AbstractQueuedSynchronizer.parkAndCheckInterrupt(AbstractQueuedSynchronizer.java:836)\r\n    at java.util.concurrent.locks.AbstractQueuedSynchronizer.doAcquireSharedInterruptibly(AbstractQueuedSynchronizer.java:997)\r\n    at java.util.concurrent.locks.AbstractQueuedSynchronizer.acquireSharedInterruptibly(AbstractQueuedSynchronizer.java:1304)\r\n    at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:252)\r\n    at org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:87)\r\n    at org.elasticsearch.common.util.concurrent.FutureUtils.get(FutureUtils.java:57)\r\n    at org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:34)\r\n    at org.elasticsearch.xpack.ml.integration.MlNativeAutodetectIntegTestCase.stopDatafeed(MlNativeAutodetectIntegTestCase.java:177)\r\n    at org.elasticsearch.xpack.ml.integration.MlNativeAutodetectIntegTestCase.cleanUpDatafeeds(MlNativeAutodetectIntegTestCase.java:96)\r\n    at org.elasticsearch.xpack.ml.integration.MlNativeAutodetectIntegTestCase.cleanUpResources(MlNativeAutodetectIntegTestCase.java:89)\r\n    at org.elasticsearch.xpack.ml.integration.MlNativeIntegTestCase.cleanUp(MlNativeIntegTestCase.java:98)\r\n    at org.elasticsearch.xpack.ml.integration.SetUpgradeModeIT.cleanup(SetUpgradeModeIT.java:44)\r\n```\r\n\r\nThe test is passing but there is a problem stopping the datafeed in the cleanup. Later tests are failing because the persistent task associated with the datafeed has not stopped and the stop datafeed transport action is still running. \r\n\r\n```\r\nxpack/ml/datafeed[c]                 klrAQw8HQ1qTn7SZe4ZvEw:1740  cluster:7                    persistent 1575459442578 11:37:22 26.9m       127.0.0.1 integTest-1 datafeed-realtime-job-test-enable-upgrade-mode-datafeed\r\ncluster:admin/xpack/ml/datafeed/stop 0_wtc71iQ4C5t6vbmt3oQA:1591  -                            transport  1575459442642 11:37:22 26.9m          \r\n```\r\n\r\nThat is interesting because `admin/xpack/ml/datafeed/stop` has a timeout of 5 minutes but the test times out after 20 minutes. From the logs I surmise the stop request has been hanging for a good 20 minutes.\r\n\r\nThe test toggles ML upgrade mode which stops the job and datafeed. When upgrade mode is turned back on the datafeed automatically restarts and the test succeeds when the datafeed is assigned a node. Test teardown then stops the datafeed. I think the problem is a race condition between the datafeed re-starting and it being stopped in the teardown, i.e. when the datafeed says it has been assigned to a node it has not started then the stop request hangs on a datafeed that has not started. The logs support this:\r\n\r\n```\r\n// This is the stop request sent by test cleanup\r\n[2019-12-04T11:37:22,720][INFO ][o.e.x.m.d.DatafeedManager] [integTest-1] [stop_datafeed (api)] attempt to stop datafeed [realtime-job-test-enable-upgrade-mode-datafeed] [7]\r\n...\r\n// This is the datafeed re-starting after upgrade mode is turned off but is happening chronologically after the stop request\r\n[2019-12-04T11:37:22,752][INFO ][o.e.x.m.d.DatafeedJob    ] [integTest-1] [realtime-job-test-enable-upgrade-mode] Datafeed started (from: 2019-12-04T11:37:17.799Z to: real-time) with frequency [1000ms]\r\n```\r\n\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/577136749","html_url":"https://github.com/elastic/elasticsearch/issues/49467#issuecomment-577136749","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49467","id":577136749,"node_id":"MDEyOklzc3VlQ29tbWVudDU3NzEzNjc0OQ==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-01-22T11:23:48Z","updated_at":"2020-01-22T11:23:48Z","author_association":"MEMBER","body":"Possibly fixed by #51302 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/577147958","html_url":"https://github.com/elastic/elasticsearch/issues/49467#issuecomment-577147958","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49467","id":577147958,"node_id":"MDEyOklzc3VlQ29tbWVudDU3NzE0Nzk1OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-01-22T11:57:59Z","updated_at":"2020-01-22T11:57:59Z","author_association":"CONTRIBUTOR","body":"> Possibly fixed by #51302\r\n\r\nInterestingly from https://github.com/elastic/elasticsearch/issues/51285#issuecomment-577145655:\r\n\r\n> It looks like the resulting NPE is ignored in `AllocatedPersistentTask.completeAndNotifyIfNeeded` since the task is already completed.\r\n\r\nThis would explain why no NPE was observed in the triage of this issue, and makes it highly likely that #51302 does fix this.\r\n\r\nTherefore I'll close this optimistically.  Please reopen if it happens again.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/577156213","html_url":"https://github.com/elastic/elasticsearch/issues/49467#issuecomment-577156213","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49467","id":577156213,"node_id":"MDEyOklzc3VlQ29tbWVudDU3NzE1NjIxMw==","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"created_at":"2020-01-22T12:22:37Z","updated_at":"2020-01-22T12:22:37Z","author_association":"MEMBER","body":"Copying from https://github.com/elastic/elasticsearch/pull/51302#issuecomment-577136095 the following explains the reason for the timeout:\r\n\r\n> I would have spotted in NPE in the logs when triaging #49467. That test timed out waiting for the datafeed to stop, my theory is the NPE took down the worker thread that is vital in stopping the DF so a stopped status was never reached.\r\n","performed_via_github_app":null}]