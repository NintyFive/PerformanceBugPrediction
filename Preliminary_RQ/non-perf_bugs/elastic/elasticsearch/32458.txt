{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32458","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32458/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32458/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32458/events","html_url":"https://github.com/elastic/elasticsearch/issues/32458","id":345666978,"node_id":"MDU6SXNzdWUzNDU2NjY5Nzg=","number":32458,"title":"[CI] Multiple invocations of repository_s3/20_repository_permanent_credentials can interact","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-07-30T08:51:45Z","updated_at":"2018-12-06T15:45:27Z","closed_at":"2018-12-06T15:45:25Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"`repository_s3/20_repository_permanent_credentials/Snapshot and Restore with repository-s3 using permanent credentials` failed with the following error:\r\n\r\n```\r\nFailure at [repository_s3/20_repository_permanent_credentials:64]: expected [2xx] status code but api [snapshot.create] returned [400 Bad Request] [{\"error\":{\"root_cause\":[{\"type\":\"invalid_snapshot_name_exception\",\"reason\":\"[repository_permanent:snapshot-one] Invalid snapshot name [snapshot-one], snapshot with the same name already exists\",\"stack_trace\":\"InvalidSnapshotNameException[[repository_permanent:snapshot-one] Invalid snapshot name [snapshot-one], snapshot with the same name already exists]\r\n```\r\n\r\nThis does not trivially reproduce, but it looks like it could happen if there were two test runs in CI at the same time for the same branch.  CI sets the environment variable `amazon_s3_base_path={branch}` and this is what the test uses for its \"permanent\" repository.\r\n\r\nThe full failure log is https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+third-party-tests/35/console\r\n\r\nThe repro command is:\r\n\r\n```\r\n./gradlew :plugins:repository-s3:integTestRunner \\\r\n  -Dtests.seed=1FD0A748E26205B \\\r\n  -Dtests.class=org.elasticsearch.repositories.s3.RepositoryS3ClientYamlTestSuiteIT \\\r\n  -Dtests.method=\"test {yaml=repository_s3/20_repository_permanent_credentials/Snapshot and Restore with repository-s3 using permanent credentials}\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=sv-SE \\\r\n  -Dtests.timezone=America/Lower_Princes\r\n```","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}