{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53174","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53174/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53174/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53174/events","html_url":"https://github.com/elastic/elasticsearch/issues/53174","id":576330856,"node_id":"MDU6SXNzdWU1NzYzMzA4NTY=","number":53174,"title":"unfollow call not returning when remote cluster is not available","user":{"login":"jepert","id":61747460,"node_id":"MDQ6VXNlcjYxNzQ3NDYw","avatar_url":"https://avatars2.githubusercontent.com/u/61747460?v=4","gravatar_id":"","url":"https://api.github.com/users/jepert","html_url":"https://github.com/jepert","followers_url":"https://api.github.com/users/jepert/followers","following_url":"https://api.github.com/users/jepert/following{/other_user}","gists_url":"https://api.github.com/users/jepert/gists{/gist_id}","starred_url":"https://api.github.com/users/jepert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jepert/subscriptions","organizations_url":"https://api.github.com/users/jepert/orgs","repos_url":"https://api.github.com/users/jepert/repos","events_url":"https://api.github.com/users/jepert/events{/privacy}","received_events_url":"https://api.github.com/users/jepert/received_events","type":"User","site_admin":false},"labels":[{"id":912824565,"node_id":"MDU6TGFiZWw5MTI4MjQ1NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CCR","name":":Distributed/CCR","color":"0e8a16","default":false,"description":"Issues around the Cross Cluster State Replication features"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-05T15:21:19Z","updated_at":"2020-03-08T12:59:00Z","closed_at":"2020-03-08T12:59:00Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): \r\n\r\nVersion: 7.6.1, Build: default/rpm/aa751e09be0a5072e8570670309b1f12348f023b/2020-02-29T00:15:25.529771Z, JVM: 13.0.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\nopenjdk version \"13.0.2\" 2020-01-14\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 13.0.2+8)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13.0.2+8, mixed mode, sharing)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nLinux 3.10.0-1062.12.1.el7.x86_64 #1 SMP Tue Feb 4 23:02:59 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nTesting a disaster recovery scenario with ccr I found two different behaviours  unfollowing indices when the leader is not available (remote cluster is down)\r\n\r\n1) The unfollow call returns immediately with connect_transport_exception exceptions \r\n\r\n2) The unfollow call never returns (i waited for more than an hour)\r\nThe cluster shows the unfollow task running but never dies.\r\nThis second case seems to happens with indices with number_shards > 1\r\n\r\nExpected behavior: both  cases returning with status.\r\n\r\n**Steps to reproduce**:\r\nTo reproduce I did a fresh install of 2 clusters with 3 nodes each with latest version of ES (rpm)\r\n\r\nelasticsearch.yml :\r\n\r\n```\r\ncluster.name: primary\r\nnode.name: node1\r\npath.data: /var/lib/elasticsearch\r\npath.logs: /var/log/elasticsearch\r\nbootstrap.memory_lock: true\r\nnetwork.host: _eth0_\r\nhttp.port: 9200\r\ndiscovery.seed_hosts: [\"192.168.1.219\", \"192.168.1.222\", \"192.168.1.223\"]\r\ncluster.initial_master_nodes: [\"node1\", \"node2\", \"node3\"]\r\ngateway.recover_after_nodes: 2\r\nxpack.security.enabled: true\r\nxpack.security.transport.ssl.enabled: true\r\nxpack.security.transport.ssl.verification_mode: certificate\r\nxpack.security.transport.ssl.keystore.path: elastic-certificates.p12\r\nxpack.security.transport.ssl.truststore.path: elastic-certificates.p12\r\n\r\n```\r\nSteps:\r\n\r\n#Start trial on both cluster\r\n```\r\ncurl -X POST \"192.168.1.219:9200/_license/start_trial?acknowledge=true&pretty\" -u elastic:badpassword\r\ncurl -X POST \"192.168.1.226:9200/_license/start_trial?acknowledge=true&pretty\" -u elastic:badpassword\r\n\r\n```\r\n#remote cluster connection\r\n\r\n```\r\ncurl -u elastic:badpassword -X PUT \"192.168.1.226:9200/_cluster/settings?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"persistent\": {\r\n    \"cluster\": {\r\n      \"remote\": {\r\n        \"remote-primary\": {\r\n          \"seeds\": [\r\n            \"192.168.1.219:9300\"\r\n          ],\r\n          \"transport.ping_schedule\": \"30s\"\r\n        }\r\n        }\r\n      }\r\n    }\r\n  }\r\n'\r\n\r\n```\r\n#Verify remote \r\n```\r\ncurl -XGET  'http://192.168.1.226:9200/_remote/info' -u elastic:badpassword \r\n```\r\n#Create leader index with 1 shard on primary cluster\r\n```\r\ncurl -u elastic:badpassword -X PUT \"192.168.1.219:9200/testing-11?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 1, \r\n            \"number_of_replicas\" : 1 \r\n        }\r\n    }\r\n}\r\n'\r\n```\r\n#Create leader index with 2 shards on primary cluster\r\n```\r\ncurl -u elastic:badpassword -X PUT \"192.168.1.219:9200/testing-21?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 2, \r\n            \"number_of_replicas\" : 1 \r\n        }\r\n    }\r\n}\r\n'\r\n\r\n```\r\n\r\n#Verify new indices\r\n\r\n`curl -XGET  'http://192.168.1.219:9200/_cat/indices/test*?v' -u elastic:badpassword\r\n`\r\n\r\n#Create followers on secondary cluster\r\n\r\n```\r\ncurl -u elastic:badpassword -X PUT \"192.168.1.226:9200/testing-11/_ccr/follow?wait_for_active_shards=1&pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"remote_cluster\" : \"remote-primary\",\r\n  \"leader_index\" : \"testing-11\"\r\n}\r\n'\r\n\r\n\r\ncurl -u elastic:badpassword -X PUT \"192.168.1.226:9200/testing-21/_ccr/follow?wait_for_active_shards=1&pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"remote_cluster\" : \"remote-primary\",\r\n  \"leader_index\" : \"testing-21\"\r\n}\r\n'\r\n```\r\n#Verify followers \r\n\r\n```\r\ncurl -XGET  'http://192.168.1.226:9200/_cat/indices/test*?v' -u elastic:badpassword\r\ncurl -XGET  'http://192.168.1.226:9200/_ccr/stats?pretty' -u elastic:badpassword\r\n```\r\n#Shutdown primary cluster nodes\r\n```\r\nsystemctl stop elasticsearch\r\n```\r\n#Verify ccr status \r\n```\r\ncurl -XGET  'http://192.168.1.226:9200/_remote/info' -u elastic:badpassword\r\ncurl -XGET  'http://192.168.1.226:9200/_ccr/stats?pretty&filter_path=follow_stats.indices.shards.read_exceptions.*' -u elastic:badpassword\r\n```\r\n#Pause following on both indices and verify\r\n```\r\ncurl -u elastic:badpassword -X POST \"192.168.1.226:9200/testing-11/_ccr/pause_follow?pretty\"\r\ncurl -u elastic:badpassword -X POST \"192.168.1.226:9200/testing-21/_ccr/pause_follow?pretty\"\r\ncurl -XGET  'http://192.168.1.226:9200/testing-*/_ccr/info?pretty' -u elastic:badpassword\r\n```\r\n#Close\r\n```\r\ncurl -u elastic:badpassword -X POST \"192.168.1.226:9200/testing-11/_close?pretty\"\r\ncurl -u elastic:badpassword -X POST \"192.168.1.226:9200/testing-21/_close?pretty\"\r\ncurl -XGET  'http://192.168.1.226:9200/_cat/indices/test*?v' -u elastic:badpassword\r\n```\r\n#unfollow\r\n\r\n#this call to unfollow return a  connect_transport_exception\r\n```\r\ncurl -u elastic:badpassword -X POST \"192.168.1.226:9200/testing-11/_ccr/unfollow?pretty\"\r\n```\r\n#this call to unfollow never returns\r\n```\r\ncurl -u elastic:badpassword -X POST \"192.168.1.226:9200/testing-21/_ccr/unfollow?pretty\"\r\n```\r\n#Verify long running tasks\r\n```\r\ncurl -XGET  'http://192.168.1.226:9200/_cat/tasks?v' -u elastic:badpassword\r\n```\r\n```\r\naction                           task_id                      parent_task_id              type      start_time    timestamp running_time ip            node\r\nindices:admin/xpack/ccr/unfollow V-frNb4_Sc2RTGZ_uYne-g:665   -                           transport 1583414050796 13:14:10  2h           192.168.1.226 node3s\r\nindices:admin/xpack/ccr/unfollow dm-h5Zx7TxCUoOvn1I_DWQ:1208  V-frNb4_Sc2RTGZ_uYne-g:665  transport 1583414050798 13:14:10  2h           192.168.1.224 node2s\r\ncluster:monitor/tasks/lists      V-frNb4_Sc2RTGZ_uYne-g:8609  -                           transport 1583421254522 15:14:14  756.7micros  192.168.1.226 node3s\r\ncluster:monitor/tasks/lists[n]   V-frNb4_Sc2RTGZ_uYne-g:8610  V-frNb4_Sc2RTGZ_uYne-g:8609 direct    1583421254523 15:14:14  241.5micros  192.168.1.226 node3s\r\ncluster:monitor/tasks/lists[n]   dm-h5Zx7TxCUoOvn1I_DWQ:16577 V-frNb4_Sc2RTGZ_uYne-g:8609 transport 1583421254530 15:14:14  247.2micros  192.168.1.224 node2s\r\ncluster:monitor/tasks/lists[n]   YIzbKYCoQ-SDyJTkAVSBQg:8917  V-frNb4_Sc2RTGZ_uYne-g:8609 transport 1583421254533 15:14:14  343.3micros  192.168.1.225 node1s\r\n```\r\n\r\n\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n[secondary-v761-node1s.log](https://github.com/elastic/elasticsearch/files/4293535/secondary-v761-node1s.log)\r\n\r\n[secondary-v761-node2s.log](https://github.com/elastic/elasticsearch/files/4293523/secondary-v761-node2s.log)\r\n\r\n[secondary-v761-node3s.log](https://github.com/elastic/elasticsearch/files/4293538/secondary-v761-node3s.log)\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}