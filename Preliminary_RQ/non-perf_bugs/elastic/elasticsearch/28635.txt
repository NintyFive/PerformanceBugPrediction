{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28635","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28635/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28635/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28635/events","html_url":"https://github.com/elastic/elasticsearch/issues/28635","id":296395475,"node_id":"MDU6SXNzdWUyOTYzOTU0NzU=","number":28635,"title":"Support Map entry key type other than String in Painless","user":{"login":"cbismuth","id":21545602,"node_id":"MDQ6VXNlcjIxNTQ1NjAy","avatar_url":"https://avatars1.githubusercontent.com/u/21545602?v=4","gravatar_id":"","url":"https://api.github.com/users/cbismuth","html_url":"https://github.com/cbismuth","followers_url":"https://api.github.com/users/cbismuth/followers","following_url":"https://api.github.com/users/cbismuth/following{/other_user}","gists_url":"https://api.github.com/users/cbismuth/gists{/gist_id}","starred_url":"https://api.github.com/users/cbismuth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbismuth/subscriptions","organizations_url":"https://api.github.com/users/cbismuth/orgs","repos_url":"https://api.github.com/users/cbismuth/repos","events_url":"https://api.github.com/users/cbismuth/events{/privacy}","received_events_url":"https://api.github.com/users/cbismuth/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-02-12T14:34:43Z","updated_at":"2018-02-16T14:05:43Z","closed_at":"2018-02-16T14:05:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the feature**: support `Map` entry key type other than `String` in Painless\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**: `6.1.1`\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: `1.8.0_151`\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Linux dmal-insels02 4.4.0-87-generic #110-Ubuntu SMP Tue Jul 18 12:55:35 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen sharing a Map instance between nodes in Painless, keys have to be String instances. A better approach could be to support any type supported by the String#valueOf API.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Setup a multi-nodes Elasticsearch instance\r\n 2. Create a Painless script with a init phase with a `Map<Long, Long>` variable and a reduce phase to aggregate these values\r\n 3. See error in log output file `Caused by: org.elasticsearch.common.io.stream.NotSerializableExceptionWrapper: class_cast_exception: java.lang.Long cannot be cast to java.lang.String\r\n`\r\n\r\nIt may be implement in the line shown below.\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/v6.2.1/server/src/main/java/org/elasticsearch/common/io/stream/StreamOutput.java#L571\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\norg.elasticsearch.transport.RemoteTransportException: [dmal-insels04][10.10.13.220:9300][indices:data/read/search[phase/query]]\r\nCaused by: org.elasticsearch.common.io.stream.NotSerializableExceptionWrapper: class_cast_exception: java.lang.Long cannot be cast to java.lang.String\r\n\tat org.elasticsearch.common.io.stream.StreamOutput.lambda$static$11(StreamOutput.java:571) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.io.stream.StreamOutput.writeGenericValue(StreamOutput.java:662) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.io.stream.StreamOutput.lambda$static$11(StreamOutput.java:572) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.io.stream.StreamOutput.writeGenericValue(StreamOutput.java:662) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.aggregations.metrics.scripted.InternalScriptedMetric.doWriteTo(InternalScriptedMetric.java:66) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregation.writeTo(InternalAggregation.java:103) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteable(StreamOutput.java:883) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.io.stream.StreamOutput.writeNamedWriteableList(StreamOutput.java:961) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.writeTo(InternalAggregations.java:99) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.query.QuerySearchResult.writeToNoId(QuerySearchResult.java:334) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.query.QuerySearchResult.writeTo(QuerySearchResult.java:315) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.transport.TcpTransport.buildMessage(TcpTransport.java:1234) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.transport.TcpTransport.sendResponse(TcpTransport.java:1187) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.transport.TcpTransport.sendResponse(TcpTransport.java:1169) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.transport.TcpTransportChannel.sendResponse(TcpTransportChannel.java:62) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.transport.TcpTransportChannel.sendResponse(TcpTransportChannel.java:56) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:54) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6$1.onResponse(SearchTransportService.java:380) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6$1.onResponse(SearchTransportService.java:376) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:310) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:306) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:996) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:637) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.1.1.jar:6.1.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_151]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_151]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_151]\r\n```","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}