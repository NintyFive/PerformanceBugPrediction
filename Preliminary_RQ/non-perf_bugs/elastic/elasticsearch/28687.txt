{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28687","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28687/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28687/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28687/events","html_url":"https://github.com/elastic/elasticsearch/issues/28687","id":297378969,"node_id":"MDU6SXNzdWUyOTczNzg5Njk=","number":28687,"title":"ES Crash: 'Failed to close SearcherManager'","user":{"login":"DropCloth","id":36500662,"node_id":"MDQ6VXNlcjM2NTAwNjYy","avatar_url":"https://avatars0.githubusercontent.com/u/36500662?v=4","gravatar_id":"","url":"https://api.github.com/users/DropCloth","html_url":"https://github.com/DropCloth","followers_url":"https://api.github.com/users/DropCloth/followers","following_url":"https://api.github.com/users/DropCloth/following{/other_user}","gists_url":"https://api.github.com/users/DropCloth/gists{/gist_id}","starred_url":"https://api.github.com/users/DropCloth/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DropCloth/subscriptions","organizations_url":"https://api.github.com/users/DropCloth/orgs","repos_url":"https://api.github.com/users/DropCloth/repos","events_url":"https://api.github.com/users/DropCloth/events{/privacy}","received_events_url":"https://api.github.com/users/DropCloth/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-02-15T09:33:37Z","updated_at":"2018-02-15T10:07:08Z","closed_at":"2018-02-15T10:07:07Z","author_association":"NONE","active_lock_reason":null,"body":"Hello !\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI'm currently testing my ES cluster by simulating generic failures. I have 5 nodes, with the Elasticsearch replication enabled: 5 shards, the replication factor is 1. They are all data nodes, master is chosen automatically.\r\n\r\nI manually shutdown a node to see how the cluster is reallocating the missing shards, and to see if the cluster could handle this kind of situation.\r\nHowever, another node left the cluster 10 hours after the first one, but without any action from me.\r\nThe log file is very small to debug the problem (cf. the end of the post), and I don't find any related issue about it.\r\nWith this second node leaving the cluster, it went red which wasn't the expected result.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Stop the Elasticsearch service on a node \r\n 2. Wait for failure\r\n\r\n**OS version** : Ubuntu Server 16.04\r\n\r\n**Elasticsearch version** : 5.6.4\r\n\r\n**JVM version** : 1.8.0_131\r\n\r\n**Plugins installed**: None\r\n\r\n**Provide logs (if relevant)**:\r\n[2018-02-15T01:04:41,065][WARN ][o.e.i.e.Engine           ] [my-server03] [fw_5][3] Failed to close SearcherManager\r\njava.lang.NullPointerException: null\r\n\tat java.util.Collections$UnmodifiableCollection.size(Collections.java:1030) ~[?:1.8.0_131]\r\n\tat java.util.HashSet.<init>(HashSet.java:118) ~[?:1.8.0_131]\r\n\tat org.apache.lucene.index.SegmentCommitInfo.files(SegmentCommitInfo.java:220) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.SegmentInfos.files(SegmentInfos.java:792) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexFileDeleter.decRef(IndexFileDeleter.java:649) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexWriter.decRefDeleter(IndexWriter.java:5027) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.StandardDirectoryReader.doClose(StandardDirectoryReader.java:381) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexReader.decRef(IndexReader.java:253) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexReader.close(IndexReader.java:403) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.FilterDirectoryReader.doClose(FilterDirectoryReader.java:134) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexReader.decRef(IndexReader.java:253) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.search.SearcherManager.decRef(SearcherManager.java:149) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.search.SearcherManager.decRef(SearcherManager.java:58) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.search.ReferenceManager.release(ReferenceManager.java:274) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.search.ReferenceManager.swapReference(ReferenceManager.java:62) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.search.ReferenceManager.close(ReferenceManager.java:146) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.util.IOUtils.close(IOUtils.java:89) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.util.IOUtils.close(IOUtils.java:76) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.elasticsearch.index.engine.InternalEngine.closeNoLock(InternalEngine.java:1330) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.engine.Engine.failEngine(Engine.java:805) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:915) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:632) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService.maybeRefreshEngine(IndexService.java:690) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService.access$400(IndexService.java:92) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService$AsyncRefreshTask.runInternal(IndexService.java:832) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService$BaseAsyncTask.run(IndexService.java:743) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\n[2018-02-15T01:04:41,129][WARN ][o.e.i.e.Engine           ] [my-server03] [fw_5][3] failed to rollback writer on close\r\njava.lang.NullPointerException: null\r\n\tat org.apache.lucene.index.IndexFileDeleter.decRef(IndexFileDeleter.java:581) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexFileDeleter.checkpoint(IndexFileDeleter.java:534) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexWriter.rollbackInternalNoCommit(IndexWriter.java:2248) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexWriter.rollbackInternal(IndexWriter.java:2193) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.apache.lucene.index.IndexWriter.rollback(IndexWriter.java:2186) ~[lucene-core-6.6.1.jar:6.6.1 9aa465a89b64ff2dabe7b4d50c472de32c298683 - varunthacker - 2017-08-29 21:54:39]\r\n\tat org.elasticsearch.index.engine.InternalEngine.closeNoLock(InternalEngine.java:1342) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.engine.Engine.failEngine(Engine.java:805) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:915) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:632) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService.maybeRefreshEngine(IndexService.java:690) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService.access$400(IndexService.java:92) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService$AsyncRefreshTask.runInternal(IndexService.java:832) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.index.IndexService$BaseAsyncTask.run(IndexService.java:743) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:569) [elasticsearch-5.6.4.jar:5.6.4]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\n\r\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}