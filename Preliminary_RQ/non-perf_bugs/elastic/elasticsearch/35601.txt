{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35601","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35601/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35601/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35601/events","html_url":"https://github.com/elastic/elasticsearch/issues/35601","id":381312844,"node_id":"MDU6SXNzdWUzODEzMTI4NDQ=","number":35601,"title":"Pagerduty not following new accounts","user":{"login":"danielkasen","id":31549908,"node_id":"MDQ6VXNlcjMxNTQ5OTA4","avatar_url":"https://avatars1.githubusercontent.com/u/31549908?v=4","gravatar_id":"","url":"https://api.github.com/users/danielkasen","html_url":"https://github.com/danielkasen","followers_url":"https://api.github.com/users/danielkasen/followers","following_url":"https://api.github.com/users/danielkasen/following{/other_user}","gists_url":"https://api.github.com/users/danielkasen/gists{/gist_id}","starred_url":"https://api.github.com/users/danielkasen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielkasen/subscriptions","organizations_url":"https://api.github.com/users/danielkasen/orgs","repos_url":"https://api.github.com/users/danielkasen/repos","events_url":"https://api.github.com/users/danielkasen/events{/privacy}","received_events_url":"https://api.github.com/users/danielkasen/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-11-15T19:47:54Z","updated_at":"2019-01-07T23:20:37Z","closed_at":"2019-01-07T23:20:37Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.3.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nOpenJDK 1.8.72\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nUbuntu 14.04\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAfter adding a new pagerduty integration into the cluster settings, when you try to call it using the pagerduty watcher action it just sends the event to the default integration. \r\n\r\n**Steps to reproduce**:\r\n\r\nInclude a default pagerduty account in the elasticsearch.yml file:\r\n\r\n```  \r\nxpack:\r\n  notification:\r\n    pagerduty:\r\n      account:\r\n        monitoring:\r\n          service_api_key: \"XXXXXXX\"\r\n          event_defaults:\r\n            description: \"Watch Notification\"\r\n```\r\n\r\nThen add more accounts via the _cluster/settings\r\n\r\n```\r\nPUT _cluster/settings\r\n{\r\n  \"persistent\": {\r\n    \"xpack\": {\r\n      \"notification\": {\r\n        \"pagerduty\": {\r\n          \"default_account\": \"elasticsearch-logs\",\r\n          \"account\": {\r\n            \"monitoring\": {\r\n              \"service_api_key\": \"asdsadasd\"\r\n            },\r\n            \"elasticsearch-logs\": {\r\n              \"service_api_key\": \"asdasdadsa\"\r\n            },\r\n            \"kibana-logs\": {\r\n              \"service_api_key\": \"asdasdasd\"\r\n            },\r\n            \"logstash-logs\": {\r\n              \"service_api_key\": \"asdadsadas\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nThen try to send an event to one of those accounts:\r\n\r\n```\r\n{\r\n  \"trigger\": {\r\n    \"schedule\": {\r\n      \"interval\": \"15m\"\r\n    }\r\n  },\r\n  \"input\": {\r\n    \"search\": {\r\n      \"request\": {\r\n        \"search_type\": \"query_then_fetch\",\r\n        \"indices\": [\r\n          \"elk-*\"\r\n        ],\r\n        \"types\": [],\r\n        \"body\": {\r\n          \"query\": {\r\n            \"bool\": {\r\n              \"filter\": [\r\n                {\r\n                  \"range\": {\r\n                    \"@timestamp\": {\r\n                      \"to\": \"{{ ctx.trigger.triggered_time }}\",\r\n                      \"from\": \"{{ ctx.trigger.scheduled_time }}||-6m\"\r\n                    }\r\n                  }\r\n                },\r\n                {\r\n                  \"match\": {\r\n                    \"fileset.module\": \"curator\"\r\n                  }\r\n                }\r\n              ],\r\n              \"must\": [\r\n                {\r\n                  \"query_string\": {\r\n                    \"query\": \"message: \\\"forceMerging index\\\"\",\r\n                    \"default_field\": \"message\"\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          \"size\": 100\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"condition\": {\r\n    \"compare\": {\r\n      \"ctx.payload.hits.total\": {\r\n        \"lt\": 1\r\n      }\r\n    }\r\n  },\r\n  **\"actions\": {\r\n    \"notify-pagerduty\": {\r\n        \"throttle_period\": \"5m\",\r\n        \"pagerduty\": {\r\n            \"account\": \"elasticsearch-logs\",\r\n            \"description\": \"STG - Force Merge Hasn't Run in 6 Hours\"\r\n        }\r\n    }\r\n  }**\r\n}\r\n```\r\n\r\nTHis results in the default `monitoring` account getting paged which is defined in the elasticsearch.yml file","closed_by":{"login":"danielkasen","id":31549908,"node_id":"MDQ6VXNlcjMxNTQ5OTA4","avatar_url":"https://avatars1.githubusercontent.com/u/31549908?v=4","gravatar_id":"","url":"https://api.github.com/users/danielkasen","html_url":"https://github.com/danielkasen","followers_url":"https://api.github.com/users/danielkasen/followers","following_url":"https://api.github.com/users/danielkasen/following{/other_user}","gists_url":"https://api.github.com/users/danielkasen/gists{/gist_id}","starred_url":"https://api.github.com/users/danielkasen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielkasen/subscriptions","organizations_url":"https://api.github.com/users/danielkasen/orgs","repos_url":"https://api.github.com/users/danielkasen/repos","events_url":"https://api.github.com/users/danielkasen/events{/privacy}","received_events_url":"https://api.github.com/users/danielkasen/received_events","type":"User","site_admin":false},"performed_via_github_app":null}