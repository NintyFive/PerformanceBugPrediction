[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/77861859","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-77861859","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":77861859,"node_id":"MDEyOklzc3VlQ29tbWVudDc3ODYxODU5","user":{"login":"polgl","id":11061987,"node_id":"MDQ6VXNlcjExMDYxOTg3","avatar_url":"https://avatars1.githubusercontent.com/u/11061987?v=4","gravatar_id":"","url":"https://api.github.com/users/polgl","html_url":"https://github.com/polgl","followers_url":"https://api.github.com/users/polgl/followers","following_url":"https://api.github.com/users/polgl/following{/other_user}","gists_url":"https://api.github.com/users/polgl/gists{/gist_id}","starred_url":"https://api.github.com/users/polgl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polgl/subscriptions","organizations_url":"https://api.github.com/users/polgl/orgs","repos_url":"https://api.github.com/users/polgl/repos","events_url":"https://api.github.com/users/polgl/events{/privacy}","received_events_url":"https://api.github.com/users/polgl/received_events","type":"User","site_admin":false},"created_at":"2015-03-09T14:22:27Z","updated_at":"2015-03-09T14:22:27Z","author_association":"NONE","body":"This is a BUG in the Java API: the list with listed nodes never gets updated and thus never contains the right IDs. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/162224339","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-162224339","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":162224339,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MjIyNDMzOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-05T17:14:47Z","updated_at":"2015-12-05T17:14:47Z","author_association":"CONTRIBUTOR","body":"Hi @polgl \n\nSorry it has taken a while to look at this.  Are you still seeing this problem in Elasticsearch 2.0?  If so, any chance you'd like to send a PR?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170638422","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-170638422","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":170638422,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDYzODQyMg==","user":{"login":"polgl","id":11061987,"node_id":"MDQ6VXNlcjExMDYxOTg3","avatar_url":"https://avatars1.githubusercontent.com/u/11061987?v=4","gravatar_id":"","url":"https://api.github.com/users/polgl","html_url":"https://github.com/polgl","followers_url":"https://api.github.com/users/polgl/followers","following_url":"https://api.github.com/users/polgl/following{/other_user}","gists_url":"https://api.github.com/users/polgl/gists{/gist_id}","starred_url":"https://api.github.com/users/polgl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polgl/subscriptions","organizations_url":"https://api.github.com/users/polgl/orgs","repos_url":"https://api.github.com/users/polgl/repos","events_url":"https://api.github.com/users/polgl/events{/privacy}","received_events_url":"https://api.github.com/users/polgl/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T18:13:46Z","updated_at":"2016-01-11T18:13:46Z","author_association":"NONE","body":"Hi @clintongormley here is the diff of a quick fix\nI did not manage to write a test with the right conditions for this (netty client, one slow/ blocking request, killing the server without normal shutdown)\nThis change ensures that the DiscoveryNode object that was connected before is used for disconnecting.\n\n```\n--- a/core/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java\n+++ b/core/src/main/java/org/elasticsearch/client/transport/TransportClientNodesService.java\n@@ -54,6 +54,7 @@ import java.util.Iterator;\n import java.util.List;\n import java.util.Locale;\n import java.util.Map;\n+import java.util.HashMap;\n import java.util.Set;\n import java.util.concurrent.ConcurrentMap;\n import java.util.concurrent.CountDownLatch;\n@@ -86,6 +87,7 @@ public class TransportClientNodesService extends AbstractComponent {\n\n     private final Object mutex = new Object();\n\n+    private volatile Map<DiscoveryNode, DiscoveryNode> discoveredNodesMap = new HashMap<>();\n     private volatile List<DiscoveryNode> nodes = Collections.emptyList();\n     private volatile List<DiscoveryNode> filteredNodes = Collections.emptyList();\n\n@@ -372,7 +374,9 @@ public class TransportClientNodesService extends AbstractComponent {\n                     } else if (livenessResponse.getDiscoveryNode() != null) {\n                         // use discovered information but do keep the original transport address, so people can control which address is exactly used.\n                         DiscoveryNode nodeWithInfo = livenessResponse.getDiscoveryNode();\n-                        newNodes.add(new DiscoveryNode(nodeWithInfo.name(), nodeWithInfo.id(), nodeWithInfo.getHostName(), nodeWithInfo.getHostAddress(), listedNode.address(), nodeWithInfo.attributes(), nodeWithInfo.version()));\n+                        DiscoveryNode discoveredNode = new DiscoveryNode(nodeWithInfo.name(), nodeWithInfo.id(), nodeWithInfo.getHostName(), nodeWithInfo.getHostAddress(), listedNode.address(), nodeWithInfo.attributes(), nodeWithInfo.version());\n+                        newNodes.add(discoveredNode);\n+                        discoveredNodesMap.put(listedNode, discoveredNode);\n                     } else {\n                         // although we asked for one node, our target may not have completed initialization yet and doesn't have cluster nodes\n                         logger.debug(\"node {} didn't return any discovery info, temporarily using transport discovery node\", listedNode);\n@@ -381,6 +385,10 @@ public class TransportClientNodesService extends AbstractComponent {\n                 } catch (Throwable e) {\n                     logger.info(\"failed to get node info for {}, disconnecting...\", e, listedNode);\n                     transportService.disconnectFromNode(listedNode);\n+                    // disconnect from the node that was connected before\n+                    if (discoveredNodesMap.containsKey(listedNode)) {\n+                        transportService.disconnectFromNode(discoveredNodesMap.get(listedNode));\n+                    }\n                 }\n             }\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/170657810","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-170657810","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":170657810,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MDY1NzgxMA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-11T19:14:24Z","updated_at":"2016-01-11T19:14:24Z","author_association":"CONTRIBUTOR","body":"@bleskes could you take a look at this please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/175591059","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-175591059","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":175591059,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NTU5MTA1OQ==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-01-27T12:22:29Z","updated_at":"2016-01-27T12:22:29Z","author_association":"MEMBER","body":"@polgl I looked at this and I'm a bit puzzled. Here is what I  understand:\n\n1) During the issue of the liveness test the target node disconnects.\n2) This somehow makes the liveness request not being canceled but just hang.\n3) That causes new nodes not to be picked up.\n\nI don't see how the node disconnect event is missed based on the client code alone - the disconnect even should come for both the \"official\" node and the one that is connected \"light\" for the liveness call. Can you elaborate? Also - which version of ES are you referring to? it might something subtle I miss by looking at the wrong version.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/175810167","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-175810167","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":175810167,"node_id":"MDEyOklzc3VlQ29tbWVudDE3NTgxMDE2Nw==","user":{"login":"polgl","id":11061987,"node_id":"MDQ6VXNlcjExMDYxOTg3","avatar_url":"https://avatars1.githubusercontent.com/u/11061987?v=4","gravatar_id":"","url":"https://api.github.com/users/polgl","html_url":"https://github.com/polgl","followers_url":"https://api.github.com/users/polgl/followers","following_url":"https://api.github.com/users/polgl/following{/other_user}","gists_url":"https://api.github.com/users/polgl/gists{/gist_id}","starred_url":"https://api.github.com/users/polgl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polgl/subscriptions","organizations_url":"https://api.github.com/users/polgl/orgs","repos_url":"https://api.github.com/users/polgl/repos","events_url":"https://api.github.com/users/polgl/events{/privacy}","received_events_url":"https://api.github.com/users/polgl/received_events","type":"User","site_admin":false},"created_at":"2016-01-27T19:25:00Z","updated_at":"2016-01-27T19:25:00Z","author_association":"NONE","body":"sorry I may went to fast in my explanation:\n\n1) The node disconnects between 2 liveness tests\n2) an other request (search request for example) that was started before but is not yet finished hangs\n3) causes the search request not to be canceled and/or retried \n\nI added a graph the show the sequence of events in the client and the server:\n\n![graph](https://docs.google.com/drawings/d/13sqI2AJ67ljEpGYG-wy6qgaibWCxL8IMlZ3imT2RYAc/pub?w=960&amp;h=720)\n\nWhat I understood from the code:\n1) add node at with a given address\n`org.elasticsearch.client.transport.TransportClientNodesService#addTransportAddresses`\ncreates `DiscoveryNode object 1` with id = `#transport#-0` \n\n2) test liveness\n`org.elasticsearch.client.transport.TransportClientNodesService.SimpleNodeSampler#doSample`\ntests liveness for `DiscoveryNode object 1` with id = `#transport#-0` \ngets response with real id and creates `DiscoveryNode object 2` with id = `abcd` \n\n3) send search request\n`org.elasticsearch.transport.TransportService.RequestHolder` holds reference to `DiscoveryNode object 2`  with id = `abcd` \n\n4) connection loss\n\n5) test liveness again\n`org.elasticsearch.client.transport.TransportClientNodesService.SimpleNodeSampler#doSample`\ntests liveness for `DiscoveryNode object 1` with id = `#transport#-0` \nnode is not available\ndisconnects from `DiscoveryNode object 1`\n`org.elasticsearch.transport.TransportService.Adapter#raiseNodeDisconnected` does not match the `RequestHolder` from 3)\nrequest from 3) is not stopped\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/177962568","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-177962568","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":177962568,"node_id":"MDEyOklzc3VlQ29tbWVudDE3Nzk2MjU2OA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-02-01T13:00:47Z","updated_at":"2016-02-01T13:00:47Z","author_association":"MEMBER","body":"Thanks for clarifying @polgl . I think I understand where things go wrong. The NodeSampler is mainly in charge of maintaining a connection to the specified nodes (by sending a liveness command) and validating that the nodes on the other side indeed belong to the same cluster. It isn't responsible for maintaining the nodes that the client is currently connected to and cancelling in flight request. Both of those are the responsibility of the TransportService, which should have detected the connection loss (socket break) in step 4 above and failed all inflight requests to the node.  Something else is going on... \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/263080363","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-263080363","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":263080363,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MzA4MDM2Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-11-26T19:11:05Z","updated_at":"2016-11-26T19:11:05Z","author_association":"CONTRIBUTOR","body":"@bleskes did you ever get anywhere with this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/263147467","html_url":"https://github.com/elastic/elasticsearch/issues/9794#issuecomment-263147467","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9794","id":263147467,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MzE0NzQ2Nw==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-11-27T21:05:14Z","updated_at":"2016-11-27T21:05:14Z","author_association":"MEMBER","body":"@clintongormley not really - something was wrong but not exactly fitting the discreption. I think we can close it for now and reopen if something similar pops up - it will be hard to continue debugging without a concrete issue. @polgl if this is still happening for you, feel free to reopen.","performed_via_github_app":null}]