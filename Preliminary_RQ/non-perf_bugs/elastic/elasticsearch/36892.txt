{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36892","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36892/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36892/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36892/events","html_url":"https://github.com/elastic/elasticsearch/issues/36892","id":393043642,"node_id":"MDU6SXNzdWUzOTMwNDM2NDI=","number":36892,"title":"ES fails to retrieve snapshot from GCS","user":{"login":"dmnfortytwo","id":26309559,"node_id":"MDQ6VXNlcjI2MzA5NTU5","avatar_url":"https://avatars1.githubusercontent.com/u/26309559?v=4","gravatar_id":"","url":"https://api.github.com/users/dmnfortytwo","html_url":"https://github.com/dmnfortytwo","followers_url":"https://api.github.com/users/dmnfortytwo/followers","following_url":"https://api.github.com/users/dmnfortytwo/following{/other_user}","gists_url":"https://api.github.com/users/dmnfortytwo/gists{/gist_id}","starred_url":"https://api.github.com/users/dmnfortytwo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dmnfortytwo/subscriptions","organizations_url":"https://api.github.com/users/dmnfortytwo/orgs","repos_url":"https://api.github.com/users/dmnfortytwo/repos","events_url":"https://api.github.com/users/dmnfortytwo/events{/privacy}","received_events_url":"https://api.github.com/users/dmnfortytwo/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2018-12-20T13:19:39Z","updated_at":"2019-01-18T10:01:10Z","closed_at":"2018-12-21T12:26:06Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n`Version: 6.2.2, Build: 10b1edd/2018-02-16T19:01:30.685723Z, JVM: 1.8.0_181`\r\n\r\n**Plugins installed**: \r\n```repository-gcs\r\n- Plugin information:\r\nName: repository-gcs\r\nDescription: The GCS repository plugin adds Google Cloud Storage support for repositories.\r\nVersion: 6.2.2\r\nNative Controller: false\r\nRequires Keystore: false\r\nExtended Plugins: []\r\n * Classname: org.elasticsearch.repositories.gcs.GoogleCloudStoragePlugin\r\n```\r\n\r\n**JVM version** (`java -version`):\r\n```java version \"1.8.0_181\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_181-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)\r\n```\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n`Linux elasticsearch-gce-be-10.domain 4.15.0-1018-gcp #19-Ubuntu SMP Thu Aug 16 13:38:55 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nSometimes elasticsearch fails to retrieve snapshot from gcs repo with first try. This puts whole cluster into red state and makes monitoring team nervous.\r\n\r\n**Steps to reproduce**:\r\n* configure repo in google cloud like this:\r\n```# curl -sXGET localhost:9200/_snapshot/archive?pretty\r\n{\r\n  \"archive\" : {\r\n    \"type\" : \"gcs\",\r\n    \"settings\" : {\r\n      \"bucket\" : \"my_bucket\",\r\n      \"client\" : \"elasticsearch\",\r\n      \"max_restore_bytes_per_sec\" : \"160mb\",\r\n      \"max_snapshot_bytes_per_sec\" : \"160mb\"\r\n    }\r\n  }\r\n}\r\n```\r\n* Add new large (40G+) indices to archive\r\n* Try to restore a few one-by-one\r\n* Restore will fail and you'll see an error like this (see below)\r\n* Few minutes later restore will continue, but cluster health will stay red until it finishes\r\n```\r\n[2018-12-18T18:21:43,045][WARN ][o.e.c.a.s.ShardStateAction] [esmaster-gce-be-2] [team_logs--2018.09.04][1] received shard failed for shard id [[team_logs--2018.09.04][1]], allocation id [y2pCEt_[72/43121]\r\njEjGQ], primary term [0], message [failed recovery], failure [RecoveryFailedException[[team_logs--2018.09.04][1]: Recovery failed on {elasticsearch-gce-be-6}{aG29GP2tQd22_whltBTMdw}{S4KZvtUIRAuyMFIEsZMcpA}{10\r\n.132.0.30}{10.132.0.30:9300}{rack_id=europe-west1-d}]; nested: IndexShardRecoveryException[failed recovery]; nested: IndexShardRestoreFailedException[restore failed]; nested: IndexShardRestoreFailedException[fa$\r\nled to restore snapshot [all-2018.09.04/p3EzllljTjK0TRFbNTNhTg]]; nested: IndexShardRestoreFailedException[Failed to recover index]; nested: IOException[Connection closed prematurely: bytesRead = 16777216, Cont$\r\nnt-Length = 44104724]; ]\r\norg.elasticsearch.indices.recovery.RecoveryFailedException: [team_logs--2018.09.04][1]: Recovery failed on {elasticsearch-gce-be-6}{aG29GP2tQd22_whltBTMdw}{S4KZvtUIRAuyMFIEsZMcpA}{10.132.0.30}{10.132.0.30:93$\r\n0}{rack_id=europe-west1-d}\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2065) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:573) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) ~[?:1.8.0_181]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) ~[?:1.8.0_181]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\nCaused by: org.elasticsearch.index.shard.IndexShardRecoveryException: failed recovery\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:342) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        ... 4 more\r\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: restore failed\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:463) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        ... 4 more\r\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: failed to restore snapshot [all-2018.09.04/p3EzllljTjK0TRFbNTNhTg]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.restoreShard(BlobStoreRepository.java:827) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:448) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        ... 4 more\r\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: Failed to recover index\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restore(BlobStoreRepository.java:1518) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.restoreShard(BlobStoreRepository.java:825) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:448) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        ... 4 more\r\nCaused by: java.io.IOException: Connection closed prematurely: bytesRead = 16777216, Content-Length = 44104724\r\n        at com.google.api.client.http.javanet.NetHttpResponse$SizeValidatingInputStream.throwIfFalseEOF(NetHttpResponse.java:202) ~[?:?]\r\n        at com.google.api.client.http.javanet.NetHttpResponse$SizeValidatingInputStream.read(NetHttpResponse.java:171) ~[?:?]\r\n        at org.elasticsearch.index.snapshots.blobstore.SlicedInputStream.read(SlicedInputStream.java:92) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at java.io.FilterInputStream.read(FilterInputStream.java:133) ~[?:1.8.0_181]\r\n        at org.elasticsearch.index.snapshots.blobstore.RateLimitingInputStream.read(RateLimitingInputStream.java:69) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at java.io.FilterInputStream.read(FilterInputStream.java:107) ~[?:1.8.0_181]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restoreFile(BlobStoreRepository.java:1572) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository$RestoreContext.restore(BlobStoreRepository.java:1515) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.restoreShard(BlobStoreRepository.java:825) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.restore(StoreRecovery.java:448) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.lambda$recoverFromRepository$5(StoreRecovery.java:277) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.executeRecovery(StoreRecovery.java:300) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.StoreRecovery.recoverFromRepository(StoreRecovery.java:275) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.restoreFromRepository(IndexShard.java:1613) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        at org.elasticsearch.index.shard.IndexShard.lambda$startRecovery$7(IndexShard.java:2061) ~[elasticsearch-6.2.2.jar:6.2.2]\r\n        ... 4 more\r\n```\r\n\r\n\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}