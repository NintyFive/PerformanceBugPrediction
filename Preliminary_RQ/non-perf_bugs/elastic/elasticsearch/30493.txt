{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30493","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30493/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30493/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30493/events","html_url":"https://github.com/elastic/elasticsearch/issues/30493","id":321704380,"node_id":"MDU6SXNzdWUzMjE3MDQzODA=","number":30493,"title":"Beats central management: index templates and built-in roles","user":{"login":"ycombinator","id":51061,"node_id":"MDQ6VXNlcjUxMDYx","avatar_url":"https://avatars2.githubusercontent.com/u/51061?v=4","gravatar_id":"","url":"https://api.github.com/users/ycombinator","html_url":"https://github.com/ycombinator","followers_url":"https://api.github.com/users/ycombinator/followers","following_url":"https://api.github.com/users/ycombinator/following{/other_user}","gists_url":"https://api.github.com/users/ycombinator/gists{/gist_id}","starred_url":"https://api.github.com/users/ycombinator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ycombinator/subscriptions","organizations_url":"https://api.github.com/users/ycombinator/orgs","repos_url":"https://api.github.com/users/ycombinator/repos","events_url":"https://api.github.com/users/ycombinator/events{/privacy}","received_events_url":"https://api.github.com/users/ycombinator/received_events","type":"User","site_admin":false},"labels":[{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-05-09T19:54:29Z","updated_at":"2018-07-10T17:06:42Z","closed_at":"2018-07-10T17:06:42Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"We are starting on a Central Management feature for Beats (https://github.com/elastic/beats/issues/7028). This will be an X-Pack feature and will require certain elements in X-Pack Elasticsearch, specifically:\r\n\r\n### Index Templates\r\n\r\nAn index template for an internal index, say `.management-beats-agents`, that will be used to persist information from Beats agents when they enroll themselves or update the same information periodically after enrollment. It will also be used to persist the central configuration (after merging) for each beat. Each document in this index will represent an enrolled Beat and its merged central configuration, if any.\r\n\r\n```\r\nPUT _template/.management-beats-agents\r\n{\r\n  \"version\": 7000001,\r\n  \"index_patterns\": [\r\n    \".management-beats-agents\"\r\n  ],\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"number_of_shards\": 1,\r\n      \"auto_expand_replicas\": \"0-1\",\r\n      \"codec\": \"best_compression\"\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"beat\": {\r\n          \"properties\": {\r\n            \"id\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"enrollment_token\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"access_token\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"verified_on\": {\r\n              \"type\": \"date\"\r\n            },\r\n            \"type\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"ephemeral_id\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"local_configuration_yml\": {\r\n              \"type\": \"text\"\r\n            },\r\n            \"central_configuration_yml\": {\r\n               \"type\": \"text\"\r\n            },\r\n            \"metadata\": {\r\n              \"dynamic\": \"true\",\r\n              \"type\": \"object\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAn index template for an internal index, say `.management-beats-admin`, that will be used to persist enrollment tokens and configuration for Beats. There may be two different types of documents in this index, which will be distinguished by the value in the `type` field, either `enrollment_token` or `configuration_fragment`. Documents with `type` = `enrollment_token` are expected to have an `enrollment_token` field, containing sub-fields necessary to represent enrollment tokens. Documents with `type` = `configuration_fragment` are expected to have a `configuration_fragment` field, containing sub-fields necessary to represent configuration fragments.\r\n\r\n```\r\nPUT _template/.management-beats-admin\r\n{\r\n  \"version\": 7000001,\r\n  \"index_patterns\": [\r\n    \".management-beats-admin\"\r\n  ],\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"number_of_shards\": 1,\r\n      \"auto_expand_replicas\": \"0-1\",\r\n      \"codec\": \"best_compression\"\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"type\": {\r\n          \"type\": \"keyword\"\r\n        },\r\n        \"enrollment_token\": {\r\n          \"properties\": {\r\n            \"token\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"configuration_fragment\": {\r\n          \"properties\": {\r\n            \"tag\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"fragment_yml\": {\r\n              \"type\": \"text\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n## Security Roles\r\n\r\nA `beats_agent` role, which should:\r\n\r\n* be used by Beats agents (indirectly, via a user configured in `kibana.yml`) for initial enrollment, periodic updates to Beat information, and to pull down configuration for the agent.\r\n* have `create_index`, `read`, and `index` privileges on the `.management-beats-agents` index\r\n\r\n```\r\nPUT _xpack/security/role/beats_agent\r\n{\r\n  \"indices\": [\r\n    {\r\n      \"names\": [\r\n        \".management-beats-agents\"\r\n      ],\r\n      \"privileges\": [\r\n        \"create_index\",\r\n        \"index\",\r\n        \"read\"\r\n      ],\r\n      \"field_security\": {\r\n        \"grant\": [\r\n          \"*\"\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nA `beats_admin` role, which should:\r\n\r\n* be used by administrative users to sign in to Kibana and use the Beats Management UI to centrally-manage beat configurations, including verifying enrolled beats.\r\n* have `all` index privileges on all `.management-beats-*` indices.\r\n\r\n```\r\nPUT _xpack/security/role/beats_admin\r\n{\r\n  \"indices\": [\r\n    {\r\n      \"names\": [\r\n        \".management-beats-*\"\r\n      ],\r\n      \"privileges\": [\r\n        \"all\"\r\n      ],\r\n      \"field_security\": {\r\n        \"grant\": [\r\n          \"*\"\r\n        ]\r\n      }\r\n    }\r\n  ]\r\n}\r\n```","closed_by":{"login":"ycombinator","id":51061,"node_id":"MDQ6VXNlcjUxMDYx","avatar_url":"https://avatars2.githubusercontent.com/u/51061?v=4","gravatar_id":"","url":"https://api.github.com/users/ycombinator","html_url":"https://github.com/ycombinator","followers_url":"https://api.github.com/users/ycombinator/followers","following_url":"https://api.github.com/users/ycombinator/following{/other_user}","gists_url":"https://api.github.com/users/ycombinator/gists{/gist_id}","starred_url":"https://api.github.com/users/ycombinator/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ycombinator/subscriptions","organizations_url":"https://api.github.com/users/ycombinator/orgs","repos_url":"https://api.github.com/users/ycombinator/repos","events_url":"https://api.github.com/users/ycombinator/events{/privacy}","received_events_url":"https://api.github.com/users/ycombinator/received_events","type":"User","site_admin":false},"performed_via_github_app":null}