{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48366","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48366/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48366/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48366/events","html_url":"https://github.com/elastic/elasticsearch/issues/48366","id":510916676,"node_id":"MDU6SXNzdWU1MTA5MTY2NzY=","number":48366,"title":"Handle dangling indices more safely","user":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"assignees":[{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-10-22T21:09:41Z","updated_at":"2020-07-17T14:17:59Z","closed_at":"2020-07-17T14:17:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Dangling indices are indices that exist on disk on one or more nodes but which do not currently exist in the cluster state. They arise in a number of situations, such as:\r\n\r\n   * A user overflows the index graveyard by deleting more than 500 indices while a node is offline and then the node rejoins the cluster\r\n   * A node (unsafely) moves from one cluster to another, perhaps because the original cluster lost all its master nodes\r\n   * A user (unsafely) meddles with the contents of the data path, maybe restoring an old index folder from a backup\r\n   * A disk partially fails and the user has no replicas and no snapshots and wants to (unsafely) recover whatever they can\r\n   * A cluster loses all master nodes and those are (unsafely) restored from backup, but the backup does not contain the index.\r\n\r\nToday we greedily and automatically import any dangling indices found on disk if possible, with surprising results:\r\n\r\n   * A deleted index may suddenly reappear when a node joins the cluster.\r\n   * A user may delete an index and see the immediate creation of another index with the same name, containing stale mappings and old data. They may start to index into this ancient index before realising. Data loss abounds.\r\n   * We may not be able to find copies of all of the shards of the index, resulting in a red cluster state.\r\n   * We do not attempt to import the freshest metadata for the index, and use a possibly-stale copy of the in-sync set to pick primaries. Data loss abounds.\r\n\r\n## What can we do about this?\r\n\r\nIn the long run we would prefer to avoid auto-importing dangling indices, but we must recognise that there are some desperate situations where a dangling index import is the best option and must therefore continue to support it.  Rather than automatically importing a dangling index as soon as it is discovered, we could offer an API to help users manage their dangling indices. Something like this:\r\n\r\n    GET /_dangling\r\n\r\nGets a list of the dangling indices across the cluster. The response could include the index metadata (the one with the highest version in case of conflict) and mappings and some information about the underlying shards to help the user decide whether it should be deleted without needing to import it first.\r\n\r\n    DELETE /_dangling/$INDEX_UUID\r\n\r\nMarks the dangling index for deletion.\r\n\r\n    POST /_dangling/$INDEX_UUID\r\n\r\nImports the given index into the cluster. This would require a body with `accept_data_loss: true`. It may be necessary to allow dangling indices to be recovered under a different name too. Maybe we should allow specifying a particular node in case of conflicting metadata versions.\r\n\r\nIt should also be possible to use a wildcard i.e. `POST /_dangling/*`, so that if a user is in a desperate situation, they can still quickly import any dangling indices without having to iterate over the whole list.\r\n\r\nWith this API we would warn the user about the existence of dangling indices through some UI (e.g. periodic log messages, or something in Kibana) and it would then be up to them to resolve that warning at their convenience.\r\n\r\nThe API sketch above is predicated on being able to disable the automatic import of dangling indices. We propose to introduce a new setting, which will default to disabling automatic imports. At a later date we will remove the setting, along with the automatic imports functionality since it is inherently unsafe.\r\n\r\n## Steps\r\n\r\n   * [x] Write test case to exercise the dangling indices case #49174\r\n   * [x] Introduce new setting to disable automatic dangling index imports #49174\r\n   * [x] Add API for:\r\n      * Listing dangling indices\r\n      * Importing a dangling index\r\n      * Deleting a dangling index\r\n   * [x] Add documentation\r\n   * [x] Default the new settings to off.\r\n   * [ ] Remove auto-import from `v8.0.0`\r\n   * [x] Add list of dangling indices to the [support diagnostics tool](https://github.com/elastic/support-diagnostics)","closed_by":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"performed_via_github_app":null}