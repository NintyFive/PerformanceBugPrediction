{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52921","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52921/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52921/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52921/events","html_url":"https://github.com/elastic/elasticsearch/issues/52921","id":572351640,"node_id":"MDU6SXNzdWU1NzIzNTE2NDA=","number":52921,"title":"ML: Datafeed not correctly returning results","user":{"login":"fkelbert","id":714592,"node_id":"MDQ6VXNlcjcxNDU5Mg==","avatar_url":"https://avatars0.githubusercontent.com/u/714592?v=4","gravatar_id":"","url":"https://api.github.com/users/fkelbert","html_url":"https://github.com/fkelbert","followers_url":"https://api.github.com/users/fkelbert/followers","following_url":"https://api.github.com/users/fkelbert/following{/other_user}","gists_url":"https://api.github.com/users/fkelbert/gists{/gist_id}","starred_url":"https://api.github.com/users/fkelbert/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fkelbert/subscriptions","organizations_url":"https://api.github.com/users/fkelbert/orgs","repos_url":"https://api.github.com/users/fkelbert/repos","events_url":"https://api.github.com/users/fkelbert/events{/privacy}","received_events_url":"https://api.github.com/users/fkelbert/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-02-27T20:51:05Z","updated_at":"2020-03-09T08:48:24Z","closed_at":"2020-03-09T08:48:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ES 7.6.1 (and 7.6.0) on Elastic Cloud.\r\n\r\nWithin the following example, the datafeed will not include field `host.name` as expected and [described within the documentation](https://www.elastic.co/guide/en/machine-learning/7.5/ml-configuring-aggregation.html).\r\n\r\n```\r\nPUT _ml/anomaly_detectors/farequote\r\n{\r\n  \"analysis_config\": {\r\n    \"bucket_span\": \"60m\",\r\n    \"detectors\": [{\r\n      \"function\": \"mean\",\r\n      \"field_name\": \"responsetime\",\r\n      \"by_field_name\": \"airline\"\r\n    }],\r\n    \"summary_count_field_name\": \"doc_count\"\r\n  },\r\n  \"data_description\": {\r\n    \"time_field\":\"@timestamp\"\r\n  }\r\n}\r\n\r\nPUT /_ml/datafeeds/datafeed-farequote\r\n{\r\n  \"job_id\": \"farequote\",\r\n  \"indices\": [\r\n    \"metricbeat-7.5.*\"\r\n  ],\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"exists\": {\r\n            \"field\": \"host.name\"\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"now-24h/h\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"buckets\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"@timestamp\",\r\n        \"fixed_interval\": \"15m\"\r\n      },\r\n      \"aggregations\": {\r\n        \"@timestamp\": {\r\n          \"max\": {\r\n            \"field\": \"@timestamp\"\r\n          }\r\n        },\r\n        \"host.name\": {\r\n          \"terms\": {\r\n            \"field\": \"host.name\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nGET _ml/datafeeds/datafeed-farequote/_preview\r\n```\r\n\r\nResult:\r\n\r\n```\r\n[\r\n  {\r\n    \"@timestamp\" : 1582748098324,\r\n    \"doc_count\" : 3997\r\n  },\r\n  {\r\n    \"@timestamp\" : 1582748998323,\r\n    \"doc_count\" : 4038\r\n  },\r\n  {\r\n    \"@timestamp\" : 1582749898324,\r\n    \"doc_count\" : 4108\r\n  },\r\n  ....\r\n]\r\n```\r\n\r\nInstead, and in line with the documentation, I would expect the presence of `host.name` in each bucket.\r\n\r\nThe search endpoint confirms that this should work just fine:\r\n\r\nInput:\r\n```\r\nGET metricbeat-7.5.*/_search\r\n{\r\n  \"size\": 0,\r\n \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"exists\": {\r\n            \"field\": \"host.name\"\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"now-24h/h\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggregations\": {\r\n    \"buckets\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"@timestamp\",\r\n        \"fixed_interval\": \"15m\"\r\n      },\r\n      \"aggregations\": {\r\n        \"host.name\": {\r\n          \"terms\": {\r\n            \"field\": \"host.name\"\r\n          }\r\n        },\r\n        \"@timestamp\": {\r\n          \"max\": {\r\n            \"field\": \"@timestamp\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nResult:\r\n```\r\n{\r\n  \"took\" : 196,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 6,\r\n    \"successful\" : 6,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 10000,\r\n      \"relation\" : \"gte\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  },\r\n  \"aggregations\" : {\r\n    \"buckets\" : {\r\n      \"buckets\" : [\r\n        {\r\n          \"key_as_string\" : \"2020-02-26T20:00:00.000Z\",\r\n          \"key\" : 1582747200000,\r\n          \"doc_count\" : 3997,\r\n          \"@timestamp\" : {\r\n            \"value\" : 1.582748098324E12,\r\n            \"value_as_string\" : \"2020-02-26T20:14:58.324Z\"\r\n          },\r\n          \"host.name\" : {\r\n            \"doc_count_error_upper_bound\" : 0,\r\n            \"sum_other_doc_count\" : 0,\r\n            \"buckets\" : [\r\n              {\r\n                \"key\" : \"fkelbert-proxy\",\r\n                \"doc_count\" : 2446\r\n              },\r\n              {\r\n                \"key\" : \"fk\",\r\n                \"doc_count\" : 1551\r\n              }\r\n            ]\r\n          }\r\n        }\r\n...\r\n  }\r\n}\r\n```","closed_by":{"login":"szabosteve","id":22324794,"node_id":"MDQ6VXNlcjIyMzI0Nzk0","avatar_url":"https://avatars3.githubusercontent.com/u/22324794?v=4","gravatar_id":"","url":"https://api.github.com/users/szabosteve","html_url":"https://github.com/szabosteve","followers_url":"https://api.github.com/users/szabosteve/followers","following_url":"https://api.github.com/users/szabosteve/following{/other_user}","gists_url":"https://api.github.com/users/szabosteve/gists{/gist_id}","starred_url":"https://api.github.com/users/szabosteve/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/szabosteve/subscriptions","organizations_url":"https://api.github.com/users/szabosteve/orgs","repos_url":"https://api.github.com/users/szabosteve/repos","events_url":"https://api.github.com/users/szabosteve/events{/privacy}","received_events_url":"https://api.github.com/users/szabosteve/received_events","type":"User","site_admin":false},"performed_via_github_app":null}