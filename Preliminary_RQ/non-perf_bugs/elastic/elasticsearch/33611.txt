{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33611","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33611/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33611/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33611/events","html_url":"https://github.com/elastic/elasticsearch/issues/33611","id":359177771,"node_id":"MDU6SXNzdWUzNTkxNzc3NzE=","number":33611,"title":"Getting conflict with existing mapping when upgrading from 6.2 to 6.3","user":{"login":"kylelyk","id":3401359,"node_id":"MDQ6VXNlcjM0MDEzNTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3401359?v=4","gravatar_id":"","url":"https://api.github.com/users/kylelyk","html_url":"https://github.com/kylelyk","followers_url":"https://api.github.com/users/kylelyk/followers","following_url":"https://api.github.com/users/kylelyk/following{/other_user}","gists_url":"https://api.github.com/users/kylelyk/gists{/gist_id}","starred_url":"https://api.github.com/users/kylelyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kylelyk/subscriptions","organizations_url":"https://api.github.com/users/kylelyk/orgs","repos_url":"https://api.github.com/users/kylelyk/repos","events_url":"https://api.github.com/users/kylelyk/events{/privacy}","received_events_url":"https://api.github.com/users/kylelyk/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"assignees":[{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2018-09-11T18:58:03Z","updated_at":"2018-09-14T17:58:36Z","closed_at":"2018-09-13T07:21:28Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.3.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.0_172\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): MacOS (Darwin Kernel Version 15.6.0)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nAfter upgrading from Elasticsearch 6.2 to 6.3, we're getting these errors in the logs, which can cause the entire cluster to go down for a moment.\r\n\r\n**Steps to reproduce**:\r\n\r\nI think I've been able to narrow down the problem to the following steps, however it does not happen very often when manually testing it, but our integration tests catch it almost every time.\r\n\r\n```\r\nPUT test\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"analyzer\": {\r\n        \"text_en_splitting\": {\r\n          \"type\": \"custom\",\r\n          \"char_filter\": [\r\n            \"html_strip\"\r\n          ],\r\n          \"tokenizer\": \"whitespace\",\r\n          \"filter\": [\r\n            \"asciifolding\",\r\n            \"word_delimiter_custom\",\r\n            \"lowercase\",\r\n            \"porter_stem\"\r\n          ]\r\n        }\r\n      },\r\n      \"filter\": {\r\n        \"word_delimiter_custom\": {\r\n          \"type\": \"word_delimiter\",\r\n          \"catenate_words\": true,\r\n          \"catenate_numbers\": true,\r\n          \"split_on_case_change\": false\r\n        }\r\n      },\r\n      \"normalizer\": {\r\n        \"lower_case_ascii\": {\r\n          \"type\": \"custom\",\r\n          \"char_filter\": [],\r\n          \"filter\": [\r\n            \"lowercase\",\r\n            \"asciifolding\"\r\n          ]\r\n        }\r\n      }\r\n    },\r\n    \"index\": {\r\n      \"number_of_shards\": 4,\r\n      \"number_of_replicas\": 0,\r\n      \"refresh_interval\": \"1s\",\r\n      \"mapping\": {\r\n        \"total_fields\": {\r\n          \"limit\": 40000\r\n        }\r\n      }\r\n    },\r\n    \"similarity\": {\r\n      \"custom_similarity\": {\r\n        \"type\": \"scripted\",\r\n        \"script\": {\r\n          \"source\": \"int threshold = 5; double tf = Math.sqrt(doc.freq); if (doc.freq > threshold) { tf /= Math.exp(doc.freq); } double idf = Math.log((field.docCount+1.0)/(term.docFreq+1.0)) + 1.0; double norm = 1/Math.sqrt(doc.length); return query.boost * tf * idf * norm;\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"_routing\": {\r\n        \"required\": true\r\n      },\r\n      \"dynamic\": \"strict\",\r\n      \"properties\": {\r\n        \"details\": {\r\n          \"properties\": {\r\n            \"master\": {\r\n              \"type\": \"text\",\r\n              \"analyzer\": \"text_en_splitting\",\r\n              \"similarity\": \"custom_similarity\"\r\n            },\r\n            \"other\": {\r\n              \"type\": \"object\",\r\n              \"dynamic\": true\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\nPOST test/_doc/1?routing=1\r\n{\"details.master\":\"foo\"}\r\n```\r\n\r\n```\r\nGET test/_search\r\n{\r\n  \"query\": {\r\n    \"term\": {\r\n      \"details.master\": {\r\n        \"value\": \"foo\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe weird thing is that these queries succeed, but then at some point the cluster encounters the exception, and new queries fail due to the cluster being offline.\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2018-09-11T18:41:47,813][WARN ][o.e.c.r.a.AllocationService] [kIvzo8F] failing shard [failed shard, shard [ce][0], node[kIvzo8FnRM6luAJF3MkFMA], [P], s[STARTED], a[id=z-Krv7QCR5mhKzUP9Sgmpw], message [failed to update mapping for index], failure [IllegalArgumentException[Mapper for [details.master] conflicts with existing mapping in other types:\r\n[mapper [details.master] has different [similarity]]]], markAsStale [true]]\r\njava.lang.IllegalArgumentException: Mapper for [details.master] conflicts with existing mapping in other types:\r\n[mapper [details.master] has different [similarity]]\r\n\tat org.elasticsearch.index.mapper.FieldTypeLookup.checkCompatibility(FieldTypeLookup.java:130) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.index.mapper.FieldTypeLookup.copyAndAddAll(FieldTypeLookup.java:94) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.index.mapper.MapperService.internalMerge(MapperService.java:439) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.index.mapper.MapperService.internalMerge(MapperService.java:356) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.index.mapper.MapperService.internalMerge(MapperService.java:305) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.index.mapper.MapperService.updateMapping(MapperService.java:235) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.index.IndexService.updateMapping(IndexService.java:525) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.indices.cluster.IndicesClusterStateService.updateIndices(IndicesClusterStateService.java:487) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.indices.cluster.IndicesClusterStateService.applyClusterState(IndicesClusterStateService.java:226) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.lambda$callClusterStateAppliers$6(ClusterApplierService.java:496) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat java.lang.Iterable.forEach(Iterable.java:75) ~[?:1.8.0_172]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.callClusterStateAppliers(ClusterApplierService.java:493) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.applyChanges(ClusterApplierService.java:480) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.runTask(ClusterApplierService.java:431) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService$UpdateTask.run(ClusterApplierService.java:161) ~[elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:626) [elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:244) [elasticsearch-6.3.2.jar:6.3.2]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:207) [elasticsearch-6.3.2.jar:6.3.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_172]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_172]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_172]\r\n[2018-09-11T18:41:47,816][INFO ][o.e.c.r.a.AllocationService] [kIvzo8F] Cluster health status changed from [GREEN] to [RED] (reason: [shards failed [[ce][3], [ce][2], [ce][1], [ce][0]] ...]).\r\n[2018-09-11T18:41:48,038][INFO ][o.e.c.r.a.AllocationService] [kIvzo8F] Cluster health status changed from [RED] to [GREEN] (reason: [shards started [[ce][0], [ce][2]] ...]).\r\n```\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}