[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/344252880","html_url":"https://github.com/elastic/elasticsearch/issues/27378#issuecomment-344252880","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27378","id":344252880,"node_id":"MDEyOklzc3VlQ29tbWVudDM0NDI1Mjg4MA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-11-14T13:05:05Z","updated_at":"2017-11-14T13:05:05Z","author_association":"MEMBER","body":"I think if the mapping has nested fields then we should just wrap the `ShardSplittingQuery` in a `ToChildBlockJoinQuery`? This should include the document that do not belong in the current shard with their nested documents.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/344269145","html_url":"https://github.com/elastic/elasticsearch/issues/27378#issuecomment-344269145","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27378","id":344269145,"node_id":"MDEyOklzc3VlQ29tbWVudDM0NDI2OTE0NQ==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-11-14T14:06:27Z","updated_at":"2017-11-14T14:06:27Z","author_association":"CONTRIBUTOR","body":"@mvg this sounds like a good plan, I wonder if we then need to skip all child docs when we select documents for deletion? the query we pass to the `ToChildBlockJoinQuery ` should only match parents, right? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/344288317","html_url":"https://github.com/elastic/elasticsearch/issues/27378#issuecomment-344288317","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27378","id":344288317,"node_id":"MDEyOklzc3VlQ29tbWVudDM0NDI4ODMxNw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-11-14T15:09:13Z","updated_at":"2017-11-14T15:09:13Z","author_association":"MEMBER","body":"> I wonder if we then need to skip all child docs when we select documents for deletion\r\n\r\nRight, because then there is one way of selecting nested documents.\r\n\r\n> the query we pass to the ToChildBlockJoinQuery should only match parents, right?\r\n\r\nYes. Then the `ShardSplittingQuery` query should then in the default case (no routing AND no partitioning) not select nested documents by itself.\r\n\r\nMaybe we can create a bool query with two should clause:\r\n* `ShardSplittingQuery` which selects all regular Lucene documents that do not belong on the current shard.\r\n* `ToChildBlockJoinQuery` with `ShardSplittingQuery` as `parentQuery` and a bitset based on `Queries.newNonNestedFilter()` query as `parentsFilter`. This will select all nested documents of regular documents that do not belong on the current shard.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/344294225","html_url":"https://github.com/elastic/elasticsearch/issues/27378#issuecomment-344294225","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27378","id":344294225,"node_id":"MDEyOklzc3VlQ29tbWVudDM0NDI5NDIyNQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-11-14T15:27:06Z","updated_at":"2017-11-14T15:27:06Z","author_association":"MEMBER","body":"The `ShardSplittingQuery` can be an expensive query, so alternatively we can introduce a new query. This query would wrap the `ShardSplittingQuery` query and emit its docids and use `BitSet` (based `Queries.newNonNestedFilter()`) to also emit all nested docids belong to each normal document. This way only a single `ShardSplittingQuery` instance needs to be used.","performed_via_github_app":null}]