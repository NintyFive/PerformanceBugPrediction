[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67012087","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67012087","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67012087,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MDEyMDg3","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-12-15T15:38:14Z","updated_at":"2014-12-15T15:38:14Z","author_association":"CONTRIBUTOR","body":"Hi @ivanlw \n\nFirst, I think the polygon should be closed (ie first and last points should be the same). Second, using 90/180 is always tricky because eg -180 could be normalized to +180, but I'll leave it to @nknize to comment further.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67176813","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67176813","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67176813,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MTc2ODEz","user":{"login":"tolinwei","id":2353407,"node_id":"MDQ6VXNlcjIzNTM0MDc=","avatar_url":"https://avatars2.githubusercontent.com/u/2353407?v=4","gravatar_id":"","url":"https://api.github.com/users/tolinwei","html_url":"https://github.com/tolinwei","followers_url":"https://api.github.com/users/tolinwei/followers","following_url":"https://api.github.com/users/tolinwei/following{/other_user}","gists_url":"https://api.github.com/users/tolinwei/gists{/gist_id}","starred_url":"https://api.github.com/users/tolinwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tolinwei/subscriptions","organizations_url":"https://api.github.com/users/tolinwei/orgs","repos_url":"https://api.github.com/users/tolinwei/repos","events_url":"https://api.github.com/users/tolinwei/events{/privacy}","received_events_url":"https://api.github.com/users/tolinwei/received_events","type":"User","site_admin":false},"created_at":"2014-12-16T15:30:55Z","updated_at":"2014-12-16T15:44:16Z","author_association":"NONE","body":"Hi @clintongormley \nThanks for your reply, when I was using [this website](http://geojson.io/#map=2/20.0/0.0) to build the query geo json, I did notice that the polygon should be closed. But when I went back to the official document [here](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-geo-polygon-filter.html), it actually doesn't require a closed polygon.\n\nSo I tried the closed polygon that covers most of the possible area of our data for query, it returned nothing.\n![Geo JSON](http://i.imgur.com/DFlFDQ3.png)\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"geo_polygon\": {\n          \"coordinate.value\": {\n            \"points\": [\n              {\n                \"lat\": 50,\n                \"lon\": -127\n              },\n              {\n                \"lat\": 12,\n                \"lon\": -113\n              },\n              {\n                \"lat\": 40,\n                \"lon\": -66\n              },\n              {\n                \"lat\": 51,\n                \"lon\": -81\n              },\n              {\n                \"lat\": 50,\n                \"lon\": -127\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThen I also tried other query syntax like the [Geo Distance Filter](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-geo-distance-filter.html), I still got nothing back.\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"geo_distance\": {\n          \"distance\": \"200km\",\n          \"coordinate\": {\n            \"lat\": 16.95,\n            \"lon\": -102.67\n          }\n        }\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67311862","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67311862","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67311862,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MzExODYy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T11:50:25Z","updated_at":"2014-12-17T11:50:25Z","author_association":"CONTRIBUTOR","body":"ah - you've got the field defined as type `nested` but you're not using a `nested` filter.  that won't work.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67350124","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67350124","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67350124,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MzUwMTI0","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T16:35:35Z","updated_at":"2014-12-17T16:35:35Z","author_association":"CONTRIBUTOR","body":"Greetings @ivanlw \n\nLet us know if you haven't resolved your problem.  The following nested filter example should help (note that the docs are correct and the search polygon does not have to be closed):\n\n``` java\ncurl -XGET 'http://localhost:9200/my_index/venues/_search' -d '\n{ \"query\": { \n  \"filtered\": {\n    \"query\": { \"match_all\": {} }, \n    \"filter\": { \n      \"nested\" : { \n        \"path\": \"coordinate\", \n        \"filter\": {\n          \"geo_polygon\": {\n            \"value\": { \n              \"points\": [\n                {\"lon\" : -127.0, \"lat\" : 50.0}, \n                {\"lon\": -113.0, \"lat\": 12.0}, \n                {\"lon\": -66.0, \"lat\": 40.0}, \n                {\"lon\": -81.0, \"lat\": 51.0} ]\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67354530","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67354530","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67354530,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MzU0NTMw","user":{"login":"tolinwei","id":2353407,"node_id":"MDQ6VXNlcjIzNTM0MDc=","avatar_url":"https://avatars2.githubusercontent.com/u/2353407?v=4","gravatar_id":"","url":"https://api.github.com/users/tolinwei","html_url":"https://github.com/tolinwei","followers_url":"https://api.github.com/users/tolinwei/followers","following_url":"https://api.github.com/users/tolinwei/following{/other_user}","gists_url":"https://api.github.com/users/tolinwei/gists{/gist_id}","starred_url":"https://api.github.com/users/tolinwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tolinwei/subscriptions","organizations_url":"https://api.github.com/users/tolinwei/orgs","repos_url":"https://api.github.com/users/tolinwei/repos","events_url":"https://api.github.com/users/tolinwei/events{/privacy}","received_events_url":"https://api.github.com/users/tolinwei/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T17:00:37Z","updated_at":"2014-12-17T17:00:50Z","author_association":"NONE","body":"Thanks! @clintongormley \nWhen I was reading the document about [Geo Polygon Filter here](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-geo-polygon-filter.html), I thought the **person.location** in there is the nested field.\n\nI also thought about it might be the problem of my nested type, so I tried to use simple structure by defining\n\n```\ncoordinate\": {\n    \"type\": \"geo_point\",\n}\n```\n\nThen query using the slight modification of @nknize 's\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"geo_polygon\": {\n          \"coordinate\": {\n            \"points\": [\n              {\n                \"lon\": -127,\n                \"lat\": 50\n              },\n              {\n                \"lon\": -113,\n                \"lat\": 12\n              },\n              {\n                \"lon\": -66,\n                \"lat\": 40\n              },\n              {\n                \"lon\": -81,\n                \"lat\": 51\n              }\n            ]\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nNo result returns.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67355285","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67355285","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67355285,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MzU1Mjg1","user":{"login":"tolinwei","id":2353407,"node_id":"MDQ6VXNlcjIzNTM0MDc=","avatar_url":"https://avatars2.githubusercontent.com/u/2353407?v=4","gravatar_id":"","url":"https://api.github.com/users/tolinwei","html_url":"https://github.com/tolinwei","followers_url":"https://api.github.com/users/tolinwei/followers","following_url":"https://api.github.com/users/tolinwei/following{/other_user}","gists_url":"https://api.github.com/users/tolinwei/gists{/gist_id}","starred_url":"https://api.github.com/users/tolinwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tolinwei/subscriptions","organizations_url":"https://api.github.com/users/tolinwei/orgs","repos_url":"https://api.github.com/users/tolinwei/repos","events_url":"https://api.github.com/users/tolinwei/events{/privacy}","received_events_url":"https://api.github.com/users/tolinwei/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T17:04:54Z","updated_at":"2014-12-17T17:11:17Z","author_association":"NONE","body":"Hello @nknize Thanks for you patient reply\nI tried your query, it cause an error:\n{\n\"error\": \"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[2i1vj4IjTT--S4WGnFa9Dg][cerebro3][0]: SearchParseException[[cerebro3][0]: from[-1],size[-1]: Parse Failure [Failed to parse source [{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"nested\":{\"path\":\"coordinate\",\"filter\":{\"geo_polygon\":{\"value\":{\"points\":[{\"lon\":-127,\"lat\":50},{\"lon\":-113,\"lat\":12},{\"lon\":-66,\"lat\":40},{\"lon\":-81,\"lat\":51}]}}}}}}}}]]]; nested: QueryParsingException[[cerebro3] field [value] is not a geo_point field]; }{[2i1vj4IjTT--S4WGnFa9Dg][cerebro3][1]: SearchParseException[[cerebro3][1]: from[-1],size[-1]: Parse Failure [Failed to parse source [{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"nested\":{\"path\":\"coordinate\",\"filter\":{\"geo_polygon\":{\"value\":{\"points\":[{\"lon\":-127,\"lat\":50},{\"lon\":-113,\"lat\":12},{\"lon\":-66,\"lat\":40},{\"lon\":-81,\"lat\":51}]}}}}}}}}]]]; nested: QueryParsingException[[cerebro3] field [value] is not a geo_point field]; }]\",\n\"status\": 400\n}\n\nAccording to the **\"obj.name\"** and **\"obj.count\"** in the [document about Nested Query](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/query-dsl-nested-query.html), I think the query body should be (replace **value** with **coordinate.value**)\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"coordinate\",\n          \"filter\": {\n            \"geo_polygon\": {\n              \"coordinate.value\": {\n                \"points\": [\n                  {\n                    \"lon\": -127,\n                    \"lat\": 50\n                  },\n                  {\n                    \"lon\": -113,\n                    \"lat\": 12\n                  },\n                  {\n                    \"lon\": -66,\n                    \"lat\": 40\n                  },\n                  {\n                    \"lon\": -81,\n                    \"lat\": 51\n                  }\n                ]\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nThis one can be run correctly, but no result returns.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67358590","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67358590","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67358590,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MzU4NTkw","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T17:25:06Z","updated_at":"2014-12-17T17:28:41Z","author_association":"CONTRIBUTOR","body":"Which version are you running?  The namespace 'coordinate' should be optional since the path in the filter already defines it.  Not sure how you're inserting your documents, so here's an end-to-end example you can try to replicate:\n\nMapping:\n\n``` java\ncurl -XPUT 'http://localhost:9200/nested_geo' -d '{\n  \"mappings\": {\n    \"venues\": {\n      \"properties\": {\n        \"name\":{\n          \"type\":\"string\"\n        },\n        \"coordinate\": {\n          \"type\":\"nested\",\n          \"properties\": {\n            \"value\": {\n              \"type\":\"geo_point\"\n            },\n            \"source\": {\n              \"type\":\"integer\"\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n\nInsert:\n\n``` java\ncurl -XPUT 'http://localhost:9200/nested_geo/venues/1' -d '{\n  \"name\": \"Chipotle Mexican Grill\",\n  \"coordinate\": {\n    \"value\": {\n      \"lon\":-74.011,\n      \"lat\":40.715\n    },\n    \"source\": 15\n  }\n}'\n```\n\nNested filter:\n\n``` java\ncurl -XGET 'http://localhost:9200/nested_geo/venues/_search' -d '{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\":{}\n      },\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"coordinate\",\n          \"filter\": {\n            \"geo_polygon\": {\n              \"value\": {\n                \"points\": [\n                  { \n                    \"lon\": -75.0,\n                    \"lat\": 40.0\n                  },\n                  {\n                    \"lon\": -70.0,\n                    \"lat\": 40.0\n                  },\n                  {\n                    \"lon\": -70.0,\n                    \"lat\": 45.0\n                  },\n                  {\n                    \"lon\": -75.0,\n                    \"lat\": 45.0\n                  }\n                ]\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n\nResult:\n\n``` java\n{\n   ...\n  \"hits\": {\n    \"total\": 1,\n    \"max_score\": 1.0,\n    \"hits\": [{\n        \"_index\": \"nested_geo\",\n        \"_type\": \"venues\",\n        \"_id\": \"1\",\n        \"_score\": 1.0,\n        \"_source\": {\n          \"name\": \"Chipotle Mexican Grill\",\n          \"coordinate\": {\n            \"value\": {\n              \"lon\": -74.011,\n              \"lat\": 40.715\n            },\n            \"source\": 15\n          }\n        }\n      }\n    ]\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67383726","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67383726","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67383726,"node_id":"MDEyOklzc3VlQ29tbWVudDY3MzgzNzI2","user":{"login":"tolinwei","id":2353407,"node_id":"MDQ6VXNlcjIzNTM0MDc=","avatar_url":"https://avatars2.githubusercontent.com/u/2353407?v=4","gravatar_id":"","url":"https://api.github.com/users/tolinwei","html_url":"https://github.com/tolinwei","followers_url":"https://api.github.com/users/tolinwei/followers","following_url":"https://api.github.com/users/tolinwei/following{/other_user}","gists_url":"https://api.github.com/users/tolinwei/gists{/gist_id}","starred_url":"https://api.github.com/users/tolinwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tolinwei/subscriptions","organizations_url":"https://api.github.com/users/tolinwei/orgs","repos_url":"https://api.github.com/users/tolinwei/repos","events_url":"https://api.github.com/users/tolinwei/events{/privacy}","received_events_url":"https://api.github.com/users/tolinwei/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T20:01:15Z","updated_at":"2014-12-17T20:01:15Z","author_association":"NONE","body":"A huge thanks again @nknize \n\nI just tried your example and compared it with indexed documents, then found out I did make some mistake. I'm using river plugin to index the data from MySQL to ElasticSearch, and I wrote the SQL stupidly like below\n\n```\nSELECT _id, id, column_1 as {profile_name}.column_1, column_2 as {profile_name}.column_2 FROM {table_name}\n```\n\nIt made the **columns(column_1, column_2)** nested under **{profile_name}**, which is not parallel to **_id** and **id**. In this situation, my **geo_point** becomes a three-level nested field, which is definitely wrong.\n\nActually the SQL should be something like this (the **{profile_name}** is only needed in the definition of mapping)\n\n```\nSELECT _id, id, column_1 as column_1, column_2 as .column_2 FROM {table_name}\n```\n\nBy the way, for now, the version of ElasticSearch I'm using is 1.4.2, with the newest river plugin [here](https://github.com/jprante/elasticsearch-river-jdbc). Now I can only query the document by using\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"filter\": {\n        \"nested\": {\n          \"path\": \"coordinate\",\n          \"filter\": {\n            \"geo_polygon\": {\n              \"coordinate.value\": {\n                \"points\": [\n                  {\n                    \"lon\": -75,\n                    \"lat\": 40\n                  },\n                  {\n                    \"lon\": -70,\n                    \"lat\": 40\n                  },\n                  {\n                    \"lon\": -70,\n                    \"lat\": 45\n                  },\n                  {\n                    \"lon\": -75,\n                    \"lat\": 45\n                  }\n                ]\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nRather than using the one without **coordicate.** that you gave me. Which means it's not optional, at least in my version.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/67412454","html_url":"https://github.com/elastic/elasticsearch/issues/8935#issuecomment-67412454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8935","id":67412454,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NDEyNDU0","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2014-12-17T22:56:33Z","updated_at":"2014-12-17T22:56:33Z","author_association":"CONTRIBUTOR","body":"Glad to hear you got it working @ivanlw!  Cheers!\n","performed_via_github_app":null}]