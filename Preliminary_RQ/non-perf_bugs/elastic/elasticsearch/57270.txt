{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57270","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57270/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57270/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57270/events","html_url":"https://github.com/elastic/elasticsearch/issues/57270","id":626295361,"node_id":"MDU6SXNzdWU2MjYyOTUzNjE=","number":57270,"title":"[sql]stack overflow when unresolved alias that refers to a field with the same name that does not exist ","user":{"login":"Hailei","id":1724869,"node_id":"MDQ6VXNlcjE3MjQ4Njk=","avatar_url":"https://avatars1.githubusercontent.com/u/1724869?v=4","gravatar_id":"","url":"https://api.github.com/users/Hailei","html_url":"https://github.com/Hailei","followers_url":"https://api.github.com/users/Hailei/followers","following_url":"https://api.github.com/users/Hailei/following{/other_user}","gists_url":"https://api.github.com/users/Hailei/gists{/gist_id}","starred_url":"https://api.github.com/users/Hailei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Hailei/subscriptions","organizations_url":"https://api.github.com/users/Hailei/orgs","repos_url":"https://api.github.com/users/Hailei/repos","events_url":"https://api.github.com/users/Hailei/events{/privacy}","received_events_url":"https://api.github.com/users/Hailei/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967501040,"node_id":"MDU6TGFiZWwxOTY3NTAxMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:QL","name":"Team:QL","color":"fef2c0","default":false,"description":"Meta label for query languages team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-05-28T07:49:41Z","updated_at":"2020-06-22T13:04:46Z","closed_at":"2020-06-22T13:04:46Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):   7.6.2 and 7.7.0\r\n\r\n**Plugins installed**: []\r\nonly default plugin\r\n\r\n**JVM version** (`java -version`):\r\nbuiltin jdk\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n4.14.81.bm.17-amd64 #1 SMP Debian 4.14.81.bm.17 Sun Dec 15 02:54:05 UTC 2019 x86_64 GNU/Linux\r\n**Description of the problem including expected versus actual behavior**:\r\nFirst，create new blank index that named “test”,the mapping of index ,and execute the following query：\r\n\r\n> SELECT count(*) AS cnt,dete AS dete FROM test WHERE dete = 5 group by dete\r\n\r\nNeed to point out is  the column “dete” that don't exist，Once the SQL is executed, the node will crash,  Refer to Provide logs for the error stack\r\nDeep into the code, ResolveFilterRefs 's replaceAliases method results in an infinite loop\r\nAdd the following judgment to the if statement to break out of the loop\r\n> !(alias.child() instanceof UnresolvedAttribute)\r\n\r\nThe complete code is as follows:\r\n\r\n```java\r\nreturn condition.transformDown(u -> {\r\n                boolean qualified = u.qualifier() != null;\r\n                for (Alias alias : aliases) {\r\n                    if (qualified ? Objects.equals(alias.qualifiedName(), u.qualifiedName()) : Objects.equals(alias.name(), u.name())\r\n                     && !(alias.child() instanceof UnresolvedAttribute)) {\r\n                        return alias;\r\n                    }\r\n                }\r\n                return u;\r\n             }, UnresolvedAttribute.class);\r\n```\r\nAdd  unit test to the QueryTranslatorTests\r\n```java\r\n    public void testNoStackOverFlow() {\r\n        VerificationException ex = expectThrows(VerificationException.class, () -> plan(\"SELECT count(*) AS \\\"cnt\\\",\\\"dete\\\" AS \\\"dete\\\" FROM test WHERE dete = 5 group by \\\"dete\\\"\"));\r\n        assertTrue(ex.getMessage().contains(\"Unknown column [dete], did you mean [date]?\"));\r\n    }\r\n```\r\nIt works correctly\r\n**Steps to reproduce**:\r\n\r\n**Provide logs (if relevant)**:\r\njava.lang.reflect.InvocationTargetException: null\r\n        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method) ~[?:?]\r\n        at jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62) ~[?:?]\r\n        at jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43) ~[?:?]\r\n        at java.lang.reflect.Method.invoke(Method.java:567) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformChildren(Node.java:210) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformDown(Node.java:178) ~[?:?]\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformDown$8(Node.java:178) ~[?:?]\r\n\r\n\r\n","closed_by":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"performed_via_github_app":null}