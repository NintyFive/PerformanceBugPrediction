{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22278","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22278/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22278/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22278/events","html_url":"https://github.com/elastic/elasticsearch/issues/22278","id":196629454,"node_id":"MDU6SXNzdWUxOTY2Mjk0NTQ=","number":22278,"title":"Improve test coverage for bucket and metric aggregations","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2016-12-20T09:53:46Z","updated_at":"2017-06-23T14:42:09Z","closed_at":"2017-06-23T14:42:09Z","author_association":"MEMBER","active_lock_reason":null,"body":"Today there is very little unit test coverage for bucket and metric aggregations. This meta issue aim is to significantly improve that. For each aggregation we should add more unit tests for the aggregator (how it interacts with the Lucene index via `org.apache.lucene.search.Collector` that each aggregation implements), the reduce logic and serialization of the aggregation results.\r\n\r\nWe should add unit tests for the following `Aggregator` implementations:\r\n\r\n- [x] `ParentToChildrenAggregator` @cbuescher #23305\r\n- [x] `FilterAggregator` @colings86 #23826\r\n- [x] `FiltersAggregator` @jimczi #22678 \r\n- [x] `GeoHashGridAggregator` @martijnvg #23417\r\n- [x] `GlobalAggregator` @nik9000 #22668\r\n- [x] `DateHistogramAggregator` @tlrx #22714\r\n- [x] `HistogramAggregator` @jpountz #22961\r\n- [x] `MissingAggregator` @jimczi  #23895\r\n- [x] `NestedAggregator` @polyfractal\r\n- [x] `ReverseNestedAggregator` @cbuescher\r\n- [x] `RangeAggregator` (also test with `DateRangeAggregationBuilder` and `GeoDistanceAggregationBuilder`) @tlrx #24569\r\n- [x] `BinaryRangeAggregator` (also test with `IpRangeAggregationBuilder`) @jimczi #23255\r\n- [x] Diversified sampler aggregator, which has the following implementations that need to be tested: `DiversifiedBytesHashSamplerAggregator`, `DiversifiedMapSamplerAggregator`, `DiversifiedNumericSamplerAggregator` and `DiversifiedOrdinalsSamplerAggregator`. @martijnvg #23511\r\n- [x] `SamplerAggregator` @nik9000 #23243\r\n- [x] Significant terms aggregation: `GlobalOrdinalsSignificantTermsAggregator`, `GlobalOrdinalsSignificantTermsAggregator.WithHash`, `SignificantLongTermsAggregator` and `SignificantStringTermsAggregator`. @markharwood #24904\r\n- [x] Terms aggregation: `DoubleTermsAggregator`, `GlobalOrdinalsStringTermsAggregator. LowCardinality`, `GlobalOrdinalsStringTermsAggregator. WithHash`, `LongTermsAggregator` and `StringTermsAggregator`. @martijnvg   #24949\r\n- [x] `BestBucketsDeferringCollector` @MaineC #23511\r\n- [x]  `BestDocsDeferringCollector`  @polyfractal #23511\r\n- [x] `AvgAggregator` @cbuescher #23000\r\n- [x] `CardinalityAggregator` @colings86 #23826\r\n- [x] `GeoBoundsAggregator` @jimczi #23259\r\n- [x] `GeoCentroidAggregator` @martijnvg #24111\r\n- [x] `MaxAggregator` @nik9000 #22668\r\n- [x] `MinAggregator` [**MvG**] #22279\r\n- [x]  Percentiles metric aggregation: `TDigestPercentilesAggregator` and `HDRPercentilesAggregator` @tlrx #24245\r\n- [x]  Percentiles rank metric aggregation: `TDigestPercentileRanksAggregator` and `HDRPercentileRanksAggregator`. @jpountz #23240\r\n- [x] `ScriptedMetricAggregator` @cbuescher #23404\r\n- [x] `StatsAggregator` @jimczi\r\n- [x] `ExtendedStatsAggregator` @jimczi\r\n- [x] `SumAggregator` @martijnvg #22954\r\n- [x] `TopHitsAggregator` @nik9000 #22754\r\n- [x] `ValueCountAggregator` @tlrx #22741\r\n- [x] `MatrixStatsAggregator` @martijnvg #24837\r\n\r\nWe should also add tests for the following `InternalAggregation` implementations:\r\n(to test the reduce and result serialization logic)\r\n\r\n- [x] `InternalChildren` @cbuescher #23261\r\n- [x] `InternalFilter` @colings86 #23388\r\n- [x] `InternalFilters` @jimczi #22678 \r\n- [x] `InternalGeoHashGrid` @martijnvg #23417\r\n- [x] `InternalGlobal` @nik9000 #23388\r\n- [x] `InternalHistogram` @jpountz #22961\r\n- [x] `InternalDateHistogram` @tlrx #23402\r\n- [x] `InternalMissing` @MaineC #23388\r\n- [x] `InternalNested` @polyfractal #23388\r\n- [x] `InternalReverseNested` @cbuescher #23388\r\n- [x] `InternalRange`, `InternalDateRange`, `InternalGeoDistance`. @tlrx #24569\r\n- [x] `InternalBinaryRange` @jimczi #23259\r\n- [x] `InternalSampler` @martijnvg edada2581e75400da9fac82bdfbc7ec1f02ef0d8\r\n- [x] Significant terms aggregation: `SignificantLongTerms` and `SignificantStringTerms`. @tlrx #23428 \r\n- [x] Terms aggregation: `DoubleTerms`, `LongTerms`, `StringTerms` and `UnmappedTerms`. @jpountz #23149\r\n- [x] `InternalAvg` @cbuescher #23000\r\n- [x] `InternalCardinality` @colings86 #23826\r\n- [x] `InternalGeoBounds` @jimczi #23259 \r\n- [x] `InternalGeoCentroid` @martijnvg #24176\r\n- [x] `InternalMax` @nik9000 #22668\r\n- [x] `InternalMin` @colings86 + @nik9000 #22668\r\n- [x]  Percentiles metric aggregation: `InternalTDigestPercentiles` (#24090) and `InternalHDRPercentiles` (#24157) @tlrx\r\n- [x]  Percentiles rank metric aggregation: `InternalTDigestPercentileRanks` and `InternalHDRPercentileRanks`. @jpountz #23240\r\n- [x] `InternalScriptedMetric` @cbuescher #23330\r\n- [x] `InternalStats` @jimczi\r\n- [x] `InternalExtendedStats` @jimczi\r\n- [x] `InternalSum` @martijnvg #22954\r\n- [x] `InternalTopHits` @nik9000\r\n- [x] `InternalValueCount` @tlrx #22741\r\n- [x] `InternalMatrixStats` @martijnvg #24559\r\n\r\nI may have forgotten some classes, so please update this issue if that is the case :)\r\n\r\nI listed the `InternalAggregation` implementations separately from `Aggregator` implementations as unit tests for each can be written in parallel by different devs. However I think for the less complex aggregations unit tests for both the `InternalAggregation` implementation and `Aggregator` implementations can be added in the same PR.\r\n\r\nI think at least the unit tests should be added to the master branch. Backporting to 5.x branch is best effort and should only be considered if it is low hanging fruit.\r\n\r\nI suggest that we work in the following way in order to avoid accidentally doing work twice:\r\n* Add your name the a task you like to work on before starting to write the unit tests.\r\n* When you open a pr then add the PR number to task.\r\n* Once the pr is merged, then check off the task.\r\n\r\nNote that aggregations are tested, however due to how before the code was structured, unit testing was really difficult. ","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}