{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46928","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46928/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46928/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46928/events","html_url":"https://github.com/elastic/elasticsearch/issues/46928","id":496386058,"node_id":"MDU6SXNzdWU0OTYzODYwNTg=","number":46928,"title":"[DOCS] _exists_ returns `too_many_clauses` exception","user":{"login":"thePanz","id":226021,"node_id":"MDQ6VXNlcjIyNjAyMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/226021?v=4","gravatar_id":"","url":"https://api.github.com/users/thePanz","html_url":"https://github.com/thePanz","followers_url":"https://api.github.com/users/thePanz/followers","following_url":"https://api.github.com/users/thePanz/following{/other_user}","gists_url":"https://api.github.com/users/thePanz/gists{/gist_id}","starred_url":"https://api.github.com/users/thePanz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thePanz/subscriptions","organizations_url":"https://api.github.com/users/thePanz/orgs","repos_url":"https://api.github.com/users/thePanz/repos","events_url":"https://api.github.com/users/thePanz/events{/privacy}","received_events_url":"https://api.github.com/users/thePanz/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"assignees":[{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2019-09-20T14:31:36Z","updated_at":"2019-10-18T14:20:23Z","closed_at":"2019-10-18T14:20:23Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 7.3.2\r\n**Plugins installed**: none\r\n**JVM version**: 12.0.2\r\n**OS version**: latest docker container for 7.3.2\r\n\r\n**Issue**\r\nRunning the following query: `{\"query\": {\"exists\": {\"field\": \"myField\"}}}}` returns a \"all shards failed\" due to `too_many_clauses` exception.\r\n\r\nThe container log reports:\r\n```\r\nelasticsearch_1  | {\"type\": \"server\", \"timestamp\": \"2019-09-20T13:49:09,025+0000\", \"level\": \"DEBUG\", \"component\": \"o.e.a.s.TransportSearchAction\", \"cluster.name\": \"elasticsearch\", \"node.name\": \"es01\", \"cluster.uuid\": \"Lj6To9uwSTetSdntuC4Wyw\", \"node.id\": \"iCm50_K2QEq8aV9FZcrTWg\",  \"message\": \"All shards failed for phase: [query]\" , \r\nelasticsearch_1  | \"stacktrace\": [\"org.elasticsearch.index.query.QueryShardException: failed to create query: {\",\r\nelasticsearch_1  | \"  \\\"exists\\\" : {\",\r\nelasticsearch_1  | \"    \\\"field\\\" : \\\"myField\\\",\",\r\nelasticsearch_1  | \"    \\\"boost\\\" : 1.0\",\r\nelasticsearch_1  | \"  }\",\r\nelasticsearch_1  | \"}\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.QueryShardContext.toQuery(QueryShardContext.java:321) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.QueryShardContext.toQuery(QueryShardContext.java:304) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.search.SearchService.parseSource(SearchService.java:743) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.search.SearchService.createContext(SearchService.java:591) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:550) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:353) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.search.SearchService.lambda$executeQueryPhase$1(SearchService.java:340) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.action.ActionListener.lambda$map$2(ActionListener.java:145) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:62) [elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.search.SearchService$2.doRun(SearchService.java:1052) [elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) [elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:758) [elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\",\r\nelasticsearch_1  | \"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\",\r\nelasticsearch_1  | \"at java.lang.Thread.run(Thread.java:835) [?:?]\",\r\nelasticsearch_1  | \"Caused by: org.apache.lucene.search.BooleanQuery$TooManyClauses: maxClauseCount is set to 1024\",\r\nelasticsearch_1  | \"at org.apache.lucene.search.BooleanQuery$Builder.add(BooleanQuery.java:114) ~[lucene-core-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:34:03]\",\r\nelasticsearch_1  | \"at org.apache.lucene.search.BooleanQuery$Builder.add(BooleanQuery.java:127) ~[lucene-core-8.1.0.jar:8.1.0 dbe5ed0b2f17677ca6c904ebae919363f2d36a0a - ishan - 2019-05-09 19:34:03]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.ExistsQueryBuilder.newObjectFieldExistsQuery(ExistsQueryBuilder.java:208) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.ExistsQueryBuilder.newFieldExistsQuery(ExistsQueryBuilder.java:195) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.ExistsQueryBuilder.newFilter(ExistsQueryBuilder.java:157) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.ExistsQueryBuilder.doToQuery(ExistsQueryBuilder.java:130) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.AbstractQueryBuilder.toQuery(AbstractQueryBuilder.java:99) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.QueryShardContext.lambda$toQuery$1(QueryShardContext.java:305) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"at org.elasticsearch.index.query.QueryShardContext.toQuery(QueryShardContext.java:317) ~[elasticsearch-7.3.2.jar:7.3.2]\",\r\nelasticsearch_1  | \"... 16 more\"] }\r\n```\r\n\r\n**Steps to reproduce**:\r\nThe issue relies on the mapping structure of the `myField` property, which contains ~80 sub-properties, and those have between 10 to 50 (or more) sub-properties.\r\nNo analysis is defined for the index.\r\n\r\nA quick gist of the document defined in the mappings:\r\n```\r\n- propertyA <-- this property fill cause the issue, \"myField\" in the example\r\n    - propertyA01\r\n        - propertyA01_01\r\n        - propertyA01_02\r\n            - propertyA01_02_01\r\n            - .. ~10 properties at this level\r\n        - propertyA01_03\r\n        - .. ~15 properties at this level\r\n        - propertyA01_xx\r\n    - propertyA02\r\n    - .. ~85 properties at this level (with additional sub-levels)\r\n    - propertyA80\r\n- propertyB\r\n- .. ~80 properties at this level\r\n- propertyXX\r\n```\r\n 1. Create an index with no analysis, \r\n 2. Create a mapping with a document configured as above\r\n 3. Query for the `_exists_` with the property pointed above\r\n","closed_by":{"login":"jrodewig","id":40268737,"node_id":"MDQ6VXNlcjQwMjY4NzM3","avatar_url":"https://avatars1.githubusercontent.com/u/40268737?v=4","gravatar_id":"","url":"https://api.github.com/users/jrodewig","html_url":"https://github.com/jrodewig","followers_url":"https://api.github.com/users/jrodewig/followers","following_url":"https://api.github.com/users/jrodewig/following{/other_user}","gists_url":"https://api.github.com/users/jrodewig/gists{/gist_id}","starred_url":"https://api.github.com/users/jrodewig/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jrodewig/subscriptions","organizations_url":"https://api.github.com/users/jrodewig/orgs","repos_url":"https://api.github.com/users/jrodewig/repos","events_url":"https://api.github.com/users/jrodewig/events{/privacy}","received_events_url":"https://api.github.com/users/jrodewig/received_events","type":"User","site_admin":false},"performed_via_github_app":null}