{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40059","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40059/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40059/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40059/events","html_url":"https://github.com/elastic/elasticsearch/issues/40059","id":421137175,"node_id":"MDU6SXNzdWU0MjExMzcxNzU=","number":40059,"title":"CCS: sibling pipeline aggregations don't work when minimizing roundtrips","user":{"login":"chrisronline","id":56682,"node_id":"MDQ6VXNlcjU2Njgy","avatar_url":"https://avatars1.githubusercontent.com/u/56682?v=4","gravatar_id":"","url":"https://api.github.com/users/chrisronline","html_url":"https://github.com/chrisronline","followers_url":"https://api.github.com/users/chrisronline/followers","following_url":"https://api.github.com/users/chrisronline/following{/other_user}","gists_url":"https://api.github.com/users/chrisronline/gists{/gist_id}","starred_url":"https://api.github.com/users/chrisronline/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/chrisronline/subscriptions","organizations_url":"https://api.github.com/users/chrisronline/orgs","repos_url":"https://api.github.com/users/chrisronline/repos","events_url":"https://api.github.com/users/chrisronline/events{/privacy}","received_events_url":"https://api.github.com/users/chrisronline/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2019-03-14T16:57:40Z","updated_at":"2019-03-19T07:45:35Z","closed_at":"2019-03-19T07:45:35Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): latest master snapshot (hash: `8839a72`)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): `java version \"11.0.1\" 2018-10-16 LTS`\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): `Darwin Kernel Version 18.2.0`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen performing a CCS search request, an error occurs if there is a pipeline aggregation in the query.\r\n\r\nThe exact error is:\r\n```\r\n   │      java.lang.UnsupportedOperationException: Not supported\r\n   │      \tat org.elasticsearch.search.aggregations.pipeline.InternalSimpleValue.doReduce(InternalSimpleValue.java:80) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n   │      \tat org.elasticsearch.search.aggregations.pipeline.InternalSimpleValue.doReduce(InternalSimpleValue.java:34) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n   │      \tat org.elasticsearch.search.aggregations.InternalAggregation.reduce(InternalAggregation.java:135) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n   │      \tat org.elasticsearch.search.aggregations.InternalAggregations.reduce(InternalAggregations.java:90) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n   │      \tat org.elasticsearch.action.search.SearchResponseMerger.getMergedResponse(SearchResponseMerger.java:193) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n   │      \tat org.elasticsearch.action.search.TransportSearchAction$3.createFinalResponse(TransportSearchAction.java:389) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n   │      \tat org.elasticsearch.action.search.TransportSearchAction$3.createFinalResponse(TransportSearchAction.java:379) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Start two ES instances, ensuring they have unique `cluster.name`s\r\n2. Bulk index documents into both:\r\n```\r\nPOST _bulk\r\n{ \"index\": { \"_index\": \"sales\" } }\r\n{ \"price\": 10, \"payment_type\": \"credit_card\" }\r\n{ \"index\": { \"_index\": \"sales\" } }\r\n{ \"price\": 20, \"payment_type\": \"cash\" }\r\n```\r\n3. Configure one ES instance to talk to the other through CCS\r\n```\r\nPOST _cluster/settings\r\n{\r\n  \"persistent\": {\r\n    \"cluster\": {\r\n      \"remote\": {\r\n        \"other\": {\r\n          \"seeds\": [\r\n            \"{other_es_instance_address}\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n4. Perform a CCS search that uses a pipeline aggregations from the same ES instance\r\n```\r\nPOST *:sales,sales/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"sales_per_type\": {\r\n      \"terms\": {\r\n        \"field\": \"payment_type.keyword\"\r\n      },\r\n      \"aggs\": {\r\n        \"sales\": {\r\n          \"sum\": {\r\n            \"field\": \"price\"\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"max_per_type\": {\r\n      \"max_bucket\": {\r\n        \"buckets_path\": \"sales_per_type>sales\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\nIt's worth noting that the same query does not incur an error when used in either of these contexts:\r\n`POST sales/_search`\r\n`POST *:sales/_search`\r\n\r\nThe error only occurs when doing them together: `POST *:sales,sales/_search`.\r\n\r\nIt's also worth noting that the query does not incur an error when you remove the pipeline aggregation:\r\n```\r\nPOST *:sales,sales/_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"sales_per_type\": {\r\n      \"terms\": {\r\n        \"field\": \"payment_type.keyword\"\r\n      },\r\n      \"aggs\": {\r\n        \"sales\": {\r\n          \"sum\": {\r\n            \"field\": \"price\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis is currently **BREAKING** the Kibana Stack Monitoring app, as we run these sorts of pipeline aggregations which are currently broken with CCS enabled.\r\n\r\nThe work done [in this PR](https://github.com/elastic/elasticsearch/pull/37000) *might* be related to this, as the description seems like it touches the code around this\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}