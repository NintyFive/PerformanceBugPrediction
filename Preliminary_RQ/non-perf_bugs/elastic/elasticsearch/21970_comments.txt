[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264868949","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-264868949","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":264868949,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDg2ODk0OQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2016-12-05T14:34:30Z","updated_at":"2016-12-05T14:34:30Z","author_association":"CONTRIBUTOR","body":"@dakrone, I think this is some fun combination of your script limiter and ingest templates. Can you have a look?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/264974952","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-264974952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":264974952,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NDk3NDk1Mg==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-12-05T20:57:44Z","updated_at":"2016-12-05T20:57:44Z","author_association":"MEMBER","body":"Sure I'll take a look at this.\r\n\r\n> We also change the \"script.max_compilations_per_minute\" to have a try, but it seems not work.\r\n\r\n@xxx111x1 can you explain a little bit more about this? This should be a dynamic setting. What do you mean by \"seems not [to] work\"?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265035956","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-265035956","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":265035956,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTAzNTk1Ng==","user":{"login":"xxx111x1","id":13516071,"node_id":"MDQ6VXNlcjEzNTE2MDcx","avatar_url":"https://avatars2.githubusercontent.com/u/13516071?v=4","gravatar_id":"","url":"https://api.github.com/users/xxx111x1","html_url":"https://github.com/xxx111x1","followers_url":"https://api.github.com/users/xxx111x1/followers","following_url":"https://api.github.com/users/xxx111x1/following{/other_user}","gists_url":"https://api.github.com/users/xxx111x1/gists{/gist_id}","starred_url":"https://api.github.com/users/xxx111x1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xxx111x1/subscriptions","organizations_url":"https://api.github.com/users/xxx111x1/orgs","repos_url":"https://api.github.com/users/xxx111x1/repos","events_url":"https://api.github.com/users/xxx111x1/events{/privacy}","received_events_url":"https://api.github.com/users/xxx111x1/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T01:43:05Z","updated_at":"2016-12-06T01:43:05Z","author_association":"NONE","body":"@dakrone \r\nThanks for your reply, \"seems not [to] work\" means, the setting is work, but enlarging the max_compilations_per_minute value cannot resolve my problem.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265308842","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-265308842","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":265308842,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTMwODg0Mg==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T23:38:49Z","updated_at":"2016-12-06T23:38:49Z","author_association":"MEMBER","body":"@xxx111x1 I've been trying to reproduce this, but without any luck, here's what I've done:\r\n\r\nOn 5.0.0, I started ES with `script.painless.regex.enabled: true`, then performed:\r\n\r\n```json\r\nPOST /_scripts/painless/index-device-and-app?pretty\r\n{\r\n  \"script\": \"if (ctx._index.startsWith('logstash-raw-')) {if (ctx.tag == 'gBbJrY' || ctx.tag == 'tThBgH') {def re = /^\\\\d+\\\\/\\\\d+\\\\/\\\\d+\\\\/(?<source>[^\\\\/]+)\\\\/(?<uid>\\\\d+)\\\\/(?<did>\\\\d+)_\\\\d+\\\\.\\\\S+$/; def m = re.matcher(ctx.parameters[0]); if (m.matches()) {ctx._index = ctx._index.replace('logstash-raw-', 'logstash-' + m.namedGroup('source') + '-'); ctx.deviceId = m.namedGroup('did'); ctx.userId = m.namedGroup('uid');}}} \"\r\n}\r\n\r\nPOST /_scripts/painless/extract-app-stat?pretty\r\n{\r\n  \"script\": \"if (ctx._index.startsWith('logstash-app-')) {def re = /^\\\\[(?<logtime>.*?)\\\\] \\\\[INFO\\\\] \\\\[STAT\\\\] (?<measure>.*)$/; def m = re.matcher(ctx.parameters[1]); if (m.matches()) {def measureValues = /,/.split(m.namedGroup('measure')); def name = measureValues[0].replace(' ', ''); def value = null; if (measureValues.length > 1) {value = measureValues[1].trim();} if (value == 'on' || value == 'off' || value == 'auto') {name = name + value; value = null;} if (value == null) {ctx[name + '_count'] = 1;} else {if (value.startsWith('time = ')) {value = Float.parseFloat(value.substring(7));} ctx[name] = value; ctx[name + '_count'] = 1;} ctx.stat = true;} re = /^\\\\[(?<logtime>.*?)\\\\].*$/; m = re.matcher(ctx.parameters[1]); if (m.matches()) {def f = new SimpleDateFormat(\\\"yyyy-MM-dd'T'HH:mm:ss.SSSZ\\\"); def p = new SimpleDateFormat('yy-MM-dd hh:mm:ss'); f.setTimeZone(TimeZone.getTimeZone('Asia/Shanghai')); p.setTimeZone(TimeZone.getTimeZone('Asia/Shanghai')); ctx.logtime = f.format(p.parse(m.namedGroup('logtime')));}} \"\r\n}\r\n```\r\n\r\nTo store the scripts in ES (which compiles them, so this would be 2 script compilations counted towards the bucket).\r\n\r\nThen I added the pipeline as you had it defined:\r\n\r\n```json\r\nPUT /_ingest/pipeline/logstashLogs\r\n{\r\n  \"description\": \"Get device id and user id\",\r\n  \"processors\": [\r\n    {\r\n      \"script\": {\r\n        \"lang\": \"painless\",\r\n        \"id\": \"index-device-and-app\"\r\n      }\r\n    },\r\n    {\r\n      \"script\": {\r\n        \"lang\": \"painless\",\r\n        \"id\": \"extract-app-stat\"\r\n      }\r\n    }\r\n  ],\r\n  \"on_failure\": [\r\n    {\r\n      \"set\": {\r\n        \"field\": \"_index\",\r\n        \"value\": \"failed-{{ _index }}\"\r\n      }\r\n    },\r\n    {\r\n      \"set\": {\r\n        \"field\": \"_error\",\r\n        \"value\": \"{{ _ingest }}\"\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nI then ran the following in a tight loop over and over to try and trip the circuit breaker:\r\n\r\n```json\r\nPOST /logstash-app-1/doc?pipeline=logstashLogs&pretty\r\n{\"body\": \"foo\"}\r\n```\r\n\r\nHowever, I was never able to get the circuit breaker to trip.\r\n\r\nCan you confirm this is how you're using the system? Is there perhaps something that continually re-adds the script that could be causing more compilation? Am I missing any steps for how you are running this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265357519","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-265357519","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":265357519,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTM1NzUxOQ==","user":{"login":"xxx111x1","id":13516071,"node_id":"MDQ6VXNlcjEzNTE2MDcx","avatar_url":"https://avatars2.githubusercontent.com/u/13516071?v=4","gravatar_id":"","url":"https://api.github.com/users/xxx111x1","html_url":"https://github.com/xxx111x1","followers_url":"https://api.github.com/users/xxx111x1/followers","following_url":"https://api.github.com/users/xxx111x1/following{/other_user}","gists_url":"https://api.github.com/users/xxx111x1/gists{/gist_id}","starred_url":"https://api.github.com/users/xxx111x1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xxx111x1/subscriptions","organizations_url":"https://api.github.com/users/xxx111x1/orgs","repos_url":"https://api.github.com/users/xxx111x1/repos","events_url":"https://api.github.com/users/xxx111x1/events{/privacy}","received_events_url":"https://api.github.com/users/xxx111x1/received_events","type":"User","site_admin":false},"created_at":"2016-12-07T05:11:14Z","updated_at":"2016-12-07T05:11:14Z","author_association":"NONE","body":"@dakrone, it is wired that there is no error now. The only thing we did is changing the logstash configuration.\r\n\r\nWe wrote two configs for two topics, and we found it was wroten twince into Elastic Search. So we merge the two configs to one.\r\n\r\n**Before the change, two configuration files.**\r\ninput {\r\n  kafka {\r\n    bootstrap_servers => \"10.2.1.23:9092\"\r\n    topics => [\"flume_1\"]\r\n    consumer_threads => 4\r\n    session_timeout_ms => \"30000\"\r\n    max_poll_records => \"64\"\r\n    codec => \"json\"\r\n  }\r\n}\r\nfilter {\r\n  date {\r\n    match => [\"timestamp\", \"UNIX_MS\"]\r\n    timezone => \"Asia/Shanghai\"\r\n  }\r\n}\r\noutput {\r\n  elasticsearch {\r\n    hosts => [\"10.2.1.33:9200\",\"10.2.1.28:9200\",\"10.2.1.32:9200\",\"10.2.1.35:9200                                                       \"]\r\n    index => \"logstash-raw-%{+YYYY-MM-dd}\"\r\n    user => \"logstash\"\r\n    password => \"1111111\"\r\n    pipeline => \"logstashLogs\"\r\n    flush_size => 4096\r\n  }\r\n}\r\n\r\ninput {\r\n  kafka {\r\n    bootstrap_servers => \"10.2.1.23:9092\"\r\n    topics => [\"ipc002_1\"]\r\n    consumer_threads => 4\r\n    session_timeout_ms => \"30000\"\r\n    max_poll_records => \"64\"\r\n    codec => \"json\"\r\n  }\r\n}\r\nfilter {\r\n  date {\r\n    match => [\"timestamp\", \"UNIX_MS\"]\r\n    timezone => \"Asia/Shanghai\"\r\n  }\r\n}\r\noutput {\r\n  elasticsearch {\r\n    hosts => [\"10.2.1.33:9200\",\"10.2.1.28:9200\",\"10.2.1.32:9200\",\"10.2.1.35:9200                                                       \"]\r\n    index => \"logstash-raw-%{+YYYY-MM-dd}\"\r\n    user => \"logstash\"\r\n    password => \"1111111\"\r\n    pipeline => \"logstashLogs\"\r\n    flush_size => 4096\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n**Now, one files**\r\ninput {\r\n  kafka {\r\n    bootstrap_servers => \"10.2.1.23:9092\"\r\n    topics => [\"flume_1\", \"ipc002_1\"]\r\n    consumer_threads => 4\r\n    session_timeout_ms => \"30000\"\r\n    max_poll_records => \"64\"\r\n    codec => \"json\"\r\n  }\r\n}\r\nfilter {\r\n  date {\r\n    match => [\"timestamp\", \"UNIX_MS\"]\r\n    timezone => \"Asia/Shanghai\"\r\n  }\r\n}\r\noutput {\r\n  elasticsearch {\r\n    hosts => [\"10.2.1.33:9200\",\"10.2.1.28:9200\",\"10.2.1.32:9200\",\"10.2.1.35:9200                                                       \"]\r\n    index => \"logstash-raw-%{+YYYY-MM-dd}\"\r\n    user => \"logstash\"\r\n    password => \"1111111\"\r\n    pipeline => \"logstashLogs\"\r\n    flush_size => 4096\r\n  }\r\n}\r\n\r\nI don't think this is relative with this issue, but now, there is no more errors. \r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265589822","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-265589822","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":265589822,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTU4OTgyMg==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-12-07T22:12:09Z","updated_at":"2016-12-07T22:12:09Z","author_association":"MEMBER","body":"Can you include the entire exception and stacktrace from the logs when this occurs next? I'd like to see where it came from.\r\n\r\nAre you doing any other scripting in this cluster other than this pipeline during indexing?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265641138","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-265641138","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":265641138,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTY0MTEzOA==","user":{"login":"xxx111x1","id":13516071,"node_id":"MDQ6VXNlcjEzNTE2MDcx","avatar_url":"https://avatars2.githubusercontent.com/u/13516071?v=4","gravatar_id":"","url":"https://api.github.com/users/xxx111x1","html_url":"https://github.com/xxx111x1","followers_url":"https://api.github.com/users/xxx111x1/followers","following_url":"https://api.github.com/users/xxx111x1/following{/other_user}","gists_url":"https://api.github.com/users/xxx111x1/gists{/gist_id}","starred_url":"https://api.github.com/users/xxx111x1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xxx111x1/subscriptions","organizations_url":"https://api.github.com/users/xxx111x1/orgs","repos_url":"https://api.github.com/users/xxx111x1/repos","events_url":"https://api.github.com/users/xxx111x1/events{/privacy}","received_events_url":"https://api.github.com/users/xxx111x1/received_events","type":"User","site_admin":false},"created_at":"2016-12-08T03:06:35Z","updated_at":"2016-12-08T03:06:35Z","author_association":"NONE","body":"Sure, however do you know which log file I should looking for? Since we cannot find this error message neither in \"logstash-plain-{date}.log\" nor  \"elasticsearch-{date}.log\" files where the date is the day errors happended.\r\n\r\nAs for the second question, no other scripts .","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266084426","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-266084426","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":266084426,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NjA4NDQyNg==","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"created_at":"2016-12-09T18:22:36Z","updated_at":"2016-12-09T18:22:36Z","author_association":"MEMBER","body":"> Sure, however do you know which log file I should looking for?\r\n\r\nIt should be in the regular `elasticsearch.log` file","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290722310","html_url":"https://github.com/elastic/elasticsearch/issues/21970#issuecomment-290722310","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21970","id":290722310,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcyMjMxMA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T14:09:40Z","updated_at":"2017-03-31T14:09:40Z","author_association":"MEMBER","body":"No further feedback. @xxx111x1 if you have the exception then please paste it in a comment and reopen","performed_via_github_app":null}]