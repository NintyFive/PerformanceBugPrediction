{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57645","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57645/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57645/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57645/events","html_url":"https://github.com/elastic/elasticsearch/issues/57645","id":630609083,"node_id":"MDU6SXNzdWU2MzA2MDkwODM=","number":57645,"title":"[ML] Deleting open job's results index causes recreation with write alias name","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-06-04T08:14:54Z","updated_at":"2020-08-04T09:55:20Z","closed_at":"2020-08-04T09:55:20Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Deleting the results index of an anomaly detection job while it is running is not expected or supported.  However, if it is done then this is what happens:\r\n\r\n- Because the results writes are being made via the write alias, a concrete index named after the write alias is auto-created\r\n- Because reads of results are done via the read alias, subsequent reads of results for the job find no results\r\n\r\nSo, if a job appears to be running but no results for it exist then it is worth checking if deletion of the results index is the cause.  The simplest place to look is the output from `_cat/indices` - the concrete index for the job named after the write alias will look strange compared to the other ML indices listed in the output.\r\n\r\nThe next question is whether we could do anything to fail fast in this situation.\r\n\r\nOne idea that has been previously suggested is to add a `?alias_required` argument to index requests that would fail the request if the write was not being made via an alias.  This would be very helpful for ML.\r\n\r\nAnother possibility that doesn't require any core changes is that we could check the responses immediately after indexing anomaly results.  The response to an index or bulk request says which index it was indexed into, even if this was specified as an alias in the request.  Since we know we are supposed to be indexing via an alias we could fail the job if the index contained in the response is identical to the name we supplied in the index or bulk request.\r\n\r\nAnother possibility would be to intercept delete index requests using a filter client and reject any for indices with names beginning `.ml` that didn't come from the `_xpack` user.  This could however be dangerous, as it would make it hard to recover from corruption caused by future bugs.  So this is probably the least desirable of the 3 options.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}