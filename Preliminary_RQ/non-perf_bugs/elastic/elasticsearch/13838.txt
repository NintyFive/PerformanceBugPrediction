{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13838","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13838/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13838/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13838/events","html_url":"https://github.com/elastic/elasticsearch/issues/13838","id":108842118,"node_id":"MDU6SXNzdWUxMDg4NDIxMTg=","number":13838,"title":"Elasticsearch creates same log entry multiple times","user":{"login":"tigranterteryan","id":7555393,"node_id":"MDQ6VXNlcjc1NTUzOTM=","avatar_url":"https://avatars2.githubusercontent.com/u/7555393?v=4","gravatar_id":"","url":"https://api.github.com/users/tigranterteryan","html_url":"https://github.com/tigranterteryan","followers_url":"https://api.github.com/users/tigranterteryan/followers","following_url":"https://api.github.com/users/tigranterteryan/following{/other_user}","gists_url":"https://api.github.com/users/tigranterteryan/gists{/gist_id}","starred_url":"https://api.github.com/users/tigranterteryan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tigranterteryan/subscriptions","organizations_url":"https://api.github.com/users/tigranterteryan/orgs","repos_url":"https://api.github.com/users/tigranterteryan/repos","events_url":"https://api.github.com/users/tigranterteryan/events{/privacy}","received_events_url":"https://api.github.com/users/tigranterteryan/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2015-09-29T10:36:33Z","updated_at":"2015-09-29T13:57:55Z","closed_at":"2015-09-29T12:57:16Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nI have a problem with Elasticsearch creating same entry in DB 2 or more times.\n\nHere is the search of the entry before it appears in DB:\n\n```\nroot@elk:/home/tigran# curl -XGET localhost:9200/appdev-2015.09.29/jibeqa/_search -d '{\"query\":{\"bool\":{\"must\":[{\"term\":{\"jibeqa.date\":\"2015-09-29T07:10:50+0000\"}}],\"must_not\":[],\"should\":[]}},\"from\":0,\"size\":10,\"sort\":[],\"facets\":{}}' | json_pp\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100   270  100   122  100   148  19473  23623 --:--:-- --:--:-- --:--:-- 24666\n{\n   \"timed_out\" : false,\n   \"hits\" : {\n      \"total\" : 0,\n      \"hits\" : [],\n      \"max_score\" : null\n   },\n   \"took\" : 1,\n   \"_shards\" : {\n      \"successful\" : 5,\n      \"total\" : 5,\n      \"failed\" : 0\n   }\n}\nroot@elk:/home/tigran#\n```\n\nAs you can see it is empty for now.\n\nNow I send json to the log file which will be forwarded with logstash-forwarder\n\n```\n{\"appId\":\"imas-dev-10.240.21.82\",\"date\":\"2015-09-29T07:10:50+0000\",\"category\":\"IMAS_CHATSESSION_MESSAGE_RECEIVED_121\",\"user\":\"+11000040488\",\"toUser\":\"+11000040466\",\"messageType\":\"imdn\",\"contributionId\":\"FACfIAV6DA\",\"size\":265,\"extras\":{}}\n```\n\nlogstash rubydebug shows that it was parsed and sent to Elasticsearch just once:\n\n```\n{\n             \"appId\" => \"imas-dev-10.240.21.82\",\n              \"date\" => \"2015-09-29T07:10:50+0000\",\n          \"category\" => \"IMAS_CHATSESSION_MESSAGE_RECEIVED_121\",\n              \"user\" => \"+11000040488\",\n            \"toUser\" => \"+11000040466\",\n       \"messageType\" => \"imdn\",\n    \"contributionId\" => \"FACfIAV6DA\",\n              \"size\" => 265,\n            \"extras\" => {},\n          \"@version\" => \"1\",\n        \"@timestamp\" => \"2015-09-29T07:10:50.000Z\",\n              \"file\" => \"/opt/jibe/jetty_master/reporting_MASTER_local/logs/reporting.log\",\n              \"host\" => \"app3-us\",\n            \"offset\" => \"2390\",\n              \"tags\" => \"appdev\",\n              \"type\" => \"jibeqa\"\n}\n```\n\nBut new search in Elasticsearch shows that it was created 2 times:\n\n```\nroot@elk:/home/tigran# curl -XGET localhost:9200/appdev-2015.09.29/jibeqa/_search -d '{\"query\":{\"bool\":{\"must\":[{\"term\":{\"jibeqa.date\":\"2015-09-29T07:10:50+0000\"}}],\"must_not\":[],\"should\":[]}},\"from\":0,\"size\":10,\"sort\":[],\"facets\":{}}' | json_pp\n  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current\n                                 Dload  Upload   Total   Spent    Left  Speed\n100  1350  100  1202  100   148   3304    406 --:--:-- --:--:-- --:--:--  3311\n{\n   \"_shards\" : {\n      \"total\" : 5,\n      \"successful\" : 5,\n      \"failed\" : 0\n   },\n   \"timed_out\" : false,\n   \"took\" : 361,\n   \"hits\" : {\n      \"total\" : 2,\n      \"max_score\" : 1,\n      \"hits\" : [\n         {\n            \"_index\" : \"appdev-2015.09.29\",\n            \"_score\" : 1,\n            \"_type\" : \"jibeqa\",\n            \"_id\" : \"AVAYqahQZ2RePRz37-kE\",\n            \"_source\" : {\n               \"appId\" : \"imas-dev-10.240.21.82\",\n               \"messageType\" : \"imdn\",\n               \"toUser\" : \"+11000040466\",\n               \"offset\" : \"2390\",\n               \"contributionId\" : \"FACfIAV6DA\",\n               \"@timestamp\" : \"2015-09-29T07:10:50.000Z\",\n               \"user\" : \"+11000040488\",\n               \"type\" : \"jibeqa\",\n               \"@version\" : \"1\",\n               \"date\" : \"2015-09-29T07:10:50+0000\",\n               \"file\" : \"/opt/jibe/jetty_master/reporting_MASTER_local/logs/reporting.log\",\n               \"tags\" : \"appdev\",\n               \"host\" : \"app3-us\",\n               \"category\" : \"IMAS_CHATSESSION_MESSAGE_RECEIVED_121\",\n               \"size\" : 265,\n               \"extras\" : {}\n            }\n         },\n         {\n            \"_score\" : 1,\n            \"_type\" : \"jibeqa\",\n            \"_source\" : {\n               \"file\" : \"/opt/jibe/jetty_master/reporting_MASTER_local/logs/reporting.log\",\n               \"date\" : \"2015-09-29T07:10:50+0000\",\n               \"@version\" : \"1\",\n               \"type\" : \"jibeqa\",\n               \"extras\" : {},\n               \"size\" : 265,\n               \"category\" : \"IMAS_CHATSESSION_MESSAGE_RECEIVED_121\",\n               \"tags\" : \"appdev\",\n               \"host\" : \"app3-us\",\n               \"messageType\" : \"imdn\",\n               \"appId\" : \"imas-dev-10.240.21.82\",\n               \"contributionId\" : \"FACfIAV6DA\",\n               \"@timestamp\" : \"2015-09-29T07:10:50.000Z\",\n               \"user\" : \"+11000040488\",\n               \"offset\" : \"2390\",\n               \"toUser\" : \"+11000040466\"\n            },\n            \"_id\" : \"AVAYqahQZ2RePRz37-kD\",\n            \"_index\" : \"appdev-2015.09.29\"\n         }\n      ]\n   }\n}\n```\n\nThe ID is different but the rest is same.\n\nMy input is:\n\n```\n  lumberjack {\n    port => 5120\n    #type => \"logs\"\n    #tags => \"appdev\"\n    ssl_certificate => \"/etc/pki/tls/certs/logstash-forwarder_appdev.crt\"\n    ssl_key => \"/etc/pki/tls/private/logstash-forwarder_appdev.key\"\n    codec => \"json\"\n  }\n```\n\nFilter is:\n\n```\nfilter {\n  if [type] == \"jibeqa\" {\n    json{\n        source => \"message\"\n    }\n    mutate {\n        remove_field => \"message\"\n    }\n    date {\n      match => [ \"date\", \"ISO8601\"]\n    }\n  }\n}\n```\n\nAnd the output is:\n\n```\noutput {\n  if \"appdev\" in [tags] {\n    elasticsearch { host => localhost protocol => \"http\" cluster => Jibe_ELK index => \"appdev-%{+YYYY.MM.dd}\" workers => 5 }\n  }\n#  stdout { codec => rubydebug }\n}\n```\n\nVersions:\n\n```\nii  elasticsearch                       1.5.2                               all          Open Source, Distributed, RESTful Search Engine\nii  logstash                            1.4.5-1-a2bacae                     all          An extensible logging pipeline\nii  logstash-contrib                    1.4.5-1-2bad350                     all          Community supported plugins for Logstash\n```\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}