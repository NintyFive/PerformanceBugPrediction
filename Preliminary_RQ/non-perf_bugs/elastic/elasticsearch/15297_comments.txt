[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/164750285","html_url":"https://github.com/elastic/elasticsearch/issues/15297#issuecomment-164750285","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297","id":164750285,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NDc1MDI4NQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-15T12:31:22Z","updated_at":"2015-12-15T12:31:51Z","author_association":"CONTRIBUTOR","body":"It is really helpful if you add a recreation that I can just copy and paste.  I've spent about an hour trying to replicate your example, without any luck.  Here's a demonstration of this working correctly:\n\n```\nPUT test\n{\n  \"mappings\": {\n    \"test\": {\n      \"properties\": {\n        \"loc\": {\n          \"type\": \"geo_point\"\n        },\n        \"session\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"location\": {\n              \"type\": \"geo_point\",\n              \"doc_values\": true\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\nPUT test/test/1\n{\n  \"session\": {\n    \"location\": {\n      \"lon\": -118.473667,\n      \"lat\": 34.028449\n    }\n  },\n  \"loc\": {\n    \"lon\": -118.473667,\n    \"lat\": 34.028449\n  }\n}\n\nPUT test/test/2\n{\n  \"session\": {\n    \"location\": {\n      \"lon\": -118.486974,\n      \"lat\": 34.01956\n    }\n  },\n  \"loc\": {\n    \"lon\": -118.486974,\n    \"lat\": 34.01956\n  }\n}\n\nGET /test/test/_search?_source=false\n{\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"nested\": {\n                \"path\": \"session\",\n                \"filter\": {\n                  \"geo_distance\": {\n                    \"distance\": \"1mi\",\n                    \"session.location\": {\n                      \"lon\": -118.486974,\n                      \"lat\": 34.01956\n                    }\n                  }\n                },\n                \"inner_hits\": {\n                  \"sort\": [\n                    {\n                      \"_geo_distance\": {\n                        \"location\": {\n                          \"lon\": -118.486974,\n                          \"lat\": 34.01956\n                        },\n                        \"order\": \"asc\",\n                        \"unit\": \"mi\"\n                      }\n                    }\n                  ]\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"sort\": [\n    {\n      \"_geo_distance\": {\n        \"loc\": {\n          \"lon\": -118.486974,\n          \"lat\": 34.01956\n        },\n        \"order\": \"asc\",\n        \"unit\": \"mi\"\n      }\n    },\n    {\n      \"_script\": {\n        \"lang\": \"groovy\",\n        \"script\": \"doc['loc'].arcDistanceInMiles(34.01956, -118.486974)\",\n        \"type\": \"number\",\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nYou will see that all geo sort values (nested, top-level, groovy) are the same.  Tested on 1.5.1 and 1.7.3.  note: I had to change the nested sort field from `session.location` to just `location`, otherwise it didn't find the field.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/164940742","html_url":"https://github.com/elastic/elasticsearch/issues/15297#issuecomment-164940742","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297","id":164940742,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NDk0MDc0Mg==","user":{"login":"sudhanne","id":12982069,"node_id":"MDQ6VXNlcjEyOTgyMDY5","avatar_url":"https://avatars1.githubusercontent.com/u/12982069?v=4","gravatar_id":"","url":"https://api.github.com/users/sudhanne","html_url":"https://github.com/sudhanne","followers_url":"https://api.github.com/users/sudhanne/followers","following_url":"https://api.github.com/users/sudhanne/following{/other_user}","gists_url":"https://api.github.com/users/sudhanne/gists{/gist_id}","starred_url":"https://api.github.com/users/sudhanne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sudhanne/subscriptions","organizations_url":"https://api.github.com/users/sudhanne/orgs","repos_url":"https://api.github.com/users/sudhanne/repos","events_url":"https://api.github.com/users/sudhanne/events{/privacy}","received_events_url":"https://api.github.com/users/sudhanne/received_events","type":"User","site_admin":false},"created_at":"2015-12-16T00:05:10Z","updated_at":"2015-12-16T00:05:10Z","author_association":"NONE","body":"Hi Clinton,\n\nTry this:\n\n``` javascript\nPUT test1\n{\n  \"mappings\": {\n    \"test\": {\n      \"properties\": {\n        \"id\": {\n          \"type\": \"integer\"\n        },\n        \"session\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"location\": {\n              \"type\": \"geo_point\",\n              \"doc_values\": true\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\n``` javascript\nPUT test1/test/1\n{\n   \"id\": 1,\n   \"session\": {\n      \"location\": {\n         \"lon\": -118.486974,\n         \"lat\": 34.01956\n      }\n   }\n}\n```\n\n``` javascript\nPUT test1/test/2\n{\n   \"id\": 2,\n   \"session\": {\n      \"location\": {\n         \"lon\": -118.486974,\n         \"lat\": 34.02956\n      }\n   }\n}\n```\n\n``` javascript\nGET /test1/test/_search\n{\n   \"query\": {\n      \"filtered\": {\n         \"filter\": {\n            \"bool\": {\n               \"must\": [\n                  {\n                     \"nested\": {\n                        \"path\": \"session\",\n                        \"filter\": {\n                           \"geo_distance\": {\n                              \"distance\": \"1mi\",\n                              \"location\": {\n                                 \"lon\": -118.486974,\n                                 \"lat\": 34.01956\n                              }\n                           }\n                        },\n                        \"inner_hits\": {\n                           \"size\": 1000,\n                           \"sort\": [\n                              {\n                                  \"_script\": {\n                                    \"lang\": \"groovy\",\n                                    \"script\": \"doc['session.location'].arcDistanceInMiles(34.01956, -118.486974)\",\n                                    \"type\": \"number\",\n                                    \"order\": \"asc\"\n                                  }                                  \n                              },\n                              {\n                                 \"_geo_distance\": {\n                                    \"session.location\": {\n                                       \"lon\": -118.486974,\n                                       \"lat\": 34.01956\n                                    },\n                                    \"order\": \"asc\",\n                                    \"unit\": \"mi\"\n                                 }\n                              }\n                           ]\n                        }\n                     }\n                  }\n               ]\n            }\n         }\n      }\n   }\n}\n```\n\n``` javascript\n{\n   \"took\": 1,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 1,\n      \"successful\": 1,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 2,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"test1\",\n            \"_type\": \"test\",\n            \"_id\": \"1\",\n            \"_score\": 1,\n            \"_source\": {\n               \"id\": 1,\n               \"session\": {\n                  \"location\": {\n                     \"lon\": -118.486974,\n                     \"lat\": 34.01956\n                  }\n               }\n            },\n            \"inner_hits\": {\n               \"session\": {\n                  \"hits\": {\n                     \"total\": 1,\n                     \"max_score\": null,\n                     \"hits\": [\n                        {\n                           \"_index\": \"test1\",\n                           \"_type\": \"test\",\n                           \"_id\": \"1\",\n                           \"_nested\": {\n                              \"field\": \"session\",\n                              \"offset\": 0\n                           },\n                           \"_score\": null,\n                           \"_source\": {\n                              \"location\": {\n                                 \"lon\": -118.486974,\n                                 \"lat\": 34.01956\n                              }\n                           },\n                           \"sort\": [\n                              0,\n                              1.7976931348623157e+308\n                           ]\n                        }\n                     ]\n                  }\n               }\n            }\n         },\n         {\n            \"_index\": \"test1\",\n            \"_type\": \"test\",\n            \"_id\": \"2\",\n            \"_score\": 1,\n            \"_source\": {\n               \"id\": 2,\n               \"session\": {\n                  \"location\": {\n                     \"lon\": -118.486974,\n                     \"lat\": 34.02956\n                  }\n               }\n            },\n            \"inner_hits\": {\n               \"session\": {\n                  \"hits\": {\n                     \"total\": 1,\n                     \"max_score\": null,\n                     \"hits\": [\n                        {\n                           \"_index\": \"test1\",\n                           \"_type\": \"test\",\n                           \"_id\": \"2\",\n                           \"_nested\": {\n                              \"field\": \"session\",\n                              \"offset\": 0\n                           },\n                           \"_score\": null,\n                           \"_source\": {\n                              \"location\": {\n                                 \"lon\": -118.486974,\n                                 \"lat\": 34.02956\n                              }\n                           },\n                           \"sort\": [\n                              0.6909863387230968,\n                              1.7976931348623157e+308\n                           ]\n                        }\n                     ]\n                  }\n               }\n            }\n         }\n      ]\n   }\n}\n```\n\nNotice that the inner hit sorting by geolocation does not appear to work properly unless I use custom Groovy script.  Thanks.\n\n-Sudheer\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/165075625","html_url":"https://github.com/elastic/elasticsearch/issues/15297#issuecomment-165075625","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15297","id":165075625,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NTA3NTYyNQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-16T11:33:40Z","updated_at":"2015-12-16T11:33:40Z","author_association":"CONTRIBUTOR","body":"@sudhanne Did you see this line in my previous comment?\n\n> note: I had to change the nested sort field from `session.location` to just `location`, otherwise it didn't find the field.\n\nIn 2.0, you should use `session.location` in the geodistance sort, but in 1.x, you leave out the nested path.\n","performed_via_github_app":null}]