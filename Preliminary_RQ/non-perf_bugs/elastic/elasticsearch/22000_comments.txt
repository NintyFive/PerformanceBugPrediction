[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265233712","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265233712","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265233712,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTIzMzcxMg==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T18:38:26Z","updated_at":"2016-12-06T18:38:26Z","author_association":"CONTRIBUTOR","body":"When retrieving the snapshot status, that action looks in the cluster state and retrieves the current snapshots.  So its very strange that the snapshot status is showing an `IN_PROGRESS` snapshot, whereas the cluster state is showing the snapshot as `ABORTED`.  Did you get the cluster state from the non-master node? (i.e. did you run `/_cluster/state?local=true`).  Also, I'm assuming you retrieved the cluster state and the snapshot status _after_ the rolling restart had completed?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265238920","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265238920","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265238920,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTIzODkyMA==","user":{"login":"desagar","id":18707115,"node_id":"MDQ6VXNlcjE4NzA3MTE1","avatar_url":"https://avatars3.githubusercontent.com/u/18707115?v=4","gravatar_id":"","url":"https://api.github.com/users/desagar","html_url":"https://github.com/desagar","followers_url":"https://api.github.com/users/desagar/followers","following_url":"https://api.github.com/users/desagar/following{/other_user}","gists_url":"https://api.github.com/users/desagar/gists{/gist_id}","starred_url":"https://api.github.com/users/desagar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/desagar/subscriptions","organizations_url":"https://api.github.com/users/desagar/orgs","repos_url":"https://api.github.com/users/desagar/repos","events_url":"https://api.github.com/users/desagar/events{/privacy}","received_events_url":"https://api.github.com/users/desagar/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T18:57:15Z","updated_at":"2016-12-06T18:57:15Z","author_association":"NONE","body":"I retrieved both cluster state and snapshot status after the rolling restart fully completed and the cluster health was back to green. \r\nI unfortunately can't remember which node I got the cluster state from, but I did not use local=true. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265268283","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265268283","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265268283,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTI2ODI4Mw==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T20:51:10Z","updated_at":"2016-12-06T20:51:10Z","author_association":"CONTRIBUTOR","body":"If you didn't use `local=true`, then it would've retrieved the cluster state from the master node.\r\n\r\nDid you explicitly try deleting the snapshot before (or after) the rolling restart? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265276607","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265276607","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265276607,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTI3NjYwNw==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T21:23:22Z","updated_at":"2016-12-06T21:23:22Z","author_association":"CONTRIBUTOR","body":"@desagar BTW, you inadvertently pasted us the entire cluster state which included your repository credentials.  I removed the link from the ticket, but you should also update your security settings immediately so as to not have your repository account compromised.  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265280486","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265280486","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265280486,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTI4MDQ4Ng==","user":{"login":"desagar","id":18707115,"node_id":"MDQ6VXNlcjE4NzA3MTE1","avatar_url":"https://avatars3.githubusercontent.com/u/18707115?v=4","gravatar_id":"","url":"https://api.github.com/users/desagar","html_url":"https://github.com/desagar","followers_url":"https://api.github.com/users/desagar/followers","following_url":"https://api.github.com/users/desagar/following{/other_user}","gists_url":"https://api.github.com/users/desagar/gists{/gist_id}","starred_url":"https://api.github.com/users/desagar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/desagar/subscriptions","organizations_url":"https://api.github.com/users/desagar/orgs","repos_url":"https://api.github.com/users/desagar/repos","events_url":"https://api.github.com/users/desagar/events{/privacy}","received_events_url":"https://api.github.com/users/desagar/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T21:37:54Z","updated_at":"2016-12-06T21:37:54Z","author_association":"NONE","body":"Thank you for removing the link. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265283295","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265283295","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265283295,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTI4MzI5NQ==","user":{"login":"desagar","id":18707115,"node_id":"MDQ6VXNlcjE4NzA3MTE1","avatar_url":"https://avatars3.githubusercontent.com/u/18707115?v=4","gravatar_id":"","url":"https://api.github.com/users/desagar","html_url":"https://github.com/desagar","followers_url":"https://api.github.com/users/desagar/followers","following_url":"https://api.github.com/users/desagar/following{/other_user}","gists_url":"https://api.github.com/users/desagar/gists{/gist_id}","starred_url":"https://api.github.com/users/desagar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/desagar/subscriptions","organizations_url":"https://api.github.com/users/desagar/orgs","repos_url":"https://api.github.com/users/desagar/repos","events_url":"https://api.github.com/users/desagar/events{/privacy}","received_events_url":"https://api.github.com/users/desagar/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T21:48:37Z","updated_at":"2016-12-06T21:48:37Z","author_association":"NONE","body":"I attempted deleting the snapshot prior to the restart, and at that point it was just hanging. That could possibly have been due to the bug in the plugin - I did not take a thread dump at that point so I am unsure.\r\n\r\nI just attempted deleting it again after the restart, and the delete fails with since the snapshot is not fully written to the repository.  However, the delete apparently removed the aborted snapshot, and it is no longer present in the cluster state output. Snapshot status reports that the snapshot is missing.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/265306590","html_url":"https://github.com/elastic/elasticsearch/issues/22000#issuecomment-265306590","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22000","id":265306590,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NTMwNjU5MA==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-12-06T23:27:33Z","updated_at":"2016-12-06T23:27:33Z","author_association":"CONTRIBUTOR","body":"You should be able to take snapshots now, correct?  \r\n\r\nI believe I know what is happening.  When you issued a delete snapshot request, the master node marked the snapshot as `ABORTED` in the cluster state, and propagated this cluster state to the other node so that each node can abort individual snapshots running on their respective node.  Because your plugin was in a stuck state, no reads of snapshot data were taking place, so the abort never kicked in (the abort kicks in on the input stream) to fail the shard.  So, your snapshot remained in this `ABORTED` state, without progressing to the `FAILED` state whereby the snapshot could be removed from the cluster state.  \r\n\r\nIn this case, the full cluster restart is your main option.  We opened https://github.com/elastic/elasticsearch/issues/21759 to look at better options for aborting, and once that is completed, situations like the one you encountered would be properly handled.\r\n\r\nI'm closing this for now.  If you encounter other issues, please feel free to reopen.  Thank you for reporting this!","performed_via_github_app":null}]