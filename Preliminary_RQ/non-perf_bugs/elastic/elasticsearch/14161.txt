{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14161","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14161/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14161/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14161/events","html_url":"https://github.com/elastic/elasticsearch/issues/14161","id":111845979,"node_id":"MDU6SXNzdWUxMTE4NDU5Nzk=","number":14161,"title":"no buckets returned by terms aggregation on raw field","user":{"login":"cwithers","id":15158908,"node_id":"MDQ6VXNlcjE1MTU4OTA4","avatar_url":"https://avatars3.githubusercontent.com/u/15158908?v=4","gravatar_id":"","url":"https://api.github.com/users/cwithers","html_url":"https://github.com/cwithers","followers_url":"https://api.github.com/users/cwithers/followers","following_url":"https://api.github.com/users/cwithers/following{/other_user}","gists_url":"https://api.github.com/users/cwithers/gists{/gist_id}","starred_url":"https://api.github.com/users/cwithers/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cwithers/subscriptions","organizations_url":"https://api.github.com/users/cwithers/orgs","repos_url":"https://api.github.com/users/cwithers/repos","events_url":"https://api.github.com/users/cwithers/events{/privacy}","received_events_url":"https://api.github.com/users/cwithers/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":12,"created_at":"2015-10-16T14:42:19Z","updated_at":"2015-10-16T17:02:23Z","closed_at":"2015-10-16T15:43:52Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nI'm getting strange behaviour with a terms aggregation. In the example below, the terms aggregation based on the \"fruit\" field returns 3 buckets but the aggregation on the \"fruit.raw\" field returns 0 buckets. I've also tried \"fruit.fruit.raw\", which returns 3 buckets, as expected.\n\nAm I doing something subtly wrong?\n\nMany Thanks,\nChris\n\nHere is my mapping:\n\n``` json\n{\n    \"my__fruit__1445001899868\" : {\n        \"mappings\" : {\n            \"fruit\" : {\n                \"dynamic\" : \"strict\",\n                \"properties\" : {\n                    \"color\" : {\n                        \"type\" : \"string\",\n                        \"fields\" : {\n                            \"raw\" : {\n                                \"type\" : \"string\",\n                                \"index\" : \"not_analyzed\"\n                            }\n                        }\n                    },\n                    \"fruit\" : {\n                        \"type\" : \"string\",\n                        \"fields\" : {\n                            \"raw\" : {\n                                \"type\" : \"string\",\n                                \"index\" : \"not_analyzed\"\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nHere is my data:\n\n``` json\n{\"index\": {\"_index\": \"my__fruit__1445001899868\", \"_type\" : \"fruit\", \"_id\" : \"2GjU4Yf3R323B9enVSbFuQ\"}}\n{\"fruit\":\"banana\", \"color\":\"yellow\"}\n{\"index\": {\"_index\" : \"my__fruit__1445001899868\", \"_type\" : \"fruit\", \"_id\" : \"mnCDZBNbQ2GgX0JnTIaMxg\"}}\n{\"fruit\":\"apple\", \"color\":\"green\"}\n{\"index\": {\"_index\" : \"sand__fruit__1445001899868\", \"_type\" : \"fruit\", \"_id\" : \"kXlD__CvTk21cicCTncLCQ\"}}\n{\"fruit\":\"mango\", \"color\":\"green\"}\n```\n\nHere is the working request and response:\n\n``` json\n{\n    \"query\" : {\n        \"match_all\" : {}\n    },\n    \"from\" : 0,\n    \"size\" : 0,\n    \"aggs\" : {\n        \"fruit\" : {\n            \"terms\" : {\n                \"field\" : \"fruit\"\n            }\n        },\n        \"color\" : {\n            \"terms\" : {\n                \"field\" : \"color\"\n            }\n        }\n    }\n}\n```\n\n``` json\n{\n  \"took\" : 5,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 3,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"color\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"green\",\n        \"doc_count\" : 2\n      }, {\n        \"key\" : \"yellow\",\n        \"doc_count\" : 1\n      } ]\n    },\n    \"fruit\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"apple\",\n        \"doc_count\" : 1\n      }, {\n        \"key\" : \"banana\",\n        \"doc_count\" : 1\n      }, {\n        \"key\" : \"mango\",\n        \"doc_count\" : 1\n      } ]\n    }\n  }\n}\n```\n\nHere is the failing request and response:\n\n``` json\n{\n    \"query\" : {\n        \"match_all\" : {}\n    },\n    \"from\" : 0,\n    \"size\" : 0,\n    \"aggs\" : {\n        \"fruit\" : {\n            \"terms\" : {\n                \"field\" : \"fruit.raw\"\n            }\n        },\n        \"color\" : {\n            \"terms\" : {\n                \"field\" : \"color.raw\"\n            }\n        }\n    }\n}\n```\n\n``` json\n{\n  \"took\" : 2,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 3,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"color\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"green\",\n        \"doc_count\" : 2\n      }, {\n        \"key\" : \"yellow\",\n        \"doc_count\" : 1\n      } ]\n    },\n    \"fruit\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ ]\n    }\n  }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}