{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9979","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9979/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9979/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9979/events","html_url":"https://github.com/elastic/elasticsearch/issues/9979","id":59802892,"node_id":"MDU6SXNzdWU1OTgwMjg5Mg==","number":9979,"title":"Sum Aggregation On Nested Doc Not Handling Negative Numbers","user":{"login":"natenash203","id":1540527,"node_id":"MDQ6VXNlcjE1NDA1Mjc=","avatar_url":"https://avatars3.githubusercontent.com/u/1540527?v=4","gravatar_id":"","url":"https://api.github.com/users/natenash203","html_url":"https://github.com/natenash203","followers_url":"https://api.github.com/users/natenash203/followers","following_url":"https://api.github.com/users/natenash203/following{/other_user}","gists_url":"https://api.github.com/users/natenash203/gists{/gist_id}","starred_url":"https://api.github.com/users/natenash203/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/natenash203/subscriptions","organizations_url":"https://api.github.com/users/natenash203/orgs","repos_url":"https://api.github.com/users/natenash203/repos","events_url":"https://api.github.com/users/natenash203/events{/privacy}","received_events_url":"https://api.github.com/users/natenash203/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2015-03-04T14:15:42Z","updated_at":"2015-03-16T21:14:18Z","closed_at":"2015-03-16T16:26:36Z","author_association":"NONE","active_lock_reason":null,"body":"I have a an index with 30M documents, spread across 4 nodes, 30 shards, with 2 replicas each. Each document has a nested mapping type \"a\", representing a transaction log entry. Each transaction log entry has a positive or negative dollar value and a timestamp. When I attempt to bucket the nested objects using the date range and sum aggregations, the sum aggregation appears to break on transactions with both positive and negative numbers.\n\nFor example, consider the following query. I include a reverse nested agg to show that the nested objects are different than the output of the sum agg.\n\n``` JSON\n{\n    \"size\": 0,\n    \"query\": {\n        \"filtered\": {\n            \"query\": {\n                \"match_all\": {}\n            },\n            \"filter\": {\n                \"bool\": {\n                    \"must\": [\n                        {\n                            \"range\": {\n                                \"timestamp\": {\n                                    \"gte\": \"2011-10-01\"\n                                }\n                            }\n                        },\n                        {\n                            \"term\": {\n                                \"bar.name\": \"ASpecialName\"\n                            }\n                        }\n                    ]\n                }\n            }\n        }\n    },\n    \"aggs\": {\n        \"BAR\": {\n            \"terms\": {\n                \"field\": \"bar.name\",\n                \"size\": 2,\n                \"order\": {\n                    \"NESTED>TOTAL\": \"asc\"\n                }\n            },\n            \"aggs\": {\n                \"NESTED\": {\n                    \"nested\": {\n                        \"path\": \"a\"\n                    },\n                    \"aggs\": {\n                        \"TOTAL\": {\n                            \"sum\": {\n                                \"field\": \"a.obligatedamount\"\n                            }\n                        },\n                        \"DATES\": {\n                            \"date_range\": {\n                                \"field\": \"a.signeddate\",\n                                \"keyed\": true,\n                                \"ranges\": [\n                                    {\n                                        \"key\": \"FY2012\",\n                                        \"from\": \"2011-10-01\",\n                                        \"to\": \"2012-09-30\"\n                                    },\n                                    {\n                                        \"key\": \"FY2013\",\n                                        \"from\": \"2012-10-01\",\n                                        \"to\": \"2013-09-30\"\n                                    },\n                                    {\n                                        \"key\": \"FY2014\",\n                                        \"from\": \"2013-10-01\",\n                                        \"to\": \"2014-09-30\"\n                                    },\n                                    {\n                                        \"key\": \"FY2015\",\n                                        \"from\": \"2014-10-01\",\n                                        \"to\": \"2015-09-30\"\n                                    }\n                                ]\n                            },\n                            \"aggs\": {\n                                \"DATEBUCKET_SUBTOTAL\": {\n                                    \"sum\": {\n                                        \"field\": \"a.obligatedamount\"\n                                    }\n                                },\n                                \"HITS_REVERSE\": {\n                                    \"reverse_nested\": {},\n                                    \"aggs\": {\n                                        \"HITS\": {\n                                            \"top_hits\": {\n                                                \"_source\": {\n                                                    \"include\": [\n                                                        \"a.obligatedamount\",\n                                                        \"a.signeddate\"\n                                                    ]\n                                                }\n                                            }\n                                        }\n                                    }\n                                }\n                            }\n                        }\n                    }\n                }\n            }\n        }\n    }\n}\n```\n\nThe following result is returned. Note the odd number in the DATEBUCKET_SUBTOTAL in FY2012 for \"ASpecialPlace\". This appears to only be an issue when the transaction log contains both negative and positive numbers. (Response slightly truncated...)\n\n``` JSON\n{\n    \"aggregations\": {\n        \"BAR\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n                {\n                    \"key\": \"ASpecialPlace\",\n                    \"doc_count\": 2,\n                    \"NESTED\": {\n                        \"doc_count\": 3,\n                        \"DATES\": {\n                            \"buckets\": {\n                                \"FY2012\": {\n                                    \"from_as_string\": \"2011-10-01T00:00:00.000Z\",\n                                    \"to_as_string\": \"2012-09-30T00:00:00.000Z\",\n                                    \"doc_count\": 1,\n                                    \"HITS_REVERSE\": {\n                                        \"doc_count\": 1,\n                                        \"HITS\": {\n                                            \"hits\": {\n                                                \"total\": 1,\n                                                \"max_score\": 1,\n                                                \"hits\": [\n                                                    {\n                                                        \"_index\": \"myIndex\",\n                                                        \"_type\": \"myType\",\n                                                        \"_id\": \"AG9J61P110025\",\n                                                        \"_score\": 1,\n                                                        \"_source\": {\n                                                            \"a\": [\n                                                                {\n                                                                    \"signeddate\": \"2011-02-01T00:00:00+0000\",\n                                                                    \"obligatedamount\": 4000\n                                                                },\n                                                                {\n                                                                    \"signeddate\": \"2012-07-11T00:00:00+0000\",\n                                                                    \"obligatedamount\": -1694\n                                                                }\n                                                            ]\n                                                        }\n                                                    }\n                                                ]\n                                            }\n                                        }\n                                    },\n                                    \"DATEBUCKET_SUBTOTAL\": {\n                                        \"value\": -8.365e-321\n                                    }\n                                },\n                                \"FY2013\": {\n                                    \"from_as_string\": \"2012-10-01T00:00:00.000Z\",\n                                    \"to\": 1380499200000,\n                                    \"doc_count\": 0,\n                                    \"HITS_REVERSE\": {\n                                        \"doc_count\": 0,\n                                        \"HITS\": {\n                                            \"hits\": {\n                                                \"total\": 0,\n                                                \"max_score\": null,\n                                                \"hits\": []\n                                            }\n                                        }\n                                    },\n                                    \"DATEBUCKET_SUBTOTAL\": {\n                                        \"value\": 0\n                                    }\n                                },\n                                \"FY2014\": {\n                                    \"from_as_string\": \"2013-10-01T00:00:00.000Z\",\n                                    \"to_as_string\": \"2014-09-30T00:00:00.000Z\",\n                                    \"doc_count\": 1,\n                                    \"HITS_REVERSE\": {\n                                        \"doc_count\": 1,\n                                        \"HITS\": {\n                                            \"hits\": {\n                                                \"total\": 1,\n                                                \"max_score\": 1,\n                                                \"hits\": [\n                                                    {\n                                                        \"_index\": \"myIndex\",\n                                                        \"_type\": \"myType\",\n                                                        \"_id\": \"AG04GGP140011\",\n                                                        \"_score\": 1,\n                                                        \"_source\": {\n                                                            \"a\": [\n                                                                {\n                                                                    \"signeddate\": \"2013-12-19T00:00:00+0000\",\n                                                                    \"obligatedamount\": 3449\n                                                                }\n                                                            ]\n                                                        }\n                                                    }\n                                                ]\n                                            }\n                                        }\n                                    },\n                                    \"DATEBUCKET_SUBTOTAL\": {\n                                        \"value\": 3449\n                                    }\n                                },\n                                \"FY2015\": {\n                                    \"from_as_string\": \"2014-10-01T00:00:00.000Z\",\n                                    \"to_as_string\": \"2015-09-30T00:00:00.000Z\",\n                                    \"doc_count\": 0,\n                                    \"HITS_REVERSE\": {\n                                        \"doc_count\": 0,\n                                        \"HITS\": {\n                                            \"hits\": {\n                                                \"total\": 0,\n                                                \"max_score\": null,\n                                                \"hits\": []\n                                            }\n                                        }\n                                    },\n                                    \"DATEBUCKET_SUBTOTAL\": {\n                                        \"value\": 0\n                                    }\n                                }\n                            }\n                        },\n                        \"TOTAL\": {\n                            \"value\": 3449\n                        }\n                    }\n                }\n            ]\n        }\n    }\n}\n```\n\nIf I set a filter at the nested level to remove any nested \"a\" objects with a negative value, everything works fine. Note, this behavior is also apparent if using a stats agg instead of just a sum.  \n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}