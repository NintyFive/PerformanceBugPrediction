{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53171","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53171/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53171/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53171/events","html_url":"https://github.com/elastic/elasticsearch/issues/53171","id":576312954,"node_id":"MDU6SXNzdWU1NzYzMTI5NTQ=","number":53171,"title":"RemoteTransportException caused by NullPointerException when trying to create snapshot through Kibana UI","user":{"login":"bcbrockway","id":6728173,"node_id":"MDQ6VXNlcjY3MjgxNzM=","avatar_url":"https://avatars2.githubusercontent.com/u/6728173?v=4","gravatar_id":"","url":"https://api.github.com/users/bcbrockway","html_url":"https://github.com/bcbrockway","followers_url":"https://api.github.com/users/bcbrockway/followers","following_url":"https://api.github.com/users/bcbrockway/following{/other_user}","gists_url":"https://api.github.com/users/bcbrockway/gists{/gist_id}","starred_url":"https://api.github.com/users/bcbrockway/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bcbrockway/subscriptions","organizations_url":"https://api.github.com/users/bcbrockway/orgs","repos_url":"https://api.github.com/users/bcbrockway/repos","events_url":"https://api.github.com/users/bcbrockway/events{/privacy}","received_events_url":"https://api.github.com/users/bcbrockway/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1619315113,"node_id":"MDU6TGFiZWwxNjE5MzE1MTEz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.6.0","name":"v7.6.0","color":"DDDDDD","default":false,"description":""},{"id":1789304462,"node_id":"MDU6TGFiZWwxNzg5MzA0NDYy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.7.0","name":"v7.7.0","color":"dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-03-05T14:56:42Z","updated_at":"2020-03-10T18:36:24Z","closed_at":"2020-03-10T18:36:24Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 7.5.2\r\n\r\n**Plugins installed**:\r\n\r\n* repository-gcs\r\n* repository-s3\r\n\r\n**JVM version**: openjdk 13.0.1 2019-10-15\r\n\r\n**OS version**: Linux portal-elastic-es-main-0 4.14.138+ #1 SMP Tue Sep 3 02:58:08 PDT 2019 x86_64 x86_64 x86_64 GNU/Linux (official docker container - docker.elastic.co/elasticsearch/elasticsearch:7.5.2)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIf you create a Snapshot Lifecycle Policy through the API without specifying a `config` block and then try to click the \"Run now\" button in the Kibana UI, the operation will fail and the following exceptions will be shown in the elasticsearch/kibana logs:\r\n\r\n```\r\nportal-elastic-es-main-0 elasticsearch {\"type\": \"server\", \"timestamp\": \"2020-03-05T12:23:14,224Z\", \"level\": \"WARN\", \"component\": \"r.suppressed\", \"cluster.name\": \"portal-elastic\", \"node.name\": \"portal-elastic-es-main-0\", \"message\": \"path: /_slm/policy/daily/_execute, params: {name=daily}\", \"cluster.uuid\": \"AY3K33D1TZ6NeQ_tsYLfmA\", \"node.id\": \"DKHkJG7HQBS8KisfmfxAdg\" , \r\nportal-elastic-es-main-0 elasticsearch \"stacktrace\": [\"org.elasticsearch.transport.RemoteTransportException: [portal-elastic-es-main-2][10.52.4.33:9300][cluster:admin/slm/execute]\",\r\nportal-elastic-es-main-0 elasticsearch \"Caused by: java.lang.NullPointerException\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.xpack.core.slm.SnapshotLifecyclePolicy.toRequest(SnapshotLifecyclePolicy.java:258) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.xpack.slm.SnapshotLifecycleTask.lambda$maybeTakeSnapshot$1(SnapshotLifecycleTask.java:86) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at java.util.Optional.map(Optional.java:258) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.xpack.slm.SnapshotLifecycleTask.maybeTakeSnapshot(SnapshotLifecycleTask.java:85) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.xpack.slm.action.TransportExecuteSnapshotLifecycleAction.masterOperation(TransportExecuteSnapshotLifecycleAction.java:80) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.xpack.slm.action.TransportExecuteSnapshotLifecycleAction.masterOperation(TransportExecuteSnapshotLifecycleAction.java:35) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:98) ~[elasticsearch-7.5.2.jar:7.5.2]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.lambda$doStart$3(TransportMasterNodeAction.java:169) ~[elasticsearch-7.5.2.jar:7.5.2]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73) ~[elasticsearch-7.5.2.jar:7.5.2]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:773) ~[elasticsearch-7.5.2.jar:7.5.2]\",\r\nportal-elastic-es-main-0 elasticsearch \"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-7.5.2.jar:7.5.2]\",\r\nportal-elastic-es-main-0 elasticsearch \"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\",\r\nportal-elastic-es-main-0 elasticsearch \"at java.lang.Thread.run(Thread.java:830) [?:?]\"] }\r\n\r\nportal-elastic-kb-75cb599c99-72f5h kibana {\"type\":\"error\",\"@timestamp\":\"2020-03-05T12:23:14Z\",\"tags\":[],\"pid\":6,\"level\":\"error\",\"error\":{\"message\":\"[remote_transport_exception] [portal-elastic-es-main-2][10.52.4.33:9300][cluster:admin/slm/execute]\",\"name\":\"Error\",\"stack\":\"Error: [remote_transport_exception] [portal-elastic-es-main-2][10.52.4.33:9300][cluster:admin/slm/execute]\\n    at respond (/usr/share/kibana/node_modules/elasticsearch/src/lib/transport.js:349:15)\\n    at checkRespForFailure (/usr/share/kibana/node_modules/elasticsearch/src/lib/transport.js:306:7)\\n    at HttpConnector.<anonymous> (/usr/share/kibana/node_modules/elasticsearch/src/lib/connectors/http.js:173:7)\\n    at IncomingMessage.wrapper (/usr/share/kibana/node_modules/elasticsearch/node_modules/lodash/lodash.js:4929:19)\\n    at IncomingMessage.emit (events.js:194:15)\\n    at endReadableNT (_stream_readable.js:1103:12)\\n    at process._tickCallback (internal/process/next_tick.js:63:19)\"},\"url\":{\"protocol\":null,\"slashes\":null,\"auth\":null,\"host\":null,\"port\":null,\"hostname\":null,\"hash\":null,\"search\":null,\"query\":{},\"pathname\":\"/api/snapshot_restore/policy/daily/run\",\"path\":\"/api/snapshot_restore/policy/daily/run\",\"href\":\"/api/snapshot_restore/policy/daily/run\"},\"message\":\"[remote_transport_exception] [portal-elastic-es-main-2][10.52.4.33:9300][cluster:admin/slm/execute]\"}\r\n```\r\n\r\nThe PUT operation should either fail or, preferably, add an empty `\"config\": { }` block to the created policy.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Set up basic Kibana / Elasticsearch nodes with `path.repo` in the latter's settings.\r\n2. Set up your backup location:\r\n```\r\ncurl -X PUT \"localhost:9200/_snapshot/my_backup?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"type\": \"fs\",\r\n  \"settings\": {\r\n    \"location\": \"my_backup_location\"\r\n  }\r\n}\r\n'\r\n```\r\n3. Set up your ILM policy without a config block:\r\n```\r\ncurl -X PUT \"localhost:9200/_slm/policy/nightly-snapshots?pretty\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"schedule\": \"0 30 1 * * ?\",\r\n  \"name\": \"<nightly-snap-{now/d}>\",\r\n  \"repository\": \"my_backup\",    \r\n  \"retention\": {\r\n    \"expire_after\": \"30d\",\r\n    \"min_count\": 5,\r\n    \"max_count\": 50\r\n  }\r\n}\r\n'\r\n```\r\n4. Open the Kibana UI, go to `Management > Elasticsearch > Snapshot and Restore > Policies` and click the \"Run now\" button. The operation will fail.","closed_by":{"login":"probakowski","id":3896475,"node_id":"MDQ6VXNlcjM4OTY0NzU=","avatar_url":"https://avatars1.githubusercontent.com/u/3896475?v=4","gravatar_id":"","url":"https://api.github.com/users/probakowski","html_url":"https://github.com/probakowski","followers_url":"https://api.github.com/users/probakowski/followers","following_url":"https://api.github.com/users/probakowski/following{/other_user}","gists_url":"https://api.github.com/users/probakowski/gists{/gist_id}","starred_url":"https://api.github.com/users/probakowski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/probakowski/subscriptions","organizations_url":"https://api.github.com/users/probakowski/orgs","repos_url":"https://api.github.com/users/probakowski/repos","events_url":"https://api.github.com/users/probakowski/events{/privacy}","received_events_url":"https://api.github.com/users/probakowski/received_events","type":"User","site_admin":false},"performed_via_github_app":null}