[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62306699","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62306699","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62306699,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMzA2Njk5","user":{"login":"avleen","id":539525,"node_id":"MDQ6VXNlcjUzOTUyNQ==","avatar_url":"https://avatars1.githubusercontent.com/u/539525?v=4","gravatar_id":"","url":"https://api.github.com/users/avleen","html_url":"https://github.com/avleen","followers_url":"https://api.github.com/users/avleen/followers","following_url":"https://api.github.com/users/avleen/following{/other_user}","gists_url":"https://api.github.com/users/avleen/gists{/gist_id}","starred_url":"https://api.github.com/users/avleen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avleen/subscriptions","organizations_url":"https://api.github.com/users/avleen/orgs","repos_url":"https://api.github.com/users/avleen/repos","events_url":"https://api.github.com/users/avleen/events{/privacy}","received_events_url":"https://api.github.com/users/avleen/received_events","type":"User","site_admin":false},"created_at":"2014-11-09T15:21:13Z","updated_at":"2014-11-09T15:21:13Z","author_association":"NONE","body":"This is on Elasticsearch 1.3.2.\nIf this is repeatable for others, any chance the fix could make it into 1.4? It's brought our cluster down repeatedly in the last 2 weeks and I can reproduce it here easily.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62364882","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62364882","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62364882,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMzY0ODgy","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-11-10T10:16:46Z","updated_at":"2014-11-10T10:16:46Z","author_association":"CONTRIBUTOR","body":"@avleen This looks wrong indeed. I just tried to reproduce the issue with no success, can you please help me understand a bit more what happens:\n- do you actually get a doc_count for every term in the response or did you infer that it ran on all docs because of CPU or I/O activity?\n- can you confirm you are not setting [min_doc_count](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_minimum_document_count) to `0`? (this option combined with the `map` execution hint could make elasticsearch search the whole index).\n- if you can still reproduce this issue, could you try to capture the output of the [hot threads](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/cluster-nodes-hot-threads.html) while the query is running so that I can see what is calling the aggregation.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62424669","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62424669","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62424669,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDI0NjY5","user":{"login":"avleen","id":539525,"node_id":"MDQ6VXNlcjUzOTUyNQ==","avatar_url":"https://avatars1.githubusercontent.com/u/539525?v=4","gravatar_id":"","url":"https://api.github.com/users/avleen","html_url":"https://github.com/avleen","followers_url":"https://api.github.com/users/avleen/followers","following_url":"https://api.github.com/users/avleen/following{/other_user}","gists_url":"https://api.github.com/users/avleen/gists{/gist_id}","starred_url":"https://api.github.com/users/avleen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avleen/subscriptions","organizations_url":"https://api.github.com/users/avleen/orgs","repos_url":"https://api.github.com/users/avleen/repos","events_url":"https://api.github.com/users/avleen/events{/privacy}","received_events_url":"https://api.github.com/users/avleen/received_events","type":"User","site_admin":false},"created_at":"2014-11-10T17:54:33Z","updated_at":"2014-11-10T17:54:33Z","author_association":"NONE","body":"Hi @jpountz \nHere're the results from the query when searching over 2 days of indices, and running the agg on a field with very low cardinality (maybe a few dozen unique entries):\n\n```\n{\n   \"took\": 6148,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 78,\n      \"successful\": 78,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 0,\n      \"max_score\": null,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"terms\": {\n         \"buckets\": []\n      }\n   }\n}\n```\n\nWhen I run it against our `log_message` field, which is `not_analyzed` and has a ton of large strings (up to 10kb long) and the vast majority of the messages are unique:\n\n```\n{\n   \"took\": 184340,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 39,\n      \"successful\": 39,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 0,\n      \"max_score\": null,\n      \"hits\": []\n   },\n   \"aggregations\": {\n      \"terms\": {\n         \"buckets\": []\n      }\n   }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62434824","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62434824","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62434824,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDM0ODI0","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-11-10T18:57:50Z","updated_at":"2014-11-10T18:57:50Z","author_association":"CONTRIBUTOR","body":"Hmm this might be due to fielddata loading. This is expected since we need to load fielddata before knowing what matches but I will check that we are not loading global ordinals with the \"map\" execution hint since they are not required.\n\nCan you confirm that only the first few queries are slow?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62457407","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62457407","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62457407,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDU3NDA3","user":{"login":"avleen","id":539525,"node_id":"MDQ6VXNlcjUzOTUyNQ==","avatar_url":"https://avatars1.githubusercontent.com/u/539525?v=4","gravatar_id":"","url":"https://api.github.com/users/avleen","html_url":"https://github.com/avleen","followers_url":"https://api.github.com/users/avleen/followers","following_url":"https://api.github.com/users/avleen/following{/other_user}","gists_url":"https://api.github.com/users/avleen/gists{/gist_id}","starred_url":"https://api.github.com/users/avleen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avleen/subscriptions","organizations_url":"https://api.github.com/users/avleen/orgs","repos_url":"https://api.github.com/users/avleen/repos","events_url":"https://api.github.com/users/avleen/events{/privacy}","received_events_url":"https://api.github.com/users/avleen/received_events","type":"User","site_admin":false},"created_at":"2014-11-10T21:21:55Z","updated_at":"2014-11-10T21:21:55Z","author_association":"NONE","body":"This seems to be pretty slow all the time. It's hard to confirm because running the query takes down our production cluster for several minutes. It just happened again and one node fell out of the cluster because it was trying to do garbage collection for several minutes :-)\n\nRunning the `filtered query` part is really fast. It rarely takes more than 5 or 10s for ~5bn docs.\nRunning the `aggs` on top of that, even when are zero results from the query, takes many minutes.\nSo in this case, why is fielddata being loaded when there were zero results?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62689043","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62689043","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62689043,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNjg5MDQz","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-11-12T09:10:35Z","updated_at":"2014-11-12T09:10:35Z","author_association":"CONTRIBUTOR","body":"I can try to explain a bit more how running works on a shard level: Elasticsearch creates an object called `BulkScorer` which is responsible for finding matching documents and optionally scoring them. This `BulkScorer` takes a `Collector` which is basically a callback that gets called for every matching document. Examples of collectors include `TotalHitCountCollector` (to just count the number of matches), `TopDocsCollector` (to compute the top matching documents) or `AggregationsCollector` (to run aggregations). For instance your request would use both a `TopDocsCollector` and a `AggregationsCollector`. When we create the collector for aggregations, we need to prepare everything to get ready for collecting matches, which includes loading fielddata. But at this point we don't know if the query is going to match anything yet. This is why even queries that do not match any hits load field data.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62691010","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-62691010","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":62691010,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNjkxMDEw","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-11-12T09:27:48Z","updated_at":"2014-11-12T09:27:48Z","author_association":"CONTRIBUTOR","body":"I just checked that the `map` execution hint does not load global ordinals, as expected. So the only idea I have is that these slow times for queries that match no queries is due to fielddata loading.\n\nHowever, I'm still concerned that you mentioned that everything works fine when the query returns ~100 matches. Do you mean that requests that match no documents are more harmful to your cluster than those queries that match few documents?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64224657","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-64224657","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":64224657,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MjI0NjU3","user":{"login":"avleen","id":539525,"node_id":"MDQ6VXNlcjUzOTUyNQ==","avatar_url":"https://avatars1.githubusercontent.com/u/539525?v=4","gravatar_id":"","url":"https://api.github.com/users/avleen","html_url":"https://github.com/avleen","followers_url":"https://api.github.com/users/avleen/followers","following_url":"https://api.github.com/users/avleen/following{/other_user}","gists_url":"https://api.github.com/users/avleen/gists{/gist_id}","starred_url":"https://api.github.com/users/avleen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avleen/subscriptions","organizations_url":"https://api.github.com/users/avleen/orgs","repos_url":"https://api.github.com/users/avleen/repos","events_url":"https://api.github.com/users/avleen/events{/privacy}","received_events_url":"https://api.github.com/users/avleen/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T16:54:20Z","updated_at":"2014-11-24T16:54:20Z","author_association":"NONE","body":"It seemed that way but don't take it as gospel. It's possible that during\nthose instances, field data was already cached.\n\nCould the field data loading be delayed until we know what documents\nactually need to be loaded in?\nIt seems problematic is always load in huge amounts of field data when you\nare running a filtered query to reduce the number of documents for\naggregation.\n\nOn Wed, Nov 12, 2014, 01:27 Adrien Grand notifications@github.com wrote:\n\n> I just checked that the map execution hint does not load global ordinals,\n> as expected. So the only idea I have is that these slow times for queries\n> that match no queries is due to fielddata loading.\n> \n> However, I'm still concerned that you mentioned that everything works fine\n> when the query returns ~100 matches. Do you mean that requests that match\n> no documents are more harmful to your cluster than those queries that match\n> few documents?\n> \n> ## \n> \n> Reply to this email directly or view it on GitHub\n> https://github.com/elasticsearch/elasticsearch/issues/8406#issuecomment-62691010\n> .\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64396951","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-64396951","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":64396951,"node_id":"MDEyOklzc3VlQ29tbWVudDY0Mzk2OTUx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-25T13:10:01Z","updated_at":"2014-11-25T13:10:01Z","author_association":"CONTRIBUTOR","body":"@avleen If you want to use a field for sorting/aggregating, then you need it in fielddata.  Perhaps this query doesn't match but the next one will.  Fielddata is loaded from disk by uninverting the index, so it has to happen in one go.  It would be much much much slower if we were to load only matching docs.\n\nInstead, use doc values for this field.  Then the memory requirements go away.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64397534","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-64397534","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":64397534,"node_id":"MDEyOklzc3VlQ29tbWVudDY0Mzk3NTM0","user":{"login":"avleen","id":539525,"node_id":"MDQ6VXNlcjUzOTUyNQ==","avatar_url":"https://avatars1.githubusercontent.com/u/539525?v=4","gravatar_id":"","url":"https://api.github.com/users/avleen","html_url":"https://github.com/avleen","followers_url":"https://api.github.com/users/avleen/followers","following_url":"https://api.github.com/users/avleen/following{/other_user}","gists_url":"https://api.github.com/users/avleen/gists{/gist_id}","starred_url":"https://api.github.com/users/avleen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avleen/subscriptions","organizations_url":"https://api.github.com/users/avleen/orgs","repos_url":"https://api.github.com/users/avleen/repos","events_url":"https://api.github.com/users/avleen/events{/privacy}","received_events_url":"https://api.github.com/users/avleen/received_events","type":"User","site_admin":false},"created_at":"2014-11-25T13:15:18Z","updated_at":"2014-11-25T13:15:18Z","author_association":"NONE","body":"We'll give doc values another site Clinton. When we tested them a while\nback,we traded lower memory for significantly higher disk IO which slowed\nindexing.\nWe'll test to see if the recent perf improvements with doc values make them\nmore viable now :)\n\nThanks!\n\nOn Tue, Nov 25, 2014, 14:10 Clinton Gormley notifications@github.com\nwrote:\n\n> @avleen https://github.com/avleen If you want to use a field for\n> sorting/aggregating, then you need it in fielddata. Perhaps this query\n> doesn't match but the next one will. Fielddata is loaded from disk by\n> uninverting the index, so it has to happen in one go. It would be much much\n> much slower if we were to load only matching docs.\n> \n> Instead, use doc values for this field. Then the memory requirements go\n> away.\n> \n> ## \n> \n> Reply to this email directly or view it on GitHub\n> https://github.com/elasticsearch/elasticsearch/issues/8406#issuecomment-64396951\n> .\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64432215","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-64432215","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":64432215,"node_id":"MDEyOklzc3VlQ29tbWVudDY0NDMyMjE1","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-25T16:54:13Z","updated_at":"2014-11-25T16:54:13Z","author_association":"CONTRIBUTOR","body":"@avleen Make sure you aren't using them on the `message.raw` field (in fact, just disable the `message.raw` field completely).  Also, in Lucene 5, doc values merging is better than it is today, which should help as well.  Would be interested in any stats you can give us about the effect of doc values on your indexing.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/68455752","html_url":"https://github.com/elastic/elasticsearch/issues/8406#issuecomment-68455752","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8406","id":68455752,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NDU1NzUy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-12-31T17:22:47Z","updated_at":"2014-12-31T17:22:47Z","author_association":"CONTRIBUTOR","body":"Nothing more to do here.  Closing in favour of https://github.com/elasticsearch/elasticsearch/issues/8312\n","performed_via_github_app":null}]