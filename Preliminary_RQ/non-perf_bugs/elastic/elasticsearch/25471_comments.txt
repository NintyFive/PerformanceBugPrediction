[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314927326","html_url":"https://github.com/elastic/elasticsearch/issues/25471#issuecomment-314927326","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25471","id":314927326,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDkyNzMyNg==","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"created_at":"2017-07-12T23:35:50Z","updated_at":"2017-07-12T23:35:50Z","author_association":"CONTRIBUTOR","body":"another occurrence: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/441/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/316660100","html_url":"https://github.com/elastic/elasticsearch/issues/25471#issuecomment-316660100","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25471","id":316660100,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNjY2MDEwMA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2017-07-20T10:12:28Z","updated_at":"2017-07-20T10:12:28Z","author_association":"CONTRIBUTOR","body":"Another failure: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-windows-compatibility/517/console.\r\n\r\nStill on Windows.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317479367","html_url":"https://github.com/elastic/elasticsearch/issues/25471#issuecomment-317479367","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25471","id":317479367,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzQ3OTM2Nw==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-07-24T16:34:24Z","updated_at":"2017-07-24T16:34:24Z","author_association":"MEMBER","body":"I tried to pin this one down but couldn't. I push another commit enabling logging so I can see what's going on the next time it fails.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317491592","html_url":"https://github.com/elastic/elasticsearch/issues/25471#issuecomment-317491592","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25471","id":317491592,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzQ5MTU5Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-07-24T17:15:51Z","updated_at":"2017-07-24T17:15:51Z","author_association":"CONTRIBUTOR","body":"I think I know what's going on:\r\n\r\n```\r\n[2017-07-20T12:08:50,470][INFO ][o.e.c.s.ClusterApplierService] [node_tm1] added {{node_td0}{x-cBZZWBTgaw3HnIvASSoQ}{-70w0dZrQRamhbcEb-Yn8Q}{127.0.0.1}{127.0.0.1:9400},}, reason: apply cluster state (from master [master {node_tm1}{w9RMBfuvTHOltc_pciHQ9g}{VwzY_zHhSjytF5ZwhXDv5g}{127.0.0.1}{127.0.0.1:9401} committed version [3] source [zen-disco-node-join[{node_td0}{x-cBZZWBTgaw3HnIvASSoQ}{-70w0dZrQRamhbcEb-Yn8Q}{127.0.0.1}{127.0.0.1:9400}]]])\r\n```\r\n\r\nSee, that's cluster state version 3. Now we shutdown the master node, and start up another master node. If you look at those master nodes, you see that they have the same persistent id:\r\n\r\n```\r\n{node_tm1}{w9RMBfuvTHOltc_pciHQ9g}{VwzY_zHhSjytF5ZwhXDv5g}{127.0.0.1}{127.0.0.1:9401}\r\n{node_tm2}{w9RMBfuvTHOltc_pciHQ9g}{G48cQz0BQb-6eajl0Nccuw}{127.0.0.1}{127.0.0.1:9401}\r\n```\r\n\r\nHowever, `node_tm2` starts again with cluster state version 0, it's using a clean state. After the data node has rejoined `node_tm2` we have:\r\n\r\n```\r\n[2017-07-20T12:08:51,090][INFO ][o.e.c.s.ClusterApplierService] [node_tm2] added {{node_td0}{x-cBZZWBTgaw3HnIvASSoQ}{-70w0dZrQRamhbcEb-Yn8Q}{127.0.0.1}{127.0.0.1:9400},}, reason: apply cluster state (from master [master {node_tm2}{w9RMBfuvTHOltc_pciHQ9g}{G48cQz0BQb-6eajl0Nccuw}{127.0.0.1}{127.0.0.1:9401} committed version [3] source [zen-disco-node-join[{node_td0}{x-cBZZWBTgaw3HnIvASSoQ}{-70w0dZrQRamhbcEb-Yn8Q}{127.0.0.1}{127.0.0.1:9400}]]])\r\n```\r\n\r\nagain cluster state version 3.\r\n\r\nLet's look at `MasterNodeChangePredicate`, which is used by `TransportMasterNodeAction` for the ClusterObserver:\r\n\r\n```\r\npublic static Predicate<ClusterState> build(ClusterState currentState) {\r\n        final long currentVersion = currentState.version();\r\n        final String currentMaster = currentState.nodes().getMasterNodeId();\r\n        return newState -> {\r\n            final String newMaster = newState.nodes().getMasterNodeId();\r\n            final boolean accept;\r\n            if (newMaster == null) {\r\n                accept = false;\r\n            } else if (newMaster.equals(currentMaster) == false){\r\n                accept = true;\r\n            } else {\r\n                accept = newState.version() > currentVersion;\r\n            }\r\n            return accept;\r\n        };\r\n    }\r\n```\r\n\r\nIf, due to batching on the applier, the data node did not apply the cluster state where the old master has been removed, but directly applies the one with the new master, the predicate will return false, as we will have same persistent master node id and same CS version.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/317496429","html_url":"https://github.com/elastic/elasticsearch/issues/25471#issuecomment-317496429","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25471","id":317496429,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNzQ5NjQyOQ==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-07-24T17:32:31Z","updated_at":"2017-07-24T17:32:31Z","author_association":"MEMBER","body":"Great catch @ywelsch . I thought about this scenario but erroneously discarded it, thinking that since the node uses the same data folder, it will recover the cluster state *with* the version (sadly.. this is where it goes wrong) and thus the version will be incremented. Note though that batching is one possible cause. Another is concurrency in calling the observer - it may skip a cluster state update while transport master action deals with things.\r\n\r\nI will work on a fix tomorrow.","performed_via_github_app":null}]