[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/630428979","html_url":"https://github.com/elastic/elasticsearch/issues/56923#issuecomment-630428979","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56923","id":630428979,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDQyODk3OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-05-18T20:52:25Z","updated_at":"2020-05-18T20:52:25Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/630429022","html_url":"https://github.com/elastic/elasticsearch/issues/56923#issuecomment-630429022","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56923","id":630429022,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDQyOTAyMg==","user":{"login":"toby-jn","id":32616473,"node_id":"MDQ6VXNlcjMyNjE2NDcz","avatar_url":"https://avatars1.githubusercontent.com/u/32616473?v=4","gravatar_id":"","url":"https://api.github.com/users/toby-jn","html_url":"https://github.com/toby-jn","followers_url":"https://api.github.com/users/toby-jn/followers","following_url":"https://api.github.com/users/toby-jn/following{/other_user}","gists_url":"https://api.github.com/users/toby-jn/gists{/gist_id}","starred_url":"https://api.github.com/users/toby-jn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/toby-jn/subscriptions","organizations_url":"https://api.github.com/users/toby-jn/orgs","repos_url":"https://api.github.com/users/toby-jn/repos","events_url":"https://api.github.com/users/toby-jn/events{/privacy}","received_events_url":"https://api.github.com/users/toby-jn/received_events","type":"User","site_admin":false},"created_at":"2020-05-18T20:52:30Z","updated_at":"2020-05-18T20:52:30Z","author_association":"NONE","body":"It looks to me like the error is coming from: https://github.com/elastic/elasticsearch/blob/v7.7.0/server/src/main/java/org/elasticsearch/search/query/QueryPhase.java#L376\r\nThough I'm not sure why it's not easier to reproduce this error.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/630441253","html_url":"https://github.com/elastic/elasticsearch/issues/56923#issuecomment-630441253","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56923","id":630441253,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDQ0MTI1Mw==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2020-05-18T21:20:12Z","updated_at":"2020-05-18T21:20:12Z","author_association":"MEMBER","body":"@toby-jn thanks for raising this bug. From digging into the stack trace, it looks like this happens when (1) the search size is 0, and (2) the 'long sort' optimization is enabled.\r\n\r\nWe added the optimization in 7.6 to speed up searches that sort on a `long` field (#48804). The optimization only kicks in if there are > 512 documents, and the sort doesn't match the index sort exactly (otherwise we could use the normal index sort optimization). This could help explain why you aren't able to put together a simple reproduction using just a few documents.\r\n\r\nWe will look into a fix. In the meantime, a workaround would be to remove the `sort` section for these searches that just count total hits, since sorting won't have an affect on the result.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/630444211","html_url":"https://github.com/elastic/elasticsearch/issues/56923#issuecomment-630444211","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56923","id":630444211,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDQ0NDIxMQ==","user":{"login":"toby-jn","id":32616473,"node_id":"MDQ6VXNlcjMyNjE2NDcz","avatar_url":"https://avatars1.githubusercontent.com/u/32616473?v=4","gravatar_id":"","url":"https://api.github.com/users/toby-jn","html_url":"https://github.com/toby-jn","followers_url":"https://api.github.com/users/toby-jn/followers","following_url":"https://api.github.com/users/toby-jn/following{/other_user}","gists_url":"https://api.github.com/users/toby-jn/gists{/gist_id}","starred_url":"https://api.github.com/users/toby-jn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/toby-jn/subscriptions","organizations_url":"https://api.github.com/users/toby-jn/orgs","repos_url":"https://api.github.com/users/toby-jn/repos","events_url":"https://api.github.com/users/toby-jn/events{/privacy}","received_events_url":"https://api.github.com/users/toby-jn/received_events","type":"User","site_admin":false},"created_at":"2020-05-18T21:26:47Z","updated_at":"2020-05-18T21:26:47Z","author_association":"NONE","body":"Just managed to reproduce it, but looks like you beat me to why it wasn't working before, needed to add more documents for testing. Now able to reliably reproduce this with the following script on a fresh 7.7.0 install:\r\n```\r\ncurl -X PUT 127.0.0.1:9200/twitter -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"sort.field\" : \"date\",\r\n            \"sort.order\": \"desc\"\r\n        }\r\n    },\r\n    \"mappings\": {\r\n        \"properties\": {\r\n            \"date\": {\r\n                \"type\": \"date\"\r\n            },\r\n            \"title\": {\r\n                \"type\": \"keyword\"\r\n            }\r\n        }\r\n    }\r\n}\r\n'\r\n\r\n# index 20k documents\r\nyes '{\"index\": {}}\r\n{\"date\": \"2020-05-18T19:21:36Z\",\"title\": \"title1\"}' | head -n 40000 | curl -X POST 127.0.0.1:9200/twitter/_bulk?refresh -H 'Content-Type: application/json' --data-binary @- > /dev/null\r\n\r\n# works\r\ncurl -X POST '127.0.0.1:9200/twitter/_search?error_trace=true&pretty' -H content-type:application/json --data '{\"size\":0,\"sort\":[{\"date\":{\"order\":\"desc\"}}],\"track_total_hits\":true}'\r\n\r\n# error\r\ncurl -X POST '127.0.0.1:9200/twitter/_search?error_trace=true&pretty' -H content-type:application/json --data '{\"size\":0,\"sort\":[{\"date\":{\"order\":\"desc\"}},{\"title\":{\"order\":\"asc\"}}],\"track_total_hits\":true}'\r\n```","performed_via_github_app":null}]