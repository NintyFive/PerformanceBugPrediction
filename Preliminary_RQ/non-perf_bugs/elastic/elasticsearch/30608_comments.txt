[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389146473","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389146473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389146473,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTE0NjQ3Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T12:20:13Z","updated_at":"2018-05-15T12:20:13Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389146919","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389146919","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389146919,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTE0NjkxOQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T12:22:04Z","updated_at":"2018-05-15T12:22:04Z","author_association":"MEMBER","body":"@colings86 do you have an idea whether this is something that should be supported or a usage problem?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389150055","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389150055","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389150055,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTE1MDA1NQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T12:33:27Z","updated_at":"2018-05-15T12:33:27Z","author_association":"MEMBER","body":"@ruizmarc This does indeed looks like a bug at first glance. Do you have the full stack trace for the ClassCastException from your server logs?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389167825","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389167825","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389167825,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTE2NzgyNQ==","user":{"login":"ruizmarc","id":5717082,"node_id":"MDQ6VXNlcjU3MTcwODI=","avatar_url":"https://avatars3.githubusercontent.com/u/5717082?v=4","gravatar_id":"","url":"https://api.github.com/users/ruizmarc","html_url":"https://github.com/ruizmarc","followers_url":"https://api.github.com/users/ruizmarc/followers","following_url":"https://api.github.com/users/ruizmarc/following{/other_user}","gists_url":"https://api.github.com/users/ruizmarc/gists{/gist_id}","starred_url":"https://api.github.com/users/ruizmarc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ruizmarc/subscriptions","organizations_url":"https://api.github.com/users/ruizmarc/orgs","repos_url":"https://api.github.com/users/ruizmarc/repos","events_url":"https://api.github.com/users/ruizmarc/events{/privacy}","received_events_url":"https://api.github.com/users/ruizmarc/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T13:32:39Z","updated_at":"2018-05-15T14:28:59Z","author_association":"NONE","body":"Thanks for your quick response :) Sure, here you have the stack trace:\r\n\r\n```\r\n org.elasticsearch.action.search.SearchPhaseExecutionException:\r\n    at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:274) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:657) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\n    at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\n Caused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n    at org.elasticsearch.search.aggregations.pipeline.bucketmetrics.BucketMetricsPipelineAggregator.doReduce(BucketMetricsPipelineAggregator.java:83) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:533) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:504) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:421) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:740) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    ... 5 more\r\n [2018-05-15T10:42:12,952][WARN ][r.suppressed             ] path: /charges/_search, params: {index=charges}\r\n org.elasticsearch.action.search.SearchPhaseExecutionException:\r\n    at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:274) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:657) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\n    at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\n Caused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n    at org.elasticsearch.search.aggregations.pipeline.bucketmetrics.BucketMetricsPipelineAggregator.doReduce(BucketMetricsPipelineAggregator.java:83) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:533) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:504) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:421) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:740) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    ... 5 more\r\n [2018-05-15T10:42:28,853][WARN ][r.suppressed             ] path: /charges/_search, params: {index=charges}\r\n org.elasticsearch.action.search.SearchPhaseExecutionException:\r\n    at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:274) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:657) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\n    at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\n Caused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n    at org.elasticsearch.search.aggregations.pipeline.bucketmetrics.BucketMetricsPipelineAggregator.doReduce(BucketMetricsPipelineAggregator.java:83) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:533) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:504) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:421) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:740) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    ... 5 more\r\n [2018-05-15T13:31:07,538][WARN ][r.suppressed             ] path: /charges/_search, params: {index=charges}\r\n org.elasticsearch.action.search.SearchPhaseExecutionException:\r\n    at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:274) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:657) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_161]\r\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_161]\r\n    at java.lang.Thread.run(Thread.java:748) [?:1.8.0_161]\r\n Caused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n    at org.elasticsearch.search.aggregations.pipeline.bucketmetrics.BucketMetricsPipelineAggregator.doReduce(BucketMetricsPipelineAggregator.java:83) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:533) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:504) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:421) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:740) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n    ... 5 more\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389187735","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389187735","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389187735,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTE4NzczNQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T14:29:25Z","updated_at":"2018-05-15T14:29:25Z","author_association":"MEMBER","body":"@ruizmarc  I hope you don't mind but I re-formatted your stack trace a bit to make it a bit easier to read","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389326863","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389326863","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389326863,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTMyNjg2Mw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T21:58:34Z","updated_at":"2018-05-15T21:58:34Z","author_association":"MEMBER","body":"I see the bug.  It's not just when the aggs are the same name, but when they line up in just the correct manner:\r\n\r\n- A. Multi-bucket agg in the first entry of our internal list\r\n- B. Regular agg as the immediate child of the multi-bucket in A\r\n- C. Regular agg with the same name as B at the top level, listed as the second entry in our internal list\r\n- D. Finally, a pipeline agg with the path down to B\r\n\r\nIt blows up because we [overwrite the bucket path with the sublist](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/search/aggregations/pipeline/bucketmetrics/BucketMetricsPipelineAggregator.java#L82).  So when we start iterating, we match the agg in A, sublist the path and recurse down.  But when the loop comes back around to check agg C, the sublisted path now matches because it went from `A>B` to just `B`, and then it throws the cast exception.\r\n\r\nThe fix should be pretty straightforward.  I'll work something up.  Thanks for the bug report @ruizmarc! ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389352897","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-389352897","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":389352897,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTM1Mjg5Nw==","user":{"login":"ruizmarc","id":5717082,"node_id":"MDQ6VXNlcjU3MTcwODI=","avatar_url":"https://avatars3.githubusercontent.com/u/5717082?v=4","gravatar_id":"","url":"https://api.github.com/users/ruizmarc","html_url":"https://github.com/ruizmarc","followers_url":"https://api.github.com/users/ruizmarc/followers","following_url":"https://api.github.com/users/ruizmarc/following{/other_user}","gists_url":"https://api.github.com/users/ruizmarc/gists{/gist_id}","starred_url":"https://api.github.com/users/ruizmarc/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ruizmarc/subscriptions","organizations_url":"https://api.github.com/users/ruizmarc/orgs","repos_url":"https://api.github.com/users/ruizmarc/repos","events_url":"https://api.github.com/users/ruizmarc/events{/privacy}","received_events_url":"https://api.github.com/users/ruizmarc/received_events","type":"User","site_admin":false},"created_at":"2018-05-16T00:06:20Z","updated_at":"2018-05-16T00:06:20Z","author_association":"NONE","body":"I'm glad it helped! Thanks for your quick fix, it will be very helpful! 💯 ☺️","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390192096","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-390192096","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":390192096,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDE5MjA5Ng==","user":{"login":"jmuscireum","id":31538484,"node_id":"MDQ6VXNlcjMxNTM4NDg0","avatar_url":"https://avatars2.githubusercontent.com/u/31538484?v=4","gravatar_id":"","url":"https://api.github.com/users/jmuscireum","html_url":"https://github.com/jmuscireum","followers_url":"https://api.github.com/users/jmuscireum/followers","following_url":"https://api.github.com/users/jmuscireum/following{/other_user}","gists_url":"https://api.github.com/users/jmuscireum/gists{/gist_id}","starred_url":"https://api.github.com/users/jmuscireum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmuscireum/subscriptions","organizations_url":"https://api.github.com/users/jmuscireum/orgs","repos_url":"https://api.github.com/users/jmuscireum/repos","events_url":"https://api.github.com/users/jmuscireum/events{/privacy}","received_events_url":"https://api.github.com/users/jmuscireum/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T12:32:10Z","updated_at":"2018-05-18T12:32:10Z","author_association":"NONE","body":"It seems like I stumbled across the same bug, so I backported the fix to 5.6.8 to check. But unfortunatly the fix isn't working for me:\r\n\r\n```\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: \r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:272) [elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.onFailure(FetchSearchPhase.java:92) [elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.onFailure(ThreadContext.java:659) [elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:39) [elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_144]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_144]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_144]\r\nCaused by: java.lang.ClassCastException: org.elasticsearch.search.aggregations.bucket.filter.InternalFilter cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation\r\n\tat org.elasticsearch.search.aggregations.pipeline.bucketmetrics.BucketMetricsPipelineAggregator.doReduce(BucketMetricsPipelineAggregator.java:83) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reduceAggs(SearchPhaseController.java:519) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:490) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchPhaseController.reducedQueryPhase(SearchPhaseController.java:408) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.SearchPhaseController$1.reduce(SearchPhaseController.java:725) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:102) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:45) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:87) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:674) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.6.8-SNAPSHOT.jar:5.6.8-SNAPSHOT]\r\n\t... 3 more\r\n```\r\n\r\nThe query is: \r\n```\r\n{\r\n  \"size\" : 13,\r\n  \"query\" : {\r\n    \"match_all\": {}\r\n  },\r\n  \"aggregations\" : {  \r\n    \"filteredPrices\" : {\r\n      \"filter\" : {\r\n        \"match_all\": {}\r\n      },\r\n      \"aggregations\" : {\r\n        \"groupById\" : {\r\n          \"terms\" : {\r\n            \"field\" : \"itemId\"\r\n          },\r\n          \"aggregations\" : {\r\n            \"nestedPrices\" : {\r\n              \"nested\" : {\r\n                \"path\" : \"prices\"\r\n              },\r\n              \"aggregations\" : {\r\n                \"catalogFiltered\" : {\r\n                  \"filter\" : {\r\n                    \"match_all\": {}\r\n                  },\r\n                  \"aggregations\" : {\r\n                    \"minPrice\" : {\r\n                      \"min\" : {\r\n                        \"field\" : \"prices.price\"\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"minPriceOfAllItems\" : {\r\n      \"min_bucket\" : {\r\n        \"buckets_path\" : [\r\n          \"filteredPrices>groupById>nestedPrices>catalogFiltered>minPrice\"\r\n        ],\r\n        \"gap_policy\" : \"skip\"\r\n      }\r\n    },\r\n    \"maxPriceOfAllItems\" : {\r\n      \"max_bucket\" : {\r\n        \"buckets_path\" : [\r\n          \"filteredPrices>groupById>nestedPrices>catalogFiltered>minPrice\"\r\n        ],\r\n        \"gap_policy\" : \"skip\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390203701","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-390203701","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":390203701,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDIwMzcwMQ==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T13:17:17Z","updated_at":"2018-05-18T13:17:17Z","author_association":"MEMBER","body":"Hey @jmuscireum, I believe your running into a triplet of unrelated issues that constrain pipeline aggs right now.\r\n\r\nFirst, `filter` aggs don't play nicely with pipelines because they only emit a single bucket, whereas the various sibling pipeline aggs (like `min_bucket`) can only use multi-bucket aggs.  Issue https://github.com/elastic/elasticsearch/issues/14600 deals with this (it talks about `bucket_script`, but generally applicable to other sibling aggs).\r\n\r\nYou can \"workaround\" it by using `filters` agg, but then you'll run into this issue: https://github.com/elastic/elasticsearch/issues/29287.  Which is actually the same thing: nested aggs emit a single bucket instead of multi-buckets\r\n\r\nFinally, and I'm not sure there's an issue for this, but pipeline aggs can't aggregate across multiple levels of terms aggregations easily.  You can sometimes work around it by \"proxy'ing\" the value out of the terms agg with an intermediate pipeline agg (e.g. a min_bucket on the same level as the terms, to \"roll up\" the value at that level, then another min_bucket at a higher level to roll up all the previous min_buckets).  But you can't normally use one pipeline agg to aggregate across multiple levels of terms aggs.\r\n\r\nSorry for all the bad news... pipeline aggs have some fundamental limitations based on how the framework works.  :(","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390216598","html_url":"https://github.com/elastic/elasticsearch/issues/30608#issuecomment-390216598","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30608","id":390216598,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDIxNjU5OA==","user":{"login":"jmuscireum","id":31538484,"node_id":"MDQ6VXNlcjMxNTM4NDg0","avatar_url":"https://avatars2.githubusercontent.com/u/31538484?v=4","gravatar_id":"","url":"https://api.github.com/users/jmuscireum","html_url":"https://github.com/jmuscireum","followers_url":"https://api.github.com/users/jmuscireum/followers","following_url":"https://api.github.com/users/jmuscireum/following{/other_user}","gists_url":"https://api.github.com/users/jmuscireum/gists{/gist_id}","starred_url":"https://api.github.com/users/jmuscireum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmuscireum/subscriptions","organizations_url":"https://api.github.com/users/jmuscireum/orgs","repos_url":"https://api.github.com/users/jmuscireum/repos","events_url":"https://api.github.com/users/jmuscireum/events{/privacy}","received_events_url":"https://api.github.com/users/jmuscireum/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T14:00:47Z","updated_at":"2018-05-18T14:00:47Z","author_association":"NONE","body":"Hey @polyfractal, thank you for the detailed answer! As a workaround, we can manually fetch the min and max price from the aggregated bucket. But I have the feeling, that there is a way that is more suited for our use case, but I can't think of it. Maybe you have an idea how we can achieve this, without having so many nested aggregations.\r\n\r\nOur products can have different prices in multiple catalogs. Depending on the user, different catalogs are accessible. So the prices differ from user to user. On our search page every product filter is showing the active filter values and the values that are additionally possible. For this we are using the post filter to filter the products after the filter aggregations were done. That's why `filteredPrices` exists. It filters the products that should be taken into consideration for the min and max values of our price filter.\r\n\r\nThank you for doing awesome work and have a nice weekend!","performed_via_github_app":null}]