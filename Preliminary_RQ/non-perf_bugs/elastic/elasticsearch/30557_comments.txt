[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/388726378","html_url":"https://github.com/elastic/elasticsearch/issues/30557#issuecomment-388726378","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30557","id":388726378,"node_id":"MDEyOklzc3VlQ29tbWVudDM4ODcyNjM3OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-14T07:45:34Z","updated_at":"2018-05-14T07:45:34Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390162581","html_url":"https://github.com/elastic/elasticsearch/issues/30557#issuecomment-390162581","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30557","id":390162581,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDE2MjU4MQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T10:14:32Z","updated_at":"2018-05-18T10:14:32Z","author_association":"MEMBER","body":"This looks very much related to the changes made in #29535. Other seeds seem to run fine. I'm digging into the details but if @nik9000 has some ideas how to debug this efficiently, I'd appreciate a hint.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390166752","html_url":"https://github.com/elastic/elasticsearch/issues/30557#issuecomment-390166752","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30557","id":390166752,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDE2Njc1Mg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T10:32:32Z","updated_at":"2018-05-18T10:32:32Z","author_association":"MEMBER","body":"The first failure is related to the italian analyzers:\r\n```\r\nFailure at [reference/analysis/analyzers/lang-analyzer:1144]: text differs: italian was [𐒁𐒌𐒥𐒔] but rebuilt_italian was [d'e]. In utf8 those are\r\n   > [f0 90 92 81 f0 90 92 8c f0 90 92 a5 f0 90 92 94] and\r\n   > [64 27 65]\r\n```\r\nThe second is the same input token, but relates to the catalan analyzer:\r\n```\r\nFailure at [reference/analysis/analyzers/lang-analyzer:352]: text differs: catalan was [𐒁𐒌𐒥𐒔] but rebuilt_catalan was [d'e]. In utf8 those are0\r\n   > [f0 90 92 81 f0 90 92 8c f0 90 92 a5 f0 90 92 94] and\r\n   > [64 27 65]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390182671","html_url":"https://github.com/elastic/elasticsearch/issues/30557#issuecomment-390182671","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30557","id":390182671,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDE4MjY3MQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T11:48:51Z","updated_at":"2018-05-18T11:48:51Z","author_association":"MEMBER","body":"Its a bit tricky to debug this since the context if missing from the error, but I think I managed to isolate the part where the two analyzer outputs begin to differ. I can reproduce in Kibana, not sure if this copy/paste action preserves all \"hidden\" characters that the test string contains, but anyway:\r\n\r\n```\r\nPUT /italian_example\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"filter\": {\r\n        \"italian_elision\": {\r\n          \"type\": \"elision\",\r\n          \"articles\": [\r\n                \"c\", \"l\", \"all\", \"dall\", \"dell\",\r\n                \"nell\", \"sull\", \"coll\", \"pell\",\r\n                \"gl\", \"agl\", \"dagl\", \"degl\", \"negl\",\r\n                \"sugl\", \"un\", \"m\", \"t\", \"s\", \"v\", \"d\"\r\n          ]\r\n        },\r\n        \"italian_stop\": {\r\n          \"type\":       \"stop\",\r\n          \"stopwords\":  \"_italian_\" \r\n        },\r\n        \"italian_keywords\": {\r\n          \"type\":       \"keyword_marker\",\r\n          \"keywords\":   [\"esempio\"] \r\n        },\r\n        \"italian_stemmer\": {\r\n          \"type\":       \"stemmer\",\r\n          \"language\":   \"light_italian\"\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"rebuilt_italian\": {\r\n          \"tokenizer\":  \"standard\",\r\n          \"filter\": [\r\n            \"italian_elision\",\r\n            \"lowercase\",\r\n            \"italian_stop\",\r\n            \"italian_keywords\",\r\n            \"italian_stemmer\"\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST /test/_analyze\r\n  {\r\n  \"analyzer\" : \"italian\",\r\n  \"text\" : \"𐅣 D'e* ᧴᧱᧡, ﹢﹪ 𐒁𐒌𐒥𐒔 ջ՘՘զԲ԰ԽՙԻՕԴՇֈ 𐱍𐰕𐰬𐰪𐰯𐰕𐰉𐰜𐰁𐰫𐱉𐰅𐰾 ꩪꩤ꩹ꩤꩼ ᜦᜦᜫᜦ᜹, 𐡏𐡚𐡗𐡖𐡂𐡞𐡒𐡑      𐡞𐡌𐡗𐡄𐡁𐡓, ᇷᄒᇐᇽ취ᄸ\"\r\n}\r\n\r\nPOST /italian_example/_analyze\r\n  {\r\n  \"analyzer\" : \"rebuilt_italian\",\r\n  \"text\" : \"𐅣 D'e* ᧴᧱᧡, ﹢﹪ 𐒁𐒌𐒥𐒔 ջ՘՘զԲ԰ԽՙԻՕԴՇֈ 𐱍𐰕𐰬𐰪𐰯𐰕𐰉𐰜𐰁𐰫𐱉𐰅𐰾 ꩪꩤ꩹ꩤꩼ ᜦᜦᜫᜦ᜹, 𐡏𐡚𐡗𐡖𐡂𐡞𐡒𐡑      𐡞𐡌𐡗𐡄𐡁𐡓, ᇷᄒᇐᇽ취ᄸ\"\r\n}\r\n```\r\n\r\nThe first analyzes to:\r\n```\r\n{\r\n  \"tokens\": [\r\n    {\r\n      \"token\": \"𐅣\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 2,\r\n      \"type\": \"<ALPHANUM>\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"𐒁𐒌𐒥𐒔\",\r\n      \"start_offset\": 16,\r\n      \"end_offset\": 24,\r\n      \"type\": \"<ALPHANUM>\",\r\n      \"position\": 2\r\n    },\r\n    {\r\n      \"token\": \"ջ\",\r\n      \"start_offset\": 25,\r\n      \"end_offset\": 26,\r\n      \"type\": \"<ALPHANUM>\",\r\n      \"position\": 3\r\n    }, [...]\r\n```\r\n\r\nThe second to \r\n```\r\n{\r\n  \"tokens\": [\r\n    {\r\n      \"token\": \"𐅣\",\r\n      \"start_offset\": 0,\r\n      \"end_offset\": 2,\r\n      \"type\": \"<ALPHANUM>\",\r\n      \"position\": 0\r\n    },\r\n    {\r\n      \"token\": \"d'e\",\r\n      \"start_offset\": 3,\r\n      \"end_offset\": 6,\r\n      \"type\": \"<ALPHANUM>\",\r\n      \"position\": 1\r\n    },\r\n    {\r\n      \"token\": \"𐒁𐒌𐒥𐒔\",\r\n      \"start_offset\": 16,\r\n      \"end_offset\": 24,\r\n      \"type\": \"<ALPHANUM>\",\r\n      \"position\": 2\r\n    }, [...]\r\n```\r\n\r\nSo the original italian analyzer seems to swallow one more token. This part is surrounded by many chracters that seem to get dropped during analysis, which makes this also hard to debug.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390184802","html_url":"https://github.com/elastic/elasticsearch/issues/30557#issuecomment-390184802","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30557","id":390184802,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDE4NDgwMg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T11:59:03Z","updated_at":"2018-05-18T11:59:03Z","author_association":"MEMBER","body":"I think it's caused by the elision filter that is case insensitive in the built in analyzer and not in the rebuilt one. Adding `\"articles_case\": true` in all the `elision` filter of the rebuilt analyzer seems to solve the issue (this is already done for the `french_rebuilt`).","performed_via_github_app":null}]