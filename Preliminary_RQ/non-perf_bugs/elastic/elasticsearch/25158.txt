{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25158","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25158/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25158/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25158/events","html_url":"https://github.com/elastic/elasticsearch/issues/25158","id":234868115,"node_id":"MDU6SXNzdWUyMzQ4NjgxMTU=","number":25158,"title":"Scroll request never ends on mixed version cluster (5.1.2/5.3.2)","user":{"login":"nomoa","id":5939211,"node_id":"MDQ6VXNlcjU5MzkyMTE=","avatar_url":"https://avatars1.githubusercontent.com/u/5939211?v=4","gravatar_id":"","url":"https://api.github.com/users/nomoa","html_url":"https://github.com/nomoa","followers_url":"https://api.github.com/users/nomoa/followers","following_url":"https://api.github.com/users/nomoa/following{/other_user}","gists_url":"https://api.github.com/users/nomoa/gists{/gist_id}","starred_url":"https://api.github.com/users/nomoa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nomoa/subscriptions","organizations_url":"https://api.github.com/users/nomoa/orgs","repos_url":"https://api.github.com/users/nomoa/repos","events_url":"https://api.github.com/users/nomoa/events{/privacy}","received_events_url":"https://api.github.com/users/nomoa/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-06-09T15:49:09Z","updated_at":"2017-06-09T18:39:55Z","closed_at":"2017-06-09T18:39:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"While doing a rolling restart on a cluster to upgrade from 5.1.2 to 5.3.2 we noticed that a script used to rebuild some indices stopped to function properly. The scroll request used constantly returned the same set of results.\r\n\r\nLooking into details it appeared to only happen for small indices where the initial scroll request returned all the hits. But also only on indices with a shard that was hosted by nodes with different versions.\r\n\r\nUsing `preference=_only_nodes:old_version_node` I was able to reproduce the problem consistently on the production cluster.\r\nI have not verified that I could reproduce the problem on a test environment but I think we can reproduce it with:\r\n\r\n- Install elastic 5.1.2 a cluster with 2 nodes (node1, node2).\r\n- Create a small index with 5 docs (one shard and one replica so that the index is hosted on both nodes)\r\n- upgrade node1 to elastic to 5.3.2\r\n- Create a scroll context by sending the REST request to node1 but forcing the transport request to be sent to node2: `curl -s -XGET 'node1:9200/test/_search?preference=_only_nodes:node2&size=20&scroll=15m' | jq ._scroll_id`\r\n- The resulting scroll_id is broken calling /_search/scroll multiple times on it will return the same set of results (the node used to send the REST request does not matter)\r\n- Sending the initial rest request to node2 with `preference=_only_nodes:node2` does not trigger the issue\r\n- Sending the initial rest request to node2 with `preference=_only_nodes:node1` does not trigger the issue\r\n\r\nSo it looks like that if scroll context is created on a node at v5.1.2 but the transport request is sent from a node at v5.3.2 the scroll context is broken.\r\n\r\nThe problem only appeared on small indices but I did not carefully checked larger indices.\r\n","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}