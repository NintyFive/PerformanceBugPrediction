{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42780","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42780/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42780/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42780/events","html_url":"https://github.com/elastic/elasticsearch/issues/42780","id":451078532,"node_id":"MDU6SXNzdWU0NTEwNzg1MzI=","number":42780,"title":"filter_duplicate_text - Words that appear in duplicated texts have lower scores than they should","user":{"login":"eranhirs","id":3372820,"node_id":"MDQ6VXNlcjMzNzI4MjA=","avatar_url":"https://avatars1.githubusercontent.com/u/3372820?v=4","gravatar_id":"","url":"https://api.github.com/users/eranhirs","html_url":"https://github.com/eranhirs","followers_url":"https://api.github.com/users/eranhirs/followers","following_url":"https://api.github.com/users/eranhirs/following{/other_user}","gists_url":"https://api.github.com/users/eranhirs/gists{/gist_id}","starred_url":"https://api.github.com/users/eranhirs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eranhirs/subscriptions","organizations_url":"https://api.github.com/users/eranhirs/orgs","repos_url":"https://api.github.com/users/eranhirs/repos","events_url":"https://api.github.com/users/eranhirs/events{/privacy}","received_events_url":"https://api.github.com/users/eranhirs/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2019-06-01T12:05:28Z","updated_at":"2019-06-03T09:36:47Z","closed_at":"2019-06-02T20:28:58Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): [Docker Image](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): [Docker Image](https://www.elastic.co/guide/en/elasticsearch/reference/7.0/docker.html)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 18\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen setting `\"filter_duplicate_text\": true` in `significant_text` aggregation, it changes the count only for the `doc_count` and not for the `bg_count`.\r\n\r\nThis is problematic as a word that appears a lot in duplicated texts has a significantly lower score than it should.\r\n\r\nThe expected behavior would be that it ignores duplicated texts completely like they don't exist.\r\n\r\n**Steps to reproduce**:\r\n\r\nIn the following example, we expect the words `Cat1` and `Cat2` to show up together.\r\nHowever, we will see that `Cat2` is penalized because it appears in duplicated texts.\r\nThen we remove the duplicated texts and see that `Cat2` appears like expected.\r\n\r\n```\r\nPUT some_index\r\n\r\nPOST some_index/_search\r\n\r\nPOST some_index/_doc/1\r\n{\r\n  \"text\": \"Cat1 Cat2 - I am a duplicated text\"\r\n}\r\n\r\nPOST some_index/_doc/2\r\n{\r\n  \"text\": \"Cat1 Cat2 - I am a duplicated text\"\r\n}\r\n\r\nPOST some_index/_doc/3\r\n{\r\n  \"text\": \"Cat1 Cat2 - I am a duplicated text\"\r\n}\r\n\r\nPOST some_index/_doc/4\r\n{\r\n  \"text\": \" not - Cat1 - duplicated - Cat2 - at all\"\r\n}\r\n\r\nPOST some_index/_doc/5\r\n{\r\n  \"text\": \"no - Cat1 - duplication - Cat2\"\r\n}\r\n\r\nPOST some_index/_doc/6\r\n{\r\n  \"text\": \"zero - Cat1 - dups - Cat2\"\r\n}\r\n\r\nPOST some_index/_doc/7\r\n{\r\n  \"text\": \"Very different text\"\r\n}\r\n```\r\n\r\nWhen using the following search, you can see that `Cat2` is not a word that is associated with `Cat1`\r\n```\r\nPOST some_index/_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"match\": {\r\n      \"text\": \"Cat1\"\r\n    }\r\n  }, \r\n  \"aggs\": {\r\n    \"NAME\": {\r\n      \"significant_text\": {\r\n        \"field\": \"text\",\r\n        \"filter_duplicate_text\": true,\r\n        \"min_doc_count\": 2\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nNow, delete the index and run it again without indexing the duplicated texts (remove documents 1 and 2).\r\nRun the search again, we see Cat2 appears.\r\n\r\nI couldn't reproduce it but in my own example I did get Cat2 but with a low score and I saw that bg_count is the same and doc_count is lower.","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}