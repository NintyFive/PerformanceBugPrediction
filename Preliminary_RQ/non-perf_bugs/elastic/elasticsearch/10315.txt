{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10315","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10315/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10315/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10315/events","html_url":"https://github.com/elastic/elasticsearch/issues/10315","id":65188055,"node_id":"MDU6SXNzdWU2NTE4ODA1NQ==","number":10315,"title":"grand parent/parent/child aggregation (NullPointerException)","user":{"login":"rkarakaya","id":3129105,"node_id":"MDQ6VXNlcjMxMjkxMDU=","avatar_url":"https://avatars1.githubusercontent.com/u/3129105?v=4","gravatar_id":"","url":"https://api.github.com/users/rkarakaya","html_url":"https://github.com/rkarakaya","followers_url":"https://api.github.com/users/rkarakaya/followers","following_url":"https://api.github.com/users/rkarakaya/following{/other_user}","gists_url":"https://api.github.com/users/rkarakaya/gists{/gist_id}","starred_url":"https://api.github.com/users/rkarakaya/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rkarakaya/subscriptions","organizations_url":"https://api.github.com/users/rkarakaya/orgs","repos_url":"https://api.github.com/users/rkarakaya/repos","events_url":"https://api.github.com/users/rkarakaya/events{/privacy}","received_events_url":"https://api.github.com/users/rkarakaya/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-03-30T11:07:29Z","updated_at":"2015-03-30T11:54:49Z","closed_at":"2015-03-30T11:38:18Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\n\nI have tested against 1.4.3 and 1.5.0 and I am getting NPE during the aggreagation below:\n\nMAPPINGS:\n\n<PRE>\n    \"user\": {\n      \"dynamic\": \"false\",\n      \"_timestamp\": {\n        \"enabled\": false,\n        \"format\": \"date_optional_time\"\n      },\n      \"_index\": {\n        \"enabled\": false\n      },\n      \"_ttl\": {\n        \"enabled\": false\n      },\n      \"_size\": {\n        \"enabled\": false\n      },\n      \"properties\": {\n        \"tags\": {\n          \"index\": \"not_analyzed\",\n          \"postings_format\": \"default\",\n          \"similarity\": \"default\",\n          \"fielddata\": {\n            \"loading\": \"lazy\"\n          },\n          \"type\": \"string\"\n        },\n        \"revenue_t\": {\n          \"type\": \"double\"\n        },\n        \"revenue_avgd\": {\n          \"type\": \"double\"\n        },\n        \"segments\": {\n          \"index\": \"not_analyzed\",\n          \"postings_format\": \"default\",\n          \"similarity\": \"default\",\n          \"fielddata\": {\n            \"loading\": \"lazy\"\n          },\n          \"type\": \"string\"\n        },\n        \"install_date\": {\n          \"format\": \"dateOptionalTime\",\n          \"type\": \"date\"\n        },\n        \"revenue_avgm\": {\n          \"type\": \"double\"\n        },\n        \"user_id\": {\n          \"index\": \"not_analyzed\",\n          \"postings_format\": \"default\",\n          \"similarity\": \"default\",\n          \"fielddata\": {\n            \"loading\": \"lazy\"\n          },\n          \"type\": \"string\"\n        },\n        \"slot\": {\n          \"type\": \"long\"\n        },\n        \"profile\": {\n          \"properties\": {\n            \"age\": {\n              \"type\": \"long\"\n            },\n            \"team\": {\n              \"index\": \"not_analyzed\",\n              \"postings_format\": \"default\",\n              \"similarity\": \"default\",\n              \"fielddata\": {\n                \"loading\": \"lazy\"\n              },\n              \"type\": \"string\"\n            }\n          }\n        }\n      },\n      \"_all\": {\n        \"enabled\": false\n      }\n    },\n\n\n    \"session\": {\n      \"dynamic\": \"false\",\n      \"_source\": {\n        \"enabled\": false\n      },\n      \"_routing\": {\n        \"required\": true\n      },\n      \"_timestamp\": {\n        \"enabled\": false,\n        \"format\": \"date_optional_time\"\n      },\n      \"_index\": {\n        \"enabled\": false\n      },\n      \"_ttl\": {\n        \"enabled\": false\n      },\n      \"_size\": {\n        \"enabled\": false\n      },\n      \"properties\": {\n        \"spid\": {\n          \"index\": \"not_analyzed\",\n          \"postings_format\": \"default\",\n          \"similarity\": \"default\",\n          \"fielddata\": {\n            \"loading\": \"lazy\"\n          },\n          \"type\": \"string\"\n        },\n        \"sts\": {\n          \"format\": \"dateOptionalTime\",\n          \"type\": \"date\"\n        }\n      },\n      \"_all\": {\n        \"enabled\": false\n      },\n      \"_parent\": {\n        \"type\": \"user\"\n      }\n    },\n    \n\n    \"event\": {\n      \"dynamic\": \"false\",\n      \"_source\": {\n        \"enabled\": false\n      },\n      \"_routing\": {\n        \"required\": true\n      },\n      \"_timestamp\": {\n        \"enabled\": false,\n        \"format\": \"date_optional_time\"\n      },\n      \"_index\": {\n        \"enabled\": false\n      },\n      \"_ttl\": {\n        \"enabled\": false\n      },\n      \"_size\": {\n        \"enabled\": false\n      },\n      \"properties\": {\n        \"con\": {\n          \"index\": \"not_analyzed\",\n          \"postings_format\": \"default\",\n          \"similarity\": \"default\",\n          \"fielddata\": {\n            \"loading\": \"lazy\"\n          },\n          \"type\": \"string\"\n        },\n        \"ets\": {\n          \"format\": \"dateOptionalTime\",\n          \"type\": \"date\"\n        },\n        \"data\": {\n          \"properties\": {\n            \"balance\": {\n              \"type\": \"double\"\n            },\n            \"level\": {\n              \"type\": \"long\"\n            },\n            \"page\": {\n              \"index\": \"not_analyzed\",\n              \"postings_format\": \"default\",\n              \"similarity\": \"default\",\n              \"fielddata\": {\n                \"loading\": \"lazy\"\n              },\n              \"type\": \"string\"\n            },\n            \"invoiceID\": {\n              \"index\": \"not_analyzed\",\n              \"postings_format\": \"default\",\n              \"similarity\": \"default\",\n              \"fielddata\": {\n                \"loading\": \"lazy\"\n              },\n              \"type\": \"string\"\n            },\n            \"tas\": {\n              \"type\": \"long\"\n            },\n            \"pid\": {\n              \"index\": \"not_analyzed\",\n              \"postings_format\": \"default\",\n              \"similarity\": \"default\",\n              \"fielddata\": {\n                \"loading\": \"lazy\"\n              },\n              \"type\": \"string\"\n            }\n          }\n        },\n        \"et\": {\n          \"index\": \"not_analyzed\",\n          \"postings_format\": \"default\",\n          \"similarity\": \"default\",\n          \"fielddata\": {\n            \"loading\": \"lazy\"\n          },\n          \"type\": \"string\"\n        }\n      },\n      \"_all\": {\n        \"enabled\": false\n      },\n      \"_parent\": {\n        \"type\": \"session\"\n      }\n    }\n\n</PRE>\n\n\nSAMPLE DATA:\n\nUSER:\n\n<PRE>\n{\n  \"_index\": \"testapp3\",\n  \"_type\": \"user\",\n  \"_id\": \"bD0CGpdVOAbF\",\n  \"_version\": 1,\n  \"_score\": 1,\n  \"_source\": {\n    \"user_id\": \"bD0CGpdVOAbF\",\n    \"slot\": 0,\n    \"segments\": [\n      \"yandas trol\",\n      \"dayisi bakan\"\n    ],\n    \"tags\": [\n      \"asia\"\n    ],\n    \"install_date\": \"2015-04-12T06:16:54.787Z\",\n    \"revenue_t\": 300.6897,\n    \"revenue_avgd\": 0,\n    \"revenue_avgm\": 0,\n    \"profile\": {\n      \"team\": \"karabukspor\",\n      \"age\": 34\n    }\n  }\n}\n</PRE>\n\n\nSESSION\n\n<PRE>\n{\n  \"_index\": \"testapp3\",\n  \"_type\": \"session\",\n  \"_id\": \"nKyJHGgCBl9t5oG7\",\n  \"_version\": 1,\n  \"_score\": 1,\n  \"_source\": {\n    \"spid\": \"4Jn7mOG6dtkrimdKQFUETmCD\",\n    \"sts\": \"2015-04-20T20:11:20.209Z\"\n  },\n  \"fields\": {\n    \"_parent\": \"bD0CGpdVOAbF\"\n  }\n}\n</PRE>\n\nEVENT:\n\n<PRE>\n{\n  \"_index\": \"testapp3\",\n  \"_type\": \"event\",\n  \"_id\": \"AUxqJOcTwN0lu_3PUVp2\",\n  \"_version\": 1,\n  \"_score\": 1,\n  \"_source\": {\n    \"et\": \"UserBalance\",\n    \"ets\": \"2015-04-20T20:23:20.209Z\",\n    \"con\": \"cellular\",\n    \"data\": {\n      \"balance\": 8.722086988665563\n    }\n  },\n  \"fields\": {\n    \"_parent\": \"nKyJHGgCBl9t5oG7\"\n  }\n}\n</PRE>\n\n\nQUERY:\n\n<PRE>\n{\n  \"query\": {\n    \"match_all\": {\n      \n    }\n  },\n  \"from\": 0,\n  \"size\": 10,\n  \"explain\": false,\n  \"version\": false,\n  \"aggs\": {\n    \"segments\": {\n      \"terms\": {\n        \"field\": \"segments\",\n        \"size\": 20\n      },\n      \"aggs\": {\n        \"to_session\": {\n          \"children\": {\n            \"type\": \"session\"\n          },\n          \"aggs\": {\n            \"to_event\": {\n              \"children\": {\n                \"type\": \"event\"\n              },\n              \"aggs\": {\n                \"filtered\": {\n                  \"filter\": {\n                    \"term\": {\n                      \"et\": \"UserBalance\"\n                    }\n                  },\n                  \"aggs\": {\n                    \"average_balance\": {\n                      \"avg\": {\n                        \"field\": \"data.balance\"\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n</PRE>\n\n\nERROR:\n\n<PRE>\n[2015-03-30 13:40:45,265][DEBUG][action.search.type       ] [Tagak the Leopard Lord] All shards failed for phase: [query]\norg.elasticsearch.search.query.QueryPhaseExecutionException: [testapp3][3]: query[ConstantScore(*:*)],from[0],size[10]: Query Failed [Failed to execute main query]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:163)\n        at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:286)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:297)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:231)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:228)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:559)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:724)\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.search.aggregations.bucket.children.ParentToChildrenAggregator.doPostCollection(ParentToChildrenAggregator.java:149)\n        at org.elasticsearch.search.aggregations.Aggregator.postCollection(Aggregator.java:335)\n        at org.elasticsearch.search.aggregations.bucket.children.ParentToChildrenAggregator.doPostCollection(ParentToChildrenAggregator.java:186)\n        at org.elasticsearch.search.aggregations.Aggregator.postCollection(Aggregator.java:335)\n        at org.elasticsearch.search.aggregations.Aggregator.postCollection(Aggregator.java:334)\n        at org.elasticsearch.search.aggregations.AggregationPhase$AggregationsCollector.postCollection(AggregationPhase.java:178)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:202)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:491)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:448)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:281)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:269)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:157)\n        ... 8 more\n\n</PRE>\n\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}