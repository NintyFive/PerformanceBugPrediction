[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/263846191","html_url":"https://github.com/elastic/elasticsearch/issues/21719#issuecomment-263846191","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21719","id":263846191,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Mzg0NjE5MQ==","user":{"login":"vanga","id":5126396,"node_id":"MDQ6VXNlcjUxMjYzOTY=","avatar_url":"https://avatars3.githubusercontent.com/u/5126396?v=4","gravatar_id":"","url":"https://api.github.com/users/vanga","html_url":"https://github.com/vanga","followers_url":"https://api.github.com/users/vanga/followers","following_url":"https://api.github.com/users/vanga/following{/other_user}","gists_url":"https://api.github.com/users/vanga/gists{/gist_id}","starred_url":"https://api.github.com/users/vanga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vanga/subscriptions","organizations_url":"https://api.github.com/users/vanga/orgs","repos_url":"https://api.github.com/users/vanga/repos","events_url":"https://api.github.com/users/vanga/events{/privacy}","received_events_url":"https://api.github.com/users/vanga/received_events","type":"User","site_admin":false},"created_at":"2016-11-30T11:04:13Z","updated_at":"2016-11-30T11:05:10Z","author_association":"NONE","body":"I am not sure if this is the write place to put this\r\nBut, I ran into something like this twice now\r\n\r\nI did following operations (I don't remember the order of these)\r\n\r\n\"Added new node\"\r\n\"Disabled allocation\"\r\n\"Added more nodes\"\r\n\"Excluded few nodes from shard allocation \"\r\n\"Changed # of replicas to 0\"\r\n\r\nI also had changed node awareness in between (disabled by setting awareness attribute to `null`)\r\n\r\nI ended up with unassigned shards even after reverting all cluster updates I did before.\r\nI looked at the disk and I could see that shard data is there. \r\nRouting table in cluster state says `NODE_LEFT` as the reason\r\n\r\nI waited for almost an hour, some shards didn't get allocated. I manually pinged `_cluster/reroute` which didn't make any difference.\r\n\r\nI had to restart one of the node where those unassigned shard data is there on disk. Even then some indices are still in unassigned state.\r\n\r\nRouting information for the shard that didn't get allocated even after restarting\r\n```\r\n               \"3\": [\r\n                  {\r\n                     \"state\": \"UNASSIGNED\",\r\n                     \"primary\": true,\r\n                     \"node\": null,\r\n                     \"relocating_node\": null,\r\n                     \"shard\": 3,\r\n                     \"index\": \"test\",\r\n                     \"recovery_source\": {\r\n                        \"type\": \"EXISTING_STORE\"\r\n                     },\r\n                     \"unassigned_info\": {\r\n                        \"reason\": \"NODE_LEFT\",\r\n                        \"at\": \"2016-11-30T09:05:10.817Z\",\r\n                        \"delayed\": false,\r\n                        \"details\": \"node_left[fWo-O27hRW-egfvtpQO-BQ]\",\r\n                        \"allocation_status\": \"no_valid_shard_copy\"\r\n                     }\r\n                  },\r\n```\r\ncurl -XGET 'http://localhost:9200/_shard_stores?pretty'\r\n```\r\n{\r\n  \"indices\" : {\r\n    \"test\" : {\r\n      \"shards\" : {\r\n        \"3\" : {\r\n          \"stores\" : [\r\n            {\r\n              \"fWo-O27hRW-egfvtpQO-BQ\" : {\r\n                \"name\" : \"data-primary-255684\",\r\n                \"ephemeral_id\" : \"aJV_xqKqR6i_QLC1lWortg\",\r\n                \"transport_address\" : \"10.0.34.17:9300\",\r\n                \"attributes\" : {\r\n                  \"rack_id\" : \"primary\"\r\n                }\r\n              },\r\n              \"allocation_id\" : \"45790dx0S9Sb2T7nHQnbGw\",\r\n              \"allocation\" : \"unused\"\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/263851509","html_url":"https://github.com/elastic/elasticsearch/issues/21719#issuecomment-263851509","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21719","id":263851509,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Mzg1MTUwOQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-11-30T11:30:49Z","updated_at":"2016-11-30T11:30:49Z","author_association":"CONTRIBUTOR","body":"Can you also provide the output of \r\n```\r\ncurl -XGET 'http://localhost:9200/_cluster/allocation/explain' -d'{\r\n  \"index\": \"test\",\r\n  \"shard\": 3,\r\n  \"primary\": true\r\n}'\r\n```\r\n\r\nAs workaround, if you're **absolutely sure** that only this one node has data for this shard (i.e. all nodes were available while running the `_shard_stores` command), you can use the `allocate_stale_primary` command (which is part of the `reroute` command, see https://www.elastic.co/guide/en/elasticsearch/reference/master/cluster-reroute.html ) to explicitly tell the system to chose the shard data on node `data-primary-255684` as primary copy. The risk with running the `allocate_stale_primary` command is that if the data on that node is not the most recent one (there exists another newer copy of the data somewhere else), you will experience data loss as the newer shard copy will be discarded.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/263854735","html_url":"https://github.com/elastic/elasticsearch/issues/21719#issuecomment-263854735","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21719","id":263854735,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Mzg1NDczNQ==","user":{"login":"vanga","id":5126396,"node_id":"MDQ6VXNlcjUxMjYzOTY=","avatar_url":"https://avatars3.githubusercontent.com/u/5126396?v=4","gravatar_id":"","url":"https://api.github.com/users/vanga","html_url":"https://github.com/vanga","followers_url":"https://api.github.com/users/vanga/followers","following_url":"https://api.github.com/users/vanga/following{/other_user}","gists_url":"https://api.github.com/users/vanga/gists{/gist_id}","starred_url":"https://api.github.com/users/vanga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vanga/subscriptions","organizations_url":"https://api.github.com/users/vanga/orgs","repos_url":"https://api.github.com/users/vanga/repos","events_url":"https://api.github.com/users/vanga/events{/privacy}","received_events_url":"https://api.github.com/users/vanga/received_events","type":"User","site_admin":false},"created_at":"2016-11-30T11:48:20Z","updated_at":"2016-12-15T05:09:48Z","author_association":"NONE","body":"I am doing some modifications to the cluster, so this output may have some irrelevant info\r\nhttps://gist.github.com/vanga/7ff86fc51127e2be42670cd4c78cd9ec\r\n\r\nMain index was fixed by restarting the node, not sure why this shard didn't get allocated even though I see corresponding files for this shard on disk.\r\n\r\n> you can use the allocate_stale_primary command (which is part of the reroute command, \r\n\r\nAfter doing this manually now its allocated.\r\nThanks.\r\n","performed_via_github_app":null}]