{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33350","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33350/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33350/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33350/events","html_url":"https://github.com/elastic/elasticsearch/issues/33350","id":356492024,"node_id":"MDU6SXNzdWUzNTY0OTIwMjQ=","number":33350,"title":"org.elasticsearch.action.search.SearchPhaseExecutionException while loading snapshot","user":{"login":"pieterlukasse","id":2900303,"node_id":"MDQ6VXNlcjI5MDAzMDM=","avatar_url":"https://avatars1.githubusercontent.com/u/2900303?v=4","gravatar_id":"","url":"https://api.github.com/users/pieterlukasse","html_url":"https://github.com/pieterlukasse","followers_url":"https://api.github.com/users/pieterlukasse/followers","following_url":"https://api.github.com/users/pieterlukasse/following{/other_user}","gists_url":"https://api.github.com/users/pieterlukasse/gists{/gist_id}","starred_url":"https://api.github.com/users/pieterlukasse/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pieterlukasse/subscriptions","organizations_url":"https://api.github.com/users/pieterlukasse/orgs","repos_url":"https://api.github.com/users/pieterlukasse/repos","events_url":"https://api.github.com/users/pieterlukasse/events{/privacy}","received_events_url":"https://api.github.com/users/pieterlukasse/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":905326255,"node_id":"MDU6TGFiZWw5MDUzMjYyNTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.6.10","name":"v5.6.10","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-09-03T12:46:13Z","updated_at":"2018-09-09T16:56:07Z","closed_at":"2018-09-09T16:56:07Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version**\r\n5.6.10 using docker. See yaml section from `docker-compose` below:\r\n```\r\nservices:\r\n  es-ot:\r\n    networks:\r\n    - ot-net\r\n    image: docker.elastic.co/elasticsearch/elasticsearch:5.6.10\r\n    ports:\r\n    - \"9200:9200\"\r\n    restart: always\r\n    volumes:\r\n    - /media/pieter/b250/opentargets/esdata5:/usr/share/elasticsearch/data/\r\n    environment:\r\n     - ES_JAVA_OPTS=-Xms6g -Xmx6g\r\n     - repositories.url.allowed_urls=https://storage.googleapis.com/*\r\n     - xpack.security.enabled=false\r\n    ulimits:\r\n      nofile:\r\n        soft: 65536\r\n        hard: 65536\r\n```\r\n\r\n**Plugins installed**: []\r\nSee dockerfile\r\n\r\n**JVM version**\r\nSee dockerfile\r\n\r\n**OS version** \r\nSee dockerfile\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhile restoring a snapshot into a new elasticsearch installation, I get the following error:\r\n```\r\nes-ot_1    | [2018-09-03T10:36:54,814][WARN ][r.suppressed             ] path: /18.08_evidence-data*/_search, params: {index=18.08_evidence-data*, timeout=10m}\r\nes-ot_1    | org.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\nes-ot_1    | \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:272) ~[elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:130) ~[elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:241) ~[elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:107) ~[elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.action.search.InitialSearchPhase.lambda$performPhaseOnShard$4(InitialSearchPhase.java:205) ~[elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.action.search.InitialSearchPhase$1.doRun(InitialSearchPhase.java:184) [elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:674) [elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.6.10.jar:5.6.10]\r\nes-ot_1    | \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_171]\r\nes-ot_1    | \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_171]\r\nes-ot_1    | \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_171]\r\n```\r\n**Steps to reproduce**:\r\n\r\n1) Register the repo to take the 18.08 snapshot from https://storage.googleapis.com/open-targets-data-releases :\r\n \r\n```\r\ncurl -XPUT 'localhost:9200/_snapshot/ot_repo?verify=false&pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"type\": \"url\",\r\n  \"settings\": {\r\n\t\"url\": \"https://storage.googleapis.com/open-targets-data-releases/18.08/18.08_snapshot/\"\r\n   }\r\n}\r\n'\r\n```\r\n\r\n2) Get snapshot name with:\r\n\r\n```\r\ncurl -i -H \"Accept: application/json\" http://localhost:9200/_snapshot/ot_repo/_all?pretty\r\n```\r\nThis returns something like:\r\n\r\n```\r\n{\r\n  \"snapshots\" : [\r\n    {\r\n      \"snapshot\" : \"curator-20180827215825\",\r\n      \"uuid\" : \"JySZfV8aSt6rV52xvC8Pkw\",\r\n      \"version_id\" : 5061099,\r\n      \"version\" : \"5.6.10\",\r\n      \"indices\" : [\r\n        \"18.08_mp-data\",\r\n...\r\n      ],\r\n      \"state\" : \"SUCCESS\",\r\n...\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\n3) Trigger the snapshot restore, using the snapshot name (in this example `curator-20180827215825`):\r\n\r\n```\r\ncurl -XPOST 'localhost:9200/_snapshot/ot_repo/curator-20180827215825/_restore?pretty'\r\n```\r\n\r\n4) After snapshot loading is done, the error posted above will appear in the ES logs.\r\n\r\n","closed_by":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"performed_via_github_app":null}