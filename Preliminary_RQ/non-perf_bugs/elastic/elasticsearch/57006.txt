{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57006","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57006/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57006/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57006/events","html_url":"https://github.com/elastic/elasticsearch/issues/57006","id":621946052,"node_id":"MDU6SXNzdWU2MjE5NDYwNTI=","number":57006,"title":"7.7.0 bug with _search and idle shards","user":{"login":"awick","id":427321,"node_id":"MDQ6VXNlcjQyNzMyMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/427321?v=4","gravatar_id":"","url":"https://api.github.com/users/awick","html_url":"https://github.com/awick","followers_url":"https://api.github.com/users/awick/followers","following_url":"https://api.github.com/users/awick/following{/other_user}","gists_url":"https://api.github.com/users/awick/gists{/gist_id}","starred_url":"https://api.github.com/users/awick/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/awick/subscriptions","organizations_url":"https://api.github.com/users/awick/orgs","repos_url":"https://api.github.com/users/awick/repos","events_url":"https://api.github.com/users/awick/events{/privacy}","received_events_url":"https://api.github.com/users/awick/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."},{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2020-05-20T17:22:21Z","updated_at":"2020-05-26T16:13:04Z","closed_at":"2020-05-26T16:13:04Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): Version: 7.7.0, Build: default/tar/81a1e9eda8e6183f5237786246f6dced26a10eaf/2020-05-12T02:01:37.602180Z, JVM: 14\r\n\r\n**Plugins installed**: [] None\r\n\r\n**JVM version** (`java -version`): Included\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux moloches01 3.10.0-1062.12.1.el7.YAHOO.20200205.52.x86_64 #1 SMP Wed Feb 5 22:45:50 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n7.7.0 seems to no longer wait for idle shards to be refreshed before responding to a _search query. 7.6.2 and previous versions did not have this issue.\r\n\r\n* So I have a index (dstats_v4) that I constantly overwrite documents in (1440 documents per moloch node, written every 5 seconds, wrapping around so always the same doc ids are used)\r\n* It does NOT have a refresh_interval set, so it should be taking advantage of the idle shard feature (https://www.elastic.co/guide/en/elasticsearch/reference/7.7/index-modules.html#dynamic-index-settings)\r\n* If we wait to search this index for a long period of time and then do a search, only some of the documents we know are there are returned.  so if we a _search?q=molochnode:test we should ALWAYS get 1440 documents, but we randomly get around 600-800, it almost looks like every other document is returned so it is NOT just the documents written during the period of not searching.  (I wondering if there is some idle + # of shards issue here, since we are using 2 shards)\r\n* If we repeat the search several times eventually it will return all 1440 documents and then will keep working\r\n* As a work around Mark had as set refresh_interval to 1s and that always works, even after wait a long period of time\r\n\r\nHere is our _settings\r\n```{\r\n      \"dstats_v4\" : {\r\n        \"settings\" : {\r\n          \"index\" : {\r\n            \"number_of_shards\" : \"2\",\r\n            \"auto_expand_replicas\" : \"0-3\",\r\n            \"provided_name\" : \"dstats_v4\",\r\n            \"creation_date\" : \"1565358628829\",\r\n            \"priority\" : \"50\",\r\n            \"number_of_replicas\" : \"3\",\r\n            \"uuid\" : \"muB0pZV4SYywXmxBcJEEGA\",\r\n            \"version\" : {\r\n              \"created\" : \"6080299\",\r\n              \"upgraded\" : \"7040299\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }```\r\n\r\n\r\n**Steps to reproduce**:\r\n\r\nHaven't been able to reproduce with standalone script yet\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}