{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46362","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46362/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46362/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46362/events","html_url":"https://github.com/elastic/elasticsearch/issues/46362","id":489522907,"node_id":"MDU6SXNzdWU0ODk1MjI5MDc=","number":46362,"title":"RestHighLevelClient - Error on sort string field","user":{"login":"medcl","id":64487,"node_id":"MDQ6VXNlcjY0NDg3","avatar_url":"https://avatars0.githubusercontent.com/u/64487?v=4","gravatar_id":"","url":"https://api.github.com/users/medcl","html_url":"https://github.com/medcl","followers_url":"https://api.github.com/users/medcl/followers","following_url":"https://api.github.com/users/medcl/following{/other_user}","gists_url":"https://api.github.com/users/medcl/gists{/gist_id}","starred_url":"https://api.github.com/users/medcl/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/medcl/subscriptions","organizations_url":"https://api.github.com/users/medcl/orgs","repos_url":"https://api.github.com/users/medcl/repos","events_url":"https://api.github.com/users/medcl/events{/privacy}","received_events_url":"https://api.github.com/users/medcl/received_events","type":"User","site_admin":false},"labels":[{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"assignees":[{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-09-05T04:36:06Z","updated_at":"2019-10-08T01:38:40Z","closed_at":"2019-10-07T13:26:05Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nv7.3.1\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nUsing RestHighLevelClient to perform search request, sorting on number field is ok, sorting on string field will throw exception. it seems the client only try to decode the returned sort field as number.\r\n\r\n**Steps to reproduce**:\r\n\r\nHere is the sample document:\r\n```\r\n{\r\n          \"times\" : 1,\r\n          \"ip\" : \"10.1.35.240\",\r\n          \"updateTime\" : \"2019-03-19T23:34:39.000Z\",\r\n          \"interface\" : \"Ethernet111/1/31\"\r\n        }\r\n```\r\nHere is the sample request:\r\n```\r\n\tSearchRequest searchRequest = new SearchRequest();\r\n        SearchSourceBuilder searchSourceBuilder = new SearchSourceBuilder();\r\n        searchRequest.indices(Constant.NETALERT_LOG_TRANS_INDEX_NAME+\"-*\");\r\n        searchSourceBuilder.query(QueryBuilders.matchAllQuery()).from(0).size(5);\r\n        searchSourceBuilder.sort(\"updateTime\",SortOrder.DESC);\r\n```\r\nThis will be throw exception, as a good case, sort on `times` will be successful.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n\t\t\r\nMessage: GatewayApp running failed\r\nError: xxxx.xxxx.common.error.UnknownException: BeanCreationException: Error creating bean with name 'netAlertBoardTransService': Invocation of init method failed; nested exception is ElasticsearchStatusException[Elasticsearch exception [type=search_phase_execution_exception, reason=]]; nested: ElasticsearchException[Elasticsearch exception [type=class_cast_exception, reason=class java.lang.Long cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Long is in module java.base of loader 'bootstrap'; org.apache.lucene.util.BytesRef is in unnamed module of loader 'app')]];\r\n\tat xxxx.xxxx.common.error.BaseException.translate(BaseException.java:46)\r\n\tat xxxx.xxxx.impl.GatewayApp.main(GatewayApp.java:27)\r\nCaused by: org.springframework.beans.factory.BeanCreationException: Error creating bean with name 'netAlertBoardTransService': Invocation of init method failed; nested exception is ElasticsearchStatusException[Elasticsearch exception [type=search_phase_execution_exception, reason=]]; nested: ElasticsearchException[Elasticsearch exception [type=class_cast_exception, reason=class java.lang.Long cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Long is in module java.base of loader 'bootstrap'; org.apache.lucene.util.BytesRef is in unnamed module of loader 'app')]];\r\n\tat org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor.postProcessBeforeInitialization(InitDestroyAnnotationBeanPostProcessor.java:137)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.applyBeanPostProcessorsBeforeInitialization(AbstractAutowireCapableBeanFactory.java:409)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1620)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.doCreateBean(AbstractAutowireCapableBeanFactory.java:555)\r\n\tat org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.createBean(AbstractAutowireCapableBeanFactory.java:483)\r\n\tat org.springframework.beans.factory.support.AbstractBeanFactory$1.getObject(AbstractBeanFactory.java:306)\r\n\tat org.springframework.beans.factory.support.DefaultSingletonBeanRegistry.getSingleton(DefaultSingletonBeanRegistry.java:230)\r\n\tat org.springframework.beans.factory.support.AbstractBeanFactory.doGetBean(AbstractBeanFactory.java:302)\r\n\tat org.springframework.beans.factory.support.AbstractBeanFactory.getBean(AbstractBeanFactory.java:197)\r\n\tat org.springframework.beans.factory.support.DefaultListableBeanFactory.preInstantiateSingletons(DefaultListableBeanFactory.java:761)\r\n\tat org.springframework.context.support.AbstractApplicationContext.finishBeanFactoryInitialization(AbstractApplicationContext.java:867)\r\n\tat org.springframework.context.support.AbstractApplicationContext.refresh(AbstractApplicationContext.java:543)\r\n\tat org.springframework.boot.context.embedded.EmbeddedWebApplicationContext.refresh(EmbeddedWebApplicationContext.java:122)\r\n\tat org.springframework.boot.SpringApplication.refresh(SpringApplication.java:693)\r\n\tat org.springframework.boot.SpringApplication.refreshContext(SpringApplication.java:360)\r\n\tat org.springframework.boot.SpringApplication.run(SpringApplication.java:303)\r\n\tat xxxx.xxxx.gateway.impl.GatewayApp.main(GatewayApp.java:23)\r\nCaused by: ElasticsearchStatusException[Elasticsearch exception [type=search_phase_execution_exception, reason=]]; nested: ElasticsearchException[Elasticsearch exception [type=class_cast_exception, reason=class java.lang.Long cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Long is in module java.base of loader 'bootstrap'; org.apache.lucene.util.BytesRef is in unnamed module of loader 'app')]];\r\n\tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:177)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:1727)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseResponseException(RestHighLevelClient.java:1704)\r\n\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1467)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:1424)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:1394)\r\n\tat org.elasticsearch.client.RestHighLevelClient.search(RestHighLevelClient.java:930)\r\n\tat xxxx.xxxx.log.impl.timer.NetAlertBoardTransService.getLastTranLogTime(NetAlertBoardTransService.java:145)\r\n\tat xxxx.xxxx.log.impl.timer.NetAlertBoardTransService.init(NetAlertBoardTransService.java:55)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor$LifecycleElement.invoke(InitDestroyAnnotationBeanPostProcessor.java:366)\r\n\tat org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor$LifecycleMetadata.invokeInitMethods(InitDestroyAnnotationBeanPostProcessor.java:311)\r\n\tat org.springframework.beans.factory.annotation.InitDestroyAnnotationBeanPostProcessor.postProcessBeforeInitialization(InitDestroyAnnotationBeanPostProcessor.java:134)\r\n\t... 16 more\r\n\tSuppressed: org.elasticsearch.client.ResponseException: method [POST], host [https://10.1.240.240:9200], URI [/xxxx-xxxx-*/_search?typed_keys=true&ignore_unavailable=false&expand_wildcards=open&allow_no_indices=true&ignore_throttled=true&search_type=query_then_fetch&batched_reduce_size=512&ccs_minimize_roundtrips=true], status line [HTTP/1.1 500 Internal Server Error]\r\n{\"error\":{\"root_cause\":[],\"type\":\"search_phase_execution_exception\",\"reason\":\"\",\"phase\":\"fetch\",\"grouped\":true,\"failed_shards\":[],\"caused_by\":{\"type\":\"class_cast_exception\",\"reason\":\"class java.lang.Long cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Long is in module java.base of loader 'bootstrap'; org.apache.lucene.util.BytesRef is in unnamed module of loader 'app')\"}},\"status\":500}\r\n\t\tat org.elasticsearch.client.RestClient.convertResponse(RestClient.java:253)\r\n\t\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:231)\r\n\t\tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:205)\r\n\t\tat org.elasticsearch.client.RestHighLevelClient.internalPerformRequest(RestHighLevelClient.java:1454)\r\n\t\t... 28 more\r\nCaused by: ElasticsearchException[Elasticsearch exception [type=class_cast_exception, reason=class java.lang.Long cannot be cast to class org.apache.lucene.util.BytesRef (java.lang.Long is in module java.base of loader 'bootstrap'; org.apache.lucene.util.BytesRef is in unnamed module of loader 'app')]]\r\n\tat org.elasticsearch.ElasticsearchException.innerFromXContent(ElasticsearchException.java:491)\r\n\tat org.elasticsearch.ElasticsearchException.fromXContent(ElasticsearchException.java:402)\r\n\tat org.elasticsearch.ElasticsearchException.innerFromXContent(ElasticsearchException.java:432)\r\n\tat org.elasticsearch.ElasticsearchException.failureFromXContent(ElasticsearchException.java:598)\r\n\tat org.elasticsearch.rest.BytesRestResponse.errorFromXContent(BytesRestResponse.java:169)\r\n\t... 31 more\r\n\r\n********************************************************************************\r\n\r\nProcess finished with exit code 1\r\n```","closed_by":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"performed_via_github_app":null}