[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426610390","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-426610390","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":426610390,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjYxMDM5MA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-10-03T11:59:56Z","updated_at":"2018-10-03T11:59:56Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/431592850","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-431592850","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":431592850,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMTU5Mjg1MA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-10-20T15:43:06Z","updated_at":"2018-10-20T15:43:06Z","author_association":"MEMBER","body":"I have this reproduced => fixing now to not allow restoring a newer index version to an older datanode version.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/431652838","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-431652838","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":431652838,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMTY1MjgzOA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-10-21T09:27:41Z","updated_at":"2018-10-21T09:27:41Z","author_association":"MEMBER","body":"I talked about this with @DaveCTurner and the behavior here seems to not necessarily be a bug.\r\n\r\nWe are not actually restoring any data to the old data node in a mixed cluster, all we're doing is acknowledging the restore which puts the newer index in the state and prevent old datanodes from joining.\r\n\r\nWith the change I suggested in #34676 we're preventing putting starting the restore during rolling upgrade which may be less confusing but also reduces functionality during rolling upgrade (which seems to work fine if you have new version data nodes present).\r\n\r\n=> maybe the behavior is ok as is?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/431764252","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-431764252","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":431764252,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMTc2NDI1Mg==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-22T07:50:55Z","updated_at":"2018-10-22T07:50:55Z","author_association":"CONTRIBUTOR","body":"I'd like more information from @Bukhtawar because I tried the steps given to reproduce this and got the expected error when trying to restore a snapshot taken on a 6.4.2 cluster into a 6.4.1 cluster:\r\n\r\n```\r\nPOST /_snapshot/my_backup/snapshot_1/_restore\r\n# 500 Internal Server Error\r\n# {\r\n#   \"status\": 500,\r\n#   \"error\": {\r\n#     \"reason\": \"[my_backup:snapshot_1/qHahtNWXQ3elpe8rYqHEkA] the snapshot was created with Elasticsearch version [6.4.2] which is higher than the version of this node [6.4.1]\",\r\n#     \"root_cause\": [\r\n#       {\r\n#         \"reason\": \"[my_backup:snapshot_1/qHahtNWXQ3elpe8rYqHEkA] the snapshot was created with Elasticsearch version [6.4.2] which is higher than the version of this node [6.4.1]\",\r\n#         \"type\": \"snapshot_restore_exception\"\r\n#       }\r\n#     ],\r\n#     \"type\": \"snapshot_restore_exception\"\r\n#   }\r\n# }\r\n```\r\n\r\nTo reproduce this needed a cluster that comprised a mix of 6.4.1 and 6.4.2 version nodes. We only expect a cluster of mixed versions to occur during a rolling upgrade, and in this situation we don't expect there to be more 6.4.1 nodes joining the cluster - in fact there are other things you can do during a rolling upgrade that will block the older nodes from joining the cluster, such as simply creating an index, and the solution in all cases is to upgrade the removed node. I think perhaps the docs could be clearer on this subject, but I can't see that we should change the behaviour here.\r\n\r\nDid this occur during a rolling uprgade, and if so why were there more 6.4.1 nodes joining the cluster?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/432587423","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-432587423","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":432587423,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMjU4NzQyMw==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2018-10-24T09:39:23Z","updated_at":"2018-10-24T09:39:23Z","author_association":"CONTRIBUTOR","body":"@DaveCTurner Thanks for taking a look. \r\n\r\nWe needed to urgently resize our clusters by adding additional capacity which didn't work coz the restore of a higher version of index from another snapshot repository failed the membership checks and subsequently forced us to delete that index.\r\nWell we did try to restore a 6.3.2 index onto a 6.3.1 node which worked without the need for a mixed cluster\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/432593556","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-432593556","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":432593556,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMjU5MzU1Ng==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-24T09:58:07Z","updated_at":"2018-10-24T09:58:07Z","author_association":"CONTRIBUTOR","body":"> Well we did try to restore a 6.3.2 index onto a 6.3.1 node which worked without the need for a mixed cluster\r\n\r\nI cannot currently see how to reproduce this in a single-version cluster. My attempt, described above, failed with an exception. Can you explain how to reproduce this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433602217","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-433602217","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":433602217,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzYwMjIxNw==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2018-10-27T08:31:22Z","updated_at":"2018-10-27T08:31:22Z","author_association":"CONTRIBUTOR","body":"* Start-up a single-node ES 6.2.4 cluster (say N1) . Create an index (say idx-624) on it and add some documents. The index would have the version as 6.2.4 in its metadata.\r\n* Start-up another single-node ES 6.2.3 cluster (say N2). Allow N1 to join this cluster. Ensure that the master of the cluster is still N2, the older version ES cluster. The combined cluster now would also show index: idx-624.\r\n* Initiate a snapshot on this cluster (say S1). The S3 file structure would look as the below.\r\n    * Root level metadata will contain the master version which is 6.2.3\r\n    * Index metadata for idx-624 will contain the index version which is 6.2.4\r\n\r\nRoot\r\n|-snap-<snapID>.dat -> Root level metadata file contains the master ES version 6.2.3\r\n|-indexes\r\n    |-<index-id corresponding to idx-624>\r\n        |-meta-<snapID>.dat -> Contains the index version 6.2.4\r\n        \r\n\r\n* Restore S1 onto an ES cluster in version ES-6.2.3. During restore, ES validates the root level metadata and restore will succeed.\r\n* ES cluster now contains an index idx-624 of a higher version than the current ES version.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/433602995","html_url":"https://github.com/elastic/elasticsearch/issues/34264#issuecomment-433602995","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34264","id":433602995,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMzYwMjk5NQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-27T08:46:57Z","updated_at":"2018-10-27T08:47:40Z","author_association":"CONTRIBUTOR","body":"Aha, thanks, that helps. This is a very strange sequence of operations - you are essentially merging two distinct clusters together, which only works today because of the lenience that dangling indices provide. Indeed when I try this I see the vital log message as the later-versioned index is brought into the earlier-versioned cluster:\r\n\r\n```\r\n[2018-10-27T09:37:36,225][INFO ][o.e.g.LocalAllocateDangledIndices] [VNUG9FA] auto importing dangled indices [[i/aU903bhuQ_-V1_9t-XC99A]/OPEN] from [{u13ixhL}{u13ixhL1SPK-fcYmr3AVQg}{yetE4T05SjeCbUFlxdyxBw}{127.0.0.1}{127.0.0.1:9301}{ml.machine_memory=17179869184, ml.max_open_jobs=20, xpack.installed=true, ml.enabled=true}]\r\n```\r\n\r\nI think we should not import the dangling 6.4.2 index in this case, because as soon as that has happened no more 6.4.1 nodes can join the cluster - there is no need to snapshot and restore anything. Good catch.","performed_via_github_app":null}]