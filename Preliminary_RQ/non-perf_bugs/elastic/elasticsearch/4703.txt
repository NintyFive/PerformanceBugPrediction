{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4703","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4703/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4703/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4703/events","html_url":"https://github.com/elastic/elasticsearch/issues/4703","id":25479957,"node_id":"MDU6SXNzdWUyNTQ3OTk1Nw==","number":4703,"title":"Scrolling with has_child filter returns no hits on 2nd request","user":{"login":"joedj","id":250501,"node_id":"MDQ6VXNlcjI1MDUwMQ==","avatar_url":"https://avatars2.githubusercontent.com/u/250501?v=4","gravatar_id":"","url":"https://api.github.com/users/joedj","html_url":"https://github.com/joedj","followers_url":"https://api.github.com/users/joedj/followers","following_url":"https://api.github.com/users/joedj/following{/other_user}","gists_url":"https://api.github.com/users/joedj/gists{/gist_id}","starred_url":"https://api.github.com/users/joedj/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/joedj/subscriptions","organizations_url":"https://api.github.com/users/joedj/orgs","repos_url":"https://api.github.com/users/joedj/repos","events_url":"https://api.github.com/users/joedj/events{/privacy}","received_events_url":"https://api.github.com/users/joedj/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":74293669,"node_id":"MDU6TGFiZWw3NDI5MzY2OQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.11","name":"v0.90.11","color":"DDDDDD","default":false,"description":null},{"id":74899026,"node_id":"MDU6TGFiZWw3NDg5OTAyNg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0","name":"v1.0.0","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2014-01-13T06:33:43Z","updated_at":"2018-06-13T16:08:39Z","closed_at":"2014-01-20T10:12:10Z","author_association":"NONE","active_lock_reason":null,"body":"When using scroll with a has_child filter, the initial request returns the correct total number of hits, but subsequent requests return no hits.\n\nIt looks like this problem was introduced in 0.90.6, and still occurs in 0.90.10.  0.90.5 works as expected.\n\nThe number of documents seems to play a part - in my initial test cases with only 2 parent documents, I couldn't reproduce the issue.  However, creating 100 parents does reliably reproduce it.  In my testing, 8 parent documents worked fine, but 9 did not.\n\nIt sounds very similar to the issue mentioned here: http://elasticsearch-users.115913.n3.nabble.com/No-hit-using-scan-scroll-with-has-parent-filter-td4047236.html\n\nHere's a test script (requires jq(1) to grab the scroll ID from the first JSON result):\n\n``` bash\n#!/bin/sh\n\nHOST='localhost:9200'\nINDEX='test_scroll_jj'\nCURL=\"curl -q --ipv4 --silent --show-error --fail\"\n\n$CURL -XDELETE \"$HOST/${INDEX}?pretty=true\" >/dev/null\n$CURL -XPOST \"$HOST/${INDEX}/?pretty=true\" -d '\n{\n    \"mappings\": {\n        \"homes\":{\n            \"_parent\":{\n                \"type\" : \"person\"\n            }\n        }\n    }\n}' >/dev/null\n\nfor x in {1..100}; do # in my testing, 8 docs works, 9 fails\n    $CURL -XPUT \"$HOST/${INDEX}/person/$x/?pretty=true\" -d '{}' >/dev/null\n    $CURL -XPOST \"$HOST/${INDEX}/homes?parent=$x&pretty=true\" -d '{}' >/dev/null\ndone\n\n$CURL -XPOST \"$HOST/${INDEX}/_refresh?pretty=true\" >/dev/null\n\necho \"REQUEST ONE:\"\nSCROLL_RESULT=$($CURL -v -XPOST \"http://$HOST/${INDEX}/person/_search?pretty=true&scroll=30s\" -d'\n{\n    \"size\" : 1,\n    \"fields\" : [\"_id\"],\n    \"query\" : {\n        \"filtered\" : {\n            \"filter\" : {\n                \"has_child\" : {\n                    \"type\" : \"homes\",\n                    \"query\" : {\n                        \"match_all\" : {}\n                    }\n                }\n            }\n        }\n    }\n}')\necho $SCROLL_RESULT\n\nscroll_id=$(echo $SCROLL_RESULT | jq -r '.[\"_scroll_id\"]')\n\necho\necho \"REQUEST TWO:\"\n$CURL -v \"http://$HOST/_search/scroll?scroll=30s&scroll_id=$scroll_id&pretty=true\"\n```\n\nThe failing output on 0.90.10:\n\n```\n/tmp|⇒  /tmp/scrollbug.sh\nREQUEST ONE:\n* About to connect() to localhost port 9200 (#0)\n*   Trying 127.0.0.1...\n* Adding handle: conn: 0x7fb832006e00\n* Adding handle: send: 0\n* Adding handle: recv: 0\n* Curl_addHandleToPipeline: length: 1\n* - Conn 0 (0x7fb832006e00) send_pipe: 1, recv_pipe: 0\n* Connected to localhost (127.0.0.1) port 9200 (#0)\n> POST /test_scroll_jj/person/_search?pretty=true&scroll=30s HTTP/1.1\n> User-Agent: curl/7.32.0\n> Host: localhost:9200\n> Accept: */*\n> Content-Length: 321\n> Content-Type: application/x-www-form-urlencoded\n>\n} [data not shown]\n* upload completely sent off: 321 out of 321 bytes\n< HTTP/1.1 200 OK\n< Content-Type: application/json; charset=UTF-8\n< Content-Length: 520\n<\n{ [data not shown]\n* Connection #0 to host localhost left intact\n{ \"_scroll_id\" : \"cXVlcnlUaGVuRmV0Y2g7NTs2OkM5SXlBenNyU0lXR21uX3JsN25XcHc7NzpDOUl5QXpzclNJV0dtbl9ybDduV3B3Ozg6QzlJeUF6c3JTSVdHbW5fcmw3bldwdzs5OkM5SXlBenNyU0lXR21uX3JsN25XcHc7MTA6QzlJeUF6c3JTSVdHbW5fcmw3bldwdzswOw==\", \"took\" : 5, \"timed_out\" : false, \"_shards\" : { \"total\" : 5, \"successful\" : 5, \"failed\" : 0 }, \"hits\" : { \"total\" : 100, \"max_score\" : 1.0, \"hits\" : [ { \"_index\" : \"test_scroll_jj\", \"_type\" : \"person\", \"_id\" : \"2\", \"_score\" : 1.0 } ] } }\n\nREQUEST TWO:\n* About to connect() to localhost port 9200 (#0)\n*   Trying 127.0.0.1...\n* Adding handle: conn: 0x7f8589806e00\n* Adding handle: send: 0\n* Adding handle: recv: 0\n* Curl_addHandleToPipeline: length: 1\n* - Conn 0 (0x7f8589806e00) send_pipe: 1, recv_pipe: 0\n* Connected to localhost (127.0.0.1) port 9200 (#0)\n> GET /_search/scroll?scroll=30s&scroll_id=cXVlcnlUaGVuRmV0Y2g7NTs2OkM5SXlBenNyU0lXR21uX3JsN25XcHc7NzpDOUl5QXpzclNJV0dtbl9ybDduV3B3Ozg6QzlJeUF6c3JTSVdHbW5fcmw3bldwdzs5OkM5SXlBenNyU0lXR21uX3JsN25XcHc7MTA6QzlJeUF6c3JTSVdHbW5fcmw3bldwdzswOw==&pretty=true HTTP/1.1\n> User-Agent: curl/7.32.0\n> Host: localhost:9200\n> Accept: */*\n>\n< HTTP/1.1 200 OK\n< Content-Type: application/json; charset=UTF-8\n< Content-Length: 410\n<\n{\n  \"_scroll_id\" : \"cXVlcnlUaGVuRmV0Y2g7NTs2OkM5SXlBenNyU0lXR21uX3JsN25XcHc7NzpDOUl5QXpzclNJV0dtbl9ybDduV3B3Ozg6QzlJeUF6c3JTSVdHbW5fcmw3bldwdzs5OkM5SXlBenNyU0lXR21uX3JsN25XcHc7MTA6QzlJeUF6c3JTSVdHbW5fcmw3bldwdzswOw==\",\n  \"took\" : 0,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 0,\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n```\n\nAnd the expected output as per 0.90.5:\n\n```\n/tmp|⇒  /tmp/scrollbug.sh\nREQUEST ONE:\n* About to connect() to localhost port 9200 (#0)\n*   Trying 127.0.0.1...\n* Adding handle: conn: 0x7fd04a006e00\n* Adding handle: send: 0\n* Adding handle: recv: 0\n* Curl_addHandleToPipeline: length: 1\n* - Conn 0 (0x7fd04a006e00) send_pipe: 1, recv_pipe: 0\n* Connected to localhost (127.0.0.1) port 9200 (#0)\n> POST /test_scroll_jj/person/_search?pretty=true&scroll=30s HTTP/1.1\n> User-Agent: curl/7.32.0\n> Host: localhost:9200\n> Accept: */*\n> Content-Length: 321\n> Content-Type: application/x-www-form-urlencoded\n>\n} [data not shown]\n* upload completely sent off: 321 out of 321 bytes\n< HTTP/1.1 200 OK\n< Content-Type: application/json; charset=UTF-8\n< Content-Length: 523\n<\n{ [data not shown]\n* Connection #0 to host localhost left intact\n{ \"_scroll_id\" : \"cXVlcnlUaGVuRmV0Y2g7NTsyMTpILV9IUWU2MlRrUzQyd2JRYzZLS3dROzIzOkgtX0hRZTYyVGtTNDJ3YlFjNktLd1E7MjI6SC1fSFFlNjJUa1M0MndiUWM2S0t3UTsyNDpILV9IUWU2MlRrUzQyd2JRYzZLS3dROzI1OkgtX0hRZTYyVGtTNDJ3YlFjNktLd1E7MDs=\", \"took\" : 9, \"timed_out\" : false, \"_shards\" : { \"total\" : 5, \"successful\" : 5, \"failed\" : 0 }, \"hits\" : { \"total\" : 100, \"max_score\" : 1.0, \"hits\" : [ { \"_index\" : \"test_scroll_jj\", \"_type\" : \"person\", \"_id\" : \"2\", \"_score\" : 1.0 } ] } }\n\nREQUEST TWO:\n* About to connect() to localhost port 9200 (#0)\n*   Trying 127.0.0.1...\n* Adding handle: conn: 0x7f8a92006e00\n* Adding handle: send: 0\n* Adding handle: recv: 0\n* Curl_addHandleToPipeline: length: 1\n* - Conn 0 (0x7f8a92006e00) send_pipe: 1, recv_pipe: 0\n* Connected to localhost (127.0.0.1) port 9200 (#0)\n> GET /_search/scroll?scroll=30s&scroll_id=cXVlcnlUaGVuRmV0Y2g7NTsyMTpILV9IUWU2MlRrUzQyd2JRYzZLS3dROzIzOkgtX0hRZTYyVGtTNDJ3YlFjNktLd1E7MjI6SC1fSFFlNjJUa1M0MndiUWM2S0t3UTsyNDpILV9IUWU2MlRrUzQyd2JRYzZLS3dROzI1OkgtX0hRZTYyVGtTNDJ3YlFjNktLd1E7MDs=&pretty=true HTTP/1.1\n> User-Agent: curl/7.32.0\n> Host: localhost:9200\n> Accept: */*\n>\n< HTTP/1.1 200 OK\n< Content-Type: application/json; charset=UTF-8\n< Content-Length: 523\n<\n{\n  \"_scroll_id\" : \"cXVlcnlUaGVuRmV0Y2g7NTsyMTpILV9IUWU2MlRrUzQyd2JRYzZLS3dROzIzOkgtX0hRZTYyVGtTNDJ3YlFjNktLd1E7MjI6SC1fSFFlNjJUa1M0MndiUWM2S0t3UTsyNDpILV9IUWU2MlRrUzQyd2JRYzZLS3dROzI1OkgtX0hRZTYyVGtTNDJ3YlFjNktLd1E7MDs=\",\n  \"took\" : 2,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 100,\n    \"max_score\" : 1.0,\n    \"hits\" : [ {\n      \"_index\" : \"test_scroll_jj\",\n      \"_type\" : \"person\",\n      \"_id\" : \"7\",\n      \"_score\" : 1.0\n    } ]\n  }\n}\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}