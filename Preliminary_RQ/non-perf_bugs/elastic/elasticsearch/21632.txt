{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21632","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21632/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21632/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21632/events","html_url":"https://github.com/elastic/elasticsearch/issues/21632","id":190111558,"node_id":"MDU6SXNzdWUxOTAxMTE1NTg=","number":21632,"title":"Nested filter does not work for fields within a subobject","user":{"login":"jpblair","id":10817512,"node_id":"MDQ6VXNlcjEwODE3NTEy","avatar_url":"https://avatars3.githubusercontent.com/u/10817512?v=4","gravatar_id":"","url":"https://api.github.com/users/jpblair","html_url":"https://github.com/jpblair","followers_url":"https://api.github.com/users/jpblair/followers","following_url":"https://api.github.com/users/jpblair/following{/other_user}","gists_url":"https://api.github.com/users/jpblair/gists{/gist_id}","starred_url":"https://api.github.com/users/jpblair/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpblair/subscriptions","organizations_url":"https://api.github.com/users/jpblair/orgs","repos_url":"https://api.github.com/users/jpblair/repos","events_url":"https://api.github.com/users/jpblair/events{/privacy}","received_events_url":"https://api.github.com/users/jpblair/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-11-17T17:27:58Z","updated_at":"2016-11-17T18:09:57Z","closed_at":"2016-11-17T18:09:57Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 1.7.5\r\n\r\n**Plugins installed**: marvel, cloud-aws, bigdesk\r\n\r\n**JVM version**: 1.8.0_40\r\n\r\n**OS version**: CentOS 6.6\r\n\r\n**Description of the problem including expected versus actual behavior**:  Using the `nested` filter does not appear to work when the filter uses fields that are within a subobject of the nested object (ie, not top-level).\r\n\r\n**Steps to reproduce**:\r\n 1. Create a new index (POST to `[cluster]/nested-filter-test`).\r\n 2. POST the following payload to `/[cluster/nested-filter-test/test-type` to create a type `test-type` with a nested field in its mapping:\r\n```\r\n{\r\n\t\"properties\": {\r\n\t\t\"nestedField\": {\r\n\t\t\t\"type\":\"nested\",\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"topLevel\": {\r\n\t\t\t\t\t\"type\": \"string\",\r\n\t\t\t\t\t\"index\": \"not_analyzed\"\r\n\t\t\t\t},\r\n\t\t\t\t\"subobject\": {\r\n\t\t\t\t\t\"properties\": {\r\n\t\t\t\t\t\t\"subfield\": {\r\n\t\t\t\t\t\t\t\"type\": \"string\",\r\n\t\t\t\t\t\t\t\"index\": \"not_analyzed\"\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n 3. POST to `[cluster]/nested-filter-test/test-type` with the following payload to index a document:\r\n```\r\n{\r\n\t\"nestedField\": [\r\n\t\t{\r\n\t\t\t\"topLevel\": \"value1\",\r\n\t\t\t\"subobject\": {\r\n\t\t\t\t\"subfield\": \"value2\"\r\n\t\t\t}\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"topLevel\": \"value3\",\r\n\t\t\t\"subobject\": {\r\n\t\t\t\t\"subfield\": \"value4\"\r\n\t\t\t}\r\n\t\t}\r\n\t]\r\n}\r\n```\r\n4. Query for the document using the nested filter - put the following payload in Sense for `GET _search`, using the URL `[cluster]/nested-filter-test/test-type`:\r\n```\r\n{\r\n    \"filter\": {\r\n\t\t\"nested\" : {\r\n\t\t\t\"filter\" : {\r\n\t\t\t\t\"term\" : {\r\n\t\t\t\t\t\"subobject.subfield\" : \"value2\"\r\n\t\t\t\t}\r\n\t\t\t},\r\n\t\t\t\"path\" : \"nestedField\"\r\n\t\t}\r\n\t}\r\n}\r\n```\r\n5. The indexed document should be returned since the value of `subobject.subfield` is \"value2\" for the first object in `nestedField`, but it is not.  However, if you change the term filter to the following (ie, query on a top-level field of the nested object), the document is returned:\r\n```\r\n\"term\" : {\r\n\t\"topLevel\" : \"value1\"\r\n}\r\n```\r\n\r\nI first posted this on the Elastic forums [here](https://discuss.elastic.co/t/querying-on-a-subobject-field-within-a-nested-object/65533), but did not get a response.  Thanks for your help.\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}