[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137757175","html_url":"https://github.com/elastic/elasticsearch/issues/13345#issuecomment-137757175","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345","id":137757175,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzc1NzE3NQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2015-09-04T14:49:30Z","updated_at":"2015-09-04T14:49:30Z","author_association":"MEMBER","body":"This is tricky one. In order to check the correctness of the mapping MetaDataIndexUpgradeService [loads and applies one type](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/cluster/metadata/MetaDataIndexUpgradeService.java#L329) at a time and checks it for conflicts with already loaded mappings. If it loads the parent first and then the child, it gets Mapper conflict exception as expected and fails to start the node. However, if it loads the child first and then parent, no exception is thrown and index gets successfully loaded and marked as upgraded to 2.0.0. The problem is that types are stored in map and their order is unpredictable and can change on over load. So, if somebody starts the node enough times, it will eventually get the child type before the parent type and upgrade the index. \n\nIt's possible to simulate the issue by running the following script on 2.0.0-beta1, which recreates the conflicting mapping within 2.0.0-beta1.\n\n```\ncurl -XDELETE \"localhost:9200/test?pretty\"\ncurl -XPUT \"localhost:9200/test?pretty\"\ncurl -XPUT \"localhost:9200/test/child/_mapping?pretty\" -d '{\n    \"child\": {\n        \"_parent\": {\n            \"type\": \"parent\",\n            \"fielddata\": {\n                \"loading\": \"eager_global_ordinals\"\n            }\n        }\n    }\n}'\ncurl -XPUT \"localhost:9200/test/parent/_mapping?pretty\" -d '{\n    \"parent\": {}\n}'\ncurl -XGET \"localhost:9200/test/_mapping?pretty\"\n```\n\nIf you try to put this mapping as a whole into 2.0.0 it fails:\n\n```\ncurl -XDELETE \"localhost:9200/test2?pretty\"\ncurl -XPUT \"localhost:9200/test2?pretty\" -d '{\n    \"mappings\": {\n        \"parent\": {},\n        \"child\": {\n            \"_parent\": {\n                \"type\": \"parent\",\n                \"fielddata\": {\n                    \"loading\": \"eager_global_ordinals\"\n                }\n            }\n        }\n    }\n}'\n```\n\nWe discussed it with @martijnvg and he suggested that it's a version of #13169. We might also want to look into making the mapping upgrade procedure more consistent. Maybe apply mappings in alphabetical order?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/137823129","html_url":"https://github.com/elastic/elasticsearch/issues/13345#issuecomment-137823129","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345","id":137823129,"node_id":"MDEyOklzc3VlQ29tbWVudDEzNzgyMzEyOQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2015-09-04T19:02:18Z","updated_at":"2015-09-04T19:02:18Z","author_association":"MEMBER","body":"After some research, it looks like applying types in alphabetical order will not really help us that much. If we could figure out initial type creation order we could have followed it every time we validate the mapping. But since this order is not preserved, there is little value in enforcing a completely different order later on. It looks like the only way to prevent the issue above is to make sure that mapper works the same way independently of the order of merged types. So, unless somebody has some better ideas I am going to close this issue.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/138086139","html_url":"https://github.com/elastic/elasticsearch/issues/13345#issuecomment-138086139","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13345","id":138086139,"node_id":"MDEyOklzc3VlQ29tbWVudDEzODA4NjEzOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-09-06T13:33:59Z","updated_at":"2015-09-06T13:33:59Z","author_association":"CONTRIBUTOR","body":"@imotov agreed.  I think this is only an issue for the `_parent` field, which should be dealt with in #13169\n","performed_via_github_app":null}]