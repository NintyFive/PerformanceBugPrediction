{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52850","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52850/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52850/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52850/events","html_url":"https://github.com/elastic/elasticsearch/issues/52850","id":571679684,"node_id":"MDU6SXNzdWU1NzE2Nzk2ODQ=","number":52850,"title":"Match All Percolate Query Returns Unexpected Values","user":{"login":"marcoserrato","id":20644139,"node_id":"MDQ6VXNlcjIwNjQ0MTM5","avatar_url":"https://avatars1.githubusercontent.com/u/20644139?v=4","gravatar_id":"","url":"https://api.github.com/users/marcoserrato","html_url":"https://github.com/marcoserrato","followers_url":"https://api.github.com/users/marcoserrato/followers","following_url":"https://api.github.com/users/marcoserrato/following{/other_user}","gists_url":"https://api.github.com/users/marcoserrato/gists{/gist_id}","starred_url":"https://api.github.com/users/marcoserrato/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marcoserrato/subscriptions","organizations_url":"https://api.github.com/users/marcoserrato/orgs","repos_url":"https://api.github.com/users/marcoserrato/repos","events_url":"https://api.github.com/users/marcoserrato/events{/privacy}","received_events_url":"https://api.github.com/users/marcoserrato/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-02-26T21:44:55Z","updated_at":"2020-06-17T20:30:00Z","closed_at":"2020-06-17T20:30:00Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.2, 6.8.2, 7.6.0\r\n\r\n**Plugins installed**: []\r\n\r\nI use the elasticsearch docker images: docker.elastic.co/elasticsearch/elasticsearch-oss:x.x.x\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nFirst of, I'll mention that this bug is similar to https://github.com/elastic/elasticsearch/issues/42361 which was supposedly fixed in 6.8.1 but I am able to reproduce similar behavior in higher versions. \r\nWhen using nested docs and a percolate query with a `match_all` clause, I believe the percolate query is matching against the nested docs which is being manifested as negative indices in the `_percolator_document_slot` field. \r\n\r\nAnother note: I tested this on version 6.3.3 and am unable to reproduce it, so this must have been introduced in later versions.\r\n\r\n**Steps to reproduce**:\r\n\r\nCreate a new index with a mapping for a nested doc containing two text fields and a query field for the percolator\r\n\r\n<details>\r\n<summary> Collapse/Expand </summary>\r\n\r\n```json\r\nPUT test-index\r\n{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"blob\": {\r\n        \"type\": \"nested\",\r\n        \"properties\": {\r\n          \"inner_one\": {\r\n            \"type\": \"text\"\r\n          },\r\n          \"inner_two\": {\r\n            \"type\": \"text\"\r\n          }\r\n        }\r\n      },\r\n      \"query\": {\r\n        \"type\": \"percolator\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\n----\r\n\r\nCreate a percolate match_all percolate query\r\n<details>\r\n<summary> Collapse/Expand </summary>\r\n\r\n```json\r\nPUT /test-index/_doc/2?refresh\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"match_all\": {}\r\n        }\r\n      ]\r\n    }\r\n  }\r\n```\r\n</details>\r\n\r\n----\r\n\r\nPercolate some documents\r\n<details>\r\n<summary> Collapse/Expand </summary>\r\n\r\n```json\r\nGET /test-index/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"random\": \"hello\"\r\n        },\r\n        {\r\n          \"random\": \"hello2\",\r\n          \"blob\": [\r\n            {\r\n              \"inner_one\": \"none\",\r\n              \"inner_two\": \"ntwo\"\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\nAnd the response: \r\n\r\n\r\n```json\r\n{\r\n  ...\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 1,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test-index\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"query\" : {\r\n            \"bool\" : {\r\n              \"must\" : [\r\n                {\r\n                  \"match_all\" : { }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        },\r\n        \"fields\" : {\r\n          \"_percolator_document_slot\" : [\r\n            0,\r\n            -2,\r\n            1\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n-----\r\n\r\nI believe this is exactly the behavior described in the previously mentioned bug since increasing the number of nested docs in the percolated document increases the occurrences of negative indices.\r\n\r\nFor instance another percolate query \r\n<details>\r\n<summary> Collapse/Expand </summary>\r\n\r\n```json\r\nGET /test-index/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"random\": \"hello\"\r\n        },\r\n        {\r\n          \"random\": \"hello2\",\r\n          \"blob\": [\r\n            {\r\n              \"inner_one\": \"none\",\r\n              \"inner_two\": \"ntwo\"\r\n            },\r\n             {\r\n              \"inner_one\": \"none\",\r\n              \"inner_two\": \"ntwo\"\r\n            },\r\n             {\r\n              \"inner_one\": \"none\",\r\n              \"inner_two\": \"ntwo\"\r\n            },\r\n             {\r\n              \"inner_one\": \"none\",\r\n              \"inner_two\": \"ntwo\"\r\n            },\r\n             {\r\n              \"inner_one\": \"none\",\r\n              \"inner_two\": \"ntwo\"\r\n            }\r\n          ]\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n</details>\r\n\r\nreturns the following\r\n\r\n```json\r\n{\r\n  ...\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 1,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test-index\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"query\" : {\r\n            \"bool\" : {\r\n              \"must\" : [\r\n                {\r\n                  \"match_all\" : { }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        },\r\n        \"fields\" : {\r\n          \"_percolator_document_slot\" : [\r\n            0,\r\n            -2,\r\n            -2,\r\n            -2,\r\n            -2,\r\n            -2,\r\n            1\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}