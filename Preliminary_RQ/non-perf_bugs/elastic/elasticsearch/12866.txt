{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12866","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12866/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12866/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12866/events","html_url":"https://github.com/elastic/elasticsearch/issues/12866","id":100899354,"node_id":"MDU6SXNzdWUxMDA4OTkzNTQ=","number":12866,"title":"Terms aggregation unexpected results","user":{"login":"pablod","id":786832,"node_id":"MDQ6VXNlcjc4NjgzMg==","avatar_url":"https://avatars0.githubusercontent.com/u/786832?v=4","gravatar_id":"","url":"https://api.github.com/users/pablod","html_url":"https://github.com/pablod","followers_url":"https://api.github.com/users/pablod/followers","following_url":"https://api.github.com/users/pablod/following{/other_user}","gists_url":"https://api.github.com/users/pablod/gists{/gist_id}","starred_url":"https://api.github.com/users/pablod/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pablod/subscriptions","organizations_url":"https://api.github.com/users/pablod/orgs","repos_url":"https://api.github.com/users/pablod/repos","events_url":"https://api.github.com/users/pablod/events{/privacy}","received_events_url":"https://api.github.com/users/pablod/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-08-14T00:17:41Z","updated_at":"2015-08-14T13:23:10Z","closed_at":"2015-08-14T13:23:10Z","author_association":"NONE","active_lock_reason":null,"body":"We are facing an unexpected behavior with a term aggregation.\nWe are getting different results whether we use a term facet or its term aggregation equivalent.\n\nSteps to reproduce:\n#### Test case 1\n\n**_Add  some test data:**_\n\n```\ncat << EOF | curl -X POST http://localhost:9200/test/mention --data-binary @-\n{\n  \"mention\": {\n    \"hasMedia\" : true,\n    \"original\": {\n      \"hasMedia\": false\n    }\n  }\n}\nEOF\n```\n\n**_Term facet and aggregation for the same field:**_\n\n```\ncat << EOF | curl -X POST --data-binary @- 'http://localhost:9200/test/mention/_search?search_type=count&pretty'\n{\n  \"facets\" : {\n    \"mention.hasMedia\" : {\n      \"terms\" : {\n        \"field\" : \"mention.hasMedia\"\n      }\n    }\n  },\n  \"aggregations\" : {\n    \"mention.hasMedia\" : {\n      \"terms\" : {\n        \"field\" : \"mention.hasMedia\"\n      }\n    }\n  }\n}\nEOF\n```\n\n**_Results:**_*\n\n```\n{\n  \"aggregations\": {\n    \"mention.hasMedia\": {\n      \"buckets\": [\n        {\n          \"doc_count\": 1,\n          \"key\": \"F\"\n        }\n      ],\n      \"sum_other_doc_count\": 0,\n      \"doc_count_error_upper_bound\": 0\n    }\n  },\n  \"facets\": {\n    \"mention.hasMedia\": {\n      \"terms\": [\n        {\n          \"count\": 1,\n          \"term\": \"T\"\n        }\n      ],\n      \"other\": 0,\n      \"total\": 1,\n      \"missing\": 0,\n      \"_type\": \"terms\"\n    }\n  },\n  \"hits\": {\n    \"hits\": [],\n    \"max_score\": 0,\n    \"total\": 1\n  },\n  \"_shards\": {\n    \"failed\": 0,\n    \"successful\": 5,\n    \"total\": 5\n  },\n  \"timed_out\": false,\n  \"took\": 6\n}\n```\n\nWe would expect both terms facet and aggregation results to show count/doc_count: 1 and key/term: \"T\".\n\nWhat I found more peculiar is that if you change the \"hasMedia\" field name for lets say \"hasLinks\" the results are the expected ones. Take a look at this next test case.\n#### Test case 2\n\n**_Sample data with changed field name (from hasMedia to hasLinks):**_\n\n```\ncat << EOF | curl -X POST http://localhost:9200/test/mentionlinks --data-binary @-\n{\n  \"mention\": {\n    \"hasLinks\" : true,\n    \"original\": {\n      \"hasLinks\": false\n    }\n  }\n}\nEOF\n```\n\n**_Same facet and aggregation for the new field name:**_\n\n```\ncat << EOF | curl -X POST -d @- 'http://localhost:9200/test/mentionlinks/_search?search_type=count&pretty'\n{\n  \"facets\" : {\n    \"mention.hasLinks\" : {\n      \"terms\" : {\n        \"field\" : \"mention.hasLinks\"\n      }\n    }\n  },\n  \"aggregations\" : {\n    \"mention.hasLinks\" : {\n      \"terms\" : {\n        \"field\" : \"mention.hasLinks\"\n      }\n    }\n  }\n}\nEOF\n```\n\n**_New results:**_\n\n```\n{\n  \"aggregations\": {\n    \"mention.hasLinks\": {\n      \"buckets\": [\n        {\n          \"doc_count\": 1,\n          \"key\": \"T\"\n        }\n      ],\n      \"sum_other_doc_count\": 0,\n      \"doc_count_error_upper_bound\": 0\n    }\n  },\n  \"facets\": {\n    \"mention.hasLinks\": {\n      \"terms\": [\n        {\n          \"count\": 1,\n          \"term\": \"T\"\n        }\n      ],\n      \"other\": 0,\n      \"total\": 1,\n      \"missing\": 0,\n      \"_type\": \"terms\"\n    }\n  },\n  \"hits\": {\n    \"hits\": [],\n    \"max_score\": 0,\n    \"total\": 1\n  },\n  \"_shards\": {\n    \"failed\": 0,\n    \"successful\": 5,\n    \"total\": 5\n  },\n  \"timed_out\": false,\n  \"took\": 3\n}\n```\n\nAs you can see the results are now the expected ones. Showing count/doc_count: 1 and key/field: \"T\" in both facet and aggregation. So the issue seems to be related to field names in the doc?.\n\nIm running 1.7.1 out of the box.\n\nAny help will be greatly appreciated.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}