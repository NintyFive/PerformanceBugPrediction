[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/494819592","html_url":"https://github.com/elastic/elasticsearch/issues/42361#issuecomment-494819592","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361","id":494819592,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NDgxOTU5Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-05-22T14:10:27Z","updated_at":"2019-05-22T14:10:27Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/495678101","html_url":"https://github.com/elastic/elasticsearch/issues/42361#issuecomment-495678101","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361","id":495678101,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NTY3ODEwMQ==","user":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"created_at":"2019-05-24T15:29:28Z","updated_at":"2019-05-24T15:37:56Z","author_association":"CONTRIBUTOR","body":"@ismael-hasan @jimczi  has identified what is the problem and proposed a temporary workaround until we fix this issue in the next 6.x release.\r\n\r\nThe problem is nested documents which are separate Lucene documents are not excluded during query time.  A temporary workaround for this issue is to modify your document to add another filter to exclude nested documents. The filter will be must exists on `_primary_term` field, as only parent documents have `_primary_term` field:\r\n\r\n```js\r\nPUT test1/percolatorquery/1?refresh\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"constant_score\": {\r\n            \"filter\": {\r\n              \"bool\": {\r\n                \"must\": {\r\n                  \"exists\": {\r\n                    \"field\": \"_primary_term\"\r\n                  }\r\n                },\r\n                \"must_not\": [\r\n                  {\r\n                    \"exists\": {\r\n                      \"field\": \"someText\",\r\n                      \"boost\": 1.0\r\n                    }\r\n                  }\r\n                ],\r\n                \"adjust_pure_negative\": true,\r\n                \"boost\": 1.0\r\n              }\r\n            },\r\n            \"boost\": 100.0\r\n          }\r\n        }\r\n      ],\r\n      \"adjust_pure_negative\": true,\r\n      \"boost\": 1.0\r\n    }\r\n  }\r\n}\r\n\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/495682222","html_url":"https://github.com/elastic/elasticsearch/issues/42361#issuecomment-495682222","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361","id":495682222,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NTY4MjIyMg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-05-24T15:41:18Z","updated_at":"2019-05-24T15:41:18Z","author_association":"MEMBER","body":"Unfortunately the workaround doesn't work, the `_primary_term` field is not listed in the ES mapping so the query doesn't return any document even when it should :(. Another workaround would be to change the `_primary_term` to any field that appears in all root documents and never in nested fields but there are no such field in the example.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/495688685","html_url":"https://github.com/elastic/elasticsearch/issues/42361#issuecomment-495688685","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361","id":495688685,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5NTY4ODY4NQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-05-24T15:59:52Z","updated_at":"2019-05-24T15:59:52Z","author_association":"MEMBER","body":"Here's another simple workaround:\r\nthe percolator doesn't apply the right logic when the score of the query is needed so for use cases where the score of documents is not needed it is possible to bypass the bug by providing a different sort order. The following query for instance will effectively filter nested documents even in 6.x:\r\n````\r\n{\r\n\t\"query\": {\r\n\t\t\"percolate\": {\r\n\t\t\t\"field\": \"query\",\r\n\t\t\t\"documents\": [{\r\n\t\t\t\t\t\"fullName\": \"test\",\r\n\t\t\t\t\t\"document\": {\r\n\t\t\t\t\t\t\"number\": \"test\"\r\n\t\t\t\t\t}\r\n\t\t\t\t}\r\n\t\t\t],\r\n\t\t\t\"boost\": 1.0\r\n\t\t}\r\n\t},\r\n\t\"sort\": \"_doc\"\r\n}\r\n````\r\nAs Mayya said we'll work on a fix but we wanted to find workarounds for this bug first.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/499589963","html_url":"https://github.com/elastic/elasticsearch/issues/42361#issuecomment-499589963","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361","id":499589963,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5OTU4OTk2Mw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2019-06-06T17:24:40Z","updated_at":"2019-06-06T17:24:40Z","author_association":"MEMBER","body":"This is fixed by #42554, hence closing","performed_via_github_app":null}]