{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13230","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13230/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13230/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13230/events","html_url":"https://github.com/elastic/elasticsearch/issues/13230","id":104157317,"node_id":"MDU6SXNzdWUxMDQxNTczMTc=","number":13230,"title":"inner_hits from has_parent not populated when _parent field requested","user":{"login":"mbuhot","id":336840,"node_id":"MDQ6VXNlcjMzNjg0MA==","avatar_url":"https://avatars3.githubusercontent.com/u/336840?v=4","gravatar_id":"","url":"https://api.github.com/users/mbuhot","html_url":"https://github.com/mbuhot","followers_url":"https://api.github.com/users/mbuhot/followers","following_url":"https://api.github.com/users/mbuhot/following{/other_user}","gists_url":"https://api.github.com/users/mbuhot/gists{/gist_id}","starred_url":"https://api.github.com/users/mbuhot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbuhot/subscriptions","organizations_url":"https://api.github.com/users/mbuhot/orgs","repos_url":"https://api.github.com/users/mbuhot/repos","events_url":"https://api.github.com/users/mbuhot/events{/privacy}","received_events_url":"https://api.github.com/users/mbuhot/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-09-01T00:09:07Z","updated_at":"2018-02-14T13:26:41Z","closed_at":"2016-01-28T13:59:44Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Using elasticsearch 1.7.1.\nWhen `\"fields\" : [\"_parent\"]` is included in a query, it stops the results of `\"has_parent\" : { ...,  \"inner_hits\" : {}}` being included in results.\n\nMinimal repro script that demonstrates the problem:\n\n```\n#! /bin/bash\n\nSERVER=\"localhost:9200\"\n\ncurl -w \"\\n\" -X DELETE \"$SERVER/my_index\"\ncurl -w \"\\n\" -X PUT \"$SERVER/my_index\"\ncurl -w \"\\n\" -X PUT \"$SERVER/my_index/_mapping/parent_doc_type\" -d '{ \"parent_doc_type\" : { \"properties\" : { \"name\" : { \"type\" : \"string\" } } } }'\ncurl -w \"\\n\" -X PUT \"$SERVER/my_index/_mapping/child_type\" -d '{ \"child_type\" : { \"properties\" : { \"name\" : { \"type\": \"string\" } }, \"_parent\" : { \"type\": \"parent_doc_type\" } } }'\ncurl -w \"\\n\" -X POST \"$SERVER/my_index/parent_doc_type/parent_doc\" -d '{ \"name\" : \"joe\" }'\ncurl -w \"\\n\" -X POST \"$SERVER/my_index/child_type/chid_doc?parent=parent_doc&routing=parent_doc\" -d '{ \"name\" : \"jack\" }'\n\nsleep 1\n\necho \"contains parent id but not inner hits:\"\ncurl -w \"\\n\" -X POST \"$SERVER/my_index/child_type/_search\" -d ' \n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"parent_doc_type\",\n      \"query\": { \"match_all\": {} },\n      \"inner_hits\" : {}\n    }\n  },\n  \"fields\": [\"_source\", \"_parent\"]\n}'\n\necho \"removing _parent field causes inner hits to be populated:\"\ncurl -w \"\\n\" -X POST \"$SERVER/my_index/child_type/_search\" -d '\n{\n  \"query\": {\n    \"has_parent\": {\n      \"parent_type\": \"parent_doc_type\",\n      \"query\": { \"match_all\": {} },\n      \"inner_hits\" : {}\n    }\n  },\n  \"fields\": [\"_source\"]\n}'\n```\n\nThe output of the script is:\n\n```\ncontains parent id but not inner hits:\n{  \n  \"took\":2,\n  \"timed_out\":false,\n  \"_shards\":{  \n    \"total\":5,\n    \"successful\":5,\n    \"failed\":0\n  },\n  \"hits\":{  \n    \"total\":1,\n    \"max_score\":1.0,\n    \"hits\":[  \n      {  \n        \"_index\":\"my_index\",\n        \"_type\":\"child_type\",\n        \"_id\":\"chid_doc\",\n        \"_score\":1.0,\n        \"_source\":{  \n          \"name\":\"jack\"\n        },\n        \"fields\":{  \n          \"_parent\":\"parent_doc\"\n        },\n        \"inner_hits\":{  \n          \"parent_doc_type\":{  \n            \"hits\":{  \n              \"total\":0,\n              \"max_score\":null,\n              \"hits\":[  \n\n              ]\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n\nremoving _parent field causes inner hits to be populated:\n{  \n  \"took\":2,\n  \"timed_out\":false,\n  \"_shards\":{  \n    \"total\":5,\n    \"successful\":5,\n    \"failed\":0\n  },\n  \"hits\":{  \n    \"total\":1,\n    \"max_score\":1.0,\n    \"hits\":[  \n      {  \n        \"_index\":\"my_index\",\n        \"_type\":\"child_type\",\n        \"_id\":\"chid_doc\",\n        \"_score\":1.0,\n        \"_source\":{  \n          \"name\":\"jack\"\n        },\n        \"inner_hits\":{  \n          \"parent_doc_type\":{  \n            \"hits\":{  \n              \"total\":1,\n              \"max_score\":1.0,\n              \"hits\":[  \n                {  \n                  \"_index\":\"my_index\",\n                  \"_type\":\"parent_doc_type\",\n                  \"_id\":\"parent_doc\",\n                  \"_score\":1.0,\n                  \"_source\":{  \n                    \"name\":\"joe\"\n                  }\n                }\n              ]\n            }\n          }\n        }\n      }\n    ]\n  }\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}