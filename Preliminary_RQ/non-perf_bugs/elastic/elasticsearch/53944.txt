{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53944","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53944/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53944/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53944/events","html_url":"https://github.com/elastic/elasticsearch/issues/53944","id":585929138,"node_id":"MDU6SXNzdWU1ODU5MjkxMzg=","number":53944,"title":"java.io.IOException: could not remove the following files ","user":{"login":"xlogin","id":7158075,"node_id":"MDQ6VXNlcjcxNTgwNzU=","avatar_url":"https://avatars0.githubusercontent.com/u/7158075?v=4","gravatar_id":"","url":"https://api.github.com/users/xlogin","html_url":"https://github.com/xlogin","followers_url":"https://api.github.com/users/xlogin/followers","following_url":"https://api.github.com/users/xlogin/following{/other_user}","gists_url":"https://api.github.com/users/xlogin/gists{/gist_id}","starred_url":"https://api.github.com/users/xlogin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xlogin/subscriptions","organizations_url":"https://api.github.com/users/xlogin/orgs","repos_url":"https://api.github.com/users/xlogin/repos","events_url":"https://api.github.com/users/xlogin/events{/privacy}","received_events_url":"https://api.github.com/users/xlogin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-03-23T04:55:06Z","updated_at":"2020-03-23T08:59:12Z","closed_at":"2020-03-23T08:59:12Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Feature request -->\r\n\r\n**Describe the feature**:   I created a backup repository to report an error。\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.8.6\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): jdk-13.0.1+9\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): centos 7   kernel： 5.5.4-1.el7.elrepo.x86_64\r\n\r\n I use the official docker image file  “ docker.elastic.co/elasticsearch/elasticsearch-oss:6.8.6 ” in the K8S。\r\n\r\n 1. I set the \"path.repo\" to /mnt and mounted the container's /mnt path to the local /mnt  directory, \r\n 2. While I mounted the NFS Shared storage to the local /mnt directory.\r\n 3. I mount the same shared filesystem to the same location on all master and data nodes. \r\n\r\nHere's what I did：\r\n```\r\n curl -H 'Content-Type: application/json' -XPUT https://elasticsearch.root.com/_snapshot/2020-03-22 -d '\r\n{\r\n    \"type\": \"fs\",\r\n    \"settings\": {\r\n        \"location\": \"/mnt/2020-03-22\",\r\n        \"max_snapshot_bytes_per_sec\": \"50mb\",\r\n        \"max_restore_bytes_per_sec\": \"50mb\",\r\n        \"compress\":true\r\n    }\r\n}'\r\n```\r\n\r\n`{\"error\":{\"root_cause\":[{\"type\":\"repository_verification_exception\",\"reason\":\"[2020-03-22] cannot delete test data at \"}],\"type\":\"repository_verification_exception\",\"reason\":\"[2020-03-22] cannot delete test data at \",\"caused_by\":{\"type\":\"i_o_exception\",\"reason\":\"could not remove the following files (in the order of attempts):\\n   /mnt/2020-03-22/tests-bROfi9MOQOy8Xr4RifViWg: java.nio.file.DirectoryNotEmptyException: /mnt/2020-03-22/tests-bROfi9MOQOy8Xr4RifViWg\\n\"}},\"status\":500}`\r\n\r\n\r\nThe application reports an error message：\r\n\r\n```\r\n[2020-03-23T04:53:19,783][WARN ][r.suppressed             ] [es-cluster-elasticsearch-client-74c7b45d67-52l7m] path: /_snapshot/2020-03-22, params: {repository=2020-03-22}\r\norg.elasticsearch.transport.RemoteTransportException: [es-cluster-elasticsearch-master-0][172.20.0.45:9300][cluster:admin/repository/put]\r\nCaused by: org.elasticsearch.repositories.RepositoryVerificationException: [2020-03-22] cannot delete test data at \r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.endVerification(BlobStoreRepository.java:644) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat org.elasticsearch.repositories.RepositoriesService$3.lambda$onResponse$1(RepositoriesService.java:238) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:681) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:830) [?:?]\r\nCaused by: java.io.IOException: could not remove the following files (in the order of attempts):\r\n   /mnt/2020-03-22/tests-bROfi9MOQOy8Xr4RifViWg: java.nio.file.DirectoryNotEmptyException: /mnt/2020-03-22/tests-bROfi9MOQOy8Xr4RifViWg\r\n\r\n\tat org.elasticsearch.core.internal.io.IOUtils.rm(IOUtils.java:197) ~[elasticsearch-core-6.8.6.jar:6.8.6]\r\n\tat org.elasticsearch.common.blobstore.fs.FsBlobStore.delete(FsBlobStore.java:82) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat org.elasticsearch.repositories.blobstore.BlobStoreRepository.endVerification(BlobStoreRepository.java:642) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat org.elasticsearch.repositories.RepositoriesService$3.lambda$onResponse$1(RepositoriesService.java:238) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:681) ~[elasticsearch-6.8.6.jar:6.8.6]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) ~[?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) ~[?:?]\r\n\tat java.lang.Thread.run(Thread.java:830) ~[?:?]\r\n```\r\n\r\n\r\n```\r\n[root@es-cluster-elasticsearch-data-0 mnt]# ll 2020-03-22/tests-bROfi9MOQOy8Xr4RifViWg/\r\ntotal 2\r\n-rw-rw-r-- 1 elasticsearch root 22 Mar 23 04:53 data-UoFTkreDTLm4bJmDcXppfQ.dat\r\n-rw-rw-r-- 1 elasticsearch root 22 Mar 23 04:53 data-sgmWV0csRUqteCDdXQQ5tw.dat\r\n-rw-rw-r-- 1 elasticsearch root 22 Mar 23 04:53 data-ydD6f6WfRVylSItGi0go0w.dat\r\n[root@es-cluster-elasticsearch-data-0 mnt]# ll -d /mnt/\r\ndrwxr-xr-x 3 elasticsearch elasticsearch 4096 Mar 23 04:49 /mnt/\r\n[root@es-cluster-elasticsearch-data-0 mnt]# \r\n```\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}