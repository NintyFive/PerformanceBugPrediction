{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17296","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17296/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17296/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17296/events","html_url":"https://github.com/elastic/elasticsearch/issues/17296","id":143064329,"node_id":"MDU6SXNzdWUxNDMwNjQzMjk=","number":17296,"title":"Reindex and update-by-query \"refresh\" url parameter can cause a refresh for all indices","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":302749677,"node_id":"MDU6TGFiZWwzMDI3NDk2Nzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.3.0","name":"v2.3.0","color":"dddddd","default":false,"description":null},{"id":342561351,"node_id":"MDU6TGFiZWwzNDI1NjEzNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.4.0","name":"v2.4.0","color":"dddddd","default":false,"description":null},{"id":246685314,"node_id":"MDU6TGFiZWwyNDY2ODUzMTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-alpha1","name":"v5.0.0-alpha1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":0,"created_at":"2016-03-23T19:58:00Z","updated_at":"2018-02-13T19:43:50Z","closed_at":"2016-03-23T22:13:27Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3, 2.x, and master branches (probably, only checked 2.3 but I'm pretty sure)\n\n**JVM version**: \n\n```\nmanyair:elasticsearch-2.3.0 manybubbles$ java -version\njava version \"1.8.0_51\"\nJava(TM) SE Runtime Environment (build 1.8.0_51-b16)\nJava HotSpot(TM) 64-Bit Server VM (build 25.51-b03, mixed mode)\n```\n\n**OS version**:\n\n```\nmanyair:elasticsearch-2.3.0 manybubbles$ uname -mrs\nDarwin 14.5.0 x86_64\n```\n\n10.10.5 (14F1605)\n\n**Description of the problem including expected versus actual behavior**:\n\n``` bash\n# Build an index with some docs\ncurl -XDELETE localhost:9200/test\nfor i in $(seq 1 1000); do\n  curl -XPOST localhost:9200/test/test -d'{\"tags\": [\"bannanas\"]}'\n  echo\ndone\ncurl -XPOST localhost:9200/test/_refresh\n\n# This should be fast\ncurl -XPOST 'localhost:9200/test/_update_by_query?pretty&refresh' -d'{\n  \"query\": {\n    \"bool\": {\n      \"must\": [ {\"match\": {\"tags\": \"bannanas\"}} ],\n      \"must_not\": [ {\"match\": {\"tags\": \"chocolate\"}} ]\n    }\n  },\n  \"script\": {\n    \"inline\": \"ctx._source.tags += \\\"chocolate\\\"\"\n  }\n}'\n\n# But repeat this and it tries to refresh all indexes.\ncurl -XPOST 'localhost:9200/test/_update_by_query?pretty&refresh' -d'{\n  \"query\": {\n    \"bool\": {\n      \"must\": [ {\"match\": {\"tags\": \"bannanas\"}} ],\n      \"must_not\": [ {\"match\": {\"tags\": \"chocolate\"}} ]\n    }\n  },\n  \"script\": {\n    \"inline\": \"ctx._source.tags += \\\"chocolate\\\"\"\n  }\n}'\n```\n\nThat last command should instead refresh no indices. It is kind of hard to tell if it has refreshed all indices or none other than the it takes longer. On my laptop with the test data I have loaded it takes 60 seconds to refresh all indices (that seems like a long time but that is another issue). If you leave the `refresh` off of the url then update-by-query completes in 2 milliseconds.\n","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}