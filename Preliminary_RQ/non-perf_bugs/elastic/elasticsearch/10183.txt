{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10183","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10183/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10183/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10183/events","html_url":"https://github.com/elastic/elasticsearch/issues/10183","id":63206976,"node_id":"MDU6SXNzdWU2MzIwNjk3Ng==","number":10183,"title":"Snapshot sometimes lose some shards data","user":{"login":"aqlu","id":5010463,"node_id":"MDQ6VXNlcjUwMTA0NjM=","avatar_url":"https://avatars0.githubusercontent.com/u/5010463?v=4","gravatar_id":"","url":"https://api.github.com/users/aqlu","html_url":"https://github.com/aqlu","followers_url":"https://api.github.com/users/aqlu/followers","following_url":"https://api.github.com/users/aqlu/following{/other_user}","gists_url":"https://api.github.com/users/aqlu/gists{/gist_id}","starred_url":"https://api.github.com/users/aqlu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aqlu/subscriptions","organizations_url":"https://api.github.com/users/aqlu/orgs","repos_url":"https://api.github.com/users/aqlu/repos","events_url":"https://api.github.com/users/aqlu/events{/privacy}","received_events_url":"https://api.github.com/users/aqlu/received_events","type":"User","site_admin":false},"labels":[{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-03-20T10:42:24Z","updated_at":"2015-03-21T17:22:35Z","closed_at":"2015-03-21T14:30:21Z","author_association":"NONE","active_lock_reason":null,"body":"I used 1.4.2 version of elasticsearch,  each index is 10 shards,  when use snapshot to backup indices sometimes lose shards. \n\nSome of the information listed below：\n\n```\n[elasticsearch@lin-mongo-65-182 indices] curl -XPUT 'localhost:9200/_snapshot/log_backup/snapshot-logstash-2015.03.15_20150320-160201?wait_for_completion=true&pretty' -d '{\n       \"indices\":\"logstash-2015.03.15\"\n }'\n{\n  \"snapshot\" : {\n    \"snapshot\" : \"snapshot-logstash-2015.03.15_20150320-160201\",\n    \"indices\" : [ \"logstash-2015.03.15\" ],\n    \"state\" : \"SUCCESS\",\n    \"start_time\" : \"2015-03-20T08:35:41.641Z\",\n    \"start_time_in_millis\" : 1426840541641,\n    \"end_time\" : \"2015-03-20T08:36:23.932Z\",\n    \"end_time_in_millis\" : 1426840583932,\n    \"duration_in_millis\" : 42291,\n    \"failures\" : [ ],\n    \"shards\" : {\n      \"total\" : 10,\n      \"failed\" : 0,\n      \"successful\" : 10\n    }\n  }\n}\n```\n\nresult is snapshot successful for 10 shards; but  when i restore this snapshot, ES report many exception:\n\n```\n[2015-03-20 16:09:12,088][WARN ][indices.cluster          ] [lin-65-181] [logstash-2015.03.15][0] failed to start shard\norg.elasticsearch.index.gateway.IndexShardGatewayRecoveryException: [logstash-2015.03.15][0] failed recovery\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:185)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: [logstash-2015.03.15][0] restore failed\n    at org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.restore(IndexShardSnapshotAndRestoreService.java:130)\n    at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:127)\n    ... 3 more\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: [logstash-2015.03.15][0] failed to restore snapshot [snapshot-logstash-2015.03.15_20150320-160201]\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.restore(BlobStoreIndexShardRepository.java:165)\n    at org.elasticsearch.index.snapshots.IndexShardSnapshotAndRestoreService.restore(IndexShardSnapshotAndRestoreService.java:124)\n    ... 4 more\nCaused by: org.elasticsearch.index.snapshots.IndexShardRestoreFailedException: [logstash-2015.03.15][0] failed to read shard snapshot file\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$Context.loadSnapshot(BlobStoreIndexShardRepository.java:319)\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$RestoreContext.restore(BlobStoreIndexShardRepository.java:709)\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository.restore(BlobStoreIndexShardRepository.java:162)\n    ... 5 more\nCaused by: java.io.FileNotFoundException: /home/elasticsearch/ES_backup/log/indices/logstash-2015.03.15/0/snapshot-snapshot-logstash-2015.03.15_20150320-160201 (No such file or directory)\n    at java.io.FileInputStream.open(Native Method)\n    at java.io.FileInputStream.<init>(FileInputStream.java:146)\n    at org.elasticsearch.common.blobstore.fs.FsBlobContainer.openInput(FsBlobContainer.java:79)\n    at org.elasticsearch.index.snapshots.blobstore.BlobStoreIndexShardRepository$Context.loadSnapshot(BlobStoreIndexShardRepository.java:316)\n    ... 7 more\n```\n\nI jump to the backup directory, found miss \"0\" directory for index \"logstash-2015.03.15\".\n\n```\n[elasticsearch@lin-mongo-65-182 indices]$ pwd\n/home/elasticsearch/ES_backup/log/indices\n[elasticsearch@lin-mongo-65-182 indices]$ tree -L 2 ./\n./\n├── logstash-2015.03.14\n│   ├── 0\n│   ├── 1\n│   ├── 2\n│   ├── 3\n│   ├── 4\n│   ├── 5\n│   ├── 6\n│   ├── 7\n│   ├── 8\n│   └── 9\n└── logstash-2015.03.15\n    ├── 1\n    ├── 2\n    ├── 3\n    ├── 4\n    ├── 5\n    ├── 6\n    ├── 7\n    ├── 8\n    ├── 9\n    └── snapshot-snapshot-logstash-2015.03.15_20150320-160201\n```\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}