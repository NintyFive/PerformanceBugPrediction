{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22584","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22584/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22584/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22584/events","html_url":"https://github.com/elastic/elasticsearch/issues/22584","id":200357611,"node_id":"MDU6SXNzdWUyMDAzNTc2MTE=","number":22584,"title":"Unable to cast IP DataType to String in Painless Script","user":{"login":"josephDunne","id":1827457,"node_id":"MDQ6VXNlcjE4Mjc0NTc=","avatar_url":"https://avatars0.githubusercontent.com/u/1827457?v=4","gravatar_id":"","url":"https://api.github.com/users/josephDunne","html_url":"https://github.com/josephDunne","followers_url":"https://api.github.com/users/josephDunne/followers","following_url":"https://api.github.com/users/josephDunne/following{/other_user}","gists_url":"https://api.github.com/users/josephDunne/gists{/gist_id}","starred_url":"https://api.github.com/users/josephDunne/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/josephDunne/subscriptions","organizations_url":"https://api.github.com/users/josephDunne/orgs","repos_url":"https://api.github.com/users/josephDunne/repos","events_url":"https://api.github.com/users/josephDunne/events{/privacy}","received_events_url":"https://api.github.com/users/josephDunne/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":12,"created_at":"2017-01-12T12:43:34Z","updated_at":"2018-02-14T13:21:43Z","closed_at":"2017-01-12T20:26:10Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.0\r\n\r\n**Plugins installed**: default set\r\n\r\n**JVM version**: openjdk version \"1.8.0_101\"\r\n\r\n**OS version**: Centos 6\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI have trying to append a field value to a string but I am getting an ArrayIndexOutOfBoundsException.\r\nIt seems that there is a problem with the `.getValue()` function for IP data type fields.\r\n\r\nIf anyone has a workaround I would much appreciate it.\r\n\r\nThis code does not work:\r\n```\r\ndef ip = doc['IP_SRC'].getValue();\r\n```\r\n\r\nthis code does not work:\r\n```\r\ndef acc = 'my_ip:';\r\nacc +=  doc['IP_SRC'];\r\n```\r\n\r\n**Steps to reproduce**:\r\n 1. Create an field with mapping type ip\r\n 2. Add documents some with doc values containing ip field data\r\n 3. Try use that field in a string in a Painless script (I am using my script as a Kibana scripted field)\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nThis log doesn't seem to show the cause of the Out of Bounds exception but I believe its somewhere in the to UTF8 routines of `ByteRef`.\r\n\r\n```\r\n[2017-01-12T12:37:49,043][DEBUG][o.e.a.s.TransportSearchAction] [Z8qG7Y5] [nap-gi-2017.01.12][0], node[Z8qG7Y5IScyM2r06BN0Dbg], [P], s[STARTED], a[id=TpRuYNq6TE-cY47uz3VlsA]: Failed to execute [SearchRequest{searchType=QUERY_AND_FETCH, indices=[nap-gi-2017.01.12], indicesOptions=IndicesOptions[id=39, ignore_unavailable=true, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_alisases_to_multiple_indices=true, forbid_closed_indices=true], types=[], routing='null', preference='1484222965683', requestCache=null, scroll=null, source={\r\n  \"size\" : 500,\r\n  \"query\" : {\r\n    \"bool\" : {\r\n      \"must\" : [\r\n        {\r\n          \"query_string\" : {\r\n            \"query\" : \"*\",\r\n            \"fields\" : [ ],\r\n            \"use_dis_max\" : true,\r\n            \"tie_breaker\" : 0.0,\r\n            \"default_operator\" : \"or\",\r\n            \"auto_generate_phrase_queries\" : false,\r\n            \"max_determined_states\" : 10000,\r\n            \"lowercase_expanded_terms\" : true,\r\n            \"enable_position_increment\" : true,\r\n            \"fuzziness\" : \"AUTO\",\r\n            \"fuzzy_prefix_length\" : 0,\r\n            \"fuzzy_max_expansions\" : 50,\r\n            \"phrase_slop\" : 0,\r\n            \"analyze_wildcard\" : true,\r\n            \"locale\" : \"und\",\r\n            \"escape\" : false,\r\n            \"boost\" : 1.0\r\n          }\r\n        },\r\n        {\r\n          \"range\" : {\r\n            \"TS\" : {\r\n              \"from\" : 1484222823984,\r\n              \"to\" : 1484224623984,\r\n              \"include_lower\" : true,\r\n              \"include_upper\" : true,\r\n              \"format\" : \"epoch_millis\",\r\n              \"boost\" : 1.0\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\" : false,\r\n      \"adjust_pure_negative\" : true,\r\n      \"boost\" : 1.0\r\n    }\r\n  },\r\n  \"_source\" : {\r\n    \"includes\" : [ ],\r\n    \"excludes\" : [ ]\r\n  },\r\n  \"stored_fields\" : \"*\",\r\n  \"docvalue_fields\" : [\r\n    \"TS\"\r\n  ],\r\n  \"script_fields\" : {\r\n    \"search_token\" : {\r\n      \"script\" : {\r\n        \"inline\" : \"def json = '{';if (doc['IP_SRC'].size() > 0){\\n  def asBytes = doc['IP_SRC'].getValue();\\n  json += \\\"\\\\\\\"s\\\\\\\": \\\" + \\\",\\\";\\n}\\njson += '}';\\nreturn json\",\r\n        \"lang\" : \"painless\"\r\n      },\r\n      \"ignore_failure\" : false\r\n    }\r\n  },\r\n  \"sort\" : [\r\n    {\r\n      \"TS\" : {\r\n        \"order\" : \"desc\",\r\n        \"unmapped_type\" : \"boolean\"\r\n      }\r\n    }\r\n  ],\r\n  \"aggregations\" : {\r\n    \"2\" : {\r\n      \"date_histogram\" : {\r\n        \"field\" : \"TS\",\r\n        \"time_zone\" : \"Europe/London\",\r\n        \"interval\" : \"30s\",\r\n        \"offset\" : 0,\r\n        \"order\" : {\r\n          \"_key\" : \"asc\"\r\n        },\r\n        \"keyed\" : false,\r\n        \"min_doc_count\" : 1\r\n      }\r\n    }\r\n  },\r\n  \"highlight\" : {\r\n    \"pre_tags\" : [\r\n      \"@kibana-highlighted-field@\"\r\n    ],\r\n    \"post_tags\" : [\r\n      \"@/kibana-highlighted-field@\"\r\n    ],\r\n    \"fragment_size\" : 2147483647,\r\n    \"require_field_match\" : false,\r\n    \"fields\" : {\r\n      \"*\" : { }\r\n    }\r\n  },\r\n  \"ext\" : { }\r\n}}]\r\norg.elasticsearch.transport.RemoteTransportException: [Z8qG7Y5][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]\r\nCaused by: org.elasticsearch.script.ScriptException: runtime error\r\n        at org.elasticsearch.painless.ScriptImpl.convertToScriptException(ScriptImpl.java:177) ~[?:?]\r\n        at org.elasticsearch.painless.ScriptImpl.run(ScriptImpl.java:124) ~[?:?]\r\n        at org.elasticsearch.search.fetch.subphase.ScriptFieldsFetchSubPhase.hitExecute(ScriptFieldsFetchSubPhase.java:52) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:161) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:358) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$9(SearchTransportService.java:291) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_101]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_101]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_101]\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException\r\n[2017-01-12T12:37:49,045][DEBUG][o.e.a.s.TransportSearchAction] [Z8qG7Y5] All shards failed for phase: [query_fetch]\r\norg.elasticsearch.transport.RemoteTransportException: [Z8qG7Y5][127.0.0.1:9300][indices:data/read/search[phase/query+fetch]]\r\nCaused by: org.elasticsearch.script.ScriptException: runtime error\r\n        at org.elasticsearch.painless.ScriptImpl.convertToScriptException(ScriptImpl.java:177) ~[?:?]\r\n        at org.elasticsearch.painless.ScriptImpl.run(ScriptImpl.java:124) ~[?:?]\r\n        at org.elasticsearch.search.fetch.subphase.ScriptFieldsFetchSubPhase.hitExecute(ScriptFieldsFetchSubPhase.java:52) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:161) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:358) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.action.search.SearchTransportService.lambda$registerRequestHandler$9(SearchTransportService.java:291) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:548) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:504) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.0.0.jar:5.0.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_101]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_101]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_101]\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException\r\n```","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}