{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44914","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44914/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44914/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44914/events","html_url":"https://github.com/elastic/elasticsearch/issues/44914","id":473448925,"node_id":"MDU6SXNzdWU0NzM0NDg5MjU=","number":44914,"title":"auto_date_histogram fails where date_histogram does not","user":{"login":"igoristic","id":27822304,"node_id":"MDQ6VXNlcjI3ODIyMzA0","avatar_url":"https://avatars2.githubusercontent.com/u/27822304?v=4","gravatar_id":"","url":"https://api.github.com/users/igoristic","html_url":"https://github.com/igoristic","followers_url":"https://api.github.com/users/igoristic/followers","following_url":"https://api.github.com/users/igoristic/following{/other_user}","gists_url":"https://api.github.com/users/igoristic/gists{/gist_id}","starred_url":"https://api.github.com/users/igoristic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/igoristic/subscriptions","organizations_url":"https://api.github.com/users/igoristic/orgs","repos_url":"https://api.github.com/users/igoristic/repos","events_url":"https://api.github.com/users/igoristic/events{/privacy}","received_events_url":"https://api.github.com/users/igoristic/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"pcsanwald","id":163306,"node_id":"MDQ6VXNlcjE2MzMwNg==","avatar_url":"https://avatars1.githubusercontent.com/u/163306?v=4","gravatar_id":"","url":"https://api.github.com/users/pcsanwald","html_url":"https://github.com/pcsanwald","followers_url":"https://api.github.com/users/pcsanwald/followers","following_url":"https://api.github.com/users/pcsanwald/following{/other_user}","gists_url":"https://api.github.com/users/pcsanwald/gists{/gist_id}","starred_url":"https://api.github.com/users/pcsanwald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pcsanwald/subscriptions","organizations_url":"https://api.github.com/users/pcsanwald/orgs","repos_url":"https://api.github.com/users/pcsanwald/repos","events_url":"https://api.github.com/users/pcsanwald/events{/privacy}","received_events_url":"https://api.github.com/users/pcsanwald/received_events","type":"User","site_admin":false},"assignees":[{"login":"pcsanwald","id":163306,"node_id":"MDQ6VXNlcjE2MzMwNg==","avatar_url":"https://avatars1.githubusercontent.com/u/163306?v=4","gravatar_id":"","url":"https://api.github.com/users/pcsanwald","html_url":"https://github.com/pcsanwald","followers_url":"https://api.github.com/users/pcsanwald/followers","following_url":"https://api.github.com/users/pcsanwald/following{/other_user}","gists_url":"https://api.github.com/users/pcsanwald/gists{/gist_id}","starred_url":"https://api.github.com/users/pcsanwald/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pcsanwald/subscriptions","organizations_url":"https://api.github.com/users/pcsanwald/orgs","repos_url":"https://api.github.com/users/pcsanwald/repos","events_url":"https://api.github.com/users/pcsanwald/events{/privacy}","received_events_url":"https://api.github.com/users/pcsanwald/received_events","type":"User","site_admin":false}],"milestone":null,"comments":16,"created_at":"2019-07-26T16:53:05Z","updated_at":"2019-12-10T22:09:07Z","closed_at":"2019-12-05T21:11:28Z","author_association":"NONE","active_lock_reason":null,"body":"We are planning to port most of Stack Monitoring current aggregations to use `auto_date_histogram` in lieu of `date_histogram` as part of https://github.com/elastic/kibana/issues/37246.\r\n\r\nWe noticed that `auto_date_histogram` supports most of aggregations that `date_histogram` does, but fails (on `fetch` phase) with `bucket_script`. As a first pass, I tried replacing the existing `date_histogram` usage with `auto_date_histogram` and it broke:\r\n\r\n```http\r\nGET .monitoring-logstash-*/_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"range\": {\r\n            \"logstash_stats.timestamp\": {\r\n              \"format\": \"epoch_millis\",\r\n              \"gte\": 1563551274281,\r\n              \"lte\": 1563554874281\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"check\": {\r\n      \"auto_date_histogram\": {\r\n        \"field\": \"logstash_stats.timestamp\",\r\n        \"buckets\": 10\r\n      },\r\n      \"aggs\": {\r\n        \"pipelines_nested\": {\r\n          \"nested\": {\r\n            \"path\": \"logstash_stats.pipelines\"\r\n          },\r\n          \"aggs\": {\r\n            \"by_pipeline_id\": {\r\n              \"terms\": {\r\n                \"field\": \"logstash_stats.pipelines.id\",\r\n                \"size\": 1000\r\n              },\r\n              \"aggs\": {\r\n                \"by_pipeline_hash\": {\r\n                  \"terms\": {\r\n                    \"field\": \"logstash_stats.pipelines.hash\",\r\n                    \"size\": 1000\r\n                  },\r\n                  \"aggs\": {\r\n                    \"by_ephemeral_id\": {\r\n                      \"terms\": {\r\n                        \"field\": \"logstash_stats.pipelines.ephemeral_id\",\r\n                        \"size\": 1000\r\n                      },\r\n                      \"aggs\": {\r\n                        \"events_stats\": {\r\n                          \"stats\": {\r\n                            \"field\": \"logstash_stats.pipelines.events.out\"\r\n                          }\r\n                        },\r\n                        \"throughput\": {\r\n                          \"bucket_script\": {\r\n                            \"script\": \"params.max - params.min\",\r\n                            \"buckets_path\": {\r\n                              \"min\": \"events_stats.min\",\r\n                              \"max\": \"events_stats.max\"\r\n                            }\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThis query fails where the same query works if you replace `auto_date_histogram` with `date_histogram` (and use `interval` instead of `buckets`). Anyone attempting to run this on an existing cluster will likely need to shift the date `range` query.","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}