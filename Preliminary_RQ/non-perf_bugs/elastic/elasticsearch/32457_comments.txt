[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408779473","html_url":"https://github.com/elastic/elasticsearch/issues/32457#issuecomment-408779473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32457","id":408779473,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODc3OTQ3Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T07:58:34Z","updated_at":"2018-07-30T07:58:34Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408851014","html_url":"https://github.com/elastic/elasticsearch/issues/32457#issuecomment-408851014","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32457","id":408851014,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODg1MTAxNA==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T12:46:55Z","updated_at":"2018-07-30T12:46:55Z","author_association":"CONTRIBUTOR","body":"This seems to be a result of the upgrade to Lucene 7.5.0 (#32390 / 53ff06e621213cb007d0e03b8ec8d80431d9186a).\r\n\r\nI'll debug further to work out if it's just a test bug or a genuine behaviour change.\r\n\r\nFYI @jimczi ; I'll let you know what I find.\r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408868480","html_url":"https://github.com/elastic/elasticsearch/issues/32457#issuecomment-408868480","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32457","id":408868480,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODg2ODQ4MA==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T13:45:16Z","updated_at":"2018-07-30T13:45:44Z","author_association":"CONTRIBUTOR","body":"@jimczi (or another Lucene expert)\r\n\r\nI think I understand why this test is failing and can guess at why it is triggered in Lucene 7.5, but I'm not sure of the best way to fix it.\r\n\r\nThe problem is between lines 102 and 104 here:\r\n- https://github.com/elastic/elasticsearch/blob/53ff06e621213cb007d0e03b8ec8d80431d9186a/x-pack/plugin/core/src/test/java/org/elasticsearch/xpack/core/security/authz/accesscontrol/DocumentSubsetReaderTests.java#L102-L104\r\n\r\nDepending on the merge policy/schedule configuration (which is randomised in LuceneTestCase), it's possible that the delete would trigger a merge, which causes the \"value3\" document to be removed entirely, and the \"value4\" document become the `doc` with index `2` instead of `3` which fails the assertion at line 133.\r\n\r\nSince Lucene 7.5 contains `reclaim_deletes_weight`/`setDeletesPctAllowed` changes, and this index has so few docs, a single delete could trigger a merge.\r\n\r\nIf that analysis is correct, what's the cleanest way to ensure that no merge happens when the document is deleted at line 103?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408872377","html_url":"https://github.com/elastic/elasticsearch/issues/32457#issuecomment-408872377","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32457","id":408872377,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODg3MjM3Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T13:57:09Z","updated_at":"2018-07-30T13:57:09Z","author_association":"MEMBER","body":"Good catch @tvernum ! One workaround is to force the merge policy to choose a log merge policy (this policy does not handle the new `setDeletesPctAllowed`) like this:\r\n````\r\n    IndexWriter iw = new IndexWriter(directory, newIndexWriterConfig().setMergePolicy(newLogMergePolicy(random()));\r\n````\r\nIt seems that the test only need a single segment with a delete so it could also work if you disable the merge entirely and set a big buffer size for the index writer. Though the solution with the log merge policy should work fine. Thanks for chasing this up Tim !","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/408930932","html_url":"https://github.com/elastic/elasticsearch/issues/32457#issuecomment-408930932","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32457","id":408930932,"node_id":"MDEyOklzc3VlQ29tbWVudDQwODkzMDkzMg==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-07-30T16:44:24Z","updated_at":"2018-07-30T16:44:24Z","author_association":"MEMBER","body":"@tvernum and @jimczi Another workaround is to index more documents to reduce the deletion ratio.","performed_via_github_app":null}]