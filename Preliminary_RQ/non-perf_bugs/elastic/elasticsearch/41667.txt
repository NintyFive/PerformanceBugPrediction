{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41667","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41667/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41667/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41667/events","html_url":"https://github.com/elastic/elasticsearch/issues/41667","id":438669000,"node_id":"MDU6SXNzdWU0Mzg2NjkwMDA=","number":41667,"title":"Reindex fails if dest is alias using `is_write_index`","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":1315850572,"node_id":"MDU6TGFiZWwxMzE1ODUwNTcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Reindex","name":":Distributed/Reindex","color":"0e8a16","default":false,"description":"Issues relating to reindex that are not caused by issues further down"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-04-30T08:58:09Z","updated_at":"2019-05-08T07:27:07Z","closed_at":"2019-05-08T07:27:07Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.7.1, 7.0, 7.x, master\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nReindexing when the destination is an alias using `is_write_index` (i.e. an alias with multiple indices but only one set with `is_write_index: true`) fails with:\r\n```\r\n[elasticsearch] java.lang.IllegalStateException: alias [my_data] has more than one write index [index-1,index-2]\r\n[elasticsearch]         at org.elasticsearch.cluster.metadata.AliasOrIndex$Alias.computeAndValidateWriteIndex(AliasOrIndex.java:154) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.metadata.MetaData$Builder.lambda$buildAliasAndIndexLookup$1(MetaData.java:1230) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at java.util.stream.ForEachOps$ForEachOp$OfRef.accept(ForEachOps.java:183) ~[?:?]\r\n[elasticsearch]         at java.util.stream.ReferencePipeline$2$1.accept(ReferencePipeline.java:177) ~[?:?]\r\n[elasticsearch]         at java.util.TreeMap$ValueSpliterator.forEachRemaining(TreeMap.java:2890) ~[?:?]\r\n[elasticsearch]         at java.util.stream.AbstractPipeline.copyInto(AbstractPipeline.java:484) ~[?:?]\r\n[elasticsearch]         at java.util.stream.AbstractPipeline.wrapAndCopyInto(AbstractPipeline.java:474) ~[?:?]\r\n[elasticsearch]         at java.util.stream.ForEachOps$ForEachOp.evaluateSequential(ForEachOps.java:150) ~[?:?]\r\n[elasticsearch]         at java.util.stream.ForEachOps$ForEachOp$OfRef.evaluateSequential(ForEachOps.java:173) ~[?:?]\r\n[elasticsearch]         at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:234) ~[?:?]\r\n[elasticsearch]         at java.util.stream.ReferencePipeline.forEach(ReferencePipeline.java:497) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.cluster.metadata.MetaData$Builder.buildAliasAndIndexLookup(MetaData.java:1230) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.metadata.MetaData$Builder.build(MetaData.java:1193) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.metadata.MetaDataCreateIndexService$IndexCreationTask.execute(MetaDataCreateIndexService.java:557) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.ClusterStateUpdateTask.execute(ClusterStateUpdateTask.java:47) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:687) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.service.MasterService.calculateTaskOutputs(MasterService.java:310) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.service.MasterService.runTasks(MasterService.java:210) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.service.MasterService$Batcher.run(MasterService.java:142) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:687) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:252) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:215) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n[elasticsearch]         at java.lang.Thread.run(Thread.java:835) [?:?]\r\n```\r\n\r\nThis should work since indexing into an alias with multiple indexes is now permitted as long as the alias is using `is_write_index`.\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\nGET _cat/indices?v\r\n\r\nDELETE index-1\r\n\r\nPUT index-1\r\n{\r\n  \"aliases\": {\r\n    \"my_data\": {\r\n      \"is_write_index\": true\r\n    }\r\n  }\r\n}\r\n\r\nPOST my_data/_doc/1\r\n{\r\n  \"foo\":\"bar\"\r\n}\r\n\r\nPOST my_data/_rollover\r\n{\r\n  \"conditions\": {\r\n    \"max_docs\": 1\r\n  }\r\n}\r\n\r\nGET my_data\r\n\r\nPOST my_data/_doc/2\r\n{\r\n  \"foo\":\"baz\"\r\n}\r\n\r\nPOST other-index/_doc/3\r\n{\r\n  \"foo\": \"bof\"\r\n}\r\n\r\n# This fails with the above error\r\nPOST _reindex\r\n{\r\n  \"source\": {\r\n    \"index\": \"other-index\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"my_data\"\r\n  }\r\n}\r\n```\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}