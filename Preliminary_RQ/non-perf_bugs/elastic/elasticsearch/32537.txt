{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32537","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32537/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32537/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32537/events","html_url":"https://github.com/elastic/elasticsearch/issues/32537","id":346546559,"node_id":"MDU6SXNzdWUzNDY1NDY1NTk=","number":32537,"title":"Heap slowly filling up with org.elasticsearch.index.SearchSlowLog$SlowLogSearchContextPrinter","user":{"login":"ccoffey","id":456400,"node_id":"MDQ6VXNlcjQ1NjQwMA==","avatar_url":"https://avatars2.githubusercontent.com/u/456400?v=4","gravatar_id":"","url":"https://api.github.com/users/ccoffey","html_url":"https://github.com/ccoffey","followers_url":"https://api.github.com/users/ccoffey/followers","following_url":"https://api.github.com/users/ccoffey/following{/other_user}","gists_url":"https://api.github.com/users/ccoffey/gists{/gist_id}","starred_url":"https://api.github.com/users/ccoffey/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ccoffey/subscriptions","organizations_url":"https://api.github.com/users/ccoffey/orgs","repos_url":"https://api.github.com/users/ccoffey/repos","events_url":"https://api.github.com/users/ccoffey/events{/privacy}","received_events_url":"https://api.github.com/users/ccoffey/received_events","type":"User","site_admin":false},"labels":[{"id":151561891,"node_id":"MDU6TGFiZWwxNTE1NjE4OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Logging","name":":Core/Infra/Logging","color":"0e8a16","default":false,"description":"Log management and logging utilities"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":10,"created_at":"2018-08-01T10:45:07Z","updated_at":"2018-08-07T08:50:49Z","closed_at":"2018-08-06T12:56:22Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\n```json\r\n{\r\n   \"version\" : {\r\n      \"number\" : \"6.3.0\",\r\n       \"build_flavor\" : \"default\",\r\n       \"build_type\" : \"rpm\",\r\n       \"build_hash\" : \"424e937\",\r\n       \"build_date\" : \"2018-06-11T23:38:03.357887Z\",\r\n       \"build_snapshot\" : false,\r\n       \"lucene_version\" : \"7.3.1\",\r\n       \"minimum_wire_compatibility_version\" : \"5.6.0\",\r\n       \"minimum_index_compatibility_version\" : \"5.0.0\"\r\n  }\r\n}\r\n```\r\n\r\n**Plugins installed**: ['discovery-ec2', 'repository-s3']\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\njava version \"1.8.0_171\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_171-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux es-data-1 4.14.51-60.38.amzn1.x86_64 #1 SMP Tue Jun 26 23:06:43 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nGarbage collection is able to recover less and less of the heap as time moves on. Eventually this puts a lot of memory pressure on `data-nodes` and we see long pause the world `Old GC collections`\r\n\r\n![screen shot 2018-08-01 at 11 38 42](https://user-images.githubusercontent.com/456400/43517118-848f568c-957f-11e8-8709-32536bacd6f3.png)\r\n\r\n\r\n**Day 1**\r\n\r\n![screen shot 2018-08-01 at 11 12 25](https://user-images.githubusercontent.com/456400/43515939-cd3005a2-957b-11e8-81f4-94009bc73bdf.png)\r\n\r\n**Day 2**\r\n\r\n![screen shot 2018-08-01 at 11 17 45](https://user-images.githubusercontent.com/456400/43516140-8d54fc70-957c-11e8-8eda-54c1992bcbdc.png)\r\n\r\n**Day 3**\r\n\r\n![screen shot 2018-08-01 at 11 19 30](https://user-images.githubusercontent.com/456400/43516208-ca9ba480-957c-11e8-9e75-2d57faf3a710.png)\r\n\r\nOn Day 3, we took a heap dump and saw that `6,776 MB == ~30%` of the heap was filled with `org.elasticsearch.index.SearchSlowLog$SlowLogSearchContextPrinter` \r\n\r\n<img width=\"1729\" alt=\"43466021-8679f9f6-94d6-11e8-8e79-7357e64a5b8b\" src=\"https://user-images.githubusercontent.com/456400/43516565-d3b49648-957d-11e8-992c-f8132c4be0ae.png\">\r\n\r\nWe then turned off slow logging by doing the following\r\n\r\n```\r\ncurl -XPUT 'localhost:9200/_settings' -H 'Content-Type: application/json' -d '{\r\n  \"index.indexing.slowlog.level\": null,\r\n  \"index.search.slowlog.threshold.query.warn\": null,\r\n  \"index.search.slowlog.threshold.fetch.warn\": null,\r\n  \"index.indexing.slowlog.threshold.index.warn\": null\r\n}'\r\n```\r\n\r\nWe restarted each `data-node` in our cluster 12 hours ago and things seem stable since then (really we won't be sure for a few more days).\r\n\r\n**Last 12 hours**\r\n\r\n![screen shot 2018-08-01 at 11 32 14](https://user-images.githubusercontent.com/456400/43516808-90417af6-957e-11e8-9078-e3ddfd120126.png)\r\n\r\n**Last hour**\r\n\r\n![screen shot 2018-08-01 at 11 32 45](https://user-images.githubusercontent.com/456400/43516838-a624fe4c-957e-11e8-9d5f-73547ff1c439.png)\r\n\r\n**Steps to reproduce**:\r\n\r\nI haven't tried to reproduce this, but this has happened to all four of our `ES 6.3.0` clusters.\r\n\r\n 1. Turn on slow logging\r\n 2. Generate a lot of slow queries\r\n 3. Look at the metric `jvm.mem.heap_in_use` over time. \r\n \r\n**Note:** This issue might have the same route cause as: https://github.com/elastic/elasticsearch/issues/27300\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}