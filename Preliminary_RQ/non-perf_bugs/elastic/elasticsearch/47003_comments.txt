[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534487471","html_url":"https://github.com/elastic/elasticsearch/issues/47003#issuecomment-534487471","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47003","id":534487471,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDQ4NzQ3MQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-09-24T10:01:53Z","updated_at":"2019-09-24T10:01:53Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534634084","html_url":"https://github.com/elastic/elasticsearch/issues/47003#issuecomment-534634084","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47003","id":534634084,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDYzNDA4NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-09-24T16:18:22Z","updated_at":"2019-09-24T16:18:22Z","author_association":"CONTRIBUTOR","body":"My observations when we were discussing this this morning were:\r\n\r\n1. The way the daily maintenance task reschedules is that each invocation schedules the next one.  So if some problem stops the task running once then it won't run again.\r\n2. There is a race condition in `MlDailyMaintenanceService` where if `stop` and `start` are called close together, with `start` being called before `stop` has finished doing its work then the `stop` that was called before `start` but finished running afterwards can cancel the newly scheduled timer.  (I'm not sure it's possible in production for this to happen, but we could defend against it by making all the methods that access the `cancellable` variable `synchronized`.)\r\n3. Similarly there's a potential race in `MlInitializationService` if `onMaster` can be called before a call made very soon beforehand to `offMaster` has finished its work.  That could be defended against by making all the methods that access `mlDailyMaintenanceService` `synchronized`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534891385","html_url":"https://github.com/elastic/elasticsearch/issues/47003#issuecomment-534891385","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47003","id":534891385,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDg5MTM4NQ==","user":{"login":"pheyos","id":1945390,"node_id":"MDQ6VXNlcjE5NDUzOTA=","avatar_url":"https://avatars0.githubusercontent.com/u/1945390?v=4","gravatar_id":"","url":"https://api.github.com/users/pheyos","html_url":"https://github.com/pheyos","followers_url":"https://api.github.com/users/pheyos/followers","following_url":"https://api.github.com/users/pheyos/following{/other_user}","gists_url":"https://api.github.com/users/pheyos/gists{/gist_id}","starred_url":"https://api.github.com/users/pheyos/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pheyos/subscriptions","organizations_url":"https://api.github.com/users/pheyos/orgs","repos_url":"https://api.github.com/users/pheyos/repos","events_url":"https://api.github.com/users/pheyos/events{/privacy}","received_events_url":"https://api.github.com/users/pheyos/received_events","type":"User","site_admin":false},"created_at":"2019-09-25T07:27:09Z","updated_at":"2019-09-25T07:27:09Z","author_association":"NONE","body":"To debug this issue, I did a full cluster restart which should schedule a new nightly maintenance task. But one day later, the maintenance task still did not run (7am server time).\r\nI've also checked logs and model snapshots of a second long running cluster that has been created on 7.3.0 right away (without upgrade from an older version like the first cluster) with the same result: no sign of running the maintenance task and lots of old model snapshots.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534961774","html_url":"https://github.com/elastic/elasticsearch/issues/47003#issuecomment-534961774","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47003","id":534961774,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDk2MTc3NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-09-25T10:37:23Z","updated_at":"2019-09-25T10:37:23Z","author_association":"CONTRIBUTOR","body":"The problem is much simpler than the subtle race conditions I thought of.  It was introduced in 6.6: https://github.com/elastic/elasticsearch/pull/36702/files#diff-6d8a49bb3f57c032cf9c63498d1e2f89L48\r\n\r\nIt means nightly maintenance has not run for any cluster on versions 6.6.0 to 7.4.0 inclusive.\r\n\r\nI will fix this for 6.8.4/7.4.1 (and also defend the subtle races too).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/534969748","html_url":"https://github.com/elastic/elasticsearch/issues/47003#issuecomment-534969748","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47003","id":534969748,"node_id":"MDEyOklzc3VlQ29tbWVudDUzNDk2OTc0OA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-09-25T11:03:00Z","updated_at":"2019-09-25T11:03:00Z","author_association":"CONTRIBUTOR","body":"I opened #47103 to fix this.\r\n\r\nThe reason it didn't show up in any of our unit/integration tests is that the unit tests don't exercise the real on/off master listener functionality, and in integration tests we actually test the `DeleteExpiredDataAction` on the basis that we cannot have an integration test waiting for the early hours of the morning.\r\n\r\nSo in the tests in the elasticsearch repo we're testing most pieces of the jigsaw in isolation but not the full jigsaw.  This means it's critical that the long running QA tests keep an eye out for whether daily maintenance is running in the early hours of each morning.  If it is running then the unit/integration tests show it's probably doing the right thing.  But if it's not running in the early hours of each morning then we're relying on the long running QA tests to tell us.","performed_via_github_app":null}]