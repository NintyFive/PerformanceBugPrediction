[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/62779460","html_url":"https://github.com/elastic/elasticsearch/issues/8456#issuecomment-62779460","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8456","id":62779460,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNzc5NDYw","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-12T19:36:37Z","updated_at":"2014-11-12T19:36:37Z","author_association":"CONTRIBUTOR","body":"Hi @roncemer \n\n> One thing I'm noticing is that ES begins relocating shards as soon as the cluster is started up. This is bad, because it results in unnecessary delays getting the cluster to the yellow, then green state. If there are any unassigned or uninitialized shards, or the cluster status is anything other than green, shard relocation should be delayed until everything else is done, all shards are initialized and running, and the cluster state is green.\n\nThe cluster doesn't know how many nodes you are planning on starting, unless you tell it.  You should look at this section of the docs, which will help you to configure these settings:\nhttp://www.elasticsearch.org/guide/en/elasticsearch/reference/current/modules-gateway.html#recover-after\n\nIf you plan on doing a rolling restart, then you should disable shard allocation as described here: http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/setup-upgrade.html#rolling-upgrades\n\nAlso, we're trying to implement another feature which will greatly speed up recovery: https://github.com/elasticsearch/elasticsearch/issues/6069\n\n> An even bigger issue, and you may want to split this into two issues, is that sometimes ES leaves shards unassigned. It just doesn't assign them. Even if you have to start up another thread to look for unassigned shards and assign them, under no circumstances should ES ever leave a shard unassigned, period. Doing this forces the cluster state to red, and forces the admin to manually assign those shards. This is something ES should take care of automatically. So...NEVER leave a shard in the unassigned state.\n\nThere are good reasons for leaving shards unassigned, eg you have no disk space, or the only copy of your shard is corrupt (but you may have another copy on an unstarted node or in a snapshot somewhere).  If we were to say \"just go ahead and assign empty shards regardless\" then you will suffer data loss which you could have avoided.\n\nThat said, the logs should always tell you **why** a shard is unassigned, which will help you to figure out what to do about it.  1.4.0 isn't noisy enough about nearly full disks, we are working on improving that in 1.4.1 (https://github.com/elasticsearch/elasticsearch/pull/8382).  If we're missing logging other reasons, open issues about them so that we can fix those too.\n\n> Other than these two bugs in how ES recovers from a downed node or a complete cluster restart, ES has been fabulous for us. Certainly a night-and-day improvement over Riak. Keep up the awesome work!\n\nGlad to hear it is working out :)  thanks for letting us know.\n","performed_via_github_app":null}]