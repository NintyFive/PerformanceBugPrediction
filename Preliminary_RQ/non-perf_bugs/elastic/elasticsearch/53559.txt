{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/53559","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53559/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53559/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/53559/events","html_url":"https://github.com/elastic/elasticsearch/issues/53559","id":580789697,"node_id":"MDU6SXNzdWU1ODA3ODk2OTc=","number":53559,"title":"Faster access to started  shards  count of the index in each node","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-03-13T19:08:52Z","updated_at":"2020-03-19T00:57:51Z","closed_at":"2020-03-19T00:57:51Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"ES_VERSION: 7.6.0\r\nJVM version : JDK1.8.0_112\r\nOS version : linux\r\n**Description of the problem including expected versus actual behavior:**\r\nAs it's known, Updating ClusterState on master may cost too much time, which is not good for cluster. During the updating ClusterState, ShardsLimitAllocationDecider deciders iterate through all the shards on a node to find STARTED ones belonging to the index when `cluster.routing.allocation.total_shards_per_node` > 0, Which will cost too much time.\r\n\r\nIn out product, There are  39 nodes and 2,000 indices, 50,000 shards,  but the time to update cluster state reach at 3.4min, It's intolerable.\r\n\r\n  To find out why it cost so much time on updating cluste state, I get the thread stack about updateTask, such that:\r\n```\r\n\"[node-1][clusterService#updateTask][T#1]\" #21 daemon prio=5 os_prio=0 tid=0x00007fc5c88fa800 nid=0x3369 runnable [0x00007fc58431a000]\r\n   java.lang.Thread.State: RUNNABLE\r\n        at java.util.Collections$UnmodifiableCollection$1.hasNext(Collections.java:1041)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.ShardsLimitAllocationDecider.doDecide(ShardsLimitAllocationDecider.java:112)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.ShardsLimitAllocationDecider.canAllocate(ShardsLimitAllocationDecider.java:88)\r\n        at org.elasticsearch.cluster.routing.allocation.decider.AllocationDeciders.canAllocate(AllocationDeciders.java:73)\r\n        at org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator$Balancer.decideMove(BalancedShardsAllocator.java:707)\r\n        at org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator$Balancer.moveShards(BalancedShardsAllocator.java:648)\r\n        at org.elasticsearch.cluster.routing.allocation.allocator.BalancedShardsAllocator.allocate(BalancedShardsAllocator.java:123)\r\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:329)\r\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.applyStartedShards(AllocationService.java:100)\r\n        at org.elasticsearch.cluster.action.shard.ShardStateAction$ShardStartedClusterStateTaskExecutor.execute(ShardStateAction.java:438)\r\n        at org.elasticsearch.cluster.service.ClusterService.executeTasks(ClusterService.java:634)\r\n        at org.elasticsearch.cluster.service.ClusterService.calculateTaskOutputs(ClusterService.java:612)\r\n```\r\n  I try several times and get the same thread stack,  it seems that ShardsLimitAllocationDecider.doDecide will cost too much time, the related code:\r\n```\r\n       if (indexShardLimit <= 0 && clusterShardLimit <= 0) {\r\n            return allocation.decision(Decision.YES, NAME, \"total shard limits are disabled: [index: %d, cluster: %d] <= 0\",\r\n                    indexShardLimit, clusterShardLimit);\r\n        }\r\n        int indexShardCount = 0;\r\n        int nodeShardCount = 0;\r\n        for (ShardRouting nodeShard : node) {\r\n            // don't count relocating shards...\r\n            if (nodeShard.relocating()) {\r\n                continue;\r\n            }\r\n            nodeShardCount++;\r\n            if (nodeShard.index().equals(shardRouting.index())) {\r\n                indexShardCount++;\r\n            }\r\n        }\r\n```\r\nIt will iterate 50000*50000/39 = 64,000,000 times, which will cost too much time.\r\n\r\nThere is room for optimization to avoid iterating the node:\r\n1.If indexShardLimit=-1 and clusterShardLimit>0, we need't to count `indexShardCount` and `nodeShardCount` by iterating, `nodeShardCount = node.size() - node.numberOfShardsWithState(ShardRoutingState.RELOCATING)`, indexShardCount is useless.\r\n2. If we could  count the started shards of each index in each node in RoutingNode to avoid the iteration?","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}