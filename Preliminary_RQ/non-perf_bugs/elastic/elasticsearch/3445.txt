{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3445","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3445/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3445/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3445/events","html_url":"https://github.com/elastic/elasticsearch/issues/3445","id":17648671,"node_id":"MDU6SXNzdWUxNzY0ODY3MQ==","number":3445,"title":"Not able to use Java API in JBoss EAP6 module","user":{"login":"synclpz","id":3776160,"node_id":"MDQ6VXNlcjM3NzYxNjA=","avatar_url":"https://avatars0.githubusercontent.com/u/3776160?v=4","gravatar_id":"","url":"https://api.github.com/users/synclpz","html_url":"https://github.com/synclpz","followers_url":"https://api.github.com/users/synclpz/followers","following_url":"https://api.github.com/users/synclpz/following{/other_user}","gists_url":"https://api.github.com/users/synclpz/gists{/gist_id}","starred_url":"https://api.github.com/users/synclpz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synclpz/subscriptions","organizations_url":"https://api.github.com/users/synclpz/orgs","repos_url":"https://api.github.com/users/synclpz/repos","events_url":"https://api.github.com/users/synclpz/events{/privacy}","received_events_url":"https://api.github.com/users/synclpz/received_events","type":"User","site_admin":false},"labels":[{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2013-08-05T18:02:45Z","updated_at":"2014-12-03T16:03:44Z","closed_at":"2014-12-03T16:03:44Z","author_association":"NONE","active_lock_reason":null,"body":"If I use api in simple servlet attaching elasticsearch libs in WEB-INF/lib everything is ok.\n\nBut if I create a module in JBoss with elasticsearch and give my web-app a dependency on it (via jboss-deployment-structure.xml), it cannot load neither TransportClient, nor Node-client throwing inject errors like these:\n\n```\norg.elasticsearch.common.inject.CreationException: Guice creation errors:\n\n1) Error injecting constructor, java.lang.NoClassDefFoundError: sun/misc/Unsafe\n  at org.elasticsearch.threadpool.ThreadPool.<init>(Unknown Source)\n  while locating org.elasticsearch.threadpool.ThreadPool\nCaused by: java.lang.NoClassDefFoundError: sun/misc/Unsafe\n    at org.elasticsearch.common.util.concurrent.jsr166e.Striped64.getUnsafe(Striped64.java:321)\n    at org.elasticsearch.common.util.concurrent.jsr166e.Striped64.<clinit>(Striped64.java:301)\n    at org.elasticsearch.common.metrics.CounterMetric.<init>(CounterMetric.java:28)\n    at org.elasticsearch.common.util.concurrent.EsAbortPolicy.<init>(EsAbortPolicy.java:30)\n    at org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor.<init>(EsThreadPoolExecutor.java:36)\n    at org.elasticsearch.threadpool.ThreadPool.rebuild(ThreadPool.java:292)\n    at org.elasticsearch.threadpool.ThreadPool.build(ThreadPool.java:249)\n    at org.elasticsearch.threadpool.ThreadPool.<init>(ThreadPool.java:119)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:525)\n    at org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:54)\n    at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\n    at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:98)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:819)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:42)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:57)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:200)\n    at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:193)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:812)\n    at org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:193)\n    at org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:175)\n    at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:110)\n    at org.elasticsearch.common.inject.Guice.createInjector(Guice.java:93)\n    at org.elasticsearch.common.inject.Guice.createInjector(Guice.java:70)\n    at org.elasticsearch.common.inject.ModulesBuilder.createInjector(ModulesBuilder.java:59)\n    at org.elasticsearch.client.transport.TransportClient.<init>(TransportClient.java:177)\n    at org.elasticsearch.client.transport.TransportClient.<init>(TransportClient.java:127)\n    at ru.deltasolutions.switchyard.component.es.ESHandler.doStart(ESHandler.java:117)\n    at org.switchyard.deploy.BaseServiceHandler.start(BaseServiceHandler.java:60)\n    at org.switchyard.deploy.internal.Deployment.deployReferenceBindings(Deployment.java:309)\n    at org.switchyard.deploy.internal.Deployment.start(Deployment.java:141)\n    at org.switchyard.as7.extension.deployment.SwitchYardDeployment.start(SwitchYardDeployment.java:101)\n    at org.switchyard.as7.extension.services.SwitchYardService.start(SwitchYardService.java:73)\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.startService(ServiceControllerImpl.java:1811)\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.run(ServiceControllerImpl.java:1746)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:722)\nCaused by: java.lang.ClassNotFoundException: sun.misc.Unsafe from [Module \"org.elasticsearch:main\" from local module loader @49404e39 (finder: local module finder @1ccfa5c1 (roots: C:\\Java\\jboss-eap-6.1\\modules,C:\\Java\\jboss-eap-6.1\\modules\\system\\layers\\soa,C:\\Java\\jboss-eap-6.1\\modules\\system\\layers\\ds,C:\\Java\\jboss-eap-6.1\\modules\\system\\layers\\base))]\n    at org.jboss.modules.ModuleClassLoader.findClass(ModuleClassLoader.java:196)\n    at org.jboss.modules.ConcurrentClassLoader.performLoadClassUnchecked(ConcurrentClassLoader.java:444)\n    at org.jboss.modules.ConcurrentClassLoader.performLoadClassChecked(ConcurrentClassLoader.java:432)\n    at org.jboss.modules.ConcurrentClassLoader.performLoadClass(ConcurrentClassLoader.java:374)\n    at org.jboss.modules.ConcurrentClassLoader.loadClass(ConcurrentClassLoader.java:119)\n    ... 42 more\n\n2) Error injecting constructor, java.lang.NoClassDefFoundError: Could not initialize class org.elasticsearch.common.util.concurrent.jsr166e.LongAdder\n  at org.elasticsearch.threadpool.ThreadPool.<init>(Unknown Source)\n  while locating org.elasticsearch.threadpool.ThreadPool\n    for parameter 1 at org.elasticsearch.transport.netty.NettyTransport.<init>(Unknown Source)\n  while locating org.elasticsearch.transport.netty.NettyTransport\n  while locating org.elasticsearch.transport.Transport\n    for parameter 1 at org.elasticsearch.transport.TransportService.<init>(Unknown Source)\n  while locating org.elasticsearch.transport.TransportService\nCaused by: java.lang.NoClassDefFoundError: Could not initialize class org.elasticsearch.common.util.concurrent.jsr166e.LongAdder\n    at org.elasticsearch.common.metrics.CounterMetric.<init>(CounterMetric.java:28)\n    at org.elasticsearch.common.util.concurrent.EsAbortPolicy.<init>(EsAbortPolicy.java:30)\n    at org.elasticsearch.common.util.concurrent.EsThreadPoolExecutor.<init>(EsThreadPoolExecutor.java:36)\n    at org.elasticsearch.threadpool.ThreadPool.rebuild(ThreadPool.java:292)\n    at org.elasticsearch.threadpool.ThreadPool.build(ThreadPool.java:249)\n    at org.elasticsearch.threadpool.ThreadPool.<init>(ThreadPool.java:119)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)\n    at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:57)\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:525)\n    at org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:54)\n    at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\n    at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:98)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:819)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:42)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:57)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:45)\n    at org.elasticsearch.common.inject.SingleParameterInjector.inject(SingleParameterInjector.java:42)\n    at org.elasticsearch.common.inject.SingleParameterInjector.getAll(SingleParameterInjector.java:66)\n    at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:85)\n    at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:98)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:819)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:42)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:57)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:45)\n    at org.elasticsearch.common.inject.FactoryProxy.get(FactoryProxy.java:52)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:819)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:42)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:57)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:45)\n    at org.elasticsearch.common.inject.SingleParameterInjector.inject(SingleParameterInjector.java:42)\n    at org.elasticsearch.common.inject.SingleParameterInjector.getAll(SingleParameterInjector.java:66)\n    at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:85)\n    at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:98)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:819)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:42)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:57)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:45)\n    at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:200)\n    at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:193)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:812)\n    at org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:193)\n    at org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:175)\n    at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:110)\n    at org.elasticsearch.common.inject.Guice.createInjector(Guice.java:93)\n    at org.elasticsearch.common.inject.Guice.createInjector(Guice.java:70)\n    at org.elasticsearch.common.inject.ModulesBuilder.createInjector(ModulesBuilder.java:59)\n    at org.elasticsearch.client.transport.TransportClient.<init>(TransportClient.java:177)\n    at org.elasticsearch.client.transport.TransportClient.<init>(TransportClient.java:127)\n    at ru.deltasolutions.switchyard.component.es.ESHandler.doStart(ESHandler.java:117)\n    at org.switchyard.deploy.BaseServiceHandler.start(BaseServiceHandler.java:60)\n    at org.switchyard.deploy.internal.Deployment.deployReferenceBindings(Deployment.java:309)\n    at org.switchyard.deploy.internal.Deployment.start(Deployment.java:141)\n    at org.switchyard.as7.extension.deployment.SwitchYardDeployment.start(SwitchYardDeployment.java:101)\n    at org.switchyard.as7.extension.services.SwitchYardService.start(SwitchYardService.java:73)\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.startService(ServiceControllerImpl.java:1811)\n    at org.jboss.msc.service.ServiceControllerImpl$StartTask.run(ServiceControllerImpl.java:1746)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:722)\n\n```\n\nand so on up to 56 errors in TransportClient and up to over 2000 errors in Node client.\n\nAs I see, that's because of elasticsearch depends on special (or simple?) classloading mechanism. JBoss AS uses module classloaders and deployment classloader is different from ES module classloader.\n\nIt's a pity, but my deployment format denies me from including ES jars into the deployment, they only could be a module.\n\nThe last resort is to use Jest to communicate to ES cluster, but it seems to be not fast enough to perform at needed transaction rate...\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}