[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510038182","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510038182","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510038182,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDAzODE4Mg==","user":{"login":"dinamic","id":11616,"node_id":"MDQ6VXNlcjExNjE2","avatar_url":"https://avatars0.githubusercontent.com/u/11616?v=4","gravatar_id":"","url":"https://api.github.com/users/dinamic","html_url":"https://github.com/dinamic","followers_url":"https://api.github.com/users/dinamic/followers","following_url":"https://api.github.com/users/dinamic/following{/other_user}","gists_url":"https://api.github.com/users/dinamic/gists{/gist_id}","starred_url":"https://api.github.com/users/dinamic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinamic/subscriptions","organizations_url":"https://api.github.com/users/dinamic/orgs","repos_url":"https://api.github.com/users/dinamic/repos","events_url":"https://api.github.com/users/dinamic/events{/privacy}","received_events_url":"https://api.github.com/users/dinamic/received_events","type":"User","site_admin":false},"created_at":"2019-07-10T12:23:01Z","updated_at":"2019-07-10T12:23:01Z","author_association":"NONE","body":"The problem that I've got seem similar as to the bug report in https://github.com/elastic/elasticsearch/issues/18412","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510123872","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510123872","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510123872,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDEyMzg3Mg==","user":{"login":"dinamic","id":11616,"node_id":"MDQ6VXNlcjExNjE2","avatar_url":"https://avatars0.githubusercontent.com/u/11616?v=4","gravatar_id":"","url":"https://api.github.com/users/dinamic","html_url":"https://github.com/dinamic","followers_url":"https://api.github.com/users/dinamic/followers","following_url":"https://api.github.com/users/dinamic/following{/other_user}","gists_url":"https://api.github.com/users/dinamic/gists{/gist_id}","starred_url":"https://api.github.com/users/dinamic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinamic/subscriptions","organizations_url":"https://api.github.com/users/dinamic/orgs","repos_url":"https://api.github.com/users/dinamic/repos","events_url":"https://api.github.com/users/dinamic/events{/privacy}","received_events_url":"https://api.github.com/users/dinamic/received_events","type":"User","site_admin":false},"created_at":"2019-07-10T16:01:13Z","updated_at":"2019-07-10T16:04:48Z","author_association":"NONE","body":"@PhaedrusTheGreek could you spot something wrong with my aggregation?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510194800","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510194800","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510194800,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDE5NDgwMA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-07-10T19:24:21Z","updated_at":"2019-07-10T19:24:21Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510203127","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510203127","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510203127,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDIwMzEyNw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-07-10T19:50:46Z","updated_at":"2019-07-10T19:50:46Z","author_association":"MEMBER","body":"I believe this is the same situation as #18412, and not a bug.  What's likely happening is that your first filter finds documents that have status `completed`, but since they are nested there are also other statuses.  Then the next aggregations work on the full nested document and collect all the docs regardless of their statuses.  You probably need to invert the query as suggested in https://github.com/elastic/elasticsearch/issues/18412 (quoting from that ticket):\r\n\r\n> In the first query, the filter keeps root documents that have at leas one nested document that matches the query. Since the 2nd root document has one nested document that matches, it is selected. Then we run the nested aggregation, which can see all nested docs of this root document.\r\n> \r\n> On the other hand the second query first goes to the nested documents, and then only keeps those that match the filter, so there is only one bucket: the one that matches the filter.\r\n\r\n\r\n\r\nAlthough it's hard to say without seeing the mapping.  If you open a post at the [Discuss Forums](https://discuss.elastic.co/c/elasticsearch) with the query and the mapping we can help work through the query there.\r\n\r\nWe try to reserve Github tickets for known bugs or feature requests.  I'm going to close this ticket for now.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510495677","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510495677","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510495677,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDQ5NTY3Nw==","user":{"login":"dinamic","id":11616,"node_id":"MDQ6VXNlcjExNjE2","avatar_url":"https://avatars0.githubusercontent.com/u/11616?v=4","gravatar_id":"","url":"https://api.github.com/users/dinamic","html_url":"https://github.com/dinamic","followers_url":"https://api.github.com/users/dinamic/followers","following_url":"https://api.github.com/users/dinamic/following{/other_user}","gists_url":"https://api.github.com/users/dinamic/gists{/gist_id}","starred_url":"https://api.github.com/users/dinamic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinamic/subscriptions","organizations_url":"https://api.github.com/users/dinamic/orgs","repos_url":"https://api.github.com/users/dinamic/repos","events_url":"https://api.github.com/users/dinamic/events{/privacy}","received_events_url":"https://api.github.com/users/dinamic/received_events","type":"User","site_admin":false},"created_at":"2019-07-11T13:54:25Z","updated_at":"2019-07-11T13:56:53Z","author_association":"NONE","body":"Thanks @polyfractal!\r\n\r\nI'm still confused as to what is causing it, but am not sure whether I would feel comfortable pasting the details in a public forum. I tried to strip down some data here as I thought it would be a simple issue to tackle.\r\n\r\nThe filter aggregation should operate on the main document and not on a nested one. I would have hoped these behave differently. The next aggregation I have nested is the range one. Maybe I could try to do the range first and do the filter aggregation after that, but it really feels contra-intuitive.  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510529312","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510529312","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510529312,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDUyOTMxMg==","user":{"login":"dinamic","id":11616,"node_id":"MDQ6VXNlcjExNjE2","avatar_url":"https://avatars0.githubusercontent.com/u/11616?v=4","gravatar_id":"","url":"https://api.github.com/users/dinamic","html_url":"https://github.com/dinamic","followers_url":"https://api.github.com/users/dinamic/followers","following_url":"https://api.github.com/users/dinamic/following{/other_user}","gists_url":"https://api.github.com/users/dinamic/gists{/gist_id}","starred_url":"https://api.github.com/users/dinamic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinamic/subscriptions","organizations_url":"https://api.github.com/users/dinamic/orgs","repos_url":"https://api.github.com/users/dinamic/repos","events_url":"https://api.github.com/users/dinamic/events{/privacy}","received_events_url":"https://api.github.com/users/dinamic/received_events","type":"User","site_admin":false},"created_at":"2019-07-11T15:15:55Z","updated_at":"2019-07-11T15:15:55Z","author_association":"NONE","body":"@polyfractal just posted a question at the Discuss Forums. I would appreciate any help!\r\n\r\nHere's link to the question:\r\n- https://discuss.elastic.co/t/nested-range-aggregation-misbehaving/190055","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510824601","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510824601","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510824601,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDgyNDYwMQ==","user":{"login":"dinamic","id":11616,"node_id":"MDQ6VXNlcjExNjE2","avatar_url":"https://avatars0.githubusercontent.com/u/11616?v=4","gravatar_id":"","url":"https://api.github.com/users/dinamic","html_url":"https://github.com/dinamic","followers_url":"https://api.github.com/users/dinamic/followers","following_url":"https://api.github.com/users/dinamic/following{/other_user}","gists_url":"https://api.github.com/users/dinamic/gists{/gist_id}","starred_url":"https://api.github.com/users/dinamic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dinamic/subscriptions","organizations_url":"https://api.github.com/users/dinamic/orgs","repos_url":"https://api.github.com/users/dinamic/repos","events_url":"https://api.github.com/users/dinamic/events{/privacy}","received_events_url":"https://api.github.com/users/dinamic/received_events","type":"User","site_admin":false},"created_at":"2019-07-12T09:45:44Z","updated_at":"2019-07-12T09:46:39Z","author_association":"NONE","body":"@polyfractal I still think this is a bug. I have a filter aggregation that has a boolean statement in it and the range aggregation is nested after. So, no actual nesting could be messed up IMO.\r\n\r\nMaybe I spoke too soon and not understanding what the underlying issue in #18412 is. Maybe this misleads you on thinking it's the same problem here.\r\n\r\nThe query, the mapping, and the result are linked in the Elastic Discuss.\r\n\r\nCould you have a look, please?\r\n\r\nIf you don't think you could spend the time, maybe you could reopen the issue so someone else could have a look.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/510891234","html_url":"https://github.com/elastic/elasticsearch/issues/44162#issuecomment-510891234","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44162","id":510891234,"node_id":"MDEyOklzc3VlQ29tbWVudDUxMDg5MTIzNA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-07-12T13:42:55Z","updated_at":"2019-07-12T13:42:55Z","author_association":"MEMBER","body":"Patience...  I'm probably in a different time zone from you and can't respond to tickets immediately either :)\r\n\r\nI'll leave a reply on the forum thread.  Thanks for opening a discuss thread!","performed_via_github_app":null}]