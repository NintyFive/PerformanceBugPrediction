{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16195","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16195/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16195/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16195/events","html_url":"https://github.com/elastic/elasticsearch/issues/16195","id":128265759,"node_id":"MDU6SXNzdWUxMjgyNjU3NTk=","number":16195,"title":"Visibility problem when cluster.routing.allocation.awareness.attributes is misconfigured","user":{"login":"jordansissel","id":131818,"node_id":"MDQ6VXNlcjEzMTgxOA==","avatar_url":"https://avatars1.githubusercontent.com/u/131818?v=4","gravatar_id":"","url":"https://api.github.com/users/jordansissel","html_url":"https://github.com/jordansissel","followers_url":"https://api.github.com/users/jordansissel/followers","following_url":"https://api.github.com/users/jordansissel/following{/other_user}","gists_url":"https://api.github.com/users/jordansissel/gists{/gist_id}","starred_url":"https://api.github.com/users/jordansissel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jordansissel/subscriptions","organizations_url":"https://api.github.com/users/jordansissel/orgs","repos_url":"https://api.github.com/users/jordansissel/repos","events_url":"https://api.github.com/users/jordansissel/events{/privacy}","received_events_url":"https://api.github.com/users/jordansissel/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-01-22T22:55:00Z","updated_at":"2018-02-17T15:39:32Z","closed_at":"2018-02-17T15:39:32Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Scenario: If a cluster is misconfigured such that all nodes have `cluster.routing.allocation.awareness.attributes=some_missing_attribute` and zero nodes actually set this attribute, then shard allocation will fail and new indexes will have unallocated shards. \n\nThe symptoms are:\n- One or more indices are red\n\nThe challenge is that it is very difficult to debug this scenario. @dakrone was kind and pointed me at a nifty (advanced!) trick to ask Elasticsearch why it's allocation decision was made, and the decision is unhelpful (details below).\n\nTo reproduce this:\n\n1) Run Elasticsearch with the _default_ configuration file and the following additional settings:\n- `cluster.routing.allocation.awareness.attributes=foobar`\n\n2) Create a new index:\n\n```\n% curl -DPUT localhost:9200/example -d '{}'\n{\"acknowledged\":true}\n```\n\n3) Check the status:\n\n```\n% curl -s localhost:9200/_cat/indices|grep example\nred open example               5 1\n```\n\n4) Troubleshooting: Check the elasticsearch logs (at default level) and I don't see any information hinting at allocation issues.\n\n5) Debugging: Try a dry run allocation via _cluster/reroute:\n\n```\n% curl -s 'localhost:9200/_cluster/reroute?dry_run&explain&pretty' -d '{ \"commands\": [ { \"\nallocate\": { \"index\": \"example\", \"shard\": 0, \"node\": \"happynode\" } } ] }' | jq '.explanati\nons'\n[\n  {\n    \"command\": \"allocate\",\n    \"parameters\": {\n      \"index\": \"example\",\n      \"shard\": 0,\n      \"node\": \"happynode\",\n      \"allow_primary\": false\n    },\n    \"decisions\": [\n      {\n        \"decider\": \"allocate_allocation_command\",\n        \"decision\": \"NO\",\n        \"explanation\": \"trying to allocate a primary shard [example][0], which is disabled\n\"\n      }\n    ]\n  }\n]\n```\n\n---\n\nOverall, I believe Elasticsearch to be acting correctly (It has nowhere to route shards because of our configuration!). However, my concern is the lack of visibility into this issue for users:\n\n1) The debugging trickery via `_cluster/reroute` uses phrasing that I interpret to mean that allocation on is _disabled_.\n2) It's unclear how, without the reroute trick, how to ask Elasticsearch for hints on troubleshooting the misconfiguration\n\nFor a user, the correction would be to have at least one data node with `node.foobar: whatever` (more generally, that an awareness attribute _must_ exist on at least one data node), and with some more clear logging and/or response/hinting to tell users something along the lines of \"Could not allocate shard on any nodes because no nodes match the criteria: has attribute `foobar`\"\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}