{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27852","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27852/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27852/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27852/events","html_url":"https://github.com/elastic/elasticsearch/issues/27852","id":282697535,"node_id":"MDU6SXNzdWUyODI2OTc1MzU=","number":27852,"title":"AssertionError \"map must be empty\" when call _flush/synced after deleting document","user":{"login":"floragunn","id":11678154,"node_id":"MDQ6VXNlcjExNjc4MTU0","avatar_url":"https://avatars3.githubusercontent.com/u/11678154?v=4","gravatar_id":"","url":"https://api.github.com/users/floragunn","html_url":"https://github.com/floragunn","followers_url":"https://api.github.com/users/floragunn/followers","following_url":"https://api.github.com/users/floragunn/following{/other_user}","gists_url":"https://api.github.com/users/floragunn/gists{/gist_id}","starred_url":"https://api.github.com/users/floragunn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/floragunn/subscriptions","organizations_url":"https://api.github.com/users/floragunn/orgs","repos_url":"https://api.github.com/users/floragunn/repos","events_url":"https://api.github.com/users/floragunn/events{/privacy}","received_events_url":"https://api.github.com/users/floragunn/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2017-12-17T14:30:37Z","updated_at":"2018-02-13T20:26:30Z","closed_at":"2017-12-20T12:53:43Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n5.6.5 (5.6.4 works fine, so maybe related to https://github.com/elastic/elasticsearch/pull/27534 and https://github.com/elastic/elasticsearch/pull/27516 and https://github.com/elastic/elasticsearch/issues/20498 )\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_121\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_121-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nMac and Ubuntu\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\"java.lang.AssertionError: map must be empty\" when it not must be thrown\r\n\r\n**Steps to reproduce**:\r\n- Make sure assertions are enabled (export ES_JAVA_OPTS=-ea)\r\n- Delete a non existent document in an non existent index (curl -Ss -XDELETE  \"http://localhost:9200/x/y/1\")\r\n- Make a synced flush (curl -Ss -XPOST \"http://localhost:9200/_flush/synced\")\r\n\r\n**Provide logs (if relevant)**:\r\n<pre>\r\n[2017-12-17T15:24:39,706][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [] fatal error in thread [elasticsearch[Cj7lPWN][flush][T#3]], exiting\r\njava.lang.AssertionError: map must be empty\r\n\tat org.elasticsearch.index.engine.LiveVersionMap.adjustMapSizeUnderLock(LiveVersionMap.java:43) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.index.engine.InternalEngine.syncFlush(InternalEngine.java:997) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.index.shard.IndexShard.syncFlush(IndexShard.java:757) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.indices.flush.SyncedFlushService.performSyncedFlush(SyncedFlushService.java:423) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.indices.flush.SyncedFlushService.access$1100(SyncedFlushService.java:70) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.indices.flush.SyncedFlushService$SyncedFlushTransportHandler.messageReceived(SyncedFlushService.java:704) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.indices.flush.SyncedFlushService$SyncedFlushTransportHandler.messageReceived(SyncedFlushService.java:700) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:654) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.6.5.jar:5.6.5]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\n</pre>","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}