[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/603824811","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-603824811","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":603824811,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzgyNDgxMQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-03-25T12:59:51Z","updated_at":"2020-03-25T12:59:51Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search (:Search/Search)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/604491128","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-604491128","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":604491128,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNDQ5MTEyOA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-03-26T15:19:54Z","updated_at":"2020-03-26T15:19:54Z","author_association":"CONTRIBUTOR","body":"I saw [another failure](https://gradle-enterprise.elastic.co/s/px6mwu5a4um2c) of this test. It looks like there's a problem during test cleanup where the `.async-search` index is deleted and then re-created:\r\n\r\n```\r\n1> [2020-03-26T21:29:32,687][INFO ][o.e.x.s.AsyncSearchActionTests] [testCancellation] [AsyncSearchActionTests#testCancellation]: cleaning up after test |  \r\n-- | --\r\n  | 1> [2020-03-26T21:29:32,736][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_s0] [test-async/4xCsJ1nESwa4J36TnnOulA] deleting index |  \r\n  | 1> [2020-03-26T21:29:32,736][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node_s0] [.async-search/WeVwFd18SPWmCrHQx0qgSg] deleting index |  \r\n  | 1> [2020-03-26T21:29:32,848][WARN ][o.e.d.c.m.MetaDataCreateIndexService] [node_s0] index name [.async-search] starts with a dot '.', in the next major version, index names starting with a dot are reserved for hidden indices and system indices |  \r\n  | 1> [2020-03-26T21:29:32,851][INFO ][o.e.c.m.MetaDataCreateIndexService] [node_s0] [.async-search] creating index, cause [api], templates [random_index_template], shards [1]/[0], mappings [_doc] |  \r\n  | 1> [2020-03-26T21:29:32,851][INFO ][o.e.c.r.a.AllocationService] [node_s0] updating number_of_replicas to [1] for indices [.async-search] |  \r\n  | 1> [2020-03-26T21:29:32,876][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s0] removing template [random_index_template] |  \r\n  | 1> [2020-03-26T21:29:32,894][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s0] removing template [ilm-history] |  \r\n  | 1> [2020-03-26T21:29:32,931][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s0] adding template [ilm-history] for index patterns [ilm-history-2*] |  \r\n  | 1> [2020-03-26T21:29:32,945][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s0] removing template [.slm-history] |  \r\n  | 1> [2020-03-26T21:29:32,972][INFO ][o.e.c.m.MetaDataIndexTemplateService] [node_s0] adding template [.slm-history] for index patterns [.slm-history-2*] |  \r\n  | 1> [2020-03-26T21:29:33,068][INFO ][o.e.c.r.a.AllocationService] [node_s0] Cluster health status changed from [YELLOW] to [GREEN] (reason: [shards started [[.async-search][0]]]). |  \r\n  | 1> [2020-03-26T21:29:38,202][INFO ][o.e.x.s.AsyncSearchActionTests] [testCancellation] after test\r\n\r\n\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/604502125","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-604502125","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":604502125,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNDUwMjEyNQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-03-26T15:38:49Z","updated_at":"2020-03-26T15:38:49Z","author_association":"CONTRIBUTOR","body":"Muted in `master`, `7.x` and `7.7`: 1d3a8de f48e8f3 7491f7f","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/605079294","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-605079294","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":605079294,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNTA3OTI5NA==","user":{"login":"mark-vieira","id":4106672,"node_id":"MDQ6VXNlcjQxMDY2NzI=","avatar_url":"https://avatars2.githubusercontent.com/u/4106672?v=4","gravatar_id":"","url":"https://api.github.com/users/mark-vieira","html_url":"https://github.com/mark-vieira","followers_url":"https://api.github.com/users/mark-vieira/followers","following_url":"https://api.github.com/users/mark-vieira/following{/other_user}","gists_url":"https://api.github.com/users/mark-vieira/gists{/gist_id}","starred_url":"https://api.github.com/users/mark-vieira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mark-vieira/subscriptions","organizations_url":"https://api.github.com/users/mark-vieira/orgs","repos_url":"https://api.github.com/users/mark-vieira/repos","events_url":"https://api.github.com/users/mark-vieira/events{/privacy}","received_events_url":"https://api.github.com/users/mark-vieira/received_events","type":"User","site_admin":false},"created_at":"2020-03-27T15:58:59Z","updated_at":"2020-03-27T15:58:59Z","author_association":"CONTRIBUTOR","body":"There are a number of failures that seem to be specific to our MacOS agents. They typically look like this:\r\n\r\n```\r\norg.elasticsearch.xpack.search.AsyncSearchActionTests > testCleanupOnFailure FAILED\r\n    java.lang.AssertionError: 6 channels still being tracked in RestCancellableNodeClient while there should be none expected:<0> but was:<6>\r\n        at __randomizedtesting.SeedInfo.seed([4C0451DF11A87EF0:C71070CDB7AD6138]:0)\r\n        at org.junit.Assert.fail(Assert.java:88)\r\n        at org.junit.Assert.failNotEquals(Assert.java:834)\r\n        at org.junit.Assert.assertEquals(Assert.java:645)\r\n        at org.elasticsearch.test.ESIntegTestCase.lambda$clearClusters$2(ESIntegTestCase.java:551)\r\n        at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:917)\r\n        at org.elasticsearch.test.ESTestCase.assertBusy(ESTestCase.java:890)\r\n        at org.elasticsearch.test.ESIntegTestCase.clearClusters(ESIntegTestCase.java:549)\r\n        at org.elasticsearch.test.ESIntegTestCase.buildAndPutCluster(ESIntegTestCase.java:523)\r\n        at org.elasticsearch.test.ESIntegTestCase.beforeInternal(ESIntegTestCase.java:381)\r\n        at org.elasticsearch.test.ESIntegTestCase.setupTestCluster(ESIntegTestCase.java:2192)\r\n        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n```\r\n\r\nThis doesn't happen locally for me on my MBP so it might be infra related but I don't know enough about these tests to infer what that might be. Seems isolated to `AsyncSearchActionTests`.\r\n\r\nLet me know if I should open a separate issue for this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/605082614","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-605082614","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":605082614,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNTA4MjYxNA==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-03-27T16:04:26Z","updated_at":"2020-03-27T16:04:26Z","author_association":"MEMBER","body":"thanks for your comment @mark-vieira I will look into this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/605090131","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-605090131","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":605090131,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNTA5MDEzMQ==","user":{"login":"mark-vieira","id":4106672,"node_id":"MDQ6VXNlcjQxMDY2NzI=","avatar_url":"https://avatars2.githubusercontent.com/u/4106672?v=4","gravatar_id":"","url":"https://api.github.com/users/mark-vieira","html_url":"https://github.com/mark-vieira","followers_url":"https://api.github.com/users/mark-vieira/followers","following_url":"https://api.github.com/users/mark-vieira/following{/other_user}","gists_url":"https://api.github.com/users/mark-vieira/gists{/gist_id}","starred_url":"https://api.github.com/users/mark-vieira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mark-vieira/subscriptions","organizations_url":"https://api.github.com/users/mark-vieira/orgs","repos_url":"https://api.github.com/users/mark-vieira/repos","events_url":"https://api.github.com/users/mark-vieira/events{/privacy}","received_events_url":"https://api.github.com/users/mark-vieira/received_events","type":"User","site_admin":false},"created_at":"2020-03-27T16:18:34Z","updated_at":"2020-03-27T16:18:34Z","author_association":"CONTRIBUTOR","body":"Ah, I forgot to include a link to an example build. Here you are @javanna.\r\n\r\nhttps://gradle-enterprise.elastic.co/s/msim2zdegwhzg","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/605949132","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-605949132","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":605949132,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNTk0OTEzMg==","user":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"created_at":"2020-03-30T11:39:55Z","updated_at":"2020-03-30T11:41:50Z","author_association":"MEMBER","body":"More [MacOS failures like this comment](https://github.com/elastic/elasticsearch/issues/54180#issuecomment-605079294): \r\n\r\nhttps://gradle-enterprise.elastic.co/s/7rni7zuujym2m (7.x)\r\nhttps://gradle-enterprise.elastic.co/s/wr5bjpe6hejig (7.7)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/605951346","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-605951346","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":605951346,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNTk1MTM0Ng==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2020-03-30T11:45:21Z","updated_at":"2020-03-30T11:45:21Z","author_association":"MEMBER","body":"I seems that we have two types of failure here. One that fails with:\r\n`````\r\njava.lang.AssertionError: 6 channels still being tracked in RestCancellableNodeClient while there should be none expected:<0> but was:<6>\r\n`````\r\nand another one that fails with:\r\n`````\r\norg.elasticsearch.xpack.search.AsyncSearchActionTests > testCancellation FAILED\r\n    java.lang.AssertionError: Shard [.async-search][0] is still locked after 5 sec waiting\r\n`````\r\nThey are maybe linked but the former is weird since it fails with a rest layer assertion on tests that should only use the transport client. I suspect that the leaked channels are coming from other tests that failed to cleanup their connections.  @javanna were you able to reproduce ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/606986380","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-606986380","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":606986380,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNjk4NjM4MA==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-04-01T02:15:15Z","updated_at":"2020-04-01T04:11:39Z","author_association":"MEMBER","body":"I commented and re-openned #53360. But decided to move it here since this issue is more recent and active. I do want to emphasize that the errors are not just for testCancellation as it says in the title. In fact, ~the new failures do not even include testCancellation~ (I noticed it's muted). They are for the following test methods:\r\n\r\n```\r\nAsyncSearchActionTests classMethod\r\nAsyncSearchActionTests testCleanupOnFailure\r\nAsyncSearchActionTests testDeleteCancelRunningTask\r\nAsyncSearchActionTests testDeleteCleanupIndex\r\nAsyncSearchActionTests testInvalidId\r\nAsyncSearchActionTests testMaxMinAggregation\r\nAsyncSearchActionTests testNoIndex\r\nAsyncSearchActionTests testRestartAfterCompletion\r\nAsyncSearchActionTests testTermsAggregation\r\n```\r\n\r\nIt started to fail for \"darwin-compatibility\" since March 27 for `master`, `7.x` and `7.7`. **On CI, all tests of this class fail all the time for \"darwin-compatibility\"**. The trend can be seen [here](https://gradle-enterprise.elastic.co/scans/tests?list.size=50&list.sortColumn=startTime&list.sortOrder=desc&search.buildToolType=gradle&search.buildToolType=maven&search.relativeStartTime=P7D&search.tags=CI&search.tags=MAC&search.tzOffset=660&tests.container=org.elasticsearch.xpack.search.AsyncSearchActionTests&tests.sortField=FAILED&tests.unstableOnly=true).\r\n\r\nBut I _cannot_ reproduce locally:\r\n```\r\n./gradlew ':x-pack:plugin:async-search:test' --tests \"org.elasticsearch.xpack.search.AsyncSearchActionTests.testNoIndex\" \\\r\n  -Dtests.seed=49A4746586643385 \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=es-MX \\\r\n  -Dtests.timezone=SystemV/MST7MDT \\\r\n  -Dcompiler.java=13\r\n```\r\n\r\nSample error message\r\n```\r\n:x-pack:plugin:async-search:test » org.elasticsearch.xpack.search.AsyncSearchActionTests » testNoIndex (11.246s)\r\n6 channels still being tracked in RestCancellableNodeClient while there should be none expected:<0> but was:<6>\r\njava.lang.AssertionError: 6 channels still being tracked in RestCancellableNodeClient while there should be none expected:<0> but was:<6>\r\n```\r\n\r\nBuild scan:\r\nhttps://gradle-enterprise.elastic.co/s/q4uaac6hl4jvu\r\n\r\nBuild log:\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-darwin-compatibility/613/console\r\n\r\nFailure email notification:\r\nhttps://groups.google.com/a/elastic.co/forum/?utm_medium=email&utm_source=footer#!topic/build-elasticsearch/vxu0iDmfzcg\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/607094002","html_url":"https://github.com/elastic/elasticsearch/issues/54180#issuecomment-607094002","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54180","id":607094002,"node_id":"MDEyOklzc3VlQ29tbWVudDYwNzA5NDAwMg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-04-01T07:55:43Z","updated_at":"2020-04-01T07:55:43Z","author_association":"MEMBER","body":"Thanks @ywangd you are right that there isn't a proper issue for the failure that you saw. I opened a PR: #54520 . The reason why you don't see `testCancellation` fail is because it's muted due to its failures ;)","performed_via_github_app":null}]