{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41509","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41509/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41509/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41509/events","html_url":"https://github.com/elastic/elasticsearch/issues/41509","id":436914999,"node_id":"MDU6SXNzdWU0MzY5MTQ5OTk=","number":41509,"title":"Prevent field_value_factor from calculating negative scores","user":{"login":"dschneiter","id":1571991,"node_id":"MDQ6VXNlcjE1NzE5OTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1571991?v=4","gravatar_id":"","url":"https://api.github.com/users/dschneiter","html_url":"https://github.com/dschneiter","followers_url":"https://api.github.com/users/dschneiter/followers","following_url":"https://api.github.com/users/dschneiter/following{/other_user}","gists_url":"https://api.github.com/users/dschneiter/gists{/gist_id}","starred_url":"https://api.github.com/users/dschneiter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dschneiter/subscriptions","organizations_url":"https://api.github.com/users/dschneiter/orgs","repos_url":"https://api.github.com/users/dschneiter/repos","events_url":"https://api.github.com/users/dschneiter/events{/privacy}","received_events_url":"https://api.github.com/users/dschneiter/received_events","type":"User","site_admin":false},"labels":[{"id":418189364,"node_id":"MDU6TGFiZWw0MTgxODkzNjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Ranking","name":":Search/Ranking","color":"0e8a16","default":false,"description":"Scoring, rescoring, rank evaluation."},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2019-04-24T21:27:12Z","updated_at":"2019-05-06T21:52:17Z","closed_at":"2019-05-06T21:52:16Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\nNot 100% sure this is a bug report (or whether it should be a change request).\r\nThis issue is related to #33309 and #35709\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 7.0.0, Build: default/tar/b7e28a7/2019-04-05T22:55:32.697037Z, JVM: 1.8.0_152\r\n\r\n**Plugins installed**:\r\n- analysis-icu      7.0.0\r\n- analysis-kuromoji 7.0.0\r\n- analysis-phonetic 7.0.0\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_152\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_152-b16)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.152-b16, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDarwin Daniels-MacBook-Pro-Elastic.local 17.7.0 Darwin Kernel Version 17.7.0: Wed Feb 27 00:43:23 PST 2019; root:xnu-4570.71.35~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nUsing the \"wrong\" modifier in a field_value_factor currently can result in a negative factor which would result in a negative score which again gets prevented by raising exception `field value function must not produce negative scores`. As a consequence, such a query won't return any results.\r\nWouldn't it be more reasonable to prevent field_value_factor from returning negative values by returning 0 (=max(0, modified score)) in cases like the modifier function computing a negative value (example `ln(0.8)`)?\r\nOr as an alternative, no longer support now potentially \"dangerous\" modifier functions such as `ln`?\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n*Step 1*\r\nPOST test/_doc/1\r\n{\r\n  \"title\": \"Test document\",\r\n  \"popularity\": 0.8\r\n}\r\n\r\n*Step 2*  \r\nGET test/_search\r\n{\r\n  \"query\": {\r\n    \"function_score\": {\r\n      \"query\": {\r\n        \"match\": {\r\n          \"title\": \"test\"\r\n        }\r\n      },\r\n      \"functions\": [\r\n        {\r\n          \"field_value_factor\": {\r\n            \"field\": \"popularity\",\r\n            \"missing\": 1,\r\n            \"modifier\": \"ln\"\r\n          }\r\n        }\r\n      ],\r\n      \"boost_mode\": \"sum\"\r\n    }\r\n  }\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"performed_via_github_app":null}