{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24807","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24807/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24807/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24807/events","html_url":"https://github.com/elastic/elasticsearch/issues/24807","id":230074361,"node_id":"MDU6SXNzdWUyMzAwNzQzNjE=","number":24807,"title":"Error using miles for percision in Geo Location Context","user":{"login":"KellyBennett","id":4806426,"node_id":"MDQ6VXNlcjQ4MDY0MjY=","avatar_url":"https://avatars2.githubusercontent.com/u/4806426?v=4","gravatar_id":"","url":"https://api.github.com/users/KellyBennett","html_url":"https://github.com/KellyBennett","followers_url":"https://api.github.com/users/KellyBennett/followers","following_url":"https://api.github.com/users/KellyBennett/following{/other_user}","gists_url":"https://api.github.com/users/KellyBennett/gists{/gist_id}","starred_url":"https://api.github.com/users/KellyBennett/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/KellyBennett/subscriptions","organizations_url":"https://api.github.com/users/KellyBennett/orgs","repos_url":"https://api.github.com/users/KellyBennett/repos","events_url":"https://api.github.com/users/KellyBennett/events{/privacy}","received_events_url":"https://api.github.com/users/KellyBennett/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"assignees":[{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2017-05-19T19:54:52Z","updated_at":"2018-07-11T14:48:53Z","closed_at":"2018-04-04T21:39:31Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**:\r\n5.1.2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nHere is the search I want to run:\r\n\r\n```\r\nPOST stores_search/_search?\r\n{\r\n  \"suggest\": {\r\n    \"store-suggest\": {\r\n      \"prefix\": \"Combs\",\r\n      \"completion\": {\r\n        \"field\": \"suggest\",\r\n        \"fuzzy\": {\r\n          \"fuzziness\": \"AUTO\",\r\n          \"transpositions\": true\r\n        },\r\n        \"size\": 100,\r\n        \"contexts\": {\r\n          \"location\": [\r\n            {\r\n              \"lat\": 47.6062,\r\n              \"lon\": -122.3321,\r\n              \"precision\": \"100m\"\r\n            }\r\n          ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nI need to provide my precision in distance. The docs state this is possible:\r\n```\r\nThe precision of the geohash to encode the query geo point. This can be specified as a distance value (5m, 10km etc.), or as a raw geohash precision (1..12). Defaults to index time precision level.\r\n```\r\n\r\nBut instead of getting stores within that geo location, I get this error response:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"parsing_exception\",\r\n        \"reason\": \"[geo] failed to parse field [precision]\",\r\n        \"line\": 1,\r\n        \"col\": 57\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query_fetch\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"stores_search\",\r\n        \"node\": \"Se4Iz_2cS4OGdz33kndgGg\",\r\n        \"reason\": {\r\n          \"type\": \"parsing_exception\",\r\n          \"reason\": \"[geo] failed to parse field [precision]\",\r\n          \"line\": 1,\r\n          \"col\": 57,\r\n          \"caused_by\": {\r\n            \"type\": \"number_format_exception\",\r\n            \"reason\": \"For input string: \\\"1000mi\\\"\"\r\n          }\r\n        }\r\n      }\r\n    ],\r\n    \"caused_by\": {\r\n      \"type\": \"parsing_exception\",\r\n      \"reason\": \"[geo] failed to parse field [precision]\",\r\n      \"line\": 1,\r\n      \"col\": 57,\r\n      \"caused_by\": {\r\n        \"type\": \"number_format_exception\",\r\n        \"reason\": \"For input string: \\\"1000mi\\\"\"\r\n      }\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\nIf i change precision to `1` (or any number in (1..12)), my search completes with no errors.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create a mapping as an example try:\r\n```\r\nPUT place\r\n{\r\n    \"mappings\": {\r\n        \"shops\" : {\r\n            \"properties\" : {\r\n                \"suggest\" : {\r\n                    \"type\" : \"completion\",\r\n                    \"contexts\": [\r\n                        { \r\n                            \"name\": \"place_type\",\r\n                            \"type\": \"category\",\r\n                            \"path\": \"cat\"\r\n                        },\r\n                        { \r\n                            \"name\": \"location\",\r\n                            \"type\": \"geo\",\r\n                            \"precision\": 4\r\n                        }\r\n                    ]\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n 2. Put some documents in the new index, as an example:\r\n```\r\nPUT place/shops/1\r\n{\r\n    \"suggest\": {\r\n        \"input\": \"timmy's\",\r\n        \"contexts\": {\r\n            \"location\": [\r\n                {\r\n                    \"lat\": 43.6624803,\r\n                    \"lon\": -79.3863353\r\n                },\r\n                {\r\n                    \"lat\": 43.6624718,\r\n                    \"lon\": -79.3873227\r\n                }\r\n            ]\r\n        }\r\n    }\r\n}\r\n```\r\n 3. Do a lil' query:\r\n```\r\nPOST place/_suggest?pretty\r\n{\r\n    \"suggest\" : {\r\n        \"prefix\" : \"tim\",\r\n        \"completion\" : {\r\n            \"field\" : \"suggest\",\r\n            \"size\": 10,\r\n            \"contexts\": {\r\n                \"location\": [ \r\n                    {\r\n                        \"lat\": 43.6624803,\r\n                        \"lon\": -79.3863353,\r\n                        \"precision\": \"2m\"\r\n                    },\r\n                    {\r\n                        \"context\": {\r\n                            \"lat\": 43.6624803,\r\n                            \"lon\": -79.3863353\r\n                        },\r\n                        \"boost\": 2\r\n                    }\r\n                 ]\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nresult:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"parsing_exception\",\r\n        \"reason\": \"[geo] failed to parse field [precision]\",\r\n        \"line\": 1,\r\n        \"col\": 62\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"place\",\r\n        \"node\": \"Se4Iz_2cS4OGdz33kndgGg\",\r\n        \"reason\": {\r\n          \"type\": \"parsing_exception\",\r\n          \"reason\": \"[geo] failed to parse field [precision]\",\r\n          \"line\": 1,\r\n          \"col\": 62,\r\n          \"caused_by\": {\r\n            \"type\": \"number_format_exception\",\r\n            \"reason\": \"For input string: \\\"2m\\\"\"\r\n          }\r\n        }\r\n      }\r\n    ],\r\n    \"caused_by\": {\r\n      \"type\": \"parsing_exception\",\r\n      \"reason\": \"[geo] failed to parse field [precision]\",\r\n      \"line\": 1,\r\n      \"col\": 62,\r\n      \"caused_by\": {\r\n        \"type\": \"number_format_exception\",\r\n        \"reason\": \"For input string: \\\"2m\\\"\"\r\n      }\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}