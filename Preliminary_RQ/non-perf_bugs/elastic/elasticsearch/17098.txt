{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17098","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17098/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17098/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17098/events","html_url":"https://github.com/elastic/elasticsearch/issues/17098","id":140771672,"node_id":"MDU6SXNzdWUxNDA3NzE2NzI=","number":17098,"title":"Regexp Query Cannot Accept Escaped '+'","user":{"login":"tebriel","id":821688,"node_id":"MDQ6VXNlcjgyMTY4OA==","avatar_url":"https://avatars1.githubusercontent.com/u/821688?v=4","gravatar_id":"","url":"https://api.github.com/users/tebriel","html_url":"https://github.com/tebriel","followers_url":"https://api.github.com/users/tebriel/followers","following_url":"https://api.github.com/users/tebriel/following{/other_user}","gists_url":"https://api.github.com/users/tebriel/gists{/gist_id}","starred_url":"https://api.github.com/users/tebriel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tebriel/subscriptions","organizations_url":"https://api.github.com/users/tebriel/orgs","repos_url":"https://api.github.com/users/tebriel/repos","events_url":"https://api.github.com/users/tebriel/events{/privacy}","received_events_url":"https://api.github.com/users/tebriel/received_events","type":"User","site_admin":true},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":13,"created_at":"2016-03-14T19:14:59Z","updated_at":"2016-03-15T18:14:19Z","closed_at":"2016-03-15T17:20:28Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 2.2.0\n\n**JVM version**: 1.8.0_72-internal\n\n**OS version**: debian-jessie\n\n**Description of the problem including expected versus actual behavior**:\n\nI have a lot of data in E.164 format in a field called data.cid_info.e164. These are internationally standardized phone numbers. I want to find all phone numbers that start with +44 (UK prefix). As this is a string field, a regexp query seems sufficient. So I issue a search as follows:\n\n``` json\n{\n  \"query\": {\n    \"regexp\": {\n      \"data.cid_info.e164\": \"^+44.*\"\n    }\n  },\n  \"fields\": [\"data.cid_info.e164\"],\n  \"size\": 10\n}\n```\n\nI expect 343 hits for today (will explain how I know this in a second) but I get 0 instead.\n\nOh, but you say, + is not an allowed character and must be escaped. Sure, so let's try that using the docs. It states that to escape a special character, precede it with a `\\`.\n\n``` json\n{\n  \"query\": {\n    \"regexp\": {\n      \"data.cid_info.e164\": \"^\\+44.*\"\n    }\n  },\n  \"fields\": [\"data.cid_info.e164\"],\n  \"size\": 10\n}\n```\n\nSense immediately throws an exception, but let's ignore sense's exception for a second and carry on.\n\n``` json\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"query_parsing_exception\",\n            \"reason\": \"Failed to parse\",\n            \"index\": \"logstash-2016.03.14\"\n         }\n      ],\n      \"type\": \"search_phase_execution_exception\",\n      \"reason\": \"all shards failed\",\n      \"phase\": \"query\",\n      \"grouped\": true,\n      \"failed_shards\": [\n         {\n            \"shard\": 0,\n            \"index\": \"logstash-2016.03.14\",\n            \"node\": \"YOEgLqVGSbGgIgbXJJqSNg\",\n            \"reason\": {\n               \"type\": \"query_parsing_exception\",\n               \"reason\": \"Failed to parse\",\n               \"index\": \"logstash-2016.03.14\",\n               \"caused_by\": {\n                  \"type\": \"json_parse_exception\",\n                  \"reason\": \"Unrecognized character escape '+' (code 43)\\n at [Source: [B@1dfa7073; line: 4, column: 33]\"\n               }\n            }\n         }\n      ]\n   },\n   \"status\": 400\n}\n```\n\nNow, because I know my data, and I know it conforms to the E.164 format for the field, I know I can safely suggest that the + is optional, and it will return me the right counts (good for troubleshooting this bug, not a good general practice).\n\n``` json\n{\n  \"query\": {\n    \"regexp\": {\n      \"data.cid_info.e164\": \"^+?44.*\"\n    }\n  },\n  \"fields\": [\"data.cid_info.e164\"],\n  \"size\": 0\n}\n```\n\nResulting in:\n\n```\n{\n  \"_shards\": {\n    \"failed\": 0,\n    \"successful\": 2,\n    \"total\": 2\n  },\n  \"hits\": {\n    \"hits\": [],\n    \"max_score\": 0.0,\n    \"total\": 343\n  },\n  \"timed_out\": false,\n  \"took\": 2\n}\n```\n\nHey, it's the right number!\n\nI believe this is due to the [JSON spec](http://www.json.org/) not allowing escaped characters that aren't control characters.\n\n> char\n> any-Unicode-character-\n>     except-\"-or--or-\n>     control-character\n> \\\"\n> \\\n> \\/\n> \\b\n> \\f\n> \\n\n> \\r\n> \\t\n> \\u four-hex-digits\n\nSo I'm not sure that there is a way to do a web request with an escaped character in the JSON body.\n\nNote that escaping the \\ doesn't work either, as that returns 0 results `\"^\\\\+44.*\"` for reference. \n\n**Steps to reproduce**:\n1. Issue a regex query with an escaped `+` sign (data which has a literal plus in it), see examples above\n2. Note that no results were returned\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}