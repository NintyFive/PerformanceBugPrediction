{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29328","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29328/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29328/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29328/events","html_url":"https://github.com/elastic/elasticsearch/issues/29328","id":310355398,"node_id":"MDU6SXNzdWUzMTAzNTUzOTg=","number":29328,"title":"Migrate scripted metric agg scripts to new ScriptContext design and use context variables for agg state","user":{"login":"rationull","id":6431686,"node_id":"MDQ6VXNlcjY0MzE2ODY=","avatar_url":"https://avatars2.githubusercontent.com/u/6431686?v=4","gravatar_id":"","url":"https://api.github.com/users/rationull","html_url":"https://github.com/rationull","followers_url":"https://api.github.com/users/rationull/followers","following_url":"https://api.github.com/users/rationull/following{/other_user}","gists_url":"https://api.github.com/users/rationull/gists{/gist_id}","starred_url":"https://api.github.com/users/rationull/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rationull/subscriptions","organizations_url":"https://api.github.com/users/rationull/orgs","repos_url":"https://api.github.com/users/rationull/repos","events_url":"https://api.github.com/users/rationull/events{/privacy}","received_events_url":"https://api.github.com/users/rationull/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2018-04-01T21:27:03Z","updated_at":"2018-08-29T09:12:58Z","closed_at":"2018-08-29T09:12:57Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Per discussion on #28819 it would be nice to have custom ScriptContexts (and the abstract Script classes to go with them) for the scripts involved in scripted metric aggregations. One goal is to provide the _agg/_aggs variable as a script context variable rather than in the params map. Another goal is to continue migrating scripts to use the new dedicated context design.\r\n\r\nPer discussion in #30111 `_agg` and `_aggs` shall become `state` and `states` when moved into the context.\r\n\r\nThe four script types in play, with their desired context properties:\r\n* init: params map, agg map\r\n* map: params map, agg map, doc, score (anything else? Do we need to do anything for _fields and _source here? I have a feeling we don't but I'm not sure)\r\n* combine: params map, agg map\r\n* reduce: params map, aggs array\r\n\r\nWe'll also need to modify ScriptedMetricAggregator where it pulls out the _agg param to use the new context variable instead.\r\n\r\nAnother concern is backwards compatibility since ultimately we would remove _agg/_aggs from params. I would guess the strategy here is to leave both the old and the new in place for at least one major release. Would we emit a deprecation warning whenever scripted metric aggregations are used or somehow try to detect uses of the old _agg/_aggs params in scripts and only emit a warning then? Any cases where we touch the agg variable content in code would need to honor the legacy _agg/_aggs content if present as well. I would assume we can rule that either the new context variable or the legacy params (not a mix of both) would be used within a given set of aggregation scripts.","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}