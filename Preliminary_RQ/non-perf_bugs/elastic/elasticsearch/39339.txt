{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/39339","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39339/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39339/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39339/events","html_url":"https://github.com/elastic/elasticsearch/issues/39339","id":413951303,"node_id":"MDU6SXNzdWU0MTM5NTEzMDM=","number":39339,"title":"Internal index unrecoverable when upgrade from 5.6.x fails to reindex","user":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"labels":[{"id":163824881,"node_id":"MDU6TGFiZWwxNjM4MjQ4ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Indices%20APIs","name":":Core/Features/Indices APIs","color":"0e8a16","default":false,"description":"APIs to create and manage indices"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":151933706,"node_id":"MDU6TGFiZWwxNTE5MzM3MDY=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eupgrade","name":">upgrade","color":"c7def8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"assignees":[{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-02-25T06:23:01Z","updated_at":"2019-03-08T00:47:15Z","closed_at":"2019-03-08T00:47:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"When following the steps mentioned in the [upgrade guide](https://www.elastic.co/guide/en/elastic-stack/6.6/upgrading-elastic-stack.html),\r\nif we disable the cluster shard allocation but fail to enable it after\r\nupgrading the nodes and plugins, the next step of upgrading internal\r\nindices fails. As we did not check the bulk response for reindexing,\r\nwe delete the old index assuming it has been reindexed successfully.\r\nThis is fatal as we cannot recover from this state since index to be upgraded\r\nhas been deleted.\r\n\r\n**Steps to follow:-**\r\nFollowing the upgrade guide:\r\nhttps://www.elastic.co/guide/en/elastic-stack/6.6/upgrading-elastic-stack.html\r\n\r\n- Before the upgrade, we disable cluster shard allocation (Step 1)\r\n- And after the upgrade of the node(s) to 6.6, plugins upgrade we need to enable the cluster shard allocation (Step 8 )\r\n- And then run the upgrade internal indices step if you are upgrading from 5.6 (https://www.elastic.co/guide/en/elastic-stack/6.6/upgrading-elastic-stack.html#upgrade-internal-indices)\r\n\r\nIf we miss the step of enabling cluster shard allocation, during reindex operation `UnavailableShardsException` is thrown.\r\nBut as we do not check the `BulkByScrollResponse` if there were any failures and proceed as a successful operation thereby deleting the internal index.\r\n\r\n**Solution:-**\r\nThere should be a pre-upgrade check before proceeding with the upgrade. Also, in the case where reindex fails for some reason, it should not delete the original index.","closed_by":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"performed_via_github_app":null}