{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36881","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36881/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36881/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36881/events","html_url":"https://github.com/elastic/elasticsearch/issues/36881","id":392913487,"node_id":"MDU6SXNzdWUzOTI5MTM0ODc=","number":36881,"title":"stackoverflowerror when bulk data or update task","user":{"login":"FarmerLinT","id":46016262,"node_id":"MDQ6VXNlcjQ2MDE2MjYy","avatar_url":"https://avatars0.githubusercontent.com/u/46016262?v=4","gravatar_id":"","url":"https://api.github.com/users/FarmerLinT","html_url":"https://github.com/FarmerLinT","followers_url":"https://api.github.com/users/FarmerLinT/followers","following_url":"https://api.github.com/users/FarmerLinT/following{/other_user}","gists_url":"https://api.github.com/users/FarmerLinT/gists{/gist_id}","starred_url":"https://api.github.com/users/FarmerLinT/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/FarmerLinT/subscriptions","organizations_url":"https://api.github.com/users/FarmerLinT/orgs","repos_url":"https://api.github.com/users/FarmerLinT/repos","events_url":"https://api.github.com/users/FarmerLinT/events{/privacy}","received_events_url":"https://api.github.com/users/FarmerLinT/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-12-20T06:50:05Z","updated_at":"2019-02-06T11:33:58Z","closed_at":"2019-02-06T11:33:58Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\nour nodes are crashing caused by stackoverflowerror often，if happens when bulk data or update task。\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n 5.5.1\r\n\r\n**Plugins installed**: \r\nelasticsearch-sql-5.5.1\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_111\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_111-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.111-b14, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 3.10.0.-229.el77.x86_64 #1 SMP Fri Mar 6 11:36:42 UTC 2015 x86_64 x86_64  x86_64  GNU/Linux \r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nour nodes are crashing caused by stackoverflowerror often，if happens when bulk data(datanode) or update task(master)。\r\nIt's on a cluster with 7 datanodes, 3700 indices,  9500 shards, 70 To of total data, 30 billions documents.\r\n\r\n**Steps to reproduce**:\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1.It seems to happens on a bulk or updatetask request but I don't know which one.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n> datanode crash log:\r\n[2018-12-20T13:33:11,525][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [datanode001] fatal error in thread [elasticsearch[datanode001][bulk][T#4]], exiting\r\njava.lang.StackOverflowError: null\r\n        at java.util.Spliterators$IteratorSpliterator.estimateSize(Spliterators.java:1821) ~[?:1.8.0_111]\r\n        at java.util.Spliterator.getExactSizeIfKnown(Spliterator.java:408) ~[?:1.8.0_111]\r\n        at java.util.stream.AbstractPipeline.exactOutputSizeIfKnown(AbstractPipeline.java:466) ~[?:1.8.0_111]\r\n        at java.util.stream.AbstractPipeline.evaluate(AbstractPipeline.java:544) ~[?:1.8.0_111]\r\n        at java.util.stream.AbstractPipeline.evaluateToArrayNode(AbstractPipeline.java:260) ~[?:1.8.0_111]\r\n        at java.util.stream.ReferencePipeline.toArray(ReferencePipeline.java:438) ~[?:1.8.0_111]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:511) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:477) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.index.mapper.ObjectMapper.toXContent(ObjectMapper.java:525) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\t\t\r\n\t\t\r\n\r\n> master crash log:\r\n[2018-12-20T13:35:15,933][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [master001] fatal error in thread [elasticsearch[master001][clusterService#updateTask][T#1]], exiting\r\njava.lang.StackOverflowError: null\r\n        at com.fasterxml.jackson.core.util.InternCache.intern(InternCache.java:61) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at com.fasterxml.jackson.core.sym.ByteQuadsCanonicalizer.addName(ByteQuadsCanonicalizer.java:813) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at com.fasterxml.jackson.core.json.UTF8StreamJsonParser.addName(UTF8StreamJsonParser.java:2394) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at com.fasterxml.jackson.core.json.UTF8StreamJsonParser.parseEscapedName(UTF8StreamJsonParser.java:2034) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at com.fasterxml.jackson.core.json.UTF8StreamJsonParser.parseName(UTF8StreamJsonParser.java:1925) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at com.fasterxml.jackson.core.json.UTF8StreamJsonParser._parseName(UTF8StreamJsonParser.java:1747) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at com.fasterxml.jackson.core.json.UTF8StreamJsonParser.nextToken(UTF8StreamJsonParser.java:776) ~[jackson-core-2.8.6.jar:2.8.6]\r\n        at org.elasticsearch.common.xcontent.json.JsonXContentParser.nextToken(JsonXContentParser.java:55) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:310) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readMap(AbstractXContentParser.java:317) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n        at org.elasticsearch.common.xcontent.support.AbstractXContentParser.readValue(AbstractXContentParser.java:375) ~[elasticsearch-5.5.1.jar:5.5.1]\r\n\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}