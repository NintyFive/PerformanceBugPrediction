[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731270007","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731270007","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731270007,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTI3MDAwNw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T16:29:51Z","updated_at":"2020-11-20T16:29:51Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-ql (Team:QL)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731281994","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731281994","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731281994,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTI4MTk5NA==","user":{"login":"palesz","id":1084370,"node_id":"MDQ6VXNlcjEwODQzNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/1084370?v=4","gravatar_id":"","url":"https://api.github.com/users/palesz","html_url":"https://github.com/palesz","followers_url":"https://api.github.com/users/palesz/followers","following_url":"https://api.github.com/users/palesz/following{/other_user}","gists_url":"https://api.github.com/users/palesz/gists{/gist_id}","starred_url":"https://api.github.com/users/palesz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/palesz/subscriptions","organizations_url":"https://api.github.com/users/palesz/orgs","repos_url":"https://api.github.com/users/palesz/repos","events_url":"https://api.github.com/users/palesz/events{/privacy}","received_events_url":"https://api.github.com/users/palesz/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T16:52:27Z","updated_at":"2020-11-20T16:52:27Z","author_association":"CONTRIBUTOR","body":"Thanks for the awesome bug report, taking a look.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731299185","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731299185","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731299185,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTI5OTE4NQ==","user":{"login":"palesz","id":1084370,"node_id":"MDQ6VXNlcjEwODQzNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/1084370?v=4","gravatar_id":"","url":"https://api.github.com/users/palesz","html_url":"https://github.com/palesz","followers_url":"https://api.github.com/users/palesz/followers","following_url":"https://api.github.com/users/palesz/following{/other_user}","gists_url":"https://api.github.com/users/palesz/gists{/gist_id}","starred_url":"https://api.github.com/users/palesz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/palesz/subscriptions","organizations_url":"https://api.github.com/users/palesz/orgs","repos_url":"https://api.github.com/users/palesz/repos","events_url":"https://api.github.com/users/palesz/events{/privacy}","received_events_url":"https://api.github.com/users/palesz/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T17:24:58Z","updated_at":"2020-11-20T17:24:58Z","author_association":"CONTRIBUTOR","body":"Good news in the bad news is that I can reproduce this problem with a unit test. Taking a deeper dive.\r\n\r\n\r\nUnit test in the `QueryTranslator` on the `master` branch:\r\n\r\n    public void testBug() {\r\n        PhysicalPlan p = optimizeAndPlan(\"SELECT keyword FROM test WHERE date >= '2010-06-18T22:58:43.000Z' AND keyword <> '00882F6' ORDER BY keyword LIMIT 3\");\r\n        assertEquals(EsQueryExec.class, p.getClass());\r\n    }\r\n\r\nReveals the following query translation process:\r\n\r\n    [2020-11-21T05:21:22,837][DEBUG][o.e.x.s.p.QueryFolder    ] [testBug] Tree transformation took 48ms\r\n    LimitExec[3[INTEGER]]                                                        ! EsQueryExec[test,{\r\n    \\_OrderExec[[Order[test.keyword{f}#9,ASC,LAST]]]                             !   \"query\" : {\r\n      \\_ProjectExec[[test.keyword{f}#9]]                                         !     \"range\" : {\r\n        \\_FilterExec[test.date{f}#10 >= 2010-06-18T22:58:43.000Z[KEYWORD],false] !       \"date\" : {\r\n          \\_EsQueryExec[test,{                                                   !         \"from\" : \"2010-06-18T22:58:43.000Z\",\r\n      \"_source\" : false,                                                         !         \"to\" : null,\r\n      \"stored_fields\" : \"_none_\",                                                !         \"include_lower\" : true,\r\n      \"sort\" : [                                                                 !         \"include_upper\" : false,\r\n        {                                                                        !         \"time_zone\" : \"Z\",\r\n          \"_doc\" : {                                                             !         \"boost\" : 1.0\r\n            \"order\" : \"asc\"                                                      !       }\r\n          }                                                                      !     }\r\n        }                                                                        !   },\r\n      ]                                                                          !   \"_source\" : false,\r\n    }]                                                                           !   \"stored_fields\" : \"_none_\",\r\n                                                                                 !   \"docvalue_fields\" : [\r\n                                                                                 !     {\r\n                                                                                 !       \"field\" : \"keyword\"\r\n                                                                                 !     }\r\n                                                                                 !   ],\r\n                                                                                 !   \"sort\" : [\r\n                                                                                 !     {\r\n                                                                                 !       \"keyword\" : {\r\n                                                                                 !         \"order\" : \"asc\",\r\n                                                                                 !         \"missing\" : \"_last\",\r\n                                                                                 !         \"unmapped_type\" : \"keyword\"\r\n                                                                                 !       }\r\n                                                                                 !     }\r\n                                                                                 !   ]\r\n                                                                                 ! }]\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731301419","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731301419","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731301419,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTMwMTQxOQ==","user":{"login":"palesz","id":1084370,"node_id":"MDQ6VXNlcjEwODQzNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/1084370?v=4","gravatar_id":"","url":"https://api.github.com/users/palesz","html_url":"https://github.com/palesz","followers_url":"https://api.github.com/users/palesz/followers","following_url":"https://api.github.com/users/palesz/following{/other_user}","gists_url":"https://api.github.com/users/palesz/gists{/gist_id}","starred_url":"https://api.github.com/users/palesz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/palesz/subscriptions","organizations_url":"https://api.github.com/users/palesz/orgs","repos_url":"https://api.github.com/users/palesz/repos","events_url":"https://api.github.com/users/palesz/events{/privacy}","received_events_url":"https://api.github.com/users/palesz/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T17:29:12Z","updated_at":"2020-11-20T17:29:12Z","author_association":"CONTRIBUTOR","body":"Seems the problem is somewhere here:\r\n\r\n```\r\n[2020-11-21T05:21:22,705][TRACE][o.e.x.s.o.Optimizer      ] [testBug] Rule optimizer.OptimizerRules$CombineBinaryComparisons applied\r\nLimit[3[INTEGER]]                                                                                            = Limit[3[INTEGER]]\r\n\\_OrderBy[[Order[test.keyword{f}#9,ASC,LAST]]]                                                               = \\_OrderBy[[Order[test.keyword{f}#9,ASC,LAST]]]\r\n  \\_Project[[test.keyword{f}#9]]                                                                             =   \\_Project[[test.keyword{f}#9]]\r\n    \\_Filter[test.date{f}#10 >= 2010-06-18T22:58:43.000Z[KEYWORD] AND test.keyword{f}#9 != 00882F6[KEYWORD]] !     \\_Filter[test.date{f}#10 >= 2010-06-18T22:58:43.000Z[KEYWORD]]\r\n      \\_EsRelation[test][bool{f}#6, int{f}#7, text{f}#8, keyword{f}#9, date{..]                              =       \\_EsRelation[test][bool{f}#6, int{f}#7, text{f}#8, keyword{f}#9, date{..]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731310818","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731310818","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731310818,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTMxMDgxOA==","user":{"login":"palesz","id":1084370,"node_id":"MDQ6VXNlcjEwODQzNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/1084370?v=4","gravatar_id":"","url":"https://api.github.com/users/palesz","html_url":"https://github.com/palesz","followers_url":"https://api.github.com/users/palesz/followers","following_url":"https://api.github.com/users/palesz/following{/other_user}","gists_url":"https://api.github.com/users/palesz/gists{/gist_id}","starred_url":"https://api.github.com/users/palesz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/palesz/subscriptions","organizations_url":"https://api.github.com/users/palesz/orgs","repos_url":"https://api.github.com/users/palesz/repos","events_url":"https://api.github.com/users/palesz/events{/privacy}","received_events_url":"https://api.github.com/users/palesz/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T17:48:03Z","updated_at":"2020-11-20T17:48:03Z","author_association":"CONTRIBUTOR","body":"The first issue is that `OptimizerRules$CombineBinaryComparisons` tries to combine the `test.date{f}#10 >= 2010-06-18T22:58:43.000Z[KEYWORD]` and `test.keyword{f}#9 != 00882F6[KEYWORD]` that are both BinaryComparisons, but for different fields (left side is NOT the same as the right field). But the code does not check it. It sees that the right side of the negation is a keyword (string) that lexically before the right side of the first expression `2010-06-18T22:58:43.000Z[KEYWORD]`, so it thinks the negation can be dropped from the `AND`. This is of course incorrect.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731332916","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731332916","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731332916,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTMzMjkxNg==","user":{"login":"magicwerk","id":18592562,"node_id":"MDQ6VXNlcjE4NTkyNTYy","avatar_url":"https://avatars2.githubusercontent.com/u/18592562?v=4","gravatar_id":"","url":"https://api.github.com/users/magicwerk","html_url":"https://github.com/magicwerk","followers_url":"https://api.github.com/users/magicwerk/followers","following_url":"https://api.github.com/users/magicwerk/following{/other_user}","gists_url":"https://api.github.com/users/magicwerk/gists{/gist_id}","starred_url":"https://api.github.com/users/magicwerk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/magicwerk/subscriptions","organizations_url":"https://api.github.com/users/magicwerk/orgs","repos_url":"https://api.github.com/users/magicwerk/repos","events_url":"https://api.github.com/users/magicwerk/events{/privacy}","received_events_url":"https://api.github.com/users/magicwerk/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T18:18:43Z","updated_at":"2020-11-20T18:18:43Z","author_association":"NONE","body":"Can you think of a workaround by writing the query in a different way to get a correct result?\r\nOr is the only option to wait for a bug fix?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/731334899","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-731334899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":731334899,"node_id":"MDEyOklzc3VlQ29tbWVudDczMTMzNDg5OQ==","user":{"login":"palesz","id":1084370,"node_id":"MDQ6VXNlcjEwODQzNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/1084370?v=4","gravatar_id":"","url":"https://api.github.com/users/palesz","html_url":"https://github.com/palesz","followers_url":"https://api.github.com/users/palesz/followers","following_url":"https://api.github.com/users/palesz/following{/other_user}","gists_url":"https://api.github.com/users/palesz/gists{/gist_id}","starred_url":"https://api.github.com/users/palesz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/palesz/subscriptions","organizations_url":"https://api.github.com/users/palesz/orgs","repos_url":"https://api.github.com/users/palesz/repos","events_url":"https://api.github.com/users/palesz/events{/privacy}","received_events_url":"https://api.github.com/users/palesz/received_events","type":"User","site_admin":false},"created_at":"2020-11-20T18:22:54Z","updated_at":"2020-11-20T18:22:54Z","author_association":"CONTRIBUTOR","body":"For this particular query (and where you have `!=` in the query) using `field NOT IN ('<value>')` instead of `field != '<value>'` is a good workaround. At the moment I am not sure about all the possible where clauses and conjunctions that might be impacted though.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/733086165","html_url":"https://github.com/elastic/elasticsearch/issues/65322#issuecomment-733086165","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/65322","id":733086165,"node_id":"MDEyOklzc3VlQ29tbWVudDczMzA4NjE2NQ==","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"created_at":"2020-11-24T16:19:52Z","updated_at":"2020-11-24T16:19:52Z","author_association":"MEMBER","body":"In case it was overlooked another workaround (and more readable) is in the issue description - namely casting the date in string format to a date.","performed_via_github_app":null}]