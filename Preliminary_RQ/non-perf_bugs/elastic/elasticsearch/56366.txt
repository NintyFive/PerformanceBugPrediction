{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/56366","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56366/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56366/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56366/events","html_url":"https://github.com/elastic/elasticsearch/issues/56366","id":614204800,"node_id":"MDU6SXNzdWU2MTQyMDQ4MDA=","number":56366,"title":"[ML] Flaws in connection of named pipes to native processes","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-05-07T16:55:41Z","updated_at":"2020-05-15T09:13:32Z","closed_at":"2020-05-15T09:13:01Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"There are a couple of problems with connection of named pipes to the ML native processes if the native process logs lots of messages before or during the connection process.\r\n\r\nIn the ML native processes any logging that happens before the logging named pipe is connected is written to the process's stderr.  In the case of the `controller` process, this is connected to the JVM, but the JVM doesn't read it.  This means that if the `controller` process logs more than the size of the buffer on that stream before it connects its logging pipe then it will hang.  (This early on in the program's lifecycle, low level error messages written directly from the C runtime library or some other system library are more likely that logging via our logging framework, and these would also go to stderr on Linux.)\r\n\r\nThe other ML processes (`autodetect`, `normalize`, etc.) have their stderr redirected to `/dev/null` so this problem doesn't affect them.  Only `controller` suffers from this first risk.\r\n\r\nThe second problem is that in the `ProcessPipes.connectStreams()` method the Java side of the connection attempts to connect all the pipes one after the other before reading from any of them.  Since it is not reading from the logging pipe until all pipes are connected, if the native process logs more messages than the size of the logging named pipe's buffer in between connecting the logging pipe and connecting the last pipe then it will hang.\r\n\r\nUsually neither of these problems occurs.  We have run successfully for years without any known occurrences of these problems.  This is because the ML native processes log very very little this early on in their lifecycle.  In normal operation they log nothing before opening the logging pipe and only the process name and version number in between opening the logging named pipe and the last named pipe (and that must fit within the named pipe's buffer on all systems we've ever tested on).\r\n\r\nHowever, recently a user encountered a problem that may be an occurrence of problem 1, and while debugging this I encountered problem 2, so we should fix them.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}