{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31895","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31895/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31895/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31895/events","html_url":"https://github.com/elastic/elasticsearch/issues/31895","id":339402761,"node_id":"MDU6SXNzdWUzMzk0MDI3NjE=","number":31895,"title":"nested object / aggregation, Get Variation with positiv stock values","user":{"login":"eyyazubi","id":17872358,"node_id":"MDQ6VXNlcjE3ODcyMzU4","avatar_url":"https://avatars3.githubusercontent.com/u/17872358?v=4","gravatar_id":"","url":"https://api.github.com/users/eyyazubi","html_url":"https://github.com/eyyazubi","followers_url":"https://api.github.com/users/eyyazubi/followers","following_url":"https://api.github.com/users/eyyazubi/following{/other_user}","gists_url":"https://api.github.com/users/eyyazubi/gists{/gist_id}","starred_url":"https://api.github.com/users/eyyazubi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/eyyazubi/subscriptions","organizations_url":"https://api.github.com/users/eyyazubi/orgs","repos_url":"https://api.github.com/users/eyyazubi/repos","events_url":"https://api.github.com/users/eyyazubi/events{/privacy}","received_events_url":"https://api.github.com/users/eyyazubi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-07-09T11:01:21Z","updated_at":"2018-07-09T12:33:10Z","closed_at":"2018-07-09T12:33:10Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version:\r\n6.2\r\n-----------\r\nGood day,\r\n\r\nwe are not moving forward with nested object and aggregation.\r\nIn the example below, there are variations as nested.\r\nWe only want values ​​with positive stock in the aggregations.\r\n\r\nHow can we solve this best?\r\n\r\n<pre>PUT products {\r\n  \"mappings\": {\r\n    \"product\": {\r\n      \"properties\": {\r\n        \"categories\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"id\": {\r\n              \"type\": \"integer\",\r\n              \"index\": false\r\n            },\r\n            \"name\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"slug\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"images\": {\r\n          \"type\": \"text\",\r\n          \"index\": false\r\n        },\r\n        \"index\": {\r\n          \"properties\": {\r\n            \"_id\": {\r\n              \"type\": \"long\"\r\n            },\r\n            \"_index\": {\r\n              \"type\": \"text\",\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"type\": \"keyword\",\r\n                  \"ignore_above\": 256\r\n                }\r\n              }\r\n            },\r\n            \"_type\": {\r\n              \"type\": \"text\",\r\n              \"fields\": {\r\n                \"keyword\": {\r\n                  \"type\": \"keyword\",\r\n                  \"ignore_above\": 256\r\n                }\r\n              }\r\n            }\r\n          }\r\n        },\r\n        \"name\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"permalink\": {\r\n          \"type\": \"text\",\r\n          \"index\": false\r\n        },\r\n        \"related_products\": {\r\n          \"properties\": {\r\n            \"first_image\": {\r\n              \"type\": \"text\",\r\n              \"index\": false\r\n            },\r\n            \"permalink\": {\r\n              \"type\": \"text\",\r\n              \"index\": false\r\n            }\r\n          }\r\n        },\r\n        \"variations\": {\r\n          \"type\": \"nested\",\r\n          \"properties\": {\r\n            \"brand-name\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"brand-slug\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"color\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"price\": {\r\n              \"type\": \"double\"\r\n            },\r\n            \"sale_price\": {\r\n              \"type\": \"double\"\r\n            },\r\n            \"size\": {\r\n              \"type\": \"keyword\"\r\n            },\r\n            \"stock\": {\r\n              \"type\": \"integer\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}</pre>\r\n\r\n<pre>PUT products/product/1 {\r\n  \"name\": \"Only - SAMANTHA S/S PULLOVER KNT BB - Grün (HONEYDEW)\",\r\n  \"permalink\": \"/only-samantha-s-s-pullover-knt-bb-gruen-honeydew/\",\r\n  \"categories\": [\r\n    {\r\n      \"id\": 1368,\r\n      \"name\": \"Bekleidung\",\r\n      \"slug\": \"bekleidung\"\r\n    },\r\n    {\r\n      \"id\": 1367,\r\n      \"name\": \"Damen\",\r\n      \"slug\": \"damen\"\r\n    },\r\n    {\r\n      \"id\": 1413,\r\n      \"name\": \"Kurzarmpullover\",\r\n      \"slug\": \"kurzarmpullover\"\r\n    },\r\n    {\r\n      \"id\": 6980,\r\n      \"name\": \"Only\",\r\n      \"slug\": \"only\"\r\n    },\r\n    {\r\n      \"id\": 1408,\r\n      \"name\": \"Pullover\",\r\n      \"slug\": \"pullover\"\r\n    },\r\n    {\r\n      \"id\": 1407,\r\n      \"name\": \"Pullover & Strickjacken\",\r\n      \"slug\": \"pullover-strickjacken\"\r\n    },\r\n    {\r\n      \"id\": 1420,\r\n      \"name\": \"Rundhalspullover\",\r\n      \"slug\": \"rundhalspullover\"\r\n    }\r\n  ],\r\n  \"images\": [\r\n    \"/wp-content/uploads/2018/05/87cc3bb4884582ba6030cdcb80def112.jpg\",\r\n    \"/wp-content/uploads/2018/05/2a05ce66c0ce35086c85357f8439a935.jpg\"\r\n  ],\r\n  \"variations\": [\r\n    {\r\n      \"stock\": 0,\r\n      \"sale_price\": \"29.95\",\r\n      \"price\": \"29.95\",\r\n      \"color\": \"Grün\",\r\n      \"brand-slug\": \"only\",\r\n      \"brand-name\": \"Only\",\r\n      \"size\": \"L\"\r\n    },\r\n    {\r\n      \"stock\": 1,\r\n      \"sale_price\": \"29.95\",\r\n      \"price\": \"29.95\",\r\n      \"color\": \"Grün\",\r\n      \"brand-slug\": \"only\",\r\n      \"brand-name\": \"Only\",\r\n      \"size\": \"M\"\r\n    },\r\n    {\r\n      \"stock\": 0,\r\n      \"sale_price\": \"29.95\",\r\n      \"price\": \"29.95\",\r\n      \"color\": \"Grün\",\r\n      \"brand-slug\": \"only\",\r\n      \"brand-name\": \"Only\",\r\n      \"size\": \"S\"\r\n    },\r\n    {\r\n      \"stock\": 0,\r\n      \"sale_price\": \"29.95\",\r\n      \"price\": \"29.95\",\r\n      \"color\": \"Grün\",\r\n      \"brand-slug\": \"only\",\r\n      \"brand-name\": \"Only\",\r\n      \"size\": \"XS\"\r\n    }\r\n  ],\r\n  \"related_products\": []\r\n}</pre>\r\n<pre>\r\nGET products/_search {\r\n  \"from\": 0,\r\n  \"size\": 800,\r\n  \"aggs\": {\r\n    \"prices\": {\r\n      \"aggs\": {\r\n        \"min_price\": {\r\n          \"min\": {\r\n            \"field\": \"variations.price\"\r\n          }\r\n        },\r\n        \"max_price\": {\r\n          \"max\": {\r\n            \"field\": \"variations.price\"\r\n          }\r\n        }\r\n      },\r\n      \"nested\": {\r\n        \"path\": \"variations\"\r\n      }\r\n    },\r\n    \"nested_colors\": {\r\n      \"nested\": {\r\n        \"path\": \"variations\"\r\n      },\r\n      \"aggs\": {\r\n        \"colors\": {\r\n          \"terms\": {\r\n            \"field\": \"variations.color\",\r\n            \"size\": 10000,\r\n            \"order\": [\r\n              {\r\n                \"_term\": \"asc\"\r\n              }\r\n            ]\r\n          },\r\n          \"aggs\": {\r\n            \"reverse_nested_colors\": {\r\n              \"reverse_nested\": {}\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"nested_sizes\": {\r\n      \"nested\": {\r\n        \"path\": \"variations\"\r\n      },\r\n      \"aggs\": {\r\n        \"sizes\": {\r\n          \"terms\": {\r\n            \"field\": \"variations.size\",\r\n            \"size\": 10000\r\n          },\r\n          \"aggs\": {\r\n            \"reverse_nested_sizes\": {\r\n              \"reverse_nested\": {}\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"nested_categories\": {\r\n      \"nested\": {\r\n        \"path\": \"categories\"\r\n      },\r\n      \"aggs\": {\r\n        \"categories\": {\r\n          \"terms\": {\r\n            \"field\": \"categories.id\",\r\n            \"size\": 10000\r\n          },\r\n          \"aggs\": {\r\n            \"reverse_nested_categories\": {\r\n              \"reverse_nested\": {}\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"nested_brands\": {\r\n      \"nested\": {\r\n        \"path\": \"variations\"\r\n      },\r\n      \"aggs\": {\r\n        \"brands\": {\r\n          \"terms\": {\r\n            \"field\": \"variations.brand-slug\",\r\n            \"size\": 10000\r\n          },\r\n          \"aggs\": {\r\n            \"reverse_nested_brands\": {\r\n              \"reverse_nested\": {}\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"must_not\": {\r\n                  \"match\": {\r\n                    \"variations.stock\": 0\r\n                  }\r\n                }\r\n              }\r\n            },\r\n            \"path\": \"variations\",\r\n            \"score_mode\": \"max\"\r\n          }\r\n        },\r\n        {\r\n          \"nested\": {\r\n            \"query\": {\r\n              \"bool\": {\r\n                \"must\": [\r\n                  {\r\n                    \"match\": {\r\n                      \"categories.slug\": \"damen\"\r\n                    }\r\n                  }\r\n                ]\r\n              }\r\n            },\r\n            \"path\": \"categories\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}</pre>","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}