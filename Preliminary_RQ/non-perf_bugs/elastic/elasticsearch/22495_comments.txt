[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271255277","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271255277","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271255277,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI1NTI3Nw==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T10:46:54Z","updated_at":"2017-01-09T10:46:54Z","author_association":"CONTRIBUTOR","body":"Hmm, this is not good: it means on Java 9 we (ES) are failing to use Lucene's unmapping best efforts.  Here's the root cause:\r\n\r\n```\r\nFAILURE 0.02s J0 | LuceneTests.testMMapHackSupported <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: MMapDirectory does not support unmapping: Unmapping is not supported on this platform, because internal Java APIs are not compatible to this Lucene version: java.lang.IllegalAccessException: symbolic reference class is not accessible: class jdk.internal.ref.Cleaner, from org.apache.lucene.store.MMapDirectory (unnamed module @77dd2cd6)\r\n   > \tat __randomizedtesting.SeedInfo.seed([ECC3BC902EFF7263:1D3CDF5BF2E129A4]:0)\r\n   > \tat org.elasticsearch.common.lucene.LuceneTests.testMMapHackSupported(LuceneTests.java:408)\r\n```\r\n\r\nI don't think it's a missing security permission, because Lucene throws a different message in that case.\r\n\r\nMaybe our 1.9-ea is too old in the ES jenkins instance?  We are running with `9-ea-150` but from https://jdk9.java.net/ it looks like it's up to `ea-151`.\r\n\r\nOtherwise I'm not sure what's wrong ... @uschindler any pointers welcome :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271255991","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271255991","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271255991,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI1NTk5MQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T10:50:48Z","updated_at":"2017-01-09T10:50:48Z","author_association":"MEMBER","body":"I think this issue is fixed in Lucene for java9 150+:\r\nhttps://issues.apache.org/jira/browse/LUCENE-6989\r\nhttps://git-wip-us.apache.org/repos/asf?p=lucene-solr.git;h=7e03427 ?\r\n\r\nI think there is also another issue that should prevent java9 to build:\r\nhttps://issues.apache.org/jira/browse/LUCENE-7596\r\n\r\nThere is an ongoing discussion on the Lucene dev mailing list regarding the next release compatibility with java9. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271258687","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271258687","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271258687,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI1ODY4Nw==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T11:05:14Z","updated_at":"2017-01-09T11:05:14Z","author_association":"CONTRIBUTOR","body":"Thanks for the pointers @jimczi!\r\n\r\n> I think this issue is fixed in Lucene for java9 150+\r\n\r\nOK I think I understand now: Lucene 6.4.0 will have this fix (https://issues.apache.org/jira/browse/LUCENE-6989), to use unmapping with Java 9-ea 150+, but Lucene 6.3.0 (which ES 5.0, 5.1 are using) cannot do unmapping with Java 9-ea 150+.\r\n\r\nSo we should disable this test in ES 5.0, 5.1, but keep it in ES 5.x (5.2)?  And notify ES users that if they use Java 9, they should use ES 5.2+ so unmap works.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271270394","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271270394","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271270394,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI3MDM5NA==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T12:13:40Z","updated_at":"2017-01-09T12:17:06Z","author_association":"CONTRIBUTOR","body":"Hi,\r\n\r\n*first:* If you have tests that fail on *any* Java version if unmapping does not work, it should ignore this failure. You should add some `assumeTrue(MMapDirectory.UNMAP_NOT_SUPPORTED_REASON, MMapDirectory.UNMAP_SUPPORTED)` to disable test exceution.\r\n\r\nAs Lucene tests only break on windows if unmapping is not supported, we have a special Assume in LuceneTestCase that enforces that unmapping works on windows only, for other OS it is happy also if unmapping does not work (it's just bad that it does not work for disk usage, but does not prevent tests from succeeding): `LuceneTestCase.assumeWorkingMMapOnWindows()`\r\n\r\n*second:* Under some circumstances Lucene 6.0 - Lucene 6.3 and MMapDirectory completely fails, because the static initializer does not catch a new Java 9 RuntimeException (my fault, I am so sorry) and breaks class initialization (you don't see this in your tests, what Lucene version and which permissions are you using?). So people may completely fail unless they use another directory implementation.\r\n\r\nLucene 6.4 will be compatible with Java 9 b150, but it will no longer work with Java 9 build 100 to 149, because the code to support those versions was removed. It is very likely that the new variant will work also with the final release, because they added an API for unmapping in build 150 (although it is in sun.misc.Unsafe, but that is what it is: it's unsafe, because it may crush you JVM if you misuse the API). The new hack will of course work with Java 8 and very early Java 9 versions.\r\n\r\nTo fix the mmap issue in general, we have to wait for Java 10, there are some ideas of changing Hotspot and Java's memory model (a new type of field access with \"volatile only on safepoint\" semantics using VarHandles) that will be integrated internally into DirectByteBuffer. When you then \"officially\" unmap a bytebuffer it will also trigger a JVM safepoint, that makes a field in ByteBuffer suddenly behaving \"volatile\". After that it unmaps and sets the field to null, because its code that accesses the bytebuffer will do the volatile check. It's just too late for Java 9. Once this is done, ByteBuffer will be java.io.Closeable or similar and you can \"officially\" call ByteBuffer.close(), but until this happens we have to hack around it. I will discuss this with Andrew Haley and Mark Reinhold (+ Alan Bateman) on FOSDEM :-) I am sure the NETTY people will also happy about this!\r\n\r\nI'd wait to make Java 9 compatibility public until Java 9 is out there :-) Once it is out we can offcially say: Use a minimum of that version of Elasticsearch using that version of Lucene. If it is urgent we may also backport the final fix to older Lucene versions and release bugfixes for 6.0, 6.1, 6.2, 6.3, so Elasticsearch can make the mainline versions (5.x) compatible to Java 9.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271271561","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271271561","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271271561,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI3MTU2MQ==","user":{"login":"uschindler","id":1005388,"node_id":"MDQ6VXNlcjEwMDUzODg=","avatar_url":"https://avatars2.githubusercontent.com/u/1005388?v=4","gravatar_id":"","url":"https://api.github.com/users/uschindler","html_url":"https://github.com/uschindler","followers_url":"https://api.github.com/users/uschindler/followers","following_url":"https://api.github.com/users/uschindler/following{/other_user}","gists_url":"https://api.github.com/users/uschindler/gists{/gist_id}","starred_url":"https://api.github.com/users/uschindler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/uschindler/subscriptions","organizations_url":"https://api.github.com/users/uschindler/orgs","repos_url":"https://api.github.com/users/uschindler/repos","events_url":"https://api.github.com/users/uschindler/events{/privacy}","received_events_url":"https://api.github.com/users/uschindler/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T12:20:51Z","updated_at":"2017-01-09T12:20:51Z","author_association":"CONTRIBUTOR","body":"I just noticed, Lucene 6.0 till 6.3 will not break fatally anymore with Java 9 build 150+. It just disables unmapping (as it should - which triggers your test failure). The reason is the Lucene-proposed Unsafe fix included in build 150. So my old (broken) code only breaks fatally in build 148 and 149, so all is fine! Users will be able to start ES, but unmapping just does not work.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271298299","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271298299","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271298299,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI5ODI5OQ==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T14:32:23Z","updated_at":"2017-01-09T14:32:23Z","author_association":"CONTRIBUTOR","body":"Thanks @uschindler for the explanations!  The ES test is here to catch us if unmap is unexpectedly not working, but in this case (Lucene < 6.3.0, Java 1.9 ea 150+) we know unmap does not work.\r\n\r\nSo I'll just open a PR to add an `assume` to this test, for just 5.0, 5.1, that if the java version is 1.9, then unmap won't work.\r\n\r\nOn 5.x we already use Lucene's 6.x snapshot (soon to be 6.4.0) which has your recent fixes for LUCENE-6989 (thank you!) so the test case doesn't need the assume there.\r\n\r\nAnd I agree we should make no promises about Java 9 support until Java 9 is released!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271298662","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271298662","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271298662,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTI5ODY2Mg==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T14:33:45Z","updated_at":"2017-01-09T14:33:45Z","author_association":"CONTRIBUTOR","body":"@uschindler for the rescue !!! thanks man","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271332474","html_url":"https://github.com/elastic/elasticsearch/issues/22495#issuecomment-271332474","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22495","id":271332474,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTMzMjQ3NA==","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2017-01-09T16:30:35Z","updated_at":"2017-01-09T16:30:35Z","author_association":"CONTRIBUTOR","body":"Fixed in 5.0 and 5.1.","performed_via_github_app":null}]