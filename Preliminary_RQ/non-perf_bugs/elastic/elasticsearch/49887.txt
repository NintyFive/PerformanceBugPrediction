{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49887","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49887/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49887/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49887/events","html_url":"https://github.com/elastic/elasticsearch/issues/49887","id":533584047,"node_id":"MDU6SXNzdWU1MzM1ODQwNDc=","number":49887,"title":"Update centroid calculation of geo_shape for geo-centroid","user":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2019-12-05T20:34:15Z","updated_at":"2020-02-03T19:25:02Z","closed_at":"2020-02-03T19:25:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**where things are now**\r\n\r\nAs the `geoshape-doc-values` branch stands today, the centroid is \r\ndefined as the centroid of all the geometry's vertices.\r\n\r\nWhy the update?\r\n\r\nAfter a re-visit of this strategy, we decided that it would be worth \r\nmodifying this calculation to be closer in line with how popular \r\ngeo-spatial data-stores compute the centroid.\r\n\r\nAfter exploring existing implementations for some of these, it seems there are a few commonalities. I'll list in the detailed definition below.\r\n\r\n**Proposed detailed definition of a centroid of a geo_shape field**\r\n\r\n| Geometry Type | Centroid Calculation  |\r\n|---|---|\r\n| [Multi]Point |  equally weighted average of all the coordinates  |\r\n| [Multi]LineString  |  a weighted average of all the centroids of each segment, where the weight of each segment is its length in degrees  |\r\n| [Multi]Polygon  | a weighted average of all the centroids of all the triangles of a polygon where the triangles are formed by every two consecutive vertices and the starting-point. holes have negative weights. weights represent the area of the triangle in deg^2 calculated using [The Shoelace Formulate](https://en.wikipedia.org/wiki/Shoelace_formula)  |\r\n| GeometryCollection  | The centroid of all the underlying geometries with the highest dimension. If Polygons and Lines and/or Points, then lines and/or points are ignored. If Lines and Points, then points are ignored |\r\n\r\n**Proposed definition of a geo-centroid of a bucket**\r\n\r\nThe un-weighted centroid of the centroid of each shape within the bucket.\r\n\r\nBelow is a summary of the descriptions from various sources:\r\n\r\n- **OGC Standard**\r\n> \"No specific algorithm is specified for the Centroid function; answers may vary with implementation.\"\r\n>\r\n> \\- OpenGISÂ® Implementation Standard for Geographic information - Simple feature access - Part 2: SQL option\r\n\r\nThe OGC standard does not specify any specific way one \r\nshould calculate the centroid.\r\n\r\n- **[Oracle SQL](https://docs.oracle.com/database/121/SPATL/sdo_geom-sdo_centroid.htm#SPATL1112)**\r\n>Returns a point geometry that is the centroid of a polygon, multipolygon, point, or point cluster. (The centroid is also known as the \"center of gravity.\")\r\n>\r\n>For an input geometry consisting of multiple objects, the result is weighted by the area of each polygon in the geometry objects. If the geometry objects are a mixture of polygons and points, the points are not used in the calculation of the centroid. If the geometry objects are all points, the points have equal weight.\r\n\r\nThe Oracle definition does not specify how one should implement and define `weight`.\r\nIt interestingly also does not describe the behavior for line-strings.\r\n\r\n- **[PostGIS](https://postgis.net/docs/ST_Centroid.html)**\r\n> Computes the geometric center of a geometry, or equivalently, the center of mass of the geometry as a POINT. For [MULTI]POINTs, this is computed as the arithmetic mean of the input coordinates. For [MULTI]LINESTRINGs, this is computed as the weighted length of each line segment. For [MULTI]POLYGONs, \"weight\" is thought in terms of area. If an empty geometry is supplied, an empty GEOMETRYCOLLECTION is returned. If NULL is supplied, NULL is returned. If CIRCULARSTRING or COMPOUNDCURVE are supplied, they are converted to linestring wtih CurveToLine first, then same than for LINESTRING\r\n>\r\n> The centroid is equal to the centroid of the set of component Geometries of highest dimension\r\n\r\nSimilarly, this description does not go into detail about how either the \"center of mass\" or the \"weighted length\" is calculated.\r\n\r\n**Discussion Item**\r\n\r\n- Is this new definition of centroid the one we would like?\r\nFor example, there can be multiple interpretations of how \r\nthe centroid as an aggregate function should be calculated.\r\nThese specs define ST_Centroid as a simple function on one \r\nfield value. Geo Centroid aggregation is the centroid of a field\r\nin multiple documents. Should all these field values be treated as \r\na singular GeometryCollection which the centroid is derived from, \r\nor should we treat each document as a singular point (computed using above)\r\nwith equal weight.\r\n- should weight be measured in degrees and degrees^2, or meters and meters^2?","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}