{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32761/events","html_url":"https://github.com/elastic/elasticsearch/issues/32761","id":349360073,"node_id":"MDU6SXNzdWUzNDkzNjAwNzM=","number":32761,"title":"[Fielddata] Terms aggregation on keyword field with doc values consume huge fielddata cache, may cause OOM","user":{"login":"boicehuang","id":4607177,"node_id":"MDQ6VXNlcjQ2MDcxNzc=","avatar_url":"https://avatars3.githubusercontent.com/u/4607177?v=4","gravatar_id":"","url":"https://api.github.com/users/boicehuang","html_url":"https://github.com/boicehuang","followers_url":"https://api.github.com/users/boicehuang/followers","following_url":"https://api.github.com/users/boicehuang/following{/other_user}","gists_url":"https://api.github.com/users/boicehuang/gists{/gist_id}","starred_url":"https://api.github.com/users/boicehuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/boicehuang/subscriptions","organizations_url":"https://api.github.com/users/boicehuang/orgs","repos_url":"https://api.github.com/users/boicehuang/repos","events_url":"https://api.github.com/users/boicehuang/events{/privacy}","received_events_url":"https://api.github.com/users/boicehuang/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2018-08-10T03:04:59Z","updated_at":"2018-11-27T10:49:25Z","closed_at":"2018-08-10T09:30:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Description of the problem including expected versus actual behavior**:\r\n\r\nFrom issue #12394 we know that in-memory field data for field-types that support doc-values are removed. But, every time after running a big terms aggregation query on a keyword field enabled with doc_values,  which has one hundred million buckets,  my field data cache is being consumed up to 7.1gb and triggered parent breaker,  cause normal requests to the cluster to be rejected continuously.  The parent-level breaker is configured with 30% of 20gb JVM heap,  the field data circuit breaker is configured with 3% of JVM heap and I expect them to protect cluster. When can keyword field with doc values enabled consume field data cache and cause a lot of memory?\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):  5.6.4 \r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version** (`java -version`):  1.8.0_91-b14\r\n\r\n**Elasticsearch.yml** :  \r\n\r\n> \r\nindices.queries.cache.count: 500\r\nprocessors: 2\r\ncluster.routing.allocation.disk.watermark.high: 95%\r\ncluster.routing.allocation.disk.watermark.low: 90%\r\nnetwork.publish_host: 1.1.1.1\r\nindices.queries.cache.size: 5%\r\nnode.data: true\r\ndiscovery.zen.minimum_master_nodes: 1\r\ncluster.name: pe5qmzs4\r\nnode.master: true\r\nnode.attr.ip: 1.1.1.1\r\nnode.ingest: true\r\ntransport.tcp.port: 9300\r\nindices.memory.index_buffer_size: 15%\r\nthread_pool.bulk.queue_size: 1024\r\nhttp.port: 9200\r\nnetwork.host: 0.0.0.0\r\nindices.breaker.request.limit: 6%\r\nindices.breaker.fielddata.limit: 3%\r\nindices.breaker.total.limit: 30%\r\n\r\n**JVM**:\r\n-Xms20000m\r\n-Xmx20000m\r\n\r\n**Steps to reproduce**:\r\n\r\n 1.   Prepare a cluster with 150gb data that contains a keyword field with one hundred million distinct value\r\n 2.  Run the query below\r\n> GET index/_search?\r\n{\r\n    \"size\": 0,\r\n   \"aggregations\": {  \r\n        \"agg_trace_id\": {  \r\n            \"terms\": {  \r\n                \"field\": \"keyword_field\"\r\n            }\r\n        }\r\n    }  \r\n}\r\n\r\n**Fielddata**:\r\nSending _stats/fielddata?fields=keyword_field&human=true \r\nResult: \r\n> {\r\n  \"_shards\" : {\r\n    \"total\" : 231,\r\n    \"successful\" : 157,\r\n    \"failed\" : 73,\r\n    \"failures\" : [\r\n      { \r\n        \"shard\" : 2,\r\n        \"index\" : \"index\",\r\n        \"status\" : \"INTERNAL_SERVER_ERROR\",\r\n        \"reason\" : {\r\n          \"type\" : \"failed_node_exception\",\r\n          \"reason\" : \"Failed node [lg8-CJLRS_KUlb2tkAWnZw]\",\r\n          \"caused_by\" : {\r\n            \"type\" : \"circuit_breaking_exception\",\r\n            \"reason\" : \"[parent] Data too large, data for [<transport_request>] would be [7647861567/7.1gb], which is larger than the limit of [6192011673/5.7gb]\",\r\n            \"bytes_wanted\" : 7647861567,\r\n            \"bytes_limit\" : 6192011673\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"_all\" : {\r\n    \"primaries\" : {\r\n      \"fielddata\" : {\r\n        \"memory_size\" : \"3.1gb\",\r\n        \"memory_size_in_bytes\" : 3432930008,\r\n        \"evictions\" : 0,\r\n        \"fields\" : {\r\n          \"keyword_field\" : {\r\n            \"memory_size\" : \"3.1gb\",\r\n            \"memory_size_in_bytes\" : 3432930008\r\n          }\r\n        }\r\n      }\r\n    }\r\n........................\r\n\r\n\r\n\r\nBy adding execution_hint: map to my aggregation,  it takes effects and the aggregation does not consume field data cache anymore. But I think keyword field with doc values should not consume field data cache and cause huge memory, and the field data breaker should have worked. I think it is a bug.  Eager for any help. \r\n\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}