[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352790898","html_url":"https://github.com/elastic/elasticsearch/issues/27893#issuecomment-352790898","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893","id":352790898,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Mjc5MDg5OA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-12-19T15:24:28Z","updated_at":"2017-12-19T15:24:28Z","author_association":"MEMBER","body":"@valdemarrolfsen The `range` query inside the `nested` query just determines whether there are nested docs for the root document to be a match. The `nested` aggregation doesn't know about the inner query specified in the `nested` query. It only knows that the root document was a match, and iterates over all its nested documents.\r\n\r\nIf the `range` query is moved to a `filter` aggregation under the `nested` aggregation then the aggs result that you expect is returned:\r\n\r\n```\r\nGET /test-index/_search?size=0&pretty\r\n{\r\n  \"aggs\": {\r\n    \"nested_field\": {\r\n      \"nested\": {\r\n        \"path\": \"nested_field\"\r\n      },\r\n      \"aggs\": {\r\n        \"filter-by-range\": {\r\n          \"filter\": {\r\n            \"range\": {\r\n              \"nested_field.date\": {\r\n                \"gte\": \"2013\",\r\n                \"lte\": \"2014\",\r\n                \"format\": \"yyyy\"\r\n              }\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"count_per_year\": {\r\n              \"date_histogram\": {\r\n                \"field\": \"nested_field.date\",\r\n                \"interval\": \"year\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352798958","html_url":"https://github.com/elastic/elasticsearch/issues/27893#issuecomment-352798958","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893","id":352798958,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Mjc5ODk1OA==","user":{"login":"valdemarrolfsen","id":8336948,"node_id":"MDQ6VXNlcjgzMzY5NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/8336948?v=4","gravatar_id":"","url":"https://api.github.com/users/valdemarrolfsen","html_url":"https://github.com/valdemarrolfsen","followers_url":"https://api.github.com/users/valdemarrolfsen/followers","following_url":"https://api.github.com/users/valdemarrolfsen/following{/other_user}","gists_url":"https://api.github.com/users/valdemarrolfsen/gists{/gist_id}","starred_url":"https://api.github.com/users/valdemarrolfsen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/valdemarrolfsen/subscriptions","organizations_url":"https://api.github.com/users/valdemarrolfsen/orgs","repos_url":"https://api.github.com/users/valdemarrolfsen/repos","events_url":"https://api.github.com/users/valdemarrolfsen/events{/privacy}","received_events_url":"https://api.github.com/users/valdemarrolfsen/received_events","type":"User","site_admin":false},"created_at":"2017-12-19T15:50:31Z","updated_at":"2017-12-19T15:50:31Z","author_association":"NONE","body":"Thank you @martijnvg, but what if you want to aggregate on a field of the root doc but filter based on a field in the nested doc? For example, if the mapping is updated to:\r\n\r\n```\r\n\"mappings\" : {\r\n        \"test\" : {\r\n            \"properties\" : {\r\n                \"name\" : { \"type\" : \"text\" },\r\n                \"age\": {\"type\": \"short\"},\r\n                \"nested_field\": {\r\n                \t\"type\": \"nested\",\r\n                \t\"properties\": {\r\n                \t\t\"date\": {\"type\": \"date\"}\r\n                \t}\r\n                \t\r\n                }\r\n            }\r\n        }\r\n    }\r\n```\r\n\r\nAnd you want to get the `avg` age within a timespan? The only way I can think of is the one presented below, but then you run into the same issue.\r\n\r\n```\r\nGET /test-index/_search?size=0&pretty\r\n{\r\n  \"aggs\": {\r\n    \"nested_field\": {\r\n      \"nested\": {\r\n        \"path\": \"nested_field\"\r\n      },\r\n      \"aggs\": {\r\n        \"filter-by-range\": {\r\n          \"filter\": {\r\n            \"range\": {\r\n              \"nested_field.date\": {\r\n                \"gte\": \"2013\",\r\n                \"lte\": \"2014\",\r\n                \"format\": \"yyyy\"\r\n              }\r\n            }\r\n          },\r\n          \"aggs\": {\r\n           \"back_to_root\": {\r\n              \"reverse_nested\": {},\r\n              \"aggs\": {\r\n                \"average_age\": {\r\n                  \"avg\": {\"field\": \"age\"}\r\n                }\r\n               }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352812044","html_url":"https://github.com/elastic/elasticsearch/issues/27893#issuecomment-352812044","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27893","id":352812044,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MjgxMjA0NA==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2017-12-19T16:31:29Z","updated_at":"2017-12-19T16:31:29Z","author_association":"MEMBER","body":"@valdemarrolfsen You can still use the `nested` query you had originally to get the average age in the requested range:\r\n\r\n```\r\nGET /test-index/_search?size=0&pretty\r\n{\r\n  \"query\": {\r\n        \"nested\": {\r\n            \"path\": \"nested_field\",\r\n            \"query\": {\r\n                \"range\": {\r\n                    \"nested_field.date\": {\r\n                        \"gte\": \"2013\",\r\n                        \"lte\": \"2014\",\r\n                        \"format\": \"yyyy\"\r\n                    }\r\n                }\r\n            }\r\n        }\r\n   },\r\n  \"aggs\": {\r\n    \"nested_field\": {\r\n      \"nested\": {\r\n        \"path\": \"nested_field\"\r\n      },\r\n      \"aggs\": {\r\n        \"filter-by-range\": {\r\n          \"filter\": {\r\n            \"range\": {\r\n              \"nested_field.date\": {\r\n                \"gte\": \"2013\",\r\n                \"lte\": \"2014\",\r\n                \"format\": \"yyyy\"\r\n              }\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"count_per_year\": {\r\n              \"date_histogram\": {\r\n                \"field\": \"nested_field.date\",\r\n                \"interval\": \"year\"\r\n              }\r\n            },\r\n            \"average_age\": {\r\n                \"avg\": {\"field\": \"age\"}\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```","performed_via_github_app":null}]