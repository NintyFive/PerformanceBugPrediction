{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1645","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1645/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1645/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1645/events","html_url":"https://github.com/elastic/elasticsearch/issues/1645","id":2991821,"node_id":"MDU6SXNzdWUyOTkxODIx","number":1645,"title":"Counts in date histogram facets are inaccurate on nested documents","user":{"login":"markbirbeck","id":62572,"node_id":"MDQ6VXNlcjYyNTcy","avatar_url":"https://avatars2.githubusercontent.com/u/62572?v=4","gravatar_id":"","url":"https://api.github.com/users/markbirbeck","html_url":"https://github.com/markbirbeck","followers_url":"https://api.github.com/users/markbirbeck/followers","following_url":"https://api.github.com/users/markbirbeck/following{/other_user}","gists_url":"https://api.github.com/users/markbirbeck/gists{/gist_id}","starred_url":"https://api.github.com/users/markbirbeck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markbirbeck/subscriptions","organizations_url":"https://api.github.com/users/markbirbeck/orgs","repos_url":"https://api.github.com/users/markbirbeck/repos","events_url":"https://api.github.com/users/markbirbeck/events{/privacy}","received_events_url":"https://api.github.com/users/markbirbeck/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2012-01-27T08:49:13Z","updated_at":"2014-07-08T14:02:32Z","closed_at":"2014-07-08T14:02:32Z","author_association":"NONE","active_lock_reason":null,"body":"When using date histogram facets we're finding that the values returned are incorrect when using nested documents.\n\nA script to load 5 documents and query them is here:\n\nhttps://gist.github.com/1684494\n\nIt loads documents with the following structure:\n\n``` json\n{\n  \"title\": \"Article x\",\n  \"actions\": [\n    {\"date\": \"2010-11-18\", \"updated\": 1, \"action\": \"updated\"}\n  ]\n}\n```\n\nand then queries for all documents that are called 'Article 1', with date of '2011-11-18'. This correctly has 1 as the value for the _updated_ facet.\n\nHowever, if the script is changed to load _6_ documents, the same query returns a facet count of 2 instead of 1:\n\nhttps://gist.github.com/1684506\n\nWe've shown that increasing the number of stored records also gradually increases the error, but this is the smallest number of records we've found that illustrates the problem.\n\nWe've also found on our live system with millions of documents, that if we increase the date range in the nested part of the query that then reduces the scale of the error. However, we've not been able to come up with a set of scripts that illustrates that problem.\n\nWe're using ES 0.18.7.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}