{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/61854","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61854/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61854/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61854/events","html_url":"https://github.com/elastic/elasticsearch/issues/61854","id":691063487,"node_id":"MDU6SXNzdWU2OTEwNjM0ODc=","number":61854,"title":"EQL: Filter pipe semantics","user":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"labels":[{"id":1690690117,"node_id":"MDU6TGFiZWwxNjkwNjkwMTE3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/EQL","name":":Query Languages/EQL","color":"0e8a16","default":false,"description":"EQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967501040,"node_id":"MDU6TGFiZWwxOTY3NTAxMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:QL","name":"Team:QL","color":"fef2c0","default":false,"description":"Meta label for query languages team"},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"tsg","id":101817,"node_id":"MDQ6VXNlcjEwMTgxNw==","avatar_url":"https://avatars1.githubusercontent.com/u/101817?v=4","gravatar_id":"","url":"https://api.github.com/users/tsg","html_url":"https://github.com/tsg","followers_url":"https://api.github.com/users/tsg/followers","following_url":"https://api.github.com/users/tsg/following{/other_user}","gists_url":"https://api.github.com/users/tsg/gists{/gist_id}","starred_url":"https://api.github.com/users/tsg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsg/subscriptions","organizations_url":"https://api.github.com/users/tsg/orgs","repos_url":"https://api.github.com/users/tsg/repos","events_url":"https://api.github.com/users/tsg/events{/privacy}","received_events_url":"https://api.github.com/users/tsg/received_events","type":"User","site_admin":false},"assignees":[{"login":"tsg","id":101817,"node_id":"MDQ6VXNlcjEwMTgxNw==","avatar_url":"https://avatars1.githubusercontent.com/u/101817?v=4","gravatar_id":"","url":"https://api.github.com/users/tsg","html_url":"https://github.com/tsg","followers_url":"https://api.github.com/users/tsg/followers","following_url":"https://api.github.com/users/tsg/following{/other_user}","gists_url":"https://api.github.com/users/tsg/gists{/gist_id}","starred_url":"https://api.github.com/users/tsg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsg/subscriptions","organizations_url":"https://api.github.com/users/tsg/orgs","repos_url":"https://api.github.com/users/tsg/repos","events_url":"https://api.github.com/users/tsg/events{/privacy}","received_events_url":"https://api.github.com/users/tsg/received_events","type":"User","site_admin":false},{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},{"login":"spong","id":2946766,"node_id":"MDQ6VXNlcjI5NDY3NjY=","avatar_url":"https://avatars0.githubusercontent.com/u/2946766?v=4","gravatar_id":"","url":"https://api.github.com/users/spong","html_url":"https://github.com/spong","followers_url":"https://api.github.com/users/spong/followers","following_url":"https://api.github.com/users/spong/following{/other_user}","gists_url":"https://api.github.com/users/spong/gists{/gist_id}","starred_url":"https://api.github.com/users/spong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spong/subscriptions","organizations_url":"https://api.github.com/users/spong/orgs","repos_url":"https://api.github.com/users/spong/repos","events_url":"https://api.github.com/users/spong/events{/privacy}","received_events_url":"https://api.github.com/users/spong/received_events","type":"User","site_admin":false},{"login":"rw-access","id":31489089,"node_id":"MDQ6VXNlcjMxNDg5MDg5","avatar_url":"https://avatars1.githubusercontent.com/u/31489089?v=4","gravatar_id":"","url":"https://api.github.com/users/rw-access","html_url":"https://github.com/rw-access","followers_url":"https://api.github.com/users/rw-access/followers","following_url":"https://api.github.com/users/rw-access/following{/other_user}","gists_url":"https://api.github.com/users/rw-access/gists{/gist_id}","starred_url":"https://api.github.com/users/rw-access/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rw-access/subscriptions","organizations_url":"https://api.github.com/users/rw-access/orgs","repos_url":"https://api.github.com/users/rw-access/repos","events_url":"https://api.github.com/users/rw-access/events{/privacy}","received_events_url":"https://api.github.com/users/rw-access/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2020-09-02T14:20:17Z","updated_at":"2020-09-17T11:58:10Z","closed_at":"2020-09-17T11:58:10Z","author_association":"MEMBER","active_lock_reason":null,"body":"With the support for filter pipe in EQL, it is worth discussing its semantics since there seems to be a gap between the assumptions on how it should work and existing tests.\r\n\r\nTo recap, take a look at the filter description in the [EQL Python](https://eql.readthedocs.io/en/latest/query-guide/pipes.html#filter):\r\n\r\n> The filter pipe will only output events that match the criteria. With simple queries, this can be accomplished by adding and to the search criteria. Itâ€™s most commonly used to filter sequences or with other pipes.\r\n\r\nTo wit:\r\n\r\n```\r\nnetwork where true\r\n| filter id > 10\r\n```\r\n\r\nis the same as\r\n\r\n```\r\nnetwork where true and id > 10\r\n```\r\n\r\nFor sequences:\r\n\r\n```\r\nsequence \r\n[process where a > 1]\r\n[network where b < 10]\r\n| filter c == 5\r\n```\r\n\r\nthis becomes\r\n\r\n```\r\nsequence \r\n[process where a > 1 and c == 5]\r\n[network where b < 10 and c == 5]\r\n```\r\n\r\nThis is my interpretation, how filter pipes work in EQL in ES and I believe how SIEM thinks about it as well.\r\n\r\nHowever that doesn't seem to be the way EQL in Python works based on the existing tests.\r\nIt seems to applies the filter in declaration order on the results of a sequence or query.\r\nThat is, instead of filtering events *before* being matched, it filters *after* they are matched.\r\n\r\nAssume the following stream of events A1, A2 and B3, in this order.\r\n\r\n```\r\nsequence\r\n[process where A]\r\n[process where B]\r\n| filter A != A2\r\n```\r\n\r\nIf the filter is applied before matching, A2 is eliminated and the resulting sequence is [A1,B3].\r\nIf the filter is applied after matching, the sequence produces [A2, B3] which then gets filtered out.\r\n\r\nAs a tangent, this affects the way other pipes get applied as well:\r\n\r\n```\r\nprocess where true\r\n| head 10\r\n| filter id > 10\r\n```\r\n\r\nAssume the id is monotonically increasing and it starts from 1. Should the result be:\r\n[] (head 10, returns process with id 1, ... 10] which then get filtered out or\r\n[11, 12 ... 20] ?\r\n\r\nIn other words are the following queries equivalent:\r\n \r\n```\r\nprocess where true\r\n| head 10\r\n| filter id > 10\r\n```\r\n\r\n```\r\nprocess where true\r\n| filter id > 10\r\n| head 10\r\n```\r\n```\r\nprocess where id > 10\r\n| head 10\r\n```","closed_by":{"login":"costin","id":76245,"node_id":"MDQ6VXNlcjc2MjQ1","avatar_url":"https://avatars3.githubusercontent.com/u/76245?v=4","gravatar_id":"","url":"https://api.github.com/users/costin","html_url":"https://github.com/costin","followers_url":"https://api.github.com/users/costin/followers","following_url":"https://api.github.com/users/costin/following{/other_user}","gists_url":"https://api.github.com/users/costin/gists{/gist_id}","starred_url":"https://api.github.com/users/costin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/costin/subscriptions","organizations_url":"https://api.github.com/users/costin/orgs","repos_url":"https://api.github.com/users/costin/repos","events_url":"https://api.github.com/users/costin/events{/privacy}","received_events_url":"https://api.github.com/users/costin/received_events","type":"User","site_admin":false},"performed_via_github_app":null}