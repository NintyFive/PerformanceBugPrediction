{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31902","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31902/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31902/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31902/events","html_url":"https://github.com/elastic/elasticsearch/issues/31902","id":339515905,"node_id":"MDU6SXNzdWUzMzk1MTU5MDU=","number":31902,"title":"Relax field types supported by _termvectors API","user":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-07-09T16:13:05Z","updated_at":"2019-02-07T10:36:18Z","closed_at":"2018-07-17T12:11:11Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"### Problem background\r\nIn adding [a plugin for a new field type](https://github.com/elastic/elasticsearch/pull/30364) I've discovered a few places in core where we have hard-coded assumptions about what represents a searchable text field type:\r\n\r\n1) \"All\" queries expansion (work in progress here: https://github.com/elastic/elasticsearch/pull/31655)\r\n2) [MLT queries ](https://github.com/elastic/elasticsearch/blob/916bf9d26d6292dcb9b229123c58a86f0e741ffd/server/src/main/java/org/elasticsearch/index/query/MoreLikeThisQueryBuilder.java#L92)\r\n3) [TermVectors service](https://github.com/elastic/elasticsearch/blob/00b0e1006320cf8d11d2aaf2f4233dab1bcc1be3/server/src/main/java/org/elasticsearch/index/termvectors/TermVectorsService.java#L165)\r\n\r\n### Proposed change\r\nAn open question is if all of these problems can be addressed with a new common field-checking service. For now, this issue just relates to solving 3) and the proposed change is to switch the code in TermVectorsService which has :\r\n\r\n        // must be a string\r\n        if (fieldType instanceof KeywordFieldMapper.KeywordFieldType == false\r\n                && fieldType instanceof TextFieldMapper.TextFieldType == false) {\r\n            return false;\r\n        }\r\n \r\nto this broader base class test:\r\n\r\n        if (fieldType instanceof KeywordFieldMapper.KeywordFieldType == false\r\n                && fieldType instanceof StringFieldType == false) {\r\n            return false;\r\n        }\r\n\r\n\r\n### Side effect  (desirable or undesirable?)\r\nA side effect of this change is that other forms of indexed strings can now return termvectors info e.g. given this mapping:\r\n\r\n\tPUT test\r\n\t{\r\n\t  \"mappings\": {\r\n\t\t\"doc\": {\r\n\t\t  \"properties\": {\r\n\t\t\t\"text\": {\r\n\t\t\t  \"type\": \"text\",\r\n\t\t\t  \"index_prefixes\": {},\r\n\t\t\t  \"index_phrases\": true\r\n\t\t\t...\r\n \r\nand this call to the modified termvectors API:\r\n\r\n\tGET /test/doc/_termvectors\r\n\t{\r\n\t\t\"doc\": {\r\n\t\t  \"text\":  \"my example text\"\t\t  \r\n\t\t},\r\n\t\t\"term_statistics\" : true,\r\n\t\t\"field_statistics\" : true,\r\n\t\t\"positions\": false,\r\n\t\t\"offsets\": false,\r\n\t\t\"filter\" : {\r\n\t\t  \"max_num_terms\" : 3,\r\n\t\t  \"min_term_freq\" : 1,\r\n\t\t  \"min_doc_freq\" : 1\r\n\t\t}\r\n\t}\r\n\r\n..the new version of this API would also return termvectors for the `text._index_phrase` and `text._index_prefix` as well as the usual `text` field. The `max_num_terms` setting applies to each indexed field so in this case is 3 terms multiplied by 3 fields = 9 terms.\r\n\r\nIt's not clear if this change in behaviour is useful or not (opinions, @romseygeek ?)\r\n\r\n\r\n\r\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}