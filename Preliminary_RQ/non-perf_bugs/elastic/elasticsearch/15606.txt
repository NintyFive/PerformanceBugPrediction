{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15606","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15606/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15606/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15606/events","html_url":"https://github.com/elastic/elasticsearch/issues/15606","id":123492101,"node_id":"MDU6SXNzdWUxMjM0OTIxMDE=","number":15606,"title":"Distance sorting and calculation incorrect and inaccurate","user":{"login":"ghost","id":10137,"node_id":"MDQ6VXNlcjEwMTM3","avatar_url":"https://avatars3.githubusercontent.com/u/10137?v=4","gravatar_id":"","url":"https://api.github.com/users/ghost","html_url":"https://github.com/ghost","followers_url":"https://api.github.com/users/ghost/followers","following_url":"https://api.github.com/users/ghost/following{/other_user}","gists_url":"https://api.github.com/users/ghost/gists{/gist_id}","starred_url":"https://api.github.com/users/ghost/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghost/subscriptions","organizations_url":"https://api.github.com/users/ghost/orgs","repos_url":"https://api.github.com/users/ghost/repos","events_url":"https://api.github.com/users/ghost/events{/privacy}","received_events_url":"https://api.github.com/users/ghost/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-12-22T14:39:52Z","updated_at":"2015-12-22T19:11:42Z","closed_at":"2015-12-22T19:03:09Z","author_association":"NONE","active_lock_reason":null,"body":"I'm using elasticsearch for a search functionality on a website. The search must provide a search by distance from a location in an - for example - 25km radius.\n\nThat's no problem, I'm using the following elasticsearch query array:\n\n```\n{\n    \"index\": \"kasd9i9021profiles\",\n    \"type\": \"profile\",\n    \"size\": 30,\n    \"from\": 0,\n    \"body\": {\n    \"query\": {\n        \"bool\": {\n            \"filter\": {\n                \"geo_distance\": {\n                    \"distance\": \"25km\",\n                    \"distance_type\": \"sloppy_arc\",\n                    \"_cache\": true,\n                    \"location\": {\n                        \"lat\": 48.136833417046,\n                        \"lon\": 11.570900696682\n                    },\n                    \"unit\": \"km\"\n                }\n            },\n            \"must\": [\n                {\n                    \"term\": {\n                        \"published\": \"1\"\n                    }\n                },\n                {\n                    \"match\": {\n                        \"country\": \"DE\"\n                    }\n                },\n                {\n                    \"match\": {\n                        \"category_id\": \"1\"\n                    }\n                }\n            ]\n        }\n    },\n    \"script_fields\": {\n        \"distance\": {\n            \"lang\": \"groovy\",\n            \"params\": {\n                \"lat\": 48.136833417046,\n                \"lon\": 11.570900696682\n            },\n            \"script\": \"doc['location'].distanceInKm(lat,lon)\"\n        }\n    },\n    \"sort\": [\n        {\n            \"upgrade_sort\": {\n                \"order\": \"desc\"\n            }\n        },\n        {\n            \"has_siegel\": {\n                \"order\": \"desc\"\n            }\n        },\n        {\n            \"_geo_distance\": {\n                \"location\": {\n                    \"lat\": 48.136833417046,\n                    \"lon\": 11.570900696682\n                },\n                \"order\": \"asc\",\n                \"unit\": \"km\"\n            }\n        }\n    ]\n    },\n    \"fields\": [\n    \"_source\",\n    \"distance\"\n    ]\n}\n```\n\nThe value of \"upgrade_sort\" can be between 0 and 3. The value of \"has_siegel\" can be true or false.\n\nThe problems are:\n\n```\nThe results are not sorted by distance\nThe distance in the result is between 0 and ~30km, not between 0 and 25km.\n```\n\nIs that a bug or a wrong query?\n\nAlso postet on stackoverflow.com: http://stackoverflow.com/questions/34372194/elasticsearch-distance-sorting-and-calculation\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}