{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19891","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19891/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19891/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19891/events","html_url":"https://github.com/elastic/elasticsearch/issues/19891","id":170213194,"node_id":"MDU6SXNzdWUxNzAyMTMxOTQ=","number":19891,"title":"Sampler+Filters Aggregation: array_index_out_of_bounds_exception when no docs match on a shard","user":{"login":"gibrown","id":820871,"node_id":"MDQ6VXNlcjgyMDg3MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820871?v=4","gravatar_id":"","url":"https://api.github.com/users/gibrown","html_url":"https://github.com/gibrown","followers_url":"https://api.github.com/users/gibrown/followers","following_url":"https://api.github.com/users/gibrown/following{/other_user}","gists_url":"https://api.github.com/users/gibrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gibrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gibrown/subscriptions","organizations_url":"https://api.github.com/users/gibrown/orgs","repos_url":"https://api.github.com/users/gibrown/repos","events_url":"https://api.github.com/users/gibrown/events{/privacy}","received_events_url":"https://api.github.com/users/gibrown/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2016-08-09T16:35:53Z","updated_at":"2017-03-31T15:32:17Z","closed_at":"2017-03-31T13:44:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.3\n**Plugins installed**: [analysis-icu, analysis-kuromoji ,analysis-smartcn, analysis-stempel, head, elasticsearch-inquisitor, statsd, whatson, langdetect, delete-by-query, lang-javascript]\n\n**JVM version**: OpenJDK Java 8\n\n**OS version**: Debian\n\n**Description of the problem including expected versus actual behavior**:\n\nCombination of factors results in the error:\n- filters aggregation containing a sampler aggregation and a significant terms aggregation (not sure sig terms matters here)\n- Querying an index (maybe even just a shard) where the top level filter excludes all documents from the shard. In this case looking at 2016q2 index with a filter for the past 30 days.\n- The filters aggregation must have more than one filter in it. If I remove the \"t1\" filter below, then it will work correctly and return an empty set of results from the 2016q2 index.\n\nExample query:\n\n```\nGET global-temporal-2-2016q2/post/_search\n{\n  \"from\": 0,\n  \"size\": 0,\n  \"fields\": [\n    \"blog_id\"\n  ],\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"match_all\": []\n      },\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"range\": {\n                \"date_gmt\": {\n                  \"gte\": \"now-30d\"\n                }\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"aggregations\": {\n    \"topics\": {\n      \"filters\": {\n        \"filters\": {\n          \"t0\": {\n            \"or\": [\n              {\n                \"term\": {\n                  \"title.default\": \"travel\"\n                }\n              },\n              {\n                \"term\": {\n                  \"content.default\": \"travel\"\n                }\n              },\n              {\n                \"term\": {\n                  \"tag.name.default\": \"travel\"\n                }\n              },\n              {\n                \"term\": {\n                  \"category.name.default\": \"travel\"\n                }\n              }\n            ]\n          },\n          \"t1\": {\n            \"or\": [\n              {\n                \"term\": {\n                  \"title.default\": \"photography\"\n                }\n              },\n              {\n                \"term\": {\n                  \"content.default\": \"photography\"\n                }\n              },\n              {\n                \"term\": {\n                  \"tag.name.default\": \"photography\"\n                }\n              },\n              {\n                \"term\": {\n                  \"category.name.default\": \"photography\"\n                }\n              }\n            ]\n          }\n        }\n      },\n      \"aggs\": {\n        \"sample\": {\n          \"sampler\": {\n            \"shard_size\": 500\n          },\n          \"aggs\": {\n            \"blogs\": {\n              \"significant_terms\": {\n                \"field\": \"blog_id\",\n                \"size\": 10,\n                \"gnd\": {}\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"timeout\": \"2s\"\n}\n```\n\nWhat the response looks like:\n- 500 response when querying 2016q2 index\n- 200 response querying 2016q3 index\n- 500 response querying 2016q\\* indices. And we get partial results.\n\nFull Response when querying 2016q2:\n\n```\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"array_index_out_of_bounds_exception\",\n            \"reason\": null\n         }\n      ],\n      \"type\": \"search_phase_execution_exception\",\n      \"reason\": \"all shards failed\",\n      \"phase\": \"query\",\n      \"grouped\": true,\n      \"failed_shards\": [\n         {\n            \"shard\": 0,\n            \"index\": \"global-temporal-2-2016q2\",\n            \"node\": \"-sTCWr_OQzuhyHfgIgyANw\",\n            \"reason\": {\n               \"type\": \"array_index_out_of_bounds_exception\",\n               \"reason\": null\n            }\n         }\n      ]\n   },\n   \"status\": 500\n}\n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}