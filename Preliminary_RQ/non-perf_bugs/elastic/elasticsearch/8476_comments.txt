[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63026106","html_url":"https://github.com/elastic/elasticsearch/issues/8476#issuecomment-63026106","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8476","id":63026106,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMDI2MTA2","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-14T08:54:44Z","updated_at":"2014-11-14T08:54:44Z","author_association":"CONTRIBUTOR","body":"Hi @aaneja \n\nThe circuit breaker trips when there is not enough memory to serve the request.  In this case, it was unable to load the fielddata that it needed for the `request.count` field.  Presumably you have a lot of other data already loaded in fielddata.\n\nNote: it doesn't just depend on that single query - it looks at how much heap is in use at the time. So if you have other queries running which are also using heap, then it may throw the exception at that moment, but later work just fine.\n\nI suggest you look at what is consuming your fielddata:\n\n```\nGET /_nodes/stats/indices/fielddata?fields=*\n```\n\nAlso consider changing those fields to use doc values instead (fielddata on disk), which then removes the problem of heap usage.\n\nAlso, given that your query took 148s, I'm betting that you have garbage collection issues.  Make sure that you have swap disabled.  See http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/setup-configuration.html#setup-configuration-memory\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/63741425","html_url":"https://github.com/elastic/elasticsearch/issues/8476#issuecomment-63741425","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8476","id":63741425,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNzQxNDI1","user":{"login":"aaneja","id":1797669,"node_id":"MDQ6VXNlcjE3OTc2Njk=","avatar_url":"https://avatars2.githubusercontent.com/u/1797669?v=4","gravatar_id":"","url":"https://api.github.com/users/aaneja","html_url":"https://github.com/aaneja","followers_url":"https://api.github.com/users/aaneja/followers","following_url":"https://api.github.com/users/aaneja/following{/other_user}","gists_url":"https://api.github.com/users/aaneja/gists{/gist_id}","starred_url":"https://api.github.com/users/aaneja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aaneja/subscriptions","organizations_url":"https://api.github.com/users/aaneja/orgs","repos_url":"https://api.github.com/users/aaneja/repos","events_url":"https://api.github.com/users/aaneja/events{/privacy}","received_events_url":"https://api.github.com/users/aaneja/received_events","type":"User","site_admin":false},"created_at":"2014-11-20T00:31:09Z","updated_at":"2014-11-20T00:31:09Z","author_association":"NONE","body":"So I reran the query today a bunch of times and queried the marvel reported node_stats for the failing nodes. The query -\n\n```\nGET /.marvel-2014.11.19/node_stats/_search?search_type=count\n{\n  \"_source\": [\n    \"@timestamp\",\n    \"indices.fielddata.*\",\n    \"fielddata_breaker.*\",\n    \"indices.search.*\"\n  ],\n  \"aggs\": {\n    \"ByIp\": {\n      \"terms\": {\n        \"field\": \"node.ip\",\n        \"size\": 0\n      },\n      \"aggs\": {\n        \"FiledDataBytes\": {\n          \"stats\": {\n            \"field\": \"indices.fielddata.memory_size_in_bytes\"\n          }\n        },\n        \"QueryCurrent\": {\n          \"stats\": {\n            \"field\": \"indices.search.query_current\"\n          }\n        },\n        \"QueryTotal\": {\n          \"stats\": {\n            \"field\": \"indices.search.query_total\"\n          }\n        },\n        \"Tripped\": {\n          \"stats\": {\n            \"field\": \"fielddata_breaker.tripped\"\n          }\n        },\n        \"Evictions\": {\n          \"stats\": {\n            \"field\": \"fielddata.evictions\"\n          }\n        }\n      }\n    }\n  },\n  \"query\": {\n    \"filtered\": {\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"range\": {\n                \"@timestamp\": {\n                  \"gte\": \"2014-11-19T20:20:48Z\",\n                  \"lt\": \"2014-11-19T20:27:48Z\"\n                }\n              }\n            },\n            {\n              \"bool\": {\n                \"should\": [\n                  {\n                    \"term\": {\n                      \"node.ip\": \"10.0.65.59\"\n                    }\n                  },\n                  {\n                    \"term\": {\n                      \"node.ip\": \"10.0.64.243\"\n                    }\n                  }\n                ]\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"sort\": [\n    {\n      \"@timestamp\": {\n        \"order\": \"asc\"\n      }\n    }\n  ]\n}\n```\n\nHere are the aggregation results -\n\n```\n\"aggregations\": {\n      \"ByIp\": {\n         \"buckets\": [\n            {\n               \"key\": \"10.0.65.59\",\n               \"doc_count\": 40,\n               \"Evictions\": {\n                  \"count\": 0,\n                  \"min\": null,\n                  \"max\": null,\n                  \"avg\": null,\n                  \"sum\": null\n               },\n               \"FiledDataBytes\": {\n                  \"count\": 40,\n                  \"min\": 8185812512,\n                  \"max\": 8185812512,\n                  \"avg\": 8185812512,\n                  \"sum\": 327432500480\n               },\n               \"QueryTotal\": {\n                  \"count\": 40,\n                  \"min\": 53021,\n                  \"max\": 53534,\n                  \"avg\": 53287.175,\n                  \"sum\": 2131487\n               },\n               \"QueryCurrent\": {\n                  \"count\": 40,\n                  \"min\": 0,\n                  \"max\": 9,\n                  \"avg\": 1.4,\n                  \"sum\": 56\n               },\n               \"Tripped\": {\n                  \"count\": 40,\n                  \"min\": 2885,\n                  \"max\": 2915,\n                  \"avg\": 2904.125,\n                  \"sum\": 116165\n               }\n            },\n            {\n               \"key\": \"10.0.64.243\",\n               \"doc_count\": 39,\n               \"Evictions\": {\n                  \"count\": 0,\n                  \"min\": null,\n                  \"max\": null,\n                  \"avg\": null,\n                  \"sum\": null\n               },\n               \"FiledDataBytes\": {\n                  \"count\": 39,\n                  \"min\": 8361789544,\n                  \"max\": 8361789544,\n                  \"avg\": 8361789544,\n                  \"sum\": 326109792216\n               },\n               \"QueryTotal\": {\n                  \"count\": 39,\n                  \"min\": 48028,\n                  \"max\": 48544,\n                  \"avg\": 48303.333333333336,\n                  \"sum\": 1883830\n               },\n               \"QueryCurrent\": {\n                  \"count\": 39,\n                  \"min\": 0,\n                  \"max\": 0,\n                  \"avg\": 0,\n                  \"sum\": 0\n               },\n               \"Tripped\": {\n                  \"count\": 39,\n                  \"min\": 8841,\n                  \"max\": 8884,\n                  \"avg\": 8864.333333333334,\n                  \"sum\": 345709\n               }\n            }\n         ]\n      }\n   }\n```\n\nMy take on these numbers : I would've imagined that when we have few parallel queries, then already loaded fielddata would not be a factor in determining if CircuitBreaker should trip or not.\nThis is not the case above.\nThere were no evictions either, in fact I have never seen evictions on these nodes over the past 2 days\n\nCan you provide a more detailed explanation of how CircuitBreaker estimations work ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64020721","html_url":"https://github.com/elastic/elasticsearch/issues/8476#issuecomment-64020721","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8476","id":64020721,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MDIwNzIx","user":{"login":"aaneja","id":1797669,"node_id":"MDQ6VXNlcjE3OTc2Njk=","avatar_url":"https://avatars2.githubusercontent.com/u/1797669?v=4","gravatar_id":"","url":"https://api.github.com/users/aaneja","html_url":"https://github.com/aaneja","followers_url":"https://api.github.com/users/aaneja/followers","following_url":"https://api.github.com/users/aaneja/following{/other_user}","gists_url":"https://api.github.com/users/aaneja/gists{/gist_id}","starred_url":"https://api.github.com/users/aaneja/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aaneja/subscriptions","organizations_url":"https://api.github.com/users/aaneja/orgs","repos_url":"https://api.github.com/users/aaneja/repos","events_url":"https://api.github.com/users/aaneja/events{/privacy}","received_events_url":"https://api.github.com/users/aaneja/received_events","type":"User","site_admin":false},"created_at":"2014-11-21T19:02:13Z","updated_at":"2014-11-21T19:02:13Z","author_association":"NONE","body":"Ping. Any updates ? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/64245075","html_url":"https://github.com/elastic/elasticsearch/issues/8476#issuecomment-64245075","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8476","id":64245075,"node_id":"MDEyOklzc3VlQ29tbWVudDY0MjQ1MDc1","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-11-24T19:03:29Z","updated_at":"2014-11-24T19:03:29Z","author_association":"CONTRIBUTOR","body":"@aaneja Evictions will only happen if you set a maximum size to the fielddata cache.  Already loaded fielddata is taken into account.  Apparently, loading the data you requested would have pushed you over the configured circuit breaker limits, given the amount of heap space you have available.  \n\nThe details of what you can configure are available here: http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/index-modules-fielddata.html\n\nIf you want to understand more low level details, your best bet would be to delve into the code itself.\n","performed_via_github_app":null}]