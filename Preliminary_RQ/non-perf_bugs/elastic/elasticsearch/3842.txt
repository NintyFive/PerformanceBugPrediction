{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3842","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3842/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3842/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3842/events","html_url":"https://github.com/elastic/elasticsearch/issues/3842","id":20625796,"node_id":"MDU6SXNzdWUyMDYyNTc5Ng==","number":3842,"title":"ES 0.90.5 Master losing track of client nodes (Client: \"failed to send join request to master\" Master: \"received a join request for an existing node\")","user":{"login":"pvulgaris","id":1030026,"node_id":"MDQ6VXNlcjEwMzAwMjY=","avatar_url":"https://avatars1.githubusercontent.com/u/1030026?v=4","gravatar_id":"","url":"https://api.github.com/users/pvulgaris","html_url":"https://github.com/pvulgaris","followers_url":"https://api.github.com/users/pvulgaris/followers","following_url":"https://api.github.com/users/pvulgaris/following{/other_user}","gists_url":"https://api.github.com/users/pvulgaris/gists{/gist_id}","starred_url":"https://api.github.com/users/pvulgaris/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pvulgaris/subscriptions","organizations_url":"https://api.github.com/users/pvulgaris/orgs","repos_url":"https://api.github.com/users/pvulgaris/repos","events_url":"https://api.github.com/users/pvulgaris/events{/privacy}","received_events_url":"https://api.github.com/users/pvulgaris/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2013-10-07T17:22:50Z","updated_at":"2014-08-08T17:51:33Z","closed_at":"2014-08-08T17:51:33Z","author_association":"NONE","active_lock_reason":null,"body":"Ever since moving to 0.90.x we've been having intermittent issues where clients will suddenly start sending join requests to the master node and the master, thinking the client already exists in the cluster, will not respond. Even more bizarre, during this time the client will usually continue to mostly function properly (responds to query and index requests), but eventually enough client nodes get into this state that the cluster must be restarted. Restarting the individual client node has no effect, only a full cluster restart will solve the problem completely. But only temporarily.\n\nOur setup is 3 data nodes and 1 master node in each of 3 datacenters, for a total of 9 data nodes and 3 master nodes. Besides the upgrade to 0.90 from 0.20, we are also doing the following, possibly related, things:\n\n1) We've been using dynamic mapping to track click counts for search results for certain queries. Basically, we have an object property with the queries as the keys and the click counts as the values (for boosting). This leads to massive mapping updates every few seconds when a new query is added to the mapping. Now that the rescore API is available, we can do the same thing without dynamic mapping. Should be completely moved away from dynamic after today. Will also try to setup a reproducible test case to see if this is the cause of the issue.\n\n2) One particularly massive index (90gb+) with only 3 shards.\n\n```\njava -version\nJava version \"1.7.0_10\"\nJava(TM) SE Runtime Environment (build 1.7.0_10-b18)\nJava HotSpot(TM) 64-Bit Server VM (build 23.6-b04, mixed mode)\n```\n\nLogs from master:\n\n```\n7037:[2013-10-07 09:57:46,216][INFO ][cluster.service          ] [elasticsearch020.prn1] removed {[elasticsearch003.lla1][MMZlC4qyQ129gA9NnTSr2A][inet[/10.88.27.43:9300]]{dc=lla1, master=false},}, reason: zen-disco-node_left([elasticsearch003.lla1][MMZlC4qyQ129gA9NnTSr2A][inet[/10.88.27.43:9300]]{dc=lla1, master=false})\n7284:[2013-10-07 09:58:20,477][INFO ][cluster.service          ] [elasticsearch020.prn1] added {[elasticsearch003.lla1][ynx12931RFOoWNnU7QAEXw][inet[/10.88.27.43:9300]]{dc=lla1, master=false},}, reason: zen-disco-receive(join from node[[elasticsearch003.lla1][ynx12931RFOoWNnU7QAEXw][inet[/10.88.27.43:9300]]{dc=lla1, master=false}])\n7285:[2013-10-07 09:58:27,070][WARN ][discovery.zen            ] [elasticsearch020.prn1] received a join request for an existing node [[elasticsearch003.lla1][ynx12931RFOoWNnU7QAEXw][inet[/10.88.27.43:9300]]{dc=lla1, master=false}]\n7314:[2013-10-07 09:58:32,916][WARN ][discovery.zen            ] [elasticsearch020.prn1] received a join request for an existing node [[elasticsearch003.lla1][ynx12931RFOoWNnU7QAEXw][inet[/10.88.27.43:9300]]{dc=lla1, master=false}]\n```\n\nLogs from client:\n\n```\n1:[2013-10-07 09:55:27,844][INFO ][node                     ] [elasticsearch001.lla1] version[0.90.5], pid[21551], build[c8714e8/2013-09-17T12:50:20Z]\n2:[2013-10-07 09:55:27,845][INFO ][node                     ] [elasticsearch001.lla1] initializing ...\n3:[2013-10-07 09:55:27,896][INFO ][plugins                  ] [elasticsearch001.lla1] loaded [transport-thrift, mapper-attachments], sites [elasticsearch-paramedic]\n4:[2013-10-07 09:55:30,122][DEBUG][gateway.local            ] [elasticsearch001.lla1] using initial_shards [quorum], list_timeout [30s]\n5:[2013-10-07 09:55:30,288][DEBUG][gateway.local.state.meta ] [elasticsearch001.lla1] using gateway.local.auto_import_dangled [YES], with gateway.local.dangling_timeout [2h]\n6:[2013-10-07 09:55:30,288][TRACE][gateway.local.state.shards] [elasticsearch001.lla1] [find_latest_state]: processing [global-32014]\n7:[2013-10-07 09:55:30,309][DEBUG][gateway.local.state.shards] [elasticsearch001.lla1] took 21ms to load started shards state\n8:[2013-10-07 09:55:30,332][INFO ][node                     ] [elasticsearch001.lla1] initialized\n9:[2013-10-07 09:55:30,332][INFO ][node                     ] [elasticsearch001.lla1] starting ...\n10:[2013-10-07 09:55:30,352][INFO ][thrift                   ] [elasticsearch001.lla1] bound on port [9500]\n11:[2013-10-07 09:55:30,551][INFO ][transport                ] [elasticsearch001.lla1] bound_address {inet[/0.0.0.0:9300]}, publish_address {inet[/10.88.17.25:9300]}\n12:[2013-10-07 09:55:36,970][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n13:[2013-10-07 09:55:43,179][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n14:[2013-10-07 09:55:49,380][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n15:[2013-10-07 09:55:55,585][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n16:[2013-10-07 09:56:00,556][WARN ][discovery                ] [elasticsearch001.lla1] waited for 30s and no initial state was set by the discovery\n17:[2013-10-07 09:56:00,557][INFO ][discovery                ] [elasticsearch001.lla1] xsearch2/P7aHjB88TGS4-ZP4_w9-7A\n18:[2013-10-07 09:56:00,586][INFO ][http                     ] [elasticsearch001.lla1] bound_address {inet[/0.0.0.0:9200]}, publish_address {inet[/10.88.17.25:9200]}\n19:[2013-10-07 09:56:00,586][INFO ][node                     ] [elasticsearch001.lla1] started\n20:[2013-10-07 09:56:01,785][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n21:[2013-10-07 09:56:07,983][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n22:[2013-10-07 09:56:14,178][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n23:[2013-10-07 09:56:20,376][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n24:[2013-10-07 09:56:26,574][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n25:[2013-10-07 09:56:32,771][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n26:[2013-10-07 09:56:38,969][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n27:[2013-10-07 09:56:45,169][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n28:[2013-10-07 09:56:51,364][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n29:[2013-10-07 09:56:57,558][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n30:[2013-10-07 09:57:03,753][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n31:[2013-10-07 09:57:09,950][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n32:[2013-10-07 09:57:16,141][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n33:[2013-10-07 09:57:22,336][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n34:[2013-10-07 09:57:28,530][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n35:[2013-10-07 09:57:34,727][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n36:[2013-10-07 09:57:40,923][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n37:[2013-10-07 09:57:47,179][INFO ][discovery.zen            ] [elasticsearch001.lla1] failed to send join request to master [[elasticsearch020.prn1][BHwePHiKRbi8p_mmF0w5og][inet[/10.79.29.71:9300]]{dc=prn1, data=false, master=true}], reason [org.elasticsearch.ElasticSearchTimeoutException: Timeout waiting for task.]\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}