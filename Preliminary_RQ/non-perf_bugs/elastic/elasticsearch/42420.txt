{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42420","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42420/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42420/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42420/events","html_url":"https://github.com/elastic/elasticsearch/issues/42420","id":447482660,"node_id":"MDU6SXNzdWU0NDc0ODI2NjA=","number":42420,"title":"Partial ES S3 snapshots with INTERNAL_SERVER_ERROR ","user":{"login":"nvsajeeva","id":22984158,"node_id":"MDQ6VXNlcjIyOTg0MTU4","avatar_url":"https://avatars0.githubusercontent.com/u/22984158?v=4","gravatar_id":"","url":"https://api.github.com/users/nvsajeeva","html_url":"https://github.com/nvsajeeva","followers_url":"https://api.github.com/users/nvsajeeva/followers","following_url":"https://api.github.com/users/nvsajeeva/following{/other_user}","gists_url":"https://api.github.com/users/nvsajeeva/gists{/gist_id}","starred_url":"https://api.github.com/users/nvsajeeva/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nvsajeeva/subscriptions","organizations_url":"https://api.github.com/users/nvsajeeva/orgs","repos_url":"https://api.github.com/users/nvsajeeva/repos","events_url":"https://api.github.com/users/nvsajeeva/events{/privacy}","received_events_url":"https://api.github.com/users/nvsajeeva/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-05-23T07:02:43Z","updated_at":"2019-05-23T08:06:21Z","closed_at":"2019-05-23T08:06:21Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n6.2.4\r\n**Plugins installed**: []\r\nrepository-s3\r\n\r\n**JVM version** (`java -version`):\r\n1.8.0_181\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentOS Linux release 7.5.1804 (Core) \r\n3.10.0-862.3.2.el7.x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nOur ES cluster consists of 3 master nodes and 4 data nodes. It contains around 6300+ shards. \r\nSnapshot repository is configured pointing to an S3 bucket. When a snapshot is taken,  one or two shards fail, making it a partial snapshot. \r\nShards which happen to fail have no pattern. At a time it can be a shard in index A, next time it can be a shard in index B\r\n\r\n\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n\r\n\r\n>         {\r\n>           \"index\" : \"IDX1\",\r\n>           \"index_uuid\" : \"IDX1\",\r\n>           \"shard_id\" : 3,\r\n>           \"reason\" : \"IndexShardSnapshotFailedException[Failed to write file list]; nested: IOException[com.amazonaws.services.s3.model.AmazonS3Exception: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: X; S3 Extended Request ID: X), S3 Extended Request ID: X]; nested: AmazonS3Exception[The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: X; S3 Extended Request ID: X)]; \",\r\n>           \"node_id\" : \"-lmVU9lxS1SL3lTgeFP1JA\",\r\n>           \"status\" : \"INTERNAL_SERVER_ERROR\"\r\n>         }\r\n\r\n> [2019-05-23T01:20:44,600][WARN ][o.e.s.SnapshotShardsService] [data-4] [[X][3]][s3_repository:curator-prod-20190523010005/X] failed to snapshot shard\r\n> org.elasticsearch.index.snapshots.IndexShardSnapshotFailedException: Failed to write file list\r\n>         at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:994) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1230) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:810) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:412) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:98) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:355) [elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) [elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n>         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_181]\r\n>         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_181]\r\n>         at java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\n> Caused by: java.io.IOException: com.amazonaws.services.s3.model.AmazonS3Exception: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: X; S3 Extended Request ID: X), S3 Extended Request ID: X\r\n>         at org.elasticsearch.repositories.s3.S3BlobContainer.move(S3BlobContainer.java:177) ~[?:?]\r\n>         at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeAtomic(ChecksumBlobStoreFormat.java:138) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:992) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         ... 10 more\r\n>         Suppressed: java.nio.file.NoSuchFileException: Blob [pending-index-2] does not exist\r\n>                 at org.elasticsearch.repositories.s3.S3BlobContainer.deleteBlob(S3BlobContainer.java:116) ~[?:?]\r\n>                 at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeAtomic(ChecksumBlobStoreFormat.java:142) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:992) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.repositories.blobstore.BlobStoreRepository$SnapshotContext.snapshot(BlobStoreRepository.java:1230) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.repositories.blobstore.BlobStoreRepository.snapshotShard(BlobStoreRepository.java:810) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.snapshots.SnapshotShardsService.snapshot(SnapshotShardsService.java:412) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.snapshots.SnapshotShardsService.access$200(SnapshotShardsService.java:98) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.snapshots.SnapshotShardsService$1.doRun(SnapshotShardsService.java:355) [elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:672) [elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.2.4.jar:6.2.4]\r\n>                 at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_181]\r\n>                 at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_181]\r\n>                 at java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\n> Caused by: com.amazonaws.services.s3.model.AmazonS3Exception: The specified key does not exist. (Service: Amazon S3; Status Code: 404; Error Code: NoSuchKey; Request ID: X; S3 Extended Request ID: X\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.handleErrorResponse(AmazonHttpClient.java:1639) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeOneRequest(AmazonHttpClient.java:1304) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeHelper(AmazonHttpClient.java:1056) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.doExecute(AmazonHttpClient.java:743) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.executeWithTimer(AmazonHttpClient.java:717) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.execute(AmazonHttpClient.java:699) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutor.access$500(AmazonHttpClient.java:667) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient$RequestExecutionBuilderImpl.execute(AmazonHttpClient.java:649) ~[?:?]\r\n>         at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:513) ~[?:?]\r\n>         at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:4247) ~[?:?]\r\n>         at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:4194) ~[?:?]\r\n>         at com.amazonaws.services.s3.AmazonS3Client.copyObject(AmazonS3Client.java:1870) ~[?:?]\r\n>         at org.elasticsearch.repositories.s3.S3BlobContainer.lambda$move$6(S3BlobContainer.java:172) ~[?:?]\r\n>         at org.elasticsearch.repositories.s3.SocketAccess.lambda$doPrivilegedVoid$0(SocketAccess.java:57) ~[?:?]\r\n>         at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_181]\r\n>         at org.elasticsearch.repositories.s3.SocketAccess.doPrivilegedVoid(SocketAccess.java:56) ~[?:?]\r\n>         at org.elasticsearch.repositories.s3.S3BlobContainer.move(S3BlobContainer.java:171) ~[?:?]\r\n>         at org.elasticsearch.repositories.blobstore.ChecksumBlobStoreFormat.writeAtomic(ChecksumBlobStoreFormat.java:138) ~[elasticsearch-6.2.4.jar:6.2.4]\r\n>         at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:992) ~[elasticsearch-6.2.4.jar:6.2.4]","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}