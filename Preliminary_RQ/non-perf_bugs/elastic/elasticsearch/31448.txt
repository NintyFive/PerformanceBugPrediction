{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31448","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31448/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31448/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31448/events","html_url":"https://github.com/elastic/elasticsearch/issues/31448","id":333866846,"node_id":"MDU6SXNzdWUzMzM4NjY4NDY=","number":31448,"title":"Null pointer exception with script query on indexed text field","user":{"login":"tonyyanga","id":5278006,"node_id":"MDQ6VXNlcjUyNzgwMDY=","avatar_url":"https://avatars0.githubusercontent.com/u/5278006?v=4","gravatar_id":"","url":"https://api.github.com/users/tonyyanga","html_url":"https://github.com/tonyyanga","followers_url":"https://api.github.com/users/tonyyanga/followers","following_url":"https://api.github.com/users/tonyyanga/following{/other_user}","gists_url":"https://api.github.com/users/tonyyanga/gists{/gist_id}","starred_url":"https://api.github.com/users/tonyyanga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tonyyanga/subscriptions","organizations_url":"https://api.github.com/users/tonyyanga/orgs","repos_url":"https://api.github.com/users/tonyyanga/repos","events_url":"https://api.github.com/users/tonyyanga/events{/privacy}","received_events_url":"https://api.github.com/users/tonyyanga/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-06-19T22:52:38Z","updated_at":"2019-01-24T20:40:33Z","closed_at":"2018-06-21T18:04:50Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nVersion: 6.3.0, Build: default/zip/424e937/2018-06-11T23:38:03.357887Z, JVM: 1.8.0_171\r\n\r\n**Plugins installed**: None\r\n\r\n**JVM version** (`java -version`):\r\n\r\nopenjdk version \"1.8.0_171\"\r\nOpenJDK Runtime Environment (build 1.8.0_171-8u171-b11-1~bpo8+1-b11)\r\nOpenJDK 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nLinux tony-laptop 3.16.0-4-amd64 #1 SMP Debian 3.16.51-3 (2017-12-13) x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI created a mapping with a text field, with only one document of valid values. Then I run a script query on using `_source` field, filtering null values. The query fails with null pointer exception and returns HTTP 500.\r\n\r\nI expect to receive one hit. I am able to obtain the expected behavior on version 6.0.0 but failed with 6.1.4, 6.2.4 and 6.3.0.\r\n\r\n**Steps to reproduce**:\r\n\r\nCreate mappings:\r\n\r\n```\r\nPUT /test_schema_1\r\n\r\n{\r\n  \"settings\":{\r\n    \"index\":{\r\n      \"number_of_shards\":1,\r\n      \"number_of_replicas\":0\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\nPUT /test_schema_1/_mapping/test_table_1\r\n\r\n{\"test_table_1\":{\"properties\":{\"text_field\":{\"type\":\"text\"}}}}\r\n```\r\n\r\nPopulate with one document:\r\n\r\n```\r\nPOST /_bulk?refresh=true\r\n\r\n{ \"index\" : { \"_index\" : \"test_schema_1\", \"_type\" : \"test_table_1\" } }\r\n{\"text_field\":\"string_value_0\"}\r\n```\r\n\r\nQuery:\r\n\r\n```\r\nPOST /test_schema_1/test_table_1/_search?scroll=300000ms\r\n\r\n{\r\n  \"from\" : 0,\r\n  \"size\" : 4000,\r\n  \"query\" : {\r\n    \"bool\" : {\r\n      \"must\" : [\r\n        {\r\n          \"script\" : {\r\n            \"script\" : {\r\n              \"source\" : \"(def) (params._source.text_field == null ? null : 1 == 1)\",\r\n              \"lang\" : \"painless\"\r\n            },\r\n            \"boost\" : 1.0\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\" : false,\r\n      \"adjust_pure_negative\" : true,\r\n      \"boost\" : 1.0\r\n    }\r\n  }\r\n}\r\n```\r\nActual behavior with version 6.3.0:\r\n\r\n```\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [\r\n            {\r\n                \"type\": \"script_exception\",\r\n                \"reason\": \"runtime error\",\r\n                \"script_stack\": [\r\n                    \"(def) (params._source.text_field == null ? null : 1 == 1)\",\r\n                    \"                     ^---- HERE\"\r\n                ],\r\n                \"script\": \"(def) (params._source.text_field == null ? null : 1 == 1)\",\r\n                \"lang\": \"painless\"\r\n            }\r\n        ],\r\n        \"type\": \"search_phase_execution_exception\",\r\n        \"reason\": \"all shards failed\",\r\n        \"phase\": \"query\",\r\n        \"grouped\": true,\r\n        \"failed_shards\": [\r\n            {\r\n                \"shard\": 0,\r\n                \"index\": \"test_schema_1\",\r\n                \"node\": \"KxD0i-SOSvieYNucLKBC-g\",\r\n                \"reason\": {\r\n                    \"type\": \"script_exception\",\r\n                    \"reason\": \"runtime error\",\r\n                    \"script_stack\": [\r\n                        \"(def) (params._source.text_field == null ? null : 1 == 1)\",\r\n                        \"                     ^---- HERE\"\r\n                    ],\r\n                    \"script\": \"(def) (params._source.text_field == null ? null : 1 == 1)\",\r\n                    \"lang\": \"painless\",\r\n                    \"caused_by\": {\r\n                        \"type\": \"null_pointer_exception\",\r\n                        \"reason\": null\r\n                    }\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"status\": 500\r\n}\r\n```\r\n\r\nExpected behavior obtained with version 6.0.0:\r\n\r\n```\r\n{\r\n    \"_scroll_id\": \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAAAAIWN1FxY04yMG5RSWlORnhJdzN5aTlGZw==\",\r\n    \"took\": 3,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 1,\r\n        \"successful\": 1,\r\n        \"skipped\": 0,\r\n        \"failed\": 0\r\n    },\r\n    \"hits\": {\r\n        \"total\": 1,\r\n        \"max_score\": 1,\r\n        \"hits\": [\r\n            {\r\n                \"_index\": \"test_schema_1\",\r\n                \"_type\": \"test_table_1\",\r\n                \"_id\": \"BAY4GmQBHwt3Z431yPc8\",\r\n                \"_score\": 1,\r\n                \"_source\": {\r\n                    \"text_field\": \"string_value_0\"\r\n                }\r\n            }\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nConsole output:\r\n\r\n```\r\n[2018-06-19T15:46:18,138][WARN ][r.suppressed             ] path: /test_schema_1/test_table_1/_search, params: {scroll=300000ms, index=test_schema_1, type=test_table_1}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:288) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:128) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:249) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:101) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:222) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:176) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:222) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:527) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1095) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1188) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1172) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:66) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6$1.onFailure(SearchTransportService.java:385) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:341) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:335) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:329) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:1019) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:724) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.3.0.jar:6.3.0]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_171]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_171]\r\n\tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_171]\r\nCaused by: org.elasticsearch.script.ScriptException: runtime error\r\n\tat org.elasticsearch.painless.PainlessScript.convertToScriptException(PainlessScript.java:94) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessScript$Script.execute((def) (params._source.text_field == null ? null : 1 == 1):8) ~[?:?]\r\n\tat org.elasticsearch.index.query.ScriptQueryBuilder$ScriptQuery$1$1.matches(ScriptQueryBuilder.java:188) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:240) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:184) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:660) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:191) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:266) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:107) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:324) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:357) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\t... 9 more\r\nCaused by: java.lang.NullPointerException\r\n\tat org.elasticsearch.painless.DefBootstrap$PIC.fallback(DefBootstrap.java:202) ~[?:?]\r\n\tat org.elasticsearch.painless.PainlessScript$Script.execute((def) (params._source.text_field == null ? null : 1 == 1):22) ~[?:?]\r\n\tat org.elasticsearch.index.query.ScriptQueryBuilder$ScriptQuery$1$1.matches(ScriptQueryBuilder.java:188) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:240) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:184) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:660) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:191) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462) ~[lucene-core-7.3.1.jar:7.3.1 ae0705edb59eaa567fe13ed3a222fdadc7153680 - caomanhdat - 2018-05-09 09:27:24]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:266) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:107) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:324) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:357) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\t... 9 more\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:107) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:324) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:357) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\t... 9 more\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:107) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:324) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:357) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.3.0.jar:6.3.0]\r\n\t... 9 more\r\n```\r\n\r\n**More info**:\r\n\r\nThe above error case uses script:\r\n\r\n`(def) (params._source.text_field == null ? null : 1 == 1)`\r\n\r\nI get null pointer exception with `(def) (params._source== null ? null : 1 == 1)` as well. However, using `(def) (params == null ? null : 1 == 1)` I can get the right result.\r\n\r\nIs there a change with painless script syntax from 6.0 to 6.1 that I am not aware of?\r\n\r\nThank you!","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}