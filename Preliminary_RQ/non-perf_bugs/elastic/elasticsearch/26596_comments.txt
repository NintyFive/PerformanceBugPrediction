[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329089787","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329089787","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329089787,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTA4OTc4Nw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T08:00:22Z","updated_at":"2017-09-13T08:00:22Z","author_association":"MEMBER","body":"@javanna are you able to have a look at this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329100516","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329100516","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329100516,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEwMDUxNg==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T08:45:23Z","updated_at":"2017-09-13T08:45:23Z","author_association":"MEMBER","body":"Could you explain a bit more about what you are trying to do? Why are you trying to set Authorization headers in this way? If you are trying to authenticate with the XPack Security plugin then this can be done by following the steps in https://www.elastic.co/guide/en/x-pack/current/java-clients.html. The threadpool is almost certainly not going to be the right place to be setting these headers.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329105409","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329105409","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329105409,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEwNTQwOQ==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T09:04:22Z","updated_at":"2017-09-13T09:04:22Z","author_association":"NONE","body":"I have found a way to fix it. \r\nI use myself authority plugin.\r\nAdd authentication in transportt client header and http header.\r\nbut in BulkProcessor, when add request, eg:  bulkProcessor.add(request),\r\n\r\n private synchronized void internalAdd(DocWriteRequest request, @Nullable Object payload) {\r\n        ensureOpen();\r\n        bulkRequest.add(request, payload);\r\n        executeIfNeeded();\r\n    }\r\nif executeIfNeeded(), then execute Immediately in this thread.\r\nbut if flushInterval To meet the conditions, then execute Immediately in other thread .\r\nso, this header is lost in other thread.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329119624","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329119624","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329119624,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTExOTYyNA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T09:58:55Z","updated_at":"2017-09-13T09:58:55Z","author_association":"MEMBER","body":"Glad you have found a fix but do note that this is not a supported way of adding headers so this could well break in subsequent versions","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329121770","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329121770","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329121770,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyMTc3MA==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:07:56Z","updated_at":"2017-09-13T10:07:56Z","author_association":"NONE","body":"I want to fix this code, can reopen this issues?\r\nbut if well break in subsequent versions, Can there be other ways to replace it?\r\nOr now i have other better way to do itï¼Ÿ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329122273","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329122273","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329122273,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyMjI3Mw==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:10:16Z","updated_at":"2017-09-13T10:10:16Z","author_association":"NONE","body":" @Override\r\n        public void execute(BulkRequest bulkRequest, long executionId, Map<String, String> headers) {\r\n            if (client.threadPool().getThreadContext().getHeaders() == null && headers != null) {\r\n                client.threadPool().getThreadContext().putHeader(headers);\r\n            }....\r\nI want to add header para in this method.\r\nit's will fix this bug, Do you have a better suggestion?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329122927","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329122927","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329122927,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyMjkyNw==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:13:10Z","updated_at":"2017-09-13T10:13:10Z","author_association":"NONE","body":"@colings86 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329126440","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329126440","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329126440,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyNjQ0MA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:28:11Z","updated_at":"2017-09-13T10:28:11Z","author_association":"MEMBER","body":"> I have found a way to fix it.\r\n\r\nI took this as you had solved your problem and your issue was fixed which is why I closed the issue. However, we do reserve this Github issue list only for bug reports and feature requests. It is clear now that this is not a bug in Elasticsearch but rather a question about a bug in your application code. Questions like this should normally be asked in the [Elasticsearch forum](https://discuss.elastic.co/c/elasticsearch). Could you create a topic there to discuss this further? I am not familiar enough with this aspect of the codebase to know what the right solution is here","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329127963","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329127963","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329127963,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyNzk2Mw==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:34:57Z","updated_at":"2017-09-13T10:34:57Z","author_association":"NONE","body":"but I think this is es bug, because this header lost in org.elasticsearch.action.bulk.BulkProcessor.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329129318","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329129318","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329129318,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyOTMxOA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:40:56Z","updated_at":"2017-09-13T10:40:56Z","author_association":"MEMBER","body":"@jaymode @javanna is the ThreadContext supposed to be used in this manner to set and get headers and therefore not being able to get the header from the thread context is a bug?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329129442","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329129442","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329129442,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTEyOTQ0Mg==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T10:41:30Z","updated_at":"2017-09-13T10:41:55Z","author_association":"NONE","body":"please see org.elasticsearch.action.bulk.BulkProcessor,\r\n\r\nBulkProcessor(Client client, BackoffPolicy backoffPolicy, Listener listener, @Nullable String name, int concurrentRequests, int bulkActions, ByteSizeValue bulkSize, @Nullable TimeValue flushInterval) {\r\n        this.bulkActions = bulkActions;\r\n        this.bulkSize = bulkSize.getBytes();\r\n        this.bulkRequest = new BulkRequest();\r\n        this.bulkRequestHandler = (concurrentRequests == 0) ? BulkRequestHandler.syncHandler(client, backoffPolicy, listener) : BulkRequestHandler.asyncHandler(client, backoffPolicy, listener, concurrentRequests);\r\n\r\n        if (flushInterval != null) {\r\n            this.scheduler = (ScheduledThreadPoolExecutor) Executors.newScheduledThreadPool(1, EsExecutors.daemonThreadFactory(client.settings(), (name != null ? \"[\" + name + \"]\" : \"\") + \"bulk_processor\"));\r\n            this.scheduler.setExecuteExistingDelayedTasksAfterShutdownPolicy(false);\r\n            this.scheduler.setContinueExistingPeriodicTasksAfterShutdownPolicy(false);\r\n            this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(new Flush(), flushInterval.millis(), flushInterval.millis(), TimeUnit.MILLISECONDS);\r\n        } else {\r\n            this.scheduler = null;\r\n            this.scheduledFuture = null;\r\n        }\r\n    }\r\n\r\nthe code will execute other thread,lead to the client.threadPool().getThreadContext().header lost.\r\n\r\nIs not that a bug?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329237920","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329237920","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329237920,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTIzNzkyMA==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2017-09-13T17:22:01Z","updated_at":"2017-09-13T17:22:01Z","author_association":"MEMBER","body":"I think that this should be considered a issue. We shouldn't lose headers when switching threads as this is the only way for users to provide headers with requests.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329344000","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329344000","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329344000,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTM0NDAwMA==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-14T01:37:46Z","updated_at":"2017-09-14T01:38:15Z","author_association":"NONE","body":"if I fix to\r\n\r\n org.elasticsearch.action.bulk.BulkProcessor\r\n\r\n    BulkProcessor(Client client, BackoffPolicy backoffPolicy, Listener listener, @Nullable String name, int concurrentRequests, int bulkActions, ByteSizeValue bulkSize, @Nullable TimeValue flushInterval) {\r\n        this.bulkActions = bulkActions;\r\n        this.bulkSize = bulkSize.getBytes();\r\n\r\n        this.bulkRequest = new BulkRequest();\r\n        this.bulkRequestHandler = (concurrentRequests == 0) ? BulkRequestHandler.syncHandler(client, backoffPolicy, listener) : BulkRequestHandler.asyncHandler(client, backoffPolicy, listener, concurrentRequests);\r\n\r\n        if (flushInterval != null) {\r\n            this.scheduler = (ScheduledThreadPoolExecutor) Executors.newScheduledThreadPool(1, EsExecutors.daemonThreadFactory(client.settings(), (name != null ? \"[\" + name + \"]\" : \"\") + \"bulk_processor\"));\r\n            this.scheduler.setExecuteExistingDelayedTasksAfterShutdownPolicy(false);\r\n            this.scheduler.setContinueExistingPeriodicTasksAfterShutdownPolicy(false);\r\n            this.scheduledFuture = this.scheduler.scheduleWithFixedDelay(new Flush(client.threadPool().getThreadContext().getHeaders()), flushInterval.millis(), flushInterval.millis(), TimeUnit.MILLISECONDS);\r\n        } else {\r\n            this.scheduler = null;\r\n            this.scheduledFuture = null;\r\n        }\r\n    }\r\n\r\n\r\n\r\n    class Flush implements Runnable {\r\n        private Map<String, String> headers = null;\r\n\r\n        public Flush() {\r\n            super();\r\n        }\r\n\r\n        public Flush(Map<String, String> headers) {\r\n            this.headers = headers;\r\n        }\r\n\r\n        @Override\r\n        public void run() {\r\n            synchronized (BulkProcessor.this) {\r\n                if (closed) {\r\n                    return;\r\n                }\r\n                if (bulkRequest.numberOfActions() == 0) {\r\n                    return;\r\n                }\r\n                if (headers != null) {\r\n                    execute(headers);\r\n                } else {\r\n                    execute();\r\n                }\r\n            }\r\n        }\r\n    }\r\n\r\nand  in  org.elasticsearch.action.bulk.BulkRequestHandler ,add a abstract method\r\npublic abstract void execute(BulkRequest bulkRequest, long executionId, Map<String, String> headers);\r\n\r\n @Override\r\n        public void execute(BulkRequest bulkRequest, long executionId, Map<String, String> headers) {\r\n            if (headers != null) {\r\n                client.threadPool().getThreadContext().putHeader(headers);\r\n            }\r\n......\r\n\r\nit's ok?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329523217","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329523217","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329523217,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTUyMzIxNw==","user":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"created_at":"2017-09-14T15:42:41Z","updated_at":"2017-09-14T15:42:41Z","author_association":"MEMBER","body":"I would look at org.elasticsearch.common.util.concurrent.ThreadContext#preserveContext. We could just use that to wrap the Flush runnable","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329722119","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329722119","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329722119,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTcyMjExOQ==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-15T08:51:05Z","updated_at":"2017-09-15T08:51:05Z","author_association":"NONE","body":"hi\r\n@jaymode \r\nI do not know how to use this approach to fix.\r\nIs there a plan to fix this problem in the next version?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329722807","html_url":"https://github.com/elastic/elasticsearch/issues/26596#issuecomment-329722807","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26596","id":329722807,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTcyMjgwNw==","user":{"login":"hexian55","id":16074700,"node_id":"MDQ6VXNlcjE2MDc0NzAw","avatar_url":"https://avatars1.githubusercontent.com/u/16074700?v=4","gravatar_id":"","url":"https://api.github.com/users/hexian55","html_url":"https://github.com/hexian55","followers_url":"https://api.github.com/users/hexian55/followers","following_url":"https://api.github.com/users/hexian55/following{/other_user}","gists_url":"https://api.github.com/users/hexian55/gists{/gist_id}","starred_url":"https://api.github.com/users/hexian55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hexian55/subscriptions","organizations_url":"https://api.github.com/users/hexian55/orgs","repos_url":"https://api.github.com/users/hexian55/repos","events_url":"https://api.github.com/users/hexian55/events{/privacy}","received_events_url":"https://api.github.com/users/hexian55/received_events","type":"User","site_admin":false},"created_at":"2017-09-15T08:53:59Z","updated_at":"2017-09-15T08:53:59Z","author_association":"NONE","body":"hi jaymode\r\n\r\nCan you think this is a bug?","performed_via_github_app":null}]