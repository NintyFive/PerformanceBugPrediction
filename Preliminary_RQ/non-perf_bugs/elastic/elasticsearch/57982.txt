{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57982","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57982/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57982/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57982/events","html_url":"https://github.com/elastic/elasticsearch/issues/57982","id":636950999,"node_id":"MDU6SXNzdWU2MzY5NTA5OTk=","number":57982,"title":"[ML] Delete some annotations when reverting a model snapshot with delete_intervening_results=true","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"}],"state":"closed","locked":false,"assignee":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"assignees":[{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2020-06-11T11:50:33Z","updated_at":"2020-06-18T14:30:39Z","closed_at":"2020-06-18T14:30:39Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"At the moment when a model snapshot is reverted using the revert model snapshot API with [`delete_intervening_results`](https://www.elastic.co/guide/en/elasticsearch/reference/current/ml-revert-snapshot.html#ml-revert-snapshot-request-body) set to `true`, all results later than the last result time stored in the model snapshot document are deleted.\r\n\r\nIt also makes sense to delete certain types of annotations in this situation:\r\n\r\n* `delayed_data` - because the results based on the delayed data are being deleted, the fact that the data was originally delayed is not relevant.  If the same time period is re-run and data is delayed again then a new `delayed_data` annotation will be generated.\r\n* `model_change` - because the model that changed is no longer in use; it has been rolled back to a time before those changes occurred.  If the same time period is re-run then new `model_change` annotations may be generated, but these may or may not be the same as the original ones depending on what else was changed before the re-run (e.g. calendar events or corrections to the input data).\r\n\r\nOnly annotations that relate to periods after the reversion time should be deleted - earlier ones are still relevant.\r\n\r\nOther types of annotation should not be deleted when reverting a model snapshot.\r\n\r\nThere is actually a tricky situation with `model_change` annotations in the case where `delete_internvening_results` is `false`.  Results will still exist around the time of the model changes, so it makes sense to keep them to explain these results.  But the model changes _won't_ apply to the period after which the datafeed is restarted using the reverted model.  Ideally we'd add an annotation at the start time of the datafeed after reverting a model snapshot with `delete_internvening_results=false` to say that model changes in between the snapshot time and the restart time weren't relevant after the restart.  But this would be extremely hard as they are two separate APIs that have no knowledge of each other.\r\n\r\nIt is much simpler and more obvious what needs doing when `delete_internvening_results=true`, so implementing that would be a good start.","closed_by":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}