{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27954/events","html_url":"https://github.com/elastic/elasticsearch/issues/27954","id":284030870,"node_id":"MDU6SXNzdWUyODQwMzA4NzA=","number":27954,"title":"MultiPoint query yields more false positives when points are further apart","user":{"login":"mikeurbach","id":1182100,"node_id":"MDQ6VXNlcjExODIxMDA=","avatar_url":"https://avatars0.githubusercontent.com/u/1182100?v=4","gravatar_id":"","url":"https://api.github.com/users/mikeurbach","html_url":"https://github.com/mikeurbach","followers_url":"https://api.github.com/users/mikeurbach/followers","following_url":"https://api.github.com/users/mikeurbach/following{/other_user}","gists_url":"https://api.github.com/users/mikeurbach/gists{/gist_id}","starred_url":"https://api.github.com/users/mikeurbach/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikeurbach/subscriptions","organizations_url":"https://api.github.com/users/mikeurbach/orgs","repos_url":"https://api.github.com/users/mikeurbach/repos","events_url":"https://api.github.com/users/mikeurbach/events{/privacy}","received_events_url":"https://api.github.com/users/mikeurbach/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":113234020,"node_id":"MDU6TGFiZWwxMTMyMzQwMjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/stalled","name":"stalled","color":"fef2c0","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2017-12-21T23:14:44Z","updated_at":"2020-10-23T12:24:38Z","closed_at":"2020-10-23T12:24:38Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: Version: 6.1.1, Build: bd92e7f/2017-12-17T20:23:25.338Z, JVM: 1.8.0_45 \r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** : Java(TM) SE Runtime Environment (build 1.8.0_45-b14) \r\n\r\n**OS version**: Darwin Kernel Version 14.5.0: Sun Jun  4 21:40:08 PDT 2017; root:xnu-2782.70.3~1/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI am using a geo_shape mapping to index polygons and querying with a multi point. I get false positives when the multi point contains points that are very far apart and do not intersect any polygon. If I use non-matching points that are sufficiently close together, there is no false positive, as expected. \r\n\r\nThis appears to only be happening when I enable the `\"tree\": \"quadtree\"` option for this field. I couldn't reproduce with the default geohash tree. I've tried with different precision and distance error percent settings, but the issue remains, and it occurs with the default settings.\r\n\r\nI don't think this is a duplicate of https://github.com/elastic/elasticsearch/issues/27123, as this seems to be related to the quadtree implementation, multi points, and much larger distances than the example in #27123.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create an index with a geo_shape field and quadtree enabled.\r\n```\r\ncurl -XDELETE localhost:9200/test\r\n\r\ncurl -XPUT -H'Content-Type: application/json' localhost:9200/test -d'{\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"location\": {\r\n          \"type\": \"geo_shape\",\r\n          \"tree\": \"quadtree\",\r\n          \"precision\": \"100m\",\r\n          \"distance_error_pct\": 0.05\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n2. Index a polygon\r\n```\r\ncurl -XPUT -H'Content-Type: application/json' localhost:9200/test/test/1 -d'{\r\n  \"location\": {\r\n    \"type\": \"Polygon\",\r\n    \"coordinates\": [\r\n      [\r\n        [-0.1263, 51.5016],\r\n        [-0.1263, 51.4996],\r\n        [-0.1228, 51.4996],\r\n        [-0.1228, 51.5016],\r\n        [-0.1263, 51.5016]\r\n      ]\r\n    ]\r\n  }\r\n}'\r\n```\r\n3. Query with non-matching points, which are \"close\". Nothing is returned, as expected. Screenshot of geojson.io: http://take.ms/DYuU8m \r\n```\r\ncurl -XPOST -H'Content-Type: application/json' localhost:9200/test/_search -d'{\r\n  \"query\": {\r\n    \"geo_shape\": {\r\n      \"location\": {\r\n        \"shape\": {\r\n          \"type\": \"MultiPoint\",\r\n           \"coordinates\": [\r\n             [-0.1264, 51.5062],\r\n             [-0.1235, 51.4935]\r\n           ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n4. Query with non-matching points, which are \"far apart\". The document is returned, even though neither of the points intersects it. Screenshot of geojson.io: http://take.ms/Xjp15\r\n```\r\ncurl -XPOST -H'Content-Type: application/json' localhost:9200/test/_search -d'{\r\n  \"query\": {\r\n    \"geo_shape\": {\r\n      \"location\": {\r\n        \"shape\": {\r\n          \"type\": \"MultiPoint\",\r\n           \"coordinates\": [\r\n             [-0.1264, 51.5062],\r\n             [-117.7679, 35.5330]\r\n           ]\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n```\r\n\r\nI haven't played around too much with exactly how \"far apart\" the points need to be for this to happen.","closed_by":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"performed_via_github_app":null}