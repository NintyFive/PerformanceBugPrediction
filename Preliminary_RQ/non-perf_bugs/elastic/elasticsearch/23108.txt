{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23108","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23108/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23108/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23108/events","html_url":"https://github.com/elastic/elasticsearch/issues/23108","id":206792253,"node_id":"MDU6SXNzdWUyMDY3OTIyNTM=","number":23108,"title":"Computing average shows wrong value","user":{"login":"CristianWeiland","id":12500687,"node_id":"MDQ6VXNlcjEyNTAwNjg3","avatar_url":"https://avatars1.githubusercontent.com/u/12500687?v=4","gravatar_id":"","url":"https://api.github.com/users/CristianWeiland","html_url":"https://github.com/CristianWeiland","followers_url":"https://api.github.com/users/CristianWeiland/followers","following_url":"https://api.github.com/users/CristianWeiland/following{/other_user}","gists_url":"https://api.github.com/users/CristianWeiland/gists{/gist_id}","starred_url":"https://api.github.com/users/CristianWeiland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/CristianWeiland/subscriptions","organizations_url":"https://api.github.com/users/CristianWeiland/orgs","repos_url":"https://api.github.com/users/CristianWeiland/repos","events_url":"https://api.github.com/users/CristianWeiland/events{/privacy}","received_events_url":"https://api.github.com/users/CristianWeiland/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-02-10T13:09:54Z","updated_at":"2017-02-10T15:34:23Z","closed_at":"2017-02-10T14:57:12Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.2.0\r\n\r\n**JVM version**: openjdk version \"1.8.0_111\"\r\nOpenJDK Runtime Environment (build 1.8.0_111-8u111-b14-2~bpo8+1-b14)\r\nOpenJDK 64-Bit Server VM (build 25.111-b14, mixed mode)\r\n\r\n**OS version**: Debian 8.7\r\n\r\nI am using the official Docker container 5.2.\r\n\r\n**Description of the problem**:\r\n\r\nUsing Data table visualization in Kibana, I want to get the average value of a number field. When an extra filter is applied, which results in only one row, the average looks correct, but without extra filters, it seems like ElasticSearch does not search all documents in the date range.\r\n\r\n**Screenshot without filters**:\r\n![data_without_filters](https://cloud.githubusercontent.com/assets/12500687/22827130/63340f22-ef7d-11e6-8c48-f0aa84004032.png)\r\n\r\n**Screenshot using Name as filter** (note that documents retrieved went from 2 to 94 on the **Count** column):\r\n![data_with_filter](https://cloud.githubusercontent.com/assets/12500687/22827200/af4f6a6e-ef7d-11e6-9be6-a771adc94a09.png)\r\n\r\n\r\n**Request** without filters (first screenshot):\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"query_string\": {\r\n            \"query\": \"*\",\r\n            \"analyze_wildcard\": true\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": 1328876530691,\r\n              \"lte\": 1486729330691,\r\n              \"format\": \"epoch_millis\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": []\r\n    }\r\n  },\r\n  \"size\": 0,\r\n  \"_source\": {\r\n    \"excludes\": []\r\n  },\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"terms\": {\r\n        \"field\": \"NOME.keyword\",\r\n        \"size\": 10,\r\n        \"order\": {\r\n          \"1\": \"desc\"\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"1\": {\r\n          \"avg\": {\r\n            \"field\": \"REMUNERAÇÃO APÓS DEDUÇÕES OBRIGATÓRIAS (R$)\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n**Response** without filters (first screenshot):\r\n```\r\n{\r\n  \"took\": 29,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 235,\r\n    \"successful\": 235,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 366968,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"2\": {\r\n      \"doc_count_error_upper_bound\": -1,\r\n      \"sum_other_doc_count\": 366956,\r\n      \"buckets\": [\r\n        {\r\n          \"1\": {\r\n            \"value\": 52272\r\n          },\r\n          \"key\": \"CARLOS JOSE DE MESQUITA SIQUEIRA\",\r\n          \"doc_count\": 2\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 44516\r\n          },\r\n          \"key\": \"CLAUDIR JOSE DALTOE\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 37745\r\n          },\r\n          \"key\": \"DIONE MARIA MENZ\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 36270\r\n          },\r\n          \"key\": \"PAULO DA CUNHA LANA\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 36081\r\n          },\r\n          \"key\": \"LUIZ PEREIRA RAMOS\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 35154\r\n          },\r\n          \"key\": \"CARLOS EDUARDO PILLEGGI DE SOUZA\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 35017\r\n          },\r\n          \"key\": \"ALBERTO PIO FIORI\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 34044\r\n          },\r\n          \"key\": \"PAULO HENRIQUE TROMBETA ZANIN\",\r\n          \"doc_count\": 1\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 33876\r\n          },\r\n          \"key\": \"THELMA ALVIM VEIGA LUDWIG\",\r\n          \"doc_count\": 2\r\n        },\r\n        {\r\n          \"1\": {\r\n            \"value\": 33775\r\n          },\r\n          \"key\": \"ANDREA KNABEM\",\r\n          \"doc_count\": 1\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"status\": 200\r\n}\r\n```\r\n\r\n**Request** with name filters (second screenshot):\r\n```\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"query_string\": {\r\n            \"query\": \"*\",\r\n            \"analyze_wildcard\": true\r\n          }\r\n        },\r\n        {\r\n          \"match\": {\r\n            \"NOME.keyword\": {\r\n              \"query\": \"CARLOS JOSE DE MESQUITA SIQUEIRA\",\r\n              \"type\": \"phrase\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": 1328876577929,\r\n              \"lte\": 1486729377929,\r\n              \"format\": \"epoch_millis\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": []\r\n    }\r\n  },\r\n  \"size\": 0,\r\n  \"_source\": {\r\n    \"excludes\": []\r\n  },\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"terms\": {\r\n        \"field\": \"NOME.keyword\",\r\n        \"size\": 10,\r\n        \"order\": {\r\n          \"1\": \"desc\"\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"1\": {\r\n          \"avg\": {\r\n            \"field\": \"REMUNERAÇÃO APÓS DEDUÇÕES OBRIGATÓRIAS (R$)\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Response** with name filter (second screenshot):\r\n```\r\n{\r\n  \"took\": 45,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 235,\r\n    \"successful\": 235,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 94,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"2\": {\r\n      \"doc_count_error_upper_bound\": 0,\r\n      \"sum_other_doc_count\": 0,\r\n      \"buckets\": [\r\n        {\r\n          \"1\": {\r\n            \"value\": 12990.489361702128\r\n          },\r\n          \"key\": \"CARLOS JOSE DE MESQUITA SIQUEIRA\",\r\n          \"doc_count\": 94\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"status\": 200\r\n}\r\n```\r\n\r\nThis issue has been created in Kibana [here](https://github.com/elastic/kibana/issues/5265), but already closed by @rashidkpc , who said it was a bug in ElasticSearch.","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}