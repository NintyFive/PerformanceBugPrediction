{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15731","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15731/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15731/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15731/events","html_url":"https://github.com/elastic/elasticsearch/issues/15731","id":124513482,"node_id":"MDU6SXNzdWUxMjQ1MTM0ODI=","number":15731,"title":"Extend the Avg Aggregation to support weighted average","user":{"login":"lquerel","id":657994,"node_id":"MDQ6VXNlcjY1Nzk5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/657994?v=4","gravatar_id":"","url":"https://api.github.com/users/lquerel","html_url":"https://github.com/lquerel","followers_url":"https://api.github.com/users/lquerel/followers","following_url":"https://api.github.com/users/lquerel/following{/other_user}","gists_url":"https://api.github.com/users/lquerel/gists{/gist_id}","starred_url":"https://api.github.com/users/lquerel/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lquerel/subscriptions","organizations_url":"https://api.github.com/users/lquerel/orgs","repos_url":"https://api.github.com/users/lquerel/repos","events_url":"https://api.github.com/users/lquerel/events{/privacy}","received_events_url":"https://api.github.com/users/lquerel/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":27,"created_at":"2015-12-31T23:00:04Z","updated_at":"2018-08-27T22:37:01Z","closed_at":"2018-07-23T22:33:16Z","author_association":"NONE","active_lock_reason":null,"body":"The current Avg Aggretation only supports the simple form of average (ie: sum(values) / num of values). In order to support weighted average (ie: sum( value \\* weight) / sum (weight)) in an efficient way, I suggest the following changes in the API.\n\n**First implementation without modification of the existing API**\nThe script property in the avg object can return a number of a list of numbers. My proposal is to also support a map containing 2 fixed properties: value and weight (or values and weights if multiple values) (. For example:\n\n``` javascript\n{\"avg\" : { \"script\" : \"[value: doc['latency'].value, weight: doc['transaction'].value]\" }}\n```\n\nI prototyped this solution with only 2 modifications. A first modification in the ScriptDoubleValues class to take into account this map. A second modification in the AvgAggregator class to apply the right formula accordingly to the context.\n\n**Second implementation requiring minor modifications of the existing API (more efficient because no script)**\nWe can add a new property 'weight' to define the field to use in the document.\n\n``` javascript\n{ \"avg\" : { \"field\" : \"latency\",  \"weight\" : \"transaction\"} } \n```\n\nI didn't prototype this solution because I'm still not sure which DoubleValues implementation to use to get efficiently the value and the weight. If you have some advices don't hesitate.\n\nA third option is to use scripted metrics but until now it's not possible to sort the result of scripted metrics so that doesn't work for me. I created a pull request to add this support but I'm still waiting approval. But anyway a solution based on scripted metrics will be less efficient. \n\nThis proposal should be easy to implement and I'm pretty sure that many users will be happy with this extended version of the avg aggregation. \n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}