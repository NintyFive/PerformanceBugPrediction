{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26263","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26263/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26263/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26263/events","html_url":"https://github.com/elastic/elasticsearch/issues/26263","id":251047684,"node_id":"MDU6SXNzdWUyNTEwNDc2ODQ=","number":26263,"title":"A /reindex operation could end up deleting the data in the source index if pipelines are misconfigured","user":{"login":"jmlucjav","id":1813237,"node_id":"MDQ6VXNlcjE4MTMyMzc=","avatar_url":"https://avatars0.githubusercontent.com/u/1813237?v=4","gravatar_id":"","url":"https://api.github.com/users/jmlucjav","html_url":"https://github.com/jmlucjav","followers_url":"https://api.github.com/users/jmlucjav/followers","following_url":"https://api.github.com/users/jmlucjav/following{/other_user}","gists_url":"https://api.github.com/users/jmlucjav/gists{/gist_id}","starred_url":"https://api.github.com/users/jmlucjav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jmlucjav/subscriptions","organizations_url":"https://api.github.com/users/jmlucjav/orgs","repos_url":"https://api.github.com/users/jmlucjav/repos","events_url":"https://api.github.com/users/jmlucjav/events{/privacy}","received_events_url":"https://api.github.com/users/jmlucjav/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-08-17T19:30:23Z","updated_at":"2018-02-13T19:41:36Z","closed_at":"2017-08-18T13:06:16Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** \r\nVersion: 6.0.0-beta1-SNAPSHOT, Build: Unknown/2017-08-13T15:13:28.500Z, JVM: 1.8.0_102\r\n\r\n**JVM version**\r\njava version \"1.8.0_102\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_102-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode)\r\n\r\n**OS version**\r\nwin10, 64b\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nA /reindex operation could end up deleting the data in the source index if pipelines are misused. I am hesitant to report this as a bug, as I think it makes sense to consider it is working exactly as designed. But just in case, as it can led to losing your original docs in the source index, here it is.\r\n\r\n**Steps to reproduce**:\r\n\r\n1. index a couple of docs into twitter \r\n```\r\ncurl -XPUT 'localhost:9200/twitter?pretty' -H 'Content-Type: application/json' -d'{}'\r\ncurl -XPUT 'localhost:9200/twitter/tweet/1?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n    \"user\" : \"kimchy\",\r\n    \"post_date\" : \"2009-11-15T14:12:12\",\r\n    \"message\" : \"trying out Elasticsearch\"\r\n}'\r\ncurl -XPUT 'localhost:9200/twitter/tweet/2?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n    \"user\" : \"user2\",\r\n    \"post_date\" : \"2012-11-15T14:12:12\",\r\n    \"message\" : \"some mess\"\r\n}'\r\n```\r\n\r\n2. define a pipeline that sets _index=twitter and removes all fields\r\n```\r\ncurl -XPUT 'localhost:9200/_ingest/pipeline/pipeline1?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"description\" : \"describe pipeline\",\r\n  \"processors\" : [\r\n    {\r\n      \"set\" : {\r\n         \"field\": \"_index\",\r\n         \"value\": \"twitter\"\r\n      }\r\n    },\r\n    {\r\n      \"remove\" : {\r\n         \"field\": [\"user\", \"post_date\", \"message\"]\r\n      }\r\n    }\r\n  ]\r\n}\r\n'\r\n```\r\n3.  reindexing from twitter to itself is not possible, it is catched by some safeguard:\r\n```\r\ncurl -XPOST 'localhost:9200/_reindex?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"source\": {\r\n    \"index\": \"twitter\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"twitter\"\r\n  }\r\n}\r\n'\r\n```\r\n\r\n```\r\n{                                                                                                                                   \r\n  \"error\" : {                                                                                                                       \r\n    \"root_cause\" : [                                                                                                                \r\n      {                                                                                                                             \r\n        \"type\" : \"action_request_validation_exception\",                                                                             \r\n        \"reason\" : \"Validation Failed: 1: reindex cannot write into an index its reading from [twitter];\"                           \r\n      }                                                                                                                             \r\n    ],                                                                                                                              \r\n    \"type\" : \"action_request_validation_exception\",                                                                                 \r\n    \"reason\" : \"Validation Failed: 1: reindex cannot write into an index its reading from [twitter];\"                               \r\n  },                                                                                                                                \r\n  \"status\" : 400                                                                                                                    \r\n}                                                                                                                                   \r\n```\r\n\r\n4.  reindex from twitter to dest\r\n```\r\ncurl -XPOST 'localhost:9200/_reindex?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"source\": {\r\n    \"index\": \"twitter\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"dest\",\r\n    \"pipeline\": \"pipeline1\"\r\n  }\r\n}\r\n'\r\n```\r\n5. due to the pipeline, the original docs in twitter are lost (well all the fields lost, but by changing the ctx.op to delete the docs could be totally deleted too I guess, did not try it)\r\n\r\n\r\n> \"hits\": {\r\n> \"total\": 2,\r\n> \"max_score\": 1,\r\n> \"hits\": [\r\n> {\r\n> \"_index\": \"twitter\",\r\n> \"_type\": \"tweet\",\r\n> \"_id\": \"2\",\r\n> \"_score\": 1,\r\n> \"_source\": {}\r\n> },\r\n> {\r\n> \"_index\": \"twitter\",\r\n> \"_type\": \"tweet\",\r\n> \"_id\": \"1\",\r\n> \"_score\": 1,\r\n> \"_source\": {}\r\n> }\r\n> ]\r\n> }\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}