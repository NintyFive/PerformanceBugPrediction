{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43695","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43695/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43695/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43695/events","html_url":"https://github.com/elastic/elasticsearch/issues/43695","id":461531807,"node_id":"MDU6SXNzdWU0NjE1MzE4MDc=","number":43695,"title":"[DOCS] example from configuring-tls-docker.asciidoc does not work and is out of date","user":{"login":"hobo05","id":7526980,"node_id":"MDQ6VXNlcjc1MjY5ODA=","avatar_url":"https://avatars3.githubusercontent.com/u/7526980?v=4","gravatar_id":"","url":"https://api.github.com/users/hobo05","html_url":"https://github.com/hobo05","followers_url":"https://api.github.com/users/hobo05/followers","following_url":"https://api.github.com/users/hobo05/following{/other_user}","gists_url":"https://api.github.com/users/hobo05/gists{/gist_id}","starred_url":"https://api.github.com/users/hobo05/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hobo05/subscriptions","organizations_url":"https://api.github.com/users/hobo05/orgs","repos_url":"https://api.github.com/users/hobo05/repos","events_url":"https://api.github.com/users/hobo05/events{/privacy}","received_events_url":"https://api.github.com/users/hobo05/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"assignees":[{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2019-06-27T13:32:23Z","updated_at":"2020-11-11T21:55:40Z","closed_at":"2019-07-01T12:32:45Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version:** Version: 7.2.0, Build: default/docker/508c38a/2019-06-20T15:54:18.811730Z, JVM: 12.0.1\r\n\r\n**Docker Image:** docker.elastic.co/elasticsearch/elasticsearch:7.2.0\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen trying to run `create-certs.yml` using docker-compose from `https://github.com/elastic/elasticsearch/blob/v7.2.0/docs/reference/security/securing-communications/configuring-tls-docker.asciidoc` I expect that the certificates will be created and saved to the current directory. What actually happens is as follows\r\n\r\n```\r\n$ docker-compose -f create-certs.yml up\r\nERROR: Invalid interpolation format for \"user\" option in service \"create_certs\": \"$\\{UID:-1000\\}\"\r\n```\r\n\r\nThis can be fixed by setting `user` directly to `'1000'`.\r\n\r\nThe next error you'll get is\r\n\r\n```\r\n$ docker-compose -f create-certs.yml up\r\nCreating create_certs ... done\r\nAttaching to create_certs\r\ncreate_certs    | WARNING: An illegal reflective access operation has occurred\r\ncreate_certs    | WARNING: Illegal reflective access by org.bouncycastle.jcajce.provider.drbg.DRBG (file:/usr/share/elasticsearch/lib/tools/security-cli/bcprov-jdk15on-1.61.jar) to constructor sun.security.provider.Sun()\r\ncreate_certs    | WARNING: Please consider reporting this to the maintainers of org.bouncycastle.jcajce.provider.drbg.DRBG\r\ncreate_certs    | WARNING: Use --illegal-access=warn to enable warnings of further illegal reflective access operations\r\ncreate_certs    | WARNING: All illegal access operations will be denied in a future release\r\ncreate_certs    | Exception in thread \"main\" java.nio.file.FileAlreadyExistsException: /usr/share/elasticsearch/config/certificates/certs/bundle.zip\r\ncreate_certs    |       at java.base/sun.nio.fs.UnixException.translateToIOException(UnixException.java:94)\r\ncreate_certs    |       at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:111)\r\ncreate_certs    |       at java.base/sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:116)\r\ncreate_certs    |       at java.base/sun.nio.fs.UnixFileSystemProvider.newByteChannel(UnixFileSystemProvider.java:219)\r\ncreate_certs    |       at java.base/java.nio.file.spi.FileSystemProvider.newOutputStream(FileSystemProvider.java:478)\r\ncreate_certs    |       at java.base/java.nio.file.Files.newOutputStream(Files.java:222)\r\ncreate_certs    |       at org.elasticsearch.xpack.security.cli.CertificateGenerateTool.fullyWriteFile(CertificateGenerateTool.java:456)\r\ncreate_certs    |       at org.elasticsearch.xpack.security.cli.CertificateGenerateTool.generateAndWriteSignedCertificates(CertificateGenerateTool.java:405)\r\ncreate_certs    |       at org.elasticsearch.xpack.security.cli.CertificateGenerateTool.execute(CertificateGenerateTool.java:185)\r\ncreate_certs    |       at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)\r\ncreate_certs    |       at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)\r\ncreate_certs    |       at org.elasticsearch.cli.Command.main(Command.java:90)\r\ncreate_certs    |       at org.elasticsearch.xpack.security.cli.CertificateGenerateTool.main(CertificateGenerateTool.java:156)\r\ncreate_certs    | bash: line 6: unzip: command not found\r\ncreate_certs exited with code 0\r\n\r\n```\r\n\r\nThis is because in this commit https://github.com/elastic/dockerfiles/commit/b0c83e71a9fe72e89d87e87cea36ce44f09eb6a5#diff-21c4e096c31ca33cf67e2ad16f6dac93 for 7.2.0, `unzip` was removed from being installed in the Dockerfile for the [Contexts for 7.2.0](https://github.com/elastic/dockerfiles/pull/15) PR\r\n\r\nThe workaround right now is setting the user to `root` and installing unzip in the command. \r\n\r\nOn a separate note, this example is using `elasticsearch-certgen` which has been deprecated since 6.1 as documented https://github.com/elastic/elasticsearch/blob/ddafdb8ca1dd25fa16c6dbd9acd9763de7fc4738/docs/reference/commands/certgen.asciidoc. The team may want to consider switching out the command with `bin/elasticsearch-certutil cert --silent --pem --in config/certificates/instances.yml --keep-ca-key --ca-pass \"\" --out bundle.zip;` or something to that effect.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Follow directions from https://www.elastic.co/guide/en/elasticsearch/reference/7.2/configuring-tls-docker.html to create the `instances.yml`.\r\n2. Grab the contents of create-certs.yml from the page.  At the time of writing, this was what I copied.\r\n    ```\r\n    version: '2.2'\r\n\r\n    services:\r\n      create_certs:\r\n        container_name: create_certs\r\n        image: docker.elastic.co/elasticsearch/elasticsearch:7.2.0\r\n        command: >\r\n          bash -c '\r\n            if [[ ! -d config/certificates/certs ]]; then\r\n              mkdir config/certificates/certs;\r\n            fi;\r\n            if [[ ! -f /local/certs/bundle.zip ]]; then\r\n              bin/elasticsearch-certgen --silent --in config/certificates/instances.yml --out config/certificates/certs/bundle.zip;\r\n              unzip config/certificates/certs/bundle.zip -d config/certificates/certs;\r\n            fi;\r\n            chgrp -R 0 config/certificates/certs\r\n          '\r\n        user: $\\{UID:-1000\\}\r\n        working_dir: /usr/share/elasticsearch\r\n        volumes: ['.:/usr/share/elasticsearch/config/certificates']\r\n    ```\r\n 3. Run `docker-compose -f create-certs.yml up`\r\n 4. You should see it fail with the first error mentioned above.\r\n\r\n\r\n","closed_by":{"login":"dliappis","id":1754575,"node_id":"MDQ6VXNlcjE3NTQ1NzU=","avatar_url":"https://avatars0.githubusercontent.com/u/1754575?v=4","gravatar_id":"","url":"https://api.github.com/users/dliappis","html_url":"https://github.com/dliappis","followers_url":"https://api.github.com/users/dliappis/followers","following_url":"https://api.github.com/users/dliappis/following{/other_user}","gists_url":"https://api.github.com/users/dliappis/gists{/gist_id}","starred_url":"https://api.github.com/users/dliappis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dliappis/subscriptions","organizations_url":"https://api.github.com/users/dliappis/orgs","repos_url":"https://api.github.com/users/dliappis/repos","events_url":"https://api.github.com/users/dliappis/events{/privacy}","received_events_url":"https://api.github.com/users/dliappis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}