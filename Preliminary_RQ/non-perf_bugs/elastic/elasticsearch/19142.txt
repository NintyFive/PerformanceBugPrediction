{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19142","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19142/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19142/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19142/events","html_url":"https://github.com/elastic/elasticsearch/issues/19142","id":162875303,"node_id":"MDU6SXNzdWUxNjI4NzUzMDM=","number":19142,"title":"inner_hits breaks from version 1.7 to 2.3 upgrade","user":{"login":"siddharthgoel88","id":1888204,"node_id":"MDQ6VXNlcjE4ODgyMDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/1888204?v=4","gravatar_id":"","url":"https://api.github.com/users/siddharthgoel88","html_url":"https://github.com/siddharthgoel88","followers_url":"https://api.github.com/users/siddharthgoel88/followers","following_url":"https://api.github.com/users/siddharthgoel88/following{/other_user}","gists_url":"https://api.github.com/users/siddharthgoel88/gists{/gist_id}","starred_url":"https://api.github.com/users/siddharthgoel88/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/siddharthgoel88/subscriptions","organizations_url":"https://api.github.com/users/siddharthgoel88/orgs","repos_url":"https://api.github.com/users/siddharthgoel88/repos","events_url":"https://api.github.com/users/siddharthgoel88/events{/privacy}","received_events_url":"https://api.github.com/users/siddharthgoel88/received_events","type":"User","site_admin":false},"labels":[{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2016-06-29T09:04:35Z","updated_at":"2016-08-18T20:31:16Z","closed_at":"2016-08-18T20:31:16Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.3.3\n\n**JVM version**: 1.7.0_95\n\n**OS version**: Red Hat Enterprise Linux Workstation release 6.7 (Santiago)\n\n**Description of the problem including expected versus actual behavior**:\n\n**Steps to reproduce**:\n I have described the issue on community at https://discuss.elastic.co/t/inner-hits-queries-break-from-1-7-to-2-3-in-elasticsearch/54242 .\n\nI had an inner_hits query which was working fine in version 1.7 but it stopped working in version 2.3.3. Following is the query :\n\n```\n\"query\": {\n    \"filtered\": {\n        \"filter\": {\n            \"and\": [\n                {\n                    \"range\": {\n                        \"@timestamp\": {\n                             \"gte\": \"2015-01-01||/d\",\n                             \"lte\": \"2016-01-01||/d\"\n                        }\n                    }\n                },\n                {\n                    \"or\": [\n                        {\n                            \"has_child\": {\n                                \"type\": \"TypeName\",\n                                \"filter\": {\n                                    \"term\": {\n                                        \"eventType.raw\": \"some-event\"\n                                    }\n                                },\n                                \"inner_hits\": {\n                                    \"_source\": \"@timestamp\"\n                                }\n                            }\n                        },\n                        {\n                            \"not\": {\n                                \"has_child\": {\n                                    \"type\": \"TypeName\",\n                                    \"filter\": {\n                                        \"term\": {\n                                            \"eventType.raw\": \"some-event\"\n                                        }\n                                    },\n                                    \"inner_hits\": {\n                                        \"_source\": \"@timestamp\"\n                                    }\n                                }\n                            }\n                        }\n                    ]\n                }\n            ]\n        }\n    }\n}\n```\n\nWith version 2.3.3 I get the following response for it :\n\n```\n\"reason\": {\n   \"type\": \"illegal_argument_exception\",\n   \"reason\": \"inner_hit definition with the name [TypeName] already exists. Use a different inner_hit name\"\n}\n```\n\n**Provide logs (if relevant)**:\nFollowing is the error stack\n\n```\nnested: IllegalArgumentException[inner_hit definition with the name [TypeName] already exists. Use a different inner_hit name];\n    at org.elasticsearch.search.SearchService.parseSource(SearchService.java:855)\n    at org.elasticsearch.search.SearchService.createContext(SearchService.java:654)\n    at org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:620)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:371)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:368)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:365)\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:75)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalArgumentException: inner_hit definition with the name [TypeName] already exists. Use a different inner_hit name\n    at org.elasticsearch.search.fetch.innerhits.InnerHitsContext.addInnerHitDefinition(InnerHitsContext.java:69)\n    at org.elasticsearch.index.query.QueryParseContext.addInnerHits(QueryParseContext.java:218)\n    at org.elasticsearch.index.query.HasChildQueryParser.parse(HasChildQueryParser.java:155)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerFilter(QueryParseContext.java:277)\n    at org.elasticsearch.index.query.NotQueryParser.parse(NotQueryParser.java:69)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerQuery(QueryParseContext.java:250)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerFilter(QueryParseContext.java:263)\n    at org.elasticsearch.index.query.OrQueryParser.parse(OrQueryParser.java:69)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerQuery(QueryParseContext.java:250)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerFilter(QueryParseContext.java:263)\n    at org.elasticsearch.index.query.AndQueryParser.parse(AndQueryParser.java:69)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerQuery(QueryParseContext.java:250)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerFilter(QueryParseContext.java:263)\n    at org.elasticsearch.index.query.FilteredQueryParser.parse(FilteredQueryParser.java:79)\n    at org.elasticsearch.index.query.QueryParseContext.parseInnerQuery(QueryParseContext.java:250)\n    at org.elasticsearch.index.query.IndexQueryParserService.innerParse(IndexQueryParserService.java:320)\n    at org.elasticsearch.index.query.IndexQueryParserService.parse(IndexQueryParserService.java:223)\n    at org.elasticsearch.index.query.IndexQueryParserService.parse(IndexQueryParserService.java:218)\n    at org.elasticsearch.search.query.QueryParseElement.parse(QueryParseElement.java:33)\n    at org.elasticsearch.search.SearchService.parseSource(SearchService.java:838)\n    ... 12 more\n\n\n\n```\n","closed_by":{"login":"tsouza","id":122435,"node_id":"MDQ6VXNlcjEyMjQzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/122435?v=4","gravatar_id":"","url":"https://api.github.com/users/tsouza","html_url":"https://github.com/tsouza","followers_url":"https://api.github.com/users/tsouza/followers","following_url":"https://api.github.com/users/tsouza/following{/other_user}","gists_url":"https://api.github.com/users/tsouza/gists{/gist_id}","starred_url":"https://api.github.com/users/tsouza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsouza/subscriptions","organizations_url":"https://api.github.com/users/tsouza/orgs","repos_url":"https://api.github.com/users/tsouza/repos","events_url":"https://api.github.com/users/tsouza/events{/privacy}","received_events_url":"https://api.github.com/users/tsouza/received_events","type":"User","site_admin":false},"performed_via_github_app":null}