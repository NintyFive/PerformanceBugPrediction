[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47636968","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47636968","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47636968,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjM2OTY4","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T09:47:28Z","updated_at":"2014-07-01T09:47:28Z","author_association":"MEMBER","body":"I have tested this on master and it seems to return the expected buckets.  Which version of Elasticsearch are you running?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47637606","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47637606","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47637606,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjM3NjA2","user":{"login":"rocambolesque","id":4463477,"node_id":"MDQ6VXNlcjQ0NjM0Nzc=","avatar_url":"https://avatars1.githubusercontent.com/u/4463477?v=4","gravatar_id":"","url":"https://api.github.com/users/rocambolesque","html_url":"https://github.com/rocambolesque","followers_url":"https://api.github.com/users/rocambolesque/followers","following_url":"https://api.github.com/users/rocambolesque/following{/other_user}","gists_url":"https://api.github.com/users/rocambolesque/gists{/gist_id}","starred_url":"https://api.github.com/users/rocambolesque/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocambolesque/subscriptions","organizations_url":"https://api.github.com/users/rocambolesque/orgs","repos_url":"https://api.github.com/users/rocambolesque/repos","events_url":"https://api.github.com/users/rocambolesque/events{/privacy}","received_events_url":"https://api.github.com/users/rocambolesque/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T09:54:21Z","updated_at":"2014-07-01T09:54:21Z","author_association":"NONE","body":"I'm running 1.2.1.\nThe strange thing is that my ElasticSearch instance crashed running this query, I got:\n\n```\njava.lang.OutOfMemoryError: Java heap space\nDumping heap to java_pid2903.hprof ...\nHeap dump file created [35656409797 bytes in 236.788 secs]\n[2014-06-30 15:58:03,560][DEBUG][action.search.type       ] [Bloodshed] failed to reduce search\norg.elasticsearch.action.search.ReduceSearchPhaseException: Failed to execute phase [fetch], [reduce]\n[....]\n```\n\nI restarted it and then the query was working properly.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47649909","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47649909","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47649909,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjQ5OTA5","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T12:32:55Z","updated_at":"2014-07-01T12:32:55Z","author_association":"MEMBER","body":"ok so this is most likely to do with:\n\n> [ multiple sub terms aggregation here ]\n\nEach bucket generated by the date_histogram aggregation will contain buckets for each matched term in the sub aggregations.  Potentially generating 30x the number of buckets which would be generated for a single day (this is worst case as not all the days in June may be populated and not all terms will exist in all days). If you have further levels of bucket aggregations nested under the terms aggregation the number of buckets will grow further (and exponentially).\n\nAs the buckets are transient data stored in memory for the life of the request, generating a lot of buckets in this way can be very memory intensive and can lead to OOM Errors.  Although there are features currently under development which should help to combat these problems (detailed below), if you continue seeing these problems, you may need to either simplify your aggregation structure to reduce the number of generated buckets or increase the heap memory assigned to your ES nodes.\n\nThere is a circuit breaker currently in development which should help stop the server from actually running out of memory in these cases and instead will stop the request and pass an error back to the client. This is planned for 1.3.\n\nThere is also a feature coming in 1.3 which will add a new mode to an aggregation where the calculation of sub-aggregations can be deferred until the parent aggregation has determined the final list of buckets to keep (e.g. the top 10 terms in a terms aggregation) and will then replay the collected documents to calculate the sub-aggregations, vastly reducing the number of generated buckets).  This incurs a memory cost of keeping the collected docIds in memory but can be useful when the number of generated buckets is very large.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47651090","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47651090","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47651090,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjUxMDkw","user":{"login":"rocambolesque","id":4463477,"node_id":"MDQ6VXNlcjQ0NjM0Nzc=","avatar_url":"https://avatars1.githubusercontent.com/u/4463477?v=4","gravatar_id":"","url":"https://api.github.com/users/rocambolesque","html_url":"https://github.com/rocambolesque","followers_url":"https://api.github.com/users/rocambolesque/followers","following_url":"https://api.github.com/users/rocambolesque/following{/other_user}","gists_url":"https://api.github.com/users/rocambolesque/gists{/gist_id}","starred_url":"https://api.github.com/users/rocambolesque/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocambolesque/subscriptions","organizations_url":"https://api.github.com/users/rocambolesque/orgs","repos_url":"https://api.github.com/users/rocambolesque/repos","events_url":"https://api.github.com/users/rocambolesque/events{/privacy}","received_events_url":"https://api.github.com/users/rocambolesque/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T12:45:41Z","updated_at":"2014-07-01T12:45:58Z","author_association":"NONE","body":"I will look into simplifying my aggregations, filling the blanks in the histogram myself or make separate queries, although it is really handy to get everything with the right timezone offset with a single query.\n\nThanks for the explanation, looking forward to 1.3!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47651737","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47651737","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47651737,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjUxNzM3","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T12:52:20Z","updated_at":"2014-07-01T12:52:20Z","author_association":"MEMBER","body":"What is the structure of the sub aggregations under the date_histogram?  It is more likely to be that structure which is causing the issue then the date_histogram itself.  \n\nEmpty date_histogram buckets will not generate any sub-aggregation buckets since no documents will be passed to the sub-aggregations so I don't think your issue will be due to the min_doc_count or extended_bounds options you have set but more due to the sub-aggregations you are using.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47652680","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47652680","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47652680,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjUyNjgw","user":{"login":"rocambolesque","id":4463477,"node_id":"MDQ6VXNlcjQ0NjM0Nzc=","avatar_url":"https://avatars1.githubusercontent.com/u/4463477?v=4","gravatar_id":"","url":"https://api.github.com/users/rocambolesque","html_url":"https://github.com/rocambolesque","followers_url":"https://api.github.com/users/rocambolesque/followers","following_url":"https://api.github.com/users/rocambolesque/following{/other_user}","gists_url":"https://api.github.com/users/rocambolesque/gists{/gist_id}","starred_url":"https://api.github.com/users/rocambolesque/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocambolesque/subscriptions","organizations_url":"https://api.github.com/users/rocambolesque/orgs","repos_url":"https://api.github.com/users/rocambolesque/repos","events_url":"https://api.github.com/users/rocambolesque/events{/privacy}","received_events_url":"https://api.github.com/users/rocambolesque/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T13:01:35Z","updated_at":"2014-07-01T13:02:03Z","author_association":"NONE","body":"Here's the full aggregation:\n\n```\n\"aggs\": {\n    \"histogram\": {\n      \"date_histogram\": {\n        \"field\": \"_timestamp\",\n        \"interval\": \"1d\",\n        \"min_doc_count\": 0,\n        \"extended_bounds\": {\n          \"min\": 1401573600000,\n          \"max\": 1404165599999\n        },\n        \"pre_zone\": 2,\n        \"post_zone\": -2\n      },\n      \"aggs\": {\n        \"apps\": {\n          \"terms\": {\n            \"field\": \"field1\",\n            \"size\": 1 // this could be more but it ran out of memory with size = 1\n          },\n          \"aggs\": {\n            \"events\": {\n              \"terms\": {\n                \"field\": \"field2\"\n              },\n              \"aggs\": {\n                \"formats\": {\n                  \"terms\": {\n                    \"field\": \"field3\"\n                  },\n                  \"aggs\": {\n                    \"countries\": {\n                      \"terms\": {\n                        \"field\": \"field4\",\n                        \"size\": 50\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47655805","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47655805","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47655805,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjU1ODA1","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T13:31:25Z","updated_at":"2014-07-01T13:31:25Z","author_association":"MEMBER","body":"> \"size\": 1 // this could be more but it ran out of memory with size = 1\n\nThe size attribute doesn't  affect the amount of memory require to compute the aggregation since we have to track all buckets until we have processed all the documents to determine which are the top N buckets.  The amount of memory required is a function of the number of buckets that need to be created to work out the top N buckets.\n\nFor example if your query returned 1,000,000 documents which had 100 different countries, 50 different formats, 200 different events and 20 apps across even a single day,  you would potentially be creating up to 100 \\* 50 \\* 200 \\* 20 = 20,000,000 buckets for each request.\n\nThis example is the sort of case which could benefit from the deferred sub-aggregation feature I previously mentioned as the number of potential buckets is quite a bit larger than the number of hits returned by the query.\n\nOut of interest, how many hits does your query (without aggregations) return? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47657542","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47657542","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47657542,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjU3NTQy","user":{"login":"rocambolesque","id":4463477,"node_id":"MDQ6VXNlcjQ0NjM0Nzc=","avatar_url":"https://avatars1.githubusercontent.com/u/4463477?v=4","gravatar_id":"","url":"https://api.github.com/users/rocambolesque","html_url":"https://github.com/rocambolesque","followers_url":"https://api.github.com/users/rocambolesque/followers","following_url":"https://api.github.com/users/rocambolesque/following{/other_user}","gists_url":"https://api.github.com/users/rocambolesque/gists{/gist_id}","starred_url":"https://api.github.com/users/rocambolesque/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rocambolesque/subscriptions","organizations_url":"https://api.github.com/users/rocambolesque/orgs","repos_url":"https://api.github.com/users/rocambolesque/repos","events_url":"https://api.github.com/users/rocambolesque/events{/privacy}","received_events_url":"https://api.github.com/users/rocambolesque/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T13:46:35Z","updated_at":"2014-07-01T13:47:32Z","author_association":"NONE","body":"The number of hits ranges from a few thousands to a few millions for a 30 day range.\nAlthough there are only a few number of formats, events and countries, it might create a huge number of buckets indeed.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47661066","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47661066","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47661066,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjYxMDY2","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T14:15:34Z","updated_at":"2014-07-01T14:15:34Z","author_association":"MEMBER","body":"Until 1.3 you will probably need to simplify your aggregations structure or increase heap memory if you can.  After 1.3 has been released you should be able to take advantage of the deferred aggregations in #6128.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/47661108","html_url":"https://github.com/elastic/elasticsearch/issues/6652#issuecomment-47661108","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6652","id":47661108,"node_id":"MDEyOklzc3VlQ29tbWVudDQ3NjYxMTA4","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-07-01T14:15:54Z","updated_at":"2014-07-01T14:15:54Z","author_association":"MEMBER","body":"Closing in favour of #6128 \n","performed_via_github_app":null}]