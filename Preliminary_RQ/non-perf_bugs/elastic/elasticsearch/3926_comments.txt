[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26803422","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26803422","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26803422,"node_id":"MDEyOklzc3VlQ29tbWVudDI2ODAzNDIy","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2013-10-22T13:41:57Z","updated_at":"2013-10-22T13:41:57Z","author_association":"CONTRIBUTOR","body":"Any feedback about this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26805996","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26805996","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26805996,"node_id":"MDEyOklzc3VlQ29tbWVudDI2ODA1OTk2","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2013-10-22T14:11:30Z","updated_at":"2013-10-22T14:20:31Z","author_association":"CONTRIBUTOR","body":"Have you considered using the [function_score query](http://www.elasticsearch.org/guide/en/elasticsearch/reference/master/query-dsl-function-score-query.html)? \nYou can configure it so that people returned by a query are sorted by their closest distance to any number of  defined points. Is this what you want? \n\nHere is how the query would roughly look like:\n\n```\n\"query\": {\n      \"function_score\": {\n         \"query\": {\n            put here which kinds of people you look for and also maybe put distance filters to get rid of people that are too far anyway\n         },\n         \"functions\": [\n            {\n               \"gauss\": {\n                   \"name of geo location field for person\": {\n                        \"origin\": \"geo point of favorite cafe 1\",\n                        \"scale\": \"..\"\n                  }\n               }\n            },\n            {\n               \"gauss\": {\n                  \"name of geo location field for person\": {\n                      \"origin\": \"geo point of favorite cafe 2\",\n                      \"scale\": \"...\"\n                   }\n               }\n            },\n            ...put even more places...\n         ],\n         .. use the score of nearest place...\n         \"score_mode\": \"max\"\n      }\n   }\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26919007","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26919007","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26919007,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTE5MDA3","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2013-10-23T16:14:30Z","updated_at":"2013-10-23T16:14:30Z","author_association":"CONTRIBUTOR","body":"@brwe I think It could work too, but `_geo_distance` would be easier to debug, because it tells you the distance. I also think `_geo_distance` should work faster in my case.\n\nI tried `function_score` with query like this:\n\n``` json\n{\n  \"fields\": [\n    \"geo_points\"\n  ],\n  \"size\": 10000,\n  \"filter\": {\n    \"and\": [\n      {\n        \"or\": [\n          {\n            \"geo_distance\": {\n              \"geo_points.point\": {\n                \"lat\": 59.953478,\n                \"lon\": 30.315557\n              },\n              \"distance\": \"1.2km\"\n            }\n          },\n          {\n            \"geo_distance\": {\n              \"geo_points.point\": {\n                \"lat\": 60.002,\n                \"lon\": 30.298391\n              },\n              \"distance\": \"1.2km\"\n            }\n          }\n        ]\n      },\n      {\n        \"terms\": {\n          \"user_id\": [\n            51933602,\n            63087823,\n            45214178\n          ]\n        }\n      }\n    ]\n  },\n  \"query\": {\n    \"function_score\": {\n      \"boost_mode\": \"replace\",\n      \"score_mode\": \"max\",\n      \"functions\": [\n        {\n          \"gauss\": {\n            \"geo_points.point\": {\n              \"origin\": {\n                \"lat\": 59.953478,\n                \"lon\": 30.315557\n              },\n              \"scale\": \"1.2km\"\n            }\n          }\n        },\n        {\n          \"gauss\": {\n            \"geo_points.point\": {\n              \"origin\": {\n                \"lat\": 60.002,\n                \"lon\": 30.298391\n              },\n              \"scale\": \"1.2km\"\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nNotice that I filtered only 3 users, because their score for some reason is 0. Response looks like this:\n\n``` json\n{\n  \"total\": 3,\n  \"max_score\": 0,\n  \"hits\": [\n    {\n      \"_index\": \"female\",\n      \"_type\": \"users\",\n      \"_id\": \"45214178\",\n      \"_score\": 0,\n      \"fields\": {\n        \"geo_points\": [\n          {\n            \"point\": \"59.957,30.303\"\n          },\n          {\n            \"point\": \"0.004,0.004\"\n          },\n          {\n            \"point\": \"59.948,30.276\"\n          },\n          {\n            \"point\": \"59.944,30.272\"\n          }\n        ]\n      }\n    },\n    {\n      \"_index\": \"female\",\n      \"_type\": \"users\",\n      \"_id\": \"63087823\",\n      \"_score\": 0,\n      \"fields\": {\n        \"geo_points\": [\n          {\n            \"point\": \"59.956,30.318\"\n          },\n          {\n            \"point\": \"0,0\"\n          }\n        ]\n      }\n    },\n    {\n      \"_index\": \"female\",\n      \"_type\": \"users\",\n      \"_id\": \"51933602\",\n      \"_score\": 0,\n      \"fields\": {\n        \"geo_points\": [\n          {\n            \"point\": \"59.956,30.314\"\n          },\n          {\n            \"point\": \"0,-0.004\"\n          }\n        ]\n      }\n    }\n  ]\n}\n```\n\nThere are points far away from requested, but there are closer points in there same objects too. I thought that best match should be used. Am I missing something?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26923197","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26923197","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26923197,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTIzMTk3","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2013-10-23T17:03:42Z","updated_at":"2013-10-23T17:03:42Z","author_association":"CONTRIBUTOR","body":"No, you did not miss something, I did. I completely misunderstood your request. `function_score` unfortunately does not work for fields with multiple values. Hope you did not waste too much time with it.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26957577","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26957577","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26957577,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTU3NTc3","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2013-10-24T00:19:53Z","updated_at":"2013-10-24T00:19:53Z","author_association":"MEMBER","body":"Perhaps you can try implementing it as [script-based sort](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/search-request-sort.html#_script_based_sorting) that will calculated distances to all points of interest and then return the shortest one. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26969068","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26969068","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26969068,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTY5MDY4","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2013-10-24T06:19:28Z","updated_at":"2013-10-24T06:19:28Z","author_association":"CONTRIBUTOR","body":"@brwe maybe `function_sort` should fire an exception if it called against field with multiple values?\n\n@imotov yep, that should work, but scripting is much slower than native support. But I'll try.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/26979296","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-26979296","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":26979296,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTc5Mjk2","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2013-10-24T09:49:36Z","updated_at":"2013-10-24T09:49:36Z","author_association":"CONTRIBUTOR","body":"@imotov Looks like I cannot iterate array of objects in elasticsearch. I've found this thread: https://groups.google.com/forum/#!topic/elasticsearch/8Z2KwuPlyas\n\nMy mapping looks like this:\n\n``` json\n{\n  \"users\" : {\n    \"properties\" : {\n      \"geo_points\" : {\n        \"properties\" : {\n          \"point\" : {\n            \"type\" : \"geo_point\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nand script looks like this:\n\n``` mvel\ncurrent_to_any_geo_distance = 100;\nif (!doc[\"geo_points\"].empty && !current_geo.empty) {\n    foreach (point : doc[\"geo_points\"].values) {\n        distance = point[\"point\"].arcDistanceInKm(current_geo.lat, current_geo.lon);\n        if (distance < current_to_any_geo_distance) {\n            current_to_any_geo_distance = distance;\n        }\n    }\n}\n```\n\nand elasticsearch complains like this:\n\n``` json\n{\n  \"took\": 44,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 2,\n    \"successful\": 1,\n    \"failed\": 1,\n    \"failures\": [\n      {\n        \"index\": \"female\",\n        \"shard\": 3,\n        \"status\": 500,\n        \"reason\": \"RemoteTransportException[[search04][inet[/192.168.1.91:9300]][search/phase/query]]; nested: QueryPhaseExecutionException[[female][3]: query[ConstantScore(cache(_type:users))],from[0],size[20],sort[<custom:\\\"_script\\\": org.elasticsearch.index.fielddata.fieldcomparator.DoubleScriptDataComparator$InnerSource@1dd5b162>!]: Query Failed [Failed to execute main query]]; nested: CompileException[[Error: No field found for [geo_points] in mapping with types [users]]\\n[Near : {... order = OLDER_ORDER; ....}]\\n             ^\\n[Line: 1, Column: 1]]; nested: ElasticSearchIllegalArgumentException[No field found for [geo_points] in mapping with types [users]]; \"\n      }\n    ]\n  },\n  \"hits\": {\n    \"total\": 0,\n    \"max_score\": null,\n    \"hits\": []\n  }\n}\n```\n\nIs that kind of iteration really supported in elasticsearch? It looks like bug to me, but I couldn't find an existing issue.\n\ncc @dadoonet\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/27046302","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-27046302","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":27046302,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDQ2MzAy","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2013-10-25T00:31:38Z","updated_at":"2013-10-25T00:31:38Z","author_association":"MEMBER","body":"@bobrik - such iteration is going to work only on `source`. A `doc` field can only be obtain by the actual field name - `geo_points.point` in your case. `doc[\"geo_points\"]` simply doesn't exist in the index. Here is an example that demonstrates the idea - https://github.com/imotov/elasticsearch-test-scripts/blob/master/multi_geo_search.sh.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/27068890","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-27068890","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":27068890,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDY4ODkw","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2013-10-25T06:42:56Z","updated_at":"2013-10-25T06:42:56Z","author_association":"CONTRIBUTOR","body":"@imotov looks like I forgot to submit my solution yesterday :)\n\nI looked at source code and found that I can actually iterate `doc[\"geo_points.point\"].values`, but it will be an array of `object`s with `lat` and `lon` properties, not `geo_point`s, therefore I cannot compute distance.\n\nLooks like I can compute distance in pretty hardcore way:\n\n```\nimport org.elasticsearch.common.geo.GeoDistance;\nimport org.elasticsearch.common.unit.DistanceUnit;\n\nforeach (point : doc[\"geo_points.point\"].values) {\n    distance = GeoDistance.ARC.calculate(point.lat, point.lon, current_geo.lat, current_geo.lon, DistanceUnit.KILOMETERS);\n}\n```\n\nI'm not sure if this is friendly. It's not in the docs for sure :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/50776518","html_url":"https://github.com/elastic/elasticsearch/issues/3926#issuecomment-50776518","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3926","id":50776518,"node_id":"MDEyOklzc3VlQ29tbWVudDUwNzc2NTE4","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"created_at":"2014-07-31T15:39:29Z","updated_at":"2014-07-31T15:39:29Z","author_association":"CONTRIBUTOR","body":"Nice, thanks!\n","performed_via_github_app":null}]