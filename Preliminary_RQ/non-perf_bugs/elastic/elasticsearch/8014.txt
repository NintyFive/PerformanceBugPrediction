{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8014","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8014/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8014/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8014/events","html_url":"https://github.com/elastic/elasticsearch/issues/8014","id":45166858,"node_id":"MDU6SXNzdWU0NTE2Njg1OA==","number":8014,"title":"Cluster inconsistency after master node is restarted","user":{"login":"jeanvanwyk","id":7990525,"node_id":"MDQ6VXNlcjc5OTA1MjU=","avatar_url":"https://avatars1.githubusercontent.com/u/7990525?v=4","gravatar_id":"","url":"https://api.github.com/users/jeanvanwyk","html_url":"https://github.com/jeanvanwyk","followers_url":"https://api.github.com/users/jeanvanwyk/followers","following_url":"https://api.github.com/users/jeanvanwyk/following{/other_user}","gists_url":"https://api.github.com/users/jeanvanwyk/gists{/gist_id}","starred_url":"https://api.github.com/users/jeanvanwyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeanvanwyk/subscriptions","organizations_url":"https://api.github.com/users/jeanvanwyk/orgs","repos_url":"https://api.github.com/users/jeanvanwyk/repos","events_url":"https://api.github.com/users/jeanvanwyk/events{/privacy}","received_events_url":"https://api.github.com/users/jeanvanwyk/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2014-10-07T20:59:00Z","updated_at":"2014-10-17T05:10:12Z","closed_at":"2014-10-16T02:59:04Z","author_association":"NONE","active_lock_reason":null,"body":"# Version\n\nWe can reproduce this consistently both in 1.2.x, 1.3.2, 1.3.4 and 1.4.0Beta1 with different documents and different data sets on different machines.\n# Setup\n- OS: Linux SLES\n- Java:\n\n```\njava version \"1.7.0_60\"\nJava(TM) SE Runtime Environment (build 1.7.0_60-b19)\nJava HotSpot(TM) 64-Bit Server VM (build 24.60-b09, mixed mode)\n```\n- Three node cluster with five shards and two replicas\n- Reproduced on three separate machines as well as on a single machine.\n- Plugins installed:\n  - Head or HQ\n  - CouchDB river plugin (Reproduced without river plugin as well)\n- Head plugin reports:\n  - **index_name_real**\n  - **size:** 72.7Mi (216Mi)\n  - **docs:** 131,686 (131,686)\n- Query against alias **index_name** and **index_name_real**\n# Steps to reproduce issue\n1. Start up three new nodes in any order with no indexes.\n2. Set up index, mappings and alias\n3. Set up a CouchDB river to populate data\n4. Wait for data to be populated.\n5. Optionally remove river definitions to ensure it is not a problem with the river (_reproduced behavior with and without rivers_).\n6. Query ElasticSearch - consistently get a number of results eg. 27\n7. Shut down master node\n   - through the head plugin, \n   - startup script or \n   - killing the process\n8. Give a few minutes to ensure cluster stabilize (say 5 minutes)\n9. Query ElasticSearch - consistently get the number of results eg. 27\n10. Start up old master node\n11. Give a few minutes to ensure cluster and shards stabilize (say 5 minutes)\n12. Query ElasticSearch - got the following sequence of results:\n    - **27, 22, 18, 27, 9, 5, 27, 22, 18, 27, 9, 5**\n# Additional information\n- No errors or stack traces in any of the log files.\n- Old master node log statements when starting up:\n\n```\n[2014-10-08 09:10:57,398][INFO ][node                     ] [nodePD02] version[1.3.4], pid[15545], build[a70f3cc/2014-09-30T09:07:17Z]\n[2014-10-08 09:10:57,399][INFO ][node                     ] [nodePD02] initializing ...\n[2014-10-08 09:10:57,423][INFO ][plugins                  ] [nodePD02] loaded [river-couchdb], sites [head]\n[2014-10-08 09:11:01,583][INFO ][node                     ] [nodePD02] initialized\n[2014-10-08 09:11:01,583][INFO ][node                     ] [nodePD02] starting ...\n[2014-10-08 09:11:01,747][INFO ][transport                ] [nodePD02] bound_address {inet[/0.0.0.0:9300]}, publish_address {inet[/..........:9300]}\n[2014-10-08 09:11:01,752][INFO ][discovery                ] [nodePD02] elasticsearch_PROD/ridS6JGyQOuNql_m5mMoMQ\n[2014-10-08 09:11:11,919][INFO ][cluster.service          ] [nodePD02] detected_master [nodePD03][2XpaT8CfTO2m-FhoyOaIgg][es03][inet[/..........:9300]]{river=_none_}, added {[nodePD03][2XpaT8CfTO2m-FhoyOaIgg][es03][inet[/..........:9300]]{river=_none_},[nodePD01][OBQXEeP6R32NCus3guXUdQ][es01][inet[/..........:9300]],}, reason: zen-disco-receive(from master [[nodePD03][2XpaT8CfTO2m-FhoyOaIgg][es03][inet[/..........:9300]]{river=_none_}])\n[2014-10-08 09:11:12,146][INFO ][http                     ] [nodePD02] bound_address {inet[/0.0.0.0:9200]}, publish_address {inet[/..........:9200]}\n[2014-10-08 09:11:12,147][INFO ][node                     ] [nodePD02] started\n```\n## Query\n\n```\n{\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"multi_match\": {\n                \"query\": \"10011\",\n                \"fields\": [\n                  \"payload.id\",\n                  \"payload.code\"\n                ]\n              }\n            }\n          ]\n        }\n      },\n      \"filter\": {\n        \"and\": [\n          {\n            \"term\": {\n              \"fortress\": \"ct\"\n            }\n          },\n          {\n            \"term\": {\n              \"docType\": \"plannedtrain\"\n            }\n          }\n        ]\n      }\n    }\n  },\n  \"sort\": [\n    {\n      \"eventDate\": {\n        \"order\": \"asc\"\n      }\n    }\n  ],\n  \"size\": 100,\n  \"from\": 0\n}\n```\n","closed_by":{"login":"jeanvanwyk","id":7990525,"node_id":"MDQ6VXNlcjc5OTA1MjU=","avatar_url":"https://avatars1.githubusercontent.com/u/7990525?v=4","gravatar_id":"","url":"https://api.github.com/users/jeanvanwyk","html_url":"https://github.com/jeanvanwyk","followers_url":"https://api.github.com/users/jeanvanwyk/followers","following_url":"https://api.github.com/users/jeanvanwyk/following{/other_user}","gists_url":"https://api.github.com/users/jeanvanwyk/gists{/gist_id}","starred_url":"https://api.github.com/users/jeanvanwyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeanvanwyk/subscriptions","organizations_url":"https://api.github.com/users/jeanvanwyk/orgs","repos_url":"https://api.github.com/users/jeanvanwyk/repos","events_url":"https://api.github.com/users/jeanvanwyk/events{/privacy}","received_events_url":"https://api.github.com/users/jeanvanwyk/received_events","type":"User","site_admin":false},"performed_via_github_app":null}