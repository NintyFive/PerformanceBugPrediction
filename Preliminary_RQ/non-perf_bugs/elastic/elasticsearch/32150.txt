{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32150","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32150/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32150/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32150/events","html_url":"https://github.com/elastic/elasticsearch/issues/32150","id":342158302,"node_id":"MDU6SXNzdWUzNDIxNTgzMDI=","number":32150,"title":"es transport layer cost too much time exception","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"labels":[{"id":146829143,"node_id":"MDU6TGFiZWwxNDY4MjkxNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Transport%20API","name":":Core/Infra/Transport API","color":"0e8a16","default":false,"description":"Transport client API"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-07-18T03:01:01Z","updated_at":"2018-07-18T10:12:31Z","closed_at":"2018-07-18T10:12:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n2.3.3\r\n\r\n**Plugins installed**: []\r\ndelete-by-query\r\nlicense\r\nmarvel-agent\r\n\r\n**JVM version** (`java -version`):\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.77-b03, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n2.6.32-573.18.1.el6.toav2.x86_64 #1 SMP Sun Jul 17 12:44:29 CST 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nclient send search request to tribenode, but the transport layer cost too much time.This case  happens accidentally.But everyday it appears.\r\n\r\n\r\n\t public class ReleaseChannelFutureListener implements ChannelFutureListener {\r\n\t\tprivate final ESLogger tracerLog = Loggers.getLogger(\"requestIdLog\");\r\n\r\n\t    private final Releasable releasable;\r\n\t    \r\n\t    private TransportResponse response;\r\n\t    \r\n\t    private long requestId;\r\n\r\n\t    public ReleaseChannelFutureListener(Releasable releasable) {\r\n\t        this.releasable = releasable;\r\n\t    }\r\n\t    \r\n\t    public ReleaseChannelFutureListener(Releasable releasable, TransportResponse response, long requestId) {\r\n\t        this.releasable = releasable;\r\n\t        this.response = response;\r\n\t        this.requestId = requestId;\r\n\t    }\r\n\r\n\t    @Override\r\n\t    public void operationComplete(ChannelFuture future) throws Exception {\r\n\t        releasable.close();\r\n\t        \r\n\t        if (response instanceof SearchResponse\r\n\t        \t\t|| response instanceof MultiSearchResponse) {\r\n\t        \ttracerLog.warn(\"[{}] sentResponse operationComplete\", requestId);\r\n\t        }\r\n\t    }\r\n\t}\r\n\r\n\tNettyTransportChannel.sendResponse:\r\n\tReleaseChannelFutureListener listener = new ReleaseChannelFutureListener(bytes, response, requestId);\r\n\r\n**Provide logs (if relevant)**:\r\nsearch dsl:\r\n{\"size\":1,\"query\":{\"bool\":{\"filter\":[{\"term\":{\"dltag\":\"_com_request_in\"}},{\"term\":{\"uri\":\"/gulfstream/openapi-inner/v1/info/passenger\"}}],\"should\":[{\"range\":{\"logTime\":{\"gte\":1531783800000,\"lte\":1531784399000,\"format\":\"epoch_millis\"}}}]}},\"_source\":{\"includes\":[\"traceid\",\"spanid\"],\"excludes\":[]}}\r\n\r\nresponseLen=377\r\ntookInMillis=16944\r\n\r\nclient log\r\n[TRACE][2018-07-18 09:13:14,359][78150089][rest-es-thread-8][TransportService.java:650] [Exterminator] [2090581][indices:data/read/search] sent to [{...}}{max_local_storage_nodes=1, client=true, data=false, master=false}] (timeout: [null])\r\n[TRACE][2018-07-18 09:13:44,929][78180659][elasticsearch[Exterminator][transport_client_worker][T#1]{New I/O worker #391}][TransportService.java:642] [Exterminator] [2090581][indices:data/read/search] received response from [{...}{max_local_storage_nodes=1, client=true, data=false, master=false}]\r\n\r\n\r\ntribenode log\r\n[2018-07-18 09:13:14,359][TRACE ][transport.tracer         ] [xxx] [2090581][indices:data/read/search] received request\r\n[2018-07-18 09:13:31,326][TRACE ][transport.tracer         ] [xxx] [2090581][indices:data/read/search] sent response\r\n[2018-07-18 09:13:44,929][WARN ][requestIdLog             ] [2090581] sentResponse operationComplete\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}