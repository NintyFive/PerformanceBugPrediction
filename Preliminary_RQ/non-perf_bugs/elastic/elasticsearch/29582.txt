{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29582","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29582/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29582/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29582/events","html_url":"https://github.com/elastic/elasticsearch/issues/29582","id":315491339,"node_id":"MDU6SXNzdWUzMTU0OTEzMzk=","number":29582,"title":"ExitCode does not bubble out bat files when not called from DOS","user":{"login":"Mpdreamz","id":245275,"node_id":"MDQ6VXNlcjI0NTI3NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/245275?v=4","gravatar_id":"","url":"https://api.github.com/users/Mpdreamz","html_url":"https://github.com/Mpdreamz","followers_url":"https://api.github.com/users/Mpdreamz/followers","following_url":"https://api.github.com/users/Mpdreamz/following{/other_user}","gists_url":"https://api.github.com/users/Mpdreamz/gists{/gist_id}","starred_url":"https://api.github.com/users/Mpdreamz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Mpdreamz/subscriptions","organizations_url":"https://api.github.com/users/Mpdreamz/orgs","repos_url":"https://api.github.com/users/Mpdreamz/repos","events_url":"https://api.github.com/users/Mpdreamz/events{/privacy}","received_events_url":"https://api.github.com/users/Mpdreamz/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-04-18T13:56:53Z","updated_at":"2020-11-11T21:56:52Z","closed_at":"2019-01-25T15:44:33Z","author_association":"MEMBER","active_lock_reason":null,"body":"`%ERRORLEVEL%` is reported just fine in DOS. Note the `CALL` is mandatory when calling any batch file and using `||`.\r\n\r\n```batch\r\n$ (CALL bin\\elasticsearch-plugin.bat install --batch asfasf) || echo %ERRORLEVEL%\r\nA tool for managing installed elasticsearch plugins\r\n\r\nCommands\r\n--------\r\nlist - Lists installed elasticsearch plugins\r\ninstall - Install a plugin\r\nremove - removes a plugin from Elasticsearch\r\n\r\nNon-option arguments:\r\ncommand\r\n\r\nOption         Description\r\n------         -----------\r\n-h, --help     show help\r\n-s, --silent   show minimal output\r\n-v, --verbose  show verbose output\r\nERROR: Unknown plugin asfasf\r\n64\r\n```\r\n\r\n\r\nBut on powershell `$LASTEXITCODE` is `0`:\r\n\r\n```powershell\r\nPS> bin\\elasticsearch-plugin.bat install --batch asfasf; echo $LASTEXITCODE\r\nA tool for managing installed elasticsearch plugins\r\n\r\n<snip>\r\nERROR: Unknown plugin asfasf\r\n0\r\n```\r\n\r\nHowever if we modify the `.bat` files we distribute to explicitly exit \r\n\r\n```batch\r\nendlocal\r\nendlocal\r\nexit /B %ERRORLEVEL%\r\n```\r\n\r\n*NOTE:* `ENDLOCAL` does not alter `%ERRORLEVEL%`.\r\n\r\n`$LASTEXITCODE` is set correctly in powershell. \r\n\r\n```powershell\r\nPS > bin\\elasticsearch-plugin.bat install --batch asfasf; echo $LASTEXITCODE\r\nA tool for managing installed elasticsearch plugins\r\n\r\n<snip>\r\nERROR: Unknown plugin asfasf\r\n64\r\n```\r\n\r\nA similar result is observed when automating the bat files from `C#`\r\n\r\n```csharp\r\nvar bat = @\"bin\\elasticsearch-plugin.bat\";\r\nvar args = \"install --batch asfasf\";\r\nvar startInfo = new ProcessStartInfo(bat, args)\r\n{\r\n\tUseShellExecute = false,\r\n\tCreateNoWindow = true\r\n};\r\n\t\r\nvar p = Process.Start(startInfo);\r\np.WaitForExit();\r\n\t\r\nvar exitCode = p.ExitCode;\r\n```\r\n\r\n`exitCode` will be `0` right now and `64` when we use the explict `exit /B %ERRORLEVEL%` fix.\r\n\r\n\r\n\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"Mpdreamz","id":245275,"node_id":"MDQ6VXNlcjI0NTI3NQ==","avatar_url":"https://avatars3.githubusercontent.com/u/245275?v=4","gravatar_id":"","url":"https://api.github.com/users/Mpdreamz","html_url":"https://github.com/Mpdreamz","followers_url":"https://api.github.com/users/Mpdreamz/followers","following_url":"https://api.github.com/users/Mpdreamz/following{/other_user}","gists_url":"https://api.github.com/users/Mpdreamz/gists{/gist_id}","starred_url":"https://api.github.com/users/Mpdreamz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Mpdreamz/subscriptions","organizations_url":"https://api.github.com/users/Mpdreamz/orgs","repos_url":"https://api.github.com/users/Mpdreamz/repos","events_url":"https://api.github.com/users/Mpdreamz/events{/privacy}","received_events_url":"https://api.github.com/users/Mpdreamz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}