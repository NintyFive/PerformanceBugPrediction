[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/248870803","html_url":"https://github.com/elastic/elasticsearch/issues/20619#issuecomment-248870803","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619","id":248870803,"node_id":"MDEyOklzc3VlQ29tbWVudDI0ODg3MDgwMw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-09-22T11:01:59Z","updated_at":"2016-09-22T11:01:59Z","author_association":"MEMBER","body":"@fesnault I'm unsure what is going wrong here. Is it possible to provide a more isolated reproduction of the issue? (with the mappings, index requests for both parent and childs and the searches). It is important to know if for example the parent ids are set correctly on the index requests.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/249216532","html_url":"https://github.com/elastic/elasticsearch/issues/20619#issuecomment-249216532","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619","id":249216532,"node_id":"MDEyOklzc3VlQ29tbWVudDI0OTIxNjUzMg==","user":{"login":"fesnault","id":261169,"node_id":"MDQ6VXNlcjI2MTE2OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/261169?v=4","gravatar_id":"","url":"https://api.github.com/users/fesnault","html_url":"https://github.com/fesnault","followers_url":"https://api.github.com/users/fesnault/followers","following_url":"https://api.github.com/users/fesnault/following{/other_user}","gists_url":"https://api.github.com/users/fesnault/gists{/gist_id}","starred_url":"https://api.github.com/users/fesnault/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fesnault/subscriptions","organizations_url":"https://api.github.com/users/fesnault/orgs","repos_url":"https://api.github.com/users/fesnault/repos","events_url":"https://api.github.com/users/fesnault/events{/privacy}","received_events_url":"https://api.github.com/users/fesnault/received_events","type":"User","site_admin":false},"created_at":"2016-09-23T15:01:44Z","updated_at":"2016-09-23T15:01:44Z","author_association":"NONE","body":"Hi @martijnvg and thanks for replying.\n\nIt's actually difficult to create a reproductible environment.\nI tried creating the same situation, with similar mappings and documents, but the query works correctly in the testing index.\nI also tried to create another index and inject the same mappings as in the real one. I then injected three document, one parent and two children, taken directly from production.\nBut here too, my query works.\n\nAs an example, here is a child document from production (filtered out) :\n\n```\n{\n  \"_index\": \"filtered\",\n  \"_type\": \"doc_mapping_history\",\n  \"_id\": \"194855\",\n  \"_score\": 6.254041,\n  \"_routing\": \"PID-803\",\n  \"_parent\": \"PID-803\",\n  \"_source\": {\n    \"issuetype\": \"Epic\",\n    \"issue\": \"PID-803\",\n    \"created\": \"2016-06-22T07:53:45.709Z\",\n    \"duration\": 39709,\n    \"field\": \"status\",\n    \"group_id\": 120998,\n    \"change_id\": 194855,\n    \"issue_created\": \"2016-06-22T07:53:06.000Z\",\n    \"old_value\": \"[10007] Draft\",\n    \"user\": \"fesnault\",\n    \"new_value\": \"[10503] Assessing Scope\"\n  }\n}\n```\n\nAnd here is the parent document :\n\n```\n{\n  \"_index\": \"filtered\",\n  \"_type\": \"doc_mapping\",\n  \"_id\": \"PID-803\",\n  \"_version\": 2,\n  \"_routing\": \"fesnault\",\n  \"_parent\": \"fesnault\",\n  \"found\": true,\n  \"_source\": {\n    \"summary\": \"Filtered\",\n    \"issuetype\": \"Epic\",\n    \"issue_id\": 22245,\n    \"project_key\": \"PID\",\n    \"created\": \"2016-06-22T07:53:06.000Z\",\n    \"description\": \"Filtered\",\n    \"key\": \"PID-803\",\n    \"status\": \"Assessing Scope\"\n    }\n}\n```\n\nNote that the parent document also has a parent himself.\n\nAbout the way they are indexed. This is done by a software. I added some logs which showed me that the children documents were indexed with a parent, so the parent parameter is not forgotten. Here is the line of code doing this :\n\n```\nindexResponse = client.prepareIndex(indexName, getTypeName(mappingTitle), (changeValues.get(\"change_id\")).toString()).setSource(changeValues).setParent(parentId).execute().actionGet();\n```\n\nIs there anyway I could do to get more information? Some special logging or query ? Btw no error shows up in the logs, just no result.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/249220326","html_url":"https://github.com/elastic/elasticsearch/issues/20619#issuecomment-249220326","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619","id":249220326,"node_id":"MDEyOklzc3VlQ29tbWVudDI0OTIyMDMyNg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-09-23T15:16:01Z","updated_at":"2016-09-23T15:16:01Z","author_association":"CONTRIBUTOR","body":"You have grandparents?  In which case, i think you indexed the grandchildren with `?parent={parentid}` but without `&routing={grandparentid}`.  The parent goes to the same shard as the grandparent, so the grandchildren need to know what shard that is, and can't deduce it just from the parent's ID\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/249226455","html_url":"https://github.com/elastic/elasticsearch/issues/20619#issuecomment-249226455","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619","id":249226455,"node_id":"MDEyOklzc3VlQ29tbWVudDI0OTIyNjQ1NQ==","user":{"login":"fesnault","id":261169,"node_id":"MDQ6VXNlcjI2MTE2OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/261169?v=4","gravatar_id":"","url":"https://api.github.com/users/fesnault","html_url":"https://github.com/fesnault","followers_url":"https://api.github.com/users/fesnault/followers","following_url":"https://api.github.com/users/fesnault/following{/other_user}","gists_url":"https://api.github.com/users/fesnault/gists{/gist_id}","starred_url":"https://api.github.com/users/fesnault/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fesnault/subscriptions","organizations_url":"https://api.github.com/users/fesnault/orgs","repos_url":"https://api.github.com/users/fesnault/repos","events_url":"https://api.github.com/users/fesnault/events{/privacy}","received_events_url":"https://api.github.com/users/fesnault/received_events","type":"User","site_admin":false},"created_at":"2016-09-23T15:38:32Z","updated_at":"2016-09-23T15:38:48Z","author_association":"NONE","body":"Hi @clintongormley ,\nGreat, I modified my indexing code to add the grandparent id routing parameter to the grandchildren indexing, and it works perfectly fine, my query with has_parent restriction returns the expected results.\n\nThanks a lot !\n\nI learned something about indexing documents with parents and grandparents.\n","performed_via_github_app":null}]