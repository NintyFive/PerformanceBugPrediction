{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22788","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22788/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22788/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22788/events","html_url":"https://github.com/elastic/elasticsearch/issues/22788","id":203131825,"node_id":"MDU6SXNzdWUyMDMxMzE4MjU=","number":22788,"title":"java invoked oom-killer","user":{"login":"humbapa","id":3932507,"node_id":"MDQ6VXNlcjM5MzI1MDc=","avatar_url":"https://avatars3.githubusercontent.com/u/3932507?v=4","gravatar_id":"","url":"https://api.github.com/users/humbapa","html_url":"https://github.com/humbapa","followers_url":"https://api.github.com/users/humbapa/followers","following_url":"https://api.github.com/users/humbapa/following{/other_user}","gists_url":"https://api.github.com/users/humbapa/gists{/gist_id}","starred_url":"https://api.github.com/users/humbapa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/humbapa/subscriptions","organizations_url":"https://api.github.com/users/humbapa/orgs","repos_url":"https://api.github.com/users/humbapa/repos","events_url":"https://api.github.com/users/humbapa/events{/privacy}","received_events_url":"https://api.github.com/users/humbapa/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2017-01-25T15:21:13Z","updated_at":"2020-05-13T10:52:45Z","closed_at":"2017-01-30T06:55:55Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.1.2 (and 2.4.4)\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: Oracle JDK 1.8.0_121 (and OpenJDK 1.8.0_111)\r\n\r\n**OS version**: Ubuntu 16.04\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nOn 2.4.1 the cluster was running without a problem. After upgrading to 2.4.4 I started to see \"out of memory\" errors. this happens randomly on all 8 data-nodes, which all have the same configuration and storage size.\r\nAs I was already prepared to upgrade to 5.x, I upgraded all nodes to 5.1.2. Unfortunately the nodes keep dying after I started to index some data again.\r\nI then switched from OpenJDK to Oracle and also tried to reactivate the netty recycler (-Dio.netty.recycler.maxCapacityPerThread) but still get those \"out of memory\" errors.\r\n\r\n**Steps to reproduce**:\r\n 1. After the cluster has a green status, just wait for some hours and a random node will invoke the oom-killer\r\n\r\n**Provide logs (if relevant)**:\r\n\r\nI only get the following Kernel Error:\r\n\r\n```\r\nJan 25 15:25:20 es14 kernel: java invoked oom-killer: gfp_mask=0x26142c0, order=2, oom_score_adj=0\r\nJan 25 15:25:20 es14 kernel: java cpuset=/ mems_allowed=0\r\nJan 25 15:25:20 es14 kernel: CPU: 5 PID: 22114 Comm: java Not tainted 4.4.0-59-generic #80-Ubuntu\r\nJan 25 15:25:20 es14 kernel: Hardware name: Supermicro SYS-5039MS-H8TRF/X11SSD-F, BIOS 1.0 01/11/2016\r\nJan 25 15:25:20 es14 kernel:  0000000000000286 00000000ea5159af ffff88011bdfb8a8 ffffffff813f7583\r\nJan 25 15:25:20 es14 kernel:  ffff88011bdfba80 ffff88011020ad00 ffff88011bdfb918 ffffffff8120ad5e\r\nJan 25 15:25:20 es14 kernel:  ffff88107795a870 ffff88107795a860 ffffea0016f32480 0000000100000001\r\nJan 25 15:25:20 es14 kernel: Call Trace:\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff813f7583>] dump_stack+0x63/0x90\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8120ad5e>] dump_header+0x5a/0x1c5\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81192722>] oom_kill_process+0x202/0x3c0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81192b49>] out_of_memory+0x219/0x460\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81198abd>] __alloc_pages_slowpath.constprop.88+0x8fd/0xa70\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81198eb6>] __alloc_pages_nodemask+0x286/0x2a0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81198f6b>] alloc_kmem_pages_node+0x4b/0xc0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff811e973c>] kmalloc_large_node+0x2c/0x60\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff811f0df2>] __kmalloc_node_track_caller+0x262/0x310\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81718637>] ? __alloc_skb+0x87/0x1f0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81717101>] __kmalloc_reserve.isra.33+0x31/0x90\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8171860b>] ? __alloc_skb+0x5b/0x1f0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff81718637>] __alloc_skb+0x87/0x1f0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8177b916>] sk_stream_alloc_skb+0x56/0x1b0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8177c874>] tcp_sendmsg+0x824/0xb60\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff817a80f5>] inet_sendmsg+0x65/0xa0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8170fae8>] sock_sendmsg+0x38/0x50\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8170fb85>] sock_write_iter+0x85/0xf0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8120e11b>] new_sync_write+0x9b/0xe0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8120e186>] __vfs_write+0x26/0x40\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8120eb09>] vfs_write+0xa9/0x1a0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff8120f7c5>] SyS_write+0x55/0xc0\r\nJan 25 15:25:20 es14 kernel:  [<ffffffff818384f2>] entry_SYSCALL_64_fastpath+0x16/0x71\r\nJan 25 15:25:20 es14 kernel: Mem-Info:\r\nJan 25 15:25:20 es14 kernel: active_anon:431751 inactive_anon:4743 isolated_anon:0\r\nJan 25 15:25:20 es14 kernel: Node 0 DMA free:15876kB min:16kB low:20kB high:24kB active_anon:0kB inactive_anon:0kB active_file:0kB inactive_file:0kB unevictable:0kB isolated(anon):0kB isolated(file):0kB present:15960kB managed:15876kB mlocked:0kB dirty:0kB writeback:0kB mapped:0kB shmem:0kB slab_reclaimable:0kB slab_unreclaimable:0kB kernel_stack:0kB pagetables:0kB unstable:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_unreclaimable? yes\r\nJan 25 15:25:20 es14 kernel: lowmem_reserve[]: 0 1869 64201 64201 64201\r\nJan 25 15:25:20 es14 kernel: Node 0 DMA32 free:251824kB min:1964kB low:2452kB high:2944kB active_anon:5260kB inactive_anon:80kB active_file:0kB inactive_file:0kB unevictable:1683784kB isolated(anon):0kB isolated(file):0kB present:2033712kB managed:1953092kB mlocked:1683784kB dirty:0kB writeback:0kB mapped:824kB shmem:580kB slab_reclaimable:5536kB slab_unreclaimable:1208kB kernel_stack:128kB pagetables:4076kB unstable:0kB bounce:0kB free_pcp:0kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_unreclaimable? yes\r\nJan 25 15:25:20 es14 kernel: lowmem_reserve[]: 0 0 62332 62332 62332\r\nJan 25 15:25:20 es14 kernel: Node 0 Normal free:107828kB min:65600kB low:82000kB high:98400kB active_anon:1721744kB inactive_anon:18892kB active_file:15876236kB inactive_file:15954636kB unevictable:28564300kB isolated(anon):0kB isolated(file):0kB present:64876544kB managed:63828168kB mlocked:28564300kB dirty:49116kB writeback:0kB mapped:3011992kB shmem:33152kB slab_reclaimable:1168120kB slab_unreclaimable:49304kB kernel_stack:6960kB pagetables:197244kB unstable:0kB bounce:0kB free_pcp:792kB local_pcp:0kB free_cma:0kB writeback_tmp:0kB pages_scanned:0 all_unreclaimable? no\r\nJan 25 15:25:20 es14 kernel: lowmem_reserve[]: 0 0 0 0 0\r\nJan 25 15:25:20 es14 kernel: Node 0 DMA: 1*4kB (U) 0*8kB 0*16kB 0*32kB 2*64kB (U) 1*128kB (U) 1*256kB (U) 0*512kB 1*1024kB (U) 1*2048kB (M) 3*4096kB (M) = 15876kB\r\nJan 25 15:25:20 es14 kernel: Node 0 DMA32: 140*4kB (UMEH) 92*8kB (UMEH) 64*16kB (UMEH) 53*32kB (UME) 22*64kB (UMEH) 19*128kB (UMH) 23*256kB (UME) 11*512kB (UM) 9*1024kB (UM) 3*2048kB (UME) 53*4096kB (UM) = 251824kB\r\nJan 25 15:25:20 es14 kernel: Node 0 Normal: 25762*4kB (UME) 586*8kB (UME) 0*16kB 0*32kB 0*64kB 0*128kB 0*256kB 0*512kB 0*1024kB 0*2048kB 0*4096kB = 107736kB\r\nJan 25 15:25:20 es14 kernel: Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=1048576kB\r\nJan 25 15:25:20 es14 kernel: Node 0 hugepages_total=0 hugepages_free=0 hugepages_surp=0 hugepages_size=2048kB\r\nJan 25 15:25:20 es14 kernel: 7971730 total pagecache pages\r\nJan 25 15:25:20 es14 kernel: 0 pages in swap cache\r\nJan 25 15:25:20 es14 kernel: Swap cache stats: add 0, delete 0, find 0/0\r\nJan 25 15:25:20 es14 kernel: Free swap  = 0kB\r\nJan 25 15:25:20 es14 kernel: Total swap = 0kB\r\nJan 25 15:25:20 es14 kernel: 16731554 pages RAM\r\nJan 25 15:25:20 es14 kernel: 0 pages HighMem/MovableOnly\r\nJan 25 15:25:20 es14 kernel: 282270 pages reserved\r\nJan 25 15:25:20 es14 kernel: 0 pages cma reserved\r\nJan 25 15:25:20 es14 kernel: 0 pages hwpoisoned\r\nJan 25 15:25:20 es14 kernel: [ pid ]   uid  tgid total_vm      rss nr_ptes nr_pmds swapents oom_score_adj name\r\nJan 25 15:25:20 es14 kernel: [  481]     0   481    22241    12371      45       3        0             0 systemd-journal\r\nJan 25 15:25:20 es14 kernel: [  534]     0   534     9849     1051      20       4        0         -1000 systemd-udevd\r\nJan 25 15:25:20 es14 kernel: [ 1381]   108  1381    27684     1422      56       3        0          -900 dbus-daemon\r\nJan 25 15:25:20 es14 kernel: [ 1423]     0  1423     4929      500      15       3        0             0 atd\r\nJan 25 15:25:20 es14 kernel: [ 1438]     0  1438     5098      564      13       3        0             0 systemd-logind\r\nJan 25 15:25:20 es14 kernel: [ 1449]     0  1449     1100      293       9       3        0             0 acpid\r\nJan 25 15:25:20 es14 kernel: [ 1458]     0  1458     5350      712      15       3        0             0 cron\r\nJan 25 15:25:20 es14 kernel: [ 1463]   104  1463    80522     1528      57       4        0             0 rsyslogd\r\nJan 25 15:25:20 es14 kernel: [ 1554]     0  1554   176004     2598      68       3        0             0 nscd\r\nJan 25 15:25:20 es14 kernel: [ 2118]     0  2118    14858     1212      32       3        0         -1000 sshd\r\nJan 25 15:25:20 es14 kernel: [ 2137]     0  2137     1606      170       9       3        0             0 agetty\r\nJan 25 15:25:20 es14 kernel: [ 2150] 10023  2150     3469      924      15       3        0          -500 nrpe\r\nJan 25 15:25:20 es14 kernel: [ 2157]   110  2157    26033      884      23       3        0             0 ntpd\r\nJan 25 15:25:20 es14 kernel: [ 2265]     0  2265    15413     1080      22       3        0             0 master\r\nJan 25 15:25:20 es14 kernel: [ 2267]   111  2267    15440     1090      21       3        0             0 qmgr\r\nJan 25 15:25:20 es14 kernel: [22041]   112 22041 166246848  8386734   49054     637        0             0 java\r\nJan 25 15:25:20 es14 kernel: [24878]     0 24878  2526142   341234     820       9        0             0 java\r\nJan 25 15:25:20 es14 kernel: [28283]   111 28283    15400      655      21       3        0             0 pickup\r\nJan 25 15:25:20 es14 kernel: Out of memory: Kill process 22041 (java) score 512 or sacrifice child\r\nJan 25 15:25:20 es14 kernel: Killed process 22041 (java) total-vm:664987392kB, anon-rss:30648528kB, file-rss:2898356kB\r\n```\r\n\r\nThere is also Logstash running on this node, but the error also happens if it is stopped.","closed_by":{"login":"humbapa","id":3932507,"node_id":"MDQ6VXNlcjM5MzI1MDc=","avatar_url":"https://avatars3.githubusercontent.com/u/3932507?v=4","gravatar_id":"","url":"https://api.github.com/users/humbapa","html_url":"https://github.com/humbapa","followers_url":"https://api.github.com/users/humbapa/followers","following_url":"https://api.github.com/users/humbapa/following{/other_user}","gists_url":"https://api.github.com/users/humbapa/gists{/gist_id}","starred_url":"https://api.github.com/users/humbapa/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/humbapa/subscriptions","organizations_url":"https://api.github.com/users/humbapa/orgs","repos_url":"https://api.github.com/users/humbapa/repos","events_url":"https://api.github.com/users/humbapa/events{/privacy}","received_events_url":"https://api.github.com/users/humbapa/received_events","type":"User","site_admin":false},"performed_via_github_app":null}