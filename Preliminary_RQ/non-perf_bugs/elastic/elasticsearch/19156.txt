{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19156","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19156/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19156/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19156/events","html_url":"https://github.com/elastic/elasticsearch/issues/19156","id":162948144,"node_id":"MDU6SXNzdWUxNjI5NDgxNDQ=","number":19156,"title":"Highlighting problem when mixing a match query and filtering by geo_distance in query context","user":{"login":"moliware","id":620035,"node_id":"MDQ6VXNlcjYyMDAzNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/620035?v=4","gravatar_id":"","url":"https://api.github.com/users/moliware","html_url":"https://github.com/moliware","followers_url":"https://api.github.com/users/moliware/followers","following_url":"https://api.github.com/users/moliware/following{/other_user}","gists_url":"https://api.github.com/users/moliware/gists{/gist_id}","starred_url":"https://api.github.com/users/moliware/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/moliware/subscriptions","organizations_url":"https://api.github.com/users/moliware/orgs","repos_url":"https://api.github.com/users/moliware/repos","events_url":"https://api.github.com/users/moliware/events{/privacy}","received_events_url":"https://api.github.com/users/moliware/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-06-29T14:59:45Z","updated_at":"2016-06-29T15:07:20Z","closed_at":"2016-06-29T15:01:31Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.2\n\n**JVM version**: 1.8.0_92\n\n**OS version**: Ubuntu 12.04.5 LTS\n\n**Description of the problem including expected versus actual behavior**:\n\nSay that we have a mapping with two properties:\n- description: analyzed string\n- location: geo_point\n\nIf I combine a match query on description and a geo_distance filter on location using a boolean query (that's why I say \"filtering in query context\"), Elasticsearch raises an error while highlighting. If I move the geo_distance filter to \"post_filter context\" it works fine.\n\nI checked a bit the code and it seems to me that when creating the highlighting context [in HighlightPhase](https://github.com/elastic/elasticsearch/blob/v2.3.2/core/src/main/java/org/elasticsearch/search/highlight/HighlightPhase.java#L120),  it uses description as field and geo_point as the type of the fieldMapper. \n\nIf you confirm that this is a bug I can look further and help with it.\n\n**Steps to reproduce**:\n\n```\nPUT /test\n{\n    \"mappings\": {\n        \"test\":{\n            \"dynamic\": \"false\",\n            \"properties\": {\n                \"description\" :{\n                    \"type\": \"string\"\n                },\n                \"location\": {\n                  \"type\": \"geo_point\"\n                }\n            }\n        }\n    }\n}\n\nPUT /test/test/1\n{\n    \"description\": \"Hello world\",\n    \"location\": {\"lat\": 1.0, \"lon\": 1.0}\n}\n\nPOST /test/test/_search\n{\n  \"from\": 0,\n  \"size\": 10,\n  \"query\": {\n    \"bool\": {\n      \"must\": {\n        \"match\": {\n          \"description\": \"hello\"\n        }\n      },\n      \"filter\": {\n        \"geo_distance\": {\n          \"location\": [\n            1.0,\n            1.0\n          ],\n          \"distance\": \"10km\"\n        }\n      }\n    }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"description\": {\n      }\n    }\n  }\n}\n```\n\n**Provide logs (if relevant)**:\n\nThis is the exception:\n\n```\n[2016-06-29 16:08:18,057][DEBUG][action.search            ] [Bella Donna] [44] Failed to execute fetch phase\nRemoteTransportException[[Bella Donna][127.0.0.1:9300][indices:data/read/search[phase/fetch/id]]]; nested: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [description]]]; nested: NumberFormatException[Invalid shift value (111) in prefixCoded bytes (is encoded value really a geo point?)];\nCaused by: FetchPhaseExecutionException[Fetch Failed [Failed to highlight field [description]]]; nested: NumberFormatException[Invalid shift value (111) in prefixCoded bytes (is encoded value really a geo point?)];\n    at org.elasticsearch.search.highlight.PlainHighlighter.highlight(PlainHighlighter.java:123)\n    at org.elasticsearch.search.highlight.HighlightPhase.hitExecute(HighlightPhase.java:126)\n    at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:188)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:592)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$FetchByIdTransportHandler.messageReceived(SearchServiceTransportAction.java:408)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$FetchByIdTransportHandler.messageReceived(SearchServiceTransportAction.java:405)\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:75)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.NumberFormatException: Invalid shift value (111) in prefixCoded bytes (is encoded value really a geo point?)\n    at org.apache.lucene.spatial.util.GeoEncodingUtils.getPrefixCodedShift(GeoEncodingUtils.java:134)\n    at org.apache.lucene.spatial.geopoint.search.GeoPointPrefixTermsEnum.accept(GeoPointPrefixTermsEnum.java:219)\n    at org.apache.lucene.index.FilteredTermsEnum.next(FilteredTermsEnum.java:232)\n    at org.apache.lucene.search.TermCollectingRewrite.collectTerms(TermCollectingRewrite.java:67)\n    at org.apache.lucene.search.ScoringRewrite.rewrite(ScoringRewrite.java:108)\n    at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:220)\n    at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:227)\n    at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.extract(WeightedSpanTermExtractor.java:113)\n    at org.apache.lucene.search.highlight.WeightedSpanTermExtractor.getWeightedSpanTerms(WeightedSpanTermExtractor.java:505)\n    at org.apache.lucene.search.highlight.QueryScorer.initExtractor(QueryScorer.java:218)\n    at org.apache.lucene.search.highlight.QueryScorer.init(QueryScorer.java:186)\n    at org.apache.lucene.search.highlight.Highlighter.getBestTextFragments(Highlighter.java:195)\n    at org.elasticsearch.search.highlight.PlainHighlighter.highlight(PlainHighlighter.java:108)\n    ... 12 more\n```\n\nThanks!\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}