{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43974","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43974/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43974/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43974/events","html_url":"https://github.com/elastic/elasticsearch/issues/43974","id":464229945,"node_id":"MDU6SXNzdWU0NjQyMjk5NDU=","number":43974,"title":"Scrolling a remote index should not require cluster:monitor/state privilege ","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-07-04T12:03:55Z","updated_at":"2019-07-23T11:55:57Z","closed_at":"2019-07-23T11:55:57Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"At the moment it seems that starting a scroll on a remote index requires just the index permissions you'd expect, but _continuing_ that scroll involving a remote index additionally requires that you have permission to read the _entire_ cluster state.\r\n\r\nTo demonstrate:\r\n\r\n1. Install two local single node clusters on your machine with security enabled: cluster 1 and cluster 2\r\n2. Configure cluster 1 as a remote of cluster 2\r\n3. Import some data into both clusters\r\n4. Create a role `cluster_one_data` in cluster 1 that gives `all` access to the index containing the imported data\r\n5. Create a role `cluster_one_data` in cluster 1 that gives `all` access to the _remote_ index containing the imported data _in cluster 1_\r\n6. Create a role `cluster_two_data` in cluster 2 that gives `all` access to the index containing the imported data in cluster 2\r\n7. Create a user in cluster 2 with the following roles:\r\n  a. `kibana_user`\r\n  b. `cluster_one_data`\r\n  c. `cluster_two_data`\r\n8. From cluster 2, try scrolling the local and remote data in both clusters using the newly created user:\r\n\r\n```\r\nPOST /farequote/_search?scroll=1m\r\n\r\nPOST /_search/scroll\r\n{\r\n  \"scroll_id\" : \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAALfEWZGhpcUxXeENST1dZRUZSMTF1T2Vidw==\",\r\n  \"scroll\" : \"1m\"\r\n}\r\n\r\nPOST /cluster_one:farequote/_search?scroll=1m\r\n\r\nPOST /_search/scroll\r\n{\r\n  \"scroll_id\" : \"DXF1ZXJ5QW5kRmV0Y2gBAAAAAAAABvQiY2x1c3Rlcl9vbmU6Qm1hRFIzOWdRT0d1bjI5OV9hZE5zdw==\",\r\n  \"scroll\" : \"1m\"\r\n}\r\n```\r\n\r\n(Obviously the exact scroll IDs will vary from run to run.)\r\n\r\nYou will note that the local scroll can be started and continued with just privileges on the index being scrolled.  The scroll of the remote index can also be started successfully, returning the first few hits as expected.  But the attempt to continue the remote scroll returns this:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"security_exception\",\r\n        \"reason\": \"action [cluster:monitor/state] is unauthorized for user [dave]\"\r\n      }\r\n    ],\r\n    \"type\": \"security_exception\",\r\n    \"reason\": \"action [cluster:monitor/state] is unauthorized for user [dave]\"\r\n  },\r\n  \"status\": 403\r\n}\r\n```\r\n\r\nI think that if the remote scroll continuation needs to get some portion of the cluster state as an internal implementation detail then it should switch to system context to get this information, because logically you'd expect to be able to scroll an index when you have been granted permission to scroll that index.  You should not additionally need permission to read the entire cluster state.","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}