{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62847","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62847/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62847/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62847/events","html_url":"https://github.com/elastic/elasticsearch/issues/62847","id":707917702,"node_id":"MDU6SXNzdWU3MDc5MTc3MDI=","number":62847,"title":"[Transform] _stats throws NPE if 1 transform task is unassigned","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-09-24T07:08:39Z","updated_at":"2020-09-29T07:55:33Z","closed_at":"2020-09-28T13:23:50Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Affected versions**: 7.5 -- 7.9.2 (fixed >= 7.9.3)\r\n\r\nIf a transform p-task isn't assigned to a node, `_transform/_stats` might fail with `500` (internal server error). In addition deletion and stopping doesn't work.\r\n\r\nIn the log you will find something like:\r\n\r\n```\r\njava.lang.NullPointerException: Cannot invoke \"String.equals(Object)\" because \"nodeId\" is null\r\n\tat org.elasticsearch.cluster.node.DiscoveryNodes.resolveNodes(DiscoveryNodes.java:341) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.support.tasks.TransportTasksAction.resolveNodes(TransportTasksAction.java:159) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.support.tasks.TransportTasksAction$AsyncAction.<init>(TransportTasksAction.java:230) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n```\r\n\r\n**Mitigation**:\r\n\r\nThe problem is likely a failed transform, as it's failed it does **not** get assigned, but the task still exists and must be removed in order to get back to normal. Check tasks and cancel all `data_frame/transforms[c]` ones (this is save for other running transforms, no data will be lost, they will continue from the last saved state after restart):\r\n\r\n```\r\nGET _cat/tasks\r\nPOST _tasks/{id}/_cancel\r\n```\r\n\r\nAfter that check if `GET _transform/_stats` works, if not the task might still exist in cluster state, see `GET _cluster/state/` and search for \"data_frame/transforms\".\r\n\r\nIf the tasks are cancelled but cluster state still has them, restart the master node. The entries should disappear.\r\n\r\nAfterwards you can start the transform again, it might fail, if so you find the reason in `_stats` or check the job messages / audit log for failures.\r\n\r\n(Only if the transform fails and than the nodes (temporary) disappears (e.g. upgrade), the above can happen)\r\n\r\n**Solution**\r\n\r\nIf a transform p-task isn't assigned to a node - either because there is none or the task is failed - `_stats` fails with an NPE. The NPE is thrown when resolving node ids, however the root cause seems to be in the transport. When it resolves the tasks and find the corresponding nodes, it does not check regarding unassigned tasks. The list of collected nodes contains `null` and the resolver stumbles upon that (in addition consider making the resolver more robust).\r\n\r\n```\r\njava.lang.NullPointerException: Cannot invoke \"String.equals(Object)\" because \"nodeId\" is null\r\n\tat org.elasticsearch.cluster.node.DiscoveryNodes.resolveNodes(DiscoveryNodes.java:341) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.support.tasks.TransportTasksAction.resolveNodes(TransportTasksAction.java:159) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.support.tasks.TransportTasksAction$AsyncAction.<init>(TransportTasksAction.java:230) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.support.tasks.TransportTasksAction$AsyncAction.<init>(TransportTasksAction.java:215) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.support.tasks.TransportTasksAction.doExecute(TransportTasksAction.java:96) ~[elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.xpack.transform.action.TransportGetTransformStatsAction.lambda$doExecute$7(TransportGetTransformStatsAction.java:141) ~[?:?]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) [elasticsearch-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.xpack.transform.persistence.IndexBasedTransformConfigManager.lambda$expandTransformIds$10(IndexBasedTransformConfigManager.java:461) [transform-7.9.0.jar:7.9.0]\r\n\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) [elasticsearch-7.9.0.jar:7.9.0]\r\n```","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}