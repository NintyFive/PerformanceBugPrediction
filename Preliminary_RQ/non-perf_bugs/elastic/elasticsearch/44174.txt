{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44174","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44174/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44174/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44174/events","html_url":"https://github.com/elastic/elasticsearch/issues/44174","id":466363540,"node_id":"MDU6SXNzdWU0NjYzNjM1NDA=","number":44174,"title":"ES 7.2 Fails to start due to OutOfMemory error","user":{"login":"fatmcgav","id":2235170,"node_id":"MDQ6VXNlcjIyMzUxNzA=","avatar_url":"https://avatars2.githubusercontent.com/u/2235170?v=4","gravatar_id":"","url":"https://api.github.com/users/fatmcgav","html_url":"https://github.com/fatmcgav","followers_url":"https://api.github.com/users/fatmcgav/followers","following_url":"https://api.github.com/users/fatmcgav/following{/other_user}","gists_url":"https://api.github.com/users/fatmcgav/gists{/gist_id}","starred_url":"https://api.github.com/users/fatmcgav/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fatmcgav/subscriptions","organizations_url":"https://api.github.com/users/fatmcgav/orgs","repos_url":"https://api.github.com/users/fatmcgav/repos","events_url":"https://api.github.com/users/fatmcgav/events{/privacy}","received_events_url":"https://api.github.com/users/fatmcgav/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"}],"state":"closed","locked":false,"assignee":{"login":"williamrandolph","id":3253644,"node_id":"MDQ6VXNlcjMyNTM2NDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3253644?v=4","gravatar_id":"","url":"https://api.github.com/users/williamrandolph","html_url":"https://github.com/williamrandolph","followers_url":"https://api.github.com/users/williamrandolph/followers","following_url":"https://api.github.com/users/williamrandolph/following{/other_user}","gists_url":"https://api.github.com/users/williamrandolph/gists{/gist_id}","starred_url":"https://api.github.com/users/williamrandolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/williamrandolph/subscriptions","organizations_url":"https://api.github.com/users/williamrandolph/orgs","repos_url":"https://api.github.com/users/williamrandolph/repos","events_url":"https://api.github.com/users/williamrandolph/events{/privacy}","received_events_url":"https://api.github.com/users/williamrandolph/received_events","type":"User","site_admin":false},"assignees":[{"login":"williamrandolph","id":3253644,"node_id":"MDQ6VXNlcjMyNTM2NDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3253644?v=4","gravatar_id":"","url":"https://api.github.com/users/williamrandolph","html_url":"https://github.com/williamrandolph","followers_url":"https://api.github.com/users/williamrandolph/followers","following_url":"https://api.github.com/users/williamrandolph/following{/other_user}","gists_url":"https://api.github.com/users/williamrandolph/gists{/gist_id}","starred_url":"https://api.github.com/users/williamrandolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/williamrandolph/subscriptions","organizations_url":"https://api.github.com/users/williamrandolph/orgs","repos_url":"https://api.github.com/users/williamrandolph/repos","events_url":"https://api.github.com/users/williamrandolph/events{/privacy}","received_events_url":"https://api.github.com/users/williamrandolph/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2019-07-10T15:05:11Z","updated_at":"2020-03-17T17:21:01Z","closed_at":"2020-03-17T17:21:00Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): \r\n`7.2.0`\r\n\r\n**Plugins installed**: \r\nDefault MSI installation\r\n\r\n**JVM version** (`java -version`): \r\n```\r\njava version \"1.8.0_144\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_144-b01)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nWindows 2016\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nInstalled Elasticsearch `7.2.0` using the Windows MSI package.\r\nSelected 8GB of Heap space, with the machine having 16GB available. \r\n\r\nUpon trying to start ES using `.\\bin\\elasticsearch.exe`, a Java `OutOfMemory` error is returned:\r\n```\r\nC:\\Program Files\\Elastic\\Elasticsearch\\7.2.0>.\\bin\\elasticsearch.exe\r\nException in thread \"main\" java.lang.OutOfMemoryError: Direct buffer memory\r\n\r\n        at java.nio.Bits.reserveMemory(Bits.java:694)\r\n        at java.nio.DirectByteBuffer.<init>(DirectByteBuffer.java:123)\r\n        at java.nio.ByteBuffer.allocateDirect(ByteBuffer.java:311)\r\n        at sun.nio.ch.Util.getTemporaryDirectBuffer(Util.java:241)\r\n        at sun.nio.ch.IOUtil.read(IOUtil.java:195)\r\n        at sun.nio.ch.FileChannelImpl.read(FileChannelImpl.java:159)\r\n        at sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:65)\r\n        at sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:109)\r\n        at sun.nio.ch.ChannelInputStream.read(ChannelInputStream.java:103)\r\n        at com.fasterxml.jackson.dataformat.yaml.UTF8Reader.readBytes(UTF8Reader.java:327)\r\n        at com.fasterxml.jackson.dataformat.yaml.UTF8Reader.loadMore(UTF8Reader.java:447)\r\n        at com.fasterxml.jackson.dataformat.yaml.UTF8Reader.read(UTF8Reader.java:185)\r\n        at com.fasterxml.jackson.dataformat.yaml.UTF8Reader.read(UTF8Reader.java:148)\r\n        at org.yaml.snakeyaml.reader.StreamReader.update(StreamReader.java:184)\r\n        at org.yaml.snakeyaml.reader.StreamReader.<init>(StreamReader.java:60)\r\n        at com.fasterxml.jackson.dataformat.yaml.YAMLParser.<init>(YAMLParser.java:152)\r\n        at com.fasterxml.jackson.dataformat.yaml.YAMLFactory._createParser(YAMLFactory.java:420)\r\n        at com.fasterxml.jackson.dataformat.yaml.YAMLFactory.createParser(YAMLFactory.java:321)\r\n        at org.elasticsearch.common.xcontent.yaml.YamlXContent.createParser(YamlXContent.java:85)\r\n        at org.elasticsearch.common.settings.Settings$Builder.loadFromStream(Settings.java:1087)\r\n        at org.elasticsearch.common.settings.Settings$Builder.loadFromPath(Settings.java:1070)\r\n        at org.elasticsearch.node.InternalSettingsPreparer.prepareEnvironment(InternalSettingsPreparer.java:83)\r\n        at org.elasticsearch.cli.EnvironmentAwareCommand.createEnv(EnvironmentAwareCommand.java:95)\r\n        at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86)\r\n        at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124)\r\n        at org.elasticsearch.cli.Command.main(Command.java:90)\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:115)\r\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92)\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Install any Oracle Java 8 JDK version\r\n 2. Install Elasticsearch 7.2.0 using MSI installation\r\n 3. Select 8GB of Java memory\r\n 4. Attempt to start Elasticsearch using `administrator` command prompt:\r\n```\r\nC:\\Program Files\\Elastic\\Elasticsearch\\7.2.0>.\\bin\\elasticsearch.exe\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n**Additional information**:\r\nI've confirmed that the issue appears to be limited to the Oracle Java 8 JDK, by setting `JAVA_HOME` to `C:\\Progra~1\\Elastic\\Elasticsearch\\7.2.0\\jdk` and confirming that Elasticsearch starts cleanly and uses the bundled JDK version:\r\n```\r\n[2019-07-10T09:55:59,484][INFO ][o.e.n.Node               ] [FATMCGAV-WINDOW] node name [FATMCGAV-WINDOW], node ID [UbhLetpkQb6UUQp7WSqC3w], cluster name [elasticsearch]\r\n[2019-07-10T09:55:59,484][INFO ][o.e.n.Node               ] [FATMCGAV-WINDOW] version[7.2.0], pid[4512], build[unknown/unknown/508c38a/2019-06-20T15:54:18.811730Z], OS[Windows Server 2016/10.0/amd64], JVM[Oracle Corporation/Java HotSpot(TM) 64-Bit Server VM/1.8.0_144/25.144-b01]\r\n[2019-07-10T09:55:59,500][INFO ][o.e.n.Node               ] [FATMCGAV-WINDOW] JVM home [C:\\Program Files\\Java\\jdk1.8.0_144\\jre]\r\n[2019-07-10T09:55:59,500][INFO ][o.e.n.Node               ] [FATMCGAV-WINDOW] JVM arguments [-XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -Des.networkaddress.cache.ttl=60, -Des.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -Xss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.io.tmpdir=C:\\Users\\fatmcgav\\AppData\\Local\\Temp\\elasticsearch, -XX:+HeapDumpOnOutOfMemoryError, -XX:HeapDumpPath=C:\\ProgramData\\Elastic\\Elasticsearch\\data, -XX:ErrorFile=logs/hs_err_pid%p.log, -XX:+PrintGCDetails, -XX:+PrintGCDateStamps, -XX:+PrintTenuringDistribution, -XX:+PrintGCApplicationStoppedTime, -Xloggc:logs/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLogFiles=32, -XX:GCLogFileSize=64m, -Xmx8192m, -Xms8192m, -XX:MaxDirectMemorySize=6g, -XX:+PrintFlagsFinal, -Dio.netty.allocator.type=unpooled, -Delasticsearch, -Des.path.home=C:\\Program Files\\Elastic\\Elasticsearch\\7.2.0, -Des.path.conf=C:\\ProgramData\\Elastic\\Elasticsearch\\config]\r\n```\r\n\r\nI've also confirmed that upgrading the Oracle Java 8 JDK to the _latest_ release doesn't change the behaviour.\r\n\r\nI believe this issue is related to the changes in https://github.com/elastic/elasticsearch/pull/42006.\r\n\r\nI tested the theory by setting the `-XX:MaxDirectMemorySize` flag in `jvm.options`, with some interesting results. \r\nSetting the value to `(Xmx / 2) ± 1` results in the JVM starting. \r\nSo if `Xmx` is set to `8192m`, values of `4095m` or `4097m` worked, but `4096m` didn't. \r\n\r\nAlso, setting the value to match `Xmx`, which mirrors the `7.1` behaviour fails with the same exception. ","closed_by":{"login":"williamrandolph","id":3253644,"node_id":"MDQ6VXNlcjMyNTM2NDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3253644?v=4","gravatar_id":"","url":"https://api.github.com/users/williamrandolph","html_url":"https://github.com/williamrandolph","followers_url":"https://api.github.com/users/williamrandolph/followers","following_url":"https://api.github.com/users/williamrandolph/following{/other_user}","gists_url":"https://api.github.com/users/williamrandolph/gists{/gist_id}","starred_url":"https://api.github.com/users/williamrandolph/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/williamrandolph/subscriptions","organizations_url":"https://api.github.com/users/williamrandolph/orgs","repos_url":"https://api.github.com/users/williamrandolph/repos","events_url":"https://api.github.com/users/williamrandolph/events{/privacy}","received_events_url":"https://api.github.com/users/williamrandolph/received_events","type":"User","site_admin":false},"performed_via_github_app":null}