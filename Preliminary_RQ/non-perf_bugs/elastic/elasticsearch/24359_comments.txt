[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297648167","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297648167","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297648167,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzY0ODE2Nw==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T08:28:08Z","updated_at":"2017-04-27T08:28:08Z","author_association":"MEMBER","body":"Hi @jay-dihenkar, would you be able to share your document corpus (maybe anonymized if it contains sensitive data)?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297650065","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297650065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297650065,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzY1MDA2NQ==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T08:36:01Z","updated_at":"2017-04-27T08:36:48Z","author_association":"MEMBER","body":"FWIW, here is [my attempt to reproduce this issue](https://gist.github.com/danielmitterdorfer/b095e6ad5570722c3eb9fa32418d4852) (tested again Elasticsearch 5.3.1 with default settings) but this example works fine (that's why I'm asking for the document corpus).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297657026","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297657026","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297657026,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzY1NzAyNg==","user":{"login":"jay-dihenkar","id":17760959,"node_id":"MDQ6VXNlcjE3NzYwOTU5","avatar_url":"https://avatars2.githubusercontent.com/u/17760959?v=4","gravatar_id":"","url":"https://api.github.com/users/jay-dihenkar","html_url":"https://github.com/jay-dihenkar","followers_url":"https://api.github.com/users/jay-dihenkar/followers","following_url":"https://api.github.com/users/jay-dihenkar/following{/other_user}","gists_url":"https://api.github.com/users/jay-dihenkar/gists{/gist_id}","starred_url":"https://api.github.com/users/jay-dihenkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay-dihenkar/subscriptions","organizations_url":"https://api.github.com/users/jay-dihenkar/orgs","repos_url":"https://api.github.com/users/jay-dihenkar/repos","events_url":"https://api.github.com/users/jay-dihenkar/events{/privacy}","received_events_url":"https://api.github.com/users/jay-dihenkar/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T09:04:34Z","updated_at":"2017-04-27T09:04:34Z","author_association":"NONE","body":"Hi,\r\n\r\nSome points I want to highlight:\r\n\r\n* Total docs in index is : 139000\r\n* We have upgraded from 2.3.3 to 5.3.1 so the mappings which I have given are not same as you have mentioned. \r\n* We have 180 fields in the doc, the field on which aggregation is done is 'uuid' sample value: 4015759c-9764-4fee-b735-720dc6b3e28f\r\n* We are having a timestamp field \"ES_TIMESTAMP\" which is of type date so we're quering the number of docs for 1 day which is 417.\r\n* The output for cat indices is :\r\n```\r\nhealth status index                              uuid                   pri rep docs.count docs.deleted store.size pri.store.size\r\nyellow open   test-index                      J7kU9LXHSc-7NGNKHmHRbA   9   2     139856            0    195.1mb        195.1mb\r\n```\r\n\r\nI'll further see if I can anonymize the data and share a mock index.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297684702","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297684702","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297684702,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzY4NDcwMg==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T11:12:46Z","updated_at":"2017-04-27T11:12:46Z","author_association":"MEMBER","body":"Thanks for the update @jay-dihenkar. @colings86 can you please have a look whether you can explain this behavior?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297690037","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297690037","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297690037,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzY5MDAzNw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T11:40:58Z","updated_at":"2017-04-27T11:40:58Z","author_association":"MEMBER","body":"@jay-dihenkar are you able to do the same request directly to ES (not through kibana) and get the same result? Also in the server logs there should be a stack trace for this exception could you paste that here (including all caused by traces)?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297697840","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297697840","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297697840,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzY5Nzg0MA==","user":{"login":"jay-dihenkar","id":17760959,"node_id":"MDQ6VXNlcjE3NzYwOTU5","avatar_url":"https://avatars2.githubusercontent.com/u/17760959?v=4","gravatar_id":"","url":"https://api.github.com/users/jay-dihenkar","html_url":"https://github.com/jay-dihenkar","followers_url":"https://api.github.com/users/jay-dihenkar/followers","following_url":"https://api.github.com/users/jay-dihenkar/following{/other_user}","gists_url":"https://api.github.com/users/jay-dihenkar/gists{/gist_id}","starred_url":"https://api.github.com/users/jay-dihenkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay-dihenkar/subscriptions","organizations_url":"https://api.github.com/users/jay-dihenkar/orgs","repos_url":"https://api.github.com/users/jay-dihenkar/repos","events_url":"https://api.github.com/users/jay-dihenkar/events{/privacy}","received_events_url":"https://api.github.com/users/jay-dihenkar/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T12:21:43Z","updated_at":"2017-04-27T12:21:43Z","author_association":"NONE","body":"Hi, \r\n\r\nPutting details::\r\ncurl query =>\r\n```\r\n> curl -XPOST http://ip:port/test-index/_search -d @t\r\n{\"error\":{\"root_cause\":[{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [119240039600/111gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":119240039600,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [137971939600/128.4gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":137971939600,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [111410235200/103.7gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":111410235200,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [116703122800/108.6gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":116703122800,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [120376379200/112.1gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":120376379200,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [107969413200/100.5gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":107969413200,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [106957774000/99.6gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":106957774000,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [136670085200/127.2gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":136670085200,\"bytes_limit\":8511422464},{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [140459030800/130.8gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":140459030800,\"bytes_limit\":8511422464}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [119240039600/111gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":119240039600,\"bytes_limit\":8511422464}},{\"shard\":1,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [137971939600/128.4gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":137971939600,\"bytes_limit\":8511422464}},{\"shard\":2,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [111410235200/103.7gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":111410235200,\"bytes_limit\":8511422464}},{\"shard\":3,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [116703122800/108.6gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":116703122800,\"bytes_limit\":8511422464}},{\"shard\":4,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [120376379200/112.1gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":120376379200,\"bytes_limit\":8511422464}},{\"shard\":5,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [107969413200/100.5gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":107969413200,\"bytes_limit\":8511422464}},{\"shard\":6,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [106957774000/99.6gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":106957774000,\"bytes_limit\":8511422464}},{\"shard\":7,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [136670085200/127.2gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":136670085200,\"bytes_limit\":8511422464}},{\"shard\":8,\"index\":\"test-index\",\"node\":\"i-vL8blaT026-wCIWYo16g\",\"reason\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [140459030800/130.8gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":140459030800,\"bytes_limit\":8511422464}}],\"caused_by\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[request] Data too large, data for [<reused_arrays>] would be [116703122800/108.6gb], which is larger than the limit of [8511422464/7.9gb]\",\"bytes_wanted\":116703122800,\"bytes_limit\":8511422464}},\"status\":503}\r\n```\r\n\r\n```\r\n> cat t\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"query_string\": {\r\n            \"query\": \"*\",\r\n            \"analyze_wildcard\": true\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"ES_timestamp\": {\r\n              \"gte\": 1487183400000,\r\n              \"lte\": 1487269800000,\r\n              \"format\": \"epoch_millis\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"must_not\": []\r\n    }\r\n  },\r\n  \"size\": 0,\r\n  \"_source\": {\r\n    \"excludes\": []\r\n  },\r\n  \"aggs\": {\r\n    \"2\": {\r\n      \"terms\": {\r\n        \"field\": \"uuid\",\r\n        \"size\": 500000,\r\n        \"order\": {\r\n          \"1\": \"desc\"\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"1\": {\r\n          \"cardinality\": {\r\n            \"field\": \"uuid\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n```\r\nThis is one full trace of debugging messages: https://gist.github.com/jay-dihenkar/b52d83cdd052b007bdaae409dffe5c60\r\n\r\nPS: I have also changed `\"size\": 500000,` to 500 as well.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297703228","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297703228","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297703228,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzcwMzIyOA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T12:46:34Z","updated_at":"2017-04-27T12:46:34Z","author_association":"MEMBER","body":"Ok I _think_ the issue here is that the terms aggregation is using the global ordinals execution mode and the ordinal value a collected term is large. The cardinality aggregation pre-allocates memory for all buckets with a ordinal value less than or equal to the current one. \r\n\r\nThis works well in a lot of cases but in this case the combination of the terms agg using global ordinals and the cardinality agg is making Elasticsearch try to allocate too much memory thus causing the circuit breaker to trip. @jpountz has actually raise an issue about changing this behaviour (https://github.com/elastic/elasticsearch/issues/15892).\r\n\r\nThe good new is that there is an easy workaround for your query that will prove if this is what is happening and get you around it for now. The terms aggregation has an [`execution_hint`](https://www.elastic.co/guide/en/elasticsearch/reference/5.3/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-execution-hint) field that you can set to ask the terms agg to run in a different mode. Can you set this to `global_ordinals_hash` and run the same query and let me know what the result is?\r\n\r\nSo the terms portion of the request should look something like this:\r\n```\r\n\"terms\": {\r\n        \"field\": \"uuid\",\r\n        \"size\": 500,\r\n        \"execution_hint\": \"global_ordinals_hash\",\r\n        \"order\": {\r\n          \"1\": \"desc\"\r\n        }\r\n      }\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297705287","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297705287","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297705287,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzcwNTI4Nw==","user":{"login":"jay-dihenkar","id":17760959,"node_id":"MDQ6VXNlcjE3NzYwOTU5","avatar_url":"https://avatars2.githubusercontent.com/u/17760959?v=4","gravatar_id":"","url":"https://api.github.com/users/jay-dihenkar","html_url":"https://github.com/jay-dihenkar","followers_url":"https://api.github.com/users/jay-dihenkar/followers","following_url":"https://api.github.com/users/jay-dihenkar/following{/other_user}","gists_url":"https://api.github.com/users/jay-dihenkar/gists{/gist_id}","starred_url":"https://api.github.com/users/jay-dihenkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay-dihenkar/subscriptions","organizations_url":"https://api.github.com/users/jay-dihenkar/orgs","repos_url":"https://api.github.com/users/jay-dihenkar/repos","events_url":"https://api.github.com/users/jay-dihenkar/events{/privacy}","received_events_url":"https://api.github.com/users/jay-dihenkar/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T12:55:55Z","updated_at":"2017-04-27T12:55:55Z","author_association":"NONE","body":"Hi, This worked! I added it to curl query and ran and it worked.\r\n\r\nIs there a way to inject this into Kibana Viz, I already tried to put it in 'advanced' -> json input but it doesn't work saying it's not a recognized option?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297708197","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297708197","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297708197,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzcwODE5Nw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T13:08:36Z","updated_at":"2017-04-27T13:08:42Z","author_association":"MEMBER","body":"@jay-dihenkar glad it worked.\r\n\r\n@spalger is the `execution_hint` on a terms aggregation configurable in Visualize in Kibana?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297825395","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-297825395","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":297825395,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzgyNTM5NQ==","user":{"login":"jay-dihenkar","id":17760959,"node_id":"MDQ6VXNlcjE3NzYwOTU5","avatar_url":"https://avatars2.githubusercontent.com/u/17760959?v=4","gravatar_id":"","url":"https://api.github.com/users/jay-dihenkar","html_url":"https://github.com/jay-dihenkar","followers_url":"https://api.github.com/users/jay-dihenkar/followers","following_url":"https://api.github.com/users/jay-dihenkar/following{/other_user}","gists_url":"https://api.github.com/users/jay-dihenkar/gists{/gist_id}","starred_url":"https://api.github.com/users/jay-dihenkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay-dihenkar/subscriptions","organizations_url":"https://api.github.com/users/jay-dihenkar/orgs","repos_url":"https://api.github.com/users/jay-dihenkar/repos","events_url":"https://api.github.com/users/jay-dihenkar/events{/privacy}","received_events_url":"https://api.github.com/users/jay-dihenkar/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T20:10:09Z","updated_at":"2017-04-27T20:10:09Z","author_association":"NONE","body":"Hi @spalger / @colings86  / @danielmitterdorfer ,\r\n\r\nA quick patch in Kibana by some trick or suggestions modifying `./src/core_plugins/console/api_server/es_5_0/aggregations.js` to make it work will be appreciated.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/298146339","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-298146339","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":298146339,"node_id":"MDEyOklzc3VlQ29tbWVudDI5ODE0NjMzOQ==","user":{"login":"jay-dihenkar","id":17760959,"node_id":"MDQ6VXNlcjE3NzYwOTU5","avatar_url":"https://avatars2.githubusercontent.com/u/17760959?v=4","gravatar_id":"","url":"https://api.github.com/users/jay-dihenkar","html_url":"https://github.com/jay-dihenkar","followers_url":"https://api.github.com/users/jay-dihenkar/followers","following_url":"https://api.github.com/users/jay-dihenkar/following{/other_user}","gists_url":"https://api.github.com/users/jay-dihenkar/gists{/gist_id}","starred_url":"https://api.github.com/users/jay-dihenkar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jay-dihenkar/subscriptions","organizations_url":"https://api.github.com/users/jay-dihenkar/orgs","repos_url":"https://api.github.com/users/jay-dihenkar/repos","events_url":"https://api.github.com/users/jay-dihenkar/events{/privacy}","received_events_url":"https://api.github.com/users/jay-dihenkar/received_events","type":"User","site_admin":false},"created_at":"2017-04-29T04:28:01Z","updated_at":"2017-04-29T04:28:01Z","author_association":"NONE","body":"OK, \r\n\r\nFigured out, we can do this from Kibana. \r\nIn Edit Viz -> aggs bucket -> advanced -> json -> `{\"execution_hint\": \"global_ordinals_hash\"}`.\r\n\r\n@colings86 : Are there any further improvements in the query we can do if we have lots of unique terms to aggregate over other than the `execution_hint`? \r\n\r\nAre there any other significant changes from 2.x to 5.x related to cardinality aggregations and parameters controlling them?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314788267","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-314788267","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":314788267,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDc4ODI2Nw==","user":{"login":"bwdezend","id":813245,"node_id":"MDQ6VXNlcjgxMzI0NQ==","avatar_url":"https://avatars0.githubusercontent.com/u/813245?v=4","gravatar_id":"","url":"https://api.github.com/users/bwdezend","html_url":"https://github.com/bwdezend","followers_url":"https://api.github.com/users/bwdezend/followers","following_url":"https://api.github.com/users/bwdezend/following{/other_user}","gists_url":"https://api.github.com/users/bwdezend/gists{/gist_id}","starred_url":"https://api.github.com/users/bwdezend/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bwdezend/subscriptions","organizations_url":"https://api.github.com/users/bwdezend/orgs","repos_url":"https://api.github.com/users/bwdezend/repos","events_url":"https://api.github.com/users/bwdezend/events{/privacy}","received_events_url":"https://api.github.com/users/bwdezend/received_events","type":"User","site_admin":false},"created_at":"2017-07-12T14:33:15Z","updated_at":"2017-07-12T14:33:15Z","author_association":"NONE","body":"We are having the same issue with an Elasticsearch 5.3.3 cluster.  A user issuing a cardinality query can trivially OOME's the data nodes.  As a temporary workaround, we've removed the import of the ```AggTypesMetricsCardinalityProvider``` aggregation in the Kibana ```src/ ui/public/agg_types/index.js```  to prevent users from selecting a cardinality aggregation.\r\n\r\nI'm happy to provide further information as needed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314791894","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-314791894","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":314791894,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDc5MTg5NA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-07-12T14:44:31Z","updated_at":"2017-07-12T14:44:31Z","author_association":"MEMBER","body":"@bwdezend if you are able to upgrade to 5.4.2+ you should be able to take advantage of https://github.com/elastic/elasticsearch/pull/25010 which fixes a bug in the circuit breaker so it accounts for the memory the cardinality aggregation uses before allocating the memory. This would still mean these kinds of requests would fail but it should throw a circuit breaker exception rather than an OOME.\r\n\r\nIn that same version we also merged https://github.com/elastic/elasticsearch/pull/24941 which should help these kinds of request not pre-allocate as much memory which may help some of these requests succeed, although in the case where the number of buckets the terms aggregation needs to create is very high you still may end up with memory issues but as I said above these should present as circuit breaker exceptions rather than OOMEs now.\r\n\r\nLet us know if you manage to try it out","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314795442","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-314795442","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":314795442,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDc5NTQ0Mg==","user":{"login":"bwdezend","id":813245,"node_id":"MDQ6VXNlcjgxMzI0NQ==","avatar_url":"https://avatars0.githubusercontent.com/u/813245?v=4","gravatar_id":"","url":"https://api.github.com/users/bwdezend","html_url":"https://github.com/bwdezend","followers_url":"https://api.github.com/users/bwdezend/followers","following_url":"https://api.github.com/users/bwdezend/following{/other_user}","gists_url":"https://api.github.com/users/bwdezend/gists{/gist_id}","starred_url":"https://api.github.com/users/bwdezend/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bwdezend/subscriptions","organizations_url":"https://api.github.com/users/bwdezend/orgs","repos_url":"https://api.github.com/users/bwdezend/repos","events_url":"https://api.github.com/users/bwdezend/events{/privacy}","received_events_url":"https://api.github.com/users/bwdezend/received_events","type":"User","site_admin":false},"created_at":"2017-07-12T14:54:50Z","updated_at":"2017-07-12T14:54:50Z","author_association":"NONE","body":"@colings86 is there no planned fix for the 5.3.x branch? We have over 200 nodes running 5.3.3, and upgrading isn't trivial.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314800299","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-314800299","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":314800299,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDgwMDI5OQ==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-07-12T15:10:14Z","updated_at":"2017-07-12T15:10:14Z","author_association":"MEMBER","body":"Our policy is to only maintain and provide patch release for each minor version until the next minor version is released. The exception to this is for the last minor release in each major release. See https://www.elastic.co/support/eol for more details on this, specifically the 'Maintenance Policy' section.\r\n\r\nAlso note that you can upgrade minor releases using the [rolling upgrade method](https://www.elastic.co/guide/en/elasticsearch/reference/5.5/rolling-upgrades.html) the same way that you would for a patch release upgrade. Minor releases are also backwards compatible. see here for more information on our recommended upgrade procedures: https://www.elastic.co/guide/en/elasticsearch/reference/5.5/setup-upgrade.html","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314806536","html_url":"https://github.com/elastic/elasticsearch/issues/24359#issuecomment-314806536","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24359","id":314806536,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDgwNjUzNg==","user":{"login":"bwdezend","id":813245,"node_id":"MDQ6VXNlcjgxMzI0NQ==","avatar_url":"https://avatars0.githubusercontent.com/u/813245?v=4","gravatar_id":"","url":"https://api.github.com/users/bwdezend","html_url":"https://github.com/bwdezend","followers_url":"https://api.github.com/users/bwdezend/followers","following_url":"https://api.github.com/users/bwdezend/following{/other_user}","gists_url":"https://api.github.com/users/bwdezend/gists{/gist_id}","starred_url":"https://api.github.com/users/bwdezend/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bwdezend/subscriptions","organizations_url":"https://api.github.com/users/bwdezend/orgs","repos_url":"https://api.github.com/users/bwdezend/repos","events_url":"https://api.github.com/users/bwdezend/events{/privacy}","received_events_url":"https://api.github.com/users/bwdezend/received_events","type":"User","site_admin":false},"created_at":"2017-07-12T15:30:33Z","updated_at":"2017-07-12T15:30:33Z","author_association":"NONE","body":"This bug was reported against 5.3.1 in April. 5.5.0 was released a few days ago. Upgrading even between minor versions takes time for testing and validation. I wasn't expecting for 5.3.x to be unsupported this quickly.  We'll leave our workaround in place for now and get the testing scheduled for 5.5.x.","performed_via_github_app":null}]