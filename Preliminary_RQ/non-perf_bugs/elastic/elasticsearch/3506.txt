{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3506","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3506/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3506/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3506/events","html_url":"https://github.com/elastic/elasticsearch/issues/3506","id":18047253,"node_id":"MDU6SXNzdWUxODA0NzI1Mw==","number":3506,"title":"Add scoring support to percolate api ","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":37906111,"node_id":"MDU6TGFiZWwzNzkwNjExMQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0.Beta1","name":"v1.0.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2013-08-14T11:31:01Z","updated_at":"2016-03-16T00:57:39Z","closed_at":"2013-08-14T11:51:57Z","author_association":"MEMBER","active_lock_reason":null,"body":"Adding scoring support will allow the percolate matches to be sorted, or just assign a scores to percolate matches. Sorting by score can be very useful when millions of matches are being returned.\n\nThe scoring support hooks in into the percolate query option and adds two new boolean options:\n- `sort` - Whether to sort the matches based on the score. This will also include the score for each match. The `size` option is a required option when sorting percolate matches is enabled.\n- `score` - Whether to compute the score and include it with each match. This will not sort the matches.\n\nFor both new options the `query` option needs to be specified, which is used to produce the scores. The `query` option is normally used to control which percolate queries are evaluated. In order to give meaning to these score, the recently added `function_score` query in #3423 can be used to wrap these queries as is shown in the examples below.\n## Examples\n### Indexing dummy percolator queries:\n\nFirst query:\n\n``` bash\ncurl -XPUT 'localhost:9200/my-index/_percolator/1' -d '{ \n    \"query\": { \n        \"match_all\" : {} \n    },\n    \"priority\" : 1,\n    \"create_date\" : \"2010/01/01\"\n}'\n```\n\nSecond query:\n\n``` bash\ncurl -XPUT 'localhost:9200/my-index/_percolator/2' -d '{ \n    \"query\": { \n        \"match_all\" : {} \n    },\n    \"priority\" : 2,\n    \"create_date\" : \"2013/01/01\"\n}'\n```\n\nThese queries have two extra fields: 'priority' and 'create_date'. These fields can be used in the percolate api during sorting.\n### Script score example\n\nPercolate request using the `script_score` function:\n\n``` json\n{ \n    \"doc\": { \n        \"field\" : \"value\" \n    },\n    \"query\" : {\n        \"function_score\" : {\n            \"query\" : { \"match_all\": {}},\n            \"functions\" : [\n                {\n                    \"script_score\" : {\n                        \"script\" : \"doc['priority'].value\"\n                    }\n                }\n            ]\n        }\n    },\n    \"sort\" : true,\n    \"size\" : 10\n}\n```\n#### Response:\n\n``` json\n{\n   \"took\": 118,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"total\": 2,\n   \"matches\": [\n      {\n         \"_index\": \"my-index\",\n         \"_id\": \"2\",\n         \"_score\": 2\n      },\n      {\n         \"_index\": \"my-index\",\n         \"_id\": \"1\",\n         \"_score\": 1\n      }\n   ]\n}\n```\n### Decay function example\n\nPercolate request using the `exp` decay function:\n\n``` json\n{ \n    \"doc\": { \n        \"field\" : \"value\" \n    },\n    \"query\" : {\n        \"function_score\" : {\n            \"query\" : { \"match_all\": {}},\n            \"functions\" : [\n                {\n                    \"exp\" : {\n                        \"create_date\" : {\n                            \"reference\" : \"2013/08/14\",\n                            \"scale\" : \"1000d\"\n                        }\n                    }\n                }\n            ]\n        }\n    },\n    \"sort\" : true,\n    \"size\" : 10\n}\n```\n#### Response:\n\n``` json\n{\n   \"took\": 2,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"total\": 2,\n   \"matches\": [\n      {\n         \"_index\": \"my-index\",\n         \"_id\": \"2\",\n         \"_score\": 0.85559505\n      },\n      {\n         \"_index\": \"my-index\",\n         \"_id\": \"1\",\n         \"_score\": 0.4002574\n      }\n   ]\n}\n```\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}