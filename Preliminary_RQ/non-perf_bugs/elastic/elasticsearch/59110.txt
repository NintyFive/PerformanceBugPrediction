{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/59110","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59110/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59110/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/59110/events","html_url":"https://github.com/elastic/elasticsearch/issues/59110","id":651885461,"node_id":"MDU6SXNzdWU2NTE4ODU0NjE=","number":59110,"title":"Elasticsearch: empty slices when using scroll api with slice","user":{"login":"casertap","id":284394,"node_id":"MDQ6VXNlcjI4NDM5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/284394?v=4","gravatar_id":"","url":"https://api.github.com/users/casertap","html_url":"https://github.com/casertap","followers_url":"https://api.github.com/users/casertap/followers","following_url":"https://api.github.com/users/casertap/following{/other_user}","gists_url":"https://api.github.com/users/casertap/gists{/gist_id}","starred_url":"https://api.github.com/users/casertap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casertap/subscriptions","organizations_url":"https://api.github.com/users/casertap/orgs","repos_url":"https://api.github.com/users/casertap/repos","events_url":"https://api.github.com/users/casertap/events{/privacy}","received_events_url":"https://api.github.com/users/casertap/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2020-07-06T23:47:13Z","updated_at":"2020-07-09T12:03:00Z","closed_at":"2020-07-09T12:00:38Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.5.2\r\n\r\n**Plugins installed**: []\r\n\r\nrepository-s3\r\nanalysis-icu\r\nanalysis-kuromoji\r\nanalysis-nori\r\nanalysis-phonetic\r\nanalysis-smartcn\r\nanalysis-stempel\r\nanalysis-ukrainian\r\nhttps://github.com/medcl/elasticsearch-analysis-ik/releases/download/v7.5.2/elasticsearch-analysis-ik-7.5.2.zip\r\nhttps://github.com/medcl/elasticsearch-analysis-pinyin/releases/download/v7.5.2/elasticsearch-analysis-pinyin-7.5.2.zip\r\nhttps://github.com/medcl/elasticsearch-analysis-stconvert/releases/download/v7.5.2/elasticsearch-analysis-stconvert-7.5.2.zip\r\n\r\n**JVM version** (`java -version`):\r\n\r\nJVM[AdoptOpenJDK/OpenJDK 64-Bit Server VM/13.0.1/13.0.1+9\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nOS[Linux/5.4.0-39-generic/amd64]\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI have a simple setup with a green cluster (v7.5.2) of 1 instance with 1 index (replica 0) with 8 shards.\r\n61,500 documents indexed.\r\n\r\nIf I create 8 slices with these queries (POST queries)\r\n```\r\nhttp://localhost:9202/products_dev/_search?scroll=10m: {'slice': {'field': 'created_at', 'id': 0, 'max': 8}, 'size': 1000}\r\nhttp://localhost:9202/products_dev/_search?scroll=10m: {'slice': {'field': 'created_at', 'id': 1, 'max': 8}, 'size': 1000}\r\n...\r\nhttp://localhost:9202/products_dev/_search?scroll=10m: {'slice': {'field': 'created_at', 'id': 7, 'max': 8}, 'size': 1000}\r\n```\r\nfor each slice I collect the first hits of each slice and get those lengths:\r\n```[1000, 0, 0, 0, 0, 0, 0, 0]```\r\n\r\nOnly 1 slice has results which is equivalent to not slicing the index in the first place.\r\n\r\nI tried a max of 32 with those commands:\r\n```\r\nhttp://localhost:9202/products_dev/_search?scroll=10m: {'slice': {'field': 'created_at', 'id': 0, 'max': 32}, 'size': 1000}\r\nhttp://localhost:9202/products_dev/_search?scroll=10m: {'slice': {'field': 'created_at', 'id': 1, 'max': 32}, 'size': 1000}\r\n...\r\nhttp://localhost:9202/products_dev/_search?scroll=10m: {'slice': {'field': 'created_at', 'id': 31, 'max': 32}, 'size': 1000}\r\n```\r\nfor each slice I collect the first hits of each slice and get those lengths:\r\n```[1000, 0, 0, 0, 0, 0, 0, 0, 1000, 0, 0, 0, 0, 0, 0, 0, 1000, 0, 0, 0, 0, 0, 0, 0, 1000, 0, 0, 0, 0, 0, 0, 0]```\r\n\r\nThis way I can scroll my index using 4 different (non-empty) slices but I had to create 32 contexts which is not ideal.\r\n\r\nI think this is a bug. It also happens on a real production cluster with 3 nodes and index with replica 1.\r\n\r\nI tried to use a date as slice.field\r\n```\r\n\"slice\": {\r\n        \"field\": \"created_at\",\r\n```\r\nbut it did not help.\r\n\r\n**Steps to reproduce**:\r\n\r\nI can't share my mapping but there is nothing special in there. here is the settings part\r\n```\r\n  \"settings\": {\r\n    \"number_of_shards\": 8,\r\n    \"number_of_replicas\": 1, (or 0)\r\n    \"max_result_window\": 50000,\r\n    \"codec\": \"best_compression\",\r\n```\r\n# Scenario 1 (8 slices)\r\nthen you create the scroll 0:\r\n```\r\ncurl -XPOST \"http://localhost:9202/products_dev/_search?scroll=10m\" -H 'Content-Type: application/json' -d '{\"slice\": {\"field\": \"created_at\", \"id\": 0, \"max\": 8}, \"size\": 1000}' | jq '.hits.total.value'\r\n``` \r\n=> should contain all the documents in your index\r\n\r\nthen you create the scroll 1:\r\n```\r\n curl -XPOST \"http://localhost:9202/products_dev/_search?scroll=10m\" -H 'Content-Type: application/json' -d '{\"slice\": {\"field\": \"created_at\", \"id\": 1, \"max\": 8}, \"size\": 1000}' | jq '.hits.total.value'\r\n``` \r\n=> should return 0 result\r\nscroll 2,3,4,5,6,7 should return 0 result as well\r\n\r\n# Scenario 2 (16 slices)\r\n\r\nyou create the scroll 0:\r\n```\r\ncurl -XPOST \"http://localhost:9202/products_dev/_search?scroll=10m\" -H 'Content-Type: application/json' -d '{\"slice\": {\"field\": \"created_at\", \"id\": 0, \"max\": 16}, \"size\": 1000}' | jq '.hits.total.value'\r\n```\r\n=> should contain half of all the documents in your index\r\nscroll 1,2,3,4,5,6,7 should return 0 result\r\n\r\nthen you create the scroll 8:\r\n```\r\ncurl -XPOST \"http://localhost:9202/products_dev/_search?scroll=10m\" -H 'Content-Type: application/json' -d '{\"slice\": {\"field\": \"created_at\", \"id\": 8, \"max\": 16}, \"size\": 1000}' | jq '.hits.total.value'\r\n``` \r\n=> should contain half of all the documents in your index\r\nscroll 9,10,11,12,13,14,15 should return 0 result as well","closed_by":{"login":"casertap","id":284394,"node_id":"MDQ6VXNlcjI4NDM5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/284394?v=4","gravatar_id":"","url":"https://api.github.com/users/casertap","html_url":"https://github.com/casertap","followers_url":"https://api.github.com/users/casertap/followers","following_url":"https://api.github.com/users/casertap/following{/other_user}","gists_url":"https://api.github.com/users/casertap/gists{/gist_id}","starred_url":"https://api.github.com/users/casertap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/casertap/subscriptions","organizations_url":"https://api.github.com/users/casertap/orgs","repos_url":"https://api.github.com/users/casertap/repos","events_url":"https://api.github.com/users/casertap/events{/privacy}","received_events_url":"https://api.github.com/users/casertap/received_events","type":"User","site_admin":false},"performed_via_github_app":null}