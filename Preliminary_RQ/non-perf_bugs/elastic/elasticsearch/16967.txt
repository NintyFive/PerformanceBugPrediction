{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16967","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16967/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16967/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16967/events","html_url":"https://github.com/elastic/elasticsearch/issues/16967","id":138643620,"node_id":"MDU6SXNzdWUxMzg2NDM2MjA=","number":16967,"title":"NullPointerException when multiple zones are used","user":{"login":"ghorkov","id":17644190,"node_id":"MDQ6VXNlcjE3NjQ0MTkw","avatar_url":"https://avatars1.githubusercontent.com/u/17644190?v=4","gravatar_id":"","url":"https://api.github.com/users/ghorkov","html_url":"https://github.com/ghorkov","followers_url":"https://api.github.com/users/ghorkov/followers","following_url":"https://api.github.com/users/ghorkov/following{/other_user}","gists_url":"https://api.github.com/users/ghorkov/gists{/gist_id}","starred_url":"https://api.github.com/users/ghorkov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ghorkov/subscriptions","organizations_url":"https://api.github.com/users/ghorkov/orgs","repos_url":"https://api.github.com/users/ghorkov/repos","events_url":"https://api.github.com/users/ghorkov/events{/privacy}","received_events_url":"https://api.github.com/users/ghorkov/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"assignees":[{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2016-03-05T04:44:27Z","updated_at":"2018-02-14T13:48:51Z","closed_at":"2016-06-30T09:44:55Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.1.2\n**JVM version**:1.8.0_74\n**OS version**:Linux 3.16.0-4-amd64 #1 SMP Debian 3.16.7-ckt20-1+deb8u3 (2016-01-17) x86_64 GNU/Linux\n\n**Description of the problem including expected versus actual behavior**:\nGCE Discovery is not working when multiple zones are used. I followed the steps here: https://www.elastic.co/guide/en/elasticsearch/plugins/current/cloud-gce-usage-discovery-zones.html\nI have tested my configuration by changing the configuration file to use 1 zone and GCE discovery works correctly and the nodes can communicate correctly. As soon as I add a second zone the nodes stop communicating to each other. \n\nI was expecting to configure all nodes to communicate with each other across all Google Cloud zones.  If I need a new node in a different zone I could clone my existing instance template and move it to the new zone and communication between nodes will happen automatically across all zones.\n\n**Steps to reproduce**:\n1. Install Elastic 2.1.2 +  GCE plugin for 2 Linux instances in the Google Cloud\n2. Configure one of the instances to use multiple zones\n\n**Provide logs (if relevant)**:\n\n```\n[2016-03-04 13:25:35,730][WARN ][discovery.gce ] [Firebrand] Exception caught during discovery java.lang.NullPointerException : null\n[2016-03-04 13:25:35,732][TRACE][discovery.gce ] [Firebrand] Exception caught during discovery\njava.lang.NullPointerException\nat com.google.common.collect.Iterables$3.transform(Iterables.java:512)\nat com.google.common.collect.Iterables$3.transform(Iterables.java:509)\nat com.google.common.collect.TransformedIterator.next(TransformedIterator.java:48)\nat com.google.common.collect.Iterators$5.hasNext(Iterators.java:548)\nat org.elasticsearch.common.util.CollectionUtils.iterableAsArrayList(CollectionUtils.java:390)\nat org.elasticsearch.cloud.gce.GceComputeServiceImpl.instances(GceComputeServiceImpl.java:97)\nat org.elasticsearch.discovery.gce.GceUnicastHostsProvider.buildDynamicNodes(GceUnicastHostsProvider.java:123)\nat org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.sendPings(UnicastZenPing.java:335)\nat org.elasticsearch.discovery.zen.ping.unicast.UnicastZenPing.ping(UnicastZenPing.java:240)\nat org.elasticsearch.discovery.zen.ping.ZenPingService.ping(ZenPingService.java:106)\nat org.elasticsearch.discovery.zen.ping.ZenPingService.pingAndWait(ZenPingService.java:84)\nat org.elasticsearch.discovery.zen.ZenDiscovery.findMaster(ZenDiscovery.java:879)\nat org.elasticsearch.discovery.zen.ZenDiscovery.innerJoinCluster(ZenDiscovery.java:335)\nat org.elasticsearch.discovery.zen.ZenDiscovery.access$5000(ZenDiscovery.java:75)\nat org.elasticsearch.discovery.zen.ZenDiscovery$JoinThreadControl$1.run(ZenDiscovery.java:1236)\nat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nat java.lang.Thread.run(Thread.java:745)\n[2016-03-04 13:25:35,743][DEBUG][discovery.gce ] [Firebrand] 0 node(s) added\n```\n\nMy configuration yml file:\n\n```\ncluster.name: elastic\nnetwork.host: 0.0.0.0\nhttp.port: 9201\nhttp.cors.enabled : true\nhttp.cors.allow-origin : /.*/\ntransport.tcp.port: 9301\ncloud:\n  gce:\n      project_id: app\n      zone: [\"asia-east1-a\", \"us-central1-a\"]\ndiscovery:\n      type: gce\nshield.enabled: false\nreadonlyrest:\n    enable: true\n    response_if_req_forbidden: Not found\n    access_control_rules:\n\n    - name: Accept only requests with api keys\n      type: allow\n      api_keys: [XXX]\n      methods: [GET,POST,PUT,DELETE,OPTIONS]\n```\n\nBy the way: I've also configured the metadata es_port=9301\n\nGCE discovery only works if the zone property is changed to one of the following:\n\n```\nzone: [\"asia-east1-a\"] \nzone: asia-east1-a\n```\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}