{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48773","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48773/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48773/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48773/events","html_url":"https://github.com/elastic/elasticsearch/issues/48773","id":515697496,"node_id":"MDU6SXNzdWU1MTU2OTc0OTY=","number":48773,"title":"Role mappings do not warn about invalid role_template entries","user":{"login":"legrego","id":3493255,"node_id":"MDQ6VXNlcjM0OTMyNTU=","avatar_url":"https://avatars2.githubusercontent.com/u/3493255?v=4","gravatar_id":"","url":"https://api.github.com/users/legrego","html_url":"https://github.com/legrego","followers_url":"https://api.github.com/users/legrego/followers","following_url":"https://api.github.com/users/legrego/following{/other_user}","gists_url":"https://api.github.com/users/legrego/gists{/gist_id}","starred_url":"https://api.github.com/users/legrego/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/legrego/subscriptions","organizations_url":"https://api.github.com/users/legrego/orgs","repos_url":"https://api.github.com/users/legrego/repos","events_url":"https://api.github.com/users/legrego/events{/privacy}","received_events_url":"https://api.github.com/users/legrego/received_events","type":"User","site_admin":false},"labels":[{"id":912837951,"node_id":"MDU6TGFiZWw5MTI4Mzc5NTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authentication","name":":Security/Authentication","color":"0e8a16","default":false,"description":"Logging in, Usernames/passwords, Realms (Native/LDAP/AD/SAML/PKI/etc)"}],"state":"closed","locked":false,"assignee":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"assignees":[{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-10-31T19:44:08Z","updated_at":"2020-03-24T12:31:43Z","closed_at":"2020-03-24T07:25:44Z","author_association":"MEMBER","active_lock_reason":null,"body":"Role mappings can specify either an array of `roles`, or an array of `role_templates`. When `role_templates` are specified, they are expected to be in one of these two formats (based on my limited understanding of the code):\r\n\r\n1) `{ \"template\": { \"source\": \"some_{{mustache}}_template_string\" } }`\r\n2) `{ \"template\": { \"id\": \"stored_script_id\" } }`\r\n\r\n\r\nThe API allows users to submit invalid templates, such as:\r\n```\r\n{\r\n\t...\r\n    \"role_templates\": [\r\n        {\r\n           \"template\": {\r\n              \"someOtherField\": \"foo\"\r\n           }\r\n        },\r\n        {\r\n           \"template\": \"just a plain old string\"\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\nBut once this role mapping is created, no users who rely on role mappings will be able to authenticate:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"security_exception\",\r\n        \"reason\": \"error attempting to authenticate request\",\r\n        \"header\": {\r\n          \"WWW-Authenticate\": \"Basic realm=\\\"security\\\" charset=\\\"UTF-8\\\"\"\r\n        }\r\n      }\r\n    ],\r\n    \"type\": \"security_exception\",\r\n    \"reason\": \"error attempting to authenticate request\",\r\n    \"caused_by\": {\r\n      \"type\": \"not_x_content_exception\",\r\n      \"reason\": \"Compressor detection can only be called on some xcontent bytes or compressed xcontent bytes\"\r\n    },\r\n    \"header\": {\r\n      \"WWW-Authenticate\": \"Basic realm=\\\"security\\\" charset=\\\"UTF-8\\\"\"\r\n    }\r\n  },\r\n  \"status\": 401\r\n}\r\n```\r\n\r\nI think the API should ideally prevent these invalid templates from being stored in the first place, but I'm not sure how feasible that is.\r\n\r\n\r\nFurther, format 1 above requires `inline` scripts to be enabled, and format 2 above requires `stored` scripts to be enabled. If the required script type is disabled in Elasticsearch, then users will be unable to authenticate:\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"security_exception\",\r\n        \"reason\": \"error attempting to authenticate request\",\r\n        \"header\": {\r\n          \"WWW-Authenticate\": \"Basic realm=\\\"security\\\" charset=\\\"UTF-8\\\"\"\r\n        }\r\n      }\r\n    ],\r\n    \"type\": \"security_exception\",\r\n    \"reason\": \"error attempting to authenticate request\",\r\n    \"caused_by\": {\r\n      \"type\": \"illegal_argument_exception\",\r\n      \"reason\": \"cannot execute [inline] scripts\"\r\n    },\r\n    \"header\": {\r\n      \"WWW-Authenticate\": \"Basic realm=\\\"security\\\" charset=\\\"UTF-8\\\"\"\r\n    }\r\n  },\r\n  \"status\": 401\r\n}\r\n```\r\n\r\nI don't know how much can be done here, since node settings like `scripts.allowed_types` can be changed at any point after role mappings are created.","closed_by":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"performed_via_github_app":null}