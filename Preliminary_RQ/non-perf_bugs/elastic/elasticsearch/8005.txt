{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8005","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8005/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8005/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8005/events","html_url":"https://github.com/elastic/elasticsearch/issues/8005","id":45059735,"node_id":"MDU6SXNzdWU0NTA1OTczNQ==","number":8005,"title":"[Aggregation] Ordering buckets by their top document's score","user":{"login":"pandora2000","id":436401,"node_id":"MDQ6VXNlcjQzNjQwMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/436401?v=4","gravatar_id":"","url":"https://api.github.com/users/pandora2000","html_url":"https://github.com/pandora2000","followers_url":"https://api.github.com/users/pandora2000/followers","following_url":"https://api.github.com/users/pandora2000/following{/other_user}","gists_url":"https://api.github.com/users/pandora2000/gists{/gist_id}","starred_url":"https://api.github.com/users/pandora2000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pandora2000/subscriptions","organizations_url":"https://api.github.com/users/pandora2000/orgs","repos_url":"https://api.github.com/users/pandora2000/repos","events_url":"https://api.github.com/users/pandora2000/events{/privacy}","received_events_url":"https://api.github.com/users/pandora2000/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-10-07T02:10:16Z","updated_at":"2014-10-15T15:31:01Z","closed_at":"2014-10-15T15:31:01Z","author_association":"NONE","active_lock_reason":null,"body":"Thank you for developing Elasticsearch! I'm using Elasticsearch for my web service, and it's great :)\n\nNow, I want to renew my service, and I want to order buckets (grouped by `iid_or_id`) by their top `source_priority` document's score.\n\nFinally, I come up with the solution by using `1.4.0.Beta1` feature `scripted metric aggregation`.\n\n``` rb\n  {\n    query: { match_all: {} },\n    size: 0,\n    aggs: {\n      group_by_iid_or_id: {\n        terms: {\n          field: 'iid_or_id',\n          order: { max_priority_score: 'desc' },\n          size: 0\n        },\n        aggs: {\n          top_hit: {\n            top_hits: {\n              sort: [{ source_priority: { order: 'desc' } }],\n              size: 1\n            }\n          },\n          max_priority_score: {\n            scripted_metric: {\n              init_script: \"_agg['p'] = -1; _agg['s'] = 0\",\n              map_script: \"if (doc['source_priority'].value > _agg['p']) { _agg['p'] = doc['source_priority'].value; _agg['s'] = _score }\",\n              reduce_script: \"p = -1; s = 0; for (a in _aggs) { if (a['p'] > p) { p = a['p']; s = a['s'] } }; return s\"\n            }\n          }\n        }\n      }\n    }\n  }\n```\n\nBut this fails with the following error.\n\n```\n{\"error\":\"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[OeQB_cJkRCmTDi4CbOlMfw][items_test][0]: AggregationExecutionException[Invalid terms aggregation order path [max_priority_score]. Terms buckets can only be sorted on a sub-aggregator path that is built out of zero or more single-bucket aggregations within the path and a final single-bucket or a metrics aggregation at the path end.]}{[OeQB_cJkRCmTDi4CbOlMfw][items_test][1]: AggregationExecutionException[Invalid terms aggregation order path [max_priority_score]. Terms buckets can only be sorted on a sub-aggregator path that is built out of zero or more single-bucket aggregations within the path and a final single-bucket or a metrics aggregation at the path end.]}{[OeQB_cJkRCmTDi4CbOlMfw][items_test][2]: AggregationExecutionException[Invalid terms aggregation order path [max_priority_score]. Terms buckets can only be sorted on a sub-aggregator path that is built out of zero or more single-bucket aggregations within the path and a final single-bucket or a metrics aggregation at the path end.]}{[OeQB_cJkRCmTDi4CbOlMfw][items_test][3]: AggregationExecutionException[Invalid terms aggregation order path [max_priority_score]. Terms buckets can only be sorted on a sub-aggregator path that is built out of zero or more single-bucket aggregations within the path and a final single-bucket or a metrics aggregation at the path end.]}{[OeQB_cJkRCmTDi4CbOlMfw][items_test][4]: AggregationExecutionException[Invalid terms aggregation order path [max_priority_score]. Terms buckets can only be sorted on a sub-aggregator path that is built out of zero or more single-bucket aggregations within the path and a final single-bucket or a metrics aggregation at the path end.]}]\",\"status\":500}\n```\n\nI think this because `max_priority_score` seems to be invalid order path, but I don't know how to solve this. Or I want to know another way to solve my original problem.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}