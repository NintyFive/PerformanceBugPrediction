[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/291855076","html_url":"https://github.com/elastic/elasticsearch/issues/23904#issuecomment-291855076","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23904","id":291855076,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MTg1NTA3Ng==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-04-05T13:06:19Z","updated_at":"2017-04-05T13:06:19Z","author_association":"CONTRIBUTOR","body":"The issue here is that a recovery can be cancelled (and thus restarted) even though the shard state has already been marked as `POST_RECOVERY` and the master possibly notified that recovery is completed. This can result in a `IndexShard` state where the `shardRouting` field has a `ShardRouting` object with state `STARTED` and the `IndexShardState` state is `RECOVERING`.\r\n\r\nRelevant log lines:\r\n\r\n```\r\n[2017-04-04T07:55:06,259][DEBUG][o.e.i.s.IndexShard       ] [node_t0] [test][6] state: [RECOVERING]->[POST_RECOVERY], reason [peer recovery done]\r\n[2017-04-04T07:55:06,259][DEBUG][o.e.c.a.s.ShardStateAction] [node_t0] [test][6] sending [internal:cluster/shard/started] to [-Yuj9lf-SBukW3QmsKsd5Q] for shard entry [shard id [[test][6]], allocation id [JP-MRVCbR0KhsLfpxI6NxQ], primary term [0], message [after peer recovery]]\r\n[2017-04-04T07:55:06,259][TRACE][o.e.i.r.PeerRecoveryTargetService] [node_t0] [test][6] recovery completed from {node_t5}{pU6m0yd6S2iDZ99S-VJLWA}{XUt-RNEFR2eWoSmqKvAlEA}{local}{local[340]}{color=red}, took[957ms]\r\n   phase1: recovered_files [1] with total_size of [130b], took [0s], throttling_wait [0s]\r\n         : reusing_files   [0] with total_size of [0b]\r\n   phase2: start took [189ms]\r\n         : recovered [15] transaction log operations, took [43ms]\r\n\r\n[2017-04-04T07:55:06,268][TRACE][o.e.i.r.PeerRecoveryTargetService] [node_t0] [test][6] canceled recovery from {node_t5}{pU6m0yd6S2iDZ99S-VJLWA}{XUt-RNEFR2eWoSmqKvAlEA}{local}{local[340]}{color=red}, id [1177] (reason [recovery source node changed])\r\n[2017-04-04T07:55:06,268][DEBUG][o.e.i.c.IndicesClusterStateService] [node_t0] [test][6] removing shard (recovery source changed), current [{node_t5}{pU6m0yd6S2iDZ99S-VJLWA}{XUt-RNEFR2eWoSmqKvAlEA}{local}{local[340]}{color=red}], global [{node_t2}{X7ELsMwOREaXxzUy7rFDWg}{3rAUw9LgSWyqq1XiOtO4Cg}{local}{local[342]}{color=blue}], shard [[test][6], node[0Wc3MatcR1eQSLHl-ecGnQ], relocating [Q0gM5AaxTDKSJqDjLGATNg], [R], recovery_source[peer recovery], s[INITIALIZING], a[id=JP-MRVCbR0KhsLfpxI6NxQ, rId=tRrvLT2wTqi4fLcSa6w4BA]])\r\n[2017-04-04T07:55:06,268][DEBUG][o.e.i.IndexService       ] [node_t0] [test] [6] closing... (reason: [removing shard (recovery source node changed)])\r\n[2017-04-04T07:55:06,268][DEBUG][o.e.i.s.IndexShard       ] [node_t0] [test][6] state: [POST_RECOVERY]->[CLOSED], reason [removing shard (recovery source node changed)]\r\n\r\n[2017-04-04T07:55:06,274][DEBUG][o.e.i.s.IndexShard       ] [node_t0] [test][6] state: [CREATED]\r\n[2017-04-04T07:55:06,275][DEBUG][o.e.i.s.IndexShard       ] [node_t0] [test][6] state: [CREATED]->[RECOVERING], reason [from {node_t2}{X7ELsMwOREaXxzUy7rFDWg}{3rAUw9LgSWyqq1XiOtO4Cg}{local}{local[342]}{color=blue}]\r\n\r\n[2017-04-04T07:55:06,451][DEBUG][o.e.c.a.s.ShardStateAction] [node_t3] [test][6] starting shard [test][6], node[0Wc3MatcR1eQSLHl-ecGnQ], relocating [Q0gM5AaxTDKSJqDjLGATNg], [R], recovery_source[peer recovery], s[INITIALIZING], a[id=JP-MRVCbR0KhsLfpxI6NxQ, rId=tRrvLT2wTqi4fLcSa6w4BA] (shard started task: [shard id [[test][6]], allocation id [JP-MRVCbR0KhsLfpxI6NxQ], primary term [0], message [after peer recovery]])\r\n\r\n[2017-04-04T07:55:06,504][DEBUG][o.e.c.s.ClusterService   ] [node_t0] cluster state updated, version [21], source [zen-disco-receive(from master [master {node_t3}{-Yuj9lf-SBukW3QmsKsd5Q}{NUPAScmeTaONvTHLQ_xx-w}{local}{local[343]}{color=red} committed version [21]])]\r\n\r\n// here, IndexShardState is recovering, not started. The ShardRouting is now silently moved to STARTED while the IndexShardState is RECOVERING (ouch)\r\n\r\n[2017-04-04T07:55:06,518][TRACE][o.e.i.r.PeerRecoverySourceService] [node_t2] [test][6] recovery [phase1] to {node_t0}{0Wc3MatcR1eQSLHl-ecGnQ}{xRopKVWjRam2fQqbLivXiw}{local}{local[339]}{color=blue}: prepare remote engine for translog\r\n```","performed_via_github_app":null}]