{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30021","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30021/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30021/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30021/events","html_url":"https://github.com/elastic/elasticsearch/issues/30021","id":317453981,"node_id":"MDU6SXNzdWUzMTc0NTM5ODE=","number":30021,"title":"How to perform security migrations when security is not licensed","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-02-10T18:00:26Z","updated_at":"2018-08-02T07:12:51Z","closed_at":"2018-08-02T07:12:51Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @tvernum:*\n\nIt is possible to have a `.security` index with meaningful data, but have security turned off due to either:\r\n\r\n1. installing an incompatible license, _or_\r\n2. by setting `xpack.security.enabled: false`\r\n\r\nIf the cluster is upgraded while in this state we treat these two scenarios differently:\r\n\r\n- In the first case we will upgrade the security index template & mappings to the current (new) version. \r\n- In the second case, none of the relevant security components are created, so no upgrades happen.\r\n\r\nI think these are probably the right decisions, but they create a complication for upgrades to security data.\r\n\r\nIn LINK REDACTED and LINK REDACTED we make changes to the data stored in the `.security` index immediately before upgrading the index mapping. We rely on the version number in the old mapping to determine which (if any) migrations should apply.\r\n\r\nBecause we upgrade the mappings in the first scenario, we need to also perform the migrations at that point, or we will never get another chance to do so (because we won't know which version we're upgrading from). **_But_**, because security is not licensed, the `SecurityActionFilter` will prevent the migration from making calls to any security actions.\r\n\r\nIn LINK REDACTED I was able to skip over the security action as it was not actually needed, but that cannot be assumed to be true in the general case, and we may need a more complete solution.\r\n\r\nMy immediate thought is that we may need to have a way to by-pass the license check in `SecurityActionFilter` when performing the migration, but I'm open to other ideas.\r\n\n\n","closed_by":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"performed_via_github_app":null}