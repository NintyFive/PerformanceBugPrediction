{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25845","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25845/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25845/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25845/events","html_url":"https://github.com/elastic/elasticsearch/issues/25845","id":244897345,"node_id":"MDU6SXNzdWUyNDQ4OTczNDU=","number":25845,"title":"Sum Buckets Aggregation does not work with Nested / Reverse Nested Aggregation","user":{"login":"ggarciao","id":1259730,"node_id":"MDQ6VXNlcjEyNTk3MzA=","avatar_url":"https://avatars2.githubusercontent.com/u/1259730?v=4","gravatar_id":"","url":"https://api.github.com/users/ggarciao","html_url":"https://github.com/ggarciao","followers_url":"https://api.github.com/users/ggarciao/followers","following_url":"https://api.github.com/users/ggarciao/following{/other_user}","gists_url":"https://api.github.com/users/ggarciao/gists{/gist_id}","starred_url":"https://api.github.com/users/ggarciao/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ggarciao/subscriptions","organizations_url":"https://api.github.com/users/ggarciao/orgs","repos_url":"https://api.github.com/users/ggarciao/repos","events_url":"https://api.github.com/users/ggarciao/events{/privacy}","received_events_url":"https://api.github.com/users/ggarciao/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-07-23T08:43:18Z","updated_at":"2019-07-31T02:17:45Z","closed_at":"2017-08-22T07:50:47Z","author_association":"NONE","active_lock_reason":null,"body":"**Environment**\r\n`FROM docker.elastic.co/elasticsearch/elasticsearch:5.4.1`\r\n\r\n**Situation:**\r\nWe have an index mapping with a nested document. On this index:\r\n-  We use a `terms aggregation` on the nested document (`nested aggregation` then `terms aggregation`).\r\n- Then we use a reverse nested aggregation to go back to the root document (`nested aggregation` then `terms aggregation `then `reverse nested aggregation`)\r\n- Back on the root document, we use a `max aggregation` (`nested aggregation` then `terms aggregation` then `reverse nested aggregation` then `max aggregation`)\r\n- Then we use the `sum bucket aggregation` to sum all the max found on the previous buckets. (a sibling aggregation of the first `nested aggregation` with `buckets_path nested aggregation > terms aggregation > reverse nested aggregation > max aggregation`)\r\n\r\n**Exceptions**\r\n`org.elasticsearch.search.aggregations.bucket.nested.InternalNested cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation`  \r\n\r\nIf you put the `sum buckets aggregation` as a sibling of the `reverse nested aggregation` you get:\r\n`org.elasticsearch.search.aggregations.bucket.nested.InternalReverseNested cannot be cast to org.elasticsearch.search.aggregations.InternalMultiBucketAggregation`\r\n\r\n**Some thoughts**\r\nI'm not an expert of the internal implementation of elasticsearch, but I think that the problem here is that the sum bucket aggregation search for the multi bucket aggregation too soon. \r\n\r\nI think that the sum bucket aggregation should allow passing through any single bucket aggregation and executing the sum on a multi bucket aggregation.\r\n\r\nI tried to think about having multi buckets aggregation in the `buckets_path` and I think it is conceptually possible if it is implemented as a reduce phase. (I haven't look at the source code, so, take it as a theoretical suggestion only)","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}