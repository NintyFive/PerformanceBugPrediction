[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259694085","html_url":"https://github.com/elastic/elasticsearch/issues/21461#issuecomment-259694085","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21461","id":259694085,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTY5NDA4NQ==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2016-11-10T13:49:22Z","updated_at":"2016-11-10T13:49:22Z","author_association":"MEMBER","body":"@jasontedor any idea on this one?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259712925","html_url":"https://github.com/elastic/elasticsearch/issues/21461#issuecomment-259712925","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21461","id":259712925,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTcxMjkyNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-10T15:04:17Z","updated_at":"2016-11-10T15:04:17Z","author_association":"MEMBER","body":"I'll take a look, thanks @spinscale.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/259989476","html_url":"https://github.com/elastic/elasticsearch/issues/21461#issuecomment-259989476","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21461","id":259989476,"node_id":"MDEyOklzc3VlQ29tbWVudDI1OTk4OTQ3Ng==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-11-11T16:02:02Z","updated_at":"2016-11-11T16:02:02Z","author_association":"MEMBER","body":"It looks like there are similar failures in another test in this suite:\n\n```\n1> [2016-11-11T12:18:48,093][INFO ][o.e.i.s.UpdateSettingsIT ] [UpdateSettingsIT#testUpdateMergeMaxThreadCount]: cleaned up after test\nFAILURE 0.22s J0 | UpdateSettingsIT.testUpdateMergeMaxThreadCount <<< FAILURES!\n   > Throwable #1: java.lang.AssertionError: \n   > Expected: an empty collection\n   >      but: <[Attempted to append to non-started appender testUpdateMergeMaxThreadCount]>\n   >    at __randomizedtesting.SeedInfo.seed([12EFA62A6A1DA08C:7C24A0F5DF787B40]:0)\n   >    at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\n   >    at org.elasticsearch.test.ESTestCase.checkStaticState(ESTestCase.java:279)\n   >    at org.elasticsearch.test.ESTestCase.ensureCleanedUp(ESTestCase.java:244)\n   >    at java.lang.Thread.run(Thread.java:745)\n```\n\nSee an example [here](https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=sles/233/consoleFull)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260012781","html_url":"https://github.com/elastic/elasticsearch/issues/21461#issuecomment-260012781","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21461","id":260012781,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDAxMjc4MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-11T17:43:06Z","updated_at":"2016-11-12T13:32:23Z","author_association":"MEMBER","body":"I took a look at this this afternoon. I do not immediately see what is going on, and the failures do not reproduce.\n\nFor now I have pushed commits so that there is an actual stack trace to look at when the offending append is made:\n- master: 9352d166024435a1f0465e73c227083e18efbd85\n- 5.x: da5af7d1f52261af0ded4d901648b7faa7022053\n- 5.0: 5ff7438c1611513c1599fd5bd9b01e2cb5e66709\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/260123408","html_url":"https://github.com/elastic/elasticsearch/issues/21461#issuecomment-260123408","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21461","id":260123408,"node_id":"MDEyOklzc3VlQ29tbWVudDI2MDEyMzQwOA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-11-12T13:54:06Z","updated_at":"2016-11-12T14:04:58Z","author_association":"MEMBER","body":"Okay, the [stack trace](https://gist.github.com/jasontedor/18d65d8123a0319c1f276a79063d3d37) gave a clue as to what is going on here:\n\n```\n  1> org.apache.logging.log4j.core.appender.AppenderLoggingException: Attempted to append to non-started appender testUpdateAutoThrottleSettings\n  1>    at org.apache.logging.log4j.core.config.AppenderControl.handleError(AppenderControl.java:142) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.AppenderControl.ensureAppenderStarted(AppenderControl.java:135) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:127) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:120) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:447) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:432) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:416) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.logParent(LoggerConfig.java:438) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:433) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:416) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:402) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.config.DefaultReliabilityStrategy.log(DefaultReliabilityStrategy.java:49) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.core.Logger.logMessage(Logger.java:146) ~[log4j-core-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.spi.ExtendedLoggerWrapper.logMessage(ExtendedLoggerWrapper.java:217) ~[log4j-api-2.7.jar:2.7]\n  1>    at org.elasticsearch.common.logging.PrefixLogger.logMessage(PrefixLogger.java:67) ~[main/:?]\n  1>    at org.apache.logging.log4j.spi.AbstractLogger.logMessageSafely(AbstractLogger.java:2091) ~[log4j-api-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:2023) ~[log4j-api-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1900) ~[log4j-api-2.7.jar:2.7]\n  1>    at org.apache.logging.log4j.spi.AbstractLogger.debug(AbstractLogger.java:452) ~[log4j-api-2.7.jar:2.7]\n  1>    at org.elasticsearch.cluster.service.ClusterService.runTasksForExecutor(ClusterService.java:765) ~[main/:?]\n  1>    at org.elasticsearch.cluster.service.ClusterService$UpdateTask.run(ClusterService.java:907) ~[main/:?]\n  1>    at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:451) ~[main/:?]\n  1>    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:238) ~[main/:?]\n  1>    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:201) ~[main/:?]\n  1>    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[?:1.8.0_92-internal]\n  1>    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[?:1.8.0_92-internal]\n  1>    at java.lang.Thread.run(Thread.java:745) ~[?:1.8.0_92-internal]\n```\n\n</details>\n\n There is a race condition. We submit a cluster state update, and the test proceeds after the master processes this cluster state update. At the end of the test, we remove the mock appender, and stop it. If the master has processed the cluster state update, but still has a log message to write, we can blow up. Namely:\n- master attempts to log `logger.debug(\"processing [{}]: took [{}] done applying updated cluster_state (version: {}, uuid: {})\", tasksSummary,\n              executionTime, newClusterState.version(), newClusterState.stateUUID());`\n- Log4j grabs a reference to the current appenders, which includes the mock appender\n- the finally statement in the test removes the mock appender, and stops it\n- Log4j iterates over the appenders, using the reference it previously grabbed, this will still include the mock appender, which is now stopped\n- :boom:\n\nI will think about a fix.\n","performed_via_github_app":null}]