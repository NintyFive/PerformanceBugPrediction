{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/13160","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13160/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13160/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/13160/events","html_url":"https://github.com/elastic/elasticsearch/issues/13160","id":103568541,"node_id":"MDU6SXNzdWUxMDM1Njg1NDE=","number":13160,"title":"bad groovy script delete-by-query makes shard unrecoverable","user":{"login":"jeremybmerrill","id":548250,"node_id":"MDQ6VXNlcjU0ODI1MA==","avatar_url":"https://avatars0.githubusercontent.com/u/548250?v=4","gravatar_id":"","url":"https://api.github.com/users/jeremybmerrill","html_url":"https://github.com/jeremybmerrill","followers_url":"https://api.github.com/users/jeremybmerrill/followers","following_url":"https://api.github.com/users/jeremybmerrill/following{/other_user}","gists_url":"https://api.github.com/users/jeremybmerrill/gists{/gist_id}","starred_url":"https://api.github.com/users/jeremybmerrill/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeremybmerrill/subscriptions","organizations_url":"https://api.github.com/users/jeremybmerrill/orgs","repos_url":"https://api.github.com/users/jeremybmerrill/repos","events_url":"https://api.github.com/users/jeremybmerrill/events{/privacy}","received_events_url":"https://api.github.com/users/jeremybmerrill/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2015-08-27T18:34:33Z","updated_at":"2015-08-28T11:44:11Z","closed_at":"2015-08-28T11:41:13Z","author_association":"NONE","active_lock_reason":null,"body":"An index is now unrecoverable because I ran a Groovyscript delete-by-query against it, and the query errored out. That query is below.\n\n``````\ncurl -XDELETE 'http://my_elasticsearch_host/my_index_name/my_type/_query' -d '{\n \"query\": {\n   \"filtered\": {\n     \"filter\": {\n       \"script\": {\n         \"script\": \"_source.body.length() == 0\"\n       }\n     }\n   }\n }\n}\n'````\nMy goal was to delete all records whose `body` field was an empty string. The error I get after restarting the elasticsearch server is:\n``````\n\n[2015-08-27 18:30:11,309][WARN ][cluster.action.shard     ] [Schemer] [daily_worker][1] received shard failed for [daily_worker][1], node[6fa-STJgTT6z-uQbzIDErA], [P], s[INITIALIZING], unassigned_info[[reason=ALLOCATION_FAILED], at[2015-08-27T18:30:11.274Z], details[shard failure [failed recovery][IndexShardGatewayRecoveryException[[daily_worker][1] failed to recover shard]; nested: RefreshFailedEngineException[[daily_worker][1] Refresh failed]; nested: GroovyScriptExecutionException[NullPointerException[Cannot invoke method length() on null object]]; ]]], indexUUID [AmmH0azOQzOi2wkzy_H_lw], reason [shard failure [failed recovery][IndexShardGatewayRecoveryException[[daily_worker][1] failed to recover shard]; nested: RefreshFailedEngineException[[daily_worker][1] Refresh failed]; nested: GroovyScriptExecutionException[NullPointerException[Cannot invoke method length() on null object]]; ]]\n\n```\nCluster status is \n```\n\n{\n\n```\n\"status\": \"red\",\n\"number_of_shards\": 5,\n\"number_of_replicas\": 1,\n\"active_primary_shards\": 0,\n\"active_shards\": 0,\n\"relocating_shards\": 0,\n\"initializing_shards\": 3,\n\"unassigned_shards\": 7\n```\n\n},````\n\nIdeally I'd like to be able to recover the index. Please let me know what I can do to fix this; feel free to ask away if there's any more information I can give you about this to help you fix the problem.\n\nEdit: Probably wouldn't hurt to note that I'm running ES 1.7.0. Lucene's CheckIndex command says there's no problems with any of the shards in my index.\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}