{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/61637","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61637/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61637/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61637/events","html_url":"https://github.com/elastic/elasticsearch/issues/61637","id":687289680,"node_id":"MDU6SXNzdWU2ODcyODk2ODA=","number":61637,"title":"Bulk API does not accept charset with application/x-ndjson in Content-Type header","user":{"login":"mieciu","id":2097938,"node_id":"MDQ6VXNlcjIwOTc5Mzg=","avatar_url":"https://avatars0.githubusercontent.com/u/2097938?v=4","gravatar_id":"","url":"https://api.github.com/users/mieciu","html_url":"https://github.com/mieciu","followers_url":"https://api.github.com/users/mieciu/followers","following_url":"https://api.github.com/users/mieciu/following{/other_user}","gists_url":"https://api.github.com/users/mieciu/gists{/gist_id}","starred_url":"https://api.github.com/users/mieciu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mieciu/subscriptions","organizations_url":"https://api.github.com/users/mieciu/orgs","repos_url":"https://api.github.com/users/mieciu/repos","events_url":"https://api.github.com/users/mieciu/events{/privacy}","received_events_url":"https://api.github.com/users/mieciu/received_events","type":"User","site_admin":false},"labels":[{"id":152517143,"node_id":"MDU6TGFiZWwxNTI1MTcxNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/REST%20API","name":":Core/Infra/REST API","color":"0e8a16","default":false,"description":"REST infrastructure and utilities"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967495446,"node_id":"MDU6TGFiZWwxOTY3NDk1NDQ2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Infra","name":"Team:Core/Infra","color":"fef2c0","default":false,"description":"Meta label for core/infra team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-08-27T14:29:01Z","updated_at":"2020-08-27T18:16:39Z","closed_at":"2020-08-27T18:16:26Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n```\r\nVersion: 6.8.13-SNAPSHOT, Build: default/tar/37825c3/2020-08-26T14:42:26.771178Z, JVM: 1.8.0_262\r\n```\r\n\r\n**JVM version** (`java -version`):\r\n```\r\nopenjdk version \"1.8.0_262\"\r\nOpenJDK Runtime Environment (build 1.8.0_262-b10)\r\nOpenJDK 64-Bit Server VM (build 25.262-b10, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux ce0caf533cff 4.15.0-1066-aws #70-Ubuntu SMP Wed Apr 8 16:10:41 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nTrying to index data via `/_bulk` API with the `Content-Type: application/x-ndjson; charset=ISO-8859-1` header results in the `406` error:\r\n```\r\n{\"error\":\"Content-Type header [application/x-ndjson; charset=ISO-8859-1] is not supported\",\"status\":406}\r\n```\r\n\r\nTo have this working I can either strip the `charset` part **OR** use `Content-Type: application/json; charset=ISO-8859-1` which is technically incorrect, because my payload **is truly ndjson**:\r\n```\r\nPUT /_bulk HTTP/1.1\r\nAuthorization: Basic <TOKEN>\r\nAccept: */*\r\nContent-Type: application/x-ndjson; charset=ISO-8859-1\r\nContent-Length: 1595845\r\nHost: 127.0.0.1:5000\r\nConnection: Keep-Alive\r\nUser-Agent: Apache-HttpClient/4.5.10 (Java/1.8.0_252)\r\nAccept-Encoding: gzip,deflate\r\n\r\n{\"index\":{\"_index\":\"test-ml\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595938329181,\"accept\":285308,\"deny\":2173,\"host\":\"server_1\",\"response\":3.526092,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595938389181,\"accept\":178321,\"deny\":2717,\"host\":\"server_1\",\"response\":3.2162445,\"service\":\"app_3\"}\r\n[...]\r\n```\r\n\r\nDocumentation for `6.8` clearly states the need for `application/x-ndjson` header though (ref: https://www.elastic.co/guide/en/elasticsearch/reference/6.8/docs-bulk.html). \r\n\r\n**When testing on `7.9` everything works fine**, `Content-Type: application/x-ndjson; charset=ISO-8859-1` header is accepted and data is being loaded without any issues. This PR could be related https://github.com/elastic/elasticsearch/pull/45130/files.\r\n\r\n**Steps to reproduce**:\r\n\r\nFull instruction below:\r\n<details>\r\n\r\n1) Create index\r\n```\r\nHOST_URL=https://my-host.my-domain.com:9243\r\nBASIC_AUTH=elastic:<PASS>\r\n\r\ncurl -k  -H 'Content-Type: application/json' -u ${BASIC_AUTH} -XPUT ${HOST_URL}/test-ml2 -d '\r\n{\r\n    \"mappings\": {\r\n    \"_doc\" : {\r\n        \"properties\": {\r\n          \"@timestamp\": {\r\n            \"type\": \"date\"\r\n          },\r\n          \"accept\": {\r\n            \"type\": \"long\"\r\n          },\r\n          \"deny\": {\r\n            \"type\": \"long\"\r\n          },\r\n          \"host\": {\r\n            \"type\": \"keyword\"\r\n          },\r\n          \"response\": {\r\n            \"type\": \"float\"\r\n          },\r\n          \"service\": {\r\n            \"type\": \"keyword\"\r\n          },\r\n          \"total\": {\r\n            \"type\": \"long\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n}\r\n'\r\n```\r\n\r\n2) Index data with `application/x-ndjson` - **IT WILL FAIL WITH 406**\r\n```\r\ncurl -k  -H 'Content-Type: application/x-ndjson; charset=ISO-8859-1' -u ${BASIC_AUTH} -XPUT ${HOST_URL}/_bulk --data-binary '\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855011420,\"accept\":244647,\"deny\":79,\"host\":\"server_1\",\"response\":0.40575957,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855071420,\"accept\":483733,\"deny\":391,\"host\":\"server_1\",\"response\":2.5463665,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855131420,\"accept\":231359,\"deny\":4609,\"host\":\"server_1\",\"response\":2.2355824,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855191420,\"accept\":272323,\"deny\":4106,\"host\":\"server_1\",\"response\":3.9306116,\"service\":\"app_3\"}\r\n'\r\n```\r\n3) Index data with `application/json` - it will succeed, but that's not what docs recommend doing:\r\n```\r\ncurl -k  -H 'Content-Type: application/json; charset=ISO-8859-1' -u ${BASIC_AUTH} -XPUT ${HOST_URL}/_bulk --data-binary '\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855011420,\"accept\":244647,\"deny\":79,\"host\":\"server_1\",\"response\":0.40575957,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855071420,\"accept\":483733,\"deny\":391,\"host\":\"server_1\",\"response\":2.5463665,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855131420,\"accept\":231359,\"deny\":4609,\"host\":\"server_1\",\"response\":2.2355824,\"service\":\"app_3\"}\r\n{\"index\":{\"_index\":\"test-ml2\",\"_type\":\"_doc\"}}\r\n{\"@timestamp\":1595855191420,\"accept\":272323,\"deny\":4106,\"host\":\"server_1\",\"response\":3.9306116,\"service\":\"app_3\"}\r\n'\r\n```\r\n</details>\r\n\r\nNote that charset could be `charset=UTF-8`, the value doesn't really matter here (but yes, as @DaveCTurner pointed out JSON should technically be UTF-8 https://tools.ietf.org/html/rfc7159#section-8.1) \r\n\r\n","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}