{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25746/events","html_url":"https://github.com/elastic/elasticsearch/issues/25746","id":243350763,"node_id":"MDU6SXNzdWUyNDMzNTA3NjM=","number":25746,"title":"Tokens generated after token filters ignore match query operator option","user":{"login":"pmishev","id":5188763,"node_id":"MDQ6VXNlcjUxODg3NjM=","avatar_url":"https://avatars1.githubusercontent.com/u/5188763?v=4","gravatar_id":"","url":"https://api.github.com/users/pmishev","html_url":"https://github.com/pmishev","followers_url":"https://api.github.com/users/pmishev/followers","following_url":"https://api.github.com/users/pmishev/following{/other_user}","gists_url":"https://api.github.com/users/pmishev/gists{/gist_id}","starred_url":"https://api.github.com/users/pmishev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pmishev/subscriptions","organizations_url":"https://api.github.com/users/pmishev/orgs","repos_url":"https://api.github.com/users/pmishev/repos","events_url":"https://api.github.com/users/pmishev/events{/privacy}","received_events_url":"https://api.github.com/users/pmishev/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-07-17T10:18:45Z","updated_at":"2017-08-21T12:56:53Z","closed_at":"2017-08-21T12:56:53Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 2.4, 5.5\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 1.8.0_131\r\n\r\n**OS version**: 4.4.0-81-generic #104-Ubuntu x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen `\"operator\": \"and\"` is specified in a match query, ALL tokens generated by the search analyzer should be looked for in the indexed tokens.\r\nHowever tokens generated by token filters are behaving differently. It is looking for ANY of those tokens.\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\nPUT /test1\r\n{\r\n  \"settings\": {\r\n    \"analysis\": {\r\n      \"filter\": {\r\n        \"pattern_filter\": {\r\n          \"type\": \"pattern_capture\",\r\n          \"patterns\": [\r\n            \"(\\\\p{L}+)\"\r\n          ]\r\n        }\r\n      },\r\n      \"analyzer\": {\r\n        \"my_analyzer1\": {\r\n          \"tokenizer\": \"uax_url_email\",\r\n          \"filter\": [\r\n            \"pattern_filter\"\r\n          ]\r\n        },\r\n        \"my_analyzer2\": {\r\n          \"tokenizer\": \"standard\"\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"emails\": {\r\n      \"properties\": {\r\n        \"email1\": {\r\n          \"type\": \"string\",\r\n          \"analyzer\": \"my_analyzer1\"\r\n        },\r\n        \"email2\": {\r\n          \"type\": \"string\",\r\n          \"analyzer\": \"my_analyzer2\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n```\r\nGET test1/emails/_validate/query?explain\r\n{\r\n  \"query\": {\r\n    \"match\": {\r\n      \"email2\": {\r\n        \"query\": \"somebody@we-example.com\",\r\n        \"operator\": \"and\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\ngives `\"explanation\": \"+(+email2:somebody +email2:we +email2:example.com) #ConstantScore(+ConstantScore(_type:emails))\"`, which is correct\r\n\r\n```\r\nGET test1/emails/_validate/query?explain\r\n{\r\n  \"query\": {\r\n    \"match\": {\r\n      \"email1\": {\r\n        \"query\": \"somebody@we-example.com\",\r\n        \"operator\": \"and\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\ngives `\"explanation\": \"+(email1:somebody@we-example.com email1:somebody email1:we email1:example email1:com) #ConstantScore(+ConstantScore(_type:emails))\"` in ES 2.4\r\n\r\nor `\"explanation\": \"+Synonym(email1:com email1:example email1:somebody email1:somebody@we-example.com email1:we) #_type:emails\"` in ES 5.5\r\n\r\nI couldn't find a reason for such behaviour documented anywhere and I believe it is wrong and the correct explanation should be:\r\n`+(+email1:somebody@we-example.com +email1:somebody +email1:we +email1:example +email1:com) #ConstantScore(+ConstantScore(_type:emails))`","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}