{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/58496","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58496/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58496/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58496/events","html_url":"https://github.com/elastic/elasticsearch/issues/58496","id":644611565,"node_id":"MDU6SXNzdWU2NDQ2MTE1NjU=","number":58496,"title":"[Snapshot & Restore] Issue with restoring a snapshot that contains a data stream","user":{"login":"jloleysens","id":8155004,"node_id":"MDQ6VXNlcjgxNTUwMDQ=","avatar_url":"https://avatars3.githubusercontent.com/u/8155004?v=4","gravatar_id":"","url":"https://api.github.com/users/jloleysens","html_url":"https://github.com/jloleysens","followers_url":"https://api.github.com/users/jloleysens/followers","following_url":"https://api.github.com/users/jloleysens/following{/other_user}","gists_url":"https://api.github.com/users/jloleysens/gists{/gist_id}","starred_url":"https://api.github.com/users/jloleysens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jloleysens/subscriptions","organizations_url":"https://api.github.com/users/jloleysens/orgs","repos_url":"https://api.github.com/users/jloleysens/repos","events_url":"https://api.github.com/users/jloleysens/events{/privacy}","received_events_url":"https://api.github.com/users/jloleysens/received_events","type":"User","site_admin":false},"labels":[{"id":1915711992,"node_id":"MDU6TGFiZWwxOTE1NzExOTky","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Data%20streams","name":":Core/Features/Data streams","color":"0e8a16","default":false,"description":""},{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"},{"id":1967496670,"node_id":"MDU6TGFiZWwxOTY3NDk2Njcw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Distributed","name":"Team:Distributed","color":"fef2c0","default":false,"description":"Meta label for distributed team"},{"id":1967500052,"node_id":"MDU6TGFiZWwxOTY3NTAwMDUy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:UI","name":"Team:UI","color":"fef2c0","default":false,"description":"Meta label for UI team"},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-06-24T13:22:56Z","updated_at":"2020-06-29T07:59:27Z","closed_at":"2020-06-29T07:59:27Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): Latest `elasticsearch-oss-8.0.0-SNAPSHOT-darwin-x86_64.tar.gz`\r\n\r\n**JVM version** (`java -version`): 12.0.2\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Darwin 19.5.0 Darwin Kernel Version 19.5.0: Tue May 26 20:41:44 PDT 2020; root:xnu-6153.121.2~2/RELEASE_X86_64 x86_64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen restoring snapshot that contains a data stream that existed on the cluster previously (in my case `test-data-stream1`), the data stream can not be deleted and responds with:\r\n\r\n```json\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"index_not_found_exception\",\r\n        \"reason\": \"no such index [.ds-test-data-stream1-000001]\",\r\n        \"index_uuid\": \"OYWmUQ64RhqdVSopJpd0kw\",\r\n        \"index\": \".ds-test-data-stream1-000001\"\r\n      }\r\n    ],\r\n    \"type\": \"index_not_found_exception\",\r\n    \"reason\": \"no such index [.ds-test-data-stream1-000001]\",\r\n    \"index_uuid\": \"OYWmUQ64RhqdVSopJpd0kw\",\r\n    \"index\": \".ds-test-data-stream1-000001\",\r\n    \"caused_by\": {\r\n      \"type\": \"illegal_state_exception\",\r\n      \"reason\": \"index uuid doesn't match expected: [OYWmUQ64RhqdVSopJpd0kw] but got: [IAbkfRhxRxGdcQ9R-MAffQ]\"\r\n    }\r\n  },\r\n  \"status\": 404\r\n}\r\n```\r\n\r\nAdditionally, when restoring the data stream, the option to rename the indices upon restore was not reconnecting the restored data streams with the original data stream.\r\n\r\nI would expect the data stream to be restored in a manner that leaves it fully functional as it was when the snapshot was taken.\r\n\r\n**Steps to reproduce**:\r\n\r\n#### Step 1\r\n\r\nCreate a data stream.\r\n\r\nIndex Template:\r\n```json\r\nPUT /_index_template/test-data-stream\r\n{\r\n\t\"index_patterns\": [\r\n\t\t\"test-data-stream*\"\r\n\t],\r\n\t\"template\": {\r\n\t\t\"mappings\": {\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"@timestamp\": {\r\n\t\t\t\t\t\"type\": \"date\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t}\r\n\t},\r\n\t\"data_stream\": {\r\n\t\t\"timestamp_field\": \"@timestamp\"\r\n\t}\r\n}\r\n```\r\n\r\nData stream:\r\n```\r\nPUT /_data_stream/test-data-stream\r\n```\r\n\r\n\r\n#### Step 1\r\n\r\nCreate a repository and snapshot policy that will capture data streams and data stream indices into that repository in snapshots:\r\n\r\n```\r\n# Example\r\nPUT _slm/policy/test\r\n{\r\n  \"name\": \"<test-{now/d}>\",\r\n  \"schedule\": \"0 30 1 * * ?\",\r\n  \"repository\": \"test\",\r\n  \"config\": {\r\n    \"indices\": [],\r\n    \"include_global_state\": true\r\n  }\r\n}\r\n```\r\n\r\n\r\n#### Step 2\r\n\r\nAttempt to restore the a snapshot created by the SLM policy adding option for global state (this seems to include the data stream? otherwise it is not restored?):\r\n\r\n```json\r\n{\r\n  ...\r\n  \"include_global_state\": true\r\n  ...\r\n}\r\n```\r\n\r\nYou may need to first delete the data stream or use the index renaming option upon restore. I found that the renaming leads to a different bug where the restored indices are not linked back to the data stream that was restored.\r\n\r\n#### Step 3\r\n\r\nAttempt to delete the restored data stream:\r\n\r\n```\r\nDELETE /_data_stream/test-data-stream1\r\n```\r\n\r\nSee the error reported above.\r\n\r\nCC @martijnvg \r\n\r\n\r\n\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}