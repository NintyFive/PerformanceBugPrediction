{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57644","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57644/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57644/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57644/events","html_url":"https://github.com/elastic/elasticsearch/issues/57644","id":630604271,"node_id":"MDU6SXNzdWU2MzA2MDQyNzE=","number":57644,"title":"IllegalArgumentException: numHits must be > 0 in ES 7.7.0","user":{"login":"g-w","id":28716,"node_id":"MDQ6VXNlcjI4NzE2","avatar_url":"https://avatars2.githubusercontent.com/u/28716?v=4","gravatar_id":"","url":"https://api.github.com/users/g-w","html_url":"https://github.com/g-w","followers_url":"https://api.github.com/users/g-w/followers","following_url":"https://api.github.com/users/g-w/following{/other_user}","gists_url":"https://api.github.com/users/g-w/gists{/gist_id}","starred_url":"https://api.github.com/users/g-w/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/g-w/subscriptions","organizations_url":"https://api.github.com/users/g-w/orgs","repos_url":"https://api.github.com/users/g-w/repos","events_url":"https://api.github.com/users/g-w/events{/privacy}","received_events_url":"https://api.github.com/users/g-w/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-06-04T08:07:18Z","updated_at":"2020-06-04T11:07:21Z","closed_at":"2020-06-04T11:07:20Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 7.7.0, Build: default/docker/81a1e9eda8e6183f5237786246f6dced26a10eaf/2020-05-12T02:01:37.602180Z, JVM: 14\r\n\r\n**Plugins installed**: \r\nNo additional plugins where installed.\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"14\" 2020-03-17\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 14+36)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 14+36, mixed mode, sharing)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux b99cbb29ece8 5.6.13-200.fc31.x86_64 #1 SMP Thu May 14 23:26:14 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen using ES 7.7.0 the following query\r\n\r\n```\r\ncurl  -X POST -H \"Content-Type:application/json\" \\\r\n  http://localhost:9200/bug\\*/_search \\\r\n  -d '{\"size\":1,\"query\":{\"term\":{\"test\":{\"value\":\"test\",\"boost\":1.0}}},\"sort\":[{\"@timestamp\":{\"order\":\"desc\"}}]}'\r\n```\r\n\r\nThe server sometimes responds with:\r\n\r\n```\r\n{\r\n   \"_shards\" : {\r\n      \"failed\" : 1,\r\n      \"failures\" : [\r\n         {\r\n            \"index\" : \"bug-first\",\r\n            \"node\" : \"WJi6sSFOQdKQ6fmiJ8alxw\",\r\n            \"reason\" : {\r\n               \"reason\" : \"numHits must be > 0; please use TotalHitCountCollector if you just need the total hit count\",\r\n               \"type\" : \"illegal_argument_exception\"\r\n            },\r\n            \"shard\" : 0\r\n         }\r\n      ],\r\n      \"skipped\" : 0,\r\n      \"successful\" : 1,\r\n      \"total\" : 2\r\n   },\r\n   \"hits\" : {\r\n      \"hits\" : [\r\n         {\r\n            \"_id\" : \"soJSYHIBhhdeGg3HEdIG\",\r\n            \"_index\" : \"bug-second\",\r\n            \"_score\" : null,\r\n            \"_source\" : {\r\n               \"@timestamp\" : \"2020-05-29T09:10:41.272235893Z\",\r\n               \"test\" : \"test\"\r\n            },\r\n            \"_type\" : \"_doc\",\r\n            \"sort\" : [\r\n               1590743441272\r\n            ]\r\n         }\r\n      ],\r\n      \"max_score\" : null,\r\n      \"total\" : {\r\n         \"relation\" : \"eq\",\r\n         \"value\" : 1\r\n      }\r\n   },\r\n   \"timed_out\" : false,\r\n   \"took\" : 4\r\n}\r\n```\r\nand logs the following exception\r\n```\r\n{\"type\": \"server\", \"timestamp\": \"2020-05-29T12:23:47,774Z\", \"level\": \"DEBUG\", \"component\": \"o.e.a.s.TransportSearchAction\", \"cluster.name\": \"docker-cluster\", \"node.name\": \"9994b59cd16f\", \"message\": \"[bug-first][0], node[WJi6sSFOQdKQ6fmiJ8alxw], [P], s[STARTED], a[id=V2qDwV8OSciQPJ7KDYZOGg]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[bug*], indicesOptions=IndicesOptions[ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, expand_wildcards_hidden=false, allow_aliases_to_multiple_indices=true, forbid_closed_indices=true, ignore_aliases=false, ignore_throttled=true], types=[], routing='null', preference='null', requestCache=null, scroll=null, maxConcurrentShardRequests=0, batchedReduceSize=512, preFilterShardSize=null, allowPartialSearchResults=true, localClusterAlias=null, getOrCreateAbsoluteStartMillis=-1, ccsMinimizeRoundtrips=true, source={\\\"size\\\":1,\\\"query\\\":{\\\"term\\\":{\\\"test\\\":{\\\"value\\\":\\\"test\\\",\\\"boost\\\":1.0}}},\\\"sort\\\":[{\\\"@timestamp\\\":{\\\"order\\\":\\\"desc\\\"}}]}}]\", \"cluster.uuid\": \"vM6KAFOWTEa49nRmq-kM3A\", \"node.id\": \"WJi6sSFOQdKQ6fmiJ8alxw\" , \r\n\"stacktrace\": [\"org.elasticsearch.transport.RemoteTransportException: [9994b59cd16f][10.0.9.3:9300][indices:data/read/search[phase/query]]\",\r\n\"Caused by: org.elasticsearch.search.query.QueryPhaseExecutionException: Query Failed [Failed to execute main query]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.executeInternal(QueryPhase.java:323) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:151) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.lambda$loadIntoContext$21(IndicesService.java:1344) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.lambda$cacheShardLevelResult$22(IndicesService.java:1396) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:176) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:159) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:433) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesRequestCache.getOrCompute(IndicesRequestCache.java:125) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.cacheShardLevelResult(IndicesService.java:1402) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.loadIntoContext(IndicesService.java:1341) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:359) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:434) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.access$200(SearchService.java:135) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService$2.lambda$onResponse$0(SearchService.java:395) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.lambda$runAsync$0(SearchService.java:411) [elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) [elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:692) [elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) [?:?]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) [?:?]\",\r\n\"at java.lang.Thread.run(Thread.java:832) [?:?]\",\r\n\"Caused by: java.lang.IllegalArgumentException: numHits must be > 0; please use TotalHitCountCollector if you just need the total hit count\",\r\n\"at org.apache.lucene.search.TopFieldCollector.create(TopFieldCollector.java:464) ~[lucene-core-8.5.1.jar:8.5.1 edb9fc409398f2c3446883f9f80595c884d245d0 - ivera - 2020-04-08 08:55:42]\",\r\n\"at org.apache.lucene.search.TopFieldCollector$1.newCollector(TopFieldCollector.java:502) ~[lucene-core-8.5.1.jar:8.5.1 edb9fc409398f2c3446883f9f80595c884d245d0 - ivera - 2020-04-08 08:55:42]\",\r\n\"at org.apache.lucene.search.TopFieldCollector$1.newCollector(TopFieldCollector.java:495) ~[lucene-core-8.5.1.jar:8.5.1 edb9fc409398f2c3446883f9f80595c884d245d0 - ivera - 2020-04-08 08:55:42]\",\r\n\"at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:166) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.searchWithCollectorManager(QueryPhase.java:402) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.executeInternal(QueryPhase.java:297) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:151) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.lambda$loadIntoContext$21(IndicesService.java:1344) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.lambda$cacheShardLevelResult$22(IndicesService.java:1396) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:176) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:159) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:433) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesRequestCache.getOrCompute(IndicesRequestCache.java:125) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.cacheShardLevelResult(IndicesService.java:1402) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.indices.IndicesService.loadIntoContext(IndicesService.java:1341) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:359) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:434) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.access$200(SearchService.java:135) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService$2.lambda$onResponse$0(SearchService.java:395) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.search.SearchService.lambda$runAsync$0(SearchService.java:411) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:692) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-7.7.0.jar:7.7.0]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1130) ~[?:?]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:630) ~[?:?]\",\r\n\"at java.lang.Thread.run(Thread.java:832) ~[?:?]\"] }\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nTo reproduce the bug.  You have to create two indices bug-first and bug-second with no additional settings or mappings, ie. `http put http://localhost:9200/bug-first` and `http put http://localhost:9200/bug-second`. Further add some old documents to the first index `bug-first` through\r\n```\r\nfor i in $(seq 1000); do echo '{ \"@timestamp\" : \"2020-05-09T09:10:41.272235893Z\",\"test\":\"test\" }' | http post localhost:9200/bug-first/_doc; done\r\n```\r\nFurther add a document and to the second index\r\n```\r\n> echo '{ \"@timestamp\" : \"2020-05-29T09:10:41.272235893Z\", \"test\":\"test\"}' | http post localhost:9200/bug-second/_doc;                                                                                        \r\n```\r\nIt is not sufficient to add a few documents. Further add a document to the second index `bug-second`\r\n```\r\n> echo '{ \"@timestamp\" : \"2020-05-29T09:10:41.272235893Z\", \"test\":\"test\"}' | http post localhost:9200/bug-second/_doc;                                                                                        \r\n```\r\nExecute the query as above.\r\n\r\nThis issue might be related two https://github.com/elastic/elasticsearch/issues/56923\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}