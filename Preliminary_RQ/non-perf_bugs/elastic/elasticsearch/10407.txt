{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10407/events","html_url":"https://github.com/elastic/elasticsearch/issues/10407","id":66041777,"node_id":"MDU6SXNzdWU2NjA0MTc3Nw==","number":10407,"title":"A network partition isolating a primary can cause the loss of inserted documents","user":{"login":"aphyr","id":3748,"node_id":"MDQ6VXNlcjM3NDg=","avatar_url":"https://avatars3.githubusercontent.com/u/3748?v=4","gravatar_id":"","url":"https://api.github.com/users/aphyr","html_url":"https://github.com/aphyr","followers_url":"https://api.github.com/users/aphyr/followers","following_url":"https://api.github.com/users/aphyr/following{/other_user}","gists_url":"https://api.github.com/users/aphyr/gists{/gist_id}","starred_url":"https://api.github.com/users/aphyr/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aphyr/subscriptions","organizations_url":"https://api.github.com/users/aphyr/orgs","repos_url":"https://api.github.com/users/aphyr/repos","events_url":"https://api.github.com/users/aphyr/events{/privacy}","received_events_url":"https://api.github.com/users/aphyr/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111053151,"node_id":"MDU6TGFiZWwxMTEwNTMxNTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/resiliency","name":"resiliency","color":"009800","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2015-04-03T00:46:02Z","updated_at":"2016-05-12T11:55:12Z","closed_at":"2016-05-12T11:55:11Z","author_association":"NONE","active_lock_reason":null,"body":"This is tough for me to reliably reproduce, but I've seen it a half-dozen times and think it needs an issue. Elasticsearch can still lose inserted documents when a single primary node is isolated by a simple network partition. Nothing fancy, no overlapping partitions required. Sometimes it's only a few documents, from immediately following the partition:\n\n``` clj\n{:valid? false,\n :lost \"#{640 643 645 649}\",\n :recovered\n \"#{140..142 144 146 148..152 155 157 159..162 164..168 171 174..175 177 179..185 187 190..192 194 197 199..200 202 205..208 214 224 234 238 240..247 249..254 256..264 266..282 285 296 317 342 363 388 431}\",\n :ok\n \"#{0..137 140..142 144 146 148..152 155 157 159..162 164..168 171 174..175 177 179..185 187 190..192 194 197 199..200 202 205..208 210..212 214 224 234 238 240..247 249..254 256..264 266..639 641..642 644 646..648 650..654}\",\n :recovered-frac 96/655,\n :unexpected-frac 0,\n :unexpected \"#{}\",\n :lost-frac 4/655,\n :ok-frac 598/655}\n```\n\nOther times, the cluster seems to get really confused, and loses over half of the acknowledged records, distributed throughout the history:\n\n``` clj\n{:valid? false,\n :lost\n \"#{53..55 126..129 131..142 144..167 169..189 191..212 214..235 237..260 262..281 283..305 307..327 329..352 354..367 374 376}\",\n :recovered\n \"#{46..47 49 52 60 428..430 432..435 437..440 442..445 447..450 452..455 457..473}\",\n :ok\n \"#{0..47 49 52 60 428..430 432..435 437..440 442..445 447..450 452..455 457..473}\",\n :recovered-frac 15/158,\n :unexpected-frac 0,\n :unexpected \"#{}\",\n :lost-frac 118/237,\n :ok-frac 91/474}\n```\n\nThe logs aren't particularly informative here, but I have noticed some interesting messages which seem correlated with data loss: for instance:\n\n```\n[2015-04-02][WARN ][index.shard] [n4] [jepsen-index][0] suspect illegal state: trying to move shard from primary mode to replica mode\n```\n\nand\n\n```\n[2015-04-02 17:19:54,370][DEBUG][action.index             ] [n2] observer: timeout notification from cluster service. timeout setting [1m], time since start [1m]\n```\n\nwhich I think is a hardcoded message.\n\nAgain, these are tough to reproduce--only 1 in 10 runs or so--so I'll keep working on finding a failure schedule that reliably triggers the fault.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}