{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17225","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17225/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17225/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17225/events","html_url":"https://github.com/elastic/elasticsearch/issues/17225","id":142402187,"node_id":"MDU6SXNzdWUxNDI0MDIxODc=","number":17225,"title":"Getting array_index_out_of_bounds_exception while using order_by","user":{"login":"Vineeth-Mohan","id":977962,"node_id":"MDQ6VXNlcjk3Nzk2Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/977962?v=4","gravatar_id":"","url":"https://api.github.com/users/Vineeth-Mohan","html_url":"https://github.com/Vineeth-Mohan","followers_url":"https://api.github.com/users/Vineeth-Mohan/followers","following_url":"https://api.github.com/users/Vineeth-Mohan/following{/other_user}","gists_url":"https://api.github.com/users/Vineeth-Mohan/gists{/gist_id}","starred_url":"https://api.github.com/users/Vineeth-Mohan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Vineeth-Mohan/subscriptions","organizations_url":"https://api.github.com/users/Vineeth-Mohan/orgs","repos_url":"https://api.github.com/users/Vineeth-Mohan/repos","events_url":"https://api.github.com/users/Vineeth-Mohan/events{/privacy}","received_events_url":"https://api.github.com/users/Vineeth-Mohan/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":342561425,"node_id":"MDU6TGFiZWwzNDI1NjE0MjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.3.1","name":"v2.3.1","color":"dddddd","default":false,"description":null},{"id":246685314,"node_id":"MDU6TGFiZWwyNDY2ODUzMTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.0.0-alpha1","name":"v5.0.0-alpha1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2016-03-21T16:32:38Z","updated_at":"2016-04-07T02:44:04Z","closed_at":"2016-03-29T12:28:56Z","author_association":"NONE","active_lock_reason":null,"body":"**Observations**\n- ES version 2.2.1\n- If number of documents indexed is 2 , there is no error or issue\n- With following recreation , I am seeing array_index_out_of_bounds_exception exception \n\n```\ncurl -XDELETE 'http://localhost:9200/vm/'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm1\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm2\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm3\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm4\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm5\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm6\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm7\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm8\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm9\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm10\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm' -d '{ \"name\" : \"vm11\" , \"rank\" : 2 , \"date\" : 2000 }'\necho\ncurl -XPOST 'http://localhost:9200/vm/_refresh'\necho\ncurl -XPOST 'http://localhost:9200/vm/vm/_search?pretty' -d '{\n  \"size\": 0,\n  \"aggs\": {\n    \"keywords\": {\n      \"terms\": {\n        \"collect_mode\": \"breadth_first\",\n        \"field\": \"name\",\n        \"size\": 1,\n        \"order\": {\n          \"dateB>rankAvg\": \"asc\"\n        }\n      },\n      \"aggs\": {\n        \"dateB\": {\n          \"filter\": {\n            \"term\": {\n              \"date\": 2001\n            }\n          },\n          \"aggs\": {\n            \"rankAvg\": {\n              \"min\": {\n                \"field\": \"rank\",\n                \"missing\": 1000\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}'\n```\n\nResponse\n\n```\n{\n  \"took\" : 13,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 3,\n    \"failed\" : 2,\n    \"failures\" : [ {\n      \"shard\" : 2,\n      \"index\" : \"vm\",\n      \"node\" : \"xpPiHlvJQjSgYu-L10WJuA\",\n      \"reason\" : {\n        \"type\" : \"array_index_out_of_bounds_exception\",\n        \"reason\" : \"1\"\n      }\n    } ]\n  },\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"keywords\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 1,\n      \"buckets\" : [ {\n        \"key\" : \"vm10\",\n        \"doc_count\" : 1,\n        \"dateB\" : {\n          \"doc_count\" : 0,\n          \"rankAvg\" : {\n            \"value\" : null\n          }\n        }\n      } ]\n    }\n  }\n}\n```\n\nLogs emitted\n\n```\n[2016-03-21 21:53:55,238][DEBUG][action.search.type       ] [Gertrude Yorkes] [vm][4], node[pkRBZKPTStiOaYYr4mH_-w], [P], v[2], s[STARTED], a[id=Tf6t7fTWRz-FSvU30ln-mA]: Failed to execute [org.elasticsearch.action.search.SearchRequest@a062c99] lastShard [true]\nRemoteTransportException[[Gertrude Yorkes][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: ArrayIndexOutOfBoundsException[1];\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 1\n    at org.elasticsearch.common.util.BigArrays$DoubleArrayWrapper.get(BigArrays.java:260)\n    at org.elasticsearch.search.aggregations.metrics.min.MinAggregator.metric(MinAggregator.java:100)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$Aggregation$3.compare(InternalOrder.java:213)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$Aggregation$3.compare(InternalOrder.java:210)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$CompoundOrder$CompoundOrderComparator.compare(InternalOrder.java:280)\n    at org.elasticsearch.search.aggregations.bucket.terms.InternalOrder$CompoundOrder$CompoundOrderComparator.compare(InternalOrder.java:266)\n    at org.elasticsearch.search.aggregations.bucket.terms.support.BucketPriorityQueue.lessThan(BucketPriorityQueue.java:37)\n    at org.elasticsearch.search.aggregations.bucket.terms.support.BucketPriorityQueue.lessThan(BucketPriorityQueue.java:26)\n    at org.apache.lucene.util.PriorityQueue.upHeap(PriorityQueue.java:258)\n    at org.apache.lucene.util.PriorityQueue.add(PriorityQueue.java:135)\n    at org.apache.lucene.util.PriorityQueue.insertWithOverflow(PriorityQueue.java:151)\n    at org.elasticsearch.search.aggregations.bucket.terms.GlobalOrdinalsStringTermsAggregator.buildAggregation(GlobalOrdinalsStringTermsAggregator.java:176)\n    at org.elasticsearch.search.aggregations.AggregationPhase.execute(AggregationPhase.java:167)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:119)\n    at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:364)\n    at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:376)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:368)\n    at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:365)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n\n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}