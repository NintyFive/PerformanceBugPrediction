{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44994","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44994/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44994/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44994/events","html_url":"https://github.com/elastic/elasticsearch/issues/44994","id":474425161,"node_id":"MDU6SXNzdWU0NzQ0MjUxNjE=","number":44994,"title":"Official Dockerimage in Openshift | Permission problems when accessing served certificates","user":{"login":"lostiniceland","id":1516116,"node_id":"MDQ6VXNlcjE1MTYxMTY=","avatar_url":"https://avatars2.githubusercontent.com/u/1516116?v=4","gravatar_id":"","url":"https://api.github.com/users/lostiniceland","html_url":"https://github.com/lostiniceland","followers_url":"https://api.github.com/users/lostiniceland/followers","following_url":"https://api.github.com/users/lostiniceland/following{/other_user}","gists_url":"https://api.github.com/users/lostiniceland/gists{/gist_id}","starred_url":"https://api.github.com/users/lostiniceland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lostiniceland/subscriptions","organizations_url":"https://api.github.com/users/lostiniceland/orgs","repos_url":"https://api.github.com/users/lostiniceland/repos","events_url":"https://api.github.com/users/lostiniceland/events{/privacy}","received_events_url":"https://api.github.com/users/lostiniceland/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-07-30T07:40:06Z","updated_at":"2020-11-11T21:55:32Z","closed_at":"2019-08-01T08:51:59Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** 6.7.2 Docker\r\n\r\n**OS version**:  Openshift 3.11 on Centos 7\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nRunning Elasticsearch in Openshift doesnt work when specifing a Certificate which was provided by the platform. Openshift mounts a secret-volume containing its own CA and the YAML specifies a self-serving certificate which was signed by the Openshift-CA.\r\n\r\nThose files are mapped to root:root.\r\n\r\nOpenshift runs each image with a generated UID (> 10000) and GUID 0.\r\n\r\nIt seems the Elasticsearch User is not running as root (which is good) but not with GUID 0, which is necessary to access those files.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Deploy official ES image as Openshift Imagestream\r\n 2. Use DeploymentConfig (or Deployment) YAML with SSL configuration\r\n 3. Check logs\r\n\r\nOpenshift-Deployment-YAML\r\n```\r\n- kind: Service\r\n    apiVersion: v1\r\n    metadata:\r\n      name: test\r\n      annotations:\r\n        service.alpha.openshift.io/serving-cert-secret-name: cert-secret-test\r\n    spec:\r\n      selector:\r\n        name: test\r\n      ports:\r\n        - name: elasticsearch\r\n          port: 9200\r\n          targetPort: 9200\r\n      type: LoadBalancer\r\n\t  \r\n- kind: DeploymentConfig\r\n    apiVersion: v1\r\n    metadata:\r\n      name: test\r\n    spec:\r\n      replicas: 1\r\n      template:\r\n        spec:\r\n          containers:\r\n            - name: elasticsearch\r\n              image: docker-registry.default.svc:5000/project/elasticsearch:6.7.2\r\n              ports:\r\n                - containerPort: 9200\r\n              env:\r\n                - name: discovery.type\r\n                  value: single-node\r\n                - name: ELASTIC_PASSWORD\r\n                  value: password\r\n                - name: xpack.ssl.key\r\n                  value: /var/run/secrets/openshift.io/project/cert-secret/tls.key\r\n                - name: xpack.ssl.certificate\r\n                  value: /var/run/secrets/openshift.io/project/cert-secret/tls.crt\r\n                - name: xpack.ssl.certificate_authorities\r\n                  value: /var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt\r\n                - name: xpack.security.transport.ssl.enabled\r\n                  value: 'true'\r\n                - name: xpack.security.http.ssl.enabled\r\n                  value: 'true'\r\n                - name: ES_JAVA_OPTS\r\n                  value: '-Xms512m -Xmx512m'\r\n              volumeMounts:\r\n                - name: cert-vol-test\r\n                  mountPath: /var/run/secrets/openshift.io/project/cert-secret\r\n\tvolumes:\r\n\t   - name: cert-vol-test\r\n             secret:\r\n                secretName: cert-secret-test\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\nCaused by: java.security.AccessControlException: access denied (\"java.io.FilePermission\" \"/var/run/secrets/kubernetes.io/serviceaccount/service-ca.crt\" \"read\")\r\n```\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"lostiniceland","id":1516116,"node_id":"MDQ6VXNlcjE1MTYxMTY=","avatar_url":"https://avatars2.githubusercontent.com/u/1516116?v=4","gravatar_id":"","url":"https://api.github.com/users/lostiniceland","html_url":"https://github.com/lostiniceland","followers_url":"https://api.github.com/users/lostiniceland/followers","following_url":"https://api.github.com/users/lostiniceland/following{/other_user}","gists_url":"https://api.github.com/users/lostiniceland/gists{/gist_id}","starred_url":"https://api.github.com/users/lostiniceland/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lostiniceland/subscriptions","organizations_url":"https://api.github.com/users/lostiniceland/orgs","repos_url":"https://api.github.com/users/lostiniceland/repos","events_url":"https://api.github.com/users/lostiniceland/events{/privacy}","received_events_url":"https://api.github.com/users/lostiniceland/received_events","type":"User","site_admin":false},"performed_via_github_app":null}