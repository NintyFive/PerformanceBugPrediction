[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/267832975","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-267832975","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":267832975,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NzgzMjk3NQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-12-18T17:06:14Z","updated_at":"2016-12-18T17:06:14Z","author_association":"MEMBER","body":"This:\r\n\r\n```\r\n\"main\" #1 prio=5 os_prio=0 tid=0x00007fcfc0009800 nid=0x4db9 runnable [0x00007fcfc7955000]\r\njava.lang.Thread.State: RUNNABLE\r\nat sun.nio.fs.UnixNativeDispatcher.stat0(Native Method)\r\nat sun.nio.fs.UnixNativeDispatcher.stat(UnixNativeDispatcher.java:286)\r\nat sun.nio.fs.UnixFileAttributes.get(UnixFileAttributes.java:70)\r\nat sun.nio.fs.UnixFileStore.devFor(UnixFileStore.java:55)\r\nat sun.nio.fs.UnixFileStore.(UnixFileStore.java:70)\r\nat sun.nio.fs.LinuxFileStore.(LinuxFileStore.java:48)\r\nat sun.nio.fs.LinuxFileSystem.getFileStore(LinuxFileSystem.java:112)\r\nat sun.nio.fs.UnixFileSystem$FileStoreIterator.readNext(UnixFileSystem.java:213)\r\nat sun.nio.fs.UnixFileSystem$FileStoreIterator.hasNext(UnixFileSystem.java:224)\r\n- locked <0x00000000c0b74e48> (a sun.nio.fs.UnixFileSystem$FileStoreIterator)\r\nat org.apache.lucene.util.IOUtils.getFileStore(IOUtils.java:515)\r\nat org.apache.lucene.util.IOUtils.spinsLinux(IOUtils.java:459)\r\nat org.apache.lucene.util.IOUtils.spins(IOUtils.java:448)\r\nat org.elasticsearch.env.ESFileStore.(ESFileStore.java:57)\r\nat org.elasticsearch.env.Environment.(Environment.java:90)\r\nat org.elasticsearch.node.internal.InternalSettingsPreparer.prepareEnvironment(InternalSettingsPreparer.java:81)\r\nat org.elasticsearch.common.cli.CliTool.(CliTool.java:107)\r\nat org.elasticsearch.common.cli.CliTool.(CliTool.java:100)\r\n```\r\n\r\nWhat filesystem and disks are you on?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269348029","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-269348029","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":269348029,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTM0ODAyOQ==","user":{"login":"ANorwell","id":246457,"node_id":"MDQ6VXNlcjI0NjQ1Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/246457?v=4","gravatar_id":"","url":"https://api.github.com/users/ANorwell","html_url":"https://github.com/ANorwell","followers_url":"https://api.github.com/users/ANorwell/followers","following_url":"https://api.github.com/users/ANorwell/following{/other_user}","gists_url":"https://api.github.com/users/ANorwell/gists{/gist_id}","starred_url":"https://api.github.com/users/ANorwell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ANorwell/subscriptions","organizations_url":"https://api.github.com/users/ANorwell/orgs","repos_url":"https://api.github.com/users/ANorwell/repos","events_url":"https://api.github.com/users/ANorwell/events{/privacy}","received_events_url":"https://api.github.com/users/ANorwell/received_events","type":"User","site_admin":false},"created_at":"2016-12-27T16:26:12Z","updated_at":"2016-12-27T16:26:12Z","author_association":"NONE","body":"I seem to be getting this as well in the java ES client with a very large ZFS installation (many disks and thousands of datasets). Preferably the ES client (nor the server) should not care about these or need to iterate over them.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269360408","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-269360408","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":269360408,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTM2MDQwOA==","user":{"login":"ANorwell","id":246457,"node_id":"MDQ6VXNlcjI0NjQ1Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/246457?v=4","gravatar_id":"","url":"https://api.github.com/users/ANorwell","html_url":"https://github.com/ANorwell","followers_url":"https://api.github.com/users/ANorwell/followers","following_url":"https://api.github.com/users/ANorwell/following{/other_user}","gists_url":"https://api.github.com/users/ANorwell/gists{/gist_id}","starred_url":"https://api.github.com/users/ANorwell/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ANorwell/subscriptions","organizations_url":"https://api.github.com/users/ANorwell/orgs","repos_url":"https://api.github.com/users/ANorwell/repos","events_url":"https://api.github.com/users/ANorwell/events{/privacy}","received_events_url":"https://api.github.com/users/ANorwell/received_events","type":"User","site_admin":false},"created_at":"2016-12-27T18:01:14Z","updated_at":"2016-12-27T18:20:07Z","author_association":"NONE","body":"To add some more detail here:\r\n\r\nThe initialization of `org.elasticsearch.env.Environment` is quadratic in the number of FileStores returned by `java.nio.file.FileSystems.getDefault.getFileStores`. For me, this can be 30k+ filestores, because the underlying file system is ZFS.\r\n\r\nThe quadratic performance comes because:\r\n1. The static initialization of `org.elasticsearch.env.Environment` loops over all filestores, creating an `ESFileStore` object.\r\n2. The initialization of `ESFileStore` invokes `org.apache.lucene.util.IOUtils.spins`, which calls `IOUtils.getFileStore`, which itself loops over every filestore to find a matching filestore for the provided path. (Additionally, the initialization scans `/proc/self/mountinfo` for the matching entry. This is also quadratic in the number of mounted filestores. In my case, most filestores are not mounted, so `mountinfo` has only a few entries.)\r\n\r\nSome possible inefficiencies I see here:\r\n1. The filestore is already known. Either `IOUtils` could expose providing this as part of its interface, or if it's hard to change lucene, then possibly the `spins` heuristic could be re-implemented in Elasticsearch, since it is really just a few lines of code.\r\n2. `/proc/self/mountinfo` might be read only once, and preprocessed to provide a mountpoint => device number lookup.\r\n3. Ideally the java elasticsearch client should not care about what disks exist. This seems specific to the server.\r\n4. Is it really necessary for the server to know every filestore that exists? In some environments the vast majority are unrelated to ES data storage.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290729116","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-290729116","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":290729116,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcyOTExNg==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T14:34:42Z","updated_at":"2017-03-31T14:34:42Z","author_association":"MEMBER","body":"@jasontedor is this still an issue?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290729243","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-290729243","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":290729243,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcyOTI0Mw==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T14:35:09Z","updated_at":"2017-03-31T14:35:09Z","author_association":"MEMBER","body":"@ANorwell are you still seeing this problem on the released versions of 5.x?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290729459","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-290729459","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":290729459,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcyOTQ1OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T14:35:59Z","updated_at":"2017-03-31T14:35:59Z","author_association":"MEMBER","body":"No additional feedback, closing.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/298168260","html_url":"https://github.com/elastic/elasticsearch/issues/21902#issuecomment-298168260","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21902","id":298168260,"node_id":"MDEyOklzc3VlQ29tbWVudDI5ODE2ODI2MA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-04-29T13:12:48Z","updated_at":"2017-04-29T13:12:48Z","author_association":"MEMBER","body":"@ANorwell See #24402.","performed_via_github_app":null}]