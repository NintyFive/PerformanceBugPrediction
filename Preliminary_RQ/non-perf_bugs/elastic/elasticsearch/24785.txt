{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24785","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24785/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24785/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24785/events","html_url":"https://github.com/elastic/elasticsearch/issues/24785","id":229893174,"node_id":"MDU6SXNzdWUyMjk4OTMxNzQ=","number":24785,"title":"The script query on binary field returns incorrect results","user":{"login":"dixingxing0","id":1303530,"node_id":"MDQ6VXNlcjEzMDM1MzA=","avatar_url":"https://avatars2.githubusercontent.com/u/1303530?v=4","gravatar_id":"","url":"https://api.github.com/users/dixingxing0","html_url":"https://github.com/dixingxing0","followers_url":"https://api.github.com/users/dixingxing0/followers","following_url":"https://api.github.com/users/dixingxing0/following{/other_user}","gists_url":"https://api.github.com/users/dixingxing0/gists{/gist_id}","starred_url":"https://api.github.com/users/dixingxing0/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dixingxing0/subscriptions","organizations_url":"https://api.github.com/users/dixingxing0/orgs","repos_url":"https://api.github.com/users/dixingxing0/repos","events_url":"https://api.github.com/users/dixingxing0/events{/privacy}","received_events_url":"https://api.github.com/users/dixingxing0/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2017-05-19T07:30:02Z","updated_at":"2017-07-25T10:37:37Z","closed_at":"2017-07-25T10:37:37Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**:  \r\n5.2.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): \r\n HotSpot 1.8.0_74\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nLinux es.244.22.hadoop.sjz 2.6.32-573.22.1.el6.centos.plus.x86_64 #1 SMP Wed Mar 23 17:51:43 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n 1.  We used a binary field , and tried to use script query on that field, unfortunately  we got very weird results.\r\n**es returns too much results, which script return false**. \r\n\r\nhere is the mapping:\r\n\r\n```\r\n...\r\n            \"evtCnt\": {\r\n                  \"properties\": {\r\n                     \"code\": {\r\n                        \"type\": \"binary\",\r\n                        \"doc_values\": true\r\n                     }\r\n                  }\r\n               }\r\n```\r\n 2. setting:\r\n```\r\n            \"refresh_interval\": \"-1\",\r\n            \"number_of_shards\": \"16\",\r\n            \"number_of_replicas\": \"0\",\r\n```\r\n 3. source:\r\n```\r\n            \"evtCnt\": [\r\n                  {\r\n                     \"code\": [\r\n                        \"ATPGVQMEAQk=\",\r\n                        \"ATPGVQMEAQk=\"\r\n                     ]\r\n                  }\r\n               ]\r\n```\r\n4. myFilter.painless:\r\n```java\r\nboolean myFilter(List list, int fromDate, int toDate) {\r\n                int totalCount = 0;\r\n\r\n                for(int i=evt.size()-1;i>=0;i--){\r\n                        byte[] bytes = list.get(i).bytes;\r\n                        for(int j=0;j<bytes.length;){\r\n                                ....\r\n                                totalCount = totalCount + bytes[j++];\r\n                                ....\r\n                        }\r\n                }\r\n                return totalCount > 1;\r\n    }\r\nreturn myFilter(doc[params.column].values, params.from, params.to);\r\n```\r\n5. script query : \r\n```javascript\r\n\"query\": {\r\n      \"bool\": {\r\n         \"must\": [\r\n            {\r\n                \"exists\":{\r\n                    \"field\":\"evtCnt.code\"\r\n                }\r\n            },\r\n            {\r\n               \"script\": {\r\n                  \"script\": {\r\n                     \"file\": \"myFilter\",\r\n                     \"lang\": \"painless\",\r\n                     \"params\": {\r\n                        \"column\": \"evtCnt.code\",\r\n                        \"from\": 20170201,\r\n                        \"to\": 20170515\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         ]\r\n      }\r\n   }\r\n```\r\n6. The query result returns many wrong records. (which myFilter function returns false )\r\n\r\n\r\n7. **At last we changed the mapping and source** (of cause a little change on script) , everything works fine.  \r\n\r\nThe mapping : \r\n```\r\n             \"evtCnt\": {\r\n                  \"type\": \"binary\",\r\n                  \"doc_values\": true\r\n               }\r\n```\r\nand changed the source to (single value, not an array) : \r\n```\r\n           {\r\n               \"evtCnt\": \"ATPF7QEBAQEzxe8BAQQBM8Y9AQEB\"\r\n            }\r\n\r\n```\r\n\r\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}