{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26587","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26587/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26587/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26587/events","html_url":"https://github.com/elastic/elasticsearch/issues/26587","id":256839135,"node_id":"MDU6SXNzdWUyNTY4MzkxMzU=","number":26587,"title":"Potential memory/cache problem in 5.5.2","user":{"login":"natelapp","id":15839796,"node_id":"MDQ6VXNlcjE1ODM5Nzk2","avatar_url":"https://avatars1.githubusercontent.com/u/15839796?v=4","gravatar_id":"","url":"https://api.github.com/users/natelapp","html_url":"https://github.com/natelapp","followers_url":"https://api.github.com/users/natelapp/followers","following_url":"https://api.github.com/users/natelapp/following{/other_user}","gists_url":"https://api.github.com/users/natelapp/gists{/gist_id}","starred_url":"https://api.github.com/users/natelapp/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/natelapp/subscriptions","organizations_url":"https://api.github.com/users/natelapp/orgs","repos_url":"https://api.github.com/users/natelapp/repos","events_url":"https://api.github.com/users/natelapp/events{/privacy}","received_events_url":"https://api.github.com/users/natelapp/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":127075273,"node_id":"MDU6TGFiZWwxMjcwNzUyNzM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/PITA","name":"PITA","color":"e11d21","default":false,"description":null},{"id":651959372,"node_id":"MDU6TGFiZWw2NTE5NTkzNzI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.5.2","name":"v5.5.2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2017-09-11T20:54:53Z","updated_at":"2018-04-06T15:31:50Z","closed_at":"2018-04-06T15:31:50Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.5.2\r\n\r\n**Plugins installed**: [x-pack (basic license)]\r\n\r\n**JVM version** (`java -version`): \r\n\r\n**OS version** (`uname -a` if on a Unix-like system): CentOS 7\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nDuring periods of ingest using the bulk API (500 docs per request with a max of 5 concurrent requests) we're seeing the memory usage on the 10 ES nodes in our cluster increase slowly, but continually, until the nodes eventually OOM.\r\n\r\n**Steps to reproduce**:\r\n\r\nUnfortunately, I don't have the ability to provide configuration/mappings/etc. due to our elasticsearch instance being on a closed network.  I will do my best to provide as much detail as possible that might be relevant to tracking down this issue.\r\n\r\nDuring these periods of ingest, regular GCs are occurring, but the trough after GC is completed is always higher than before.   Basically, the typical pattern you'd see from a memory leak.   These OOMs occurred consistently and I was able to reproduce several times through multiple cluster restarts.  In trying to track this down today, I let our process run until the nodes hit around 90% memory used and then I stopped the ingest process, basically short circuiting it right before the OOMs.   The memory on all of the nodes flatlined at 90% and didn't decrease, despite no ingest/query activity taking place.\r\n\r\nThe heap on the 10 ES nodes are set to 12gb and we're heavily favoring 'keyword' types for all but a couple of string fields.  There are no aggs or anything going against analyzed fields and our overall fielddata is very low on all the nodes.   In looking at 'fielddata', 'query_cache' and 'request_cache' stats, there is a total of a couple of gb per node -- nowhere near the 12gb configured for the jvm.  I also did a force 'flush' to make sure the translog wasn't somehow going beyond the default 512mb.  That had no effect.\r\n\r\nI suspected there was still some cache somewhere that was causing this, so I used the 'clear cache' API to see if I could free up the ~90% memory that was still being consumed by all of the nodes.  First, I tried _only_ clearing the cache against the indices we created.  That had no effect on the memory usage.  Next I tried clearing using ```/.*/_cache/clear``` (matching against the ES .monitoring*, .tasks, etc.).  That too had no effect.  Finally, I issued a clear cache against all indices using ```/*/_cache/clear```. All of the nodes immediately dropped their memory usage to ~10%.\r\n\r\nAre there any internal elasticsearch indices that are not exposed externally (via ```_cat/indices```, for example) that could be caching without regard to the configured cache limits (all using the defaults)?  We're using x-pack, but not any of the ML or anything else like that (though xpack.ml.enabled was true initially).   Alternatively, are there any other internal cache mechanisms that get cleared when a 'clear all' is submitted?\r\n\r\nAny help on this is appreciated.   Thanks.\r\n\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}