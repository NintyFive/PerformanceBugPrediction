{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18972","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18972/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18972/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18972/events","html_url":"https://github.com/elastic/elasticsearch/issues/18972","id":161162691,"node_id":"MDU6SXNzdWUxNjExNjI2OTE=","number":18972,"title":"Corrupt index after disk full, unclean shutdown / Possible to avoid translog recovery at all?","user":{"login":"SergiuCip","id":4825638,"node_id":"MDQ6VXNlcjQ4MjU2Mzg=","avatar_url":"https://avatars2.githubusercontent.com/u/4825638?v=4","gravatar_id":"","url":"https://api.github.com/users/SergiuCip","html_url":"https://github.com/SergiuCip","followers_url":"https://api.github.com/users/SergiuCip/followers","following_url":"https://api.github.com/users/SergiuCip/following{/other_user}","gists_url":"https://api.github.com/users/SergiuCip/gists{/gist_id}","starred_url":"https://api.github.com/users/SergiuCip/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SergiuCip/subscriptions","organizations_url":"https://api.github.com/users/SergiuCip/orgs","repos_url":"https://api.github.com/users/SergiuCip/repos","events_url":"https://api.github.com/users/SergiuCip/events{/privacy}","received_events_url":"https://api.github.com/users/SergiuCip/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":44,"created_at":"2016-06-20T10:19:20Z","updated_at":"2016-08-23T13:17:55Z","closed_at":"2016-08-12T11:04:41Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.3.1 then after trying the steps below we have decided to update to the newest version, so probably the bugs will have been fixed\n\n**JVM version**: openjdk version \"1.8.0_91\"\nOpenJDK Runtime Environment (build 1.8.0_91-b14)\nOpenJDK 64-Bit Server VM (build 25.91-b14, mixed mode)\n\n**OS version**: CentOS 7\n\n**Description of the problem including expected versus actual behavior**:\n\nThe disk space on our Elasticsearch server got full and we had to remove some logs in order to reduce the disk space usage. Moreover, we restarted elasticsearch and once we have done so immediately we have seen that some of our indices were broken (please see attached below the logs).\n\nWe have moved the entire elasticsearch 'data' directory out of the way as it was an urgent to have logs and restarted elasticsearch which started with a fresh 'data' directory.\n\nIn order to restore the indices we have copied some of them to another Elasticsearch Server because we did not wanted to do this on our Live Elasticsearch server and we did as follows:\n1. Stop the ES server\n2. Copy + change permission of the index\n3. Restart ES server\n\nalso:\n- removed all the translog files\n\nError message:\n\n[2016-06-20 09:01:56,764][WARN ][cluster.action.shard     ] [Famine] [logstash-2016.05.11][3] received shard failed for target shard [[logstash-2016.05.11][3], node[d-z_xFoqTrGd-kip-Tly_w], [P], v[3], s[INITIALIZING], a[id=yh9ngGZNQ5CIrq87hxZRTg], unassigned_info[[reason=ALLOCATION_FAILED], at[2016-06-20T09:01:56.636Z], details[failed recovery, failure IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed to create engine]; nested: EOFException; ]]], indexUUID [xN9jy5ZiRqaALYvkDxdFgA], message [failed recovery], failure [IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed to create engine]; nested: EOFException; ]\n\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: Caused by: [logstash-2016.05.11][[logstash-2016.05.11][0]] EngineCreationFailureException[fa\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:155)\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: at org.elasticsearch.index.engine.InternalEngineFactory.newReadWriteEngine(InternalEngineFac\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: at org.elasticsearch.index.shard.IndexShard.newEngine(IndexShard.java:1509)\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: at org.elasticsearch.index.shard.IndexShard.createNewEngine(IndexShard.java:1493)\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: at org.elasticsearch.index.shard.IndexShard.internalPerformTranslogRecovery(IndexShard.java:\nJun 20 09:01:49 log-01.novalocal elasticsearch[9894]: at org.elasticsearch.index.shard.IndexShard.performTranslogRecovery(IndexShard.java:938)\n\n[2016-06-20 07:12:24,538][WARN ][cluster.action.shard     ] [Brain-Child] [logstash-2016.05.11][3] received shard failed for [logstash-2016.05.11][3], node[FcS6VgojTuijenAeemDE6Q], [P], v[3], s[INITIALIZING], a[id=OdCh5n8GSDeZpiCLW-CKZg], unassigned_info[[reason=ALLOCATION_FAILED], at[2016-06-20T07:12:24.364Z], details[failed recovery, failure IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed to create engine]; nested: EOFException; ]], indexUUID [xN9jy5ZiRqaALYvkDxdFgA], message [failed recovery], failure [IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed to create engine]; nested: EOFException; ]\n[logstash-2016.05.11][[logstash-2016.05.11][3]] IndexShardRecoveryException[failed to recovery from gateway]; nested: EngineCreationFailureException[failed to create engine]; nested: EOFException;\n- removed the translog.ckp\n\nCaused by: [logstash-2016.05.11][[logstash-2016.05.11][4]] EngineCreationFailureException[failed to create engine]; nested: NoSuchFileException[/var/lib/elasticsearch/elasticsearch/nodes/0/indices/logstash-2016.05.11/4/translog/translog.ckp];\n    at org.elasticsearch.index.engine.InternalEngine.<init>(InternalEngine.java:155)\n    at org.elasticsearch.index.engine.InternalEngineFactory.newReadWriteEngine(InternalEngineFactory.java:25)\n    at org.elasticsearch.index.shard.IndexShard.newEngine(IndexShard.java:1509)\n    at org.elasticsearch.index.shard.IndexShard.createNewEngine(IndexShard.java:1493)\n    at org.elasticsearch.index.shard.IndexShard.internalPerformTranslogRecovery(IndexShard.java:966)\n    at org.elasticsearch.index.shard.IndexShard.performTranslogRecovery(IndexShard.java:938)\n    at org.elasticsearch.index.shard.StoreRecoveryService.recoverFromStore(StoreRecoveryService.java:241)\n- removed everything besides translog.ckp in the translog folder\n- we have also used java -cp lucene-core5.4.1.jar -ea:org.apache.lucene... org.apache.lucene.index.CheckIndex to check our indexes and it said that everything is ok, however still we kept on getting errors.\n\nCould someone please inform me what I have done wrong and what could I do to restore my indices ?\n\nThanks,\nSergiu\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}