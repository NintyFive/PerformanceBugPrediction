{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6239","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6239/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6239/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6239/events","html_url":"https://github.com/elastic/elasticsearch/issues/6239","id":33843098,"node_id":"MDU6SXNzdWUzMzg0MzA5OA==","number":6239,"title":"Aggregations: date_histogram aggregation breaks on date fields with multiple formats","user":{"login":"maxlang","id":3691886,"node_id":"MDQ6VXNlcjM2OTE4ODY=","avatar_url":"https://avatars2.githubusercontent.com/u/3691886?v=4","gravatar_id":"","url":"https://api.github.com/users/maxlang","html_url":"https://github.com/maxlang","followers_url":"https://api.github.com/users/maxlang/followers","following_url":"https://api.github.com/users/maxlang/following{/other_user}","gists_url":"https://api.github.com/users/maxlang/gists{/gist_id}","starred_url":"https://api.github.com/users/maxlang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/maxlang/subscriptions","organizations_url":"https://api.github.com/users/maxlang/orgs","repos_url":"https://api.github.com/users/maxlang/repos","events_url":"https://api.github.com/users/maxlang/events{/privacy}","received_events_url":"https://api.github.com/users/maxlang/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":95090930,"node_id":"MDU6TGFiZWw5NTA5MDkzMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.3.0","name":"v1.3.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"assignees":[{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2014-05-19T22:21:04Z","updated_at":"2014-05-27T08:33:36Z","closed_at":"2014-05-22T09:30:23Z","author_association":"NONE","active_lock_reason":null,"body":"The date format docs says you can separate different date formats using a double bar and that the first will be used to format any stored dates: [Date Format Docs](http://www.elasticsearch.org/guide/en/elasticsearch/reference/current/mapping-date-format.html)\n\nWhen using multiple date formats, however, the date_histogram aggregation throws \"UnsupportedOperationException[Printing not supported]\" which seems to be a Joda exception when a format doesn't have a printer. If I change the mapping to be a single format, the exception isn't thrown, so my guess is that the first format isn't parsed out to retrieve the printer.\n\nI'm using ES 1.1.1, though I've also observed this on 1.1.0. \n\nCreate the index:\n\n```\n➜  ~  curl localhost:9200/my_index -XPUT -d'{\"settings\":{},\"mappings\":{\"my_type\":{\"properties\":{\"my_date\":{\"type\":\"date\",\"format\":\"dateOptionalTime||mm-DD-yyyy\"}}}}}' \n\n{\"acknowledged\":true}%       \n```\n\nAdd a document with a date:\n\n```\n➜  ~  curl localhost:9200/my_index/my_type/1 -XPOST -d '{\"my_date\":\"12-13-2014\"}'\n\n{\"_index\":\"my_index\",\"_type\":\"my_type\",\"_id\":\"1\",\"_version\":1,\"created\":true}%  \n```\n\nPerform a date histogram facet (works):\n\n```\n➜  ~  curl localhost:9200/my_index/my_type/_search -XPOST -d '{\"facets\":{\"dates\":{\"date_histogram\":{\"field\":\"my_date\",\"interval\":\"day\"}}}}'\n\n{\"took\":2,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":1.0,\"hits\":[{\"_index\":\"my_index\",\"_type\":\"my_type\",\"_id\":\"1\",\"_score\":1.0, \"_source\" : {\"my_date\":\"12-13-2014\"}}]},\"facets\":{\"dates\":{\"_type\":\"date_histogram\",\"entries\":[{\"time\":1389571200000,\"count\":1}]}}}%      \n```\n\nPerform an aggregation facet (fails with UnsupportedOperationException):\n\n```\n ➜  ~  curl localhost:9200/my_index/my_type/_search -XPOST -d '{\"aggs\":{\"dates\":{\"date_histogram\":{\"field\":\"my_date\",\"interval\":\"day\"}}}}'\n\n{\"error\":\"UnsupportedOperationException[Printing not supported]\",\"status\":500}% \n```\n\nChange the mapping to contain only a single date format:\n\n```\n➜  ~  curl localhost:9200/my_index/my_type/_mapping -XPUT -d '{\"my_type\":{\"properties\":{\"my_date\":{\"type\":\"date\",\"format\":\"dateOptionalTime\"}}}}'\n\n{\"acknowledged\":true}%                                                          \n```\n\nCheck that the mapping changed:\n\n```\n➜  ~  curl localhost:9200/my_index/my_type/_mapping      \n\n{\"my_index\":{\"mappings\":{\"my_type\":{\"properties\":{\"my_date\":{\"type\":\"date\",\"format\":\"dateOptionalTime\"}}}}}}%          \n```\n\nRun the original aggregation again, and see that it returns the same result as the facet:\n\n```\n➜  ~  curl localhost:9200/my_index/my_type/_search -XPOST -d '{\"aggs\":{\"dates\":{\"date_histogram\":{\"field\":\"my_date\",\"interval\":\"day\"}}}}'\n\n{\"took\":2,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":1.0,\"hits\":[{\"_index\":\"my_index\",\"_type\":\"my_type\",\"_id\":\"1\",\"_score\":1.0, \"_source\" : {\"my_date\":\"12-13-2014\"}}]},\"aggregations\":{\"dates\":{\"buckets\":[{\"key_as_string\":\"2014-01-13T00:00:00.000Z\",\"key\":1389571200000,\"doc_count\":1}]}}}%                \n```\n","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}