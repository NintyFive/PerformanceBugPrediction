{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30170","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30170/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30170/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30170/events","html_url":"https://github.com/elastic/elasticsearch/issues/30170","id":317968761,"node_id":"MDU6SXNzdWUzMTc5Njg3NjE=","number":30170,"title":"repository-s3 plugin breaking changes in 5.4.0: can't see oldest snapshots","user":{"login":"MaxymVlasov","id":11096782,"node_id":"MDQ6VXNlcjExMDk2Nzgy","avatar_url":"https://avatars0.githubusercontent.com/u/11096782?v=4","gravatar_id":"","url":"https://api.github.com/users/MaxymVlasov","html_url":"https://github.com/MaxymVlasov","followers_url":"https://api.github.com/users/MaxymVlasov/followers","following_url":"https://api.github.com/users/MaxymVlasov/following{/other_user}","gists_url":"https://api.github.com/users/MaxymVlasov/gists{/gist_id}","starred_url":"https://api.github.com/users/MaxymVlasov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MaxymVlasov/subscriptions","organizations_url":"https://api.github.com/users/MaxymVlasov/orgs","repos_url":"https://api.github.com/users/MaxymVlasov/repos","events_url":"https://api.github.com/users/MaxymVlasov/events{/privacy}","received_events_url":"https://api.github.com/users/MaxymVlasov/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"assignees":[{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-04-26T10:28:30Z","updated_at":"2018-05-14T07:43:58Z","closed_at":"2018-05-14T07:43:58Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): \r\nVersion: 5.4.3, Build: eed30a8/2017-06-22T00:34:03.743Z, JVM: 1.8.0_171\r\n\r\n**Plugins installed**: []\r\nrepository-s3\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_171\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_171-b11)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.171-b11, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux ip-10-0-6-252 4.4.0-1052-aws #61-Ubuntu SMP Mon Feb 12 23:05:58 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe have ES 5.2, make snapshot per index everyday and store them to S3.\r\nNow we prepare migration to ES 6.2 and find next issue: ES 6.2 didn't see ES 5.2 S3 snapshots.\r\nWithin 5 days of debug, I found next things:\r\nES 5.4.0 and newest:\r\n* see 5.2 FS snapshots\r\n* don't see 5.2 S3 snapshots\r\n* see 6.2 S3 snapshots\r\n* Restored 5.2 snapshot/index can be stored as 5.4 S3 snapshot, and 6.2 their see\r\n\r\nES 5.3.3 and oldest:\r\n* see 5.2 FS snapshots\r\n* see 5.2 S3 snapshots\r\n* don't see 5.4/6.2 S3 snapshots\r\n\r\nlooks like something goes wrong on [split AWS Cloud plugin to 2 plugins](https://www.elastic.co/guide/en/elasticsearch/reference/5.4/breaking_50_plugins.html#_cloud_aws_plugin_changes) (`git diff 65e26e66dad..eed30a8e9bb plugins/repository-s3/`)\r\n\r\n**Steps to reproduce**:\r\n\r\nAWS\r\n1. Register on AWS \r\n2. create EC2 instance with ubuntu 16.04 and attach Elastic IP to instance\r\n3. Create user with full access to S3 [or with recommended settings](https://www.elastic.co/guide/en/elasticsearch/plugins/5.4/repository-s3-repository.html#repository-s3-permissions)\r\n4. Create S3 bucket and add Bucket policy ([your guide](https://www.elastic.co/guide/en/elasticsearch/plugins/5.4/repository-s3-repository.html#repository-s3-permissions))\r\n5. Go to your EC2 by ssh\r\n\r\nEC2 instance:\r\n1. [Download and ES 5.3 using tar.gz](https://www.elastic.co/guide/en/elasticsearch/reference/5.3/zip-targz.html#install-targz)\r\n2. Install plugin [repository-s3](https://www.elastic.co/guide/en/elasticsearch/plugins/5.3/repository-s3.html)\r\n3. Add settings like this to config/elasticsearch.yml\r\n```bash\r\ncloud:\r\n  aws:\r\n    access_key: XXX\r\n    secret_key: XXXXXX\r\n    s3:\r\n      signer: S3SignerType\r\n\r\npath.repo: [\"/home/ubuntu/local_backup\"]\r\n\r\npath:\r\n  data: /home/ubuntu/elasticsearch-5.2.0/data\r\n```\r\n4. Run ES and create some index if you haven't, for example, using Kibana.\r\n5. Create snapshot repos (S3 & FS) like this:\r\n```bash\r\ncurl -X PUT \"http://127.0.0.1:9200/_snapshot/s3_elastic_log\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"type\": \"s3\",\r\n    \"settings\": {\r\n        \"bucket\": \"BUCKET\",\r\n        \"region\": \"REGION\",\r\n        \"base_path\": \"/path/to/logs/\"\r\n    }\r\n}'\r\n\r\ncurl -X PUT \"localhost:9200/_snapshot/local_backup\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"type\": \"fs\",\r\n  \"settings\": {\r\n    \"location\": \"/home/ubuntu/local_backup\"\r\n  }\r\n}\r\n'\r\n```\r\n6. Create snapshots to S3 & FS.\r\n7. Make [Rolling upgrade to 5.4](https://www.elastic.co/guide/en/elasticsearch/reference/5.4/rolling-upgrades.html). And repeat steps 1-3 so that ES 5.4 look at ES 5.3 data and settings.\r\n<br>Also you need export `ES_PATH_CONF` like this `export ES_PATH_CONF=/home/ubuntu/elasticsearch-5.2.0`\r\n8. After upgrade to 5.4 you can see FS snapshot and can't see S3 snapshot\r\nUsing `curl localhost:9200/_snapshot/s3_elastic_lo/_all` and `curl localhost:9200/_snapshot/local_backup/_all`\r\n\r\n\r\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}