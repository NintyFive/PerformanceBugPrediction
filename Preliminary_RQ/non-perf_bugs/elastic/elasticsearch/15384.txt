{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15384","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15384/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15384/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15384/events","html_url":"https://github.com/elastic/elasticsearch/issues/15384","id":121670736,"node_id":"MDU6SXNzdWUxMjE2NzA3MzY=","number":15384,"title":"Error on ElasticSearch 1.0.3 EndWithValue","user":{"login":"elliswood","id":16253286,"node_id":"MDQ6VXNlcjE2MjUzMjg2","avatar_url":"https://avatars1.githubusercontent.com/u/16253286?v=4","gravatar_id":"","url":"https://api.github.com/users/elliswood","html_url":"https://github.com/elliswood","followers_url":"https://api.github.com/users/elliswood/followers","following_url":"https://api.github.com/users/elliswood/following{/other_user}","gists_url":"https://api.github.com/users/elliswood/gists{/gist_id}","starred_url":"https://api.github.com/users/elliswood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elliswood/subscriptions","organizations_url":"https://api.github.com/users/elliswood/orgs","repos_url":"https://api.github.com/users/elliswood/repos","events_url":"https://api.github.com/users/elliswood/events{/privacy}","received_events_url":"https://api.github.com/users/elliswood/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-12-11T09:32:43Z","updated_at":"2015-12-11T12:52:01Z","closed_at":"2015-12-11T12:48:54Z","author_association":"NONE","active_lock_reason":null,"body":"This has been driving me crazy for 2 weeks now. I have an elastic search on my dev machine that is working great but when I shove it up to LIVE I get this error whenever I sort by relevancy i.e. use script_score:\n\n{\n\"error\": \"SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[Gy8DKMvoQKO5rousUfhQsw][modernrugs_3][1]: QueryPhaseExecutionException[[modernrugs_3][1]: query[function score (filtered(ConstantScore(_:_))->+cache(_type:models.Product) ++cache(all_sizes.lt:[85 TO 100]) ++cache(all_sizes.price:[0.0 TO 1000000.0]) +cache(BooleanFilter(relevancy_scores.162:[\\* TO _])) +cache(BooleanFilter(relevancy_scores.176:[_ TO _])),function=script[if (!relevancyIds.isEmpty()) {cnt=0;x = relevancyIds.split(',');if (x.length>0) {for (i=0;i<x.length;i++) {p=x[i];if (!doc['relevancy_scores.'+p].isEmpty()) {relsProd=doc['relevancy_scores.'+p];if ((relsProd != null) && (!relsProd.empty&&relsProd.values.length>0)) {for (y=0;y<relsProd.values.length;y++) {cnt+=(int)relsProd.values[y];}}}}return cnt;} else {return _score}} else {return _score};], params [{_PAYLOADS=4, _FREQUENCIES=8, _source=org.elasticsearch.search.lookup.SourceLookup@5c7519d9, _fields=org.elasticsearch.search.lookup.FieldsLookup@bf424fb, _doc=org.elasticsearch.search.lookup.DocLookup@49a7e0de, _index=org.elasticsearch.search.lookup.IndexLookup@2c9c3499, doc=org.elasticsearch.search.lookup.DocLookup@49a7e0de, _CACHE=32, _score=1.0, _OFFSETS=2, relevancyIds=162, _POSITIONS=16}])],from[0],size[40]: Query Failed [Failed to execute main query]]; nested: EndWithValue; }{[Gy8DKMvoQKO5rousUfhQsw][modernrugs_3][0]: QueryPhaseExecutionException[[modernrugs_3][0]: query[function score (filtered(ConstantScore(_:_))->+cache(_type:models.Product) ++cache(all_sizes.lt:[85 TO 100]) ++cache(all_sizes.price:[0.0 TO 1000000.0]) +cache(BooleanFilter(relevancy_scores.162:[_ TO _])) +cache(BooleanFilter(relevancy_scores.176:[_ TO *])),function=script[if (!relevancyIds.isEmpty()) {cnt=0;x = relevancyIds.split(',');if (x.length>0) {for (i=0;i<x.length;i++) {p=x[i];if (!doc['relevancy_scores.'+p].isEmpty()) {relsProd=doc['relevancy_scores.'+p];if ((relsProd != null) && (!relsProd.empty&&relsProd.values.length>0)) {for (y=0;y<relsProd.values.length;y++) {cnt+=(int)relsProd.values[y];}}}}return cnt;} else {return _score}} else {return _score};], params [{_PAYLOADS=4, _FREQUENCIES=8, _source=org.elasticsearch.search.lookup.SourceLookup@12baae0f, _fields=org.elasticsearch.search.lookup.FieldsLookup@1df96464, _doc=org.elasticsearch.search.lookup.DocLookup@602df09b, _index=org.elasticsearch.search.lookup.IndexLookup@680f8171, doc=org.elasticsearch.search.lookup.DocLookup@602df09b, _CACHE=32, _score=1.0, _OFFSETS=2, relevancyIds=162, _POSITIONS=16}])],from[0],size[40]: Query Failed [Failed to execute main query]]; nested: EndWithValue; }]\",\n\"status\": 500\n}\n\nMy query is as follows:\n\n{\n  \"from\": 0,\n  \"size\": 40,\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"filtered\": {\n          \"query\": {\n            \"bool\": {\n              \"should\": {\n                \"match_all\": {}\n              }\n            }\n          },\n          \"filter\": {\n            \"and\": {\n              \"filters\": [\n                {\n                  \"or\": {\n                    \"filters\": [\n                      {\n                        \"type\": {\n                          \"value\": \"models.Product\"\n                        }\n                      }\n                    ]\n                  }\n                },\n                {\n                  \"and\": {\n                    \"filters\": [\n                      {\n                        \"range\": {\n                          \"all_sizes.lt\": {\n                            \"from\": 85,\n                            \"to\": 100,\n                            \"include_lower\": true,\n                            \"include_upper\": true\n                          }\n                        }\n                      }\n                    ]\n                  }\n                },\n                {\n                  \"and\": {\n                    \"filters\": [\n                      {\n                        \"range\": {\n                          \"all_sizes.price\": {\n                            \"from\": 0,\n                            \"to\": 1000000,\n                            \"include_lower\": true,\n                            \"include_upper\": true\n                          }\n                        }\n                      }\n                    ]\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": []\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": [\n                      {\n                        \"or\": {\n                          \"filters\": [\n                            {\n                              \"exists\": {\n                                \"field\": \"relevancy_scores.162\"\n                              }\n                            }\n                          ]\n                        }\n                      }\n                    ]\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": [\n                      {\n                        \"or\": {\n                          \"filters\": [\n                            {\n                              \"exists\": {\n                                \"field\": \"relevancy_scores.176\"\n                              }\n                            }\n                          ]\n                        }\n                      }\n                    ]\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": []\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": []\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": []\n                  }\n                },\n                {\n                  \"or\": {\n                    \"filters\": []\n                  }\n                }\n              ]\n            }\n          }\n        }\n      },\n      \"script_score\": {\n        \"script\": \"if (!relevancyIds.isEmpty()) {cnt=0;x = relevancyIds.split(',');if (x.length>0) {for (i=0;i<x.length;i++) {p=x[i];if (!doc['relevancy_scores.'+p].isEmpty()) {relsProd=doc['relevancy_scores.'+p];if ((relsProd != null) && (!relsProd.empty&&relsProd.values.length>0)) {for (y=0;y<relsProd.values.length;y++) {cnt+=(int)relsProd.values[y];}}}}return cnt;} else {return _score}} else {return _score};\",\n        \"params\": {\n          \"relevancyIds\": \"162\"\n        }\n      },\n      \"boost_mode\": \"replace\"\n    }\n  },\n  \"fields\": \"_id\",\n  \"sort\": [\n    {\n      \"_score\": {\n        \"order\": \"desc\"\n      }\n    }\n  ],\n  \"facets\": {\n    \"modelType\": {\n      \"terms\": {\n        \"field\": \"_type\",\n        \"size\": 10\n      }\n    },\n    \"relevancyId\": {\n      \"terms\": {\n        \"field\": \"all_relevancies.id\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\nLike I say it works fine on DEV but not on LIVE with the same code version. At the moment I am thinking its down to the actual data having something missing but I did a compare (using es mashup) and the object are identical :( :( :(\n\nI am quickly losing hair so if anyone can help that would be awesome\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}