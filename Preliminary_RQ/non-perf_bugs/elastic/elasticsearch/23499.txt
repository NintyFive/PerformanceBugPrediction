{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23499","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23499/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23499/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23499/events","html_url":"https://github.com/elastic/elasticsearch/issues/23499","id":212508233,"node_id":"MDU6SXNzdWUyMTI1MDgyMzM=","number":23499,"title":"Old GC pool is increasing continously with number of requests","user":{"login":"vanga","id":5126396,"node_id":"MDQ6VXNlcjUxMjYzOTY=","avatar_url":"https://avatars3.githubusercontent.com/u/5126396?v=4","gravatar_id":"","url":"https://api.github.com/users/vanga","html_url":"https://github.com/vanga","followers_url":"https://api.github.com/users/vanga/followers","following_url":"https://api.github.com/users/vanga/following{/other_user}","gists_url":"https://api.github.com/users/vanga/gists{/gist_id}","starred_url":"https://api.github.com/users/vanga/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/vanga/subscriptions","organizations_url":"https://api.github.com/users/vanga/orgs","repos_url":"https://api.github.com/users/vanga/repos","events_url":"https://api.github.com/users/vanga/events{/privacy}","received_events_url":"https://api.github.com/users/vanga/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2017-03-07T17:47:30Z","updated_at":"2018-03-20T22:28:39Z","closed_at":"2018-03-20T22:28:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**:\r\n5.2.2\r\n**Plugins installed**: [mapper-murmur3, ec2-discovery, s3-repository, x-pack]\r\n\r\n**JVM version**:\r\nopenjdk version \"1.8.0_121\"\r\n\r\n**OS version**:\r\nUbuntu 16.04\r\n**Description of the problem including expected versus actual behavior**:\r\nHeap usage is continuously increasing as I run queries with scripts, which is causing frequent old GCs. Old GC is clearing most of the heap, but it's happening almost all the time (because of the no of scripts that are being run)\r\n**Steps to reproduce**:\r\nRefer ES query https://gist.github.com/vanga/2cd8e1fd7c3b2bffa89fda8ce3a8a481#file-query1\r\nI have already asked this in forum\r\nhttps://discuss.elastic.co/t/heap-usage-of-client-node-is-continuously-increasing-as-i-run-queries/77032\r\n\r\nI have also tested the above query in 3 different scenarios\r\n1) Run once every second \r\n2) Run every second by setting `inline: \"\"`\r\n3) Run every second by removing the reduce script altogether\r\n\r\nMemory increase:\r\n1) causes an increase of 400-500 MB per 10 minutes\r\n2) causes an increase of 100 MB per 10 minutes\r\n3) negligible in a time window of 10 mins, but it's increasing slowly\r\n\r\nThis increase seems like not much, but with significant traffic/data size on production this is causing frequent GCs (almost all the time, every minute or so)\r\nThis isn't happening if I run queries without scripts, no matter with what concurrency. \r\n\r\nis this a bug or is there anything that can be done to improve this situation.\r\nI am not sure if this will be helpful, but here is the jmap histo output\r\n```\r\n----------------------------------------------\r\n   1:       6331050      998816688  [C\r\n   2:        922539      190724632  [B\r\n   3:       5909870      189115840  java.util.HashMap$Node\r\n   4:       6293885      151053240  java.lang.String\r\n   5:       2055583      132862912  [Ljava.util.HashMap$Node;\r\n   6:       2317385      111234480  java.util.HashMap\r\n   7:       2482432       59578368  java.util.ArrayList\r\n``` \r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}