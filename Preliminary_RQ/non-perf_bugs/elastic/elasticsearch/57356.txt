{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57356","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57356/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57356/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57356/events","html_url":"https://github.com/elastic/elasticsearch/issues/57356","id":627261462,"node_id":"MDU6SXNzdWU2MjcyNjE0NjI=","number":57356,"title":"Modified jvm.options prevent node from starting when upgrading from 7.5.1 to 7.7.0","user":{"login":"ddolcimascolo","id":5468291,"node_id":"MDQ6VXNlcjU0NjgyOTE=","avatar_url":"https://avatars1.githubusercontent.com/u/5468291?v=4","gravatar_id":"","url":"https://api.github.com/users/ddolcimascolo","html_url":"https://github.com/ddolcimascolo","followers_url":"https://api.github.com/users/ddolcimascolo/followers","following_url":"https://api.github.com/users/ddolcimascolo/following{/other_user}","gists_url":"https://api.github.com/users/ddolcimascolo/gists{/gist_id}","starred_url":"https://api.github.com/users/ddolcimascolo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ddolcimascolo/subscriptions","organizations_url":"https://api.github.com/users/ddolcimascolo/orgs","repos_url":"https://api.github.com/users/ddolcimascolo/repos","events_url":"https://api.github.com/users/ddolcimascolo/events{/privacy}","received_events_url":"https://api.github.com/users/ddolcimascolo/received_events","type":"User","site_admin":false},"labels":[{"id":114977275,"node_id":"MDU6TGFiZWwxMTQ5NzcyNzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Delivery/Packaging","name":":Delivery/Packaging","color":"0e8a16","default":false,"description":"RPM and deb packaging, tar and zip archives, shell and batch scripts"},{"id":2495976472,"node_id":"MDU6TGFiZWwyNDk1OTc2NDcy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Delivery","name":"Team:Delivery","color":"fef2c0","default":false,"description":"Meta label for Delivery team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-05-29T13:16:52Z","updated_at":"2020-11-11T22:03:27Z","closed_at":"2020-06-03T20:42:49Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests; it is not the place\r\nfor general questions. If you have a question or an unconfirmed bug , please\r\nvisit the [forums](https://discuss.elastic.co/c/elasticsearch).  Please also\r\ncheck your OS is [supported](https://www.elastic.co/support/matrix#show_os).\r\nIf it is not, the issue is likely to be closed.\r\n\r\nFor security vulnerabilities please only send reports to security@elastic.co.\r\nSee https://www.elastic.co/community/security for more information.\r\n\r\nPlease fill in the following details to help us reproduce the bug:\r\n-->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.7.0\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): The bundled JDK 14 (version below)\r\n\r\n```\r\n$ /usr/share/elasticsearch/jdk/bin/java -version\r\nopenjdk version \"14\" 2020-03-17\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 14+36)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 14+36, mixed mode, sharing)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu Server 18.04\r\n\r\n```\r\n$ uname -a\r\nLinux 4.15.0-99-generic #100-Ubuntu SMP Wed Apr 22 20:32:56 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n```\r\n$ cat /etc/lsb-release \r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=18.04\r\nDISTRIB_CODENAME=bionic\r\nDISTRIB_DESCRIPTION=\"Ubuntu 18.04.4 LTS\"\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n_Preamble_:\r\nIn versions prior to 7.7.0 we used to edit the file `/etc/elasticsearch/jvm.options` directly to change the heap size, as documented. This file is marked as a configuration file by the Debian package and as such, triggers a specific workflow in `dpkg` when the package is upgraded (depending on various advanced options that you might pass to `apt`) which by default asks you whether you want to keep your modified file, or upgrade to the new one. The problem gets worse when you upgrade the package in an unattended way, typically via a configuration manager (we use Ansible), because `dpkg` will keep the old version without asking.\r\n\r\n_The problem_:\r\nAs a matter of fact, upgrading Elasticsearch in these conditions silently ignore any upgrades to the `jvm.options` file, which was sad but worked fine until 7.7.0.\r\nThis version bundles a JDK 14 in which the CMS GC does not exist anymore and (on my system at least) the JVM defaults to the serial (single-threaded) GC (proof below)\r\n\r\n```\r\n$ /usr/share/elasticsearch/jdk/bin/java -XX:+PrintCommandLineFlags -version\r\n-XX:InitialHeapSize=64637824 -XX:MaxHeapSize=1034205184 -XX:MinHeapSize=6815736 -XX:+PrintCommandLineFlags -XX:ReservedCodeCacheSize=251658240 -XX:+SegmentedCodeCache -XX:+UseCompressedClassPointers -XX:+UseCompressedOops -XX:+UseSerialGC \r\nopenjdk version \"14\" 2020-03-17\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 14+36)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 14+36, mixed mode, sharing)\r\n```\r\nThe previous flavor of the `jvm.options` file enabled the CMS GC, but it does not exist anymore so the JVM uses the default one. This prevents the node from starting after the upgrade because of a failing bootstrap check.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Install Elasticsearch version 7.5.1 (I suppose any version < 7.7.0 would reproduce) using the official Debian packages on Ubuntu 18.04\r\n 2. Edit the `/etc/elasticsearch/jvm.options` file to increase the heap size\r\n 2. Verify that the node starts\r\n 3. Upgrade to Elasticsearch 7.7.0 using APT, keep your old version of the `jvm.options` file (answer \"N\" when asked)\r\n 4. Start the node, see it fail in the logs\r\n\r\n**Additional information**\r\n\r\nThe new system for setting JVM options with files in the `/etc/elasticsearch/jvm.options.d` directory is the correct solution to this. I've now migrated the nodes to use a file in this folder.\r\nHowever, the problem I describe here is still an issue and make upgrading painful, at least you should be able to show a big warning when the package is upgraded that the user MUST upgrade the `jvm.options` file because of the upgraded bundled JDK. Better yet, detect this problem and guide the user towards resolving this \"the proper way\". I personally spent a few hours digging into the changelog in a hope to find what the problem is...\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n[2020-05-29T09:06:50,490][INFO ][o.e.e.NodeEnvironment    ] [es-002.stordata.dev] using [1] data paths, mounts [[/ (/dev/sda2)]], net usable_space [38.6gb], net total_space [62.7gb], types [ext4]\r\n[2020-05-29T09:06:50,499][INFO ][o.e.e.NodeEnvironment    ] [es-002.stordata.dev] heap size [1.8gb], compressed ordinary object pointers [true]\r\n[2020-05-29T09:06:51,312][INFO ][o.e.n.Node               ] [es-002.stordata.dev] node name [es-002.stordata.dev], node ID [nfaUfK3uST-UxMCKQBDYAQ], cluster name [elk-clus-00]\r\n[2020-05-29T09:06:51,318][INFO ][o.e.n.Node               ] [es-002.stordata.dev] version[7.7.0], pid[626], build[default/deb/81a1e9eda8e6183f5237786246f6dced26a10eaf/2020-05-12T02:01:37.602180Z], OS[Linux/4.15\r\n.0-99-generic/amd64], JVM[AdoptOpenJDK/OpenJDK 64-Bit Server VM/14/14+36]\r\n[2020-05-29T09:06:51,318][INFO ][o.e.n.Node               ] [es-002.stordata.dev] JVM home [/usr/share/elasticsearch/jdk]\r\n[2020-05-29T09:06:51,319][INFO ][o.e.n.Node               ] [es-002.stordata.dev] JVM arguments [-Xshare:auto, -Des.networkaddress.cache.ttl=60, -Des.networkaddress.cache.negative.ttl=10, -XX:+AlwaysPreTouch, -\r\nXss1m, -Djava.awt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -XX:-OmitStackTraceInFastThrow, -XX:+ShowCodeDetailsInExceptionMessages, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true,\r\n -Dio.netty.recycler.maxCapacityPerThread=0, -Dio.netty.allocator.numDirectArenas=0, -Dlog4j.shutdownHookEnabled=false, -Dlog4j2.disable.jmx=true, -Djava.locale.providers=SPI,COMPAT, -Xms1972m, -Xmx1972m, -XX:+\r\nUseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -Djava.io.tmpdir=/tmp/elasticsearch-4206078949703173838, -XX:+HeapDumpOnOutOfMemoryError, -XX:HeapDumpPath=/var/lib\r\n/elasticsearch, -XX:ErrorFile=/var/log/elasticsearch/hs_err_pid%p.log, -Xlog:gc*,gc+age=trace,safepoint:file=/var/log/elasticsearch/gc.log:utctime,pid,tags:filecount=32,filesize=64m, -Xms1972m, -Xmx1972m, -XX:M\r\naxDirectMemorySize=1033895936, -Des.path.home=/usr/share/elasticsearch, -Des.path.conf=/etc/elasticsearch, -Des.distribution.flavor=default, -Des.distribution.type=deb, -Des.bundled_jdk=true]\r\n[2020-05-29T09:06:57,156][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [aggs-matrix-stats]\r\n[2020-05-29T09:06:57,159][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [analysis-common]\r\n[2020-05-29T09:06:57,162][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [constant-keyword]\r\n[2020-05-29T09:06:57,162][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [flattened]\r\n[2020-05-29T09:06:57,162][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [frozen-indices]\r\n[2020-05-29T09:06:57,163][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [ingest-common]\r\n[2020-05-29T09:06:57,163][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [ingest-geoip]\r\n[2020-05-29T09:06:57,163][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [ingest-user-agent]\r\n[2020-05-29T09:06:57,164][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [lang-expression]\r\n[2020-05-29T09:06:57,165][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [lang-mustache]\r\n[2020-05-29T09:06:57,166][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [lang-painless]\r\n[2020-05-29T09:06:57,166][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [mapper-extras]\r\n[2020-05-29T09:06:57,166][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [parent-join]\r\n[2020-05-29T09:06:57,166][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [percolator]\r\n[2020-05-29T09:06:57,167][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [rank-eval]\r\n[2020-05-29T09:06:57,167][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [reindex]\r\n[2020-05-29T09:06:57,167][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [repository-url]\r\n[2020-05-29T09:06:57,167][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [search-business-rules]\r\n[2020-05-29T09:06:57,173][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [spatial]\r\n[2020-05-29T09:06:57,174][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [systemd]\r\n[2020-05-29T09:06:57,174][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [tasks]\r\n[2020-05-29T09:06:57,174][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [transform]\r\n[2020-05-29T09:06:57,174][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [transport-netty4]\r\n[2020-05-29T09:06:57,175][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [vectors]\r\n[2020-05-29T09:06:57,176][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-analytics]\r\n[2020-05-29T09:06:57,176][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-async-search]\r\n[2020-05-29T09:06:57,177][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-autoscaling]\r\n[2020-05-29T09:06:57,177][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-ccr]\r\n[2020-05-29T09:06:57,178][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-core]\r\n[2020-05-29T09:06:57,178][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-deprecation]\r\n[2020-05-29T09:06:57,178][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-enrich]\r\n[2020-05-29T09:06:57,181][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-eql]\r\n[2020-05-29T09:06:57,182][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-graph]\r\n[2020-05-29T09:06:57,182][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-identity-provider]\r\n[2020-05-29T09:06:57,182][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-ilm]\r\n[2020-05-29T09:06:57,183][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-logstash]\r\n[2020-05-29T09:06:57,185][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-ml]\r\n[2020-05-29T09:06:57,186][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-monitoring]\r\n[2020-05-29T09:06:57,186][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-ql]\r\n[2020-05-29T09:06:57,187][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-rollup]\r\n[2020-05-29T09:06:57,187][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-security]\r\n[2020-05-29T09:06:57,188][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-sql]\r\n[2020-05-29T09:06:57,188][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-voting-only-node]\r\n[2020-05-29T09:06:57,194][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] loaded module [x-pack-watcher]\r\n[2020-05-29T09:06:57,195][INFO ][o.e.p.PluginsService     ] [es-002.stordata.dev] no plugins loaded\r\n[2020-05-29T09:07:09,620][INFO ][o.e.x.s.a.s.FileRolesStore] [es-002.stordata.dev] parsed [0] roles from file [/etc/elasticsearch/roles.yml]\r\n[2020-05-29T09:07:11,311][INFO ][o.e.x.m.p.l.CppLogMessageHandler] [es-002.stordata.dev] [controller/795] [Main.cc@110] controller (64 bit): Version 7.7.0 (Build a8939d3da43f33) Copyright (c) 2020 Elasticsearch BV\r\n[2020-05-29T09:07:13,254][INFO ][o.e.d.DiscoveryModule    ] [es-002.stordata.dev] using discovery type [zen] and seed hosts providers [settings]\r\n[2020-05-29T09:07:15,639][INFO ][o.e.n.Node               ] [es-002.stordata.dev] initialized\r\n[2020-05-29T09:07:15,642][INFO ][o.e.n.Node               ] [es-002.stordata.dev] starting ...\r\n[2020-05-29T09:07:15,948][INFO ][o.e.t.TransportService   ] [es-002.stordata.dev] publish_address {10.78.7.228:9300}, bound_addresses {10.78.7.228:9300}\r\n[2020-05-29T09:07:22,938][INFO ][o.e.b.BootstrapChecks    ] [es-002.stordata.dev] bound or publishing to a non-loopback address, enforcing bootstrap checks\r\n[2020-05-29T09:07:22,990][ERROR][o.e.b.Bootstrap          ] [es-002.stordata.dev] node validation exception\r\n[1] bootstrap checks failed\r\n[1]: JVM is using the serial collector but should not be for the best performance; either it's the default for the VM [OpenJDK 64-Bit Server VM] or -XX:+UseSerialGC was explicitly specified\r\n[2020-05-29T09:07:23,005][INFO ][o.e.n.Node               ] [es-002.stordata.dev] stopping ...\r\n[2020-05-29T09:07:23,029][INFO ][o.e.n.Node               ] [es-002.stordata.dev] stopped\r\n[2020-05-29T09:07:23,030][INFO ][o.e.n.Node               ] [es-002.stordata.dev] closing ...\r\n[2020-05-29T09:07:23,082][INFO ][o.e.n.Node               ] [es-002.stordata.dev] closed\r\n[2020-05-29T09:07:23,084][INFO ][o.e.x.m.p.NativeController] [es-002.stordata.dev] Native controller process has stopped - no new native processes can be started\r\n```\r\n\r\nThanks a lot !\r\n\r\nDavid","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}