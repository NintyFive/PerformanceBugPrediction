[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441561953","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441561953","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441561953,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTU2MTk1Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T08:51:45Z","updated_at":"2018-11-26T08:51:45Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441564758","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441564758","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441564758,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTU2NDc1OA==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T09:01:50Z","updated_at":"2018-11-26T09:01:50Z","author_association":"MEMBER","body":"@synhershko we introduced a new limit in 6x through a cluster setting named `search.max_buckets`:\r\nhttps://github.com/elastic/elasticsearch/pull/27581\r\nHowever we couldn't activate it by default in a minor release so in 6x a deprecation warning is printed when the number of buckets to render is bigger than `10,000`. You can force a value in 6x (it's a dynamic cluster setting) to throw an error instead. The setting is activated by default in 7 (with a default limit set to `10,000`) so I hope you don't mind if I close this issue. I tried your recreation in 6x where I updated `search.max_buckets` to 10,000, and in 7 and I get the expected error:\r\n````\r\n{\r\n    \"error\": {\r\n        \"root_cause\": [],\r\n        \"type\": \"search_phase_execution_exception\",\r\n        \"reason\": \"\",\r\n        \"phase\": \"fetch\",\r\n        \"grouped\": true,\r\n        \"failed_shards\": [],\r\n        \"caused_by\": {\r\n            \"type\": \"too_many_buckets_exception\",\r\n            \"reason\": \"Trying to create too many buckets. Must be less than or equal to: [10000] but was [10001]. This limit can be set by changing the [search.max_buckets] cluster level setting.\",\r\n            \"max_buckets\": 10000\r\n        }\r\n    },\r\n    \"status\": 503\r\n}\r\n````","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441581444","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441581444","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441581444,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTU4MTQ0NA==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T09:57:38Z","updated_at":"2018-11-26T09:57:38Z","author_association":"CONTRIBUTOR","body":"The problem is this error / warning is never printed, because the ES node reaches OOM and crashes (on the `createEmptyBuckets` method, full stacktrace not handy atm). Specifically that happened on a 1g heap so I assume the low memory used is the reason and a lower max_buckets config would solve it. Thanks!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441582569","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441582569","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441582569,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTU4MjU2OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T10:01:14Z","updated_at":"2018-11-26T10:01:14Z","author_association":"MEMBER","body":"> The problem is this error / warning is never printed, because the ES node reaches OOM and crashes (on the createEmptyBuckets method, full stacktrace not handy atm)\r\n\r\nIt should be printed in the deprecation logs as soon as the `createEmptyBuckets` reaches `10,000` buckets. If it's not then there is a bug.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441596725","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441596725","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441596725,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTU5NjcyNQ==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T10:48:43Z","updated_at":"2018-11-26T10:48:43Z","author_association":"CONTRIBUTOR","body":"Deprecation log contains:\r\n\r\n```\r\n[2018-11-26T10:46:32,835][WARN ][o.e.d.s.a.MultiBucketConsumerService] [ip-172-31-28-55] This aggregation creates too many buckets (10001) and will \r\nthrow an error in future versions. You should update the [search.max_buckets] cluster setting or use the [composite] aggregation to paginate all buc\r\nkets in multiple requests.  \r\n```\r\n\r\nBut the node still crashes with the following (cropped in the end in the original file - probably process quit before finishing the flush to the file):\r\n\r\n```\r\n[2018-11-26T10:46:33,992][WARN ][o.e.m.j.JvmGcMonitorService] [ip-172-31-28-55] [gc][8471] overhead, spent [901ms] collecting in the last [1s]      \r\n[2018-11-26T10:46:36,606][WARN ][o.e.m.j.JvmGcMonitorService] [ip-172-31-28-55] [gc][8472] overhead, spent [2.3s] collecting in the last [2.6s]     \r\n[2018-11-26T10:46:38,199][WARN ][o.e.m.j.JvmGcMonitorService] [ip-172-31-28-55] [gc][8473] overhead, spent [1.5s] collecting in the last [1.5s]     \r\n[2018-11-26T10:46:41,889][WARN ][o.e.m.j.JvmGcMonitorService] [ip-172-31-28-55] [gc][8474] overhead, spent [3.6s] collecting in the last [3.6s]     \r\n[2018-11-26T10:46:49,522][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [ip-172-31-28-55] fatal error in thread [elasticsearch[ip-172-31-28-55\r\n][search][T#1]], exiting                                                                                                                            \r\njava.lang.OutOfMemoryError: Java heap space                                                                                                         \r\n        at java.util.Arrays.copyOf(Arrays.java:3181) ~[?:1.8.0_191]                                                                                 \r\n        at java.util.ArrayList.grow(ArrayList.java:265) ~[?:1.8.0_191]                                                                              \r\n        at java.util.ArrayList.ensureExplicitCapacity(ArrayList.java:239) ~[?:1.8.0_191]                                                            \r\n        at java.util.ArrayList.ensureCapacityInternal(ArrayList.java:231) ~[?:1.8.0_191]                                                            \r\n        at java.util.ArrayList.add(ArrayList.java:479) ~[?:1.8.0_191]                                                                               \r\n        at java.util.ArrayList$ListItr.add(ArrayList.java:964) ~[?:1.8.0_191]                                                                       \r\n        at org.elasticsearch.search.aggregations.bucket.histogram.InternalHistogram.addEmptyBuckets(InternalHistogram.java:405) ~[elasticsearch-6.5.\r\n0.jar:6.5.0]                                                                                                                                        \r\n        at org.elasticsearch.search.aggregations.bucket.histogram.InternalHist\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441601106","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441601106","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441601106,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTYwMTEwNg==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T11:04:16Z","updated_at":"2018-11-26T11:04:16Z","author_association":"MEMBER","body":"Thanks @synhershko . The issue is that we don't have a circuit breaker in the coordinating node, we only use it on each shard that participates in the search so the `search.max_buckets` setting is different. It can be seen as a limit to the number of buckets that we can transport between each shard and finally to the user. We didn't want to break every use cases that returns more than `10,000` buckets in a minor release so we choose the deprecation path but as you noticed this doesn't prevent the node to crash if the heap cannot handle this amount of memory. However there is a workaround \r\n in 6x (where you can force `search.max_buckets` to a reasonable value) and this shouldn't be an issue in 7 anymore where the default value should protect against the explosion. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441603252","html_url":"https://github.com/elastic/elasticsearch/issues/35896#issuecomment-441603252","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35896","id":441603252,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTYwMzI1Mg==","user":{"login":"synhershko","id":212252,"node_id":"MDQ6VXNlcjIxMjI1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/212252?v=4","gravatar_id":"","url":"https://api.github.com/users/synhershko","html_url":"https://github.com/synhershko","followers_url":"https://api.github.com/users/synhershko/followers","following_url":"https://api.github.com/users/synhershko/following{/other_user}","gists_url":"https://api.github.com/users/synhershko/gists{/gist_id}","starred_url":"https://api.github.com/users/synhershko/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/synhershko/subscriptions","organizations_url":"https://api.github.com/users/synhershko/orgs","repos_url":"https://api.github.com/users/synhershko/repos","events_url":"https://api.github.com/users/synhershko/events{/privacy}","received_events_url":"https://api.github.com/users/synhershko/received_events","type":"User","site_admin":false},"created_at":"2018-11-26T11:12:18Z","updated_at":"2018-11-26T11:12:18Z","author_association":"CONTRIBUTOR","body":"For the record, this happens on a single node instance (master + data + ingest roles) with 1g heap - so I did expect the circuit breaker to pop.\r\n\r\nUnderstood re the setting - obviously this is not a production deployment or anything and the query is faulty, but again - I did expect Elastic to protect itself. I'll check this with 7.x later...","performed_via_github_app":null}]