[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/172518421","html_url":"https://github.com/elastic/elasticsearch/issues/16040#issuecomment-172518421","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16040","id":172518421,"node_id":"MDEyOklzc3VlQ29tbWVudDE3MjUxODQyMQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-01-18T12:43:20Z","updated_at":"2016-01-18T12:43:20Z","author_association":"CONTRIBUTOR","body":"No, it's not possible to do this at the moment, with the current structure of your documents.  You can calculate the ratio using a pipeline aggregation as follows:\n\n```\nGET _search?size=0\n{\n  \"aggregations\": {\n    \"campaigns\": {\n      \"terms\": {\n        \"field\": \"campaign_id\"\n      },\n      \"aggregations\": {\n        \"clicks\": {\n          \"filter\": {\n            \"term\": {\n              \"action\": \"click\"\n            }\n          }\n        },\n        \"views\": {\n          \"filter\": {\n            \"term\": {\n              \"action\": \"view\"\n            }\n          }\n        },\n        \"ratio\": {\n          \"bucket_script\": {\n            \"buckets_path\": {\n              \"clicks\": \"clicks._count\",\n              \"views\": \"views._count\"\n            },\n            \"script\": \"clicks/views\"\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nBut you can't sort the terms agg on the result of `ratio`.  Possibly you'll be able to sort later on once https://github.com/elastic/elasticsearch/issues/14928 is implemented.\n\nWhat you can do though is to create a summarised view on your indexed documents to group them together and index click and view rates within a single document for each campaign. Then what you're after will be easy to do.  \n\nHave a look at this talk about entity centric indexing for more guidance: https://www.youtube.com/watch?v=yBf7oeJKH2Y\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/258837839","html_url":"https://github.com/elastic/elasticsearch/issues/16040#issuecomment-258837839","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16040","id":258837839,"node_id":"MDEyOklzc3VlQ29tbWVudDI1ODgzNzgzOQ==","user":{"login":"DeeeFOX","id":3414019,"node_id":"MDQ6VXNlcjM0MTQwMTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3414019?v=4","gravatar_id":"","url":"https://api.github.com/users/DeeeFOX","html_url":"https://github.com/DeeeFOX","followers_url":"https://api.github.com/users/DeeeFOX/followers","following_url":"https://api.github.com/users/DeeeFOX/following{/other_user}","gists_url":"https://api.github.com/users/DeeeFOX/gists{/gist_id}","starred_url":"https://api.github.com/users/DeeeFOX/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DeeeFOX/subscriptions","organizations_url":"https://api.github.com/users/DeeeFOX/orgs","repos_url":"https://api.github.com/users/DeeeFOX/repos","events_url":"https://api.github.com/users/DeeeFOX/events{/privacy}","received_events_url":"https://api.github.com/users/DeeeFOX/received_events","type":"User","site_admin":false},"created_at":"2016-11-07T13:40:44Z","updated_at":"2016-11-07T13:40:44Z","author_association":"NONE","body":"This is not suitable to data which is ambiguous of how many types it does have util aggregation result show up to us. Just like in this example, if we don't know the exactly action name (\"clicks\" or \"views\"), we can't get the aggregation result of the <each_type_count>/<total_count>!\n","performed_via_github_app":null}]