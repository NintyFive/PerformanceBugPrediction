[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384137467","html_url":"https://github.com/elastic/elasticsearch/issues/30056#issuecomment-384137467","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30056","id":384137467,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzNzQ2Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-02-06T17:47:41Z","updated_at":"2018-04-25T02:01:58Z","author_association":"COLLABORATOR","body":"*Original comment by @droberts195:*\n\nThis is the relevant bit of the external cluster log:\r\n\r\n```\r\n[2018-02-06T15:13:21,124][WARN ][o.e.x.m.j.p.a.o.AutoDetectResultProcessor] [realtime-job-given-process-is-killed] some results not processed due to the process being killed\r\n[2018-02-06T15:13:21,149][INFO ][o.e.x.m.j.p.l.CppLogMessageHandler] [controller/3503] EMAIL REDACTED Child process with PID 4593 was terminated by signal 15\r\n[2018-02-06T15:13:31,485][INFO ][o.e.x.m.d.DatafeedManager] [stop_datafeed (api)] attempt to stop datafeed [realtime-job-given-process-is-killed-datafeed] [63]\r\n[2018-02-06T15:13:31,485][INFO ][o.e.x.m.d.DatafeedManager] [stop_datafeed (api)] attempt to stop datafeed [realtime-job-given-process-is-killed-datafeed] for job [realtime-job-given-process-is-killed]\r\n[2018-02-06T15:13:31,485][INFO ][o.e.x.m.d.DatafeedManager] [stop_datafeed (api)] try lock [5m] to stop datafeed [realtime-job-given-process-is-killed-datafeed] for job [realtime-job-given-process-is-killed]...\r\n[2018-02-06T15:18:31,485][INFO ][o.e.x.m.d.DatafeedManager] [stop_datafeed (api)] stopping datafeed [realtime-job-given-process-is-killed-datafeed] for job [realtime-job-given-process-is-killed], acquired [false]...\r\n[2018-02-06T15:18:31,486][INFO ][o.e.x.m.d.DatafeedManager] [stop_datafeed (api)] datafeed [realtime-job-given-process-is-killed-datafeed] for job [realtime-job-given-process-is-killed] has been stopped, but there may be pending tasks as the timeout [5m] expired\r\n```\r\n\r\nThere must be a rare race condition that meant the datafeed didn't react correctly to `autodetect` being killed.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384137468","html_url":"https://github.com/elastic/elasticsearch/issues/30056#issuecomment-384137468","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30056","id":384137468,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzNzQ2OA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-02-07T16:39:58Z","updated_at":"2018-04-25T02:01:58Z","author_association":"COLLABORATOR","body":"*Original comment by @droberts195:*\n\n`DatafeedJobsIT.startRealtime()` returns when the `DataCounts` for the job show the expected number of documents.  This will happen once the second post_data request completes.  However, the datafeed is running with a frequency of 1 second, so if there is a garbage collection or VM stall between the second post_data and the kill then the _third_ run of the datafeed can coincide with the kill, and the logs show that that's what's happened in this failure.\r\n\r\nThis is bad because it implies there's a time during the work of `DatafeedJob.run()` somewhere between `LOGGER.trace(\"[{}] Searching data in: ...` and `LOGGER.debug(\"[{}] Complete iterating data extractor...` where killing the `autodetect` process causes a deadlock, and that could happen in production - it's not purely a test problem.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/384137469","html_url":"https://github.com/elastic/elasticsearch/issues/30056#issuecomment-384137469","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30056","id":384137469,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NDEzNzQ2OQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-02-15T15:22:50Z","updated_at":"2018-04-25T02:01:58Z","author_association":"COLLABORATOR","body":"*Original comment by @davidkyle:*\n\nDatacounts are persisted at the end of a post data operation before the response returns, in theory they are visible before the request has finished. The kill process action is fired when the updated datacounts are detected which could happen before the datafeed gets the response from post data (however unlikely that is). The datafeed sends a flush request after the posting data, I suspect the error is due to an interaction with that flush request and the kill process action executing simultaneously so the process is killed during the flush. \r\n\r\nI have not been able to recreate the deadlock nor can I see a route through the code where it could happen I'm sharing this hypothesis in case it helps someone else. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/441072911","html_url":"https://github.com/elastic/elasticsearch/issues/30056#issuecomment-441072911","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30056","id":441072911,"node_id":"MDEyOklzc3VlQ29tbWVudDQ0MTA3MjkxMQ==","user":{"login":"albertzaharovits","id":4568420,"node_id":"MDQ6VXNlcjQ1Njg0MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4568420?v=4","gravatar_id":"","url":"https://api.github.com/users/albertzaharovits","html_url":"https://github.com/albertzaharovits","followers_url":"https://api.github.com/users/albertzaharovits/followers","following_url":"https://api.github.com/users/albertzaharovits/following{/other_user}","gists_url":"https://api.github.com/users/albertzaharovits/gists{/gist_id}","starred_url":"https://api.github.com/users/albertzaharovits/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/albertzaharovits/subscriptions","organizations_url":"https://api.github.com/users/albertzaharovits/orgs","repos_url":"https://api.github.com/users/albertzaharovits/repos","events_url":"https://api.github.com/users/albertzaharovits/events{/privacy}","received_events_url":"https://api.github.com/users/albertzaharovits/received_events","type":"User","site_admin":false},"created_at":"2018-11-22T16:05:43Z","updated_at":"2018-11-22T16:05:43Z","author_association":"CONTRIBUTOR","body":"A more recent hit:\r\nhttps://internal-ci.elastic.co/job/elastic+x-pack-elasticsearch+5.6+multijob-unix-compatibility/428/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/557586974","html_url":"https://github.com/elastic/elasticsearch/issues/30056#issuecomment-557586974","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30056","id":557586974,"node_id":"MDEyOklzc3VlQ29tbWVudDU1NzU4Njk3NA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-11-22T15:54:49Z","updated_at":"2019-11-22T15:54:49Z","author_association":"CONTRIBUTOR","body":"> The datafeed sends a flush request after the posting data, I suspect the error is due to an interaction with that flush request and the kill process action executing simultaneously so the process is killed during the flush.\r\n\r\nI believe the problem should be fixed by #46982.  In particular by moving the flush acknowledgement from https://github.com/elastic/elasticsearch/pull/46982/files#diff-957ab8349a993d0dac4dee91fdc1f48fL293 into the `finally` block at https://github.com/elastic/elasticsearch/pull/46982/files#diff-957ab8349a993d0dac4dee91fdc1f48fR304.","performed_via_github_app":null}]