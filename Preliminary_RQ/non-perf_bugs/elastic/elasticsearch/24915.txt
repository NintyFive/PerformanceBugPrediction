{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24915","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24915/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24915/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24915/events","html_url":"https://github.com/elastic/elasticsearch/issues/24915","id":231753309,"node_id":"MDU6SXNzdWUyMzE3NTMzMDk=","number":24915,"title":"Implement adaptive replica selection for coordinating nodes performing queries","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":654494999,"node_id":"MDU6TGFiZWw2NTQ0OTQ5OTk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.1.0","name":"v6.1.0","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-05-26T23:08:23Z","updated_at":"2017-09-22T12:33:17Z","closed_at":"2017-09-07T22:28:00Z","author_association":"MEMBER","active_lock_reason":null,"body":"In #23884 (and #3890) we added the `fixed_auto_queue_size` threadpool which could automatically raise or lower the queue size of the search threadpool depending on the arrival rate of operations and target response rate.\r\n\r\nWe'd like to take the next step for this and implement adaptive replica selection. This is a partial application of the [C3 algorithm](https://www.usenix.org/system/files/conference/nsdi15/nsdi15-paper-suresh.pdf) used on the coordinating node to select the appropriate replica instead of our current round robin behavior. Note that we cannot currently implement the rate control and backpressure from the paper since we cannot treat each request as having identical cost, though with the automatic queue-sizing already implemented we do have a good way to provide backpressure on the execution nodes themselves already.\r\n\r\nThe formula for replica ranking (`Ψ(s)`) (see page 6 of the linked paper) (EWMA = Exponentially Weighted Moving Average):\r\n\r\n    Ψ(s) = R(s) - 1/µ̄(s) + (q̂(s))^b / µ̄(s)\r\n\r\nWhere `q̂(s)` is:\r\n\r\n    q̂(s) = 1 + (os(s) * n) + q(s)\r\n\r\nHere `(os(s) * n)` is the \"concurrency compensation\", where `os(s)` is the number of outstanding requests to a node and `n` is the number of clients in the system. `R(s)`, `q(s)`, and `µ̄(s)` are EWMAs of the response time (as seen from the coordinating node), queue-size, and service time received from the execution node.\r\n\r\nThis will require a number of steps in order to be implemented:\r\n\r\n-   [x] Track EWMA of task execution time (service time) requests on the execution node (#24989)\r\n-   [x] Piggyback service time EWMA and current queue size from execution node back to coordinating node with the search response (#25430)\r\n-   [x] Track EWMA of response time of an execution node on the coordinating node (#25430)\r\n-   [x] Track EWMA of queue size on the coordinating node (#25430)\r\n-   [x] Implement the actual adaptive replica ranking on the coordinating node when deciding which copy of the data to execute the read operation on (#26128)\r\n\r\nThere is a little flexibility here, since we could possibly use some of our existing metrics (like \"took\" time) instead of adding new measurements, this is only a rough overview.\r\n\r\nAdditionally, we will need to decide on a value for `b` to correctly penalize long queues (the paper uses 3) as well as a good `α` value for the EWMA calculations. We could also make these configurable if desired.\r\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}