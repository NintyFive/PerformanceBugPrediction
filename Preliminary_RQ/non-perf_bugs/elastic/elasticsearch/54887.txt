{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54887","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54887/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54887/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54887/events","html_url":"https://github.com/elastic/elasticsearch/issues/54887","id":595841004,"node_id":"MDU6SXNzdWU1OTU4NDEwMDQ=","number":54887,"title":"[CI] denying access as action [internal:admin/tasks/ban] is not an index or cluster action","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2020-04-07T12:45:49Z","updated_at":"2020-07-06T15:57:35Z","closed_at":"2020-07-06T15:57:35Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"An ML test failed in https://gradle-enterprise.elastic.co/s/d5tipghjjliwc\r\n\r\nThe error was:\r\n\r\n```\r\nFailure at [mixed_cluster/90_ml_data_frame_analytics_crud:83]: expected [2xx] status code but api [ml.stop_data_frame_analytics] returned [409 Conflict] [{\"error\":{\"root_cause\":[{\"type\":\"status_exception\",\"reason\":\"cannot close data frame analytics [old_cluster_regression_job] because it failed, use force stop instead\",\"stack_trace\":\"org.elasticsearch.ElasticsearchStatusException: cannot close data frame analytics [old_cluster_regression_job] because it failed, use force stop instead\\n\\tat org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper.conflictStatusException(ExceptionsHelper.java:67)\\n\\tat org.elasticsearch.xpack.ml.action.TransportStopDataFrameAnalyticsAction.normalStop(TransportStopDataFrameAnalyticsAction.java:143)\\n\\tat org.elasticsearch.xpack.ml.action.TransportStopDataFrameAnalyticsAction.lambda$doExecute$0(TransportStopDataFrameAnalyticsAction.java:111)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.xpack.ml.action.TransportStopDataFrameAnalyticsAction.lambda$expandIds$3(TransportStopDataFrameAnalyticsAction.java:131)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.xpack.ml.dataframe.persistence.DataFrameAnalyticsConfigProvider.lambda$getMultiple$3(DataFrameAnalyticsConfigProvider.java:133)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.client.node.NodeClient.lambda$executeLocally$0(NodeClient.java:91)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:158)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:151)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.xpack.ml.action.TransportGetDataFrameAnalyticsAction.lambda$doExecute$0(TransportGetDataFrameAnalyticsAction.java:63)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.xpack.core.action.AbstractTransportGetResourcesAction$1.onResponse(AbstractTransportGetResourcesAction.java:124)\\n\\tat org.elasticsearch.xpack.core.action.AbstractTransportGetResourcesAction$1.onResponse(AbstractTransportGetResourcesAction.java:97)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.client.node.NodeClient.lambda$executeLocally$0(NodeClient.java:91)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:158)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:151)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.sendSearchResponse(AbstractSearchAsyncAction.java:545)\\n\\tat org.elasticsearch.action.search.ExpandSearchPhase.run(ExpandSearchPhase.java:117)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executePhase(AbstractSearchAsyncAction.java:350)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:344)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase.moveToNextPhase(FetchSearchPhase.java:231)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase.lambda$innerRun$1(FetchSearchPhase.java:119)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:125)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:95)\\n\\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\\n\\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44)\\n\\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:691)\\n\\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\\n\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\n\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\n\\tat java.lang.Thread.run(Thread.java:834)\\n\"}],\"type\":\"status_exception\",\"reason\":\"cannot close data frame analytics [old_cluster_regression_job] because it failed, use force stop instead\",\"stack_trace\":\"org.elasticsearch.ElasticsearchStatusException: cannot close data frame analytics [old_cluster_regression_job] because it failed, use force stop instead\\n\\tat org.elasticsearch.xpack.core.ml.utils.ExceptionsHelper.conflictStatusException(ExceptionsHelper.java:67)\\n\\tat org.elasticsearch.xpack.ml.action.TransportStopDataFrameAnalyticsAction.normalStop(TransportStopDataFrameAnalyticsAction.java:143)\\n\\tat org.elasticsearch.xpack.ml.action.TransportStopDataFrameAnalyticsAction.lambda$doExecute$0(TransportStopDataFrameAnalyticsAction.java:111)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.xpack.ml.action.TransportStopDataFrameAnalyticsAction.lambda$expandIds$3(TransportStopDataFrameAnalyticsAction.java:131)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.xpack.ml.dataframe.persistence.DataFrameAnalyticsConfigProvider.lambda$getMultiple$3(DataFrameAnalyticsConfigProvider.java:133)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.client.node.NodeClient.lambda$executeLocally$0(NodeClient.java:91)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:158)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:151)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.xpack.ml.action.TransportGetDataFrameAnalyticsAction.lambda$doExecute$0(TransportGetDataFrameAnalyticsAction.java:63)\\n\\tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63)\\n\\tat org.elasticsearch.xpack.core.action.AbstractTransportGetResourcesAction$1.onResponse(AbstractTransportGetResourcesAction.java:124)\\n\\tat org.elasticsearch.xpack.core.action.AbstractTransportGetResourcesAction$1.onResponse(AbstractTransportGetResourcesAction.java:97)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.client.node.NodeClient.lambda$executeLocally$0(NodeClient.java:91)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:158)\\n\\tat org.elasticsearch.tasks.TaskManager$1.onResponse(TaskManager.java:151)\\n\\tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.sendSearchResponse(AbstractSearchAsyncAction.java:545)\\n\\tat org.elasticsearch.action.search.ExpandSearchPhase.run(ExpandSearchPhase.java:117)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executePhase(AbstractSearchAsyncAction.java:350)\\n\\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:344)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase.moveToNextPhase(FetchSearchPhase.java:231)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase.lambda$innerRun$1(FetchSearchPhase.java:119)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:125)\\n\\tat org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:95)\\n\\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\\n\\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:44)\\n\\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:691)\\n\\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\\n\\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128)\\n\\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628)\\n\\tat java.lang.Thread.run(Thread.java:834)\\n\"},\"status\":409}]\r\n```\r\n\r\nHowever, the server side logs (downloadable from https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+matrix-java-periodic/ES_RUNTIME_JAVA=adoptopenjdk11,nodes=general-purpose/616/gcsObjects/) show the following error was the root cause:\r\n\r\n```\r\n[2020-04-07T05:23:07,037][WARN ][o.e.x.s.a.AuthorizationService] [v8.0.0-1] denying access as action [internal:admin/tasks/ban] is not an index or cluster action\r\n```\r\n\r\nThat message is from `x-pack/qa/rolling-upgrade/build/testclusters/v8.0.0-1/logs/v8.0.0.log`.\r\n\r\nIt looks like the ban action needs to be called from within the system security context, and this does not always happen (although it must happen sometimes by coincidence as the test failure is quite rare).","closed_by":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"performed_via_github_app":null}