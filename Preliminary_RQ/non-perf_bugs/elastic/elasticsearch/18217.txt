{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18217","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18217/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18217/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18217/events","html_url":"https://github.com/elastic/elasticsearch/issues/18217","id":153815690,"node_id":"MDU6SXNzdWUxNTM4MTU2OTA=","number":18217,"title":"recovery issues when using multiple entries in path.data","user":{"login":"djschny","id":129643,"node_id":"MDQ6VXNlcjEyOTY0Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/129643?v=4","gravatar_id":"","url":"https://api.github.com/users/djschny","html_url":"https://github.com/djschny","followers_url":"https://api.github.com/users/djschny/followers","following_url":"https://api.github.com/users/djschny/following{/other_user}","gists_url":"https://api.github.com/users/djschny/gists{/gist_id}","starred_url":"https://api.github.com/users/djschny/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djschny/subscriptions","organizations_url":"https://api.github.com/users/djschny/orgs","repos_url":"https://api.github.com/users/djschny/repos","events_url":"https://api.github.com/users/djschny/events{/privacy}","received_events_url":"https://api.github.com/users/djschny/received_events","type":"User","site_admin":false},"labels":[{"id":152510590,"node_id":"MDU6TGFiZWwxNTI1MTA1OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Recovery","name":":Distributed/Recovery","color":"0e8a16","default":false,"description":"Anything around constructing a new shard, either from a local or a remote source."},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-05-09T16:25:58Z","updated_at":"2016-05-13T09:23:23Z","closed_at":"2016-05-13T09:23:23Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.2\n\n**JVM version**: 1.8.0_74\n\n**OS version**: OSX 10.11.4\n\n**Description of the problem including expected versus actual behavior**:\nWhen using multiple entries for `path.data` on a node and then simulating removing a drive from the node, the node does not mark the shards that were on that shard as unavailable so re-assignment can happen. I would expect to see some initial errors get thrown, but after a little bit of time, see the shards that were assigned to the missing or timing out filesystem to be allocated elsewhere in the cluster (or the same node but a different data path).\n\n**Steps to reproduce**:\n1. Create four empty directories\n2. Create a new index (using default 5/1 shard allocation) and index some data\n3. Start up two nodes of ES, each one pointing to two different data directories. For example:\n\n```\nbin/elasticsearch --node.name=node1 --path.data=/data/node1-drive1,/data/node1-drive2\nbin/elasticsearch --node.name=node2 --path.data=/data/node2-drive1,/data/node2-drive2\n```\n1. Remove one of the directories completely\n\n**Provide logs (if relevant)**:\n- Observed https://github.com/elastic/elasticsearch/issues/17395#issuecomment-217903474\n- Also observed the following logs to continue to happen over and over with no recovery; Below are some examples of the various errors seen:\n\n```\n{\n  \"_index\": \"index1\",\n  \"_type\": \"docs\",\n  \"_id\": \"AVSWUC2X9feFc7L66p0Q\",\n  \"_version\": 1,\n  \"_shards\": {\n    \"total\": 2,\n    \"successful\": 1,\n    \"failed\": 1,\n    \"failures\": [\n      {\n        \"_index\": \"index1\",\n        \"_shard\": 4,\n        \"_node\": \"X4nxoaPZTMqX-RCWBM79Ew\",\n        \"reason\": {\n          \"type\": \"create_failed_engine_exception\",\n          \"reason\": \"Create failed for [docs#AVSWUC2X9feFc7L66p0Q]\",\n          \"shard\": \"4\",\n          \"index\": \"index1\",\n          \"caused_by\": {\n            \"type\": \"no_such_file_exception\",\n            \"reason\": \"/data/node1-drive1/elasticsearch/nodes/0/indices/index1/4/index/write.lock\"\n          }\n        },\n        \"status\": \"INTERNAL_SERVER_ERROR\",\n        \"primary\": false\n      }\n    ]\n  },\n  \"created\": true\n}\n```\n\n```\n[2016-05-09 11:40:24,812][DEBUG][action.admin.indices.stats] [node1] [indices:monitor/stats] failed to execute operation for shard [[.kibana][0], node[X4nxoaPZTMqX-RCWBM79Ew], [P], v[4], s[STARTED], a[id=hTbB0MAbTXCZuOSwh_fArA]]\nElasticsearchException[failed to refresh store stats]; nested: NoSuchFileException[/data/node1-drive1/elasticsearch/nodes/0/indices/.kibana/0/index];\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1532)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1517)\n    at org.elasticsearch.common.util.SingleObjectCache.getOrRefresh(SingleObjectCache.java:55)\n    at org.elasticsearch.index.store.Store.stats(Store.java:293)\n    at org.elasticsearch.index.shard.IndexShard.storeStats(IndexShard.java:702)\n    at org.elasticsearch.action.admin.indices.stats.CommonStats.<init>(CommonStats.java:134)\n    at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:165)\n    at org.elasticsearch.action.admin.indices.stats.TransportIndicesStatsAction.shardOperation(TransportIndicesStatsAction.java:47)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.onShardOperation(TransportBroadcastByNodeAction.java:420)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:399)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:386)\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:75)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.nio.file.NoSuchFileException: /data/node1-drive1/elasticsearch/nodes/0/indices/.kibana/0/index\n    at sun.nio.fs.UnixException.translateToIOException(UnixException.java:86)\n    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:102)\n    at sun.nio.fs.UnixException.rethrowAsIOException(UnixException.java:107)\n    at sun.nio.fs.UnixFileSystemProvider.newDirectoryStream(UnixFileSystemProvider.java:407)\n    at java.nio.file.Files.newDirectoryStream(Files.java:457)\n    at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:191)\n    at org.apache.lucene.store.FSDirectory.listAll(FSDirectory.java:203)\n    at org.elasticsearch.index.store.FsDirectoryService$1.listAll(FsDirectoryService.java:127)\n    at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n    at org.apache.lucene.store.FilterDirectory.listAll(FilterDirectory.java:57)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.estimateSize(Store.java:1538)\n    at org.elasticsearch.index.store.Store$StoreStatsCache.refresh(Store.java:1530)\n    ... 17 more\n\n```\n\n```\n[2016-05-09 12:22:03,174][WARN ][cluster.action.shard     ] [node1] [index1][1] received shard failed for target shard [[index1][1], node[X4nxoaPZTMqX-RCWBM79Ew], [R], v[17860], s[INITIALIZING], a[id=Og_FzyceRPK2Dt-U0w8SJw], unassigned_info[[reason=ALLOCATION_FAILED], at[2016-05-09T16:22:03.137Z], details[failed to create shard, failure ElasticsearchException[failed to create shard]; nested: AccessControlException[access denied (\"java.io.FilePermission\" \"/data\" \"read\")]; ]]], indexUUID [OlAoAb1cRHydJ-P8CNZFHw], message [failed to create shard], failure [ElasticsearchException[failed to create shard]; nested: AccessControlException[access denied (\"java.io.FilePermission\" \"/data\" \"read\")]; ]\n[index1][[index1][1]] ElasticsearchException[failed to create shard]; nested: AccessControlException[access denied (\"java.io.FilePermission\" \"/data\" \"read\")];\n    at org.elasticsearch.index.IndexService.createShard(IndexService.java:371)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyInitializingShard(IndicesClusterStateService.java:601)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.applyNewOrUpdatedShards(IndicesClusterStateService.java:501)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:166)\n    at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:610)\n    at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.security.AccessControlException: access denied (\"java.io.FilePermission\" \"/data\" \"read\")\n    at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n    at java.security.AccessController.checkPermission(AccessController.java:884)\n    at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n    at java.lang.SecurityManager.checkRead(SecurityManager.java:888)\n    at sun.nio.fs.UnixPath.checkRead(UnixPath.java:795)\n    at sun.nio.fs.UnixFileSystemProvider.checkAccess(UnixFileSystemProvider.java:290)\n    at java.nio.file.Files.createDirectories(Files.java:746)\n    at org.elasticsearch.index.store.FsDirectoryService.newDirectory(FsDirectoryService.java:85)\n    at org.elasticsearch.index.store.Store.<init>(Store.java:123)\n    at org.elasticsearch.index.store.Store.<init>(Store.java:118)\n    at sun.reflect.GeneratedConstructorAccessor9.newInstance(Unknown Source)\n    at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)\n    at java.lang.reflect.Constructor.newInstance(Constructor.java:423)\n    at org.elasticsearch.common.inject.DefaultConstructionProxyFactory$1.newInstance(DefaultConstructionProxyFactory.java:50)\n    at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:86)\n    at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:104)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:887)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:46)\n    at org.elasticsearch.common.inject.SingleParameterInjector.inject(SingleParameterInjector.java:42)\n    at org.elasticsearch.common.inject.SingleParameterInjector.getAll(SingleParameterInjector.java:66)\n    at org.elasticsearch.common.inject.ConstructorInjector.construct(ConstructorInjector.java:85)\n    at org.elasticsearch.common.inject.ConstructorBindingImpl$Factory.get(ConstructorBindingImpl.java:104)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter$1.call(ProviderToInternalFactoryAdapter.java:47)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:887)\n    at org.elasticsearch.common.inject.ProviderToInternalFactoryAdapter.get(ProviderToInternalFactoryAdapter.java:43)\n    at org.elasticsearch.common.inject.Scopes$1$1.get(Scopes.java:59)\n    at org.elasticsearch.common.inject.InternalFactoryToProviderAdapter.get(InternalFactoryToProviderAdapter.java:46)\n    at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:201)\n    at org.elasticsearch.common.inject.InjectorBuilder$1.call(InjectorBuilder.java:193)\n    at org.elasticsearch.common.inject.InjectorImpl.callInContext(InjectorImpl.java:880)\n    at org.elasticsearch.common.inject.InjectorBuilder.loadEagerSingletons(InjectorBuilder.java:193)\n    at org.elasticsearch.common.inject.InjectorBuilder.injectDynamically(InjectorBuilder.java:175)\n    at org.elasticsearch.common.inject.InjectorBuilder.build(InjectorBuilder.java:110)\n    at org.elasticsearch.common.inject.InjectorImpl.createChildInjector(InjectorImpl.java:162)\n    at org.elasticsearch.common.inject.ModulesBuilder.createChildInjector(ModulesBuilder.java:55)\n    at org.elasticsearch.index.IndexService.createShard(IndexService.java:369)\n    ... 10 more\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}