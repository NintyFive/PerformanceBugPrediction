{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24866","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24866/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24866/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24866/events","html_url":"https://github.com/elastic/elasticsearch/issues/24866","id":231100788,"node_id":"MDU6SXNzdWUyMzExMDA3ODg=","number":24866,"title":"Clarify whether the Reindex API handles deletions during the reindex process","user":{"login":"takahashi64","id":14998342,"node_id":"MDQ6VXNlcjE0OTk4MzQy","avatar_url":"https://avatars2.githubusercontent.com/u/14998342?v=4","gravatar_id":"","url":"https://api.github.com/users/takahashi64","html_url":"https://github.com/takahashi64","followers_url":"https://api.github.com/users/takahashi64/followers","following_url":"https://api.github.com/users/takahashi64/following{/other_user}","gists_url":"https://api.github.com/users/takahashi64/gists{/gist_id}","starred_url":"https://api.github.com/users/takahashi64/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/takahashi64/subscriptions","organizations_url":"https://api.github.com/users/takahashi64/orgs","repos_url":"https://api.github.com/users/takahashi64/repos","events_url":"https://api.github.com/users/takahashi64/events{/privacy}","received_events_url":"https://api.github.com/users/takahashi64/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-05-24T16:35:12Z","updated_at":"2017-05-24T17:06:06Z","closed_at":"2017-05-24T17:06:06Z","author_association":"NONE","active_lock_reason":null,"body":"Elastic Search version: 2.4.3\r\n\r\nI would like to use the [Reindex API](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html) to migrate documents from an in-use index in production to a newly created index that has an updated index mapping/definition. \r\n\r\nI stumbled on this [guide](https://summera.github.io/infrastructure/2016/07/04/reindexing-elasticsearch.html) which outlines various approaches to the problem of updating mappings/definition of an index. It points out (what I think to be a valid) an issue with deletions that occur during the document-migration process:\r\n\r\n> Deletes\r\n> \r\n> Deletes are a bit trickier. We canâ€™t handle them like we did writes because there is a race condition. Consider the following problem scenario:\r\n> \r\n> Given:\r\n> \r\n> Record A exists in the old index\r\n> We have started the reindex process, capturing A in the scrolled search snapshot\r\n> Record A is not yet in the new index\r\n> When: A DELETE operation on Record A occurs\r\n> \r\n> Then:\r\n> \r\n> Record A is deleted from old index, but not from our new index because it doesnâ€™t exist yet\r\n> Record A is later indexed into the new index when it is returned from our scrolled search snapshot\r\n> So there is a race condition between deleting and indexing the record. If we reindex Record A before the DELETE operation comes in, we are fine. If we try to DELETE a non-existent Record A in our new index and then insert the same record from our scrolled search, we have a record in our new index that should not exist.ðŸ˜«\r\n> \r\n> Options\r\n> \r\n> Eliminate the possibility of deleting records during reindexing\r\n> Push delete operations to a queue during reindexing to be processed when done\r\n\r\nDoes the Reindex API cater for deletions that occur during the reindexing process or should I follow the proposed options in the guide, or is there another solution?\r\n\r\n\r\n\r\n","closed_by":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}