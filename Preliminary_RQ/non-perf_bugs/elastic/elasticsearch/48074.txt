{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/48074","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48074/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48074/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/48074/events","html_url":"https://github.com/elastic/elasticsearch/issues/48074","id":507359882,"node_id":"MDU6SXNzdWU1MDczNTk4ODI=","number":48074,"title":"Bug - Date field used as sort option can crash ES with BigInteger error","user":{"login":"DemonGyro","id":21047452,"node_id":"MDQ6VXNlcjIxMDQ3NDUy","avatar_url":"https://avatars2.githubusercontent.com/u/21047452?v=4","gravatar_id":"","url":"https://api.github.com/users/DemonGyro","html_url":"https://github.com/DemonGyro","followers_url":"https://api.github.com/users/DemonGyro/followers","following_url":"https://api.github.com/users/DemonGyro/following{/other_user}","gists_url":"https://api.github.com/users/DemonGyro/gists{/gist_id}","starred_url":"https://api.github.com/users/DemonGyro/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DemonGyro/subscriptions","organizations_url":"https://api.github.com/users/DemonGyro/orgs","repos_url":"https://api.github.com/users/DemonGyro/repos","events_url":"https://api.github.com/users/DemonGyro/events{/privacy}","received_events_url":"https://api.github.com/users/DemonGyro/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-10-15T16:39:38Z","updated_at":"2019-10-23T18:01:43Z","closed_at":"2019-10-23T18:01:43Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.3.1\r\n\r\n**Plugins installed**: [discovery-ec2, repository-s3]\r\n\r\n**JVM version** (`java -version`):\r\njava version \"11.0.4\" 2019-07-16 LTS\r\nJava(TM) SE Runtime Environment 18.9 (build 11.0.4+10-LTS)\r\nJava HotSpot(TM) 64-Bit Server VM 18.9 (build 11.0.4+10-LTS, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux XXXXXXXXX 4.15.0-1051-aws #53-Ubuntu SMP Wed Sep 18 13:35:53 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nThe date value returned in the `sort` field returned in a document from `_search` had a value that was invalid. When this was passed back in to the `search_after` field, this caused the request to fail with a `java.lang.AssertionError: Unknown number type []BIG_INTEGER` error. With enough errors, this ended up crashing ES. We were seeing this take down an entire cluster with only a couple requests.\r\n\r\nThe values returned from the `sort` field of a document from `_search` are expected to be valid and are expected to not cause crashes in the ES application.\r\n\r\n**Steps to reproduce**:\r\n1. Create an index that has a date.\r\n```\r\nPUT _template/test_index\r\n{\r\n  \"index_patterns\": [\r\n    \"test*\"\r\n  ],\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"test\": {\r\n          \"type\": \"boolean\"\r\n        },\r\n        \"created\": {\r\n          \"type\": \"date\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n2. Add about a dozen documents. 8 good, 4 bad.\r\n\r\nGood example:\r\n```\r\nPOST /test_0/test\r\n{\r\n  \"test\": true,\r\n  \"created\": \"2017-12-20T15:42:55.6497236+00:00\"\r\n}\r\n```\r\n\r\nBad example:\r\n```\r\nPOST /test_0/test\r\n{\r\n  \"test\": true\r\n}\r\n```\r\n\r\n3. Execute a search on the date field as `sort`\r\n```\r\nPOST /_search\r\n{\r\n    \"query\": {\r\n    \t\"match_all\": {}\r\n    },\r\n    \"sort\": [\r\n        {\r\n            \"created\": {\r\n                \"order\": \"asc\"\r\n            }\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\n4. If done correctly, the last item in the search should look like this:\r\n```\r\n{\r\n        \"_index\": \"test_b10\",\r\n        \"_type\": \"test\",\r\n        \"_id\": \"OSA_0G0BUWBv2lD0FAe4\",\r\n        \"_score\": null,\r\n        \"_source\": {\r\n          \"test\": true\r\n        },\r\n        \"sort\": [\r\n          9223372036854776000\r\n        ]\r\n}\r\n```\r\n\r\n5. Execute a search with the last item's sort value as the `search_after` field.\r\n```\r\n{\r\n    \"query\": {\r\n        \"match_all\": {}\r\n    },\r\n    \"sort\": [\r\n        {\r\n            \"created\": {\r\n                \"order\": \"asc\"\r\n            }\r\n        }\r\n    ],\r\n    \"search_after\": [\r\n        9223372036854776000\r\n    ]\r\n}\r\n```\r\n\r\n6. Result from search should be a 500 error.\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"illegal_state_exception\",\r\n        \"reason\": \"No matching token for number_type [BIG_INTEGER]\"\r\n      }\r\n    ],\r\n    \"type\": \"illegal_state_exception\",\r\n    \"reason\": \"No matching token for number_type [BIG_INTEGER]\"\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\n**Stack Trace**\r\n```\r\n[2019-10-10T20:34:56,297][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [ES_NODE_NAME] fatal error in thread [Thread-6470], exiting\r\njava.lang.AssertionError: Unknown number type []BIG_INTEGER\r\n        at org.elasticsearch.search.searchafter.SearchAfterBuilder.fromXContent(SearchAfterBuilder.java:247) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.search.builder.SearchSourceBuilder.parseXContent(SearchSourceBuilder.java:1189) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.action.search.RestSearchAction.parseSearchRequest(RestSearchAction.java:131) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.action.search.RestSearchAction.lambda$prepareRequest$1(RestSearchAction.java:110) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.RestRequest.withContentOrSourceParamParserOrNull(RestRequest.java:449) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.action.search.RestSearchAction.prepareRequest(RestSearchAction.java:109) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.BaseRestHandler.handleRequest(BaseRestHandler.java:92) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.xpack.security.rest.SecurityRestFilter.handleRequest(SecurityRestFilter.java:69) ~[?:?]\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:240) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.RestController.tryAllHandlers(RestController.java:344) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:174) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.http.AbstractHttpServerTransport.dispatchRequest(AbstractHttpServerTransport.java:320) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.http.AbstractHttpServerTransport.handleIncomingRequest(AbstractHttpServerTransport.java:370) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.http.AbstractHttpServerTransport.incomingRequest(AbstractHttpServerTransport.java:299) ~[elasticsearch-7.3.1.jar:7.3.1]\r\n        at org.elasticsearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:66) ~[?:?]\r\n        at org.elasticsearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:31) ~[?:?]\r\n        at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at org.elasticsearch.http.netty4.Netty4HttpPipeliningHandler.channelRead(Netty4HttpPipeliningHandler.java:58) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102) ~[?:?]\r\n        at io.netty.handler.codec.MessageToMessageCodec.channelRead(MessageToMessageCodec.java:111) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:323) ~[?:?]\r\n        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:297) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at io.netty.handler.timeout.IdleStateHandler.channelRead(IdleStateHandler.java:287) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:352) ~[?:?]\r\n        at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1408) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:374) ~[?:?]\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:360) ~[?:?]\r\n        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:930) ~[?:?]\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:163) ~[?:?]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:682) ~[?:?]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:582) ~[?:?]\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:536) ~[?:?]\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:496) ~[?:?]\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:906) ~[?:?]\r\n        at io.netty.util.internal.ThreadExecutorMap$2.run(ThreadExecutorMap.java:74) ~[?:?]\r\n        at java.lang.Thread.run(Thread.java:835) [?:?]\r\n```","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}