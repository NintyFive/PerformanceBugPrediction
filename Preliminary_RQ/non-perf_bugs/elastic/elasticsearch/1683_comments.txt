[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/3873212","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-3873212","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":3873212,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NzMyMTI=","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2012-02-08T18:42:03Z","updated_at":"2012-02-08T18:42:03Z","author_association":"MEMBER","body":"It actually used to be in the reverse order, but then, multi valued fields with small amount of valued would cause a lot of memory to be allocated (many more arrays) and make the job of the GC harder.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/3873571","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-3873571","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":3873571,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NzM1NzE=","user":{"login":"Alex-Ikanow","id":851950,"node_id":"MDQ6VXNlcjg1MTk1MA==","avatar_url":"https://avatars2.githubusercontent.com/u/851950?v=4","gravatar_id":"","url":"https://api.github.com/users/Alex-Ikanow","html_url":"https://github.com/Alex-Ikanow","followers_url":"https://api.github.com/users/Alex-Ikanow/followers","following_url":"https://api.github.com/users/Alex-Ikanow/following{/other_user}","gists_url":"https://api.github.com/users/Alex-Ikanow/gists{/gist_id}","starred_url":"https://api.github.com/users/Alex-Ikanow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alex-Ikanow/subscriptions","organizations_url":"https://api.github.com/users/Alex-Ikanow/orgs","repos_url":"https://api.github.com/users/Alex-Ikanow/repos","events_url":"https://api.github.com/users/Alex-Ikanow/events{/privacy}","received_events_url":"https://api.github.com/users/Alex-Ikanow/received_events","type":"User","site_admin":false},"created_at":"2012-02-08T18:58:04Z","updated_at":"2012-02-08T18:58:04Z","author_association":"NONE","body":"I figured it was GC-related! \n\nThat was partly the reason for my alternative suggestion of picking a smaller number of \"offending\" documents, giving them an ordinals.get(0).geo(docId) value of -1 and then indexing them the other way round.\n\nI can't believe my sort of scenario will be that rare, seems like it would be something you'd want to the tool to handle without application-level \"grovelling\".\n\n(On the subject of which, I'm just testing out putting docs with >20 geos in their own index now, which I hope will have a similar effect.)\n\nIncidentally, since I just discovered Java ints are always 32b (ahem!), I'm now out by x4 on my geo usage estimates, ie based on a single instance of the ordinals array I'd expect \"4B \\* 2.3M \\* 155\"= 1.4GB per replica/original, ie ~3GB in total for original + 1 replica ... whereas my actual field cache usage is 6GB the first time I run the facet, and 12GB the second time. \n\nAny idea where my estimation error might be? How many copies of ordinals do you think are being made? The only other significant memory usage would be some array of unique terms (maybe 10K), which should be relatively tiny.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/4116181","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-4116181","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":4116181,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMTYxODE=","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2012-02-22T19:13:42Z","updated_at":"2012-02-22T19:13:42Z","author_association":"MEMBER","body":"The reason for the current structure is simple, imagine having maximum of 5 \"tags\" pre doc (multi valued part) and having a million docs (in a single Lucene segment). Instead of having 1 million arrays with 5 ordinals, with the current scheme, you have 5 arrays with 1 million slots (much better memory usage wise).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/4120902","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-4120902","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":4120902,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjA5MDI=","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2012-02-22T20:23:32Z","updated_at":"2012-02-22T20:23:32Z","author_association":"MEMBER","body":"We also have a couple of use cases where the number of tokens per field varies greatly. There are few records with hundreds of tokens in a field, and many records that have only a couple of tokens in the same field. The distribution doesn't match Zipf's law but gets quite close. The current data structure seems to be inefficient in such use cases. \n\nAnother issue with the current data structure is that a single outlier record with a lot of tokens, when merged into a large segment, can significantly and suddenly increase memory requirements on an index that was running fine before that. \n\nShay, are you planning to change it in 0.20? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/4133573","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-4133573","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":4133573,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzM1NzM=","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2012-02-23T09:59:00Z","updated_at":"2012-02-23T09:59:00Z","author_association":"CONTRIBUTOR","body":"++ we have a similar issue\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/4139331","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-4139331","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":4139331,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMzkzMzE=","user":{"login":"Alex-Ikanow","id":851950,"node_id":"MDQ6VXNlcjg1MTk1MA==","avatar_url":"https://avatars2.githubusercontent.com/u/851950?v=4","gravatar_id":"","url":"https://api.github.com/users/Alex-Ikanow","html_url":"https://github.com/Alex-Ikanow","followers_url":"https://api.github.com/users/Alex-Ikanow/followers","following_url":"https://api.github.com/users/Alex-Ikanow/following{/other_user}","gists_url":"https://api.github.com/users/Alex-Ikanow/gists{/gist_id}","starred_url":"https://api.github.com/users/Alex-Ikanow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alex-Ikanow/subscriptions","organizations_url":"https://api.github.com/users/Alex-Ikanow/orgs","repos_url":"https://api.github.com/users/Alex-Ikanow/repos","events_url":"https://api.github.com/users/Alex-Ikanow/events{/privacy}","received_events_url":"https://api.github.com/users/Alex-Ikanow/received_events","type":"User","site_admin":false},"created_at":"2012-02-23T16:19:02Z","updated_at":"2012-02-23T16:19:02Z","author_association":"NONE","body":"Since I bizarrely don't seem to have explicitly mentioned it in this thread: note that there's a simple workaround for the issue: create a separate index and put your \"top\" X% of documents (in terms of number of fields) in that. \n\nThis results in a small index with many fields and a large index with few fields. In my case I reduced memory usage from ~14GB to ~2GB by putting ~0.1% docs in the new index (I picked the thresholds pretty lazily so I'm sure you could do even better).\n\n(Apologies for repeating myself in every thread!)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/9750921","html_url":"https://github.com/elastic/elasticsearch/issues/1683#issuecomment-9750921","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","id":9750921,"node_id":"MDEyOklzc3VlQ29tbWVudDk3NTA5MjE=","user":{"login":"Alex-Ikanow","id":851950,"node_id":"MDQ6VXNlcjg1MTk1MA==","avatar_url":"https://avatars2.githubusercontent.com/u/851950?v=4","gravatar_id":"","url":"https://api.github.com/users/Alex-Ikanow","html_url":"https://github.com/Alex-Ikanow","followers_url":"https://api.github.com/users/Alex-Ikanow/followers","following_url":"https://api.github.com/users/Alex-Ikanow/following{/other_user}","gists_url":"https://api.github.com/users/Alex-Ikanow/gists{/gist_id}","starred_url":"https://api.github.com/users/Alex-Ikanow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alex-Ikanow/subscriptions","organizations_url":"https://api.github.com/users/Alex-Ikanow/orgs","repos_url":"https://api.github.com/users/Alex-Ikanow/repos","events_url":"https://api.github.com/users/Alex-Ikanow/events{/privacy}","received_events_url":"https://api.github.com/users/Alex-Ikanow/received_events","type":"User","site_admin":false},"created_at":"2012-10-24T18:34:54Z","updated_at":"2012-10-24T18:34:54Z","author_association":"NONE","body":"Eh just noticed I never closed this - apologies!\n","performed_via_github_app":null}]