{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17485","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17485/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17485/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17485/events","html_url":"https://github.com/elastic/elasticsearch/issues/17485","id":145268917,"node_id":"MDU6SXNzdWUxNDUyNjg5MTc=","number":17485,"title":"analyzers on non-string fields do not migrate correctly to 2.2","user":{"login":"plebedev","id":5315507,"node_id":"MDQ6VXNlcjUzMTU1MDc=","avatar_url":"https://avatars2.githubusercontent.com/u/5315507?v=4","gravatar_id":"","url":"https://api.github.com/users/plebedev","html_url":"https://github.com/plebedev","followers_url":"https://api.github.com/users/plebedev/followers","following_url":"https://api.github.com/users/plebedev/following{/other_user}","gists_url":"https://api.github.com/users/plebedev/gists{/gist_id}","starred_url":"https://api.github.com/users/plebedev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/plebedev/subscriptions","organizations_url":"https://api.github.com/users/plebedev/orgs","repos_url":"https://api.github.com/users/plebedev/repos","events_url":"https://api.github.com/users/plebedev/events{/privacy}","received_events_url":"https://api.github.com/users/plebedev/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-04-01T19:49:01Z","updated_at":"2016-04-04T19:40:24Z","closed_at":"2016-04-04T19:40:24Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.2.0\n\n**JVM version**: 1.7 or 1.8\n\n**OS version**: OSX 10.9.5 but it does not really matter, issue is reproducible on various Linux flavors as well.\n\n**Description of the problem including expected versus actual behavior**:\nLooks like there was a change in 2.2 related to analyzers. \nIn 2.0 you can specify analyzer and search_analyzer on any filed type. In 2.2 you can only do it for 'string' types. It maybe makes sense but it is not compatible with previous versions and many cases fail in different way.\n\n**Steps to reproduce**:\n_With 2.0.2, create a new index:_\n\n```\nPUT index_try123\n{\n  \"mappings\": {\n    \"doc\": {\n      \"properties\": {\n        \"prop1\": {\n          \"type\": \"boolean\",\n          \"analyzer\": \"standard\"\n        },\n        \"prop2\": {\n          \"type\": \"string\",\n          \"analyzer\": \"standard\",\n          \"search_analyzer\": \"standard\"\n        }\n      }\n    }\n  }\n}\n```\n\n_Upgrade ES to 2.2.1_\n\n_Try to update the mapping:_\n\n```\nPUT index_try123/_mapping/doc\n{\n  \"properties\": {\n        \"prop1\": {\n          \"type\": \"boolean\"\n        },\n        \"prop2\": {\n          \"type\": \"string\",\n          \"analyzer\": \"standard\"\n        },\n        \"prop3\": {\n          \"type\": \"string\",\n          \"analyzer\": \"standard\"\n        }\n      }\n}\n\n```\n\nThis fails with the error:\n\n```\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"mapper_parsing_exception\",\n            \"reason\": \"analyzer [_keyword] not found for field [prop1]\"\n         }\n      ],\n      \"type\": \"mapper_parsing_exception\",\n      \"reason\": \"analyzer [_keyword] not found for field [prop1]\"\n   },\n   \"status\": 400\n}\n```\n\nIf you look at the index after you created it with 2.0.1, you will see \"search_analyzer\": \"_keyword\" added to prop1.\n\n_Now, delete the index and try to create it again:_\n\n```\nDELETE index_try123\n\nPUT index_try123\n{\n  \"mappings\": {\n    \"doc\": {\n      \"properties\": {\n        \"prop1\": {\n          \"type\": \"boolean\",\n          \"analyzer\": \"standard\"\n        },\n        \"prop2\": {\n          \"type\": \"string\",\n          \"analyzer\": \"standard\",\n          \"search_analyzer\": \"standard\"\n        }\n      }\n    }\n  }\n}\n```\n\nThis now fails with this error:\n\n```\n{\n   \"error\": {\n      \"root_cause\": [\n         {\n            \"type\": \"mapper_parsing_exception\",\n            \"reason\": \"Mapping definition for [prop1] has unsupported parameters:  [analyzer : standard]\"\n         }\n      ],\n      \"type\": \"mapper_parsing_exception\",\n      \"reason\": \"Failed to parse mapping [doc]: Mapping definition for [prop1] has unsupported parameters:  [analyzer : standard]\",\n      \"caused_by\": {\n         \"type\": \"mapper_parsing_exception\",\n         \"reason\": \"Mapping definition for [prop1] has unsupported parameters:  [analyzer : standard]\"\n      }\n   },\n   \"status\": 400\n}\n```\n\nSo, if you had a mapping with an analyzer set on non-string field in 2.0, and then migrate to 2.2, you can't update existing mappings,  nor you can create the same mapping on a fresh installation without modifying the put request.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}