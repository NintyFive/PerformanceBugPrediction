{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12119","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12119/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12119/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12119/events","html_url":"https://github.com/elastic/elasticsearch/issues/12119","id":93723951,"node_id":"MDU6SXNzdWU5MzcyMzk1MQ==","number":12119,"title":"Filters-Aggregation does not work with children-aggregation","user":{"login":"tlmnb","id":1886755,"node_id":"MDQ6VXNlcjE4ODY3NTU=","avatar_url":"https://avatars1.githubusercontent.com/u/1886755?v=4","gravatar_id":"","url":"https://api.github.com/users/tlmnb","html_url":"https://github.com/tlmnb","followers_url":"https://api.github.com/users/tlmnb/followers","following_url":"https://api.github.com/users/tlmnb/following{/other_user}","gists_url":"https://api.github.com/users/tlmnb/gists{/gist_id}","starred_url":"https://api.github.com/users/tlmnb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlmnb/subscriptions","organizations_url":"https://api.github.com/users/tlmnb/orgs","repos_url":"https://api.github.com/users/tlmnb/repos","events_url":"https://api.github.com/users/tlmnb/events{/privacy}","received_events_url":"https://api.github.com/users/tlmnb/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-07-08T07:55:23Z","updated_at":"2015-07-08T08:32:49Z","closed_at":"2015-07-08T08:32:49Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\n\nI don't know whether this is a bug, a feature or I did not understand something, but consider the following mapping/data:\n\n```\nDELETE /test\n\nPUT /test\n{\n    \"mappings\": {\n        \"document\": {\n            \"properties\": {\n                \"a\": {\n                    \"type\": \"string\"\n                }\n            }\n        },\n        \"subdocument\": {\n            \"_parent\": {\n               \"type\": \"document\"\n            }, \n            \"properties\": {\n                \"str\": {\n                    \"type\": \"string\"\n                },\n                \"int\": {\n                    \"type\": \"integer\"\n                }\n            }\n        }\n    }\n}\nPOST /test/document/1\n{\n    \"a\": \"x\"   \n}\nPOST /test/subdocument/1?parent=1\n{\n    \"str\": \"a\",\n    \"int\": 1 \n}\n\n```\n\nIf I try to aggregate the data with a combination of a children-aggregation and a filters-aggregation I get results, which seem wrong to me:\n\n```\nPOST /test/document/_search\n{\n   \"query\": {\n      \"match_all\": {}\n   },\n   \"aggregations\": {\n      \"subdocuments\": {\n         \"children\": {\n            \"type\": \"subdocument\"\n         },\n         \"aggregations\": {\n            \"f\": {\n               \"filters\": {\n                  \"filters\": {\n                     \"0\": {\n                        \"term\": {\n                           \"int\": 1\n                        }\n                     }\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n```\n\ngives back\n\n```\n{\n   \"took\": 1,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"test\",\n            \"_type\": \"document\",\n            \"_id\": \"1\",\n            \"_score\": 1,\n            \"_source\": {\n               \"a\": \"x\"\n            }\n         }\n      ]\n   },\n   \"aggregations\": {\n      \"subdocuments\": {\n         \"doc_count\": 1,\n         \"f\": {\n            \"buckets\": {\n               \"0\": {\n                  \"doc_count\": 0\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nIf I filter on a string-field I get some results as expected:\n\n```\nPOST /test/document/_search\n{\n   \"query\": {\n      \"match_all\": {}\n   },\n   \"aggregations\": {\n      \"subdocuments\": {\n         \"children\": {\n            \"type\": \"subdocument\"\n         },\n         \"aggregations\": {\n            \"f\": {\n               \"filters\": {\n                  \"filters\": {\n                     \"0\": {\n                        \"term\": {\n                           \"str\": \"a\"\n                        }\n                     }\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n```\n\ngives:\n\n```\n{\n   \"took\": 1,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"test\",\n            \"_type\": \"document\",\n            \"_id\": \"1\",\n            \"_score\": 1,\n            \"_source\": {\n               \"a\": \"x\"\n            }\n         }\n      ]\n   },\n   \"aggregations\": {\n      \"subdocuments\": {\n         \"doc_count\": 1,\n         \"f\": {\n            \"buckets\": {\n               \"0\": {\n                  \"doc_count\": 1\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nAnyhow, the filters-aggregations with a filter on the int-field is working without the children-aggregation:\n\n```\nPOST /test/subdocument/_search\n{\n   \"query\": {\n      \"match_all\": {}\n   },\n   \"aggregations\": {\n      \"f\": {\n         \"filters\": {\n            \"filters\": {\n               \"0\": {\n                  \"term\": {\n                     \"int\": 1\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n\n{\n   \"took\": 1,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"test\",\n            \"_type\": \"subdocument\",\n            \"_id\": \"1\",\n            \"_score\": 1,\n            \"_source\": {\n               \"str\": \"a\",\n               \"int\": 1\n            }\n         }\n      ]\n   },\n   \"aggregations\": {\n      \"f\": {\n         \"buckets\": {\n            \"0\": {\n               \"doc_count\": 1\n            }\n         }\n      }\n   }\n}\n```\n\nI'm using ES 1.6. \n","closed_by":{"login":"tlmnb","id":1886755,"node_id":"MDQ6VXNlcjE4ODY3NTU=","avatar_url":"https://avatars1.githubusercontent.com/u/1886755?v=4","gravatar_id":"","url":"https://api.github.com/users/tlmnb","html_url":"https://github.com/tlmnb","followers_url":"https://api.github.com/users/tlmnb/followers","following_url":"https://api.github.com/users/tlmnb/following{/other_user}","gists_url":"https://api.github.com/users/tlmnb/gists{/gist_id}","starred_url":"https://api.github.com/users/tlmnb/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlmnb/subscriptions","organizations_url":"https://api.github.com/users/tlmnb/orgs","repos_url":"https://api.github.com/users/tlmnb/repos","events_url":"https://api.github.com/users/tlmnb/events{/privacy}","received_events_url":"https://api.github.com/users/tlmnb/received_events","type":"User","site_admin":false},"performed_via_github_app":null}