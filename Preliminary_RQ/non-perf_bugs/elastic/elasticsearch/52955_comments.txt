[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592568209","html_url":"https://github.com/elastic/elasticsearch/issues/52955#issuecomment-592568209","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52955","id":592568209,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjU2ODIwOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T15:39:14Z","updated_at":"2020-02-28T15:39:14Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security (:Security/Authorization)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592569266","html_url":"https://github.com/elastic/elasticsearch/issues/52955#issuecomment-592569266","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52955","id":592569266,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjU2OTI2Ng==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T15:41:37Z","updated_at":"2020-02-28T15:41:37Z","author_association":"MEMBER","body":"Given that it does not repro and it sporadically fails, shall we keep the test around to potentially collect more info or shall I mute it already?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/617076114","html_url":"https://github.com/elastic/elasticsearch/issues/52955#issuecomment-617076114","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52955","id":617076114,"node_id":"MDEyOklzc3VlQ29tbWVudDYxNzA3NjExNA==","user":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"created_at":"2020-04-21T09:49:48Z","updated_at":"2020-04-21T09:49:48Z","author_association":"CONTRIBUTOR","body":"Another failure in 7.x: https://gradle-enterprise.elastic.co/s/rssnr4evzsaww","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/621665733","html_url":"https://github.com/elastic/elasticsearch/issues/52955#issuecomment-621665733","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52955","id":621665733,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMTY2NTczMw==","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"created_at":"2020-04-30T07:33:23Z","updated_at":"2020-04-30T07:33:23Z","author_association":"CONTRIBUTOR","body":"We suspect this might have only been broken for a few weeks and the issue from 9 days ago is something different, but @ywangd will followup and see where we are.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/624546838","html_url":"https://github.com/elastic/elasticsearch/issues/52955#issuecomment-624546838","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52955","id":624546838,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNDU0NjgzOA==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2020-05-06T09:43:46Z","updated_at":"2020-05-06T09:43:46Z","author_association":"CONTRIBUTOR","body":"Happened again in master (`testAutoReload`) :https://gradle-enterprise.elastic.co/s/uftgjwlhgiunm","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/625221026","html_url":"https://github.com/elastic/elasticsearch/issues/52955#issuecomment-625221026","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52955","id":625221026,"node_id":"MDEyOklzc3VlQ29tbWVudDYyNTIyMTAyNg==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-05-07T12:20:23Z","updated_at":"2020-05-07T12:20:23Z","author_association":"MEMBER","body":"This is a genuine issue with the test code. I can reliably reproduce it locally by inserting `Thread.sleep(200);` before the first `writer.append` call:\r\nhttps://github.com/elastic/elasticsearch/blob/0097a86d5389d990387005d64a908777dcf61ff6/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java#L427-L431\r\n\r\nThe main reason of the failure is that the `BufferedWriter` does not write file atomically. If there is any delay after the file is opened (with trunction), it is picked up by the FileWatcher and the content is parsed for roles. Since the file is empty, we get no role back.\r\n\r\nNow the test code does check whether the expected role is in the change-set (reported by FileWatcher) before asserting the existence of the Role (where the test failed). However, we do not differentiate the change-set between \"deleted\", \"inserted\" or \"update\". The test code really wanted an \"updated\" change-set, but it accepted a \"deleted\" one because role name is the same and it cannot tell the type of the change-set (`modifiedFileRolesModified` is the change-set in the following code):\r\nhttps://github.com/elastic/elasticsearch/blob/0097a86d5389d990387005d64a908777dcf61ff6/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authz/store/FileRolesStoreTests.java#L435\r\n\r\nI will fix this with a PR to basically perform file move instead of write to avoid the race condition.","performed_via_github_app":null}]