{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23692","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23692/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23692/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23692/events","html_url":"https://github.com/elastic/elasticsearch/issues/23692","id":215968635,"node_id":"MDU6SXNzdWUyMTU5Njg2MzU=","number":23692,"title":"ES system CPU spikes to 100% despite of having small amount of data","user":{"login":"rajshah1593","id":26591802,"node_id":"MDQ6VXNlcjI2NTkxODAy","avatar_url":"https://avatars2.githubusercontent.com/u/26591802?v=4","gravatar_id":"","url":"https://api.github.com/users/rajshah1593","html_url":"https://github.com/rajshah1593","followers_url":"https://api.github.com/users/rajshah1593/followers","following_url":"https://api.github.com/users/rajshah1593/following{/other_user}","gists_url":"https://api.github.com/users/rajshah1593/gists{/gist_id}","starred_url":"https://api.github.com/users/rajshah1593/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rajshah1593/subscriptions","organizations_url":"https://api.github.com/users/rajshah1593/orgs","repos_url":"https://api.github.com/users/rajshah1593/repos","events_url":"https://api.github.com/users/rajshah1593/events{/privacy}","received_events_url":"https://api.github.com/users/rajshah1593/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-03-22T06:46:25Z","updated_at":"2017-03-22T07:06:32Z","closed_at":"2017-03-22T07:06:32Z","author_association":"NONE","active_lock_reason":null,"body":"Hello,\r\n\r\nI am using Elastic Search v5.2.2.\r\nI have a single node cluster with 3 primary shards & 0 replica shard.\r\nTotal documents are around 10 million with 5 GB of data.\r\n\r\nI have disabled scoring and most of the fields in my index are not_analyzed.\r\nI am also using the pre-load feature where I load all the files (index.store.preload : [\"*\"]) before beginning the search operations.\r\n\r\nCurrently, I have 128 GB RAM and 1.5 TB of hard disk....Heap size is set to 8 GB.\r\n\r\nInspite of having such a small amount of data and a high performance machine, my CPU spikes to 100% and performance is not as expected.\r\n\r\nWhat might be the reason for such slow performance?\r\nAnd what can be interpreted from the following hot thread output? I can see Scorers in the output even though I have disabled scoring.\r\n\r\nThanks.\r\n\r\n\r\n```\r\n::: {sys217}{NDgCEjjcT9CT32i4JlMmWQ}{FILT-0ulRc64Osy1EIUICw}{172.24.22.217}{172.24.22.217:9300}\r\n   Hot threads at 2017-03-19T13:30:33.282Z, interval=500ms, busiestThreads=3, ignoreIdleThreads=true:\r\n   \r\n   81.1% (405.6ms out of 500ms) cpu usage by thread 'elasticsearch[sys217][search][T#12]'\r\n     2/10 snapshots sharing following 23 elements\r\n       org.apache.lucene.codecs.blocktree.IntersectTermsEnum.next(IntersectTermsEnum.java:500)\r\n       org.apache.lucene.search.MultiTermQueryConstantScoreWrapper$1.rewrite(MultiTermQueryConstantScoreWrapper.java:176)\r\n       org.apache.lucene.search.MultiTermQueryConstantScoreWrapper$1.scorer(MultiTermQueryConstantScoreWrapper.java:208)\r\n       org.apache.lucene.search.BooleanWeight.scorer(BooleanWeight.java:389)\r\n       org.apache.lucene.search.Weight.bulkScorer(Weight.java:135)\r\n       org.apache.lucene.search.BooleanWeight.bulkScorer(BooleanWeight.java:370)\r\n       org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:106)\r\n       org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:246)\r\n       org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:260)\r\n       org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:298)\r\n       org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)\r\n       org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:610)\r\n       org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596)\r\n       org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n     2/10 snapshots sharing following 31 elements\r\n       org.apache.lucene.util.automaton.Operations.determinize(Operations.java:728)\r\n       org.apache.lucene.util.automaton.Operations.getCommonSuffixBytesRef(Operations.java:1163)\r\n       org.apache.lucene.util.automaton.CompiledAutomaton.<init>(CompiledAutomaton.java:238)\r\n       org.apache.lucene.search.AutomatonQuery.<init>(AutomatonQuery.java:102)\r\n       org.apache.lucene.search.TermRangeQuery.<init>(TermRangeQuery.java:66)\r\n       org.elasticsearch.index.mapper.StringFieldType.rangeQuery(StringFieldType.java:93)\r\n       org.elasticsearch.index.query.RangeQueryBuilder.doToQuery(RangeQueryBuilder.java:517)\r\n       org.elasticsearch.index.query.AbstractQueryBuilder.toQuery(AbstractQueryBuilder.java:97)\r\n       org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)\r\n       org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:610)\r\n       org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596)\r\n       org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n     2/10 snapshots sharing following 19 elements\r\n       org.apache.lucene.search.BooleanWeight.scorer(BooleanWeight.java:389)\r\n       org.apache.lucene.search.Weight.bulkScorer(Weight.java:135)\r\n       org.apache.lucene.search.BooleanWeight.bulkScorer(BooleanWeight.java:370)\r\n       org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:106)\r\n       org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:260)\r\n                  org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:295)\r\n       org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)\r\n       org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:610)\r\n       org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596)\r\n       org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n     2/10 snapshots sharing following 26 elements\r\n       java.lang.Throwable.fillInStackTrace(Native Method)\r\n       java.lang.Throwable.fillInStackTrace(Throwable.java:783)\r\n       java.lang.Throwable.<init>(Throwable.java:250)\r\n       java.lang.Error.<init>(Error.java:58)\r\n\r\n       org.apache.lucene.queryparser.classic.MapperQueryParser.<init>(MapperQueryParser.java:86)\r\n       org.elasticsearch.index.query.QueryShardContext.<init>(QueryShardContext.java:94)\r\n       org.elasticsearch.index.IndexService.newQueryShardContext(IndexService.java:470)\r\n       org.elasticsearch.search.DefaultSearchContext.<init>(DefaultSearchContext.java:171)\r\n       org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:298)\r\n       \r\n       org.apache.lucene.util.automaton.Operations.getCommonSuffixBytesRef(Operations.java:1163)\r\n       org.apache.lucene.util.automaton.CompiledAutomaton.<init>(CompiledAutomaton.java:238)\r\n       org.apache.lucene.search.AutomatonQuery.<init>(AutomatonQuery.java:102)\r\n       org.apache.lucene.search.TermRangeQuery.<init>(TermRangeQuery.java:66)\r\n       org.elasticsearch.index.mapper.StringFieldType.rangeQuery(StringFieldType.java:93)\r\n       org.elasticsearch.index.query.RangeQueryBuilder.doToQuery(RangeQueryBuilder.java:517)\r\n       org.elasticsearch.index.query.AbstractQueryBuilder.toQuery(AbstractQueryBuilder.java:97)\r\n       org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69)\r\n       org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:610)\r\n       org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:596)\r\n       org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n       java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\r\n       java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\r\n       java.lang.Thread.run(Thread.java:745)\r\n```","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}