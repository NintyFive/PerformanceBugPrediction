{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25353","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25353/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25353/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25353/events","html_url":"https://github.com/elastic/elasticsearch/issues/25353","id":237846209,"node_id":"MDU6SXNzdWUyMzc4NDYyMDk=","number":25353,"title":"Routing Lost on Single Node Cluster Recovery [community plugins involved]","user":{"login":"daviddyball","id":1235844,"node_id":"MDQ6VXNlcjEyMzU4NDQ=","avatar_url":"https://avatars2.githubusercontent.com/u/1235844?v=4","gravatar_id":"","url":"https://api.github.com/users/daviddyball","html_url":"https://github.com/daviddyball","followers_url":"https://api.github.com/users/daviddyball/followers","following_url":"https://api.github.com/users/daviddyball/following{/other_user}","gists_url":"https://api.github.com/users/daviddyball/gists{/gist_id}","starred_url":"https://api.github.com/users/daviddyball/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/daviddyball/subscriptions","organizations_url":"https://api.github.com/users/daviddyball/orgs","repos_url":"https://api.github.com/users/daviddyball/repos","events_url":"https://api.github.com/users/daviddyball/events{/privacy}","received_events_url":"https://api.github.com/users/daviddyball/received_events","type":"User","site_admin":false},"labels":[{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-06-22T13:30:24Z","updated_at":"2017-06-22T14:06:31Z","closed_at":"2017-06-22T14:02:27Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: 2.3.3\r\n\r\n**Plugins installed**: [ kiwionly/elasticsearch-image, mobz/head, cloud-aws]\r\n\r\n**JVM version** (`java -version`):\r\n```\r\nopenjdk version \"1.8.0_91\"\r\nOpenJDK Runtime Environment (build 1.8.0_91-8u91-b14-1~bpo8+1-b14)\r\nOpenJDK 64-Bit Server VM (build 25.91-b14, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nDocker image version `elasticsearch:2.3.3` from Docker Hub\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe had a single-node cluster get overloaded and the search queue backed up. We did a `kill -TERM` to restart it gracefully, but after it came up most of the documents in our index were unavailable by the GET API. After reading in lots of places that documents being unavailable in GET is usually related to routing issues, I discovered doing `curl localhost:9201/my_index/document/{id}?routing=4` was able to return my documents. We've *never* used custom routing on our clusters (and this is a single-node anyway, so irrelevant). So I'm wondering what is causing this.\r\n\r\nOne thing that comes to mind is a bug in the `elasticsearch-image` plugin whereby an index has to be created with `index.version.created` always set to `1070499` regardless of the actual version of ES you're using to create the index (bug raised here: https://github.com/kiwionly/elasticsearch-image/issues/17). I noticed that, after a restart of the node there are additional `legacy.routing` options set in the index `_settings`. Could this be causing the routing confusion?\r\n\r\nWhile I appreciate that there is an obscure community plugin in the mix, I'd be really keen to know if there is a way to get back to a state where I no longer have to specify `routing=4` on every GET request in order to see documents?\r\n\r\n\r\n**Steps to reproduce**:\r\n 1. Install `elasticsearch-image`\r\n 2. Index settings\r\n    ```\r\n    {\r\n      \"my_index\": {\r\n        \"settings\": {\r\n          \"index\": {\r\n            \"version\": {\r\n              \"created\": \"1070499\"\r\n            },\r\n            \"uuid\": \"3UTJJ0CoR2WxjyfajGr36Q\",\r\n            \"number_of_replicas\": \"0\",\r\n            \"creation_date\": \"1498056689819\",\r\n            \"number_of_shards\": \"5\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n    ```\r\n 3. Mappings\r\n    ```\r\n\t{\r\n\t  \"my_index\": {\r\n\t\t\"mappings\": {\r\n\t\t  \"document\": {\r\n\t\t\t\"properties\": {\r\n\t\t\t  \"image\": {\r\n\t\t\t\t\"metadata\": {},\r\n\t\t\t\t\"feature\": {\r\n\t\t\t\t  \"JCD\": {\r\n\t\t\t\t\t\"hash\": [\r\n\t\t\t\t\t  \"BIT_SAMPLING\"\r\n\t\t\t\t\t]\r\n\t\t\t\t  }\r\n\t\t\t\t},\r\n\t\t\t\t\"type\": \"image\"\r\n\t\t\t  }\r\n\t\t\t},\r\n\t\t\t\"_timestamp\": {}\r\n\t\t  }\r\n\t\t}\r\n\t  }\r\n\t}\r\n    ```\r\n 4. Shutdown the node and restart it.\r\n 5. The index settings has the following added to it, which I believe is caused by the index originally being created with `settings.index.version.created=1070499`:\r\n    ```\r\n    \"legacy\": {\r\n      \"routing\": {\r\n        \"use_type\": \"false\",\r\n        \"hash\": {\r\n          \"type\": \"org.elasticsearch.cluster.routing.DjbHashFunction\"\r\n        }\r\n      }\r\n    }\r\n    ```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"tlrx","id":642733,"node_id":"MDQ6VXNlcjY0MjczMw==","avatar_url":"https://avatars1.githubusercontent.com/u/642733?v=4","gravatar_id":"","url":"https://api.github.com/users/tlrx","html_url":"https://github.com/tlrx","followers_url":"https://api.github.com/users/tlrx/followers","following_url":"https://api.github.com/users/tlrx/following{/other_user}","gists_url":"https://api.github.com/users/tlrx/gists{/gist_id}","starred_url":"https://api.github.com/users/tlrx/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tlrx/subscriptions","organizations_url":"https://api.github.com/users/tlrx/orgs","repos_url":"https://api.github.com/users/tlrx/repos","events_url":"https://api.github.com/users/tlrx/events{/privacy}","received_events_url":"https://api.github.com/users/tlrx/received_events","type":"User","site_admin":false},"performed_via_github_app":null}