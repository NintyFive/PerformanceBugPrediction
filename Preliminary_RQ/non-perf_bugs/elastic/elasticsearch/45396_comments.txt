[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/519982945","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-519982945","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":519982945,"node_id":"MDEyOklzc3VlQ29tbWVudDUxOTk4Mjk0NQ==","user":{"login":"kakra","id":17684,"node_id":"MDQ6VXNlcjE3Njg0","avatar_url":"https://avatars3.githubusercontent.com/u/17684?v=4","gravatar_id":"","url":"https://api.github.com/users/kakra","html_url":"https://github.com/kakra","followers_url":"https://api.github.com/users/kakra/followers","following_url":"https://api.github.com/users/kakra/following{/other_user}","gists_url":"https://api.github.com/users/kakra/gists{/gist_id}","starred_url":"https://api.github.com/users/kakra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kakra/subscriptions","organizations_url":"https://api.github.com/users/kakra/orgs","repos_url":"https://api.github.com/users/kakra/repos","events_url":"https://api.github.com/users/kakra/events{/privacy}","received_events_url":"https://api.github.com/users/kakra/received_events","type":"User","site_admin":false},"created_at":"2019-08-09T16:31:49Z","updated_at":"2019-08-09T16:31:49Z","author_association":"NONE","body":"Version 7.2.1 fails in the same way (I cloned the container and upgraded):\r\n\r\n```\r\nAug 09 18:30:25 es7 elasticsearch[705]: [2019-08-09T18:30:25,287][WARN ][o.e.b.ElasticsearchUncaughtExceptionHandler] [es7] uncaught exception in thread [main]\r\nAug 09 18:30:25 es7 elasticsearch[705]: org.elasticsearch.bootstrap.StartupException: java.lang.NullPointerException\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:163) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:150) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.cli.EnvironmentAwareCommand.execute(EnvironmentAwareCommand.java:86) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:124) ~[elasticsearch-cli-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.cli.Command.main(Command.java:90) ~[elasticsearch-cli-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:115) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:92) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]: Caused by: java.lang.NullPointerException\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at sun.nio.fs.UnixFileSystem.getPath(UnixFileSystem.java:273) ~[?:?]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.common.io.PathUtils.get(PathUtils.java:60) ~[elasticsearch-core-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.monitor.os.OsProbe.readSysFsCgroupCpuAcctCpuAcctUsage(OsProbe.java:309) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.monitor.os.OsProbe.getCgroupCpuAcctUsageNanos(OsProbe.java:296) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.monitor.os.OsProbe.getCgroup(OsProbe.java:515) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.monitor.os.OsProbe.osStats(OsProbe.java:635) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.monitor.os.OsService.<init>(OsService.java:49) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.monitor.MonitorService.<init>(MonitorService.java:46) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.node.Node.<init>(Node.java:366) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.node.Node.<init>(Node.java:251) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Bootstrap$5.<init>(Bootstrap.java:221) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Bootstrap.setup(Bootstrap.java:221) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:349) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:159) ~[elasticsearch-7.2.1.jar:7.2.1]\r\nAug 09 18:30:25 es7 elasticsearch[705]:         ... 6 more\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/520054757","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-520054757","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":520054757,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDA1NDc1Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-09T20:33:51Z","updated_at":"2019-08-09T20:33:51Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/520395656","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-520395656","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":520395656,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDM5NTY1Ng==","user":{"login":"kakra","id":17684,"node_id":"MDQ6VXNlcjE3Njg0","avatar_url":"https://avatars3.githubusercontent.com/u/17684?v=4","gravatar_id":"","url":"https://api.github.com/users/kakra","html_url":"https://github.com/kakra","followers_url":"https://api.github.com/users/kakra/followers","following_url":"https://api.github.com/users/kakra/following{/other_user}","gists_url":"https://api.github.com/users/kakra/gists{/gist_id}","starred_url":"https://api.github.com/users/kakra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kakra/subscriptions","organizations_url":"https://api.github.com/users/kakra/orgs","repos_url":"https://api.github.com/users/kakra/repos","events_url":"https://api.github.com/users/kakra/events{/privacy}","received_events_url":"https://api.github.com/users/kakra/received_events","type":"User","site_admin":false},"created_at":"2019-08-12T11:58:34Z","updated_at":"2019-08-12T11:58:34Z","author_association":"NONE","body":"Hacky patch to work around this problem (yet untested because I need to build the package from source first):\r\n\r\n```patch\r\nFrom 674f9cbcc8d98e1371a664344d1c439d2756fb2d Mon Sep 17 00:00:00 2001\r\nFrom: Kai Krakow <kk@netactive.de>\r\nDate: Mon, 12 Aug 2019 12:58:37 +0200\r\nSubject: [PATCH] HACK: Catch NullPointerException during cgroup detection\r\n\r\nDo not crash if for whatever reason the pattern matching didn't match\r\nthe cgroups and resolves to a NULL pointer path component. In this case,\r\nsimply pretent we do not have cgroups.\r\n\r\nIn my case, it crashes because `controlGroup` is passed a NULL pointer\r\nhere:\r\n\r\nString readSysFsCgroupCpuAcctCpuAcctUsage(final String controlGroup)\r\nthrows IOException {\r\nreturn readSingleLine(PathUtils.get(\"/sys/fs/cgroup/cpuacct\",\r\ncontrolGroup, \"cpuacct.usage\"));\r\n    }\r\n\r\n\r\nThis probably results from `OsProbe.getControlGroups()` returning a\r\n`controllerMap` with NULL pointers in some cases.\r\n\r\nSigned-off-by: Kai Krakow <kk@netactive.de>\r\n---\r\n server/src/main/java/org/elasticsearch/monitor/os/OsProbe.java | 3 +++\r\n 1 file changed, 3 insertions(+)\r\n\r\ndiff --git a/server/src/main/java/org/elasticsearch/monitor/os/OsProbe.java b/server/src/main/java/org/elasticsearch/monitor/os/OsProbe.java\r\nindex 18173dd275a..44c639546f1 100644\r\n--- a/server/src/main/java/org/elasticsearch/monitor/os/OsProbe.java\r\n+++ b/server/src/main/java/org/elasticsearch/monitor/os/OsProbe.java\r\n@@ -507,6 +507,9 @@ public class OsProbe {\r\n         } catch (final IOException e) {\r\n             logger.debug(\"error reading control group stats\", e);\r\n             return null;\r\n+        } catch (final NullPointerException e) {\r\n+            logger.debug(\"error resolving control groups\", e);\r\n+            return null;\r\n         }\r\n     }\r\n\r\n--\r\n2.21.0\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/520461502","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-520461502","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":520461502,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMDQ2MTUwMg==","user":{"login":"kakra","id":17684,"node_id":"MDQ6VXNlcjE3Njg0","avatar_url":"https://avatars3.githubusercontent.com/u/17684?v=4","gravatar_id":"","url":"https://api.github.com/users/kakra","html_url":"https://github.com/kakra","followers_url":"https://api.github.com/users/kakra/followers","following_url":"https://api.github.com/users/kakra/following{/other_user}","gists_url":"https://api.github.com/users/kakra/gists{/gist_id}","starred_url":"https://api.github.com/users/kakra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kakra/subscriptions","organizations_url":"https://api.github.com/users/kakra/orgs","repos_url":"https://api.github.com/users/kakra/repos","events_url":"https://api.github.com/users/kakra/events{/privacy}","received_events_url":"https://api.github.com/users/kakra/received_events","type":"User","site_admin":false},"created_at":"2019-08-12T14:59:52Z","updated_at":"2019-08-12T14:59:52Z","author_association":"NONE","body":"Confirming my own hacky patch works: I've built patched 6.8.1 using gradle, then replaced the JAR file containing OsProbe.class in my container. ES 6.8.1 now starts successfully.\r\n\r\nIf the patch is fine for you, feel free to apply (just remove the \"HACK:\" prefix), or ask for a PR. I can port it over to different branches.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521942598","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-521942598","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":521942598,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTk0MjU5OA==","user":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T09:07:15Z","updated_at":"2019-08-16T09:07:15Z","author_association":"CONTRIBUTOR","body":"@kakra thanks for raising this issue. We've fixed this in a slightly different way, by explicitly checking for missing cgroup data.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521981115","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-521981115","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":521981115,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTk4MTExNQ==","user":{"login":"kakra","id":17684,"node_id":"MDQ6VXNlcjE3Njg0","avatar_url":"https://avatars3.githubusercontent.com/u/17684?v=4","gravatar_id":"","url":"https://api.github.com/users/kakra","html_url":"https://github.com/kakra","followers_url":"https://api.github.com/users/kakra/followers","following_url":"https://api.github.com/users/kakra/following{/other_user}","gists_url":"https://api.github.com/users/kakra/gists{/gist_id}","starred_url":"https://api.github.com/users/kakra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kakra/subscriptions","organizations_url":"https://api.github.com/users/kakra/orgs","repos_url":"https://api.github.com/users/kakra/repos","events_url":"https://api.github.com/users/kakra/events{/privacy}","received_events_url":"https://api.github.com/users/kakra/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T11:42:17Z","updated_at":"2019-08-16T11:42:17Z","author_association":"NONE","body":"@pugnascotia You're welcome.\r\n\r\nIs the 5.x branch still maintained and will this be backported? Because I fear when upgrading kernels for my apps that still depend on the 5.x version, it will crash due to the same issue.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521994117","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-521994117","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":521994117,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTk5NDExNw==","user":{"login":"pugnascotia","id":8696382,"node_id":"MDQ6VXNlcjg2OTYzODI=","avatar_url":"https://avatars1.githubusercontent.com/u/8696382?v=4","gravatar_id":"","url":"https://api.github.com/users/pugnascotia","html_url":"https://github.com/pugnascotia","followers_url":"https://api.github.com/users/pugnascotia/followers","following_url":"https://api.github.com/users/pugnascotia/following{/other_user}","gists_url":"https://api.github.com/users/pugnascotia/gists{/gist_id}","starred_url":"https://api.github.com/users/pugnascotia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pugnascotia/subscriptions","organizations_url":"https://api.github.com/users/pugnascotia/orgs","repos_url":"https://api.github.com/users/pugnascotia/repos","events_url":"https://api.github.com/users/pugnascotia/events{/privacy}","received_events_url":"https://api.github.com/users/pugnascotia/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T12:35:33Z","updated_at":"2019-08-16T12:35:33Z","author_association":"CONTRIBUTOR","body":"5.x is no longer maintained, I'm afraid. However, you could look into why `cpuacct` doesn't appear in `/proc/self/cgroup` on your system. I booted an Ubuntu VM with a 5.0 kernel (so not as new as yours, but at least the same major version), and I still saw a line with `cpuacct` in `/proc/self/cgroup`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/522069290","html_url":"https://github.com/elastic/elasticsearch/issues/45396#issuecomment-522069290","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45396","id":522069290,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMjA2OTI5MA==","user":{"login":"kakra","id":17684,"node_id":"MDQ6VXNlcjE3Njg0","avatar_url":"https://avatars3.githubusercontent.com/u/17684?v=4","gravatar_id":"","url":"https://api.github.com/users/kakra","html_url":"https://github.com/kakra","followers_url":"https://api.github.com/users/kakra/followers","following_url":"https://api.github.com/users/kakra/following{/other_user}","gists_url":"https://api.github.com/users/kakra/gists{/gist_id}","starred_url":"https://api.github.com/users/kakra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kakra/subscriptions","organizations_url":"https://api.github.com/users/kakra/orgs","repos_url":"https://api.github.com/users/kakra/repos","events_url":"https://api.github.com/users/kakra/events{/privacy}","received_events_url":"https://api.github.com/users/kakra/received_events","type":"User","site_admin":false},"created_at":"2019-08-16T16:26:33Z","updated_at":"2019-08-16T16:28:54Z","author_association":"NONE","body":"I researched a little bit, it's probably a combination of different factors: kernel version, systemd using unified hierarchy, the ES machines are running in a nspawn container (as an installation mirror of the production machines so normal system updates to my dev machine won't tamper with the dependencies), and my desktop/development kernels use the MuQSS scheduler (CK patchset). The latter doesn't support hierarchical CPU bandwidth allocation and no CPU accounting at all, it's flat, and I'm pretty sure that's causing the problem.\r\n\r\nI'll look into the 5.x case myself then. Since those containers are mostly static (they only offer ES as a service visible to the host), I can simply backport the patch, rebuild the class file and replace it in the installation. It's a bit dirty but it should be good enough.\r\n\r\nBTW: At least, if it's the CK patchset, the server deployments would be safe: They are running the standard Linux scheduler. Still good to know that potential crash is caught now.","performed_via_github_app":null}]