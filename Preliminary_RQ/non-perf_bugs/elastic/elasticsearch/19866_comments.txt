[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/238269233","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-238269233","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":238269233,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODI2OTIzMw==","user":{"login":"rtkmhart","id":2601414,"node_id":"MDQ6VXNlcjI2MDE0MTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/2601414?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkmhart","html_url":"https://github.com/rtkmhart","followers_url":"https://api.github.com/users/rtkmhart/followers","following_url":"https://api.github.com/users/rtkmhart/following{/other_user}","gists_url":"https://api.github.com/users/rtkmhart/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkmhart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkmhart/subscriptions","organizations_url":"https://api.github.com/users/rtkmhart/orgs","repos_url":"https://api.github.com/users/rtkmhart/repos","events_url":"https://api.github.com/users/rtkmhart/events{/privacy}","received_events_url":"https://api.github.com/users/rtkmhart/received_events","type":"User","site_admin":false},"created_at":"2016-08-08T15:14:26Z","updated_at":"2016-08-08T15:14:26Z","author_association":"NONE","body":"Small correction, I realized a large portion of the shards that are reporting different document counts are actively being written to so that's expected. The shards that are not actively being written to and have different documents are 8 in total. But the overall nature of the problem doesn't change.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/238283765","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-238283765","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":238283765,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODI4Mzc2NQ==","user":{"login":"rtkmhart","id":2601414,"node_id":"MDQ6VXNlcjI2MDE0MTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/2601414?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkmhart","html_url":"https://github.com/rtkmhart","followers_url":"https://api.github.com/users/rtkmhart/followers","following_url":"https://api.github.com/users/rtkmhart/following{/other_user}","gists_url":"https://api.github.com/users/rtkmhart/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkmhart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkmhart/subscriptions","organizations_url":"https://api.github.com/users/rtkmhart/orgs","repos_url":"https://api.github.com/users/rtkmhart/repos","events_url":"https://api.github.com/users/rtkmhart/events{/privacy}","received_events_url":"https://api.github.com/users/rtkmhart/received_events","type":"User","site_admin":false},"created_at":"2016-08-08T16:00:37Z","updated_at":"2016-08-08T16:00:37Z","author_association":"NONE","body":"As a workaorund I can forcefully \"fix\" the doc by retrieving and updating it with the \"doc_as_upsert\" attribute added and set to true. Seems the two nodes are happy to update or insert the doc as they see fit.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/238798917","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-238798917","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":238798917,"node_id":"MDEyOklzc3VlQ29tbWVudDIzODc5ODkxNw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-08-10T08:25:12Z","updated_at":"2016-08-10T08:25:12Z","author_association":"CONTRIBUTOR","body":"How are documents written/updated/deleted in your cluster? Do you use [version types](https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-index_.html#_version_types)? Do you use [delete-by-query](https://www.elastic.co/guide/en/elasticsearch/plugins/2.3/plugins-delete-by-query.html)?\nAfter fixing the inconsistencies between primary/replica, have you seen this happening again?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/239260921","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-239260921","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":239260921,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTI2MDkyMQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-08-11T19:10:54Z","updated_at":"2016-08-11T19:10:54Z","author_association":"CONTRIBUTOR","body":"Are the 8 indices with differing doc counts from old versions, or 2.3.3?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/240143363","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-240143363","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":240143363,"node_id":"MDEyOklzc3VlQ29tbWVudDI0MDE0MzM2Mw==","user":{"login":"rtkmhart","id":2601414,"node_id":"MDQ6VXNlcjI2MDE0MTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/2601414?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkmhart","html_url":"https://github.com/rtkmhart","followers_url":"https://api.github.com/users/rtkmhart/followers","following_url":"https://api.github.com/users/rtkmhart/following{/other_user}","gists_url":"https://api.github.com/users/rtkmhart/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkmhart/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkmhart/subscriptions","organizations_url":"https://api.github.com/users/rtkmhart/orgs","repos_url":"https://api.github.com/users/rtkmhart/repos","events_url":"https://api.github.com/users/rtkmhart/events{/privacy}","received_events_url":"https://api.github.com/users/rtkmhart/received_events","type":"User","site_admin":false},"created_at":"2016-08-16T15:43:15Z","updated_at":"2016-08-16T15:43:15Z","author_association":"NONE","body":"@ywelsch The vast majority of the documents are written using bulk indexing, for both inserts and updates. We rarely delete documents. Version types are not used, we use the default settings. We do not use delete-by-query.\n\n@clintongormley In each case the indices have a mix of versions that return from the \"/index/_segments\" call, a mix of 4.10.4 and 5.5.0, which I think means the indices were created prior to 2.3.3. In those cases I didn't upgrade in place, but did a snapshot from v1.7 and restore to the new v2.3.3 cluster, in case that makes a difference.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/242749793","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-242749793","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":242749793,"node_id":"MDEyOklzc3VlQ29tbWVudDI0Mjc0OTc5Mw==","user":{"login":"rtkbkish","id":3708115,"node_id":"MDQ6VXNlcjM3MDgxMTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3708115?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkbkish","html_url":"https://github.com/rtkbkish","followers_url":"https://api.github.com/users/rtkbkish/followers","following_url":"https://api.github.com/users/rtkbkish/following{/other_user}","gists_url":"https://api.github.com/users/rtkbkish/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkbkish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkbkish/subscriptions","organizations_url":"https://api.github.com/users/rtkbkish/orgs","repos_url":"https://api.github.com/users/rtkbkish/repos","events_url":"https://api.github.com/users/rtkbkish/events{/privacy}","received_events_url":"https://api.github.com/users/rtkbkish/received_events","type":"User","site_admin":false},"created_at":"2016-08-26T14:24:42Z","updated_at":"2016-08-26T14:24:42Z","author_association":"NONE","body":"We are continuing to see this issue and it is becoming more serious.\n\nWe have two classes of documents that we are indexing through a bulk operation: one class is doing a simple index, and the other class is doing an update operation with an upsert with a groovy script.\n\nWe don't have any evidence of missing items with the first class of documents.\n\nBut we are missing a small (<1%?), but functionally noticeable percentage of documents in some of the shards. I just worked through a small set of example failures from yesterday. In each case, the document was in the replica, but not the primary. (We have three shards and one replica for these indices). (BTW this is a hack to get our updatable objects to work with ES)\n\nThis is the template of the bulk update action we are using:\n\n```\n{\"update\":{\"_index\":\"<index name>\",\"_type\":\"<doc type>\",\"_id\":\"<id>\"}}\n{\"upsert\":<doc body>,\"script\":{\"file\":\"update_incident\",\"params\":{\"doc\":<partial doc>}}}\n```\n\nThis is the groovy script used to update the document.\n\n```\n// We always want the latest timestamp\nif (doc.get('@timestamp') < ctx._source['@timestamp']) {\n  doc.putAt('@timestamp', ctx._source['@timestamp'])\n}\n// Update the state\nctx._source.putAll(doc)\nctx._source.incident.count++\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/242801726","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-242801726","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":242801726,"node_id":"MDEyOklzc3VlQ29tbWVudDI0MjgwMTcyNg==","user":{"login":"rtkbkish","id":3708115,"node_id":"MDQ6VXNlcjM3MDgxMTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3708115?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkbkish","html_url":"https://github.com/rtkbkish","followers_url":"https://api.github.com/users/rtkbkish/followers","following_url":"https://api.github.com/users/rtkbkish/following{/other_user}","gists_url":"https://api.github.com/users/rtkbkish/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkbkish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkbkish/subscriptions","organizations_url":"https://api.github.com/users/rtkbkish/orgs","repos_url":"https://api.github.com/users/rtkbkish/repos","events_url":"https://api.github.com/users/rtkbkish/events{/privacy}","received_events_url":"https://api.github.com/users/rtkbkish/received_events","type":"User","site_admin":false},"created_at":"2016-08-26T17:40:47Z","updated_at":"2016-08-26T17:40:47Z","author_association":"NONE","body":"We have been doing this for over 18 months without issue (on 1.5, 1.6 and 1.7). It is only in the last month since the switch to Elasticsearch 2.x that we have run into consistency problems.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/290716912","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-290716912","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":290716912,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MDcxNjkxMg==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2017-03-31T13:48:49Z","updated_at":"2017-03-31T13:48:49Z","author_association":"MEMBER","body":"@rtkbkish are you still seeing this issue?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/293591339","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-293591339","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":293591339,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MzU5MTMzOQ==","user":{"login":"rtkbkish","id":3708115,"node_id":"MDQ6VXNlcjM3MDgxMTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3708115?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkbkish","html_url":"https://github.com/rtkbkish","followers_url":"https://api.github.com/users/rtkbkish/followers","following_url":"https://api.github.com/users/rtkbkish/following{/other_user}","gists_url":"https://api.github.com/users/rtkbkish/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkbkish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkbkish/subscriptions","organizations_url":"https://api.github.com/users/rtkbkish/orgs","repos_url":"https://api.github.com/users/rtkbkish/repos","events_url":"https://api.github.com/users/rtkbkish/events{/privacy}","received_events_url":"https://api.github.com/users/rtkbkish/received_events","type":"User","site_admin":false},"created_at":"2017-04-12T14:17:36Z","updated_at":"2017-04-12T14:17:55Z","author_association":"NONE","body":"@colings86 Yes","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/293910194","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-293910194","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":293910194,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MzkxMDE5NA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-04-13T14:23:31Z","updated_at":"2017-04-13T14:23:31Z","author_association":"MEMBER","body":"@rtkbkish many many things changed in this area of the code. There are known problems, many of them has been fixed and some are on the process of being fixed. This is a problem we take seriously and we can work to figure out what exactly the issue in your case. Some questions:\r\n\r\n1) Which version are you on today?\r\n2) Do you see this same with 5.3.0?\r\n3) Do you see any networking issues / disconnects in the logs?\r\n4) What type of bulk request are you doing - is this update, normal index or indexing with auto generated ids?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/293913640","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-293913640","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":293913640,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MzkxMzY0MA==","user":{"login":"rtkbkish","id":3708115,"node_id":"MDQ6VXNlcjM3MDgxMTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3708115?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkbkish","html_url":"https://github.com/rtkbkish","followers_url":"https://api.github.com/users/rtkbkish/followers","following_url":"https://api.github.com/users/rtkbkish/following{/other_user}","gists_url":"https://api.github.com/users/rtkbkish/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkbkish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkbkish/subscriptions","organizations_url":"https://api.github.com/users/rtkbkish/orgs","repos_url":"https://api.github.com/users/rtkbkish/repos","events_url":"https://api.github.com/users/rtkbkish/events{/privacy}","received_events_url":"https://api.github.com/users/rtkbkish/received_events","type":"User","site_admin":false},"created_at":"2017-04-13T14:35:45Z","updated_at":"2017-04-13T14:35:45Z","author_association":"NONE","body":"1. We are currently on 2.3.3\r\n2. We haven't made the jump to 5.3. The migration from 1.x to 2.x was so time-intensive that the next migration keeps getting delayed.\r\n3. Networking issues/disconnects are very rare. Does not explain frequency of issue.\r\n4. We generate the IDs. It is a bulk update operation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/293917416","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-293917416","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":293917416,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MzkxNzQxNg==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2017-04-13T14:48:50Z","updated_at":"2017-04-13T14:48:50Z","author_association":"MEMBER","body":"> Networking issues/disconnects are very rare. Does not explain frequency of issue.\r\n\r\nCan we re-iterate on how often you see this? Also - do you see any shard failures?\r\n\r\n> We generate the IDs. It is a bulk update operation.\r\n\r\nWhat kind of update do you do?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297828564","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-297828564","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":297828564,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzgyODU2NA==","user":{"login":"rtkbkish","id":3708115,"node_id":"MDQ6VXNlcjM3MDgxMTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3708115?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkbkish","html_url":"https://github.com/rtkbkish","followers_url":"https://api.github.com/users/rtkbkish/followers","following_url":"https://api.github.com/users/rtkbkish/following{/other_user}","gists_url":"https://api.github.com/users/rtkbkish/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkbkish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkbkish/subscriptions","organizations_url":"https://api.github.com/users/rtkbkish/orgs","repos_url":"https://api.github.com/users/rtkbkish/repos","events_url":"https://api.github.com/users/rtkbkish/events{/privacy}","received_events_url":"https://api.github.com/users/rtkbkish/received_events","type":"User","site_admin":false},"created_at":"2017-04-27T20:22:52Z","updated_at":"2017-04-27T20:22:52Z","author_association":"NONE","body":"@bleskes \r\nSorry for the delay. Numerous local distractions.\r\n\r\nI looked the logs over the past 4 months for our data nodes in this cluster (of which there are four).\r\nThis is the distribution of NodeDisconnectExceptions:\r\n```\r\n  67 2017-01-12\r\n  14 2017-01-13\r\n  20 2017-01-16\r\n  10 2017-03-02\r\n  53 2017-03-08\r\n  45 2017-03-23\r\n  60 2017-04-05\r\n  59 2017-04-10\r\n   7 2017-04-13\r\n   3 2017-04-14\r\n  55 2017-04-20\r\n  12 2017-04-22\r\n```\r\nThese were triggered by GC's on the data nodes. There is a very similar distribution of Shard create failures.\r\n\r\nWe see the missing docs much more frequently than this. Several times per day.\r\n\r\n\r\nAll updates are doing using the bulk API.\r\n\r\nOriginally, we used an upsert statement, but changed that to a create and update in an attempt to get around this issue. (It hasn't fixed things, so we should roll it back).\r\n\r\nCurrent bulk statements:\r\n{\"create\":{\"_index\":\"<index>\",\"_type\":\"<type>\",\"_id\":\"<id>\"}}\r\n{<Full version of doc>}\r\n{\"update\":{\"_index\":\"<index>\",\"_type\":\"<type>\",\"_id\":\"<id>\"}}\r\n{\"script\":{\"file\":\"update_incident\",\"params\":{\"doc\":{<update version of doc>}}}}\r\n\r\nOriginal Bulk statements:\r\n{\"update\":{\"_index\":\"<index>\",\"_type\":\"<type>\",\"_id\":\"<id>\"}}\r\n{\"upsert\":{<Full version of doc>},\"script\":{\"file\":\"update_incident\",\"params\":{\"doc\":{<update version of doc>}}}}\r\n\r\nIn either case we trigger a groovy script:\r\n```\r\n// We always want the latest timestamp\r\nif (doc.get('@timestamp') < ctx._source['@timestamp']) {\r\n  doc.putAt('@timestamp', ctx._source['@timestamp'])\r\n}\r\n// Update the state\r\nctx._source.putAll(doc)\r\nctx._source.incident.count++\r\n```\r\n ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/298021971","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-298021971","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":298021971,"node_id":"MDEyOklzc3VlQ29tbWVudDI5ODAyMTk3MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-04-28T15:01:00Z","updated_at":"2017-04-28T15:01:00Z","author_association":"MEMBER","body":"Do you see active primary shard failures in your logs, and if so how often?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/298031728","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-298031728","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":298031728,"node_id":"MDEyOklzc3VlQ29tbWVudDI5ODAzMTcyOA==","user":{"login":"rtkbkish","id":3708115,"node_id":"MDQ6VXNlcjM3MDgxMTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3708115?v=4","gravatar_id":"","url":"https://api.github.com/users/rtkbkish","html_url":"https://github.com/rtkbkish","followers_url":"https://api.github.com/users/rtkbkish/followers","following_url":"https://api.github.com/users/rtkbkish/following{/other_user}","gists_url":"https://api.github.com/users/rtkbkish/gists{/gist_id}","starred_url":"https://api.github.com/users/rtkbkish/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rtkbkish/subscriptions","organizations_url":"https://api.github.com/users/rtkbkish/orgs","repos_url":"https://api.github.com/users/rtkbkish/repos","events_url":"https://api.github.com/users/rtkbkish/events{/privacy}","received_events_url":"https://api.github.com/users/rtkbkish/received_events","type":"User","site_admin":false},"created_at":"2017-04-28T15:37:42Z","updated_at":"2017-04-28T15:38:01Z","author_association":"NONE","body":"Since November 2016, I see two \"primary failed while replica initializing\" errors. both for the same index on Mar 22.\r\n\r\nOtherwise clusters of \"marking and sending shard failed due to [failed to create shard]\" when we have GC incidents. These are tied to the NodeDisconnectExceptions in the previous comment.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/340202697","html_url":"https://github.com/elastic/elasticsearch/issues/19866#issuecomment-340202697","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19866","id":340202697,"node_id":"MDEyOklzc3VlQ29tbWVudDM0MDIwMjY5Nw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-10-28T16:23:56Z","updated_at":"2017-10-28T16:23:56Z","author_association":"MEMBER","body":"I lean towards closing this as so much has changed in these regards since 2.x. Prior to 6.0, a replica could fall out of sync in the case of primary failure. In 6.0, we are introducing a primary/replica re-sync after a replica is promoted to primary. If this occurs again after 6.0 is released, we can revisit but at this point we are not going to make any changes in 2.x and 5.x to address.","performed_via_github_app":null}]