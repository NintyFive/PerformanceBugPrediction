{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/42361/events","html_url":"https://github.com/elastic/elasticsearch/issues/42361","id":447157352,"node_id":"MDU6SXNzdWU0NDcxNTczNTI=","number":42361,"title":"Percolator combining must_not and nested objects returns false positives (6.4..6.8)","user":{"login":"ismael-hasan","id":10942273,"node_id":"MDQ6VXNlcjEwOTQyMjcz","avatar_url":"https://avatars1.githubusercontent.com/u/10942273?v=4","gravatar_id":"","url":"https://api.github.com/users/ismael-hasan","html_url":"https://github.com/ismael-hasan","followers_url":"https://api.github.com/users/ismael-hasan/followers","following_url":"https://api.github.com/users/ismael-hasan/following{/other_user}","gists_url":"https://api.github.com/users/ismael-hasan/gists{/gist_id}","starred_url":"https://api.github.com/users/ismael-hasan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ismael-hasan/subscriptions","organizations_url":"https://api.github.com/users/ismael-hasan/orgs","repos_url":"https://api.github.com/users/ismael-hasan/repos","events_url":"https://api.github.com/users/ismael-hasan/events{/privacy}","received_events_url":"https://api.github.com/users/ismael-hasan/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1368435583,"node_id":"MDU6TGFiZWwxMzY4NDM1NTgz","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.8.1","name":"v6.8.1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-05-22T14:04:45Z","updated_at":"2019-06-06T17:24:40Z","closed_at":"2019-06-06T17:24:40Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.4.2, 6.5.0, 6.6.0. 6.7.0, 6.8.0  \r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** : java version \"10.0.2\" 2018-07-17\r\n\r\n**OS version** : Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nA specific percolator query is returning false matches when combining `must_not` and nested objects in the source document - nested objects are actually not included in the percolator query, though. This only happens between 6.4 and 6.8 - it does not happen in 6.3 or 7.0. \r\nI am not sure what is the specific condition that triggers the unexpected match, but it seems related to `must_not` and nested documents. The full case to reproduce it follows. \r\n\r\n**Steps to reproduce**:\r\nTests are done on index `test1` that should not exist a priori.\r\n\r\n------\r\n\r\nCreate the mapping with `sometext` and `somenested` as fields, and the `query` field for the percolator type. The nested one contains a field `somekeyword`\r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\nPUT /test1\r\n{\r\n  \"mappings\": {\r\n    \"percolatorquery\": {\r\n      \"properties\": {\r\n        \"sometext\": {\r\n          \"type\": \"text\"\r\n        },\r\n        \"somenested\": {\r\n          \"type\": \"nested\",\r\n          \"include_in_parent\": true,\r\n          \"properties\": {\r\n            \"somekeyword\": {\r\n              \"type\": \"keyword\"\r\n            }\r\n          }\r\n        },\r\n        \"query\": {\r\n          \"type\": \"percolator\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n------\r\n\r\n\r\nCreate _field sometext must not exist_ percolate query. \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\nPUT /test1/percolatorquery/1?refresh\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must_not\": [\r\n        {\r\n          \"exists\": {\r\n            \"field\": \"sometext\",\r\n            \"boost\": 1\r\n          }\r\n        }\r\n      ],\r\n      \"adjust_pure_negative\": true,\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n------\r\n\r\n\r\nDo a percolate query for a document which actually has that field. It should not be returned, but the percolate is returned as matching. I think it is significant that \r\n```\r\n        \"fields\" : {\r\n          \"_percolator_document_slot\" : [\r\n            -1\r\n          ]\r\n        }\r\n ```\r\nis returned regardless of the percolator query being returned as matched. The request follows: \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\nGET test1/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"sometext\": \"test\",\r\n          \"somenested\": {\r\n            \"somekeyword\": \"test\"\r\n          }\r\n        }\r\n      ],\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\nAnd the response: \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\n{\r\n  \"took\" : 10,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 5,\r\n    \"successful\" : 5,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 1,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test1\",\r\n        \"_type\" : \"percolatorquery\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"query\" : {\r\n            \"bool\" : {\r\n              \"must_not\" : [\r\n                {\r\n                  \"exists\" : {\r\n                    \"field\" : \"sometext\",\r\n                    \"boost\" : 1\r\n                  }\r\n                }\r\n              ],\r\n              \"adjust_pure_negative\" : true,\r\n              \"boost\" : 1\r\n            }\r\n          }\r\n        },\r\n        \"fields\" : {\r\n          \"_percolator_document_slot\" : [\r\n            -1\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n------\r\n\r\n\r\nRepeat the previous query, but this time the document that we pass does not contain the nested field. In this case, the percolate query works fine and it returns no matches. Worth to note again, the percolate query does not reference the nested field at all.  \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\nGET test1/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"sometext\": \"test\"\r\n        }\r\n      ],\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n------\r\n\r\n\r\nRepeat the query for a document that does not contain the field. It should be returned, and it is returned. Worth to note, in this case the result contains `\"_percolator_document_slot\" : [ -1, 0]`, regardless of having a single input document. \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n          \r\n```\r\nGET test1/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"otherfield\": \"test\",\r\n          \"somenested\": {\r\n            \"somekeyword\": \"test\"\r\n          }\r\n        }\r\n      ],\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\nIf I remove from the input document `somenested`, the result contains `\"_percolator_document_slot\" : [0]` , it seems the nested document is playing a role\r\n\r\n------\r\n\r\nNext tests change in the original percolate query `must_not` with `must`. In this scenario, all of the queries returned the expected results. \r\n\r\nChange the percolator query to the new one: \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\nPUT /test1/percolatorquery/1?refresh\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"exists\": {\r\n            \"field\": \"sometext\",\r\n            \"boost\": 1\r\n          }\r\n        }\r\n      ],\r\n      \"adjust_pure_negative\": true,\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n------\r\n\r\n\r\nTest a document containing the field; the query matches as expected: \r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n\r\n```\r\nGET test1/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"sometext\": \"test\",\r\n          \"somenested\": {\r\n            \"somekeyword\": \"test\"\r\n          }\r\n        }\r\n      ],\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n\r\n------\r\n\r\n\r\nTest a document not containing the field; it correctly does not match:\r\n\r\n<details><summary>Collapse/expand</summary>\r\n<p>\r\n \r\n```\r\nGET test1/_search\r\n{\r\n  \"query\": {\r\n    \"percolate\": {\r\n      \"field\": \"query\",\r\n      \"documents\": [\r\n        {\r\n          \"differentfield\": \"test\",\r\n          \"somenested\": {\r\n            \"somekeyword\": \"test\"\r\n          }\r\n        }\r\n      ],\r\n      \"boost\": 1\r\n    }\r\n  }\r\n} \r\n```\r\n\r\n</p>\r\n</details>\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}