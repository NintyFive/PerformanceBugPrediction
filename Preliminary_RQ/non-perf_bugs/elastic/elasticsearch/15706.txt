{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15706","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15706/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15706/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15706/events","html_url":"https://github.com/elastic/elasticsearch/issues/15706","id":124320025,"node_id":"MDU6SXNzdWUxMjQzMjAwMjU=","number":15706,"title":"multi_fields across types cause MapperParsingException","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2015-12-30T08:39:36Z","updated_at":"2016-01-10T17:26:11Z","closed_at":"2016-01-04T09:03:26Z","author_association":"MEMBER","active_lock_reason":null,"body":"When using a multi_field across types in the same index, Elasticsearch fails with the following exception during indexing:\n\n```\n{\n  \"took\": 482,\n  \"errors\": true,\n  \"items\": [\n    {\n      \"index\": {\n        \"_index\": \"logstash-2015.09.20\",\n        \"_type\": \"nginx\",\n        \"_id\": \"AU_x3-TaGFA8no6QjiSO\",\n        \"_version\": 1,\n        \"_shards\": {\n          \"total\": 1,\n          \"successful\": 1,\n          \"failed\": 0\n        },\n        \"created\": true,\n        \"status\": 201\n      }\n    },\n    {\n      \"index\": {\n        \"_index\": \"logstash-2015.09.20\",\n        \"_type\": \"apache\",\n        \"_id\": \"AU_x3-TaGFA8no6QjiSB\",\n        \"status\": 400,\n        \"error\": {\n          \"type\": \"mapper_parsing_exception\",\n          \"reason\": \"failed to parse\",\n          \"caused_by\": {\n            \"type\": \"illegal_state_exception\",\n            \"reason\": null\n          }\n        }\n      }\n    }\n  ]\n}\n```\n\nAnd on the server:\n\n```\nMapperParsingException[failed to parse]; nested: IllegalStateException;\n    at org.elasticsearch.index.mapper.DocumentParser.parseDocument(DocumentParser.java:146)\n    at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:276)\n    at org.elasticsearch.index.shard.IndexShard.prepareIndex(IndexShard.java:483)\n    at org.elasticsearch.index.shard.IndexShard.prepareIndexOnPrimary(IndexShard.java:465)\n[...]\nCaused by: java.lang.IllegalStateException\n    at org.elasticsearch.index.mapper.FieldMapper.updateFieldType(FieldMapper.java:365)\n    at org.elasticsearch.index.mapper.FieldMapper$MultiFields.updateFieldType(FieldMapper.java:604)\n    at org.elasticsearch.index.mapper.FieldMapper.updateFieldType(FieldMapper.java:369)\n    at org.elasticsearch.index.mapper.FieldMapper.updateFieldType(FieldMapper.java:50)\n    at org.elasticsearch.index.mapper.DocumentParser.parseDynamicValue(DocumentParser.java:613)\n    at org.elasticsearch.index.mapper.DocumentParser.parseValue(DocumentParser.java:430)\n    at org.elasticsearch.index.mapper.DocumentParser.parseObject(DocumentParser.java:251)\n    at org.elasticsearch.index.mapper.DocumentParser.parseDocument(DocumentParser.java:114)\n    ... 17 more\n```\n\nSteps to reproduce (see also attached files):\n\n```\ncurl -XPUT localhost:9200/_template/logstash -d @template.txt\ncurl -s -XPOST localhost:9200/_bulk --data-binary @bulk_data.txt\n```\n\nThe reason is that ES tries to reuse the multi_field `ip.raw` from the type `nginx` in the type `apache` but somehow fails to \"copy\" the settings.\n\nThe problem was originally found by @LeeDr from the Kibana team. This is a regression that was introduced with commit id 3015eb3.\n\n[template.txt](https://github.com/elastic/elasticsearch/files/74695/template.txt)\n[bulk_data.txt](https://github.com/elastic/elasticsearch/files/74696/bulk_data.txt)\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}