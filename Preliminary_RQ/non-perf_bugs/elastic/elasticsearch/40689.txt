{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40689","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40689/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40689/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40689/events","html_url":"https://github.com/elastic/elasticsearch/issues/40689","id":427738257,"node_id":"MDU6SXNzdWU0Mjc3MzgyNTc=","number":40689,"title":"[CI] IpFilteringIntegrationTests.testThatIpFilteringIsAppliedForProfile failed due to low timeout and GC","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2019-04-01T14:29:24Z","updated_at":"2019-06-10T16:28:48Z","closed_at":"2019-06-10T16:28:48Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"`IpFilteringIntegrationTests.testThatIpFilteringIsAppliedForProfile` failed in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.7+intake/475/console\r\n\r\nThe error is:\r\n\r\n```\r\n   > Throwable #1: java.net.SocketTimeoutException\r\n   > \tat __randomizedtesting.SeedInfo.seed([6C159540B3465FB8:76FC1633E1A901A0]:0)\r\n   > \tat java.net.SocksSocketImpl.remainingMillis(SocksSocketImpl.java:111)\r\n   > \tat java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)\r\n   > \tat java.net.Socket.connect(Socket.java:589)\r\n   > \tat org.elasticsearch.xpack.security.transport.filter.IpFilteringIntegrationTests.lambda$trySocketConnection$0(IpFilteringIntegrationTests.java:76)\r\n   > \tat org.elasticsearch.xpack.core.common.socket.SocketAccess.lambda$doPrivileged$0(SocketAccess.java:42)\r\n   > \tat java.security.AccessController.doPrivileged(Native Method)\r\n   > \tat org.elasticsearch.xpack.core.common.socket.SocketAccess.doPrivileged(SocketAccess.java:41)\r\n   > \tat org.elasticsearch.xpack.security.transport.filter.IpFilteringIntegrationTests.trySocketConnection(IpFilteringIntegrationTests.java:76)\r\n   > \tat org.elasticsearch.xpack.security.transport.filter.IpFilteringIntegrationTests.testThatIpFilteringIsAppliedForProfile(IpFilteringIntegrationTests.java:68)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThis doesn't reproduce locally using:\r\n\r\n```\r\n./gradlew :x-pack:plugin:security:unitTest \\\r\n  -Dtests.seed=6C159540B3465FB8 \\\r\n  -Dtests.class=org.elasticsearch.xpack.security.transport.filter.IpFilteringIntegrationTests \\\r\n  -Dtests.method=\"testThatIpFilteringIsAppliedForProfile\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=sr-Latn-RS \\\r\n  -Dtests.timezone=Africa/Casablanca \\\r\n  -Dcompiler.java=12 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nI think the problem is that there is a 500ms timeout on the socket connect:\r\n\r\n```\r\n        SocketAccess.doPrivileged(() -> socket.connect(address, 500));\r\n```\r\n\r\n(that's line 77 of `IpFilteringIntegrationTests.java`)\r\n\r\nBut there was a garbage collection that lasted longer than 500ms during the failing test:\r\n\r\n```\r\n  1> [2019-04-01T10:34:41,105][WARN ][o.e.m.j.JvmGcMonitorService] [node_s0] [gc][2] overhead, spent [532ms] collecting in the last [1s]\r\n```\r\n\r\nIn addition to garbage collection VMs can stall for hundreds of milliseconds while their hypervisor does things, so it may be worth increasing the 500ms socket connect timeout to avoid spurious failures.","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}