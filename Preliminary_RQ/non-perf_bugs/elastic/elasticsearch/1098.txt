{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1098","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1098/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1098/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1098/events","html_url":"https://github.com/elastic/elasticsearch/issues/1098","id":1178960,"node_id":"MDU6SXNzdWUxMTc4OTYw","number":1098,"title":"Nested Objects Facets Support","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"labels":[{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":97023,"node_id":"MDU6TGFiZWw5NzAyMw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.17.0","name":"v0.17.0","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2011-07-07T01:20:11Z","updated_at":"2013-01-30T09:57:06Z","closed_at":"2011-07-07T01:21:03Z","author_association":"MEMBER","active_lock_reason":null,"body":"Support faceting on nested documents. It includes both faceting on child documents matching a specific nested query (using scopes), and faceting on all nested documents of the matching root documents.\n\nWhy is it good for? First of all, this is the only way to use facets on nested documents once they are used (possibly for other reasons). But, there is also facet specific reason why nested documents can be used, and thats the fact that facets working on different key and value field (like `term_stats`, or `histogram`) can now support cases where both are multi valued properly.\n\nThe following will use this same mapping:\n\n```\n{\n    \"type1\" : {\n        \"properties\" : {\n            \"obj1\" : {\n                \"type\" : \"nested\"\n            }\n        }\n    }\n}\n```\n\nAnd, here is a sample data:\n\n```\n{\n    \"obj1\" : [\n        {\n            \"name\" : \"blue\",\n            \"count\" : 4\n        },\n        {\n            \"name\" : \"green\",\n            \"count\" : 6\n        }\n    ]\n}\n```\n## Nested Query Facets\n\nAny `nested` query allows to specify a `_scope` associated with it. Any `facet` allows for a scope to be defined on it controlling the scope it will execute against. For example, the following `facet1` terms stats facet will only run on documents matching the nested query associated with `my_scope`.\n\n```\n{\n    \"query\" : {\n        \"nested\" : {\n            \"_scope\" : \"my_scope\"\n            \"path\" : \"obj1\",\n            \"score_mode\" : \"avg\"\n            \"query\" : {\n                \"bool\" : {\n                    \"must\" : [\n                        \"text\" : {\"obj1.name\" : \"blue\"},\n                        \"range\" : {\"obj1.count\" : {\"gt\" : 5}}\n                    ]\n                }\n            }\n        }\n    },\n    \"facets\" : {\n        \"facet1\" : {\n            \"terms_stats\" : {\n                \"key_field\" : \"obj1.name\",\n                \"value_field\" : \"obj1.count\",\n            },\n            \"scope\" : \"my_scope\"\n        }\n    }\n}\n```\n## All Nested Matching Root Documents\n\nAnother option is to run the facet on all the nested documents matching the root objects that the main query will end up producing. For example:\n\n```\n{\n    \"query\" : {\n        \"match_all\" : {}\n    },\n    \"facets\" : {\n        \"facet1\" : {\n            \"terms_stats\" : {\n                \"key_field\" : \"name\",\n                \"value_field\" : \"count\",\n            },\n            \"nested\" : \"obj1\"\n        }\n    }\n}\n```\n\nThe `nested` element provides the path to the nested document (can be a multi level nested docs) that will be used.\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}