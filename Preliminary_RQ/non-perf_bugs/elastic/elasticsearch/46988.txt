{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46988","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46988/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46988/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46988/events","html_url":"https://github.com/elastic/elasticsearch/issues/46988","id":497367557,"node_id":"MDU6SXNzdWU0OTczNjc1NTc=","number":46988,"title":"Handle retention of failed and partial snapshots in SLM","user":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"assignees":[{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false}],"milestone":null,"comments":7,"created_at":"2019-09-23T22:56:17Z","updated_at":"2019-10-11T20:41:01Z","closed_at":"2019-10-11T20:41:01Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Problem\r\nRight now, SLM treats `PARTIAL` and `FAILED` snapshots the same, and both are kept around forever. This is unlikely to be the behavior users will expect from SLM, so SLM should handle retention of partial and failed snapshots as well.\r\n\r\n## Proposed solution\r\n`FAILED` snapshots will be kept until the configured `expire_after` period has passed, if present, and then be deleted. If there is no configured `expire_after` in the retention policy, then they will be deleted if there is at least one more recent successful snapshot from this policy (as they may otherwise be useful for troubleshooting purposes). Failed snapshots are not counted towards either `min_count` or `max_count`. (This has been implemented in https://github.com/elastic/elasticsearch/pull/47617)\r\n\r\n`PARTIAL` snapshots are more likely to be useful, so need to be handled a bit differently. For this case, there are two potential routes: One that is simple, and one that attempts to be intuitive.\r\n\r\n### Simple\r\nPartial snapshots are retained unless there is at least one more recent successful snapshot from the same policy, at which point they are deleted after the `expire_after` period has passed, if present.  If `expire_after` is not present and there is a more recent successful snapshot, they are deleted in the next retention run.  In this case, partial snapshots are not counted toward either `min_count` or `max_count`, which count successful snapshots only. (This has been implemented in https://github.com/elastic/elasticsearch/pull/47833)\r\n\r\n### Complex\r\n- If `min_count` is the only condition: No snapshots for this policy are ever deleted, so partial snapshots have no special handling.\r\n- If `expire_after` is the only condition: At least one successful snapshot will be kept, regardless of `expire_after`. Partial snapshots are deleted after the `expire_after` period has passed, regardless of whether or not there is a more recent successful snapshot.\r\n- If `max_count` is the only condition: At least one successful snapshot will be kept. Partial snapshots are deleted, oldest first, to keep `successful_snaps + partial_snaps` equal to or less than `max_count`.\r\n- If `min_count` and `expire_after` are configured: At least `min_count` successful snapshots will be retained. Partial snapshots are deleted after the `expire_after` period has passed, regardless of whether or not there is a more recent successful snapshot.\r\n- If `min_count` and `max_count` are configured: At least `min_count` successful snapshots will be retained. All other snapshots, whether successful or partial, will be deleted, oldest first, to keep `successful_snaps + partial_snaps` equal to or less than `max_count`.\r\n- If `expire_after` and `max_count` are configured: At least one successful snapshot will be kept, regardless of `expire_after`. Partial snapshots will be deleted, oldest first, to keep `successful_snaps + partial_snaps` equal to or less than `max_count`, as well as after the `expire_after` period, regardless of whether there is a more recent successful snapshot.\r\n- If all three conditions are configured: At least  `min_count` successful snapshots will be retained. All other snapshots, whether successful or partial, will be deleted, oldest first, to keep `successful_snaps + partial_snaps` equal to or less than `max_count`, as well as after the `expire_after` period has passed, regardless of whether there is a more recent successful snapshot.\r\n\r\nRelates to #43663","closed_by":{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false},"performed_via_github_app":null}