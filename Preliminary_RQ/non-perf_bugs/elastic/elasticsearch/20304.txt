{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20304","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20304/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20304/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20304/events","html_url":"https://github.com/elastic/elasticsearch/issues/20304","id":174813816,"node_id":"MDU6SXNzdWUxNzQ4MTM4MTY=","number":20304,"title":"Log4j can lose critical exceptions","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"labels":[{"id":151561891,"node_id":"MDU6TGFiZWwxNTE1NjE4OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Logging","name":":Core/Infra/Logging","color":"0e8a16","default":false,"description":"Log management and logging utilities"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913658,"node_id":"MDU6TGFiZWw5MjkxMzY1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/blocker","name":"blocker","color":"e11d21","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2016-09-02T17:49:42Z","updated_at":"2016-10-18T08:31:15Z","closed_at":"2016-10-07T18:05:31Z","author_association":"MEMBER","active_lock_reason":null,"body":"Start two nodes of Elasticsearch, intentionally binding to the same port:\n\n```\n$ bin/elasticsearch -E transport.tcp.port=9300 -E node.max_local_storage_nodes=2\n```\n\nWait for this instance to start, then from another terminal:\n\n```\n$ bin/elasticsearch -E transport.tcp.port=9300 -E node.max_local_storage_nodes=2\n```\n\nThe second node will fail to bind, as expected. However, instead of displaying an already bound exception, Log4j fails in the presence of the security manager and loses the original exception instead producing:\n\n```\n2016-09-02 13:46:33,968 main ERROR An exception occurred processing Appender rolling java.security.AccessControlException: access denied (\"java.lang.RuntimePermission\" \"accessClassInPackage.sun.nio.ch\")\n        at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n        at java.security.AccessController.checkPermission(AccessController.java:884)\n        at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n        at java.lang.SecurityManager.checkPackageAccess(SecurityManager.java:1564)\n        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:311)\n        at java.lang.ClassLoader.loadClass(ClassLoader.java:357)\n        at java.lang.Class.forName0(Native Method)\n        at java.lang.Class.forName(Class.java:264)\n        at org.apache.logging.log4j.util.LoaderUtil.loadClass(LoaderUtil.java:122)\n        at org.apache.logging.log4j.core.util.Loader.loadClass(Loader.java:228)\n        at org.apache.logging.log4j.core.impl.ThrowableProxy.loadClass(ThrowableProxy.java:496)\n        at org.apache.logging.log4j.core.impl.ThrowableProxy.toExtendedStackTrace(ThrowableProxy.java:617)\n        at org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:163)\n        at org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:138)\n        at org.apache.logging.log4j.core.impl.ThrowableProxy.<init>(ThrowableProxy.java:117)\n        at org.apache.logging.log4j.core.impl.MutableLogEvent.getThrownProxy(MutableLogEvent.java:314)\n        at org.apache.logging.log4j.core.pattern.ExtendedThrowablePatternConverter.format(ExtendedThrowablePatternConverter.java:61)\n        at org.apache.logging.log4j.core.pattern.PatternFormatter.format(PatternFormatter.java:38)\n        at org.apache.logging.log4j.core.layout.PatternLayout$PatternSerializer.toSerializable(PatternLayout.java:294)\n        at org.apache.logging.log4j.core.layout.PatternLayout.toText(PatternLayout.java:195)\n        at org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:180)\n        at org.apache.logging.log4j.core.layout.PatternLayout.encode(PatternLayout.java:57)\n        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.directEncodeEvent(AbstractOutputStreamAppender.java:120)\n        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.tryAppend(AbstractOutputStreamAppender.java:113)\n        at org.apache.logging.log4j.core.appender.AbstractOutputStreamAppender.append(AbstractOutputStreamAppender.java:104)\n        at org.apache.logging.log4j.core.appender.RollingFileAppender.append(RollingFileAppender.java:86)\n        at org.apache.logging.log4j.core.config.AppenderControl.tryCallAppender(AppenderControl.java:155)\n        at org.apache.logging.log4j.core.config.AppenderControl.callAppender0(AppenderControl.java:128)\n        at org.apache.logging.log4j.core.config.AppenderControl.callAppenderPreventRecursion(AppenderControl.java:119)\n        at org.apache.logging.log4j.core.config.AppenderControl.callAppender(AppenderControl.java:84)\n        at org.apache.logging.log4j.core.config.LoggerConfig.callAppenders(LoggerConfig.java:390)\n        at org.apache.logging.log4j.core.config.LoggerConfig.processLogEvent(LoggerConfig.java:375)\n        at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:359)\n        at org.apache.logging.log4j.core.config.LoggerConfig.log(LoggerConfig.java:349)\n        at org.apache.logging.log4j.core.config.AwaitCompletionReliabilityStrategy.log(AwaitCompletionReliabilityStrategy.java:63)\n        at org.apache.logging.log4j.core.Logger.logMessage(Logger.java:146)\n        at org.apache.logging.log4j.spi.AbstractLogger.logMessage(AbstractLogger.java:1988)\n        at org.apache.logging.log4j.spi.AbstractLogger.logIfEnabled(AbstractLogger.java:1960)\n        at org.apache.logging.log4j.spi.AbstractLogger.error(AbstractLogger.java:733)\n        at org.elasticsearch.bootstrap.Bootstrap.init(Bootstrap.java:281)\n        at org.elasticsearch.bootstrap.Elasticsearch.init(Elasticsearch.java:100)\n        at org.elasticsearch.bootstrap.Elasticsearch.execute(Elasticsearch.java:95)\n        at org.elasticsearch.cli.SettingCommand.execute(SettingCommand.java:54)\n        at org.elasticsearch.cli.Command.mainWithoutErrorHandling(Command.java:88)\n        at org.elasticsearch.cli.Command.main(Command.java:54)\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:74)\n        at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:67)\n```\n\nThis is due to Log4j attempting to load a class that it does not have the permissions to load and this exception goes uncaught.\n\nThis is not the only place that this occurs. Effectively, it can occur anywhere the native-like code is executing (think networking, filesystem access, etc.) and an exception is thrown (there are reports of four different examples of this already, the above is just the simplest reproduction).\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}