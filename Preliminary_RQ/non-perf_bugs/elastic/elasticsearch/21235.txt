{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21235","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21235/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21235/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21235/events","html_url":"https://github.com/elastic/elasticsearch/issues/21235","id":186483407,"node_id":"MDU6SXNzdWUxODY0ODM0MDc=","number":21235,"title":"Can't get empty buckets with nested, terms aggregation.","user":{"login":"devkang89","id":5411671,"node_id":"MDQ6VXNlcjU0MTE2NzE=","avatar_url":"https://avatars0.githubusercontent.com/u/5411671?v=4","gravatar_id":"","url":"https://api.github.com/users/devkang89","html_url":"https://github.com/devkang89","followers_url":"https://api.github.com/users/devkang89/followers","following_url":"https://api.github.com/users/devkang89/following{/other_user}","gists_url":"https://api.github.com/users/devkang89/gists{/gist_id}","starred_url":"https://api.github.com/users/devkang89/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/devkang89/subscriptions","organizations_url":"https://api.github.com/users/devkang89/orgs","repos_url":"https://api.github.com/users/devkang89/repos","events_url":"https://api.github.com/users/devkang89/events{/privacy}","received_events_url":"https://api.github.com/users/devkang89/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-11-01T08:37:00Z","updated_at":"2016-11-02T18:24:44Z","closed_at":"2016-11-02T18:24:44Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.1\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nHi I'm trying to use nested, terms aggregation including empty bucket as search result.\r\nProblem is when I send nested, terms aggregation query with `min_doc_count: 0` option, I can't get empty buckets. But when I send not nested terms aggregation, result is same as I expected (it includes empty buckets with value of null or 0).\r\n\r\nFor example below works well (without nested) : \r\n\r\n```json\r\n{\r\n  \"size\":0,\r\n  \"query\":{\r\n    \"bool\":{  \r\n      \"filter\":[\r\n        {\r\n          \"range\":{\r\n            \"date\":{\r\n              \"time_zone\":\"+09:00\",\r\n              \"format\":\"yyyy-MM-dd\",\r\n              \"gte\":\"2016-11-01||/d\",\r\n              \"lt\":\"2016-11-01||+1d/d\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\":{  \r\n    \"item_name\":{  \r\n      \"terms\":{  \r\n        \"field\":\"name\",\r\n        \"min_doc_count\":0,\r\n        \"size\":0\r\n      },\r\n      \"aggs\":{  \r\n        \"price_sum\":{  \r\n          \"sum\":{  \r\n            \"field\":\"price\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nAbove query returns below: \r\n```json\r\n{  \r\n  \"took\":1,\r\n  \"timed_out\":false,\r\n  \"_shards\":{  \r\n    \"total\":1,\r\n    \"successful\":1,\r\n    \"failed\":0\r\n  },\r\n  \"hits\":{  \r\n    \"total\":0,\r\n    \"max_score\":0,\r\n    \"hits\":[]\r\n  },\r\n  \"aggregations\":{  \r\n    \"name\":{  \r\n      \"doc_count_error_upper_bound\":0,\r\n      \"sum_other_doc_count\":0,\r\n      \"buckets\":[  \r\n        {  \r\n          \"key\":\"key1\",\r\n          \"doc_count\":0,\r\n          \"price_sum\":{  \r\n            \"value\":0\r\n          }\r\n        },\r\n        {  \r\n          \"key\":\"key2\",\r\n          \"doc_count\":0,\r\n          \"price_sum\":{  \r\n            \"value\":0\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nNow below query is what I'd like to send (aggregation with nested, item.property): \r\n```json\r\n{  \r\n  \"size\":0,\r\n  \"query\":{  \r\n    \"bool\":{  \r\n      \"filter\":[  \r\n        {  \r\n          \"range\":{  \r\n            \"date\":{  \r\n              \"time_zone\":\"+09:00\",\r\n              \"format\":\"yyyy-MM-dd\",\r\n              \"gte\":\"2016-11-01||/d\",\r\n              \"lt\":\"2016-11-01||+1d/d\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\":{  \r\n    \"lines\":{  \r\n      \"nested\":{  \r\n        \"path\":\"property\"\r\n      },\r\n      \"aggs\":{  \r\n        \"property_types\":{  \r\n          \"terms\":{  \r\n            \"field\":\"property.type\",\r\n            \"size\":0\r\n          },\r\n          \"aggs\":{  \r\n            \"some_value_of_property_sum\":{  \r\n              \"sum\":{  \r\n                \"field\":\"property.some_value\"\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nBut it returns below : \r\n```json\r\n{  \r\n  \"took\":1,\r\n  \"timed_out\":false,\r\n  \"_shards\":{  \r\n    \"total\":1,\r\n    \"successful\":1,\r\n    \"failed\":0\r\n  },\r\n  \"hits\":{  \r\n    \"total\":0,\r\n    \"max_score\":0,\r\n    \"hits\":[]\r\n  },\r\n  \"aggregations\":{  \r\n    \"property_types\":{  \r\n      \"doc_count\":0,\r\n      \"some_value_of_property_sum\":{  \r\n        \"doc_count_error_upper_bound\":0,\r\n        \"sum_other_doc_count\":0,\r\n        \"buckets\":[]\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nwhile I expect below : \r\n```json\r\n\"buckets\":[  \r\n  {\r\n    \"key\":\"key1\",\r\n    \"doc_count\":0,\r\n    \"some_value_of_property_sum\":{\r\n      \"value\":0\r\n    }\r\n  },\r\n  {\r\n    \"key\":\"key2\",\r\n    \"doc_count\":0,\r\n    \"some_value_of_property_sum\":{\r\n      \"value\":0\r\n    }\r\n  }\r\n]\r\n```\r\n\r\nWhat am I doing wrong?","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}