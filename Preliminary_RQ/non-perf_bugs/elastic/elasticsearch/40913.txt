{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40913","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40913/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40913/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40913/events","html_url":"https://github.com/elastic/elasticsearch/issues/40913","id":429925950,"node_id":"MDU6SXNzdWU0Mjk5MjU5NTA=","number":40913,"title":"DateFormat incompatibility between 6.x and 7.x","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"assignees":[{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2019-04-05T20:39:08Z","updated_at":"2019-12-13T08:31:02Z","closed_at":"2019-12-13T08:31:02Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"QA testing of ML functionality in an upgrade from 6.7.1 to 7.0.0-rc2 revealed an issue where moving shards from 6.7.1 to 7.0.0-rc2 nodes were getting stuck in the translog phase. The reason for this was that the 7.0.0-rc2 would not be able to parse the documents from the 6.7.1 node, internally throwing a `MapperParsingException` of the form `failed to parse field [@timestamp] of type [date] in document with id 'AVr3KgpQqy1yzebk-FVk'`. This would in turn make the peer recovery hang, as the node with the `MapperParsingException` would indefinitely wait for a cluster state update with an updated mapping. This issue does not only present a problem for rolling upgrades, but also does not allow any peer recovery of that index in a pure 7.x cluster unless the translog with the corresponding documents is completely purged.\r\n\r\nThe problematic dateformat field in the mappings of the index looked as follows:\r\n```\r\n  \"@timestamp\" : {\r\n    \"type\" : \"date\",\r\n    \"format\" : \"yyyy-MM-dd'T'HH:mm:ss.SSSZ\"\r\n  }, ...\r\n```\r\n\r\nThe documents  were  of the form \r\n```\r\n{\"@timestamp\":\"2013-01-25T20:16:55.000Z\", ...}\r\n```\r\n\r\nThe problem seems to be an incompatibility between 6.x and 7.x when it comes to date format parsing, possibly related to https://github.com/elastic/elasticsearch/issues/27330\r\n\r\nThe following test illustrates the problem on 7.x:\r\n```\r\n    // put this in DateFieldMapperTests\r\n    public void testFormat() throws Exception {\r\n        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\")\r\n            .startObject(\"properties\").startObject(\"@timestamp\").field(\"type\", \"date\")\r\n            .field(\"format\", \"yyyy-MM-dd'T'HH:mm:ss.SSSZ\").endObject().endObject()\r\n            .endObject().endObject());\r\n        DocumentMapper mapper = parser.parse(\"type\", new CompressedXContent(mapping));\r\n        ParsedDocument doc = mapper.parse(new SourceToParse(\"test\", \"type\", \"1\", BytesReference\r\n            .bytes(XContentFactory.jsonBuilder()\r\n                .startObject()\r\n                .field(\"@timestamp\", \"2013-01-25T20:16:55.000Z\")\r\n                .endObject()),\r\n            XContentType.JSON));\r\n        assertNotNull(doc);\r\n    }\r\n```\r\n\r\nand the corresponding test on 6.x passes:\r\n\r\n```\r\n    public void testFormat() throws Exception {\r\n        String mapping = Strings.toString(XContentFactory.jsonBuilder().startObject().startObject(\"type\")\r\n            .startObject(\"properties\").startObject(\"@timestamp\").field(\"type\", \"date\")\r\n            .field(\"format\", \"yyyy-MM-dd'T'HH:mm:ss.SSSZ\").endObject().endObject()\r\n            .endObject().endObject());\r\n        DocumentMapper mapper = parser.parse(\"type\", new CompressedXContent(mapping));\r\n        ParsedDocument doc = mapper.parse(SourceToParse.source(\"test\", \"type\", \"1\", BytesReference\r\n                .bytes(XContentFactory.jsonBuilder()\r\n                    .startObject()\r\n                    .field(\"@timestamp\", \"2013-01-25T20:16:55.000Z\")\r\n                    .endObject()),\r\n            XContentType.JSON));\r\n        assertNotNull(doc);\r\n    }\r\n```\r\n\r\nInvolved in this investigation: @pheyos and @dolaru (ML QA), @joegallo (Cloud, where rolling upgrades got stuck), @dnhatn (ES debugging + tests)","closed_by":{"login":"pgomulka","id":11137008,"node_id":"MDQ6VXNlcjExMTM3MDA4","avatar_url":"https://avatars0.githubusercontent.com/u/11137008?v=4","gravatar_id":"","url":"https://api.github.com/users/pgomulka","html_url":"https://github.com/pgomulka","followers_url":"https://api.github.com/users/pgomulka/followers","following_url":"https://api.github.com/users/pgomulka/following{/other_user}","gists_url":"https://api.github.com/users/pgomulka/gists{/gist_id}","starred_url":"https://api.github.com/users/pgomulka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgomulka/subscriptions","organizations_url":"https://api.github.com/users/pgomulka/orgs","repos_url":"https://api.github.com/users/pgomulka/repos","events_url":"https://api.github.com/users/pgomulka/events{/privacy}","received_events_url":"https://api.github.com/users/pgomulka/received_events","type":"User","site_admin":false},"performed_via_github_app":null}