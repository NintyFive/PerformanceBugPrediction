[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183963276","html_url":"https://github.com/elastic/elasticsearch/issues/16596#issuecomment-183963276","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16596","id":183963276,"node_id":"MDEyOklzc3VlQ29tbWVudDE4Mzk2MzI3Ng==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-02-14T19:41:13Z","updated_at":"2016-02-15T00:28:46Z","author_association":"MEMBER","body":"First, I think that you meant to refer to [line 629](https://github.com/elastic/elasticsearch/blob/cca611171c53254b74f2da7239e05177fec92b1d/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java#L629).\n\nMore importantly, there's no issue here but it's not straightforward why. Here's the relevant block of code.\n\n``` java\n617  String defaultTimestamp = TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP;\n618  if (mappingMd != null && mappingMd.timestamp() != null) {\n619    // If we explicitly ask to reject null timestamp\n620    if (mappingMd.timestamp().ignoreMissing() != null && mappingMd.timestamp().ignoreMissing() == false) {\n621      throw new TimestampParsingException(\"timestamp is required by mapping\");\n622    }\n623    defaultTimestamp = mappingMd.timestamp().defaultTimestamp();\n624  }\n625\n626  if (defaultTimestamp.equals(TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP)) {\n627    timestamp = Long.toString(System.currentTimeMillis());\n628  } else {\n629    timestamp = MappingMetaData.Timestamp.parseStringTimestamp(defaultTimestamp, mappingMd.timestamp().dateTimeFormatter(), getVersion(metaData, concreteIndex));\n630  }\n```\n\nThe `else` block can only be hit if `defaultTimestamp` is not equal to `TimestampFieldMapper.Default.DEFAULT_TIMESTAMP`. But on [line 617](https://github.com/elastic/elasticsearch/blob/cca611171c53254b74f2da7239e05177fec92b1d/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java#L617) it is initialized to have that value. That value is possibly changed from the default on [line 623](https://github.com/elastic/elasticsearch/blob/cca611171c53254b74f2da7239e05177fec92b1d/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java#L623), but that only occurs if `mappingMd != null` (from the condition on [line 618](https://github.com/elastic/elasticsearch/blob/cca611171c53254b74f2da7239e05177fec92b1d/core/src/main/java/org/elasticsearch/action/index/IndexRequest.java#L618)). Thus, if the `else` block in question is hit, it is guaranteed that `mappingMd` is not null; there can not be an NPE here. However, it's possible that `mappingMd.timestamp().defaultTimestamp()` is equal to `TimestampFieldMapper.Defaults.DEFAULT_TIMESTAMP` and that's why the code is written this way.\n\nI'll push a commit that has an assert that `mappingMd` is not null here, and that should keep your IDE or static analysis tool from complaining. :)\n","performed_via_github_app":null}]