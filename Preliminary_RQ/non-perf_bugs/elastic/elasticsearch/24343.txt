{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/24343","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24343/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24343/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/24343/events","html_url":"https://github.com/elastic/elasticsearch/issues/24343","id":224552670,"node_id":"MDU6SXNzdWUyMjQ1NTI2NzA=","number":24343,"title":"[CI] NestedAggregatorTests.testDoubleNestingMax fails with NPE on master","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2017-04-26T18:04:47Z","updated_at":"2017-04-28T07:01:48Z","closed_at":"2017-04-28T07:01:48Z","author_association":"MEMBER","active_lock_reason":null,"body":"It generates a failure like:\r\n\r\n```\r\n   > Throwable #1: java.lang.NullPointerException\r\n   > \tat __randomizedtesting.SeedInfo.seed([2E8565095954BB57:4326DFF2B14E7C9A]:0)\r\n   > \tat org.elasticsearch.index.cache.bitset.BitsetFilterCache.getAndLoadIfNotPresent(BitsetFilterCache.java:124)\r\n   > \tat org.elasticsearch.index.cache.bitset.BitsetFilterCache.access$000(BitsetFilterCache.java:74)\r\n   > \tat org.elasticsearch.index.cache.bitset.BitsetFilterCache$QueryWrapperBitSetProducer.getBitSet(BitsetFilterCache.java:192)\r\n   > \tat org.elasticsearch.search.aggregations.bucket.nested.NestedAggregator.getLeafCollector(NestedAggregator.java:71)\r\n   > \tat org.elasticsearch.search.aggregations.AggregatorBase.getLeafCollector(AggregatorBase.java:149)\r\n   > \tat org.elasticsearch.search.aggregations.AggregatorBase.getLeafCollector(AggregatorBase.java:41)\r\n   > \tat org.apache.lucene.search.FilterCollector.getLeafCollector(FilterCollector.java:40)\r\n   > \tat org.apache.lucene.search.AssertingCollector.getLeafCollector(AssertingCollector.java:47)\r\n   > \tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:649)\r\n   > \tat org.apache.lucene.search.AssertingIndexSearcher.search(AssertingIndexSearcher.java:72)\r\n   > \tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:462)\r\n   > \tat org.elasticsearch.search.aggregations.AggregatorTestCase.search(AggregatorTestCase.java:205)\r\n   > \tat org.elasticsearch.search.aggregations.bucket.nested.NestedAggregatorTests.testDoubleNestingMax(NestedAggregatorTests.java:174)\r\n   > \tat java.lang.Thread.run(Thread.java:745)\r\n```\r\n\r\nAnd reproduces for me with:\r\n\r\n```\r\ngradle :core:test -Dtests.seed=2E8565095954BB57 -Dtests.class=org.elasticsearch.search.aggregations.bucket.nested.NestedAggregatorTests -Dtests.method=\"testDoubleNestingMax\" -Dtests.security.manager=true -Dtests.jvms=2 -Dtests.locale=zh-TW -Dtests.timezone=Asia/Yekaterinburg\r\n```\r\n\r\nInterestingly, I notice that @martijnvg removed a null check on this particular line in c17de49a6dc1d54fcfee3754211ae67a06bdcec7, specifically:\r\n\r\n```diff\r\ndiff --git a/core/src/main/java/org/elasticsearch/index/cache/bitset/BitsetFilterCache.java b/core/src/main/java/org/el\r\nasticsearch/index/cache/bitset/BitsetFilterCache.java                                                                 \r\nindex 04d2ac4..7d3e75f 100644\r\n--- a/core/src/main/java/org/elasticsearch/index/cache/bitset/BitsetFilterCache.java\r\n+++ b/core/src/main/java/org/elasticsearch/index/cache/bitset/BitsetFilterCache.java\r\n@@ -121,8 +121,7 @@ public final class BitsetFilterCache extends AbstractIndexComponent implements I\r\n         }\r\n         final IndexReader.CacheKey coreCacheReader = cacheHelper.getKey();\r\n         final ShardId shardId = ShardUtils.extractShardId(context.reader());\r\n-        if (shardId != null // can't require it because of the percolator\r\n-                && indexSettings.getIndex().equals(shardId.getIndex()) == false) {\r\n+        if (indexSettings.getIndex().equals(shardId.getIndex()) == false) {\r\n             // insanity\r\n             throw new IllegalStateException(\"Trying to load bit set for index \" + shardId.getIndex()\r\n                     + \" with cache of index \" + indexSettings.getIndex());\r\n```\r\n\r\n@martijnvg do we need to add the null check back in?","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}