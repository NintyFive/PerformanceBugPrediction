{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14158","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14158/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14158/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14158/events","html_url":"https://github.com/elastic/elasticsearch/issues/14158","id":111833542,"node_id":"MDU6SXNzdWUxMTE4MzM1NDI=","number":14158,"title":"Cluster state and versions - when should we increment which version and how often?","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"labels":[{"id":160579278,"node_id":"MDU6TGFiZWwxNjA1NzkyNzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Discovery-Plugins","name":":Distributed/Discovery-Plugins","color":"0e8a16","default":false,"description":"Anything related to our integration plugins with EC2, GCP and Azure"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2015-10-16T13:36:32Z","updated_at":"2018-03-20T10:12:56Z","closed_at":"2018-03-20T10:12:56Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"While reviewing https://github.com/elastic/elasticsearch/pull/14062 I found it somewhat difficult to reason about which version is incremented when in the cluster state. I open this issue to summarize how I think versions work right now and to maybe get some feedback on how this can be handled in a more easy to understand way.\n\nThis is the version numbers we maintain:\n- cluster state version: \n  - should be incremented only by one each time a cluster state update task is processed and actually yielded any change in the whole cluster state\n  - currently only changed in the [cluster state update thread](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java#L438).\n- `MetaData` version: \n  - should increment each time something in the cluster settings or index meta data changes. \n  - currently only changed in the [cluster state update thread](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java#L443).\n- `IndexMetaData` version: \n  - Should increment whenever some index specific property changes (mapping, settings, etc. expect for routing changes which we track in shard version). \n  - changed in many places, look at `IndexMetaData.Builder.version(..)` and where it is called.\n- `RoutingTable` version\n  - should increment each time any shard routing changes\n  - currently changed in the [cluster state update thread](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java#L440) and `AllocationService.buildChangedResult(..)`.\n- Shard version: \n  - incremented each time something in the routing of a single shard changes (add/remove replica, relocate shard etc.). \n  - Shard version is stored in the `ShardRouting`s. It is updated when a single `ShardRouting` changes during allocation and then copied over to all `ShardRouting`s from the same copy in `IndexRoutingTable.normalizeVersions()` once allocation has finished.\n\nQ: Cluster state version and `MetaData` version are updated only once per cluster state update task but the others are not or at least it is not immediately clear if they can potentially be incremented by > 1. It it OK if `IndexMetaData` version,  `RoutingTable` version and shard version increment by more than one between cluster states?\n\nWhile I think I understand why we do versioning now the way we do it I find it cumbersome to read and wonder if there is a cleaner way to maintain these versions.\nFor example: we only need the version increments before master sends the new cluster state to the other nodes. Can we build a new cluster state without incrementing any version in any of the components and then [here](https://github.com/elastic/elasticsearch/blob/master/core/src/main/java/org/elasticsearch/cluster/service/InternalClusterService.java#L438) check the difference between new and old cluster state and update all versions in one go? This would leave no questions open about when versions are updated and where. Chatted very briefly with @s1monw who thinks this will add complexity and not remove any but I have not yet given up hope and will give it a shot. \n\nAny kind of feedback is more than welcome.\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}