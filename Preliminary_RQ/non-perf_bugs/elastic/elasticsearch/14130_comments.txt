[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/148368911","html_url":"https://github.com/elastic/elasticsearch/issues/14130#issuecomment-148368911","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14130","id":148368911,"node_id":"MDEyOklzc3VlQ29tbWVudDE0ODM2ODkxMQ==","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2015-10-15T12:16:53Z","updated_at":"2015-10-15T12:16:53Z","author_association":"CONTRIBUTOR","body":"Can you add the full query here? I cannot reproduce this.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/148638844","html_url":"https://github.com/elastic/elasticsearch/issues/14130#issuecomment-148638844","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14130","id":148638844,"node_id":"MDEyOklzc3VlQ29tbWVudDE0ODYzODg0NA==","user":{"login":"neerajgoyal12","id":182018,"node_id":"MDQ6VXNlcjE4MjAxOA==","avatar_url":"https://avatars0.githubusercontent.com/u/182018?v=4","gravatar_id":"","url":"https://api.github.com/users/neerajgoyal12","html_url":"https://github.com/neerajgoyal12","followers_url":"https://api.github.com/users/neerajgoyal12/followers","following_url":"https://api.github.com/users/neerajgoyal12/following{/other_user}","gists_url":"https://api.github.com/users/neerajgoyal12/gists{/gist_id}","starred_url":"https://api.github.com/users/neerajgoyal12/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neerajgoyal12/subscriptions","organizations_url":"https://api.github.com/users/neerajgoyal12/orgs","repos_url":"https://api.github.com/users/neerajgoyal12/repos","events_url":"https://api.github.com/users/neerajgoyal12/events{/privacy}","received_events_url":"https://api.github.com/users/neerajgoyal12/received_events","type":"User","site_admin":false},"created_at":"2015-10-16T07:39:24Z","updated_at":"2015-10-16T07:39:24Z","author_association":"NONE","body":"#### Create Index with Mappings\n\n```\ncurl -XPUT localhost:9200/test -d '{\n    \"mappings\" : {\n      \"user_profiles\" : {\n        \"properties\" : {\n          \"about_me\" : {\n            \"type\" : \"string\",\n            \"analyzer\" : \"standard\"\n          },\n          \"created_at\" : {\n            \"type\" : \"string\"\n          },\n          \"dob\" : {\n            \"type\" : \"date\",\n            \"format\" : \"dateOptionalTime\"\n          },\n          \"first_name\" : {\n            \"type\" : \"string\",\n            \"analyzer\" : \"standard\"\n          },\n          \"flagged\" : {\n            \"type\" : \"integer\"\n          },\n          \"gender\" : {\n            \"type\" : \"integer\"\n          },\n          \"id\" : {\n            \"type\" : \"long\"\n          },\n          \"last_name\" : {\n            \"type\" : \"string\",\n            \"analyzer\" : \"standard\"\n          },\n          \"location\" : {\n            \"type\" : \"geo_point\",\n            \"fielddata\" : {\n              \"format\" : \"compressed\",\n              \"precision\" : \"1km\"\n            }\n          },\n          \"quirky_fact\" : {\n            \"type\" : \"string\",\n            \"analyzer\" : \"standard\"\n          },\n          \"updated_at\" : {\n            \"type\" : \"string\"\n          },\n          \"user_id\" : {\n            \"type\" : \"long\"\n          }\n        }\n      }\n    }\n}'\n\n```\n\n#### Add Document 1 to Index\n\n```\ncurl -XPUT localhost:9200/test/user_profiles/1 -d '{\n  \"id\": 1,\n  \"first_name\": \"First_1\",\n  \"last_name\": \"Last_1\",\n  \"gender\": 0,\n  \"dob\": \"1986-01-03\",\n  \"about_me\": \"Veniam optio rerum.\",\n  \"quirky_fact\": \"Delectus sed.\",\n  \"location\": \"21.822714, 75.034688\",\n  \"user_id\": 1,\n  \"flagged\": 0,\n  \"created_at\": \"2015-08-20 17:46:40\",\n  \"updated_at\": \"2015-08-20 17:46:40\"\n}'\n\n```\n\n#### Add Document 2 to Index\n\n```\ncurl -XPUT localhost:9200/test/user_profiles/2 -d '{\n  \"id\": 2,\n  \"first_name\": \"First_287\",\n  \"last_name\": \"Last_287\",\n  \"gender\": 1,\n  \"dob\": \"1993-04-12\",\n  \"about_me\": \"Deserunt dolor.\",\n  \"quirky_fact\": \"Omnis cum.\",\n  \"location\": \"22.359215, 75.999696\",\n  \"user_id\": 287,\n  \"flagged\": 0,\n  \"created_at\": \"2015-08-20 17:46:40\",\n  \"updated_at\": \"2015-08-20 17:46:40\"\n}'\n\n```\n\n#### Query 1\n\n```\n  curl -XGET localhost:9200/test/user_profiles/_search?pretty  -d '{\n    \"from\": 0,\n    \"size\": 100,\n    \"_source\": {\n      \"include\": [\n        \"user_id\"\n      ]\n    },\n    \"min_score\": 2,\n    \"query\": {\n      \"function_score\": {\n        \"functions\": [\n          {\n            \"linear\": {\n              \"dob\": {\n                \"origin\": \"now\",\n                \"scale\": \"1825d\",\n                \"offset\": \"8395d\"\n              }\n            }\n          },\n          {\n            \"linear\": {\n              \"location\": {\n                \"origin\": \"22.242074, 75.936335\",\n                \"scale\": \"20km\",\n                \"offset\": \"20km\",\n                \"decay\": 0.5\n              }\n            }\n          }\n        ],\n        \"query\": {\n          \"bool\": {\n            \"must\": {\n              \"term\": {\n                \"gender\": \"1\"\n              }\n            },\n            \"must_not\": [\n              {\n                \"term\": {\n                  \"user_id\": \"1\"\n                }\n              },\n              {\n                \"term\": {\n                  \"gender\": 0\n                }\n              }\n            ]\n          }\n        },\n        \"score_mode\": \"sum\"\n      }\n    },\n    \"sort\": {\n      \"_score\": {\n        \"order\": \"desc\"\n      },\n      \"created_at\": {\n        \"order\": \"desc\"\n      }\n    }\n  }'\n```\n\n#### Query 2\n\n```\n  curl -XGET localhost:9200/test/user_profiles/_search?pretty  -d '{\n    \"from\": 0,\n    \"size\": 100,\n    \"_source\": {\n      \"include\": [\n        \"user_id\"\n      ]\n    },\n    \"min_score\": 2,\n    \"query\": {\n      \"function_score\": {\n        \"functions\": [\n          {\n            \"linear\": {\n              \"dob\": {\n                \"origin\": \"now\",\n                \"scale\": \"1825d\",\n                \"offset\": \"8395d\"\n              }\n            }\n          },\n          {\n            \"linear\": {\n              \"location\": {\n                \"origin\": \"22.242074, 75.936335\",\n                \"scale\": \"20km\",\n                \"offset\": \"20km\",\n                \"decay\": 0.5\n              }\n            }\n          }\n        ],        \n        \"score_mode\": \"sum\"\n      }\n    },\n    \"sort\": {\n      \"_score\": {\n        \"order\": \"desc\"\n      },\n      \"created_at\": {\n        \"order\": \"desc\"\n      }\n    }\n  }'\n```\n\n#### Answer\n\n```\n\n{\n  \"took\" : 5,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : null,\n    \"hits\" : [ {\n      \"_index\" : \"test\",\n      \"_type\" : \"user_profiles\",\n      \"_id\" : \"2\",\n      \"_score\" : 2.0,\n      \"_source\":{\"user_id\":287},\n      \"sort\" : [ 2.0, \"46\" ]\n    } ]\n  }\n}\n```\n\nThe score for the above query is 2.0 which i think is wrong. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/148654723","html_url":"https://github.com/elastic/elasticsearch/issues/14130#issuecomment-148654723","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14130","id":148654723,"node_id":"MDEyOklzc3VlQ29tbWVudDE0ODY1NDcyMw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-10-16T08:38:45Z","updated_at":"2015-10-16T08:38:45Z","author_association":"CONTRIBUTOR","body":"This is working correctly.  Here's a simpler version of your example:\n\n```\nDELETE test\n\nPUT /test\n{\n    \"mappings\" : {\n      \"user_profiles\" : {\n        \"properties\" : {\n          \"location\" : {\n            \"type\" : \"geo_point\",\n            \"fielddata\" : {\n              \"format\" : \"compressed\",\n              \"precision\" : \"1km\"\n            }\n          }\n        }\n      }\n    }\n}\n\nPUT /test/user_profiles/1\n{\n  \"location\": \"21.822714, 75.034688\"\n}\n\nPUT /test/user_profiles/2\n{\n  \"location\": \"22.359215, 75.999696\"\n}\n\nGET /test/user_profiles/_search?_source=0&explain=0\n{\n  \"query\": {\n    \"function_score\": {\n      \"functions\": [\n        {\n          \"linear\": {\n            \"location\": {\n              \"origin\": \"22.242074, 75.936335\",\n              \"scale\": \"20km\",\n              \"offset\": \"20km\",\n              \"decay\": 0.5\n            }\n          }\n        }\n      ],\n      \"score_mode\": \"sum\"\n    }\n  },\n  \"sort\": [\n    \"_score\",\n    {\n      \"_geo_distance\": {\n        \"location\": \"22.242074, 75.936335\",\n        \"unit\": \"km\", \n        \"order\": \"desc\"\n      }\n    }\n  ]\n}\n```\n\nResults:\n\n```\n  \"hits\": [\n     {\n        \"_index\": \"test\",\n        \"_type\": \"user_profiles\",\n        \"_id\": \"2\",\n        \"_score\": 1,\n        \"sort\": [\n           1,\n           14.574812786503244\n        ]\n     },\n     {\n        \"_index\": \"test\",\n        \"_type\": \"user_profiles\",\n        \"_id\": \"1\",\n        \"_score\": 0,\n        \"sort\": [\n           0,\n           104.04650815165414\n        ]\n     }\n  ]\n```\n\nDocument 2 is within the `offset` of 20km, and so gets the full score of `1.0`, and document 1 is far enough away that the score has dropped to `0.0`.\n","performed_via_github_app":null}]