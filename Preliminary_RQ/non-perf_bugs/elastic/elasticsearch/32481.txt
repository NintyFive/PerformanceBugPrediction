{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32481","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32481/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32481/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32481/events","html_url":"https://github.com/elastic/elasticsearch/issues/32481","id":345998162,"node_id":"MDU6SXNzdWUzNDU5OTgxNjI=","number":32481,"title":"watcher fails to respect format=json in cat api when a cluster has more than 1 node.","user":{"login":"TomonoriSoejima","id":25199092,"node_id":"MDQ6VXNlcjI1MTk5MDky","avatar_url":"https://avatars3.githubusercontent.com/u/25199092?v=4","gravatar_id":"","url":"https://api.github.com/users/TomonoriSoejima","html_url":"https://github.com/TomonoriSoejima","followers_url":"https://api.github.com/users/TomonoriSoejima/followers","following_url":"https://api.github.com/users/TomonoriSoejima/following{/other_user}","gists_url":"https://api.github.com/users/TomonoriSoejima/gists{/gist_id}","starred_url":"https://api.github.com/users/TomonoriSoejima/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/TomonoriSoejima/subscriptions","organizations_url":"https://api.github.com/users/TomonoriSoejima/orgs","repos_url":"https://api.github.com/users/TomonoriSoejima/repos","events_url":"https://api.github.com/users/TomonoriSoejima/events{/privacy}","received_events_url":"https://api.github.com/users/TomonoriSoejima/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-07-31T01:14:19Z","updated_at":"2018-08-31T07:40:30Z","closed_at":"2018-08-31T07:40:29Z","author_association":"NONE","active_lock_reason":null,"body":"In 6.2.2 or higher, when you define watcher against `_cat` as explained in [here](https://www.elastic.co/guide/en/elastic-stack-overview/current/input-http.html#_calling_elasticsearch_apis) with `format=json` in a cluster with multiple nodes, it fails to return json and instead it returns text.\r\n\r\nSince the response is different it can break your watcher code if you rely on your payload because payload path will be different from `data` to `_value`.\r\n\r\n- request \r\n\r\n```\r\nPUT /_xpack/watcher/watch/status-test\r\n{\r\n  \"trigger\": {\r\n    \"schedule\": {\r\n      \"interval\": \"1h\"\r\n    }\r\n  },\r\n  \"input\": {\r\n    \"http\": {\r\n      \"request\": {\r\n        \"host\": \"localhost\",\r\n        \"port\": 9200,\r\n        \"method\" : \"GET\",\r\n        \"path\": \"_cat/health?format=json\"\r\n      }\r\n    }\r\n  },\r\n  \"condition\": {\r\n    \"script\": {\r\n      \"source\": \"\"\"\r\n      def color = ctx.payload.data.0.status;\r\n      \r\n      return color != \"green\";\r\n    \"\"\"\r\n    }\r\n  }, \r\n  \"actions\": {\r\n    \"log\": {\r\n      \"logging\": {\r\n        \"text\": \"cluster is {{ctx.payload.data.0.status}}\"\r\n      }\r\n    }\r\n  }\r\n} \r\n\r\nPOST _xpack/watcher/watch/status-test/_execute\r\n```\r\n- response snippet in multiple nodes\r\n\r\n\r\nThe response comes back as `json`\r\n```\r\n        \"payload\": {\r\n          \"_headers\": {\r\n            \"content-type\": [\r\n              \"text/plain; charset=UTF-8\"\r\n            ]\r\n          },\r\n          \"_value\": \"1532999234 10:07:14 elasticsearch green 3 3 54 27 0 0 0 0 - 100.0%\\n\",\r\n          \"_status_code\": 200\r\n        },\r\n```\r\n\r\n\r\n- response snippet in single node\r\n\r\n```\r\n        \"payload\": {\r\n          \"_headers\": {\r\n            \"content-type\": [\r\n              \"application/json; charset=UTF-8\"\r\n            ]\r\n          },\r\n          \"data\": [\r\n            {\r\n              \"epoch\": \"1532998773\",\r\n              \"timestamp\": \"09:59:33\",\r\n              \"cluster\": \"webcluster\",\r\n              \"status\": \"yellow\",\r\n              \"node.total\": \"1\",\r\n              \"node.data\": \"1\",\r\n              \"shards\": \"5\",\r\n              \"pri\": \"5\",\r\n              \"relo\": \"0\",\r\n              \"init\": \"0\",\r\n              \"unassign\": \"3\",\r\n              \"pending_tasks\": \"0\",\r\n              \"max_task_wait_time\": \"-\",\r\n              \"active_shards_percent\": \"62.5%\"\r\n            }\r\n          ],\r\n          \"_status_code\": 200\r\n```","closed_by":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"performed_via_github_app":null}