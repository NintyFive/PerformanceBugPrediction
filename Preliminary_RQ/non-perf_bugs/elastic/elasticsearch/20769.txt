{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20769","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20769/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20769/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20769/events","html_url":"https://github.com/elastic/elasticsearch/issues/20769","id":181237473,"node_id":"MDU6SXNzdWUxODEyMzc0NzM=","number":20769,"title":"Strict URL Parsing Rejects Compound `preference` Parameter","user":{"login":"jbaiera","id":875779,"node_id":"MDQ6VXNlcjg3NTc3OQ==","avatar_url":"https://avatars1.githubusercontent.com/u/875779?v=4","gravatar_id":"","url":"https://api.github.com/users/jbaiera","html_url":"https://github.com/jbaiera","followers_url":"https://api.github.com/users/jbaiera/followers","following_url":"https://api.github.com/users/jbaiera/following{/other_user}","gists_url":"https://api.github.com/users/jbaiera/gists{/gist_id}","starred_url":"https://api.github.com/users/jbaiera/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jbaiera/subscriptions","organizations_url":"https://api.github.com/users/jbaiera/orgs","repos_url":"https://api.github.com/users/jbaiera/repos","events_url":"https://api.github.com/users/jbaiera/events{/privacy}","received_events_url":"https://api.github.com/users/jbaiera/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"assignees":[{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2016-10-05T18:58:17Z","updated_at":"2016-10-07T12:17:01Z","closed_at":"2016-10-07T12:17:01Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: master\n\n**Plugins installed**: []\n\n**JVM version**: 1.8\n\n**OS version**: any\n\n**Description of the problem including expected versus actual behavior**:\nThe [`preference` parameter](https://www.elastic.co/guide/en/elasticsearch/reference/5.0/search-request-preference.html) allows you to limit which shards you execute a search against with the `_shards:x,y,z` property. You can combine this `_shards` configuration with other preferences by separating the items with a semicolon.\n\nSo if I want to look for all documents that are hosted on a single shard, and prefer that the operation be executed on the primary shard (not a replica) I would type the following:\n\n```\ncurl -XPOST ‘localhost:9200/test/test/_search?preference=_shards:0;_primary’\n```\n\nThis now gets flagged by the new strict URL parsing (https://github.com/elastic/elasticsearch/pull/20722), as it highlights that `_primary` is not recognized:\n\n```\n>> {\"error\":{\"root_cause\":[{\"type\":\"illegal_argument_exception\",\"reason\":\"request [/test/test/_search] contains unrecognized parameter: [_primary]\"}],\"type\":\"illegal_argument_exception\",\"reason\":\"request [/test/test/_search] contains unrecognized parameter: [_primary]\"},\"status\":400}\n```\n\nHowever, searching with only one preference seems to still work:\n\n```\ncurl -XPOST ‘localhost:9200/test/test/_search?preference=_shards:0’\n>> {\"took\":1,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":1.0,\"hits\":[{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"3\",\"_score\":1.0,\"_source\":{\"c\":3}}]}}\n\ncurl -XPOST ‘localhost:9200/test/test/_search?preference=_primary’\n>> {\"took\":1,\"timed_out\":false,\"_shards\":{\"total\":2,\"successful\":2,\"failed\":0},\"hits\":{\"total\":3,\"max_score\":1.0,\"hits\":[{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"3\",\"_score\":1.0,\"_source\":{\"c\":3}},{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"1\",\"_score\":1.0,\"_source\":{\"a\":1}},{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"2\",\"_score\":1.0,\"_source\":{\"b\":2}}]}}\n```\n\nNot sure why we use a semicolon for this second level separator since semicolons are reserved characters for URLs. If the character is encoded (as “%3B”) the request completes as expected:\n\n```\ncurl -XGET 'localhost:9200/test/test/_search?preference=_shards:0%3B_primary'\n>> {\"took\":1,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":1.0,\"hits\":[{\"_index\":\"test\",\"_type\":\"test\",\"_id\":\"3\",\"_score\":1.0,\"_source\":{\"c\":3}}]}}\n```\n\n**Steps to reproduce**:\nThe test data I used isn’t really important, just enough to scatter some documents across two shards, but here are the settings and reproduction steps:\n\n```\ncurl -XPUT localhost:9200/test/ -d '{\n  \"settings\":{\n    \"number_of_shards\":2\n  }\n}'\n\ncurl -XPUT localhost:9200/test/test/1 -d ‘{“a”:1}’\ncurl -XPUT localhost:9200/test/test/2 -d ‘{“b”:2}’\ncurl -XPUT localhost:9200/test/test/3 -d ‘{“c”:\n\n#Works\ncurl -XPOST ‘localhost:9200/test/test/_search?preference=_shards:0’ \ncurl -XPOST ‘localhost:9200/test/test/_search?preference=_primary’\n\n#Used to work, now breaks\ncurl -XPOST ‘localhost:9200/test/test/_search?preference=_shards:0;_primary’\n\n#Works again\ncurl -XGET 'localhost:9200/test/test/_search?preference=_shards:0%3B_primary'\n```\n\n**Describe the feature**:\nShould we modify this parameter to use a different separator? I'm wary of continuing use of the semicolon as a list-of-lists separator in a URL. If we're doing strict parsing maybe this should be changed to a different symbol that isn't reserved...\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}