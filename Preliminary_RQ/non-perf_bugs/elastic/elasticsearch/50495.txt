{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50495","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50495/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50495/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50495/events","html_url":"https://github.com/elastic/elasticsearch/issues/50495","id":542495267,"node_id":"MDU6SXNzdWU1NDI0OTUyNjc=","number":50495,"title":"Merge failure due to: java.lang.IllegalStateException: totalPointCount=4424 was passed when we were created, but we just hit 0329 values","user":{"login":"toby-jn","id":32616473,"node_id":"MDQ6VXNlcjMyNjE2NDcz","avatar_url":"https://avatars1.githubusercontent.com/u/32616473?v=4","gravatar_id":"","url":"https://api.github.com/users/toby-jn","html_url":"https://github.com/toby-jn","followers_url":"https://api.github.com/users/toby-jn/followers","following_url":"https://api.github.com/users/toby-jn/following{/other_user}","gists_url":"https://api.github.com/users/toby-jn/gists{/gist_id}","starred_url":"https://api.github.com/users/toby-jn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/toby-jn/subscriptions","organizations_url":"https://api.github.com/users/toby-jn/orgs","repos_url":"https://api.github.com/users/toby-jn/repos","events_url":"https://api.github.com/users/toby-jn/events{/privacy}","received_events_url":"https://api.github.com/users/toby-jn/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":25,"created_at":"2019-12-26T09:23:40Z","updated_at":"2020-05-14T15:13:32Z","closed_at":"2020-05-14T15:13:32Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n```\r\nVersion: 7.4.1, Build: oss/docker/fc0eeb6e2c25915d63d871d344e3d0b45ea0ea1e/2019-10-22T17:16:35.176724Z, JVM: 13\r\n```\r\n\r\n(deployed in k8s with 3 data nodes and 3 dedicated masters)\r\n\r\n**Plugins installed**:\r\n```\r\nanalysis-url   1.0.0 (custom analysis plugin providing a token filter for URLs)\r\nrepository-gcs 7.4.1\r\nrepository-s3  7.4.1\r\n```\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\nopenjdk version \"13\" 2019-09-17\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 13+33)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13+33, mixed mode, sharing)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nLinux elasticsearch-0 4.14.138+ #1 SMP Tue Sep 3 02:58:08 PDT 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nYesterday we had an ES cluster repeatedly going red due to merge failures. In each case it was due to the error: `java.lang.IllegalStateException: totalPointCount=4424 was passed when we were created, but we just hit 0329 values`.\r\n\r\nThis was seen a total of 12 times in the last 24 hours on 3 different indices and on two different nodes.\r\n\r\nAfter the merge failure ES does not attempt to reallocate the shard and the cluster goes yellow/red.\r\n\r\nDoing a `/_cluster/reroute?retry_failed=true` causes the shard to be allocated instantaneously and the cluster health returns to green.\r\n\r\nAttempting a force merge on the index, once it has reallocated, succeeds.\r\n\r\nHave not found any other cases of this error in any of our historical logs (30d) or any of our other clusters (we have 2 other identically configured clusters in different regions as well as multiple test clusters).\r\n\r\nThe error seems to come from [lucene](https://github.com/apache/lucene-solr/blob/master/lucene/core/src/java/org/apache/lucene/util/bkd/BKDWriter.java#L228) though I don't know enough about ES/lucene internals to trace this state back.\r\n\r\nWe tried restarting one of the nodes that was getting into this state and have not seen a failure from it since then, however these have been so infrequent I'm not sure how significant that is and would like understand what the problem is before restarting other nodes where this has been seen.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n{\"type\": \"server\", \"timestamp\": \"2019-12-25T15:32:55,877Z\", \"level\": \"WARN\", \"component\": \"o.e.i.e.Engine\", \"cluster.name\": \"elasticsearch\", \"node.name\": \"elasticsearch-0\", \"message\": \" [v27.tcpevent-shrink-000188][0] failed engine [merge failed]\", \"cluster.uuid\": \"Wk2FFMJbQGKUAPPeZjek2w\", \"node.id\": \"45jcOptdTjqnA_fG1punmg\" , \r\n\"stacktrace\": [\"org.apache.lucene.index.MergePolicy$MergeException: java.lang.IllegalStateException: totalPointCount=2051853 was passed when we were created, but we just hit 0782 values\",\r\n\"at org.elasticsearch.index.engine.InternalEngine$EngineMergeScheduler$2.doRun(InternalEngine.java:2389) [elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:773) [elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\",\r\n\"at java.lang.Thread.run(Thread.java:830) [?:?]\",\r\n\"Caused by: java.lang.IllegalStateException: totalPointCount=2051853 was passed when we were created, but we just hit 0782 values\",\r\n\"at org.apache.lucene.util.bkd.BKDWriter$OneDimensionBKDWriter.add(BKDWriter.java:562) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.util.bkd.BKDWriter.merge(BKDWriter.java:497) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.codecs.lucene60.Lucene60PointsWriter.merge(Lucene60PointsWriter.java:213) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.SegmentMerger.mergePoints(SegmentMerger.java:202) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:162) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4462) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4056) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:101) ~[elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\"] }\r\n{\"type\": \"server\", \"timestamp\": \"2019-12-25T15:32:55,885Z\", \"level\": \"WARN\", \"component\": \"o.e.i.c.IndicesClusterStateService\", \"cluster.name\": \"elasticsearch\", \"node.name\": \"elasticsearch-0\", \"message\": \"[v27.tcpevent-shrink-000188][0] marking and sending shard failed due to [shard failure, reason [merge failed]]\", \"cluster.uuid\": \"Wk2FFMJbQGKUAPPeZjek2w\", \"node.id\": \"45jcOptdTjqnA_fG1punmg\" , \r\n\"stacktrace\": [\"org.apache.lucene.index.MergePolicy$MergeException: java.lang.IllegalStateException: totalPointCount=2051853 was passed when we were created, but we just hit 0782 values\",\r\n\"at org.elasticsearch.index.engine.InternalEngine$EngineMergeScheduler$2.doRun(InternalEngine.java:2389) ~[elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:773) ~[elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\",\r\n\"at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\",\r\n\"at java.lang.Thread.run(Thread.java:830) [?:?]\",\r\n\"Caused by: java.lang.IllegalStateException: totalPointCount=2051853 was passed when we were created, but we just hit 0782 values\",\r\n\"at org.apache.lucene.util.bkd.BKDWriter$OneDimensionBKDWriter.add(BKDWriter.java:562) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.util.bkd.BKDWriter.merge(BKDWriter.java:497) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.codecs.lucene60.Lucene60PointsWriter.merge(Lucene60PointsWriter.java:213) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.SegmentMerger.mergePoints(SegmentMerger.java:202) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:162) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4462) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:4056) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:625) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\",\r\n\"at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.doMerge(ElasticsearchConcurrentMergeScheduler.java:101) ~[elasticsearch-7.4.1.jar:7.4.1]\",\r\n\"at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:662) ~[lucene-core-8.2.0.jar:8.2.0 31d7ec7bbfdcd2c4cc61d9d35e962165410b65fe - ivera - 2019-07-19 15:05:56]\"] }\r\n```","closed_by":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"performed_via_github_app":null}