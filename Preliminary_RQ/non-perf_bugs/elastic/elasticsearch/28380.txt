{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28380","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28380/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28380/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28380/events","html_url":"https://github.com/elastic/elasticsearch/issues/28380","id":291699445,"node_id":"MDU6SXNzdWUyOTE2OTk0NDU=","number":28380,"title":"High Level REST client fails to parse query results with certain script fields","user":{"login":"wfhartford","id":717585,"node_id":"MDQ6VXNlcjcxNzU4NQ==","avatar_url":"https://avatars2.githubusercontent.com/u/717585?v=4","gravatar_id":"","url":"https://api.github.com/users/wfhartford","html_url":"https://github.com/wfhartford","followers_url":"https://api.github.com/users/wfhartford/followers","following_url":"https://api.github.com/users/wfhartford/following{/other_user}","gists_url":"https://api.github.com/users/wfhartford/gists{/gist_id}","starred_url":"https://api.github.com/users/wfhartford/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wfhartford/subscriptions","organizations_url":"https://api.github.com/users/wfhartford/orgs","repos_url":"https://api.github.com/users/wfhartford/repos","events_url":"https://api.github.com/users/wfhartford/events{/privacy}","received_events_url":"https://api.github.com/users/wfhartford/received_events","type":"User","site_admin":false},"labels":[{"id":493198109,"node_id":"MDU6TGFiZWw0OTMxOTgxMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20High%20Level%20REST%20Client","name":":Core/Features/Java High Level REST Client","color":"0e8a16","default":false,"description":"Expressive Java Client for Elasticsearch"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-01-25T20:08:53Z","updated_at":"2018-01-31T10:33:47Z","closed_at":"2018-01-30T12:19:09Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nElasticsearch Version: `Version: 6.1.2, Build: 5b1fea5/2018-01-10T02:35:59.208Z, JVM: 1.8.0_151`\r\nREST High Level Java Client Verstion: 6.1.2\r\n\r\n**Plugins installed**: X-Pack\r\n\r\n**JVM version** (`java -version`):\r\nClient Version:\r\n```\r\njava version \"1.8.0_161\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_161-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)\r\n```\r\nServer Version:\r\n```\r\nopenjdk version \"1.8.0_151\"\r\nOpenJDK Runtime Environment (build 1.8.0_151-8u151-b12-0ubuntu0.16.04.2-b12)\r\nOpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nClient Version:\r\n```\r\nLinux wrk-it-303 4.13.0-31-generic #34~16.04.1-Ubuntu SMP Fri Jan 19 17:11:01 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\nServer Version:\r\n```\r\nLinux rd-es-02 4.4.0-112-generic #135-Ubuntu SMP Fri Jan 19 11:48:36 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen using the high level rest client to query and retrieve script field values containing an array of anything other than strings, the HTTP response is 200, but an exception is thrown parsing the response. A typical error log is:\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create or use any index with at least one document,\r\n 2. Construct a query which will produce at least one result,\r\n 3. Execute that query include a scripted field which produces an object, an array, or null.\r\n\r\nThis sample class shows the exceptions encountered using several trivial scripts; modify the constants at the top so that any document is found.\r\n```java\r\nimport java.io.IOException;\r\nimport java.util.HashMap;\r\n\r\nimport org.apache.http.HttpHost;\r\nimport org.elasticsearch.action.search.SearchRequest;\r\nimport org.elasticsearch.client.RestClient;\r\nimport org.elasticsearch.client.RestHighLevelClient;\r\nimport org.elasticsearch.index.query.QueryBuilders;\r\nimport org.elasticsearch.script.Script;\r\nimport org.elasticsearch.script.ScriptType;\r\n\r\npublic final class HighLevelClientScripts {\r\n  private static final String ELASTICSEARCH_HOST = \"localhost\";\r\n  private static final String TARGET_INDEX = \"time-series\";\r\n  private static final String DOCUMENT_ID = \"NDcnKHrpsDNKN5pbJZGl6SOidqlrtDQ5IEKjdAd2p1E=\";\r\n  private static final String[] TEST_SCRIPTS = new String[]{\r\n      \"null\",\r\n      \"new HashMap()\",\r\n      \"new String[]{}\"\r\n  };\r\n\r\n  public static void main(String[] args) throws IOException {\r\n    try (final RestHighLevelClient client = new RestHighLevelClient(\r\n        RestClient.builder(new HttpHost(ELASTICSEARCH_HOST, 9200))\r\n    )) {\r\n      for (final String script : TEST_SCRIPTS) {\r\n        final SearchRequest request = new SearchRequest(TARGET_INDEX);\r\n\r\n        request.source()\r\n            .query(QueryBuilders.idsQuery().addIds(DOCUMENT_ID))\r\n            .scriptField(\"result\", new Script(ScriptType.INLINE, \"painless\", script, new HashMap<>()));\r\n\r\n        try {\r\n          client.search(request);\r\n          System.out.println(\"Script '\" + script + \"' succeeded!\");\r\n        }\r\n        catch (IOException e) {\r\n          System.out.println(\"Script '\" + script + \"' caused an exception\");\r\n          e.printStackTrace(System.out);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n**Output of the sample class**:\r\n```\r\nScript 'null' caused an exception\r\njava.io.IOException: Unable to parse response body for Response{requestLine=GET /time-series/_search?typed_keys=true&ignore_unavailable=false&expand_wildcards=open&allow_no_indices=true&search_type=query_then_fetch&batched_reduce_size=512 HTTP/1.1, host=http://rd-es-01:9200, response=HTTP/1.1 200 OK}\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:462)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:429)\r\n\tat org.elasticsearch.client.RestHighLevelClient.search(RestHighLevelClient.java:368)\r\n\tat com.ze.zemart.elasticsearchclient.HighLevelClientScripts.main(HighLevelClientScripts.java:36)\r\nCaused by: ParsingException[[innerHitParser] failed to parse field [fields]]; nested: ParsingException[Failed to parse object: unexpected token [VALUE_NULL] found];\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:316)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseSub(ObjectParser.java:325)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parse(ObjectParser.java:169)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.apply(ObjectParser.java:183)\r\n\tat org.elasticsearch.search.SearchHit.fromXContent(SearchHit.java:500)\r\n\tat org.elasticsearch.search.SearchHits.fromXContent(SearchHits.java:150)\r\n\tat org.elasticsearch.action.search.SearchResponse.fromXContent(SearchResponse.java:281)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:573)\r\n\tat org.elasticsearch.client.RestHighLevelClient.lambda$performRequestAndParseEntity$2(RestHighLevelClient.java:429)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:460)\r\n\t... 3 more\r\nCaused by: ParsingException[Failed to parse object: unexpected token [VALUE_NULL] found]\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.throwUnknownToken(XContentParserUtils.java:67)\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.parseStoredFieldsValue(XContentParserUtils.java:108)\r\n\tat org.elasticsearch.common.document.DocumentField.fromXContent(DocumentField.java:142)\r\n\tat org.elasticsearch.search.SearchHit.parseFields(SearchHit.java:610)\r\n\tat org.elasticsearch.search.SearchHit.lambda$declareInnerHitsParseFields$13(SearchHit.java:522)\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.lambda$declareObject$1(AbstractObjectParser.java:148)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.lambda$declareField$1(ObjectParser.java:214)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:314)\r\n\t... 12 more\r\nScript 'new HashMap()' caused an exception\r\njava.io.IOException: Unable to parse response body for Response{requestLine=GET /time-series/_search?typed_keys=true&ignore_unavailable=false&expand_wildcards=open&allow_no_indices=true&search_type=query_then_fetch&batched_reduce_size=512 HTTP/1.1, host=http://rd-es-01:9200, response=HTTP/1.1 200 OK}\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:462)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:429)\r\n\tat org.elasticsearch.client.RestHighLevelClient.search(RestHighLevelClient.java:368)\r\n\tat com.ze.zemart.elasticsearchclient.HighLevelClientScripts.main(HighLevelClientScripts.java:36)\r\nCaused by: ParsingException[[innerHitParser] failed to parse field [fields]]; nested: ParsingException[Failed to parse object: unexpected token [START_OBJECT] found];\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:316)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseSub(ObjectParser.java:325)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parse(ObjectParser.java:169)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.apply(ObjectParser.java:183)\r\n\tat org.elasticsearch.search.SearchHit.fromXContent(SearchHit.java:500)\r\n\tat org.elasticsearch.search.SearchHits.fromXContent(SearchHits.java:150)\r\n\tat org.elasticsearch.action.search.SearchResponse.fromXContent(SearchResponse.java:281)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:573)\r\n\tat org.elasticsearch.client.RestHighLevelClient.lambda$performRequestAndParseEntity$2(RestHighLevelClient.java:429)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:460)\r\n\t... 3 more\r\nCaused by: ParsingException[Failed to parse object: unexpected token [START_OBJECT] found]\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.throwUnknownToken(XContentParserUtils.java:67)\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.parseStoredFieldsValue(XContentParserUtils.java:108)\r\n\tat org.elasticsearch.common.document.DocumentField.fromXContent(DocumentField.java:142)\r\n\tat org.elasticsearch.search.SearchHit.parseFields(SearchHit.java:610)\r\n\tat org.elasticsearch.search.SearchHit.lambda$declareInnerHitsParseFields$13(SearchHit.java:522)\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.lambda$declareObject$1(AbstractObjectParser.java:148)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.lambda$declareField$1(ObjectParser.java:214)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:314)\r\n\t... 12 more\r\nScript 'new String[]{}' caused an exception\r\njava.io.IOException: Unable to parse response body for Response{requestLine=GET /time-series/_search?typed_keys=true&ignore_unavailable=false&expand_wildcards=open&allow_no_indices=true&search_type=query_then_fetch&batched_reduce_size=512 HTTP/1.1, host=http://rd-es-01:9200, response=HTTP/1.1 200 OK}\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:462)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequestAndParseEntity(RestHighLevelClient.java:429)\r\n\tat org.elasticsearch.client.RestHighLevelClient.search(RestHighLevelClient.java:368)\r\n\tat com.ze.zemart.elasticsearchclient.HighLevelClientScripts.main(HighLevelClientScripts.java:36)\r\nCaused by: ParsingException[[innerHitParser] failed to parse field [fields]]; nested: ParsingException[Failed to parse object: unexpected token [START_ARRAY] found];\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:316)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseSub(ObjectParser.java:325)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parse(ObjectParser.java:169)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.apply(ObjectParser.java:183)\r\n\tat org.elasticsearch.search.SearchHit.fromXContent(SearchHit.java:500)\r\n\tat org.elasticsearch.search.SearchHits.fromXContent(SearchHits.java:150)\r\n\tat org.elasticsearch.action.search.SearchResponse.fromXContent(SearchResponse.java:281)\r\n\tat org.elasticsearch.client.RestHighLevelClient.parseEntity(RestHighLevelClient.java:573)\r\n\tat org.elasticsearch.client.RestHighLevelClient.lambda$performRequestAndParseEntity$2(RestHighLevelClient.java:429)\r\n\tat org.elasticsearch.client.RestHighLevelClient.performRequest(RestHighLevelClient.java:460)\r\n\t... 3 more\r\nCaused by: ParsingException[Failed to parse object: unexpected token [START_ARRAY] found]\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.throwUnknownToken(XContentParserUtils.java:67)\r\n\tat org.elasticsearch.common.xcontent.XContentParserUtils.parseStoredFieldsValue(XContentParserUtils.java:108)\r\n\tat org.elasticsearch.common.document.DocumentField.fromXContent(DocumentField.java:142)\r\n\tat org.elasticsearch.search.SearchHit.parseFields(SearchHit.java:610)\r\n\tat org.elasticsearch.search.SearchHit.lambda$declareInnerHitsParseFields$13(SearchHit.java:522)\r\n\tat org.elasticsearch.common.xcontent.AbstractObjectParser.lambda$declareObject$1(AbstractObjectParser.java:148)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.lambda$declareField$1(ObjectParser.java:214)\r\n\tat org.elasticsearch.common.xcontent.ObjectParser.parseValue(ObjectParser.java:314)\r\n\t... 12 more\r\n```","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}