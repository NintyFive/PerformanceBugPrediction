{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26610","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26610/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26610/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26610/events","html_url":"https://github.com/elastic/elasticsearch/issues/26610","id":257163140,"node_id":"MDU6SXNzdWUyNTcxNjMxNDA=","number":26610,"title":"Possible memory issue on the master nodes in 5.5.1 with the large amount of idexes/shards","user":{"login":"lruslan","id":1275141,"node_id":"MDQ6VXNlcjEyNzUxNDE=","avatar_url":"https://avatars1.githubusercontent.com/u/1275141?v=4","gravatar_id":"","url":"https://api.github.com/users/lruslan","html_url":"https://github.com/lruslan","followers_url":"https://api.github.com/users/lruslan/followers","following_url":"https://api.github.com/users/lruslan/following{/other_user}","gists_url":"https://api.github.com/users/lruslan/gists{/gist_id}","starred_url":"https://api.github.com/users/lruslan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lruslan/subscriptions","organizations_url":"https://api.github.com/users/lruslan/orgs","repos_url":"https://api.github.com/users/lruslan/repos","events_url":"https://api.github.com/users/lruslan/events{/privacy}","received_events_url":"https://api.github.com/users/lruslan/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2017-09-12T20:00:13Z","updated_at":"2017-09-13T14:20:15Z","closed_at":"2017-09-13T14:20:15Z","author_association":"NONE","active_lock_reason":null,"body":"\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.5.1, build[19c13d0/2017-07-18T20:44:24.823Z]\r\n\r\n**Plugins installed**: [prometheus-exporter]\r\n\r\n**JVM version** (`java -version`): OpenJDK Runtime Environment (build 1.8.0_131-8u131-b11-2ubuntu1.16.04.3-b11)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux 4.4.0-78-generic #99-Ubuntu SMP Thu Apr 27 15:29:09 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nMemory usage keeps increasing on the master nodes. We see steady growth 5Gb per 24 hours. Such behaviour started as we increased number of data nodes and switched from weekly to hourly index rotation - in old setup with 5 data nodes and daily index rotation size of shards was relatively small <100 and it was enough to have master with 8Gb of RAM, now with 20 data nodes and > 400indexes with 20 shards per index we have >8,000 shards and it seem even 14Gb of RAM on the master is not enough. It's just keeps growing until OOM. In our setup we use separate dedicated nodes: masters (3 nodes) , data nodes (20 nodes), coordinator nodes (4 nodes) It's only master nodes have such issue, memory usage on other types of nodes are stable and properly garbage collected.\r\n \r\nJava Heap Stats:\r\n<img width=\"1249\" alt=\"screen shot 2017-09-12 at 21 10 54\" src=\"https://user-images.githubusercontent.com/1275141/30344674-8ef506a6-9802-11e7-9a22-2ed7b09a8cde.png\">\r\n\r\nTop classes from jhat processed heap dump of the master (with 8GB of RAM used)\r\nSorted by size:\r\n<img width=\"1087\" alt=\"screen shot 2017-09-12 at 21 03 16\" src=\"https://user-images.githubusercontent.com/1275141/30344794-053647a8-9803-11e7-9a14-b556d18c0d48.png\">\r\nSorted by count:\r\n<img width=\"1105\" alt=\"screen shot 2017-09-12 at 21 04 19\" src=\"https://user-images.githubusercontent.com/1275141/30344824-25f1b4f0-9803-11e7-90ca-daee00ff205d.png\">\r\n\r\nConfiguration of the master:\r\n```\r\ncluster.name: logging5\r\nnode.name: l5-es-m-1h5\r\nnode.master: true\r\nnode.data: false\r\nnode.ingest: false\r\nnetwork.host: 172.6.8.24\r\ndiscovery.zen.minimum_master_nodes: 2\r\ndiscovery.zen.ping.unicast.hosts: [\"172.16.8.23\",\"172.16.8.24\",\"172.16.8.25\"]\r\naction.destructive_requires_name: true\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\nIn the logs on the master I see constant updates of certain dynamic mappings, but we always had similar updates and they never caused memory related issues, especially on master nodes:\r\n```\r\n[2017-09-12T21:34:35,672][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [v2]\r\n[2017-09-12T21:36:24,578][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [v2]\r\n[2017-09-12T21:39:05,945][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [v2]\r\n[2017-09-12T21:39:07,829][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [v2]\r\n[2017-09-12T21:40:05,012][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [v2]\r\n[2017-09-12T21:41:34,597][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [v2]\r\n[2017-09-12T21:43:04,053][INFO ][o.e.c.m.MetaDataMappingService] [l5-es-m-0i9] [logstash-2017.09.12.19/3J9B1jZXQROU1FOTbWiFBQ] update_mapping [k8s] \r\n```\r\n\r\nIn case you need it I can provide access to the complete heap dump.\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}