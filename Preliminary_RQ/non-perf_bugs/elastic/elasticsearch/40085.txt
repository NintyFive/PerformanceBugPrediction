{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40085","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40085/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40085/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40085/events","html_url":"https://github.com/elastic/elasticsearch/issues/40085","id":421433471,"node_id":"MDU6SXNzdWU0MjE0MzM0NzE=","number":40085,"title":"geo_shape 'within' query regression in 6.6","user":{"login":"MohamedHamouGisaia","id":26741864,"node_id":"MDQ6VXNlcjI2NzQxODY0","avatar_url":"https://avatars1.githubusercontent.com/u/26741864?v=4","gravatar_id":"","url":"https://api.github.com/users/MohamedHamouGisaia","html_url":"https://github.com/MohamedHamouGisaia","followers_url":"https://api.github.com/users/MohamedHamouGisaia/followers","following_url":"https://api.github.com/users/MohamedHamouGisaia/following{/other_user}","gists_url":"https://api.github.com/users/MohamedHamouGisaia/gists{/gist_id}","starred_url":"https://api.github.com/users/MohamedHamouGisaia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/MohamedHamouGisaia/subscriptions","organizations_url":"https://api.github.com/users/MohamedHamouGisaia/orgs","repos_url":"https://api.github.com/users/MohamedHamouGisaia/repos","events_url":"https://api.github.com/users/MohamedHamouGisaia/events{/privacy}","received_events_url":"https://api.github.com/users/MohamedHamouGisaia/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"},{"id":1102494662,"node_id":"MDU6TGFiZWwxMTAyNDk0NjYy","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.6.0","name":"v6.6.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-03-15T09:46:41Z","updated_at":"2020-07-08T15:59:37Z","closed_at":"2020-07-08T15:59:37Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** \r\n`Version: 6.6.1, Build: default/zip/1fd8f69/2019-02-13T17:10:04.160291Z, JVM: 1.8.0_181`\r\n\r\n**Plugins installed**: \r\n`None`\r\n\r\n**JVM version** :\r\n`java version \"1.8.0_181\"`\r\n`Java(TM) SE Runtime Environment (build 1.8.0_181-b13)`\r\n`Java HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)`\r\n\r\n**OS version** \r\n`Linux tizintest 4.15.0-45-generic #48-Ubuntu SMP Tue Jan 29 16:28:13 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI indexed (with BKD-tree indexation) 4 shapes which coordinates are :\r\nP1 : [ [ 3, 4 ], [ 4, 4 ], [ 4, 3 ], [ 3, 3 ], [ 3, 4 ] ]\r\nP2 : [ [ 6, 2 ], [ 7, 2 ], [ 7, 1 ], [ 6, 1 ], [ 6, 2 ] ]\r\nP3 : [ [ 3, 1 ], [ 4, 1 ], [ 4, 0 ], [ 3, 0 ], [ 3, 1 ] ]\r\nP4 : [ [ 0, 2 ], [ 1, 2 ], [ 1, 1 ], [ 0, 1 ], [ 0, 2 ] ]\r\n\r\n![image](https://user-images.githubusercontent.com/26741864/54421534-ee9da800-470c-11e9-8ccb-2f41c4cbce92.png)\r\n\r\nQuerying all the shapes that are within the dashed polygon only returns polygons `P1` and `P2`\r\nThe four polygons are returned in 6.5\r\n(dashed polygon coordinates :  [ [ 0, 4 ], [ 7, 4 ], [ 7, 0 ], [ 0, 0 ], [ 0, 4 ] ])\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Index creation \r\n```bash\r\ncurl -X PUT \"localhost:9200/test_index\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"mappings\": {\r\n        \"_doc\": {\r\n            \"properties\": {\r\n                \"location\": {\r\n                    \"type\": \"geo_shape\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n'\r\n```\r\n\r\n 2. Indexing polygons (here P1 only)\r\n```bash\r\ncurl -X POST \"localhost:9200/test_index/_doc?refresh\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"location\": {\r\n    \"type\": \"Polygon\",\r\n    \"coordinates\": [\r\n      [ [ 3, 4 ], [ 4, 4 ], [ 4, 3 ], [ 3, 3 ], [ 3, 4 ] ]\r\n    ]\r\n  }\r\n}\r\n'\r\n```\r\n\r\n 3. Querying all the shapes that are *within* the dashed polygon \r\n```bash\r\ncurl -X GET \"localhost:9200/test_index/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"geo_shape\": {\r\n      \"location\": {\r\n        \"shape\": {\r\n          \"type\": \"Polygon\",\r\n          \"coordinates\": [[[0, 4], [7, 4], [7, 0], [0, 0], [0, 4]]]\r\n        },\r\n        \"relation\": \"within\"\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n","closed_by":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"performed_via_github_app":null}