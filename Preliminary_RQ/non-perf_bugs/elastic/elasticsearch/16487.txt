{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16487","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16487/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16487/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16487/events","html_url":"https://github.com/elastic/elasticsearch/issues/16487","id":131786114,"node_id":"MDU6SXNzdWUxMzE3ODYxMTQ=","number":16487,"title":"Groovy script in aggregation not working in 2.2","user":{"login":"reflection","id":652093,"node_id":"MDQ6VXNlcjY1MjA5Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/652093?v=4","gravatar_id":"","url":"https://api.github.com/users/reflection","html_url":"https://github.com/reflection","followers_url":"https://api.github.com/users/reflection/followers","following_url":"https://api.github.com/users/reflection/following{/other_user}","gists_url":"https://api.github.com/users/reflection/gists{/gist_id}","starred_url":"https://api.github.com/users/reflection/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reflection/subscriptions","organizations_url":"https://api.github.com/users/reflection/orgs","repos_url":"https://api.github.com/users/reflection/repos","events_url":"https://api.github.com/users/reflection/events{/privacy}","received_events_url":"https://api.github.com/users/reflection/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-02-05T23:14:27Z","updated_at":"2016-06-09T17:16:06Z","closed_at":"2016-02-06T00:39:20Z","author_association":"NONE","active_lock_reason":null,"body":"Reported problem in 2.0 (#14273), but this time around there are different errors:\n\nHere's the aggregation expressed in elasticsearch-dsl-py (which works fine in 1.x):\n\n```\ns.aggs \\\n  .bucket('hour', 'terms', script= \\\n          'use(groovy.time.TimeCategory) { \\\n            new Date(doc[\"timestamp\"].value).format(\"HH\") \\\n          }', size=0, order={'_term': 'asc'}) \\\n  .metric('bandwidth', 'sum', field='size') \\\n    .bucket('action', 'terms', field='action', size=0) \\\n    .metric('bandwidth', 'sum', field='size')\n```\n\nIn 2.2 we get this error:\n\n```\nes_1          | [2016-02-05 23:09:19,452][DEBUG][action.search.type       ] [Dmitri Bukharin] [356019-20160128][4], node[vJdfzAOUSzySzoEHaePQfg], [P], v[2], s[STARTED], a[id=ynZWRaZdQ6uhnwbsyMD1DA]: Failed to execute [org.elasticsearch.action.search.SearchRequest@496d4b1a] lastShard [true]\nes_1          | RemoteTransportException[[Dmitri Bukharin][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: QueryPhaseExecutionException[Query Failed [Failed to execute main query]]; nested: ScriptException[failed to run inline script [use(groovy.time.TimeCategory) {                 new Date(doc[\"timestamp\"].value).format(\"HH\")               }] using lang [groovy]]; nested: MissingPropertyException[No such property: groovy for class: 9bb55a3e15db1c99c3f7f34eb032629ba6109bc4];\nes_1          | Caused by: QueryPhaseExecutionException[Query Failed [Failed to execute main query]]; nested: ScriptException[failed to run inline script [use(groovy.time.TimeCategory) {                 new Date(doc[\"timestamp\"].value).format(\"HH\")               }] using lang [groovy]]; nested: MissingPropertyException[No such property: groovy for class: 9bb55a3e15db1c99c3f7f34eb032629ba6109bc4];\nes_1          |     at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:409)\nes_1          |     at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:113)\nes_1          |     at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:364)\nes_1          |     at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:376)\nes_1          |     at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:368)\nes_1          |     at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:365)\nes_1          |     at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\nes_1          |     at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\nes_1          |     at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\nes_1          |     at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\nes_1          |     at java.lang.Thread.run(Thread.java:745)\nes_1          | Caused by: ScriptException[failed to run inline script [use(groovy.time.TimeCategory) {                 new Date(doc[\"timestamp\"].value).format(\"HH\")               }] using lang [groovy]]; nested: MissingPropertyException[No such property: groovy for class: 9bb55a3e15db1c99c3f7f34eb032629ba6109bc4];\nes_1          |     at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:318)\nes_1          |     at org.elasticsearch.search.aggregations.support.values.ScriptBytesValues.setDocument(ScriptBytesValues.java:53)\nes_1          |     at org.elasticsearch.search.aggregations.bucket.terms.StringTermsAggregator$1.collect(StringTermsAggregator.java:80)\nes_1          |     at org.elasticsearch.search.aggregations.LeafBucketCollector.collect(LeafBucketCollector.java:88)\nes_1          |     at org.apache.lucene.search.MultiCollector$MultiLeafCollector.collect(MultiCollector.java:173)\nes_1          |     at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:218)\nes_1          |     at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:169)\nes_1          |     at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39)\nes_1          |     at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:821)\nes_1          |     at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:535)\nes_1          |     at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:384)\nes_1          |     ... 10 more\nes_1          | Caused by: groovy.lang.MissingPropertyException: No such property: groovy for class: 9bb55a3e15db1c99c3f7f34eb032629ba6109bc4\nes_1          |     at org.codehaus.groovy.runtime.ScriptBytecodeAdapter.unwrap(ScriptBytecodeAdapter.java:53)\nes_1          |     at org.codehaus.groovy.vmplugin.v7.IndyGuardsFiltersAndSignatures.unwrap(IndyGuardsFiltersAndSignatures.java:177)\nes_1          |     at 9bb55a3e15db1c99c3f7f34eb032629ba6109bc4.run(9bb55a3e15db1c99c3f7f34eb032629ba6109bc4:1)\nes_1          |     at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript$1.run(GroovyScriptEngineService.java:311)\nes_1          |     at java.security.AccessController.doPrivileged(Native Method)\nes_1          |     at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:308)\n```\n","closed_by":{"login":"reflection","id":652093,"node_id":"MDQ6VXNlcjY1MjA5Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/652093?v=4","gravatar_id":"","url":"https://api.github.com/users/reflection","html_url":"https://github.com/reflection","followers_url":"https://api.github.com/users/reflection/followers","following_url":"https://api.github.com/users/reflection/following{/other_user}","gists_url":"https://api.github.com/users/reflection/gists{/gist_id}","starred_url":"https://api.github.com/users/reflection/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reflection/subscriptions","organizations_url":"https://api.github.com/users/reflection/orgs","repos_url":"https://api.github.com/users/reflection/repos","events_url":"https://api.github.com/users/reflection/events{/privacy}","received_events_url":"https://api.github.com/users/reflection/received_events","type":"User","site_admin":false},"performed_via_github_app":null}