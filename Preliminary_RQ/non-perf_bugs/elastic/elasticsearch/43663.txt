{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/43663","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43663/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43663/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43663/events","html_url":"https://github.com/elastic/elasticsearch/issues/43663","id":461185983,"node_id":"MDU6SXNzdWU0NjExODU5ODM=","number":43663,"title":"Retention for Snapshot Lifecycle Management","user":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"labels":[{"id":912828538,"node_id":"MDU6TGFiZWw5MTI4Mjg1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/ILM+SLM","name":":Core/Features/ILM+SLM","color":"0e8a16","default":false,"description":"Index and Snapshot lifecycle management"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},{"login":"gwbrown","id":1522844,"node_id":"MDQ6VXNlcjE1MjI4NDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1522844?v=4","gravatar_id":"","url":"https://api.github.com/users/gwbrown","html_url":"https://github.com/gwbrown","followers_url":"https://api.github.com/users/gwbrown/followers","following_url":"https://api.github.com/users/gwbrown/following{/other_user}","gists_url":"https://api.github.com/users/gwbrown/gists{/gist_id}","starred_url":"https://api.github.com/users/gwbrown/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gwbrown/subscriptions","organizations_url":"https://api.github.com/users/gwbrown/orgs","repos_url":"https://api.github.com/users/gwbrown/repos","events_url":"https://api.github.com/users/gwbrown/events{/privacy}","received_events_url":"https://api.github.com/users/gwbrown/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-06-26T21:17:42Z","updated_at":"2019-10-21T14:42:01Z","closed_at":"2019-10-21T14:42:01Z","author_association":"MEMBER","active_lock_reason":null,"body":"SLM as a standalone snapshot taking tool is taking shape as described in #38461. However, to fully utilize SLM, we should implement retention for the snapshots that SLM takes.\r\n\r\nPolicy definition would change to something like:\r\n\r\n```\r\nPUT /_slm/policy/snapshot-every-day\r\n{\r\n  \"schedule\": \"0 30 2 * * ?\",\r\n  \"name\": \"<production-snap-{now/d}>\",\r\n  \"repository\": \"my-s3-repository\",\r\n  \"config\": {\r\n    \"indices\": [\"foo-*\", \"important\"]\r\n  },\r\n  // Newly configured retention options\r\n  \"retention\": {\r\n    // Snapshots should be deleted after 14 days\r\n    \"expire_after\": \"14d\",\r\n    // Keep a maximum of thirty snapshots\r\n    \"max_count\": 30,\r\n    // Keep a minimum of the four most recent snapshots\r\n    \"min_count\": 4\r\n  }\r\n}\r\n```\r\n\r\nSnapshot retention would kick in based on a schedule (supporting cron expressions) and configured with the newly introduced `slm.retention_schedule` cluster setting. This would allow administrators to configure when snapshots are deleted (so as not to interfere with other cluster operations).\r\n\r\nPotentially, SLM retention would need to cap the amount of time spent deleting snapshots (probably with another cluster setting) so long-running deletes don't cause issues with other cluster operations.\r\n\r\nPotential list of snapshot conditions:\r\n- age-based retention (delete snapshots after N days)\r\n- minimum number of snapshots to keep\r\n- maximum number of snapshots to allow (delete oldest if there are too many)\r\n\r\nSome things to work out\r\n- What should we do with FAILED/PARTIAL snapshots? Should they be treated as subject to retention? Separate retention?\r\n\r\nFor the first release, treating PARTIAL as failed and not eligible for retention\r\n\r\n- Are there retry policies for deletion, or should we wait for the next invocation of the retention task\r\n- Does the order of old snapshot deletion matter?\r\n\r\nOldest snapshots will be deleted first\r\n\r\n------------------\r\n\r\nTask Checklist\r\n--------------\r\n\r\n- [x] Add support for `_meta` in `CreateSnapshotRequest` (@gwbrown) #41281\r\n- [x] Send `_meta` associating each snapshot with the policy that created it (@gwbrown) #43132\r\n- [x] Create the feature branch (`slm-retention`) (@dakrone) #43605\r\n- [x] Modify `SnapshotLifecyclePolicy` to support retention configuration (@dakrone) #43777\r\n- [x] Modify `SnapshotRetentionTask` to implement snapshot deletion (@dakrone) #44764\r\n- [x] Implement the rest of the `SnapshotRetentionConfiguration` predicates (@dakrone) #44926\r\n- [x] Add separate API reporting of retention statistics/information (@dakrone) #45362\r\n  - [x] Add HLRC support for SLM stats endpoint (@dakrone) #45989\r\n- [x] Add per-policy retention metrics to the GetSnapshotLifecyclePolicy API (@dakrone) #45989\r\n- [x] Make retention wait for ongoing snapshots before attempting to delete (@dakrone) #45802\r\n- [x] Store snapshot retention actions in the SLM history index (@gwbrown) #45513\r\n  - [ ] Add or document creating a Watch that allows reporting failed SLM retention info (@gwbrown)\r\n- [x] Time-bound time spent in retention snapshot deletion (@dakrone) #45065\r\n- [x] Add version checks to ensure we are compatible with 7.4\r\n- [x] Ensure SLM retention obeys the ILM stop/start `OperationMode` (@dakrone) #45869\r\n- ~Investigate retention of data in snapshots based on *document/data* age (put into snap meta?) instead of snapshot age~+~ see: #45252\r\n- [x] Update SLM stats not to use dynamic key names (@gwbrown) #46991\r\n- [x] Decide on treatment of `FAILURE` and `PARTIAL` snapshots #46988 (@gwbrown) #47617\r\n- [x] Merge to master\r\n- [x] Add API to execute retention manually (@dakrone) #47405\r\n- ~Add cooldown period in between SLM operations #47520 (@dakrone)~\r\n- [x] Documentation (@dakrone) #47545\r\n- [x] Decide on a default retention schedule (@dakrone) #47604\r\n- [x] Separate start/stop/status API from ILM (@dakrone) #47710\r\n- [ ] Testing\r\n  - [x] Tests with security (@dakrone) #47608\r\n  - [x] Tests that we handle ongoing snapshots and/or deletion correctly (added in #45802)\r\n  - [ ] Test BWC and cluster restarting (to avoid bugs like #46499) (@dakrone)","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}