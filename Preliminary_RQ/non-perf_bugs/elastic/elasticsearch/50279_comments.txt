[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/566586127","html_url":"https://github.com/elastic/elasticsearch/issues/50279#issuecomment-566586127","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50279","id":566586127,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NjU4NjEyNw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-12-17T15:17:40Z","updated_at":"2019-12-17T15:17:40Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed (:Distributed/CCR)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/566627942","html_url":"https://github.com/elastic/elasticsearch/issues/50279#issuecomment-566627942","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50279","id":566627942,"node_id":"MDEyOklzc3VlQ29tbWVudDU2NjYyNzk0Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-12-17T16:14:06Z","updated_at":"2019-12-17T16:14:06Z","author_association":"CONTRIBUTOR","body":"I've had a quick look at this. I suspect that `testAutoFollowPatterns` is  the real failure, and that the `testFollowIndex` failure is just a side-effect of the prior test failing (and still having background actions running).\r\n\r\nHere are the relevant logs from the follower cluster:\r\n\r\n```\r\n[2019-12-17T14:00:11,965][INFO ][o.e.x.c.a.AutoFollowCoordinator] [follow-cluster-0] Auto followed leader index [logs-eu-20190101] as follow index [logs-eu-20190101]\r\n[2019-12-17T14:00:12,141][INFO ][o.e.c.m.MetaDataCreateIndexService] [follow-cluster-0] [.monitoring-es-7-2019.12.17] creating index, cause [auto(bulk api)], templates [.monitoring-es], shards [1]/[0], mappings [_doc]\r\n[2019-12-17T14:00:12,584][INFO ][o.e.x.w.WatcherService   ] [follow-cluster-0] reloading watcher, reason [new local watcher shard allocation ids], cancelled [0] queued tasks\r\n[2019-12-17T14:00:13,313][INFO ][o.e.c.m.MetaDataMappingService] [follow-cluster-0] [.watches/yH0UAwgJQme3sSbdhr7Xzg] update_mapping [_doc]\r\n[2019-12-17T14:00:13,449][INFO ][o.e.c.m.MetaDataMappingService] [follow-cluster-0] [.watches/yH0UAwgJQme3sSbdhr7Xzg] update_mapping [_doc]\r\n[2019-12-17T14:00:14,882][DEBUG][o.e.a.a.c.s.r.RestoreClusterStateListener] [follow-cluster-0] restore of [_latest_/_latest_] completed\r\n[2019-12-17T14:00:15,784][INFO ][o.e.x.c.a.ShardFollowTasksExecutor] [follow-cluster-0] [logs-eu-20190101][0] Starting to track leader shard [logs-eu-20190101][0]\r\n[2019-12-17T14:00:15,970][INFO ][o.e.x.c.a.ShardFollowNodeTask] [follow-cluster-0] [logs-eu-20190101][0] following leader shard [logs-eu-20190101][0], follower global checkpoint=[-1], mapping version=[2], settings version=[0], aliases version=[0]\r\n[2019-12-17T14:00:16,265][DEBUG][o.e.a.a.c.s.r.RestoreClusterStateListener] [follow-cluster-0] restore of [_latest_/_latest_] completed\r\n[2019-12-17T14:00:16,597][INFO ][o.e.x.c.a.ShardFollowTasksExecutor] [follow-cluster-0] [forget-follower][0] Starting to track leader shard [forget-leader][0]\r\n[2019-12-17T14:00:16,760][INFO ][o.e.x.c.a.ShardFollowNodeTask] [follow-cluster-0] [forget-follower][0] following leader shard [forget-leader][0], follower global checkpoint=[-1], mapping version=[1], settings version=[0], aliases version=[0]\r\n[2019-12-17T14:00:16,875][DEBUG][o.e.a.a.c.n.t.c.TransportCancelTasksAction] [follow-cluster-0] Received ban for the parent [U1yJrVrFStimvrL_QzmNhA:278] on the node [U1yJrVrFStimvrL_QzmNhA], reason: [task has been removed, cancelling locally]\r\n[2019-12-17T14:00:16,893][DEBUG][o.e.a.a.c.n.t.c.TransportCancelTasksAction] [follow-cluster-0] Sending remove ban for tasks with the parent [U1yJrVrFStimvrL_QzmNhA:278] to the node [U1yJrVrFStimvrL_QzmNhA]\r\n[2019-12-17T14:00:16,894][DEBUG][o.e.a.a.c.n.t.c.TransportCancelTasksAction] [follow-cluster-0] Removing ban for the parent [U1yJrVrFStimvrL_QzmNhA:278] on the node [U1yJrVrFStimvrL_QzmNhA]\r\n[2019-12-17T14:00:16,901][INFO ][o.e.x.c.a.ShardFollowNodeTask] [follow-cluster-0] [forget-follower][0] shard follow task has been stopped\r\n[2019-12-17T14:00:18,338][DEBUG][o.e.a.a.c.s.r.RestoreClusterStateListener] [follow-cluster-0] restore of [_latest_/_latest_] completed\r\n[2019-12-17T14:00:18,561][INFO ][o.e.x.c.a.ShardFollowTasksExecutor] [follow-cluster-0] [allowed-index][0] Starting to track leader shard [allowed-index][0]\r\n[2019-12-17T14:00:18,621][INFO ][o.e.x.c.a.ShardFollowNodeTask] [follow-cluster-0] [allowed-index][0] following leader shard [allowed-index][0], follower global checkpoint=[-1], mapping version=[2], settings version=[0], aliases version=[0]\r\n```\r\n\r\nand here is the test output:\r\n\r\n```\r\n[2019-12-17T17:00:03,382][INFO ][o.e.x.c.FollowIndexSecurityIT] [testAutoFollowPatterns] before test\r\n[2019-12-17T17:00:04,006][INFO ][o.e.x.c.FollowIndexSecurityIT] [testAutoFollowPatterns] initializing REST clients against [http://[::1]:34393, http://127.0.0.1:36644]\r\n[2019-12-17T17:00:13,181][INFO ][o.e.x.c.FollowIndexSecurityIT] [testAutoFollowPatterns] after test\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:ccr:qa:security:follow-clusterRunner' --tests \"org.elasticsearch.xpack.ccr.FollowIndexSecurityIT.testAutoFollowPatterns\" -Dtests.seed=6624383D84900BD4 -Dtests.security.manager=true -Dtests.locale=es-PR -Dtests.timezone=Africa/Addis_Ababa -Dcompiler.java=13\r\n```\r\n\r\nTo interpret the timestamps correctly, ignore the 3 hour difference (it's because tests.timezone=Africa/Addis_Ababa, which is GMT+3) between ES output and log output.\r\n\r\nWhat the logs show is that the 10 second timeout used by the test's assertBusy is just too little for the actual cluster to complete the auto-following. Part of the reasons here is that the test cluster also runs watcher and some other stuff in the background.\r\n\r\nI think we should disable watcher and other components in this test, and also increase the assertBusy timeout.","performed_via_github_app":null}]