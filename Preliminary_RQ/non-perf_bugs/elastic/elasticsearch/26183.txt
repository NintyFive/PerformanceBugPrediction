{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26183","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26183/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26183/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26183/events","html_url":"https://github.com/elastic/elasticsearch/issues/26183","id":249916471,"node_id":"MDU6SXNzdWUyNDk5MTY0NzE=","number":26183,"title":"Reindex API parent set to null, removes routing as well","user":{"login":"saurabhjaluka","id":5307446,"node_id":"MDQ6VXNlcjUzMDc0NDY=","avatar_url":"https://avatars2.githubusercontent.com/u/5307446?v=4","gravatar_id":"","url":"https://api.github.com/users/saurabhjaluka","html_url":"https://github.com/saurabhjaluka","followers_url":"https://api.github.com/users/saurabhjaluka/followers","following_url":"https://api.github.com/users/saurabhjaluka/following{/other_user}","gists_url":"https://api.github.com/users/saurabhjaluka/gists{/gist_id}","starred_url":"https://api.github.com/users/saurabhjaluka/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saurabhjaluka/subscriptions","organizations_url":"https://api.github.com/users/saurabhjaluka/orgs","repos_url":"https://api.github.com/users/saurabhjaluka/repos","events_url":"https://api.github.com/users/saurabhjaluka/events{/privacy}","received_events_url":"https://api.github.com/users/saurabhjaluka/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."}],"state":"closed","locked":false,"assignee":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"assignees":[{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false}],"milestone":null,"comments":8,"created_at":"2017-08-14T02:06:35Z","updated_at":"2018-11-05T04:10:24Z","closed_at":"2017-08-15T15:43:53Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.5.1\r\n\r\n**Plugins installed**: none\r\n\r\n**JVM version**: 1.8\r\n\r\n**OS version**: Ubuntu\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nSourceIndex : has parent field in the documents\r\nDestinationIndex : no parent field in the documents\r\n\r\nWhen I try to use reindex api with painless script for migration data from source to destination, setting parent to null in the script. It also sets routing to null. My requirement is just to remove the parent field and keep the routing field in destination.\r\n\r\nExpected behavior: Routing should not be set to null, just parent should be set to null\r\n \r\n**Steps to reproduce**:\r\n\r\nSource index: \r\n\r\n```\r\ncurl -XPUT \"http://localhost:9200/source-index/?pretty\" -d '{\r\n  \"mappings\": {\r\n      \"post\": {\r\n         \"_parent\": { \"type\": \"parent_type\" },\r\n         \"properties\": {\r\n              \"title\": {\r\n                 \"type\" : \"keyword\"\r\n              },\r\n              \"description\": {\r\n                  \"type\" : \"keyword\"\r\n              },\r\n              \"articleId\": {\r\n                  \"type\" : \"keyword\"\r\n              },\r\n              \"engineId\":{\r\n                  \"type\": \"keyword\"\r\n              }\r\n          }\r\n      },\r\n      \"parent_type\": {\r\n           \"properties\": {\r\n             \"engineId\": {\r\n               \"type\": \"keyword\"\r\n             },\r\n             \"groupIds\":{\r\n               \"type\": \"long\"\r\n            }\r\n          }\r\n      }\r\n  }\r\n}'\r\n```\r\n\r\nDestination index: \r\n\r\n```\r\ncurl -XPUT \"http://localhost:9200/dest-index/?pretty\" -d '{\r\n  \"mappings\": {\r\n      \"post\": {\r\n         \"properties\": {\r\n              \"title\": {\r\n                 \"type\" : \"keyword\"\r\n              },\r\n              \"description\": {\r\n                  \"type\" : \"keyword\"\r\n              },\r\n              \"articleId\": {\r\n                  \"type\" : \"keyword\"\r\n              },\r\n              \"engineId\":{\r\n                  \"type\": \"keyword\"\r\n              }\r\n          }\r\n      },\r\n      \"parent_type\": {\r\n           \"properties\": {\r\n             \"engineId\": {\r\n               \"type\": \"keyword\"\r\n             },\r\n             \"groupIds\":{\r\n               \"type\": \"long\"\r\n            }\r\n          }\r\n      }\r\n  }\r\n}'\r\n```\r\n\r\nSample Document:\r\n```\r\ncurl -XPOST \"localhost:9200/source-index/post/1?routing=12345&parent=12345\" -d '{\"articleId\": \"abcd\", \"title\":\"hello 1\", \"description\":\"this is a test document\",\"engineId\":\"12345\"}'\r\n```\r\n\r\nFetch Document to verify routing and parent field:\r\n```\r\ncurl localhost:9200/source-index/_search\r\n\r\nResponse:\r\n{\r\n\t\"took\": 2,\r\n\t\"timed_out\": false,\r\n\t\"_shards\": {\r\n\t\t\"total\": 5,\r\n\t\t\"successful\": 5,\r\n\t\t\"failed\": 0\r\n\t},\r\n\t\"hits\": {\r\n\t\t\"total\": 1,\r\n\t\t\"max_score\": 1,\r\n\t\t\"hits\": [\r\n\t\t\t{\r\n\t\t\t\t\"_index\": \"source-index\",\r\n\t\t\t\t\"_type\": \"post\",\r\n\t\t\t\t\"_id\": \"1\",\r\n\t\t\t\t\"_score\": 1,\r\n\t\t\t\t\"_routing\": \"12345\",\r\n\t\t\t\t\"_parent\": \"12345\",\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"articleId\": \"abcd\",\r\n\t\t\t\t\t\"title\": \"hello 1\",\r\n\t\t\t\t\t\"description\": \"this is a test document\",\r\n\t\t\t\t\t\"engineId\": \"12345\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t]\r\n\t}\r\n}\r\n```\r\n\r\nReindex api: \r\n```\r\ncurl -XPOST 'localhost:9200/_reindex?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"source\": {\r\n    \"index\": \"source-index\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"dest-index\",\r\n    \"routing\":\"keep\"\r\n  },\r\n \"script\":{\r\n \"inline\":\"ctx._parent = null;\"\r\n }\r\n}'\r\n```\r\n\r\nVerify document at destination index:\r\n```\r\ncurl localhost:9200/dest-index/_search\r\n\r\nResponse:\r\n{\r\n\t\"took\": 0,\r\n\t\"timed_out\": false,\r\n\t\"_shards\": {\r\n\t\t\"total\": 5,\r\n\t\t\"successful\": 5,\r\n\t\t\"failed\": 0\r\n\t},\r\n\t\"hits\": {\r\n\t\t\"total\": 1,\r\n\t\t\"max_score\": 1,\r\n\t\t\"hits\": [\r\n\t\t\t{\r\n\t\t\t\t\"_index\": \"dest-index\",\r\n\t\t\t\t\"_type\": \"post\",\r\n\t\t\t\t\"_id\": \"1\",\r\n\t\t\t\t\"_score\": 1,\r\n\t\t\t\t\"_source\": {\r\n\t\t\t\t\t\"articleId\": \"abcd\",\r\n\t\t\t\t\t\"description\": \"this is a test document\",\r\n\t\t\t\t\t\"title\": \"hello 1\",\r\n\t\t\t\t\t\"engineId\": \"12345\"\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t]\r\n\t}\r\n}\r\n```\r\nParent is not present that is correct, but routing is not present as well.\r\n\r\n**Helpful information**:\r\n\r\nI debugged ES code and found out in file https://github.com/elastic/elasticsearch/blob/v5.5.1/modules/reindex/src/main/java/org/elasticsearch/index/reindex/AbstractAsyncBulkByScrollAction.java under apply function. When parent is set to newValue the function scriptChangedParent (func def : https://github.com/elastic/elasticsearch/blob/v5.5.1/modules/reindex/src/main/java/org/elasticsearch/index/reindex/TransportReindexAction.java) sets routing as well to the newValue of parent. \r\n![screenshot from 2017-08-13 18-47-30](https://user-images.githubusercontent.com/5307446/29255686-7fa36678-8058-11e7-8903-74d072d4d3bc.png)\r\n\r\n\r\nNext if call for routing, leaves routing field as it is.  As newValue = oldValue (in my case it is 12345). But routing is already set the null in the previous step.\r\n![screenshot from 2017-08-13 18-48-37](https://user-images.githubusercontent.com/5307446/29255693-915a5318-8058-11e7-84c1-6af286713378.png)\r\n\r\nLet me know if extra info is required. Also I would love to contribute to fix this.\r\n\r\n","closed_by":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"performed_via_github_app":null}