{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20114","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20114/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20114/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20114/events","html_url":"https://github.com/elastic/elasticsearch/issues/20114","id":172622242,"node_id":"MDU6SXNzdWUxNzI2MjIyNDI=","number":20114,"title":"ES 2.3.5 Node gets unstable (memory issue) if role is master","user":{"login":"theely","id":2025999,"node_id":"MDQ6VXNlcjIwMjU5OTk=","avatar_url":"https://avatars2.githubusercontent.com/u/2025999?v=4","gravatar_id":"","url":"https://api.github.com/users/theely","html_url":"https://github.com/theely","followers_url":"https://api.github.com/users/theely/followers","following_url":"https://api.github.com/users/theely/following{/other_user}","gists_url":"https://api.github.com/users/theely/gists{/gist_id}","starred_url":"https://api.github.com/users/theely/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/theely/subscriptions","organizations_url":"https://api.github.com/users/theely/orgs","repos_url":"https://api.github.com/users/theely/repos","events_url":"https://api.github.com/users/theely/events{/privacy}","received_events_url":"https://api.github.com/users/theely/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2016-08-23T06:32:01Z","updated_at":"2016-10-20T06:46:52Z","closed_at":"2016-09-02T14:42:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.5\n\n**Plugins installed**: [license,marvel-agent]\n\n**JVM version**:\nopenjdk version \"1.8.0_102\"\nOpenJDK Runtime Environment (build 1.8.0_102-8u102-b14.1-1~bpo8+1-b14)\nOpenJDK 64-Bit Server VM (build 25.102-b14, mixed mode)\n\n**OS version**: Official Docker ES Image 2.3.5\n\n**Description of the problem including expected versus actual behavior**:\n\nI am running two nodes (elastic1, elastic2) on top of Mesos and Docker. Both nodes are running the official elasticsearch docker image version 2.3.5. Both nodes have the same Docker (1.11.2) and Mesos (0.28.1) version.\nThe main difference among the node is the hardware:\nelastic1: 2 magnetic disks (RIDE 0), 64GB RAM,  AMD Opteron 6338P\nelastic2: 2 SSD disks (RIDE 0), 128GB RAM,  Intel Xeon E5-1650V2\n\nSince elastic 1 uses magnetic disks it has an additional es setting:\nindex.merge.scheduler.max_thread_count: 1\n\nThe issue is a bit complex to describe but basically when the node elastic2 acts as master it enters in a loop where it will use up all assigned memory (5GB) and than garbage collect all of it (takes about 10sec) to start over again. However if the node elastic2 is acting as slave everything runs smoothly. Attached you will find an image showing some metrics of the before and after master role assignment. The red line on the image indicates the exact time when roles are switch between the nodes.\n\n![node-usage](https://cloud.githubusercontent.com/assets/2025999/17882022/2b33bc0c-690a-11e6-8420-2590bdf94cd2.png)\n\nAlso I will attach the log file showing the before and after entries. You can see the many GC runs and the time it takes. After the restart and the role switch no more entries were logged and the cluster was stable.\n\n**Provide logs (if relevant)**:\n[2016-08-22 12:43:21,536][WARN ][monitor.jvm              ] [elastic2] [gc][old][57319][19431] duration [10.5s], collections [1]/[10.6s], total [10.5s]/[2.6d], memory [4.7gb]->[4.7gb]/[4.9gb], all_pools {[young] [605.3mb]->[592.1mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:43:35,087][WARN ][monitor.jvm              ] [elastic2] [gc][old][57320][19432] duration [13.3s], collections [1]/[13.5s], total [13.3s]/[2.6d], memory [4.7gb]->[4.7gb]/[4.9gb], all_pools {[young] [592.1mb]->[603.2mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:43:46,271][WARN ][monitor.jvm              ] [elastic2] [gc][old][57321][19433] duration [11s], collections [1]/[11.1s], total [11s]/[2.6d], memory [4.7gb]->[4.8gb]/[4.9gb], all_pools {[young] [603.2mb]->[629.5mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:43:59,236][WARN ][monitor.jvm              ] [elastic2] [gc][old][57322][19434] duration [12.8s], collections [1]/[12.9s], total [12.8s]/[2.6d], memory [4.8gb]->[4.7gb]/[4.9gb], all_pools {[young] [629.5mb]->[593.4mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:44:10,448][WARN ][monitor.jvm              ] [elastic2] [gc][old][57323][19435] duration [11s], collections [1]/[10.6s], total [11s]/[2.6d], memory [4.7gb]->[4.7gb]/[4.9gb], all_pools {[young] [593.4mb]->[653.2mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:44:23,487][WARN ][monitor.jvm              ] [elastic2] [gc][old][57324][19436] duration [12.9s], collections [1]/[13.5s], total [12.9s]/[2.6d], memory [4.7gb]->[4.8gb]/[4.9gb], all_pools {[young] [653.2mb]->[636.9mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:44:34,708][WARN ][monitor.jvm              ] [elastic2] [gc][old][57325][19437] duration [11s], collections [1]/[10.6s], total [11s]/[2.6d], memory [4.8gb]->[4.7gb]/[4.9gb], all_pools {[young] [636.9mb]->[596.3mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\n[2016-08-22 12:44:49,023][WARN ][monitor.jvm              ] [elastic2] [gc][old][57326][19438] duration [14.1s], collections [1]/[14.8s], total [14.1s]/[2.6d], memory [4.7gb]->[4.7gb]/[4.9gb], all_pools {[young] [596.3mb]->[588mb]/[665.6mb]}{[survivor] [0b]->[0b]/[83.1mb]}{[old] [4.1gb]->[4.1gb]/[4.1gb]}\nReceived killTask\nShutting down\n\n================ MASTER SWITCH ================\n\n[2016-08-22 12:44:58,478][INFO ][node                     ] [elastic2] version[2.3.5], pid[1], build[90f439f/2016-07-27T10:36:52Z]\n[2016-08-22 12:44:58,478][INFO ][node                     ] [elastic2] initializing ...\n[2016-08-22 12:44:58,825][INFO ][plugins                  ] [elastic2] modules [reindex, lang-expression, lang-groovy], plugins [license, marvel-agent], sites []\n[2016-08-22 12:44:58,842][INFO ][env                      ] [elastic2] using [1] data paths, mounts [[/usr/share/elasticsearch/data (/dev/sda3)]], net usable_space [149.3gb], net total_space [434.5gb], spins? [possibly], types [ext4]\n[2016-08-22 12:44:58,842][INFO ][env                      ] [elastic2] heap size [4.9gb], compressed ordinary object pointers [true]\n[2016-08-22 12:44:59,955][INFO ][node                     ] [elastic2] initialized\n[2016-08-22 12:44:59,955][INFO ][node                     ] [elastic2] starting ...\n[2016-08-22 12:45:00,043][INFO ][transport                ] [elastic2] publish_address {xx.xx.xx.xx:9300}, bound_addresses {[::]:9300}\n[2016-08-22 12:45:00,046][INFO ][discovery                ] [elastic2] newsriver/-JAQ76_VT3iWrWvYlre-rA\n[2016-08-22 12:45:03,103][INFO ][cluster.service          ] [elastic2] detected_master {elastic1}{8iaBxIvQQn2JM7tNFMjaYg}{xx.xx.xx.xx}{xx.xx.xx.xx:9300}{master=true}, added {{elastic1}{8iaBxIvQQn2JM7tNFMjaYg}{xx.xx.xx.xx}{xx.xx.xx.xx:9300}{master=true},}, reason: zen-disco-receive(from master [{elastic1}{8iaBxIvQQn2JM7tNFMjaYg}{xx.xx.xx.xx}{xx.xx.xx.xx:9300}{master=true}])\n[2016-08-22 12:45:03,182][INFO ][http                     ] [elastic2] publish_address {xx.xx.xx.xx:9200}, bound_addresses {[::]:9200}\n[2016-08-22 12:45:03,182][INFO ][node                     ] [elastic2] started\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}