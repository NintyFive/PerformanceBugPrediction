{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9074","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9074/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9074/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9074/events","html_url":"https://github.com/elastic/elasticsearch/issues/9074","id":52936853,"node_id":"MDU6SXNzdWU1MjkzNjg1Mw==","number":9074,"title":"Nested document wrongly indexed?","user":{"login":"Enzo90910","id":488257,"node_id":"MDQ6VXNlcjQ4ODI1Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/488257?v=4","gravatar_id":"","url":"https://api.github.com/users/Enzo90910","html_url":"https://github.com/Enzo90910","followers_url":"https://api.github.com/users/Enzo90910/followers","following_url":"https://api.github.com/users/Enzo90910/following{/other_user}","gists_url":"https://api.github.com/users/Enzo90910/gists{/gist_id}","starred_url":"https://api.github.com/users/Enzo90910/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Enzo90910/subscriptions","organizations_url":"https://api.github.com/users/Enzo90910/orgs","repos_url":"https://api.github.com/users/Enzo90910/repos","events_url":"https://api.github.com/users/Enzo90910/events{/privacy}","received_events_url":"https://api.github.com/users/Enzo90910/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-12-26T19:49:50Z","updated_at":"2014-12-29T10:55:15Z","closed_at":"2014-12-29T10:55:15Z","author_association":"NONE","active_lock_reason":null,"body":"(Tested on ES 1.3.4 and 1.4.2)\nWhen I do the following commands:\n\n// Creating index\ncurl -XPUT 'http://localhost:9200/test_index'\n\n// Creating mapping with two nested properties, customData and experiments\ncurl -XPUT 'http://localhost:9200/test_index/_mapping/test_mapping' -d '{\"test_mapping\":{\"properties\":{\"customData\":{\"type\":\"nested\",\"properties\":{\"id\":{\"type\":\"integer\",\"doc_values\":true},\"value\":{\"type\":\"string\",\"index\":\"not_analyzed\",\"doc_values\":true}}},\"experiments\":{\"type\":\"nested\",\"properties\":{\"id\":{\"type\":\"long\",\"doc_values\":true},\"variationId\":{\"type\":\"long\",\"doc_values\":true}}}}}}'\n\n// Creating document in mapping\ncurl -XPUT 'http://localhost:9200/test_index/test_mapping/test_document' -d '{\"experiments\":[{\"id\":13048,\"variationId\":83517}],\"customData\":[]}'\n\n// Querying for same document using second subproperty of experiments, everything OK\ncurl -XGET 'http://localhost:9200/test_index/_search?size=1&pretty=true' -d '{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":[{\"term\":{\"_id\":\"test_document\"}},{\"nested\":{\"path\":\"experiments\",\"filter\":{\"term\":{\"variationId\":83517}}}}]}}}}'\n\n=> ... \"hits\" : { \"total\" : 1 ...}\n\n// Querying for same document using first subproperty of experiments, DOES NOT FIND DOCUMENT\ncurl -XGET 'http://localhost:9200/test_index/_search?size=1&pretty=true' -d '{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":[{\"term\":{\"_id\":\"test_document\"}},{\"nested\":{\"path\":\"experiments\",\"filter\":{\"term\":{\"id\":13048}}}}]}}}}'\ncurl -XDELETE 'http://http://localhost:9200/test_index/'\n\n=> ... \"hits\" : { \"total\" : 0 ...}\n\nIf I do the same commands but with a mapping containing only the second nested property, everything works as expected:\ncurl -XPUT 'http://localhost:9200/test_index'\ncurl -XPUT 'http://localhost:9200/test_index/_mapping/test_mapping' -d '{\"test_mapping\":{\"properties\":{\"experiments\":{\"type\":\"nested\",\"properties\":{\"id\":{\"type\":\"long\",\"doc_values\":true},\"variationId\":{\"type\":\"long\",\"doc_values\":true}}}}}}'\ncurl -XPUT 'http://http://localhost:9200/test_index/test_mapping/test_document' -d '{\"experiments\":[{\"id\":13048,\"variationId\":83517}]}'\n\n// Querying for same document using second subproperty of experiments, everything OK\ncurl -XGET 'http://localhost:9200/test_index/_search?size=1&pretty=true' -d '{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":[{\"term\":{\"_id\":\"test_document\"}},{\"nested\":{\"path\":\"experiments\",\"filter\":{\"term\":{\"variationId\":83517}}}}]}}}}'\n=> ... \"hits\" : { \"total\" : 1 ...}\n\n// Querying for same document using first subproperty of experiments, everything OK\ncurl -XGET 'http://localhost:9200/test_index/_search?size=1&pretty=true' -d '{\"query\":{\"filtered\":{\"query\":{\"match_all\":{}},\"filter\":{\"and\":[{\"term\":{\"_id\":\"test_document\"}},{\"nested\":{\"path\":\"experiments\",\"filter\":{\"term\":{\"id\":13048}}}}]}}}}'\n\n=> ... \"hits\" : { \"total\" : 1 ...}\n\nI am becoming crazy, has anyone else seen the same problems?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}