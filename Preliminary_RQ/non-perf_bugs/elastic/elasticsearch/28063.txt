{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28063","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28063/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28063/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28063/events","html_url":"https://github.com/elastic/elasticsearch/issues/28063","id":285697095,"node_id":"MDU6SXNzdWUyODU2OTcwOTU=","number":28063,"title":"Date processor of ingest pipeline got wrong date result ","user":{"login":"morning-color","id":12083512,"node_id":"MDQ6VXNlcjEyMDgzNTEy","avatar_url":"https://avatars3.githubusercontent.com/u/12083512?v=4","gravatar_id":"","url":"https://api.github.com/users/morning-color","html_url":"https://github.com/morning-color","followers_url":"https://api.github.com/users/morning-color/followers","following_url":"https://api.github.com/users/morning-color/following{/other_user}","gists_url":"https://api.github.com/users/morning-color/gists{/gist_id}","starred_url":"https://api.github.com/users/morning-color/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/morning-color/subscriptions","organizations_url":"https://api.github.com/users/morning-color/orgs","repos_url":"https://api.github.com/users/morning-color/repos","events_url":"https://api.github.com/users/morning-color/events{/privacy}","received_events_url":"https://api.github.com/users/morning-color/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-01-03T14:08:45Z","updated_at":"2018-01-03T17:32:08Z","closed_at":"2018-01-03T17:32:08Z","author_association":"NONE","active_lock_reason":null,"body":"__Elasticsearch version (bin/elasticsearch --version):__ 5.6.4\r\n\r\n__Plugins installed:__ no\r\n\r\n__JVM version (java -version):__\r\n```\r\njava version \"1.8.0_91\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_91-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.91-b14, mixed mode)\r\n```\r\n__OS version (uname -a if on a Unix-like system):__\r\n`Linux TENCENT64.site 3.10.106-1-tlinux2-0044 #1 SMP Mon Jul 17 15:20:12 CST 2017 x86_64 x86_64 x86_64 GNU/Linux`\r\n__Description of the problem including expected versus actual behavior:__\r\n\r\nI have some mongoDB logs, timestamp in the logs doesn't have year, only has week, month, day and time, just like the following line: \r\n```\r\n\"Sun Dec 31 23:59:59.626 I COMMAND  [conn78131] command trace.scan command: count { count: \\\"scan\\\", query: { qid: { $ne: 5 } }, readConcern: {} } planSummary: COLLSCAN keyUpdates:0 writeConflicts:0 numYields:1912 reslen:62 locks:{ Global: { acquireCount: { r: 3826 } }, Database: { acquireCount: { r: 1913 } }, Collection: { acquireCount: { r: 1913 } } } protocol:op_query 144ms\"\r\n```\r\nMy ingest pipeline: \r\n```\r\nGET _ingest/pipeline/mongo_slowquery_pattern\r\n\r\n\"mongo_slowquery_pattern\": {\r\n    \"description\": \"\",\r\n    \"processors\": [\r\n      {\r\n        \"gsub\": {\r\n          \"field\": \"message\",\r\n          \"pattern\": \"\\n\",\r\n          \"replacement\": \"    \"\r\n        }\r\n      },\r\n      {\r\n        \"grok\": {\r\n          \"field\": \"message\",\r\n          \"patterns\": [\r\n            \"(?<time>[a-zA-Z]{3} [a-zA-Z]{3} .* [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3}) %{MONGO3_SEVERITY} %{MONGO3_COMPONENT}%{SPACE}\\\\[%{DATA}\\\\]%{GREEDYDATA:overmax}? %{WORD:reqtype} %{MONGO_WORDDASH:db}\\\\.%{DATA:collection} %{DATA}: %{DATA:mongoreq} locks:%{DATA:locks} %{INT:cost:int}ms\"\r\n          ],\r\n          \"on_failure\": [\r\n            {\r\n              \"grok\": {\r\n                \"field\": \"message\",\r\n                \"patterns\": [\r\n                  \"(?<time>[a-zA-Z]{3} [a-zA-Z]{3} .* [0-9]{2}:[0-9]{2}:[0-9]{2}.[0-9]{3}) %{MONGO3_SEVERITY} %{MONGO3_COMPONENT}%{SPACE}\\\\[%{DATA}\\\\]%{GREEDYDATA:overmax}? %{WORD:reqtype} %{MONGO_WORDDASH:db}\\\\.%{DATA:collection} %{DATA:mongoreq} locks:%{DATA:locks} %{INT:cost:int}ms\"\r\n                ]\r\n              }\r\n            }\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"date\": {\r\n          \"field\": \"time\",\r\n          \"target_field\": \"time\",\r\n          \"formats\": [\r\n            \"EEE MMM dd HH:mm:ss.SSS\",\r\n            \"EEE MMM  d HH:mm:ss.SSS\"\r\n          ],\r\n          \"timezone\": \"Asia/Shanghai\"\r\n        }\r\n      }\r\n    ],\r\n    \"on_failure\": [\r\n      {\r\n        \"set\": {\r\n          \"field\": \"time\",\r\n          \"value\": \"{{_ingest.timestamp}}\"\r\n        }\r\n      },\r\n      {\r\n        \"set\": {\r\n          \"field\": \"_type\",\r\n          \"value\": \"failed\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n```\r\nWhen I index the log to es using that pipeline， I got a wrong date:\r\n\r\nMy index command：\r\n```\r\nPUT test-index/test-type/test-id?pipeline=mongo_slowquery_pattern\r\n{\r\n   \"message\": \"Mon Jan  1 23:59:59.900 I COMMAND  [conn9784] command 59346d400236ab95e95193f35f3df6a4.vehicles command: aggregate { aggregate: \\\"vehicles\\\", pipeline: [ { $lookup: { from: \\\"_iotdevices\\\", localField: \\\"did\\\", foreignField: \\\"did\\\", as: \\\"device\\\" } }, { $match: { uid: \\\"939056007055806500\\\", device.activeGpsData.rcvTime: { $exists: true, $gte: new Date(1514821798142) }, device.activeGpsData.alerts: { $exists: true, $ne: [] } } }, { $project: { objectId: 1, _id: 0 } }, { $sort: { objectId: 1 } }, { $skip: 0 } ] } keyUpdates:0 writeConflicts:0 numYields:20 reslen:105 locks:{ Global: { acquireCount: { r: 5172 }, acquireWaitCount: { r: 46 }, timeAcquiringMicros: { r: 65335 } }, Database: { acquireCount: { r: 2586 } }, Collection: { acquireCount: { r: 2586 } } } protocol:op_command 394ms\"\r\n}\r\n```\r\nAnd the doc I got:\r\n\r\n```\r\n {\r\n        \"_index\": \"test-index\",\r\n        \"_type\": \"test-type\",\r\n        \"_id\": \"test-id\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"mongoreq\": \"count { count: \\\"scan\\\", query: { qid: { $ne: 5 } }, readConcern: {} } planSummary: COLLSCAN keyUpdates:0 writeConflicts:0 numYields:1912 reslen:62\",\r\n          \"cost\": 144,\r\n          \"overmax\": \"\",\r\n          \"reqtype\": \"command\",\r\n          \"time\": \"2019-01-06T23:59:59.626+08:00\",\r\n          \"collection\": \"scan\",\r\n          \"message\": \"Sun Dec 31 23:59:59.626 I COMMAND  [conn78131] command trace.scan command: count { count: \\\"scan\\\", query: { qid: { $ne: 5 } }, readConcern: {} } planSummary: COLLSCAN keyUpdates:0 writeConflicts:0 numYields:1912 reslen:62 locks:{ Global: { acquireCount: { r: 3826 } }, Database: { acquireCount: { r: 1913 } }, Collection: { acquireCount: { r: 1913 } } } protocol:op_query 144ms\",\r\n          \"locks\": \"{ Global: { acquireCount: { r: 3826 } }, Database: { acquireCount: { r: 1913 } }, Collection: { acquireCount: { r: 1913 } } } protocol:op_query\",\r\n          \"db\": \"trace\"\r\n        }\r\n      }\r\n```\r\nThe time becomes `2019-01-06T23:59:59.626+08:00`, but actually it is  `Sun Dec 31 23:59:59.626` . \r\nI thought it was because the mongoDB log doesn't have year information，so the year in time field may be wrong. But  i think it shouldn't give me a wrong day and month.\r\nHope for your reply, thanks !\r\n\r\n","closed_by":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"performed_via_github_app":null}