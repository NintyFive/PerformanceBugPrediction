{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3856","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3856/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3856/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3856/events","html_url":"https://github.com/elastic/elasticsearch/issues/3856","id":20724849,"node_id":"MDU6SXNzdWUyMDcyNDg0OQ==","number":3856,"title":"Many percolators kills server with java.lang.OutOfMemoryError: Java heap space","user":{"login":"ksaveras","id":485111,"node_id":"MDQ6VXNlcjQ4NTExMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/485111?v=4","gravatar_id":"","url":"https://api.github.com/users/ksaveras","html_url":"https://github.com/ksaveras","followers_url":"https://api.github.com/users/ksaveras/followers","following_url":"https://api.github.com/users/ksaveras/following{/other_user}","gists_url":"https://api.github.com/users/ksaveras/gists{/gist_id}","starred_url":"https://api.github.com/users/ksaveras/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ksaveras/subscriptions","organizations_url":"https://api.github.com/users/ksaveras/orgs","repos_url":"https://api.github.com/users/ksaveras/repos","events_url":"https://api.github.com/users/ksaveras/events{/privacy}","received_events_url":"https://api.github.com/users/ksaveras/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2013-10-09T06:39:44Z","updated_at":"2014-08-08T17:53:30Z","closed_at":"2014-08-08T17:53:30Z","author_association":"NONE","active_lock_reason":null,"body":"ES version 0.90.5\nJava version: 1.7.0_40\nLinux CentOS 64bit (2.6.32-358.14.1.el6.x86_64)\nDefault config with some changes:\n\n```\nindex.number_of_shards: 1\nindex.number_of_replicas: 0\nbootstrap.mlockall: true\n```\n\n```\n# testing environment set memory to 512MB\nES_HEAP_SIZE=512m\n```\n\nI wanted to test how many percolator documents can handle one ElasticSearch (ES) instance and how fast it works. First idea is to create 15000 percolator documents.\nTried 1GB HEAP size, then 2GB heap size but did not succeeded (on Windows). So moved to linux box. There is no much memory. enabled mlockall (BTW if it's enabled or disabled - same result), defined to create only one shard without replicas.\n\nCreated script that generates percolator and puts one by one to ES. Query is simple:\n\n```\n{\n  \"query\":{\n    \"bool\":{\n      \"should\":[\n        {\"match\":{\"headline\":\"3BPV i3ZBGQgK mc72 5EhW\"}},\n        {\"match\":{\"bodytext\":\"NGgfMl XOIb nEgbLoXQ eL1g ItP DvE OE7eMj OJawh3\"}},\n        {\"wildcard\":{\"bodytext\":\"0vRa* Cf* 47b* hz735* cQJXyo* qMyL*\"}}\n      ]\n    }\n  }\n}\n```\n\nevery time text is random strings with different length but number of words is same.\nI create index\n\n```\ncurl -XPOST http://192.168.1.144:9200/demo\n```\n\nand then iterate 15000 times generating percolators and add one by one to ES. \n\n```\ncurl -XPUT http://192.168.1.144:9200/_percolator/demo/[name] -d '{\n  \"query\":{\n    \"bool\":{\n      \"should\":[\n        {\"match\":{\"headline\":\"3BPV i3ZBGQgK mc72 5EhW\"}},\n        {\"match\":{\"bodytext\":\"NGgfMl XOIb nEgbLoXQ eL1g ItP DvE OE7eMj OJawh3\"}},\n        {\"wildcard\":{\"bodytext\":\"0vRa* Cf* 47b* hz735* cQJXyo* qMyL*\"}}\n      ]\n    }\n  }\n}'\n```\n\nAfter ~2000 documents HEAP memory becomes full and ES becomes nonfunctional.\n\nIf i do not create index and add percolator documents then HEAP memory usage is low. I can create 15000 percolator documents easy and fast. After creating all percolator documents I create index - then HEAP memory fills up quickly and bye bye ES - nonfunctional again.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}