[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/650129773","html_url":"https://github.com/elastic/elasticsearch/issues/58589#issuecomment-650129773","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58589","id":650129773,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MDEyOTc3Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-06-26T11:27:33Z","updated_at":"2020-06-26T11:27:33Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/650130113","html_url":"https://github.com/elastic/elasticsearch/issues/58589#issuecomment-650130113","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58589","id":650130113,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MDEzMDExMw==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-06-26T11:28:35Z","updated_at":"2020-06-26T11:28:35Z","author_association":"CONTRIBUTOR","body":"Here is the config of the job in question:\r\n```\r\n{\r\n  \"job_id\": \"art_daily_flatmiddle_1592964952_790_2715\",\r\n  \"job_type\": \"anomaly_detector\",\r\n  \"job_version\": \"7.9.0\",\r\n  \"groups\": [\r\n    \"f-metric\",\r\n    \"numenta\",\r\n    \"periodic\"\r\n  ],\r\n  \"description\": \"Numenta artificialWithAnomaly metric(value) 5m renormalization=0\",\r\n  \"create_time\": 1592979353139,\r\n  \"finished_time\": 1592979374710,\r\n  \"analysis_config\": {\r\n    \"bucket_span\": \"5m\",\r\n    \"detectors\": [\r\n      {\r\n        \"detector_description\": \"metric(value)\",\r\n        \"function\": \"metric\",\r\n        \"field_name\": \"value\",\r\n        \"detector_index\": 0\r\n      }\r\n    ],\r\n    \"influencers\": []\r\n  },\r\n  \"analysis_limits\": {\r\n    \"model_memory_limit\": \"10mb\",\r\n    \"categorization_examples_limit\": 4\r\n  },\r\n  \"data_description\": {\r\n    \"format\": \"delimited\",\r\n    \"time_field\": \"timestamp\",\r\n    \"time_format\": \"yyyy-MM-dd HH:mm:ss\",\r\n    \"field_delimiter\": \",\",\r\n    \"quote_character\": \"\\\"\"\r\n  },\r\n  \"model_plot_config\": {\r\n    \"enabled\": true,\r\n    \"annotations_enabled\": true\r\n  },\r\n  \"renormalization_window_days\": 0,\r\n  \"model_snapshot_retention_days\": 10,\r\n  \"daily_model_snapshot_retention_after_days\": 1,\r\n  \"model_snapshot_id\": \"1592979374\",\r\n  \"results_index_name\": \"shared\",\r\n  \"allow_lazy_open\": false,\r\n  \"data_counts\": {\r\n    \"job_id\": \"art_daily_flatmiddle_1592964952_790_2715\",\r\n    \"processed_record_count\": 4032,\r\n    \"processed_field_count\": 4032,\r\n    \"input_bytes\": 217854,\r\n    \"input_field_count\": 4032,\r\n    \"invalid_date_count\": 0,\r\n    \"missing_field_count\": 0,\r\n    \"out_of_order_timestamp_count\": 0,\r\n    \"empty_bucket_count\": 0,\r\n    \"sparse_bucket_count\": 0,\r\n    \"bucket_count\": 4031,\r\n    \"earliest_record_timestamp\": 1396310400000,\r\n    \"latest_record_timestamp\": 1397519700000,\r\n    \"last_data_time\": 1592979365665,\r\n    \"input_record_count\": 4032,\r\n    \"latest_bucket_timestamp\": 1397519700000\r\n  },\r\n  \"model_size_stats\": {\r\n    \"job_id\": \"art_daily_flatmiddle_1592964952_790_2715\",\r\n    \"result_type\": \"model_size_stats\",\r\n    \"model_bytes\": 116000,\r\n    \"model_bytes_exceeded\": 0,\r\n    \"model_bytes_memory_limit\": 10485760,\r\n    \"total_by_field_count\": 3,\r\n    \"total_over_field_count\": 0,\r\n    \"total_partition_field_count\": 2,\r\n    \"bucket_allocation_failures_count\": 0,\r\n    \"memory_status\": \"ok\",\r\n    \"categorized_doc_count\": 0,\r\n    \"total_category_count\": 0,\r\n    \"frequent_category_count\": 0,\r\n    \"rare_category_count\": 0,\r\n    \"dead_category_count\": 0,\r\n    \"failed_category_count\": 0,\r\n    \"categorization_status\": \"ok\",\r\n    \"log_time\": 1592979374446,\r\n    \"timestamp\": 1397519400000\r\n  },\r\n  \"forecasts_stats\": {\r\n    \"total\": 0,\r\n    \"forecasted_jobs\": 0\r\n  },\r\n  \"state\": \"closed\",\r\n  \"timing_stats\": {\r\n    \"job_id\": \"art_daily_flatmiddle_1592964952_790_2715\",\r\n    \"bucket_count\": 4032,\r\n    \"total_bucket_processing_time_ms\": 8388.000000000007,\r\n    \"minimum_bucket_processing_time_ms\": 0,\r\n    \"maximum_bucket_processing_time_ms\": 72,\r\n    \"average_bucket_processing_time_ms\": 2.0803571428571446,\r\n    \"exponential_average_bucket_processing_time_ms\": 2.74483668012071,\r\n    \"exponential_average_bucket_processing_time_per_hour_ms\": 27.71019538378873\r\n  },\r\n  \"datafeed_config\": {\r\n    \"datafeed_id\": \"datafeed-art_daily_flatmiddle_1592964952_790_2715\",\r\n    \"job_id\": \"art_daily_flatmiddle_1592964952_790_2715\",\r\n    \"query_delay\": \"76549ms\",\r\n    \"indices\": [\r\n      \"art_daily_flatmiddle\"\r\n    ],\r\n    \"query\": {\r\n      \"match_all\": {}\r\n    },\r\n    \"scroll_size\": 1000,\r\n    \"chunking_config\": {\r\n      \"mode\": \"auto\"\r\n    },\r\n    \"delayed_data_check_config\": {\r\n      \"enabled\": true\r\n    },\r\n    \"indices_options\": {\r\n      \"expand_wildcards\": [\r\n        \"open\"\r\n      ],\r\n      \"ignore_unavailable\": false,\r\n      \"allow_no_indices\": true,\r\n      \"ignore_throttled\": true\r\n    },\r\n    \"state\": \"stopped\",\r\n    \"timing_stats\": {\r\n      \"job_id\": \"art_daily_flatmiddle_1592964952_790_2715\",\r\n      \"search_count\": 9,\r\n      \"bucket_count\": 4031,\r\n      \"total_search_time_ms\": 41,\r\n      \"average_search_time_per_bucket_ms\": 0.010171173406102704,\r\n      \"exponential_average_search_time_per_hour_ms\": 5.166002823361236\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nIndeed, no partition/by/over fields are configured and there is only 1 detector so there must be another source of duplicates.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/653006429","html_url":"https://github.com/elastic/elasticsearch/issues/58589#issuecomment-653006429","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/58589","id":653006429,"node_id":"MDEyOklzc3VlQ29tbWVudDY1MzAwNjQyOQ==","user":{"login":"przemekwitek","id":19312454,"node_id":"MDQ6VXNlcjE5MzEyNDU0","avatar_url":"https://avatars3.githubusercontent.com/u/19312454?v=4","gravatar_id":"","url":"https://api.github.com/users/przemekwitek","html_url":"https://github.com/przemekwitek","followers_url":"https://api.github.com/users/przemekwitek/followers","following_url":"https://api.github.com/users/przemekwitek/following{/other_user}","gists_url":"https://api.github.com/users/przemekwitek/gists{/gist_id}","starred_url":"https://api.github.com/users/przemekwitek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/przemekwitek/subscriptions","organizations_url":"https://api.github.com/users/przemekwitek/orgs","repos_url":"https://api.github.com/users/przemekwitek/repos","events_url":"https://api.github.com/users/przemekwitek/events{/privacy}","received_events_url":"https://api.github.com/users/przemekwitek/received_events","type":"User","site_admin":false},"created_at":"2020-07-02T13:29:48Z","updated_at":"2020-07-02T13:29:48Z","author_association":"CONTRIBUTOR","body":"I was able to reproduce this using synthetic data.\r\nPasting the script that generates sine wave with bigger amplitude during weekdays and smaller amplitude during weekends:\r\n```\r\n  1 from datetime import date, datetime\r\n  2 from math import pi, sin\r\n  3 import sys\r\n  4 import time\r\n  5 from random import random\r\n  6 from elasticsearch import Elasticsearch\r\n  7 \r\n  8 \r\n  9 def main(argv):\r\n 10   if len(argv) < 1:\r\n 11     print \"\"\"Usage:\r\n 12 python generate_duplicate_annotations.py <INDEX>\r\n 13 \"\"\"\r\n 14     exit(1)\r\n 15 \r\n 16   es = Elasticsearch(['localhost'], port=9200, http_auth=('elastic', 'password'))\r\n 17   index = argv[0]\r\n 18 \r\n 19   start_date = datetime(2020, 2, 3)  # It is a Monday\r\n 20   start_timestamp = long(time.mktime(start_date.timetuple())) * 1000\r\n 21   \r\n 22   n = 365 * 24  # number of buckets\r\n 23   for i in xrange(n):\r\n 24     timestamp = start_timestamp + i * 60 * 60 * 1000\r\n 25     a = 10\r\n 26     if ((i / 24) % 7) in (5, 6):\r\n 27       a = 2\r\n 28     y = a * sin(2 * pi * i / 24.0)\r\n 29     es.index(index=index, id=i, body={'timestamp': timestamp, 'y': y})\r\n 30     \r\n 31 if __name__ == \"__main__\":\r\n 32    main(sys.argv[1:])\r\n```\r\n\r\nAnd here are the annotations with the added description (local change):\r\n```\r\nGET .ml-annotations*/_search | jq\r\n```\r\n```\r\n{\r\n  \"took\": 1,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": {\r\n      \"value\": 7,\r\n      \"relation\": \"eq\"\r\n    },\r\n    \"max_score\": 1,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"momzD3MB7_gcmuQ3e0-T\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected trend\",\r\n          \"create_time\": 1593696287535,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1580742000000,\r\n          \"end_timestamp\": 1580742000000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696287535,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"oYmzD3MB7_gcmuQ3fE9r\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected periodicity with period 1d (daily)\",\r\n          \"create_time\": 1593696287819,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1580954400000,\r\n          \"end_timestamp\": 1580954400000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696287819,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"qImzD3MB7_gcmuQ3fU-C\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected linear scale by 0.216273\",\r\n          \"create_time\": 1593696288105,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1581224400000,\r\n          \"end_timestamp\": 1581224400000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696288105,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"romzD3MB7_gcmuQ3gE9D\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected periodicity with period 1d (weekend daily)\",\r\n          \"create_time\": 1593696288828,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1584324000000,\r\n          \"end_timestamp\": 1584324000000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696288828,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"r4mzD3MB7_gcmuQ3gE9D\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected periodicity with period 1d (weekday daily)\",\r\n          \"create_time\": 1593696288828,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1584324000000,\r\n          \"end_timestamp\": 1584324000000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696288828,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"sImzD3MB7_gcmuQ3gE9D\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected periodicity with period 7d (weekend weekly)\",\r\n          \"create_time\": 1593696288828,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1584324000000,\r\n          \"end_timestamp\": 1584324000000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696288828,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \".ml-annotations-6\",\r\n        \"_id\": \"sYmzD3MB7_gcmuQ3gE9D\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"annotation\": \"Detected periodicity with period 7d (weekday weekly)\",\r\n          \"create_time\": 1593696288828,\r\n          \"create_username\": \"_xpack\",\r\n          \"timestamp\": 1584324000000,\r\n          \"end_timestamp\": 1584324000000,\r\n          \"job_id\": \"duplicate-annotations-job\",\r\n          \"modified_time\": 1593696288828,\r\n          \"modified_username\": \"_xpack\",\r\n          \"type\": \"annotation\",\r\n          \"event\": \"model_change\",\r\n          \"detector_index\": 0\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","performed_via_github_app":null}]