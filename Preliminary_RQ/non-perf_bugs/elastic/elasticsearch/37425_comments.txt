[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454124932","html_url":"https://github.com/elastic/elasticsearch/issues/37425#issuecomment-454124932","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37425","id":454124932,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDEyNDkzMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-14T19:11:50Z","updated_at":"2019-01-14T19:11:50Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-analytics-geo","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454133268","html_url":"https://github.com/elastic/elasticsearch/issues/37425#issuecomment-454133268","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37425","id":454133268,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDEzMzI2OA==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-01-14T19:36:13Z","updated_at":"2019-01-14T19:36:13Z","author_association":"MEMBER","body":"I suspect what you're seeing is just the approximate nature of the `top-n` algorithm used by the terms aggregation.  Essentially, each shard sends back its best `n` results, and then all the shard's best `n` are merged.  But due to the sharded nature a term may not make the top `n` of a particular shard (even though globally it should).  This can lead to approximate doc_counts, and by extension, approximate ordering by sub-aggs (since you need all the documents present for a sub-agg to be accurate as well).\r\n\r\nThe docs cover this situation here: https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-approximate-counts\r\n\r\nAs you saw, increasing the size of the request usually \"fixes\" the issue, because the `top-n` expands and more results are pulled from each shard.\r\n\r\nWe have a [`shard_size` parameter](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#_shard_size_3) which you can configure to achieve the same thing, without increasing the size of the final `top-n` result set.  E.g. you can set `shard_size: 200` to retrieve 200 results from each shard, but keep `size: 20` so that the final result set is still 20 long.\r\n\r\nWould you mind configuring a `shard_size` and retrying your tests?  I believe that will fix the issue you are seeing, and make the results more deterministic.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454308179","html_url":"https://github.com/elastic/elasticsearch/issues/37425#issuecomment-454308179","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37425","id":454308179,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDMwODE3OQ==","user":{"login":"physicalattraction","id":7287514,"node_id":"MDQ6VXNlcjcyODc1MTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/7287514?v=4","gravatar_id":"","url":"https://api.github.com/users/physicalattraction","html_url":"https://github.com/physicalattraction","followers_url":"https://api.github.com/users/physicalattraction/followers","following_url":"https://api.github.com/users/physicalattraction/following{/other_user}","gists_url":"https://api.github.com/users/physicalattraction/gists{/gist_id}","starred_url":"https://api.github.com/users/physicalattraction/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/physicalattraction/subscriptions","organizations_url":"https://api.github.com/users/physicalattraction/orgs","repos_url":"https://api.github.com/users/physicalattraction/repos","events_url":"https://api.github.com/users/physicalattraction/events{/privacy}","received_events_url":"https://api.github.com/users/physicalattraction/received_events","type":"User","site_admin":false},"created_at":"2019-01-15T08:35:08Z","updated_at":"2019-01-15T08:35:08Z","author_association":"NONE","body":"@polyfractal: Thanks for your clear reply. Indeed increasing the `shard_size` parameter from 20 to 200 gives me a more accurate result. I was not aware of this limitation, it is present but a bit hidden in the documentation.\r\n\r\nSo it is not a bug after all, just for me unexpected behavior. I think it is more fair to future users if the limitations of ElasticSearch are clearly communicated in any feature page like the README of this repository. People need to make a decision which database to choose based on this kind of information. They do not, and in fact cannot read the entire documentation to make a well-informed decision.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454385532","html_url":"https://github.com/elastic/elasticsearch/issues/37425#issuecomment-454385532","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37425","id":454385532,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDM4NTUzMg==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2019-01-15T13:06:00Z","updated_at":"2019-01-15T13:06:00Z","author_association":"MEMBER","body":"Great, glad that solved your issue @physicalattraction!  Gonna close this issue :)\r\n\r\n > So it is not a bug after all, just for me unexpected behavior. I think it is more fair to future users if the limitations of ElasticSearch are clearly communicated in any feature page like the README of this repository. People need to make a decision which database to choose based on this kind of information. They do not, and in fact cannot read the entire documentation to make a well-informed decision.\r\n\r\nI understand this sentiment, but you have to think about it from the perspective of maintaining a large project.  We have a wide array of features, and due to the distributed nature of Elasticsearch, many of the features have specific implementation details and limitations.  That's just part of the territory for any kind of clustered software, certain tradeoffs have to be made (often it's \"pick two of: `[fast, accurate, big]`\").  \r\n\r\nIt would be impractical to list all the caveats and limitations in the project's README.  The list would be unwieldy and difficult for a user to navigate, and confusing since new users wouldn't understand what any of the features are... or how to interpret the limitations.\r\n\r\nInstead, we try to extensively document the limitations on each feature.  The `terms` agg spends the first third of the documentation discussing the [approximate count issue](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-approximate-counts).  Similarly, the [Cardinality agg](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-cardinality-aggregation.html#_counts_are_approximate) and [Percentiles agg](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-percentile-aggregation.html#search-aggregations-metrics-percentile-aggregation-approximation) have a lot written about their particular algorithms and the tradeoffs that are incurred.    This pattern is used across the APIs/features in ES docs.\r\n\r\nThe hope is that a user finds the feature they need, reads about how to use it in the documentation and then continues to read about the limitations.  We're not trying to hide anything (I think we're very open about limitations!), it's just that at the size of our API, it's the only practical way to organize the information.\r\n\r\nThanks for understanding!  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/454389552","html_url":"https://github.com/elastic/elasticsearch/issues/37425#issuecomment-454389552","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37425","id":454389552,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NDM4OTU1Mg==","user":{"login":"physicalattraction","id":7287514,"node_id":"MDQ6VXNlcjcyODc1MTQ=","avatar_url":"https://avatars2.githubusercontent.com/u/7287514?v=4","gravatar_id":"","url":"https://api.github.com/users/physicalattraction","html_url":"https://github.com/physicalattraction","followers_url":"https://api.github.com/users/physicalattraction/followers","following_url":"https://api.github.com/users/physicalattraction/following{/other_user}","gists_url":"https://api.github.com/users/physicalattraction/gists{/gist_id}","starred_url":"https://api.github.com/users/physicalattraction/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/physicalattraction/subscriptions","organizations_url":"https://api.github.com/users/physicalattraction/orgs","repos_url":"https://api.github.com/users/physicalattraction/repos","events_url":"https://api.github.com/users/physicalattraction/events{/privacy}","received_events_url":"https://api.github.com/users/physicalattraction/received_events","type":"User","site_admin":false},"created_at":"2019-01-15T13:20:51Z","updated_at":"2019-01-15T13:20:51Z","author_association":"NONE","body":"Thanks for the clarification. :-)","performed_via_github_app":null}]