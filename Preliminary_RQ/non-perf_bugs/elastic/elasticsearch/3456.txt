{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3456","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3456/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3456/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3456/events","html_url":"https://github.com/elastic/elasticsearch/issues/3456","id":17747763,"node_id":"MDU6SXNzdWUxNzc0Nzc2Mw==","number":3456,"title":"Add support for left joining nested queries and filters","user":{"login":"btiernay","id":2717578,"node_id":"MDQ6VXNlcjI3MTc1Nzg=","avatar_url":"https://avatars3.githubusercontent.com/u/2717578?v=4","gravatar_id":"","url":"https://api.github.com/users/btiernay","html_url":"https://github.com/btiernay","followers_url":"https://api.github.com/users/btiernay/followers","following_url":"https://api.github.com/users/btiernay/following{/other_user}","gists_url":"https://api.github.com/users/btiernay/gists{/gist_id}","starred_url":"https://api.github.com/users/btiernay/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/btiernay/subscriptions","organizations_url":"https://api.github.com/users/btiernay/orgs","repos_url":"https://api.github.com/users/btiernay/repos","events_url":"https://api.github.com/users/btiernay/events{/privacy}","received_events_url":"https://api.github.com/users/btiernay/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2013-08-07T13:28:53Z","updated_at":"2014-08-08T12:12:05Z","closed_at":"2014-08-08T12:12:05Z","author_association":"NONE","active_lock_reason":null,"body":"## Context\n\nAssume you have a set of documents for which you have defined a [nested mapping](http://www.elasticsearch.org/guide/reference/mapping/nested-type/). Also assume that some documents have nested documents and some do not:\n\n**Document 1**\n\n``` json\n{\n  \"id\":1,\n  \"nested\":[\n    {\n      \"x\":1\n    }\n  ]\n}\n```\n\n**Document 2**\n\n``` json\n{\n  \"id\":2,\n  \"nested\":[\n    {\n      \"x\":2\n    }\n  ]\n}\n```\n\n**Document 3**\n\n``` json\n{\n  \"id\":3\n}\n```\n## Problem\n\nThere is currently no way to perform the equivalent of the following SQL query:\n\n``` sql\nSELECT\n    r.id,\n    COUNT(*)\nFROM\n    root r\n    LEFT JOIN\n    nested n\n        ON parent(n) = r\nWHERE\n    n.x = 1 /* nested condition */\nGROUP BY\n    r.id\n```\n\nSomething that comes very close using ElasticSearch's query DSL is:\n\n``` bash\ncurl -XGET http://localhost:9200/index/root/_search -d'\n{\n   \"fields\":[ \"id\" ],\n   \"query\":{\n       \"nested\":{\n          \"query\":{\n              \"constant_score\":{\n                 \"query\":{\n                    \"term\":{\"x\":1}\n                 }\n              },\n              \"boost\":1.0\n           }\n        },\n        \"path\":\"nested\",\n        \"score_mode\":\"total\"\n      }\n   }\n}'\n```\n\nHowever, since the semantics of [nested queries](http://www.elasticsearch.org/guide/reference/query-dsl/nested-query/) and [nested filters](http://www.elasticsearch.org/guide/reference/query-dsl/nested-filter/) require a document to have [at least one nested document](https://groups.google.com/forum/m/#!topic/elasticsearch/Jlk7RgkhBG0), **Document 3** would be filtered out here (i.e. \"inner-join\" semantics). \n## Application\n\nTo note above is the condition on the nested documents. Although simple in this example, one can easily imagine situations where score based aggregations based on multiple dynamic conditions can not be precomputed in advance due to a combinatorial explosion.\n\nThe main value in the above query is that it includes results that have a score value of \"0\" and preserves a global document score sort and thus can not be computed using [facets](http://www.elasticsearch.org/guide/reference/java-api/facets/) or the forthcoming [Aggregation Module](https://github.com/elasticsearch/elasticsearch/issues/3300).\n## Resources\n- https://github.com/elasticsearch/elasticsearch/issues/3056\n- https://groups.google.com/forum/m/#!topic/elasticsearch/cZhIcZ7rxsY\n- https://groups.google.com/forum/m/#!topic/elasticsearch/Jlk7RgkhBG0\n- http://stackoverflow.com/questions/18199135/is-it-possible-to-left-join-nested-documents-in-elasticsearch-queries\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}