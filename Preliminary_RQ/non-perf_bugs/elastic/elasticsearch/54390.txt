{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/54390","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54390/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54390/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/54390/events","html_url":"https://github.com/elastic/elasticsearch/issues/54390","id":589879477,"node_id":"MDU6SXNzdWU1ODk4Nzk0Nzc=","number":54390,"title":"Undercounting of doc_counts in Terms agg V.S. scripted terms agg","user":{"login":"yao-ding","id":47505396,"node_id":"MDQ6VXNlcjQ3NTA1Mzk2","avatar_url":"https://avatars1.githubusercontent.com/u/47505396?v=4","gravatar_id":"","url":"https://api.github.com/users/yao-ding","html_url":"https://github.com/yao-ding","followers_url":"https://api.github.com/users/yao-ding/followers","following_url":"https://api.github.com/users/yao-ding/following{/other_user}","gists_url":"https://api.github.com/users/yao-ding/gists{/gist_id}","starred_url":"https://api.github.com/users/yao-ding/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yao-ding/subscriptions","organizations_url":"https://api.github.com/users/yao-ding/orgs","repos_url":"https://api.github.com/users/yao-ding/repos","events_url":"https://api.github.com/users/yao-ding/events{/privacy}","received_events_url":"https://api.github.com/users/yao-ding/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2020-03-29T20:33:56Z","updated_at":"2020-03-30T11:34:39Z","closed_at":"2020-03-30T11:34:39Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: \r\n-- elastic.io 6.8.3 (version build date: 2019-08-29T19:05:24.312154Z)\r\n\r\nDescription of the problem including expected versus actual behavior:\r\n\r\nI was experimenting a scripted terms agg that converts a field to String, because we have all data types at different times of the project (I know it's crazy but have to deal with it now).\r\n\r\nThen I noticed a mismatch in bucket \"doc_count\" between:\r\n1. straightforward terms agg\r\n1. scripted terms agg where the script returns [any value].toString() -- which I suppose does the same thing as 1.\r\n\r\nSample code below:\r\n```\r\nGET gpii-*/_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"range\": {\r\n            \"json.timestamp\": {\r\n              \"gte\": \"2020-01-01\",\r\n              \"lte\": \"2020-02-29\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"json.event.keyword\": {\r\n              \"value\": \"setting-changed\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"term\": {\r\n            \"json.data.path.keyword\": {\r\n              \"value\": \"\"\"http://registry\\.gpii\\.net/common/selfVoicing/enabled\"\"\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"exists\": {\r\n            \"field\": \"json.data.value\"\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"by_term\": {\r\n      \"terms\": {\r\n        \"field\": \"json.data.value.keyword\",\r\n        \"size\": 10000\r\n      }\r\n    },\r\n    \"by_string\": {\r\n      \"terms\": {\r\n        \"script\": \"\"\"\r\n              return params._source.json.data.value?.toString() ?: \"\";\r\n              \"\"\",\r\n        \"size\": 10000\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nHowever, the doc_counts in (1) \"by_term\" are always incorrect and doc_counts in (2) \"by_string\" are always correct.  \r\n\r\nSample results are as follows:\r\n```\r\n{\r\n  \"took\" : 4221,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 2735,\r\n    \"successful\" : 2735,\r\n    \"skipped\" : 2401,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 22,\r\n    \"max_score\" : 0.0,\r\n    \"hits\" : [ ]\r\n  },\r\n  \"aggregations\" : {\r\n    \"by_term\" : {\r\n      \"doc_count_error_upper_bound\" : 0,\r\n      \"sum_other_doc_count\" : 0,\r\n      \"buckets\" : [\r\n        {\r\n          \"key\" : \"true\",\r\n          \"doc_count\" : 10\r\n        },\r\n        {\r\n          \"key\" : \"false\",\r\n          \"doc_count\" : 5\r\n        }\r\n      ]\r\n    },\r\n    \"by_string\" : {\r\n      \"doc_count_error_upper_bound\" : 0,\r\n      \"sum_other_doc_count\" : 0,\r\n      \"buckets\" : [\r\n        {\r\n          \"key\" : \"true\",\r\n          \"doc_count\" : 15\r\n        },\r\n        {\r\n          \"key\" : \"false\",\r\n          \"doc_count\" : 7\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nThe mismatch happens when the original data type is boolean (as in the example above), and also when the original type is integer, double, and string.\r\n\r\nWhat might cause the undercounting in terms agg?","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}