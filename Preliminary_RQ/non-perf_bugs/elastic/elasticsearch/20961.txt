{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20961","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20961/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20961/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20961/events","html_url":"https://github.com/elastic/elasticsearch/issues/20961","id":183350365,"node_id":"MDU6SXNzdWUxODMzNTAzNjU=","number":20961,"title":"Elasticsearch publishes wrong ip when run with docker 1.12 in swarm mode.","user":{"login":"guenhter","id":16029571,"node_id":"MDQ6VXNlcjE2MDI5NTcx","avatar_url":"https://avatars2.githubusercontent.com/u/16029571?v=4","gravatar_id":"","url":"https://api.github.com/users/guenhter","html_url":"https://github.com/guenhter","followers_url":"https://api.github.com/users/guenhter/followers","following_url":"https://api.github.com/users/guenhter/following{/other_user}","gists_url":"https://api.github.com/users/guenhter/gists{/gist_id}","starred_url":"https://api.github.com/users/guenhter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guenhter/subscriptions","organizations_url":"https://api.github.com/users/guenhter/orgs","repos_url":"https://api.github.com/users/guenhter/repos","events_url":"https://api.github.com/users/guenhter/events{/privacy}","received_events_url":"https://api.github.com/users/guenhter/received_events","type":"User","site_admin":false},"labels":[{"id":146854632,"node_id":"MDU6TGFiZWwxNDY4NTQ2MzI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Network","name":":Distributed/Network","color":"0e8a16","default":false,"description":"Http and internode communication implementations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-10-17T08:05:45Z","updated_at":"2016-11-01T07:12:00Z","closed_at":"2016-11-01T07:12:00Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**:\n5.0.0-RC1\n\n**Plugins installed**: []\nNone\n\n**JVM version**:\nShipped Version with Elasticsearch-Docker\nhttps://github.com/elastic/elasticsearch-docker\n\n**OS version**:\nDebian 8 in Guest (using Elasticsearch via Docker)\nLinux machine1 3.16.0-4-amd64 #1 SMP Debian 3.16.36-1+deb8u1 (2016-09-03) x86_64 GNU/Linux\n\n**Description of the problem including expected versus actual behavior**:\nTried to create an elasticsearch cluster with docker 1.12.2 in swarm mode. ES now publish_address point to a wrong destination. It should connect to the actual correct VIP but it points to the \\32 address which is equal for all scaled services.\n\n**Steps to reproduce**:\n1. Run these commands:\n\n```\ndocker network create   --driver overlay   --subnet 10.0.9.0/24   --opt encrypted   services\n\ndocker service create --name es      --replicas 1 --network services -p 9200 -p 9300 -e \"discovery.zen.minimum_master_nodes=2\" -e \"ES_JAVA_OPTS=-Xms256m -Xmx256m\"                                                 docker.elastic.co/elasticsearch/elasticsearch\n```\n1. Than check the ip addresses of the container with \n   `docker exec CONTAINER-ID ip address`\n\n```\n...\n32: eth2: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1424 qdisc noqueue state UP\n    link/ether 02:42:0a:00:09:07 brd ff:ff:ff:ff:ff:ff\n    inet 10.0.9.7/24 scope global eth2\n       valid_lft forever preferred_lft forever\n    inet 10.0.9.6/32 scope global eth2\n       valid_lft forever preferred_lft forever\n    inet6 fe80::42:aff:fe00:907/64 scope link\n       valid_lft forever preferred_lft forever\n```\n1. `docker logs CONTAINER-ID` shows, that the container connect to 10.0.9.6/32\n   `[2016-10-14T17:06:55,515][INFO ][o.e.t.TransportService   ] [5xx0tvy] publish_address {10.0.9.6:9300}, bound_addresses {[::]:9300}`\n\nThis is a problem, because that address is shared among all tasks (all scaled containers) and only the first ES-instance will register successfully, all others get a\n`[2016-10-14T17:43:07,760][INFO ][o.e.d.z.ZenDiscovery     ] [XlcRAHZ] failed to send join request to master [{5xx0tvy}{5xx0tvyJR0GX2WMCBaw8ig}{6WExWxXlRYC4XwlFSuyOcw}{10.0.9.6}{10.0.9.6:9300}], reason [RemoteTransportException[[5xx0tvy][10.0.9.7:9300][internal:discovery/zen/join]]; nested: IllegalArgumentException[can't add node {XlcRAHZ}{XlcRAHZ0S6aEDrmhK7UC_g}{SRbRCA4ESp6OLDNJWU-NXA}{10.0.9.8}{10.0.9.8:9300}, found existing node {1N8RQt-}{1N8RQt-3QwS4ANWneRGGgQ}{wYsLm1gyS4mtFiwYKx0KPA}{10.0.9.8}{10.0.9.8:9300} with same address]; ]`\nmessage\n","closed_by":{"login":"guenhter","id":16029571,"node_id":"MDQ6VXNlcjE2MDI5NTcx","avatar_url":"https://avatars2.githubusercontent.com/u/16029571?v=4","gravatar_id":"","url":"https://api.github.com/users/guenhter","html_url":"https://github.com/guenhter","followers_url":"https://api.github.com/users/guenhter/followers","following_url":"https://api.github.com/users/guenhter/following{/other_user}","gists_url":"https://api.github.com/users/guenhter/gists{/gist_id}","starred_url":"https://api.github.com/users/guenhter/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/guenhter/subscriptions","organizations_url":"https://api.github.com/users/guenhter/orgs","repos_url":"https://api.github.com/users/guenhter/repos","events_url":"https://api.github.com/users/guenhter/events{/privacy}","received_events_url":"https://api.github.com/users/guenhter/received_events","type":"User","site_admin":false},"performed_via_github_app":null}