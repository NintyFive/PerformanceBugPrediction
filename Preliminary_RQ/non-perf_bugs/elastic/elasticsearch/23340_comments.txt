[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283396492","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283396492","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283396492,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzM5NjQ5Mg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-03-01T16:45:30Z","updated_at":"2017-03-01T16:45:45Z","author_association":"MEMBER","body":"I dont think this is a bug. The `text` parameter on the SuggestionBuilder level is supposed to be independent of the `globalText` parameter in the top level Suggester. This also reflects what is happening on the REST level. As mentioned in the [docs](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-suggesters.html): \"The suggest text specified on suggestion level override the suggest text on the global level.\"\r\n\r\nThis is handled later, I think in this part of the code: \r\nhttps://github.com/elastic/elasticsearch/blob/3fb9254b9548d3514c3d187081bfebfce3a948f8/core/src/main/java/org/elasticsearch/search/suggest/SuggestBuilder.java#L175\r\n\r\nSo IMHO `SuggestBuilder#setGlobalText` isn't supposed to be a shortcut for setting the text() property on each SuggestionBuilder added to the SuggestBuilder. Maybe @areek can confirm this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283428348","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283428348","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283428348,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzQyODM0OA==","user":{"login":"etay2000","id":25994877,"node_id":"MDQ6VXNlcjI1OTk0ODc3","avatar_url":"https://avatars1.githubusercontent.com/u/25994877?v=4","gravatar_id":"","url":"https://api.github.com/users/etay2000","html_url":"https://github.com/etay2000","followers_url":"https://api.github.com/users/etay2000/followers","following_url":"https://api.github.com/users/etay2000/following{/other_user}","gists_url":"https://api.github.com/users/etay2000/gists{/gist_id}","starred_url":"https://api.github.com/users/etay2000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etay2000/subscriptions","organizations_url":"https://api.github.com/users/etay2000/orgs","repos_url":"https://api.github.com/users/etay2000/repos","events_url":"https://api.github.com/users/etay2000/events{/privacy}","received_events_url":"https://api.github.com/users/etay2000/received_events","type":"User","site_admin":false},"created_at":"2017-03-01T18:35:38Z","updated_at":"2017-03-01T18:35:38Z","author_association":"NONE","body":"Directly above the section in the docs you referenced, this is mentioned:\r\n\r\n> To avoid repetition of the suggest text, it is possible to define a global text. In the example below the suggest text is defined globally and applies to the my-suggest-1 and my-suggest-2 suggestions.\r\n\r\n```\r\n POST _search\r\n{\r\n  \"suggest\": {\r\n    \"text\" : \"tring out Elasticsearch\",\r\n    \"my-suggest-1\" : {\r\n      \"term\" : {\r\n        \"field\" : \"message\"\r\n      }\r\n    },\r\n    \"my-suggest-2\" : {\r\n       \"term\" : {\r\n        \"field\" : \"user\"\r\n       }\r\n    }\r\n  }\r\n}\r\n```\r\nThis leads me to believe that setting the global text is a shortcut for setting the text() property on each SuggestionBuilder. \r\n\r\nAlso, in the code you referenced:\r\n```\r\nif (suggestionContext.getText() == null) {\r\n    if (globalText == null) {\r\n        throw new IllegalArgumentException(\"The required text option is missing\");\r\n    }\r\n    suggestionContext.setText(BytesRefs.toBytesRef(globalText));\r\n}\r\n```\r\nI read that as: \r\nIf the suggestionContext does not have it's text() property set, and globalText is not null, then use the globalText to assign the the text() property of the suggestionContext.\r\n\r\nOtherwise, what would be the point of setting the globalText if you still had to set the text property of each SuggestionBuilder?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283462645","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283462645","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283462645,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzQ2MjY0NQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-03-01T20:39:04Z","updated_at":"2017-03-01T20:39:04Z","author_association":"MEMBER","body":"@etay2000 The docs refer to the Rest syntax, not the Java API. Your reading of the code is correct, but here we are already taking about internals (SuggestionContext, SuggestionSearchContext), not the builders. The `globalText` will be used when set on the SuggestBuilder and no `text` from the individual Suggestion overwrite it. But that doesn't mean we need to transfer this to the SuggestionBuilders.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283474871","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283474871","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283474871,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzQ3NDg3MQ==","user":{"login":"etay2000","id":25994877,"node_id":"MDQ6VXNlcjI1OTk0ODc3","avatar_url":"https://avatars1.githubusercontent.com/u/25994877?v=4","gravatar_id":"","url":"https://api.github.com/users/etay2000","html_url":"https://github.com/etay2000","followers_url":"https://api.github.com/users/etay2000/followers","following_url":"https://api.github.com/users/etay2000/following{/other_user}","gists_url":"https://api.github.com/users/etay2000/gists{/gist_id}","starred_url":"https://api.github.com/users/etay2000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etay2000/subscriptions","organizations_url":"https://api.github.com/users/etay2000/orgs","repos_url":"https://api.github.com/users/etay2000/repos","events_url":"https://api.github.com/users/etay2000/events{/privacy}","received_events_url":"https://api.github.com/users/etay2000/received_events","type":"User","site_admin":false},"created_at":"2017-03-01T21:24:15Z","updated_at":"2017-03-01T21:24:15Z","author_association":"NONE","body":"@cbuescher I assumed the Rest syntax would mirror the Java API (or vice versa) with regards to setting the globalText.  I am not too familiar with the internals, so I am still a bit confused by when and why the globalText would actually be used. My interpretation of the benefit of the globalText option was to prevent the repetition of setting the same suggest text. As it stands in the Java API, each SuggestionBuilder is still required to have its text property set even if it shares the same text value with all of the other SuggestionBuilders. If the text property is not set, then why wouldn't the globalText propagate down to it? This to me seems to defeat the purpose of having an option of setting the globalText on the SuggestBuilder in the first place.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283476175","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283476175","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283476175,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzQ3NjE3NQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-03-01T21:29:12Z","updated_at":"2017-03-01T21:29:12Z","author_association":"MEMBER","body":"> As it stands in the Java API, each SuggestionBuilder is still required to have its text property set even if it shares the same text value with all of the other SuggestionBuilders. If the text property is not set, then why wouldn't the globalText propagate down to it?\r\n\r\nHave you tried setting the `globalText` on the SuggestBuilder and then using this for the seach? It should work regardless. You don't have to set the `text` on each SuggestionBuilder, these things are merged later (the place I pointed to)...","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283481312","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283481312","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283481312,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzQ4MTMxMg==","user":{"login":"etay2000","id":25994877,"node_id":"MDQ6VXNlcjI1OTk0ODc3","avatar_url":"https://avatars1.githubusercontent.com/u/25994877?v=4","gravatar_id":"","url":"https://api.github.com/users/etay2000","html_url":"https://github.com/etay2000","followers_url":"https://api.github.com/users/etay2000/followers","following_url":"https://api.github.com/users/etay2000/following{/other_user}","gists_url":"https://api.github.com/users/etay2000/gists{/gist_id}","starred_url":"https://api.github.com/users/etay2000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etay2000/subscriptions","organizations_url":"https://api.github.com/users/etay2000/orgs","repos_url":"https://api.github.com/users/etay2000/repos","events_url":"https://api.github.com/users/etay2000/events{/privacy}","received_events_url":"https://api.github.com/users/etay2000/received_events","type":"User","site_admin":false},"created_at":"2017-03-01T21:48:04Z","updated_at":"2017-03-01T21:48:04Z","author_association":"NONE","body":"Yes that was my point in my first post (sorry for the poor code formatting). If I set the globalText on the SuggestBuilder but not on any SuggestionBuilders I get a null Suggest instance back from the SearchResponse. However, if I set the suggest text on the SuggestionBuilders I get a proper Suggest instance as expected.\r\n\r\n```String searchText = \"foo\";\r\nSuggestBuilder suggestBuilder = new SuggestBuilder();\r\nsuggestBuilder.setGlobalText(searchText);\r\n\r\nSuggestionBuilder<?> suggestionBuilder = SuggestBuilders.completionSuggestion(\"fieldName\");\r\n// suggestionBuilder.text(searchText);\r\n// As is, searchResponse#getSuggest will return null,\r\n// uncomment the line above and the searchResponse#getSuggest will return as expected\r\nsuggestBuilder.addSuggestion(\"suggestion-name\", suggestionBuilder);```\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283630268","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283630268","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283630268,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzYzMDI2OA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-03-02T11:35:14Z","updated_at":"2017-03-02T11:35:14Z","author_association":"MEMBER","body":"@etay2000 thanks for the clarification, I was able to reproduce this now in a simple test. The problem seems to be limited to completion suggestions where neither `prefix`, `regex` nor `text`  specified on the individual suggestion. In this case we internally overwrite the `text` property with the global text set on the Suggest builder. The problem is that internally the completion suggester need either `prefix` or `regex` to be set and throws an error. There should be shard failures in the response you are receiving. \r\nI think in case of missing `text` on the suggestion, we should use the global text to also overwrite the prefix used by the CompletionSuggester. I will open a PR shortly.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/283714618","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-283714618","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":283714618,"node_id":"MDEyOklzc3VlQ29tbWVudDI4MzcxNDYxOA==","user":{"login":"etay2000","id":25994877,"node_id":"MDQ6VXNlcjI1OTk0ODc3","avatar_url":"https://avatars1.githubusercontent.com/u/25994877?v=4","gravatar_id":"","url":"https://api.github.com/users/etay2000","html_url":"https://github.com/etay2000","followers_url":"https://api.github.com/users/etay2000/followers","following_url":"https://api.github.com/users/etay2000/following{/other_user}","gists_url":"https://api.github.com/users/etay2000/gists{/gist_id}","starred_url":"https://api.github.com/users/etay2000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etay2000/subscriptions","organizations_url":"https://api.github.com/users/etay2000/orgs","repos_url":"https://api.github.com/users/etay2000/repos","events_url":"https://api.github.com/users/etay2000/events{/privacy}","received_events_url":"https://api.github.com/users/etay2000/received_events","type":"User","site_admin":false},"created_at":"2017-03-02T17:06:27Z","updated_at":"2017-03-02T17:06:27Z","author_association":"NONE","body":"@cbuescher Sure enough there were shard failures and somehow I missed the IllegalArgumentException(\"'prefix' or 'regex' must be defined\") on the stack, so your fix should definitely take care of it. Thanks for the quick response.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/287352680","html_url":"https://github.com/elastic/elasticsearch/issues/23340#issuecomment-287352680","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23340","id":287352680,"node_id":"MDEyOklzc3VlQ29tbWVudDI4NzM1MjY4MA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-03-17T13:25:04Z","updated_at":"2017-03-17T13:25:04Z","author_association":"MEMBER","body":"Closed by #23451","performed_via_github_app":null}]