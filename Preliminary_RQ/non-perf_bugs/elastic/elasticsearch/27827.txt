{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27827","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27827/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27827/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27827/events","html_url":"https://github.com/elastic/elasticsearch/issues/27827","id":282246667,"node_id":"MDU6SXNzdWUyODIyNDY2Njc=","number":27827,"title":"Rest client settings related to connections and keep alives are broken","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"labels":[{"id":407508641,"node_id":"MDU6TGFiZWw0MDc1MDg2NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Java%20Low%20Level%20REST%20Client","name":":Core/Features/Java Low Level REST Client","color":"0e8a16","default":false,"description":"Minimal dependencies Java Client for Elasticsearch"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":771303553,"node_id":"MDU6TGFiZWw3NzEzMDM1NTM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v5.6.7","name":"v5.6.7","color":"dddddd","default":false,"description":null},{"id":777829541,"node_id":"MDU6TGFiZWw3Nzc4Mjk1NDE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.0.3","name":"v6.0.3","color":"dddddd","default":false,"description":null},{"id":773475250,"node_id":"MDU6TGFiZWw3NzM0NzUyNTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.1.1","name":"v6.1.1","color":"dddddd","default":false,"description":null},{"id":758151235,"node_id":"MDU6TGFiZWw3NTgxNTEyMzU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.2.0","name":"v6.2.0","color":"DDDDDD","default":false,"description":null},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"assignees":[{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2017-12-14T21:36:24Z","updated_at":"2019-02-07T08:40:44Z","closed_at":"2017-12-15T19:54:23Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In 5.6 we introduced a change to the rest client that told the apache client to use system properties for some settings (3e4bc027ebdba5dd1a0935a75b5218960f736f76). \r\n\r\n```\r\nHttpAsyncClientBuilder httpClientBuilder = HttpAsyncClientBuilder.create().setDefaultRequestConfig(requestConfigBuilder.build())\r\n                //default settings for connection pooling may be too constraining\r\n                .setMaxConnPerRoute(DEFAULT_MAX_CONN_PER_ROUTE).setMaxConnTotal(DEFAULT_MAX_CONN_TOTAL).useSystemProperties();\r\n```\r\n\r\nThis was introduced to force the client to use the system default `SSLContext`. Unfortunately this also leads the http client to use system properties for max connections, keep alive, and other configs. This means that our settings of `DEFAULT_MAX_CONN_PER_ROUTE` and `DEFAULT_MAX_CONN_TOTAL` are ignored. Additionally any settings that a user changes related to the client might be ignored (depending on the setting).\r\n\r\n`org.apache.http.impl.nio.client.HttpAsyncClientBuilder.class`\r\n```\r\n            if (systemProperties) {\r\n                String s = System.getProperty(\"http.keepAlive\", \"true\");\r\n                if (\"true\".equalsIgnoreCase(s)) {\r\n                    s = System.getProperty(\"http.maxConnections\", \"5\");\r\n                    final int max = Integer.parseInt(s);\r\n                    poolingmgr.setDefaultMaxPerRoute(max);\r\n                    poolingmgr.setMaxTotal(2 * max);\r\n                }\r\n            } else {\r\n                if (maxConnTotal > 0) {\r\n                    poolingmgr.setMaxTotal(maxConnTotal);\r\n                }\r\n                if (maxConnPerRoute > 0) {\r\n                    poolingmgr.setDefaultMaxPerRoute(maxConnPerRoute);\r\n                }\r\n            }\r\n```\r\n\r\nI think we need to configured the SSLContext specifically, opposed for forcing system properties for many settings.\r\n\r\n@jaymode ","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}