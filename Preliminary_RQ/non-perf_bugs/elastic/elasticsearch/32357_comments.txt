[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/407740384","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-407740384","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":407740384,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNzc0MDM4NA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-25T12:39:49Z","updated_at":"2018-07-25T12:39:49Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409176452","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-409176452","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":409176452,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTE3NjQ1Mg==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T10:40:26Z","updated_at":"2018-07-31T10:40:48Z","author_association":"CONTRIBUTOR","body":"The issue is reproducible on 6.x and on master. I can not confirm that the issue was introduced in 6.3.1. The issue is still reproducible in 6.3.1 and 6.3.0.\r\nThe exception is happening in JsonXContentGenerator.writeRawField, while trying to guess \"Content-Type\" for _source field. If Content-Type could not be guessed, IllegalArgumentException is thrown. XContentType factory is using GUESS_HEADER_LENGTH (==20) first characters to guess the type of the field. Since they are all whitespaces - null is returned.\r\nThis issue is reproducible with non-bulk API as well - as long as _source starts with 20 or more whitespaces. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409185729","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-409185729","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":409185729,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTE4NTcyOQ==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T11:19:50Z","updated_at":"2018-07-31T11:19:50Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409186442","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-409186442","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":409186442,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTE4NjQ0Mg==","user":{"login":"andrershov","id":600624,"node_id":"MDQ6VXNlcjYwMDYyNA==","avatar_url":"https://avatars1.githubusercontent.com/u/600624?v=4","gravatar_id":"","url":"https://api.github.com/users/andrershov","html_url":"https://github.com/andrershov","followers_url":"https://api.github.com/users/andrershov/followers","following_url":"https://api.github.com/users/andrershov/following{/other_user}","gists_url":"https://api.github.com/users/andrershov/gists{/gist_id}","starred_url":"https://api.github.com/users/andrershov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/andrershov/subscriptions","organizations_url":"https://api.github.com/users/andrershov/orgs","repos_url":"https://api.github.com/users/andrershov/repos","events_url":"https://api.github.com/users/andrershov/events{/privacy}","received_events_url":"https://api.github.com/users/andrershov/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T11:22:58Z","updated_at":"2018-07-31T11:22:58Z","author_association":"CONTRIBUTOR","body":"@elastic/es-core-infra I see two possible solutions here. Quick-and-dirty - just to skip checking content-type for null and copy bytes to the output stream. Another solution is to get rid of leading whitespaces when storing the document. Technically JSON with leading whitespaces is correct, but I can hardly imagine the situation why preserving leading whitespaces in _src could be useful.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410524098","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410524098","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410524098,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUyNDA5OA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T14:32:17Z","updated_at":"2018-08-05T14:32:17Z","author_association":"MEMBER","body":"@andrershov I need some more details to be fully sure (you mention writeRawField, but I don't yet see how this connects to writing), but it seems this is something specific to how the bulk api does things. since 6.0 content type is required with each call to our APIs, and it's properly supplied in the request in this issue. From this, I think this is a bug that we even end up trying to detect what the content type is. \r\n\r\nYou mention:\r\n> This issue is reproducible with non-bulk API as well - as long as _source starts with 20 or more whitespaces.\r\n\r\nwhich `_source` do you refer to? can you give a complete example?\r\n\r\nPS I'm going to re-label w.r.t the Bulk API until we clarify it's a problem with a more generic infra.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410529041","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410529041","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410529041,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUyOTA0MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T15:50:40Z","updated_at":"2018-08-05T15:50:40Z","author_association":"MEMBER","body":"@bleskes The problem is on the search response, not the bulk request. We don’t store the source content-type and content-type detection is failing then to write the search response. The content-type detection fails because we only look at the first twenty bytes of source to guess the content-type. I don’t think we should modify user source ever. We can consider being stricter about the format of a bulk request, it depends what we document here whether or not we can get away with what would otherwise be a breaking change. We can also consider modifying content-type detection to strip leading whitespace. The latter feels like a core issue to me.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410529352","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410529352","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410529352,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUyOTM1Mg==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T15:55:33Z","updated_at":"2018-08-05T15:55:33Z","author_association":"MEMBER","body":"@jasontedor thanks. @andrershov and I discussed it over another channel and he clarified it. W.r.t improve content type detection - I'm +1 on that , though it's a bit tricky to do imo. `xContentType(InputStream si)` shouldn't change the stream, ideally and if it does it will change the response - which kind of defeats the point of not messing up with the `_source`. \r\n\r\nI've asked @andrershov to also look at what it will take to validating incoming indexing ops to make sure we can guess the content type correctly (and ideally it being equal to what we're being told). I think that's better (if it works out) until we properly resolve the \"what content type do we have stored?\" discussion. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410534102","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410534102","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410534102,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUzNDEwMg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T17:13:30Z","updated_at":"2018-08-05T17:13:30Z","author_association":"MEMBER","body":"> W.r.t improve content type detection - I'm +1 on that , though it's a bit tricky to do imo. `xContentType(InputStream si)` shouldn't change the stream, ideally and if it does it will change the response - which kind of defeats the point of not messing up with the `_source`. \r\n\r\nI don't think so. I think we can do a little dance with mark/reset. 💃 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410535528","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410535528","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410535528,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUzNTUyOA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T17:35:24Z","updated_at":"2018-08-05T17:35:24Z","author_association":"MEMBER","body":"I opened #32632.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410535795","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410535795","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410535795,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDUzNTc5NQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-08-05T17:40:08Z","updated_at":"2018-08-05T17:40:08Z","author_association":"MEMBER","body":"With the change in #32632 this issue no longer reproduces:\r\n\r\n```\r\n13:38:10 [jason@totoro:~] $ cat bulk.txt                                                                                                                                                                                                                                                                          \r\n{\"index\":{\"_id\":\"1\"}}                                                                                                                                                                                                                                                                                             \r\n{\"Name\":\"Adam\"}                                                                                                                                                                                                                                                                                                   \r\n{\"index\":{\"_id\":\"2\"}}                                                                                                                                                                                                                                                                                             \r\n{\"Name\":\"Bob\"}                                                                                                                                                                                                                                                                                                    \r\n{\"index\":{\"_id\":\"3\"}}                                                                                                                                                                                                                                                                                             \r\n                    {\"Name\":\"Charlie\"}                                                                                                                                                                                                                                                                            \r\n13:38:16 [jason@totoro:~] $ curl -XDELETE localhost:9200/_all?pretty=true                                                                                                                                                                                                                                         \r\n{                                                                                                                                                                                                                                                                                                                 \r\n  \"acknowledged\" : true                                                                                                                                                                                                                                                                                           \r\n}                                                                                                                                                                                                                                                                                                                 \r\n13:38:21 [jason@totoro:~] $ curl -XPOST -H \"Content-Type: application/json\" localhost:9200/i/_doc/_bulk?pretty=true --data-binary @bulk.txt                                                                                                                                                                       \r\n{                                                                                                                                                                                                                                                                                                                 \r\n  \"took\" : 174,         \r\n  \"errors\" : false,\r\n  \"items\" : [\r\n    {  \r\n      \"index\" : {      \r\n        \"_index\" : \"i\",  \r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"1\",   \r\n        \"_version\" : 1,\r\n        \"result\" : \"created\",\r\n        \"_shards\" : {\r\n          \"total\" : 2,\r\n          \"successful\" : 1,\r\n          \"failed\" : 0\r\n        },\r\n        \"_seq_no\" : 0,     \r\n        \"_primary_term\" : 1,\r\n        \"status\" : 201\r\n      }\r\n    },\r\n    {\r\n      \"index\" : {\r\n        \"_index\" : \"i\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"2\",\r\n        \"_version\" : 1,\r\n        \"result\" : \"created\",\r\n        \"_shards\" : {\r\n          \"total\" : 2,\r\n          \"successful\" : 1,\r\n          \"failed\" : 0\r\n        },\r\n        \"_seq_no\" : 1,\r\n        \"_primary_term\" : 1,\r\n        \"status\" : 201\r\n      }\r\n    },\r\n    {\r\n      \"index\" : {\r\n        \"_index\" : \"i\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"3\",\r\n        \"_version\" : 1,\r\n        \"result\" : \"created\",\r\n        \"_shards\" : {\r\n          \"total\" : 2,\r\n          \"successful\" : 1,\r\n          \"failed\" : 0\r\n        },\r\n        \"_seq_no\" : 2,\r\n        \"_primary_term\" : 1,\r\n        \"status\" : 201\r\n      }\r\n    }\r\n  ]\r\n}\r\n13:38:29 [jason@totoro:~] $ curl -XGET localhost:9200/_search?pretty=true\r\n{\r\n  \"took\" : 6,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 3,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"i\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"Name\" : \"Adam\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"i\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"Name\" : \"Bob\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"i\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"3\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"Name\" : \"Charlie\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410995278","html_url":"https://github.com/elastic/elasticsearch/issues/32357#issuecomment-410995278","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32357","id":410995278,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDk5NTI3OA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2018-08-07T09:30:51Z","updated_at":"2018-08-07T09:30:51Z","author_association":"MEMBER","body":"Closed by #32632","performed_via_github_app":null}]