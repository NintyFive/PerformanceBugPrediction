{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/63795","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63795/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63795/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/63795/events","html_url":"https://github.com/elastic/elasticsearch/issues/63795","id":723077195,"node_id":"MDU6SXNzdWU3MjMwNzcxOTU=","number":63795,"title":"[ML] Add a magic value for xpack.ml.max_machine_memory_percent","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"assignees":[{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-10-16T09:53:40Z","updated_at":"2020-10-21T16:50:56Z","closed_at":"2020-10-21T16:50:56Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"At the moment `xpack.ml.max_machine_memory_percent` has to be set to a value between 5 and 200.\r\n\r\nIn some situations it would be easier for users to set it to a magic value meaning \"use almost all the memory remaining after the JVM heap and core OS for ML native processes\".  This setting would be useful for dedicated ML nodes where no other significant software is running on the machine.\r\n\r\nFor consistency with the way ESS sets `xpack.ml.max_machine_memory_percent` today, the meaning of the magic value of -1 should be:\r\n\r\n```\r\nmin(90, ceil((nodeSize - jvmHeapSize - 200MB) / nodeSize * 100))\r\n```\r\n\r\n(That formula gives a percentage - depending on where the -1 is processed, it may make more sense to calculate the number of bytes rather than calculate a percentage and then immediately afterwards convert back to an actual number of bytes.)\r\n\r\nThe `xpack.ml.max_machine_memory_percent` setting will need to be given a custom validator, which allows values between 5 and 200 _or_ -1, but not values in the range 0 to 4.  Ideally this custom validator should only allow -1 if all nodes in the cluster are on versions that will understand -1.  If this is not possible then the code needs to be analysed carefully to find out what will happen in mixed version clusters if -1 is set when some nodes in the cluster do not understand it.  Possibly we can just add a warning to the docs saying not to set -1 until all nodes are upgraded to the appropriate version.\r\n\r\nOne the change is made the Cloud code can be changed to set `xpack.ml.max_machine_memory_percent` for versions that understand it.  Eventually (many years in the future) the Cloud code can be simplified to remove the current formula.","closed_by":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"performed_via_github_app":null}