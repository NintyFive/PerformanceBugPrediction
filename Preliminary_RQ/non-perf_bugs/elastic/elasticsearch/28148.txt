{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28148","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28148/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28148/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28148/events","html_url":"https://github.com/elastic/elasticsearch/issues/28148","id":287057529,"node_id":"MDU6SXNzdWUyODcwNTc1Mjk=","number":28148,"title":"How to get the value of a variable out of  Watcher's conditon where it has been defined?","user":{"login":"sunnywalden","id":15942227,"node_id":"MDQ6VXNlcjE1OTQyMjI3","avatar_url":"https://avatars0.githubusercontent.com/u/15942227?v=4","gravatar_id":"","url":"https://api.github.com/users/sunnywalden","html_url":"https://github.com/sunnywalden","followers_url":"https://api.github.com/users/sunnywalden/followers","following_url":"https://api.github.com/users/sunnywalden/following{/other_user}","gists_url":"https://api.github.com/users/sunnywalden/gists{/gist_id}","starred_url":"https://api.github.com/users/sunnywalden/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sunnywalden/subscriptions","organizations_url":"https://api.github.com/users/sunnywalden/orgs","repos_url":"https://api.github.com/users/sunnywalden/repos","events_url":"https://api.github.com/users/sunnywalden/events{/privacy}","received_events_url":"https://api.github.com/users/sunnywalden/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-01-09T11:31:49Z","updated_at":"2018-01-09T12:07:23Z","closed_at":"2018-01-09T12:07:23Z","author_association":"NONE","active_lock_reason":null,"body":"Here is my search results:\r\n\r\n{\r\n  \"took\": 638,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 2705428,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"group_by_source\": {\r\n      \"doc_count_error_upper_bound\": 0,\r\n      \"sum_other_doc_count\": 0,\r\n      \"buckets\": [\r\n        {\r\n          \"key\": \"jiwei\",\r\n          \"doc_count\": 2599928,\r\n          \"group_by_logtype\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": \"clickNumber\",\r\n                \"doc_count\": 2599894\r\n              },\r\n              {\r\n                \"key\": \"advAckAllNumber\",\r\n                \"doc_count\": 34\r\n              }\r\n            ]\r\n          }\r\n        },\r\n        {\r\n          \"key\": \"zhitou\",\r\n          \"doc_count\": 105473,\r\n          \"group_by_logtype\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": \"clickNumber\",\r\n                \"doc_count\": 105471\r\n              },\r\n              {\r\n                \"key\": \"advAckAllNumber\",\r\n                \"doc_count\": 2\r\n              }\r\n            ]\r\n          }\r\n        },\r\n        {\r\n          \"key\": \"kejin\",\r\n          \"doc_count\": 15,\r\n          \"group_by_logtype\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": \"clickNumber\",\r\n                \"doc_count\": 13\r\n              },\r\n              {\r\n                \"key\": \"advAckAllNumber\",\r\n                \"doc_count\": 2\r\n              }\r\n            ]\r\n          }\r\n        },\r\n        {\r\n          \"key\": \"mex\",\r\n          \"doc_count\": 11,\r\n          \"group_by_logtype\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": \"clickNumber\",\r\n                \"doc_count\": 10\r\n              },\r\n              {\r\n                \"key\": \"advAckAllNumber\",\r\n                \"doc_count\": 1\r\n              }\r\n            ]\r\n          }\r\n        },\r\n        {\r\n          \"key\": \"applovin\",\r\n          \"doc_count\": 1,\r\n          \"group_by_logtype\": {\r\n            \"doc_count_error_upper_bound\": 0,\r\n            \"sum_other_doc_count\": 0,\r\n            \"buckets\": [\r\n              {\r\n                \"key\": \"clickNumber\",\r\n                \"doc_count\": 1\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\nI wanna get the value of rates in actions, it there any way to do it?\r\n\r\n{\r\n  \"trigger\": {\r\n    \"schedule\": {\r\n      \"cron\": \"0 0 11 * * ?\"\r\n    }\r\n  },\r\n  \"input\": {\r\n    \"search\": {\r\n      \"request\": {\r\n        \"search_type\": \"query_then_fetch\",\r\n        \"indices\": [\r\n          \"logstash-*\"\r\n        ],\r\n        \"types\": [],\r\n        \"body\": {\r\n          \"size\": 0,\r\n          \"query\": {\r\n            \"bool\": {\r\n              \"must\": {\r\n                \"range\": {\r\n                  \"@timestamp\": {\r\n                    \"gte\": \"now-8d/d\",\r\n                    \"lte\": \"now-8d/d\",\r\n                    \"time_zone\": \"+00:00\"\r\n                  }\r\n                }\r\n              },\r\n              \"filter\": {\r\n                \"query_string\": {\r\n                  \"query\": \"(appid:1179908959)AND(log_type:(clickNumber|advAckAllNumber))\"\r\n                }\r\n              }\r\n            }\r\n          },\r\n          \"aggs\": {\r\n            \"group_by_source\": {\r\n              \"terms\": {\r\n                \"field\": \"source.keyword\",\r\n                \"size\": 50\r\n              },\r\n              \"aggs\": {\r\n                \"group_by_logtype\": {\r\n                  \"terms\": {\r\n                    \"field\": \"log_type.keyword\"\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"condition\": {\r\n    \"script\": {\r\n      \"source\": \"def hg = 0.0005;def lw = 0.0001;def len_th = ctx.payload.aggregations.group_by_source.buckets.size();def rate = 0.0;def rates = new HashMap();def lt = 0;for (def i = 0; i < len_th; i++) {  lt = ctx.payload.aggregations.group_by_source.buckets[i].group_by_logtype.buckets.length;if (lt === 1 ) { rate = 0 } else { rate = ctx.payload.aggregations.group_by_source.buckets[i].group_by_logtype.buckets.1.doc_count / ctx.payload.aggregations.group_by_source.buckets[i].group_by_logtype.buckets.0.doc_count } if ( rate < lw || rate > hg ) { rates[ctx.payload.aggregations.group_by_source.buckets[i].key] = rate  }  }   return len_th === 5 ;\",\r\n      \"lang\": \"painless\"\r\n    }\r\n  },\r\n  \"actions\": {\r\n    \"email_admin\": {\r\n      \"email\": {\r\n        \"profile\": \"standard\",\r\n        \"from\": \"**@jcmob.net\",\r\n        \"to\": [\r\n          \"**@jcmob.net\"\r\n        ],\r\n        \"subject\": \"J&C source activate rate is out of range\",\r\n        \"body\": {\r\n          \"text\": \" The info locate at: http://*.*.*.*:5601/goto/50f91b750a67fe933dd52e431b250d3f\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n**Elasticsearch version**:\r\n5.6.0\r\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}