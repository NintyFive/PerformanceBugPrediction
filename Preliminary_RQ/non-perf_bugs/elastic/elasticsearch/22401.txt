{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22401","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22401/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22401/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22401/events","html_url":"https://github.com/elastic/elasticsearch/issues/22401","id":198283864,"node_id":"MDU6SXNzdWUxOTgyODM4NjQ=","number":22401,"title":"How to build bucket after multiple nested aggregations ?","user":{"login":"mbm-rafal","id":19263109,"node_id":"MDQ6VXNlcjE5MjYzMTA5","avatar_url":"https://avatars3.githubusercontent.com/u/19263109?v=4","gravatar_id":"","url":"https://api.github.com/users/mbm-rafal","html_url":"https://github.com/mbm-rafal","followers_url":"https://api.github.com/users/mbm-rafal/followers","following_url":"https://api.github.com/users/mbm-rafal/following{/other_user}","gists_url":"https://api.github.com/users/mbm-rafal/gists{/gist_id}","starred_url":"https://api.github.com/users/mbm-rafal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mbm-rafal/subscriptions","organizations_url":"https://api.github.com/users/mbm-rafal/orgs","repos_url":"https://api.github.com/users/mbm-rafal/repos","events_url":"https://api.github.com/users/mbm-rafal/events{/privacy}","received_events_url":"https://api.github.com/users/mbm-rafal/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-01-01T22:16:29Z","updated_at":"2017-01-10T19:00:42Z","closed_at":"2017-01-10T19:00:42Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, I have problem with creating bucket after nested aggregation\r\n\r\n```\r\n\"events.name12\": {\r\n         \"filter\": {},\r\n         \"aggs\": {\r\n            \"events\": {\r\n               \"nested\": {\r\n                  \"path\": \"events\"\r\n               },\r\n               \"aggs\": {\r\n                  \"filtered.events\": {\r\n                     \"filter\": {\r\n                        \"terms\": {\r\n                            \"events.id\": [\r\n                               448,\r\n                               435,\r\n                               338,\r\n                               364\r\n                            ]\r\n                         }\r\n                     },\r\n                     \"aggs\": {\r\n                        \"filtered.roles\": {\r\n                           \"nested\": {\r\n                              \"path\": \"events.role\"\r\n                           },\r\n                           \"aggs\": {\r\n                              \"filtered\": {\r\n                                \"filter\": {},\r\n                                \"aggs\": {\r\n                                    \"events.name\": {\r\n                                       \"terms\": {\r\n                                          \"field\": \"events.name\",\r\n                                          \"size\": 5\r\n                                       }\r\n                                    },\r\n                                    \"events.name_count\": {\r\n                                       \"cardinality\": {\r\n                                          \"field\": \"events.name\"\r\n                                       }\r\n                                    }\r\n                                }\r\n                              }\r\n                           }\r\n                        }\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         }\r\n      }\r\n```\r\n\r\nI want to filter events by id, then specific role.name and in the end I need buckets from event.name\r\n\r\nResult:\r\n```\r\n\"events.name12\": {\r\n         \"doc_count\": 617,\r\n         \"events\": {\r\n            \"doc_count\": 1278,\r\n            \"filtered.events\": {\r\n               \"doc_count\": 625,\r\n               \"filtered.roles\": {\r\n                  \"doc_count\": 625,\r\n                  \"filtered\": {\r\n                     \"doc_count\": 625,\r\n                     \"events.name\": {\r\n                        \"doc_count_error_upper_bound\": 0,\r\n                        \"sum_other_doc_count\": 0,\r\n                        \"buckets\": []\r\n                     },\r\n                     \"events.name_count\": {\r\n                        \"value\": 0\r\n                     }\r\n                  }\r\n               }\r\n            }\r\n         }\r\n      }\r\n```\r\n\r\nI think they are empty because the context is changed to events.role.\r\nBut how could I achieve this kind of filtering through different levels of nested field ?\r\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}