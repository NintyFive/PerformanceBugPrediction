[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/139681","html_url":"https://github.com/elastic/elasticsearch/issues/28#issuecomment-139681","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28","id":139681,"node_id":"MDEyOklzc3VlQ29tbWVudDEzOTY4MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2010-02-19T18:29:55Z","updated_at":"2010-02-19T18:29:55Z","author_association":"CONTRIBUTOR","body":"It seems to be related to running more than one node - if I use just one node and run the query below, then it works correctly:\n\n```\ncurl -XGET 'http://127.0.0.2:9200/_all/_search'  -d '\n{\n   \"query\" : {\n      \"term\" : {\n         \"text\" : \"foo\"\n      }\n   },\n   \"facets\" : {\n      \"bazFacet\" : {\n         \"query\" : {\n            \"term\" : {\n               \"text\" : \"baz\"\n            }\n         }\n      }\n   }\n}\n'\n```\n\nHowever, multiple facets are broken:\n\n```\ncurl -XGET 'http://127.0.0.2:9200/_all/_search'  -d '\n{\n   \"query\" : {\n      \"term\" : {\n         \"text\" : \"foo\"\n      }\n   },\n   \"facets\" : [\n      {\n         \"bazFacet\" : {\n            \"query\" : {\n               \"term\" : {\n                  \"text\" : \"baz\"\n               }\n            }\n         }\n      },\n      {\n         \"barFacet\" : {\n            \"query\" : {\n               \"term\" : {\n                  \"text\" : \"baz\"\n               }\n            }\n         }\n      }\n   ]\n}\n'\n# {\n#    \"hits\" : {\n#       \"hits\" : [],\n#       \"total\" : 0\n#    },\n#    \"_shards\" : {\n#       \"failed\" : 10,\n#       \"successful\" : 0,\n#       \"total\" : 10\n#    }\n# }\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/140210","html_url":"https://github.com/elastic/elasticsearch/issues/28#issuecomment-140210","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28","id":140210,"node_id":"MDEyOklzc3VlQ29tbWVudDE0MDIxMA==","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2010-02-20T13:21:09Z","updated_at":"2010-02-20T13:21:09Z","author_association":"MEMBER","body":"Facet query crashes the cluster. Wrong serialzation of facets caused for construction of a rough sized array list. closed by 008b00f51a073765c46441e2ad299bf0a6f95646.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/140249","html_url":"https://github.com/elastic/elasticsearch/issues/28#issuecomment-140249","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28","id":140249,"node_id":"MDEyOklzc3VlQ29tbWVudDE0MDI0OQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2010-02-20T15:32:03Z","updated_at":"2010-02-20T15:32:03Z","author_association":"CONTRIBUTOR","body":"Sorry - reposting in the issue:\n\nI'm afraid your facet fix still doesn't work. I can now check for multiple facets (which if I remember correctly wasn't working yesterday) when running with one node, but with a second node, a facet search still crashes the cluster.\n\nTest script below:\n\n```\n#!/bin/bash\nset -o verbose\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/1'  -d '\n{\n   \"num\" : 2,\n   \"text\" : \"foo\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/2'  -d '\n{\n   \"num\" : 3,\n   \"text\" : \"foo\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/3'  -d '\n{\n   \"num\" : 4,\n   \"text\" : \"foo\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/4'  -d '\n{\n   \"num\" : 5,\n   \"text\" : \"foo\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/5'  -d '\n{\n   \"num\" : 6,\n   \"text\" : \"foo bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/6'  -d '\n{\n   \"num\" : 7,\n   \"text\" : \"foo bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/7'  -d '\n{\n   \"num\" : 8,\n   \"text\" : \"foo bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/8'  -d '\n{\n   \"num\" : 9,\n   \"text\" : \"foo bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/9'  -d '\n{\n   \"num\" : 10,\n   \"text\" : \"foo bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/10'  -d '\n{\n   \"num\" : 11,\n   \"text\" : \"foo bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/11'  -d '\n{\n   \"num\" : 12,\n   \"text\" : \"foo bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/12'  -d '\n{\n   \"num\" : 13,\n   \"text\" : \"foo bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/13'  -d '\n{\n   \"num\" : 14,\n   \"text\" : \"bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/14'  -d '\n{\n   \"num\" : 15,\n   \"text\" : \"bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/15'  -d '\n{\n   \"num\" : 16,\n   \"text\" : \"bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/16'  -d '\n{\n   \"num\" : 17,\n   \"text\" : \"bar baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/17'  -d '\n{\n   \"num\" : 18,\n   \"text\" : \"baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/18'  -d '\n{\n   \"num\" : 19,\n   \"text\" : \"baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/19'  -d '\n{\n   \"num\" : 20,\n   \"text\" : \"baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/20'  -d '\n{\n   \"num\" : 21,\n   \"text\" : \"baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/21'  -d '\n{\n   \"num\" : 22,\n   \"text\" : \"bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/22'  -d '\n{\n   \"num\" : 23,\n   \"text\" : \"bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/23'  -d '\n{\n   \"num\" : 24,\n   \"text\" : \"bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/24'  -d '\n{\n   \"num\" : 25,\n   \"text\" : \"bar\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_1/25'  -d '\n{\n   \"num\" : 26,\n   \"text\" : \"foo baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test/type_2/26'  -d '\n{\n   \"num\" : 27,\n   \"text\" : \"foo baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_1/27'  -d '\n{\n   \"num\" : 28,\n   \"text\" : \"foo baz\"\n}\n'\ncurl -s -XPUT 'http://127.0.0.2:9200/es_test_2/type_2/28'  -d '\n{\n   \"num\" : 29,\n   \"text\" : \"foo baz\"\n}\n'\ncurl -s -XPOST 'http://127.0.0.2:9200/_flush?refresh=true' \ncurl -XGET 'http://127.0.0.2:9200/_all/_search?pretty=true'  -d '\n{\n   \"query\" : {\n      \"term\" : {\n         \"text\" : \"foo\"\n      }\n   },\n   \"facets\" : {\n      \"bazFacet\" : {\n         \"query\" : {\n            \"term\" : {\n               \"text\" : \"baz\"\n            }\n         }\n      }\n   }\n}\n'\n```\n","performed_via_github_app":null}]