{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14555","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14555/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14555/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14555/events","html_url":"https://github.com/elastic/elasticsearch/issues/14555","id":115264379,"node_id":"MDU6SXNzdWUxMTUyNjQzNzk=","number":14555,"title":"Elasticsearch lat/lon to geohash conversion issue","user":{"login":"Shamanoid","id":4558252,"node_id":"MDQ6VXNlcjQ1NTgyNTI=","avatar_url":"https://avatars1.githubusercontent.com/u/4558252?v=4","gravatar_id":"","url":"https://api.github.com/users/Shamanoid","html_url":"https://github.com/Shamanoid","followers_url":"https://api.github.com/users/Shamanoid/followers","following_url":"https://api.github.com/users/Shamanoid/following{/other_user}","gists_url":"https://api.github.com/users/Shamanoid/gists{/gist_id}","starred_url":"https://api.github.com/users/Shamanoid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shamanoid/subscriptions","organizations_url":"https://api.github.com/users/Shamanoid/orgs","repos_url":"https://api.github.com/users/Shamanoid/repos","events_url":"https://api.github.com/users/Shamanoid/events{/privacy}","received_events_url":"https://api.github.com/users/Shamanoid/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-11-05T11:24:35Z","updated_at":"2015-11-05T16:47:46Z","closed_at":"2015-11-05T16:47:46Z","author_association":"NONE","active_lock_reason":null,"body":"ES:\n\n``` json\n\"version\" : {\n    \"number\" : \"1.5.2\",\n    \"build_hash\" : \"62ff9868b4c8a0c45860bebb259e21980778ab1c\",\n    \"build_timestamp\" : \"2015-04-27T09:21:06Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  }\n```\n\nLogstash:1.4.2\n\nWe do receive location as a string in our logs (JSON formatted) as `\"appLocation\":\"51.506411,-0.08811\"`\n- Logstash script :\n\n```\nruby {\n      code => \"event['geoip.location'] = event['appLocation'].split(',').map(&:to_f)\"\n    }\n```\n- Kibana display data as well formatted geo_point :\n  Index settings tab :\n  `geoip.location     geo_point`\n  Discover tab :\n  `geoip.location = 51.506411, -0.08811`\n- Elasticsearch mapping :\n\n``` json\n\"geoip\"  : {\n           \"type\" : \"object\",\n             \"dynamic\": true,\n             \"properties\" : {\n               \"location\" : { \"type\" : \"geo_point\" }\n             }\n         }\n```\n- Elasticsearch document query returns :\n  `\"geoip.location\":[51.506411,-0.08811]`\n- On Kibana, visualize tile map :\n  Result when mouseover point : `{\"lat\": -0.08789, \"lon\": -0.17}`\n  Same result in all precisions\n  Point on the exact center of the map (?)\n\n`GET/`\n\n``` json\n{\n  \"size\": 0,\n  \"query\": {\n    \"filtered\": {\n      \"query\": {\n        \"query_string\": {\n          \"analyze_wildcard\": true,\n          \"query\": \"*\"\n        }\n      },\n      \"filter\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"range\": {\n                \"@timestamp\": {\n                  \"gte\": 1446572700000,\n                  \"lte\": 1446745560000\n                }\n              }\n            }\n          ],\n          \"must_not\": []\n        }\n      }\n    }\n  },\n  \"aggs\": {\n    \"2\": {\n      \"geohash_grid\": {\n        \"field\": \"geoip.location\",\n        \"precision\": 4\n      }\n    }\n  }\n}\n```\n\nReturns :\n\n``` json\n{\n  \"took\": 1,\n  \"timed_out\": false,\n  \"_shards\": {\n    \"total\": 5,\n    \"successful\": 5,\n    \"failed\": 0\n  },\n  \"hits\": {\n    \"total\": 1,\n    \"max_score\": 0,\n    \"hits\": []\n  },\n  \"aggregations\": {\n    \"2\": {\n      \"buckets\": [\n        {\n          \"key\": \"7zzz\",\n          \"doc_count\": 1\n        }\n      ]\n    }\n  }\n}\n```\n- Revert 7zzz => [-0.09,-0.18]\n","closed_by":{"login":"Shamanoid","id":4558252,"node_id":"MDQ6VXNlcjQ1NTgyNTI=","avatar_url":"https://avatars1.githubusercontent.com/u/4558252?v=4","gravatar_id":"","url":"https://api.github.com/users/Shamanoid","html_url":"https://github.com/Shamanoid","followers_url":"https://api.github.com/users/Shamanoid/followers","following_url":"https://api.github.com/users/Shamanoid/following{/other_user}","gists_url":"https://api.github.com/users/Shamanoid/gists{/gist_id}","starred_url":"https://api.github.com/users/Shamanoid/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shamanoid/subscriptions","organizations_url":"https://api.github.com/users/Shamanoid/orgs","repos_url":"https://api.github.com/users/Shamanoid/repos","events_url":"https://api.github.com/users/Shamanoid/events{/privacy}","received_events_url":"https://api.github.com/users/Shamanoid/received_events","type":"User","site_admin":false},"performed_via_github_app":null}