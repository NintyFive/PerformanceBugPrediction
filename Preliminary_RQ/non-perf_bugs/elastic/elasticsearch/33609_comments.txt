[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420358323","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420358323","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420358323,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDM1ODMyMw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-09-11T17:40:28Z","updated_at":"2018-09-11T17:40:28Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420428107","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420428107","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420428107,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDQyODEwNw==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2018-09-11T21:15:24Z","updated_at":"2018-09-11T21:15:24Z","author_association":"CONTRIBUTOR","body":"#30968 is supposed to address this sort of issue, although it's still not a great workaround, and I think in this case will end up with the synonym filter just being a no-op.\r\n\r\nI wonder if we should make it possible to specify an analyzer to use for the synonym token filter?  Mostly synonyms just need tokenization, with some light normalization (eg lowercasing) applied.  Trying to re-use the analysis chain up to the point that the synonym filter appears ends up causing all sorts of weird issues if anything complex is being done.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420432218","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420432218","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420432218,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDQzMjIxOA==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2018-09-11T21:30:07Z","updated_at":"2018-09-11T21:30:07Z","author_association":"CONTRIBUTOR","body":"Thinking about this some more, including a synonym filter within a condition or multiplex filter currently won't work at all, because SynonymTokenFilterFactory isn't completely set up in its constructor like other filters, and needs an additional method call to load its dictionaries.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420637573","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420637573","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420637573,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDYzNzU3Mw==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-09-12T12:55:13Z","updated_at":"2018-09-12T12:55:13Z","author_association":"CONTRIBUTOR","body":"> I wonder if we should make it possible to specify an analyzer to use for the synonym token filter?\r\n\r\n+1 this would help work around these issues in the rare cases when today's default behavior doesn't work.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420644549","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420644549","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420644549,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDY0NDU0OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-09-12T13:18:06Z","updated_at":"2018-09-12T13:18:06Z","author_association":"MEMBER","body":"> I wonder if we should make it possible to specify an analyzer to use for the synonym token filter?\r\n\r\nWouldn't this defeat the purpose of the change we made in 6x ? I agree with the fact that only light normalization should be applied to synonym but we also want to avoid the case where the analyzer that is used to build the synonym map is not compatible with the analyzer chain that is used by the field. If you put a `stemmer` before a synonym filter, any synonym rule *must* apply the same normalization beforehand otherwise we would miss synonyms. \r\nThe issue at play here is that the `synonym_filter` cannot be built if it contains rule where some terms are removed or expanded with variations (`keyword_repeat` with a `stemmer` for instance). \r\nThis is a limitation of the filter but it is also important to disambiguate expansions since otherwise we'd have weird cases to handle where the input and output have synonyms.\r\nAlso note that this example works fine if you set the `stemmer` *after* the `synonym_filter`. Maybe we can limit the filters that can appear before a synonym filter the same way we limit filters in the `normalizer` for `keyword` field ? This would be breaking and would limit what you can do with synonyms but at least it would be impossible to have an invalid chain with this rule in place.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420652454","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420652454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420652454,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDY1MjQ1NA==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2018-09-12T13:42:04Z","updated_at":"2018-09-12T13:42:04Z","author_association":"CONTRIBUTOR","body":">  If you put a stemmer before a synonym filter, any synonym rule must apply the same normalization beforehand otherwise we would miss synonyms.\r\n\r\nTrue, although I think the answer here is more \"don't put a stemmer before a synonym filter\".  Limiting what can appear before the synonym filter is tricky though - what do we do with custom tokenfilters, for example?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/420666145","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-420666145","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":420666145,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMDY2NjE0NQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2018-09-12T14:20:14Z","updated_at":"2018-09-12T14:20:14Z","author_association":"MEMBER","body":"> Also note that this example works fine if you set the `stemmer` _after_ the `synonym_filter`. Maybe we can limit the filters that can appear before a synonym filter the same way we limit filters in the `normalizer` for `keyword` field ?\r\n\r\nAs far as I understand some use cases though, it makes sense to put a stemmer _in front_ of a `synonym_filter`. Imagine you have the synonym rule `\"programmer => developer\"` and your input text is \"A lot of programmers are freaks\", you would want the synonym rule to match, so you would perform stemming before the synonym filter. If you were forced to put the stemmer afterwards, you would need to include all kinds of inflected word forms in the synonyms list, which I think is a practical issue. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/706343724","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-706343724","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":706343724,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNjM0MzcyNA==","user":{"login":"sanjusagare","id":53381400,"node_id":"MDQ6VXNlcjUzMzgxNDAw","avatar_url":"https://avatars3.githubusercontent.com/u/53381400?v=4","gravatar_id":"","url":"https://api.github.com/users/sanjusagare","html_url":"https://github.com/sanjusagare","followers_url":"https://api.github.com/users/sanjusagare/followers","following_url":"https://api.github.com/users/sanjusagare/following{/other_user}","gists_url":"https://api.github.com/users/sanjusagare/gists{/gist_id}","starred_url":"https://api.github.com/users/sanjusagare/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sanjusagare/subscriptions","organizations_url":"https://api.github.com/users/sanjusagare/orgs","repos_url":"https://api.github.com/users/sanjusagare/repos","events_url":"https://api.github.com/users/sanjusagare/events{/privacy}","received_events_url":"https://api.github.com/users/sanjusagare/received_events","type":"User","site_admin":false},"created_at":"2020-10-09T18:42:36Z","updated_at":"2020-10-09T18:42:36Z","author_association":"NONE","body":"> I recently saw an issue where an anlyzer chain was set up to perform some stemming on the input and then apply a synonym filter afterwards.\r\n> In order to also keep the unstemmed tokens in the output (and apply synonyms as well there if possible), a `keyword_repeat` filter was used, but\r\n> this already leads to errors on index creating because the synonyms in the filter are validated by running through the analysis chain:\r\n> \r\n> ```\r\n> PUT /index\r\n> {\r\n>   \"settings\": {\r\n>     \"analysis\": {\r\n>       \"filter\": {\r\n>         \"my_synonyms\": {\r\n>           \"type\": \"synonym\",\r\n>           \"synonyms\": [\r\n>             \"optimised => optimized\"\r\n>           ]\r\n>         },\r\n>         \"english_stop\": {\r\n>           \"type\": \"stop\",\r\n>           \"stopwords\": \"_english_\"\r\n>         },\r\n>         \"light_english_stemmer\": {\r\n>           \"type\": \"stemmer\",\r\n>           \"language\": \"light_english\"\r\n>         },\r\n>         \"english_possessive_stemmer\": {\r\n>           \"type\": \"stemmer\",\r\n>           \"language\": \"possessive_english\"\r\n>         }\r\n>       },\r\n>       \"analyzer\": {\r\n>         \"blogs_synonyms_analyzer\": {\r\n>           \"tokenizer\": \"standard\",\r\n>           \"filter\": [\r\n>             \"lowercase\",\r\n>             \"keyword_repeat\",\r\n>             \"light_english_stemmer\",\r\n>             \"my_synonyms\"\r\n>           ]\r\n>         }\r\n>       }\r\n>     }\r\n>   }\r\n> }\r\n> ```\r\n> \r\n> Gives:\r\n> \r\n> ```\r\n>     \"type\": \"illegal_argument_exception\",\r\n>     \"reason\": \"failed to build synonyms\",\r\n>     \"caused_by\": {\r\n>       \"type\": \"parse_exception\",\r\n>       \"reason\": \"Invalid synonym rule at line 1\",\r\n>       \"caused_by\": {\r\n>         \"type\": \"illegal_argument_exception\",\r\n>         \"reason\": \"term: optimised analyzed to a token (optimise) with position increment != 1 (got: 0)\"\r\n>       }\r\n>     }\r\n> ```\r\n> \r\n> I also tried using a `multipexer` like so, but that is running into similar issues:\r\n> \r\n> ```\r\n> PUT /index\r\n> {\r\n>   \"settings\": {\r\n>     \"analysis\": {\r\n>       \"filter\": {\r\n>         \"my_synonyms\": {\r\n>           \"type\": \"synonym\",\r\n>           \"synonyms\": [\r\n>             \"optimised => optimized\"\r\n>           ]\r\n>         },\r\n>         \"my_multiplexer\": {\r\n>           \"type\": \"multiplexer\",\r\n>           \"filters\": [\"light_english_stemmer\"]\r\n>         },\r\n>         \"english_stop\": {\r\n>           \"type\": \"stop\",\r\n>           \"stopwords\": \"_english_\"\r\n>         },\r\n>         \"light_english_stemmer\": {\r\n>           \"type\": \"stemmer\",\r\n>           \"language\": \"light_english\"\r\n>         },\r\n>         \"english_possessive_stemmer\": {\r\n>           \"type\": \"stemmer\",\r\n>           \"language\": \"possessive_english\"\r\n>         }\r\n>       },\r\n>       \"analyzer\": {\r\n>         \"blogs_synonyms_analyzer\": {\r\n>           \"tokenizer\": \"standard\",\r\n>           \"filter\": [\r\n>             \"lowercase\",\r\n>             \"my_multiplexer\",\r\n>             \"my_synonyms\"\r\n>             \r\n>           ]\r\n>         }\r\n>       }\r\n>     }\r\n>   }\r\n> }\r\n> ```\r\n> \r\n> I'm wondering if I'm using this the wrong way or if there are other ways to achieve similar effect.\r\n> Also I'm trying to understand what the position checks that are causing this rejection in `SynonymMap#analyze` are supposed to prevent\r\n> and if those checks could possibly be omitted for the case of the tokens generated by `keyword_repeat` or `multiplexer`.\r\n\r\nI am facing the same issue . did u get solution?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/706974704","html_url":"https://github.com/elastic/elasticsearch/issues/33609#issuecomment-706974704","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33609","id":706974704,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNjk3NDcwNA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2020-10-12T08:42:54Z","updated_at":"2020-10-12T08:43:05Z","author_association":"MEMBER","body":"@sanjusagare #33702 should have solved this. If you are having general questions or problems please use the support forums over at https://discuss.elastic.co. We prefer to use Github issues only for bug reports and feature requests, and we think it's more likely this is a question than a bug report and its better to continue the discussion there than on a closed issue.","performed_via_github_app":null}]