[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/412813592","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-412813592","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":412813592,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMjgxMzU5Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-08-14T09:35:34Z","updated_at":"2018-08-14T09:35:34Z","author_association":"CONTRIBUTOR","body":"Relates to https://github.com/elastic/elasticsearch/pull/29140","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/416295306","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-416295306","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":416295306,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNjI5NTMwNg==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2018-08-27T17:04:47Z","updated_at":"2018-08-27T17:04:47Z","author_association":"CONTRIBUTOR","body":"Another one!\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+matrix-java-periodic/ES_BUILD_JAVA=java10,ES_RUNTIME_JAVA=java11,nodes=virtual&&linux/263/console","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/416548692","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-416548692","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":416548692,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNjU0ODY5Mg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-08-28T11:22:10Z","updated_at":"2018-08-28T11:22:10Z","author_association":"MEMBER","body":"Here is a different test that failed with the same error: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.4+periodic/190/console ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/418688672","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-418688672","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":418688672,"node_id":"MDEyOklzc3VlQ29tbWVudDQxODY4ODY3Mg==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-09-05T10:55:22Z","updated_at":"2018-09-05T10:55:22Z","author_association":"CONTRIBUTOR","body":"Another one: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+matrix-java-periodic/ES_BUILD_JAVA=java10,ES_RUNTIME_JAVA=java8,nodes=virtual&&linux/280/consoleFull. I'll disable the test.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/425064830","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-425064830","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":425064830,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNTA2NDgzMA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-09-27T12:02:44Z","updated_at":"2018-09-27T12:03:02Z","author_association":"MEMBER","body":"I figured out where this is coming from but I'm not sure how to fix it.\r\n\r\nThe issue is, that `org.elasticsearch.gateway.MetaDataStateFormat#read` will create a new `SimpleFSDirectory` for the for the `_state` directory without holding any lock to the shard. If this happens after the shard directory is deleted in `org.elasticsearch.env.NodeEnvironment#deleteShardDirectoryUnderLock` but before the assertion that the path is gone is made, then the shard path exists again containing nothing but an empty `_state` directory and the assertion fails.\r\n\r\nI think ideally we should avoid creating the `_state` directory in `org.elasticsearch.gateway.MetaDataStateFormat#read` because it's a read only operation but since `FSDirectory` will always create its underlying path if it doesn't exist I'm not sure how to accomplish that (without adding additional locking).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/425068688","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-425068688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":425068688,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNTA2ODY4OA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-09-27T12:16:43Z","updated_at":"2018-09-27T12:16:43Z","author_association":"CONTRIBUTOR","body":"This is a long-standing and, unfortunately, complicated issue. The fix you propose was https://github.com/elastic/elasticsearch/pull/19338 and an alternative was https://github.com/elastic/elasticsearch/pull/29140 (and see linked issues there for further discussion) but neither of these fixes were satisfactory.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426577479","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-426577479","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":426577479,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjU3NzQ3OQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2018-10-03T09:55:26Z","updated_at":"2018-10-03T09:55:26Z","author_association":"CONTRIBUTOR","body":"A failure occurred in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+multijob-unix-compatibility/os=oraclelinux/38/console that suggests #34120 doesn't fix this in every case.\r\n\r\nThe error is this:\r\n\r\n```\r\n06:45:17 ERROR   0.76s J1 | IndicesLifecycleListenerIT.testIndexStateShardChanged <<< FAILURES!\r\n06:45:17    > Throwable #1: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=10795, name=elasticsearch[node_t0][clusterApplierService#updateTask][T#1], state=RUNNABLE, group=TGRP-IndicesLifecycleListenerIT]\r\n06:45:17    > \tat __randomizedtesting.SeedInfo.seed([A8D19CF9DD9EFD43:7E04533A46A0D37A]:0)\r\n06:45:17    > Caused by: java.lang.AssertionError: Paths exist that should have been deleted: [/var/lib/jenkins/workspace/elastic+elasticsearch+6.x+multijob-unix-compatibility/os/oraclelinux/server/build/testrun/integTest/J1/temp/org.elasticsearch.indices.IndicesLifecycleListenerIT_A8D19CF9DD9EFD43-001/tempDir-002/d1/nodes/0/indices/2HM7dFt2TTqo3nNIgS8seA/2, /var/lib/jenkins/workspace/elastic+elasticsearch+6.x+multijob-unix-compatibility/os/oraclelinux/server/build/testrun/integTest/J1/temp/org.elasticsearch.indices.IndicesLifecycleListenerIT_A8D19CF9DD9EFD43-001/tempDir-002/d0/nodes/0/indices/2HM7dFt2TTqo3nNIgS8seA/2]\r\n```\r\n\r\nLooking elsewhere in the log file it seems that `2HM7dFt2TTqo3nNIgS8seA/2` _is_ the state directory, as there are messages about `.../2HM7dFt2TTqo3nNIgS8seA/2/_state/state-1.st`.\r\n\r\nThe repro command for this failure was:\r\n\r\n```\r\n./gradlew :server:integTest \\\r\n  -Dtests.seed=A8D19CF9DD9EFD43 \\\r\n  -Dtests.class=org.elasticsearch.indices.IndicesLifecycleListenerIT \\\r\n  -Dtests.method=\"testIndexStateShardChanged\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=es-AR \\\r\n  -Dtests.timezone=America/Toronto \\\r\n  -Dcompiler.java=10 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nThis didn't reproduce locally.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426585094","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-426585094","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":426585094,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjU4NTA5NA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-03T10:23:09Z","updated_at":"2018-10-03T10:23:09Z","author_association":"CONTRIBUTOR","body":"It looks like #34120 hasn't been backported to 6.x yet. @original-brownbear could you take a look?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426588870","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-426588870","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":426588870,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjU4ODg3MA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-10-03T10:37:05Z","updated_at":"2018-10-03T10:37:05Z","author_association":"MEMBER","body":"@DaveCTurner yea sorry about that, will do either later today or tomorrow at the very latest (sorry public holiday here today and a little busy because of it :))","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426594664","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-426594664","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":426594664,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjU5NDY2NA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-10-03T10:59:07Z","updated_at":"2018-10-03T10:59:07Z","author_association":"CONTRIBUTOR","body":"Oh I forgot about the holiday there today. Enjoy your day off and don't worry about this, I'll try and take care of it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/431585646","html_url":"https://github.com/elastic/elasticsearch/issues/32686#issuecomment-431585646","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32686","id":431585646,"node_id":"MDEyOklzc3VlQ29tbWVudDQzMTU4NTY0Ng==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2018-10-20T14:16:33Z","updated_at":"2018-10-20T14:16:33Z","author_association":"MEMBER","body":"Closing this since the backporting was handling by @DaveCTurner (thanks for that! :)).","performed_via_github_app":null}]