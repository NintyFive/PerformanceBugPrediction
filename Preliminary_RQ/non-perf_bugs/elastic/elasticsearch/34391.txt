{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34391","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34391/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34391/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34391/events","html_url":"https://github.com/elastic/elasticsearch/issues/34391","id":369012964,"node_id":"MDU6SXNzdWUzNjkwMTI5NjQ=","number":34391,"title":"Rollup search ignores the \"format\" option in date_histogram","user":{"login":"kiju98","id":25359646,"node_id":"MDQ6VXNlcjI1MzU5NjQ2","avatar_url":"https://avatars2.githubusercontent.com/u/25359646?v=4","gravatar_id":"","url":"https://api.github.com/users/kiju98","html_url":"https://github.com/kiju98","followers_url":"https://api.github.com/users/kiju98/followers","following_url":"https://api.github.com/users/kiju98/following{/other_user}","gists_url":"https://api.github.com/users/kiju98/gists{/gist_id}","starred_url":"https://api.github.com/users/kiju98/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kiju98/subscriptions","organizations_url":"https://api.github.com/users/kiju98/orgs","repos_url":"https://api.github.com/users/kiju98/repos","events_url":"https://api.github.com/users/kiju98/events{/privacy}","received_events_url":"https://api.github.com/users/kiju98/received_events","type":"User","site_admin":false},"labels":[{"id":912843355,"node_id":"MDU6TGFiZWw5MTI4NDMzNTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Rollup","name":":Analytics/Rollup","color":"0e8a16","default":false,"description":"Turn fine-grained time-based data into coarser-grained data"},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-10-11T08:42:44Z","updated_at":"2018-10-18T16:12:18Z","closed_at":"2018-10-18T16:12:18Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): Version: 6.4.0, Build: default/tar/595516e/2018-08-17T23:18:47.308994Z, JVM: 1.8.0_162\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.0_162, Java HotSpot(TM) 64-Bit Server VM, 25.162-b12, Oracle Corporation\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Linux oss-elastic02 3.10.0-327.el7.x86_64 #1 SMP Thu Oct 29 17:29:29 EDT 2015 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI tried a rollup search but \"format\" option in date_histogram was ignored.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Prepare an index.\r\n```\r\nPUT stat\r\n{\r\n  \"mappings\": {\r\n    \"doc\": {\r\n      \"properties\": {\r\n        \"agent\": {\r\n          \"properties\": {\r\n            \"@timestamp\": {\r\n              \"type\": \"date\"\r\n            }\r\n          }\r\n        },\r\n        \"cpu\": {\r\n          \"properties\": {\r\n            \"idle\": {\r\n              \"properties\": {\r\n                \"pct\": {\r\n                  \"type\": \"float\"\r\n                }\r\n              }\r\n            },\r\n            \"iowait\": {\r\n              \"properties\": {\r\n                \"pct\": {\r\n                  \"type\": \"float\"\r\n                }\r\n              }\r\n            },\r\n            \"sys\": {\r\n              \"properties\": {\r\n                \"pct\": {\r\n                  \"type\": \"float\"\r\n                }\r\n              }\r\n            },\r\n            \"total\": {\r\n              \"properties\": {\r\n                \"pct\": {\r\n                  \"type\": \"scaled_float\",\r\n                  \"store\": true,\r\n                  \"scaling_factor\": 100\r\n                }\r\n              }\r\n            },\r\n            \"user\": {\r\n              \"properties\": {\r\n                \"pct\": {\r\n                  \"type\": \"float\"\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPUT stat/doc/1\r\n{\r\n  \"agent\": {\r\n    \"@timestamp\": \"2018-09-01T09:19:00.000Z\"\r\n  },\r\n  \"cpu\": {\r\n    \"total\": {\r\n      \"pct\": 11\r\n    },\r\n    \"iowait\": {\r\n      \"pct\": 0\r\n    },\r\n    \"sys\": {\r\n      \"pct\": 1\r\n    },\r\n    \"idle\": {\r\n      \"pct\": 88.6\r\n    },\r\n    \"user\": {\r\n      \"pct\": 10.5\r\n    }\r\n  }\r\n}\r\n```\r\n 2. Create and start a rollup job.\r\n```\r\nPUT _xpack/rollup/job/rollup-stat\r\n{\r\n  \"index_pattern\": \"stat\",\r\n  \"rollup_index\": \"rollup-stat\",\r\n  \"cron\": \"* * * * * ?\",\r\n  \"page_size\": 2000,\r\n  \"groups\": {\r\n    \"date_histogram\": {\r\n      \"interval\": \"1h\",\r\n      \"field\": \"agent.@timestamp\"\r\n    }\r\n  },\r\n  \"metrics\": [\r\n    {\r\n      \"field\": \"cpu.total.pct\",\r\n      \"metrics\": [\r\n        \"min\",\r\n        \"max\",\r\n        \"avg\"\r\n      ]\r\n    }\r\n  ]\r\n}\r\n\r\nPOST _xpack/rollup/job/rollup-stat/_start\r\n```\r\n 3. Run a rollup query\r\n```\r\nGET rollup-stat/_rollup_search\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"1day_val\": {\r\n      \"date_histogram\": {\r\n        \"field\": \"agent.@timestamp\",\r\n        \"interval\": \"1d\",\r\n        \"format\": \"yyyy-MM-dd\",\r\n        \"time_zone\": \"UTC\"\r\n      },\r\n      \"aggs\": {\r\n        \"cpu_day_max\": {\r\n          \"max\": {\r\n            \"field\": \"cpu.total.pct\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nand see the `format` option in the `date_histogram` aggregation was ignored as below:\r\n```\r\n{\r\n  \"took\": 2,\r\n  \"timed_out\": false,\r\n  \"terminated_early\": false,\r\n  \"_shards\": {\r\n    \"total\": 5,\r\n    \"successful\": 5,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 0,\r\n    \"max_score\": 0,\r\n    \"hits\": []\r\n  },\r\n  \"aggregations\": {\r\n    \"1day_val\": {\r\n      \"meta\": {},\r\n      \"buckets\": [\r\n        {\r\n          \"key_as_string\": \"2018-09-01T00:00:00.000Z\",\r\n          \"key\": 1535760000000,\r\n          \"doc_count\": 1,\r\n          \"cpu_day_max\": {\r\n            \"value\": 11\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\n\"key_as_string\" should be \"2018-09-01\".\r\n\r\n**Provide logs (if relevant)**:","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}