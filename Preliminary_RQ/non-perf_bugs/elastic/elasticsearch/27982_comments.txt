[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/353951865","html_url":"https://github.com/elastic/elasticsearch/issues/27982#issuecomment-353951865","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27982","id":353951865,"node_id":"MDEyOklzc3VlQ29tbWVudDM1Mzk1MTg2NQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-26T10:24:56Z","updated_at":"2017-12-26T10:24:56Z","author_association":"CONTRIBUTOR","body":"The numbers given by the `_stats` API are important, and reflect the distributed nature of an Elasticsearch cluster. A single search request from the user can result in queries against a large number of shards in the cluster, and this amplification factor is captured in the stats currently reported. Similarly, an indexing request from the user can result in the document being indexed on multiple shards, as determined by the number of replicas for the index in question.\r\n\r\nWe have issues like #14576 and #22199 open to improve the documentation of these numbers to reduce any confusion they may generate, and warmly welcome contributions in this area.\r\n\r\nCounting the number of requests as sent by the user effectively ignores this amplification and treats all requests as equal. I'm not sure that this is a meaningful number from Elasticsearch's point of view, and calculating it accurately is a pretty serious engineering challenge when you start to think about the failure modes of a distributed cluster.\r\n\r\nI'll raising this for a quick discussion with the wider team when we return from the Christmas break to see if there are any other comments.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/354415451","html_url":"https://github.com/elastic/elasticsearch/issues/27982#issuecomment-354415451","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27982","id":354415451,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NDQxNTQ1MQ==","user":{"login":"panffeng","id":6678670,"node_id":"MDQ6VXNlcjY2Nzg2NzA=","avatar_url":"https://avatars1.githubusercontent.com/u/6678670?v=4","gravatar_id":"","url":"https://api.github.com/users/panffeng","html_url":"https://github.com/panffeng","followers_url":"https://api.github.com/users/panffeng/followers","following_url":"https://api.github.com/users/panffeng/following{/other_user}","gists_url":"https://api.github.com/users/panffeng/gists{/gist_id}","starred_url":"https://api.github.com/users/panffeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/panffeng/subscriptions","organizations_url":"https://api.github.com/users/panffeng/orgs","repos_url":"https://api.github.com/users/panffeng/repos","events_url":"https://api.github.com/users/panffeng/events{/privacy}","received_events_url":"https://api.github.com/users/panffeng/received_events","type":"User","site_admin":false},"created_at":"2017-12-29T08:31:37Z","updated_at":"2017-12-29T08:31:37Z","author_association":"NONE","body":"Hi Dave,\r\n\r\nthanks a lot for your reply.\r\n\r\n_stats API are absolutely important for elasticsearch. They are essential to diagnosing, monitoring and operating elasticsearch clusters. The stats make perfect sense in the elasticsearch world.\r\n\r\nAccurate QPS from user's perspective should be implemented as a separate API from _stats API.\r\n\r\nThe gap between elasticsearch stats and user's stats widens when there are several elasticsearch clusters in different colos.  Traffics are distributed among clusters. Users only report application level QPS of indexing queries and searching queries. From application level, the _stats API is very difficult to interpret if there are shard numbers, replica numbers and multiple indices involved. It would be also very difficult to find skewed traffic load and to allocate accordingly computing resources.\r\n\r\nHigh availability of elasticsearch clusters covers most cases of node failures. Then the accurate QPS from user's perspective should be maintained by master nodes.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/354418335","html_url":"https://github.com/elastic/elasticsearch/issues/27982#issuecomment-354418335","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27982","id":354418335,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NDQxODMzNQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-29T08:59:50Z","updated_at":"2017-12-29T08:59:50Z","author_association":"CONTRIBUTOR","body":"> It would be also very difficult to find skewed traffic load and to allocate accordingly computing resources.\r\n\r\nFrom the point of view of Elasticsearch's resource needs, the numbers reported by the `_stats` API are what you should use to do this; an \"external\" request rate would not be the right thing to look at. From the point of view of your wider application it's possible that the \"external\" Elasticsearch request rate is currently a useful proxy for your resource needs, but even if that's true now I wouldn't expect it to be true as your application grows. I think you are looking for something like [APM](https://www.elastic.co/blog/elastic-apm-beta-released).\r\n\r\n>  the accurate QPS from user's perspective should be maintained by master nodes.\r\n\r\nTo work correctly this'd need the master node to be involved in each request, which would become too much of a bottleneck at scale to be viable.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/354423421","html_url":"https://github.com/elastic/elasticsearch/issues/27982#issuecomment-354423421","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27982","id":354423421,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NDQyMzQyMQ==","user":{"login":"panffeng","id":6678670,"node_id":"MDQ6VXNlcjY2Nzg2NzA=","avatar_url":"https://avatars1.githubusercontent.com/u/6678670?v=4","gravatar_id":"","url":"https://api.github.com/users/panffeng","html_url":"https://github.com/panffeng","followers_url":"https://api.github.com/users/panffeng/followers","following_url":"https://api.github.com/users/panffeng/following{/other_user}","gists_url":"https://api.github.com/users/panffeng/gists{/gist_id}","starred_url":"https://api.github.com/users/panffeng/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/panffeng/subscriptions","organizations_url":"https://api.github.com/users/panffeng/orgs","repos_url":"https://api.github.com/users/panffeng/repos","events_url":"https://api.github.com/users/panffeng/events{/privacy}","received_events_url":"https://api.github.com/users/panffeng/received_events","type":"User","site_admin":false},"created_at":"2017-12-29T09:45:59Z","updated_at":"2017-12-29T09:46:37Z","author_association":"NONE","body":"The accurate QPS should be maintained by coordinates nodes, data nodes. Then periodically, master nodes get a sum from those distributive stats. In case of node failures, it is possible to lose some counts for a time slot. Master node will not participate each request.\r\n\r\nWhen there are multiple clusters, a complex load-balancing strategy is applied. Typically queries are sent to the nearest clusters. As there is no direct way to ascertain the accurate QPS from user's perspective now, _stats API often complicates performance issues with traffic patterns and resource allocation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/355584629","html_url":"https://github.com/elastic/elasticsearch/issues/27982#issuecomment-355584629","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27982","id":355584629,"node_id":"MDEyOklzc3VlQ29tbWVudDM1NTU4NDYyOQ==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2018-01-05T15:38:13Z","updated_at":"2018-01-05T15:38:13Z","author_association":"CONTRIBUTOR","body":"We discussed this in Fix-it-Friday.\r\n\r\nOne suggestion was to use the [usage API](https://www.elastic.co/guide/en/elasticsearch/reference/6.1/cluster-nodes-usage.html) to count the number of times each node has serviced a search request. Since this is a per-node statistic, it does not suffer the consistency issues that we'd have to solve if we exposed this as a cluster-wide statistic instead.\r\n\r\nIt's clearly possible to calculate a cluster-wide QPS statistic using some kind of distributed counter as you describe, but it's complicated and lacks a strong enough justification for putting effort into it at the moment. In particular, your use case (load-balancing) should make its decisions in terms of the existing stats which represent the load on the clusters more accurately than a naive QPS statistic would do.","performed_via_github_app":null}]