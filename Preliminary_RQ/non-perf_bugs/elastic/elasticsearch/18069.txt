{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/18069","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18069/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18069/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18069/events","html_url":"https://github.com/elastic/elasticsearch/issues/18069","id":151864163,"node_id":"MDU6SXNzdWUxNTE4NjQxNjM=","number":18069,"title":"Append-only indices","user":{"login":"prog8","id":6692291,"node_id":"MDQ6VXNlcjY2OTIyOTE=","avatar_url":"https://avatars0.githubusercontent.com/u/6692291?v=4","gravatar_id":"","url":"https://api.github.com/users/prog8","html_url":"https://github.com/prog8","followers_url":"https://api.github.com/users/prog8/followers","following_url":"https://api.github.com/users/prog8/following{/other_user}","gists_url":"https://api.github.com/users/prog8/gists{/gist_id}","starred_url":"https://api.github.com/users/prog8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/prog8/subscriptions","organizations_url":"https://api.github.com/users/prog8/orgs","repos_url":"https://api.github.com/users/prog8/repos","events_url":"https://api.github.com/users/prog8/events{/privacy}","received_events_url":"https://api.github.com/users/prog8/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":17,"created_at":"2016-04-29T13:22:14Z","updated_at":"2016-12-22T08:02:51Z","closed_at":"2016-05-06T09:27:23Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\nElasticsearch currently doesn't have a parameter which switches indices in append only mode. This could be interesting from performance point of view.\n\nWe are dealing with a problem of limited ingestion rate in ES. We tried to focus on a couple of hot spots to resolve potential bottlenecks. One of them was DocValues merges for sparse fields, then after changing approach synchronous translog became a bottleneck. It even seems that contention problem is not negligible: https://github.com/elastic/elasticsearch/issues/18053. These are only a few places where we tried to find optimizations. While analyzing profiles in Java Mission Control it was hard to ignore the another major problem: versions lookup. See the image below.\n\n![selection_383](https://cloud.githubusercontent.com/assets/6692291/14913686/309efd74-0e05-11e6-9437-f0497a9bcaca.png)\n\nProfiler shows that versions lookups are taking up to 25% of CPU time. This is a lot. Of course one could say I am showing a very specific case because I am using tiny documents in tests. I think this is not exactly true. Elasticsearch stack is much focused on logs aggregation and recently also metrics (Logstash, Kibana, Marvel, Beats, ...). Most systems designed for metric or log aggregation indices are append-only. Of course ES is general purpose distributed search and analytics engine so document versions are really important ...  but in many cases append-only mode could be sufficient.\nOne of the major strengths of Lucene internally is that segments are append only. Why not to use this simple but powerful assumption on higher level? Not all ES use cases require concurrent update functionality in which versions control really matters. What if Elasticsearch indices are marked as append-only (on they are created. Indices have properties which cannot be changed after index is created (eg. number of shards). This could be another parameter which can be applied only on index creation.\n\nThe contention problem mentioned in https://github.com/elastic/elasticsearch/issues/18053 would also become less painful in append-only indices. Version lookup is inside synchronized block in InternalEngine#innerIndex. This means threads are in synchronized section for a longer time than needed (in case where versions are not needed).\n\nDuring tests we disabled versions control in Elasticsearch which brought us significant improvement in indexing speed. Look at the chart below. Indexing speed on the same indices (without removing old data - just changed ES version) increased by 50% only by removing a version control.\n\nMy test environment is not very powerful. Only 2 machines with 4 CPU cores each. Indices have only one replica.\n\nhttps://apps.sematext.com/spm-reports/s/ucSD8cuTRr\n![selection_397](https://cloud.githubusercontent.com/assets/6692291/14913721/59e14ad4-0e05-11e6-8a7b-ab88f398e625.png)\n\nI would really appreciate any feedback. Am I missing something obvious? Thanks\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}