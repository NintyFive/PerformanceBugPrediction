[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/202784682","html_url":"https://github.com/elastic/elasticsearch/issues/17355#issuecomment-202784682","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17355","id":202784682,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMjc4NDY4Mg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-03-29T08:57:01Z","updated_at":"2016-03-29T08:57:01Z","author_association":"MEMBER","body":"Something like this is possible, but not direct with the `top_hits` aggregation. You need to use an additional metric agg and tell the terms agg to sort by that: \n\n```\n \"aggregations\": {\n    \"spu_group\": {\n        \"aggregations\": {\n            \"sku_info\": {\n                \"top_hits\": {\n                    \"_source\": {\n                        \"include\": \"sku_id\",\n                        \"include\": \"amount\"\n                    }, \n                    \"size\": 1\n                },\n                \"top_hit\" : {\n                  \"max\": {\n                    \"field\": \"amount\"\n                  }\n                }\n            }\n        }, \n        \"terms\": {\n            \"field\": \"product_id\", \n            \"order\": {\n              \"top_hit\": \"desc\"\n            }, \n            \"size\": 12\n        }\n    }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/202832192","html_url":"https://github.com/elastic/elasticsearch/issues/17355#issuecomment-202832192","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17355","id":202832192,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMjgzMjE5Mg==","user":{"login":"q11112345","id":10358392,"node_id":"MDQ6VXNlcjEwMzU4Mzky","avatar_url":"https://avatars3.githubusercontent.com/u/10358392?v=4","gravatar_id":"","url":"https://api.github.com/users/q11112345","html_url":"https://github.com/q11112345","followers_url":"https://api.github.com/users/q11112345/followers","following_url":"https://api.github.com/users/q11112345/following{/other_user}","gists_url":"https://api.github.com/users/q11112345/gists{/gist_id}","starred_url":"https://api.github.com/users/q11112345/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/q11112345/subscriptions","organizations_url":"https://api.github.com/users/q11112345/orgs","repos_url":"https://api.github.com/users/q11112345/repos","events_url":"https://api.github.com/users/q11112345/events{/privacy}","received_events_url":"https://api.github.com/users/q11112345/received_events","type":"User","site_admin":false},"created_at":"2016-03-29T11:01:59Z","updated_at":"2016-03-29T11:01:59Z","author_association":"NONE","body":"this is what i do now.\nthe spu returned are different from the max amount and the top_hits \ni may have three sku: s1 s2 s3.\ntop_hits return s2,\nmax amount return s1,\nat last, the s2 shows up with order ordered by s1's amount.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/203350129","html_url":"https://github.com/elastic/elasticsearch/issues/17355#issuecomment-203350129","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17355","id":203350129,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMzM1MDEyOQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-03-30T09:43:27Z","updated_at":"2016-03-30T09:43:27Z","author_association":"MEMBER","body":"@q11112345 Yes, that makes sense. The `top_hits` agg sorts by score while the `max` agg selects the max based on the amount field. If you change the `max` agg to the highest score then I think things should work like you want it to be:\n\n```\n\"top_hit\" : {\n   \"max\": {\n      \"script\": \"_score\"\n   }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/203616166","html_url":"https://github.com/elastic/elasticsearch/issues/17355#issuecomment-203616166","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17355","id":203616166,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMzYxNjE2Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-03-30T20:23:30Z","updated_at":"2016-03-30T20:23:30Z","author_association":"CONTRIBUTOR","body":"Looks like there's nothing more to do here.  Closing\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/203735044","html_url":"https://github.com/elastic/elasticsearch/issues/17355#issuecomment-203735044","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17355","id":203735044,"node_id":"MDEyOklzc3VlQ29tbWVudDIwMzczNTA0NA==","user":{"login":"q11112345","id":10358392,"node_id":"MDQ6VXNlcjEwMzU4Mzky","avatar_url":"https://avatars3.githubusercontent.com/u/10358392?v=4","gravatar_id":"","url":"https://api.github.com/users/q11112345","html_url":"https://github.com/q11112345","followers_url":"https://api.github.com/users/q11112345/followers","following_url":"https://api.github.com/users/q11112345/following{/other_user}","gists_url":"https://api.github.com/users/q11112345/gists{/gist_id}","starred_url":"https://api.github.com/users/q11112345/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/q11112345/subscriptions","organizations_url":"https://api.github.com/users/q11112345/orgs","repos_url":"https://api.github.com/users/q11112345/repos","events_url":"https://api.github.com/users/q11112345/events{/privacy}","received_events_url":"https://api.github.com/users/q11112345/received_events","type":"User","site_admin":false},"created_at":"2016-03-31T03:26:57Z","updated_at":"2016-03-31T03:28:12Z","author_association":"NONE","body":"@martijnvg  thanks very much.\ni do have problem.\nmy problem is : \n1 pick up one doc from bucket  by sorting by one field in top-hits, for example: pick up the doc with max score in bucket.\n\n```\n\"top_hits\" : {\n    \"_source\": {\n            \"include\": \"sku_id\",\n            \"include\": \"amount\"\n        }, \n  \"size\": 1\n}\n```\n\n2 then, sorting all buckets by another field of the doc which is picked up in \"top_hits\"\n\nhere i need sort buckets by doc field. and the field must be obtained from the top_hits.\ni cant find a way to make this work.\n\nthere is no way to use the field returned from top_hits as i know .\n\nmay i post this problem again?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/304798516","html_url":"https://github.com/elastic/elasticsearch/issues/17355#issuecomment-304798516","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17355","id":304798516,"node_id":"MDEyOklzc3VlQ29tbWVudDMwNDc5ODUxNg==","user":{"login":"sakthibalan15","id":10436463,"node_id":"MDQ6VXNlcjEwNDM2NDYz","avatar_url":"https://avatars1.githubusercontent.com/u/10436463?v=4","gravatar_id":"","url":"https://api.github.com/users/sakthibalan15","html_url":"https://github.com/sakthibalan15","followers_url":"https://api.github.com/users/sakthibalan15/followers","following_url":"https://api.github.com/users/sakthibalan15/following{/other_user}","gists_url":"https://api.github.com/users/sakthibalan15/gists{/gist_id}","starred_url":"https://api.github.com/users/sakthibalan15/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sakthibalan15/subscriptions","organizations_url":"https://api.github.com/users/sakthibalan15/orgs","repos_url":"https://api.github.com/users/sakthibalan15/repos","events_url":"https://api.github.com/users/sakthibalan15/events{/privacy}","received_events_url":"https://api.github.com/users/sakthibalan15/received_events","type":"User","site_admin":false},"created_at":"2017-05-30T07:34:49Z","updated_at":"2017-05-30T07:34:49Z","author_association":"NONE","body":"I have a problem with sorting aggregations on top fields.\r\n\r\n`aggs: { salary: {ranges: salary_ranges, score: 1}, company: {}, max_age: {ranges: age_ranges}, show_only: {order: {\"_term\" => \"desc\"}},  location: {}}`\r\n\r\nAfter the search I got sorting order are: 1. Max Age, 2. Show only, 3. Company, 4. Location, 5. Salary.\r\nBut I need the sorting order are: 1. Show only, 2. Location, 3. Salary, 4. Max age, 5. Company.","performed_via_github_app":null}]