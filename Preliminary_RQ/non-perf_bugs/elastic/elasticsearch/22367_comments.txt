[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269697139","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-269697139","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":269697139,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTY5NzEzOQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2016-12-29T21:35:35Z","updated_at":"2016-12-29T21:36:19Z","author_association":"MEMBER","body":"We already have a way to add response headers. See [`ThreadContext`](https://github.com/elastic/elasticsearch/blob/66fbb0dbc21f56e074981d1cfaaa9e7cf4676336/core/src/main/java/org/elasticsearch/common/util/concurrent/ThreadContext.java).\r\n\r\nHowever, it looks like we statically set the `ThreadContext` on the one current use (the deprecation logger). The impl of `RestChannel` has the `ThreadContext`, and gets the response headers from there. We could potentially add a method for adding response headers to `RestChannel`, make it an abstract class, and move the `ThreadContext` up to that, to delegate to for the addResponseHeader method. @s1monw @javanna wdyt?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/269893893","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-269893893","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":269893893,"node_id":"MDEyOklzc3VlQ29tbWVudDI2OTg5Mzg5Mw==","user":{"login":"sscarduzio","id":1327189,"node_id":"MDQ6VXNlcjEzMjcxODk=","avatar_url":"https://avatars3.githubusercontent.com/u/1327189?v=4","gravatar_id":"","url":"https://api.github.com/users/sscarduzio","html_url":"https://github.com/sscarduzio","followers_url":"https://api.github.com/users/sscarduzio/followers","following_url":"https://api.github.com/users/sscarduzio/following{/other_user}","gists_url":"https://api.github.com/users/sscarduzio/gists{/gist_id}","starred_url":"https://api.github.com/users/sscarduzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sscarduzio/subscriptions","organizations_url":"https://api.github.com/users/sscarduzio/orgs","repos_url":"https://api.github.com/users/sscarduzio/repos","events_url":"https://api.github.com/users/sscarduzio/events{/privacy}","received_events_url":"https://api.github.com/users/sscarduzio/received_events","type":"User","site_admin":false},"created_at":"2017-01-01T06:43:16Z","updated_at":"2017-01-01T06:43:16Z","author_association":"CONTRIBUTOR","body":"@rjernst I agree that DeprecationLogger.java is a curious place to initialise the context that will be used all across the framework.\r\n\r\nI reiterate on the need to enable plugin developers to either get an instance of ThreadContext or have some methods to get/set response headers from (for example) RestChannel.\r\n\r\nAs for now, implementing `BaseRestHandler` in my plugin I cannot access ThreadContext instance.\r\n\r\n**PS**: Well I might, but by reflection on `channel.delegate.threadContext` in the `RestFilter.process(RestRequest request, RestChannel channel, NodeClient client, RestFilterChain filterChain)` method. But it's not what I should find myself doing :/","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270077134","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270077134","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270077134,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDA3NzEzNA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T09:35:29Z","updated_at":"2017-01-03T09:35:29Z","author_association":"CONTRIBUTOR","body":"I don't understand the problem here to be honest. There is no such method `BaseRestHandler#process` neither in 2.x nor in 5.x nor in master. In all versions you have a handle method where you handle the request and send back a response. `RestResponse#addHeader(String name, String value)` has everything you need no?\r\n\r\nCan you maybe share some code where you would like to set the header?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270091813","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270091813","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270091813,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDA5MTgxMw==","user":{"login":"sscarduzio","id":1327189,"node_id":"MDQ6VXNlcjEzMjcxODk=","avatar_url":"https://avatars3.githubusercontent.com/u/1327189?v=4","gravatar_id":"","url":"https://api.github.com/users/sscarduzio","html_url":"https://github.com/sscarduzio","followers_url":"https://api.github.com/users/sscarduzio/followers","following_url":"https://api.github.com/users/sscarduzio/following{/other_user}","gists_url":"https://api.github.com/users/sscarduzio/gists{/gist_id}","starred_url":"https://api.github.com/users/sscarduzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sscarduzio/subscriptions","organizations_url":"https://api.github.com/users/sscarduzio/orgs","repos_url":"https://api.github.com/users/sscarduzio/repos","events_url":"https://api.github.com/users/sscarduzio/events{/privacy}","received_events_url":"https://api.github.com/users/sscarduzio/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T11:02:53Z","updated_at":"2017-01-03T11:02:53Z","author_association":"CONTRIBUTOR","body":"Hi @s1monw thanks for answering! You're right, the process method was in it was `RestFilter` which I anonymously instantiated from my impl of `BaseRestHandler`.\r\n\r\nNevertheless, I still would like to know if there is a way to inject a header in the RestResponse without creating a new `RestResponse` object. I.e. from `RestFilter#process`?\r\n\r\nHere's the code example required: https://github.com/sscarduzio/elasticsearch-readonlyrest-plugin/blob/master/src/main/java/org/elasticsearch/plugin/readonlyrest/wiring/ReadonlyRestRestAction.java#L44\r\n\r\nOnce again, I don't intend to create the response object myself, I just want to inject an extra header on whatever response will come back from ES.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270141480","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270141480","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270141480,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDE0MTQ4MA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T15:35:28Z","updated_at":"2017-01-03T15:35:28Z","author_association":"CONTRIBUTOR","body":"@sscarduzio note we removed `RestController#registerFilter` for several reasons in the upcoming 5.2 since it can be very trappy and potentially bypass security. You should instead implement `ActionPlugin` in 5.2 and implement `UnaryOperator<RestHandler> getRestHandlerWrapper(ThreadContext threadContext)` then you can use the thread context to add a response header and you will be fine. would that help in your case?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270168818","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270168818","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270168818,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDE2ODgxOA==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T17:19:33Z","updated_at":"2017-01-03T17:19:33Z","author_association":"MEMBER","body":"I missed the part about `process`. Simon is right in everything he has said. Note that implementing `getRestHandlerWrapper` means your plugin cannot work alongside `x-pack` (only one plugin may implement this). @sscarduzio you are trying to add a response header with every rest request, not some custom rest handler you are adding?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270178563","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270178563","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270178563,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDE3ODU2Mw==","user":{"login":"sscarduzio","id":1327189,"node_id":"MDQ6VXNlcjEzMjcxODk=","avatar_url":"https://avatars3.githubusercontent.com/u/1327189?v=4","gravatar_id":"","url":"https://api.github.com/users/sscarduzio","html_url":"https://github.com/sscarduzio","followers_url":"https://api.github.com/users/sscarduzio/followers","following_url":"https://api.github.com/users/sscarduzio/following{/other_user}","gists_url":"https://api.github.com/users/sscarduzio/gists{/gist_id}","starred_url":"https://api.github.com/users/sscarduzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sscarduzio/subscriptions","organizations_url":"https://api.github.com/users/sscarduzio/orgs","repos_url":"https://api.github.com/users/sscarduzio/repos","events_url":"https://api.github.com/users/sscarduzio/events{/privacy}","received_events_url":"https://api.github.com/users/sscarduzio/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T17:59:08Z","updated_at":"2017-01-03T17:59:08Z","author_association":"CONTRIBUTOR","body":"@rjernst, my code needs to set a response header (Set-Cookie) *IF* a certain header is present in the request. I'm super open on how this is going to happen.\r\nNo problem for x-pack compatibility.\r\n\r\nBTW: 5.2.x is not out, so it's unpractical to test the proposed solution with`getRestHandlerWrapper`. Also this implicitly means that in order to support 5.1.x I need reflection. Right?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270202782","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270202782","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270202782,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDIwMjc4Mg==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T19:35:10Z","updated_at":"2017-01-03T19:35:10Z","author_association":"MEMBER","body":"> 5.2.x is not out, so it's unpractical to test the proposed solution with `getRestHandlerWrapper`\r\n\r\nWe publish snapshots to maven central, so you can test with that.\r\n\r\n> Also this implicitly means that in order to support 5.1.x I need reflection. Right?\r\n\r\nNo, as it is not currently possible to have a single artifact that works for multiple versions of elasticsearch. Each plugin must be built specifically for a version of elasticsearch.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270245644","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270245644","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270245644,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDI0NTY0NA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-03T22:37:18Z","updated_at":"2017-01-03T22:37:18Z","author_association":"CONTRIBUTOR","body":"for 5.1.x I'd just do \r\n```JAVA\r\npublic ReadonlyRestRestAction(Settings settings, RestController controller, ThreadPool pool) {\r\n  ThreadContext context = pool.getThreadContext();\r\n  // now you can use the context to set your headers\r\n}\r\n\r\n```\r\n\r\nmakes sense?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/270620169","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-270620169","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":270620169,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MDYyMDE2OQ==","user":{"login":"sscarduzio","id":1327189,"node_id":"MDQ6VXNlcjEzMjcxODk=","avatar_url":"https://avatars3.githubusercontent.com/u/1327189?v=4","gravatar_id":"","url":"https://api.github.com/users/sscarduzio","html_url":"https://github.com/sscarduzio","followers_url":"https://api.github.com/users/sscarduzio/followers","following_url":"https://api.github.com/users/sscarduzio/following{/other_user}","gists_url":"https://api.github.com/users/sscarduzio/gists{/gist_id}","starred_url":"https://api.github.com/users/sscarduzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sscarduzio/subscriptions","organizations_url":"https://api.github.com/users/sscarduzio/orgs","repos_url":"https://api.github.com/users/sscarduzio/repos","events_url":"https://api.github.com/users/sscarduzio/events{/privacy}","received_events_url":"https://api.github.com/users/sscarduzio/received_events","type":"User","site_admin":false},"created_at":"2017-01-05T11:08:36Z","updated_at":"2017-01-05T11:09:02Z","author_association":"CONTRIBUTOR","body":"Thank you @s1monw this is exactly what I was looking for, I just didn't think about using DI for making the thread pool just appear from thin air 👍 \r\n\r\n@rjernst: sure I'm making different builds for different ES versions, I was referring to the fact that the code backing the 5.1 build needed to be different, as the `getRestHandlerWrapper` is not yet available.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/271518178","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-271518178","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":271518178,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MTUxODE3OA==","user":{"login":"sscarduzio","id":1327189,"node_id":"MDQ6VXNlcjEzMjcxODk=","avatar_url":"https://avatars3.githubusercontent.com/u/1327189?v=4","gravatar_id":"","url":"https://api.github.com/users/sscarduzio","html_url":"https://github.com/sscarduzio","followers_url":"https://api.github.com/users/sscarduzio/followers","following_url":"https://api.github.com/users/sscarduzio/following{/other_user}","gists_url":"https://api.github.com/users/sscarduzio/gists{/gist_id}","starred_url":"https://api.github.com/users/sscarduzio/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sscarduzio/subscriptions","organizations_url":"https://api.github.com/users/sscarduzio/orgs","repos_url":"https://api.github.com/users/sscarduzio/repos","events_url":"https://api.github.com/users/sscarduzio/events{/privacy}","received_events_url":"https://api.github.com/users/sscarduzio/received_events","type":"User","site_admin":false},"created_at":"2017-01-10T08:46:18Z","updated_at":"2017-01-10T08:46:18Z","author_association":"CONTRIBUTOR","body":"Hey, is there a solution to similarly set response headers in 2.x ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/272455270","html_url":"https://github.com/elastic/elasticsearch/issues/22367#issuecomment-272455270","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22367","id":272455270,"node_id":"MDEyOklzc3VlQ29tbWVudDI3MjQ1NTI3MA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-01-13T14:28:24Z","updated_at":"2017-01-13T14:28:24Z","author_association":"CONTRIBUTOR","body":"I am closing this for now since there is a solution","performed_via_github_app":null}]