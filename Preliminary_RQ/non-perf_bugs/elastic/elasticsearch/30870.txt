{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30870","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30870/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30870/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30870/events","html_url":"https://github.com/elastic/elasticsearch/issues/30870","id":326538998,"node_id":"MDU6SXNzdWUzMjY1Mzg5OTg=","number":30870,"title":"testThatEmailAttachmentsAreSent failed due to internal cluster not forming","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912845062,"node_id":"MDU6TGFiZWw5MTI4NDUwNjI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Watcher","name":":Core/Features/Watcher","color":"0e8a16","default":false,"description":""},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1009148120,"node_id":"MDU6TGFiZWwxMDA5MTQ4MTIw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.1","name":"v6.4.1","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},"assignees":[{"login":"hub-cap","id":613352,"node_id":"MDQ6VXNlcjYxMzM1Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/613352?v=4","gravatar_id":"","url":"https://api.github.com/users/hub-cap","html_url":"https://github.com/hub-cap","followers_url":"https://api.github.com/users/hub-cap/followers","following_url":"https://api.github.com/users/hub-cap/following{/other_user}","gists_url":"https://api.github.com/users/hub-cap/gists{/gist_id}","starred_url":"https://api.github.com/users/hub-cap/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hub-cap/subscriptions","organizations_url":"https://api.github.com/users/hub-cap/orgs","repos_url":"https://api.github.com/users/hub-cap/repos","events_url":"https://api.github.com/users/hub-cap/events{/privacy}","received_events_url":"https://api.github.com/users/hub-cap/received_events","type":"User","site_admin":false},{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-05-25T14:08:16Z","updated_at":"2019-10-08T15:56:59Z","closed_at":"2019-10-08T15:56:59Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"This failed in https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+periodic/2063/console\r\n\r\nThe repro command is:\r\n\r\n```\r\n./gradlew :x-pack:plugin:watcher:test   -Dtests.seed=81BB68C492DD47D6   -Dtests.class=org.elasticsearch.xpack.watcher.actions.email.EmailAttachmentTests   -Dtests.method=\"testThatEmailAttachmentsAreSent\"   -Dtests.security.manager=true   -Dtests.locale=mk   -Dtests.timezone=Etc/UCT\r\n```\r\n\r\nThis did not reproduce locally for me.\r\n\r\nThe cause of the failure is not in the actual test code, but in the formation of the internal test cluster:\r\n\r\n```\r\n   > Throwable #1: java.lang.IllegalStateException: cluster failed to form with expected nodes [{node_s2}{FikzomkMTTueLareWsmHlQ}{AjalmjLQQReu3dFLp3FG9w}{127.0.0.1}{127.0.0.1:46204}{xpack.installed=true}, {node_s0}{qExd_lljQ_a26sqD6YRnvQ}{t7MyJIeFT8C7VX9Y3JR3Bw}{127.0.0.1}{127.0.0.1:42826}{xpack.installed=true}, {node_s1}{T-N7bqCeQwyFLg26owJxRw}{g5GAMmHqQHSHWLyjMu_q_g}{127.0.0.1}{127.0.0.1:37292}{xpack.installed=true}] and actual nodes nodes: \r\n   >    {node_s1}{T-N7bqCeQwyFLg26owJxRw}{g5GAMmHqQHSHWLyjMu_q_g}{127.0.0.1}{127.0.0.1:37292}{xpack.installed=true}, master\r\n   >    {node_s0}{qExd_lljQ_a26sqD6YRnvQ}{t7MyJIeFT8C7VX9Y3JR3Bw}{127.0.0.1}{127.0.0.1:42826}{xpack.installed=true}\r\n   > \tat __randomizedtesting.SeedInfo.seed([81BB68C492DD47D6:5FF1DE3DEDA219B7]:0)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.validateClusterFormed(InternalTestCluster.java:1084)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.validateClusterFormed(InternalTestCluster.java:1059)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.reset(InternalTestCluster.java:1051)\r\n   > \tat org.elasticsearch.test.InternalTestCluster.beforeTest(InternalTestCluster.java:973)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.beforeInternal(ESIntegTestCase.java:380)\r\n   > \tat org.elasticsearch.test.ESIntegTestCase.setupTestCluster(ESIntegTestCase.java:2067)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nFor some reason node_s2 did not join the cluster until the test had given up on it:\r\n\r\n```\r\n  1> [2018-05-25T12:24:49,797][INFO ][o.e.t.d.MockZenPing      ] [node_s2] pinging using mock zen ping\r\n  1> [2018-05-25T12:25:14,794][WARN ][o.e.n.Node               ] [node_s2] timed out while waiting for initial discovery state - timeout: 30s\r\n  1> [2018-05-25T12:25:14,795][INFO ][o.e.n.Node               ] [node_s2] started\r\n  1> [2018-05-25T12:25:44,851][INFO ][o.s.s.s.SMTPServer       ] SMTP server *:41967 stopping\r\n  1> [2018-05-25T12:25:52,165][INFO ][o.s.s.s.ServerThread     ] SMTP server *:41967 stopped\r\n  1> [2018-05-25T12:25:52,171][INFO ][o.e.x.w.a.e.EmailAttachmentTests] [#testThatEmailAttachmentsAreSent]: clearing watcher state\r\n  1> [2018-05-25T12:25:52,178][INFO ][o.e.x.w.a.e.EmailAttachmentTests] waiting to stop watcher, current states [Tuple [v1=node_s2, v2=STARTED]]\r\n  1> [2018-05-25T12:25:52,186][INFO ][o.e.x.w.WatcherService   ] [node_s0] stopping watch service, reason [watcher manually marked to shutdown by cluster state update]\r\n  1> [2018-05-25T12:25:52,190][INFO ][o.e.x.w.WatcherService   ] [node_s1] stopping watch service, reason [watcher manually marked to shutdown by cluster state update]\r\n  1> [2018-05-25T12:25:52,191][INFO ][o.e.c.s.MasterService    ] [node_s1] zen-disco-node-join, reason: added {{node_s2}{FikzomkMTTueLareWsmHlQ}{AjalmjLQQReu3dFLp3FG9w}{127.0.0.1}{127.0.0.1:46204}{xpack.installed=true},}\r\n  1> [2018-05-25T12:25:52,193][INFO ][o.e.c.s.ClusterApplierService] [node_s0] added {{node_s2}{FikzomkMTTueLareWsmHlQ}{AjalmjLQQReu3dFLp3FG9w}{127.0.0.1}{127.0.0.1:46204}{xpack.installed=true},}, reason: apply cluster state (from master [master {node_s1}{T-N7bqCeQwyFLg26owJxRw}{g5GAMmHqQHSHWLyjMu_q_g}{127.0.0.1}{127.0.0.1:37292}{xpack.installed=true} committed version [8]])\r\n```","closed_by":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"performed_via_github_app":null}