{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23393","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23393/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23393/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23393/events","html_url":"https://github.com/elastic/elasticsearch/issues/23393","id":210587846,"node_id":"MDU6SXNzdWUyMTA1ODc4NDY=","number":23393,"title":"Range query with dates not working properly on 2.0.2","user":{"login":"alissonsales","id":17289,"node_id":"MDQ6VXNlcjE3Mjg5","avatar_url":"https://avatars1.githubusercontent.com/u/17289?v=4","gravatar_id":"","url":"https://api.github.com/users/alissonsales","html_url":"https://github.com/alissonsales","followers_url":"https://api.github.com/users/alissonsales/followers","following_url":"https://api.github.com/users/alissonsales/following{/other_user}","gists_url":"https://api.github.com/users/alissonsales/gists{/gist_id}","starred_url":"https://api.github.com/users/alissonsales/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alissonsales/subscriptions","organizations_url":"https://api.github.com/users/alissonsales/orgs","repos_url":"https://api.github.com/users/alissonsales/repos","events_url":"https://api.github.com/users/alissonsales/events{/privacy}","received_events_url":"https://api.github.com/users/alissonsales/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2017-02-27T19:51:31Z","updated_at":"2017-02-27T20:24:03Z","closed_at":"2017-02-27T20:06:21Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 2.0.2\r\n\r\n**Plugins installed**: [head]\r\n\r\n**JVM version**:\r\n```\r\n# java -version\r\nopenjdk version \"1.8.0_111\"\r\nOpenJDK Runtime Environment (build 1.8.0_111-8u111-b14-2~bpo8+1-b14)\r\nOpenJDK 64-Bit Server VM (build 25.111-b14, mixed mode)\r\n```\r\n\r\n**OS version**: using docker for mac running official docker image elasticsearch:2.0 (adccd7124f26)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe range filter using dates without time is not behaving like expected.\r\n\r\nThe `lte` filter is not converting the date `2017-02-06` to `2017-02-06T23:59:59.999Z`.\r\n\r\nI've put on a script to reproduce the issue:\r\n\r\n```bash\r\n# test_date_query.sh\r\nbase_url=$1\r\n\r\ncurl \"${base_url}\"\r\necho \"\"\r\necho \"Removing index\"\r\ncurl -X DELETE \"$base_url/my_index\"\r\necho \"\"\r\n\r\necho \"Creating index and mapping\"\r\ncurl -X POST \"${base_url}/my_index\" -d '\r\n{\r\n  \"settings\": { \"number_of_shars\": \"1\", \"number_of_replicas\": \"1\" },\r\n  \"mappings\": {\r\n    \"user\": {\r\n      \"properties\": {\r\n        \"name\": { \"type\": \"string\" },\r\n        \"created_at\": {\"type\": \"date\", format: \"date_optional_time\" }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\necho \"\"\r\necho \"Add documents\"\r\ncurl -X PUT \"${base_url}/my_index/user/_bulk?refresh=true\" -d '\r\n{ \"index\": { \"_id\": \"1\"} }\r\n{ \"name\": \"John Doe\", \"created_at\": \"2017-02-05T12:30:45.123Z\" }\r\n{ \"index\": { \"_id\": \"2\"} }\r\n{ \"name\": \"The Man\", \"created_at\": \"2017-02-06T18:21:35.321Z\" }\r\n'\r\necho \"\"\r\necho \"Query\"\r\n\r\ncurl -X POST \"${base_url}/my_index/user/_search\" -d '\r\n{\r\n  \"explain\": true,\r\n  \"query\": {\r\n    \"range\": {\r\n      \"created_at\": {\r\n        \"gte\": \"2017-01-01\",\r\n        \"lte\": \"2017-02-06\"\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\necho \"\"\r\n```\r\n\r\n### Results on different versions of ES\r\n\r\n#### ES 1.7.6\r\n\r\n```\r\nbash test_date_query.sh http://localhost:9201\r\n{\r\n  \"status\" : 200,\r\n  \"name\" : \"Dr. John Grey\",\r\n  \"cluster_name\" : \"elasticsearch\",\r\n  \"version\" : {\r\n    \"number\" : \"1.7.6\",\r\n    \"build_hash\" : \"c730b59357f8ebc555286794dcd90b3411f517c9\",\r\n    \"build_timestamp\" : \"2016-11-18T15:21:16Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"4.10.4\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n\r\nRemoving index\r\n{\"acknowledged\":true}\r\nCreating index and mapping\r\n{\"acknowledged\":true}\r\nAdd documents\r\n{\"took\":199,\"errors\":false,\"items\":[{\"index\":{\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"1\",\"_version\":1,\"status\":201}},{\"index\":{\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"2\",\"_version\":1,\"status\":201}}]}\r\nQuery\r\n{\"took\":6,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":2,\"max_score\":1.0,\"hits\":[{\"_shard\":2,\"_node\":\"Y8zyM5_rQEeSxwIZN9UOCQ\",\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"1\",\"_score\":1.0,\"_source\":{ \"name\": \"John Doe\", \"created_at\": \"2017-02-05T12:30:45.123Z\" },\"_explanation\":{\"value\":1.0,\"description\":\"ConstantScore(created_at:[1483228800000 TO 1486425599999]), product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\"},{\"value\":1.0,\"description\":\"queryNorm\"}]}},{\"_shard\":3,\"_node\":\"Y8zyM5_rQEeSxwIZN9UOCQ\",\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"2\",\"_score\":1.0,\"_source\":{ \"name\": \"The Man\", \"created_at\": \"2017-02-06T18:21:35.321Z\" },\"_explanation\":{\"value\":1.0,\"description\":\"ConstantScore(created_at:[1483228800000 TO 1486425599999]), product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\"},{\"value\":1.0,\"description\":\"queryNorm\"}]}}]}}\r\n```\r\n\r\n#### ES 2.0.2\r\n\r\n```\r\nbash test_date_query.sh http://localhost:9200\r\n{\r\n  \"name\" : \"Windshear\",\r\n  \"cluster_name\" : \"elasticsearch\",\r\n  \"version\" : {\r\n    \"number\" : \"2.0.2\",\r\n    \"build_hash\" : \"6abf5d8e5b37c2735d8e2f110f9743c453f71e92\",\r\n    \"build_timestamp\" : \"2015-12-16T12:49:58Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"5.2.1\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n\r\nRemoving index\r\n{\"acknowledged\":true}\r\nCreating index and mapping\r\n{\"acknowledged\":true}\r\nAdd documents\r\n{\"took\":290,\"errors\":false,\"items\":[{\"index\":{\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"1\",\"_version\":1,\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"status\":201}},{\"index\":{\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"2\",\"_version\":1,\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"status\":201}}]}\r\nQuery\r\n{\"took\":4,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":1.0,\"hits\":[{\"_shard\":3,\"_node\":\"5q3xORWLTFGhduzSOuCwWg\",\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"1\",\"_score\":1.0,\"_source\":{ \"name\": \"John Doe\", \"created_at\": \"2017-02-05T12:30:45.123Z\" },\"_explanation\":{\"value\":1.0,\"description\":\"sum of:\",\"details\":[{\"value\":1.0,\"description\":\"created_at:[1483228800000 TO 1486339200000], product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\",\"details\":[]},{\"value\":1.0,\"description\":\"queryNorm\",\"details\":[]}]},{\"value\":0.0,\"description\":\"match on required clause, product of:\",\"details\":[{\"value\":0.0,\"description\":\"# clause\",\"details\":[]},{\"value\":1.0,\"description\":\"_type:user, product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\",\"details\":[]},{\"value\":1.0,\"description\":\"queryNorm\",\"details\":[]}]}]}]}}]}}\r\n```\r\n\r\n#### ES 2.4.4\r\n\r\n```\r\n$ bash test_date_query.sh http://localhost:9202\r\n{\r\n  \"name\" : \"Skull the Slayer\",\r\n  \"cluster_name\" : \"elasticsearch\",\r\n  \"cluster_uuid\" : \"0DQ9_A2sR5Gqcwqe4dO1lQ\",\r\n  \"version\" : {\r\n    \"number\" : \"2.4.4\",\r\n    \"build_hash\" : \"fcbb46dfd45562a9cf00c604b30849a6dec6b017\",\r\n    \"build_timestamp\" : \"2017-01-03T11:33:16Z\",\r\n    \"build_snapshot\" : false,\r\n    \"lucene_version\" : \"5.5.2\"\r\n  },\r\n  \"tagline\" : \"You Know, for Search\"\r\n}\r\n\r\nRemoving index\r\n{\"acknowledged\":true}\r\nCreating index and mapping\r\n{\"acknowledged\":true}\r\nAdd documents\r\n{\"took\":360,\"errors\":false,\"items\":[{\"index\":{\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"1\",\"_version\":1,\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"status\":201}},{\"index\":{\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"2\",\"_version\":1,\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"status\":201}}]}\r\nQuery\r\n{\"took\":8,\"timed_out\":false,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0},\"hits\":{\"total\":2,\"max_score\":1.0,\"hits\":[{\"_shard\":2,\"_node\":\"t3_6DM8RS3u01Igmn8hpmA\",\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"2\",\"_score\":1.0,\"_source\":{ \"name\": \"The Man\", \"created_at\": \"2017-02-06T18:21:35.321Z\" },\"_explanation\":{\"value\":1.0,\"description\":\"sum of:\",\"details\":[{\"value\":1.0,\"description\":\"created_at:[1483228800000 TO 1486425599999], product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\",\"details\":[]},{\"value\":1.0,\"description\":\"queryNorm\",\"details\":[]}]},{\"value\":0.0,\"description\":\"match on required clause, product of:\",\"details\":[{\"value\":0.0,\"description\":\"# clause\",\"details\":[]},{\"value\":1.0,\"description\":\"_type:user, product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\",\"details\":[]},{\"value\":1.0,\"description\":\"queryNorm\",\"details\":[]}]}]}]}},{\"_shard\":3,\"_node\":\"t3_6DM8RS3u01Igmn8hpmA\",\"_index\":\"my_index\",\"_type\":\"user\",\"_id\":\"1\",\"_score\":1.0,\"_source\":{ \"name\": \"John Doe\", \"created_at\": \"2017-02-05T12:30:45.123Z\" },\"_explanation\":{\"value\":1.0,\"description\":\"sum of:\",\"details\":[{\"value\":1.0,\"description\":\"created_at:[1483228800000 TO 1486425599999], product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\",\"details\":[]},{\"value\":1.0,\"description\":\"queryNorm\",\"details\":[]}]},{\"value\":0.0,\"description\":\"match on required clause, product of:\",\"details\":[{\"value\":0.0,\"description\":\"# clause\",\"details\":[]},{\"value\":1.0,\"description\":\"_type:user, product of:\",\"details\":[{\"value\":1.0,\"description\":\"boost\",\"details\":[]},{\"value\":1.0,\"description\":\"queryNorm\",\"details\":[]}]}]}]}}]}}\r\n```\r\n\r\nThe expected number of hits for this query is 2, but ES 2.0.2 is returning only 1.\r\n\r\n### Number of documents returned:\r\n\r\n1.7.6: 2\r\n2.0.2: 1\r\n2.4.4: 2\r\n\r\n### Ranges returned on explain:\r\n\r\n1.7.6: [1483228800000 TO 1486425599999]\r\n2.0.2: [1483228800000 TO 1486339200000]\r\n2.4.4: [1483228800000 TO 1486425599999]\r\n\r\nVersions 1.7.6 and 2.4.4 are converting the date used on the lte to \"end of the day\" time\r\n","closed_by":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"performed_via_github_app":null}