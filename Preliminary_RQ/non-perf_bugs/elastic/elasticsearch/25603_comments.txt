[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314041505","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-314041505","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":314041505,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDA0MTUwNQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-07-10T08:35:53Z","updated_at":"2017-07-10T08:35:53Z","author_association":"MEMBER","body":"Can you please provide more information that would help us to reproduce the problem you are facing? \r\nIt would help to get the exact query you are running (including the indices that are hit), how your data looks like, possibly the mapping and how your index process looks like.\r\n\r\nIdeally, can you provide a minimal example? Just a few documents that, if indexed, will exhibit the mentioned problem?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/314087819","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-314087819","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":314087819,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNDA4NzgxOQ==","user":{"login":"dannymurphygfk","id":29126089,"node_id":"MDQ6VXNlcjI5MTI2MDg5","avatar_url":"https://avatars1.githubusercontent.com/u/29126089?v=4","gravatar_id":"","url":"https://api.github.com/users/dannymurphygfk","html_url":"https://github.com/dannymurphygfk","followers_url":"https://api.github.com/users/dannymurphygfk/followers","following_url":"https://api.github.com/users/dannymurphygfk/following{/other_user}","gists_url":"https://api.github.com/users/dannymurphygfk/gists{/gist_id}","starred_url":"https://api.github.com/users/dannymurphygfk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dannymurphygfk/subscriptions","organizations_url":"https://api.github.com/users/dannymurphygfk/orgs","repos_url":"https://api.github.com/users/dannymurphygfk/repos","events_url":"https://api.github.com/users/dannymurphygfk/events{/privacy}","received_events_url":"https://api.github.com/users/dannymurphygfk/received_events","type":"User","site_admin":false},"created_at":"2017-07-10T12:13:34Z","updated_at":"2017-07-10T12:14:53Z","author_association":"NONE","body":"@cbuescher \r\nThats the problem, we are unable to reproduce it. \r\nThough we are worried it will occur again.\r\n\r\nWe were targeting 2 types in the query.. e.g.\r\nhttp://node01:9200/my_index/my_type,my_other_type/_search\r\n\r\nWhat we observed in the screen shots above was that it would randomly return incorrect totals for same query executed multiple times.\r\n\r\nWith the explain options set in the query we saw 1 particular node would always return the wrong totals so we restarted this node but the issue continued. \r\n\r\nOnly when we had restarted all nodes did the problem disappear.\r\n\r\nWe don't know if it was some corruption in the shards of 1 node or what.\r\nAs mentioned we didn't see the same issue using _msearch and _count apis with same query.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315721087","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-315721087","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":315721087,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTcyMTA4Nw==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T10:40:04Z","updated_at":"2017-07-17T10:40:04Z","author_association":"NONE","body":"@cbuescher \r\nWould you be able to suggest what additional information that we should collect, in order to be able to reproduce the error if we face the same issue again?   ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315724031","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-315724031","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":315724031,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTcyNDAzMQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T10:55:35Z","updated_at":"2017-07-17T10:55:35Z","author_association":"MEMBER","body":"As mentioned earlier, anything that helps reproducing this on our side: how does your data look look like, what mappings are you using, what's your ES setup, how do you index, how does the query look like that exibits this problem.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/315796289","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-315796289","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":315796289,"node_id":"MDEyOklzc3VlQ29tbWVudDMxNTc5NjI4OQ==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-07-17T15:54:26Z","updated_at":"2017-07-17T15:57:13Z","author_association":"NONE","body":"Information provided here would give you some idea about the query, mappings, data, indexing and ES setup and please note that the examples provided here have been greatly simplified. \r\n \r\nexample query :\r\nQuery listed below exhibited the issue while the problem was still there and same query is now producing the expected correct result (after rolling restart of the cluster resolved the issue) \r\n\r\nhttp://node01:9200/my_index/product/_search\r\n`{\r\n    \"size\": 10,\r\n    \"query\":  {\r\n        \"ids\": {\r\n            \"values\": [183307729]\r\n        }\r\n    }\r\n}`\r\n\r\nmappings for the type “product” :  \r\n[mapping.txt](https://github.com/elastic/elasticsearch/files/1153202/mapping.txt)\r\n\r\nHow data looks like: \r\n[product.txt](https://github.com/elastic/elasticsearch/files/1153183/product.txt) \r\n \r\nIndexing process and the ES setup:  \r\nelasticsearch.yml ([elasticsearch.txt](https://github.com/elastic/elasticsearch/files/1153209/elasticsearch.txt)) file attached here is from one of the nodes in the cluster of 9 nodes. \r\n\r\nIndexing to the cluster is performed using the HTTP bulk API with a default batch size of 1,000 items with a peak rate of around 2,000 per second.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/321467199","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-321467199","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":321467199,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMTQ2NzE5OQ==","user":{"login":"dannymurphygfk","id":29126089,"node_id":"MDQ6VXNlcjI5MTI2MDg5","avatar_url":"https://avatars1.githubusercontent.com/u/29126089?v=4","gravatar_id":"","url":"https://api.github.com/users/dannymurphygfk","html_url":"https://github.com/dannymurphygfk","followers_url":"https://api.github.com/users/dannymurphygfk/followers","following_url":"https://api.github.com/users/dannymurphygfk/following{/other_user}","gists_url":"https://api.github.com/users/dannymurphygfk/gists{/gist_id}","starred_url":"https://api.github.com/users/dannymurphygfk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dannymurphygfk/subscriptions","organizations_url":"https://api.github.com/users/dannymurphygfk/orgs","repos_url":"https://api.github.com/users/dannymurphygfk/repos","events_url":"https://api.github.com/users/dannymurphygfk/events{/privacy}","received_events_url":"https://api.github.com/users/dannymurphygfk/received_events","type":"User","site_admin":false},"created_at":"2017-08-10T06:53:21Z","updated_at":"2017-08-10T06:53:21Z","author_association":"NONE","body":"The issue has occurred again, after only 1 month of uptime.\r\n\r\n** Correction - _msearch does exhibit the same issue.\r\nWe use our userIds with the _msearch as the preference and while 1 might consistently work... another will consistently fail.\r\n\r\nAlso adding this preference to the _search query e.g. **/product/_search?preference=2906** results in 1 preference returning correct results consistently and another consistently failing.\r\n\r\nWe had to perform a rolling restart of all nodes again to fix the issue.\r\n\r\n@cbuescher Is there anything more we can check if/when it happens again ? APIs to find the shards a specific preference targets etc... to see if we can narrow down which shards/nodes are causing the issue ?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/322470509","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-322470509","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":322470509,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMjQ3MDUwOQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-08-15T13:48:39Z","updated_at":"2017-08-15T14:02:33Z","author_association":"MEMBER","body":"Sorry for the delay, just looking into this again, this seems really odd but hard to debug without reproduction. \r\nJust to clarify a bit: For a query like `{ \"size\": 10, \"query\": { \"ids\": { \"values\": [183307729] } } }` you would expect to get back exactly one document and a `total.hits` of 1? But you are getting more than that?\r\nIs the `ProductId` the same as the document id you index the main document with?\r\nWhen this happens, does it happen for all ids or just very few? As long as you don't restart, does the problem reproduce with that same id?\r\nWhat happens if instead of using the `ids` query or a terms query on the `_id` field you use the main document `ProductId`?  \r\n\r\nMy suspicion is this might have something to do with the nested documents and merging, but have no good idea so far what is happening or how to explain this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/322475859","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-322475859","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":322475859,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMjQ3NTg1OQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-08-15T14:05:38Z","updated_at":"2017-08-15T14:05:38Z","author_association":"MEMBER","body":"Another question I forgot to ask: What do you need the result of `hits.total` for? You mentioned `_count` as not exhitibing the same behaviour, is that still true as far as you know?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323021052","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-323021052","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":323021052,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzAyMTA1Mg==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-08-17T09:42:41Z","updated_at":"2017-08-17T09:42:41Z","author_association":"NONE","body":"Let me answer your questions in turn,\r\n\r\n1) Yes, for a query like { \"size\": 10, \"query\": { \"ids\": { \"values\": [183307729] } } } we expect to get back one document and hits.total of 1. But when this issue occurs we get an incorrect hits.total value.\r\nSometimes it returns 1 (which is correct value) other times a much higher value, this behaviour just feels like round-robin of shards.\r\n\r\n2) ProductId and the document _id are the same.\r\n\r\n3) When this happens the problem occurs for all ids we've randomly spot checked.\r\n\r\n4) We don't currently index the ProductId field.\r\n\r\n5) We use hits.total in side one of our web applications to make a business logic decision, _counts API still returns the correct count even when the incident occurs.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323082017","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-323082017","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":323082017,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzA4MjAxNw==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-08-17T13:59:26Z","updated_at":"2017-08-17T13:59:26Z","author_association":"MEMBER","body":"Thanks for the feedback, this is indeed a weird behaviour. Just a few follow up questions:\r\n\r\n* is the index you are running the query on maybe an old 2.x index or was it already created in 5.x\r\n* are all nodes running the same Elasticsearch version, so we can exclude serialization bugs?\r\n* Can you run the affected query using the [Validate API](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-validate.html) with the `explain` parameter set to true and post the output so we see the actual Lucene query that gets executed?\r\n* Concerning possible corruptions: this seems to be unlikely because they would normally persist even after a restart. It might still make sense to check for corruptions, but there is a command line tool in Lucene you can use to check.\r\nYou can run `java -cp lib/lucene-core-6.4.1.jar org.apache.lucene.index.CheckIndex -fast <Path-To-Index>` in your Elasticsearch home directory, where `Path-To-Index` would be absolute path to the index segments in your data directory, so usually something like `data/nodes/0/indices/<indexUUID>/<shardNo>/index/`. The indexUUI can be obtained running the `_cat/indices` endpoint, and you should try all available shards on that node and see if the tool detects any problems","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323085518","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-323085518","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":323085518,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzA4NTUxOA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-08-17T14:11:35Z","updated_at":"2017-09-06T10:45:41Z","author_association":"MEMBER","body":"One thing I forgot mentioning about `CheckIndex`: since its a very low level Lucene tool that comes without warranty, you should make a backup of your index before running it. More in the [JavaDocs](http://lucene.apache.org/core/6_4_1/core/org/apache/lucene/index/CheckIndex.html). ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323088662","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-323088662","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":323088662,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzA4ODY2Mg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-08-17T14:22:31Z","updated_at":"2017-08-17T14:22:31Z","author_association":"MEMBER","body":"I changed the titel to make the issue a bit more specific, still not sure if this is a bug or not but let's treat is as one for now.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323283460","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-323283460","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":323283460,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzI4MzQ2MA==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T07:40:44Z","updated_at":"2017-08-18T07:40:44Z","author_association":"NONE","body":"- No, we migrated from 1.X to 5.X using the _reindex API into new incidies.\r\n\r\n- All 9 nodes in the cluster are running 5.3.1\r\n\r\n- We will perform this test when the incident occurs again, it's happened twice in the last 7 days\r\n\r\n- Good information on on checking the corruption of the index, we'll give this a go after making a backup\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327205085","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327205085","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327205085,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzIwNTA4NQ==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-05T15:06:22Z","updated_at":"2017-09-05T15:06:22Z","author_association":"NONE","body":"Experiencing the same issue again,\r\n\r\nPlease see the queries and their results listed below. Would this information help ?\r\n**1)** \r\nhttp://node01:9200/my_index/my_product/_search?preference=3677\r\n{ \"size\": 10, \"query\":  {\"ids\": { \"values\": [105226165] }}}\r\n\t\r\nThis query consistently returns incorrect hits.total value.\r\n\t\r\n**2)** \r\nExecuting the same query using Validate API with the explain parameter set to true\r\n\r\nhttp://node01:9200/my_index/my_product/_validate/query?explain=true\r\n{\"query\": {\"ids\": { \"values\": [105226165] }} }\r\n\r\nResult:\r\n{\"valid\": true, \"_shards\": { \"total\": 1,\"successful\": 1,\"failed\": 0},\r\n   \"explanations\": [\r\n      {\r\n         \"index\": \"my_index\",\r\n         \"valid\": true,\r\n         \"explanation\": \"+_uid:my_product#105226165 #(#_type:my_product)\"\r\n      }]}\r\n\r\n**3)** \r\nExecuting the same query using Validate API with the explain parameter set to true and rewrite set to true\r\nhttp://node01:9200/my_index/my_product/_validate/query?explain=true&rewrite=true\r\n{\"query\": {\"ids\": { \"values\": [105226165] }}}\r\n\r\nResult:\t\r\n{\"valid\": true,\"_shards\": {\"total\": 1,\"successful\": 1,\"failed\": 0},\r\n\t   \"explanations\": [\r\n\t      {\r\n\t         \"index\": \"my_index\",\r\n\t         \"valid\": true,\r\n\t         \"explanation\": \"+ConstantScore(_uid:my_product#105226165) #(ConstantScore(_type:my_product))^0.0\"\r\n\t     }]}\r\n\t\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327257436","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327257436","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327257436,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzI1NzQzNg==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-05T18:09:00Z","updated_at":"2017-09-05T18:09:00Z","author_association":"MEMBER","body":"Hi,\r\nanother question that might narrow down my initial suspicion this might have something to do with the nested \"SellerProducts\" documents. For the above document in question (105226165), do you know if and how many nested document it currently has? Maybe it had some that got deleted? Does this number come close to the wrong \"total.hits\" you are seeing? This is a wild quess but since the querys run in the \"_uid\" field it might be worth trying to narrow things down here a little.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327407200","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327407200","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327407200,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzQwNzIwMA==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-06T08:02:44Z","updated_at":"2017-09-06T08:17:22Z","author_association":"NONE","body":"Thank you for your response,\r\n\r\nIt has multiple nested documents but hits.total and the number of nested documents are not the same.\r\nThese numbers are way off and doesn't come close (hits.total was 290 whereas the expected number was 1).  ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327419651","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327419651","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327419651,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzQxOTY1MQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-06T08:53:48Z","updated_at":"2017-09-06T08:53:48Z","author_association":"MEMBER","body":"@JagathJayasinghe thanks for your patience and bearing with me. I talked to @martijnvg who is more familiar with nested docs and we are still leaning in that direction with hypothesis of what might be wrong.\r\n\r\nA few more questions:\r\n* Do you do many deletes (or updates, delete by query for that matter) on the documents in the index? If yes, how frequent are they? \r\n* Just as a clarification: in the first mapping you attached you seem to have nested enabled (for \"SellerProducts\"), but in the query explain we don't see the clause that should exclude nested documents. This should be there in 5.3, so thats a bit odd for us to see. Also in the type is called `product` in the mapping that you shared, but in the validate request you query type `my_product`. Is that the same mapping?\r\n* What happens if you close and reopen the index instead of a restart if the problem occurs?\r\n\r\nSorry that we're still poking around in the dark a little on this, there's something fishy here but its hard to put the finger to it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327447805","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327447805","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327447805,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzQ0NzgwNQ==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-06T10:51:25Z","updated_at":"2017-09-06T10:51:25Z","author_association":"NONE","body":"- Yes, we do many deletes and updates\r\n\t  Updates per day - 20m updates across 2 indices.\r\n\t  Deletes per day -  high 100s / low 1000s. \r\n- Sorry that was my mistake, I should have used \"product\" type when simplifying for my reply\r\n- It maybe be possible for us to try closing/opening the index but it would require a maintenance window as there are several applications using the data that are not affected by the issue when it occurs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327451346","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327451346","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327451346,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzQ1MTM0Ng==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-06T11:09:04Z","updated_at":"2017-09-06T11:09:15Z","author_association":"MEMBER","body":"Thanks,\r\n\r\n> maybe be possible for us to try closing/opening the index but it would require a maintenance window as there are several\r\n\r\nokay, so that's not practical then, also this was only out of interest, no concrete hint in mind\r\n\r\nI talked to @jimczi in the meantime regarding the explain output you posted and he thinks it looks okay (the nested filter is omitted because there is a filter on _type). \r\nAnother thing to recheck, just to be sure: \r\n* you mentioned \"_count\" would work when you see this problem, did you also use the same \"preference\" parameter in the url that you are using for the search query where you the incorrect total.hits?\r\n* does restart solve the problem for a long time? We were thinking that a restart might just change the order of the replicas, so a different \"preference\" parameter might still hit the same replica that exhibits the problem? \r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/327470680","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-327470680","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":327470680,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNzQ3MDY4MA==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-06T12:40:21Z","updated_at":"2017-09-06T13:46:10Z","author_association":"NONE","body":"- With \"_count\" we didn't try using \"preference\" parameter.\r\n- Restarting solve the problem for 1-2 weeks. \r\n\r\nWhen the issue first happened we did use the _search_shards API with a successful call and an unsuccessful call of the same query in the hopes of identifying a faulty node/shard.\r\nWe thought we had identified the faulty node through the order they were listed in the responses. I think we restarted the first one that was out of order in the faulty call… but it didn’t fix the problem so we went and did a rolling restart of all nodes. Which we have been doing since.\r\n\r\nIs there some other APIs we should use to help us identify the nodes/shards a certain preference is targeting next time this happens ?\r\n\r\n\r\nThank you.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/328132571","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-328132571","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":328132571,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODEzMjU3MQ==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-08T15:18:04Z","updated_at":"2017-09-08T15:18:04Z","author_association":"MEMBER","body":"> When the issue first happened we did use the _search_shards API with a successful call and an unsuccessful call of the same query in the hopes of identifying a faulty node/shard.\r\n\r\nAs far as I can see, if you use `_search_shard` with a fixed `preference=XYZ` value you should get the node/shard that would be selected with preference first when you would run an actual search with that value. So if your `ids` query behaves weird with `preference=x` but works well with `preference=y`, that should tell you which shards on which nodes are used and check if restarting only those helps (at least for that id, docs with other ids might live on another shard). \r\n\r\nAlso setting `\"explain\" : true` in your search request should tell you `_shard` and `_node` for every hit, so if you use that with a good and a bad `preference` parameter then you probably see a difference.\r\n\r\nBtw. how many shards and replicas are configured for the index in question? I though I'd already asked that and assumed a \"standard\" setup but just rechecked and couldn't find anything.\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/328847262","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-328847262","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":328847262,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODg0NzI2Mg==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-12T13:06:37Z","updated_at":"2017-09-12T13:06:37Z","author_association":"NONE","body":"The issue has happened again.\r\nSo we ran our query with 2 preferences:\r\n \r\nPreference 2904 works and correctly returns \"total\": 1\r\n**Query**:\r\nPOST my_index/my_type%2Cmy_other_type/_search?preference=2904&explain=true\r\n{ \"query\": { \"ids\": { \"values\": [111637091] }}}\r\n**Response**: [Response.txt](https://github.com/elastic/elasticsearch/files/1296016/Response.txt)\r\n\r\nThe source has 43 nested documents or 1 type and 9 nested documents of another type.\r\n \r\nPreference 2906 fails and returns \"total\": 595\r\n**Query**:\r\nPOST my_index/my_type%2Cmy_other_type/_search?preference=2906&explain=true\r\n{\"query\": { \"ids\": {\"values\": [111637091] } }}\r\n **Response**: [Response.txt](https://github.com/elastic/elasticsearch/files/1296022/Response.txt)\r\n\r\nWe tried just restarting the node identified by the failed query but this did not fix the issue.\r\nWhile the node was recovering, the query switched to another node but once recovered it switched back to the original node but continued to fail.\r\nWe restarted the node it switched to and tried again… but it still failed… \r\nThen we restarted the final node with shard 0 and again it still failed…\r\nSo we restarted all nodes to clear the issue.\r\n\r\nPlease note that my_type and my_other_type used in this simplified query/response version are using same \"product\" mapping. \r\n\r\nThank you.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329441624","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-329441624","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":329441624,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTQ0MTYyNA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-14T10:29:39Z","updated_at":"2017-09-14T10:29:39Z","author_association":"MEMBER","body":"@JagathJayasinghe can you share how many shards and replicas are configured for the index in question? Apologies if this is already somewhere in the ticket, I couldn't find anything.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329446228","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-329446228","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":329446228,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTQ0NjIyOA==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-14T10:51:01Z","updated_at":"2017-09-14T10:51:01Z","author_association":"NONE","body":"There are 6 shards and 2 replicas.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/329514386","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-329514386","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":329514386,"node_id":"MDEyOklzc3VlQ29tbWVudDMyOTUxNDM4Ng==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-14T15:14:36Z","updated_at":"2017-09-14T15:14:36Z","author_association":"MEMBER","body":"Thanks, lets take a step back here.\r\nI didn't focus on the fact that you querying across two types so far, can you elaborate on this a bit more? This might come into play with the nested docs probably.\r\nAs far as I see in this issue, you have one index (here \"my_index\", probably different name in prod) and two types (\"my_type\", \"my_other_type\"). The mapping you provided in https://github.com/elastic/elasticsearch/issues/25603#issuecomment-315796289, that is the mapping for one type (\"product\").\r\n\r\n* Is the mapping for the other type the same? \r\n* Do the document you are querying for with the id are all of one type or are they different? Can there be the same document id on \"my_type\" and \"my_other_type\"?\r\n\r\n> The source has 43 nested documents or 1 type and 9 nested documents of another type.\r\n\r\n* Can you elaborate on what you mean by this? I assume this is one \"parent\" document with id \"111637091\", it is either of \"my_type\" or \"my_other_type\"? Do you know which? How can it have nested document under another type?\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/330148837","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-330148837","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":330148837,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMDE0ODgzNw==","user":{"login":"JagathJayasinghe","id":29983271,"node_id":"MDQ6VXNlcjI5OTgzMjcx","avatar_url":"https://avatars2.githubusercontent.com/u/29983271?v=4","gravatar_id":"","url":"https://api.github.com/users/JagathJayasinghe","html_url":"https://github.com/JagathJayasinghe","followers_url":"https://api.github.com/users/JagathJayasinghe/followers","following_url":"https://api.github.com/users/JagathJayasinghe/following{/other_user}","gists_url":"https://api.github.com/users/JagathJayasinghe/gists{/gist_id}","starred_url":"https://api.github.com/users/JagathJayasinghe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JagathJayasinghe/subscriptions","organizations_url":"https://api.github.com/users/JagathJayasinghe/orgs","repos_url":"https://api.github.com/users/JagathJayasinghe/repos","events_url":"https://api.github.com/users/JagathJayasinghe/events{/privacy}","received_events_url":"https://api.github.com/users/JagathJayasinghe/received_events","type":"User","site_admin":false},"created_at":"2017-09-18T07:44:36Z","updated_at":"2017-09-18T07:44:36Z","author_association":"NONE","body":"Thank you for the response. Please see explanations below in turn,\r\n \r\nYes, the mapping for both types is exactly the same.\r\nThe document Ids should be unique across both types.\r\n\r\nSo there are 43 nested documents of nestedType and 9 of otherNestedType\r\n\r\nYes, there is 1 parent document with id “111637091” in this case it is of type my_other_type.\r\nIt has 2 properties of nested documents:\r\n“nestedTypeProp”:{\r\n                “dynamic”: “false”,\r\n                “type”:”nested”\r\n                “properties”:{…}\r\n},\r\notherNestedTypeProp :{\r\n                “dynamic”: “false”,\r\n                “type”:”nested”\r\n                “properties”:{…}\r\n}\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331137608","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-331137608","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":331137608,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTEzNzYwOA==","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T12:10:48Z","updated_at":"2017-09-21T12:10:48Z","author_association":"CONTRIBUTOR","body":"`Preference 2906 fails and returns \"total\": 595\r\nQuery:\r\nPOST my_index/my_type%2Cmy_other_type/_search?preference=2906&explain=true\r\n{\"query\": { \"ids\": {\"values\": [111637091] } }}`\r\n\r\nwould you be able to run the query without the type filter  ie.:\r\n`POST my_index/_search?preference=2906&explain=true`\r\n\r\nand share the result?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331146722","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-331146722","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":331146722,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTE0NjcyMg==","user":{"login":"dannymurphygfk","id":29126089,"node_id":"MDQ6VXNlcjI5MTI2MDg5","avatar_url":"https://avatars1.githubusercontent.com/u/29126089?v=4","gravatar_id":"","url":"https://api.github.com/users/dannymurphygfk","html_url":"https://github.com/dannymurphygfk","followers_url":"https://api.github.com/users/dannymurphygfk/followers","following_url":"https://api.github.com/users/dannymurphygfk/following{/other_user}","gists_url":"https://api.github.com/users/dannymurphygfk/gists{/gist_id}","starred_url":"https://api.github.com/users/dannymurphygfk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dannymurphygfk/subscriptions","organizations_url":"https://api.github.com/users/dannymurphygfk/orgs","repos_url":"https://api.github.com/users/dannymurphygfk/repos","events_url":"https://api.github.com/users/dannymurphygfk/events{/privacy}","received_events_url":"https://api.github.com/users/dannymurphygfk/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T12:50:41Z","updated_at":"2017-09-21T12:57:18Z","author_association":"NONE","body":"Problem is this issue is not occurring at the moment on our production cluster but it just so happens that today I noticed we were experiencing the same issue on our Dev cluster so I have been playing with the various APIs to see if I can find out anything new.\r\nAgain querying for a single Id.\r\n\r\nRunning the query with the &explain=true only gives us the explanation of the node that successfully returned the 1 hit.\r\n[response.txt](https://github.com/elastic/elasticsearch/files/1321128/response.txt)\r\nWhether run with or without the type filters I was getting the same hits total of **598**.\r\n\r\nUsing the **?preference=_shards:n** parameter I ran the query against each of the 9 shards we have on 3 nodes in Dev individually.\r\nNode1 correctly returned 1 hit and total:1 for 1 of its shards and 0 hits and total:0 for the other shards on that node.\r\nNode2 returned no hits but totals of 95 for all of its 3 shards\r\nNode3 returned no hits but totals of 104 for all of its 3 shards\r\n\r\n(1) + (95 * 3) + (104 *3) => **598**\r\n\r\n\r\nAgain I tried the _count API but with the **?preference=_shards:n** for each individual shard and it still returns the correct counts for all shards.\r\n\r\nIs there something more we can try to find out whats going on in the 2 problem nodes we currently have in our Dev cluster ?\r\n\r\nIncidently our Dev cluster is running v5.2.2, whereas our LIVE cluster is v5.3.1\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331153310","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-331153310","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":331153310,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTE1MzMxMA==","user":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T13:17:23Z","updated_at":"2017-09-21T13:18:28Z","author_association":"MEMBER","body":"@dannymurphygfk, just to make sure, because @JagathJayasinghe  was talking about 6 shards and 2 replicas before, I assume this was production. How's the situation on the dev cluster that you mentioned now? How many of those 9 shards are primaries, how is their distribution over the three nodes? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/331155073","html_url":"https://github.com/elastic/elasticsearch/issues/25603#issuecomment-331155073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25603","id":331155073,"node_id":"MDEyOklzc3VlQ29tbWVudDMzMTE1NTA3Mw==","user":{"login":"dannymurphygfk","id":29126089,"node_id":"MDQ6VXNlcjI5MTI2MDg5","avatar_url":"https://avatars1.githubusercontent.com/u/29126089?v=4","gravatar_id":"","url":"https://api.github.com/users/dannymurphygfk","html_url":"https://github.com/dannymurphygfk","followers_url":"https://api.github.com/users/dannymurphygfk/followers","following_url":"https://api.github.com/users/dannymurphygfk/following{/other_user}","gists_url":"https://api.github.com/users/dannymurphygfk/gists{/gist_id}","starred_url":"https://api.github.com/users/dannymurphygfk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dannymurphygfk/subscriptions","organizations_url":"https://api.github.com/users/dannymurphygfk/orgs","repos_url":"https://api.github.com/users/dannymurphygfk/repos","events_url":"https://api.github.com/users/dannymurphygfk/events{/privacy}","received_events_url":"https://api.github.com/users/dannymurphygfk/received_events","type":"User","site_admin":false},"created_at":"2017-09-21T13:24:15Z","updated_at":"2017-09-21T13:24:15Z","author_association":"NONE","body":"@cbuescher Yes Jagath was talking about the Production Cluster.\r\nOur Dev cluster has 9 shards 0 replicas, 3 shards on each node.","performed_via_github_app":null}]