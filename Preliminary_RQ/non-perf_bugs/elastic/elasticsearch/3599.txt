{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3599","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3599/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3599/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3599/events","html_url":"https://github.com/elastic/elasticsearch/issues/3599","id":18781224,"node_id":"MDU6SXNzdWUxODc4MTIyNA==","number":3599,"title":"Error while sorting on fields which are not present for some of the documents","user":{"login":"avpet","id":3149604,"node_id":"MDQ6VXNlcjMxNDk2MDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/3149604?v=4","gravatar_id":"","url":"https://api.github.com/users/avpet","html_url":"https://github.com/avpet","followers_url":"https://api.github.com/users/avpet/followers","following_url":"https://api.github.com/users/avpet/following{/other_user}","gists_url":"https://api.github.com/users/avpet/gists{/gist_id}","starred_url":"https://api.github.com/users/avpet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/avpet/subscriptions","organizations_url":"https://api.github.com/users/avpet/orgs","repos_url":"https://api.github.com/users/avpet/repos","events_url":"https://api.github.com/users/avpet/events{/privacy}","received_events_url":"https://api.github.com/users/avpet/received_events","type":"User","site_admin":false},"labels":[{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2013-08-30T10:36:42Z","updated_at":"2015-04-07T13:02:38Z","closed_at":"2013-09-02T12:04:19Z","author_association":"NONE","active_lock_reason":null,"body":"This issue is experienced on version 0.90.3\nSearching in two indexes with sort on two fields - _subtype and fileSize. _subtype field is present for all indices, fileSize - is present only in the mapping of one index. 'ignore_unmapped' is set to true for both of the fields.  \n\n```\n{\n    \"sort\": [\n        {\n            \"_subtype\": {\n                \"order\": \"desc\",\n                \"ignore_unmapped\": true\n            }\n        },\n        {\n            \"fileSize\": {\n                \"order\": \"asc\",\n                \"ignore_unmapped\": true\n            }\n        }\n    ],\n\n    \"query\": {\n        \"query_string\": {\n            \"query\": \"_parents.$id:5223195f93f46463974aa1f4\"\n        }\n    }\n}\n```\n\nThe result for JSON search is:\n\n```\n{\n    error: ReduceSearchPhaseException[Failed to execute phase [query], [reduce] ]; nested: ArrayIndexOutOfBoundsException[1];\n    status: 500\n}\n```\n\nWhen searchhing with Java API:\n\n```\norg.elasticsearch.action.search.ReduceSearchPhaseException: Failed to execute phase [query], [reduce] \n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.executeFetchPhase(TransportSearchDfsQueryThenFetchAction.java:172) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction$3.onResult(TransportSearchDfsQueryThenFetchAction.java:150) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction$3.onResult(TransportSearchDfsQueryThenFetchAction.java:144) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteQuery(SearchServiceTransportAction.java:176) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.executeQuery(TransportSearchDfsQueryThenFetchAction.java:144) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction$2.run(TransportSearchDfsQueryThenFetchAction.java:131) ~[elasticsearch-0.90.3.jar:na]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) ~[na:1.7.0_25]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) ~[na:1.7.0_25]\n    at java.lang.Thread.run(Thread.java:724) ~[na:1.7.0_25]\nCaused by: java.lang.ArrayIndexOutOfBoundsException: 1\n    at org.elasticsearch.search.controller.ShardFieldDocSortedHitQueue.lessThan(ShardFieldDocSortedHitQueue.java:118) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.search.controller.ShardFieldDocSortedHitQueue.lessThan(ShardFieldDocSortedHitQueue.java:35) ~[elasticsearch-0.90.3.jar:na]\n    at org.apache.lucene.util.PriorityQueue.downHeap(PriorityQueue.java:247) ~[lucene-core-4.4.0.jar:4.4.0 1504776 - sarowe - 2013-07-19 02:53:42]\n    at org.apache.lucene.util.PriorityQueue.pop(PriorityQueue.java:184) ~[lucene-core-4.4.0.jar:4.4.0 1504776 - sarowe - 2013-07-19 02:53:42]\n    at org.elasticsearch.search.controller.SearchPhaseController.sortDocs(SearchPhaseController.java:281) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.innerExecuteFetchPhase(TransportSearchDfsQueryThenFetchAction.java:177) ~[elasticsearch-0.90.3.jar:na]\n    at org.elasticsearch.action.search.type.TransportSearchDfsQueryThenFetchAction$AsyncAction.executeFetchPhase(TransportSearchDfsQueryThenFetchAction.java:170) ~[elasticsearch-0.90.3.jar:na]\n    ... 8 common frames omitted\n```\n\nInteresting thing is that if I change fileSize field into some totally diffrerent field, which is not present in any index, for example fileSizeAAA, I do not get this error. If I omit one the _subtype field, and leave only fileSize field, then I get another error:\n\n```\n{\n\n    error: ReduceSearchPhaseException[Failed to execute phase [query], [reduce] ]; nested: ClassCastException[org.apache.lucene.search.ScoreDoc cannot be cast to org.apache.lucene.search.FieldDoc];\n    status: 503\n\n}\n```\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}