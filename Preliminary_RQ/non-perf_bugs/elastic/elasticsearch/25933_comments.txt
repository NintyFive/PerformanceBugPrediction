[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/318353128","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-318353128","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":318353128,"node_id":"MDEyOklzc3VlQ29tbWVudDMxODM1MzEyOA==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-07-27T12:54:10Z","updated_at":"2017-07-27T12:54:10Z","author_association":"MEMBER","body":"@aj7 It would be very helpful if you can create a minimal reproduction scenario (data + API calls / curl commands).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/318356637","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-318356637","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":318356637,"node_id":"MDEyOklzc3VlQ29tbWVudDMxODM1NjYzNw==","user":{"login":"aj7","id":136886,"node_id":"MDQ6VXNlcjEzNjg4Ng==","avatar_url":"https://avatars1.githubusercontent.com/u/136886?v=4","gravatar_id":"","url":"https://api.github.com/users/aj7","html_url":"https://github.com/aj7","followers_url":"https://api.github.com/users/aj7/followers","following_url":"https://api.github.com/users/aj7/following{/other_user}","gists_url":"https://api.github.com/users/aj7/gists{/gist_id}","starred_url":"https://api.github.com/users/aj7/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/aj7/subscriptions","organizations_url":"https://api.github.com/users/aj7/orgs","repos_url":"https://api.github.com/users/aj7/repos","events_url":"https://api.github.com/users/aj7/events{/privacy}","received_events_url":"https://api.github.com/users/aj7/received_events","type":"User","site_admin":false},"created_at":"2017-07-27T13:08:47Z","updated_at":"2017-07-27T13:09:06Z","author_association":"NONE","body":"@danielmitterdorfer Sure, I have put the info in the [gist](https://gist.github.com/aj7/307b4577dbe52601c5e7b940d81450cd)\r\n\r\nHope this is fine?\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/318371515","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-318371515","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":318371515,"node_id":"MDEyOklzc3VlQ29tbWVudDMxODM3MTUxNQ==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2017-07-27T14:03:14Z","updated_at":"2017-07-27T14:03:44Z","author_association":"MEMBER","body":"Based on the data from the gist I could create a minimal reproduction scenario for Elasticsearch 5.4.1 consisting of only one document (attached compressed as [geometry.json.zip](https://github.com/elastic/elasticsearch/files/1180167/geometry.json.zip)).\r\n\r\n```\r\ncurl -XDELETE \"http://localhost:9200/speedlimit\"\r\n\r\ncurl -XPUT \"http://localhost:9200/speedlimit\" -d '\r\n{\r\n  \"mappings\": {\r\n    \"speedlimit\": {\r\n      \"properties\": {\r\n        \"geometry\": {\r\n          \"type\": \"geo_shape\",\r\n          \"tree\": \"quadtree\",\r\n          \"precision\": \"100m\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'\r\n# ensure that you've unzipped geometry.json.zip from the attachment above\r\ncurl -XPOST 'http://localhost:9200/_bulk?pretty' --data-binary @geometry.json\r\n```\r\n\r\nWill lead to:\r\n\r\n```\r\n{\r\n  \"took\" : 33813,\r\n  \"errors\" : true,\r\n  \"items\" : [\r\n    {\r\n      \"index\" : {\r\n        \"_index\" : \"speedlimit\",\r\n        \"_type\" : \"speedlimit\",\r\n        \"_id\" : \"AV2EWf3T4RDVowrFsHtQ\",\r\n        \"status\" : 400,\r\n        \"error\" : {\r\n          \"type\" : \"mapper_parsing_exception\",\r\n          \"reason\" : \"failed to parse [geometry]\",\r\n          \"caused_by\" : {\r\n            \"type\" : \"array_index_out_of_bounds_exception\",\r\n            \"reason\" : \"-1\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nand in the logs:\r\n\r\n```\r\norg.elasticsearch.index.mapper.MapperParsingException: failed to parse [geometry]\r\n\tat org.elasticsearch.index.mapper.GeoShapeFieldMapper.parse(GeoShapeFieldMapper.java:473) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:450) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.DocumentParser.parseObject(DocumentParser.java:467) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n[...]\r\nCaused by: java.lang.ArrayIndexOutOfBoundsException: -1\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.assign(PolygonBuilder.java:483) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.compose(PolygonBuilder.java:455) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.geo.builders.PolygonBuilder.coordinates(PolygonBuilder.java:221) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.common.geo.builders.MultiPolygonBuilder.build(MultiPolygonBuilder.java:129) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\tat org.elasticsearch.index.mapper.GeoShapeFieldMapper.parse(GeoShapeFieldMapper.java:455) ~[elasticsearch-5.4.1.jar:5.4.1]\r\n\t... 36 more\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/328234261","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-328234261","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":328234261,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODIzNDI2MQ==","user":{"login":"apeters","id":823773,"node_id":"MDQ6VXNlcjgyMzc3Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/823773?v=4","gravatar_id":"","url":"https://api.github.com/users/apeters","html_url":"https://github.com/apeters","followers_url":"https://api.github.com/users/apeters/followers","following_url":"https://api.github.com/users/apeters/following{/other_user}","gists_url":"https://api.github.com/users/apeters/gists{/gist_id}","starred_url":"https://api.github.com/users/apeters/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/apeters/subscriptions","organizations_url":"https://api.github.com/users/apeters/orgs","repos_url":"https://api.github.com/users/apeters/repos","events_url":"https://api.github.com/users/apeters/events{/privacy}","received_events_url":"https://api.github.com/users/apeters/received_events","type":"User","site_admin":false},"created_at":"2017-09-08T23:10:13Z","updated_at":"2017-09-08T23:11:16Z","author_association":"NONE","body":"I have nothing to add to this ticket other than to +1 @aj7 on this issue.  We too have seen this error with either high vertex count polygons or polygons with very high precision.  Sometime the workaround is to simplify the geometry with something like PostGIS but often that can compromise the data.  \r\nAnd, for what it's worth, it's not too hard to generate polygons like this (imagine a highly precise polygon representing country borders).\r\nWe would love for this to be fixed, as we've run into this on more then one occasion.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/349287305","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-349287305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":349287305,"node_id":"MDEyOklzc3VlQ29tbWVudDM0OTI4NzMwNQ==","user":{"login":"rkuchvarskyy","id":25175891,"node_id":"MDQ6VXNlcjI1MTc1ODkx","avatar_url":"https://avatars1.githubusercontent.com/u/25175891?v=4","gravatar_id":"","url":"https://api.github.com/users/rkuchvarskyy","html_url":"https://github.com/rkuchvarskyy","followers_url":"https://api.github.com/users/rkuchvarskyy/followers","following_url":"https://api.github.com/users/rkuchvarskyy/following{/other_user}","gists_url":"https://api.github.com/users/rkuchvarskyy/gists{/gist_id}","starred_url":"https://api.github.com/users/rkuchvarskyy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rkuchvarskyy/subscriptions","organizations_url":"https://api.github.com/users/rkuchvarskyy/orgs","repos_url":"https://api.github.com/users/rkuchvarskyy/repos","events_url":"https://api.github.com/users/rkuchvarskyy/events{/privacy}","received_events_url":"https://api.github.com/users/rkuchvarskyy/received_events","type":"User","site_admin":false},"created_at":"2017-12-05T12:16:17Z","updated_at":"2017-12-05T15:37:13Z","author_association":"NONE","body":"We also faced with this issue\r\nSimple example cause\r\n\"java.lang.ArrayIndexOutOfBoundsException: -1\\r\\n\\tat org.elasticsearch.common.geo.builders.PolygonBuilder.assign(PolygonBuilder.java:483)\\r\\n\\tat org.elasticsearch.common.geo.builders.PolygonBuilder.compose(PolygonBuilder.java:455)\\r\\n\\tat org.elasticsearch.common.geo.builders.PolygonBuilder.coordinates(PolygonBuilder.java:221)\\r\\n\\tat org.elasticsearch.common.geo.builders.PolygonBuilder.buildGeometry(PolygonBuilder.java:251)\\r\\n\\tat org.elasticsearch.common.geo.builders.PolygonBuilder.build(PolygonBuilder.java:226)\\r\\n\\tat \r\n\r\n\r\n{\"type\":\"Polygon\",\"coordinates\":[[[-10,10.0000000000002],[-5,-5],[10,5],[-10,10.0000000000002]],[[-10,10],[0,5],[0,0],[-10,10]]]}","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/349335264","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-349335264","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":349335264,"node_id":"MDEyOklzc3VlQ29tbWVudDM0OTMzNTI2NA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-05T15:18:06Z","updated_at":"2017-12-05T15:23:16Z","author_association":"CONTRIBUTOR","body":"This seems to be because of an error in the geometry you're trying to index, although it would certainly be helpful if there was a more descriptive error message given. The attached zip file, for instance, contains self-intersections so I think it's right to reject it.\r\n\r\nHere is a shorter reproduction:\r\n\r\n```\r\n$ curl -XDELETE \"http://localhost:9200/speedlimit\"\r\n{\"acknowledged\":true}\r\n$ curl -XPUT \"http://localhost:9200/speedlimit\" -H'Content-type: application/json' -d '{\"mappings\":{\"speedlimit\":{\"properties\":{\"geometry\":{\"type\":\"geo_shape\",\"tree\":\"quadtree\",\"precision\":\"100m\"}}}}}'\r\n{\"acknowledged\":true,\"shards_acknowledged\":true,\"index\":\"speedlimit\"}\r\n$ curl -XPOST \"http://localhost:9200/speedlimit/speedlimit\" -H'Content-type: application/json' -d '{\"geometry\":{\"coordinates\":[[[[4,3],[3,2],[3,3],[4,3]],[[4,2],[3,1],[4,1],[4,2]]]],\"type\":\"MultiPolygon\"}}'\r\n{\"error\":{\"root_cause\":[{\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse [geometry]\"}],\"type\":\"mapper_parsing_exception\",\"reason\":\"failed to parse [geometry]\",\"caused_by\":{\"type\":\"array_index_out_of_bounds_exception\",\"reason\":\"-1\"}},\"status\":400}\r\n```\r\n\r\nIn this case the given geometry contains two triangles, the first of which is clockwise and the second is anticlockwise, indicating that one is an enclave (hole) within the other. However the triangles do not touch.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/349344594","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-349344594","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":349344594,"node_id":"MDEyOklzc3VlQ29tbWVudDM0OTM0NDU5NA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-05T15:45:30Z","updated_at":"2017-12-05T15:45:30Z","author_association":"CONTRIBUTOR","body":"@rkuchvarskyy the example you give also is not a valid geometry because the \"hole\" is not completely within the outer polygon. It's too small to see the error, but if I exaggerate the problem a bit your shape looks like this:\r\n\r\n<img width=\"278\" alt=\"screen shot 2017-12-05 at 15 41 56\" src=\"https://user-images.githubusercontent.com/5058284/33615906-39893440-d9d3-11e7-86e4-11992042b03c.png\">\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/349347660","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-349347660","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":349347660,"node_id":"MDEyOklzc3VlQ29tbWVudDM0OTM0NzY2MA==","user":{"login":"rkuchvarskyy","id":25175891,"node_id":"MDQ6VXNlcjI1MTc1ODkx","avatar_url":"https://avatars1.githubusercontent.com/u/25175891?v=4","gravatar_id":"","url":"https://api.github.com/users/rkuchvarskyy","html_url":"https://github.com/rkuchvarskyy","followers_url":"https://api.github.com/users/rkuchvarskyy/followers","following_url":"https://api.github.com/users/rkuchvarskyy/following{/other_user}","gists_url":"https://api.github.com/users/rkuchvarskyy/gists{/gist_id}","starred_url":"https://api.github.com/users/rkuchvarskyy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rkuchvarskyy/subscriptions","organizations_url":"https://api.github.com/users/rkuchvarskyy/orgs","repos_url":"https://api.github.com/users/rkuchvarskyy/repos","events_url":"https://api.github.com/users/rkuchvarskyy/events{/privacy}","received_events_url":"https://api.github.com/users/rkuchvarskyy/received_events","type":"User","site_admin":false},"created_at":"2017-12-05T15:54:29Z","updated_at":"2017-12-05T15:54:49Z","author_association":"NONE","body":"@DaveCTurner I understood this but I expect some validation exception but not java.lang.ArrayIndexOutOfBoundsException","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/352364346","html_url":"https://github.com/elastic/elasticsearch/issues/25933#issuecomment-352364346","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25933","id":352364346,"node_id":"MDEyOklzc3VlQ29tbWVudDM1MjM2NDM0Ng==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2017-12-18T08:59:56Z","updated_at":"2017-12-18T08:59:56Z","author_association":"CONTRIBUTOR","body":"As of version 6.2 these shapes will yield a more descriptive `org.locationtech.spatial4j.exception.InvalidShapeException` rather than `java.lang.ArrayIndexOutOfBoundsException`, via #27685.\r\n\r\nNote that this issue was nothing to do with the vertex count, nor the precision, and that the fix does not change the set of shapes accepted by Elasticsearch: it merely improves the message it gives when rejecting some invalid ones.","performed_via_github_app":null}]