[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266635935","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266635935","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266635935,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NjYzNTkzNQ==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T04:11:51Z","updated_at":"2016-12-13T04:11:51Z","author_association":"CONTRIBUTOR","body":"Is there anyone looking at this  bug? Or are we on our own with the new versions?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266701087","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266701087","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266701087,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NjcwMTA4Nw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T10:21:36Z","updated_at":"2016-12-13T10:21:36Z","author_association":"MEMBER","body":"I had a look and I don't see any particular regression in our OS stats. On my machine, I get the same values when I compare 2.4 output with 5.0 output. I think this may have to do specifically with docker, though we have to verify what changed around this with 5.0. @jasontedor do you happen to have any idea?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266843900","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266843900","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266843900,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Njg0MzkwMA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T19:55:30Z","updated_at":"2016-12-13T19:55:30Z","author_association":"MEMBER","body":"Sorry, but this appears to be a Docker issue. I can reproduce it, but only inside a Docker container. Yet, it has nothing to do with Elasticsearch as the following Java code shows:\r\n\r\n```java\r\nimport java.lang.management.ManagementFactory;\r\nimport java.lang.management.OperatingSystemMXBean;\r\nimport java.lang.reflect.InvocationTargetException;\r\nimport java.lang.reflect.Method;\r\n\r\npublic final class Memory {\r\n    public static void main(String[] args) throws NoSuchMethodException, IllegalAccessException, InvocationTargetException, ClassNotFoundException {\r\n\tfinal OperatingSystemMXBean osMxBean = ManagementFactory.getOperatingSystemMXBean();\r\n\tfinal Method method = Class.forName(\"com.sun.management.OperatingSystemMXBean\").getMethod(\"getFreePhysicalMemorySize\");\r\n\tfinal long value = (long) method.invoke(osMxBean);\r\n\tSystem.out.println(value);\r\n    }\r\n}\r\n```\r\n\r\nThis produces the same output as Elasticsearch does running inside the container. This isn't surprising, since this is exactly the same code that we use inside of Elasticsearch to report the free memory statistics. Why is it working in the 2.4.2 image and not the 5.0.1 image? I don't know what libraries these two images are built on, but I'm sure there are some discrepancies and they likely account for the difference but it's clearly not an Elasticsearch issue.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266855582","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266855582","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266855582,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Njg1NTU4Mg==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T20:41:23Z","updated_at":"2016-12-13T20:41:23Z","author_association":"CONTRIBUTOR","body":"@jasontedor Thanks for looking into it. \r\n\r\nDo you mean that you were able to repro the issue when you dockerized ES 5.0.1, but if you execute the same thing on host (no container), you can't repro?\r\n\r\nFollowing is the dockerfile content that matters for 5.0.1\r\n\r\n```\r\nFROM openjdk:8-jre \r\n\r\nARG DEBIAN_FRONTEND=noninteractive\r\nRUN set -x \\\r\n && apt-get update -qq \\\r\n && apt-get install -qqy --no-install-recommends ca-certificates curl \\\r\n && apt-get install -qqy jq \\\r\n && rm -rf /var/lib/apt/lists/* \\\r\n && curl -L -o /usr/local/bin/gosu \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg --print-architecture)\" \\\r\n && curl -L -o /usr/local/bin/gosu.asc \"https://github.com/tianon/gosu/releases/download/$GOSU_VERSION/gosu-$(dpkg --print-architecture).asc\" \\\r\n && export GNUPGHOME=\"$(mktemp -d)\" \\\r\n && gpg --keyserver hkp://ha.pool.sks-keyservers.net:80 --recv-keys B42F6819007F00F88E364FD4036A9C25BF357DD4 \\\r\n && gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu \\\r\n && rm -r \"$GNUPGHOME\" /usr/local/bin/gosu.asc \\\r\n && chmod +x /usr/local/bin/gosu \\\r\n && gosu nobody true \\\r\n && apt-get clean \\\r\n && set +x\r\n\r\nENV ES_VERSION 5.0.1\r\nENV ES_PACKAGE elasticsearch-${ES_VERSION}.deb\r\nENV ES_GID 991\r\nENV ES_UID 991\r\n\r\nRUN apt-get update -qq \\\r\n && apt-get install -qqy openjdk-8-jdk \\\r\n && apt-get clean \\\r\n && groupadd -r elasticsearch -g ${ES_GID} \\\r\n && curl https://artifacts.elastic.co/GPG-KEY-elasticsearch | apt-key add - \\\r\n && useradd -r -s /usr/sbin/nologin -M -c \"Elasticsearch service user\" -u ${ES_UID} -g elasticsearch elasticsearch \\\r\n && curl -O https://artifacts.elastic.co/downloads/elasticsearch/${ES_PACKAGE} \\\r\n && dpkg -i ${ES_PACKAGE} \\\r\n && rm -f ${ES_PACKAGE}\r\n\r\n\r\n\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266857809","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266857809","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266857809,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Njg1NzgwOQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T20:49:57Z","updated_at":"2016-12-13T20:49:57Z","author_association":"MEMBER","body":"@animageofmine That's correct, it reproduces on Dockerized 5.0.1 (and this means that I see Elasticsearch and the simple Java program I gave above reporting free memory that are in discordance with `free` inside in the Docker container), but it does not reproduce on the host.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266858579","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266858579","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266858579,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Njg1ODU3OQ==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T20:53:08Z","updated_at":"2016-12-13T20:56:11Z","author_association":"CONTRIBUTOR","body":"@jasontedor Thanks for confirming. Strange that this only happens on dockerized container. \r\n\r\nWas the host on which you started ES (without container) debian based? I am just wondering if java 1.8 has issues on debian.\r\n\r\nUpdate: Actually, never mind. I just read that you verified with free and Java program reported same stats. So, something to do with docker or debian based builds. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266868303","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266868303","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266868303,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Njg2ODMwMw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T21:32:22Z","updated_at":"2016-12-13T23:33:55Z","author_association":"MEMBER","body":"> Thanks for confirming. Let me see, if I can find something useful here. Strange to find this issue only in dockerized container.\r\n\r\nI agree, it's quite puzzling. I have more info for the puzzle too. I put together a trivial C program that is equivalent to the code the JVM executes when it is getting free memory from the system.\r\n\r\n```c\r\n#include <stdio.h>\r\n#include <unistd.h>\r\n\r\nint main(int argc, char **argv) {\r\n  long pageSize = sysconf(_SC_PAGESIZE);\r\n  long availablePhysicalPages = sysconf(_SC_AVPHYS_PAGES);\r\n  printf(\"%ld\\n\", availablePhysicalPages * pageSize);\r\n}\r\n```\r\n\r\nThis program produces the *correct* value inside the host and the container (correct as measured by matching `free` and `/proc/meminfo` (if you `strace` the JVM when it's getting the free memory from the system, and `strace` the above code, you'll see that they both just read `/proc/meminfo`)).\r\n\r\n> When you ran directly on your host, is the host debian based?\r\n\r\nI reproduced it on both an Alpine Linux based host (Moby, on Docker for Mac on my laptop), and on a Fedora host (my bare-metal Linux workstation).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266881604","html_url":"https://github.com/elastic/elasticsearch/issues/21988#issuecomment-266881604","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21988","id":266881604,"node_id":"MDEyOklzc3VlQ29tbWVudDI2Njg4MTYwNA==","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T22:25:03Z","updated_at":"2016-12-13T22:26:21Z","author_association":"MEMBER","body":"I can only score with half baked docker knowledge, but I just remembered from some time ago while playing around that the `/proc` fs is shared and thus contains the host statistics, but is not cgroup aware.\r\n\r\nCan you start the docker instance with the `-m` parameter?","performed_via_github_app":null}]