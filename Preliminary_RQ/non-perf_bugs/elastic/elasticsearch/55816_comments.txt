[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/620133302","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-620133302","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":620133302,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMDEzMzMwMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-04-27T17:44:26Z","updated_at":"2020-04-27T17:44:26Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security (:Security/Authentication)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/620803764","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-620803764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":620803764,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMDgwMzc2NA==","user":{"login":"not-napoleon","id":979663,"node_id":"MDQ6VXNlcjk3OTY2Mw==","avatar_url":"https://avatars0.githubusercontent.com/u/979663?v=4","gravatar_id":"","url":"https://api.github.com/users/not-napoleon","html_url":"https://github.com/not-napoleon","followers_url":"https://api.github.com/users/not-napoleon/followers","following_url":"https://api.github.com/users/not-napoleon/following{/other_user}","gists_url":"https://api.github.com/users/not-napoleon/gists{/gist_id}","starred_url":"https://api.github.com/users/not-napoleon/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/not-napoleon/subscriptions","organizations_url":"https://api.github.com/users/not-napoleon/orgs","repos_url":"https://api.github.com/users/not-napoleon/repos","events_url":"https://api.github.com/users/not-napoleon/events{/privacy}","received_events_url":"https://api.github.com/users/not-napoleon/received_events","type":"User","site_admin":false},"created_at":"2020-04-28T19:17:33Z","updated_at":"2020-04-28T19:17:33Z","author_association":"CONTRIBUTOR","body":"Found an example of it failing in master: https://gradle-enterprise.elastic.co/s/y3t5c3uc3fpni\r\n\r\nI'm going to mute it in master as well.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/620913282","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-620913282","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":620913282,"node_id":"MDEyOklzc3VlQ29tbWVudDYyMDkxMzI4Mg==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-04-28T23:52:21Z","updated_at":"2020-04-29T06:59:04Z","author_association":"MEMBER","body":"This is likely due to [dirty read](https://github.com/elastic/elasticsearch/issues/52400) on the security index. \r\n\r\nAssume node A holds the primary shard of the security index. Thread 1 hits node A and begins to index the new token document. While the indexing is still happening, thread 2 also hits node A and tries to get the document. Thread 2 may succeed and happily return since the document could be visible on node A's primary shard. But the indexing operation is not yet completed so it is not yet available on node B's replica shard. Now if thread 3 hits node B and tries to authenticate with the new token, it will fail because replica shard does not have the document yet. The described scenario is specific, but in general the failure can happen whenever two reads happen to hit shards that are not fully synced.\r\n\r\nI can reproduce the failure reliably in `7.7` by changing [numberOfThreads](https://github.com/elastic/elasticsearch/blob/7.7/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java#L439) to `46` (higher number is more prone to trigger failure). And it can be fixed by re-use the same `threadClient` to [perfom the authentication](https://github.com/elastic/elasticsearch/blob/7.7/x-pack/plugin/security/src/test/java/org/elasticsearch/xpack/security/authc/TokenAuthIntegTests.java#L469), i.e. `threadClient.filterWithHeader(BEARER_TOKEN...)...`. The change is basically ensure authentication talks to the same server that answered the refresh call.\r\n\r\nAs for why it happens much more often with TransportClient compared to HLRC, I can only guess that TransportClient is faster and hence prone to this error. And thanks to @not-napoleon , now we know it can also happen to HLRC, just with a very low chance.\r\n\r\nAccording to @jasontedor, there is no way to tell whether the read is stale or not. A possible fix might be swapping the order of \"update exsiting token document\" and \"create new token document\". This will guarantee that the new document is fully in place when \"update to existing document\" is visible. \r\n\r\nPS: @gwbrown believes that this behaviour should be called \"stale read\" instead of \"dirty read\". I am using \"dirty read\" here since it is the term used in #52400. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/685799046","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-685799046","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":685799046,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NTc5OTA0Ng==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2020-09-02T15:07:49Z","updated_at":"2020-09-02T15:07:49Z","author_association":"CONTRIBUTOR","body":"Fixed in #61714 ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/686391721","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-686391721","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":686391721,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NjM5MTcyMQ==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2020-09-03T10:12:21Z","updated_at":"2020-09-03T10:12:21Z","author_association":"CONTRIBUTOR","body":"In master, we use the rest client which round robins between\r\ncluster nodes and thus the same client might refresh the token\r\nin a node and then immediately attempt to authenticate against\r\nanother. Occasionally this still triggers the issue at hand.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/701526160","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-701526160","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":701526160,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMTUyNjE2MA==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2020-09-30T17:14:41Z","updated_at":"2020-09-30T17:14:41Z","author_association":"CONTRIBUTOR","body":"Another: https://gradle-enterprise.elastic.co/s/kszlclg52vup4","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/712947686","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-712947686","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":712947686,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMjk0NzY4Ng==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T15:45:44Z","updated_at":"2020-10-20T15:45:44Z","author_association":"CONTRIBUTOR","body":"Another: https://gradle-enterprise.elastic.co/s/tasx7lzui3vgs/console-log?task=:x-pack:plugin:security:internalClusterTest","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713102656","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713102656","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713102656,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzEwMjY1Ng==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T19:56:03Z","updated_at":"2020-10-20T19:56:03Z","author_association":"CONTRIBUTOR","body":"The new failures in 7.x are not the same as before \r\n\r\nfailure is\r\n```\r\norg.elasticsearch.xpack.security.authc.TokenAuthIntegTests > testRefreshingMultipleTimesWithinWindowSucceeds FAILED\r\n    java.lang.AssertionError: \r\n    Expected: <false>\r\n         but: was <true>\r\n        at __randomizedtesting.SeedInfo.seed([2D3C8E6FF712A328:C32EEADBAD7235C]:0)\r\n        at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:18)\r\n        at org.junit.Assert.assertThat(Assert.java:956)\r\n        at org.junit.Assert.assertThat(Assert.java:923)\r\n        at org.elasticsearch.xpack.security.authc.TokenAuthIntegTests.testRefreshingMultipleTimesWithinWindowSucceeds(TokenAuthIntegTests.java:620)\r\n```\r\nwith repro line\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew ':x-pack:plugin:security:internalClusterTest' --tests \"org.elasticsearch.xpack.security.authc.TokenAuthIntegTests.testRefreshingMultipleTimesWithinWindowSucceeds\" -Dtests.seed=2D3C8E6FF712A328 -Dtests.security.manager=true -Dtests.locale=nl-BE -Dtests.timezone=Europe/Tiraspol -Druntime.java=8 -Dtests.fips.enabled=true\r\n```\r\nand the actual exception that triggers the assertion error is \r\n\r\n```\r\n  1> [2020-10-20T18:25:00,838][INFO ][o.e.x.s.a.l.LoggingAuditTrail] [node_s0]org.elasticsearch.xpack.security.audit action=\"cluster:monitor/health\" authentication.type=\"REALM\" event.action=\"access_granted\" event.type=\"transport\" indices=\"[]\" origin.address=\"127.0.0.1:48636\" origin.type=\"transport\" request.id=\"xKr2AwAAQACdAHjq_____w\" request.name=\"ClusterHealthRequest\" user.name=\"test_user\" user.realm=\"file\" user.roles=\"[\"user\"]\"\r\n  1> [2020-10-20T18:25:00,843][ERROR][o.e.x.s.a.TokenAuthIntegTests] [node_s3] caught exception\r\n  1> java.lang.IllegalArgumentException: Cannot decode access token\r\n  1> \tat org.elasticsearch.xpack.security.authc.TokenService.lambda$authenticateToken$6(TokenService.java:433) ~[main/:?]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.xpack.security.authc.TokenService.lambda$getUserTokenFromId$11(TokenService.java:497) ~[main/:?]\r\n  1> \tat org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:63) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:89) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:83) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.ContextPreservingActionListener.onResponse(ContextPreservingActionListener.java:43) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.single.shard.TransportSingleShardAction$AsyncSingleAction$2.handleResponse(TransportSingleShardAction.java:261) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.single.shard.TransportSingleShardAction$AsyncSingleAction$2.handleResponse(TransportSingleShardAction.java:247) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleResponse(TransportService.java:1171) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processResponse(TransportService.java:1249) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1229) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:52) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.ChannelActionListener.onResponse(ChannelActionListener.java:43) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.support.ChannelActionListener.onResponse(ChannelActionListener.java:27) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionRunnable.lambda$supply$0(ActionRunnable.java:58) ~[elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.action.ActionRunnable$2.doRun(ActionRunnable.java:73) [elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:737) [elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.11.0-SNAPSHOT.jar:7.11.0-SNAPSHOT]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_241]\r\n  1> \tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_241]\r\n  1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_241]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713118462","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713118462","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713118462,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzExODQ2Mg==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2020-10-20T20:25:25Z","updated_at":"2020-10-20T20:28:37Z","author_association":"CONTRIBUTOR","body":"@BigPandaToo this seems to [have started failing](https://build-stats.elastic.co/app/kibana#/discover?_g=(refreshInterval:(pause:!t,value:0),time:(from:now-30d,mode:quick,to:now))&_a=(columns:!(_source),index:e58bf320-7efd-11e8-bf69-63c8ef516157,interval:auto,query:(language:lucene,query:testRefreshingMultipleTimesWithinWindowSucceeds),sort:!(time,desc))) after you merged [this PR](https://github.com/elastic/elasticsearch/pull/63841).It doesn't fail in master as it is already muted there for other reasons. I'll look into the failure in due time but if you have any insights on what might have changed in the PR that causes this, feel free to share","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713254321","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713254321","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713254321,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzI1NDMyMQ==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-10-21T02:34:25Z","updated_at":"2020-10-21T02:34:25Z","author_association":"MEMBER","body":"#62490 did introduce a new behaviour for token refresh. Once a token is successfully refreshed, it immediately authenticates with the returned access token to get the authentication object of the token:\r\nhttps://github.com/elastic/elasticsearch/blob/b6db0942abe27e65e46f165a81a59f7016bb126e/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/action/token/TransportRefreshTokenAction.java#L36-L39\r\n\r\nThis may be what is causing the current failure. \r\n\r\nFrom the stacktrace, the actual failure is because the access token document cannot be found as in the following:\r\nhttps://github.com/elastic/elasticsearch/blob/b6db0942abe27e65e46f165a81a59f7016bb126e/x-pack/plugin/security/src/main/java/org/elasticsearch/xpack/security/authc/TokenService.java#L496-L497\r\n\r\nBut I don't understand how it could happen. The refresh and subsequent authentication are sequential. Also when refresh returns, both primary and replica shards should have acknowledged the new document. So the authentication (and get token document) should be able to fetch the new token document. I may be missing something.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713360893","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713360893","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713360893,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzM2MDg5Mw==","user":{"login":"BigPandaToo","id":35386883,"node_id":"MDQ6VXNlcjM1Mzg2ODgz","avatar_url":"https://avatars0.githubusercontent.com/u/35386883?v=4","gravatar_id":"","url":"https://api.github.com/users/BigPandaToo","html_url":"https://github.com/BigPandaToo","followers_url":"https://api.github.com/users/BigPandaToo/followers","following_url":"https://api.github.com/users/BigPandaToo/following{/other_user}","gists_url":"https://api.github.com/users/BigPandaToo/gists{/gist_id}","starred_url":"https://api.github.com/users/BigPandaToo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BigPandaToo/subscriptions","organizations_url":"https://api.github.com/users/BigPandaToo/orgs","repos_url":"https://api.github.com/users/BigPandaToo/repos","events_url":"https://api.github.com/users/BigPandaToo/events{/privacy}","received_events_url":"https://api.github.com/users/BigPandaToo/received_events","type":"User","site_admin":false},"created_at":"2020-10-21T07:12:46Z","updated_at":"2020-10-21T07:12:46Z","author_association":"CONTRIBUTOR","body":"I will take a look at it today.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713402239","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713402239","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713402239,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzQwMjIzOQ==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-10-21T08:29:03Z","updated_at":"2020-10-21T08:29:03Z","author_association":"MEMBER","body":"I think this is still caused by the same \"dirty read\" problem described in the [earlier comment](https://github.com/elastic/elasticsearch/issues/55816#issuecomment-620913282). An contrived scenario can be as follows:\r\n\r\nSay we have a 3-node cluster, the token index has its primary on `node_A` and replica on `node_B` and nothing on `node_C`. Thread 1 is refreshing the token and the new token document is processed by the primary, but has not made into the replica yet. Now Thread 2 comes to refresh the token as well, it hits `node_C`.\r\n\r\nBecuase `node_C` does not have a shard copy, it needs to route the request. Since the new token document has not been fully acknowledged yet, both primary and replica are considered equal candidate for the GET token document request. For the refresh request, it happens to be routed to the primary shard (`node_A`) and successfully get the document back. After the refresh, the new code attempts to authenticate with it. Although both the refresh and authenticate happen on the same node, the GET request can be routed to a different node. This time it gets routed to the replica shard (`node_B`). The replica shard does not have this document yet (because Thread 1 is still processing it) and so it fails.\r\n\r\nThe above scenario can actually happen in production. But having an extra authenticate call straight after refresh in server side code definitely increases the likelihood of it.\r\n\r\nTo fix it, I think it is either to have `TokenService#refreshToken` to give back the token authentication object as well or retry the `TokenService#authenticateToken` (either in `TransportRefreshTokenAction` or within itself). @jkakavas Do you have a preference or other alternatives? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713410940","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713410940","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713410940,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzQxMDk0MA==","user":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"created_at":"2020-10-21T08:43:22Z","updated_at":"2020-10-21T08:43:22Z","author_association":"CONTRIBUTOR","body":"> The above scenario can actually happen in production. But having an extra authenticate call straight after refresh in server side code definitely increases the likelihood of it.\r\n\r\nAgreed. In most cases we've seen in production concurrent refreshes come from the same client so they will (most probably) be hitting the same node. In your example thread 1 and thread 2 will most probably both hit node_A. In that sense the change we recently did increases the chances of this happening but it could still happen without it if i.e. the two threads/clients both hit Node C ? We know we want to rework the concurrent refresh logic to accommodate these cases but I don't think this constitutes as a significant reason to drop other work in favor of this ( especially if we can reduce the recently increased probability ) \r\n\r\n\r\n> I think it is either to have TokenService#refreshToken to give back the token authentication object as well\r\n\r\nStrong suggestion for this one from my side","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713500944","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713500944","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713500944,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzUwMDk0NA==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-10-21T11:26:16Z","updated_at":"2020-10-21T11:26:16Z","author_association":"MEMBER","body":"IIUC, the issue can _in theory_ happen even when both threads hit `node_A`. Because we don't guarantee 100% to route to the local shard copy even with `preference=_local` for GetRequest (just learnt it today). This means the two threads can still fetch document from different shard copies on different node and one of them could fail.\r\n\r\nThe chance is probably super low to have no practical concern. I agree this is not the time to revisit the whole refreshing logic. This issue should be fixed for the new behaviour only.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/713620890","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-713620890","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":713620890,"node_id":"MDEyOklzc3VlQ29tbWVudDcxMzYyMDg5MA==","user":{"login":"BigPandaToo","id":35386883,"node_id":"MDQ6VXNlcjM1Mzg2ODgz","avatar_url":"https://avatars0.githubusercontent.com/u/35386883?v=4","gravatar_id":"","url":"https://api.github.com/users/BigPandaToo","html_url":"https://github.com/BigPandaToo","followers_url":"https://api.github.com/users/BigPandaToo/followers","following_url":"https://api.github.com/users/BigPandaToo/following{/other_user}","gists_url":"https://api.github.com/users/BigPandaToo/gists{/gist_id}","starred_url":"https://api.github.com/users/BigPandaToo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BigPandaToo/subscriptions","organizations_url":"https://api.github.com/users/BigPandaToo/orgs","repos_url":"https://api.github.com/users/BigPandaToo/repos","events_url":"https://api.github.com/users/BigPandaToo/events{/privacy}","received_events_url":"https://api.github.com/users/BigPandaToo/received_events","type":"User","site_admin":false},"created_at":"2020-10-21T14:32:17Z","updated_at":"2020-10-21T14:33:36Z","author_association":"CONTRIBUTOR","body":"I agree with @ywangd analysis and with that we have to reduce the probability of these dirty reads until we rework the concurrent refresh logic. Will work on the fix","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/718655996","html_url":"https://github.com/elastic/elasticsearch/issues/55816#issuecomment-718655996","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55816","id":718655996,"node_id":"MDEyOklzc3VlQ29tbWVudDcxODY1NTk5Ng==","user":{"login":"ywangd","id":2344308,"node_id":"MDQ6VXNlcjIzNDQzMDg=","avatar_url":"https://avatars3.githubusercontent.com/u/2344308?v=4","gravatar_id":"","url":"https://api.github.com/users/ywangd","html_url":"https://github.com/ywangd","followers_url":"https://api.github.com/users/ywangd/followers","following_url":"https://api.github.com/users/ywangd/following{/other_user}","gists_url":"https://api.github.com/users/ywangd/gists{/gist_id}","starred_url":"https://api.github.com/users/ywangd/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywangd/subscriptions","organizations_url":"https://api.github.com/users/ywangd/orgs","repos_url":"https://api.github.com/users/ywangd/repos","events_url":"https://api.github.com/users/ywangd/events{/privacy}","received_events_url":"https://api.github.com/users/ywangd/received_events","type":"User","site_admin":false},"created_at":"2020-10-29T10:59:08Z","updated_at":"2020-10-29T10:59:08Z","author_association":"MEMBER","body":"This should now be fixed by #64178","performed_via_github_app":null}]