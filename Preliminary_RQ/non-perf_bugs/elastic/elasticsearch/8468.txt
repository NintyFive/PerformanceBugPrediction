{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8468","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8468/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8468/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8468/events","html_url":"https://github.com/elastic/elasticsearch/issues/8468","id":48640463,"node_id":"MDU6SXNzdWU0ODY0MDQ2Mw==","number":8468,"title":"Highlighting not working when min_gram set to 1","user":{"login":"sschuerz","id":9714324,"node_id":"MDQ6VXNlcjk3MTQzMjQ=","avatar_url":"https://avatars0.githubusercontent.com/u/9714324?v=4","gravatar_id":"","url":"https://api.github.com/users/sschuerz","html_url":"https://github.com/sschuerz","followers_url":"https://api.github.com/users/sschuerz/followers","following_url":"https://api.github.com/users/sschuerz/following{/other_user}","gists_url":"https://api.github.com/users/sschuerz/gists{/gist_id}","starred_url":"https://api.github.com/users/sschuerz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sschuerz/subscriptions","organizations_url":"https://api.github.com/users/sschuerz/orgs","repos_url":"https://api.github.com/users/sschuerz/repos","events_url":"https://api.github.com/users/sschuerz/events{/privacy}","received_events_url":"https://api.github.com/users/sschuerz/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-11-13T14:17:37Z","updated_at":"2016-11-24T19:01:32Z","closed_at":"2016-11-24T19:01:32Z","author_association":"NONE","active_lock_reason":null,"body":"Hi,\nI use elasticsearch 1.4 and I discovered a problem with highlighting in the following scenario, where min_gram is set to 1 for an ngram tokenizer:\n\n``` json\nPUT test_highlighting\n{\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"nGram_analyzer\": {\n          \"alias\": \"default_index\",\n          \"tokenizer\": \"nGram_tokenizer\",\n          \"filter\": [\n            \"lowercase\",\n            \"asciifolding\"\n          ]\n        }\n      },\n      \"tokenizer\": {\n        \"nGram_tokenizer\": {\n          \"type\": \"nGram\",\n          \"min_gram\": 1,\n          \"max_gram\": 25,\n          \"token_chars\": [ \"letter\", \"digit\" ]\n        }\n      }\n    }\n  }\n}\n\nPOST test_highlighting/doc/\n{\n  \"content\": \"Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.\"\n}\n\nGET test_highlighting/_search\n{\n  \"query\": {\n    \"match\": {\n      \"content\": \"a\"\n    }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"*\": { }\n    }\n  }\n}\n```\n\nFor the search query at the end, I get this result:\n\n``` json\n{\n   \"took\": 6,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 0.039754517,\n      \"hits\": [\n         {\n            \"_index\": \"test_highlighting\",\n            \"_type\": \"doc\",\n            \"_id\": \"AUmpZaAOCwTCfR9MAewK\",\n            \"_score\": 0.039754517,\n            \"_source\": {\n               \"content\": \"Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.\"\n            },\n            \"highlight\": {\n               \"content\": [\n                  \"Lorem ipsum dolor sit <em>a</em>met, consetetur s<em>a</em>dipscing elitr, sed di<em>a</em>m nonumy eirmod tempor invidunt u\",\n                  \"t l<em>a</em>bore et dolore m<em>agna</em> <em>aliquya</em>m er<em>a</em>t, sed di<em>a</em>m voluptu<em>a</em>.\"\n               ]\n            }\n         }\n      ]\n   }\n}\n```\n\nYou can see that \"agna\" in \"magna\" and \"aliquya\" in \"aliquyam\" get highlighted. I think this is a bug.\nI only get these wrong results when min_gram is set to 1, the search term consists of only one char, and the search term appears two times closely together in one word (like \"a\" in \"magna\" or \"aliquyam\").\n\nUsing an ngram token filter instead, with version 4.1 (as suggested in #3137), also does not work for me. I tried these index settings:\n\n``` json\nPUT test_highlighting\n{\n  \"settings\": {\n    \"analysis\": {\n      \"analyzer\": {\n        \"nGram_analyzer\": {\n          \"alias\": \"default_index\",\n          \"tokenizer\": \"whitespace\",\n          \"filter\": [\n            \"lowercase\",\n            \"asciifolding\",\n            \"nGram_filter\"\n          ]\n        }\n      },\n      \"filter\": {\n        \"nGram_filter\": {\n          \"type\": \"nGram\",\n          \"min_gram\": 1,\n          \"max_gram\": 25,\n          \"version\": \"4.1\"\n        }\n      }\n    }\n  }\n}\n```\n\nThen highlighting works correctly when searching for single chars. But when I search for multiple chars:\n\n``` json\nGET test_highlighting/_search\n{\n  \"query\": {\n    \"match\": {\n      \"content\": \"mag\"\n    }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"*\": { }\n    }\n  }\n}\n```\n\nThen there is another highlighting problem (\"mag\" gets repeated in \"magna\"):\n\n``` json\n{\n   \"took\": 7,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 0.011986438,\n      \"hits\": [\n         {\n            \"_index\": \"test_highlighting\",\n            \"_type\": \"doc\",\n            \"_id\": \"AUmpbwK1CwTCfR9MAe9w\",\n            \"_score\": 0.011986438,\n            \"_source\": {\n               \"content\": \"Lorem ipsum dolor sit amet, consetetur sadipscing elitr, sed diam nonumy eirmod tempor invidunt ut labore et dolore magna aliquyam erat, sed diam voluptua.\"\n            },\n            \"highlight\": {\n               \"content\": [\n                  \" labore et dolore magn<em>mag</em>a aliquyam erat, sed diam voluptua.\"\n               ]\n            }\n         }\n      ]\n   }\n}\n```\n\nCould anyone please help me out?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}