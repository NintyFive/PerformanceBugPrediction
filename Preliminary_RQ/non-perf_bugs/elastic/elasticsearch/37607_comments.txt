[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/455542927","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-455542927","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":455542927,"node_id":"MDEyOklzc3VlQ29tbWVudDQ1NTU0MjkyNw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-01-18T13:18:10Z","updated_at":"2019-01-18T13:18:10Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462909030","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-462909030","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":462909030,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjkwOTAzMA==","user":{"login":"smalenfant","id":3803592,"node_id":"MDQ6VXNlcjM4MDM1OTI=","avatar_url":"https://avatars2.githubusercontent.com/u/3803592?v=4","gravatar_id":"","url":"https://api.github.com/users/smalenfant","html_url":"https://github.com/smalenfant","followers_url":"https://api.github.com/users/smalenfant/followers","following_url":"https://api.github.com/users/smalenfant/following{/other_user}","gists_url":"https://api.github.com/users/smalenfant/gists{/gist_id}","starred_url":"https://api.github.com/users/smalenfant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smalenfant/subscriptions","organizations_url":"https://api.github.com/users/smalenfant/orgs","repos_url":"https://api.github.com/users/smalenfant/repos","events_url":"https://api.github.com/users/smalenfant/events{/privacy}","received_events_url":"https://api.github.com/users/smalenfant/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T19:52:32Z","updated_at":"2019-02-12T19:52:32Z","author_association":"NONE","body":"I would love to see the manual steps if possible. I have a few ML jobs stuck in close due to this issue.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462935360","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-462935360","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":462935360,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MjkzNTM2MA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T21:08:11Z","updated_at":"2019-03-01T11:15:38Z","author_association":"CONTRIBUTOR","body":"Here are the steps needed to fix the issue (as run from the dev tools console):\r\n\r\n1. Stop all datafeeds and close all jobs and tell other users not to open any more until this process is complete. It is probably good to note which jobs were open in order to reopen them at the end of this process.\r\n\r\n```\r\nPOST _xpack/ml/datafeeds/*/_stop\r\nPOST _xpack/ml/anomaly_detectors/*/_close\r\n```\r\n\r\n2. Get aliases of ML results indices\r\n\r\n```\r\nGET .ml-anomalies-*/_alias\r\n```\r\n\r\nThe response should be stored in a file (let's call it `ml_results_alias_response.txt`)\r\n\r\n3. Reindex all ML results indices into a temporary index. This has to be done for each index starting with `.ml-anomalies-`.\r\n\r\n```\r\nPOST _reindex\r\n{\r\n  \"source\": {\r\n    \"index\": \"{index_name}\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"tmp-{index_name}\"\r\n  }\r\n}\r\n```\r\n\r\n4. Delete original indices. This has to be done for each index starting with `.ml-anomalies-`.\r\n\r\n```\r\nDELETE {index_name}\r\n```\r\n\r\n5. Reindex temporary indices back to their original names.\r\n\r\n```\r\nPOST _reindex\r\n{\r\n  \"source\": {\r\n    \"index\": \"tmp-{index_name}\"\r\n  },\r\n  \"dest\": {\r\n    \"index\": \"{index_name}\"\r\n  }\r\n}\r\n```\r\n\r\n6. Restore aliases. This [script](https://github.com/elastic/elasticsearch/files/2859627/gen_post_aliases_body.sh.txt) generates the necessary body to the post aliases request. It is a bash script but it does depend on `jq` to be available. It can be used with the file from step 2.\r\n\r\n```\r\n./gen_post_aliases_body.sh < ml_results_alias_response.txt\r\n```\r\n\r\nThen copy the output and use it as the body in the following request:\r\n\r\n```\r\nPOST _aliases\r\n{BODY}\r\n```\r\n\r\n7. Delete the temporary indices created\r\n\r\n8. Reopen any jobs that were closed in step 1.\r\n\r\nThis process will ensure the results indices have the correct mappings after the upgrade to `6.5.x`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/462982538","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-462982538","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":462982538,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2Mjk4MjUzOA==","user":{"login":"smalenfant","id":3803592,"node_id":"MDQ6VXNlcjM4MDM1OTI=","avatar_url":"https://avatars2.githubusercontent.com/u/3803592?v=4","gravatar_id":"","url":"https://api.github.com/users/smalenfant","html_url":"https://github.com/smalenfant","followers_url":"https://api.github.com/users/smalenfant/followers","following_url":"https://api.github.com/users/smalenfant/following{/other_user}","gists_url":"https://api.github.com/users/smalenfant/gists{/gist_id}","starred_url":"https://api.github.com/users/smalenfant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smalenfant/subscriptions","organizations_url":"https://api.github.com/users/smalenfant/orgs","repos_url":"https://api.github.com/users/smalenfant/repos","events_url":"https://api.github.com/users/smalenfant/events{/privacy}","received_events_url":"https://api.github.com/users/smalenfant/received_events","type":"User","site_admin":false},"created_at":"2019-02-12T23:23:37Z","updated_at":"2019-02-12T23:23:37Z","author_association":"NONE","body":"@droberts195 Thanks for this info. 1 thing missing is the script, looks like I don't have access to that repo (404).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/463121932","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-463121932","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":463121932,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MzEyMTkzMg==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-13T09:21:02Z","updated_at":"2019-02-13T09:21:02Z","author_association":"CONTRIBUTOR","body":"Sorry about that @smalenfant.  I edited the big comment above to make the script an attachment of this issue.  I had to rename it with a `.txt` extension to do this, so after downloading rename the file to remove the `.txt` extension and `chmod +x` it.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466567694","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-466567694","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":466567694,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2NjU2NzY5NA==","user":{"login":"smalenfant","id":3803592,"node_id":"MDQ6VXNlcjM4MDM1OTI=","avatar_url":"https://avatars2.githubusercontent.com/u/3803592?v=4","gravatar_id":"","url":"https://api.github.com/users/smalenfant","html_url":"https://github.com/smalenfant","followers_url":"https://api.github.com/users/smalenfant/followers","following_url":"https://api.github.com/users/smalenfant/following{/other_user}","gists_url":"https://api.github.com/users/smalenfant/gists{/gist_id}","starred_url":"https://api.github.com/users/smalenfant/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/smalenfant/subscriptions","organizations_url":"https://api.github.com/users/smalenfant/orgs","repos_url":"https://api.github.com/users/smalenfant/repos","events_url":"https://api.github.com/users/smalenfant/events{/privacy}","received_events_url":"https://api.github.com/users/smalenfant/received_events","type":"User","site_admin":false},"created_at":"2019-02-22T22:18:06Z","updated_at":"2019-02-22T22:18:06Z","author_association":"NONE","body":"@droberts195 We didn't have time to go through the process of re-indexing although we did upgrade to 6.6.1. The mapping problem went away, although my jobs can't seem to open at all now. Might be a totally different issue.\r\n\r\n```\r\nPOST _xpack/ml/anomaly_detectors/ttms/_open\r\n{\r\n \"statusCode\": 504,\r\n \"error\": \"Gateway Time-out\",\r\n \"message\": \"Client request timeout\"\r\n}\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/466940383","html_url":"https://github.com/elastic/elasticsearch/issues/37607#issuecomment-466940383","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37607","id":466940383,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2Njk0MDM4Mw==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-02-25T09:32:08Z","updated_at":"2019-02-25T09:32:08Z","author_association":"CONTRIBUTOR","body":"@smalenfant like you say, your new problem could be something completely different.  If you have a support contract please open a support case for it.  Then our support team can lead you through the process of gathering enough information to diagnose what's wrong.  If you don't have a support contract please ask on the [Discuss forum](https://discuss.elastic.co/tags/machine-learning).  Tag your question with the `machine-learning` tag so we don't miss it.","performed_via_github_app":null}]