{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23780","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23780/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23780/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23780/events","html_url":"https://github.com/elastic/elasticsearch/issues/23780","id":217690672,"node_id":"MDU6SXNzdWUyMTc2OTA2NzI=","number":23780,"title":"s3 repository with AWS instance profile not working","user":{"login":"r0c","id":1125153,"node_id":"MDQ6VXNlcjExMjUxNTM=","avatar_url":"https://avatars0.githubusercontent.com/u/1125153?v=4","gravatar_id":"","url":"https://api.github.com/users/r0c","html_url":"https://github.com/r0c","followers_url":"https://api.github.com/users/r0c/followers","following_url":"https://api.github.com/users/r0c/following{/other_user}","gists_url":"https://api.github.com/users/r0c/gists{/gist_id}","starred_url":"https://api.github.com/users/r0c/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/r0c/subscriptions","organizations_url":"https://api.github.com/users/r0c/orgs","repos_url":"https://api.github.com/users/r0c/repos","events_url":"https://api.github.com/users/r0c/events{/privacy}","received_events_url":"https://api.github.com/users/r0c/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-03-28T20:58:33Z","updated_at":"2017-03-28T21:02:40Z","closed_at":"2017-03-28T21:02:40Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: 5.2\r\n\r\n**Plugins installed**: [repository-s3]\r\n\r\n**JVM version**: \r\njava version \"1.8.0_102\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_102-b14)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.102-b14, mixed mode\r\n\r\n\r\n**OS version**: CentOS Linux release 7.3.1611 (Core)\r\n\r\n**Description of the problem including expected versus actual behavior**: \r\nI am using repository-s3 with aws instance profile,  but got Access Denied error with http code 500.\r\n\r\nHere are the command and output:\r\n```\r\n[root@ip-10-99-3-140 bin]# curl -XPUT '10.99.3.140:9200/_snapshot/my_s3_repository_3?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"type\": \"s3\",\r\n  \"settings\": {\r\n    \"bucket\": \"elasticsearchbucket-14lu5ab5ncv3a\",\r\n    \"region\": \"us-west-2\"\r\n  }\r\n}'\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"repository_verification_exception\",\r\n        \"reason\" : \"[my_s3_repository_3] path  is not accessible on master node\"\r\n      }\r\n    ],\r\n    \"type\" : \"repository_verification_exception\",\r\n    \"reason\" : \"[my_s3_repository_3] path  is not accessible on master node\",\r\n    \"caused_by\" : {\r\n      \"type\" : \"i_o_exception\",\r\n      \"reason\" : \"Unable to upload object tests-NxZaN5PAQOOZH7c528Krrg/master.dat-temp\",\r\n      \"caused_by\" : {\r\n        \"type\" : \"amazon_s3_exception\",\r\n        \"reason\" : \"Access Denied (Service: Amazon S3; Status Code: 403; Error Code: AccessDenied; Request ID: 99B74F2EF8BBBD0C)\"\r\n      }\r\n    }\r\n  },\r\n  \"status\" : 500\r\n}\r\n```\r\n\r\nThe ec2 instance has the iam role and policies for accessing this bucket:\r\n```\r\n{\r\n    \"Version\": \"2012-10-17\",\r\n    \"Statement\": [\r\n        {\r\n            \"Action\": [\r\n                \"s3:*\"\r\n            ],\r\n            \"Resource\": [\r\n                \"arn:aws:s3:::elasticsearchbucket-14lu5ab5ncv3a/*\",\r\n                \"arn:aws:s3:::elasticsearchbucket-14lu5ab5ncv3a\"\r\n            ],\r\n            \"Effect\": \"Allow\"\r\n        }\r\n    ]\r\n}\r\n```\r\n\r\nI want to know how to get it working. \r\n**Provide logs (if relevant)**:\r\n```\r\n[2017-03-28T20:52:11,513][WARN ][r.suppressed             ] path: /_snapshot/my_s3_repository_3, params: {pretty=, repository=my_s3_repository_3}\r\norg.elasticsearch.repositories.RepositoryVerificationException: [my_s3_repository_3] path  is not accessible on master node\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.startVerification(BlobStoreRepository.java:734) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.repositories.RepositoriesService.verifyRepository(RepositoriesService.java:210) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.repositories.RepositoriesService$VerifyingRegisterRepositoryListener.onResponse(RepositoriesService.java:413) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.repositories.RepositoriesService$VerifyingRegisterRepositoryListener.onResponse(RepositoriesService.java:398) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.AckedClusterStateUpdateTask.onAllNodesAcked(AckedClusterStateUpdateTask.java:64) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.service.ClusterService$SafeAckedClusterStateTaskListener.onAllNodesAcked(ClusterService.java:1047) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.service.ClusterService$AckCountDownListener.onNodeAck(ClusterService.java:1305) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.service.ClusterService$DelegetingAckListener.onNodeAck(ClusterService.java:1245) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:828) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:628) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cluster.service.ClusterService$UpdateTask.run(ClusterService.java:1112) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:527) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:238) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:201) [elasticsearch-5.2.0.jar:5.2.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\r\nCaused by: java.io.IOException: Unable to upload object tests-NxZaN5PAQOOZH7c528Krrg/master.dat-temp\r\n        at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.upload(DefaultS3OutputStream.java:119) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.flush(DefaultS3OutputStream.java:99) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.S3OutputStream.flushBuffer(S3OutputStream.java:71) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.S3OutputStream.close(S3OutputStream.java:89) ~[?:?]\r\n        at org.apache.lucene.util.IOUtils.close(IOUtils.java:89) ~[lucene-core-6.4.0.jar:6.4.0 bbe4b08cc1fb673d0c3eb4b8455f23ddc1364124 - jim - 2017-01-17 15:57:29]\r\n        at org.apache.lucene.util.IOUtils.close(IOUtils.java:76) ~[lucene-core-6.4.0.jar:6.4.0 bbe4b08cc1fb673d0c3eb4b8455f23ddc1364124 - jim - 2017-01-17 15:57:29]\r\n        at org.elasticsearch.common.io.Streams.copy(Streams.java:85) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.common.io.Streams.copy(Streams.java:57) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cloud.aws.blobstore.S3BlobContainer.writeBlob(S3BlobContainer.java:108) ~[?:?]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.startVerification(BlobStoreRepository.java:727) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        ... 16 more\r\n        Suppressed: java.io.IOException: Unable to upload object tests-NxZaN5PAQOOZH7c528Krrg/master.dat-temp\r\n                at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.upload(DefaultS3OutputStream.java:119) ~[?:?]\r\n                at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.flush(DefaultS3OutputStream.java:99) ~[?:?]\r\n                at org.elasticsearch.cloud.aws.blobstore.S3OutputStream.flushBuffer(S3OutputStream.java:71) ~[?:?]\r\n                at org.elasticsearch.cloud.aws.blobstore.S3OutputStream.close(S3OutputStream.java:89) ~[?:?]\r\n                at org.elasticsearch.cloud.aws.blobstore.S3BlobContainer.writeBlob(S3BlobContainer.java:109) ~[?:?]\r\n                at org.elasticsearch.repositories.blobstore.BlobStoreRepository.startVerification(BlobStoreRepository.java:727) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.repositories.RepositoriesService.verifyRepository(RepositoriesService.java:210) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.repositories.RepositoriesService$VerifyingRegisterRepositoryListener.onResponse(RepositoriesService.java:413) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.repositories.RepositoriesService$VerifyingRegisterRepositoryListener.onResponse(RepositoriesService.java:398) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.AckedClusterStateUpdateTask.onAllNodesAcked(AckedClusterStateUpdateTask.java:64) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.service.ClusterService$SafeAckedClusterStateTaskListener.onAllNodesAcked(ClusterService.java:1047) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.service.ClusterService$AckCountDownListener.onNodeAck(ClusterService.java:1305) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.service.ClusterService$DelegetingAckListener.onNodeAck(ClusterService.java:1245) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.service.ClusterService.publishAndApplyChanges(ClusterService.java:828) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.service.ClusterService.runTasks(ClusterService.java:628) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.cluster.service.ClusterService$UpdateTask.run(ClusterService.java:1112) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:527) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:238) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:201) [elasticsearch-5.2.0.jar:5.2.0]\r\n                at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_102]\r\n                at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_102]\r\n                at java.lang.Thread.run(Thread.java:745) [?:1.8.0_102]\r\n        Caused by: com.amazonaws.services.s3.model.AmazonS3Exception: Access Denied (Service: Amazon S3; Status Code: 403; Error Code: AccessDenied; Request ID: 4A6546566DF33ED9)\r\n                at com.amazonaws.http.AmazonHttpClient.handleErrorResponse(AmazonHttpClient.java:1389) ~[?:?]\r\n                at com.amazonaws.http.AmazonHttpClient.executeOneRequest(AmazonHttpClient.java:902) ~[?:?]\r\n                at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:607) ~[?:?]\r\n                at com.amazonaws.http.AmazonHttpClient.doExecute(AmazonHttpClient.java:376) ~[?:?]\r\n                at com.amazonaws.http.AmazonHttpClient.executeWithTimer(AmazonHttpClient.java:338) ~[?:?]\r\n                at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:287) ~[?:?]\r\n                at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:3654) ~[?:?]\r\n                at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:1354) ~[?:?]\r\n                at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.doUpload(DefaultS3OutputStream.java:149) ~[?:?]\r\n                at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.upload(DefaultS3OutputStream.java:112) ~[?:?]\r\n                ... 21 more\r\nCaused by: com.amazonaws.services.s3.model.AmazonS3Exception: Access Denied (Service: Amazon S3; Status Code: 403; Error Code: AccessDenied; Request ID: 99B74F2EF8BBBD0C)\r\n        at com.amazonaws.http.AmazonHttpClient.handleErrorResponse(AmazonHttpClient.java:1389) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient.executeOneRequest(AmazonHttpClient.java:902) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient.executeHelper(AmazonHttpClient.java:607) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient.doExecute(AmazonHttpClient.java:376) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient.executeWithTimer(AmazonHttpClient.java:338) ~[?:?]\r\n        at com.amazonaws.http.AmazonHttpClient.execute(AmazonHttpClient.java:287) ~[?:?]\r\n        at com.amazonaws.services.s3.AmazonS3Client.invoke(AmazonS3Client.java:3654) ~[?:?]\r\n        at com.amazonaws.services.s3.AmazonS3Client.putObject(AmazonS3Client.java:1354) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.doUpload(DefaultS3OutputStream.java:149) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.upload(DefaultS3OutputStream.java:112) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.DefaultS3OutputStream.flush(DefaultS3OutputStream.java:99) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.S3OutputStream.flushBuffer(S3OutputStream.java:71) ~[?:?]\r\n        at org.elasticsearch.cloud.aws.blobstore.S3OutputStream.close(S3OutputStream.java:89) ~[?:?]\r\n        at org.apache.lucene.util.IOUtils.close(IOUtils.java:89) ~[lucene-core-6.4.0.jar:6.4.0 bbe4b08cc1fb673d0c3eb4b8455f23ddc1364124 - jim - 2017-01-17 15:57:29]\r\n        at org.apache.lucene.util.IOUtils.close(IOUtils.java:76) ~[lucene-core-6.4.0.jar:6.4.0 bbe4b08cc1fb673d0c3eb4b8455f23ddc1364124 - jim - 2017-01-17 15:57:29]\r\n        at org.elasticsearch.common.io.Streams.copy(Streams.java:85) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.common.io.Streams.copy(Streams.java:57) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        at org.elasticsearch.cloud.aws.blobstore.S3BlobContainer.writeBlob(S3BlobContainer.java:108) ~[?:?]\r\n        at org.elasticsearch.repositories.blobstore.BlobStoreRepository.startVerification(BlobStoreRepository.java:727) ~[elasticsearch-5.2.0.jar:5.2.0]\r\n        ... 16 more\r\n\r\n```\r\n<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n\r\n**Describe the feature**:\r\n","closed_by":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"performed_via_github_app":null}