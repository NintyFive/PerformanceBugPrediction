{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9958","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9958/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9958/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9958/events","html_url":"https://github.com/elastic/elasticsearch/issues/9958","id":59598689,"node_id":"MDU6SXNzdWU1OTU5ODY4OQ==","number":9958,"title":"multiple 'children' aggregations interfere with each other","user":{"login":"perryn","id":40276,"node_id":"MDQ6VXNlcjQwMjc2","avatar_url":"https://avatars3.githubusercontent.com/u/40276?v=4","gravatar_id":"","url":"https://api.github.com/users/perryn","html_url":"https://github.com/perryn","followers_url":"https://api.github.com/users/perryn/followers","following_url":"https://api.github.com/users/perryn/following{/other_user}","gists_url":"https://api.github.com/users/perryn/gists{/gist_id}","starred_url":"https://api.github.com/users/perryn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/perryn/subscriptions","organizations_url":"https://api.github.com/users/perryn/orgs","repos_url":"https://api.github.com/users/perryn/repos","events_url":"https://api.github.com/users/perryn/events{/privacy}","received_events_url":"https://api.github.com/users/perryn/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":9,"created_at":"2015-03-03T05:53:57Z","updated_at":"2015-04-23T18:23:37Z","closed_at":"2015-04-13T10:38:28Z","author_association":"NONE","active_lock_reason":null,"body":"If you have two sibling aggregations that make use of the 'children' aggregation, then the second aggregation seems to count each document twice.\n\nHere is a cut-down example\n\nI have a mapping that has parent documents of type 'datastreams' with child documents of type 'readings'\n\nI ran this, which has two identical sibling aggregations:\n\n```\ncurl -XGET 'https://blahblahblah/index/datastreams/_search?search_type=count&pretty' -d '{\n\"aggs\" : {\n     \"one\" : {\n        \"children\": {\n          \"type\": \"readings\"\n        },\n       \"aggs\" :{\n         \"grand-total\" : { \"sum\" : { \"field\" : \"readings.dv\" } }\n       }\n     },\n     \"two\" : {\n        \"children\": {\n          \"type\": \"readings\"\n         },\n        \"aggs\" :{\n          \"grand-total\" : { \"sum\" : { \"field\" : \"readings.dv\" } }\n        }\n     }  \n }  \n}' \n```\n\nand got the response\n\n```\n{\n   \"took\" : 23620,\n   \"timed_out\" : false,\n   \"_shards\" : {\n      \"total\" : 5,\n      \"successful\" : 5,\n      \"failed\" : 0\n   },\n  \"hits\" : {\n     \"total\" : 1389,\n     \"max_score\" : 0.0,\n     \"hits\" : [ ]\n  },\n \"aggregations\" : {\n    \"two\" : {\n       \"doc_count\" : 729353222,\n       \"grand-total\" : {\n          \"value\" : 2.389726905175203E10\n       }\n    },\n   \"one\" : {\n      \"doc_count\" : 364676611,\n      \"grand-total\" : {\n          \"value\" : 1.1948634525852589E10\n      }\n   }\n }\n}\n```\n\nAlthough aggregation 'one' and 'two' are identical Elasticsearch seems to have double counted the documents for aggregation 'two'\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}