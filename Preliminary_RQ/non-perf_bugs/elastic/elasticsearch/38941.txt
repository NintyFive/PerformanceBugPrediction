{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38941","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38941/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38941/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38941/events","html_url":"https://github.com/elastic/elasticsearch/issues/38941","id":410707214,"node_id":"MDU6SXNzdWU0MTA3MDcyMTQ=","number":38941,"title":"S3 Snapshot Repository Erroneously Assumes Consistent List Operation","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-02-15T10:41:35Z","updated_at":"2019-12-05T18:00:47Z","closed_at":"2019-12-05T18:00:46Z","author_association":"MEMBER","active_lock_reason":null,"body":"We do the following when snapshotting a shard in https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/repositories/blobstore/BlobStoreRepository.java#L1177:\r\n\r\n```java\r\n        public void snapshot(final IndexCommit snapshotIndexCommit) {\r\n            logger.debug(\"[{}] [{}] snapshot to [{}] ...\", shardId, snapshotId, metadata.name());\r\n\r\n            final Map<String, BlobMetaData> blobs;\r\n            try {\r\n                blobs = blobContainer.listBlobs();\r\n```\r\n\r\nto find the latest `index-{N}` file at the root of each shard folder.\r\nThere is no guarantee that this file is actually going to be listed if two snapshots happen in rapid succession and some inconsistency becomes ever more likely the more snapshots one has.\r\nIf we hit the wrong `N` here the subsequent logic of:\r\n\r\n```java\r\n                    if (existingFileInfo == null) {\r\n                        indexIncrementalFileCount++;\r\n                        indexIncrementalSize += md.length();\r\n                        // create a new FileInfo\r\n                        BlobStoreIndexShardSnapshot.FileInfo snapshotFileInfo =\r\n                            new BlobStoreIndexShardSnapshot.FileInfo(fileNameFromGeneration(++generation), md, chunkSize());\r\n                        indexCommitPointFiles.add(snapshotFileInfo);\r\n                        filesToSnapshot.add(snapshotFileInfo);\r\n                    } else {\r\n                        indexCommitPointFiles.add(existingFileInfo);\r\n                    }\r\n                }\r\n\r\n                snapshotStatus.moveToStarted(startTime, indexIncrementalFileCount,\r\n                    indexTotalNumberOfFiles, indexIncrementalSize, indexTotalFileCount);\r\n\r\n                for (BlobStoreIndexShardSnapshot.FileInfo snapshotFileInfo : filesToSnapshot) {\r\n                    try {\r\n                        snapshotFile(snapshotFileInfo);\r\n```\r\n\r\nCould produce incorrect values for `generation` causing shard data files to collide in naming.\r\nAdd to that the fact that the S3 repository has no `failIfAlreadyExists` logic in place, like the other snapshot repositories (see #36927 for details), one could overwrite shard data files in this scenario and corrupt the repository as far as I can see.\r\n\r\n@ywelsch @tlrx maybe I'm missing some hidden step here that prevents getting the wrong `N` and potentially overwriting shard data files?","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}