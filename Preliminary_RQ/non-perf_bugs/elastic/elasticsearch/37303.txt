{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37303","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37303/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37303/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37303/events","html_url":"https://github.com/elastic/elasticsearch/issues/37303","id":397832096,"node_id":"MDU6SXNzdWUzOTc4MzIwOTY=","number":37303,"title":"Invalid variance computed in extended_stats aggregation","user":{"login":"raphz","id":3070916,"node_id":"MDQ6VXNlcjMwNzA5MTY=","avatar_url":"https://avatars1.githubusercontent.com/u/3070916?v=4","gravatar_id":"","url":"https://api.github.com/users/raphz","html_url":"https://github.com/raphz","followers_url":"https://api.github.com/users/raphz/followers","following_url":"https://api.github.com/users/raphz/following{/other_user}","gists_url":"https://api.github.com/users/raphz/gists{/gist_id}","starred_url":"https://api.github.com/users/raphz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raphz/subscriptions","organizations_url":"https://api.github.com/users/raphz/orgs","repos_url":"https://api.github.com/users/raphz/repos","events_url":"https://api.github.com/users/raphz/events{/privacy}","received_events_url":"https://api.github.com/users/raphz/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":92913858,"node_id":"MDU6TGFiZWw5MjkxMzg1OA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/good%20first%20issue","name":"good first issue","color":"07569b","default":true,"description":"low hanging fruit"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-01-10T13:32:30Z","updated_at":"2020-06-17T16:12:05Z","closed_at":"2019-01-25T14:56:34Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.1.4\r\n\r\n**Plugins installed**: n/a\r\n\r\n**JVM version** (`java -version`): 1.8.191\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Centos 7.5\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nIn some conditions, the variance computed in an extended_stats aggregation is computed as a negative number that should never append.\r\n\r\nThe variance is a sum of positive numbers, hence cannot be negative. What makes it negative here is the way it is computed (probably as the difference of two positive numbers here: \"sum_of_squares / count\" and \"avg * avg\"). Due to the non-infinite precision of floating point numbers, both numbers are 'almost' the same...\r\n\r\n**Proposed solution**:\r\n\r\nAt least prevent negative values to appear in the variance: add a \"Math.max(0.0, ...)\" to the existing computation formula.\r\n\r\n**Steps to reproduce**:\r\n\r\nUsing the attached zip file, do the following :\r\n\r\n- in env.properties: put the host/port to the elastic-search instance (default: localhost:9200)\r\n- run ./reproduce.sh my-test-index (or any other index name, beware, this index will be dropped!)\r\n\r\nWhat does it do?\r\n\r\n- drop the given index\r\n- create it new with a specific mapping: index: long, amount: double\r\n- load 3 documents with same amount: 49.95\r\n- ask for an \"extended_stats\" aggregation on the amounts\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n{\"acknowledged\":true}\r\n\r\n{\"acknowledged\":true,\"shards_acknowledged\":true,\"index\":\"my-test-index\"}\r\n\r\n{\"_index\":\"my-test-index\",\"_type\":\"document\",\"_id\":\"BErfN2gBWLZgAGEHAdb8\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"_seq_no\":0,\"_primary_term\":1}\r\n\r\n{\"_index\":\"my-test-index\",\"_type\":\"document\",\"_id\":\"BUrfN2gBWLZgAGEHAtY2\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"_seq_no\":0,\"_primary_term\":1}\r\n\r\n{\"_index\":\"my-test-index\",\"_type\":\"document\",\"_id\":\"BkrfN2gBWLZgAGEHAtZd\",\"_version\":1,\"result\":\"created\",\"_shards\":{\"total\":2,\"successful\":1,\"failed\":0},\"_seq_no\":0,\"_primary_term\":1}\r\n\r\n{\"_shards\":{\"total\":10,\"successful\":5,\"failed\":0}}\r\n{\r\n \"took\" : 1,\r\n \"timed_out\" : false,\r\n \"_shards\" : {\r\n   \"total\" : 5,\r\n   \"successful\" : 5,\r\n   \"skipped\" : 0,\r\n   \"failed\" : 0\r\n },\r\n \"hits\" : {\r\n   \"total\" : 3,\r\n   \"max_score\" : 1.0,\r\n   \"hits\" : [\r\n     {\r\n       \"_index\" : \"my-test-index\",\r\n       \"_type\" : \"document\",\r\n       \"_id\" : \"BUrfN2gBWLZgAGEHAtY2\",\r\n       \"_score\" : 1.0,\r\n       \"_source\" : {\r\n         \"amount\" : 49.95,\r\n         \"index\" : 2\r\n       }\r\n     },\r\n     {\r\n       \"_index\" : \"my-test-index\",\r\n       \"_type\" : \"document\",\r\n       \"_id\" : \"BErfN2gBWLZgAGEHAdb8\",\r\n       \"_score\" : 1.0,\r\n       \"_source\" : {\r\n         \"amount\" : 49.95,\r\n         \"index\" : 1\r\n       }\r\n     },\r\n     {\r\n       \"_index\" : \"my-test-index\",\r\n       \"_type\" : \"document\",\r\n       \"_id\" : \"BkrfN2gBWLZgAGEHAtZd\",\r\n       \"_score\" : 1.0,\r\n       \"_source\" : {\r\n         \"amount\" : 49.95,\r\n         \"index\" : 3\r\n       }\r\n     }\r\n   ]\r\n },\r\n \"aggregations\" : {\r\n   \"amount\" : {\r\n     \"count\" : 3,\r\n     \"min\" : 49.95,\r\n     \"max\" : 49.95,\r\n     \"avg\" : 49.95000000000001,\r\n     \"sum\" : 149.85000000000002,\r\n     \"sum_of_squares\" : 7485.0075000000015,\r\n     \"variance\" : -3.0316490059097606E-13,\r\n     \"std_deviation\" : \"NaN\",\r\n     \"std_deviation_bounds\" : {\r\n       \"upper\" : \"NaN\",\r\n       \"lower\" : \"NaN\"\r\n     }\r\n   }\r\n }\r\n}\r\n```\r\n\r\n\r\n**File used to reproduce**:\r\n[to-reproduce-it.zip](https://github.com/elastic/elasticsearch/files/2745481/to-reproduce-it.zip)\r\n","closed_by":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}