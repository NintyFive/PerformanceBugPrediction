[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389263318","html_url":"https://github.com/elastic/elasticsearch/issues/30624#issuecomment-389263318","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624","id":389263318,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTI2MzMxOA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-15T18:15:41Z","updated_at":"2018-05-15T18:15:41Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-security","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389445664","html_url":"https://github.com/elastic/elasticsearch/issues/30624#issuecomment-389445664","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624","id":389445664,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTQ0NTY2NA==","user":{"login":"james-uffindell-granta","id":27734625,"node_id":"MDQ6VXNlcjI3NzM0NjI1","avatar_url":"https://avatars3.githubusercontent.com/u/27734625?v=4","gravatar_id":"","url":"https://api.github.com/users/james-uffindell-granta","html_url":"https://github.com/james-uffindell-granta","followers_url":"https://api.github.com/users/james-uffindell-granta/followers","following_url":"https://api.github.com/users/james-uffindell-granta/following{/other_user}","gists_url":"https://api.github.com/users/james-uffindell-granta/gists{/gist_id}","starred_url":"https://api.github.com/users/james-uffindell-granta/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/james-uffindell-granta/subscriptions","organizations_url":"https://api.github.com/users/james-uffindell-granta/orgs","repos_url":"https://api.github.com/users/james-uffindell-granta/repos","events_url":"https://api.github.com/users/james-uffindell-granta/events{/privacy}","received_events_url":"https://api.github.com/users/james-uffindell-granta/received_events","type":"User","site_admin":false},"created_at":"2018-05-16T08:53:44Z","updated_at":"2018-05-16T08:53:44Z","author_association":"NONE","body":"There's what seems to be a related issue where you don't get an error, but you do get the wrong inner hit back.\r\n\r\nIf you repeat the above steps, but instead index the document\r\n```\r\n{\r\n\t\"document_name\": \"followup testing\",\r\n\t\"metadata\": [\r\n\t\t{\r\n\t\t\t\"name\": \"numeric\",\r\n\t\t\t\"nv\": 0.1\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"name\": \"string\",\r\n\t\t\t\"sv\": \"problem\"\r\n\t\t},\r\n\t\t{\r\n\t\t\t\"name\": \"second\",\r\n\t\t\t\"sv\": \"kitten\"\r\n\t\t}\r\n\t]\r\n}\r\n```\r\n\r\nand rerun the search which throws an exception, you no longer get an exception, but the \"inner_hits\" part of the response contains the \"kitten\" metadata field instead of the \"problem\" one which you actually searched for.\r\n\r\nThis seems consistent with the guess that it locates the array index of the inner hit before doing the filtering, and looks it up properly afterwards.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389572789","html_url":"https://github.com/elastic/elasticsearch/issues/30624#issuecomment-389572789","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30624","id":389572789,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTU3Mjc4OQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2018-05-16T16:00:12Z","updated_at":"2018-05-16T16:00:12Z","author_association":"MEMBER","body":"@james-uffindell-granta Thanks for reporting this problem. The inner hit source filtering is not working correctly with field level security.\r\n\r\nStacktrace of the first request:\r\n\r\n```\r\n[elasticsearch] [2018-05-16T17:56:48,844][WARN ][r.suppressed             ] path: /test/_search, params: {index=test}\r\n[elasticsearch] org.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n[elasticsearch]         at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:293) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:133) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:254) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:101) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:222) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:176) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:222) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:535) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1095) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1188) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1172) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:66) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.SearchTransportService$6$1.onFailure(SearchTransportService.java:393) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:340) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:334) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:328) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService$3.doRun(SearchService.java:1015) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:724) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1135) [?:?]\r\n[elasticsearch]         at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) [?:?]\r\n[elasticsearch]         at java.lang.Thread.run(Thread.java:844) [?:?]\r\n[elasticsearch] Caused by: org.elasticsearch.ElasticsearchException$1: Index 1 out-of-bounds for length 1\r\n[elasticsearch]         at org.elasticsearch.ElasticsearchException.guessRootCauses(ElasticsearchException.java:658) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:131) [elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         ... 26 more\r\n[elasticsearch] Caused by: java.lang.IndexOutOfBoundsException: Index 1 out-of-bounds for length 1\r\n[elasticsearch]         at jdk.internal.util.Preconditions.outOfBounds(Preconditions.java:64) ~[?:?]\r\n[elasticsearch]         at jdk.internal.util.Preconditions.outOfBoundsCheckIndex(Preconditions.java:70) ~[?:?]\r\n[elasticsearch]         at jdk.internal.util.Preconditions.checkIndex(Preconditions.java:248) ~[?:?]\r\n[elasticsearch]         at java.util.Objects.checkIndex(Objects.java:372) ~[?:?]\r\n[elasticsearch]         at java.util.ArrayList.get(ArrayList.java:440) ~[?:?]\r\n[elasticsearch]         at org.elasticsearch.search.fetch.FetchPhase.createNestedSearchHit(FetchPhase.java:295) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:153) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitsExecute(InnerHitsFetchSubPhase.java:69) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:170) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:392) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:367) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n[elasticsearch]         at org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:332) ~[elasticsearch-7.0.0-alpha1-SNAPSHOT.jar:7.0.0-alpha1-SNAPSHOT]\r\n```","performed_via_github_app":null}]