{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3494","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3494/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3494/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3494/events","html_url":"https://github.com/elastic/elasticsearch/issues/3494","id":17984894,"node_id":"MDU6SXNzdWUxNzk4NDg5NA==","number":3494,"title":"Does not analyze query string","user":{"login":"jcassee","id":20749,"node_id":"MDQ6VXNlcjIwNzQ5","avatar_url":"https://avatars1.githubusercontent.com/u/20749?v=4","gravatar_id":"","url":"https://api.github.com/users/jcassee","html_url":"https://github.com/jcassee","followers_url":"https://api.github.com/users/jcassee/followers","following_url":"https://api.github.com/users/jcassee/following{/other_user}","gists_url":"https://api.github.com/users/jcassee/gists{/gist_id}","starred_url":"https://api.github.com/users/jcassee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcassee/subscriptions","organizations_url":"https://api.github.com/users/jcassee/orgs","repos_url":"https://api.github.com/users/jcassee/repos","events_url":"https://api.github.com/users/jcassee/events{/privacy}","received_events_url":"https://api.github.com/users/jcassee/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2013-08-13T08:32:10Z","updated_at":"2013-08-18T00:13:55Z","closed_at":"2013-08-18T00:13:55Z","author_association":"NONE","active_lock_reason":null,"body":"As per the [discussion on the list](https://groups.google.com/d/topic/elasticsearch/NHR4uRa0y8E/discussion) the query_string query does not analyze the search string. (There was no resolution on the list or the IRC channel, so I am assuming a problem with elasticsearch.)\n\nI use the following analyzer configuration:\n\n``` yaml\nindex:\n    analysis: \n        analyzer: \n            default: \n                alias: [goabout]\n                type: custom\n                tokenizer: standard\n                filter: [lowercase, synonym, standard, asciifolding]\n                char_filter: [char_mapper]\n            postal_code: \n                tokenizer: keyword\n                filter: [lowercase]\n        tokenizer: \n            standard: \n                stopwords: []\n        filter: \n            synonym: \n                type: synonym\n                synonyms:\n                  - st => sint\n                  - den haag => s gravenhage\n                  - den bosch => s hertogenbosch\n                  - jp => jan pieterszoon\n                  - mh => maarten harpertszoon\n        char_filter: \n            char_mapper: \n                type: mapping\n                mappings:\n                  - ij => y\n```\n\n(I also tried naming the analyzer `goabout` and aliasing it to `default`, but that does not change the results.)\n\nAnd this mapping for the `address` type:\n\n``` json\n{ \n    \"properties\": { \n        \"street\":      { \"type\": \"string\" }, \n        \"housenumber\": { \"type\": \"string\" }, \n        \"postal_code\": { \"type\": \"string\", \"analyzer\": \"postal_code\" }, \n        \"city\":        { \"type\": \"string\" }, \n        \"point\":       { \"type\": \"geo_point\" } \n    } \n} \n```\n\nI then the index the following document:\n\n``` console\n$ curl -XPUT http://localhost:9200/geocoder/address/1 -d \"{\\\"city\\\": \\\"'s-Gravenhage\\\", \\\"point\\\": {\\\"lat\\\": 52.034608082483366, \\\"lon\\\": 4.266201580347966}, \\\"street\\\": \\\"Wantsnijdersgaarde\\\", \\\"postal_code\\\": \\\"2542 GN\\\", \\\"housenumber\\\": \\\"573\\\"}\"\n```\n\nThe analyzer works correctly:\n\n``` console\n$ curl -X GET \"http://localhost:9200/geocoder/_analyze?pretty=true\" -d \"Den Haag\"     \n{\n  \"tokens\" : [ {\n    \"token\" : \"s\",\n    \"start_offset\" : 0,\n    \"end_offset\" : 3,\n    \"type\" : \"SYNONYM\",\n    \"position\" : 1\n  }, {\n    \"token\" : \"gravenhage\",\n    \"start_offset\" : 4,\n    \"end_offset\" : 8,\n    \"type\" : \"SYNONYM\",\n    \"position\" : 2\n  } ]\n}\n```\n\nThe analyzer seems to get use in both indexing and querying, as this query (that exchanges \"y\" for \"ij\") finds the document:\n\n``` console\n$ curl -X GET \"http://localhost:9200/geocoder/_search?q=Wantsnydersgaarde&analyzer=goabout&pretty=true\"       \n{\n  \"took\" : 5,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 0.095891505,\n    \"hits\" : [ {\n      \"_index\" : \"geocoder\",\n      \"_type\" : \"address\",\n      \"_id\" : \"1\",\n      \"_score\" : 0.095891505, \"_source\" : {\"city\": \"'s-Gravenhage\", \"point\": {\"lat\": 52.034608082483366, \"lon\": 4.266201580347966}, \"street\": \"Wantsnijdersgaarde\", \"postal_code\": \"2542 GN\", \"housenumber\": \"573\"}\n    } ]\n  }\n}\n```\n\nAlso, querying for the indexed terms show the \"ij\" -> \"y\" filter has processed the fields:\n\n``` console\n$ curl 'http://localhost:9200/geocoder/_search?pretty=true' -d '{ \n    \"query\" : { \n        \"match_all\" : { } \n    }, \n    \"script_fields\": { \n        \"terms\" : { \n            \"script\": \"doc[field].values\", \n            \"params\": { \n                \"field\": \"_all\" \n            } \n        } \n\n    } \n}' \n{ \n  \"took\" : 10, \n  \"timed_out\" : false, \n  \"_shards\" : { \n    \"total\" : 5, \n    \"successful\" : 5, \n    \"failed\" : 0 \n  }, \n  \"hits\" : { \n    \"total\" : 1, \n    \"max_score\" : 1.0, \n    \"hits\" : [ { \n      \"_index\" : \"geocoder\", \n      \"_type\" : \"address\", \n      \"_id\" : \"1\", \n      \"_score\" : 1.0, \n      \"fields\" : { \n        \"terms\" : [ \"2542\", \"573\", \"gn\", \"gravenhage\", \"s\", \n\"wantsnydersgaarde\" ] \n      } \n    } ] \n  } \n} \n```\n\nBut this search query does not return results:\n\n```\n$ curl -X GET \"http://localhost:9200/geocoder/_search?q=den+haag&analyzer=goabout&pretty=true\"       \n{\n  \"took\" : 5,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 0,\n    \"max_score\" : null,\n    \"hits\" : [ ]\n  }\n}\n```\n\nSo apparently the query string is not analyzed.\n","closed_by":{"login":"jcassee","id":20749,"node_id":"MDQ6VXNlcjIwNzQ5","avatar_url":"https://avatars1.githubusercontent.com/u/20749?v=4","gravatar_id":"","url":"https://api.github.com/users/jcassee","html_url":"https://github.com/jcassee","followers_url":"https://api.github.com/users/jcassee/followers","following_url":"https://api.github.com/users/jcassee/following{/other_user}","gists_url":"https://api.github.com/users/jcassee/gists{/gist_id}","starred_url":"https://api.github.com/users/jcassee/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jcassee/subscriptions","organizations_url":"https://api.github.com/users/jcassee/orgs","repos_url":"https://api.github.com/users/jcassee/repos","events_url":"https://api.github.com/users/jcassee/events{/privacy}","received_events_url":"https://api.github.com/users/jcassee/received_events","type":"User","site_admin":false},"performed_via_github_app":null}