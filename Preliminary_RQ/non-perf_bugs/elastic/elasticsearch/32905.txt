{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32905","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32905/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32905/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32905/events","html_url":"https://github.com/elastic/elasticsearch/issues/32905","id":351176244,"node_id":"MDU6SXNzdWUzNTExNzYyNDQ=","number":32905,"title":"[ML] Metadata Migration Meta issue","user":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":158399402,"node_id":"MDU6TGFiZWwxNTgzOTk0MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Meta","name":"Meta","color":"e11d21","default":false,"description":null},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-08-16T12:05:09Z","updated_at":"2019-06-26T12:39:49Z","closed_at":"2019-06-26T12:39:48Z","author_association":"MEMBER","active_lock_reason":null,"body":"Anomaly detector jobs and datafeed configurations are currently stored in the cluster state, the initial design decision was based on the need to distribute work across the cluster. After persistent tasks were invented -and with a little hindsight- it is not necessary to store config in the cluster state if the persistent task parameters contain enough information to open a job and start a datafeed. \r\n\r\nPlacing config in the cluster state has caused a number of issues:\r\n\r\n- Jobs cannot be easily transferred to another cluster\r\n- User defined searches in the datafeed may use deprecated features removed in the next version. After upgrading this can fail reading the cluster state as parsing the removed feature throws an exception \r\n- If you restore a snapshotted cluster state you restore all jobs that existed at the time the snapshot was taken\r\n- Jobs do not recover if the cluster state is lost #30088\r\n- Adding new types of job or changing the validation is difficult or impossible in a backwards compatible manner #30084 #30070\r\n\r\n### Proposal\r\nStarting in 6.last new job and datafeed configurations will be stored in a new internal index `.ml-config`. Jobs created prior to 6.last will be migrated to index documents and removed from the cluster state with the goal of removing all ml data from the cluster state. 7.x will retain the ability to  read jobs from the cluster state to support full cluster upgrades and restoring a snapshot containing a global cluster state. The preferred solution is to automatically migrate extant cluster state jobs on allocation. In the 8 series all the code to handle ml config in cluster state will be dropped. \r\n\r\n### Work Plan\r\nWork will be done on the feature branch `feature/feature-jindex-6x` and `feature/feature-jindex-master` with regular merges. The first stage is the changes required to create and run a job with its configuration stored in an index. Once that is stable and passing the testing gate the migration of existing jobs on upgrade will be tackled.  \r\n\r\n### Phase 1: Run Jobs with their configuration defined in an index\r\n- [x] Add the `.ml-config` index template with job and datafeed mappings #32719\r\n- [x] Add class to handle read/write/update/deletes on config documents #32854 #32738\r\n- [x] Wildcard expansion for getting jobs and datafeed e.g. `_all`, `foo-*`. This replaces the MlMetaData Group or Job Lookup functionality #32854 #32738\r\n- [x] Change JobManager to operate on migrated configs #33064\r\n- [x] Change DatafeedManager to operate on migrated configs #33273\r\n- [x] The OpenJobPersistentTasksExecutor validate and selectLeastLoadedMlNode methods require information that can no longer be read from the cluster state #34084\r\n- [x] DatafeedNodeSelector requires information that can no longer be read from the cluster state #34218\r\n- [x] Close job and TransportFinalizeJobExecutionAction must be changed so it doesn't update the cluster state #34217 #34226\r\n- [x] AbstractExpiredJobDataRemover must read migrated job configurations #34532\r\n- [x] Delete job and implement the equivalent of markJobAsDeleting #34595\r\n- [x] Get job and datafeed stats #34645 \r\n- [x] All the endpoints #34605 #34642 #34710\r\n- [x] All the tests (excluding rolling upgrade) #34851\r\n- [x] Replace Version.CURRENT with the release version #36118\r\n\r\n### Phase 1a: 6.6 & 6.7 Jobs can be defined in the clusterstate or an index document\r\n- [x] All reads of config must check both index and clusterstate #35344 #35539 #35590 #35598\r\n- [x] Upgrade tests #35700 #36593\r\n\r\n\r\n### Phase 2: Migrate Job and Datafeed Configuration\r\n- [x] Where config exists in both index and clusterstate prefer ~~index~~ clusterstate #35940 #36014\r\n- [x] Create a migration class for jobs and datafeeds #35834\r\n- [x] Automatically migrate closed jobs and datafeeds #35834 #36425 #36481\r\n- [x] Migrate open jobs and datafeeds once they become unallocated #37430 #37536\r\n\r\n### Issues\r\n- [x] Alternative method to share job memory usage. **Blocker** #34084 #35263\r\n- [x] Parsing deprecated and removed features in Datafeed Config **Blocker** #34858\r\n- [x] Backup MlMetadata before starting migration #36422 \r\n- [x] Repeatedly migrate config in batches #36716 \r\n- [x] Create .`ml-config` index in case autocreate is disabled #36608\r\n- [x] Transient setting override #36700\r\n- [x] Check .ml-config is yellow #36608\r\n- [x] CI failure MlDistributedFailureIT.testLoseDedicatedMasterNode #36760\r\n- [x] CI failure RestoreModelSnapshotIT #36849\r\n- [x] CI failure MlMigrationFullClusterRestartIT #36816\r\n- [x] CI failure 60_ml_config_migration #36810\r\n- [x] CI failure model mem limit #36961\r\n- [x] NPE in MachineLearningFeatureSet.addJobsUsage elastic/ml-cpp#351\r\n- [x] UnusedStateRemover will remove all state for jobs not in cluster state **Blocker** #37109\r\n- [x] MachineLearningLicensingTests #37117 \r\n\r\n### Nice to haves\r\n- [ ] TransportJobTaskAction no longer throws missing job #34747\r\n- [ ] Get Jobs response is limited by search size  #34864 #36608\r\n- [ ] Consider changing where config is validated #34899 \r\n- [ ] Use custom all field for configs #36445 \r\n- [x] Don't write empty lists of jobs and datafeeds in MlMetadata.toXContent #36421\r\n- [ ] Index aliases for .ml-config\r\n- [ ] OpenJobParams (p task params) contain the full job when only certain fields are required\r\n- [ ] Ensure ordering of updates to the autodetect process","closed_by":{"login":"davidkyle","id":2353640,"node_id":"MDQ6VXNlcjIzNTM2NDA=","avatar_url":"https://avatars1.githubusercontent.com/u/2353640?v=4","gravatar_id":"","url":"https://api.github.com/users/davidkyle","html_url":"https://github.com/davidkyle","followers_url":"https://api.github.com/users/davidkyle/followers","following_url":"https://api.github.com/users/davidkyle/following{/other_user}","gists_url":"https://api.github.com/users/davidkyle/gists{/gist_id}","starred_url":"https://api.github.com/users/davidkyle/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/davidkyle/subscriptions","organizations_url":"https://api.github.com/users/davidkyle/orgs","repos_url":"https://api.github.com/users/davidkyle/repos","events_url":"https://api.github.com/users/davidkyle/events{/privacy}","received_events_url":"https://api.github.com/users/davidkyle/received_events","type":"User","site_admin":false},"performed_via_github_app":null}