{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37591","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37591/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37591/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37591/events","html_url":"https://github.com/elastic/elasticsearch/issues/37591","id":400491350,"node_id":"MDU6SXNzdWU0MDA0OTEzNTA=","number":37591,"title":"consistent test failures with :x-pack:qa:openldap-tests:unitTest ","user":{"login":"jakelandis","id":976291,"node_id":"MDQ6VXNlcjk3NjI5MQ==","avatar_url":"https://avatars2.githubusercontent.com/u/976291?v=4","gravatar_id":"","url":"https://api.github.com/users/jakelandis","html_url":"https://github.com/jakelandis","followers_url":"https://api.github.com/users/jakelandis/followers","following_url":"https://api.github.com/users/jakelandis/following{/other_user}","gists_url":"https://api.github.com/users/jakelandis/gists{/gist_id}","starred_url":"https://api.github.com/users/jakelandis/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jakelandis/subscriptions","organizations_url":"https://api.github.com/users/jakelandis/orgs","repos_url":"https://api.github.com/users/jakelandis/repos","events_url":"https://api.github.com/users/jakelandis/events{/privacy}","received_events_url":"https://api.github.com/users/jakelandis/received_events","type":"User","site_admin":false},"labels":[{"id":912838879,"node_id":"MDU6TGFiZWw5MTI4Mzg4Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Security","name":":Security/Security","color":"0e8a16","default":false,"description":"Security issues without another label"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"}],"state":"closed","locked":false,"assignee":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"assignees":[{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-01-17T22:30:41Z","updated_at":"2019-01-18T19:43:40Z","closed_at":"2019-01-18T19:43:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"\r\nThe following will reliable fail on both 6.x and master.\r\n```\r\n./gradlew clean :x-pack:qa:openldap-tests:unitTest\r\n```\r\nIt reproduces irregardless of seed. \r\n\r\n6.x\r\n```\r\n  1> [2019-01-18T01:23:17,040][INFO ][o.e.x.s.a.l.OpenLdapUserSearchSessionFactoryTests] [testUserSearchWithBindUserOpenLDAP] before test\r\n  1> [2019-01-18T01:23:17,439][DEBUG][o.e.x.c.s.SSLService     ] [testUserSearchWithBindUserOpenLDAP] using ssl settings [SSLConfiguration{keyConfig=[NONE], trustConfig=ca=[/home/jake/workspace/elasticsearch/x-pack/qa/openldap-tests/build/generated-resources/openldap-tests/ca.crt]], cipherSuites=[[TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA384, TLS_ECDHE_ECDSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_256_CBC_SHA, TLS_RSA_WITH_AES_256_CBC_SHA256, TLS_RSA_WITH_AES_256_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA256, TLS_ECDHE_ECDSA_WITH_AES_128_CBC_SHA, TLS_ECDHE_RSA_WITH_AES_128_CBC_SHA, TLS_RSA_WITH_AES_128_CBC_SHA256, TLS_RSA_WITH_AES_128_CBC_SHA]], supportedProtocols=[[TLSv1.2, TLSv1.1, TLSv1]], sslClientAuth=[REQUIRED], verificationMode=[FULL]}]\r\n  1> [2019-01-18T01:23:17,628][WARN ][o.e.d.x.c.s.SSLService   ] [testUserSearchWithBindUserOpenLDAP] SSL configuration [xpack.http.ssl] relies upon fallback to another configuration for [trust configuration], which is deprecated.\r\n  1> [2019-01-18T01:23:17,678][INFO ][o.e.x.s.a.l.LdapUserSearchSessionFactory] [testUserSearchWithBindUserOpenLDAP] Realm [oldap-test] is in user-search mode - base_dn=[ou=people,dc=oldap,dc=test,dc=elasticsearch,dc=com], search filter=[(uid={0})]\r\n  2> REPRODUCE WITH: ./gradlew :x-pack:qa:openldap-tests:unitTest -Dtests.seed=A9B1920977D5FDA2 -Dtests.class=org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests -Dtests.method=\"testUserSearchWithBindUserOpenLDAP\" -Dtests.security.manager=true -Dtests.locale=el-CY -Dtests.timezone=Africa/Kampala -Dcompiler.java=11 -Druntime.java=8\r\nFAILURE 1.45s J1 | OpenLdapUserSearchSessionFactoryTests.testUserSearchWithBindUserOpenLDAP <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: unexpected warning headers expected null, but was:<[299 Elasticsearch-6.7.0-SNAPSHOT-faa5aca \"SSL configuration [xpack.http.ssl] relies upon fallback to another configuration for [trust configuration], which is deprecated.\" \"Thu, 17 Jan 2019 22:23:17 GMT\"]>\r\n   >    at __randomizedtesting.SeedInfo.seed([A9B1920977D5FDA2:66D5D5F4682AF1AC]:0)\r\n   >    at org.elasticsearch.test.ESTestCase.ensureNoWarnings(ESTestCase.java:378)\r\n   >    at org.elasticsearch.test.ESTestCase.after(ESTestCase.java:356)\r\n   >    at java.lang.Thread.run(Thread.java:748)\r\n  2> NOTE: leaving temporary files on disk at: /home/jake/workspace/elasticsearch/x-pack/qa/openldap-tests/build/testrun/unitTest/J1/temp/org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests_A9B1920977D5FDA2-001\r\n  2> NOTE: test params are: codec=Asserting(Lucene70): {}, docValues:{}, maxPointsInLeafNode=1631, maxMBSortInHeap=7.811575863060436, sim=RandomSimilarity(queryNorm=false): {}, locale=el-CY, timezone=Africa/Kampala\r\n  2> NOTE: Linux 4.19.13-200.fc28.x86_64 amd64/Oracle Corporation 1.8.0_171 (64-bit)/cpus=8,threads=1,free=443516472,total=514850816\r\n  2> NOTE: All tests run in this JVM: [OpenLdapUserSearchSessionFactoryTests]\r\nCompleted [1/3] on J1 in 3.44s, 1 test, 1 failure <<< FAILURES!\r\n```\r\n\r\nMaster (this might be a local setup issue)\r\n```  1> [2019-01-18T09:19:07,495][INFO ][o.e.x.s.a.l.OpenLdapUserSearchSessionFactoryTests] [testUserSearchWithBindUserOpenLDAP] after test\r\n  2> REPRODUCE WITH: ./gradlew :x-pack:qa:openldap-tests:unitTest -Dtests.seed=9C31A8FBC6D9742 -Dtests.class=org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests -Dtests.method=\"testUserSearchWithBindUserOpenLDAP\" -Dtests.security.manager=true -Dtests.locale=en-IN -Dtests.timezone=Pacific/Pohnpei -Dcompiler.java=11 -Druntime.java=8\r\nERROR   0.89s J1 | OpenLdapUserSearchSessionFactoryTests.testUserSearchWithBindUserOpenLDAP <<< FAILURES!\r\n   > Throwable #1: UncategorizedExecutionException[Failed execution]; nested: ExecutionException[LDAPException(resultCode=91 (connect error), errorMessage='An error occurred while attempting to connect to server localhost:60636:  IOException(LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812'))')]; nested: LDAPException[An error occurred while attempting to connect to server localhost:60636:  IOException(LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812'))]; nested: IOException[LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812')]; nested: LDAPException[Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812]; nested: SSLPeerUnverifiedException[peer not authenticated];\r\n   >    at __randomizedtesting.SeedInfo.seed([9C31A8FBC6D9742:C6A75D72A3929B4C]:0)\r\n   >    at org.elasticsearch.common.util.concurrent.FutureUtils.rethrowExecutionException(FutureUtils.java:101)\r\n   >    at org.elasticsearch.common.util.concurrent.FutureUtils.get(FutureUtils.java:62)\r\n   >    at org.elasticsearch.action.support.AdapterActionFuture.actionGet(AdapterActionFuture.java:34)\r\n   >    at org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests.session(OpenLdapUserSearchSessionFactoryTests.java:130)\r\n   >    at org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests.testUserSearchWithBindUserOpenLDAP(OpenLdapUserSearchSessionFactoryTests.java:105)\r\n   >    at java.lang.Thread.run(Thread.java:748)\r\n   > Caused by: java.util.concurrent.ExecutionException: LDAPException(resultCode=91 (connect error), errorMessage='An error occurred while attempting to connect to server localhost:60636:  IOException(LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812'))')\r\n   >    at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.getValue(BaseFuture.java:266)\r\n   >    at org.elasticsearch.common.util.concurrent.BaseFuture$Sync.get(BaseFuture.java:253)\r\n   >    at org.elasticsearch.common.util.concurrent.BaseFuture.get(BaseFuture.java:87)\r\n   >    at org.elasticsearch.common.util.concurrent.FutureUtils.get(FutureUtils.java:57)\r\n   >    ... 40 more\r\n   > Caused by: LDAPException(resultCode=91 (connect error), errorMessage='An error occurred while attempting to connect to server localhost:60636:  IOException(LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812'))')\r\n   >    at com.unboundid.ldap.sdk.LDAPConnection.connect(LDAPConnection.java:870)\r\n   >    at com.unboundid.ldap.sdk.LDAPConnection.connect(LDAPConnection.java:760)\r\n   >    at com.unboundid.ldap.sdk.LDAPConnection.connect(LDAPConnection.java:710)\r\n   >    at com.unboundid.ldap.sdk.LDAPConnection.<init>(LDAPConnection.java:534)\r\n   >    at com.unboundid.ldap.sdk.SingleServerSet.getConnection(SingleServerSet.java:307)\r\n   >    at com.unboundid.ldap.sdk.FailoverServerSet.getConnection(FailoverServerSet.java:653)\r\n   >    at com.unboundid.ldap.sdk.FailoverServerSet.getConnection(FailoverServerSet.java:567)\r\n   >    at java.security.AccessController.doPrivileged(Native Method)\r\n   >    at org.elasticsearch.xpack.security.authc.ldap.support.LdapUtils.privilegedConnect(LdapUtils.java:74)\r\n   >    at org.elasticsearch.xpack.security.authc.ldap.LdapUserSearchSessionFactory.getSessionWithoutPool(LdapUserSearchSessionFactory.java:112)\r\n   >    at org.elasticsearch.xpack.security.authc.ldap.PoolingSessionFactory.session(PoolingSessionFactory.java:102)\r\n   >    at org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests.session(OpenLdapUserSearchSessionFactoryTests.java:129)\r\n   >    ... 38 more\r\n   > Caused by: java.io.IOException: LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812')\r\n   >    at com.unboundid.ldap.sdk.LDAPConnectionInternals.<init>(LDAPConnectionInternals.java:178)\r\n   >    at com.unboundid.ldap.sdk.LDAPConnection.connect(LDAPConnection.java:860)\r\n   >    ... 49 more\r\n   > Caused by: LDAPException(resultCode=91 (connect error), errorMessage='Unable to verify an attempt to to establish a secure connection to 'localhost:60636' because an unexpected error was encountered during validation processing:  SSLPeerUnverifiedException(peer not authenticated), ldapSDKVersion=4.0.8, revision=28812')\r\n   >    at com.unboundid.util.ssl.HostNameSSLSocketVerifier.verifySSLSocket(HostNameSSLSocketVerifier.java:146)\r\n   >    at com.unboundid.ldap.sdk.LDAPConnectionInternals.<init>(LDAPConnectionInternals.java:166)\r\n   >    ... 50 more\r\n   > Caused by: javax.net.ssl.SSLPeerUnverifiedException: peer not authenticated\r\n   >    at sun.security.ssl.SSLSessionImpl.getPeerCertificates(SSLSessionImpl.java:440)\r\n   >    at com.unboundid.util.ssl.HostNameSSLSocketVerifier.verifySSLSocket(HostNameSSLSocketVerifier.java:113)\r\n   >    ... 51 more\r\n  2> NOTE: leaving temporary files on disk at: /home/jake/workspace/elasticsearch/x-pack/qa/openldap-tests/build/testrun/unitTest/J1/temp/org.elasticsearch.xpack.security.authc.ldap.OpenLdapUserSearchSessionFactoryTests_9C31A8FBC6D9742-001\r\n  2> NOTE: test params are: codec=Asserting(Lucene80): {}, docValues:{}, maxPointsInLeafNode=2025, maxMBSortInHeap=6.9218108535077105, sim=Asserting(org.apache.lucene.search.similarities.AssertingSimilarity@11da7e90), locale=en-IN, timezone=Pacific/Pohnpei\r\n  2> NOTE: Linux 4.19.13-200.fc28.x86_64 amd64/Oracle Corporation 1.8.0_171 (64-bit)/cpus=8,threads=1,free=452836240,total=514850816\r\n  2> NOTE: All tests run in this JVM: [OpenLdapUserSearchSessionFactoryTests]\r\nCompleted [1/3] on J1 in 2.74s, 1 test, 1 error <<< FAILURES!\r\n```\r\n","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}