[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389875747","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-389875747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":389875747,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTg3NTc0Nw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T13:57:59Z","updated_at":"2018-05-17T13:57:59Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389910219","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-389910219","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":389910219,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTkxMDIxOQ==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T15:35:54Z","updated_at":"2018-05-17T15:35:54Z","author_association":"CONTRIBUTOR","body":"Todd, thank you for filing this request. This would be really helpful enhancement / feature and I hope this is implemented ASAP. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389915914","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-389915914","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":389915914,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTkxNTkxNA==","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T15:52:33Z","updated_at":"2018-05-17T15:52:33Z","author_association":"MEMBER","body":"I'm not sure I understand how we could achieve this without hitting all the documents. We have no idea before collecting documents which buckets might be created. In theory we can look at the range of values in the whole shard but this:\r\n1. does not generalise well to all aggregations (I think if we implemented a feature like this it would be important it applied to more than one aggregation)\r\n2. Does not take into account the fact that the query can vastly limit the buckets collected (the query does not have to be a date range query to limit the results to a much smaller number of buckets)\r\n\r\nSo the only way to know how many buckets will be created by an aggregation is to collect the documents that match the query and create the resulting buckets, which means we can't do much better than just running the aggregation IMO.\r\n\r\nCan we take a bit of a step back here and can I ask, what is the problem you are trying to solve by this request? What issue is causing this feature request?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/389973902","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-389973902","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":389973902,"node_id":"MDEyOklzc3VlQ29tbWVudDM4OTk3MzkwMg==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2018-05-17T19:01:26Z","updated_at":"2018-05-17T19:01:26Z","author_association":"CONTRIBUTOR","body":"@colings86 \r\nThank you for sharing your thoughts.\r\n\r\nFollowing is the use case:\r\nWe want to calculate an aggregation not supported by Elasticsearch (e.g. Cumulative Moving Metric) for date histogram chosen by our customer (could be day, week, month, quarter, etc....). If you select a date filter that's too wide, it can return a lot of buckets. In other words, the payload could be large enough for ES cluster to run out of memory. We want to add safeguards / limits to avoid blowing up Elasticsearch node by checking the number of buckets / cardinality before we actually request the payload. If the cardinality is too high, we can return a 400 error in our API. \r\n\r\nThe request is same as cardinality aggregation, but for date histogram. \r\n\r\nThinking out possible solutions loud:\r\n**Solution 1**\r\n\r\n1. Fetch the record with oldest date (and optionally latest) from the index.\r\n2. Calculate the number of buckets based on the granularity of histogram (e.g. day, week, month, etc...) that includes the empty buckets. No need to scan through the index. \r\n3. Return the number of buckets instead of the actual count.\r\n\r\n**Solution 2**\r\nInstead of returning all the buckets, provide an option to return the count of buckets. Elasticsearch will still generate the buckets, but just wouldn't return the actual payload. \r\n\r\n- Pro: Don't waste resources in the API cluster\r\n- Con: Doesn't avoid the problem if large cardinality and possibility of OOM","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/390114157","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-390114157","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":390114157,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MDExNDE1Nw==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-05-18T07:00:28Z","updated_at":"2018-05-18T07:00:28Z","author_association":"MEMBER","body":"In 6.2 we added a new dynamic cluster setting called `search.max_bucket` that fails requests that try to return more than N bucket:\r\nhttps://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket.html\r\n It is disabled by default in 6.x and set to `10,000` by default in 7. This setting is applied at the shard level and in the coordinating node when the aggregation responses are merged. It doesn't prevent OOM completely since the number of buckets is checked at the end of the collection on each shard (we collect all buckets and then check the number of reduced buckets that need to be sent to the coordinating node) but it will prevent the coordinating node to run the pipeline aggregation if the number of buckets is too high. In a sense it is similar to the second solution that you propose but it is not restricted to `date_histogram` or single level aggregation and can be integrated in the main request (no need to run a pre-aggregation).","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/391861233","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-391861233","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":391861233,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MTg2MTIzMw==","user":{"login":"tomcallahan","id":15988488,"node_id":"MDQ6VXNlcjE1OTg4NDg4","avatar_url":"https://avatars1.githubusercontent.com/u/15988488?v=4","gravatar_id":"","url":"https://api.github.com/users/tomcallahan","html_url":"https://github.com/tomcallahan","followers_url":"https://api.github.com/users/tomcallahan/followers","following_url":"https://api.github.com/users/tomcallahan/following{/other_user}","gists_url":"https://api.github.com/users/tomcallahan/gists{/gist_id}","starred_url":"https://api.github.com/users/tomcallahan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tomcallahan/subscriptions","organizations_url":"https://api.github.com/users/tomcallahan/orgs","repos_url":"https://api.github.com/users/tomcallahan/repos","events_url":"https://api.github.com/users/tomcallahan/events{/privacy}","received_events_url":"https://api.github.com/users/tomcallahan/received_events","type":"User","site_admin":false},"created_at":"2018-05-24T21:03:01Z","updated_at":"2018-05-24T21:03:01Z","author_association":"CONTRIBUTOR","body":"@animageofmine do you think @jimczi suggestion will work well?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/392268455","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-392268455","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":392268455,"node_id":"MDEyOklzc3VlQ29tbWVudDM5MjI2ODQ1NQ==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2018-05-26T15:27:47Z","updated_at":"2018-05-26T15:28:06Z","author_association":"CONTRIBUTOR","body":"@tomcallahan On a vacation right now, but will check as soon as I get back (next 5 days). Just wanted to ack in the meanwhile.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/402136823","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-402136823","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":402136823,"node_id":"MDEyOklzc3VlQ29tbWVudDQwMjEzNjgyMw==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-07-03T12:23:06Z","updated_at":"2018-07-03T12:23:06Z","author_association":"MEMBER","body":"hi @animageofmine did you have the chance to check this out? We would like to know whether the proposed solution works for you.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/410824414","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-410824414","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":410824414,"node_id":"MDEyOklzc3VlQ29tbWVudDQxMDgyNDQxNA==","user":{"login":"harishks","id":2930075,"node_id":"MDQ6VXNlcjI5MzAwNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/2930075?v=4","gravatar_id":"","url":"https://api.github.com/users/harishks","html_url":"https://github.com/harishks","followers_url":"https://api.github.com/users/harishks/followers","following_url":"https://api.github.com/users/harishks/following{/other_user}","gists_url":"https://api.github.com/users/harishks/gists{/gist_id}","starred_url":"https://api.github.com/users/harishks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/harishks/subscriptions","organizations_url":"https://api.github.com/users/harishks/orgs","repos_url":"https://api.github.com/users/harishks/repos","events_url":"https://api.github.com/users/harishks/events{/privacy}","received_events_url":"https://api.github.com/users/harishks/received_events","type":"User","site_admin":false},"created_at":"2018-08-06T19:24:37Z","updated_at":"2018-08-06T19:24:37Z","author_association":"NONE","body":"Hi! We are running into similar issues pointed out by @animageofmine in terms of memory usage for multi-term aggregations, and we were wondering if there are plans to expose the bucket count as part of the aggregation response? This would be very useful for our use-case where we plan the time_range of a aggregation based on the bucket_count. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/423437057","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-423437057","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":423437057,"node_id":"MDEyOklzc3VlQ29tbWVudDQyMzQzNzA1Nw==","user":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"created_at":"2018-09-21T07:12:01Z","updated_at":"2018-09-21T07:12:01Z","author_association":"CONTRIBUTOR","body":"Hey @animageofmine, we haven't heard back from you in more than 3 months and I'm assuming you adopted one solution after all. We would love to hear what did work for you in the end. Until then, though, I'll go ahead and close this issue since it stalled for too long. Please, feel free to update it afterwards if you have any feedback/follow up for us.\r\n\r\n@harishks even though your issue might be similar, the feature you are looking for is different. I suggest having a look at [`value_count` aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/6.4/search-aggregations-metrics-valuecount-aggregation.html) which might help you or, if you believe it's not the feature you are looking for, please raise another issue describing the new desired functionality.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/426686065","html_url":"https://github.com/elastic/elasticsearch/issues/30685#issuecomment-426686065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30685","id":426686065,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNjY4NjA2NQ==","user":{"login":"animageofmine","id":6426633,"node_id":"MDQ6VXNlcjY0MjY2MzM=","avatar_url":"https://avatars3.githubusercontent.com/u/6426633?v=4","gravatar_id":"","url":"https://api.github.com/users/animageofmine","html_url":"https://github.com/animageofmine","followers_url":"https://api.github.com/users/animageofmine/followers","following_url":"https://api.github.com/users/animageofmine/following{/other_user}","gists_url":"https://api.github.com/users/animageofmine/gists{/gist_id}","starred_url":"https://api.github.com/users/animageofmine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/animageofmine/subscriptions","organizations_url":"https://api.github.com/users/animageofmine/orgs","repos_url":"https://api.github.com/users/animageofmine/repos","events_url":"https://api.github.com/users/animageofmine/events{/privacy}","received_events_url":"https://api.github.com/users/animageofmine/received_events","type":"User","site_admin":false},"created_at":"2018-10-03T15:42:25Z","updated_at":"2018-10-03T15:42:25Z","author_association":"CONTRIBUTOR","body":"@astefan @javanna I am so sorry I didn't respond back to this (my bad). We don't have a clean solution unless we pull a reasonably large payload out of ES and compute ourselves, which is expensive. IMO, the best option is to consider implementing this in ES itself. Anything that you can do to help us would be really appreciated. ","performed_via_github_app":null}]