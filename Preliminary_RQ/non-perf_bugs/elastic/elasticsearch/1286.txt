{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1286","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1286/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1286/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1286/events","html_url":"https://github.com/elastic/elasticsearch/issues/1286","id":1517646,"node_id":"MDU6SXNzdWUxNTE3NjQ2","number":1286,"title":"Invalid conversion from long to date in script field","user":{"login":"lukas-vlcek","id":205174,"node_id":"MDQ6VXNlcjIwNTE3NA==","avatar_url":"https://avatars2.githubusercontent.com/u/205174?v=4","gravatar_id":"","url":"https://api.github.com/users/lukas-vlcek","html_url":"https://github.com/lukas-vlcek","followers_url":"https://api.github.com/users/lukas-vlcek/followers","following_url":"https://api.github.com/users/lukas-vlcek/following{/other_user}","gists_url":"https://api.github.com/users/lukas-vlcek/gists{/gist_id}","starred_url":"https://api.github.com/users/lukas-vlcek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukas-vlcek/subscriptions","organizations_url":"https://api.github.com/users/lukas-vlcek/orgs","repos_url":"https://api.github.com/users/lukas-vlcek/repos","events_url":"https://api.github.com/users/lukas-vlcek/events{/privacy}","received_events_url":"https://api.github.com/users/lukas-vlcek/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2011-08-30T09:28:57Z","updated_at":"2014-03-26T09:07:43Z","closed_at":"2014-03-26T09:07:43Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Using 0.18.0-SNAPSHOT take the following script:\n\n```\ncurl -X DELETE 'localhost:9200/index'\n\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314651089690 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314651087102 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314651082795 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650999543 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650999252 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650998558 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650990049 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650989434 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650988908 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650944381 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650944055 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650943401 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650932802 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650932211 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650931720 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650922622 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650922335 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650921635 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650917717 }'\ncurl -X POST 'localhost:9200/index/type/' -d '{ \"date\" : 1314650917152 }'\n\ncurl -X POST 'localhost:9200/_refresh'\n\necho\n\ncurl -X GET 'localhost:9200/index/type/_search?pretty=true' -d '\n{\n  \"size\" : 20,\n  \"query\" : {\n    \"match_all\" : {}\n  },\n  \"sort\" : {\n    \"_script\" : {\n      \"script\" : \"doc.date.value\",\n      \"type\" : \"number\",\n      \"order\" : \"desc\"\n    }\n  },\n  \"script_fields\" : {\n    \"original_millis\" : {\n      \"script\" : \"doc.date.value\"\n    },\n    \"script_millis\" : {\n      \"script\" : \"doc.date.date.millis\"\n    },\n    \"script_date\" : {\n      \"script\" : \"doc.date.date\"\n    }\n  }\n}'\n```\n\nNow, taking only script fields from the returned hits we can get the following sequence:\n\n```\norig_millis      script_millis    script_date\n\n1314651089690    1314651089690    2011-08-29T20:48:41.635Z\n1314651087102    1314651087102    2011-08-29T20:48:37.717Z\n1314651082795    1314651082795    2011-08-29T20:48:42.335Z\n1314650999543    1314650999543    2011-08-29T20:48:42.622Z\n1314650999252    1314650999252    2011-08-29T20:48:37.152Z\n1314650998558    1314650998558    2011-08-29T20:48:42.622Z    \n1314650990049    1314650990049    2011-08-29T20:48:37.152Z\n1314650989434    1314650989434    2011-08-29T20:48:37.717Z\n1314650988908    1314650988908    2011-08-29T20:48:41.635Z\n1314650944381    1314650944381    2011-08-29T20:48:37.717Z\n1314650944055    1314650944055    2011-08-29T20:48:42.622Z\n1314650943401    1314650943401    2011-08-29T20:48:37.152Z\n1314650932802    1314650932802    2011-08-29T20:48:41.635Z\n1314650932211    1314650932211    2011-08-29T20:48:42.622Z\n1314650931720    1314650931720    2011-08-29T20:48:37.152Z\n1314650922622    1314650922622    2011-08-29T20:48:42.622Z\n1314650922335    1314650922335    2011-08-29T20:48:42.335Z\n1314650921635    1314650921635    2011-08-29T20:48:41.635Z\n1314650917717    1314650917717    2011-08-29T20:48:37.717Z\n1314650917152    1314650917152    2011-08-29T20:48:37.152Z\n```\n\nAs we can see the order by original long value is correct but the date values generated from them are obviously not sorted correctly - check sec values. Interestingly, millis value generated from the date value is equal to the original millis value from the document (so is it that the problem can be only be in converting the correct millis value into string date representation?).\n","closed_by":{"login":"lukas-vlcek","id":205174,"node_id":"MDQ6VXNlcjIwNTE3NA==","avatar_url":"https://avatars2.githubusercontent.com/u/205174?v=4","gravatar_id":"","url":"https://api.github.com/users/lukas-vlcek","html_url":"https://github.com/lukas-vlcek","followers_url":"https://api.github.com/users/lukas-vlcek/followers","following_url":"https://api.github.com/users/lukas-vlcek/following{/other_user}","gists_url":"https://api.github.com/users/lukas-vlcek/gists{/gist_id}","starred_url":"https://api.github.com/users/lukas-vlcek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukas-vlcek/subscriptions","organizations_url":"https://api.github.com/users/lukas-vlcek/orgs","repos_url":"https://api.github.com/users/lukas-vlcek/repos","events_url":"https://api.github.com/users/lukas-vlcek/events{/privacy}","received_events_url":"https://api.github.com/users/lukas-vlcek/received_events","type":"User","site_admin":false},"performed_via_github_app":null}