[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159555344","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-159555344","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":159555344,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTU1NTM0NA==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T09:56:26Z","updated_at":"2015-11-25T09:56:26Z","author_association":"CONTRIBUTOR","body":"Can you post a recreation of what you are doing today and that doesn't work?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159558788","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-159558788","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":159558788,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTU1ODc4OA==","user":{"login":"saai","id":455787,"node_id":"MDQ6VXNlcjQ1NTc4Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/455787?v=4","gravatar_id":"","url":"https://api.github.com/users/saai","html_url":"https://github.com/saai","followers_url":"https://api.github.com/users/saai/followers","following_url":"https://api.github.com/users/saai/following{/other_user}","gists_url":"https://api.github.com/users/saai/gists{/gist_id}","starred_url":"https://api.github.com/users/saai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saai/subscriptions","organizations_url":"https://api.github.com/users/saai/orgs","repos_url":"https://api.github.com/users/saai/repos","events_url":"https://api.github.com/users/saai/events{/privacy}","received_events_url":"https://api.github.com/users/saai/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T10:05:40Z","updated_at":"2015-11-25T10:06:57Z","author_association":"NONE","body":"hi jpountz,  I am xuralf's colleague, and here is the problem.\n\nthe querying json is as followed:\n\n```\n{\n  \"query\" : {\n    \"filtered\" : {\n      \"query\" : {\n        \"bool\" : {\n          \"must\" : {\n            \"has_child\" : {\n              \"query\" : {\n                \"bool\" : { }\n              },\n              \"child_type\" : \"hotel-level-lose-stat\"\n            }\n          }\n        }\n      },\n      \"filter\" : {\n        \"bool\" : {\n          \"must\" : {\n            \"has_child\" : {\n              \"filter\" : {\n                \"bool\" : {\n                  \"must\" : {\n                    \"range\" : {\n                      \"report_date\" : {\n                        \"from\" : \"2015-11-01\",\n                        \"to\" : \"2015-11-03\",\n                        \"include_lower\" : true,\n                        \"include_upper\" : true\n                      }\n                    }\n                  }\n                }\n              },\n              \"child_type\" : \"hotel-level-lose-stat\"\n            }\n          }\n        }\n      }\n    }\n  },\n  \"aggregations\" : {\n    \"sales_center\" : {\n      \"terms\" : {\n        \"field\" : \"sales_center\",\n        \"size\" : 0\n      },\n      \"aggregations\" : {\n        \"region\" : {\n          \"terms\" : {\n            \"field\" : \"region\",\n            \"size\" : 0\n          },\n          \"aggregations\" : {\n            \"sales_area\" : {\n              \"terms\" : {\n                \"field\" : \"sales_area\",\n                \"size\" : 0\n              },\n              \"aggregations\" : {\n                \"secondary_area\" : {\n                  \"terms\" : {\n                    \"field\" : \"secondary_area\",\n                    \"size\" : 0\n                  },\n                  \"aggregations\" : {\n                    \"city_name.raw\" : {\n                      \"terms\" : {\n                        \"field\" : \"city_name.raw\",\n                        \"size\" : 0\n                      },\n                      \"aggregations\" : {\n                        \"manager_name.raw\" : {\n                          \"terms\" : {\n                            \"field\" : \"manager_name.raw\",\n                            \"size\" : 0\n                          },\n                          \"aggregations\" : {\n                            \"trading_area.raw\" : {\n                              \"terms\" : {\n                                \"field\" : \"trading_area.raw\",\n                                \"size\" : 0\n                              },\n                              \"aggregations\" : {\n                                \"competitor_price\" : {\n                                  \"children\" : {\n                                    \"type\" : \"hotel-level-lose-stat\"\n                                  },\n                                  \"aggregations\" : {\n                                    \"competitor_price\" : {\n                                      \"date_histogram\" : {\n                                        \"field\" : \"report_date\",\n                                        \"interval\" : \"1d\",\n                                        \"min_doc_count\" : 0,\n                                        \"format\" : \"yyyy-MM-dd\",\n                                        \"extended_bounds\" : {\n                                          \"min\" : \"2015-11-01\",\n                                          \"max\" : \"2015-11-03\"\n                                        }\n                                      },\n                                      \"aggregations\" : {\n                                        \"competitor_price\" : {\n                                          \"filter\" : {\n                                            \"exists\" : {\n                                              \"field\" : \"competitor_price\"\n                                            }\n                                          }\n                                        }\n                                      }\n                                    }\n                                  }\n                                },\n                                \"lose_result\" : {\n                                  \"children\" : {\n                                    \"type\" : \"hotel-level-lose-stat\"\n                                  },\n                                  \"aggregations\" : {\n                                    \"lose_result\" : {\n                                      \"date_histogram\" : {\n                                        \"field\" : \"report_date\",\n                                        \"interval\" : \"1d\",\n                                        \"min_doc_count\" : 0,\n                                        \"format\" : \"yyyy-MM-dd\",\n                                        \"extended_bounds\" : {\n                                          \"min\" : \"2015-11-01\",\n                                          \"max\" : \"2015-11-03\"\n                                        }\n                                      },\n                                      \"aggregations\" : {\n                                        \"lose_result\" : {\n                                          \"filter\" : {\n                                            \"bool\" : {\n                                              \"must\" : {\n                                                \"range\" : {\n                                                  \"report_date\" : {\n                                                    \"from\" : \"2015-11-01\",\n                                                    \"to\" : \"2015-11-03\",\n                                                    \"include_lower\" : true,\n                                                    \"include_upper\" : true\n                                                  }\n                                                }\n                                              }\n                                            }\n                                          },\n                                          \"aggregations\" : {\n                                            \"lose_result\" : {\n                                              \"terms\" : {\n                                                \"field\" : \"lose_result\"\n                                              }\n                                            }\n                                          }\n                                        }\n                                      }\n                                    }\n                                  }\n                                }\n                              }\n                            }\n                          }\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nand the returning json is \n\n{\n  \"took\" : 300,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"sales_center\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"高星酒店\",\n        \"doc_count\" : 1,\n        \"region\" : {\n          \"doc_count_error_upper_bound\" : 0,\n          \"sum_other_doc_count\" : 0,\n          \"buckets\" : [ {\n            \"key\" : \"高星酒店\",\n            \"doc_count\" : 1,\n            \"sales_area\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ {\n                \"key\" : \"西南区域\",\n                \"doc_count\" : 1,\n                \"secondary_area\" : {\n                  \"doc_count_error_upper_bound\" : 0,\n                  \"sum_other_doc_count\" : 0,\n                  \"buckets\" : [ {\n                    \"key\" : \"四川\",\n                    \"doc_count\" : 1,\n                    \"city_name.raw\" : {\n                      \"doc_count_error_upper_bound\" : 0,\n                      \"sum_other_doc_count\" : 0,\n                      \"buckets\" : [ {\n                        \"key\" : \"阿坝\",\n                        \"doc_count\" : 1,\n                        \"manager_name.raw\" : {\n                          \"doc_count_error_upper_bound\" : 0,\n                          \"sum_other_doc_count\" : 0,\n                          \"buckets\" : [ {\n                            \"key\" : \"彭洁\",\n                            \"doc_count\" : 1,\n                            \"trading_area.raw\" : {\n                              \"doc_count_error_upper_bound\" : 0,\n                              \"sum_other_doc_count\" : 0,\n                              \"buckets\" : [ {\n                                \"key\" : \"未确定\",\n                                \"doc_count\" : 1,\n                                \"lose_result\" : {\n                                  \"doc_count\" : 2,\n                                  \"lose_result\" : {\n                                    \"buckets\" : [ {\n                                      \"key_as_string\" : \"2015-11-01\",\n                                      \"key\" : 1446336000000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-02\",\n                                      \"key\" : 1446422400000,\n                                      \"doc_count\" : 1,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-03\",\n                                      \"key\" : 1446508800000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-04\",\n                                      \"key\" : 1446595200000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-05\",\n                                      \"key\" : 1446681600000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-06\",\n                                      \"key\" : 1446768000000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-07\",\n                                      \"key\" : 1446854400000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-08\",\n                                      \"key\" : 1446940800000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-09\",\n                                      \"key\" : 1447027200000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-10\",\n                                      \"key\" : 1447113600000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-11\",\n                                      \"key\" : 1447200000000,\n                                      \"doc_count\" : 0,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-12\",\n                                      \"key\" : 1447286400000,\n                                      \"doc_count\" : 1,\n                                      \"lose_result\" : {\n                                        \"doc_count\" : 0,\n                                        \"lose_result\" : {\n                                          \"doc_count_error_upper_bound\" : 0,\n                                          \"sum_other_doc_count\" : 0,\n                                          \"buckets\" : [ ]\n                                        }\n                                      }\n                                    } ]\n                                  }\n                                },\n                                \"competitor_price\" : {\n                                  \"doc_count\" : 2,\n                                  \"competitor_price\" : {\n                                    \"buckets\" : [ {\n                                      \"key_as_string\" : \"2015-11-01\",\n                                      \"key\" : 1446336000000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-02\",\n                                      \"key\" : 1446422400000,\n                                      \"doc_count\" : 1,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 1\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-03\",\n                                      \"key\" : 1446508800000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-04\",\n                                      \"key\" : 1446595200000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-05\",\n                                      \"key\" : 1446681600000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-06\",\n                                      \"key\" : 1446768000000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-07\",\n                                      \"key\" : 1446854400000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-08\",\n                                      \"key\" : 1446940800000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-09\",\n                                      \"key\" : 1447027200000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-10\",\n                                      \"key\" : 1447113600000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-11\",\n                                      \"key\" : 1447200000000,\n                                      \"doc_count\" : 0,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 0\n                                      }\n                                    }, {\n                                      \"key_as_string\" : \"2015-11-12\",\n                                      \"key\" : 1447286400000,\n                                      \"doc_count\" : 1,\n                                      \"competitor_price\" : {\n                                        \"doc_count\" : 1\n                                      }\n                                    } ]\n                                  }\n                                }\n                              } ]\n                            }\n                          } ]\n                        }\n                      } ]\n                    }\n                  } ]\n                }\n              } ]\n            }\n          } ]\n        }\n      } ]\n    }\n  }\n}\n```\n\nthe returning date is out of [2015-11-01,2015-11-03] , we can see the data of 2015-11-04 etc,\n\n it seems that the aggregation filter doesn't work, please help me !!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159564049","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-159564049","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":159564049,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTU2NDA0OQ==","user":{"login":"saai","id":455787,"node_id":"MDQ6VXNlcjQ1NTc4Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/455787?v=4","gravatar_id":"","url":"https://api.github.com/users/saai","html_url":"https://github.com/saai","followers_url":"https://api.github.com/users/saai/followers","following_url":"https://api.github.com/users/saai/following{/other_user}","gists_url":"https://api.github.com/users/saai/gists{/gist_id}","starred_url":"https://api.github.com/users/saai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saai/subscriptions","organizations_url":"https://api.github.com/users/saai/orgs","repos_url":"https://api.github.com/users/saai/repos","events_url":"https://api.github.com/users/saai/events{/privacy}","received_events_url":"https://api.github.com/users/saai/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T10:26:13Z","updated_at":"2015-11-25T10:26:13Z","author_association":"NONE","body":"the returned report_date value is exceeding the range filter , which is from 2015-11-01 to 2015-11-03, \n\nis the child aggregation filter doesn't work ? or did I wrongly set the filter?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159581179","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-159581179","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":159581179,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTU4MTE3OQ==","user":{"login":"saai","id":455787,"node_id":"MDQ6VXNlcjQ1NTc4Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/455787?v=4","gravatar_id":"","url":"https://api.github.com/users/saai","html_url":"https://github.com/saai","followers_url":"https://api.github.com/users/saai/followers","following_url":"https://api.github.com/users/saai/following{/other_user}","gists_url":"https://api.github.com/users/saai/gists{/gist_id}","starred_url":"https://api.github.com/users/saai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saai/subscriptions","organizations_url":"https://api.github.com/users/saai/orgs","repos_url":"https://api.github.com/users/saai/repos","events_url":"https://api.github.com/users/saai/events{/privacy}","received_events_url":"https://api.github.com/users/saai/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T11:42:21Z","updated_at":"2015-11-25T17:57:29Z","author_association":"NONE","body":"I did another test, the json is much easier,\n\nthe query json \n\n```\n{\n  \"aggregations\" : {\n    \"sales_center\" : {\n      \"terms\" : {\n        \"field\" : \"sales_center\"\n      },\n      \"aggregations\" : {\n        \"region\" : {\n          \"terms\" : {\n            \"field\" : \"region\"\n          },\n          \"aggregations\" : {\n            \"sales_area\" : {\n              \"terms\" : {\n                \"field\" : \"sales_area\"\n              },\n              \"aggregations\" : {\n                \"secondary_area\" : {\n                  \"terms\" : {\n                    \"field\" : \"secondary_area\"\n                  },\n                  \"aggregations\" : {\n                    \"city_name.raw\" : {\n                      \"terms\" : {\n                        \"field\" : \"city_name.raw\"\n                      },\n                      \"aggregations\" : {\n                        \"manager_name.raw\" : {\n                          \"terms\" : {\n                            \"field\" : \"manager_name.raw\"\n                          },\n                          \"aggregations\" : {\n                            \"lose_stat\" : {\n                              \"children\" : {\n                                \"type\" : \"hotel-level-lose-stat\"\n                              },\n                              \"aggregations\" : {\n                                \"qunar_scope_filter\" : {\n                                  \"filter\" : {\n                                    \"terms\" : {\n                                      \"quanr_scope\" : [ \"ZHI_XIAO\" ]\n                                    }\n                                  }\n                                },\n                                \"qunar_scope\" : {\n                                  \"terms\" : {\n                                    \"field\" : \"qunar_scope\"\n                                  }\n                                }\n                              }\n                            }\n                          }\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n\nthe returned results\n{\n  \"took\" : 190,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 3,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"sales_center\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"高星酒店\",\n        \"doc_count\" : 2,\n        \"region\" : {\n          \"doc_count_error_upper_bound\" : 0,\n          \"sum_other_doc_count\" : 0,\n          \"buckets\" : [ {\n            \"key\" : \"高星酒店\",\n            \"doc_count\" : 2,\n            \"sales_area\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ {\n                \"key\" : \"西南区域\",\n                \"doc_count\" : 2,\n                \"secondary_area\" : {\n                  \"doc_count_error_upper_bound\" : 0,\n                  \"sum_other_doc_count\" : 0,\n                  \"buckets\" : [ {\n                    \"key\" : \"四川\",\n                    \"doc_count\" : 2,\n                    \"city_name.raw\" : {\n                      \"doc_count_error_upper_bound\" : 0,\n                      \"sum_other_doc_count\" : 0,\n                      \"buckets\" : [ {\n                        \"key\" : \"阿坝\",\n                        \"doc_count\" : 2,\n                        \"manager_name.raw\" : {\n                          \"doc_count_error_upper_bound\" : 0,\n                          \"sum_other_doc_count\" : 0,\n                          \"buckets\" : [ {\n                            \"key\" : \"向璐\",\n                            \"doc_count\" : 1,\n                            \"lose_stat\" : {\n                              \"doc_count\" : 1,\n                              \"qunar_scope_filter\" : {\n                                \"doc_count\" : 0\n                              },\n                              \"qunar_scope\" : {\n                                \"doc_count_error_upper_bound\" : 0,\n                                \"sum_other_doc_count\" : 0,\n                                \"buckets\" : [ {\n                                  \"key\" : \"ZHI_XIAO_AND_AGENTS\",\n                                  \"doc_count\" : 1\n                                } ]\n                              }\n                            }\n                          }, {\n                            \"key\" : \"彭洁\",\n                            \"doc_count\" : 1,\n                            \"lose_stat\" : {\n                              \"doc_count\" : 2,\n                              \"qunar_scope_filter\" : {\n                                \"doc_count\" : 0\n                              },\n                              \"qunar_scope\" : {\n                                \"doc_count_error_upper_bound\" : 0,\n                                \"sum_other_doc_count\" : 0,\n                                \"buckets\" : [ {\n                                  \"key\" : \"ZHI_XIAO\",\n                                  \"doc_count\" : 2\n                                } ]\n                              }\n                            }\n                          } ]\n                        }\n                      } ]\n                    }\n                  } ]\n                }\n              } ]\n            }\n          } ]\n        }\n      }, {\n        \"key\" : \"单体直销中心\",\n        \"doc_count\" : 1,\n        \"region\" : {\n          \"doc_count_error_upper_bound\" : 0,\n          \"sum_other_doc_count\" : 0,\n          \"buckets\" : [ {\n            \"key\" : \"华中大区\",\n            \"doc_count\" : 1,\n            \"sales_area\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ {\n                \"key\" : \"华西南\",\n                \"doc_count\" : 1,\n                \"secondary_area\" : {\n                  \"doc_count_error_upper_bound\" : 0,\n                  \"sum_other_doc_count\" : 0,\n                  \"buckets\" : [ {\n                    \"key\" : \"川贵\",\n                    \"doc_count\" : 1,\n                    \"city_name.raw\" : {\n                      \"doc_count_error_upper_bound\" : 0,\n                      \"sum_other_doc_count\" : 0,\n                      \"buckets\" : [ {\n                        \"key\" : \"阿坝\",\n                        \"doc_count\" : 1,\n                        \"manager_name.raw\" : {\n                          \"doc_count_error_upper_bound\" : 0,\n                          \"sum_other_doc_count\" : 0,\n                          \"buckets\" : [ {\n                            \"key\" : \"黄晓静\",\n                            \"doc_count\" : 1,\n                            \"lose_stat\" : {\n                              \"doc_count\" : 0,\n                              \"qunar_scope_filter\" : {\n                                \"doc_count\" : 0\n                              },\n                              \"qunar_scope\" : {\n                                \"doc_count_error_upper_bound\" : 0,\n                                \"sum_other_doc_count\" : 0,\n                                \"buckets\" : [ ]\n                              }\n                            }\n                          } ]\n                        }\n                      } ]\n                    }\n                  } ]\n                }\n              } ]\n            }\n          } ]\n        }\n      } ]\n    }\n  }\n}\n```\n\nwe can see that the \"qunar_scope_filter\" aggregation  DID NOT  hit any doc which equals \"ZHI_XIAO\" , while qunar_scope aggregation has hits 2 documents of \"ZHI_XIAO\", they are both the sub aggregation of child type, so the filtered aggregation inside child aggregation does not work properly.  \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159688715","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-159688715","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":159688715,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTY4ODcxNQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2015-11-25T18:01:30Z","updated_at":"2015-11-25T18:01:30Z","author_association":"CONTRIBUTOR","body":"You seem to have a typo in your example:\n\n```\n                                    \"terms\" : {\n                                      \"quanr_scope\" : [ \"ZHI_XIAO\" ]\n                                    }\n```\n\nShould it be \"qunar_scope\" rather than \"quanr_scope\"? Could it be the cause of your problem?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/159787903","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-159787903","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":159787903,"node_id":"MDEyOklzc3VlQ29tbWVudDE1OTc4NzkwMw==","user":{"login":"saai","id":455787,"node_id":"MDQ6VXNlcjQ1NTc4Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/455787?v=4","gravatar_id":"","url":"https://api.github.com/users/saai","html_url":"https://github.com/saai","followers_url":"https://api.github.com/users/saai/followers","following_url":"https://api.github.com/users/saai/following{/other_user}","gists_url":"https://api.github.com/users/saai/gists{/gist_id}","starred_url":"https://api.github.com/users/saai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saai/subscriptions","organizations_url":"https://api.github.com/users/saai/orgs","repos_url":"https://api.github.com/users/saai/repos","events_url":"https://api.github.com/users/saai/events{/privacy}","received_events_url":"https://api.github.com/users/saai/received_events","type":"User","site_admin":false},"created_at":"2015-11-26T02:49:40Z","updated_at":"2015-11-26T02:49:40Z","author_association":"NONE","body":"@jpountz  Yes you are right , I passed the wrong field name for qunar_scope. But , here is another strange thing, when I pass the date type field \"report_date\" for filter, I got wrong result , the json is as followed.\n\nthe query json:\n{\n  \"aggregations\" : {\n    \"sales_center\" : {\n      \"terms\" : {\n        \"field\" : \"sales_center\"\n      },\n      \"aggregations\" : {\n        \"lose_stat\" : {\n          \"children\" : {\n            \"type\" : \"hotel-level-lose-stat\"\n          },\n          \"aggregations\" : {\n            \"qunar_scope\" : {\n              \"terms\" : {\n                \"field\" : \"qunar_scope\"\n              }\n            },\n            \"qunar_scope_filter\" : {\n              \"filter\" : {\n                \"terms\" : {\n                  \"qunar_scope\" : [ \"ZHI_XIAO\" ]\n                }\n              },\n              \"aggregations\" : {\n                \"lose_result\" : {\n                  \"terms\" : {\n                    \"field\" : \"lose_result\"\n                  }\n                }\n              }\n            },\n            \"report_date_filter\" : {\n              \"filter\" : {\n                \"range\" : {\n                  \"report_date\" : {\n                    \"from\" : \"2015-11-01\",\n                    \"to\" : \"2015-11-03\",\n                    \"include_lower\" : true,\n                    \"include_upper\" : true\n                  },\n                  \"_name\" : \"report_date\"\n                }\n              },\n              \"aggregations\" : {\n                \"lose_result\" : {\n                  \"terms\" : {\n                    \"field\" : \"lose_result\"\n                  }\n                }\n              }\n            },\n            \"report_date\" : {\n              \"terms\" : {\n                \"field\" : \"report_date\"\n              }\n            },\n            \"lose_result\" : {\n              \"terms\" : {\n                \"field\" : \"lose_result\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\nthe result json:\n{\n  \"took\" : 267,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 3,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"sales_center\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"高星酒店\",\n        \"doc_count\" : 2,\n        \"lose_stat\" : {\n          \"doc_count\" : 3,\n          \"report_date\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : 1446422400000,\n              \"key_as_string\" : \"2015-11-02\",\n              \"doc_count\" : 1\n            }, {\n              \"key\" : 1447286400000,\n              \"key_as_string\" : \"2015-11-12\",\n              \"doc_count\" : 1\n            }, {\n              \"key\" : 1448236800000,\n              \"key_as_string\" : \"2015-11-23\",\n              \"doc_count\" : 1\n            } ]\n          },\n          \"qunar_scope_filter\" : {\n            \"doc_count\" : 2,\n            \"lose_result\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ {\n                \"key\" : \"PRICE_LOSE\",\n                \"doc_count\" : 2\n              } ]\n            }\n          },\n          \"qunar_scope\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"ZHI_XIAO\",\n              \"doc_count\" : 2\n            }, {\n              \"key\" : \"ZHI_XIAO_AND_AGENTS\",\n              \"doc_count\" : 1\n            } ]\n          },\n          \"lose_result\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"PRICE_LOSE\",\n              \"doc_count\" : 3\n            } ]\n          },\n          \"report_date_filter\" : {\n            \"doc_count\" : 0,\n            \"lose_result\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ ]\n            }\n          }\n        }\n      }, {\n        \"key\" : \"单体直销中心\",\n        \"doc_count\" : 1,\n        \"lose_stat\" : {\n          \"doc_count\" : 0,\n          \"report_date\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ ]\n          },\n          \"qunar_scope_filter\" : {\n            \"doc_count\" : 0,\n            \"lose_result\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ ]\n            }\n          },\n          \"qunar_scope\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ ]\n          },\n          \"lose_result\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ ]\n          },\n          \"report_date_filter\" : {\n            \"doc_count\" : 0,\n            \"lose_result\" : {\n              \"doc_count_error_upper_bound\" : 0,\n              \"sum_other_doc_count\" : 0,\n              \"buckets\" : [ ]\n            }\n          }\n        }\n      } ]\n    }\n  }\n}\n\nthe report_date_filter did not hit any doc, since the range is [2015-11-01, 2015-11-03],  the doc 2015-11-02 should be hit, did I wrongly set  the date filter ? Thanks in advance!!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/160136053","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-160136053","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":160136053,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MDEzNjA1Mw==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-11-27T13:07:16Z","updated_at":"2015-11-27T13:07:16Z","author_association":"CONTRIBUTOR","body":"Hi @saai \n\nAs @jpountz said before, please could you upload a full (minimal) recreation, ie show how you create the index, index the docs, then run the query.  Otherwise we're just guessing.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/163090273","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-163090273","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":163090273,"node_id":"MDEyOklzc3VlQ29tbWVudDE2MzA5MDI3Mw==","user":{"login":"saai","id":455787,"node_id":"MDQ6VXNlcjQ1NTc4Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/455787?v=4","gravatar_id":"","url":"https://api.github.com/users/saai","html_url":"https://github.com/saai","followers_url":"https://api.github.com/users/saai/followers","following_url":"https://api.github.com/users/saai/following{/other_user}","gists_url":"https://api.github.com/users/saai/gists{/gist_id}","starred_url":"https://api.github.com/users/saai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saai/subscriptions","organizations_url":"https://api.github.com/users/saai/orgs","repos_url":"https://api.github.com/users/saai/repos","events_url":"https://api.github.com/users/saai/events{/privacy}","received_events_url":"https://api.github.com/users/saai/received_events","type":"User","site_admin":false},"created_at":"2015-12-09T02:57:11Z","updated_at":"2015-12-09T02:57:11Z","author_association":"NONE","body":"Hello @jpountz and @clintongormley , Here I am again... \nI have made a simple example to show the issue more explicitly.\nAn index, which has two types , hotel which is the parent , and order which is the child. \nhotel has 3 fields: hotel_seq (id), hotel_name, hotel_level ,\norder has 4 fields: report_date (date type), hotel_seq, selling_type (indicates whether the order is from the website or mobile apps), price (the price of the order).\nI use java to create the index, and here are the XContentBuilder of hotel and order:\n\n<pre><code>\nXContentBuilder parentJson = XContentFactory.jsonBuilder()\n                .startObject()\n                .startObject(\"properties\")\n                .startObject(\"hotel_seq\").field(\"type\", \"string\").field(\"index\", \"not_analyzed\").field(\"doc_values\", true).endObject()\n                .startObject(\"hotel_name\").field(\"type\", \"string\").field(\"analyzer\", \"cjk\").startObject(\"fields\").startObject(\"raw\").field(\"type\", \"string\").field(\"index\", \"not_analyzed\").field(\"doc_values\", true).endObject().endObject().endObject()\n                .startObject(\"hotel_level\").field(\"type\", \"string\").field(\"index\", \"not_analyzed\").field(\"doc_values\", true).endObject()\n                .endObject()\n                .endObject()\n                ;\nXContentBuilder childJson = XContentFactory.jsonBuilder()\n                .startObject()\n                .startObject(\"_parent\").field(\"type\", parentType).endObject()\n                .startObject(\"properties\")\n                .startObject(\"report_date\").field(\"type\", \"date\").field(\"format\", \"yyyy-MM-dd\").endObject()\n                .startObject(\"hotel_seq\").field(\"type\", \"string\").field(\"index\", \"not_analyzed\").field(\"doc_values\", true).endObject()\n                .startObject(\"selling_type\").field(\"type\", \"string\").field(\"index\", \"not_analyzed\").field(\"doc_values\", true).endObject()\n                .startObject(\"price\").field(\"type\", \"double\").field(\"index\", \"not_analyzed\").field(\"doc_values\", true).endObject()\n                .endObject()\n                .endObject()\n                ; \n</code></pre>\n\nthen , I put 2 hotels and 3 orders data into the index, here are the json of the data\n\n<pre><code>\nXContentBuilder hotel1 = XContentFactory.jsonBuilder()\n                .startObject()\n                .field(\"hotel_seq\", \"aba_201\")\n                .field(\"hotel_name\",\"holidays inn\")\n                .field(\"hotel_level\", \"B\")\n                .endObject();\n        XContentBuilder hotel2 = XContentFactory.jsonBuilder()\n                .startObject()\n                .field(\"hotel_seq\", \"aba_202\")\n                .field(\"hotel_name\", \"four seasons\")\n                .field(\"hotel_level\", \"A\")\n                .endObject();\n        XContentBuilder order1 = XContentFactory.jsonBuilder()\n                .startObject()\n                .field(\"report_date\", \"2015-11-01\")\n                .field(\"hotel_seq\", \"aba_201\")\n                .field(\"selling_type\", \"WEBSITE\")\n                .field(\"price\", 766.0)\n                .endObject();\n        XContentBuilder order2 = XContentFactory.jsonBuilder()\n                .startObject()\n                .field(\"report_date\", \"2015-11-03\")\n                .field(\"hotel_seq\", \"aba_201\")\n                .field(\"selling_type\", \"APP\")\n                .field(\"price\", 766.0)\n                .endObject();\n        XContentBuilder order3 = XContentFactory.jsonBuilder()\n                .startObject()\n                .field(\"report_date\",\"2015-11-02\")\n                .field(\"hotel_seq\", \"aba_202\")\n                .field(\"selling_type\", \"WEBSITE\")\n                .field(\"price\", 1666.0)\n                .endObject();\n</code></pre>\n\nThen I try to query the incomes of selling_type \"WEBSITE\" and the incomes from report_date 2015-11-01 to 2015-11-03, aggregated by hotel_level in parent fields . In order to compare, I also added two child aggregation of report_date terms and selling_type terms.\n\nthe request json is as followed:\n<pre><code>\n{\n  \"aggregations\" : {\n    \"hotel_level\" : {\n      \"terms\" : {\n        \"field\" : \"hotel_level\"\n      },\n      \"aggregations\" : {\n        \"order\" : {\n          \"children\" : {\n            \"type\" : \"child-order\"\n          },\n          \"aggregations\" : {\n            \"selling_type_terms\" : {\n              \"terms\" : {\n                \"field\" : \"selling_type\"\n              }\n            },\n            \"report_date_terms\" : {\n              \"terms\" : {\n                \"field\" : \"report_date\"\n              }\n            },\n            \"selling_type_WEBSITE\" : {\n              \"filter\" : {\n                \"terms\" : {\n                  \"selling_type\" : [ \"WEBSITE\" ]\n                }\n              },\n              \"aggregations\" : {\n                \"income\" : {\n                  \"sum\" : {\n                    \"field\" : \"price\"\n                  }\n                }\n              }\n            },\n            \"report_date_20151101_20151103\" : {\n              \"filter\" : {\n                \"range\" : {\n                  \"report_date\" : {\n                    \"from\" : \"2015-11-01\",\n                    \"to\" : \"2015-11-03\",\n                    \"include_lower\" : true,\n                    \"include_upper\" : true\n                  }\n                }\n              },\n              \"aggregations\" : {\n                \"income\" : {\n                  \"sum\" : {\n                    \"field\" : \"price\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n</pre></code>\n\nand the result is \n\n<pre><code>\n{\n  \"took\" : 1373,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 1,\n    \"successful\" : 1,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 2,\n    \"max_score\" : 0.0,\n    \"hits\" : [ ]\n  },\n  \"aggregations\" : {\n    \"hotel_level\" : {\n      \"doc_count_error_upper_bound\" : 0,\n      \"sum_other_doc_count\" : 0,\n      \"buckets\" : [ {\n        \"key\" : \"A\",\n        \"doc_count\" : 1,\n        \"order\" : {\n          \"doc_count\" : 1,\n          \"report_date_20151101_20151103\" : {\n            \"doc_count\" : 0,\n            \"income\" : {\n              \"value\" : 0.0\n            }\n          },\n          \"selling_type_WEBSITE\" : {\n            \"doc_count\" : 1,\n            \"income\" : {\n              \"value\" : 1666.0\n            }\n          },\n          \"selling_type_terms\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"WEBSITE\",\n              \"doc_count\" : 1\n            } ]\n          },\n          \"report_date_terms\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : 1446422400000,\n              \"key_as_string\" : \"2015-11-02\",\n              \"doc_count\" : 1\n            } ]\n          }\n        }\n      }, {\n        \"key\" : \"B\",\n        \"doc_count\" : 1,\n        \"order\" : {\n          \"doc_count\" : 2,\n          \"report_date_20151101_20151103\" : {\n            \"doc_count\" : 0,\n            \"income\" : {\n              \"value\" : 0.0\n            }\n          },\n          \"selling_type_WEBSITE\" : {\n            \"doc_count\" : 1,\n            \"income\" : {\n              \"value\" : 766.0\n            }\n          },\n          \"selling_type_terms\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : \"APP\",\n              \"doc_count\" : 1\n            }, {\n              \"key\" : \"WEBSITE\",\n              \"doc_count\" : 1\n            } ]\n          },\n          \"report_date_terms\" : {\n            \"doc_count_error_upper_bound\" : 0,\n            \"sum_other_doc_count\" : 0,\n            \"buckets\" : [ {\n              \"key\" : 1446336000000,\n              \"key_as_string\" : \"2015-11-01\",\n              \"doc_count\" : 1\n            }, {\n              \"key\" : 1446508800000,\n              \"key_as_string\" : \"2015-11-03\",\n              \"doc_count\" : 1\n            } ]\n          }\n        }\n      } ]\n    }\n  }\n}\n</pre></code>\n\nIn hotel_level bucket \"A\", I got 1666.0 for the total incomes of WEBSITE ,which is right,  but 0 for total incomes from 20151101 to 20151103, which should be 1666.0,  so I guess that the date range filter is not working in child aggregations.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/164550609","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-164550609","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":164550609,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NDU1MDYwOQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-14T20:31:30Z","updated_at":"2015-12-14T20:31:30Z","author_association":"CONTRIBUTOR","body":"@martijnvg Please could you have a look at this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/164550905","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-164550905","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":164550905,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NDU1MDkwNQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-12-14T20:32:53Z","updated_at":"2015-12-14T20:32:53Z","author_association":"CONTRIBUTOR","body":"Related to https://github.com/elastic/elasticsearch/issues/15413 ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/164895037","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-164895037","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":164895037,"node_id":"MDEyOklzc3VlQ29tbWVudDE2NDg5NTAzNw==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-12-15T20:59:58Z","updated_at":"2015-12-15T20:59:58Z","author_association":"MEMBER","body":"@saai I tried to make a reproduction based on what you have shared in your latest comment:\n\nMappings and documents:\n\n```\nDELETE /_all\n\nPUT /test\n{\n  \"mappings\": {\n    \"parentType\" : {\n      \"properties\": {\n        \"hotel_name\": {\"type\": \"string\"},\n        \"hotel_level\" : {\"type\": \"string\", \"index\": \"not_analyzed\"}\n      }\n    },\n    \"childType\": {\n      \"_parent\": {\n        \"type\": \"parentType\"\n      },\n      \"properties\": {\n        \"selling_type\" : {\"type\": \"string\", \"index\": \"not_analyzed\"},\n        \"price\" : {\"type\": \"double\", \"index\": \"not_analyzed\"},\n        \"report_date\": {\"type\": \"date\", \"format\": \"yyyy-MM-dd\"}\n      }\n    }\n  }\n}\n\nPUT /test/parentType/1\n{\n  \"hotel_name\":\"holidays inn\",\n  \"hotel_level\": \"B\"\n}\n\nPUT /test/parentType/2\n{\n  \"hotel_name\": \"four seasons\",\n  \"hotel_level\": \"A\"\n}\n\nPUT /test/childType/order1?parent=1\n{\n  \"report_date\": \"2015-11-01\",\n  \"selling_type\": \"WEBSITE\",\n  \"price\": 766.0\n}\n\nPUT /test/childType/order2?parent=1\n{\n  \"report_date\": \"2015-11-03\",\n  \"selling_type\": \"APP\",\n  \"price\": 766.0  \n}\n\nPUT /test/childType/order3?parent=2\n{\n  \"report_date\": \"2015-11-02\",\n  \"selling_type\": \"WEBSITE\",\n  \"price\": 1666.0\n}\n```\n\nSearch request:\n\n```\nGET /test/_search\n{\n  \"size\": 0, \n  \"aggregations\" : {\n    \"hotel_level\" : {\n      \"terms\" : {\n        \"field\" : \"hotel_level\"\n      },\n      \"aggregations\" : {\n        \"order\" : {\n          \"children\" : {\n            \"type\" : \"childType\"\n          },\n          \"aggregations\" : {\n            \"selling_type_terms\" : {\n              \"terms\" : {\n                \"field\" : \"selling_type\"\n              }\n            },\n            \"report_date_terms\" : {\n              \"terms\" : {\n                \"field\" : \"report_date\"\n              }\n            },\n            \"selling_type_WEBSITE\" : {\n              \"filter\" : {\n                \"terms\" : {\n                  \"selling_type\" : [ \"WEBSITE\" ]\n                }\n              },\n              \"aggregations\" : {\n                \"income\" : {\n                  \"sum\" : {\n                    \"field\" : \"price\"\n                  }\n                }\n              }\n            },\n            \"report_date_20151101_20151103\" : {\n              \"filter\" : {\n                \"range\" : {\n                  \"report_date\" : {\n                    \"from\" : \"2015-11-01\",\n                    \"to\" : \"2015-11-03\",\n                    \"include_lower\" : true,\n                    \"include_upper\" : true\n                  }\n                }\n              },\n              \"aggregations\" : {\n                \"income\" : {\n                  \"sum\" : {\n                    \"field\" : \"price\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nWhen running this I do get results for the `report_date_20151101_20151103`(income is 1666). So this looks good here, but maybe my reproduction isn't exactly the same? (something got lost between translating the java snippets to curl requests)\n\nSome questions:\n- Can you try and run the reproduction I have shared here? \n- What ES version are you using exactly? \n- Did you run your reproduction on already existing index?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/168576989","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-168576989","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":168576989,"node_id":"MDEyOklzc3VlQ29tbWVudDE2ODU3Njk4OQ==","user":{"login":"saai","id":455787,"node_id":"MDQ6VXNlcjQ1NTc4Nw==","avatar_url":"https://avatars1.githubusercontent.com/u/455787?v=4","gravatar_id":"","url":"https://api.github.com/users/saai","html_url":"https://github.com/saai","followers_url":"https://api.github.com/users/saai/followers","following_url":"https://api.github.com/users/saai/following{/other_user}","gists_url":"https://api.github.com/users/saai/gists{/gist_id}","starred_url":"https://api.github.com/users/saai/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/saai/subscriptions","organizations_url":"https://api.github.com/users/saai/orgs","repos_url":"https://api.github.com/users/saai/repos","events_url":"https://api.github.com/users/saai/events{/privacy}","received_events_url":"https://api.github.com/users/saai/received_events","type":"User","site_admin":false},"created_at":"2016-01-04T04:17:04Z","updated_at":"2016-01-04T04:17:04Z","author_association":"NONE","body":"@martijnvg Thanks for the reply, your reproduction is working fine. Since I am using the version 1.7.1, I guess this is an old bug for \"date\" type,  it will take some time for my project to update to the version 2.0 +, I will let you know if I found the same issue after the update...\n\nAgain thanks very much for your conscientious reply !!!\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/183938731","html_url":"https://github.com/elastic/elasticsearch/issues/15005#issuecomment-183938731","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15005","id":183938731,"node_id":"MDEyOklzc3VlQ29tbWVudDE4MzkzODczMQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-02-14T17:57:07Z","updated_at":"2016-02-14T17:57:07Z","author_association":"CONTRIBUTOR","body":"thanks @saai - closing\n","performed_via_github_app":null}]