[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266516202","html_url":"https://github.com/elastic/elasticsearch/issues/22120#issuecomment-266516202","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22120","id":266516202,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NjUxNjIwMg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2016-12-12T18:48:37Z","updated_at":"2016-12-12T18:48:37Z","author_association":"MEMBER","body":"Not sure this is happens sporadically, I saw this a couple of times today out of probably 10 runs.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/266808143","html_url":"https://github.com/elastic/elasticsearch/issues/22120#issuecomment-266808143","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22120","id":266808143,"node_id":"MDEyOklzc3VlQ29tbWVudDI2NjgwODE0Mw==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-12-13T17:42:23Z","updated_at":"2016-12-13T17:57:28Z","author_association":"CONTRIBUTOR","body":"This test failure is triggered by PR #22049 which simplifies the cluster state update logic to only change the list of disco-nodes in the cluster state when said cluster state is going to be published. This means that a node cannot just locally change its cluster state and state changes always have to go through an active master.  The test failure here highlights a few issues that are not only bound to happen with the above change (but which makes them more frequent):\r\n- Validating full transport connections: Pinging reuses an existing connection when it's available. It does not re-check however whether the node on the other side is who it thinks it is when reconnecting. This is an issue if the cluster state has disco-nodes in it that are dead and when there are new live nodes which have the same transport address but different node id as the dead nodes and the pinging just reconnects to the different node.\r\n- Master election gets confused by dead nodes: The reason is that master election proceeds in two steps: 1) Pinging to determine a master and collecting joins 2) Publishing a cluster state which sets the new master and which needs \"approval\" from the master-eligible nodes through the process of committing. These two steps can disagree, however, when we elect a master based on nodes with same transport address (but different node id) as previous nodes which are now dead.  I've opened a PR (#22134) so that the live nodes take precedence over the dead nodes when completing the master-election process, so that the cluster state electing the master is published and committed by the right nodes.\r\n- Async shard fetching is brittle in presence of the issues above. The test actually fails because it ends up with unassigned shards. The reason for this is that the update logic for the cache used by the async shard fetching does not properly handle the scenario where target nodes of a shard fetch do not correspond to the nodes that the master (who is issuing the fetch) believes them to be. When the master starts fetching it adds a NodeEntry to the cache keyed by the node id. When a response is then received, it takes the node id that is contained in the response object to resolve the cache entry. In a situation where a node has a different node id than what the master believes it to have but the same transport address, the response will just be ignored and also prevent future fetching on this node id as the master thinks that fetching is still going on for that node. As such shard fetching will never complete and shards cannot be allocated as they're waiting on the fetching to complete.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/287496516","html_url":"https://github.com/elastic/elasticsearch/issues/22120#issuecomment-287496516","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22120","id":287496516,"node_id":"MDEyOklzc3VlQ29tbWVudDI4NzQ5NjUxNg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-03-17T23:36:18Z","updated_at":"2017-03-17T23:36:18Z","author_association":"MEMBER","body":"Closed by #22134","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292896092","html_url":"https://github.com/elastic/elasticsearch/issues/22120#issuecomment-292896092","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22120","id":292896092,"node_id":"MDEyOklzc3VlQ29tbWVudDI5Mjg5NjA5Mg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2017-04-10T09:24:24Z","updated_at":"2017-04-10T09:24:24Z","author_association":"MEMBER","body":"one more failure of this test: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+master+multijob-unix-compatibility/os=sles/814/ .\r\n\r\nShould I open a separate issue for it?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/292900971","html_url":"https://github.com/elastic/elasticsearch/issues/22120#issuecomment-292900971","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22120","id":292900971,"node_id":"MDEyOklzc3VlQ29tbWVudDI5MjkwMDk3MQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2017-04-10T09:45:23Z","updated_at":"2017-04-10T09:45:23Z","author_association":"CONTRIBUTOR","body":"Thanks for the notification @javanna. I've pushed 12471c4f76 as a follow-up to a3cceb8a00 (see #23922), which should fix this. If more failures of this occur after this commit, feel free to open a separate issue.","performed_via_github_app":null}]