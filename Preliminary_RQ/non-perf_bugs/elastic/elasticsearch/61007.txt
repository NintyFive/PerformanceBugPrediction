{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/61007","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61007/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61007/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61007/events","html_url":"https://github.com/elastic/elasticsearch/issues/61007","id":677483511,"node_id":"MDU6SXNzdWU2Nzc0ODM1MTE=","number":61007,"title":"[Elasticsearch][Transforms] Hits shown in preview + API, but not when searching the destination index","user":{"login":"P1llus","id":8027539,"node_id":"MDQ6VXNlcjgwMjc1Mzk=","avatar_url":"https://avatars1.githubusercontent.com/u/8027539?v=4","gravatar_id":"","url":"https://api.github.com/users/P1llus","html_url":"https://github.com/P1llus","followers_url":"https://api.github.com/users/P1llus/followers","following_url":"https://api.github.com/users/P1llus/following{/other_user}","gists_url":"https://api.github.com/users/P1llus/gists{/gist_id}","starred_url":"https://api.github.com/users/P1llus/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/P1llus/subscriptions","organizations_url":"https://api.github.com/users/P1llus/orgs","repos_url":"https://api.github.com/users/P1llus/repos","events_url":"https://api.github.com/users/P1llus/events{/privacy}","received_events_url":"https://api.github.com/users/P1llus/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1977209897,"node_id":"MDU6TGFiZWwxOTc3MjA5ODk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:ML","name":"Team:ML","color":"fef2c0","default":false,"description":"Meta label for the ML team"},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-08-12T08:00:37Z","updated_at":"2020-08-12T11:18:47Z","closed_at":"2020-08-12T11:18:47Z","author_association":"NONE","active_lock_reason":null,"body":"Version: Newest 7.9 BC build on ESS:\r\n\r\nIt seems that while the transform preview shows the correct amount of pivots and hits, the actual destination index is not populated with all hits. No error messages shown either and the transform is continuously running.\r\n\r\nExample:\r\nCreating the test source index:\r\n```\r\nPUT /corridtest/\r\nPOST /corridtest/_mapping\r\n{\r\n  \"properties\": {\r\n    \"corrid\": {\r\n      \"type\": \"keyword\"\r\n    },\r\n    \"timestamp\": {\r\n      \"type\": \"date\"\r\n    },\r\n    \"@timestamp\": {\r\n      \"type\": \"date\"\r\n    }\r\n  }\r\n}\r\nPUT /corridtest/_doc/1\r\n{\r\n  \"@timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"corrid\": \"123\"\r\n}\r\n\r\nPUT /corridtest/_doc/2\r\n{\r\n  \"@timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"timestamp\": \"2020-08-10T01:32:55.056Z\",\r\n  \"corrid\": \"123\"\r\n}\r\n\r\nPUT /corridtest/_doc/3\r\n{\r\n  \"@timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"timestamp\": \"2020-08-10T02:32:55.056Z\",\r\n  \"corrid\": \"123\"\r\n}\r\n\r\n```\r\n\r\nCreating the transform:\r\n```\r\nPUT _transform/avgtime\r\n{\r\n  \"source\": {\r\n    \"index\": \"corridtest\"\r\n  },\r\n  \"dest\" : { \r\n    \"index\" : \"totally_different_name\"\r\n  },\r\n  \"sync\" : { \r\n    \"time\": {\r\n      \"field\": \"timestamp\",\r\n      \"delay\": \"5s\"\r\n    }\r\n  },\r\n  \"pivot\": {\r\n    \"group_by\": {  \r\n      \"corrid\": { \"terms\": { \"field\": \"corrid\" } }\r\n      },\r\n    \"aggregations\": {\r\n      \"timestamp.min\": { \"min\": { \"field\": \"timestamp\" }},\r\n      \"timestamp.max\": { \"max\": { \"field\": \"timestamp\" }},\r\n      \"timestamp.duration_ms\": { \r\n        \"bucket_script\": {\r\n          \"buckets_path\": {\r\n            \"min_time\": \"timestamp.min.value\",\r\n            \"max_time\": \"timestamp.max.value\"\r\n          },\r\n          \"script\": \"(params.max_time - params.min_time)\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAfter going to the Transform UI and clicking start on the transform (continuously) I go back and add another document:\r\n```\r\nPUT /corridtest/_doc/5\r\n{\r\n  \"@timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"corrid\": \"1234\"\r\n}\r\n\r\nPUT /corridtest/_doc/6\r\n{\r\n  \"@timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"timestamp\": \"2020-08-10T01:32:55.056Z\",\r\n  \"corrid\": \"1234\"\r\n}\r\n\r\nPUT /corridtest/_doc/7\r\n{\r\n  \"@timestamp\": \"2020-08-12T00:32:55.056Z\",\r\n  \"timestamp\": \"2020-08-10T02:32:55.056Z\",\r\n  \"corrid\": \"1234\"\r\n}\r\n```\r\nNow the Preview in the UI shows both corrid's, which is what I pivot on:\r\n![image](https://user-images.githubusercontent.com/8027539/89990251-5d748d00-dc82-11ea-94f7-77229be0073f.png)\r\n\r\nThe preview API also shows 2 hits:\r\n```\r\nPOST _transform/_preview\r\n{\r\n  \"source\": {\r\n    \"index\": \"corridtest\"\r\n  },\r\n  \"dest\" : { \r\n    \"index\" : \"totally_different_name\"\r\n  },\r\n  \"sync\" : { \r\n    \"time\": {\r\n      \"field\": \"timestamp\",\r\n      \"delay\": \"5s\"\r\n    }\r\n  },\r\n  \"pivot\": {\r\n    \"group_by\": {  \r\n      \"corrid\": { \"terms\": { \"field\": \"corrid\" } }\r\n      },\r\n    \"aggregations\": {\r\n      \"timestamp.min\": { \"min\": { \"field\": \"timestamp\" }},\r\n      \"timestamp.max\": { \"max\": { \"field\": \"timestamp\" }},\r\n      \"timestamp.duration_ms\": { \r\n        \"bucket_script\": {\r\n          \"buckets_path\": {\r\n            \"min_time\": \"timestamp.min.value\",\r\n            \"max_time\": \"timestamp.max.value\"\r\n          },\r\n          \"script\": \"(params.max_time - params.min_time)\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nOutput:\r\n```\r\n{\r\n  \"preview\" : [\r\n    {\r\n      \"corrid\" : \"123\",\r\n      \"timestamp\" : {\r\n        \"duration_ms\" : 1.692E8,\r\n        \"min\" : \"2020-08-10T01:32:55.056Z\",\r\n        \"max\" : \"2020-08-12T00:32:55.056Z\"\r\n      }\r\n    },\r\n    {\r\n      \"corrid\" : \"1234\",\r\n      \"timestamp\" : {\r\n        \"duration_ms\" : 1.692E8,\r\n        \"min\" : \"2020-08-10T01:32:55.056Z\",\r\n        \"max\" : \"2020-08-12T00:32:55.056Z\"\r\n      }\r\n    }\r\n  ],\r\n  \"generated_dest_index\" : {\r\n    \"mappings\" : {\r\n      \"_meta\" : {\r\n        \"_transform\" : {\r\n          \"transform\" : \"transform-preview\",\r\n          \"version\" : {\r\n            \"created\" : \"7.9.0\"\r\n          },\r\n          \"creation_date_in_millis\" : 1597219137793\r\n        },\r\n        \"created_by\" : \"transform\"\r\n      },\r\n      \"properties\" : {\r\n        \"timestamp.min\" : {\r\n          \"type\" : \"date\"\r\n        },\r\n        \"timestamp.max\" : {\r\n          \"type\" : \"date\"\r\n        },\r\n        \"corrid\" : {\r\n          \"type\" : \"keyword\"\r\n        },\r\n        \"timestamp\" : {\r\n          \"type\" : \"object\"\r\n        }\r\n      }\r\n    },\r\n    \"settings\" : {\r\n      \"index\" : {\r\n        \"number_of_shards\" : \"1\",\r\n        \"auto_expand_replicas\" : \"0-1\"\r\n      }\r\n    },\r\n    \"aliases\" : { }\r\n  }\r\n}\r\n```\r\n\r\nBut running `GET /totally_different_name/_search` returns:\r\n```\r\n{\r\n  \"took\" : 0,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 1,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"totally_different_name\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"MUPKYASc0DQQB0SJWijKeKoAAAAAAAAA\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"corrid\" : \"123\",\r\n          \"timestamp\" : {\r\n            \"duration_ms\" : 1.692E8,\r\n            \"min\" : \"2020-08-10T01:32:55.056Z\",\r\n            \"max\" : \"2020-08-12T00:32:55.056Z\"\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nSo the second set of documents is not actually being added it seems","closed_by":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"performed_via_github_app":null}