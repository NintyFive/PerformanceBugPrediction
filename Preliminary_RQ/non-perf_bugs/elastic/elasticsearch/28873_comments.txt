[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/369723635","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-369723635","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":369723635,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTcyMzYzNQ==","user":{"login":"nik9000","id":215970,"node_id":"MDQ6VXNlcjIxNTk3MA==","avatar_url":"https://avatars2.githubusercontent.com/u/215970?v=4","gravatar_id":"","url":"https://api.github.com/users/nik9000","html_url":"https://github.com/nik9000","followers_url":"https://api.github.com/users/nik9000/followers","following_url":"https://api.github.com/users/nik9000/following{/other_user}","gists_url":"https://api.github.com/users/nik9000/gists{/gist_id}","starred_url":"https://api.github.com/users/nik9000/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nik9000/subscriptions","organizations_url":"https://api.github.com/users/nik9000/orgs","repos_url":"https://api.github.com/users/nik9000/repos","events_url":"https://api.github.com/users/nik9000/events{/privacy}","received_events_url":"https://api.github.com/users/nik9000/received_events","type":"User","site_admin":false},"created_at":"2018-03-01T20:40:26Z","updated_at":"2018-03-01T20:40:26Z","author_association":"CONTRIBUTOR","body":"Pinging @elastic/es-core-infra, more specifically @javanna.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/369961552","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-369961552","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":369961552,"node_id":"MDEyOklzc3VlQ29tbWVudDM2OTk2MTU1Mg==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-03-02T15:56:15Z","updated_at":"2018-03-02T15:56:15Z","author_association":"MEMBER","body":"The problem here is that the returned suggestion is not keyed by its type, it should be `term#did_you_mean_term` rather than `did_you_mean_term`. That is because the high-level client must set the `typed_keys` parameter to `true` in order to be able to parse aggs and suggest responses into their own proper object which depend on the returned type.\r\n\r\nUnfortunately, the client doesn't set such param when calling `searchScroll` but only when calling `search` and `multiSearch`, and the reason for that is that Elasticsearch itself doesn't support the `typed_keys` param in its `_search/scroll` endpoint. \r\n\r\nI wonder though why the search scroll endpoint return suggestions? It doesn't return aggregations, why would it return suggestions? That sounds like a bug to me, thoughts @elastic/es-search-aggs ?\r\n\r\n@xiyangliu what is the usecase for having suggestions returned as part of a search/scroll response? I think as a workaround, while we figure this out I would take out the suggestion from the initial search request.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/370038136","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-370038136","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":370038136,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDAzODEzNg==","user":{"login":"xiyangliu","id":1987190,"node_id":"MDQ6VXNlcjE5ODcxOTA=","avatar_url":"https://avatars0.githubusercontent.com/u/1987190?v=4","gravatar_id":"","url":"https://api.github.com/users/xiyangliu","html_url":"https://github.com/xiyangliu","followers_url":"https://api.github.com/users/xiyangliu/followers","following_url":"https://api.github.com/users/xiyangliu/following{/other_user}","gists_url":"https://api.github.com/users/xiyangliu/gists{/gist_id}","starred_url":"https://api.github.com/users/xiyangliu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiyangliu/subscriptions","organizations_url":"https://api.github.com/users/xiyangliu/orgs","repos_url":"https://api.github.com/users/xiyangliu/repos","events_url":"https://api.github.com/users/xiyangliu/events{/privacy}","received_events_url":"https://api.github.com/users/xiyangliu/received_events","type":"User","site_admin":false},"created_at":"2018-03-02T20:07:30Z","updated_at":"2018-03-02T20:07:30Z","author_association":"NONE","body":"@javanna We ask for aggregations and suggestions in the initial search request. They can be parsed successfully from search response. \r\n\r\nHowever in following scroll response, aggregations are removed intentionally (this is mentioned in [doc](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-scroll.html)) but suggestions are retained. That's where the parsing exception happens.\r\n\r\nI guess the team is aware of the `typed_keys` issue so they removed aggregations but forget suggestions. Because aggregations also requires a `type#name` parsing format.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/370040449","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-370040449","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":370040449,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDA0MDQ0OQ==","user":{"login":"xiyangliu","id":1987190,"node_id":"MDQ6VXNlcjE5ODcxOTA=","avatar_url":"https://avatars0.githubusercontent.com/u/1987190?v=4","gravatar_id":"","url":"https://api.github.com/users/xiyangliu","html_url":"https://github.com/xiyangliu","followers_url":"https://api.github.com/users/xiyangliu/followers","following_url":"https://api.github.com/users/xiyangliu/following{/other_user}","gists_url":"https://api.github.com/users/xiyangliu/gists{/gist_id}","starred_url":"https://api.github.com/users/xiyangliu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xiyangliu/subscriptions","organizations_url":"https://api.github.com/users/xiyangliu/orgs","repos_url":"https://api.github.com/users/xiyangliu/repos","events_url":"https://api.github.com/users/xiyangliu/events{/privacy}","received_events_url":"https://api.github.com/users/xiyangliu/received_events","type":"User","site_admin":false},"created_at":"2018-03-02T20:17:18Z","updated_at":"2018-03-02T20:17:18Z","author_association":"NONE","body":"As a work around, we are now using low level client for scroll request and handling scroll response by ourselves.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/370049899","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-370049899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":370049899,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDA0OTg5OQ==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-03-02T20:56:17Z","updated_at":"2018-03-02T20:56:17Z","author_association":"MEMBER","body":"I am aware of where the problem is, I just don't get why suggestions would be useful in a scroll response, would you have an answer to that? We didn't expect them to be there when building the client, that is why we are not providing the `typed_keys` parameter. Aggregations were not removed for that reason.\r\n\r\nUsing the low-level client is quite a drastic work-around, you could just have two search requests, one for the suggestion, and another one without the suggestion to initiate the scroll.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/370056406","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-370056406","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":370056406,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MDA1NjQwNg==","user":{"login":"edudar","id":584181,"node_id":"MDQ6VXNlcjU4NDE4MQ==","avatar_url":"https://avatars0.githubusercontent.com/u/584181?v=4","gravatar_id":"","url":"https://api.github.com/users/edudar","html_url":"https://github.com/edudar","followers_url":"https://api.github.com/users/edudar/followers","following_url":"https://api.github.com/users/edudar/following{/other_user}","gists_url":"https://api.github.com/users/edudar/gists{/gist_id}","starred_url":"https://api.github.com/users/edudar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/edudar/subscriptions","organizations_url":"https://api.github.com/users/edudar/orgs","repos_url":"https://api.github.com/users/edudar/repos","events_url":"https://api.github.com/users/edudar/events{/privacy}","received_events_url":"https://api.github.com/users/edudar/received_events","type":"User","site_admin":false},"created_at":"2018-03-02T21:22:58Z","updated_at":"2018-03-02T21:22:58Z","author_association":"NONE","body":"@javanna We use low-level client anyway for APIs that not yet implemented in high-level one (as of v5.6.8) so for us, it's not that drastic, more like a business as usual. An edge case here, however, is that we have a use for aggregations and suggesters on **initial** search request that creates a scroll. It's UI thing. And no, we don't need either of them when actual scroll request happens subsequently, that's why we manually remove `suggest` part from json response before feeding it to `XContentHelper.createParser()`","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/371830449","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-371830449","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":371830449,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MTgzMDQ0OQ==","user":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"created_at":"2018-03-09T14:40:09Z","updated_at":"2018-03-09T14:40:09Z","author_association":"MEMBER","body":"We discussed this in FixIt Friday and decided that suggestions should not be part of a scroll request. \r\nYou can use multi-search to build two queries, one for suggestion and one for the scroll and then proceed the scroll with the scroll_id returned in the second request.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/372351285","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-372351285","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":372351285,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MjM1MTI4NQ==","user":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"created_at":"2018-03-12T15:30:43Z","updated_at":"2018-03-12T15:30:43Z","author_association":"MEMBER","body":"I think we should do something about this though: be consistent with aggregations that are not being returned as part of scroll responses, hence stop returning suggestions too.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/373470659","html_url":"https://github.com/elastic/elasticsearch/issues/28873#issuecomment-373470659","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28873","id":373470659,"node_id":"MDEyOklzc3VlQ29tbWVudDM3MzQ3MDY1OQ==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-03-15T18:04:57Z","updated_at":"2018-03-15T18:04:57Z","author_association":"CONTRIBUTOR","body":"For the record, we also said we'd like to stop allowing aggregations on the first scroll page, and instead allow users to acquire point-in-time snapshots so that they can run multiple queries against a consistent view of the index, which is the only point of allowing to run aggs and scroll on the same request today: #26472.","performed_via_github_app":null}]