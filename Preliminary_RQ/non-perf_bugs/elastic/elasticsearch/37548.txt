{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37548","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37548/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37548/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37548/events","html_url":"https://github.com/elastic/elasticsearch/issues/37548","id":399933415,"node_id":"MDU6SXNzdWUzOTk5MzM0MTU=","number":37548,"title":"Curator failing to delete old snapshots","user":{"login":"mojamal","id":11744186,"node_id":"MDQ6VXNlcjExNzQ0MTg2","avatar_url":"https://avatars1.githubusercontent.com/u/11744186?v=4","gravatar_id":"","url":"https://api.github.com/users/mojamal","html_url":"https://github.com/mojamal","followers_url":"https://api.github.com/users/mojamal/followers","following_url":"https://api.github.com/users/mojamal/following{/other_user}","gists_url":"https://api.github.com/users/mojamal/gists{/gist_id}","starred_url":"https://api.github.com/users/mojamal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mojamal/subscriptions","organizations_url":"https://api.github.com/users/mojamal/orgs","repos_url":"https://api.github.com/users/mojamal/repos","events_url":"https://api.github.com/users/mojamal/events{/privacy}","received_events_url":"https://api.github.com/users/mojamal/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2019-01-16T18:12:57Z","updated_at":"2019-01-31T17:26:45Z","closed_at":"2019-01-31T17:26:45Z","author_association":"NONE","active_lock_reason":null,"body":"**<!-- Bug report -->**\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n$ /usr/share/elasticsearch/bin/elasticsearch -version\r\nVersion: 5.6.14, Build: f310fe9/2018-12-05T21:20:16.416Z, JVM: 1.8.0_191\r\n\r\n**Plugins installed**: []\r\nx-pack 5.6.14\r\nrepository-s3 5.6.14\r\nkibana 5.6.14\r\ncerebro - 0.8.1\r\nlicense 5.x \r\n\r\n**JVM version** (`java -version`):\r\n$ java -version\r\njava version \"1.8.0_191\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_191-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.191-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n$ uname -a\r\nLinux ip-10-20-8-162 4.4.0-1057-aws #66-Ubuntu SMP Thu May 3 12:49:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n$ cat /etc/lsb-release\r\nDISTRIB_ID=Ubuntu\r\nDISTRIB_RELEASE=16.04\r\nDISTRIB_CODENAME=xenial\r\nDISTRIB_DESCRIPTION=\"Ubuntu 16.04.5 LTS\"\r\n\r\n**Description :** Curator fails to cleanup old snapshots.\r\n\r\nA related github issue that has been closed  is : https://github.com/elastic/elasticsearch/issues/27061\r\n\r\n**Reproduce Snapshot Setup**\r\nSnapshots are configured as follows in crontab for Chef Name: Snapshot ES indices using Curator\r\n30 1 * * * /usr/bin/curator --config /etc/logstash/curator_client_masteronly.yml /etc/logstash/curator_snapshot.yml && sh /etc/logstash/gotel_snapshot_checkin.sh\r\n\r\n$ sudo cat /etc/logstash/curator_client_masteronly.yml\r\nclient:\r\n  hosts:\r\n    - <REDACTED IPADDRESS>\r\n  port: 9200\r\n  use_ssl: False\r\n  certificate: '/etc/ssl/certs/ROOT-CA.pem'\r\n  client_cert:\r\n  client_key:\r\n  aws_key:\r\n  aws_secret_key:\r\n  aws_region:\r\n  ssl_no_validate: False\r\n  http_auth:\r\n  timeout: 30\r\n  master_only: True\r\n\r\nlogging:\r\n  loglevel: INFO\r\n  logfile: /mnt/log/elasticsearch/curator.log\r\n  logformat: default\r\n  blacklist: ['elasticsearch', 'urllib3']\r\n\r\n$ sudo cat /etc/logstash/curator_snapshot.yml\r\nactions:\r\n  1:\r\n    action: snapshot\r\n    description: >-\r\n      Snapshot selected indices to 'repository' with the snapshot name or name\r\n      pattern in 'name'.  Use all other options as assigned\r\n    options:\r\n      repository: brepository\r\n      skip_repo_fs_check: False\r\n      # Leaving name blank will result in the default 'curator-%Y%m%d%H%M%S'\r\n      name:\r\n      wait_for_completion: True\r\n      max_wait: 7200\r\n      ignore_unavailable: False\r\n      include_global_state: True\r\n      partial: False\r\n      ignore_empty_list: True\r\n    filters:\r\n    - filtertype: pattern\r\n      kind: regex\r\n      value: .*\r\n  2:\r\n    action: delete_snapshots\r\n    description: >-\r\n      Delete snapshots from repostory: brepository older than 15 days.\r\n    options:\r\n      repository: brepository\r\n      disable_action: False\r\n      ignore_empty_list: True\r\n      timeout_override: 3600\r\n    filters:\r\n    - filtertype: pattern\r\n      kind: prefix\r\n      value: curator-\r\n      exclude:\r\n    - filtertype: age\r\n      source: creation_date\r\n      direction: older\r\n      unit: days\r\n      unit_count: 15\r\n\r\n**Relevant Logs while triaging the failed snapshots : \r\nCurator Error**\r\n\r\n2019-01-15 01:33:36,480 ERROR     Failed to complete action: delete_snapshots.  <class 'curator.exceptions.FailedExecution'>: Exception encountered.  Rerun with loglevel DEBUG and/or check Elasticsearch logs for more information. Exception: TransportError(500, 'index_shard_snapshot_failed_exception', 'error deleting index file [pending-index-29] during cleanup') \r\n\r\n**ES Error**\r\n[2019-01-15T01:33:36,473][WARN ][r.suppressed             ] path: /_snapshot/brepository/curator-20181231013002, params: {repository=brepository, snapshot=curator-20181231013002}[2019-01-15T01:33:36,473][WARN ][r.suppressed             ] path: /_snapshot/brepository/curator-20181231013002, params: {repository=brepository, snapshot=curator-20181231013002}org.elasticsearch.index.snapshots.IndexShardSnapshotFailedException: error deleting index file [pending-index-29] during cleanup at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:1149) ~[elasticsearch-5.6.14.jar:5.6.14] at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.delete(BlobStoreRepository.java:1114) ~[elasticsearch-5.6.14.jar:5.6.14] at org.elasticsearch.repositories.blobstore.BlobStoreRepository.delete(BlobStoreRepository.java:1042) ~[elasticsearch-5.6.14.jar:5.6.14] at org.elasticsearch.repositories.blobstore.BlobStoreRepository.deleteSnapshot(BlobStoreRepository.java:467) ~[elasticsearch-5.6.14.jar:5.6.14] at org.elasticsearch.snapshots.SnapshotsService.lambda$deleteSnapshotFromRepository$6(SnapshotsService.java:1309) ~[elasticsearch-5.6.14.jar:5.6.14] at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:576) ~[elasticsearch-5.6.14.jar:5.6.14] at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_191] at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_191] at java.lang.Thread.run(Thread.java:748) [?:1.8.0_191]Caused by: java.nio.file.NoSuchFileException: Blob [pending-index-29] does not exist at org.elasticsearch.repositories.s3.S3BlobContainer.deleteBlob(S3BlobContainer.java:122) ~[?:?] at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:1145) ~[elasticsearch-5.6.14.jar:5.6.14] ... 8 more\r\n\r\n**MAIN ERROR**: Caused by: java.nio.file.NoSuchFileException: Blob [pending-index-29] does not exist at org.elasticsearch.repositories.s3.S3BlobContainer.deleteBlob(S3BlobContainer.java:122) ~[?:?] at org.elasticsearch.repositories.blobstore.BlobStoreRepository$Context.finalize(BlobStoreRepository.java:1145) ~[elasticsearch-5.6.14.jar:5.6.14]","closed_by":{"login":"mojamal","id":11744186,"node_id":"MDQ6VXNlcjExNzQ0MTg2","avatar_url":"https://avatars1.githubusercontent.com/u/11744186?v=4","gravatar_id":"","url":"https://api.github.com/users/mojamal","html_url":"https://github.com/mojamal","followers_url":"https://api.github.com/users/mojamal/followers","following_url":"https://api.github.com/users/mojamal/following{/other_user}","gists_url":"https://api.github.com/users/mojamal/gists{/gist_id}","starred_url":"https://api.github.com/users/mojamal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mojamal/subscriptions","organizations_url":"https://api.github.com/users/mojamal/orgs","repos_url":"https://api.github.com/users/mojamal/repos","events_url":"https://api.github.com/users/mojamal/events{/privacy}","received_events_url":"https://api.github.com/users/mojamal/received_events","type":"User","site_admin":false},"performed_via_github_app":null}