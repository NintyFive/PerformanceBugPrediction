{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36248","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36248/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36248/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36248/events","html_url":"https://github.com/elastic/elasticsearch/issues/36248","id":387703616,"node_id":"MDU6SXNzdWUzODc3MDM2MTY=","number":36248,"title":"Highlighting not working at field boundaries with whitespace or non-printing characters","user":{"login":"tmo-trustpilot","id":13134751,"node_id":"MDQ6VXNlcjEzMTM0NzUx","avatar_url":"https://avatars2.githubusercontent.com/u/13134751?v=4","gravatar_id":"","url":"https://api.github.com/users/tmo-trustpilot","html_url":"https://github.com/tmo-trustpilot","followers_url":"https://api.github.com/users/tmo-trustpilot/followers","following_url":"https://api.github.com/users/tmo-trustpilot/following{/other_user}","gists_url":"https://api.github.com/users/tmo-trustpilot/gists{/gist_id}","starred_url":"https://api.github.com/users/tmo-trustpilot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tmo-trustpilot/subscriptions","organizations_url":"https://api.github.com/users/tmo-trustpilot/orgs","repos_url":"https://api.github.com/users/tmo-trustpilot/repos","events_url":"https://api.github.com/users/tmo-trustpilot/events{/privacy}","received_events_url":"https://api.github.com/users/tmo-trustpilot/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-12-05T11:01:50Z","updated_at":"2018-12-05T16:18:05Z","closed_at":"2018-12-05T16:17:58Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**\r\nVersion: 6.3.2, Build: default/tar/053779d/2018-07-20T05:20:23.451332Z, JVM: 10.0.2\r\n\r\n**Plugins installed**:\r\ningest-geoip:6.3.2\r\ningest-user-agent:6.3.2\r\n\r\n**JVM version** (`java -version`):\r\nNot sure, I'm using the docker image `docker.elastic.co/elasticsearch/elasticsearch:6.3.2` to reproduce this but java isn't in the $PATH on that.\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 77b0d7cbec64 4.9.93-linuxkit-aufs #1 SMP Wed Jun 6 16:55:56 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nFiltering for a search string and using highlight with either a non-printing character (eg. '\\a') or a whitespace character ('\\r' or ' ') will not include the first highlight tag if the matching text is at the start of the string. I believe it also occurs with the closing tag if the result is the end of the search string.\r\n\r\nThis leads to an unmatched closing tag in the search results. I expect that the starting tag of the highlighting should be included in the highlight result.\r\n\r\nIn the example below I have `number_of_fragments` of 0 but it also occurs with `fragment_size` set instead. In our use case we're using '\\a' from the python client as our delimiter which has the same effect. I can't work out how to escape that properly in CURL for reproducing, but the same thing is happening with '\\r'.\r\n\r\n**Steps to reproduce**:\r\n\r\n\r\n\r\nThis script will reproduce the issue **it will delete an index called `sample_index` if you run it**.\r\nIt shows:\r\n1. Searching for the middle of the text with \"\\r\" as tags (which works)\r\n2. Seaching for the start of the text with \"$\" as tags (which works)\r\n3. Searching for the start of the text with \"\\r\" as tags (which doesn't work)\r\n\r\n```sh\r\n#!/bin/sh\r\n\r\necho Deleting any existing index\r\ncurl -s -X DELETE localhost:9200/sample_index\r\necho\r\n\r\necho Creating new index\r\ncurl -s -X PUT localhost:9200/sample_index -H 'Content-Type: application/json' -d' \r\n{ \r\n  \"mappings\": {\r\n    \"sample\": {\r\n      \"properties\": {\r\n          \"SampleField\": { \"type\": \"text\" }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\necho\r\n\r\necho Inserting new document\r\ncurl -s -X POST localhost:9200/sample_index/sample?refresh -H 'Content-Type: application/json' --data-binary \\\r\n  '{ \"SampleField\": \"Elastic is great for search\" }'\r\necho\r\n\r\necho Searching for text in middle\r\ncurl -s -X GET localhost:9200/_search -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [{\r\n        \"query_string\": { \"fields\": [ \"SampleField\" ], \"query\": \"great\" }\r\n      }]\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"pre_tags\": [ \"\\r\" ],\r\n    \"post_tags\": [ \"\\r\" ],\r\n    \"fields\": { \"SampleField\": {} },\r\n    \"number_of_fragments\": 0\r\n  }\r\n}\r\n' | python -m json.tool\r\n# hits.hits.highlight.SampleField: \"Elastic is \\rgreat\\r for search\"\r\n\r\necho Searching for text at start with plain text delimiters\r\ncurl -s -X GET localhost:9200/_search -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [{\r\n        \"query_string\": { \"fields\": [ \"SampleField\" ], \"query\": \"Elastic\" }\r\n      }]\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"pre_tags\": [ \"$\" ],\r\n    \"post_tags\": [ \"$\" ],\r\n    \"fields\": { \"SampleField\": {} },\r\n    \"number_of_fragments\": 0\r\n  }\r\n}\r\n' | python -m json.tool\r\n# hits.hits.highlight.SampleField: \"$Elastic$ is great for search\"\r\n\r\necho Searching for text at start with newline delimiters\r\ncurl -s -X GET localhost:9200/_search -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [{\r\n        \"query_string\": { \"fields\": [ \"SampleField\" ], \"query\": \"Elastic\" }\r\n      }]\r\n    }\r\n  },\r\n  \"highlight\": {\r\n    \"pre_tags\": [ \"\\r\" ],\r\n    \"post_tags\": [ \"\\r\" ],\r\n    \"fields\": { \"SampleField\": {} },\r\n    \"number_of_fragments\": 0\r\n  }\r\n}\r\n' | python -m json.tool\r\n# hits.hits.highlight.SampleField: \"Elastic\\r is great for search\"\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\nNothing interesting shows up\r\n","closed_by":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"performed_via_github_app":null}