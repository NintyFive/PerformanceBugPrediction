[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631509560","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631509560","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631509560,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTUwOTU2MA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T14:29:01Z","updated_at":"2020-05-20T14:29:01Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra (:Core/Infra/Build)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631540806","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631540806","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631540806,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTU0MDgwNg==","user":{"login":"mark-vieira","id":4106672,"node_id":"MDQ6VXNlcjQxMDY2NzI=","avatar_url":"https://avatars2.githubusercontent.com/u/4106672?v=4","gravatar_id":"","url":"https://api.github.com/users/mark-vieira","html_url":"https://github.com/mark-vieira","followers_url":"https://api.github.com/users/mark-vieira/followers","following_url":"https://api.github.com/users/mark-vieira/following{/other_user}","gists_url":"https://api.github.com/users/mark-vieira/gists{/gist_id}","starred_url":"https://api.github.com/users/mark-vieira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mark-vieira/subscriptions","organizations_url":"https://api.github.com/users/mark-vieira/orgs","repos_url":"https://api.github.com/users/mark-vieira/repos","events_url":"https://api.github.com/users/mark-vieira/events{/privacy}","received_events_url":"https://api.github.com/users/mark-vieira/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T15:16:55Z","updated_at":"2020-05-20T15:16:55Z","author_association":"CONTRIBUTOR","body":"@rjernst noticed this recently. We should just use runtime classpath here since it already excludes compile only dependencies.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631562837","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631562837","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631562837,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTU2MjgzNw==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T15:52:46Z","updated_at":"2020-05-20T15:52:46Z","author_association":"MEMBER","body":"I think this is historical. We used the concept of compileOnly in the ES build before it existed in gradle. When we switched to using gradle's compileOnly, we simply swapped out the old configuration for gradle's, without auditing whether or not it was necessary anymore.\r\n\r\n+1 to remove","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631577747","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631577747","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631577747,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTU3Nzc0Nw==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T16:17:08Z","updated_at":"2020-05-20T16:17:08Z","author_association":"MEMBER","body":"While working on #56926, I've realized there is another important side effect of compileOnly in the dependencyLicenses case. For modules/plugins, we put the server project (ie the core elasticsearch jar) in compileOnly, and use this as \"provided\" (in fact that was the old configuration we had before compileOnly). When we subtract it out of runtime for dependencyLicenses, this is to not have to repeat the licenses for server dependencies in every module/plugin. We need to maintain that functionality somehow.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631603367","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631603367","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631603367,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTYwMzM2Nw==","user":{"login":"breskeby","id":77300,"node_id":"MDQ6VXNlcjc3MzAw","avatar_url":"https://avatars3.githubusercontent.com/u/77300?v=4","gravatar_id":"","url":"https://api.github.com/users/breskeby","html_url":"https://github.com/breskeby","followers_url":"https://api.github.com/users/breskeby/followers","following_url":"https://api.github.com/users/breskeby/following{/other_user}","gists_url":"https://api.github.com/users/breskeby/gists{/gist_id}","starred_url":"https://api.github.com/users/breskeby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breskeby/subscriptions","organizations_url":"https://api.github.com/users/breskeby/orgs","repos_url":"https://api.github.com/users/breskeby/repos","events_url":"https://api.github.com/users/breskeby/events{/privacy}","received_events_url":"https://api.github.com/users/breskeby/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T17:03:13Z","updated_at":"2020-05-20T17:03:13Z","author_association":"CONTRIBUTOR","body":"@rjernst do you know where in the build these `compileOnly` dependencies are wired into the `runtimeClasspath`?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631631077","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631631077","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631631077,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTYzMTA3Nw==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T17:56:09Z","updated_at":"2020-05-20T17:56:09Z","author_association":"MEMBER","body":"They are not wired into the compileOnly classpath. Let me give a more concrete example as to what I see happening.\r\n\r\nplugins/repository-s3 has a dependency on aws, which transitively depends on jackson. Currently we explicitly add this jackson dep since we don't use transitive deps, but elasticsearch server depends on jackson as well. Anything that server depends on is automatically provided to all modules/plugins because it is loaded in the root classloader. For this reason the server project is added as compileOnly to all modules/plugins: we don't want them to include any jars provided by server in the plugin, because that would cause jarhell. By subtracting compileOnly, we not only remove ES server, but all of its deps. If we remove the subtraction, we would be including jackson in both the built plugin, as well as in dependency license checking. So we need a way to still remove all those common deps.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/631676525","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-631676525","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":631676525,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMTY3NjUyNQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2020-05-20T19:24:51Z","updated_at":"2020-05-20T19:24:51Z","author_association":"MEMBER","body":"Another note: I've found another issue related to this and extended plugins. Due to how we currently load SPI jars from extensible plugins, the plugins implementing SPI extensions get the extended plugin fully on their classpath. This means if they share any dependencies, we must remove those from the latter or we get jarhell. Currently removing compileOnly \"fixes\" this issue indirectly. One concrete example is eql, which extends painless. Both depend on antlr. I tried changing to only use the spi jar for painless in eql, as compileOnly. This caused antlr to get included in the eql plugin zip, which caused jarhell at runtime.\r\n\r\nhttps://gradle-enterprise.elastic.co/s/s6xv366hjhiay/console-log?task=:docs:integTestRunner","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/633519073","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-633519073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":633519073,"node_id":"MDEyOklzc3VlQ29tbWVudDYzMzUxOTA3Mw==","user":{"login":"breskeby","id":77300,"node_id":"MDQ6VXNlcjc3MzAw","avatar_url":"https://avatars3.githubusercontent.com/u/77300?v=4","gravatar_id":"","url":"https://api.github.com/users/breskeby","html_url":"https://github.com/breskeby","followers_url":"https://api.github.com/users/breskeby/followers","following_url":"https://api.github.com/users/breskeby/following{/other_user}","gists_url":"https://api.github.com/users/breskeby/gists{/gist_id}","starred_url":"https://api.github.com/users/breskeby/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/breskeby/subscriptions","organizations_url":"https://api.github.com/users/breskeby/orgs","repos_url":"https://api.github.com/users/breskeby/repos","events_url":"https://api.github.com/users/breskeby/events{/privacy}","received_events_url":"https://api.github.com/users/breskeby/received_events","type":"User","site_admin":false},"created_at":"2020-05-25T11:10:00Z","updated_at":"2020-05-25T11:10:39Z","author_association":"CONTRIBUTOR","body":"Thanks for the details explanation and those examples. \r\n\r\n> plugins/repository-s3 has a dependency on aws, which transitively depends on jackson. Currently we explicitly add this jackson dep since we don't use transitive deps, but elasticsearch server depends on jackson as well. \r\n\r\nI see that in `repository-s3` the jackson dependencies are added via the compile configuration. It seems to me that this should be added to the `compileOnly` configuration instead then shouldn't it? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/634203875","html_url":"https://github.com/elastic/elasticsearch/issues/56998#issuecomment-634203875","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/56998","id":634203875,"node_id":"MDEyOklzc3VlQ29tbWVudDYzNDIwMzg3NQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2020-05-26T18:38:19Z","updated_at":"2020-05-26T18:38:19Z","author_association":"MEMBER","body":"Yes and no. While that seems like it would solve the immediate issue, it still has the problem that when we switch back to transitive dependencies, we would have no mechanism to remove provided dependencies from the transitive dependencies.","performed_via_github_app":null}]