{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/12278","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12278/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12278/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/12278/events","html_url":"https://github.com/elastic/elasticsearch/issues/12278","id":95285591,"node_id":"MDU6SXNzdWU5NTI4NTU5MQ==","number":12278,"title":"Date Histogram Aggregations w/ `extended_bounds` and `time_zone`","user":{"login":"feltnerm","id":146949,"node_id":"MDQ6VXNlcjE0Njk0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/146949?v=4","gravatar_id":"","url":"https://api.github.com/users/feltnerm","html_url":"https://github.com/feltnerm","followers_url":"https://api.github.com/users/feltnerm/followers","following_url":"https://api.github.com/users/feltnerm/following{/other_user}","gists_url":"https://api.github.com/users/feltnerm/gists{/gist_id}","starred_url":"https://api.github.com/users/feltnerm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/feltnerm/subscriptions","organizations_url":"https://api.github.com/users/feltnerm/orgs","repos_url":"https://api.github.com/users/feltnerm/repos","events_url":"https://api.github.com/users/feltnerm/events{/privacy}","received_events_url":"https://api.github.com/users/feltnerm/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":5,"created_at":"2015-07-15T20:40:50Z","updated_at":"2015-08-19T16:42:19Z","closed_at":"2015-08-19T16:42:19Z","author_association":"NONE","active_lock_reason":null,"body":"Hey all, \n\nI'm performing a date histogram aggregation over the past day (`'now/d'` -> `'now/d'`), and would like to get results into hourly buckets. I am using the `extended_bounds` of the aggregation because I would still like to get empty buckets back (as long as they are within my time range).\n\nEverything is working _almost_ as expected... except it seems like `extended_bounds` is not respecting the time zone. \n\nMy query returns the UTC \"midnight\" bucket which becomes 7pm (on the previous day) when I adjust for my timezone (CST). I would expect that `extended_bounds` with `time_zone` would return that timezone's midnight.\n\nSo if I were performing a query from `'now/d'` to `'now/d'` in CST (which is GMT-5 currently), I would expect the first bucket to be `'2015-07-15T05:00:00.000Z'` and _not_ `'2015-07-15T00:00:00.000Z'`.\n\nMy question is: Is `extended_bounds` not respecting `time_zone`?\n\nI'm having trouble succinctly describing this in English; hopefully my test case below helps to explain:\n#### Test Case:\n\nIndex a new document with timestamp of 00:00 GMT:\n\n```\ncurl -XPOST \"http://localhost:9200/analytics/event\" -d'\n{\n    \"name\": \"Prince George\",\n   \"event-date\": {\n      \"timestamp\": \"2015-07-15T00:00:00.000Z\"\n   }\n}'\n```\n\nIndex a new document with timestamp of 08:00 GMT:\n\n```\ncurl -XPOST \"http://localhost:9200/analytics/event\" -d'\n{\n    \"name\": \"James Madison\",\n    \"event-date\": {\n        \"timestamp\": \"2015-07-15T08:00:00.000Z\"\n    }\n}'\n```\n\nSearch!\n\n```\ncurl -XPOST \"http://localhost:9200/analytics/event/_search\" -d'\n{\n   \"query\": {\n      \"filtered\": {\n         \"query\": {\n            \"match_all\": {}\n         },\n         \"filter\": {\n            \"bool\": {\n               \"must\": [\n                  {\n                     \"range\": {\n                        \"timestamp\": {\n                           \"from\": \"now/d\",\n                           \"to\": \"now/d\",\n                           \"time_zone\": \"-5:00\",\n                           \"include_lower\": true,\n                           \"include_upper\": true\n                        }\n                     }\n                  }\n               ]\n            }\n         }\n      }\n   },\n   \"aggs\": {\n      \"dateagg\": {\n         \"date_histogram\": {\n            \"field\": \"event-date.timestamp\",\n            \"interval\": \"1h\",\n            \"time_zone\": \"-5:00\",\n            \"min_doc_count\": 0,\n            \"extended_bounds\": {\n               \"min\": \"now/d\",\n               \"max\": \"now/d\"\n            }\n         }\n      }\n   }\n}'\n```\n\n**Result**:\n\n```\n{\n   \"took\": 92,\n   \"timed_out\": false,\n   \"_shards\": {\n      \"total\": 5,\n      \"successful\": 5,\n      \"failed\": 0\n   },\n   \"hits\": {\n      \"total\": 1,\n      \"max_score\": 1,\n      \"hits\": [\n         {\n            \"_index\": \"analytics\",\n            \"_type\": \"event\",\n            \"_id\": \"AU6S1QrhLJ3RT4VnGs-M\",\n            \"_score\": 1,\n            \"_source\": {\n               \"name\": \"James Madison\",\n               \"event-date\": {\n                  \"timestamp\": \"2015-07-15T08:00:00.000Z\"\n               }\n            }\n         }\n      ]\n   },\n   \"aggregations\": {\n      \"dateagg\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"2015-07-15T00:00:00.000Z\",\n               \"key\": 1436918400000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T01:00:00.000Z\",\n               \"key\": 1436922000000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T02:00:00.000Z\",\n               \"key\": 1436925600000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T03:00:00.000Z\",\n               \"key\": 1436929200000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T04:00:00.000Z\",\n               \"key\": 1436932800000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T05:00:00.000Z\",\n               \"key\": 1436936400000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T06:00:00.000Z\",\n               \"key\": 1436940000000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T07:00:00.000Z\",\n               \"key\": 1436943600000,\n               \"doc_count\": 0\n            },\n            {\n               \"key_as_string\": \"2015-07-15T08:00:00.000Z\",\n               \"key\": 1436947200000,\n               \"doc_count\": 1\n            }\n         ]\n      }\n   }\n}\n```\n\nAs you can see, we are getting the expected hits (\"James Madison\"), and the document is in the correct bucket. I would prefer the first bucket to start at the beginning of the day in the timezone I specified in the query (\"-05:00\"), and not at the beginning of the day in UTC.\n\nThanks for your review, and thanks your hard work!\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}