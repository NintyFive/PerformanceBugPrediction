{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/28654","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28654/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28654/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/28654/events","html_url":"https://github.com/elastic/elasticsearch/issues/28654","id":296705849,"node_id":"MDU6SXNzdWUyOTY3MDU4NDk=","number":28654,"title":"array_index_out_of_bounds_exception when indexing polygon with hole","user":{"login":"dandago","id":13241564,"node_id":"MDQ6VXNlcjEzMjQxNTY0","avatar_url":"https://avatars3.githubusercontent.com/u/13241564?v=4","gravatar_id":"","url":"https://api.github.com/users/dandago","html_url":"https://github.com/dandago","followers_url":"https://api.github.com/users/dandago/followers","following_url":"https://api.github.com/users/dandago/following{/other_user}","gists_url":"https://api.github.com/users/dandago/gists{/gist_id}","starred_url":"https://api.github.com/users/dandago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dandago/subscriptions","organizations_url":"https://api.github.com/users/dandago/orgs","repos_url":"https://api.github.com/users/dandago/repos","events_url":"https://api.github.com/users/dandago/events{/privacy}","received_events_url":"https://api.github.com/users/dandago/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-02-13T11:34:43Z","updated_at":"2018-02-15T15:21:30Z","closed_at":"2018-02-15T15:21:30Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.1.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.0_151\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**: I am trying to index a polygon with a hole. Normally this works, but with a particular set of points it keeps failing with the following error:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"mapper_parsing_exception\",\r\n        \"reason\": \"failed to parse [location]\"\r\n      }\r\n    ],\r\n    \"type\": \"mapper_parsing_exception\",\r\n    \"reason\": \"failed to parse [location]\",\r\n    \"caused_by\": {\r\n      \"type\": \"array_index_out_of_bounds_exception\",\r\n      \"reason\": \"-1\"\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nI am using the following mapping:\r\n\r\n```\r\nPUT /regions\r\n{\r\n  \"mappings\": {\r\n    \"region\": {\r\n      \"properties\": {\r\n        \"name\": {\r\n          \"type\": \"string\"\r\n        },\r\n        \"location\": {\r\n          \"type\": \"geo_shape\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAttempting to index this polygon with hole results in the aforementioned error:\r\n\r\n```\r\nPUT /regions/region/overlap7\r\n{\r\n    \"name\" : \"Overlap7\",\r\n    \"location\" : {\r\n        \"type\" : \"polygon\",\r\n        \"coordinates\" : [\r\n            [\r\n                [ -111.92674,33.53625 ],\r\n                [ -112.40224,43.33018 ],\r\n                [ -91.54212,43.35777  ],\r\n                [ -90.41345,32.98592  ],\r\n                [ -111.92674,33.53625 ]\r\n            ],\r\n            [ \r\n                [ -109.07029,31.49836 ],\r\n                [ -108.97451,36.95538 ],\r\n                [ -102.77015,37.161   ],\r\n                [ -103.15759,31.9478  ],\r\n                [ -109.07029,31.49836 ]\r\n            ]\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nI ran the JSON in a validator to confirm that it's fine.\r\n\r\nIndexing the main polygon alone works:\r\n\r\n```\r\nPUT /regions/region/overlap8\r\n{\r\n    \"name\" : \"Overlap8\",\r\n    \"location\" : {\r\n        \"type\" : \"polygon\",\r\n        \"coordinates\" : [\r\n            [\r\n                [ -111.92674,33.53625 ],\r\n                [ -112.40224,43.33018 ],\r\n                [ -91.54212,43.35777  ],\r\n                [ -90.41345,32.98592  ],\r\n                [ -111.92674,33.53625 ]\r\n            ]\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nIndexing the hole alone works:\r\n\r\n```\r\nPUT /regions/region/overlap9\r\n{\r\n    \"name\" : \"Overlap9\",\r\n    \"location\" : {\r\n        \"type\" : \"polygon\",\r\n        \"coordinates\" : [\r\n            [ \r\n                [ -109.07029,31.49836 ],\r\n                [ -108.97451,36.95538 ],\r\n                [ -102.77015,37.161   ],\r\n                [ -103.15759,31.9478  ],\r\n                [ -109.07029,31.49836 ]\r\n            ]\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nIndexing a polygon with hole in a completely different area works:\r\n\r\n```\r\nPUT /regions/region/overlap12\r\n{\r\n    \"name\" : \"Overlap12\",\r\n    \"location\" : {\r\n        \"type\" : \"polygon\", \r\n        \"coordinates\" : [\r\n            [\r\n                [ 141.04445,-28.92704 ],\r\n                [ 141.00841,-33.97411 ],\r\n                [ 149.94544,-37.51381 ],\r\n                [ 150.7789, -34.98252 ],\r\n                [ 152.18365,-32.70393 ],\r\n                [ 153.49901,-28.24141 ],\r\n                [ 148.87874,-28.98426 ],\r\n                [ 141.04445,-28.92704 ]              \r\n            ],\r\n            [ \r\n                [ 149.05898,-35.91185 ],\r\n                [ 149.14473,-35.36119 ],\r\n                [ 149.40076,-35.31932 ],\r\n                [ 149.09984,-35.11429 ],\r\n                [ 149.05898,-35.91185 ]\r\n            ]\r\n        ]\r\n    }\r\n}\r\n```\r\n\r\nI don't see what I'm doing different here from the failing case, so please call out if there's some really tiny mistake that I'm missing.","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}