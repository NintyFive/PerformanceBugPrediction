{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46212","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46212/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46212/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46212/events","html_url":"https://github.com/elastic/elasticsearch/issues/46212","id":487863015,"node_id":"MDU6SXNzdWU0ODc4NjMwMTU=","number":46212,"title":"Heuristically/Optionally use sparse data structures for adjacency matrix aggregation","user":{"login":"flash1293","id":1508364,"node_id":"MDQ6VXNlcjE1MDgzNjQ=","avatar_url":"https://avatars2.githubusercontent.com/u/1508364?v=4","gravatar_id":"","url":"https://api.github.com/users/flash1293","html_url":"https://github.com/flash1293","followers_url":"https://api.github.com/users/flash1293/followers","following_url":"https://api.github.com/users/flash1293/following{/other_user}","gists_url":"https://api.github.com/users/flash1293/gists{/gist_id}","starred_url":"https://api.github.com/users/flash1293/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/flash1293/subscriptions","organizations_url":"https://api.github.com/users/flash1293/orgs","repos_url":"https://api.github.com/users/flash1293/repos","events_url":"https://api.github.com/users/flash1293/events{/privacy}","received_events_url":"https://api.github.com/users/flash1293/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"assignees":[{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-09-01T09:30:34Z","updated_at":"2019-09-04T13:05:47Z","closed_at":"2019-09-04T13:05:47Z","author_association":"NONE","active_lock_reason":null,"body":"## Idea\r\n\r\nThe adjacency matrix aggregation currently has a default limit of 100 filters (`index.max_adjacency_matrix_filters`). This is a sensible value considering the quadratic memory complexity of the operation. For some use cases this is pretty restricting. Of course in these cases it is possible to increase this default level, but the memory pressure quickly becomes unfeasible.\r\n\r\nI talked with Mark Harwood and we came to the conclusion that this limit could probably be increased if sparse data structures were used for storing intermediate results in cases of large matrices (> 100 filters), because the memory usage wouldn't grow as fast as it would with dense data structures. This would probably result in a space/time trade-off, but allow for new use cases.\r\n\r\n## API proposal\r\n\r\nIt's an option to not expose this in the API and apply a heuristic when to use which implementation (e.g. < 100 filters uses dense data structures, > 100 filters uses sparse data structures). The advantage of this is approach is that the user doesn't have to make a decision, but it could result in unexpected performance cliffs.\r\n\r\nAn alternative to that is to add a separate parameter to the request object (e.g. `useSparseMatrix`) to leave the decision to the user. In that case there should be a separate setting, e.g. `index.max_sparse_adjacency_matrix_filters`.\r\n\r\nA cleaner way would be have a completely new aggregation `sparse_adjacency_matrix` to emphasize the distinction even more.\r\n\r\ncc @markharwood","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}