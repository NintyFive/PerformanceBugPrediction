{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7200","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7200/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7200/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7200/events","html_url":"https://github.com/elastic/elasticsearch/issues/7200","id":39808895,"node_id":"MDU6SXNzdWUzOTgwODg5NQ==","number":7200,"title":"Highlight fragment_size doesn't work with particular query_string","user":{"login":"Quentin01","id":1022683,"node_id":"MDQ6VXNlcjEwMjI2ODM=","avatar_url":"https://avatars3.githubusercontent.com/u/1022683?v=4","gravatar_id":"","url":"https://api.github.com/users/Quentin01","html_url":"https://github.com/Quentin01","followers_url":"https://api.github.com/users/Quentin01/followers","following_url":"https://api.github.com/users/Quentin01/following{/other_user}","gists_url":"https://api.github.com/users/Quentin01/gists{/gist_id}","starred_url":"https://api.github.com/users/Quentin01/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Quentin01/subscriptions","organizations_url":"https://api.github.com/users/Quentin01/orgs","repos_url":"https://api.github.com/users/Quentin01/repos","events_url":"https://api.github.com/users/Quentin01/events{/privacy}","received_events_url":"https://api.github.com/users/Quentin01/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2014-08-08T10:05:35Z","updated_at":"2016-11-24T18:54:24Z","closed_at":"2016-11-24T18:54:24Z","author_association":"NONE","active_lock_reason":null,"body":"In my use-case, I have documents indexed in ES with two fields, `metadata.path` and `metadata.text`. The path is just a file path and the text is a big chunk of text which is the content of the file. \n\nSo, I do multiple search on this fields and I have a bug with highlighting. JSON returned by ES contains a highlighted field `metadata.text` which is bigger than `fragment_size`.\n\nI succeed in minimizing the query to show you an example :  \n\n``` bash\ncurl -XPOST 'localhost:9200/company_53e1e4383e808ea8077bcacb/_search?pretty' -d '\n{\n  \"fields\": [],\n  \"query\": {\n    \"query_string\": {\n      \"query\": \"guide astreinte aer\",\n      \"default_operator\": \"AND\"\n    }\n  },\n  \"highlight\": {\n    \"pre_tags\": [\"<span>\"],\n    \"post_tags\": [\"</span>\"],\n    \"encoder\": \"html\",\n    \"fields\": {\n      \"metadata.*\": {\n        \"number_of_fragments\" : 1,\n        \"fragment_size\": 200\n      }\n    }\n  }\n}'\n```\n\nResult : \n\n``` json\n{\n  \"took\" : 11,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 0.57094264,\n    \"hits\" : [ {\n      \"_index\" : \"company_53e1e4383e808ea8077bcacb\",\n      \"_type\" : \"5252ce4ce4cfcd16f55cfa3c\",\n      \"_id\" : \"53e20d353dc80bbf7e8fe5c0-5252ce4ce4cfcd16f55cfa3c\",\n      \"_score\" : 0.57094264,\n      \"highlight\" : {\n        \"metadata.text\" : [ \" sur un événement, <span>l’AER</span> en est responsable et doit s’assurer que tout se déroule correctement aussi bien au niveau ambiance qu’au niveau matériel. 1. La garde ou <span>astreinte</span> <span>L’AER</span> de garde ou <span>d’astreinte</span> est responsable des locaux. Il a pour mission l’accompagnement des étudiants. Il doit passer dans les différentes salles et proposer son accompagnement. Il peut également être sollicité ponctu\nellement par l’équipe pédagogique ou l’administration pour diverses tâches manuelles ou actions précises. Il peut être également responsable de l’ouverture ou de la fermeture de l’école. Se reporter à la documentation pour plus de détails. 2. Les soutenances Les soutenances sont l’occasion pour <span>l’AER</span> d’évaluer les étudiants. Le barème de notation doit être suivit à la lettre. Comme ces barèmes sont parfois un peu flous, une réunion de concertation entre les différents <span>AERs</span> et le responsable du module correspondant est nécessaire au préalable afin d’avoir une notation la plus impartiale possible. Cet événement est l’un de ceux où le suivi de l’étudiant est le plus fort. Ainsi, il est important de faire remonter par email au responsable de module toute remarque constructive concernant des étudiants. 3. Les TPs Les TPs sont le second type d’événement où le suivi de l’étudiant est le plus fort. Pendant un TP, <span>l’AER</span> est debout et circule entre les différents étudiants. Il répond aux différentes questions et doit s’assurer que tous les étudiants travaillent bien. Si un étudiant ne pose pas de questions, c’est à <span>l’AER</span> de lui poser des questions. De même que pour les soutenances, toute remarque constructive à propos d’un étudiant doit être remontée au responsable du module concerné. <span>Guide</span> de <span>l’AER</span> 2014 6 4. Les conférences Il existe trois types de conférences. Comme cet événement fait intervenir des gens externes à Epitech, la documentation doit être suivie encore plus scrupuleusement que pour les autres événements. Exception faite pour les conférences retransmises, un compte-rendu détaillé doit être fait pour chaque conférence. a. Conférences en Amphi Pour les conférences en amphi, deux <span>AERs</span> sont mobilisés : le premier assure l’accueil des visiteurs devant le bâtiment de l’ISEG et les redirige vers l’amphi, une demi-heure avant et une demi-\\nheure après le début de l’événement. Il s’occupe également de la fermeture de la grille de l’ISEG. Le second s’occupe de l’amphi : il veille à ce que tout se déroule correctement en répondant aux besoins de l’intervenant (micros, identifiants WIFI testés au préalable, feutres, clés de l’amphi, tokens pour les étudiant, …). Il s’occupe également de canaliser les étudiants : il les rappelle à l’ordre si ces derniers empê\nchent le bon déroulement de la conférence et ou manquent de respect aux intervenants (ne suivent pas la conférence, font du bruit, …). b. Conférences au Bayard Certaines conférences se déroulent en salle 005. Dans ce cas là, un seul <span>AER</span> est nécessaire. Il doit être présent avant la fermeture du bâtiment et dès l’arrivée des intervenants : il est responsable des locaux et ne doit jamais les laisser sans une surveillance interne à l’équipe d’Epitech. L’accueil s’effectue par la porte arrière du bâtiment (côté rue d’Essling). La clé du bâtiment doit d’ailleurs être récupérée avant la fermeture du Bayard et ramenée le lendemain matin avant 12h00. c. Conférences retransmises Certaines conférences sont retransmises depuis Paris via le live Epitech sur Dailymotion. <span>L’AER</span> doit s’occuper de brancher le PC de conférence au rétroprojecteur et à l’ampli. Il doit s’assurer que la conférence se déroule correctement. D’une manière générale, reportez-vous à la documentation et pensez au compte-rendu. <span>Guide</span> de <span>l’AER</span> 2014 7 5. Web@cadémie La Web@cadémie (W@C) est un partenariat entre Zup de Co. et la région Rhône-Alpes (entre autres). Epitech est missionné pour former en web des étudiants répondant à certains critères. L’intervention des <span>AERs</span> est assez précise : au même titre qu’un TP <span>l’AER</span> doit circuler au milieu des étudiants et les accompagner dans leur démarche. La connaissance technique en technologies web n’est pas obligatoire : de même que pour les étudiants d’Epitech, vous ne devez pas leur apporter une réponse mais les accompagner dans leur réflexion. Il est important de faire signer la feuille d’émergement le matin et l’après-midi par les étudiants et de noter leurs éventuels retards sans exception en plus de leur distribuer les tokens. <span>L’AER</span> responsable de la W@C le vendredi après-midi doit emmener la feuille d’émergement complétée (mention ABS lors d’une absence) auprès de Prisca qui donnera la feuille de la semaine suivante. 6. Les Examens Est considéré comme un examen tout événement où l’étudiant est amené à être évalué par le biais de son ordinateur. La procédure d’examen est stricte et doit être suivie avec impartialité et précision : aucun traitement de faveur ne doit être fait. Pendant l’examen, <span>l’AER</span> circule entre les rangs en surveillant les écrans des étudiants afin d’empêcher la triche. En plus des règles de base des salles machines, les règles d’examens s’appliquent. Toute suspicion de triche doit être reportée au responsable du module correspondant immédiatement si possible ou par email à la fin de l’examen. Aucun bruit n’est toléré pendant l’examen. Si un portable sonne, la rangée entière doit sortir de la salle. Les étudiants peuvent sortir à partir des 2&#x2F;3 du temps en laissant son pc sur place jusqu’à la fin de l’examen (une fois l’heure de fin dépassée et le dernier étudiant sorti). 7. La réunion <span>AER</span> hebdomadaire La réunion <span>AER</span> hebdomadaire est planifiée de manière récurrente chaque semaine. La présence de chaque <span>AER</span> est indispensable. Elle permet l’organisation et la cohésion du groupe. C’est également pendant cette réunion qu’une réelle communication a lieu entre l’équipe pédagogique et les <span>AERs</span> : c’est l’occasion de faire remonter tout ce qui nous semble important aussi bien sur le point pédagogique que matériel ou bien même humain. <span>Guide</span> de <span>l’AER</span> 2014 8 III. Interlocuteurs Tout au long de la mission de <span>l’AER</span>, ce dernier traite avec plusieurs interlocuteurs différents. Les principaux sont l’équipe pédagogique dans laquelle un ou plusieurs référents seront désignés (responsable des <span>AERs</span>). Il est important de bien vérifier que l’ont s’adresse à la bonne personne lors d’un contact : tout le monde gagne du temps.  Pour une question concernant le travail de <span>l’AER</span> ou une précision à ce propos, le référent <span>AER</span> de l’équipe pédagogique est l’interlocuteur privilégié.  Pour une question à propos d’un module, d’un cours, d’une soutenance ou d’un TP, le bon interlocuteur est le responsable du module (vérifier sur l’intra).  Pour une question d’ordre administratif (informations sur la sécurité sociale, sur la scolarité, …), se référer à l’administration Il se peut que la question ne vous concerne pas mais émane d’un étudiant. Dans ce cas là, <span>l’AER</span> doit rediriger l’étudiant vers le bon int\nerlocuteur : il ne doit pas se renseigner pour lui. Pour l’aspect technique, il se peut que <span>l’AER</span> doive traiter avec le bocal par téléphone. Dans ce cas, il faut bien penser à se présenter (Nom, Lab <span>AER</span> Epitech Lyon). (Numéro 0140 depuis un poste de l’école). Lors d’un incident grave (feu, vol, présence d’un individu agressif dans les locaux, …), il faut impérativement se mettre en sécurité avec si possible les étudiants présents et contacter d’u\nrgence des secours (police, pompiers, SAMU, …) et le responsable des <span>AERs</span> sur son téléphone personnel s’il n’est pas présent. D’une manière générale, la documentation indique les numéros des principaux interlocuteurs. S’y rep\norter pour davantage d’informations. <span>Guide</span> de <span>l’AER</span> 2014 9 IV. En conclusion D’une manière générale :  <span>L’AER</span> est au service de l’équipe d’Epitech  Il doit être actif et présent  Il accompagne les \nétudiants  Il fait du reporting (faire remonter tout élément important aux responsables supérieurs)  Il est impartial et n’abuse pas de sa position.  Il donne l’exemple : il est irréprochable et propre  Les événements de <span>l’AER</\nspan> ne sont pas le moment pour travailler sur ses projets persos  Il se reporte à la documentation pour être sûr d’agir comme il faut  Si la documentation ne le renseigne pas, il se reporte au responsable des <span>AERs</span>. Légend\ne Urbaine \" ],\n        \"metadata.path\" : [ \"&#x2F;{Epitech.} - Lyon <span>AER</span>&#x2F;Procedures - Reglements&#x2F;Guide_<span>AER</span>.PDF\" ]\n      }\n    } ]\n  }\n}\n```\n\nTo prove that the problem isn't the doc, I have tried with a match_phrase, the same query string and the same highlight : \n\n``` bash\ncurl -XPOST 'localhost:9200/company_53e1e4383e808ea8077bcacb/_search?pretty' -d '\n{\n  \"fields\": [],\n  \"query\": {\n    \"match_phrase\": {\n      \"_all\": {\n        \"query\": \"guide astreinte aer\",\n        \"slop\": 50,\n        \"analyzer\": \"query\"\n      }\n    }\n  },\n  \"highlight\": {\n    \"pre_tags\": [\"<span>\"],\n    \"post_tags\": [\"</span>\"],\n    \"encoder\": \"html\",\n    \"fields\": {\n      \"metadata.*\": {\n        \"number_of_fragments\" : 1,\n        \"fragment_size\": 200\n      }\n    }\n  }\n}'\n```\n\nResult : \n\n``` json\n{\n  \"took\" : 12,\n  \"timed_out\" : false,\n  \"_shards\" : {\n    \"total\" : 5,\n    \"successful\" : 5,\n    \"failed\" : 0\n  },\n  \"hits\" : {\n    \"total\" : 1,\n    \"max_score\" : 0.109629005,\n    \"hits\" : [ {\n      \"_index\" : \"company_53e1e4383e808ea8077bcacb\",\n      \"_type\" : \"5252ce4ce4cfcd16f55cfa3c\",\n      \"_id\" : \"53e20d353dc80bbf7e8fe5c0-5252ce4ce4cfcd16f55cfa3c\",\n      \"_score\" : 0.109629005,\n      \"highlight\" : {\n        \"metadata.text\" : [ \" des révisions Date Auteur Sections Commentaire 02&#x2F;07&#x2F;2014 Mathieu Ville -\\nville_m Toutes Première révision <span>Guide</span> de <span>l’AER</span> 2014 3 Sommaire I. Introduction\" ]\n      }\n    } ]\n  }\n}\n```\n\nDo you have clues about this bug ? I will try to reproduce the bug in a complete shell script but it's hard.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}