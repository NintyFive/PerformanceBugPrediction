{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/50961","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50961/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50961/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/50961/events","html_url":"https://github.com/elastic/elasticsearch/issues/50961","id":549460031,"node_id":"MDU6SXNzdWU1NDk0NjAwMzE=","number":50961,"title":"Time range with time zone zero hour problem (00:00 - 00:59)","user":{"login":"howtwizer","id":2534629,"node_id":"MDQ6VXNlcjI1MzQ2Mjk=","avatar_url":"https://avatars1.githubusercontent.com/u/2534629?v=4","gravatar_id":"","url":"https://api.github.com/users/howtwizer","html_url":"https://github.com/howtwizer","followers_url":"https://api.github.com/users/howtwizer/followers","following_url":"https://api.github.com/users/howtwizer/following{/other_user}","gists_url":"https://api.github.com/users/howtwizer/gists{/gist_id}","starred_url":"https://api.github.com/users/howtwizer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/howtwizer/subscriptions","organizations_url":"https://api.github.com/users/howtwizer/orgs","repos_url":"https://api.github.com/users/howtwizer/repos","events_url":"https://api.github.com/users/howtwizer/events{/privacy}","received_events_url":"https://api.github.com/users/howtwizer/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-01-14T10:08:10Z","updated_at":"2020-01-15T09:02:19Z","closed_at":"2020-01-15T09:02:18Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.5.1\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): cloud.elastic.co AWS\r\n\r\n**Description of the problem including expected versus actual behavior**: \r\nProblem: No results when searching by range time fields with timezone \"+01:00\" provided in current day from  00:00 to 00:59.\r\nExpected: Show results from previous day for time range 23:00 - 23:59\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. Index create and add example docs\r\n```\r\nPUT test_event\r\n{\r\n  \"mappings\": {\r\n    \"properties\": {\r\n      \"time\": {\r\n        \"type\": \"date\",\r\n        \"format\": \"HH:mm:ss\"\r\n      },\r\n      \"@timestamp\": {\r\n        \"type\": \"date\"\r\n      }\r\n    }\r\n  }\r\n}\r\nPOST test_event/_doc\r\n{\r\n  \"time\" : \"23:14:59\",\r\n  \"@timestamp\" : \"2020-01-12T23:14:59.000+00:00\"\r\n}\r\nPOST test_event/_doc\r\n{\r\n  \"time\" : \"23:29:59\",\r\n  \"@timestamp\" : \"2020-01-12T23:29:59.000+00:00\"\r\n}\r\nPOST test_event/_doc\r\n{\r\n  \"time\" : \"23:59:59\",\r\n  \"@timestamp\" : \"2020-01-12T23:59:59.000+00:00\"\r\n}\r\nPOST test_event/_doc\r\n{\r\n  \"time\" : \"00:14:59\",\r\n  \"@timestamp\" : \"2020-01-13T00:14:59.000+00:00\"\r\n}\r\nPOST test_event/_doc\r\n{\r\n  \"time\" : \"00:29:59\",\r\n  \"@timestamp\" : \"2020-01-13T00:29:59.000+00:00\"\r\n}\r\nPOST test_event/_doc\r\n{\r\n  \"time\" : \"00:59:59\",\r\n  \"@timestamp\" : \"2020-01-13T00:59:59.000+00:00\"\r\n}\r\n```\r\n 2. Expected search, search all events at 2020-01-13 in range \"time\" 00:00 - 00:59\r\n```\r\nGET test_event/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"range\": {\r\n            \"time\": {\r\n              \"gte\": \"00:00:00\",\r\n              \"lte\": \"00:59:59\",\r\n              \"time_zone\": \"+01:00\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gt\": \"2020-01-13T00:00\",\r\n              \"lte\": \"2020-01-13T23:59\",\r\n              \"time_zone\": \"+01:00\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\nResponse: \r\n```\r\n{\r\n  \"took\" : 0,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 0,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : null,\r\n    \"hits\" : [ ]\r\n  }\r\n}\r\n```\r\n\r\n 3. Note that If day range removed - has events from previous day\r\n```\r\nGET test_event/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gt\": \"2020-01-13T00:00\",\r\n              \"lte\": \"2020-01-13T23:59\",\r\n              \"time_zone\": \"+01:00\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\nResponse:\r\n```\r\n{\r\n  \"took\" : 0,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 6,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"TEJLo28BQyfPd-V3olHU\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"time\" : \"23:14:59\",\r\n          \"@timestamp\" : \"2020-01-12T23:14:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"WL5Lo28BeFtx-Ggpo1Vk\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"time\" : \"23:29:59\",\r\n          \"@timestamp\" : \"2020-01-12T23:29:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"Wb5Lo28BeFtx-Ggpo1Xo\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"time\" : \"23:59:59\",\r\n          \"@timestamp\" : \"2020-01-12T23:59:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"Wr5Lo28BeFtx-GgppFVk\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"time\" : \"00:14:59\",\r\n          \"@timestamp\" : \"2020-01-13T00:14:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"W75Lo28BeFtx-GgppFXC\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"time\" : \"00:29:59\",\r\n          \"@timestamp\" : \"2020-01-13T00:29:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"XL5Lo28BeFtx-GgppVU0\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"time\" : \"00:59:59\",\r\n          \"@timestamp\" : \"2020-01-13T00:59:59.000+00:00\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n4. Note 2 - if remove timezone from time, and move values to an hour back, we will also will get result (as expected for 00:00 +01:00)\r\n```\r\nGET test_event/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"range\": {\r\n            \"time\": {\r\n              \"gte\": \"23:00:00\",\r\n              \"lte\": \"23:59:59\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gt\": \"2020-01-13T00:00\",\r\n              \"lte\": \"2020-01-13T23:59\",\r\n              \"time_zone\": \"+01:00\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\nResponse:\r\n```\r\n{\r\n  \"took\" : 0,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 3,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 2.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"TEJLo28BQyfPd-V3olHU\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"time\" : \"23:14:59\",\r\n          \"@timestamp\" : \"2020-01-12T23:14:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"WL5Lo28BeFtx-Ggpo1Vk\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"time\" : \"23:29:59\",\r\n          \"@timestamp\" : \"2020-01-12T23:29:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"Wb5Lo28BeFtx-Ggpo1Xo\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"time\" : \"23:59:59\",\r\n          \"@timestamp\" : \"2020-01-12T23:59:59.000+00:00\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n5. Note: Query for time 01:00 - 01:59 with timezone +01:00 works as expected. \r\n```\r\nGET test_event/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [\r\n        {\r\n          \"range\": {\r\n            \"time\": {\r\n              \"gte\": \"01:00:00\",\r\n              \"lte\": \"01:59:59\",\r\n              \"time_zone\": \"+01:00\"\r\n            }\r\n          }\r\n        },\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gt\": \"2020-01-13T00:00\",\r\n              \"lte\": \"2020-01-13T23:59\",\r\n              \"time_zone\": \"+01:00\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n```\r\nResponse: \r\n```\r\n{\r\n  \"took\" : 1,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 3,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 2.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"Wr5Lo28BeFtx-GgppFVk\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"time\" : \"00:14:59\",\r\n          \"@timestamp\" : \"2020-01-13T00:14:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"W75Lo28BeFtx-GgppFXC\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"time\" : \"00:29:59\",\r\n          \"@timestamp\" : \"2020-01-13T00:29:59.000+00:00\"\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"test_event\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"XL5Lo28BeFtx-GgppVU0\",\r\n        \"_score\" : 2.0,\r\n        \"_source\" : {\r\n          \"time\" : \"00:59:59\",\r\n          \"@timestamp\" : \"2020-01-13T00:59:59.000+00:00\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"howtwizer","id":2534629,"node_id":"MDQ6VXNlcjI1MzQ2Mjk=","avatar_url":"https://avatars1.githubusercontent.com/u/2534629?v=4","gravatar_id":"","url":"https://api.github.com/users/howtwizer","html_url":"https://github.com/howtwizer","followers_url":"https://api.github.com/users/howtwizer/followers","following_url":"https://api.github.com/users/howtwizer/following{/other_user}","gists_url":"https://api.github.com/users/howtwizer/gists{/gist_id}","starred_url":"https://api.github.com/users/howtwizer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/howtwizer/subscriptions","organizations_url":"https://api.github.com/users/howtwizer/orgs","repos_url":"https://api.github.com/users/howtwizer/repos","events_url":"https://api.github.com/users/howtwizer/events{/privacy}","received_events_url":"https://api.github.com/users/howtwizer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}