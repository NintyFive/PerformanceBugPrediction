[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/205735338","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-205735338","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":205735338,"node_id":"MDEyOklzc3VlQ29tbWVudDIwNTczNTMzOA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-04-05T09:55:12Z","updated_at":"2016-04-05T09:55:12Z","author_association":"NONE","body":"By the way, my Elasticsearch config:\n\n``` yaml\nscript.inline: on\n```\n\nAnd my java policy file:\n\n```\ngrant {\n    permission org.elasticsearch.script.ClassPermission \"*\"; // allow all (disables filtering basically)\n};\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/205735712","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-205735712","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":205735712,"node_id":"MDEyOklzc3VlQ29tbWVudDIwNTczNTcxMg==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-04-05T09:56:44Z","updated_at":"2016-04-05T09:56:44Z","author_association":"NONE","body":"I can \"fix\" the issue with `security.manager.enabled: false` in my Elasticsearch config, but it's deprecated....\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/206309155","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-206309155","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":206309155,"node_id":"MDEyOklzc3VlQ29tbWVudDIwNjMwOTE1NQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-04-06T10:56:39Z","updated_at":"2016-04-06T10:56:39Z","author_association":"CONTRIBUTOR","body":"@nknize can you suggest anything?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215057398","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215057398","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215057398,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTA1NzM5OA==","user":{"login":"spideyfusion","id":704579,"node_id":"MDQ6VXNlcjcwNDU3OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/704579?v=4","gravatar_id":"","url":"https://api.github.com/users/spideyfusion","html_url":"https://github.com/spideyfusion","followers_url":"https://api.github.com/users/spideyfusion/followers","following_url":"https://api.github.com/users/spideyfusion/following{/other_user}","gists_url":"https://api.github.com/users/spideyfusion/gists{/gist_id}","starred_url":"https://api.github.com/users/spideyfusion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spideyfusion/subscriptions","organizations_url":"https://api.github.com/users/spideyfusion/orgs","repos_url":"https://api.github.com/users/spideyfusion/repos","events_url":"https://api.github.com/users/spideyfusion/events{/privacy}","received_events_url":"https://api.github.com/users/spideyfusion/received_events","type":"User","site_admin":false},"created_at":"2016-04-27T11:42:11Z","updated_at":"2016-04-27T11:42:11Z","author_association":"NONE","body":"Can we get some more feedback regarding this? I'm running into the exact same issue. As @pierrre mentioned everything works fine on version **2.2**.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215085561","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215085561","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215085561,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTA4NTU2MQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-04-27T13:38:52Z","updated_at":"2016-04-27T13:38:52Z","author_association":"CONTRIBUTOR","body":"Sorry for the delay @spideyfusion and @pierrre. I'll dig today and see what, if any, security manager changes might have caused this. Its unrelated to any of the geo changes.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215513289","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215513289","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215513289,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTUxMzI4OQ==","user":{"login":"coldlamper","id":876528,"node_id":"MDQ6VXNlcjg3NjUyOA==","avatar_url":"https://avatars0.githubusercontent.com/u/876528?v=4","gravatar_id":"","url":"https://api.github.com/users/coldlamper","html_url":"https://github.com/coldlamper","followers_url":"https://api.github.com/users/coldlamper/followers","following_url":"https://api.github.com/users/coldlamper/following{/other_user}","gists_url":"https://api.github.com/users/coldlamper/gists{/gist_id}","starred_url":"https://api.github.com/users/coldlamper/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/coldlamper/subscriptions","organizations_url":"https://api.github.com/users/coldlamper/orgs","repos_url":"https://api.github.com/users/coldlamper/repos","events_url":"https://api.github.com/users/coldlamper/events{/privacy}","received_events_url":"https://api.github.com/users/coldlamper/received_events","type":"User","site_admin":false},"created_at":"2016-04-28T18:06:42Z","updated_at":"2016-04-28T18:06:42Z","author_association":"NONE","body":"I have the same problem after upgrading to 2.3.2 from 2.2.1.\n\n``` javascript\n{\"took\":543,\"timed_out\":false,\"_shards\":\n{\"total\":5,\"successful\":0,\"failed\":5,\"failures\":     [{\"shard\":0,\"index\":\"1457361018254\",\"node\":\"T8SYOug2RemSSDCLclwGog\",\"reason\":{\n\"type\":\"script_exception\",\n\"reason\":\"failed to run file script [closest_listing] using lang [groovy]\",\n\"caused_by\":{\"type\":\"groovy_bug_error\",\n\"reason\":\"BUG! UNCAUGHT EXCEPTION: class is not public: org.elasticsearch.common.geo.GeoDistance$3.calculate(double,double,double,double,DistanceUnit)double/invokeSpecial, from org.codehaus.groovy.vmplugin.v7.IndyInterface\",\"caused_by\":{\n\"type\":\"illegal_access_exception\",\n\"reason\":\"class is not public: org.elasticsearch.common.geo.GeoDistance$3.calculate(double,double,double,double,DistanceUnit)double/invokeSpecial, from org.codehaus.groovy.vmplugin.v7.IndyInterface\"}}}}]},\"hits\":{\"total\":4443,\"max_score\":6.40699,\"hits\":[]}}\n```\n\nMy policy file looks like\n\n```\ngrant {\n    permission org.elasticsearch.script.ClassPermission \"*\"; // allow all (disables filtering basically)\n};\n```\n\nMaybe this helps. If I change the policy file to \n\n```\ngrant {\n      permission java.security.AllPermission;    \n};\n```\n\nthen everything works.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215590155","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215590155","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215590155,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTU5MDE1NQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2016-04-28T23:16:59Z","updated_at":"2016-04-28T23:16:59Z","author_association":"MEMBER","body":"The problem here is a combination of groovy craziness with the GeoDistance class and how java handles enums.  Each enum value is a pkg protected anonymous class. Due to how groovy handles grabbing stuff when loading, it tries to get at this class, and that is where the error comes from.  In order to fix this, the GeoDistance class needs to not be so crazy. We shouldn't be doing crazy things like this with an enum. /cc @nknize \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215699863","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215699863","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215699863,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTY5OTg2Mw==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-04-29T12:37:40Z","updated_at":"2016-04-29T12:37:40Z","author_association":"NONE","body":"I confirm, it works with:\n\n```\ngrant {\n      permission java.security.AllPermission;    \n};\n```\n\nin java policy file and without modifying `security.manager.enabled`.\n\nThank you @coldlamper :+1: \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215735163","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215735163","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215735163,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTczNTE2Mw==","user":{"login":"spideyfusion","id":704579,"node_id":"MDQ6VXNlcjcwNDU3OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/704579?v=4","gravatar_id":"","url":"https://api.github.com/users/spideyfusion","html_url":"https://github.com/spideyfusion","followers_url":"https://api.github.com/users/spideyfusion/followers","following_url":"https://api.github.com/users/spideyfusion/following{/other_user}","gists_url":"https://api.github.com/users/spideyfusion/gists{/gist_id}","starred_url":"https://api.github.com/users/spideyfusion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spideyfusion/subscriptions","organizations_url":"https://api.github.com/users/spideyfusion/orgs","repos_url":"https://api.github.com/users/spideyfusion/repos","events_url":"https://api.github.com/users/spideyfusion/events{/privacy}","received_events_url":"https://api.github.com/users/spideyfusion/received_events","type":"User","site_admin":false},"created_at":"2016-04-29T14:27:40Z","updated_at":"2016-04-29T14:27:40Z","author_association":"NONE","body":"@coldlamper @pierrre Loosening the security policy like that is definitely something I wouldn't even consider doing in a production environment.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215739043","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215739043","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215739043,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTczOTA0Mw==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-04-29T14:38:21Z","updated_at":"2016-04-29T14:38:21Z","author_association":"NONE","body":"@spideyfusion I understand, but:\n- my Elasticsearch server is not publicly available (ports 9200/9300 are not open)\n- I don't run untrusted scripts\n\nIs there a security issue that I don't see?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215741899","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215741899","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215741899,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTc0MTg5OQ==","user":{"login":"spideyfusion","id":704579,"node_id":"MDQ6VXNlcjcwNDU3OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/704579?v=4","gravatar_id":"","url":"https://api.github.com/users/spideyfusion","html_url":"https://github.com/spideyfusion","followers_url":"https://api.github.com/users/spideyfusion/followers","following_url":"https://api.github.com/users/spideyfusion/following{/other_user}","gists_url":"https://api.github.com/users/spideyfusion/gists{/gist_id}","starred_url":"https://api.github.com/users/spideyfusion/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spideyfusion/subscriptions","organizations_url":"https://api.github.com/users/spideyfusion/orgs","repos_url":"https://api.github.com/users/spideyfusion/repos","events_url":"https://api.github.com/users/spideyfusion/events{/privacy}","received_events_url":"https://api.github.com/users/spideyfusion/received_events","type":"User","site_admin":false},"created_at":"2016-04-29T14:48:39Z","updated_at":"2016-04-29T14:48:39Z","author_association":"NONE","body":"@pierrre You're basically crippling the security manager this way:\n\nhttps://docs.oracle.com/javase/8/docs/technotes/guides/security/permissions.html#AllPermission\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/215743833","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215743833","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":215743833,"node_id":"MDEyOklzc3VlQ29tbWVudDIxNTc0MzgzMw==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-04-29T14:54:44Z","updated_at":"2016-04-29T14:54:44Z","author_association":"NONE","body":"@spideyfusion \n\n```\nThis permission should be used only during testing, \nin extremely rare cases where an application or applet is completely trusted\nand adding the necessary permissions to the policy is prohibitively cumbersome.\n```\n- `where an application or applet is completely trusted` I \"trust\" Elasticsearch, and I don't run unstrusted scripts in my queries\n- `adding the necessary permissions to the policy is prohibitively cumbersome` I just want to use the `GeoDistance` class. Do you know a safer way to use it?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/219265151","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-219265151","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":219265151,"node_id":"MDEyOklzc3VlQ29tbWVudDIxOTI2NTE1MQ==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2016-05-15T04:05:00Z","updated_at":"2016-05-15T04:05:00Z","author_association":"MEMBER","body":"@pierrre Have you tried using the distance methods available for fields?\n\n```\n{\n  \"script_fields\": {\n    \"test\": {\n      \"script\": \"doc['mygeofield'].arcDistance(someLat, someLon)\"\n    }\n  }\n}\n```\n\nHowever, as I alluded to in my previous comment here, this is a \"bug\" in that something about the craziness of how GeoDistance is implemented causes this problem. Pinging @nknize one more time to look into refactoring so it doesn't try to be so fancy, but I've also marked this as adoptme.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/220258710","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-220258710","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":220258710,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMDI1ODcxMA==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-05-19T08:22:37Z","updated_at":"2016-05-19T08:22:37Z","author_association":"NONE","body":"@rjernst I can't use `arcDistance()` because I have several geopoints in my document, and I want to sort/extract data with these geopoints.\n\nMy mapping looks like this (PHP representation of my JSON):\n\n``` php\n        return [\n            'title' => [\n                'type' => 'string',\n                'analyzer' => 'plyce_french',\n            ],\n            'priority' => [\n                'type' => 'integer',\n            ],\n            'stores' => [\n                'type' => 'nested',\n                'include_in_parent' => true,\n                'properties' => [\n                    'id' => [\n                        'type' => 'string',\n                        'index' => 'not_analyzed',\n                    ],\n                    'location' => [\n                        'type' => 'geo_point',\n                    ]\n                ],\n            ],\n        ];\n```\n\nMy sort script:\n\n``` php\n        $script = <<<'EOT'\nimport org.elasticsearch.common.unit.DistanceUnit;\nimport org.elasticsearch.common.geo.GeoDistance;\ndistanceMin = null;\nfor (storeLocation in doc[\"stores.location\"].values) {\n    distance = GeoDistance.ARC.calculate(location.lat, location.lon, storeLocation.lat, storeLocation.lon, DistanceUnit.METERS);\n    if (distanceMin == null || distance < distanceMin) {\n        distanceMin = distance;\n    }\n}\nif (distanceMin == null) {\n    distanceMin = 1000000000;\n}\nprioritySort = pow(2, doc.priority.value);\nreturn distanceMin / (_score * prioritySort);\nEOT;\n        return [\n            [\n                '_script' => [\n                    'script' => $script,\n                    'type' => 'number',\n                    'params' => [\n                        'location' => $this->getParamLocation($params)->toArray(true),\n                    ],\n                    'order' => 'asc',\n                ],\n            ],\n            '_uid', // stable sort\n        ];\n```\n\nI could use `arcDistance()` if I was able to iterate over stored values instead of the document's values.\n\nAnd my script field:\n\n``` php\n        $script = <<<'EOT'\nimport org.elasticsearch.common.unit.DistanceUnit;\nimport org.elasticsearch.common.geo.GeoDistance;\nnearestStore = null;\ndistanceMin = null;\nfor (store in _source.stores) {\n    distance = GeoDistance.ARC.calculate(location.latitude, location.longitude, store.location.lat, store.location.lon, DistanceUnit.METERS);\n    if (distanceMin == null || distance < distanceMin) {\n        distanceMin = distance;\n        nearestStore = store.id;\n    }\n}\nreturn nearestStore;\nEOT;\n        return [\n            'script' => $script,\n            'params' => [\n                'location' => $this->getParamLocation($params)->toArray(),\n            ],\n        ];\n```\n\nThis script is very ugly, because it uses the (inefficient) `_source`.\nBut it's actually very fast, because it's only called to process a script field.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/220309316","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-220309316","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":220309316,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMDMwOTMxNg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-05-19T12:27:19Z","updated_at":"2016-05-19T12:27:19Z","author_association":"CONTRIBUTOR","body":"@pierrre You know that we provide this functionality for you out of the box?\n\n```\nPUT t \n{\n  \"mappings\": {\n    \"t\": {\n      \"properties\": {\n        \"location\": {\n          \"type\": \"geo_point\"\n        }\n      }\n    }\n  }\n}\n\nPUT t/t/1\n{\n  \"location\": [\n    {\n      \"lat\": 0,\n      \"lon\": 0\n    },\n    {\n      \"lat\": 1,\n      \"lon\": 0\n    },\n    {\n      \"lat\": 2,\n      \"lon\": 0\n    },\n    {\n      \"lat\": 3,\n      \"lon\": 0\n    }\n  ]\n}\n\nGET _search\n{\n  \"sort\": [\n    {\n      \"_geo_distance\": {\n        \"location\": {\n          \"lat\": 0,\n          \"lon\": 1\n        },\n        \"order\": \"asc\",\n        \"unit\": \"km\",\n        \"mode\": \"min\",\n        \"distance_type\": \"sloppy_arc\"\n      }\n    }\n  ]\n}\n```\n\nThe distance which you're calculating in your script field is available to you in the `sort` parameter.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/220310479","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-220310479","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":220310479,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMDMxMDQ3OQ==","user":{"login":"pierrre","id":131535,"node_id":"MDQ6VXNlcjEzMTUzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/131535?v=4","gravatar_id":"","url":"https://api.github.com/users/pierrre","html_url":"https://github.com/pierrre","followers_url":"https://api.github.com/users/pierrre/followers","following_url":"https://api.github.com/users/pierrre/following{/other_user}","gists_url":"https://api.github.com/users/pierrre/gists{/gist_id}","starred_url":"https://api.github.com/users/pierrre/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pierrre/subscriptions","organizations_url":"https://api.github.com/users/pierrre/orgs","repos_url":"https://api.github.com/users/pierrre/repos","events_url":"https://api.github.com/users/pierrre/events{/privacy}","received_events_url":"https://api.github.com/users/pierrre/received_events","type":"User","site_admin":false},"created_at":"2016-05-19T12:32:29Z","updated_at":"2016-05-19T12:32:29Z","author_association":"NONE","body":"@clintongormley yes I know.\nBut I don't sort by distance.\nI use a combination of: \"minimum distance\", \"_score\" and \"priority\"\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/226035324","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-226035324","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":226035324,"node_id":"MDEyOklzc3VlQ29tbWVudDIyNjAzNTMyNA==","user":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"created_at":"2016-06-14T22:27:48Z","updated_at":"2016-06-14T22:27:48Z","author_association":"MEMBER","body":"@pierrre You can use `org.apache.lucene.util.SloppyMath.haversinMeters` (that is what GeoDistance.ARC uses).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231705756","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-231705756","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":231705756,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTcwNTc1Ng==","user":{"login":"HypeMC","id":2445045,"node_id":"MDQ6VXNlcjI0NDUwNDU=","avatar_url":"https://avatars2.githubusercontent.com/u/2445045?v=4","gravatar_id":"","url":"https://api.github.com/users/HypeMC","html_url":"https://github.com/HypeMC","followers_url":"https://api.github.com/users/HypeMC/followers","following_url":"https://api.github.com/users/HypeMC/following{/other_user}","gists_url":"https://api.github.com/users/HypeMC/gists{/gist_id}","starred_url":"https://api.github.com/users/HypeMC/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HypeMC/subscriptions","organizations_url":"https://api.github.com/users/HypeMC/orgs","repos_url":"https://api.github.com/users/HypeMC/repos","events_url":"https://api.github.com/users/HypeMC/events{/privacy}","received_events_url":"https://api.github.com/users/HypeMC/received_events","type":"User","site_admin":false},"created_at":"2016-07-11T11:08:33Z","updated_at":"2016-07-11T11:18:40Z","author_association":"NONE","body":"@rjernst Have you actually tried if this works? I tried it & got the following error:\n`No signature of method: static org.apache.lucene.util.SloppyMath.haversinMeters() is applicable for argument types: (java.lang.Double, java.lang.Double, java.lang.Double, java.lang.Double)`.\n\nWhen I listed the available methods of the class (using `getMethods()`) I only got `haversin(double, double, double, double)`. As far as I can tell this is cause [Lucene 5](https://lucene.apache.org/core/5_0_0/core/org/apache/lucene/util/SloppyMath.html#haversin%28double, double, double, double%29) is being used while the method you mentioned is in [Lucene 6](https://lucene.apache.org/core/6_0_0/core/org/apache/lucene/util/SloppyMath.html#haversinMeters-double-double-double-double-).\n\nSo, I'm I doing something wrong here? Did `haversinMeters()` work for you? However, `haversin()` seems to work, so that's a plus.\n\nI'm using Elasticsearch v2.3.4.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231746918","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-231746918","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":231746918,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTc0NjkxOA==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-07-11T14:14:46Z","updated_at":"2016-07-11T14:14:46Z","author_association":"CONTRIBUTOR","body":"> I'm using Elasticsearch v2.3.4.\n\nThen, yes, you need to use `SloppyMath.haversin()`\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234237572","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-234237572","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":234237572,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDIzNzU3Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-21T12:22:36Z","updated_at":"2016-07-21T12:22:36Z","author_association":"CONTRIBUTOR","body":"@nknize did you see @rjernst 's comment about the problem with using enums in the GeoDistance class?  https://github.com/elastic/elasticsearch/issues/17506#issuecomment-215590155\n\nWhat about adding distance methods to GeoPoints to make it easier to calculate distances on the GeoPoints returned by `doc['loc'].values`, or perhaps `doc['loc'].values` should return a wrapped GeoPoint with the extra functionality?  (no idea of the consequences here, just suggesting things)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234645019","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-234645019","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":234645019,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDY0NTAxOQ==","user":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T20:15:41Z","updated_at":"2016-07-22T20:15:41Z","author_association":"CONTRIBUTOR","body":"@clintongormley I did see the comment. Since we've deprecated `SloppyArc` and fixed up haversine in Lucene, I'd actually like to remove the `GeoDistance` class altogether. I like the idea of wrapping the GeoPoint with the extra functionality but I'll need to have a look at the side effects.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/387751925","html_url":"https://github.com/elastic/elasticsearch/issues/17506#issuecomment-387751925","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17506","id":387751925,"node_id":"MDEyOklzc3VlQ29tbWVudDM4Nzc1MTkyNQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2018-05-09T14:11:08Z","updated_at":"2018-05-09T14:11:08Z","author_association":"MEMBER","body":"I have discussed this issue with @jdconrad. It looks like the most optimal way to deal with this issue is to address it as part of #24946. So, I am going to close it.\r\n\r\nSuperseded by #24946","performed_via_github_app":null}]