{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5049","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5049/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5049/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5049/events","html_url":"https://github.com/elastic/elasticsearch/issues/5049","id":27147323,"node_id":"MDU6SXNzdWUyNzE0NzMyMw==","number":5049,"title":"AssertionError during percolation using constant score query","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":77772642,"node_id":"MDU6TGFiZWw3Nzc3MjY0Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.12","name":"v0.90.12","color":"DDDDDD","default":false,"description":null},{"id":74899026,"node_id":"MDU6TGFiZWw3NDg5OTAyNg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.0","name":"v1.0.0","color":"dddddd","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"assignees":[{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false}],"milestone":null,"comments":0,"created_at":"2014-02-07T16:15:14Z","updated_at":"2014-02-10T21:25:20Z","closed_at":"2014-02-10T17:15:32Z","author_association":"MEMBER","active_lock_reason":null,"body":"When elasticsearch is running with assertions enabled, a constant score query that doesn't match a record can cause AssertionError to be thrown. To reproduce start elasticsearch with assertions enabled and execute the following script\n\non 0.90 branch:\n\n```\ncurl -XDELETE localhost:9200/test-idx\ncurl -XPUT 'localhost:9200/test-idx/'\ncurl -XPUT 'localhost:9200/_percolator/test-idx/1' -d '{\n    \"query\" : {\n        \"constant_score\":{\n            \"filter\": {\n                \"and\": [{\n                    \"query\": {\n                        \"query_string\" : {\n                            \"query\" : \"root\"\n                        }\n                    }\n                }, {\n                    \"term\" : {\n                        \"message\" : \"tree\"\n                    }\n                }]\n            }\n        }\n    }\n}'\ncurl -XGET 'localhost:9200/test-idx/message/_percolate' -d '{\n    \"doc\" : {\n        \"message\" : \"A new bonsai tree in the office\"\n    }\n}'\n```\n\nto reproduce on master:\n\n```\ncurl -XDELETE localhost:9200/test-idx\ncurl -XPUT 'localhost:9200/test-idx/.percolator/1' -d '{\n    \"query\" : {\n        \"constant_score\":{\n            \"filter\": {\n                \"and\": [{\n                    \"query\": {\n                        \"query_string\" : {\n                            \"query\" : \"root\"\n                        }\n                    }\n                }, {\n                    \"term\" : {\n                        \"message\" : \"tree\"\n                    }\n                }]\n            }\n        }\n    }\n}'\ncurl -XGET 'localhost:9200/test-idx/message/_percolate' -d '{\n    \"doc\" : {\n        \"message\" : \"A new bonsai tree in the office\"\n    }\n}'\n```\n\nOn the master the issue is not as prominent since the error is not returned to the user. On the current master the result of execution of the script above is the following error in the log:\n\n```\n[2014-02-07 10:49:32,594][WARN ][percolator               ] [Blizzard II] [[31]] failed to execute query\njava.lang.AssertionError\n    at org.apache.lucene.search.Scorer.score(Scorer.java:61)\n    at org.apache.lucene.search.ConstantScoreQuery$ConstantScorer.score(ConstantScoreQuery.java:256)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:309)\n    at org.elasticsearch.percolator.PercolatorService$4.doPercolate(PercolatorService.java:543)\n    at org.elasticsearch.percolator.PercolatorService.percolate(PercolatorService.java:232)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:194)\n    at org.elasticsearch.action.percolate.TransportPercolateAction.shardOperation(TransportPercolateAction.java:55)\n    at org.elasticsearch.action.support.broadcast.TransportBroadcastOperationAction$AsyncBroadcastAction$2.run(TransportBroadcastOperationAction.java:226)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:724)\n```\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}