{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29071","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29071/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29071/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29071/events","html_url":"https://github.com/elastic/elasticsearch/issues/29071","id":305281795,"node_id":"MDU6SXNzdWUzMDUyODE3OTU=","number":29071,"title":"inner_hits does not work for nested filters when searching multiple indices","user":{"login":"gognjanovski","id":5372504,"node_id":"MDQ6VXNlcjUzNzI1MDQ=","avatar_url":"https://avatars1.githubusercontent.com/u/5372504?v=4","gravatar_id":"","url":"https://api.github.com/users/gognjanovski","html_url":"https://github.com/gognjanovski","followers_url":"https://api.github.com/users/gognjanovski/followers","following_url":"https://api.github.com/users/gognjanovski/following{/other_user}","gists_url":"https://api.github.com/users/gognjanovski/gists{/gist_id}","starred_url":"https://api.github.com/users/gognjanovski/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gognjanovski/subscriptions","organizations_url":"https://api.github.com/users/gognjanovski/orgs","repos_url":"https://api.github.com/users/gognjanovski/repos","events_url":"https://api.github.com/users/gognjanovski/events{/privacy}","received_events_url":"https://api.github.com/users/gognjanovski/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-03-14T18:38:00Z","updated_at":"2018-03-27T16:55:42Z","closed_at":"2018-03-27T16:55:42Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** \r\nVersion: 6.2.2, Build: 10b1edd/2018-02-16T19:01:30.685723Z, JVM: 1.8.0_73\r\n\r\nI'm trying to search multiple indices which both have nested objects. To keep it simple I will use this example. In the query I use \"inner_hits\" property.\r\n\r\n```\r\nPUT /sales\r\n{\r\n    \"mappings\": {\r\n        \"_doc\" : {\r\n            \"properties\" : {\r\n                \"tags\" : { \"type\" : \"keyword\" },\r\n                \"comments\" : { \r\n                    \"type\" : \"nested\",\r\n                    \"properties\" : {\r\n                        \"username\" : { \"type\" : \"keyword\" },\r\n                        \"comment\" : { \"type\" : \"text\" }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nPUT /sales/_doc/1?refresh\r\n{\r\n    \"tags\": [\"car\", \"auto\"],\r\n    \"comments\": [\r\n        {\"username\": \"baddriver007\", \"comment\": \"This car could have better brakes\"},\r\n        {\"username\": \"dr_who\", \"comment\": \"Where's the autopilot? Can't find it\"},\r\n        {\"username\": \"ilovemotorbikes\", \"comment\": \"This car has two extra wheels\"}\r\n    ]\r\n}\r\n\r\nPUT /markets\r\n{\r\n    \"mappings\": {\r\n        \"_doc\" : {\r\n            \"properties\" : {\r\n                \"name\" : { \"type\" : \"keyword\" },\r\n                \"products\" : { \r\n                    \"type\" : \"nested\",\r\n                    \"properties\" : {\r\n                        \"name\" : { \"type\" : \"keyword\" },\r\n                        \"sku\" : { \"type\" : \"text\" }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}\r\n\r\nPOST /sales,markets/_search\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [\r\n        {\r\n          \"bool\": {\r\n            \"should\": [\r\n              {\r\n                \"nested\": {\r\n                  \"path\": \"comments\",\r\n                  \"inner_hits\": {\r\n                    \r\n                  },\r\n                  \"ignore_unmapped\": true,\r\n                  \"query\": {\r\n                    \"match_all\": {}\r\n                  }\r\n                }   \r\n              }]\r\n          }\r\n        },\r\n        {\r\n          \"bool\": {\r\n            \"should\": [\r\n              {\r\n                \"nested\": {\r\n                  \"path\": \"products\",\r\n                  \"inner_hits\": {\r\n                    \r\n                  },\r\n                  \"ignore_unmapped\": true,\r\n                  \"query\": {\r\n                    \"match_all\": {}\r\n                  }\r\n                }\r\n              }\r\n            ]\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  }\r\n}\r\n\r\n```\r\n\r\nSo this query gives an error\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"illegal_state_exception\",\r\n        \"reason\": \"[match_all] no mapping found for type [comments]\"\r\n      },\r\n      {\r\n        \"type\": \"illegal_state_exception\",\r\n        \"reason\": \"[match_all] no mapping found for type [products]\"\r\n      }\r\n    ],\r\n    \"type\": \"search_phase_execution_exception\",\r\n    \"reason\": \"all shards failed\",\r\n    \"phase\": \"query\",\r\n    \"grouped\": true,\r\n    \"failed_shards\": [\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"markets\",\r\n        \"node\": \"-22psoQNRLa8_Y9GeHBXaw\",\r\n        \"reason\": {\r\n          \"type\": \"illegal_state_exception\",\r\n          \"reason\": \"[match_all] no mapping found for type [comments]\"\r\n        }\r\n      },\r\n      {\r\n        \"shard\": 0,\r\n        \"index\": \"sales\",\r\n        \"node\": \"-22psoQNRLa8_Y9GeHBXaw\",\r\n        \"reason\": {\r\n          \"type\": \"illegal_state_exception\",\r\n          \"reason\": \"[match_all] no mapping found for type [products]\"\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\n\r\nBut when I add \"ignore_unmapped\": true inside each \"inner_hits\": { \"ignore_unmapped\": true } everything works fine. This is not implemented in NEST .net library so I wanted to be sure before I open an issue there.\r\n\r\nIs it right to use \"ignore_unmapped\" inside \"inner_hits\", because I didn't find this as \"inner_hits\" property in the documentation ? \r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}