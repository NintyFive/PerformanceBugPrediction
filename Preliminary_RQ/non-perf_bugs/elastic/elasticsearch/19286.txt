{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19286","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19286/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19286/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19286/events","html_url":"https://github.com/elastic/elasticsearch/issues/19286","id":164094024,"node_id":"MDU6SXNzdWUxNjQwOTQwMjQ=","number":19286,"title":"Duplicated documents after bulk create and server restart","user":{"login":"jt1","id":101519,"node_id":"MDQ6VXNlcjEwMTUxOQ==","avatar_url":"https://avatars0.githubusercontent.com/u/101519?v=4","gravatar_id":"","url":"https://api.github.com/users/jt1","html_url":"https://github.com/jt1","followers_url":"https://api.github.com/users/jt1/followers","following_url":"https://api.github.com/users/jt1/following{/other_user}","gists_url":"https://api.github.com/users/jt1/gists{/gist_id}","starred_url":"https://api.github.com/users/jt1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jt1/subscriptions","organizations_url":"https://api.github.com/users/jt1/orgs","repos_url":"https://api.github.com/users/jt1/repos","events_url":"https://api.github.com/users/jt1/events{/privacy}","received_events_url":"https://api.github.com/users/jt1/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-07-06T14:47:39Z","updated_at":"2016-07-06T15:32:07Z","closed_at":"2016-07-06T15:11:29Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.3\n\n**JVM version**: OpenJDK 1.8.0_91\n\n**OS version**: Ubuntu 16.04\n\n**Description of the problem including expected versus actual behavior**:\nDocuments are not properly indexed when Elasticsearch is restarted just after bulk request is send.\nBulk request is retried because of _connection refused_ error. Finally random documents are duplicated (same content, different id) in the index.\n\n**Steps to reproduce**:\n1. Start sending 1000 bulk requests with 100 documents each, one after another. First request example:\n   \n   ```\n   curl -XPOST 'localhost:9200/_bulk' -d '\n              {\"index\":{\"_index\" : \"index1\", \"_type\": \"test\"}}\n              {\"counter\": \"1\", \"package\": \"1/1000\"}\n              {\"index\":{\"_index\" : \"index1\", \"_type\": \"test\"}}\n              {\"counter\": \"2\", \"package\": \"1/1000\"}\n              ...\n              {\"index\":{\"_index\" : \"index1\", \"_type\": \"test\"}}\n              {\"counter\": \"100\", \"package\": \"1/1000\"}\n   '\n   ```\n2. Restart Elasticsearch just after server starts receiving requests. \n   `sudo service elasticsearch restart`\n3. Repeat previous step couple of times.\n4. If bulk request fails (Connection refused) because of Elasticsearch restart, repeat sending request until it succeed.\n5. After all bulk requests are sent, index document count is grater then 10000.\n   `curl -XGET http://localhost:9200/index1/_count`\n   {\"count\":**10326**,\"_shards\":{\"total\":5,\"successful\":5,\"failed\":0}}\n\n**Provide logs (if relevant)**:\n\n```\n[2016-07-06 15:49:28,441][INFO ][node                     ] [ubuntu1-node] stopping ...\n[2016-07-06 15:49:28,485][WARN ][netty.channel.DefaultChannelPipeline] An exception was thrown by an exception handler.\njava.util.concurrent.RejectedExecutionException: Worker has already been shutdown\n    at org.jboss.netty.channel.socket.nio.AbstractNioSelector.registerTask(AbstractNioSelector.java:120)\n    at org.jboss.netty.channel.socket.nio.AbstractNioWorker.executeInIoThread(AbstractNioWorker.java:72)\n    at org.jboss.netty.channel.socket.nio.NioWorker.executeInIoThread(NioWorker.java:36)\n    at org.jboss.netty.channel.socket.nio.AbstractNioWorker.executeInIoThread(AbstractNioWorker.java:56)\n    at org.jboss.netty.channel.socket.nio.NioWorker.executeInIoThread(NioWorker.java:36)\n    at org.jboss.netty.channel.socket.nio.AbstractNioChannelSink.execute(AbstractNioChannelSink.java:34)\n    at org.jboss.netty.channel.DefaultChannelPipeline.execute(DefaultChannelPipeline.java:636)\n    at org.jboss.netty.channel.Channels.fireExceptionCaughtLater(Channels.java:496)\n    at org.jboss.netty.channel.AbstractChannelSink.exceptionCaught(AbstractChannelSink.java:46)\n    at org.jboss.netty.channel.DefaultChannelPipeline.notifyHandlerException(DefaultChannelPipeline.java:658)\n    at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendDownstream(DefaultChannelPipeline.java:781)\n    at org.jboss.netty.channel.Channels.write(Channels.java:725)\n    at org.jboss.netty.handler.codec.oneone.OneToOneEncoder.doEncode(OneToOneEncoder.java:71)\n    at org.jboss.netty.handler.codec.oneone.OneToOneEncoder.handleDownstream(OneToOneEncoder.java:59)\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendDownstream(DefaultChannelPipeline.java:591)\n    at org.jboss.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendDownstream(DefaultChannelPipeline.java:784)\n    at org.elasticsearch.http.netty.pipelining.HttpPipeliningHandler.handleDownstream(HttpPipeliningHandler.java:87)\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendDownstream(DefaultChannelPipeline.java:591)\n    at org.jboss.netty.channel.DefaultChannelPipeline.sendDownstream(DefaultChannelPipeline.java:582)\n    at org.elasticsearch.http.netty.NettyHttpChannel.sendResponse(NettyHttpChannel.java:146)\n    at org.elasticsearch.rest.action.support.RestResponseListener.processResponse(RestResponseListener.java:43)\n    at org.elasticsearch.rest.action.support.RestActionListener.onResponse(RestActionListener.java:49)\n    at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:89)\n    at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:85)\n    at org.elasticsearch.action.bulk.TransportBulkAction$2.finishHim(TransportBulkAction.java:356)\n    at org.elasticsearch.action.bulk.TransportBulkAction$2.onFailure(TransportBulkAction.java:351)\n    at org.elasticsearch.action.support.TransportAction$1.onFailure(TransportAction.java:95)\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.finishAsFailed(TransportReplicationAction.java:567)\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase$1.handleException(TransportReplicationAction.java:527)\n    at org.elasticsearch.transport.TransportService$2.run(TransportService.java:206)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n[2016-07-06 15:49:28,512][WARN ][transport                ] [ubuntu1-node] Transport response handler not found of id [43]\n[2016-07-06 15:49:28,863][INFO ][node                     ] [ubuntu1-node] stopped\n[2016-07-06 15:49:28,863][INFO ][node                     ] [ubuntu1-node] closing ...\n[2016-07-06 15:49:28,868][INFO ][node                     ] [ubuntu1-node] closed\n```\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}