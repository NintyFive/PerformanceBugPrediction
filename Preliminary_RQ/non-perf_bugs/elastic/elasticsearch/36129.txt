{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36129","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36129/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36129/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36129/events","html_url":"https://github.com/elastic/elasticsearch/issues/36129","id":386373180,"node_id":"MDU6SXNzdWUzODYzNzMxODA=","number":36129,"title":"A shingle filter before synonym filter causes index creation/open failure when multi-word synonyms are used","user":{"login":"adoerrES","id":29957519,"node_id":"MDQ6VXNlcjI5OTU3NTE5","avatar_url":"https://avatars1.githubusercontent.com/u/29957519?v=4","gravatar_id":"","url":"https://api.github.com/users/adoerrES","html_url":"https://github.com/adoerrES","followers_url":"https://api.github.com/users/adoerrES/followers","following_url":"https://api.github.com/users/adoerrES/following{/other_user}","gists_url":"https://api.github.com/users/adoerrES/gists{/gist_id}","starred_url":"https://api.github.com/users/adoerrES/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adoerrES/subscriptions","organizations_url":"https://api.github.com/users/adoerrES/orgs","repos_url":"https://api.github.com/users/adoerrES/repos","events_url":"https://api.github.com/users/adoerrES/events{/privacy}","received_events_url":"https://api.github.com/users/adoerrES/received_events","type":"User","site_admin":false},"labels":[{"id":142001965,"node_id":"MDU6TGFiZWwxNDIwMDE5NjU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Analysis","name":":Search/Analysis","color":"0e8a16","default":false,"description":"How text is split into tokens"},{"id":1056536047,"node_id":"MDU6TGFiZWwxMDU2NTM2MDQ3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.2","name":"v6.4.2","color":"Dddddd","default":false,"description":""},{"id":1104252481,"node_id":"MDU6TGFiZWwxMTA0MjUyNDgx","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.5.1","name":"v6.5.1","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-11-30T22:24:54Z","updated_at":"2018-12-03T07:34:18Z","closed_at":"2018-12-03T07:34:18Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.5.1 and earlier 6.x versions (tested in 6.4.2 as well)\r\n\r\n`Version: 6.5.1, Build: default/tar/8c58350/2018-11-16T02:22:42.182257Z, JVM: 1.8.0_181`\r\n\r\n**Plugins installed**: [] None\r\n\r\n**JVM version** (`java -version`):\r\n```\r\njava version \"1.8.0_181\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_181-b13)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.181-b13, mixed mode)\r\n```\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nReproduced in Elastic SaaS and on Mac:\r\n\r\n`16.7.0 Darwin Kernel Version 16.7.0: Thu Jun 21 20:07:39 PDT 2018; root:xnu-3789.73.14~1/RELEASE_X86_64 x86_64`\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nIndex settings that use a `shingle` filter before a `synonym` filter in a filter chain AND contain multi-word synonyms that contain whitespace (like `\"eagle claw, eagleclaw\"`) cause index creation and opening to fail.\r\n\r\nFor example, creating or opening an index with the following settings:\r\n```\r\nPUT testindex\r\n{\r\n  \"settings\": {\r\n    \"index\": {\r\n      \"analysis\": {\r\n        \"filter\": {\r\n          \"synonym\": {\r\n            \"type\": \"synonym\",\r\n            \"synonyms\": [\r\n              \"panamanian, panama\",\r\n              \"eagle claw, eagleclaw\"\r\n            ],\r\n            \"tokenizer\": \"keyword\"\r\n          },\r\n          \"my_shingle\": {\r\n            \"max_shingle_size\": \"6\",\r\n            \"min_shingle_size\": \"2\",\r\n            \"output_unigrams\": \"true\",\r\n            \"type\": \"shingle\"\r\n          }\r\n        },\r\n        \"analyzer\": {\r\n          \"with_synonyms\": {\r\n            \"filter\": [\r\n              \"lowercase\",\r\n              \"my_shingle\",\r\n              \"synonym\"\r\n            ],\r\n            \"type\": \"custom\",\r\n            \"tokenizer\": \"standard\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n\r\n...yields this error:\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"illegal_argument_exception\",\r\n        \"reason\": \"failed to build synonyms\"\r\n      }\r\n    ],\r\n    \"type\": \"illegal_argument_exception\",\r\n    \"reason\": \"failed to build synonyms\",\r\n    \"caused_by\": {\r\n      \"type\": \"parse_exception\",\r\n      \"reason\": \"Invalid synonym rule at line 2\",\r\n      \"caused_by\": {\r\n        \"type\": \"illegal_argument_exception\",\r\n        \"reason\": \"term: eagle claw analyzed to a token (eagle claw) with position increment != 1 (got: 0)\"\r\n      }\r\n    }\r\n  },\r\n  \"status\": 400\r\n}\r\n```\r\n\r\n**Workarounds:**\r\n\r\nEither remove all multi-word thesaurus entries from the index settings (`\"eagle claw, eagleclaw\"`) which is undesirable, or, change the order in the filter chain so that the `synonym` filter comes before the`shingle` filter, like so:\r\n\r\n(excerpt)\r\n```\r\n        \"analyzer\": {\r\n          \"with_synonyms\": {\r\n            \"filter\": [\r\n              \"lowercase\",\r\n              \"synonym\",\r\n              \"my_shingle\"\r\n            ],\r\n```\r\n\r\n\r\n\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}