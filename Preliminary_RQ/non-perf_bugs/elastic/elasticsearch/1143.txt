{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1143","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1143/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1143/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1143/events","html_url":"https://github.com/elastic/elasticsearch/issues/1143","id":1263206,"node_id":"MDU6SXNzdWUxMjYzMjA2","number":1143,"title":"Reusing query parser in WrapperQueryParser produces invalid queries","user":{"login":"melix","id":316357,"node_id":"MDQ6VXNlcjMxNjM1Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/316357?v=4","gravatar_id":"","url":"https://api.github.com/users/melix","html_url":"https://github.com/melix","followers_url":"https://api.github.com/users/melix/followers","following_url":"https://api.github.com/users/melix/following{/other_user}","gists_url":"https://api.github.com/users/melix/gists{/gist_id}","starred_url":"https://api.github.com/users/melix/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/melix/subscriptions","organizations_url":"https://api.github.com/users/melix/orgs","repos_url":"https://api.github.com/users/melix/repos","events_url":"https://api.github.com/users/melix/events{/privacy}","received_events_url":"https://api.github.com/users/melix/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":128694,"node_id":"MDU6TGFiZWwxMjg2OTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.17.2","name":"v0.17.2","color":"DDDDDD","default":false,"description":null},{"id":127902,"node_id":"MDU6TGFiZWwxMjc5MDI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.18.0","name":"v0.18.0","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2011-07-21T14:13:10Z","updated_at":"2011-07-21T17:21:39Z","closed_at":"2011-07-21T17:21:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I was surprised to see that when I used the WrapperQuery, my query returned the source field instead of the fields I was asking for. Also, some queries combining wrapper queries where invalid (na) without any good explanation. I eventually found that writing this :\n\n``` javascript\n{\n  \"from\" : 0,\n  \"size\" : 10,\n  \"query\" : {\n    \"wrapper\" : {\n      \"query\" : \"ewogICAgInRlcm0iOiB7ImZpZWxkMSI6InZhbHVlMV8xIn0KfQo=\"\n    }\n  },\n  \"fields\" : [ \"field2\" ]\n}\n```\n\nReturns the \"field2\" field value :\n\n``` javascript\n{\"took\":1,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":0.30685282,\"hits\":[{\"_index\":\"test\",\"_type\":\"type1\",\"_id\":\"1\",\"_score\":0.30685282,\"fields\":{\"field2\":\"value2_1\"}}]}}\n```\n\n, while writing this :\n\n``` javascript\n{\n  \"fields\" : [ \"field2\" ],\n  \"from\" : 0,\n  \"size\" : 10,\n  \"query\" : {\n    \"wrapper\" : {\n      \"query\" : \"ewogICAgInRlcm0iOiB7ImZpZWxkMSI6InZhbHVlMV8xIn0KfQo=\"\n    }\n  }\n}\n```\n\ndoesn't and returns the source object :\n\n``` javascript\n{\"took\":4479,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"failed\":0},\"hits\":{\"total\":1,\"max_score\":0.30685282,\"hits\":[{\"_index\":\"test\",\"_type\":\"type1\",\"_id\":\"1\",\"_score\":0.30685282, \"_source\" : {\"field1\":\"value1_1\",\"field2\":\"value2_1\"}}]}}\n```\n\n. I guess there is something breaking the internal state of the parser when reusing it with `SearchContext.current().queryParserService().parse(qSourceParser).query();`\n","closed_by":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}