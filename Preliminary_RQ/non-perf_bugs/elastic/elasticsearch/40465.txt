{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40465","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40465/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40465/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40465/events","html_url":"https://github.com/elastic/elasticsearch/issues/40465","id":425463159,"node_id":"MDU6SXNzdWU0MjU0NjMxNTk=","number":40465,"title":"The indices have been exchanged between the two clusters in one machine","user":{"login":"kkewwei","id":16730433,"node_id":"MDQ6VXNlcjE2NzMwNDMz","avatar_url":"https://avatars1.githubusercontent.com/u/16730433?v=4","gravatar_id":"","url":"https://api.github.com/users/kkewwei","html_url":"https://github.com/kkewwei","followers_url":"https://api.github.com/users/kkewwei/followers","following_url":"https://api.github.com/users/kkewwei/following{/other_user}","gists_url":"https://api.github.com/users/kkewwei/gists{/gist_id}","starred_url":"https://api.github.com/users/kkewwei/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kkewwei/subscriptions","organizations_url":"https://api.github.com/users/kkewwei/orgs","repos_url":"https://api.github.com/users/kkewwei/repos","events_url":"https://api.github.com/users/kkewwei/events{/privacy}","received_events_url":"https://api.github.com/users/kkewwei/received_events","type":"User","site_admin":false},"labels":[{"id":144797810,"node_id":"MDU6TGFiZWwxNDQ3OTc4MTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Core","name":":Core/Infra/Core","color":"0e8a16","default":false,"description":"Core issues without another label"},{"id":929267538,"node_id":"MDU6TGFiZWw5MjkyNjc1Mzg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/team-discuss","name":"team-discuss","color":"fbca04","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-03-26T14:47:00Z","updated_at":"2019-03-27T15:37:31Z","closed_at":"2019-03-27T15:37:31Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Elasticsearch version** : All\r\n**JVM version** :  1.8.0_45\r\n**OS version** :  linux\r\n**Description **\r\nSuppose we deploy two instances of elasticsearch service on same machine, for example cluster1, cluster2. \r\nwe both set configuration as follow in elasticsearch.yml of both two instances:\r\n1. node.max_local_storage_nodes : 2\r\n2. path.data: /data1/es_data/\r\n\r\nsteps are as follow:\r\n- we create an index separately in each cluster, those indices's distribution is as follows:\r\n[cluster1 ] :index1\r\n[cluster2 ] :index2\r\nwe find that data path of cluster1 is /data1/es_data/nodes/0/indices/*, and data path of cluster2 is /data1/es_data/nodes/1/indices/*\r\n- we shut down both of two clusters, then restart cluster2,  lastly restart cluster1. the order of startup is very important.\r\nAs a result, those indices's distribution changes:\r\n[cluster1 ] :index2\r\n[cluster2 ] :index1\r\nindex1 should exist in cluster1, but exists in cluster2, and index2 exactly the Opposite.\r\n\r\n**Reason **\r\n We observe such a fact: after we restart cluster of cluster2 first, cluster2 regards /data1/es_data/nodes/0/indices/* as its data.path. cluster1 regards /data2/es_data/nodes/1/indices/* as its data.path. the indices have been exchanged between the two clusters, it is unacceptable. The problem is here: https://github.com/elastic/elasticsearch/blob/4469cf0db81e74c63e2ff2eb5970039a541d1adf/server/src/main/java/org/elasticsearch/env/NodeEnvironment.java#L265 \r\nwe can see that cluster2 is restarted  firstly, it obtains /data1/es_data/nodes/0/indices/. then cluster1 restarts, it tries to set possibleLockId=0, but fails, it can only set possibleLockId=1, as the result, cluster1 regards /data2/es_data/nodes/1/indices/* as its data.path. it may be unreasonable that the data.path is uncertainly\r\n\r\n**Solution**\r\nin elasticsearch.yml, we can set \"node.id: 0/1\", so the data path of each node is very clear.\r\n\r\n\r\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}