[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404287398","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404287398","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404287398,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDI4NzM5OA==","user":{"login":"kylelyk","id":3401359,"node_id":"MDQ6VXNlcjM0MDEzNTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3401359?v=4","gravatar_id":"","url":"https://api.github.com/users/kylelyk","html_url":"https://github.com/kylelyk","followers_url":"https://api.github.com/users/kylelyk/followers","following_url":"https://api.github.com/users/kylelyk/following{/other_user}","gists_url":"https://api.github.com/users/kylelyk/gists{/gist_id}","starred_url":"https://api.github.com/users/kylelyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kylelyk/subscriptions","organizations_url":"https://api.github.com/users/kylelyk/orgs","repos_url":"https://api.github.com/users/kylelyk/repos","events_url":"https://api.github.com/users/kylelyk/events{/privacy}","received_events_url":"https://api.github.com/users/kylelyk/received_events","type":"User","site_admin":false},"created_at":"2018-07-11T19:42:29Z","updated_at":"2018-07-11T19:42:29Z","author_association":"NONE","body":"The description of this problem seems similar to https://github.com/elastic/elasticsearch/issues/10511, however I have double checked that all of the documents are of the type \"ce\".","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404342204","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404342204","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404342204,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDM0MjIwNA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-11T23:31:22Z","updated_at":"2018-07-11T23:31:22Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404415784","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404415784","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404415784,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDQxNTc4NA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-07-12T07:25:42Z","updated_at":"2018-07-12T07:25:42Z","author_association":"CONTRIBUTOR","body":"@kylelyk Can you provide more info on the bulk indexing process? Are you setting the routing value on the bulk request? Are you using [auto-generated IDs](https://www.elastic.co/guide/en/elasticsearch/guide/current/index-doc.html#_autogenerating_ids)?\r\nIn order to check that these documents are indeed on the same shard, can you do the search again, this time using a preference (`_shards:0`, and then check with `_shards:1` etc.), see https://www.elastic.co/guide/en/elasticsearch/reference/current/search-request-preference.html\r\nAre these duplicates only showing when you hit the primary or the replica shards? Can you try the search with preference `_primary`, and then again using preference `_replica`. Thanks.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404558918","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404558918","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404558918,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDU1ODkxOA==","user":{"login":"kylelyk","id":3401359,"node_id":"MDQ6VXNlcjM0MDEzNTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3401359?v=4","gravatar_id":"","url":"https://api.github.com/users/kylelyk","html_url":"https://github.com/kylelyk","followers_url":"https://api.github.com/users/kylelyk/followers","following_url":"https://api.github.com/users/kylelyk/following{/other_user}","gists_url":"https://api.github.com/users/kylelyk/gists{/gist_id}","starred_url":"https://api.github.com/users/kylelyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kylelyk/subscriptions","organizations_url":"https://api.github.com/users/kylelyk/orgs","repos_url":"https://api.github.com/users/kylelyk/repos","events_url":"https://api.github.com/users/kylelyk/events{/privacy}","received_events_url":"https://api.github.com/users/kylelyk/received_events","type":"User","site_admin":false},"created_at":"2018-07-12T15:48:05Z","updated_at":"2018-07-12T15:48:05Z","author_association":"NONE","body":"We are using routing values for each document indexed during a bulk request and we are using external GUIDs from a DB for the id.\r\n\r\nSearching using the preferences you specified, I can see that there are two documents on shard 1 primary with same id, type, and routing id, and 1 document on shard 1 replica.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404562988","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404562988","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404562988,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDU2Mjk4OA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-07-12T16:00:36Z","updated_at":"2018-07-12T16:01:04Z","author_association":"MEMBER","body":"> I can see that there are two documents on shard 1 primary with same id, type, and routing id, and 1 document on shard 1 replica.\r\n\r\nDid you mean the duplicate occurs on the primary? Can you also provide the `_version` number of these documents (on both primary and replica)?  Thank you!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404611259","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404611259","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404611259,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDYxMTI1OQ==","user":{"login":"kylelyk","id":3401359,"node_id":"MDQ6VXNlcjM0MDEzNTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3401359?v=4","gravatar_id":"","url":"https://api.github.com/users/kylelyk","html_url":"https://github.com/kylelyk","followers_url":"https://api.github.com/users/kylelyk/followers","following_url":"https://api.github.com/users/kylelyk/following{/other_user}","gists_url":"https://api.github.com/users/kylelyk/gists{/gist_id}","starred_url":"https://api.github.com/users/kylelyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kylelyk/subscriptions","organizations_url":"https://api.github.com/users/kylelyk/orgs","repos_url":"https://api.github.com/users/kylelyk/repos","events_url":"https://api.github.com/users/kylelyk/events{/privacy}","received_events_url":"https://api.github.com/users/kylelyk/received_events","type":"User","site_admin":false},"created_at":"2018-07-12T18:43:22Z","updated_at":"2018-07-12T18:43:22Z","author_association":"NONE","body":"Yes, the duplicate occurs on the primary shard. When I try to search using _version as documented [here](https://www.elastic.co/guide/en/elasticsearch/reference/6.3/search-request-version.html), I get two documents with version 60 and 59. I get 1 document when I then specify the preference=shards:X where x is any number. Maybe _version doesn't play well with preferences?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404639760","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404639760","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404639760,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDYzOTc2MA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-07-12T20:26:50Z","updated_at":"2018-07-12T20:26:50Z","author_association":"MEMBER","body":"@kylelyk Thanks a lot for the info. Which [version type](https://www.elastic.co/guide/en/elasticsearch/reference/6.3/docs-index_.html#_version_types) did you use for these documents? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404647660","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404647660","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404647660,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDY0NzY2MA==","user":{"login":"kylelyk","id":3401359,"node_id":"MDQ6VXNlcjM0MDEzNTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3401359?v=4","gravatar_id":"","url":"https://api.github.com/users/kylelyk","html_url":"https://github.com/kylelyk","followers_url":"https://api.github.com/users/kylelyk/followers","following_url":"https://api.github.com/users/kylelyk/following{/other_user}","gists_url":"https://api.github.com/users/kylelyk/gists{/gist_id}","starred_url":"https://api.github.com/users/kylelyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kylelyk/subscriptions","organizations_url":"https://api.github.com/users/kylelyk/orgs","repos_url":"https://api.github.com/users/kylelyk/repos","events_url":"https://api.github.com/users/kylelyk/events{/privacy}","received_events_url":"https://api.github.com/users/kylelyk/received_events","type":"User","site_admin":false},"created_at":"2018-07-12T20:55:19Z","updated_at":"2018-07-12T20:55:19Z","author_association":"NONE","body":"I am not using any kind of versioning when indexing so the default should be no version checking and automatic version incrementing.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404692547","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404692547","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404692547,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDY5MjU0Nw==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-07-13T00:46:20Z","updated_at":"2018-07-13T00:46:20Z","author_association":"MEMBER","body":"> We use Bulk Index API calls to delete and index the documents. \r\n\r\n@kylelyk We don't have to delete before reindexing a document. However, can you confirm that you always use a bulk of delete and index when updating documents or just sometimes? Thank you!","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404722753","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404722753","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404722753,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDcyMjc1Mw==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2018-07-13T04:32:59Z","updated_at":"2018-12-07T06:24:56Z","author_association":"MEMBER","body":"@ywelsch found that this issue is related to and fixed by https://github.com/elastic/elasticsearch/pull/29619. \r\n\r\nGiven the way we deleted/updated these documents and their versions, this issue can be explained as follows:\r\n\r\n1. Suppose we have a document with version 57 \r\n\r\n2. A bulk of delete and reindex will remove the index-v57, increase the version to 58 (for the delete operation), then put a new doc with version 59. While the engine places the index-59 into the version map,  the safe-access flag is flipped over (due to a concurrent fresh), the engine won't put that index entry into the version map, but also leave the delete-58 tombstone in the version map. The delete-58 tombstone is stale because the latest version of that document is index-59.\r\n\r\n3. Another bulk of delete and reindex will increase the version to 59 (for a delete) but won't remove docs from Lucene because of the existing (stale) delete-58 tombstone. The index operation will append document (version 60) to Lucene (instead of overwriting). At this point, we will have two documents with the same id.\r\n\r\nOur [formal model](https://github.com/elastic/elasticsearch-formal-models/pull/29) [uncovered](https://github.com/elastic/elasticsearch-formal-models/pull/29/commits/893a0edbce86b2e114ea59de4170c838024fc6ac) this problem and we already fixed this in 6.3.0 by https://github.com/elastic/elasticsearch/pull/29619.\r\n\r\n@kylelyk I really appreciate your helpfulness here.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404752305","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404752305","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404752305,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDc1MjMwNQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2018-07-13T07:36:13Z","updated_at":"2018-07-13T07:36:13Z","author_association":"CONTRIBUTOR","body":"@kylelyk can you update to the latest ES version (6.3.1 as of this reply) and check if this still happens?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/404862257","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-404862257","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":404862257,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNDg2MjI1Nw==","user":{"login":"kylelyk","id":3401359,"node_id":"MDQ6VXNlcjM0MDEzNTk=","avatar_url":"https://avatars1.githubusercontent.com/u/3401359?v=4","gravatar_id":"","url":"https://api.github.com/users/kylelyk","html_url":"https://github.com/kylelyk","followers_url":"https://api.github.com/users/kylelyk/followers","following_url":"https://api.github.com/users/kylelyk/following{/other_user}","gists_url":"https://api.github.com/users/kylelyk/gists{/gist_id}","starred_url":"https://api.github.com/users/kylelyk/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kylelyk/subscriptions","organizations_url":"https://api.github.com/users/kylelyk/orgs","repos_url":"https://api.github.com/users/kylelyk/repos","events_url":"https://api.github.com/users/kylelyk/events{/privacy}","received_events_url":"https://api.github.com/users/kylelyk/received_events","type":"User","site_admin":false},"created_at":"2018-07-13T15:10:11Z","updated_at":"2018-07-13T15:10:11Z","author_association":"NONE","body":"Unfortunately, we're using the AWS hosted version of Elasticsearch so it might take some time for Amazon to update it to 6.3.x. I'll close this issue and re-open it if the problem persists after the update.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/491799670","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-491799670","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":491799670,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MTc5OTY3MA==","user":{"login":"HJK181","id":11541497,"node_id":"MDQ6VXNlcjExNTQxNDk3","avatar_url":"https://avatars2.githubusercontent.com/u/11541497?v=4","gravatar_id":"","url":"https://api.github.com/users/HJK181","html_url":"https://github.com/HJK181","followers_url":"https://api.github.com/users/HJK181/followers","following_url":"https://api.github.com/users/HJK181/following{/other_user}","gists_url":"https://api.github.com/users/HJK181/gists{/gist_id}","starred_url":"https://api.github.com/users/HJK181/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/HJK181/subscriptions","organizations_url":"https://api.github.com/users/HJK181/orgs","repos_url":"https://api.github.com/users/HJK181/repos","events_url":"https://api.github.com/users/HJK181/events{/privacy}","received_events_url":"https://api.github.com/users/HJK181/received_events","type":"User","site_admin":false},"created_at":"2019-05-13T12:20:52Z","updated_at":"2019-05-13T12:20:52Z","author_association":"NONE","body":"@ywelsch I'm having the same issue which I can reproduce with the following commands:\r\n\r\n```\r\nPUT test/_doc/q_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bf?routing=c_76d2af16e8b01927f16e6cbd0d91caac3b87cbdd&op_type=create\r\n{\r\n    \"query\": \"forestier\",\r\n    \"joinType\": {\r\n      \"name\": \"q\",\r\n      \"parent\": \"c_76d2af16e8b01927f16e6cbd0d91caac3b87cbdd\"\r\n    }\r\n}\r\n```\r\nFollowed by:\r\n```\r\nPUT test/_doc/q_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bf?routing=c_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bff&op_type=create\r\n{\r\n    \"query\": \"forestier\",\r\n    \"joinType\": {\r\n      \"name\": \"q\",\r\n      \"parent\": \"c_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bf\"\r\n    }\r\n}\r\n```\r\nWhich will result in:\r\n```\r\n{\r\n  \"took\": 7,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 2,\r\n    \"successful\": 2,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": 2,\r\n    \"max_score\": 1,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"test\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"q_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bf\",\r\n        \"_score\": 1,\r\n        \"_routing\": \"c_76d2af16e8b01927f16e6cbd0d91caac3b87cbdd\",\r\n        \"_source\": {\r\n          \"query\": \"forestier\",\r\n          \"joinType\": {\r\n            \"name\": \"q\",\r\n            \"parent\": \"c_76d2af16e8b01927f16e6cbd0d91caac3b87cbdd\"\r\n          }\r\n        }\r\n      },\r\n      {\r\n        \"_index\": \"test\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"q_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bf\",\r\n        \"_score\": 1,\r\n        \"_routing\": \"c_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bff\",\r\n        \"_source\": {\r\n          \"query\": \"forestier\",\r\n          \"joinType\": {\r\n            \"name\": \"q\",\r\n            \"parent\": \"c_38d9770d8c80f2f3b8e3bb0b93d30b5f372cf5bf\"\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nThe same commands issued against an index without joinType does **not** produce duplicate documents. My template looks like:\r\n```\r\n\"mappings\": {\r\n   ...\r\n\t\t\t\"properties\": {\r\n\t\t\t\t\"joinType\": {\r\n\t\t\t\t\t\"type\": \"join\",\r\n\t\t\t\t\t\"relations\": {\r\n\t\t\t\t\t\t\"c\": \"q\"\r\n\t\t\t\t\t}\r\n\t\t\t\t},\r\n  ...\r\n}\r\n```\r\n\r\nI'm on Elasticsearch 6.3.2.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/491835349","html_url":"https://github.com/elastic/elasticsearch/issues/31976#issuecomment-491835349","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31976","id":491835349,"node_id":"MDEyOklzc3VlQ29tbWVudDQ5MTgzNTM0OQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2019-05-13T14:02:17Z","updated_at":"2019-05-13T14:02:17Z","author_association":"MEMBER","body":"@HJK181 you have different routing keys. Your documents most likely go to different shards. This is expected behaviour. You need to ensure that if you use routing values two documents with the same id cannot have different routing keys. If you have any further questions or need help with elasticsearch, please don't hesitate to ask on [our discussion forum](https://discuss.elastic.co/).","performed_via_github_app":null}]