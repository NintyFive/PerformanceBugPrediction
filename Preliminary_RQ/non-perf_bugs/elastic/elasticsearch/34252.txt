{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34252","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34252/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34252/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34252/events","html_url":"https://github.com/elastic/elasticsearch/issues/34252","id":366130937,"node_id":"MDU6SXNzdWUzNjYxMzA5Mzc=","number":34252,"title":"Create Security Role API allows malformed/invalid query JSON","user":{"login":"tsouza","id":122435,"node_id":"MDQ6VXNlcjEyMjQzNQ==","avatar_url":"https://avatars3.githubusercontent.com/u/122435?v=4","gravatar_id":"","url":"https://api.github.com/users/tsouza","html_url":"https://github.com/tsouza","followers_url":"https://api.github.com/users/tsouza/followers","following_url":"https://api.github.com/users/tsouza/following{/other_user}","gists_url":"https://api.github.com/users/tsouza/gists{/gist_id}","starred_url":"https://api.github.com/users/tsouza/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tsouza/subscriptions","organizations_url":"https://api.github.com/users/tsouza/orgs","repos_url":"https://api.github.com/users/tsouza/repos","events_url":"https://api.github.com/users/tsouza/events{/privacy}","received_events_url":"https://api.github.com/users/tsouza/received_events","type":"User","site_admin":false},"labels":[{"id":912838209,"node_id":"MDU6TGFiZWw5MTI4MzgyMDk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authorization","name":":Security/Authorization","color":"0e8a16","default":false,"description":"Roles, Privileges, DLS/FLS, RBAC/ABAC"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"assignees":[{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2018-10-03T00:37:29Z","updated_at":"2019-09-25T08:56:23Z","closed_at":"2019-09-25T08:56:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n`Version: 6.4.1, Build: default/tar/e36acdb/2018-09-13T22:18:07.696808Z, JVM: 10.0.1`\r\n`Version: 6.3.0, Build: default/tar/424e937/2018-06-11T23:38:03.357887Z, JVM: 10.0.1`\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n```\r\njava version \"10.0.1\" 2018-04-17\r\nJava(TM) SE Runtime Environment 18.3 (build 10.0.1+10)\r\nJava HotSpot(TM) 64-Bit Server VM 18.3 (build 10.0.1+10, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n```\r\nDarwin ElasticMBP 17.7.0 Darwin Kernel Version 17.7.0: Thu Jun 21 22:53:14 PDT 2018; root:xnu-4570.71.2~1/RELEASE_X86_64 x86_64\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nThe [Create or update roles API](https://www.elastic.co/guide/en/elasticsearch/reference/6.4/security-api-put-role.html) will allow defining a malformed/invalid query JSON in it's `query` attribute definition. Any query that is executed by a user with a role that has a malformed/invalid JSON in `query` attribute will always fail.\r\n\r\nThe expected is that the attempt to create a role should always fail if it defines a malformed/invalid JSON in it's `query` attribute.\r\n\r\nAdditionally, the same is observed if a `query` attribute is defined with a correct JSON syntax but it's an invalid/unknown Elasticsearch query .\r\n\r\nNote: This has been observed both in `6.3.0` and `6.4.1`\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create a role with a malformed/invalid JSON in it's `query` attribute:\r\n```http\r\nPOST /_xpack/security/role/test\r\n{\r\n  \"indices\" : [\r\n    {\r\n      \"names\" : [ \"test-*\" ],\r\n      \"privileges\" : [ \"read\" ],\r\n      \"query\": \"{ malformed JSON }\"\r\n    }\r\n  ]\r\n}\r\n```\r\nElasticsearch will accept the role definition and respond with:\r\n```json\r\n{\r\n  \"role\": {\r\n    \"created\": true\r\n  }\r\n}\r\n```\r\n\r\n 2. Create a user with the role:\r\n```http\r\nPOST _xpack/security/user/test\r\n{\r\n  \"password\": \"123456\",\r\n  \"roles\": [ \"test\" ]\r\n}\r\n```\r\n\r\n 3. Index some test document:\r\n```http\r\nPOST test-1/doc\r\n{\r\n  \"test\": \"doc\"\r\n}\r\n```\r\n\r\n4. Test a search with user `test`. The search will fail since the resulting query is invalid:\r\n```bash\r\n$ curl -u test:123456 localhost:9200/test-1/_search\r\n{\"error\":{\"root_cause\":[{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@49bcb51e; line: 1, column: 4]\"},{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@52014fcf; line: 1, column: 4]\"},{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@56e9f409; line: 1, column: 4]\"},{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@34d339df; line: 1, column: 4]\"},{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@32068a2e; line: 1, column: 4]\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"test-1\",\"node\":\"tZDWdiboSy2tuPtyrL4nUQ\",\"reason\":{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@49bcb51e; line: 1, column: 4]\",\"caused_by\":{\"type\":\"json_parse_exception\",\"reason\":\"Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@49bcb51e; line: 1, column: 4]\"}}},{\"shard\":1,\"index\":\"test-1\",\"node\":\"tZDWdiboSy2tuPtyrL4nUQ\",\"reason\":{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@52014fcf; line: 1, column: 4]\",\"caused_by\":{\"type\":\"json_parse_exception\",\"reason\":\"Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@52014fcf; line: 1, column: 4]\"}}},{\"shard\":2,\"index\":\"test-1\",\"node\":\"tZDWdiboSy2tuPtyrL4nUQ\",\"reason\":{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@56e9f409; line: 1, column: 4]\",\"caused_by\":{\"type\":\"json_parse_exception\",\"reason\":\"Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@56e9f409; line: 1, column: 4]\"}}},{\"shard\":3,\"index\":\"test-1\",\"node\":\"tZDWdiboSy2tuPtyrL4nUQ\",\"reason\":{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@34d339df; line: 1, column: 4]\",\"caused_by\":{\"type\":\"json_parse_exception\",\"reason\":\"Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@34d339df; line: 1, column: 4]\"}}},{\"shard\":4,\"index\":\"test-1\",\"node\":\"tZDWdiboSy2tuPtyrL4nUQ\",\"reason\":{\"type\":\"exception\",\"reason\":\"com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@32068a2e; line: 1, column: 4]\",\"caused_by\":{\"type\":\"json_parse_exception\",\"reason\":\"Unexpected character ('m' (code 109)): was expecting double-quote to start field name\\n at [Source: java.io.StringReader@32068a2e; line: 1, column: 4]\"}}}]},\"status\":500}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n[2018-10-02T21:11:59,619][WARN ][r.suppressed             ] path: /test-1/_search, params: {index=test-1}\r\norg.elasticsearch.action.search.SearchPhaseExecutionException: all shards failed\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseFailure(AbstractSearchAsyncAction.java:293) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:133) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.AbstractSearchAsyncAction.onPhaseDone(AbstractSearchAsyncAction.java:254) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.onShardFailure(InitialSearchPhase.java:101) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:48) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$2.lambda$onFailure$1(InitialSearchPhase.java:222) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:176) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase.access$000(InitialSearchPhase.java:48) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.InitialSearchPhase$2.onFailure(InitialSearchPhase.java:222) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.SearchExecutionStatsCollector.onFailure(SearchExecutionStatsCollector.java:73) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.ActionListenerResponseHandler.handleException(ActionListenerResponseHandler.java:51) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$ConnectionCountingHandler.handleException(SearchTransportService.java:526) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.transport.TransportService$ContextRestoreResponseHandler.handleException(TransportService.java:1068) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.processException(TransportService.java:1165) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.transport.TransportService$DirectResponseChannel.sendResponse(TransportService.java:1149) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.transport.TaskTransportChannel.sendResponse(TaskTransportChannel.java:66) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6$1.onFailure(SearchTransportService.java:384) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService$2.onFailure(SearchService.java:341) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:335) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:329) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService$3.doRun(SearchService.java:1019) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.4.1.jar:6.4.1]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1135) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:844) [?:?]\r\nCaused by: org.elasticsearch.ElasticsearchException: com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\r\n at [Source: java.io.StringReader@49bcb51e; line: 1, column: 4]\r\n\tat org.elasticsearch.ExceptionsHelper.convertToElastic(ExceptionsHelper.java:63) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.xpack.core.security.authz.accesscontrol.SecurityIndexSearcherWrapper.wrap(SecurityIndexSearcherWrapper.java:168) ~[?:?]\r\n\tat org.elasticsearch.index.shard.IndexSearcherWrapper.wrap(IndexSearcherWrapper.java:76) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:1199) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:1190) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createSearchContext(SearchService.java:616) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createSearchContext(SearchService.java:607) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createContext(SearchService.java:569) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:551) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:347) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\t... 9 more\r\nCaused by: com.fasterxml.jackson.core.JsonParseException: Unexpected character ('m' (code 109)): was expecting double-quote to start field name\r\n at [Source: java.io.StringReader@49bcb51e; line: 1, column: 4]\r\n\tat com.fasterxml.jackson.core.JsonParser._constructError(JsonParser.java:1702) ~[jackson-core-2.8.10.jar:2.8.10]\r\n\tat com.fasterxml.jackson.core.base.ParserMinimalBase._reportError(ParserMinimalBase.java:558) ~[jackson-core-2.8.10.jar:2.8.10]\r\n\tat com.fasterxml.jackson.core.base.ParserMinimalBase._reportUnexpectedChar(ParserMinimalBase.java:456) ~[jackson-core-2.8.10.jar:2.8.10]\r\n\tat com.fasterxml.jackson.core.json.ReaderBasedJsonParser._handleOddName(ReaderBasedJsonParser.java:1771) ~[jackson-core-2.8.10.jar:2.8.10]\r\n\tat com.fasterxml.jackson.core.json.ReaderBasedJsonParser.nextToken(ReaderBasedJsonParser.java:684) ~[jackson-core-2.8.10.jar:2.8.10]\r\n\tat org.elasticsearch.common.xcontent.json.JsonXContentParser.nextToken(JsonXContentParser.java:53) ~[elasticsearch-x-content-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.xpack.core.security.authz.accesscontrol.SecurityIndexSearcherWrapper.evaluateTemplate(SecurityIndexSearcherWrapper.java:268) ~[?:?]\r\n\tat org.elasticsearch.xpack.core.security.authz.accesscontrol.SecurityIndexSearcherWrapper.wrap(SecurityIndexSearcherWrapper.java:135) ~[?:?]\r\n\tat org.elasticsearch.index.shard.IndexSearcherWrapper.wrap(IndexSearcherWrapper.java:76) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:1199) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.index.shard.IndexShard.acquireSearcher(IndexShard.java:1190) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createSearchContext(SearchService.java:616) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createSearchContext(SearchService.java:607) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createContext(SearchService.java:569) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.createAndPutContext(SearchService.java:551) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:347) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\tat org.elasticsearch.search.SearchService$2.onResponse(SearchService.java:333) ~[elasticsearch-6.4.1.jar:6.4.1]\r\n\t... 9 more\r\n```\r\n\r\n","closed_by":{"login":"bizybot","id":902768,"node_id":"MDQ6VXNlcjkwMjc2OA==","avatar_url":"https://avatars2.githubusercontent.com/u/902768?v=4","gravatar_id":"","url":"https://api.github.com/users/bizybot","html_url":"https://github.com/bizybot","followers_url":"https://api.github.com/users/bizybot/followers","following_url":"https://api.github.com/users/bizybot/following{/other_user}","gists_url":"https://api.github.com/users/bizybot/gists{/gist_id}","starred_url":"https://api.github.com/users/bizybot/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bizybot/subscriptions","organizations_url":"https://api.github.com/users/bizybot/orgs","repos_url":"https://api.github.com/users/bizybot/repos","events_url":"https://api.github.com/users/bizybot/events{/privacy}","received_events_url":"https://api.github.com/users/bizybot/received_events","type":"User","site_admin":false},"performed_via_github_app":null}