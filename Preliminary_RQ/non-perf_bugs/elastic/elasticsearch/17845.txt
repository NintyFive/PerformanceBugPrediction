{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17845/events","html_url":"https://github.com/elastic/elasticsearch/issues/17845","id":149401161,"node_id":"MDU6SXNzdWUxNDk0MDExNjE=","number":17845,"title":"Java.lang.NullPointerException: Cannot get property ‘x’ on null object - when running a groovy script","user":{"login":"tpraizler","id":1968838,"node_id":"MDQ6VXNlcjE5Njg4Mzg=","avatar_url":"https://avatars2.githubusercontent.com/u/1968838?v=4","gravatar_id":"","url":"https://api.github.com/users/tpraizler","html_url":"https://github.com/tpraizler","followers_url":"https://api.github.com/users/tpraizler/followers","following_url":"https://api.github.com/users/tpraizler/following{/other_user}","gists_url":"https://api.github.com/users/tpraizler/gists{/gist_id}","starred_url":"https://api.github.com/users/tpraizler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tpraizler/subscriptions","organizations_url":"https://api.github.com/users/tpraizler/orgs","repos_url":"https://api.github.com/users/tpraizler/repos","events_url":"https://api.github.com/users/tpraizler/events{/privacy}","received_events_url":"https://api.github.com/users/tpraizler/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-04-19T09:22:54Z","updated_at":"2016-05-24T10:36:17Z","closed_at":"2016-05-24T10:36:17Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.0.0\n\n**JVM version**: Not sure - running on elastic cloud\n\n**OS version**: Not sure - running on elastic cloud\n\n**Description of the problem including expected versus actual behavior**:\nMy use case is trying to update a document simultaneously with 2  of the options of the update api, sometimes update fails and sometimes it is successful.\n\nI use a Transport client using elastic4s as my client.\n\nso my document looks like this:\n\n```\n{ \n   \"field\": {\n      \"names\": [\"A\",\"B\",\"C\"],\n      \"A\": { \"name\": \"A is awesome\" },\n      \"B\": { \"name\": \"B is awesome\" },\n      \"C\": { \"name\": \"C is awesome\" }\n   },\n   \"email\": \"x@gmail.com\"\n}\n```\n\nI am trying to update the names field with one request using inline script, and add another field under \"field\" with another request using the doc api. Those 2 requests are running simultaneously.\n\nSo here is my code:\n\n```\n  override def addTerms(String, terms: Set[String]) = {\n    val groovyScript =\n      s\"\"\"if (ctx._source.field.names== null)\n          |   ctx._source.field.names=newItems\n          |else\n          |   ctx._source.field.names<< newItems;\n          |ctx._source.field.names= ctx._source.field.names.flatten().unique();\"\"\".stripMargin\n    client.execute(ElasticDsl.update id id in indexName / documentType retryOnConflict 5 script {\n      script(groovyScript).params(Map(\"newItems\" -> terms.toArray))\n    })\n  }   \n\n  override def update(id: String, field: NestedFieldValue) = {\n    client.execute {\n      ElasticDsl.update(id) in indexName / documentType retryOnConflict 5 doc field\n    }\n  }\n```\n\nExecuting the above method in parallel fails, but when I run it sequentially it works.\nThis works: \n\n`update(id, field).flatMap(_ => addTerms(id, path, terms))`\n\n**Steps to reproduce**:\n1. Running the above methods in parallel fails with a NullPointerException coming from groovy engine.\n   So here is a piece of code:\n\n```\nfor{\n _ <- update(id, field)\n _ <- addTerms(id, path, terms)\n}yield{}\n\n```\n\n**Provide logs (if relevant)**:\n\n```\n\nCaused by: java.lang.IllegalArgumentException: failed to execute script \n   at org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:256) ~[org.elasticsearch.elasticsearch-2.0.1.jar:2.0.1] \n   at org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:196) ~[org.elasticsearch.elasticsearch-2.0.1.jar:2.0.1] \n   at org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:79) ~[org.elasticsearch.elasticsearch-2.0.1.jar:2.0.1] \n   at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:170) ~[org.elasticsearch.elasticsearch-2.0\n   at org.elasticsearch.action.update.TransportUpdateAction$3$1.doRun(TransportUpdateAction.java:227) ~[org.elasticsearch.elasticsearch-2.0.1.\n   at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[org.elasticsearch.elasticsearch-2.0.1.jar:2.0.1]\n   at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[na:1.8.0_74-cedar14] \n   at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[na:1.8.0_74-cedar14] \n   at java.lang.Thread.run(Thread.java:745) ~[na:1.8.0_74-cedar14] \n Caused by: org.elasticsearch.script.groovy.GroovyScriptExecutionException: failed to run inline script [if (ctx._source.field.names == null) \n     ctx._source.field.names=newItems \n  else \n     ctx._source.field.names<< newItems; \n     ctx._source.field.names = ctx._source.field.names.flatten().unique()] using lang [groovy] \n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:253) ~[org.elasticsearch.\n    at org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:251) ~[org.elasticsearch.elasticsearch-2.0.1.jar:2.0.1] \n    ... 8 common frames omitted \n  Caused by: java.lang.NullPointerException: Cannot get property 'names' on null object \n    at org.codehaus.groovy.runtime.NullObject.getProperty(NullObject.java:60) ~[org.codehaus.groovy.groovy-all-2.4.0.jar:2.4.0] \n    at org.codehaus.groovy.runtime.InvokerHelper.getProperty(InvokerHelper.java:172) ~[org.codehaus.groovy.groovy-all-2.4.0.jar:2.4.0] \n    at org.codehaus.groovy.runtime.callsite.NullCallSite.getProperty(NullCallSite.java:47) ~[org.codehaus.groovy.groovy-all-2.4.0.jar:2.4.0] \n    at org.codehaus.groovy.runtime.callsite.AbstractCallSite.callGetProperty(AbstractCallSite.java:296) ~[org.codehaus.groovy.groovy-all-2.4.0.\n    at 889babff0826c95e16279a9fb1fd2eb97a63e642.run(889babff0826c95e16279a9fb1fd2eb97a63e642:1) ~[na:na] \n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:248) ~[org.elasticsearch.\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}