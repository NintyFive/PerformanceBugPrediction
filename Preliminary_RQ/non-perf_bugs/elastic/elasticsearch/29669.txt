{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29669","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29669/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29669/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29669/events","html_url":"https://github.com/elastic/elasticsearch/issues/29669","id":317161034,"node_id":"MDU6SXNzdWUzMTcxNjEwMzQ=","number":29669,"title":"invalid_shape_exception for a valid geometry in the Arctic","user":{"login":"samuelbosch","id":306840,"node_id":"MDQ6VXNlcjMwNjg0MA==","avatar_url":"https://avatars2.githubusercontent.com/u/306840?v=4","gravatar_id":"","url":"https://api.github.com/users/samuelbosch","html_url":"https://github.com/samuelbosch","followers_url":"https://api.github.com/users/samuelbosch/followers","following_url":"https://api.github.com/users/samuelbosch/following{/other_user}","gists_url":"https://api.github.com/users/samuelbosch/gists{/gist_id}","starred_url":"https://api.github.com/users/samuelbosch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/samuelbosch/subscriptions","organizations_url":"https://api.github.com/users/samuelbosch/orgs","repos_url":"https://api.github.com/users/samuelbosch/repos","events_url":"https://api.github.com/users/samuelbosch/events{/privacy}","received_events_url":"https://api.github.com/users/samuelbosch/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false},"assignees":[{"login":"nknize","id":830187,"node_id":"MDQ6VXNlcjgzMDE4Nw==","avatar_url":"https://avatars3.githubusercontent.com/u/830187?v=4","gravatar_id":"","url":"https://api.github.com/users/nknize","html_url":"https://github.com/nknize","followers_url":"https://api.github.com/users/nknize/followers","following_url":"https://api.github.com/users/nknize/following{/other_user}","gists_url":"https://api.github.com/users/nknize/gists{/gist_id}","starred_url":"https://api.github.com/users/nknize/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/nknize/subscriptions","organizations_url":"https://api.github.com/users/nknize/orgs","repos_url":"https://api.github.com/users/nknize/repos","events_url":"https://api.github.com/users/nknize/events{/privacy}","received_events_url":"https://api.github.com/users/nknize/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-04-24T10:17:06Z","updated_at":"2018-04-24T11:34:50Z","closed_at":"2018-04-24T11:34:50Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.4\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): Oracle Corporation/OpenJDK 64-Bit Server VM/1.8.0_161/25.161-b14\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Centos 7\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nA query with a seemingly valid geometry in the Arctic is generating an error instead of returning results.\r\nThe issue manifests itself for us when you query the following API with a fairly simple geometry in the Arctic:\r\n\r\n[http://api2.iobis.org/occurrence?geometry=POLYGON ((-130 70, -180 89.9, -120 89.9, 19 89.6, -130 70))&after=-1&size=10](http://api2.iobis.org/occurrence?geometry=POLYGON%20((-130%2070,%20-180%2089.9,%20-120%2089.9,%2019%2089.6,%20-130%2070))&after=-1&size=10)\r\n\r\nMoving away from the dateline (e.g. -179 instead of -180) doesn't fix the issue.\r\n\r\n**Steps to reproduce**:\r\n\r\nI managed to reproduce the error with the docker image, these are the different steps command which result in the error:\r\n\r\n1) Pull and run docker image\r\n\r\n```\r\ndocker pull docker.elastic.co/elasticsearch/elasticsearch-oss:6.2.4\r\ndocker run -p 9200:9200 -p 9300:9300 -e \"discovery.type=single-node\" docker.elastic.co/elasticsearch/elasticsearch-oss:6.2.4\r\n```\r\n\r\n2) create mapping\r\n\r\n```\r\ncurl -X PUT \"localhost:9200/my_index\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"location\": {\r\n          \"type\": \"geo_shape\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n'\r\n```\r\n    \r\n3. Add a point\r\n\r\n```\r\ncurl -X PUT \"localhost:9200/my_index/_doc/4\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"type\": \"point\",\r\n  \"coordinates\": [ -71.34, 41.12 ] \r\n}\r\n'\r\n```\r\n\r\n4. Do the query with the failing polygon:\r\n\r\n```\r\ncurl -X GET \"localhost:9200/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n      \"query\": {\r\n        \"bool\": {\r\n          \"must\": [{\"bool\": {\"should\": []}},\r\n            {\r\n              \"geo_shape\": {\r\n                \"location\": {\r\n                  \"shape\": {\r\n                    \"type\": \"polygon\",\r\n                    \"coordinates\": [[[-130,70],[-180,89.9],[-120,89.9],[19,89.6],[-130,70]]]\r\n                  },\r\n                  \"relation\": \"within\"\r\n                }}}]}}}\r\n'\r\n```\r\n\r\nI noticed that the error is probably from the JavaTopologySuite and tried to reproduce it in turf.js,  which should be implemented in the same way, but I didn't succeed. For reference, here is the jsfiddle: https://jsfiddle.net/ftsm8sbd/ \r\n\r\n**Provide logs (if relevant)**:\r\n\r\nGenerated error:\r\n\r\n`{\"error\":{\"root_cause\":[{\"type\":\"query_shard_exception\",\"reason\":\"failed to create query: {\\n  \\\"bool\\\" : {\\n    \\\"must\\\" : [\\n      {\\n        \\\"match_all\\\" : {\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"geo_shape\\\" : {\\n          \\\"location\\\" : {\\n            \\\"shape\\\" : {\\n              \\\"type\\\" : \\\"polygon\\\",\\n              \\\"orientation\\\" : \\\"right\\\",\\n              \\\"coordinates\\\" : [\\n                [\\n                  [\\n                    230.0,\\n                    70.0\\n                  ],\\n                  [\\n                    180.0,\\n                    89.9\\n                  ],\\n                  [\\n                    240.0,\\n                    89.9\\n                  ],\\n                  [\\n                    19.0,\\n                    89.6\\n                  ],\\n                  [\\n                    230.0,\\n                    70.0\\n                  ]\\n                ]\\n              ]\\n            },\\n            \\\"relation\\\" : \\\"within\\\"\\n          },\\n          \\\"ignore_unmapped\\\" : false,\\n          \\\"boost\\\" : 1.0\\n        }\\n      }\\n    ],\\n    \\\"adjust_pure_negative\\\" : true,\\n    \\\"boost\\\" : 1.0\\n  }\\n}\",\"index_uuid\":\"jPS24A1DRGSOuWyCe5UBEg\",\"index\":\"my_index\"}],\"type\":\"search_phase_execution_exception\",\"reason\":\"all shards failed\",\"phase\":\"query\",\"grouped\":true,\"failed_shards\":[{\"shard\":0,\"index\":\"my_index\",\"node\":\"0BP8BRIgT7a6_MoiU0sIMw\",\"reason\":{\"type\":\"query_shard_exception\",\"reason\":\"failed to create query: {\\n  \\\"bool\\\" : {\\n    \\\"must\\\" : [\\n      {\\n        \\\"match_all\\\" : {\\n          \\\"boost\\\" : 1.0\\n        }\\n      },\\n      {\\n        \\\"geo_shape\\\" : {\\n          \\\"location\\\" : {\\n            \\\"shape\\\" : {\\n              \\\"type\\\" : \\\"polygon\\\",\\n              \\\"orientation\\\" : \\\"right\\\",\\n              \\\"coordinates\\\" : [\\n                [\\n                  [\\n                    230.0,\\n                    70.0\\n                  ],\\n                  [\\n                    180.0,\\n                    89.9\\n                  ],\\n                  [\\n                    240.0,\\n                    89.9\\n                  ],\\n                  [\\n                    19.0,\\n                    89.6\\n                  ],\\n                  [\\n                    230.0,\\n                    70.0\\n                  ]\\n                ]\\n              ]\\n            },\\n            \\\"relation\\\" : \\\"within\\\"\\n          },\\n          \\\"ignore_unmapped\\\" : false,\\n          \\\"boost\\\" : 1.0\\n        }\\n      }\\n    ],\\n    \\\"adjust_pure_negative\\\" : true,\\n    \\\"boost\\\" : 1.0\\n  }\\n}\",\"index_uuid\":\"jPS24A1DRGSOuWyCe5UBEg\",\"index\":\"my_index\",\"caused_by\":{\"type\":\"invalid_shape_exception\",\"reason\":\"Self-intersection at or near point (-179.79605248249447, 89.81882888803281, NaN)\"}}}]},\"status\":400}`","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}