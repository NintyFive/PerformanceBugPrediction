{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7554","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7554/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7554/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7554/events","html_url":"https://github.com/elastic/elasticsearch/issues/7554","id":41804155,"node_id":"MDU6SXNzdWU0MTgwNDE1NQ==","number":7554,"title":"Different queryNorm parameters over several shards during one request","user":{"login":"sck-v","id":1435744,"node_id":"MDQ6VXNlcjE0MzU3NDQ=","avatar_url":"https://avatars0.githubusercontent.com/u/1435744?v=4","gravatar_id":"","url":"https://api.github.com/users/sck-v","html_url":"https://github.com/sck-v","followers_url":"https://api.github.com/users/sck-v/followers","following_url":"https://api.github.com/users/sck-v/following{/other_user}","gists_url":"https://api.github.com/users/sck-v/gists{/gist_id}","starred_url":"https://api.github.com/users/sck-v/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sck-v/subscriptions","organizations_url":"https://api.github.com/users/sck-v/orgs","repos_url":"https://api.github.com/users/sck-v/repos","events_url":"https://api.github.com/users/sck-v/events{/privacy}","received_events_url":"https://api.github.com/users/sck-v/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"assignees":[{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2014-09-03T10:59:37Z","updated_at":"2014-09-06T18:47:15Z","closed_at":"2014-09-06T18:47:15Z","author_association":"NONE","active_lock_reason":null,"body":"Given: 5 shards, multi_match query with fuzziness set to `auto`.\nMapping has several names for each language(i.e. name_ru, name_en, name_fr etc).\n\n```\nquery: { \n    multi_match: {\n          fields: [\"name_*\"],\n          query: \"Марсель\",\n          fuzziness: :auto,\n          operator: :and,\n          prefix_length: 3\n    } \n}, \nsort: '_score', \nsearch_type: 'dfs_query_then_fetch'\n```\n\nQuery returns several results. Expected that the document with field containing value `Марсель` should get highest score. But highest score gets document with field containig value `Марсала`.\n\nDigging into explain result gives:\nfor `Марсель`:\n\n```\n \"_shard\" : 2,\n....(omitted)\n\"details\" : [ {\n            \"value\" : 6.5739636,\n            \"description\" : \"weight(name_ru:марсел in 3782) [PerFieldSimilarity], result of:\",\n            \"details\" : [ {\n              \"value\" : 6.5739636,\n              \"description\" : \"score(doc=3782,freq=1.0 = termFreq=1.0\\n), product of:\",\n              \"details\" : [ {\n                \"value\" : 0.6098557,\n                \"description\" : \"queryWeight, product of:\",\n                \"details\" : [ {\n                  \"value\" : 10.779539,\n                  \"description\" : \"idf(docFreq=1, maxDocs=35337)\"\n                }, {\n                  \"value\" : 0.056575306,\n                  \"description\" : \"queryNorm\"\n                } ]\n```\n\nfor `Марсала`:\n\n```\n \"_shard\" : 3,\n....(omitted)\n\"details\" : [ {\n            \"value\" : 7.622285,\n            \"description\" : \"weight(name_ru:марса^0.6 in 3827) [PerFieldSimilarity], result of:\",\n            \"details\" : [ {\n              \"value\" : 7.622285,\n              \"description\" : \"score(doc=3827,freq=1.0 = termFreq=1.0\\n), product of:\",\n              \"details\" : [ {\n                \"value\" : 0.70710677,\n                \"description\" : \"queryWeight, product of:\",\n                \"details\" : [ {\n                  \"value\" : 0.6,\n                  \"description\" : \"boost\"\n                }, {\n                  \"value\" : 10.779539,\n                  \"description\" : \"idf(docFreq=1, maxDocs=35337)\"\n                }, {\n                  \"value\" : 0.10932854,\n                  \"description\" : \"queryNorm\"\n                } ]\n              }, \n```\n\nAll other significant values are almost the same, but the difference within.\n\nI understand that every shard is an independent Lucene index, but is there any workaround to this issue except using single shard for that? \n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}