{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31051","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31051/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31051/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31051/events","html_url":"https://github.com/elastic/elasticsearch/issues/31051","id":328890758,"node_id":"MDU6SXNzdWUzMjg4OTA3NTg=","number":31051,"title":"Missing inner hits from collapse on query","user":{"login":"lukestephenson","id":395523,"node_id":"MDQ6VXNlcjM5NTUyMw==","avatar_url":"https://avatars3.githubusercontent.com/u/395523?v=4","gravatar_id":"","url":"https://api.github.com/users/lukestephenson","html_url":"https://github.com/lukestephenson","followers_url":"https://api.github.com/users/lukestephenson/followers","following_url":"https://api.github.com/users/lukestephenson/following{/other_user}","gists_url":"https://api.github.com/users/lukestephenson/gists{/gist_id}","starred_url":"https://api.github.com/users/lukestephenson/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/lukestephenson/subscriptions","organizations_url":"https://api.github.com/users/lukestephenson/orgs","repos_url":"https://api.github.com/users/lukestephenson/repos","events_url":"https://api.github.com/users/lukestephenson/events{/privacy}","received_events_url":"https://api.github.com/users/lukestephenson/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-06-04T02:40:57Z","updated_at":"2018-06-07T07:58:43Z","closed_at":"2018-06-07T07:58:43Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.2.4\r\n\r\n**Plugins installed**: [discovery-ec2, repository-s3]\r\n\r\n**JVM version** (`java -version`): as per docker.elastic.co/elasticsearch/elasticsearch:6.2.4\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):  as per docker.elastic.co/elasticsearch/elasticsearch:6.2.4\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\n\r\nWe have a search query which is making use of the collapse feature. We are occasionally seeing results where the returned inner_hits collection is empty. This shouldn't occur, because if there were no inner_hits then there was nothing to collapse on and return a search result.  The majority of our search results only collapse down to a single document / inner hit. Because of the complete absence of any inner_hits we detect this.  Note that if only 1 of multiple inner_hits was affected, we wouldn't detect it and I'm not sure if this has ever occurred.\r\n\r\nWhen this does occur (most searches are fine), the affected document returned has recently been updated. For example, we had this occur at 01/06/2018 09:56:21.000 and we also had the same document DELETED from the index within the same second (our logs only show second precision, so not sure exactly how close). Note that from looking at our logs, it's not just DELETEs, but also UPSERTs which can trigger this issue.\r\n\r\nThis only affects a very small percentage of our searches currently (4 out of 2.8 million), so it's not a massive issue for us, but still wanted to advise. We haven't gone to the effort of creating a stand alone reproducible test case at this stage.\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}