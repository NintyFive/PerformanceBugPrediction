{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29363","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29363/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29363/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29363/events","html_url":"https://github.com/elastic/elasticsearch/issues/29363","id":311156122,"node_id":"MDU6SXNzdWUzMTExNTYxMjI=","number":29363,"title":"QueryAnalyzerTests failing since recent commit","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"labels":[{"id":156502592,"node_id":"MDU6TGFiZWwxNTY1MDI1OTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Percolator","name":":Search/Percolator","color":"0e8a16","default":false,"description":"Reverse search: find queries that match a document"},{"id":60445228,"node_id":"MDU6TGFiZWw2MDQ0NTIyOA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest","name":">test","color":"5319e7","default":false,"description":"Issues or PRs that are addressing/adding tests"}],"state":"closed","locked":false,"assignee":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"assignees":[{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2018-04-04T09:39:30Z","updated_at":"2018-04-04T11:09:50Z","closed_at":"2018-04-04T11:09:50Z","author_association":"MEMBER","active_lock_reason":null,"body":"This is from another PR CI failure:\r\n\r\n```\r\nREPRODUCE WITH: ./gradlew :modules:percolator:test -Dtests.seed=56E400870DFCE81C -Dtests.class=org.elasticsearch.percolator.QueryAnalyzerTests -Dtests.method=\"testExactMatch_booleanQuery\" -Dtests.security.manager=true -Dtests.locale=zh-HK -Dtests.timezone=America/Argentina/Catamarca\r\nFAILURE 0.09s | QueryAnalyzerTests.testExactMatch_booleanQuery <<< FAILURES!\r\n   > Throwable #1: java.lang.AssertionError: msm is at least two so result.minimumShouldMatch should 2 too\r\n   > Expected: <2>\r\n   >      but: was <1>\r\n   >    at __randomizedtesting.SeedInfo.seed([56E400870DFCE81C:3EFE623A852957C5]:0)\r\n   >    at org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n   >    at org.elasticsearch.percolator.QueryAnalyzerTests.testExactMatch_booleanQuery(QueryAnalyzerTests.java:426)\r\n   >    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n   >    at java.base/jdk.internal.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n   >    at java.base/jdk.internal.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n   >    at java.base/java.lang.reflect.Method.invoke(Method.java:564)\r\n   >    at java.base/java.lang.Thread.run(Thread.java:844)\r\n  2> NOTE: leaving temporary files on disk at: /home/jason/src/elastic/elasticsearch/modules/percolator/build/testrun/test/J0/temp/org.elasticsearch.percolator.QueryAnalyzerTests_56E400870DFCE81C-001\r\n  2> NOTE: test params are: codec=Asserting(Lucene70): {}, docValues:{}, maxPointsInLeafNode=395, maxMBSortInHeap=7.800278966437485, sim=RandomSimilarity(queryNorm=false): {}, locale=zh-HK, timezone=America/Argentina/Catamarca\r\n  2> NOTE: Linux 4.15.13-300.fc27.x86_64 amd64/Oracle Corporation 10 (64-bit)/cpus=20,threads=1,free=509509512,total=536870912\r\n  2> NOTE: All tests run in this JVM: [QueryAnalyzerTests]\r\nCompleted [1/1] in 0.69s, 1 test, 1 failure <<< FAILURES!\r\n```\r\n\r\nFrom `git bisect`, it looks like the culprit is:\r\n\r\n```\r\n05:37:27 3d [jason@totoro:~/src/elastic/elasticsearch] dc1c16964a+ Â± git bisect good\r\n8cdd950056b722e7086f48fb84cf6c29ccf31bd3 is the first bad commit\r\ncommit 8cdd950056b722e7086f48fb84cf6c29ccf31bd3\r\nAuthor: Adrien Grand <jpountz@gmail.com>\r\nDate:   Tue Apr 3 16:44:26 2018 +0200\r\n\r\n    Fix some query extraction bugs. (#29283)\r\n    \r\n    While playing with the percolator I found two bugs:\r\n     - Sometimes we set a min_should_match that is greater than the number of\r\n       extractions. While this doesn't cause direct trouble, it does when the query\r\n       is nested into a boolean query and the boolean query tries to compute the\r\n       min_should_match for the entire query based on its own min_should_match and\r\n       those of the sub queries. So I changed the code to throw an exception when\r\n       min_should_match is greater than the number of extractions.\r\n     - Boolean queries claim matches are verified when in fact they shouldn't. This\r\n       is due to the fact that boolean queries assume that they are verified if all\r\n       sub clauses are verified but things are more complex than that, eg.\r\n       conjunctions that are nested in a disjunction or disjunctions that are nested\r\n       in a conjunction can generally not be verified without running the query.\r\n\r\n:040000 040000 bf10fc4198e43c17d96bf55329f397a91f3f72b1 ad69b9119d00655673aae59b72139d986bd00ab1 M\tmodules\r\n```","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}