{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33461","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33461/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33461/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33461/events","html_url":"https://github.com/elastic/elasticsearch/issues/33461","id":357592430,"node_id":"MDU6SXNzdWUzNTc1OTI0MzA=","number":33461,"title":"SQL: negative numbers are treated as ALIAS instead of literals in functions","user":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2018-09-06T10:26:55Z","updated_at":"2018-10-25T17:08:54Z","closed_at":"2018-09-12T22:11:23Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"For functions that have parameters numerics, a negative number is not treated properly. Example, the `power` function, and always using one of the other parameters a field: `select power(salary,-1) from test_emp;` gives the following stacktrace:\r\n\r\n```\r\nsql> select power(salary,-1) from test_emp;\r\nServer error [Server encountered an error [org.elasticsearch.xpack.sql.expression.LiteralAttribute cannot be cast to org.elasticsearch.xpack.sql.expression.FieldAttribute]. [java.lang.ClassCastException: org.elasticsearch.xpack.sql.expression.LiteralAttribute cannot be cast to org.elasticsearch.xpack.sql.expression.FieldAttribute\r\n        at org.elasticsearch.xpack.sql.expression.function.scalar.ScalarFunction.asScript(ScalarFunction.java:72)\r\n        at org.elasticsearch.xpack.sql.expression.function.scalar.BinaryScalarFunction.asScript(BinaryScalarFunction.java:51)\r\n        at org.elasticsearch.xpack.sql.expression.function.scalar.ScalarFunction.toAttribute(ScalarFunction.java:49)\r\n        at org.elasticsearch.xpack.sql.planner.QueryFolder$FoldProject.rule(QueryFolder.java:140)\r\n        at org.elasticsearch.xpack.sql.planner.QueryFolder$FoldProject.rule(QueryFolder.java:106)\r\n        at org.elasticsearch.xpack.sql.tree.Node.lambda$transformUp$11(Node.java:188)\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformUp(Node.java:182)\r\n        at org.elasticsearch.xpack.sql.tree.Node.transformUp(Node.java:188)\r\n        at org.elasticsearch.xpack.sql.planner.QueryFolder$FoldingRule.apply(QueryFolder.java:548)\r\n        at org.elasticsearch.xpack.sql.planner.QueryFolder$FoldingRule.apply(QueryFolder.java:544)\r\n        at org.elasticsearch.xpack.sql.rule.RuleExecutor$Transformation.<init>(RuleExecutor.java:82)\r\n        at org.elasticsearch.xpack.sql.rule.RuleExecutor.executeWithInfo(RuleExecutor.java:155)\r\n        at org.elasticsearch.xpack.sql.rule.RuleExecutor.execute(RuleExecutor.java:130)\r\n        at org.elasticsearch.xpack.sql.planner.QueryFolder.fold(QueryFolder.java:81)\r\n        at org.elasticsearch.xpack.sql.planner.Planner.foldPlan(Planner.java:38)\r\n        at org.elasticsearch.xpack.sql.planner.Planner.plan(Planner.java:28)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.lambda$physicalPlan$4(SqlSession.java:147)\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.lambda$optimizedPlan$3(SqlSession.java:143)\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.lambda$preAnalyze$2(SqlSession.java:131)\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60)\r\n        at org.elasticsearch.xpack.sql.analysis.index.IndexResolver.lambda$resolveWithSameMapping$3(IndexResolver.java:243)\r\n        at org.elasticsearch.action.ActionListener$1.onResponse(ActionListener.java:60)\r\n        at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:66)\r\n        at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:62)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$1.onResponse(TransportMasterNodeAction.java:172)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$1.onResponse(TransportMasterNodeAction.java:169)\r\n        at org.elasticsearch.action.admin.indices.get.TransportGetIndexAction.doMasterOperation(TransportGetIndexAction.java:142)\r\n        at org.elasticsearch.action.admin.indices.get.TransportGetIndexAction.doMasterOperation(TransportGetIndexAction.java:50)\r\n        at org.elasticsearch.action.support.master.info.TransportClusterInfoAction.masterOperation(TransportClusterInfoAction.java:52)\r\n        at org.elasticsearch.action.support.master.info.TransportClusterInfoAction.masterOperation(TransportClusterInfoAction.java:34)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:109)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:189)\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\r\n        at org.elasticsearch.common.util.concurrent.EsExecutors$1.execute(EsExecutors.java:135)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.doStart(TransportMasterNodeAction.java:186)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction.start(TransportMasterNodeAction.java:142)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction.doExecute(TransportMasterNodeAction.java:120)\r\n        at org.elasticsearch.action.support.master.TransportMasterNodeAction.doExecute(TransportMasterNodeAction.java:56)\r\n        at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:143)\r\n        at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:119)\r\n        at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:62)\r\n        at org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83)\r\n        at org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72)\r\n        at org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:388)\r\n        at org.elasticsearch.client.support.AbstractClient$IndicesAdmin.execute(AbstractClient.java:1236)\r\n        at org.elasticsearch.client.support.AbstractClient$IndicesAdmin.getIndex(AbstractClient.java:1331)\r\n        at org.elasticsearch.xpack.sql.analysis.index.IndexResolver.resolveWithSameMapping(IndexResolver.java:226)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.preAnalyze(SqlSession.java:130)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.analyzedPlan(SqlSession.java:96)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.optimizedPlan(SqlSession.java:143)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.physicalPlan(SqlSession.java:147)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.sqlExecutable(SqlSession.java:156)\r\n        at org.elasticsearch.xpack.sql.session.SqlSession.sql(SqlSession.java:151)\r\n        at org.elasticsearch.xpack.sql.execution.PlanExecutor.sql(PlanExecutor.java:72)\r\n        at org.elasticsearch.xpack.sql.plugin.TransportSqlQueryAction.operation(TransportSqlQueryAction.java:65)\r\n        at org.elasticsearch.xpack.sql.plugin.TransportSqlQueryAction.doExecute(TransportSqlQueryAction.java:52)\r\n        at org.elasticsearch.xpack.sql.plugin.TransportSqlQueryAction.doExecute(TransportSqlQueryAction.java:35)\r\n        at org.elasticsearch.action.support.TransportAction$RequestFilterChain.proceed(TransportAction.java:143)\r\n        at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:119)\r\n        at org.elasticsearch.action.support.TransportAction.execute(TransportAction.java:62)\r\n        at org.elasticsearch.client.node.NodeClient.executeLocally(NodeClient.java:83)\r\n        at org.elasticsearch.client.node.NodeClient.doExecute(NodeClient.java:72)\r\n        at org.elasticsearch.client.support.AbstractClient.execute(AbstractClient.java:388)\r\n        at org.elasticsearch.xpack.sql.plugin.RestSqlQueryAction.lambda$prepareRequest$0(RestSqlQueryAction.java:84)\r\n        at org.elasticsearch.rest.BaseRestHandler.handleRequest(BaseRestHandler.java:97)\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:239)\r\n        at org.elasticsearch.rest.RestController.tryAllHandlers(RestController.java:336)\r\n        at org.elasticsearch.rest.RestController.dispatchRequest(RestController.java:173)\r\n        at org.elasticsearch.http.AbstractHttpServerTransport.dispatchRequest(AbstractHttpServerTransport.java:323)\r\n        at org.elasticsearch.http.AbstractHttpServerTransport.handleIncomingRequest(AbstractHttpServerTransport.java:373)\r\n        at org.elasticsearch.http.AbstractHttpServerTransport.incomingRequest(AbstractHttpServerTransport.java:302)\r\n        at org.elasticsearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:66)\r\n        at org.elasticsearch.http.netty4.Netty4HttpRequestHandler.channelRead0(Netty4HttpRequestHandler.java:31)\r\n        at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at org.elasticsearch.http.netty4.Netty4HttpPipeliningHandler.channelRead(Netty4HttpPipeliningHandler.java:58)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102)\r\n        at io.netty.handler.codec.MessageToMessageCodec.channelRead(MessageToMessageCodec.java:111)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:102)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.codec.ByteToMessageDecoder.fireChannelRead(ByteToMessageDecoder.java:310)\r\n        at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:284)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.handler.timeout.IdleStateHandler.channelRead(IdleStateHandler.java:286)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340)\r\n        at io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1434)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362)\r\n        at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348)\r\n        at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:965)\r\n        at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:163)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:646)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:546)\r\n        at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:500)\r\n        at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:460)\r\n        at io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:884)\r\n        at java.base/java.lang.Thread.run(Thread.java:844)\r\n]]\r\n```","closed_by":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}