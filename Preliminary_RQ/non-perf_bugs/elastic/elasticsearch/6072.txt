{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/6072","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6072/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6072/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/6072/events","html_url":"https://github.com/elastic/elasticsearch/issues/6072","id":32963074,"node_id":"MDU6SXNzdWUzMjk2MzA3NA==","number":6072,"title":"Force awarness shards wrong assignment","user":{"login":"yu55","id":1789867,"node_id":"MDQ6VXNlcjE3ODk4Njc=","avatar_url":"https://avatars3.githubusercontent.com/u/1789867?v=4","gravatar_id":"","url":"https://api.github.com/users/yu55","html_url":"https://github.com/yu55","followers_url":"https://api.github.com/users/yu55/followers","following_url":"https://api.github.com/users/yu55/following{/other_user}","gists_url":"https://api.github.com/users/yu55/gists{/gist_id}","starred_url":"https://api.github.com/users/yu55/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/yu55/subscriptions","organizations_url":"https://api.github.com/users/yu55/orgs","repos_url":"https://api.github.com/users/yu55/repos","events_url":"https://api.github.com/users/yu55/events{/privacy}","received_events_url":"https://api.github.com/users/yu55/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2014-05-07T07:58:59Z","updated_at":"2018-02-13T19:28:51Z","closed_at":"2016-11-25T17:47:55Z","author_association":"NONE","active_lock_reason":null,"body":"We try to index large database data in our company and we encouter some reliability problems with elasticsearch 1.1.0 and 1.1.1. When we use force awarness option elasticsearch has problems with proper shards allocation and we loose access to some or whole index data.\n\nBelow steps to reproduce bug:\n1. Prepare two separate linux machines called DC2 and DC4 connected via LAN.\n2. On machine DC2 unzip 4 separate instances of elasticsearch 1.1.1 with following configuration:\n   \n   elastic 1:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC2\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC2_1\n   \n   elastic 2:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC2\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC2_2\n   \n   elastic 3:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC2\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC2_3\n   \n   elastic 4:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC2\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC2_4\n3. On machine DC4 unzip 4 separate instances of elasticsearch 1.1.1 with following configuration:\n   \n   elastic 1:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC4\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC4_1\n   \n   elastic 2:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC4\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC4_2\n   \n   elastic 3:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC4\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC4_3\n   \n   elastic 4:\n   cluster.routing.allocation.awareness.force.zone.values: DC2,DC4\n   node.zone: DC4\n   cluster.routing.allocation.awareness.attributes: zone\n   node.name: DC4_4\n4. Start all elastics on DC2. 4-node cluster forms properly.\n   ![01_empty_dc2_start](https://cloud.githubusercontent.com/assets/1789867/2899770/59ce842c-d5bc-11e3-8ac2-94666fcdd1c5.png)\n5. Start all elastics on DC4. 8-node cluster forms properly.\n   ![02_empty_dc2_start](https://cloud.githubusercontent.com/assets/1789867/2899787/ac919bae-d5bc-11e3-8d57-970e4149e067.png)\n6. Create new empty index (5 shards, 3 replicas). Shards are spread properly across nodes.\n   ![03_dc2_up_dc4_up_create_index](https://cloud.githubusercontent.com/assets/1789867/2899788/b2dc9982-d5bc-11e3-87cf-ce19791a2a14.png)\n7. Shutdown all elastics on DC4.\n   PROBLEM: All shards are assigned to all elastics on DC2. According to force awarness configuration only half of them should be assigned. Shards from DC4 should be unassigned.\n   ![04_shutdown_dc4_wrong_assignment](https://cloud.githubusercontent.com/assets/1789867/2899793/c49d0044-d5bc-11e3-8396-ac09a89451c7.png)\n8. Shutdown all elastics on DC2.\n9. Start all elastics on DC2.\n   PROBLEM: All shards are assigned to all elastics on DC2. According to force awarness configuration only half of them should be assigned. Shards from DC4 should be unassigned.\n   ![05_start_only_dc2_wrong_assignment](https://cloud.githubusercontent.com/assets/1789867/2899802/d9a37bda-d5bc-11e3-98e7-fb53e22ff9ad.png)\n10. Shutdown all elastics on DC2.\n11. Start all elastics on DC4.\n    PROBLEM: All shards are unassigned. According to force awarness configuration half of them should be assigned. Shards from DC2 should be unassigned.\n    ![06_start_only_dc4_wrong_assignment](https://cloud.githubusercontent.com/assets/1789867/2899804/e64738d6-d5bc-11e3-8031-e5b2f2f0a8e7.png)\n12. Start all elastics on DC2 - all shards are assigned properly.\n\nProblems in steps 7-11 occure all the time in this index. Sometimes (other but similar index) all shards are unassgined in steps 7 and 9 (just like in step 11).\n\nWhen shards cannot be assign following lines in log occures:\n[2014-05-07 08:21:23,787][DEBUG][gateway.local            ] [DC4_1] [some_index][3]: not allocating, number_of_allocated_shards_found [1], required_number [3]\n[2014-05-07 08:21:23,787][DEBUG][gateway.local            ] [DC4_1] [some_index][0]: not allocating, number_of_allocated_shards_found [1], required_number [3]\n[2014-05-07 08:21:23,787][DEBUG][gateway.local            ] [DC4_1] [some_index][1]: not allocating, number_of_allocated_shards_found [0], required_number [3]\n[2014-05-07 08:21:23,787][DEBUG][gateway.local            ] [DC4_1] [some_index][4]: not allocating, number_of_allocated_shards_found [0], required_number [3]\n[2014-05-07 08:21:23,787][DEBUG][gateway.local            ] [DC4_1] [some_index][2]: not allocating, number_of_allocated_shards_found [1], required_number [3]\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}