{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/49695","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49695/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49695/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/49695/events","html_url":"https://github.com/elastic/elasticsearch/issues/49695","id":530044253,"node_id":"MDU6SXNzdWU1MzAwNDQyNTM=","number":49695,"title":"Bug report: Indexing a list of floats in a painless script seems to access the elements in sorted order","user":{"login":"alexklibisz","id":8015228,"node_id":"MDQ6VXNlcjgwMTUyMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/8015228?v=4","gravatar_id":"","url":"https://api.github.com/users/alexklibisz","html_url":"https://github.com/alexklibisz","followers_url":"https://api.github.com/users/alexklibisz/followers","following_url":"https://api.github.com/users/alexklibisz/following{/other_user}","gists_url":"https://api.github.com/users/alexklibisz/gists{/gist_id}","starred_url":"https://api.github.com/users/alexklibisz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexklibisz/subscriptions","organizations_url":"https://api.github.com/users/alexklibisz/orgs","repos_url":"https://api.github.com/users/alexklibisz/repos","events_url":"https://api.github.com/users/alexklibisz/events{/privacy}","received_events_url":"https://api.github.com/users/alexklibisz/received_events","type":"User","site_admin":false},"labels":[{"id":141145460,"node_id":"MDU6TGFiZWwxNDExNDU0NjA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Mapping","name":":Search/Mapping","color":"0e8a16","default":false,"description":"How fields should be indexed"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2019-11-28T18:41:12Z","updated_at":"2019-12-01T04:08:02Z","closed_at":"2019-12-01T04:08:02Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): \r\n\r\n```\r\n# bin/elasticsearch -version\r\nOpenJDK 64-Bit Server VM warning: Option UseConcMarkSweepGC was deprecated in version 9.0 and will likely be removed in a future release.\r\nVersion: 7.4.0, Build: default/docker/22e1767283e61a198cb4db791ea66e3f11ab9910/2019-09-27T08:36:48.569419Z, JVM: 13\r\n```\r\n\r\n**Plugins installed**: No plugins installed\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\nopenjdk version \"13\" 2019-09-17\r\nOpenJDK Runtime Environment AdoptOpenJDK (build 13+33)\r\nOpenJDK 64-Bit Server VM AdoptOpenJDK (build 13+33, mixed mode, sharing)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n```\r\nLinux 27024d91b217 5.0.0-36-generic #39-Ubuntu SMP Tue Nov 12 09:46:06 UTC 2019 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI am running the elasticsearch and kibana 7.4.0 docker containers locally. \r\n\r\nI am storing a list of floats (i.e. a \"vector\") in each document. I have a script score query with a painless script that loops through the vector and does some computation to return a score. I was getting some incorrect results, and after some experimenting I found that indexing into the list seems to access the elements in sorted order, not in the order in which they were indexed. Perhaps this is intended behavior, but it's certainly surprising. I also wonder whether sorting the vectors could make indexing slower, but this is a lesser concern.\r\n\r\n**Steps to reproduce**:\r\n\r\nHere are the exact requests you should run to reproduce the issue. I think it's easiest to run them from the kibana console. You could just copy them into the kibana console, highlight them, and run them all.\r\n\r\n```\r\n# Delete and re-create index.\r\nDELETE vectors\r\nPUT vectors\r\n\r\n# Store a vector already in sorted order\r\nPUT vectors/_doc/sorted\r\n{\r\n  \"values\": [0.123,0.234,0.345]\r\n}\r\n\r\n# Store a vector not in sorted order.\r\nPUT vectors/_doc/unsorted\r\n{\r\n  \"values\": [0.333,0.111,0.222]\r\n}\r\n\r\n# Refresh the index before searching\r\nPOST vectors/_refresh\r\n\r\n# Run a scripted search that just returns the 0th element.\r\nGET vectors/_search\r\n{\r\n  \"query\": {\r\n    \"script_score\": {\r\n      \"query\": {\r\n        \"exists\": {\r\n          \"field\": \"values\"\r\n        }\r\n      },\r\n      \"script\": {\r\n        \"source\": \"return doc['values'][0];\",\r\n        \"lang\": \"painless\"\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nHere is the result for the last search request. Notice:\r\n- good: each list of values is returned in the correct order\r\n- good: the score for the sorted document is 0.123, which is the 0th (and smallest) element\r\n- **bad**: the score for the unsorted document is 0.111, the smallest element, but not the 0th. It should have been 0.333.\r\n\r\n```\r\n{\r\n  \"took\" : 1,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 1,\r\n    \"successful\" : 1,\r\n    \"skipped\" : 0,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : {\r\n      \"value\" : 2,\r\n      \"relation\" : \"eq\"\r\n    },\r\n    \"max_score\" : 0.123,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"vectors\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"sorted\",\r\n        \"_score\" : 0.123,\r\n        \"_source\" : {\r\n          \"values\" : [\r\n            0.123,\r\n            0.234,\r\n            0.345\r\n          ]\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"vectors\",\r\n        \"_type\" : \"_doc\",\r\n        \"_id\" : \"unsorted\",\r\n        \"_score\" : 0.111,\r\n        \"_source\" : {\r\n          \"values\" : [\r\n            0.333,\r\n            0.111,\r\n            0.222\r\n          ]\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"alexklibisz","id":8015228,"node_id":"MDQ6VXNlcjgwMTUyMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/8015228?v=4","gravatar_id":"","url":"https://api.github.com/users/alexklibisz","html_url":"https://github.com/alexklibisz","followers_url":"https://api.github.com/users/alexklibisz/followers","following_url":"https://api.github.com/users/alexklibisz/following{/other_user}","gists_url":"https://api.github.com/users/alexklibisz/gists{/gist_id}","starred_url":"https://api.github.com/users/alexklibisz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexklibisz/subscriptions","organizations_url":"https://api.github.com/users/alexklibisz/orgs","repos_url":"https://api.github.com/users/alexklibisz/repos","events_url":"https://api.github.com/users/alexklibisz/events{/privacy}","received_events_url":"https://api.github.com/users/alexklibisz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}