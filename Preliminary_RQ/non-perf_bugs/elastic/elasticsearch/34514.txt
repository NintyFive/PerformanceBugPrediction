{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34514","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34514/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34514/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34514/events","html_url":"https://github.com/elastic/elasticsearch/issues/34514","id":370574320,"node_id":"MDU6SXNzdWUzNzA1NzQzMjA=","number":34514,"title":"[CI] SSLException: Received close_notify during handshake","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"labels":[{"id":912838655,"node_id":"MDU6TGFiZWw5MTI4Mzg2NTU=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Network","name":":Security/Network","color":"0e8a16","default":false,"description":"SSL/TLS, Security for NIO/Netty"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1104249379,"node_id":"MDU6TGFiZWwxMTA0MjQ5Mzc5","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.4","name":"v6.4.4","color":"Dddddd","default":false,"description":""},{"id":1194435738,"node_id":"MDU6TGFiZWwxMTk0NDM1NzM4","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v8.0.0","name":"v8.0.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2018-10-16T11:52:45Z","updated_at":"2019-06-14T16:48:37Z","closed_at":"2019-06-14T16:48:37Z","author_association":"MEMBER","active_lock_reason":null,"body":"https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.4+multijob-windows-compatibility/64/consoleFull has failed with:\r\n\r\n```\r\n12:42:32   1> io.netty.handler.codec.DecoderException: javax.net.ssl.SSLException: Received close_notify during handshake\r\n12:42:32   1> \tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:459) ~[netty-codec-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:265) ~[netty-codec-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:340) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.DefaultChannelPipeline$HeadContext.channelRead(DefaultChannelPipeline.java:1359) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:362) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:348) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:935) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:134) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:645) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.nio.NioEventLoop.processSelectedKeysPlain(NioEventLoop.java:545) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:499) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:459) [netty-transport-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.util.concurrent.SingleThreadEventExecutor$5.run(SingleThreadEventExecutor.java:858) [netty-common-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat java.lang.Thread.run(Thread.java:748) [?:1.8.0_181]\r\n12:42:32   1> Caused by: javax.net.ssl.SSLException: Received close_notify during handshake\r\n12:42:32   1> \tat sun.security.ssl.Alerts.getSSLException(Alerts.java:208) ~[?:?]\r\n12:42:32   1> \tat sun.security.ssl.SSLEngineImpl.fatal(SSLEngineImpl.java:1666) ~[?:?]\r\n12:42:32   1> \tat sun.security.ssl.SSLEngineImpl.fatal(SSLEngineImpl.java:1634) ~[?:?]\r\n12:42:32   1> \tat sun.security.ssl.SSLEngineImpl.recvAlert(SSLEngineImpl.java:1776) ~[?:?]\r\n12:42:32   1> \tat sun.security.ssl.SSLEngineImpl.readRecord(SSLEngineImpl.java:1083) ~[?:?]\r\n12:42:32   1> \tat sun.security.ssl.SSLEngineImpl.readNetRecord(SSLEngineImpl.java:907) ~[?:?]\r\n12:42:32   1> \tat sun.security.ssl.SSLEngineImpl.unwrap(SSLEngineImpl.java:781) ~[?:?]\r\n12:42:32   1> \tat javax.net.ssl.SSLEngine.unwrap(SSLEngine.java:624) ~[?:1.8.0_181]\r\n12:42:32   1> \tat io.netty.handler.ssl.SslHandler$SslEngineType$3.unwrap(SslHandler.java:281) ~[netty-handler-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.handler.ssl.SslHandler.unwrap(SslHandler.java:1215) ~[netty-handler-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.handler.ssl.SslHandler.decodeJdkCompatible(SslHandler.java:1127) ~[netty-handler-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.handler.ssl.SslHandler.decode(SslHandler.java:1162) ~[netty-handler-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.handler.codec.ByteToMessageDecoder.decodeRemovalReentryProtection(ByteToMessageDecoder.java:489) ~[netty-codec-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \tat io.netty.handler.codec.ByteToMessageDecoder.callDecode(ByteToMessageDecoder.java:428) ~[netty-codec-4.1.16.Final.jar:4.1.16.Final]\r\n12:42:32   1> \t... 15 more\r\n```\r\n\r\nreproduction line of the build above with build id `20181016071459-6169C3F9 (does not reproduce locally):\r\n\r\n```\r\ngradlew :x-pack:qa:tribe-tests-with-security:test \\\r\n  -Dtests.seed=E96200A29197A00B \\\r\n  -Dtests.class=org.elasticsearch.xpack.security.SecurityTribeTests \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=de-LU \\\r\n  -Dtests.timezone=Australia/Tasmania\r\n```\r\n\r\nreproduction line of build id `20181008232140-2FF07565 (does not reproduce locally): \r\n\r\n```\r\n./gradlew :x-pack:plugin:security:test \\\r\n  -Dtests.seed=103C6D419C2C4438 \\\r\n  -Dtests.class=org.elasticsearch.xpack.security.transport.netty4.SimpleSecurityNetty4ServerTransportTests \\\r\n  -Dtests.method=\"testSendRandomRequests\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=sq \\\r\n  -Dtests.timezone=MST7MDT \\\r\n  -Dcompiler.java=11 \\\r\n  -Druntime.java=8\r\n```\r\n\r\nreproduction line of build id `20181007194343-B582AB07` (does not reproduce locally):\r\n\r\n``` \r\n/gradlew :x-pack:qa:tribe-tests-with-security:test \\\r\n  -Dtests.seed=E256452AFB8FDE46 \\\r\n  -Dtests.class=org.elasticsearch.xpack.security.SecurityTribeTests \\\r\n  -Dtests.method=\"testRetrieveRolesOnTribeNode\" \\\r\n  -Dtests.security.manager=true \\\r\n  -Dtests.locale=lv-LV \\\r\n  -Dtests.timezone=Africa/Nouakchott\r\n``` \r\n\r\nSo far we have the following build ids that failed with this error:\r\n\r\n| build id                | JDK version | OS / Distro    | branch | \r\n|-------------------------|-------------|----------------|--------| \r\n| 20181016071459-6169C3F9 | 10+46       | Windows 2012   | 6.4    | \r\n| 20181010113501-73ECBC82 | 10+46       | Oracle Linux 7 | 6.4    | \r\n| 20181008232140-2FF07565 | 8           | Ubuntu 16.04   | master | \r\n| 20181007194343-B582AB07 | 10+46       | CentOS 7       | 6.4    | \r\n\r\n\r\nThis exception is raised when a sender sends `close_notify` to the recipient to indicate it will not send\r\n any more messages on this connection (see also [RFC5246](https://tools.ietf.org/html/rfc5246#section-7.2.1)). The question is why this happens during the SSL handshake.\r\n \r\nI wonder whether this could be caused by a similar issue in Netty as addressed in https://github.com/elastic/elasticsearch/pull/30337 although I did not find anything related in recent Netty tickets. From the mix of failures on different operating systems I think we can rule out the OS.","closed_by":{"login":"jaymode","id":4339958,"node_id":"MDQ6VXNlcjQzMzk5NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/4339958?v=4","gravatar_id":"","url":"https://api.github.com/users/jaymode","html_url":"https://github.com/jaymode","followers_url":"https://api.github.com/users/jaymode/followers","following_url":"https://api.github.com/users/jaymode/following{/other_user}","gists_url":"https://api.github.com/users/jaymode/gists{/gist_id}","starred_url":"https://api.github.com/users/jaymode/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jaymode/subscriptions","organizations_url":"https://api.github.com/users/jaymode/orgs","repos_url":"https://api.github.com/users/jaymode/repos","events_url":"https://api.github.com/users/jaymode/events{/privacy}","received_events_url":"https://api.github.com/users/jaymode/received_events","type":"User","site_admin":false},"performed_via_github_app":null}