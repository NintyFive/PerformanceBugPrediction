{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27103","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27103/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27103/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27103/events","html_url":"https://github.com/elastic/elasticsearch/issues/27103","id":268166488,"node_id":"MDU6SXNzdWUyNjgxNjY0ODg=","number":27103,"title":"have an query/aggregation execution plan and avoid dispatch requests to nodes/shards whenever is possibl","user":{"login":"rcrezende","id":604872,"node_id":"MDQ6VXNlcjYwNDg3Mg==","avatar_url":"https://avatars1.githubusercontent.com/u/604872?v=4","gravatar_id":"","url":"https://api.github.com/users/rcrezende","html_url":"https://github.com/rcrezende","followers_url":"https://api.github.com/users/rcrezende/followers","following_url":"https://api.github.com/users/rcrezende/following{/other_user}","gists_url":"https://api.github.com/users/rcrezende/gists{/gist_id}","starred_url":"https://api.github.com/users/rcrezende/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rcrezende/subscriptions","organizations_url":"https://api.github.com/users/rcrezende/orgs","repos_url":"https://api.github.com/users/rcrezende/repos","events_url":"https://api.github.com/users/rcrezende/events{/privacy}","received_events_url":"https://api.github.com/users/rcrezende/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2017-10-24T20:00:40Z","updated_at":"2017-10-25T12:59:42Z","closed_at":"2017-10-25T12:59:42Z","author_association":"NONE","active_lock_reason":null,"body":"By running a top_hits aggregation I realized that some query optimizations could be applied.\r\n\r\nI ran:\r\n```\r\n\"aggs\": {\r\n\t\"autogen_by_kibana\": {\r\n\t  \"top_hits\": {\r\n\t\t\"docvalue_fields\": [\r\n\t\t  \"field_xyz\"\r\n\t\t],\r\n\t\t\"_source\": \"field_xyz\",\r\n\t\t\"size\": 1,\r\n\t\t\"sort\": [\r\n\t\t  {\r\n\t\t\t\"field_xyz\": {\r\n\t\t\t  \"order\": \"desc\"\r\n\t\t\t}\r\n\t\t  }\r\n\t\t]\r\n\t  }\r\n\t}\r\n...\r\n}\r\n```\r\n\r\nand sorted the top hit by field_xyz, which is not on every index.\r\nBut as part of the request we filter with:\r\n\r\n```\r\n{\r\n  \"exists\": {\r\n\t\"field\": \"field_xyz\"\r\n  }\r\n}\r\n```\r\n\r\nBut response fails execution on every shard when field_xyz is not present.\r\n\r\n> No mapping found for [field_xyz] in order to sort on\r\n\r\nWould be possible to not even dispatch the query to those shards since no record will match anyway?\r\n\r\nRunning ES 5.4.\r\n\r\nThat said, I see two points here:\r\n\r\n1. normalize mappings: I can certainly act on this and fix it, not sure what additional feature on ES would improve that without user intervention.\r\n2. load/dispatch requests only to needed nodes/shards: this seems to benefit ES overall through a query execution plan/optimization phase (for both regular search and aggregations) before dispatching the tasks. This error wouldn't even exist, but better than that may be the performance gain on coordinating.","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}