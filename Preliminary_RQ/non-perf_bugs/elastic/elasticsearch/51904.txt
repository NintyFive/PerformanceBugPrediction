{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/51904","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51904/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51904/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/51904/events","html_url":"https://github.com/elastic/elasticsearch/issues/51904","id":560082510,"node_id":"MDU6SXNzdWU1NjAwODI1MTA=","number":51904,"title":"Elasticsearch is fsyncing on transport threads","user":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"assignees":[{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2020-02-05T01:16:08Z","updated_at":"2020-02-15T01:10:40Z","closed_at":"2020-02-15T01:10:40Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"It is currently possible for a cluster state listener to execute a transport fsync.\r\n\r\n1. Currently in `TransportShardBulkAction` it is possible that a shard operations will trigger a mapping update. \r\n2. When this happens Elasticsearch [registers](https://github.com/elastic/elasticsearch/blob/3ad8aa6d46580229823d298e9ce68ba3aaadc3d6/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java#L125) a `ClusterStateObserver.Listener` to continue when the mapping is complete. \r\n3. This listener will eventually attempt to [reschedule](https://github.com/elastic/elasticsearch/blob/3ad8aa6d46580229823d298e9ce68ba3aaadc3d6/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java#L160) the write operation. \r\n4. If the write thread pool cannot accept this operation, the `onRejection` callback will fail outstanding operations and [complete](https://github.com/elastic/elasticsearch/blob/3ad8aa6d46580229823d298e9ce68ba3aaadc3d6/server/src/main/java/org/elasticsearch/action/bulk/TransportShardBulkAction.java#L182) the request (probably trying to notify of the operations that were able to be completed).\r\n5. Completing a `TransportShardBulkAction` will attempt to fsync or refresh as [necessary](https://github.com/elastic/elasticsearch/blob/062f9f03bfcdf8e3f57eb6a30d49fa5ec89c777f/server/src/main/java/org/elasticsearch/action/support/replication/TransportWriteAction.java#L145) after initiating replication. \r\n\r\n\r\nHere is a transport_worker stack trace. I also think these listeners might be executed on cluster state threads?\r\n\r\n```\r\nensureSynced:808, Translog (org.elasticsearch.index.translog)\r\nensureSynced:824, Translog (org.elasticsearch.index.translog)\r\nensureTranslogSynced:513, InternalEngine (org.elasticsearch.index.engine)\r\nwrite:2980, IndexShard$5 (org.elasticsearch.index.shard)\r\nprocessList:108, AsyncIOProcessor (org.elasticsearch.common.util.concurrent)\r\ndrainAndProcessAndRelease:96, AsyncIOProcessor (org.elasticsearch.common.util.concurrent)\r\nput:84, AsyncIOProcessor (org.elasticsearch.common.util.concurrent)\r\nsync:3003, IndexShard (org.elasticsearch.index.shard)\r\nrun:320, TransportWriteAction$AsyncAfterWriteAction (org.elasticsearch.action.support.replication)\r\nrunPostReplicationActions:163, TransportWriteAction$WritePrimaryResult (org.elasticsearch.action.support.replication)\r\nhandlePrimaryResult:136, ReplicationOperation (org.elasticsearch.action.support.replication)\r\naccept:-1, 359201671 (org.elasticsearch.action.support.replication.ReplicationOperation$$Lambda$3596)\r\nonResponse:63, ActionListener$1 (org.elasticsearch.action)\r\nonResponse:163, ActionListener$4 (org.elasticsearch.action)\r\ncompleteWith:336, ActionListener (org.elasticsearch.action)\r\nfinishRequest:186, TransportShardBulkAction$2 (org.elasticsearch.action.bulk)\r\nonRejection:182, TransportShardBulkAction$2 (org.elasticsearch.action.bulk)\r\nonRejection:681, ThreadContext$ContextPreservingAbstractRunnable (org.elasticsearch.common.util.concurrent)\r\nexecute:90, EsThreadPoolExecutor (org.elasticsearch.common.util.concurrent)\r\nlambda$doRun$0:160, TransportShardBulkAction$2 (org.elasticsearch.action.bulk)\r\naccept:-1, 95719050 (org.elasticsearch.action.bulk.TransportShardBulkAction$2$$Lambda$3833)\r\nonResponse:63, ActionListener$1 (org.elasticsearch.action)\r\nlambda$onResponse$0:289, TransportShardBulkAction$3 (org.elasticsearch.action.bulk)\r\nrun:-1, 1539599321 (org.elasticsearch.action.bulk.TransportShardBulkAction$3$$Lambda$3857)\r\nonResponse:251, ActionListener$5 (org.elasticsearch.action)\r\nonNewClusterState:125, TransportShardBulkAction$1 (org.elasticsearch.action.bulk)\r\nonNewClusterState:311, ClusterStateObserver$ContextPreservingListener (org.elasticsearch.cluster)\r\nwaitForNextChange:169, ClusterStateObserver (org.elasticsearch.cluster)\r\nwaitForNextChange:120, ClusterStateObserver (org.elasticsearch.cluster)\r\nwaitForNextChange:112, ClusterStateObserver (org.elasticsearch.cluster)\r\nlambda$shardOperationOnPrimary$1:122, TransportShardBulkAction (org.elasticsearch.action.bulk)\r\naccept:-1, 1672258490 (org.elasticsearch.action.bulk.TransportShardBulkAction$$Lambda$3831)\r\nonResponse:277, TransportShardBulkAction$3 (org.elasticsearch.action.bulk)\r\nonResponse:273, TransportShardBulkAction$3 (org.elasticsearch.action.bulk)\r\nonResponse:282, ActionListener$6 (org.elasticsearch.action)\r\nonResponse:116, MappingUpdatedAction$1 (org.elasticsearch.cluster.action.index)\r\nonResponse:113, MappingUpdatedAction$1 (org.elasticsearch.cluster.action.index)\r\nlambda$executeLocally$0:97, NodeClient (org.elasticsearch.client.node)\r\naccept:-1, 2099146048 (org.elasticsearch.client.node.NodeClient$$Lambda$2772)\r\nonResponse:144, TaskManager$1 (org.elasticsearch.tasks)\r\nonResponse:138, TaskManager$1 (org.elasticsearch.tasks)\r\nhandleResponse:54, ActionListenerResponseHandler (org.elasticsearch.action)\r\nhandleResponse:1053, TransportService$ContextRestoreResponseHandler (org.elasticsearch.transport)\r\ndoRun:220, InboundHandler$1 (org.elasticsearch.transport)\r\nrun:37, AbstractRunnable (org.elasticsearch.common.util.concurrent)\r\nexecute:196, EsExecutors$DirectExecutorService (org.elasticsearch.common.util.concurrent)\r\nhandleResponse:212, InboundHandler (org.elasticsearch.transport)\r\nmessageReceived:138, InboundHandler (org.elasticsearch.transport)\r\ninboundMessage:102, InboundHandler (org.elasticsearch.transport)\r\ninboundMessage:664, TcpTransport (org.elasticsearch.transport)\r\nconsumeNetworkReads:688, TcpTransport (org.elasticsearch.transport)\r\nconsumeReads:276, MockNioTransport$MockTcpReadWriteHandler (org.elasticsearch.transport.nio)\r\nhandleReadBytes:228, SocketChannelContext (org.elasticsearch.nio)\r\nread:40, BytesChannelContext (org.elasticsearch.nio)\r\nhandleRead:139, EventHandler (org.elasticsearch.nio)\r\nhandleRead:151, TestEventHandler (org.elasticsearch.transport.nio)\r\nhandleRead:420, NioSelector (org.elasticsearch.nio)\r\nprocessKey:246, NioSelector (org.elasticsearch.nio)\r\nsingleLoop:174, NioSelector (org.elasticsearch.nio)\r\nrunLoop:131, NioSelector (org.elasticsearch.nio)\r\nrun:-1, 461835914 (org.elasticsearch.nio.NioSelectorGroup$$Lambda$1709)\r\nrun:835, Thread (java.lang)\r\n```\r\n","closed_by":{"login":"tbrooks8","id":862472,"node_id":"MDQ6VXNlcjg2MjQ3Mg==","avatar_url":"https://avatars3.githubusercontent.com/u/862472?v=4","gravatar_id":"","url":"https://api.github.com/users/tbrooks8","html_url":"https://github.com/tbrooks8","followers_url":"https://api.github.com/users/tbrooks8/followers","following_url":"https://api.github.com/users/tbrooks8/following{/other_user}","gists_url":"https://api.github.com/users/tbrooks8/gists{/gist_id}","starred_url":"https://api.github.com/users/tbrooks8/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tbrooks8/subscriptions","organizations_url":"https://api.github.com/users/tbrooks8/orgs","repos_url":"https://api.github.com/users/tbrooks8/repos","events_url":"https://api.github.com/users/tbrooks8/events{/privacy}","received_events_url":"https://api.github.com/users/tbrooks8/received_events","type":"User","site_admin":false},"performed_via_github_app":null}