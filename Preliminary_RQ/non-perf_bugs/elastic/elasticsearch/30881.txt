{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/30881","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30881/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30881/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/30881/events","html_url":"https://github.com/elastic/elasticsearch/issues/30881","id":326593303,"node_id":"MDU6SXNzdWUzMjY1OTMzMDM=","number":30881,"title":"ingest-user-agent integ tests failed while wiping cluster between tests","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":912911731,"node_id":"MDU6TGFiZWw5MTI5MTE3MzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.4.0","name":"v6.4.0","color":"DDDDDD","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-05-25T16:41:30Z","updated_at":"2018-07-19T19:02:37Z","closed_at":"2018-07-19T19:02:36Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.x+intake/1769/console suffered two test failures while running the integ tests for the ingest-user-agent plugin:\r\n\r\n```\r\norg.elasticsearch.ingest.useragent.IngestUserAgentClientYamlTestSuiteIT test {yaml=ingest-useragent/20_useragent_processor/Test user agent processor with defaults}\r\norg.elasticsearch.ingest.useragent.IngestUserAgentClientYamlTestSuiteIT test {yaml=ingest-useragent/30_custom_regex/Test user agent processor with custom regex file}\r\n```\r\n\r\nHowever, on closer examination it wasn't the tests themselves that failed but the cleanup in between tests.\r\n\r\nThe first exception is this:\r\n\r\n```\r\n   > Throwable #1: java.io.IOException: listener timeout after waiting for [30000] ms\r\n   > \tat __randomizedtesting.SeedInfo.seed([95955EB3606B1633:1DC16169CE977BCB]:0)\r\n   > \tat org.elasticsearch.client.RestClient$SyncResponseListener.get(RestClient.java:794)\r\n   > \tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:174)\r\n   > \tat org.elasticsearch.client.RestClient.performRequest(RestClient.java:219)\r\n   > \tat org.elasticsearch.test.rest.ESRestTestCase.wipeCluster(ESRestTestCase.java:234)\r\n   > \tat org.elasticsearch.test.rest.ESRestTestCase.cleanUpCluster(ESRestTestCase.java:150)\r\n   > \tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThe node log shows this:\r\n\r\n```\r\n[2018-05-25T15:14:05,868][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [test/DozuAJmXTNOaPxo2lxRywQ] deleting index\r\n[2018-05-25T15:14:36,048][INFO ][o.e.c.m.MetaDataCreateIndexService] [node-0] [test] creating index, cause [auto(bulk api)], templates [], shards [5]/[1], mappings []\r\n[2018-05-25T15:14:36,117][WARN ][o.e.a.b.TransportShardBulkAction] [node-0] unexpected error during the primary phase for action [indices:data/write/bulk[s]], request [BulkShardRequest [[test][3]] containing [index {[test][test][1], source[{\"field1\":\"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_9_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/33.0.1750.149 Safari/537.36\",\"user_agent\":{\"os\":\"Other\",\"name\":\"Test\",\"os_name\":\"Other\",\"device\":\"Other\"}}]}]]\r\norg.elasticsearch.index.IndexNotFoundException: no such index\r\n\tat org.elasticsearch.cluster.routing.RoutingTable.shardRoutingTable(RoutingTable.java:137) ~[elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.primary(TransportReplicationAction.java:791) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase.doRun(TransportReplicationAction.java:726) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.action.support.replication.TransportReplicationAction$ReroutePhase$2.onNewClusterState(TransportReplicationAction.java:877) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.ClusterStateObserver$ContextPreservingListener.onNewClusterState(ClusterStateObserver.java:303) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.ClusterStateObserver$ObserverClusterStateListener.clusterChanged(ClusterStateObserver.java:191) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.lambda$callClusterStateListeners$7(ClusterApplierService.java:506) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat java.util.concurrent.ConcurrentHashMap$KeySpliterator.forEachRemaining(ConcurrentHashMap.java:3585) [?:?]\r\n\tat java.util.stream.Streams$ConcatSpliterator.forEachRemaining(Streams.java:735) [?:?]\r\n\tat java.util.stream.ReferencePipeline$Head.forEach(ReferencePipeline.java:658) [?:?]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.callClusterStateListeners(ClusterApplierService.java:503) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.applyChanges(ClusterApplierService.java:486) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService.runTask(ClusterApplierService.java:430) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.ClusterApplierService$UpdateTask.run(ClusterApplierService.java:160) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:625) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:244) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:207) [elasticsearch-6.4.0-SNAPSHOT.jar:6.4.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1135) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:635) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:844) [?:?]\r\n[2018-05-25T15:14:36,208][INFO ][o.e.c.m.MetaDataMappingService] [node-0] [test/r4CPzmugTNW5RKSz6RZopw] create_mapping [test]\r\n[2018-05-25T15:14:36,257][INFO ][o.e.c.m.MetaDataDeleteIndexService] [node-0] [test/r4CPzmugTNW5RKSz6RZopw] deleting index\r\n```\r\n\r\nIt looks like deleting the `test` index took longer than 30 seconds, causing the client to give up.  Then the following test caused the index to be recreated by indexing a document into it.  But the routing got confused between the old `test` index and the new `test` index.","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}