{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/39842","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39842/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39842/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/39842/events","html_url":"https://github.com/elastic/elasticsearch/issues/39842","id":418794557,"node_id":"MDU6SXNzdWU0MTg3OTQ1NTc=","number":39842,"title":"[ML] Real time datafeed skips first bucket after lookback when aggs are used","user":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"assignees":[{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2019-03-08T13:50:11Z","updated_at":"2019-03-12T14:23:15Z","closed_at":"2019-03-12T14:23:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Steps to reproduce**\r\n\r\n1. Index documents ranging from some time before `now` to some time after `now`. You can use the python script found [here](https://gist.github.com/dimitris-athanasiou/c7cc510365620923989944460332dd98)\r\n\r\n2. Put job:\r\n\r\n\r\n```\r\nPUT _ml/anomaly_detectors/test_job\r\n{\r\n\t\"analysis_config\": {\r\n\t\t\"bucket_span\": \"1m\",\r\n\t\t\"summary_count_field_name\": \"doc_count\",\r\n\t\t\"detectors\": [\r\n\t\t\t{\"function\": \"count\"}\r\n\t\t]\r\n\t},\r\n\t\"model_plot_config\": {\"enabled\": \"true\"},\r\n\t\"data_description\": {\r\n\t\t\"time_field\": \"time\"\r\n\t}\r\n}\r\n```\r\n\r\n3. Open job:\r\n\r\n```\r\nPOST _ml/anomaly_detectors/test_job/_open\r\n```\r\n\r\n4. Put datafeed:\r\n\r\n```\r\nPUT _ml/datafeeds/test_datafeed\r\n{\r\n\t\"indices\": \"rt\",\r\n\t\"job_id\": \"test_job\",\r\n\t\"query_delay\": \"20s\",\r\n\t\"aggs\": {\r\n    \t\"buckets\": {\r\n\t    \t\"date_histogram\": {\r\n\t        \"field\": \"time\",\r\n\t        \"interval\": \"1m\",\r\n\t        \"time_zone\": \"UTC\"\r\n    \t},\r\n        \"aggs\": {\r\n            \"time\": {\r\n                \"max\": {\r\n        \t    \"field\": \"time\"\r\n        \t}\r\n            }\r\n        }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n5. Start datafeed\r\n\r\n```\r\nPOST _ml/datafeeds/test_datafeed/_start\r\n```\r\n\r\n6. Wait until a few minutes pass so that  the datafeed triggers a few real-time searches\r\n\r\n**Observed Behaviour**\r\n\r\nNotice that there will be an empty bucket right after the lookback ended.","closed_by":{"login":"dimitris-athanasiou","id":9351617,"node_id":"MDQ6VXNlcjkzNTE2MTc=","avatar_url":"https://avatars3.githubusercontent.com/u/9351617?v=4","gravatar_id":"","url":"https://api.github.com/users/dimitris-athanasiou","html_url":"https://github.com/dimitris-athanasiou","followers_url":"https://api.github.com/users/dimitris-athanasiou/followers","following_url":"https://api.github.com/users/dimitris-athanasiou/following{/other_user}","gists_url":"https://api.github.com/users/dimitris-athanasiou/gists{/gist_id}","starred_url":"https://api.github.com/users/dimitris-athanasiou/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dimitris-athanasiou/subscriptions","organizations_url":"https://api.github.com/users/dimitris-athanasiou/orgs","repos_url":"https://api.github.com/users/dimitris-athanasiou/repos","events_url":"https://api.github.com/users/dimitris-athanasiou/events{/privacy}","received_events_url":"https://api.github.com/users/dimitris-athanasiou/received_events","type":"User","site_admin":false},"performed_via_github_app":null}