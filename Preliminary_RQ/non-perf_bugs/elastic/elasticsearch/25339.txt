{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25339","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25339/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25339/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25339/events","html_url":"https://github.com/elastic/elasticsearch/issues/25339","id":237619193,"node_id":"MDU6SXNzdWUyMzc2MTkxOTM=","number":25339,"title":"Counterintuitive date rounding behavior in date filters","user":{"login":"neuroticnetworks","id":3965137,"node_id":"MDQ6VXNlcjM5NjUxMzc=","avatar_url":"https://avatars0.githubusercontent.com/u/3965137?v=4","gravatar_id":"","url":"https://api.github.com/users/neuroticnetworks","html_url":"https://github.com/neuroticnetworks","followers_url":"https://api.github.com/users/neuroticnetworks/followers","following_url":"https://api.github.com/users/neuroticnetworks/following{/other_user}","gists_url":"https://api.github.com/users/neuroticnetworks/gists{/gist_id}","starred_url":"https://api.github.com/users/neuroticnetworks/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/neuroticnetworks/subscriptions","organizations_url":"https://api.github.com/users/neuroticnetworks/orgs","repos_url":"https://api.github.com/users/neuroticnetworks/repos","events_url":"https://api.github.com/users/neuroticnetworks/events{/privacy}","received_events_url":"https://api.github.com/users/neuroticnetworks/received_events","type":"User","site_admin":false},"labels":[{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-06-21T18:08:47Z","updated_at":"2017-09-22T15:15:12Z","closed_at":"2017-09-22T15:15:12Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 5.4.1\r\n\r\n**Plugins installed**: [mapper-murmur3,  repository-s3]\r\n\r\n**JVM version** (`java -version`): Java 1.8.0_60-b27\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Centos 7\r\n\r\n**Description of the problem including expected versus actual behavior**: \r\n\r\nDate range rounding behavior is counterintuitive, imo, and inconsistent with what I think users would expect, based on experiences with other database/IR systems. Consider the following query:\r\n\r\n```\r\nGET /_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"now-1d/d\",\r\n              \"lte\": \"now/d\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"MaxDT\": {\r\n      \"max\": {\r\n        \"field\": \"@timestamp\"\r\n      }\r\n    },\r\n    \"MinDT\": {\r\n      \"min\": {\r\n        \"field\": \"@timestamp\"\r\n      }\r\n    }    \r\n  }\r\n}\r\n```\r\n\r\nThis yields\r\n\r\n```\r\n  \"aggregations\": {\r\n    \"MinDT\": {\r\n      \"value\": 1497916800044,\r\n      \"value_as_string\": \"2017-06-20T00:00:00.044Z\"\r\n    },\r\n    \"MaxDT\": {\r\n      \"value\": 1498067981073,\r\n      \"value_as_string\": \"2017-06-21T17:59:41.073Z\"  <--- note this\r\n    }\r\n  }\r\n```\r\n\r\nConsider instead the following query:\r\n\r\n```\r\nGET /_search\r\n{\r\n  \"size\": 0,\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"filter\": [\r\n        {\r\n          \"range\": {\r\n            \"@timestamp\": {\r\n              \"gte\": \"now-1d/d\",\r\n              \"lt\": \"now/d\"\r\n            }\r\n          }\r\n        }\r\n      ]\r\n    }\r\n  },\r\n  \"aggs\": {\r\n    \"MaxDT\": {\r\n      \"max\": {\r\n        \"field\": \"@timestamp\"\r\n      }\r\n    },\r\n    \"MinDT\": {\r\n      \"min\": {\r\n        \"field\": \"@timestamp\"\r\n      }\r\n    }    \r\n  }\r\n}\r\n```\r\nThis yields\r\n\r\n```\r\n  \"aggregations\": {\r\n    \"MinDT\": {\r\n      \"value\": 1497916800044,\r\n      \"value_as_string\": \"2017-06-20T00:00:00.044Z\"\r\n    },\r\n    \"MaxDT\": {\r\n      \"value\": 1498003199988,\r\n      \"value_as_string\": \"2017-06-20T23:59:59.988Z\" <--- note this\r\n    }\r\n  }\r\n```\r\n\r\nThe later query is correct for \"Show me what happened yesterday.\"  The former produces an unexpected date range in that the values of `@timestamp` themselves appear to be rounded down and compared against `now/d`, which is not what I would expect based in the wording in the [existing](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-daterange-aggregation.html#CO79-2) [documentation](https://www.elastic.co/guide/en/elasticsearch/reference/current/common-options.html#date-math).\r\n\r\nI am still looking for the date rounding handling in the source code, but my gut feeling is that `@timestamp` is being rounded down and compared against `now/d`. This may or may not be what you intended and there may or may not be good reasons to do it this way, if you are. But it is not the behavior I would expect based on the docs and based on experience with other databases. If this behavior is intentional, would it be possible to document this behavior as a gotcha? \r\n\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}