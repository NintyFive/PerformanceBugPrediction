{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17590","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17590/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17590/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17590/events","html_url":"https://github.com/elastic/elasticsearch/issues/17590","id":146560296,"node_id":"MDU6SXNzdWUxNDY1NjAyOTY=","number":17590,"title":"Range or bucket defining pipeline aggregation","user":{"login":"cwurm","id":694597,"node_id":"MDQ6VXNlcjY5NDU5Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/694597?v=4","gravatar_id":"","url":"https://api.github.com/users/cwurm","html_url":"https://github.com/cwurm","followers_url":"https://api.github.com/users/cwurm/followers","following_url":"https://api.github.com/users/cwurm/following{/other_user}","gists_url":"https://api.github.com/users/cwurm/gists{/gist_id}","starred_url":"https://api.github.com/users/cwurm/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cwurm/subscriptions","organizations_url":"https://api.github.com/users/cwurm/orgs","repos_url":"https://api.github.com/users/cwurm/repos","events_url":"https://api.github.com/users/cwurm/events{/privacy}","received_events_url":"https://api.github.com/users/cwurm/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"},{"id":110557212,"node_id":"MDU6TGFiZWwxMTA1NTcyMTI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/high%20hanging%20fruit","name":"high hanging fruit","color":"fc6149","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2016-04-07T09:30:43Z","updated_at":"2018-03-15T10:43:45Z","closed_at":"2018-03-15T10:43:45Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Let's say the data set is transactions made by users and the question we want to ask is \"Which users have transactions totalling between 100 - 200, 200 - 300, etc.?\"\n\nAt the moment, there doesn't seem to be a way to do this in one query.\n\nGiven documents like this:\n\n```\n\"user\": user1,\n\"credit\": 50\n```\n\nwe can answer questions such as \"Show me only the users that have transactions totalling more than 100\" by using a `bucket_selector` like this:\n\n```\n\"aggs\": {\n  \"users\": {\n    \"terms\": {\n      \"field\": \"user\"\n    },\n    \"aggs\": {\n      \"sum_credit\": {\n        \"sum\": {\n          \"field\": \"credit\"\n        }\n      },\n      \"the_pipeline_agg\": {\n        \"bucket_selector\": {\n          \"buckets_path\": {\n            \"sumCredit\": \"sum_credit\"\n          },\n          \"script\": \"sumCredit > 100\"\n        }\n      }\n    }\n  }\n}\n```\n\nAnd now we could form ranges on the client side by running several of these queries in parallel.\n\nBut to answer the original question we would need some form of range pipeline aggregation like:\n\n```\n\"bucket_range\": {\n  \"buckets_path\": {\n    \"sumCredit\": \"sum_credit\"\n  },\n  \"ranges\": [\n    { \"to\": 100 },\n    { \"from\": 100, \"to\": 200 }\n  ]\n}\n```\n\nOr maybe even a more generic \"bucket defining\" pipeline agg, e.g.:\n\n```\n\"bucket_definer\": {\n  \"buckets_path\": {\n    \"sumCredit\": \"sum_credit\"\n  },\n  \"bucket_script\": \"floor(sumCredit / 100)\"\n}\n```\n\nThis would define automatically define buckets for 0-100, 100-200, and so on.\n","closed_by":{"login":"markharwood","id":170925,"node_id":"MDQ6VXNlcjE3MDkyNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/170925?v=4","gravatar_id":"","url":"https://api.github.com/users/markharwood","html_url":"https://github.com/markharwood","followers_url":"https://api.github.com/users/markharwood/followers","following_url":"https://api.github.com/users/markharwood/following{/other_user}","gists_url":"https://api.github.com/users/markharwood/gists{/gist_id}","starred_url":"https://api.github.com/users/markharwood/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/markharwood/subscriptions","organizations_url":"https://api.github.com/users/markharwood/orgs","repos_url":"https://api.github.com/users/markharwood/repos","events_url":"https://api.github.com/users/markharwood/events{/privacy}","received_events_url":"https://api.github.com/users/markharwood/received_events","type":"User","site_admin":false},"performed_via_github_app":null}