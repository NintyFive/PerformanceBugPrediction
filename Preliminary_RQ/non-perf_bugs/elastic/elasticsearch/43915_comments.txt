[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508072213","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508072213","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508072213,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODA3MjIxMw==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-03T12:29:30Z","updated_at":"2019-07-03T12:29:30Z","author_association":"CONTRIBUTOR","body":"@ywelsch I see this PR https://github.com/elastic/elasticsearch/pull/43205. Can this PR help to solve this issue?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508118412","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508118412","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508118412,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODExODQxMg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-07-03T14:30:41Z","updated_at":"2019-07-03T14:30:41Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508121075","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508121075","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508121075,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODEyMTA3NQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-07-03T14:37:01Z","updated_at":"2019-07-03T14:37:01Z","author_association":"CONTRIBUTOR","body":"I'm not sure that I understand the question here. Can you explain what the unexpected behavior here is? When using `translog.durability` set to `async`, there is a risk of losing acknowledged writes ([as the documentation says](https://www.elastic.co/guide/en/elasticsearch/reference/current/index-modules-translog.html)). Is the confusing part perhaps that it only talks about hardware failure, whereas you also lose data in case of process crashes?\r\n\r\n> when recovery, TranslogSnapshot.next() will return null when readOperations > globalCheckpoint.\r\n\r\nnot true, where do you see that? Do you mean this line? https://github.com/elastic/elasticsearch/blob/ca5771c1f4aeb37ff133540927a8c770c46693c3/server/src/main/java/org/elasticsearch/index/translog/TranslogSnapshot.java#L71\r\n\r\nWhich recovery do you mean? recovery from store (i.e. as a primary)?\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508311415","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508311415","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508311415,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODMxMTQxNQ==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-04T02:07:40Z","updated_at":"2019-07-04T02:07:40Z","author_association":"CONTRIBUTOR","body":"> Is the confusing part perhaps that it only talks about hardware failure, whereas you also lose data in case of process crashes?\r\n\r\nIt's not hardware failure. hardware is ok, but process is down.\r\nI simulate this case by kill -9 es pid, in somecase maybe jvm core, or oom-killer will cause the same problem.\r\n\r\n\r\n> Which recovery do you mean? recovery from store (i.e. as a primary)?\r\n\r\nyeah, recovery from store. indices number_of_replicas=0, It's primary recovery.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508324947","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508324947","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508324947,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODMyNDk0Nw==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-04T03:31:06Z","updated_at":"2019-07-04T03:31:06Z","author_association":"CONTRIBUTOR","body":"In Provide logs. translog.ckp's globalCheckpoint=0xcb73. But in translog-3.tlog,there are many log's seqNo > 0xcb73. in translog-3.tlog's last log, seqNo=0xcbf0. Recovery from translog lost the translog operation from seqNo 0xcb74 to 0xcbf0.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508542238","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508542238","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508542238,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODU0MjIzOA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-07-04T17:15:17Z","updated_at":"2019-07-04T17:15:17Z","author_association":"MEMBER","body":"> In Provide logs. translog.ckp's globalCheckpoint=0xcb73. But in translog-3.tlog,there are many log's seqNo > 0xcb73. in translog-3.tlog's last log, seqNo=0xcbf0. Recovery from translog lost the translog operation from seqNo 0xcb74 to 0xcbf0.\r\n\r\nWe only recover operations that we have **[manually](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java#L377-L378)** fsynced and recorded in the checkpoint files. If some operations are flushed and fsynced by OS, we won't try to scan and recover those operations. We should never attempt to recover translog as it's the source of truth.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508615425","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508615425","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508615425,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODYxNTQyNQ==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-05T03:11:24Z","updated_at":"2019-07-05T03:11:24Z","author_association":"CONTRIBUTOR","body":"> > In Provide logs. translog.ckp's globalCheckpoint=0xcb73. But in translog-3.tlog,there are many log's seqNo > 0xcb73. in translog-3.tlog's last log, seqNo=0xcbf0. Recovery from translog lost the translog operation from seqNo 0xcb74 to 0xcbf0.\r\n> \r\n> We only recover operations that we have **[manually](https://github.com/elastic/elasticsearch/blob/master/server/src/main/java/org/elasticsearch/index/translog/TranslogWriter.java#L377-L378)** fsynced and recorded in the checkpoint files. If some operations are flushed and fsynced by OS, we won't try to scan and recover those operations. We should never attempt to recover translog as it's the source of truth.\r\n\r\nI know the mechanism. But If translog has more operations then checkpoint, these operations have the chance to recover rather than drop them. \r\nTranslogWriter.syncUpTo will save the checkpoint. but if settings index.translog.durability=async, default index.translog.sync_interval=5s, syncUpTo will call every 5 seconds. If before next call syncUpTo,  index some data, translog will add these operations. If hardware failure, these translog maybe lost. But if only process crash, like jvm crash https://github.com/elastic/elasticsearch/issues/41432,  these translog are fine, but the checkpoint is behind these translog.\r\nI think before shard start, can check translog.ckp file?\r\nif checkpoint is behind translog log file, reset the translog.ckp to the right checkpoint.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508616453","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508616453","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508616453,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODYxNjQ1Mw==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-05T03:19:17Z","updated_at":"2019-07-05T03:19:17Z","author_association":"CONTRIBUTOR","body":"We are set number_of_replicas=0  in the log use case. Because log data is to large as PB level. We consumer kafka, sink data to es. when es index is success, we submit the kafka offset. But when es process crash unexpected, it will cause data loss. even if es index is return success, and we submit the kafka offset.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508713082","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508713082","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508713082,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODcxMzA4Mg==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-05T10:27:18Z","updated_at":"2019-07-05T10:27:18Z","author_association":"CONTRIBUTOR","body":"translog.log:\r\n```\r\n\t\t     |<---lost data--->|\r\n---------------------|-----------------|\r\n                     ^                 ^\r\n              globalCheckpoint        end\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508719689","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508719689","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508719689,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODcxOTY4OQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-07-05T10:51:24Z","updated_at":"2019-07-05T10:51:24Z","author_association":"CONTRIBUTOR","body":"You're confusing checkpoint and globalcheckpoint. What you meant to draw was something like:\r\n\r\n```\r\n\t\t     |<---lost data--->|\r\n---------------------|-----------------|\r\n                     ^                 ^\r\n              checkpoint.offset        end\r\n```\r\n\r\n> when es index is success, we submit the kafka offset.\r\n\r\nThat's the real bug here. The API does not offer this guarantee with async translog syncing. Also, even if we were to change the system as you suggested (which has other risks), you would still experience data loss in case of a system crash.\r\n\r\n@dnhatn I think we should update the docs, which make it currently look like you only lose data in case of hardware failure.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/508722587","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-508722587","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":508722587,"node_id":"MDEyOklzc3VlQ29tbWVudDUwODcyMjU4Nw==","user":{"login":"weizijun","id":5070449,"node_id":"MDQ6VXNlcjUwNzA0NDk=","avatar_url":"https://avatars0.githubusercontent.com/u/5070449?v=4","gravatar_id":"","url":"https://api.github.com/users/weizijun","html_url":"https://github.com/weizijun","followers_url":"https://api.github.com/users/weizijun/followers","following_url":"https://api.github.com/users/weizijun/following{/other_user}","gists_url":"https://api.github.com/users/weizijun/gists{/gist_id}","starred_url":"https://api.github.com/users/weizijun/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/weizijun/subscriptions","organizations_url":"https://api.github.com/users/weizijun/orgs","repos_url":"https://api.github.com/users/weizijun/repos","events_url":"https://api.github.com/users/weizijun/events{/privacy}","received_events_url":"https://api.github.com/users/weizijun/received_events","type":"User","site_admin":false},"created_at":"2019-07-05T11:03:18Z","updated_at":"2019-07-05T13:36:12Z","author_association":"CONTRIBUTOR","body":"> You're confusing checkpoint and globalcheckpoint. What you meant to draw was something like:\r\n> \r\n> ```\r\n> \t\t     |<---lost data--->|\r\n> ---------------------|-----------------|\r\n>                      ^                 ^\r\n>               checkpoint.offset        end\r\n> ```\r\n> \r\n> > when es index is success, we submit the kafka offset.\r\n> \r\n> That's the real bug here. The API does not offer this guarantee with async translog syncing. Also, even if we were to change the system as you suggested (which has other risks), you would still experience data loss in case of a system crash.\r\n> \r\n> @dnhatn I think we should update the docs, which make it currently look like you only lose data in case of hardware failure.\r\n\r\nyeah, If translog operation lost due to hardware failure or other unexpected exception, This the index.translog.durability=async mechanism. But if  translog file is ok, recovery can do best to recovery these translog  operation.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/509057144","html_url":"https://github.com/elastic/elasticsearch/issues/43915#issuecomment-509057144","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43915","id":509057144,"node_id":"MDEyOklzc3VlQ29tbWVudDUwOTA1NzE0NA==","user":{"login":"dnhatn","id":13474362,"node_id":"MDQ6VXNlcjEzNDc0MzYy","avatar_url":"https://avatars3.githubusercontent.com/u/13474362?v=4","gravatar_id":"","url":"https://api.github.com/users/dnhatn","html_url":"https://github.com/dnhatn","followers_url":"https://api.github.com/users/dnhatn/followers","following_url":"https://api.github.com/users/dnhatn/following{/other_user}","gists_url":"https://api.github.com/users/dnhatn/gists{/gist_id}","starred_url":"https://api.github.com/users/dnhatn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dnhatn/subscriptions","organizations_url":"https://api.github.com/users/dnhatn/orgs","repos_url":"https://api.github.com/users/dnhatn/repos","events_url":"https://api.github.com/users/dnhatn/events{/privacy}","received_events_url":"https://api.github.com/users/dnhatn/received_events","type":"User","site_admin":false},"created_at":"2019-07-08T02:28:22Z","updated_at":"2019-07-08T02:28:22Z","author_association":"MEMBER","body":"I merged #44020 to clarify the consequence of the translog async setting. I also discussed this with Yannick. We preferred not to proceed with this change as translog is crucial for the consistency and resiliency of the system.\r\n\r\nWe can continue this conversation in the [forums](https://discuss.elastic.co/). Thank you very much for your interest in Elasticsearch.","performed_via_github_app":null}]