{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/1683/events","html_url":"https://github.com/elastic/elasticsearch/issues/1683","id":3142687,"node_id":"MDU6SXNzdWUzMTQyNjg3","number":1683,"title":"Question/comment about multi-value field data construction","user":{"login":"Alex-Ikanow","id":851950,"node_id":"MDQ6VXNlcjg1MTk1MA==","avatar_url":"https://avatars2.githubusercontent.com/u/851950?v=4","gravatar_id":"","url":"https://api.github.com/users/Alex-Ikanow","html_url":"https://github.com/Alex-Ikanow","followers_url":"https://api.github.com/users/Alex-Ikanow/followers","following_url":"https://api.github.com/users/Alex-Ikanow/following{/other_user}","gists_url":"https://api.github.com/users/Alex-Ikanow/gists{/gist_id}","starred_url":"https://api.github.com/users/Alex-Ikanow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alex-Ikanow/subscriptions","organizations_url":"https://api.github.com/users/Alex-Ikanow/orgs","repos_url":"https://api.github.com/users/Alex-Ikanow/repos","events_url":"https://api.github.com/users/Alex-Ikanow/events{/privacy}","received_events_url":"https://api.github.com/users/Alex-Ikanow/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2012-02-08T16:04:47Z","updated_at":"2012-10-24T18:34:54Z","closed_at":"2012-10-24T18:34:54Z","author_association":"NONE","active_lock_reason":null,"body":"Feel free just to delete this if I'm missing something obvious, but I'm curious about the design decisions in the construction of the \"ordinals\" array for multi-valued field types.\n\nYou create an ArrayList of size <max array size of field across all documents>, each entry of the ArrayList being an int array of size maxDocs (containing the term ids)\n\nPresumably the way you use the ordinals array is to loop over the terms for a given document id, ie\n\nArrayList.get(i).get(docId) for an iterating index 'i'\n\nThis seems sub-optimal for 2 reasons:\n- As discussed in https://groups.google.com/group/elasticsearch/browse_thread/thread/31d87c84dd387367#, the memory usage for document sets that can have a large number of values for a field can get massive\n- (Less importantly) You're having to reload your L2 cache with each \"inner loop\" iteration of 'i'\n\nIf you switched round the order, you'd have more pain initializing the field data, but after that it would be much more compact in memory and faster (maybe only marginally?) ... which seems like the right trade-off, since you're constructing the field data once (particularly with the default resident cache) but using it many times.\n\nOr alternatively (eg if creating maxDocs \\* small objects is too painful for whatever reason), take the top X% of documents (in terms of array length) after you're done, treat them differently (ie indexed the other way round, in a separate structure), and then delete as many ordinals entries as you can. (etc etc)\n\nI'm sure many other es users are going to have decent-sized arrays of fields in their documents, what with the trendiness of social networks (friend lists), geo etc etc.\n","closed_by":{"login":"Alex-Ikanow","id":851950,"node_id":"MDQ6VXNlcjg1MTk1MA==","avatar_url":"https://avatars2.githubusercontent.com/u/851950?v=4","gravatar_id":"","url":"https://api.github.com/users/Alex-Ikanow","html_url":"https://github.com/Alex-Ikanow","followers_url":"https://api.github.com/users/Alex-Ikanow/followers","following_url":"https://api.github.com/users/Alex-Ikanow/following{/other_user}","gists_url":"https://api.github.com/users/Alex-Ikanow/gists{/gist_id}","starred_url":"https://api.github.com/users/Alex-Ikanow/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Alex-Ikanow/subscriptions","organizations_url":"https://api.github.com/users/Alex-Ikanow/orgs","repos_url":"https://api.github.com/users/Alex-Ikanow/repos","events_url":"https://api.github.com/users/Alex-Ikanow/events{/privacy}","received_events_url":"https://api.github.com/users/Alex-Ikanow/received_events","type":"User","site_admin":false},"performed_via_github_app":null}