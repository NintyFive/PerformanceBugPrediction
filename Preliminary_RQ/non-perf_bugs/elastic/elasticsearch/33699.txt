{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33699","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33699/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33699/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33699/events","html_url":"https://github.com/elastic/elasticsearch/issues/33699","id":360179960,"node_id":"MDU6SXNzdWUzNjAxNzk5NjA=","number":33699,"title":"SearchAsyncActionTests.testFanOutAndCollect throws RejectedExecutionException","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":148612629,"node_id":"MDU6TGFiZWwxNDg2MTI2Mjk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Etest-failure","name":">test-failure","color":"207de5","default":false,"description":"Triaged test failures from CI"},{"id":1223177445,"node_id":"MDU6TGFiZWwxMjIzMTc3NDQ1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v7.0.0-beta1","name":"v7.0.0-beta1","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-09-14T06:58:19Z","updated_at":"2019-02-07T08:20:40Z","closed_at":"2019-01-02T08:47:14Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I dug into #29242 again and tried to reproduce the problem at 5a3fd8e4e7c8d2721b3542ffa859c9245678d6c2 by running the affected test repeatedly until it failed by using:\r\n\r\n    date | tee pass-times.log; while ./gradlew --console=plain :server:test -Dtests.class=org.elasticsearch.action.search.SearchAsyncActionTests -Dtests.method=\"testFanOutAndCollect\" 2>&1 > testoutput.log; do date | tee -a pass-times.log; done\r\n\r\nAfter around 1000 iterations (6 hours) it failed with a different issue:\r\n\r\n```\r\n  2> ༩ ༡༣, ༢༠༡༨ ༢:༤༧:༢༧ ཕྱི་ཆ་ com.carrotsearch.randomizedtesting.RandomizedRunner$QueueUncaughtExceptionsHandler uncaughtException\r\n  2> WARNING: Uncaught exception in thread: Thread[Thread-1,5,TGRP-SearchAsyncActionTests]\r\n  2> java.util.concurrent.RejectedExecutionException: Task org.elasticsearch.action.search.InitialSearchPhase$1@db8dd7d rejected from java.util.concurrent.ThreadPoolExecutor@2e3a06e7[Terminated,\r\n pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]\r\n  2>    at __randomizedtesting.SeedInfo.seed([CAEABDE40791E9D5]:0)\r\n  2>    at java.base/java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2080)\r\n  2>    at java.base/java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:832)\r\n  2>    at java.base/java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1365)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.fork(InitialSearchPhase.java:174)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:167)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.executeNext(InitialSearchPhase.java:239)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.lambda$performPhaseOnShard$4(InitialSearchPhase.java:293)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase$PendingExecutions.tryRun(InitialSearchPhase.java:214)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase$PendingExecutions.finishAndRunNext(InitialSearchPhase.java:208)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:169)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.executeNext(InitialSearchPhase.java:239)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:50)\r\n  2>    at org.elasticsearch.action.search.InitialSearchPhase$2.innerOnResponse(InitialSearchPhase.java:270)\r\n  2>    at org.elasticsearch.action.search.SearchActionListener.onResponse(SearchActionListener.java:45)\r\n  2>    at org.elasticsearch.action.search.SearchAsyncActionTests$7.lambda$executePhaseOnShard$1(SearchAsyncActionTests.java:334)\r\n  2>    at java.base/java.lang.Thread.run(Thread.java:844)\r\n  2> REPRODUCE WITH: ./gradlew :server:test -Dtests.seed=CAEABDE40791E9D5 -Dtests.class=org.elasticsearch.action.search.SearchAsyncActionTests -Dtests.method=\"testFanOutAndCollect\" -Dtests.security.manager=true -Dtests.locale=dz -Dtests.timezone=Etc/GMT+11 -Dcompiler.java=10 -Druntime.java=10\r\nERROR   0.14s | SearchAsyncActionTests.testFanOutAndCollect <<< FAILURES!\r\n   > Throwable #1: com.carrotsearch.randomizedtesting.UncaughtExceptionError: Captured an uncaught exception in thread: Thread[id=18, name=Thread-1, state=RUNNABLE, group=TGRP-SearchAsyncActionTests]\r\n   >    at __randomizedtesting.SeedInfo.seed([CAEABDE40791E9D5:B11B3894FE3A2856]:0)\r\n   > Caused by: java.util.concurrent.RejectedExecutionException: Task org.elasticsearch.action.search.InitialSearchPhase$1@db8dd7d rejected from java.util.concurrent.ThreadPoolExecutor@2e3a06e7[Terminated, pool size = 0, active threads = 0, queued tasks = 0, completed tasks = 0]\r\n   >    at __randomizedtesting.SeedInfo.seed([CAEABDE40791E9D5]:0)\r\n   >    at java.base/java.util.concurrent.ThreadPoolExecutor$AbortPolicy.rejectedExecution(ThreadPoolExecutor.java:2080)\r\n   >    at java.base/java.util.concurrent.ThreadPoolExecutor.reject(ThreadPoolExecutor.java:832)\r\n   >    at java.base/java.util.concurrent.ThreadPoolExecutor.execute(ThreadPoolExecutor.java:1365)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.fork(InitialSearchPhase.java:174)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:167)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.executeNext(InitialSearchPhase.java:239)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.lambda$performPhaseOnShard$4(InitialSearchPhase.java:293)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase$PendingExecutions.tryRun(InitialSearchPhase.java:214)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase$PendingExecutions.finishAndRunNext(InitialSearchPhase.java:208)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.maybeFork(InitialSearchPhase.java:169)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.executeNext(InitialSearchPhase.java:239)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase.access$100(InitialSearchPhase.java:50)\r\n   >    at org.elasticsearch.action.search.InitialSearchPhase$2.innerOnResponse(InitialSearchPhase.java:270)\r\n   >    at org.elasticsearch.action.search.SearchActionListener.onResponse(SearchActionListener.java:45)\r\n   >    at org.elasticsearch.action.search.SearchAsyncActionTests$7.lambda$executePhaseOnShard$1(SearchAsyncActionTests.java:334)\r\n   >    at java.base/java.lang.Thread.run(Thread.java:844)\r\n  2> NOTE: test params are: codec=Asserting(Lucene80): {}, docValues:{}, maxPointsInLeafNode=1617, maxMBSortInHeap=7.294998490965383, sim=Asserting(org.apache.lucene.search.similarities.AssertingSimilarity@5ee576f6), locale=dz, timezone=Etc/GMT+11\r\n  2> NOTE: Linux 4.13.0-32-generic amd64/Oracle Corporation 10 (64-bit)/cpus=8,threads=1,free=494096088,total=536870912\r\n  2> NOTE: All tests run in this JVM: [SearchAsyncActionTests]\r\n\r\nFAILURE: Build failed with an exception.\r\n```\r\n\r\nI initially saw this kind of failure using `-Dtests.iters=1000`, which yielded this failure after only a few runs, but was unsure whether it might have been a symptom of the `tests.iters` setting. This confirms that it can also occur if the test runs individually.","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}