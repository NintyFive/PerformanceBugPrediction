{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/46994","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46994/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46994/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/46994/events","html_url":"https://github.com/elastic/elasticsearch/issues/46994","id":497462436,"node_id":"MDU6SXNzdWU0OTc0NjI0MzY=","number":46994,"title":"No timeouts in co-ordinator to primary and primary to replica interactions during indexing","user":{"login":"itiyamas","id":45985097,"node_id":"MDQ6VXNlcjQ1OTg1MDk3","avatar_url":"https://avatars3.githubusercontent.com/u/45985097?v=4","gravatar_id":"","url":"https://api.github.com/users/itiyamas","html_url":"https://github.com/itiyamas","followers_url":"https://api.github.com/users/itiyamas/followers","following_url":"https://api.github.com/users/itiyamas/following{/other_user}","gists_url":"https://api.github.com/users/itiyamas/gists{/gist_id}","starred_url":"https://api.github.com/users/itiyamas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/itiyamas/subscriptions","organizations_url":"https://api.github.com/users/itiyamas/orgs","repos_url":"https://api.github.com/users/itiyamas/repos","events_url":"https://api.github.com/users/itiyamas/events{/privacy}","received_events_url":"https://api.github.com/users/itiyamas/received_events","type":"User","site_admin":false},"labels":[{"id":836504707,"node_id":"MDU6TGFiZWw4MzY1MDQ3MDc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Distributed","name":":Distributed/Distributed","color":"0e8a16","default":false,"description":"A catch all label for anything in the Distributed Area. If you aren't sure, use this one."},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2019-09-24T05:23:12Z","updated_at":"2019-12-05T12:29:43Z","closed_at":"2019-12-05T12:29:43Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch does not have any timeouts/deadlines for the remote interactions in the indexing path. This causes resources wastage on ES nodes for the requests retried on client. In addition to this, even though primaries and replicas have gating mechanism to prevent resource wastage via thread pools and queues- the co-ordinating node just keeps on accepting requests and  hogs huge amount of memory.\r\n \r\nI understand that choosing the right timeout value is tricky for indexing, especially in primary-replica interaction since a failure(timeout) results in shard allocation failure, resulting in data movement across nodes. \r\n\r\nIn synchronous replication systems like ES, such failures are handled via strong healthchecks since there is no other way of eliminating a node. ES just has a health check on pings and not an any of the advanced adaptive metrics like bulk request successes/ failures/timeouts etc or network congestion/TCP retransmits for that matter.\r\n\r\nI am proposing to add a deadline for the entire lifecycle of the indexing request. It can be a very defensive timeout to start with. I have noticed that requests succeeding in our system after 30 minutes due to slow disk/network congestion across 2 nodes.  In addition to this, we should strengthen the ES healthchecks by taking the indexing requests, bulk indexing queues etc. into consideration.\r\n\r\nThoughts?\r\n\r\n\r\n","closed_by":{"login":"astefan","id":893749,"node_id":"MDQ6VXNlcjg5Mzc0OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/893749?v=4","gravatar_id":"","url":"https://api.github.com/users/astefan","html_url":"https://github.com/astefan","followers_url":"https://api.github.com/users/astefan/followers","following_url":"https://api.github.com/users/astefan/following{/other_user}","gists_url":"https://api.github.com/users/astefan/gists{/gist_id}","starred_url":"https://api.github.com/users/astefan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/astefan/subscriptions","organizations_url":"https://api.github.com/users/astefan/orgs","repos_url":"https://api.github.com/users/astefan/repos","events_url":"https://api.github.com/users/astefan/events{/privacy}","received_events_url":"https://api.github.com/users/astefan/received_events","type":"User","site_admin":false},"performed_via_github_app":null}