[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/59349131","html_url":"https://github.com/elastic/elasticsearch/issues/8069#issuecomment-59349131","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8069","id":59349131,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MzQ5MTMx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-10-16T11:42:44Z","updated_at":"2014-10-16T11:42:44Z","author_association":"CONTRIBUTOR","body":"Hi @lukebergen \n\nThe problem is that you are relying on dynamic mapping.  Your first two indexing requests don't create the field `age` (as we have no way of determining what datatype `age` will be from the value `null`).\n\nIf, instead, you map the `age` field before indexing, then your query works correctly:\n\n```\nDELETE /test \n\nPUT /test/\n{\n  \"mappings\": {\n    \"test\": {\n      \"properties\": {\n        \"age\": {\n          \"type\": \"integer\"\n        }\n      }\n    }\n  }\n}\n\nPUT /test/test/1\n{\n  \"name\": \"Finn\",\n  \"age\": null\n}\n\nPUT /test/test/2\n{\n  \"name\": \"Jake\",\n  \"age\": null\n}\n\n\nPOST /test/_search\n{\n  \"query\": {\n    \"function_score\": {\n      \"query\": {\n        \"match_all\": {}\n      },\n      \"functions\": [\n        {\n          \"filter\": {\n            \"exists\": {\n              \"field\": \"age\"\n            }\n          },\n          \"linear\": {\n            \"age\": {\n              \"origin\": 10,\n              \"scale\": 10,\n              \"decay\": 0.9\n            }\n          }\n        }\n      ],\n      \"score_mode\": \"multiply\"\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/213396566","html_url":"https://github.com/elastic/elasticsearch/issues/8069#issuecomment-213396566","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8069","id":213396566,"node_id":"MDEyOklzc3VlQ29tbWVudDIxMzM5NjU2Ng==","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2016-04-22T12:04:06Z","updated_at":"2016-04-22T12:04:06Z","author_association":"CONTRIBUTOR","body":"@clintongormley Wouldn't it make more sense to not even attempt to run the function score if the filter removes the document? We've finally tracked down an issue caused by this, and it's very un-intuitive.\n\nOr am I missing something obvious?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/387074547","html_url":"https://github.com/elastic/elasticsearch/issues/8069#issuecomment-387074547","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8069","id":387074547,"node_id":"MDEyOklzc3VlQ29tbWVudDM4NzA3NDU0Nw==","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2018-05-07T14:02:26Z","updated_at":"2018-08-31T12:12:18Z","author_association":"CONTRIBUTOR","body":"ping @clintongormley We're still having this issue under 6.2.\r\n\r\nBasically, we're running a top-level bool query with two should blocks, hitting two indices. Each should block is tailored to one index. This is restricted using filters. However, it will fail due to missing fields despite these filter restrictions.\r\n\r\n- Each `should` block target one index, via a filter on `_index`. This doesn't work, it will still fail with \"unknown field [mentioned_at]\".\r\n- I've also tried setting a filter inside the `functions` block, with an exists restriction on the field. Doesn't work either.\r\n\r\nIs this issue by design, or a bug?\r\n\r\nIf it's by design, are there other ways we could avoid it, and if not, do you have any planned enhancements around this?\r\n\r\n<summary> ⚠ Expand 'details' below, for the full query ⚠ \r\n<details><p>\r\n\r\n```json\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [{\r\n        \"bool\": {\r\n          \"should\": [{\r\n            \"function_score\": {\r\n              \"query\": {\r\n                \"multi_match\": {\r\n                  \"query\": \"jane\",\r\n                  \"type\": \"phrase_prefix\",\r\n                  \"fields\": [\"name\", \"firm\"]\r\n                }\r\n              },\r\n              \"functions\": [{\r\n                \"filter\": {\r\n                  \"exists\": {\r\n                    \"field\": \"mentioned_at\"\r\n                  }\r\n                },\r\n                \"gauss\": {\r\n                  \"mentioned_at\": {\r\n                    \"origin\": \"2018-05-07T13:49:33Z\",\r\n                    \"scale\": \"180d\",\r\n                    \"offset\": \"5d\",\r\n                    \"decay\": 0.5\r\n                  }\r\n                }\r\n              }, {\r\n                \"filter\": {\r\n                  \"term\": {\r\n                    \"kinsman\": true\r\n                  }\r\n                },\r\n                \"weight\": 1.1\r\n              }],\r\n              \"score_mode\": \"multiply\"\r\n            }\r\n          }],\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"must\": [{\r\n                \"term\": {\r\n                  \"_index\": \"attendees\"\r\n                }\r\n              }, {\r\n                \"term\": {\r\n                  \"owner_id\": \"5acca8d1962d745523000000\"\r\n                }\r\n              }]\r\n            }\r\n          }\r\n        }\r\n      }, {\r\n        \"bool\": {\r\n          \"should\": [{\r\n            \"multi_match\": {\r\n              \"query\": \"jane\",\r\n              \"type\": \"phrase_prefix\",\r\n              \"fields\": [\"name\", \"company\"],\r\n              \"boost\": 1.1\r\n            }\r\n          }],\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"must\": [{\r\n                \"term\": {\r\n                  \"_index\": \"users\"\r\n                }\r\n              }, {\r\n                \"term\": {\r\n                  \"company_id\": \"5acca8d1962d745523000003\"\r\n                }\r\n              }, {\r\n                \"bool\": {\r\n                  \"should\": [{\r\n                    \"range\": {\r\n                      \"archived_at\": {\r\n                        \"gte\": \"2018-02-07T13:49:33Z\"\r\n                      }\r\n                    }\r\n                  }, {\r\n                    \"bool\": {\r\n                      \"must_not\": {\r\n                        \"exists\": {\r\n                          \"field\": \"archived_at\"\r\n                        }\r\n                      }\r\n                    }\r\n                  }]\r\n                }\r\n              }]\r\n            }\r\n          }\r\n        }\r\n      }]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n</p></details>\r\n</summary>","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/417644079","html_url":"https://github.com/elastic/elasticsearch/issues/8069#issuecomment-417644079","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8069","id":417644079,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNzY0NDA3OQ==","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2018-08-31T12:07:17Z","updated_at":"2018-08-31T12:07:17Z","author_association":"CONTRIBUTOR","body":"Friendly ping @original-brownbear @eskibars @jpountz 😄 \r\n\r\nDo you know if the \"unknown field\" issue described above is by design, or a bug?\r\n\r\n*(when looking through other issues it seems like the three of you all work on the mapping and query parts of Elastic Search, but feel free to loop in other people that are better positioned to answer this if needed)*","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/419446946","html_url":"https://github.com/elastic/elasticsearch/issues/8069#issuecomment-419446946","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8069","id":419446946,"node_id":"MDEyOklzc3VlQ29tbWVudDQxOTQ0Njk0Ng==","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2018-09-07T13:55:09Z","updated_at":"2018-09-07T13:55:09Z","author_association":"CONTRIBUTOR","body":"@sandstrom Can you open a new feature issue asking that we allow functions to work on unmapped fields?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/419831234","html_url":"https://github.com/elastic/elasticsearch/issues/8069#issuecomment-419831234","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8069","id":419831234,"node_id":"MDEyOklzc3VlQ29tbWVudDQxOTgzMTIzNA==","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"created_at":"2018-09-10T08:31:25Z","updated_at":"2018-09-10T08:31:25Z","author_association":"CONTRIBUTOR","body":"@jpountz Certainly! https://github.com/elastic/elasticsearch/issues/33558","performed_via_github_app":null}]