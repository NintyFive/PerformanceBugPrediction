{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25315/events","html_url":"https://github.com/elastic/elasticsearch/issues/25315","id":237225395,"node_id":"MDU6SXNzdWUyMzcyMjUzOTU=","number":25315,"title":"Using inner_hits on nested query causes an index_out_of_bounds_exception","user":{"login":"BLZB0B","id":17888955,"node_id":"MDQ6VXNlcjE3ODg4OTU1","avatar_url":"https://avatars1.githubusercontent.com/u/17888955?v=4","gravatar_id":"","url":"https://api.github.com/users/BLZB0B","html_url":"https://github.com/BLZB0B","followers_url":"https://api.github.com/users/BLZB0B/followers","following_url":"https://api.github.com/users/BLZB0B/following{/other_user}","gists_url":"https://api.github.com/users/BLZB0B/gists{/gist_id}","starred_url":"https://api.github.com/users/BLZB0B/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/BLZB0B/subscriptions","organizations_url":"https://api.github.com/users/BLZB0B/orgs","repos_url":"https://api.github.com/users/BLZB0B/repos","events_url":"https://api.github.com/users/BLZB0B/events{/privacy}","received_events_url":"https://api.github.com/users/BLZB0B/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"assignees":[{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2017-06-20T14:16:07Z","updated_at":"2018-02-14T13:26:07Z","closed_at":"2017-09-19T09:18:29Z","author_association":"NONE","active_lock_reason":null,"body":"raised here following [this conversation](https://discuss.elastic.co/t/when-using-inner-hits-on-nested-query-we-are-getting-an-index-out-of-bounds-exception/89968) with Martijn .\r\n\r\n<!-- Bug report -->\r\n\r\nConfig: ES 5.4, AWS Linux, single node (test server), 3 shards, 0 replicas.\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux  4.9.27-14.31.amzn1.x86_64 #1 SMP Wed May 10 01:58:40 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Plugins installed**: [none]\r\n\r\n**JVM version** (`java -version`): build 1.8.0_131-b11\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWe have a set of documents which are replicated to Elastic from Couchbase.\r\n\r\nin the document, we have a \"holiday product\", this product has a nested array of \"prices\", this price object contains fields such as number of passengers, date, promo code, price etc. For each holiday product, this list of prices can be very long as there can be hundreds/thousands of permutations.\r\n\r\nWhen running a query against the data, we don't want to carry the 1000's of lines of data over the wire (can be >5MB) so are trying to use inner_hits to only return the rows that match. (approx 10KB)\r\n\r\nwe have a query such as: \r\n```\r\n{\r\n\"_source\": false,\r\n   \"query\": {\r\n    \"nested\": {\r\n      \"path\": \"doc.products.calculatedPrices\",\r\n      \"score_mode\": \"avg\",\r\n        \"query\": {\r\n        \"bool\": {\r\n          \"must\": [\r\n            { \"match\": { \"doc.products.calculatedPrices.promoCode\": \"DRH725C\" } },\r\n            { \"match\": { \"doc.products.calculatedPrices.pax\": 2 } },\r\n            { \"range\": { \"doc.products.calculatedPrices.now\" : {\"gte\": 100, \"lte\":120} } }\r\n           ]\r\n        }    \r\n\t  },\r\n\t  \"inner_hits\": {}\r\n    }\r\n  }\r\n}\r\n```\r\nthis generates the error:\r\n```\r\n{\r\n    \"took\": 41,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 3,\r\n        \"successful\": 2,\r\n        \"failed\": 1,\r\n        \"failures\": [\r\n            {\r\n                \"shard\": 2,\r\n                \"index\": \"testavail5\",\r\n                \"node\": \"AfXKKfqrSPqOrNO7mLreEQ\",\r\n                \"reason\": {\r\n                    \"type\": \"index_out_of_bounds_exception\",\r\n                    \"reason\": \"Index: 7290, Size: 134\"\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"hits\": {\r\n        \"total\": 62,\r\n        \"max_score\": 5.845086,\r\n        \"hits\": []\r\n    }\r\n}\r\n```\r\nOn this test server, we are running a single node with 3 shards. so not sure why one shard reports as failed.\r\n\r\nif we change the\r\n`inner_hits\": {}` to `inner_hits\": {\"_source\":false}`\r\n\r\nwe get results but obviously don't get any useful information in the output!\r\n\r\ntrace log:\r\n```\r\n[2017-06-20T11:46:58,972][TRACE][o.e.s.SearchService      ] [AfXKKfq] Fetch phase failed\r\njava.lang.IndexOutOfBoundsException: Index: 7290, Size: 134\r\n        at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[?:1.8.0_131]\r\n        at java.util.ArrayList.get(ArrayList.java:429) ~[?:1.8.0_131]\r\n        at org.elasticsearch.search.fetch.FetchPhase.createNestedSearchHit(FetchPhase.java:256) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:150) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitExecute(InnerHitsFetchSubPhase.java:65) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:161) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:417) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.action.search.SearchTransportService$12.messageReceived(SearchTransportService.java:394) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.action.search.SearchTransportService$12.messageReceived(SearchTransportService.java:391) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:627) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\n[2017-06-20T11:46:58,973][DEBUG][o.e.a.s.TransportSearchAction] [AfXKKfq] [6] Failed to execute fetch phase\r\norg.elasticsearch.transport.RemoteTransportException: [AfXKKfq][172.31.35.8:9300][indices:data/read/search[phase/fetch/id]]\r\nCaused by: java.lang.IndexOutOfBoundsException: Index: 7290, Size: 134\r\n        at java.util.ArrayList.rangeCheck(ArrayList.java:653) ~[?:1.8.0_131]\r\n        at java.util.ArrayList.get(ArrayList.java:429) ~[?:1.8.0_131]\r\n        at org.elasticsearch.search.fetch.FetchPhase.createNestedSearchHit(FetchPhase.java:256) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:150) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.fetch.subphase.InnerHitsFetchSubPhase.hitExecute(InnerHitsFetchSubPhase.java:65) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:161) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:417) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.action.search.SearchTransportService$12.messageReceived(SearchTransportService.java:394) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.action.search.SearchTransportService$12.messageReceived(SearchTransportService.java:391) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.transport.TransportService$7.doRun(TransportService.java:627) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:638) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.4.0.jar:5.4.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_131]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_131]\r\n        at java.lang.Thread.run(Thread.java:748) [?:1.8.0_131]\r\n```\r\n\r\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}