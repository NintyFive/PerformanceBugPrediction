{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/47270","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47270/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47270/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/47270/events","html_url":"https://github.com/elastic/elasticsearch/issues/47270","id":499950220,"node_id":"MDU6SXNzdWU0OTk5NTAyMjA=","number":47270,"title":"Elasticsearch snapshots on Azure Blob stops suddenly with weird error","user":{"login":"sunilthemaster","id":5255193,"node_id":"MDQ6VXNlcjUyNTUxOTM=","avatar_url":"https://avatars3.githubusercontent.com/u/5255193?v=4","gravatar_id":"","url":"https://api.github.com/users/sunilthemaster","html_url":"https://github.com/sunilthemaster","followers_url":"https://api.github.com/users/sunilthemaster/followers","following_url":"https://api.github.com/users/sunilthemaster/following{/other_user}","gists_url":"https://api.github.com/users/sunilthemaster/gists{/gist_id}","starred_url":"https://api.github.com/users/sunilthemaster/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sunilthemaster/subscriptions","organizations_url":"https://api.github.com/users/sunilthemaster/orgs","repos_url":"https://api.github.com/users/sunilthemaster/repos","events_url":"https://api.github.com/users/sunilthemaster/events{/privacy}","received_events_url":"https://api.github.com/users/sunilthemaster/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"assignees":[{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2019-09-29T18:10:24Z","updated_at":"2019-09-30T10:58:07Z","closed_at":"2019-09-30T10:58:07Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** : 6.5.4\r\n\r\n**Plugins installed**: [azure snapshot]\r\n\r\n**JVM version** : java-1.8.0-openjdk\r\n\r\n**OS version** : Linux b77b85b8bc22 4.15.0-1049-azure\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nI have multiple environments on Azure. Each of the env. has multiple node elasticsearch cluster.\r\n\r\neverything was working fine for months and now suddenly ES snapshot stopped worked with weird error. Error during snapshot is below\r\n\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"storage_exception\",\r\n        \"reason\": \"storage_exception: The specified account does not exist.\"\r\n      }\r\n    ],\r\n    \"type\": \"no_such_element_exception\",\r\n    \"reason\": \"no_such_element_exception: An error occurred while enumerating the result, check the original exception for details.\",\r\n    \"caused_by\": {\r\n      \"type\": \"storage_exception\",\r\n      \"reason\": \"storage_exception: The specified account does not exist.\",\r\n      \"caused_by\": {\r\n        \"type\": \"null_pointer_exception\",\r\n        \"reason\": null\r\n      }\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\nI verified all permissions and key are same. There is no change in any Blob permission or so. I tried even restarting ES master node but no luck.\r\n\r\nIf I run blob upload command from same server to same Blob, it works fine - this proves there is no permission issue.\r\n\r\nI enabled debugging of Azure ES snapshot plugin to see actual error but error is not much meaningful\r\n\r\nES logs says\r\n\r\n> [2019-09-29T05:07:09,971][WARN ][r.suppressed ] [afqLC7_] path: /_snapshot/esbackuprepository/data01, params: {pretty=, repository=esbackuprepository, snapshot=data01} java.util.NoSuchElementException: An error occurred while enumerating the result, check the original exception for details. at com.microsoft.azure.storage.core.LazySegmentedIterator.hasNext(LazySegmentedIterator.java:113) ~[?:?] at org.elasticsearch.cloud.azure.storage.AzureStorageService.lambda$listBlobsByPrefix$14(AzureStorageService.java:227) ~[?:?] at org.elasticsearch.cloud.azure.blobstore.util.SocketAccess.lambda$doPrivilegedVoidException$0(SocketAccess.java:64) ~[?:?] at java.security.AccessController.doPrivileged(Native Method) ~[?:1.8.0_201] at org.elasticsearch.cloud.azure.blobstore.util.SocketAccess.doPrivilegedVoidException(SocketAccess.java:63) ~[?:?] at org.elasticsearch.cloud.azure.storage.AzureStorageService.listBlobsByPrefix(AzureStorageService.java:226) ~[?:?] at org.elasticsearch.cloud.azure.blobstore.AzureBlobStore.listBlobsByPrefix(AzureBlobStore.java:119) ~[?:?] at org.elasticsearch.cloud.azure.blobstore.AzureBlobContainer.listBlobsByPrefix(AzureBlobContainer.java:120) ~[?:?] at org.elasticsearch.repositories.blobstore.BlobStoreRepository.listBlobsToGetLatestIndexId(BlobStoreRepository.java:822) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.repositories.blobstore.BlobStoreRepository.latestIndexBlobId(BlobStoreRepository.java:800) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.repositories.blobstore.BlobStoreRepository.getRepositoryData(BlobStoreRepository.java:663) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.snapshots.SnapshotsService.createSnapshot(SnapshotsService.java:235) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.action.admin.cluster.snapshots.create.TransportCreateSnapshotAction.masterOperation(TransportCreateSnapshotAction.java:83) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.action.admin.cluster.snapshots.create.TransportCreateSnapshotAction.masterOperation(TransportCreateSnapshotAction.java:41) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.action.support.master.TransportMasterNodeAction.masterOperation(TransportMasterNodeAction.java:108) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.action.support.master.TransportMasterNodeAction$AsyncSingleAction$2.doRun(TransportMasterNodeAction.java:195) ~[elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:723) [elasticsearch-6.5.4.jar:6.5.4] at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-6.5.4.jar:6.5.4] at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149) [?:1.8.0_201] at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624) [?:1.8.0_201] at java.lang.Thread.run(Thread.java:748) [?:1.8.0_201] Caused by: com.microsoft.azure.storage.StorageException: The specified account does not exist. at com.microsoft.azure.storage.StorageException.translateException(StorageException.java:87) ~[?:?] at com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:209) ~[?:?] at com.microsoft.azure.storage.core.LazySegmentedIterator.hasNext(LazySegmentedIterator.java:109) ~[?:?] ... 20 more Caused by: java.lang.NullPointerException at com.microsoft.azure.storage.core.ExecutionEngine.executeWithRetry(ExecutionEngine.java:189) ~[?:?] at com.microsoft.azure.storage.core.LazySegmentedIterator.hasNext(LazySegmentedIterator.java:109) ~[?:?] ... 20 more\r\n\r\nOn changing snapshot settings to some other folder is also failing with exception\r\n```\r\n{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"repository_verification_exception\",\r\n        \"reason\": \"[esbackuprepository] path [engg-az-dev2] is not accessible on master node\"\r\n      }\r\n    ],\r\n    \"type\": \"repository_verification_exception\",\r\n    \"reason\": \"[esbackuprepository] path [engg-az-dev2] is not accessible on master node\",\r\n    \"caused_by\": {\r\n      \"type\": \"i_o_exception\",\r\n      \"reason\": \"Can not write blob master.dat\",\r\n      \"caused_by\": {\r\n        \"type\": \"storage_exception\",\r\n        \"reason\": \"The specified account does not exist.\",\r\n        \"caused_by\": {\r\n          \"type\": \"null_pointer_exception\",\r\n          \"reason\": null\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"status\": 500\r\n}\r\n```\r\nAny thoughts?\r\n\r\n**Steps to reproduce**:\r\nNo clue on how to replicate the error.\r\n","closed_by":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"performed_via_github_app":null}