{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/33558","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33558/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33558/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33558/events","html_url":"https://github.com/elastic/elasticsearch/issues/33558","id":358518704,"node_id":"MDU6SXNzdWUzNTg1MTg3MDQ=","number":33558,"title":"Allow functions to work on unmapped fields","user":{"login":"sandstrom","id":122287,"node_id":"MDQ6VXNlcjEyMjI4Nw==","avatar_url":"https://avatars2.githubusercontent.com/u/122287?v=4","gravatar_id":"","url":"https://api.github.com/users/sandstrom","html_url":"https://github.com/sandstrom","followers_url":"https://api.github.com/users/sandstrom/followers","following_url":"https://api.github.com/users/sandstrom/following{/other_user}","gists_url":"https://api.github.com/users/sandstrom/gists{/gist_id}","starred_url":"https://api.github.com/users/sandstrom/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sandstrom/subscriptions","organizations_url":"https://api.github.com/users/sandstrom/orgs","repos_url":"https://api.github.com/users/sandstrom/repos","events_url":"https://api.github.com/users/sandstrom/events{/privacy}","received_events_url":"https://api.github.com/users/sandstrom/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23172,"node_id":"MDU6TGFiZWwyMzE3Mg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Efeature","name":">feature","color":"006b75","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":6,"created_at":"2018-09-10T08:29:36Z","updated_at":"2018-11-13T16:20:23Z","closed_at":"2018-11-12T19:40:15Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"## Problem\r\n\r\nFunction queries against unmapped fields doesn't work. Adding support for it would be very useful.\r\n\r\n## Example\r\n\r\nWe're running a top-level bool query with two should blocks, hitting two indices. Each should block is tailored to one index. This is restricted using filters. However, it will fail due to missing fields despite these filter restrictions.\r\n\r\n- Each `should`-block target one index, via a filter on `_index`. This doesn't work, it will still fail with \"unknown field [mentioned_at]\".\r\n- I've also tried setting a filter inside the `functions` block, with an exists restriction on the field. Doesn't work either.\r\n\r\n## Env\r\n\r\nVersion: 6.4.0\r\n\r\n## More details\r\n\r\nThis was originally discussed in https://github.com/elastic/elasticsearch/issues/8069, and @jpountz asked me to open a new issue about this. Please let me know if I should elaborate on anything.\r\n\r\n## Full example query\r\n\r\n<summary> ⚠ Expand 'details' below, for the full query ⚠ \r\n<details><p>\r\n\r\n```json\r\n{\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"should\": [{\r\n        \"bool\": {\r\n          \"should\": [{\r\n            \"function_score\": {\r\n              \"query\": {\r\n                \"multi_match\": {\r\n                  \"query\": \"jane\",\r\n                  \"type\": \"phrase_prefix\",\r\n                  \"fields\": [\"name\", \"firm\"]\r\n                }\r\n              },\r\n              \"functions\": [{\r\n                \"filter\": {\r\n                  \"exists\": {\r\n                    \"field\": \"mentioned_at\"\r\n                  }\r\n                },\r\n                \"gauss\": {\r\n                  \"mentioned_at\": {\r\n                    \"origin\": \"2018-05-07T13:49:33Z\",\r\n                    \"scale\": \"180d\",\r\n                    \"offset\": \"5d\",\r\n                    \"decay\": 0.5\r\n                  }\r\n                }\r\n              }, {\r\n                \"filter\": {\r\n                  \"term\": {\r\n                    \"kinsman\": true\r\n                  }\r\n                },\r\n                \"weight\": 1.1\r\n              }],\r\n              \"score_mode\": \"multiply\"\r\n            }\r\n          }],\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"must\": [{\r\n                \"term\": {\r\n                  \"_index\": \"attendees\"\r\n                }\r\n              }, {\r\n                \"term\": {\r\n                  \"owner_id\": \"abc\"\r\n                }\r\n              }]\r\n            }\r\n          }\r\n        }\r\n      }, {\r\n        \"bool\": {\r\n          \"should\": [{\r\n            \"multi_match\": {\r\n              \"query\": \"jane\",\r\n              \"type\": \"phrase_prefix\",\r\n              \"fields\": [\"name\", \"company\"],\r\n              \"boost\": 1.1\r\n            }\r\n          }],\r\n          \"filter\": {\r\n            \"bool\": {\r\n              \"must\": [{\r\n                \"term\": {\r\n                  \"_index\": \"users\"\r\n                }\r\n              }, {\r\n                \"term\": {\r\n                  \"company_id\": \"abc\"\r\n                }\r\n              }, {\r\n                \"bool\": {\r\n                  \"should\": [{\r\n                    \"range\": {\r\n                      \"archived_at\": {\r\n                        \"gte\": \"2018-02-07T13:49:33Z\"\r\n                      }\r\n                    }\r\n                  }, {\r\n                    \"bool\": {\r\n                      \"must_not\": {\r\n                        \"exists\": {\r\n                          \"field\": \"archived_at\"\r\n                        }\r\n                      }\r\n                    }\r\n                  }]\r\n                }\r\n              }]\r\n            }\r\n          }\r\n        }\r\n      }]\r\n    }\r\n  }\r\n}\r\n```\r\n\r\n</p></details>\r\n</summary>\r\n","closed_by":{"login":"mayya-sharipova","id":5738841,"node_id":"MDQ6VXNlcjU3Mzg4NDE=","avatar_url":"https://avatars1.githubusercontent.com/u/5738841?v=4","gravatar_id":"","url":"https://api.github.com/users/mayya-sharipova","html_url":"https://github.com/mayya-sharipova","followers_url":"https://api.github.com/users/mayya-sharipova/followers","following_url":"https://api.github.com/users/mayya-sharipova/following{/other_user}","gists_url":"https://api.github.com/users/mayya-sharipova/gists{/gist_id}","starred_url":"https://api.github.com/users/mayya-sharipova/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mayya-sharipova/subscriptions","organizations_url":"https://api.github.com/users/mayya-sharipova/orgs","repos_url":"https://api.github.com/users/mayya-sharipova/repos","events_url":"https://api.github.com/users/mayya-sharipova/events{/privacy}","received_events_url":"https://api.github.com/users/mayya-sharipova/received_events","type":"User","site_admin":false},"performed_via_github_app":null}