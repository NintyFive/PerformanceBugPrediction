{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/40998","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40998/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40998/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/40998/events","html_url":"https://github.com/elastic/elasticsearch/issues/40998","id":430840862,"node_id":"MDU6SXNzdWU0MzA4NDA4NjI=","number":40998,"title":"Self-intersecting shape reports strange error","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2019-04-09T08:41:38Z","updated_at":"2019-04-12T05:14:30Z","closed_at":"2019-04-12T05:14:30Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"In 6.6.2 I tried the following commands to index a shape with a hole that touches its edge:\r\n\r\n```\r\nPUT /i\r\n{\r\n  \"mappings\": {\r\n    \"_doc\": {\r\n      \"properties\": {\r\n        \"f\": {\r\n          \"type\": \"geo_shape\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nPOST /i/_doc\r\n{\r\n  \"f\": {\r\n    \"coordinates\": [\r\n      [\r\n        [\r\n          0,\r\n          0\r\n        ],\r\n        [\r\n          2,\r\n          0\r\n        ],\r\n        [\r\n          1,\r\n          1\r\n        ],\r\n        [\r\n          1,\r\n          2\r\n        ],\r\n        [\r\n          2,\r\n          0\r\n        ],\r\n        [\r\n          2,\r\n          3\r\n        ],\r\n        [\r\n          0,\r\n          3\r\n        ],\r\n        [\r\n          0,\r\n          0\r\n        ]\r\n      ]\r\n    ],\r\n    \"type\": \"Polygon\"\r\n  }\r\n}\r\n```\r\n\r\nThis yielded the following response:\r\n\r\n```\r\n# 400 Bad Request\r\n# {\r\n#   \"status\": 400,\r\n#   \"error\": {\r\n#     \"caused_by\": {\r\n#       \"reason\": \"at least 4 polygon points required\",\r\n#       \"type\": \"illegal_argument_exception\"\r\n#     },\r\n#     \"reason\": \"failed to parse field [f] of type [geo_shape]\",\r\n#     \"root_cause\": [\r\n#       {\r\n#         \"reason\": \"failed to parse field [f] of type [geo_shape]\",\r\n#         \"type\": \"mapper_parsing_exception\"\r\n#       }\r\n#     ],\r\n#     \"type\": \"mapper_parsing_exception\"\r\n#   }\r\n# }\r\n```\r\n\r\nI think this shape should indeed be rejected since it is self-intersecting at `[2,0]`, but the exception message seems wrong since there are enough points.\r\n\r\n~I tried the same commands in 7.0.0-rc1 and this shape was accepted, which I also think shouldn't be the case.~ (edit, not true, see below)\r\n\r\nThe shape in question looks like this:\r\n\r\n<img width=\"138\" alt=\"Screenshot 2019-04-09 at 09 38 22\" src=\"https://user-images.githubusercontent.com/5058284/55786109-89d73280-5aab-11e9-9729-886964484eab.png\">\r\n\r\nDerived from the issue reported here: https://discuss.elastic.co/t/failed-to-create-valid-geo-shape/175975","closed_by":{"login":"iverase","id":29038686,"node_id":"MDQ6VXNlcjI5MDM4Njg2","avatar_url":"https://avatars1.githubusercontent.com/u/29038686?v=4","gravatar_id":"","url":"https://api.github.com/users/iverase","html_url":"https://github.com/iverase","followers_url":"https://api.github.com/users/iverase/followers","following_url":"https://api.github.com/users/iverase/following{/other_user}","gists_url":"https://api.github.com/users/iverase/gists{/gist_id}","starred_url":"https://api.github.com/users/iverase/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/iverase/subscriptions","organizations_url":"https://api.github.com/users/iverase/orgs","repos_url":"https://api.github.com/users/iverase/repos","events_url":"https://api.github.com/users/iverase/events{/privacy}","received_events_url":"https://api.github.com/users/iverase/received_events","type":"User","site_admin":false},"performed_via_github_app":null}