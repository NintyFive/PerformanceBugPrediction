{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27928","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27928/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27928/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27928/events","html_url":"https://github.com/elastic/elasticsearch/issues/27928","id":283600359,"node_id":"MDU6SXNzdWUyODM2MDAzNTk=","number":27928,"title":"Null pointer exception using Global Aggregation and then Nested Aggregation","user":{"login":"xserrat","id":5933658,"node_id":"MDQ6VXNlcjU5MzM2NTg=","avatar_url":"https://avatars1.githubusercontent.com/u/5933658?v=4","gravatar_id":"","url":"https://api.github.com/users/xserrat","html_url":"https://github.com/xserrat","followers_url":"https://api.github.com/users/xserrat/followers","following_url":"https://api.github.com/users/xserrat/following{/other_user}","gists_url":"https://api.github.com/users/xserrat/gists{/gist_id}","starred_url":"https://api.github.com/users/xserrat/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xserrat/subscriptions","organizations_url":"https://api.github.com/users/xserrat/orgs","repos_url":"https://api.github.com/users/xserrat/repos","events_url":"https://api.github.com/users/xserrat/events{/privacy}","received_events_url":"https://api.github.com/users/xserrat/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-12-20T15:29:00Z","updated_at":"2018-01-06T09:48:45Z","closed_at":"2018-01-05T10:41:37Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.1.2\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\nopenjdk version \"1.8.0_151\"\r\nOpenJDK Runtime Environment (build 1.8.0_151-b12)\r\nOpenJDK 64-Bit Server VM (build 25.151-b12, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\nLinux xxxx 2.6.32-642.el6.x86_64 #1 SMP Tue May 10 17:27:01 UTC 2016 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI just make a query with some filters and retrieve the corresponding documents. Also, I try to add aggregations about these documents with a `NestedAggregation` and **without any filter** used in the `query` so I used at the very beginning the `GlobalAggregation`.\r\n\r\nWhen I make the request I get a `Null Pointer exception` from elastic log. However, I get results from aggregations but also, an error.\r\n\r\nRequest:\r\n\r\n```\r\n{\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"filter\": [\r\n                {\r\n                    \"bool\": {\r\n                        \"must\": [\r\n                            {\r\n                                \"nested\": {\r\n                                    \"path\": \"attributes\",\r\n                                    \"query\": {\r\n                                        \"bool\": {\r\n                                            \"must\": [\r\n                                                {\r\n                                                    \"nested\": {\r\n                                                        \"path\": \"attributes.value\",\r\n                                                        \"query\": {\r\n                                                            \"term\": {\r\n                                                                \"attributes.value.group_value\": \"4\"\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n                                                },\r\n                                                {\r\n                                                    \"term\": {\r\n                                                        \"attributes.id\": \"2\"\r\n                                                    }\r\n                                                }\r\n                                            ]\r\n                                        }\r\n                                    }\r\n                                }\r\n                            },\r\n                            {\r\n                                \"nested\": {\r\n                                    \"path\": \"path\",\r\n                                    \"query\": {\r\n                                        \"term\": {\r\n                                            \"path.id_category\": \"1\"\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        ]\r\n                    }\r\n                }\r\n            ]\r\n        }\r\n    },\r\n    \"aggregations\": {\r\n        \"all_wine_types\": {\r\n            \"global\": {},\r\n            \"aggregations\": {\r\n                \"all_wine_types\": {\r\n                    \"nested\": {\r\n                        \"path\": \"attributes\"\r\n                    },\r\n                    \"aggregations\": {\r\n                        \"all_wine_types\": {\r\n                            \"filter\": {\r\n                                \"term\": {\r\n                                    \"attributes.id\": \"2\"\r\n                                }\r\n                            },\r\n                            \"aggregations\": {\r\n                                \"all_wine_type_values\": {\r\n                                    \"nested\": {\r\n                                        \"path\": \"attributes.value\"\r\n                                    },\r\n                                    \"aggregations\": {\r\n                                        \"wine_type_value\": {\r\n                                            \"terms\": {\r\n                                                \"field\": \"attributes.value.group_value\"\r\n                                            },\r\n                                            \"aggregations\": {\r\n                                                \"data\": {\r\n                                                    \"reverse_nested\": {},\r\n                                                    \"aggregations\": {\r\n                                                        \"data\": {\r\n                                                            \"top_hits\": {\r\n                                                                \"size\": 1,\r\n                                                                \"_source\": {\r\n                                                                    \"includes\": [\r\n                                                                        \"attributes\"\r\n                                                                    ]\r\n                                                                }\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n                                                },\r\n                                                \"root_data\": {\r\n                                                    \"reverse_nested\": {},\r\n                                                    \"aggregations\": {\r\n                                                        \"data\": {\r\n                                                            \"top_hits\": {\r\n                                                                \"size\": 1,\r\n                                                                \"_source\": {\r\n                                                                    \"includes\": [\r\n                                                                        \"path\"\r\n                                                                    ]\r\n                                                                }\r\n                                                            }\r\n                                                        }\r\n                                                    }\r\n                                                }\r\n                                            }\r\n                                        }\r\n                                    }\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"size\": 0\r\n}\r\n\r\n```\r\n\r\nResponse:\r\n\r\n```\r\n{\r\n    \"took\": 45,\r\n    \"timed_out\": false,\r\n    \"_shards\": {\r\n        \"total\": 5,\r\n        \"successful\": 4,\r\n        \"failed\": 1,\r\n        \"failures\": [\r\n            {\r\n                \"shard\": 4,\r\n                \"index\": \"xxxxx\",\r\n                \"node\": \"4__8482PTbacWtnUnX4d8g\",\r\n                \"reason\": {\r\n                    \"type\": \"null_pointer_exception\",\r\n                    \"reason\": null\r\n                }\r\n            }\r\n        ]\r\n    },\r\n    \"hits\": {\r\n        \"total\": 18544,\r\n        \"max_score\": 0,\r\n        \"hits\": []\r\n    },\r\n```\r\n\r\n**Steps to reproduce**:\r\n\r\nNo steps!\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n```\r\n2017-12-20T15:54:54,361][DEBUG][o.e.a.s.TransportSearchAction] [4__8482] [xxxxx][4], node[4__8482PTbacWtnUnX4d8g], [P], s[STARTED], a[id=LOwrt7QKRK6bdrhhakAkRg]: Failed to execute [SearchRequest{searchType=QUERY_THEN_FETCH, indices=[xxxxx], indicesOptions=IndicesOptions[id=38, ignore_unavailable=false, allow_no_indices=true, expand_wildcards_open=true, expand_wildcards_closed=false, allow_alisases_to_multiple_indices=true, forbid_closed_indices=true], types=[product], routing='null', preference='null', requestCache=null, scroll=null, source={\r\n  \"size\" : 0,\r\n  \"query\" : {\r\n    \"bool\" : {\r\n      \"filter\" : [\r\n        {\r\n          \"bool\" : {\r\n            \"must\" : [\r\n              {\r\n                \"nested\" : {\r\n                  \"query\" : {\r\n                    \"bool\" : {\r\n                      \"must\" : [\r\n                        {\r\n                          \"nested\" : {\r\n                            \"query\" : {\r\n                              \"term\" : {\r\n                                \"attributes.value.group_value\" : {\r\n                                  \"value\" : \"4\",\r\n                                  \"boost\" : 1.0\r\n                                }\r\n                              }\r\n                            },\r\n                            \"path\" : \"attributes.value\",\r\n                            \"ignore_unmapped\" : false,\r\n                            \"score_mode\" : \"avg\",\r\n                            \"boost\" : 1.0\r\n                          }\r\n                        },\r\n                        {\r\n                          \"term\" : {\r\n                            \"attributes.id\" : {\r\n                              \"value\" : \"2\",\r\n                              \"boost\" : 1.0\r\n                            }\r\n                          }\r\n                        }\r\n                      ],\r\n                      \"disable_coord\" : false,\r\n                      \"adjust_pure_negative\" : true,\r\n                      \"boost\" : 1.0\r\n                    }\r\n                  },\r\n                  \"path\" : \"attributes\",\r\n                  \"ignore_unmapped\" : false,\r\n                  \"score_mode\" : \"avg\",\r\n                  \"boost\" : 1.0\r\n                }\r\n              },\r\n              {\r\n                \"nested\" : {\r\n                  \"query\" : {\r\n                    \"term\" : {\r\n                      \"path.id_category\" : {\r\n                        \"value\" : \"1\",\r\n                        \"boost\" : 1.0\r\n                      }\r\n                    }\r\n                  },\r\n                  \"path\" : \"path\",\r\n                  \"ignore_unmapped\" : false,\r\n                  \"score_mode\" : \"avg\",\r\n                  \"boost\" : 1.0\r\n                }\r\n              }\r\n            ],\r\n            \"disable_coord\" : false,\r\n            \"adjust_pure_negative\" : true,\r\n            \"boost\" : 1.0\r\n          }\r\n        }\r\n      ],\r\n      \"disable_coord\" : false,\r\n      \"adjust_pure_negative\" : true,\r\n      \"boost\" : 1.0\r\n    }\r\n  },\r\n  \"aggregations\" : {\r\n    \"all_wine_types\" : {\r\n      \"global\" : { },\r\n      \"aggregations\" : {\r\n        \"all_wine_types\" : {\r\n          \"nested\" : {\r\n            \"path\" : \"attributes\"\r\n          },\r\n          \"aggregations\" : {\r\n            \"all_wine_types\" : {\r\n              \"filter\" : {\r\n                \"term\" : {\r\n                  \"attributes.id\" : {\r\n                    \"value\" : \"2\",\r\n                    \"boost\" : 1.0\r\n                  }\r\n                }\r\n              },\r\n              \"aggregations\" : {\r\n                \"all_wine_type_values\" : {\r\n                  \"nested\" : {\r\n                    \"path\" : \"attributes.value\"\r\n                  },\r\n                  \"aggregations\" : {\r\n                    \"wine_type_value\" : {\r\n                      \"terms\" : {\r\n                        \"field\" : \"attributes.value.group_value\",\r\n                        \"size\" : 10,\r\n                        \"shard_size\" : -1,\r\n                        \"min_doc_count\" : 1,\r\n                        \"shard_min_doc_count\" : 0,\r\n                        \"show_term_doc_count_error\" : false,\r\n                        \"order\" : [\r\n                          {\r\n                            \"_count\" : \"desc\"\r\n                          },\r\n                          {\r\n                            \"_term\" : \"asc\"\r\n                          }\r\n                        ]\r\n                      },\r\n                      \"aggregations\" : {\r\n                        \"data\" : {\r\n                          \"reverse_nested\" : { },\r\n                          \"aggregations\" : {\r\n                            \"data\" : {\r\n                              \"top_hits\" : {\r\n                                \"from\" : 0,\r\n                                \"size\" : 1,\r\n                                \"version\" : false,\r\n                                \"explain\" : false,\r\n                                \"_source\" : {\r\n                                  \"includes\" : [\r\n                                    \"attributes\"\r\n                                  ],\r\n                                  \"excludes\" : [ ]\r\n                                }\r\n                              }\r\n                            }\r\n                          }\r\n                        },\r\n                        \"root_data\" : {\r\n                          \"reverse_nested\" : { },\r\n                          \"aggregations\" : {\r\n                            \"data\" : {\r\n                              \"top_hits\" : {\r\n                                \"from\" : 0,\r\n                                \"size\" : 1,\r\n                                \"version\" : false,\r\n                                \"explain\" : false,\r\n                                \"_source\" : {\r\n                                  \"includes\" : [\r\n                                    \"path\"\r\n                                  ],\r\n                                  \"excludes\" : [ ]\r\n                                }\r\n                              }\r\n                            }\r\n                          }\r\n                        }\r\n                      }\r\n                    }\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"ext\" : { }\r\n}}]\r\norg.elasticsearch.transport.RemoteTransportException: [4__8482][192.168.1.12:9300][indices:data/read/search[phase/query]]\r\nCaused by: java.lang.NullPointerException\r\n```\r\n\r\nThank you so much!","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}