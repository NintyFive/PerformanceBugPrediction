[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323250070","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323250070","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323250070,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzI1MDA3MA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T03:28:57Z","updated_at":"2017-08-18T03:28:57Z","author_association":"MEMBER","body":"That would not be the limit because Netty (our underlying networking framework) uses its own direct buffer space. With the settings we provide by default, that should lead to up to another `MaxDirectMemorySize` being used. Can you do a few things:\r\n - start Elasticsearch with `logger.io.netty.util.internal.PlatformDependent=debug` (either `-E` on the command line or in the elasticsearch.yml) and share the output of the log lines that match `i.n.u.i.PlatformDependent`?\r\n - use native memory tracking: start Elasticsearch with `-XX:NativeMemoryTracking=detail`, immediately after start execute `jcmd <PID> VM.native_memory baseline` then capture a few times as the leak grows `jcmd <PID> VM.native_memory detail.diff`\r\n - remove the JVM option `-XX:+DisableExplicitGC` (see #25759 for why)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323311156","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323311156","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323311156,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzMxMTE1Ng==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T09:50:36Z","updated_at":"2017-08-18T09:50:36Z","author_association":"NONE","body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\nVersion: 5.5.1, Build: 19c13d0/2017-07-18T20:44:24.823Z, JVM: 1.8.0_144\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\njava version \"1.8.0_144\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_144-b01)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.144-b01, mixed mode)\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux 3.13.0-128-generic #177-Ubuntu SMP Tue Aug 8 11:40:23 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWe have the same issue with 5.5.1, we upgraded from 5.3.0.\r\nIt only affects our master nodes though, especially the active master.\r\nWe didn't see the problem in staging, but our staging environment doesn't have the workload of our production environment (heavy indexing).\r\n\r\nThe HEAP is fine, it seems to be non HEAP. With 5.3.0, the RSS was always ~100% the HEAP size. With 5.5.1, the RSS will grow until ~200% the HEAP size and then vary between ~150% and ~200%. We confirmed this by reducing the HEAP size. We used to have OOM because our heap size was half of RAM, but now it's fine with heap size at the quarter of RAM.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Start a cluster with fixed HEAP size, memory_lock = true\r\n 2. Do heavy indexing\r\n 3. Master RSS will grow until\r\n\r\n**Provide logs (if relevant)**:\r\n* **With logger.io.netty.util.internal.PlatformDependent=debug :**\r\n```\r\n[2017-08-18T11:10:19,079][DEBUG][i.n.u.i.PlatformDependent] Java version: 8\r\n[2017-08-18T11:10:19,080][DEBUG][i.n.u.i.PlatformDependent] maxDirectMemory: 4056416256 bytes (maybe)\r\n[2017-08-18T11:10:19,080][DEBUG][i.n.u.i.PlatformDependent] -Dio.netty.tmpdir: /tmp (java.io.tmpdir)\r\n[2017-08-18T11:10:19,080][DEBUG][i.n.u.i.PlatformDependent] -Dio.netty.bitMode: 64 (sun.arch.data.model)\r\n[2017-08-18T11:10:19,081][DEBUG][i.n.u.i.PlatformDependent] -Dio.netty.noPreferDirect: true\r\n[2017-08-18T11:10:19,081][DEBUG][i.n.u.i.PlatformDependent] -Dio.netty.maxDirectMemory: -1 bytes\r\n[2017-08-18T11:10:19,081][DEBUG][i.n.u.i.PlatformDependent] -Dio.netty.uninitializedArrayAllocationThreshold: -1\r\n[2017-08-18T11:10:19,099][DEBUG][i.n.u.i.PlatformDependent] org.jctools-core.MpscChunkedArrayQueue: unavailable\r\n```\r\n\r\n* **native memory tracking:**\r\nHere different VM.native_memory detail.diff at various RSS sizes (Seems to be 'Internal' growing)\r\n[memory-6G.txt](https://github.com/elastic/elasticsearch/files/1233987/memory-6G.txt)\r\n[memory-7G.txt](https://github.com/elastic/elasticsearch/files/1233988/memory-7G.txt)\r\n[memory-8G.txt](https://github.com/elastic/elasticsearch/files/1233989/memory-8G.txt)\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323380650","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323380650","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323380650,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzM4MDY1MA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T15:12:46Z","updated_at":"2017-08-18T15:12:46Z","author_association":"MEMBER","body":"@Shizuu Can you verify the JVM options that Elasticearch is started with? They are printed in the logs on startup, can you share the log line here?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323434418","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323434418","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323434418,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQzNDQxOA==","user":{"login":"erik-stephens","id":3054461,"node_id":"MDQ6VXNlcjMwNTQ0NjE=","avatar_url":"https://avatars1.githubusercontent.com/u/3054461?v=4","gravatar_id":"","url":"https://api.github.com/users/erik-stephens","html_url":"https://github.com/erik-stephens","followers_url":"https://api.github.com/users/erik-stephens/followers","following_url":"https://api.github.com/users/erik-stephens/following{/other_user}","gists_url":"https://api.github.com/users/erik-stephens/gists{/gist_id}","starred_url":"https://api.github.com/users/erik-stephens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erik-stephens/subscriptions","organizations_url":"https://api.github.com/users/erik-stephens/orgs","repos_url":"https://api.github.com/users/erik-stephens/repos","events_url":"https://api.github.com/users/erik-stephens/events{/privacy}","received_events_url":"https://api.github.com/users/erik-stephens/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T18:56:27Z","updated_at":"2017-08-18T18:56:27Z","author_association":"NONE","body":"I disabled the disabling of explicit GC and enabled that netty debug logging:\r\n```\r\n[2017-08-18T18:21:55,973][DEBUG][io.netty.util.internal.PlatformDependent] Java version: 8\r\n[2017-08-18T18:21:55,974][DEBUG][io.netty.util.internal.PlatformDependent] maxDirectMemory: 32098877440 bytes (maybe)\r\n[2017-08-18T18:21:55,975][DEBUG][io.netty.util.internal.PlatformDependent] -Dio.netty.tmpdir: /tmp (java.io.tmpdir)\r\n[2017-08-18T18:21:55,975][DEBUG][io.netty.util.internal.PlatformDependent] -Dio.netty.bitMode: 64 (sun.arch.data.model)\r\n[2017-08-18T18:21:55,977][DEBUG][io.netty.util.internal.PlatformDependent] -Dio.netty.noPreferDirect: true\r\n[2017-08-18T18:21:55,977][DEBUG][io.netty.util.internal.PlatformDependent] -Dio.netty.maxDirectMemory: -1 bytes\r\n[2017-08-18T18:21:55,977][DEBUG][io.netty.util.internal.PlatformDependent] -Dio.netty.uninitializedArrayAllocationThreshold: -1\r\n[2017-08-18T18:21:56,003][DEBUG][io.netty.util.internal.PlatformDependent] org.jctools-core.MpscChunkedArrayQueue: unavailable\r\n```\r\nMy environment doesn't allow me to enable & query NMT.  Instead of enabling explicit GC's, does adding `-Dio.netty.maxDirectMemory=0` [1] seem like a way to help cap total off-heap usage?  Thank you for your help!\r\n\r\n[1] https://netty.io/4.0/xref/io/netty/util/internal/PlatformDependent.html#141\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323437052","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323437052","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323437052,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQzNzA1Mg==","user":{"login":"erik-stephens","id":3054461,"node_id":"MDQ6VXNlcjMwNTQ0NjE=","avatar_url":"https://avatars1.githubusercontent.com/u/3054461?v=4","gravatar_id":"","url":"https://api.github.com/users/erik-stephens","html_url":"https://github.com/erik-stephens","followers_url":"https://api.github.com/users/erik-stephens/followers","following_url":"https://api.github.com/users/erik-stephens/following{/other_user}","gists_url":"https://api.github.com/users/erik-stephens/gists{/gist_id}","starred_url":"https://api.github.com/users/erik-stephens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erik-stephens/subscriptions","organizations_url":"https://api.github.com/users/erik-stephens/orgs","repos_url":"https://api.github.com/users/erik-stephens/repos","events_url":"https://api.github.com/users/erik-stephens/events{/privacy}","received_events_url":"https://api.github.com/users/erik-stephens/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T19:09:23Z","updated_at":"2017-08-18T19:09:23Z","author_association":"NONE","body":"And in case this helps, this is what cmd-line looks like:\r\n\r\n> java -Xms2g -Xmx2g -XX:+UseConcMarkSweepGC -XX:CMSInitiatingOccupancyFraction=75 -XX:+UseCMSInitiatingOccupancyOnly -XX:+DisableExplicitGC -XX:+AlwaysPreTouch -server -Xss1m -Djava.awt.headless=true -Dfile.encoding=UTF-8 -Djna.nosys=true -Djdk.io.permissionsUseCanonicalPath=true -Dio.netty.noUnsafe=true -Dio.netty.noKeySetOptimization=true -Dio.netty.recycler.maxCapacityPerThread=0 -Dlog4j.shutdownHookEnabled=false -Dlog4j2.disable.jmx=true -Dlog4j.skipJansi=true -XX:+HeapDumpOnOutOfMemoryError -Xms30G -Xmx30G -XX:MaxDirectMemorySize=32G -XX:-DisableExplicitGC -Des.path.home=/elasticsearch -cp /elasticsearch/lib/* org.elasticsearch.bootstrap.Elasticsearch -Epath.conf=/app/config","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323461473","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323461473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323461473,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ2MTQ3Mw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T21:09:18Z","updated_at":"2017-08-18T21:09:18Z","author_association":"MEMBER","body":"You still have disabling of explicit GC there.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323478245","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323478245","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323478245,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ3ODI0NQ==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T22:55:44Z","updated_at":"2017-08-18T22:55:44Z","author_association":"NONE","body":"Here it is :\r\n```\r\nJVM arguments [-Xms2g, -Xmx2g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.\r\nawt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -Djdk.io.permissionsUseCanonicalPath=true, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled\r\n=false, -Dlog4j2.disable.jmx=true, -Dlog4j.skipJansi=true, -XX:+HeapDumpOnOutOfMemoryError, -Xms4g, -Xmx4g, -XX:+UseParNewGC, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=70, -XX:+UseCMSInitiatingOccupancyOnly, -XX:NewRatio\r\n=2, -XX:SurvivorRatio=4, -XX:+HeapDumpOnOutOfMemoryError, -verbose:gc, -XX:+PrintGCDetails, -XX:+PrintHeapAtGC, -XX:+PrintTenuringDistribution, -Xloggc:/var/opt/hosting/log/elasticsearch/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLo\r\ngFiles=3, -XX:GCLogFileSize=10M, -Dcom.sun.management.jmxremote.port=7199, -Dcom.sun.management.jmxremote.ssl=false, -Dcom.sun.management.jmxremote.authenticate=false, -javaagent:/usr/share/java/jolokia-jvm-1.1.4-agent.jar=port=6666,host=\r\nlocalhost, -XX:NativeMemoryTracking=detail, -Des.path.home=/usr/share/elasticsearch]\r\n```\r\n\r\nExplicit GC is disabled (I took care to check in jvm.option when I updated to 5.5.1).\r\n\r\nBefore posting the issue here I tried to :\r\n* re-enabling Explicit GC\r\n* update my java from 8u112 to 8u141\r\n* update kernel & system, reboot\r\nbut it didn't change anything\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323479082","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323479082","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323479082,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ3OTA4Mg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T23:02:17Z","updated_at":"2017-08-18T23:03:02Z","author_association":"MEMBER","body":"You have JMX and an agent installed. Would you please remove those and see if the issue continues to reproduce? I want to be clear: I am not suggesting these are the cause (I doubt they are), rather I need to get this down to the essence that I can reproduce before I can make progress on this. The more variables we remove, the simpler our effort will be. And maybe we get lucky before rolling up our sleeves.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323481588","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323481588","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323481588,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ4MTU4OA==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T23:22:35Z","updated_at":"2017-08-18T23:22:35Z","author_association":"NONE","body":"No problem, I can remove them. We use them mostly to monitor the JVM.\r\nHere are the new options : \r\n```\r\nJVM arguments [-Xms2g, -Xmx2g, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=75, -XX:+UseCMSInitiatingOccupancyOnly, -XX:+AlwaysPreTouch, -Xss1m, -Djava.\r\nawt.headless=true, -Dfile.encoding=UTF-8, -Djna.nosys=true, -Djdk.io.permissionsUseCanonicalPath=true, -Dio.netty.noUnsafe=true, -Dio.netty.noKeySetOptimization=true, -Dio.netty.recycler.maxCapacityPerThread=0, -Dlog4j.shutdownHookEnabled\r\n=false, -Dlog4j2.disable.jmx=true, -Dlog4j.skipJansi=true, -XX:+HeapDumpOnOutOfMemoryError, -Xms4g, -Xmx4g, -XX:+UseParNewGC, -XX:+UseConcMarkSweepGC, -XX:CMSInitiatingOccupancyFraction=70, -XX:+UseCMSInitiatingOccupancyOnly, -XX:NewRatio\r\n=2, -XX:SurvivorRatio=4, -XX:+HeapDumpOnOutOfMemoryError, -verbose:gc, -XX:+PrintGCDetails, -XX:+PrintHeapAtGC, -XX:+PrintTenuringDistribution, -Xloggc:/var/opt/hosting/log/elasticsearch/gc.log, -XX:+UseGCLogFileRotation, -XX:NumberOfGCLo\r\ngFiles=3, -XX:GCLogFileSize=10M, -XX:NativeMemoryTracking=detail, -Des.path.home=/usr/share/elasticsearch]\r\n```\r\nBut RSS is still growing above 6G.\r\nHere is another memory detail :\r\n[memory-6G.txt](https://github.com/elastic/elasticsearch/files/1235892/memory-6G.txt)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323482362","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323482362","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323482362,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ4MjM2Mg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-18T23:29:20Z","updated_at":"2017-08-18T23:29:20Z","author_association":"MEMBER","body":"Thanks for the quick turnaround. Let's try another thing: from Elasticsearch 5.3.0 to 5.5.1, we upgraded Netty 4 from 4.1.7 to 4.1.11, and Lucene from 6.4.1 to 6.6.0. Those are quite some changes, on top of new features and so on (but the most likely culprits to leaking native memory are Netty and Lucene).\r\n\r\nLet's start by seeing if it could be if it's something new in Netty 4. Can you start Elasticsearch with `-Etransport.type=netty3 -Ehttp.type=netty3` (or put them in the `elasticsearch.yml`). If the leak still occurs, we know it's not Netty 4. If the leak does not occur, we know it's Netty 4. Either way, this is hugely valuable.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323485368","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323485368","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323485368,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ4NTM2OA==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T00:00:42Z","updated_at":"2017-08-19T00:00:42Z","author_association":"NONE","body":"I think you nailed it. The RSS stabilized around 4.7G. :+1: \r\nIt's still moving though, but no more than by small steps of less then 500ko. (In 5.3, the RSS doesn't move at all after 2min after the start.)\r\nNeed to wait a day or two to see if it grows further.\r\nIf I can I'll post some graphs of memory over time.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323485869","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323485869","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323485869,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ4NTg2OQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T00:06:20Z","updated_at":"2017-08-19T00:06:20Z","author_association":"MEMBER","body":"I would not call it nailing it yet. We only confirmed a strong hunch I had that it was Netty 4, now I need to understand what changed in Netty 4 that is doing this. 😄","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323485998","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323485998","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323485998,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ4NTk5OA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T00:07:29Z","updated_at":"2017-08-19T00:07:29Z","author_association":"MEMBER","body":"So let's go back to the beginning: now we have a culprit, now we need to find what in Netty 4 is causing this. What can you offer in the way of a reproduction? Any straightforward steps I can follow that reliably reproduces the issue? With a reproduction in hand, and knowing where to look, it would be time to roll up our sleeves and find the root cause.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323487895","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323487895","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323487895,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzQ4Nzg5NQ==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T00:30:21Z","updated_at":"2017-08-19T00:47:24Z","author_association":"NONE","body":"I don't know exactly how to reproduce.\r\nIn staging, we didn't have the issue. Staging is 1 master node, 3 data nodes, and 2 additionnal nodes for kibana with an injection between 100 and 3,000 docs/s.\r\nOur production is : 3 master nodes, 24 data nodes, 2 additionnal nodes with an injection rate between 10,000 and 100,000 docs/s. (1700 indices, 8700 primary shards, with 1 replica)\r\n\r\nAnother thing I just noticed  : our active master is using way more CPU than before.\r\nWith 5.3.0, 10% of CPU would be used continuously, but with 5.5.1, it's around 35%, with some cores at 70% continuously. Even with netty 3, the CPU usage is high.\r\nEdit: verified CPU usage on data nodes too, it didn't change, again, the issue is only on the active master.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323504584","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323504584","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323504584,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzUwNDU4NA==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T06:32:18Z","updated_at":"2017-08-19T06:32:18Z","author_association":"MEMBER","body":"I tried a few different approaches tonight to see if I could come up with a reproduction and I do not have one. What is your method for ingesting documents into Elasticsearch? ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323522882","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323522882","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323522882,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzUyMjg4Mg==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T13:23:29Z","updated_at":"2017-08-19T13:29:13Z","author_association":"NONE","body":"We use bulk indexing across all 24 datanodes (in the process on building ingest nodes).\r\nBulk size is 3000 documents at max. Indices are daily and ~50 indices by day.\r\nMapping is dynamic, and is updated every few minutes depending on the documents we receive.\r\nWe have a few mapping exceptions every few seconds too because some clients are sending us conflicting documents.\r\n\r\nI had an idea since the CPU usage is anormally high, I checked the hot_threads API on the active master and I have this :\r\n[hot_threads_master02.txt](https://github.com/elastic/elasticsearch/files/1236371/hot_threads_master02.txt)\r\nThere's always 3 or 4 threads named \"_{New I/O worker #18}_\" taking ~60-100% or a core.\r\nI hope this is relevant. I don't see this type of threads on staging, neither do I see them on our second production cluster still in 5.3.0 (who has half the workload).\r\nEdit: these New I/O Worker threads may be from netty3, I will rollback to Netty 4 and look at hot_threads again","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323523642","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323523642","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323523642,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzUyMzY0Mg==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T13:37:44Z","updated_at":"2017-08-19T13:37:44Z","author_association":"NONE","body":"With netty 4, same threads taking 100% of a core :\r\n[hot_threads_master01_netty4.txt](https://github.com/elastic/elasticsearch/files/1236383/hot_threads_master01_netty4.txt)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323541093","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323541093","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323541093,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzU0MTA5Mw==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T18:50:38Z","updated_at":"2017-08-19T18:50:38Z","author_association":"MEMBER","body":"> Mapping is dynamic, and is updated every few minutes depending on the documents we receive.\r\n\r\n@Shizuu how big is your cluster state at the moment? Looking at the hot threads, all these threads are doing is sending mappings over the network. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/323542334","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-323542334","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":323542334,"node_id":"MDEyOklzc3VlQ29tbWVudDMyMzU0MjMzNA==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-19T19:14:52Z","updated_at":"2017-08-19T19:14:52Z","author_association":"NONE","body":"Yes we have a pretty big cluster state, because we use a lot of types, even for similar documents we can have dozens of types (i know it's bad, we plan to reduce that to be ready for 6.0 & 7.0).\r\nRight know a get of cluster state (without pretty) give me a json of 65Mo.\r\nI can count in the mapping near 50,000 types and 1,5 millions fields.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324272549","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324272549","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324272549,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDI3MjU0OQ==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-23T09:21:32Z","updated_at":"2017-08-23T09:23:43Z","author_association":"NONE","body":"Little update : I reproduced a equivalent cluster state in another environment, and doing heavy indexing and triggering a lot of mapping changes, but didn't manage to reproduce the issue.\r\n\r\nThen I asked myself if the issue is really linked to indexing and mapping changes.\r\nSo, I completelly stopped the indexation processes on the production cluster for a few minutes, then restarted all the masters to be clean.\r\n\r\nAnd the result is the issue was still there on the active master :\r\n* RSS memory still growing\r\n* several hot threads still taking 100% CPU and trying to update mappings, even if no mapping is changing (I checked the log)\r\n\r\nSo I don't know, maybe my cluster is a weird state after the upgrade.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324349941","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324349941","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324349941,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDM0OTk0MQ==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-23T14:23:15Z","updated_at":"2017-08-23T14:32:24Z","author_association":"NONE","body":"**I found the culprit !** and managed to reproduce the issue (kinda)\r\n\r\nI searched why the master was always spreading mapping information on the network, even when the mapping was not changing.\r\nI looked at hot_threads on all the nodes, hoping to find a thread reading mapping, and I found that it was always my 2 non master/non data nodes.\r\n\r\nWhat is on these nodes ? Kibana. 15 instances of Kibana on each nodes, so 30 total.\r\nTo test that is was indeed Kibana : I stopped it, restarted the masters, and the issue was gone. Then, as soon as I restarted Kibana, the issue was back.\r\n\r\nI managed to isolate what query Kibana was doing that was generating this load on the master, here it is:\r\n\r\n`/_cluster/settings?include_defaults=true&filter_path=**.script.engine.*.inline`\r\n\r\nAnd each Kibana instance is doing this query every 4 seconds.\r\n\r\nI tried to spam this query on our staging environment that has elasticsearch 5.5.1, and I observed the same behavior : RSS increasing and a lot of threads on the master.\r\n\r\nSide note though; Kibana 5.3.0 is not doing this request.\r\nSo I tried to spam this query on a cluster that still has 5.3.0 version : the CPU usage was there, but didn't observed RSS increasing much.\r\n\r\nIn conclusion :\r\n* Kibana 5.5 is doing a request that generate a lot of CPU usage on active master (not noticeable with 1 instance of Kibana but very noticeable with 30 instances)\r\n* Threads managing this request seems to use more memory in 5.5 than in 5.3 (seems to have to do with netty4 from our previous investigation)\r\n\r\nI'm still wondering why this specific requests is working with mapping information, because the response has little to do with mapping (even without the filter_path).\r\n\r\nWhat do you think of all of this ?\r\n\r\n(and sorry @erik-stephens I may have hijacked your issue for something completely unrelated)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324358032","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324358032","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324358032,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDM1ODAzMg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-23T14:44:24Z","updated_at":"2017-08-23T14:44:45Z","author_association":"MEMBER","body":"Thank you, this is massively helpful! I will see if it reproduces on my side as well and start serious debugging now that we have a possible reproduction.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324410315","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324410315","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324410315,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDQxMDMxNQ==","user":{"login":"erik-stephens","id":3054461,"node_id":"MDQ6VXNlcjMwNTQ0NjE=","avatar_url":"https://avatars1.githubusercontent.com/u/3054461?v=4","gravatar_id":"","url":"https://api.github.com/users/erik-stephens","html_url":"https://github.com/erik-stephens","followers_url":"https://api.github.com/users/erik-stephens/followers","following_url":"https://api.github.com/users/erik-stephens/following{/other_user}","gists_url":"https://api.github.com/users/erik-stephens/gists{/gist_id}","starred_url":"https://api.github.com/users/erik-stephens/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/erik-stephens/subscriptions","organizations_url":"https://api.github.com/users/erik-stephens/orgs","repos_url":"https://api.github.com/users/erik-stephens/repos","events_url":"https://api.github.com/users/erik-stephens/events{/privacy}","received_events_url":"https://api.github.com/users/erik-stephens/received_events","type":"User","site_admin":false},"created_at":"2017-08-23T17:44:06Z","updated_at":"2017-08-23T17:44:26Z","author_association":"NONE","body":"@Shizuu  No worries, your involvement is welcome!  To help summarize things on our end:\r\n\r\n- Setting `-XX:MaxDirectMemorySize=32G` stabilized things quite a bit.  30G heap + 32G NIO for elasticsearch/lucene + 32G NIO for netty + small amount for miscellaneous (eg MetaSpace) keeps us from OOM'ing.\r\n\r\n- We configured to use to netty=3 yesterday with no ill side-effects.  I probably should've isolated that change from the MaxDirectMemorySize change to better see how that helps.\r\n\r\n- We don't have any kibana instances pointing at this cluster.\r\n\r\n- I tried to duplicate locally by bulk-indexing to a single node cluster in a loop while watching NMT diffs.  I couldn't reproduce anything that looked like a leak.  I think I'd have to try with a multi node cluster and more indices, suspecting that a large cluster state is key to reproducing.\r\n\r\n- I have not run with explicit GC re-enabled.\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324521641","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324521641","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324521641,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDUyMTY0MQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-24T03:18:10Z","updated_at":"2017-08-24T03:18:10Z","author_association":"MEMBER","body":"Sadly, the leak does not reproduce as reported. Is there something special about your cluster state (aside from being large)?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324591335","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324591335","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324591335,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDU5MTMzNQ==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-24T10:00:39Z","updated_at":"2017-08-24T10:00:39Z","author_association":"NONE","body":"We have some very long types, but I don't think this is it.\r\n\r\nDid you test with \"`transport.tcp.compress: true`\" ? We have this setting activated, it's `false` by default. And in the hot_threads you can see the threads doing deflating and inflating.\r\nI can't test right now because it is not a setting dynamically updatable.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324691855","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324691855","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324691855,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDY5MTg1NQ==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-24T16:46:40Z","updated_at":"2017-08-24T16:46:40Z","author_association":"NONE","body":"I'm trying to replicate the issue on another cluster we upgraded in 5.5.1, without success for now, but it has a small cluster state. I'm trying to generate a bigger state and to figure what in it might be triggering the issue.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324785053","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324785053","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324785053,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDc4NTA1Mw==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-24T23:32:29Z","updated_at":"2017-08-24T23:32:29Z","author_association":"MEMBER","body":"Yes, I was using `transport.tcp.compress` set to `true`. I have a cluster state that is 44955643 bytes of pretty-printed json and 992131 bytes of compressed pretty-printed json and the issue still does not reproduce for me.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324977552","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324977552","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324977552,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDk3NzU1Mg==","user":{"login":"Shizuu","id":16745505,"node_id":"MDQ6VXNlcjE2NzQ1NTA1","avatar_url":"https://avatars2.githubusercontent.com/u/16745505?v=4","gravatar_id":"","url":"https://api.github.com/users/Shizuu","html_url":"https://github.com/Shizuu","followers_url":"https://api.github.com/users/Shizuu/followers","following_url":"https://api.github.com/users/Shizuu/following{/other_user}","gists_url":"https://api.github.com/users/Shizuu/gists{/gist_id}","starred_url":"https://api.github.com/users/Shizuu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Shizuu/subscriptions","organizations_url":"https://api.github.com/users/Shizuu/orgs","repos_url":"https://api.github.com/users/Shizuu/repos","events_url":"https://api.github.com/users/Shizuu/events{/privacy}","received_events_url":"https://api.github.com/users/Shizuu/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T16:55:44Z","updated_at":"2017-08-25T16:55:44Z","author_association":"NONE","body":"Okayyyy, I have done countless tests, tried to generate many indices, mappings, etc. playing with options we have activated etc.... no luck...\r\nFinally I copied the state of my cluster with the issue on an empty cluster, saw that the issue was there even without the data, and tried to trim down the cluster state to a minimum that could generate the issue...\r\n(I spend really too much time on this... :) )\r\n\r\nBut I think this time I have a reliable reproduction (if not well... nevermind!)\r\n\r\nSo you need : \r\n* 1 master node\r\n* 1 non master/non data node\r\n* no data node needed\r\n\r\nThen :\r\n* Get this file : [index_settings.txt](https://github.com/elastic/elasticsearch/files/1252385/index_settings.txt)\r\nThis is the settings and mappings (anonymized) of one of our daily index that I found was causing the issue.\r\n* Generate 40 indices with settings and mapping of this file :\r\n`for i in $(seq -w 1 40); do curl -s -XPUT localhost:9200/index_2017.08.$i -d @index_settings.txt & done`\r\n(I have seen the issue triggered at 30 indices but you may need more depending on your hardware)\r\n* On the non master node, spawn 6 or more shells and launch this in each shell to simulate severals Kibana :\r\n`while true; do curl -s \"localhost:9200/_cluster/settings\">/dev/null; done`\r\n* The RSS should increase quickly to 2x the HEAP memory.\r\n* If you see nothing try so spawn more shells or more indices.\r\n\r\nIn the end, I found the issue is caused by indices with too many types, and with very long types. (tried to put the same mapping with shorter types like 'type-001, type-002 etc.. but the issue wasn't triggering).\r\nSo, there may be a bug, but it should be gone when we will migrate to a single type.\r\nAnd if you don't succeed in replicating the issue, I think I will not look further into it and instead accelerate our single type migration ;)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/324979866","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-324979866","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":324979866,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNDk3OTg2Ng==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T17:04:29Z","updated_at":"2017-08-25T17:04:29Z","author_association":"MEMBER","body":"> (I spend really too much time on this... :) )\r\n\r\nFirst, thank you for all your time on this. Second, I'm right there with you the last few days. I will immediately try your reproduction report.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/325000715","html_url":"https://github.com/elastic/elasticsearch/issues/26269#issuecomment-325000715","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26269","id":325000715,"node_id":"MDEyOklzc3VlQ29tbWVudDMyNTAwMDcxNQ==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-08-25T18:22:26Z","updated_at":"2017-08-25T18:22:26Z","author_association":"MEMBER","body":"> The RSS should increase quickly to 2x the HEAP memory.\r\n\r\nThis happened. That's okay though, it's expected. Did something problematic happen after this?\r\n","performed_via_github_app":null}]