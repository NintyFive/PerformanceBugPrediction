[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/232926114","html_url":"https://github.com/elastic/elasticsearch/issues/19446#issuecomment-232926114","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19446","id":232926114,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMjkyNjExNA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2016-07-15T11:17:09Z","updated_at":"2016-07-15T11:17:09Z","author_association":"CONTRIBUTOR","body":"One thing to add here: The primary shard allocator forces allocation of a primary shard if allocation deciders for ALL nodes with shard copies say NO (*). If there’s a node with a shard copy where deciders says YES, we allocate to that node. If there’s a node with a shard copy where deciders say THROTTLE, and there is no node with YES, we don't allocate the shard in that round.\n\nWhat this means, however, is that we cannot simply add this override logic \"always return YES if the shard in question is a primary which already exists on this node\" at the decider level, because the overriding logic only comes into play once we've looked at deciders of ALL nodes with shard copies. \n\nIf we want to reflect this correctly in the cluster allocation explain API, it would also need to check the condition marked by \\* above.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234505068","html_url":"https://github.com/elastic/elasticsearch/issues/19446#issuecomment-234505068","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19446","id":234505068,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDUwNTA2OA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T10:00:25Z","updated_at":"2016-07-22T10:00:25Z","author_association":"MEMBER","body":"We discussed possible solutions on fix it friday. Here's what we came up with to deal with the current primary allocation logic. Instead of how it works today, which @ywelsch explained, we should do the following:\n\nAdd a `canForceAssignPrimary` method to the `AllocationDecider` class. That one will say `YES` by default and the `MaxRetryAllocationDecider` will forward it to it's `canAllocate` method. \n\nUsing this new method the PrimaryShardAllocator logic becomes:\n\n1) Iterate on all valid found allocation and ask the deciders for a decision.\n2) If there is a node which resulted in `YES` assign the primary there.\n3) If there is a node which resulted in `THROTTLE`, wait.\n4) If all nodes got a `NO` result, instead of what we do now, we will iterate all nodes again, this time calling the new `canForceAssignPrimary` method. If some node has a `YES` now, we assign there. If some node has `THROTTLE` we wait. On `NO` on all nodes, we stay red.\n\nNote that we will also need to adapt the allocation explain API to reflect this\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234505214","html_url":"https://github.com/elastic/elasticsearch/issues/19446#issuecomment-234505214","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19446","id":234505214,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDUwNTIxNA==","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T10:01:07Z","updated_at":"2016-07-22T10:01:07Z","author_association":"MEMBER","body":"@abeyad maybe this is something for you?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/234542771","html_url":"https://github.com/elastic/elasticsearch/issues/19446#issuecomment-234542771","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19446","id":234542771,"node_id":"MDEyOklzc3VlQ29tbWVudDIzNDU0Mjc3MQ==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-07-22T13:24:46Z","updated_at":"2016-07-22T13:24:46Z","author_association":"CONTRIBUTOR","body":"@bleskes Sure, just assigned it to myself.\n","performed_via_github_app":null}]