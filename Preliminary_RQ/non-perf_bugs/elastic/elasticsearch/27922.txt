{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27922","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27922/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27922/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27922/events","html_url":"https://github.com/elastic/elasticsearch/issues/27922","id":283549944,"node_id":"MDU6SXNzdWUyODM1NDk5NDQ=","number":27922,"title":"old gc can not recover memory","user":{"login":"junkainiu","id":12933695,"node_id":"MDQ6VXNlcjEyOTMzNjk1","avatar_url":"https://avatars0.githubusercontent.com/u/12933695?v=4","gravatar_id":"","url":"https://api.github.com/users/junkainiu","html_url":"https://github.com/junkainiu","followers_url":"https://api.github.com/users/junkainiu/followers","following_url":"https://api.github.com/users/junkainiu/following{/other_user}","gists_url":"https://api.github.com/users/junkainiu/gists{/gist_id}","starred_url":"https://api.github.com/users/junkainiu/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/junkainiu/subscriptions","organizations_url":"https://api.github.com/users/junkainiu/orgs","repos_url":"https://api.github.com/users/junkainiu/repos","events_url":"https://api.github.com/users/junkainiu/events{/privacy}","received_events_url":"https://api.github.com/users/junkainiu/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-12-20T12:39:50Z","updated_at":"2017-12-21T13:52:44Z","closed_at":"2017-12-21T13:52:44Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n5.3.0\r\n**Plugins installed**: []\r\nNone\r\n**JVM version** (`java -version`):\r\n1.8.0_66\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nCentOS7\r\nLinux 9ba9ad486a9a 3.10.0-514.21.2.el7.x86_64 #1 SMP Tue Jun 20 12:24:47 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n**Steps to reproduce**:\r\nWe are running a one node elaticsearch cluster with a heap size of 20GB.  Sometimes the elasticsearch node is suffering from old gc and can not recover.  We dump the heap and see something we can not understand.\r\n\r\n 1. Can not find classes that use a lot of memory\r\n![423470022118549623](https://user-images.githubusercontent.com/12933695/34206807-00c950d0-e5c3-11e7-9d0c-0b6b7ac1740b.jpg)\r\n\r\n\r\n       **segment memory**, **query cache**, **doc value**, **fielddata**  is the GET /_nodes/stats api expose.\r\n     \r\n- segment memory\r\n     org.apache.lucene.index.SegmentReader uses the most memory, about 4.7GB\r\n\r\n- query cache\r\n     org.elasticsearch.indices.IndicesQueryCache$ElasticsearchLRUQueryCache uses about 1GB\r\n\r\n- doc value\r\n    org.apache.lucene.codecs.lucene54DocValueProducer uses about 2GB\r\n\r\n- fielddata\r\n    org.elasticsearch.index.fielddata.ordinals.InternalGlobalOrdinalsIndexFieldData uses about 700MB\r\n\r\nSo all these fields uses 8.5G heap size, How is the other heap size used? Why old gc can not fully recover memory?\r\n\r\n**Provide logs (if relevant)**:\r\n\r\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}