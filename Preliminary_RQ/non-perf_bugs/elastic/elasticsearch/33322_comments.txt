[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/418045804","html_url":"https://github.com/elastic/elasticsearch/issues/33322#issuecomment-418045804","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33322","id":418045804,"node_id":"MDEyOklzc3VlQ29tbWVudDQxODA0NTgwNA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-09-03T08:47:52Z","updated_at":"2018-09-03T08:47:52Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-infra","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/424005952","html_url":"https://github.com/elastic/elasticsearch/issues/33322#issuecomment-424005952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33322","id":424005952,"node_id":"MDEyOklzc3VlQ29tbWVudDQyNDAwNTk1Mg==","user":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"created_at":"2018-09-24T15:00:09Z","updated_at":"2018-09-24T15:00:09Z","author_association":"MEMBER","body":"Initially I used your source documents which are pretty complex for such a report btw. But it turns out we get the same behavior with a simpler example as well which I'll also use below (tested on a fresh install of Elasticsearch 6.4.1):\r\n\r\n```\r\ncurl -X POST \"localhost:9200/_bulk\" -H 'Content-Type: application/json' -d'\r\n{\"update\":{\"_index\":\"cars\",\"_type\":\"_doc\",\"_id\":\"1\",\"retry_on_conflict\":25}},\r\n{\"doc\":{\"make\":\"GMC\",\"model\":\"Sierra 1500\",\"year\":2012},\"doc_as_upsert\":true},\r\n{\"update\":{\"_index\":\"cars\",\"_type\":\"_doc\",\"_id\":\"1\",\"retry_on_conflict\":25}},\r\n{\"doc\":{\"year\":2014,\"color\":\"green\"},\"doc_as_upsert\":true}\r\n'\r\n```\r\n\r\nWe'll create a document in the first bulk item and update a property and also add a new one (`color`) to demonstrate everything is merged.\r\n\r\nWe get the following response:\r\n\r\n```\r\n{\r\n  \"took\": 1457,\r\n  \"errors\": false,\r\n  \"items\": [\r\n    {\r\n      \"update\": {\r\n        \"_index\": \"cars\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"1\",\r\n        \"_version\": 1,\r\n        \"result\": \"created\",\r\n        \"_shards\": {\r\n          \"total\": 2,\r\n          \"successful\": 1,\r\n          \"failed\": 0\r\n        },\r\n        \"_seq_no\": 0,\r\n        \"_primary_term\": 1,\r\n        \"status\": 201\r\n      }\r\n    },\r\n    {\r\n      \"update\": {\r\n        \"_index\": \"cars\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"1\",\r\n        \"_version\": 2,\r\n        \"result\": \"updated\",\r\n        \"_shards\": {\r\n          \"total\": 2,\r\n          \"successful\": 1,\r\n          \"failed\": 0\r\n        },\r\n        \"_seq_no\": 1,\r\n        \"_primary_term\": 1,\r\n        \"status\": 200\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nWhen we retrieve the document ...\r\n\r\n```\r\ncurl -X GET \"localhost:9200/cars/_doc/1?pretty\"\r\n```\r\n\r\n... , we get the merged version just as we expect:\r\n\r\n```\r\n{\r\n  \"_index\" : \"cars\",\r\n  \"_type\" : \"_doc\",\r\n  \"_id\" : \"1\",\r\n  \"_version\" : 2,\r\n  \"found\" : true,\r\n  \"_source\" : {\r\n    \"make\" : \"GMC\",\r\n    \"model\" : \"Sierra 1500\",\r\n    \"year\" : 2014,\r\n    \"color\" : \"green\"\r\n  }\r\n}\r\n```","performed_via_github_app":null}]