[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/589582526","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-589582526","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":589582526,"node_id":"MDEyOklzc3VlQ29tbWVudDU4OTU4MjUyNg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-02-21T09:56:10Z","updated_at":"2020-02-21T09:56:10Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-core-features (:Core/Features/Stats)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/590060570","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-590060570","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":590060570,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MDA2MDU3MA==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2020-02-23T11:50:34Z","updated_at":"2020-02-23T11:50:34Z","author_association":"CONTRIBUTOR","body":"I'll be happy to work on a PR. Please let me know if that is fine","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/590331108","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-590331108","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":590331108,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MDMzMTEwOA==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2020-02-24T13:56:49Z","updated_at":"2020-02-24T18:55:40Z","author_association":"CONTRIBUTOR","body":"Today we can get a partial result if the request on any node fails eg. Circuit breaker exception on the transport node so timing out on the slow node would try to mimic a similar behaviour with a `FailedNodeException`.\r\n```\r\n{\"_shards\":{\"total\":4274,\"successful\":4241,\"failed\":33,\"failures\":[{\"shard\":27,\"index\":\"test-2020.01.03-19\",\"status\":\"INTERNAL_SERVER_ERROR\",\"reason\":{\"type\":\"failed_node_exception\",\"reason\":\"Failed node [GVLMLR5-WiysqqK8SBg]\",\"node_id\":\"GVLMLR5-WiysqqK8SBg\",\"caused_by\":{\"type\":\"circuit_breaking_exception\",\"reason\":\"[parent] Data too large, data for [<transport_request>] would be [30593795348/28.4gb], which is larger than the limit of [29479606681/27.4gb], real usage: [30593766888/28.4gb], new bytes reserved: [28460/27.7kb]\",\"bytes_wanted\":30593795348,\"bytes_limit\":29479606681}}}\r\n```\r\n\r\n It would be inline with `_nodes/stats` API that supports a timeout\r\n@DaveCTurner Let me know your thoughts on the same\r\n\r\nThe heap build up is proportional to the shards in the cluster. I guess passing a `TransportRequestOptions` should help based on a optional `timeout`\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/b590b49205b71561744d4e32ed02af94cb3e6cc3/server/src/main/java/org/elasticsearch/action/support/broadcast/node/TransportBroadcastByNodeAction.java#L313","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592484312","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-592484312","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":592484312,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjQ4NDMxMg==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T12:03:14Z","updated_at":"2020-02-28T12:03:14Z","author_association":"CONTRIBUTOR","body":"@matriv any updates on this. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592487910","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-592487910","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":592487910,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjQ4NzkxMA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T12:15:00Z","updated_at":"2020-02-28T12:17:02Z","author_association":"CONTRIBUTOR","body":"The underlying problems you describe (degraded hardware, kernel scheduling issues, CPU lockups) sound like they will have more widespread effects than just the stats APIs, and I would like to understand more clearly why the existing mechanisms for dealing with these problems are not effective. In particular, if a node fails its health checks then it will be removed from the cluster which will unblock everything that's waiting for the broken node to respond.\r\n\r\nIn other words, how can the node be so broken that it cannot respond to stats calls, whilst still not being broken enough to fail its health checks? How can we strengthen the health checks to detect this?","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592514049","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-592514049","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":592514049,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjUxNDA0OQ==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T13:32:55Z","updated_at":"2020-02-28T13:32:55Z","author_association":"CONTRIBUTOR","body":"Thanks @DaveCTurner \r\n> In particular, if a node fails its health checks then it will be removed from the cluster which will unblock everything that's waiting for the broken node to respond.\r\n\r\nOn this particular incident we saw the kernel scheduling issue(`INFO: task java:58012 blocked for more than 120 seconds`) causing atleast the transport worker threads to get stuck, while the health check pings continued to go through on the generic thread pool. I don't have a thread dump to precisely confirm this though but based on my observation `_cat/indices` and others were also stuck on this node. The cluster recovered when the bad node had the ES process restarted.\r\n\r\nWhile with degraded hardware the network pings for Leader/Follower checks go through, I/O can be very slow causing the heap build up on the healthy node. While some of the bad hardware would be addressed through #45286 the grey/degraded hardware issues would need other supporting metrics to detect and mitigate.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592523750","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-592523750","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":592523750,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjUyMzc1MA==","user":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T13:57:21Z","updated_at":"2020-02-28T13:57:21Z","author_association":"CONTRIBUTOR","body":"I'm struggling to align what you are saying with how Elasticsearch works today. For instance, all transport messages go through a transport worker so if the transport worker threads are stuck then health checks will fail. Furthermore in an otherwise-stable cluster the health checks run on transport worker threads and not the generic thread pool. I think we cannot reasonably decide on a course of action until we understand what was really happening in this cluster. It's a shame you don't have a thread dump, as that would have clarified things a lot.\r\n\r\nYou have already opened a PR to improve the health checks in a way that I think would help in the situation you describe (https://github.com/elastic/elasticsearch/pull/52680). If you don't think that's sufficient then maybe the best way forward is to strengthen your proposed checks to cover this failure mode too. I think we should close this issue regarding the stats APIs and continue discussing the question of better health checks on your PR.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/592540782","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-592540782","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":592540782,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjU0MDc4Mg==","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"created_at":"2020-02-28T14:37:27Z","updated_at":"2020-02-28T14:37:27Z","author_association":"CONTRIBUTOR","body":"Thanks for the clarification but don't we have broadly two categories of transport workers(thread) one doing disk I/O(for stats) and the other only network I/O(pings). While based on what I reported(/_cat/indices and stats API being stuck) it would still be possible that the good node faces a heap build up.\r\n\r\nWhile I agree bad node can be worked through with the PR we are already on, adding a timeout might still potentially be helpful for a unresponsive cluster where some nodes are busy with GC and we might still want to know partial results rather than getting blocked for long espl with client side monitoring which have a granular metric SLA . Let me know what you think.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/654797117","html_url":"https://github.com/elastic/elasticsearch/issues/52616#issuecomment-654797117","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52616","id":654797117,"node_id":"MDEyOklzc3VlQ29tbWVudDY1NDc5NzExNw==","user":{"login":"hydrogen666","id":17194883,"node_id":"MDQ6VXNlcjE3MTk0ODgz","avatar_url":"https://avatars1.githubusercontent.com/u/17194883?v=4","gravatar_id":"","url":"https://api.github.com/users/hydrogen666","html_url":"https://github.com/hydrogen666","followers_url":"https://api.github.com/users/hydrogen666/followers","following_url":"https://api.github.com/users/hydrogen666/following{/other_user}","gists_url":"https://api.github.com/users/hydrogen666/gists{/gist_id}","starred_url":"https://api.github.com/users/hydrogen666/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hydrogen666/subscriptions","organizations_url":"https://api.github.com/users/hydrogen666/orgs","repos_url":"https://api.github.com/users/hydrogen666/repos","events_url":"https://api.github.com/users/hydrogen666/events{/privacy}","received_events_url":"https://api.github.com/users/hydrogen666/received_events","type":"User","site_admin":false},"created_at":"2020-07-07T11:41:39Z","updated_at":"2020-07-07T11:46:40Z","author_association":"NONE","body":"We are facing similar issue... We have a monitoring plugin collecting stats of every indices periodically by calling `GET /_stats` api, one data node response `indices:monitor/stats[n]` very slow due to disk issue but its network connection is OK. It causes our leader master OOM.\r\n\r\nIt's hard to say whether we will encounter similar issues not caused by disk problems in the future. I think we can have a timeout mechanism for `GET /_stats` API. @DaveCTurner ","performed_via_github_app":null}]