{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/37636","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37636/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37636/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/37636/events","html_url":"https://github.com/elastic/elasticsearch/issues/37636","id":401077892,"node_id":"MDU6SXNzdWU0MDEwNzc4OTI=","number":37636,"title":"Java client API - toXContent() on aggregations from search response causes exception","user":{"login":"Ghost93","id":4268710,"node_id":"MDQ6VXNlcjQyNjg3MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/4268710?v=4","gravatar_id":"","url":"https://api.github.com/users/Ghost93","html_url":"https://github.com/Ghost93","followers_url":"https://api.github.com/users/Ghost93/followers","following_url":"https://api.github.com/users/Ghost93/following{/other_user}","gists_url":"https://api.github.com/users/Ghost93/gists{/gist_id}","starred_url":"https://api.github.com/users/Ghost93/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Ghost93/subscriptions","organizations_url":"https://api.github.com/users/Ghost93/orgs","repos_url":"https://api.github.com/users/Ghost93/repos","events_url":"https://api.github.com/users/Ghost93/events{/privacy}","received_events_url":"https://api.github.com/users/Ghost93/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2019-01-20T09:09:47Z","updated_at":"2019-02-25T09:51:37Z","closed_at":"2019-02-25T09:51:37Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.5.4, running on cloud.elastic.co (using AWS eu-west-1 region)\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nHi, \r\nThe following code produces JsonMappingException:\r\n```java\r\nSearchResponse searchResponse = this.highLevelRestClient.search(searchRequest);\r\nXContentBuilder builder = CborXContent.contentBuilder(); \r\nsearchResponse.getAggregations().toXContent(builder, ToXContent.EMPTY_PARAMS);\r\nObjectMapper cborObjectMapper = new ObjectMapper(new CBORFactory());\r\nJsonNode jsonNode = cborObjectMapper.readTree(builder.bytes().streamInput());\r\n```\r\n\r\nIf we don't call ```getAggregations()``` and read ```searchResponse``` directly it works, but we only need the aggregations :v: \r\n\r\nThe same code works when running on ```getHits()``` (in relevant queries).\r\n\r\n```searchRequest``` (in json form, I spared the ~100 LOC of creating it):\r\n```json\r\n{\r\n    \"size\": 0,\r\n    \"query\": {\r\n        \"bool\": {\r\n            \"must\": [\r\n                {\r\n                    \"range\": {\r\n                        \"censored_field_2\": {\r\n                            \"from\": \"2018-05-31T21:00:00.000Z\",\r\n                            \"to\": null,\r\n                            \"include_lower\": true,\r\n                            \"include_upper\": true,\r\n                            \"boost\": 1.0\r\n                        }\r\n                    }\r\n                },\r\n                {\r\n                    \"term\": {\r\n                        \"censored_field_1\": {\r\n                            \"value\": 460563723,\r\n                            \"boost\": 1.0\r\n                        }\r\n                    }\r\n                }\r\n            ],\r\n            \"adjust_pure_negative\": true,\r\n            \"boost\": 1.0\r\n        }\r\n    },\r\n    \"aggregations\": {\r\n        \"agg1\": {\r\n            \"date_histogram\": {\r\n                \"field\": \"censored_field_2\",\r\n                \"interval\": \"1M\",\r\n                \"offset\": 0,\r\n                \"order\": {\r\n                    \"_key\": \"asc\"\r\n                },\r\n                \"keyed\": false,\r\n                \"min_doc_count\": 0\r\n            },\r\n            \"aggregations\": {\r\n                \"avg_censored_field_3\": {\r\n                    \"avg\": {\r\n                        \"field\": \"censored_field_3\"\r\n                    }\r\n                },\r\n                \"avg_censored_field_4\": {\r\n                    \"avg\": {\r\n                        \"field\": \"censored_field_4\"\r\n                    }\r\n                },\r\n                \"avg_censored_field_5\": {\r\n                    \"avg\": {\r\n                        \"field\": \"censored_field_5\"\r\n                    }\r\n                },\r\n                \"censored_field_6\": {\r\n                    \"value_count\": {\r\n                        \"field\": \"censored_field_6\"\r\n                    }\r\n                },\r\n                \"censored_field_7\": {\r\n                    \"filter\": {\r\n                        \"exists\": {\r\n                            \"field\": \"censored_field_7.point\",\r\n                            \"boost\": 1.0\r\n                        }\r\n                    },\r\n                    \"aggregations\": {\r\n                        \"points\": {\r\n                            \"top_hits\": {\r\n                                \"from\": 0,\r\n                                \"size\": 100,\r\n                                \"version\": false,\r\n                                \"explain\": false,\r\n                                \"_source\": {\r\n                                    \"includes\": [\r\n                                        \"censored_field_7.point\"\r\n                                    ],\r\n                                    \"excludes\": []\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        },\r\n        \"agg2\": {\r\n            \"terms\": {\r\n                \"field\": \"censored_field_8.city\",\r\n                \"size\": 5,\r\n                \"min_doc_count\": 1,\r\n                \"shard_min_doc_count\": 0,\r\n                \"show_term_doc_count_error\": false,\r\n                \"order\": [\r\n                    {\r\n                        \"_count\": \"desc\"\r\n                    },\r\n                    {\r\n                        \"_key\": \"asc\"\r\n                    }\r\n                ]\r\n            }\r\n        }\r\n    }\r\n}\r\n```\r\n\r\nThanks\r\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}