{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14273","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14273/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14273/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14273/events","html_url":"https://github.com/elastic/elasticsearch/issues/14273","id":113108661,"node_id":"MDU6SXNzdWUxMTMxMDg2NjE=","number":14273,"title":"Groovy script in aggregation not working in 2.0","user":{"login":"reflection","id":652093,"node_id":"MDQ6VXNlcjY1MjA5Mw==","avatar_url":"https://avatars2.githubusercontent.com/u/652093?v=4","gravatar_id":"","url":"https://api.github.com/users/reflection","html_url":"https://github.com/reflection","followers_url":"https://api.github.com/users/reflection/followers","following_url":"https://api.github.com/users/reflection/following{/other_user}","gists_url":"https://api.github.com/users/reflection/gists{/gist_id}","starred_url":"https://api.github.com/users/reflection/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/reflection/subscriptions","organizations_url":"https://api.github.com/users/reflection/orgs","repos_url":"https://api.github.com/users/reflection/repos","events_url":"https://api.github.com/users/reflection/events{/privacy}","received_events_url":"https://api.github.com/users/reflection/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":275922394,"node_id":"MDU6TGFiZWwyNzU5MjIzOTQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.1","name":"v2.0.1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false},"assignees":[{"login":"pickypg","id":1501235,"node_id":"MDQ6VXNlcjE1MDEyMzU=","avatar_url":"https://avatars2.githubusercontent.com/u/1501235?v=4","gravatar_id":"","url":"https://api.github.com/users/pickypg","html_url":"https://github.com/pickypg","followers_url":"https://api.github.com/users/pickypg/followers","following_url":"https://api.github.com/users/pickypg/following{/other_user}","gists_url":"https://api.github.com/users/pickypg/gists{/gist_id}","starred_url":"https://api.github.com/users/pickypg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pickypg/subscriptions","organizations_url":"https://api.github.com/users/pickypg/orgs","repos_url":"https://api.github.com/users/pickypg/repos","events_url":"https://api.github.com/users/pickypg/events{/privacy}","received_events_url":"https://api.github.com/users/pickypg/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2015-10-23T22:09:20Z","updated_at":"2015-10-26T14:10:45Z","closed_at":"2015-10-26T14:10:45Z","author_association":"NONE","active_lock_reason":null,"body":"Here's the aggregation expressed in elasticsearch-dsl-py (which works fine in 1.x):\n\n```\ns.aggs \\\n  .bucket('hour', 'terms', script= \\\n          'use(groovy.time.TimeCategory) { \\\n            new Date(doc[\"timestamp\"].value).format(\"HH\") \\\n          }', size=0, order={'_term': 'asc'}) \\\n  .metric('bandwidth', 'sum', field='size') \\\n    .bucket('action', 'terms', field='action', size=0) \\\n    .metric('bandwidth', 'sum', field='size')\n```\n\nIn 2.0 we get this error:\n\n```\nRemoteTransportException[[Longshot][127.0.0.1:9300][indices:data/read/search[phase/query]]]; nested: \nQueryPhaseExecutionException[Query Failed [Failed to execute main query]]; nested: \nGroovyScriptExecutionException[failed to run inline script \n[use(groovy.time.TimeCategory) {                 new Date(doc[\"timestamp\"].value).format(\"HH\")               }] using lang [groovy]]; nested: \nNoClassDefFoundError[Could not initialize class org.codehaus.groovy.vmplugin.v7.IndyInterface];\n```\n\nIf we can no longer use groovy.time.TimeCategory, is there an alternative way to get hour buckets coalesced across multiple days from timestamps?  Thanks in advance!\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}