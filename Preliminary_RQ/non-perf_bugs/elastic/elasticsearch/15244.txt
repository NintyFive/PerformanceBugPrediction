{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15244","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15244/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15244/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15244/events","html_url":"https://github.com/elastic/elasticsearch/issues/15244","id":120428754,"node_id":"MDU6SXNzdWUxMjA0Mjg3NTQ=","number":15244,"title":"Date Format mapping not working in 2.1","user":{"login":"SMUnlimited","id":5180431,"node_id":"MDQ6VXNlcjUxODA0MzE=","avatar_url":"https://avatars2.githubusercontent.com/u/5180431?v=4","gravatar_id":"","url":"https://api.github.com/users/SMUnlimited","html_url":"https://github.com/SMUnlimited","followers_url":"https://api.github.com/users/SMUnlimited/followers","following_url":"https://api.github.com/users/SMUnlimited/following{/other_user}","gists_url":"https://api.github.com/users/SMUnlimited/gists{/gist_id}","starred_url":"https://api.github.com/users/SMUnlimited/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/SMUnlimited/subscriptions","organizations_url":"https://api.github.com/users/SMUnlimited/orgs","repos_url":"https://api.github.com/users/SMUnlimited/repos","events_url":"https://api.github.com/users/SMUnlimited/events{/privacy}","received_events_url":"https://api.github.com/users/SMUnlimited/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-12-04T15:49:40Z","updated_at":"2015-12-05T12:33:11Z","closed_at":"2015-12-05T12:33:11Z","author_association":"NONE","active_lock_reason":null,"body":"Using the latest version of Elasticsearch 2.1.0 on Windows 7\n\nThe date format mapping appears to be ignored.\n\nSet a format in mappings\n\n``` JSON\ncurl -XPUT http://localhost:9200/myindex1 '{\n  \"mappings\": {\n    \"document\": {\n      \"properties\": {\n        \"date_field\": {\n          \"type\": \"date\",\n          \"format\": \"yyyy/MM/dd\"\n        }\n      }\n    }\n  }\n}\n```\n\nIngest a document\n\n``` JSON\ncurl -XPUT http://localhost:9200/myindex1/mydoc/1 '{\n    \"date_field\": \"2013/12/23\"\n}'\n\n```\n\nThrows following exception\n\n```\n15:01:30,123 INFO  [elasticsearch[platform-webapp-ISVGREPC0000738][index][T#2]:rest.suppressed]: /com.detica.elasticsearch.platform.module.bulk.bulkidsretrievecomponentit1/mydoc/1 Params: {id=1, index=com.detica.elasticsearch.platform.module.bulk.bulkidsretrievecomponentit1, type=mydoc}\norg.elasticsearch.index.mapper.MapperParsingException: failed to parse [date_field]\n    at org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:339) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.parseObjectOrField(DocumentParser.java:314) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.parseAndMergeUpdate(DocumentParser.java:762) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.parseDynamicValue(DocumentParser.java:676) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.parseValue(DocumentParser.java:447) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.parseObject(DocumentParser.java:267) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.innerParseDocument(DocumentParser.java:127) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentParser.parseDocument(DocumentParser.java:79) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.DocumentMapper.parse(DocumentMapper.java:318) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.shard.IndexShard.prepareIndex(IndexShard.java:551) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.shard.IndexShard.prepareIndex(IndexShard.java:542) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction.prepareIndexOperationOnPrimary(TransportReplicationAction.java:1049) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction.executeIndexRequestOnPrimary(TransportReplicationAction.java:1060) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.action.index.TransportIndexAction.shardOperationOnPrimary(TransportIndexAction.java:170) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryPhase.performOnPrimary(TransportReplicationAction.java:579) [elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryPhase$1.doRun(TransportReplicationAction.java:452) [elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-2.1.0.jar:2.1.0]\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145) [?:1.7.0_79]\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615) [?:1.7.0_79]\n    at java.lang.Thread.run(Thread.java:745) [?:1.7.0_79]\nCaused by: java.lang.IllegalArgumentException: Invalid format: \"2013/12/23\" is malformed at \"/12/23\"\n    at org.joda.time.format.DateTimeParserBucket.doParseMillis(DateTimeParserBucket.java:187) ~[joda-time-2.8.2.jar:2.8.2]\n    at org.joda.time.format.DateTimeFormatter.parseMillis(DateTimeFormatter.java:780) ~[joda-time-2.8.2.jar:2.8.2]\n    at org.elasticsearch.index.mapper.core.DateFieldMapper$DateFieldType.parseStringValue(DateFieldMapper.java:360) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.core.DateFieldMapper.innerParseCreateField(DateFieldMapper.java:526) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.core.NumberFieldMapper.parseCreateField(NumberFieldMapper.java:213) ~[elasticsearch-2.1.0.jar:2.1.0]\n    at org.elasticsearch.index.mapper.FieldMapper.parse(FieldMapper.java:331) ~[elasticsearch-2.1.0.jar:2.1.0]\n    ... 19 more\n```\n\n**Yml settings file**\nSingle es node\n\ncluster.name: myTestCluster\nindex.number_of_replicas: 0\nindex.number_of_shards: 1\nhttp.enabled: true\nhttp.cors.enabled: true\nhttp.cors.allow-origin: \"*\"\n\n**Funky Scary Strange Part**\nI ended up debugging line by line to see if I could catch what the format was being set to, or overridden to cause this issue. This was in:\nDateFieldMapper.dateTimeFormatter()\nDateFieldMapper.setDateTimeFormatter()\n\nBut the document index action worked this time once it went through the DocumentParser. But the weird thing is the mapping had magically changed by itself from\n\n\"yyyy/MM/dd\" to \"yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis\"\n\nI.e i did a \"_mapping\" GET request to confirm and it was no longer yyyy/MM/dd. I havn't a clue how that is even possible. This never happens when it is not working but whatever it did fixed being able to add documents at that moment.\n\nNote if I manually set the date format myself to \"yyyy/MM/dd HH:mm:ss||yyyy/MM/dd||epoch_millis\" in a new index I still cannot add a document. \n\nIn any case when the add document is failing the date format appears to be using the 'default' rather than my custom format. \n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}