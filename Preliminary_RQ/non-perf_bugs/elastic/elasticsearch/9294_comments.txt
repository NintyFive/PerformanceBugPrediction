[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70154493","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-70154493","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":70154493,"node_id":"MDEyOklzc3VlQ29tbWVudDcwMTU0NDkz","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-01-15T20:21:04Z","updated_at":"2015-01-15T20:21:04Z","author_association":"CONTRIBUTOR","body":"Hi @mitallast \n\nThanks for reporting.  Could you provide the smallest recreation of the problem that you can come up with? Will help with debugging.\n\nthanks\n\n@martijnvg sounds like it could be a problem with top-hits?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70458346","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-70458346","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":70458346,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDU4MzQ2","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2015-01-19T08:13:14Z","updated_at":"2015-01-19T08:13:14Z","author_association":"MEMBER","body":"@clintongormley Yes, this does look like a bug in `top_hits` agg. \n@mitallast A recreation would be helpful\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70488666","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-70488666","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":70488666,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNDg4NjY2","user":{"login":"mitallast","id":531623,"node_id":"MDQ6VXNlcjUzMTYyMw==","avatar_url":"https://avatars1.githubusercontent.com/u/531623?v=4","gravatar_id":"","url":"https://api.github.com/users/mitallast","html_url":"https://github.com/mitallast","followers_url":"https://api.github.com/users/mitallast/followers","following_url":"https://api.github.com/users/mitallast/following{/other_user}","gists_url":"https://api.github.com/users/mitallast/gists{/gist_id}","starred_url":"https://api.github.com/users/mitallast/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitallast/subscriptions","organizations_url":"https://api.github.com/users/mitallast/orgs","repos_url":"https://api.github.com/users/mitallast/repos","events_url":"https://api.github.com/users/mitallast/events{/privacy}","received_events_url":"https://api.github.com/users/mitallast/received_events","type":"User","site_admin":false},"created_at":"2015-01-19T12:58:34Z","updated_at":"2015-01-19T12:58:34Z","author_association":"NONE","body":"I'm still try to reproduce like a integration test, but without success.\nBut at our test cluster, this bug also manually reproduced, and looks like this:\n\n2 nodes 1.4.2 with centos and Oracle JVM 8, first node contains shards 1/4/5/7, second contains 0/2/3/6 (8 total, 0 replicas)\nquery:\n\n```\n/index_name/type_name/_search?search_type=count&routing=3016\n{\n  \"query\": {\n    \"match_all\": {}\n  },\n  \"aggregations\": {\n    \"clients\": {\n      \"terms\": {\n        \"field\": \"client_id\",\n        \"size\": 5\n      },\n      \"aggregations\": {\n        \"best\": {\n          \"top_hits\": {\n            \"size\": 10\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nError output:\n\n```\n{\nerror: SearchPhaseExecutionException[Failed to execute phase [query], all shards failed; shardFailures {[pBrJ6zkHS8CKfAopFnmKUg][online][7]: RemoteTransportException[Failed to deserialize response of type [org.elasticsearch.search.query.QuerySearchResult]]; nested: TransportSerializationException[Failed to deserialize response of type [org.elasticsearch.search.query.QuerySearchResult]]; nested: IndexOutOfBoundsException[Invalid index: 214 - Bytes needed: 1470744, maximum is 48585]; }]\nstatus: 500\n}\n```\n\nI have this error only if query  executed at second node. If first, all is OK.\nWith search shards api, looks like 3016 route to 7th shard. Second node does not contain 7th, but first does.\n\nAny ideas?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70527639","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-70527639","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":70527639,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNTI3NjM5","user":{"login":"mitallast","id":531623,"node_id":"MDQ6VXNlcjUzMTYyMw==","avatar_url":"https://avatars1.githubusercontent.com/u/531623?v=4","gravatar_id":"","url":"https://api.github.com/users/mitallast","html_url":"https://github.com/mitallast","followers_url":"https://api.github.com/users/mitallast/followers","following_url":"https://api.github.com/users/mitallast/following{/other_user}","gists_url":"https://api.github.com/users/mitallast/gists{/gist_id}","starred_url":"https://api.github.com/users/mitallast/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitallast/subscriptions","organizations_url":"https://api.github.com/users/mitallast/orgs","repos_url":"https://api.github.com/users/mitallast/repos","events_url":"https://api.github.com/users/mitallast/events{/privacy}","received_events_url":"https://api.github.com/users/mitallast/received_events","type":"User","site_admin":false},"created_at":"2015-01-19T17:08:01Z","updated_at":"2015-01-19T17:08:59Z","author_association":"NONE","body":"Sorry, I can't show our index data - DNA restrictions. I have not find any reproduce test data.\n\nI'm reproduce it in debugger Intellij IDEA, and try to find where is an mistake.\n\nSeems like `SearchShardTarget#readFrom` code contains extra reads of two bytes with comparing to `SearchShardTarget#writeTo`\n\nSee at screenshots:\nhttps://www.dropbox.com/s/7ukfm9ozlg0rxzb/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%202015-01-19%2019.52.16.png?dl=0\nhttps://www.dropbox.com/s/bux416lf3gnzfpg/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%202015-01-19%2020.01.28.png?dl=0\n\n`int length` in line 221 must be an `22` , but `ChannelBufferStreamInput.buffer.readerIndex = 439`. Looks like It must be 437 (4 bytes for int, value 22 presents as `0-0-0-22` in byte-as-decimal view). Maybe somewhere uses `writeVInt` for write, and `readInt` for read, or something like this.\n\nLook:\nhttps://www.dropbox.com/s/gnuntjuamw1drjp/%D0%A1%D0%BA%D1%80%D0%B8%D0%BD%D1%88%D0%BE%D1%82%202015-01-19%2020.02.29.png?dl=0\nEarlier in program stack `InternalSearchHits#readFrom` lines between 207 and 210 have a correct parsed values for `totalHits`, `maxScore`, `size` and `lookupSize`.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/70632937","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-70632937","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":70632937,"node_id":"MDEyOklzc3VlQ29tbWVudDcwNjMyOTM3","user":{"login":"mitallast","id":531623,"node_id":"MDQ6VXNlcjUzMTYyMw==","avatar_url":"https://avatars1.githubusercontent.com/u/531623?v=4","gravatar_id":"","url":"https://api.github.com/users/mitallast","html_url":"https://github.com/mitallast","followers_url":"https://api.github.com/users/mitallast/followers","following_url":"https://api.github.com/users/mitallast/following{/other_user}","gists_url":"https://api.github.com/users/mitallast/gists{/gist_id}","starred_url":"https://api.github.com/users/mitallast/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mitallast/subscriptions","organizations_url":"https://api.github.com/users/mitallast/orgs","repos_url":"https://api.github.com/users/mitallast/repos","events_url":"https://api.github.com/users/mitallast/events{/privacy}","received_events_url":"https://api.github.com/users/mitallast/received_events","type":"User","site_admin":false},"created_at":"2015-01-20T10:23:37Z","updated_at":"2015-01-20T10:23:37Z","author_association":"NONE","body":"Maybe I found mistake:\n\n`org.elasticsearch.search.SearchShardTarget` has this correct methods:\n\n```\n    @Override\n    public void readFrom(StreamInput in) throws IOException {\n        if (in.readBoolean()) {\n            nodeId = in.readSharedText();\n        }\n        index = in.readSharedText();\n        shardId = in.readVInt();\n    }\n\n    @Override\n    public void writeTo(StreamOutput out) throws IOException {\n        if (nodeId == null) {\n            out.writeBoolean(false);\n        } else {\n            out.writeBoolean(true);\n            out.writeSharedText(nodeId);\n        }\n        out.writeSharedText(index);\n        out.writeVInt(shardId);\n    }\n```\n\nBut when ES at first time execute no-cached query, argument for `writeTo` is an `BytesStreamOutput` with parent class `StreamOutput` contains:\n\n```\n    public void writeText(Text text) throws IOException {\n        if (!text.hasBytes()) {\n            final String string = text.string();\n            spare.copyChars(string);\n            writeInt(spare.length());\n            write(spare.bytes(), 0, spare.length());\n        } else {\n            BytesReference bytes = text.bytes();\n            writeInt(bytes.length());\n            bytes.writeTo(this);\n        }\n    }\n\n    public void writeSharedText(Text text) throws IOException {\n        writeText(text);\n    }\n```\n\nIt means that `org.elasticsearch.common.io.stream.StreamOutput#writeSharedText` just proxy to `org.elasticsearch.common.io.stream.StreamOutput#writeText`\n\nBut when it reads at next node, uses a HandlesStreamInput with this override implementation\n\n```\n@Override\n    public Text readSharedText() throws IOException {\n        byte b = in.readByte();\n        if (b == 0) {\n            int handle = in.readVInt();\n            Text s = in.readText();\n            handlesText.put(handle, s);\n            return s;\n        } else if (b == 1) {\n            return handlesText.get(in.readVInt());\n        } else if (b == 2) {\n            return in.readText();\n        } else {\n            throw new IOException(\"Expected handle header, got [\" + b + \"]\");\n        }\n    }\n```\n\nThis two implementations are not byte compatible together. \nMaybe HandlesStreamInput should not override `readSharedText`, but should only `readSharedString` ?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/73853607","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-73853607","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":73853607,"node_id":"MDEyOklzc3VlQ29tbWVudDczODUzNjA3","user":{"login":"thomas11","id":12074,"node_id":"MDQ6VXNlcjEyMDc0","avatar_url":"https://avatars0.githubusercontent.com/u/12074?v=4","gravatar_id":"","url":"https://api.github.com/users/thomas11","html_url":"https://github.com/thomas11","followers_url":"https://api.github.com/users/thomas11/followers","following_url":"https://api.github.com/users/thomas11/following{/other_user}","gists_url":"https://api.github.com/users/thomas11/gists{/gist_id}","starred_url":"https://api.github.com/users/thomas11/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thomas11/subscriptions","organizations_url":"https://api.github.com/users/thomas11/orgs","repos_url":"https://api.github.com/users/thomas11/repos","events_url":"https://api.github.com/users/thomas11/events{/privacy}","received_events_url":"https://api.github.com/users/thomas11/received_events","type":"User","site_admin":false},"created_at":"2015-02-11T09:29:34Z","updated_at":"2015-02-11T09:29:34Z","author_association":"CONTRIBUTOR","body":"Unfortunately I couldn't reproduce it either, but I can confirm the issue exactly as mitallast described. Not setting search_type to \"count\" makes it disappear.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/73854092","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-73854092","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":73854092,"node_id":"MDEyOklzc3VlQ29tbWVudDczODU0MDky","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2015-02-11T09:34:06Z","updated_at":"2015-02-11T09:34:06Z","author_association":"CONTRIBUTOR","body":"@mitallast you are absolutely right. I found the same issue on a different occasion and must have missed this issue. We fixed this lately and removed the `read/writeSharedText` and friends in master completely. For 1.x and the upcoming 1.4.3 release this is fixed by #9500\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/73854220","html_url":"https://github.com/elastic/elasticsearch/issues/9294#issuecomment-73854220","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9294","id":73854220,"node_id":"MDEyOklzc3VlQ29tbWVudDczODU0MjIw","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2015-02-11T09:35:08Z","updated_at":"2015-02-11T09:35:08Z","author_association":"CONTRIBUTOR","body":"> Unfortunately I couldn't reproduce it either, but I can confirm the issue exactly as mitallast described. Not setting search_type to \"count\" makes it disappear.\n\nyeah we don't use the query cache if `search_type` is not `count` :)\n","performed_via_github_app":null}]