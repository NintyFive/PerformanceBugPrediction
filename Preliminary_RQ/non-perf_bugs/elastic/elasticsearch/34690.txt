{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34690","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34690/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34690/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34690/events","html_url":"https://github.com/elastic/elasticsearch/issues/34690","id":372371474,"node_id":"MDU6SXNzdWUzNzIzNzE0NzQ=","number":34690,"title":"[DOCS] Add SAML troubleshooting doc","user":{"login":"tvernum","id":2244393,"node_id":"MDQ6VXNlcjIyNDQzOTM=","avatar_url":"https://avatars0.githubusercontent.com/u/2244393?v=4","gravatar_id":"","url":"https://api.github.com/users/tvernum","html_url":"https://github.com/tvernum","followers_url":"https://api.github.com/users/tvernum/followers","following_url":"https://api.github.com/users/tvernum/following{/other_user}","gists_url":"https://api.github.com/users/tvernum/gists{/gist_id}","starred_url":"https://api.github.com/users/tvernum/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tvernum/subscriptions","organizations_url":"https://api.github.com/users/tvernum/orgs","repos_url":"https://api.github.com/users/tvernum/repos","events_url":"https://api.github.com/users/tvernum/events{/privacy}","received_events_url":"https://api.github.com/users/tvernum/received_events","type":"User","site_admin":false},"labels":[{"id":912837951,"node_id":"MDU6TGFiZWw5MTI4Mzc5NTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Security/Authentication","name":":Security/Authentication","color":"0e8a16","default":false,"description":"Logging in, Usernames/passwords, Realms (Native/LDAP/AD/SAML/PKI/etc)"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"assignees":[{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false}],"milestone":null,"comments":3,"created_at":"2018-10-22T00:43:03Z","updated_at":"2018-11-19T20:39:37Z","closed_at":"2018-11-19T20:39:37Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"There's a handful of common setup issues for SAML that create confusion for users, but are hard to solve technically.\r\n\r\nA trouble shooting document for SAML may help users understand how to work through these problems.\r\n\r\nSpecific examples:\r\n\r\n### Incorrect ACS URL\r\nThe error\r\n```\r\norg.elasticsearch.ElasticsearchSecurityException: Cannot find any matching realm for\r\n[SamlPrepareAuthenticationRequest{realmName=null,\r\nassertionConsumerServiceURL=https://my.kibana.url/api/security/v1/saml}]\r\n```\r\ncan usually be resolved by either changing the `sp.acs` in the elasticsearch config, or the `xpack.security.public.*` settings in kibana. The correct choice between those options _depends_, but can be documented.\r\n\r\n### Incorrect IdP Id or Metadata\r\n```\r\norg.elasticsearch.ElasticsearchSecurityException: \r\nCannot find metadata for entity [your:entity.id] in [metadata.xml] \r\n```\r\nWe're looking for `idp.entity_id` (\"your:entity_id\") in the configured metadata file (\"metadata.xml\"), but can't find it.\r\nEither ther entity id has been configured incorrectly, or the wrong metadata file is being used.\r\n\r\n### Want to login with standard Kibana username/password\r\nSometimes users are surprised when turning on SAML prevents logging in with a Kibana username & password. [We document how to do this](https://www.elastic.co/guide/en/elastic-stack-overview/6.3/saml-kibana.html#_supporting_saml_and_basic_authentication_in_kibana) but I think it's worth having it as a specific section in the trouble shooting.\r\n\r\n### Authentication fails with confusing error\r\n```\r\nunable to authenticate user [<unauthenticated-saml-user>]\r\nfor action [cluster:admin/xpack/security/saml/authenticate]\r\n```\r\nThe use of `unauthenticated-saml-user` here sometimes confuses people (which is understandable - it wasn't a great choice of error message).\r\nThis simply means that we failed to process the incoming saml authentication message for some reason. (It says \"unauthenticated-saml-user\" because we don't actually know the userid that the message is intended to be for until we've successfully processed it).\r\nTo diagnose _why_ authentication failed, the admin needs to check the Elasticsearch logs.\r\n\r\n### IdP rejected authentication\r\n```\r\nAuthentication to realm my-saml-realm failed - \r\nProvided SAML response is not valid for realm saml/my-saml-realm \r\n(Caused by ElasticsearchSecurityException[SAML Response is not a 'success' response:\r\nCode=urn:oasis:names:tc:SAML:2.0:status:AuthnFailed Message=null Detail=null])\r\n ```\r\n(In some cases the `Code` might be a different error identifier).\r\n\r\nThis means that there was a problem in the Identity Provider side, and it sent an error code back to the Elastic stack.\r\nBecause the `Message` and `Detail` are both `null`, it is not possible to diagnose the problem here. The IdP admin will need to consult the logs/documentation for the IdP to see why it sent an error  code.\r\n\r\n\r\n","closed_by":{"login":"jkakavas","id":10281256,"node_id":"MDQ6VXNlcjEwMjgxMjU2","avatar_url":"https://avatars2.githubusercontent.com/u/10281256?v=4","gravatar_id":"","url":"https://api.github.com/users/jkakavas","html_url":"https://github.com/jkakavas","followers_url":"https://api.github.com/users/jkakavas/followers","following_url":"https://api.github.com/users/jkakavas/following{/other_user}","gists_url":"https://api.github.com/users/jkakavas/gists{/gist_id}","starred_url":"https://api.github.com/users/jkakavas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jkakavas/subscriptions","organizations_url":"https://api.github.com/users/jkakavas/orgs","repos_url":"https://api.github.com/users/jkakavas/repos","events_url":"https://api.github.com/users/jkakavas/events{/privacy}","received_events_url":"https://api.github.com/users/jkakavas/received_events","type":"User","site_admin":false},"performed_via_github_app":null}