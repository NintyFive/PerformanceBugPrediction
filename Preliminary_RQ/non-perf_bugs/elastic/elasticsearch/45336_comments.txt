[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/519546110","html_url":"https://github.com/elastic/elasticsearch/issues/45336#issuecomment-519546110","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45336","id":519546110,"node_id":"MDEyOklzc3VlQ29tbWVudDUxOTU0NjExMA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-08-08T14:36:29Z","updated_at":"2019-08-08T14:36:29Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/521221632","html_url":"https://github.com/elastic/elasticsearch/issues/45336#issuecomment-521221632","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45336","id":521221632,"node_id":"MDEyOklzc3VlQ29tbWVudDUyMTIyMTYzMg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-08-14T12:16:08Z","updated_at":"2019-08-14T12:16:52Z","author_association":"MEMBER","body":"So this is a really strange state to be in:\r\n\r\n```\r\n[2019-08-08T12:04:23,625][INFO ][o.e.c.m.MetaDataCreateIndexService] [integTestMinio-0] [docs] creating index, cause [auto(bulk api)], templates [], shards [1]/[1], mappings []\r\n[2019-08-08T12:04:24,650][INFO ][o.e.c.m.MetaDataMappingService] [integTestMinio-0] [docs/O1dpyDjUTn2l9OIFm49v-A] create_mapping [doc]\r\n[2019-08-08T12:04:25,812][INFO ][o.e.s.SnapshotsService   ] [integTestMinio-0] snapshot [repository_permanent:snapshot-one/gkSS10brSEycokZvWD4Uug] started\r\n[2019-08-08T12:04:26,263][INFO ][o.e.s.SnapshotsService   ] [integTestMinio-0] snapshot [repository_permanent:snapshot-one/gkSS10brSEycokZvWD4Uug] completed with state [SUCCESS]\r\n[2019-08-08T12:04:26,689][INFO ][o.e.s.SnapshotsService   ] [integTestMinio-0] snapshot [repository_permanent:snapshot-two/yakZmp42RJynf5AU_EB8MA] started\r\n[2019-08-08T12:04:29,655][INFO ][o.e.s.SnapshotsService   ] [integTestMinio-0] snapshot [repository_permanent:snapshot-two/yakZmp42RJynf5AU_EB8MA] completed with state [SUCCESS]\r\n[2019-08-08T12:04:30,246][INFO ][o.e.c.m.MetaDataDeleteIndexService] [integTestMinio-0] [docs/O1dpyDjUTn2l9OIFm49v-A] deleting index\r\n[2019-08-08T12:05:01,566][WARN ][o.e.s.RestoreService     ] [integTestMinio-0] [snapshot-two/yakZmp42RJynf5AU_EB8MA] failed to restore snapshot\r\norg.elasticsearch.snapshots.SnapshotRestoreException: [repository_permanent:snapshot-two/yakZmp42RJynf5AU_EB8MA] cannot restore index [docs] because an open index with same name already exists in the cluster. Either close or delete the existing index or restore the index under a different name by providing a rename pattern and replacement name\r\n\tat org.elasticsearch.snapshots.RestoreService$1.validateExistingIndex(RestoreService.java:444) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.snapshots.RestoreService$1.execute(RestoreService.java:294) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.ClusterStateUpdateTask.execute(ClusterStateUpdateTask.java:47) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.MasterService.executeTasks(MasterService.java:697) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.MasterService.calculateTaskOutputs(MasterService.java:319) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.MasterService.runTasks(MasterService.java:214) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.MasterService$Batcher.run(MasterService.java:151) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed(TaskBatcher.java:150) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run(TaskBatcher.java:188) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run(ThreadContext.java:699) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:252) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:215) [elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1128) [?:?]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:628) [?:?]\r\n\tat java.lang.Thread.run(Thread.java:834) [?:?]\r\n[2019-08-08T12:05:06,747][DEBUG][o.e.a.a.c.s.r.RestoreClusterStateListener] [integTestMinio-0] restore of [snapshot-two/yakZmp42RJynf5AU_EB8MA] completed\r\n[2019-08-08T12:05:06,751][INFO ][o.e.r.RepositoriesService] [integTestMinio-0] delete repository [repository_permanent]\r\n[2019-08-08T12:05:06,788][INFO ][o.e.c.m.MetaDataDeleteIndexService] [integTestMinio-0] [docs/T9_1gwFJQo--MAIrttMetQ] deleting index\r\n\r\n```\r\n\r\nWe delete the index which looks like it worked out, no error there.\r\nThe we log a failed restore operation but also log this:\r\n\r\n```\r\n[2019-08-08T12:05:06,747][DEBUG][o.e.a.a.c.s.r.RestoreClusterStateListener] [integTestMinio-0] restore of [snapshot-two/yakZmp42RJynf5AU_EB8MA] completed\r\n```\r\n\r\nThis is logged from a cluster state update listener for the restore that should not be created for a failed restore. Also in the next step the index uuid for `docs` has in fact changed when it is deleted again. Almost seems like the restore was executed twice for some reason with one restore succeeding and one failing and the failing one being used for the REST response. Looking into it ...\r\n\r\nAttached the full node logs for reference:\r\n\r\n[integTestMinio.log](https://github.com/elastic/elasticsearch/files/3501276/integTestMinio.log)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/530127844","html_url":"https://github.com/elastic/elasticsearch/issues/45336#issuecomment-530127844","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/45336","id":530127844,"node_id":"MDEyOklzc3VlQ29tbWVudDUzMDEyNzg0NA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-09-10T21:28:06Z","updated_at":"2019-09-10T21:28:06Z","author_association":"MEMBER","body":"Closing this as duplicate of https://github.com/elastic/elasticsearch/issues/46091 ... same issue, except that the restore operation was rerun as a result of slowness. For now we should be good here with the higher timeout and CI adjustments anyway.","performed_via_github_app":null}]