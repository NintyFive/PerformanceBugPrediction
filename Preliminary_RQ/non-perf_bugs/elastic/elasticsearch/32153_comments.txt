[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/405851863","html_url":"https://github.com/elastic/elasticsearch/issues/32153#issuecomment-405851863","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32153","id":405851863,"node_id":"MDEyOklzc3VlQ29tbWVudDQwNTg1MTg2Mw==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2018-07-18T08:26:05Z","updated_at":"2018-07-18T08:26:05Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-search-aggs","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409356931","html_url":"https://github.com/elastic/elasticsearch/issues/32153#issuecomment-409356931","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32153","id":409356931,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTM1NjkzMQ==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T20:28:38Z","updated_at":"2018-07-31T23:16:14Z","author_association":"MEMBER","body":"Hi @ydzhu, in a `terms` aggregation it's unfortunately not possible to order by the result of a `pipeline` aggregation like `bucket_script` (see the note here: https://www.elastic.co/guide/en/elasticsearch/reference/6.3/search-aggregations-bucket-terms-aggregation.html#search-aggregations-bucket-terms-aggregation-order).\r\n\r\nIt's not good that we're throwing a 503, and the error message is also misleading. We're tracking the error code issue in #20003. \r\n\r\nI don't see an easy workaround for your request, but tagging @polyfractal just in case he has an idea.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409377343","html_url":"https://github.com/elastic/elasticsearch/issues/32153#issuecomment-409377343","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32153","id":409377343,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTM3NzM0Mw==","user":{"login":"polyfractal","id":1224228,"node_id":"MDQ6VXNlcjEyMjQyMjg=","avatar_url":"https://avatars1.githubusercontent.com/u/1224228?v=4","gravatar_id":"","url":"https://api.github.com/users/polyfractal","html_url":"https://github.com/polyfractal","followers_url":"https://api.github.com/users/polyfractal/followers","following_url":"https://api.github.com/users/polyfractal/following{/other_user}","gists_url":"https://api.github.com/users/polyfractal/gists{/gist_id}","starred_url":"https://api.github.com/users/polyfractal/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/polyfractal/subscriptions","organizations_url":"https://api.github.com/users/polyfractal/orgs","repos_url":"https://api.github.com/users/polyfractal/repos","events_url":"https://api.github.com/users/polyfractal/events{/privacy}","received_events_url":"https://api.github.com/users/polyfractal/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T21:41:49Z","updated_at":"2018-07-31T21:41:49Z","author_association":"MEMBER","body":"@jtibshirani is correct, you can't sort by pipeline aggs... they are executed after regular aggs execute.\r\n\r\nIf the terms agg contains all the entries you care about, you can still do pipeline sorting using the `bucket_sort` pipeline agg: https://www.elastic.co/guide/en/elasticsearch/reference/6.x/search-aggregations-pipeline-bucket-sort-aggregation.html\r\n\r\nThe caveat is that this performs sorting on the final list of buckets, not while the aggregations are calculating.  So it only sorts the list that is returned by the `terms` agg... if a term/value isn't in the list, it won't get sorted.  That's in contrast to sorting on the `terms` agg itself, which changes the contents of the list.\r\n\r\nIt'd look something like this (untested):\r\n\r\n```\r\n{\r\n  \"from\": 0,\r\n  \"size\": 0,\r\n  \"sort\": [],\r\n  \"aggs\": {\r\n    \"api_terms\": {\r\n      \"terms\": {\r\n        \"field\": \"name\",\r\n        \"order\": {\r\n          \"avg_time\": \"desc\"\r\n        }\r\n      },\r\n      \"aggs\": {\r\n        \"sum_duration\": {\r\n          \"sum\": {\r\n            \"field\": \"duration\"\r\n          }\r\n        },\r\n        \"sum_count\": {\r\n          \"sum\": {\r\n            \"field\": \"count\"\r\n          }\r\n        },\r\n        \"avg_time\": {\r\n          \"bucket_script\": {\r\n            \"buckets_path\": {\r\n              \"duration\": \"sum_duration\",\r\n              \"count\": \"sum_count\"\r\n            },\r\n            \"script\": \"params.duration / params.count\"\r\n          }\r\n        },\r\n        \"final_sort\": {\r\n          \"bucket_sort\": {\r\n             \"sort\": [\r\n               {\"avg_time\": {\"order\": \"desc\"}}\r\n              ]\r\n           }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n\r\n\r\n\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/409398282","html_url":"https://github.com/elastic/elasticsearch/issues/32153#issuecomment-409398282","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32153","id":409398282,"node_id":"MDEyOklzc3VlQ29tbWVudDQwOTM5ODI4Mg==","user":{"login":"jtibshirani","id":7461306,"node_id":"MDQ6VXNlcjc0NjEzMDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7461306?v=4","gravatar_id":"","url":"https://api.github.com/users/jtibshirani","html_url":"https://github.com/jtibshirani","followers_url":"https://api.github.com/users/jtibshirani/followers","following_url":"https://api.github.com/users/jtibshirani/following{/other_user}","gists_url":"https://api.github.com/users/jtibshirani/gists{/gist_id}","starred_url":"https://api.github.com/users/jtibshirani/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jtibshirani/subscriptions","organizations_url":"https://api.github.com/users/jtibshirani/orgs","repos_url":"https://api.github.com/users/jtibshirani/repos","events_url":"https://api.github.com/users/jtibshirani/events{/privacy}","received_events_url":"https://api.github.com/users/jtibshirani/received_events","type":"User","site_admin":false},"created_at":"2018-07-31T23:16:59Z","updated_at":"2018-07-31T23:17:06Z","author_association":"MEMBER","body":"I opened #32522 in hopes of clarifying the error message. I'll close this out once that goes in.","performed_via_github_app":null}]