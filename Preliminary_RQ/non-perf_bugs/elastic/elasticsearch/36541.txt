{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36541","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36541/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36541/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36541/events","html_url":"https://github.com/elastic/elasticsearch/issues/36541","id":390218586,"node_id":"MDU6SXNzdWUzOTAyMTg1ODY=","number":36541,"title":"Provide a way to create RefreshListeners at the tip of the Translog","user":{"login":"clandry94","id":5351125,"node_id":"MDQ6VXNlcjUzNTExMjU=","avatar_url":"https://avatars0.githubusercontent.com/u/5351125?v=4","gravatar_id":"","url":"https://api.github.com/users/clandry94","html_url":"https://github.com/clandry94","followers_url":"https://api.github.com/users/clandry94/followers","following_url":"https://api.github.com/users/clandry94/following{/other_user}","gists_url":"https://api.github.com/users/clandry94/gists{/gist_id}","starred_url":"https://api.github.com/users/clandry94/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clandry94/subscriptions","organizations_url":"https://api.github.com/users/clandry94/orgs","repos_url":"https://api.github.com/users/clandry94/repos","events_url":"https://api.github.com/users/clandry94/events{/privacy}","received_events_url":"https://api.github.com/users/clandry94/received_events","type":"User","site_admin":false},"labels":[{"id":836542781,"node_id":"MDU6TGFiZWw4MzY1NDI3ODE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Engine","name":":Distributed/Engine","color":"0e8a16","default":false,"description":"Anything around managing Lucene and the Translog in an open shard."}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":10,"created_at":"2018-12-12T13:09:11Z","updated_at":"2019-02-07T14:08:58Z","closed_at":"2018-12-17T13:55:07Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"**Describe the feature**:\r\n\r\nCurrently, the `addRefreshListener` method in the `IndexShard` class is publicly exposed, but expects to receive a `Translog.Location` and `Consumer` to add a new `RefreshListener`. This is fine in the context of indexation where the `Translog` is readily available, but as a plugin developer there is no way to publicly retrieve the `Translog`, especially when extending an `IndexModule` to react to different state changes of shards such as `void afterIndexShardStarted(IndexShard indexShard)` and `void beforeIndexShardClosed(ShardId shardId, @Nullable IndexShard indexShard, Settings indexSettings)`\r\n\r\nI'm proposing one of two changes within the `IndexShard` class:\r\n\r\n1) Publicly expose the `Engine` from within `IndexShard`. This used to be the case, but was changed in previous commits a while back. This would allow plugins to grab the `Translog` as well as the last write location and thus build their own `RefreshListeners`. \r\n\r\n-or-\r\n\r\n2) Add a new public method within `IndexShard` which would look something like this\r\n```\r\npublic void addRefreshListenerAtLatestWriteLocation(Consumer<boolean> listener) {\r\n  Translog.Location latestLocation = getEngine().getTranslogLastWriteLocation();\r\n  addRefreshListener(latestLocation, listener);\r\n}\r\n```\r\nThis method would be safer than option 1 since it keeps the `Engine` accessor package private. Since it is read only, I don't think this would introduce any synchronization issues. \r\n\r\nMaking either of these changes would enable plugin developers to make use of `RefreshListeners` within a cluster and fulfill a couple of use-cases:\r\n1) Retrieve metrics on refresh rates at a shard level rather than an average of all shard refreshes at an index level. This is nice for those of us that maintain clusters with hundreds of shards and the average refresh rate is not particularly useful for us. \r\n\r\n2) Build plugins that make use of shard level refresh data and perform actions such as application level cache invalidation based on when data on a specific shard is available for search","closed_by":{"login":"clandry94","id":5351125,"node_id":"MDQ6VXNlcjUzNTExMjU=","avatar_url":"https://avatars0.githubusercontent.com/u/5351125?v=4","gravatar_id":"","url":"https://api.github.com/users/clandry94","html_url":"https://github.com/clandry94","followers_url":"https://api.github.com/users/clandry94/followers","following_url":"https://api.github.com/users/clandry94/following{/other_user}","gists_url":"https://api.github.com/users/clandry94/gists{/gist_id}","starred_url":"https://api.github.com/users/clandry94/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clandry94/subscriptions","organizations_url":"https://api.github.com/users/clandry94/orgs","repos_url":"https://api.github.com/users/clandry94/repos","events_url":"https://api.github.com/users/clandry94/events{/privacy}","received_events_url":"https://api.github.com/users/clandry94/received_events","type":"User","site_admin":false},"performed_via_github_app":null}