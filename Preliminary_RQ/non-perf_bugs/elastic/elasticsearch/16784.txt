{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/16784","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16784/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16784/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/16784/events","html_url":"https://github.com/elastic/elasticsearch/issues/16784","id":135863264,"node_id":"MDU6SXNzdWUxMzU4NjMyNjQ=","number":16784,"title":"Sort with a closure comparator doesn't work from groovy scripts","user":{"login":"bra-fsn","id":820331,"node_id":"MDQ6VXNlcjgyMDMzMQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820331?v=4","gravatar_id":"","url":"https://api.github.com/users/bra-fsn","html_url":"https://github.com/bra-fsn","followers_url":"https://api.github.com/users/bra-fsn/followers","following_url":"https://api.github.com/users/bra-fsn/following{/other_user}","gists_url":"https://api.github.com/users/bra-fsn/gists{/gist_id}","starred_url":"https://api.github.com/users/bra-fsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bra-fsn/subscriptions","organizations_url":"https://api.github.com/users/bra-fsn/orgs","repos_url":"https://api.github.com/users/bra-fsn/repos","events_url":"https://api.github.com/users/bra-fsn/events{/privacy}","received_events_url":"https://api.github.com/users/bra-fsn/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-02-23T20:59:29Z","updated_at":"2016-02-23T22:33:12Z","closed_at":"2016-02-23T22:33:00Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.2.0\n\n**JVM version**:openjdk version \"1.8.0_66\"\nOpenJDK Runtime Environment (build 1.8.0_66-b17)\nOpenJDK 64-Bit Server VM (build 25.66-b17, mixed mode)\n\n**OS version**: FreeBSD 10\n\n**Description of the problem including expected versus actual behavior**: I would like to sort a list from a groovy script with a custom comparator. It fails.\nI've already tried to disable groovy sandbox by setting\nscript.groovy.sandbox.enabled: false\n\n**Steps to reproduce**:\nPut this into a groovy script and call it:\n`list=[1,2,3,4,5]\nlist.sort{ a, b ->\n    if (a>b)\n        return -1\n    else if (a<b)\n        return 1\n    else\n        return 0\n\n}`\n\n**Provide logs (if relevant)**:\n`2016-02-2321:52:33,259][INFO` ][rest.suppressed          ] /a/b/c/_update Params: {index=a, id=b, type=c}\nRemoteTransportException[[dev00][192.168.0.170:9301][indices:data/write/update[s]]]; nested: IllegalArgumentException[failed to execute script]; nested: ScriptException[failed to run file script [report] using lang [groovy]]; nested: NoClassDefFoundError[sun/reflect/MethodAccessorImpl]; nested: ClassNotFoundException[sun.reflect.MethodAccessorImpl];\nCaused by: java.lang.IllegalArgumentException: failed to execute script\n    at org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:256)\n    at org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:196)\n    at org.elasticsearch.action.update.UpdateHelper.prepare(UpdateHelper.java:79)\n    at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:170)\n    at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:164)\n    at org.elasticsearch.action.update.TransportUpdateAction.shardOperation(TransportUpdateAction.java:65)\n    at org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$ShardTransportHandler.messageReceived(TransportInstanceSingleOperationAction.java:249)\n    at org.elasticsearch.action.support.single.instance.TransportInstanceSingleOperationAction$ShardTransportHandler.messageReceived(TransportInstanceSingleOperationAction.java:245)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:350)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: ScriptException[failed to run file script [report] using lang [groovy]]; nested: NoClassDefFoundError[sun/reflect/MethodAccessorImpl]; nested: ClassNotFoundException[sun.reflect.MethodAccessorImpl];\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:318)\n    at org.elasticsearch.action.update.UpdateHelper.executeScript(UpdateHelper.java:251)\n    ... 12 more\nCaused by: java.lang.NoClassDefFoundError: sun/reflect/MethodAccessorImpl\n    at sun.misc.Unsafe.defineClass(Native Method)\n    at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:63)\n    at sun.reflect.MethodAccessorGenerator$1.run(MethodAccessorGenerator.java:399)\n    at sun.reflect.MethodAccessorGenerator$1.run(MethodAccessorGenerator.java:394)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:393)\n    at sun.reflect.MethodAccessorGenerator.generateMethod(MethodAccessorGenerator.java:75)\n    at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:53)\n    at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\n    at java.lang.reflect.Method.invoke(Method.java:497)\n    at org.codehaus.groovy.reflection.CachedMethod.invoke(CachedMethod.java:93)\n    at groovy.lang.MetaMethod.doMethodInvoke(MetaMethod.java:325)\n    at org.codehaus.groovy.runtime.metaclass.ClosureMetaClass.invokeMethod(ClosureMetaClass.java:294)\n    at groovy.lang.MetaClassImpl.invokeMethod(MetaClassImpl.java:1019)\n    at groovy.lang.Closure.call(Closure.java:426)\n    at groovy.util.ClosureComparator.compare(ClosureComparator.java:39)\n    at java.util.TimSort.countRunAndMakeAscending(TimSort.java:356)\n    at java.util.TimSort.sort(TimSort.java:234)\n    at java.util.Arrays.sort(Arrays.java:1512)\n    at java.util.ArrayList.sort(ArrayList.java:1454)\n    at java.util.Collections.sort(Collections.java:175)\n    at org.codehaus.groovy.runtime.DefaultGroovyMethods.sort(DefaultGroovyMethods.java:8476)\n    at org.codehaus.groovy.runtime.DefaultGroovyMethods.sort(DefaultGroovyMethods.java:8438)\n    at org.codehaus.groovy.runtime.dgm$566.doMethodInvoke(Unknown Source)\n    at org.codehaus.groovy.vmplugin.v7.IndyInterface.selectMethod(IndyInterface.java:218)\n    at ae5d43c5eafaae31062b2722aa92b85ba22c61c7.run(ae5d43c5eafaae31062b2722aa92b85ba22c61c7:43)\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript$1.run(GroovyScriptEngineService.java:311)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:308)\n    ... 13 more\nCaused by: java.lang.ClassNotFoundException: sun.reflect.MethodAccessorImpl\n    at java.net.URLClassLoader.findClass(URLClassLoader.java:381)\n    at java.lang.ClassLoader.loadClass(ClassLoader.java:424)\n    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:677)\n    at groovy.lang.GroovyClassLoader$InnerLoader.loadClass(GroovyClassLoader.java:425)\n    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:787)\n    at groovy.lang.GroovyClassLoader.loadClass(GroovyClassLoader.java:775)\n    ... 42 more\n\n`\n","closed_by":{"login":"bra-fsn","id":820331,"node_id":"MDQ6VXNlcjgyMDMzMQ==","avatar_url":"https://avatars2.githubusercontent.com/u/820331?v=4","gravatar_id":"","url":"https://api.github.com/users/bra-fsn","html_url":"https://github.com/bra-fsn","followers_url":"https://api.github.com/users/bra-fsn/followers","following_url":"https://api.github.com/users/bra-fsn/following{/other_user}","gists_url":"https://api.github.com/users/bra-fsn/gists{/gist_id}","starred_url":"https://api.github.com/users/bra-fsn/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bra-fsn/subscriptions","organizations_url":"https://api.github.com/users/bra-fsn/orgs","repos_url":"https://api.github.com/users/bra-fsn/repos","events_url":"https://api.github.com/users/bra-fsn/events{/privacy}","received_events_url":"https://api.github.com/users/bra-fsn/received_events","type":"User","site_admin":false},"performed_via_github_app":null}