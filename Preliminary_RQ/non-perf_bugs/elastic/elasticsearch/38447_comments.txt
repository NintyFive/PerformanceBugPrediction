[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460709282","html_url":"https://github.com/elastic/elasticsearch/issues/38447#issuecomment-460709282","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38447","id":460709282,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDcwOTI4Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T16:40:13Z","updated_at":"2019-02-05T16:40:13Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460717794","html_url":"https://github.com/elastic/elasticsearch/issues/38447#issuecomment-460717794","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38447","id":460717794,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDcxNzc5NA==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T17:01:38Z","updated_at":"2019-02-05T17:01:38Z","author_association":"CONTRIBUTOR","body":"Thanks @original-brownbear , FYI my PR  build where #38368 is not merged also failed in testMasterAndDataShutdownDuringSnapshot:\r\n\r\nhttps://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+pull-request-1/7454/console\r\n\r\nLooks like it ran for an extended duration:\r\n\r\n```\r\nHEARTBEAT J4 PID(48487@elasticsearch-ci-immutable-ubuntu-1404-1549379268547314587): 2019-02-05T15:27:19, stalled for 60.3s at: DedicatedClusterSnapshotRestoreIT.testMasterAndDataShutdownDuringSnapshot\r\nS\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460742771","html_url":"https://github.com/elastic/elasticsearch/issues/38447#issuecomment-460742771","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38447","id":460742771,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDc0Mjc3MQ==","user":{"login":"henningandersen","id":33268011,"node_id":"MDQ6VXNlcjMzMjY4MDEx","avatar_url":"https://avatars2.githubusercontent.com/u/33268011?v=4","gravatar_id":"","url":"https://api.github.com/users/henningandersen","html_url":"https://github.com/henningandersen","followers_url":"https://api.github.com/users/henningandersen/followers","following_url":"https://api.github.com/users/henningandersen/following{/other_user}","gists_url":"https://api.github.com/users/henningandersen/gists{/gist_id}","starred_url":"https://api.github.com/users/henningandersen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/henningandersen/subscriptions","organizations_url":"https://api.github.com/users/henningandersen/orgs","repos_url":"https://api.github.com/users/henningandersen/repos","events_url":"https://api.github.com/users/henningandersen/events{/privacy}","received_events_url":"https://api.github.com/users/henningandersen/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T18:09:09Z","updated_at":"2019-02-05T18:09:09Z","author_association":"CONTRIBUTOR","body":"I were able to reproduce the same failure locally by running the single test method on repeat until failure from within IntelliJ.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460757473","html_url":"https://github.com/elastic/elasticsearch/issues/38447#issuecomment-460757473","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38447","id":460757473,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDc1NzQ3Mw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T18:50:21Z","updated_at":"2019-02-05T18:50:21Z","author_association":"MEMBER","body":"Thanks for checking @henningandersen same here. Looking into fixing it now :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460767636","html_url":"https://github.com/elastic/elasticsearch/issues/38447#issuecomment-460767636","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38447","id":460767636,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDc2NzYzNg==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T19:18:57Z","updated_at":"2019-02-05T19:18:57Z","author_association":"MEMBER","body":"Seems with the changes from #38368 we're missing a state update on leaving nodes and get snapshots stuck in a state like:\r\n\r\n```json\r\n{\r\n  \"snapshots\": [\r\n    {\r\n      \"repository\": \"test-repo\",\r\n      \"snapshot\": \"test-snap\",\r\n      \"uuid\": \"KuLcFik0T86h21Y4bMVZ4Q\",\r\n      \"include_global_state\": true,\r\n      \"partial\": false,\r\n      \"state\": \"STARTED\",\r\n      \"indices\": [\r\n        {\r\n          \"name\": \"test-idx\",\r\n          \"id\": \"shkWw-veQFaFvBHAGegcjQ\"\r\n        }\r\n      ],\r\n      \"start_time_millis\": 1549394078202,\r\n      \"repository_state_id\": -1,\r\n      \"shards\": [\r\n        {\r\n          \"index\": {\r\n            \"index_name\": \"test-idx\",\r\n            \"index_uuid\": \"Lhug5HNuQ-i3ykpz0gkz-A\"\r\n          },\r\n          \"shard\": 1,\r\n          \"state\": \"SUCCESS\",\r\n          \"node\": \"6JO5slm7SzynyqKZ-C2sGg\"\r\n        },\r\n        {\r\n          \"index\": {\r\n            \"index_name\": \"test-idx\",\r\n            \"index_uuid\": \"Lhug5HNuQ-i3ykpz0gkz-A\"\r\n          },\r\n          \"shard\": 0,\r\n          \"state\": \"INIT\",\r\n          \"node\": \"Ovz6FD8bSEOdCzohp0_DKw\"\r\n        }\r\n      ]\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nWhen node `Ovz6FD8bSEOdCzohp0_DKw` has already left the cluster. => still on it :)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/460786713","html_url":"https://github.com/elastic/elasticsearch/issues/38447#issuecomment-460786713","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38447","id":460786713,"node_id":"MDEyOklzc3VlQ29tbWVudDQ2MDc4NjcxMw==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-02-05T20:14:46Z","updated_at":"2019-02-05T20:14:46Z","author_association":"MEMBER","body":"This fixes it, we were missing the node removal event when it coincided with master failover, opening a PR in a bit (trying to create a deterministic test that reproduces the issue):\r\n\r\n```diff\r\ndiff --git a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\r\nindex 17306e1585f..e2628fda991 100644\r\n--- a/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\r\n+++ b/server/src/main/java/org/elasticsearch/snapshots/SnapshotsService.java\r\n@@ -687,8 +687,9 @@ public class SnapshotsService extends AbstractLifecycleComponent implements Clus\r\n             if (event.localNodeMaster()) {\r\n                 // We don't remove old master when master flips anymore. So, we need to check for change in master\r\n                 final SnapshotsInProgress snapshotsInProgress = event.state().custom(SnapshotsInProgress.TYPE);\r\n+                final boolean newMaster = event.previousState().nodes().isLocalNodeElectedMaster() == false;\r\n                 if (snapshotsInProgress != null) {\r\n-                    if (removedNodesCleanupNeeded(snapshotsInProgress, event.nodesDelta().removedNodes())) {\r\n+                    if (newMaster || removedNodesCleanupNeeded(snapshotsInProgress, event.nodesDelta().removedNodes())) {\r\n                         processSnapshotsOnRemovedNodes();\r\n                     }\r\n                     if (event.routingTableChanged() && waitingShardsStartedOrUnassigned(snapshotsInProgress, event)) {\r\n@@ -704,7 +705,7 @@ public class SnapshotsService extends AbstractLifecycleComponent implements Clus\r\n                             || entry.state() != State.INIT && completed(entry.shards().values())\r\n                     ).forEach(this::endSnapshot);\r\n                 }\r\n-                if (event.previousState().nodes().isLocalNodeElectedMaster() == false) {\r\n+                if (newMaster) {\r\n                     finalizeSnapshotDeletionFromPreviousMaster(event);\r\n                 }\r\n             }        \r\n```","performed_via_github_app":null}]