{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/27620","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27620/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27620/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/27620/events","html_url":"https://github.com/elastic/elasticsearch/issues/27620","id":278563585,"node_id":"MDU6SXNzdWUyNzg1NjM1ODU=","number":27620,"title":"Child aggregation then by Parent aggregation (using _parent) not working after moving from 2.0.1 to 5.5.2","user":{"login":"barathguna","id":6757819,"node_id":"MDQ6VXNlcjY3NTc4MTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6757819?v=4","gravatar_id":"","url":"https://api.github.com/users/barathguna","html_url":"https://github.com/barathguna","followers_url":"https://api.github.com/users/barathguna/followers","following_url":"https://api.github.com/users/barathguna/following{/other_user}","gists_url":"https://api.github.com/users/barathguna/gists{/gist_id}","starred_url":"https://api.github.com/users/barathguna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/barathguna/subscriptions","organizations_url":"https://api.github.com/users/barathguna/orgs","repos_url":"https://api.github.com/users/barathguna/repos","events_url":"https://api.github.com/users/barathguna/events{/privacy}","received_events_url":"https://api.github.com/users/barathguna/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23715,"node_id":"MDU6TGFiZWwyMzcxNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Edocs","name":">docs","color":"db755e","default":false,"description":"General docs changes"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2017-12-01T19:03:59Z","updated_at":"2018-02-14T13:28:01Z","closed_at":"2017-12-07T13:17:43Z","author_association":"NONE","active_lock_reason":null,"body":"Issue: Aggregation on child field and by _parent field is not working after upgrading elastic search from 2.0.1 to 5.5.2.\r\n\r\nTest Details:\r\n1. ParentType will have all MAC address and its details.\r\n2. ChildType will have all application installed and its details (e.g. chrome (application name), 13(version), Browser(category))\r\n\r\nQuery Details:\r\nAggregate Application by \"child1\" (application name) then by \"child2\" (version) then cardinal aggregation by _parent id. This is to achieve, \"List all application and its version and number of MAC associated with it\"\r\n\r\nIssue: \"Group By mac parent1\" aggregation is 0 in elastic search 5.5.2.\r\n\r\nCreate Index:\r\n`curl -k -XPUT 'https://localhost:9200/testindex' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 3, \r\n            \"number_of_replicas\" : 1 \r\n        },\r\n        \"analysis\":{\r\n            \"analyzer\":{\r\n                \"case_insensitive_analyzer\":{\r\n                    \"tokenizer\":\"keyword\",\r\n                    \"filter\":\"lowercase\"\r\n                }\r\n            }\r\n        }\r\n    },\r\n  \"mappings\" : {\r\n    \"parenttype\": {\r\n        \"dynamic\":\"strict\",\r\n        \"_all\":{\r\n            \"enabled\":false\r\n        },\r\n        \"properties\":{\r\n            \"parent1\":{\r\n                \"type\":\"string\",\r\n                \"analyzer\":\"case_insensitive_analyzer\",\r\n                 \"fielddata\": \"true\"\r\n            },\r\n            \"parent2\":{\r\n                \"type\":\"string\",\r\n                \"analyzer\":\"case_insensitive_analyzer\",\r\n                 \"fielddata\": \"true\"\r\n            },\r\n            \"parent3\":{\r\n                \"type\":\"string\",\r\n                \"analyzer\":\"case_insensitive_analyzer\",\r\n                \"fielddata\": \"true\"\r\n            }\r\n        }\r\n    },\r\n    \"childtype\": {\r\n            \"dynamic\":\"strict\",\r\n            \"_all\":{\r\n                \"enabled\":false\r\n            },\r\n            \"_parent\":{\r\n                \"type\":\"parenttype\"\r\n            },\r\n            \"_routing\":{\"required\":true},\r\n            \"properties\":{\r\n                \"child1\":{\r\n                    \"type\":\"string\",\r\n                    \"analyzer\":\"case_insensitive_analyzer\",\r\n                    \"fielddata\": \"true\"\r\n                },\r\n                \"child2\":{\r\n                    \"type\":\"string\",\r\n                    \"analyzer\":\"case_insensitive_analyzer\",\r\n                    \"fielddata\": \"true\"\r\n                },\r\n                \"child3\":{\r\n                    \"type\":\"string\",\r\n                    \"analyzer\":\"case_insensitive_analyzer\",\r\n                    \"fielddata\": \"true\"\r\n                }\r\n            }\r\n        }\r\n    }\r\n}'`\r\n\r\nInsert data:\r\n`curl -k -XPOST 'https://localhost:9200/testindex/parenttype/1' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"parent1\" : \"MAC1\",\r\n  \"parent2\" : \"abc12\",\r\n  \"parent3\" : \"abc13\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/parenttype/2' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"parent1\" : \"MAC2\",\r\n  \"parent2\" : \"abc22\",\r\n  \"parent3\" : \"abc23\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/parenttype/3' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"parent1\" : \"MAC3\",\r\n  \"parent2\" : \"abc32\",\r\n  \"parent3\" : \"abc33\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c10?parent=1' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"chrome\",\r\n  \"child2\" : \"6\",\r\n  \"child3\" : \"browser\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c11?parent=1' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"ff\",\r\n  \"child2\" : \"15\",\r\n  \"child3\" : \"browser\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c12?parent=1' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"jabber\",\r\n  \"child2\" : \"5\",\r\n  \"child3\" : \"social\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c20?parent=2' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"chrome\",\r\n  \"child2\" : \"6\",\r\n  \"child3\" : \"browser\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c21?parent=2' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"safari\",\r\n  \"child2\" : \"7\",\r\n  \"child3\" : \"browser\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c22?parent=2' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"ff\",\r\n  \"child2\" : \"16\",\r\n  \"child3\" : \"browser\"\r\n}'\r\ncurl -k -XPOST 'https://localhost:9200/testindex/childtype/c30?parent=3' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"child1\" : \"chrome\",\r\n  \"child2\" : \"6\",\r\n  \"child3\" : \"browser\"\r\n}'`\r\n\r\nAggregation Query: \r\n`curl -k -XPOST 'https://localhost:9200/testindex/childtype,parenttype/_search?pretty' -H 'Content-Type: application/json' -d'\r\n{\r\n  \"from\" : 0,\r\n  \"size\" : 10,\r\n  \"query\" : { \r\n    \"has_child\" : {\r\n      \"query\" : {\r\n        \"match_all\" : {}\r\n      },\r\n      \"type\" : \"childtype\",\r\n      \"score_mode\" : \"avg\",\r\n      \"min_children\" : 0,\r\n      \"max_children\" : 2147483647,\r\n      \"ignore_unmapped\" : false,\r\n      \"boost\" : 1.0,\r\n      \"inner_hits\" : {\r\n        \"ignore_unmapped\" : false,\r\n        \"from\" : 0,\r\n        \"size\" : 0,\r\n        \"version\" : false,\r\n        \"explain\" : false,\r\n        \"track_scores\" : false\r\n      }\r\n    }\r\n  },\r\n  \"aggregations\" : {\r\n    \"Children \" : {\r\n      \"children\" : {\r\n        \"type\" : \"childtype\"\r\n      },\r\n      \"aggregations\" : {\r\n        \"Group By category child3\" : {\r\n          \"terms\" : {\r\n            \"field\" : \"child3\",\r\n            \"size\" : 10000,\r\n            \"min_doc_count\" : 1,\r\n            \"shard_min_doc_count\" : 0,\r\n            \"show_term_doc_count_error\" : false\r\n          },\r\n          \"aggregations\" : {\r\n            \"Group By version child2\" : {\r\n              \"terms\" : {\r\n                \"field\" : \"child2\",\r\n                \"size\" : 10000,\r\n                \"min_doc_count\" : 1,\r\n                \"shard_min_doc_count\" : 0,\r\n                \"show_term_doc_count_error\" : false\r\n              },\r\n              \"aggregations\" : {\r\n                \"Group By mac parent1\" : {\r\n                  \"cardinality\": {\r\n                    \"field\": \"_parent\"\r\n                  }\r\n                }\r\n              }\r\n            }\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}'`\r\n\r\nResult:\r\n`{\r\n  \"took\" : 26,\r\n  \"timed_out\" : false,\r\n  \"_shards\" : {\r\n    \"total\" : 3,\r\n    \"successful\" : 3,\r\n    \"failed\" : 0\r\n  },\r\n  \"hits\" : {\r\n    \"total\" : 3,\r\n    \"max_score\" : 1.0,\r\n    \"hits\" : [\r\n      {\r\n        \"_index\" : \"testindex\",\r\n        \"_type\" : \"parenttype\",\r\n        \"_id\" : \"2\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"parent1\" : \"MAC2\",\r\n          \"parent2\" : \"abc22\",\r\n          \"parent3\" : \"abc23\"\r\n        },\r\n        \"inner_hits\" : {\r\n          \"childtype\" : {\r\n            \"hits\" : {\r\n              \"total\" : 3,\r\n              \"max_score\" : 0.0,\r\n              \"hits\" : [ ]\r\n            }\r\n          }\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"testindex\",\r\n        \"_type\" : \"parenttype\",\r\n        \"_id\" : \"1\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"parent1\" : \"MAC1\",\r\n          \"parent2\" : \"abc12\",\r\n          \"parent3\" : \"abc13\"\r\n        },\r\n        \"inner_hits\" : {\r\n          \"childtype\" : {\r\n            \"hits\" : {\r\n              \"total\" : 3,\r\n              \"max_score\" : 0.0,\r\n              \"hits\" : [ ]\r\n            }\r\n          }\r\n        }\r\n      },\r\n      {\r\n        \"_index\" : \"testindex\",\r\n        \"_type\" : \"parenttype\",\r\n        \"_id\" : \"3\",\r\n        \"_score\" : 1.0,\r\n        \"_source\" : {\r\n          \"parent1\" : \"MAC3\",\r\n          \"parent2\" : \"abc32\",\r\n          \"parent3\" : \"abc33\"\r\n        },\r\n        \"inner_hits\" : {\r\n          \"childtype\" : {\r\n            \"hits\" : {\r\n              \"total\" : 1,\r\n              \"max_score\" : 0.0,\r\n              \"hits\" : [ ]\r\n            }\r\n          }\r\n        }\r\n      }\r\n    ]\r\n  },\r\n  \"aggregations\" : {\r\n    \"Children \" : {\r\n      \"doc_count\" : 7,\r\n      \"Group By category child3\" : {\r\n        \"doc_count_error_upper_bound\" : 0,\r\n        \"sum_other_doc_count\" : 0,\r\n        \"buckets\" : [\r\n          {\r\n            \"key\" : \"browser\",\r\n            \"doc_count\" : 6,\r\n            \"Group By version child2\" : {\r\n              \"doc_count_error_upper_bound\" : 0,\r\n              \"sum_other_doc_count\" : 0,\r\n              \"buckets\" : [\r\n                {\r\n                  \"key\" : \"6\",\r\n                  \"doc_count\" : 3,\r\n                  \"Group By mac parent1\" : {\r\n                    \"value\" : 0\r\n                  }\r\n                },\r\n                {\r\n                  \"key\" : \"15\",\r\n                  \"doc_count\" : 1,\r\n                  \"Group By mac parent1\" : {\r\n                    \"value\" : 0\r\n                  }\r\n                },\r\n                {\r\n                  \"key\" : \"16\",\r\n                  \"doc_count\" : 1,\r\n                  \"Group By mac parent1\" : {\r\n                    \"value\" : 0\r\n                  }\r\n                },\r\n                {\r\n                  \"key\" : \"7\",\r\n                  \"doc_count\" : 1,\r\n                  \"Group By mac parent1\" : {\r\n                    \"value\" : 0\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          },\r\n          {\r\n            \"key\" : \"social\",\r\n            \"doc_count\" : 1,\r\n            \"Group By version child2\" : {\r\n              \"doc_count_error_upper_bound\" : 0,\r\n              \"sum_other_doc_count\" : 0,\r\n              \"buckets\" : [\r\n                {\r\n                  \"key\" : \"5\",\r\n                  \"doc_count\" : 1,\r\n                  \"Group By mac parent1\" : {\r\n                    \"value\" : 0\r\n                  }\r\n                }\r\n              ]\r\n            }\r\n          }\r\n        ]\r\n      }\r\n    }\r\n  }\r\n}`\r\n","closed_by":{"login":"danielmitterdorfer","id":1699576,"node_id":"MDQ6VXNlcjE2OTk1NzY=","avatar_url":"https://avatars3.githubusercontent.com/u/1699576?v=4","gravatar_id":"","url":"https://api.github.com/users/danielmitterdorfer","html_url":"https://github.com/danielmitterdorfer","followers_url":"https://api.github.com/users/danielmitterdorfer/followers","following_url":"https://api.github.com/users/danielmitterdorfer/following{/other_user}","gists_url":"https://api.github.com/users/danielmitterdorfer/gists{/gist_id}","starred_url":"https://api.github.com/users/danielmitterdorfer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielmitterdorfer/subscriptions","organizations_url":"https://api.github.com/users/danielmitterdorfer/orgs","repos_url":"https://api.github.com/users/danielmitterdorfer/repos","events_url":"https://api.github.com/users/danielmitterdorfer/events{/privacy}","received_events_url":"https://api.github.com/users/danielmitterdorfer/received_events","type":"User","site_admin":false},"performed_via_github_app":null}