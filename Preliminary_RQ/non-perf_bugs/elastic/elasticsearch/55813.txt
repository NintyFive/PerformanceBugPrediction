{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/55813","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55813/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55813/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/55813/events","html_url":"https://github.com/elastic/elasticsearch/issues/55813","id":607651485,"node_id":"MDU6SXNzdWU2MDc2NTE0ODU=","number":55813,"title":"DST is not honored when searching by rounded dates on query_string","user":{"login":"adagios","id":51425,"node_id":"MDQ6VXNlcjUxNDI1","avatar_url":"https://avatars3.githubusercontent.com/u/51425?v=4","gravatar_id":"","url":"https://api.github.com/users/adagios","html_url":"https://github.com/adagios","followers_url":"https://api.github.com/users/adagios/followers","following_url":"https://api.github.com/users/adagios/following{/other_user}","gists_url":"https://api.github.com/users/adagios/gists{/gist_id}","starred_url":"https://api.github.com/users/adagios/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/adagios/subscriptions","organizations_url":"https://api.github.com/users/adagios/orgs","repos_url":"https://api.github.com/users/adagios/repos","events_url":"https://api.github.com/users/adagios/events{/privacy}","received_events_url":"https://api.github.com/users/adagios/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":4,"created_at":"2020-04-27T15:42:31Z","updated_at":"2020-05-13T08:11:41Z","closed_at":"2020-05-13T08:11:41Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nRunning on docker with `docker run -p 9200:9200 -p 9300:9300 -e \"discovery.type=single-node\" docker.elastic.co/elasticsearch/elasticsearch:7.6.2`\r\n\r\n```\r\n{\r\n\"type\": \"server\", \r\n\"timestamp\": \"2020-04-27T14:25:52,730Z\", \r\n\"level\": \"INFO\", \"component\": \"o.e.n.Node\", \"cluster.name\": \"docker-cluster\", \r\n\"node.name\": \"d34756e67976\", \r\n\"message\": \"version[7.6.2],\r\n pid[1],\r\n build[default/docker/ef48eb35cf30adf4db14086e8aabd07ef6fb113f/2020-03-26T06:34:37.794943Z], \r\nOS[Linux/4.19.76-linuxkit/amd64], \r\nJVM[AdoptOpenJDK/OpenJDK 64-Bit Server VM/13.0.2/13.0.2+8]\"\r\n}\r\n```\r\n**Plugins installed**: []\r\nnone\r\n\r\n**JVM version** (`java -version`):\r\nAdoptOpenJDK/OpenJDK 64-Bit Server VM/13.0.2/13.0.2+8\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\nLinux/4.19.76-linuxkit/amd64\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nWhen searching for a date with query_string with date rounding, DST is not taken into consideration. The query `some_date:2020-10-25||/d` does not match the indexed value of `2020-10-25T00:00:00+01:00` that is correct for Lisbon Portugal.\r\n\r\nIt works if searching for a date range (i.e. `some_date:[2020-10-25 TO 2020-10-25]`).\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\ncurl -XDELETE \"http://localhost:9200/testes-dst\"\r\ncurl -XPUT \"http://localhost:9200/testes-dst\"\r\n\r\n# create a mapping with a date\r\ncurl -XPUT \"http://localhost:9200/testes-dst/_mapping\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"properties\": {\r\n    \"data\":{\r\n      \"type\": \"date\"\r\n    },\r\n    \"quantidade\": {\r\n      \"type\": \"integer\"\r\n    }\r\n  }\r\n}'\r\n\r\n# index the day before: 2020-10-24 00:00:00 WET (+01:00)\r\ncurl -XPOST \"http://localhost:9200/testes-dst/_doc\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"data\": \"2020-10-24T00:00:00+01:00\",\r\n  \"quantidade\": 1\r\n}'\r\n# index DST change day: 2020-10-25 00:00:00 WET (+01:00)\r\ncurl -XPOST \"http://localhost:9200/testes-dst/_doc\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"data\": \"2020-10-25T00:00:00+01:00\",\r\n  \"quantidade\": 1\r\n}'\r\n# index the day after: 2020-10-24 00:00:00 WET (+00:00)\r\ncurl -XPOST \"http://localhost:9200/testes-dst/_doc\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"data\": \"2020-10-26T00:00:00+00:00\",\r\n  \"quantidade\": 1\r\n}'\r\n```\r\n\r\nThe following work as expected, returning the single hit:\r\n\r\n```\r\n# search for the day before (no problems)\r\ncurl -XGET \"http://localhost:9200/testes-dst/_search?q=data:2020-10-25||\\/d\"\r\n\r\n# search for the day after (no problems)\r\ncurl -XGET \"http://localhost:9200/testes-dst/_search?q=data:2020-10-26||\\/d\"\r\n\r\n{\"took\":3,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"skipped\":0,\"failed\":0},\"hits\":{\"total\":{\"value\":1,\"relation\":\"eq\"},\"max_score\":1.0,\"hits\":[{\"_index\":\"testes-dst\",\"_type\":\"_doc\",\"_id\":\"N88ivHEBo5SSWgbqZgTU\",\"_score\":1.0,\"_source\":\r\n{\r\n  \"data\": \"2020-10-26T00:00:00+00:00\",\r\n  \"quantidade\": 1\r\n}}]}}\r\n```\r\n\r\nBut the day of the change in DST doesn't, returning 0 hits:\r\n\r\n```\r\n# seach for the change day by date rounding\r\ncurl -XGET \"http://localhost:9200/testes-dst/_search?q=data:2020-10-25||\\/d\"\r\n\r\n# seach for the change day by date rounding with time_zone param\r\ncurl -XGET \"http://localhost:9200/testes-dst/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"query_string\": {\r\n      \"time_zone\": \"WET\",\r\n      \"query\": \"data:2020-10-25||\\\\/d\"\r\n    }\r\n  }\r\n}'\r\n\r\n{\"took\":3,\"timed_out\":false,\"_shards\":{\"total\":1,\"successful\":1,\"skipped\":0,\"failed\":0},\"hits\":{\"total\":{\"value\":0,\"relation\":\"eq\"},\"max_score\":null,\"hits\":[]}}\r\n```\r\n\r\nIt only works if using a date range:\r\n```\r\n# seach for the change day by date range with time_zone param\r\ncurl -XGET \"http://localhost:9200/testes-dst/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"query\": {\r\n    \"query_string\": {\r\n      \"time_zone\": \"WET\", \r\n      \"query\": \"data:[2020-10-25 TO 2020-10-25]\"\r\n    }\r\n  }\r\n}'\r\n```\r\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}