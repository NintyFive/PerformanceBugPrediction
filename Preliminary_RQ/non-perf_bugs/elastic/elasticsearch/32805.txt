{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32805","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32805/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32805/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32805/events","html_url":"https://github.com/elastic/elasticsearch/issues/32805","id":349957791,"node_id":"MDU6SXNzdWUzNDk5NTc3OTE=","number":32805,"title":"Non-noded intersection for geoshapes with positive-negative longitudes span","user":{"login":"antonymayi","id":6304370,"node_id":"MDQ6VXNlcjYzMDQzNzA=","avatar_url":"https://avatars0.githubusercontent.com/u/6304370?v=4","gravatar_id":"","url":"https://api.github.com/users/antonymayi","html_url":"https://github.com/antonymayi","followers_url":"https://api.github.com/users/antonymayi/followers","following_url":"https://api.github.com/users/antonymayi/following{/other_user}","gists_url":"https://api.github.com/users/antonymayi/gists{/gist_id}","starred_url":"https://api.github.com/users/antonymayi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/antonymayi/subscriptions","organizations_url":"https://api.github.com/users/antonymayi/orgs","repos_url":"https://api.github.com/users/antonymayi/repos","events_url":"https://api.github.com/users/antonymayi/events{/privacy}","received_events_url":"https://api.github.com/users/antonymayi/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2018-08-13T09:42:07Z","updated_at":"2018-08-13T10:41:45Z","closed_at":"2018-08-13T09:59:39Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.3.2\r\n**JVM version** (`java -version`): 1.8.0_171\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 16.04.5\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nIndexing geoshape with positive-negative longitudes span results in topology_exception (`found non-noded intersection`).\r\n\r\n**Steps to reproduce**:\r\n\r\n1. Create mapping:\r\n```\r\ncurl -X PUT \"localhost:9200/oceans\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 2,\r\n            \"number_of_replicas\" : 0\r\n        }\r\n    },\r\n    \"mappings\": {\r\n       \"polygon\": {\r\n           \"properties\": {\r\n               \"name\": { \"type\": \"keyword\" },\r\n               \"geometry\": { \"type\": \"geo_shape\" }\r\n           }\r\n       }\r\n    }\r\n}\r\n'\r\n```\r\n\r\n2. Index a geojson with positive-negative longitude span - here the Atlantic ocean with following visualtization of the actual points:\r\n![image](https://user-images.githubusercontent.com/6304370/44024187-e7ce49f8-9eec-11e8-99a0-6189572d021c.png)\r\n\r\n```\r\ncurl -X POST \"localhost:9200/oceans/polygon/4\" -H 'Content-Type: application/json' -d'\r\n{\"name\": \"Atlantic\", \"geometry\": {\"type\": \"Polygon\", \"coordinates\": [[[19.511197231661868, -39.47031010715461], [19.51171875, -76.31035754301745], [-23.37890625, -80.76061470752452], [-65.56640625, -84.10695292268964], [-94.72316693336734, -76.81771433666425], [-66.92680261673468, -75.49039450753801], [-66.3536052334693, -57.10692623078937], [-65.37831150793261, -55.214725604601036], [-68.78897829779179, -55.07517059271076], [-70.4808998540836, -52.49506961393108], [-70.38778880508676, -48.777113719621426], [-59.32608270736283, -15.366324431361265], [-70.83230069269295, -4.559689313729644], [-65.21775397451671, -0.876847745554054], [-50.94200887980013, 0.135127231661438], [-76.91791322154383, 7.796441951241861], [-76.91792791658833, 7.796428858600954], [-79.37602271110781, 9.394925186836758], [-81.76047487874185, 8.43979717011046], [-84.24511834421465, 10.35832224155311], [-85.48480564240484, 12.5871380191716], [-93.13145220971876, 16.81534686461491], [-96.96547124308924, 16.79436807972076], [-98.67919921875, 24.70691524106633], [-98.67854779151178, 24.71019202371468], [-98.0859375, 30.164126343161097], [-91.77978515625, 31.456782472114313], [-86.59423828125, 35.77325759103725], [-82.935791015625, 32.20350534542368], [-82.93560451384513, 32.208841231886574], [-78.662109375, 36.491973470593685], [-76.475830078125, 41.713930073371294], [-81.617431640625, 41.02135510866602], [-87.484130859375, 41.15384235711447], [-93.1640625, 46.619261036171515], [-90.52734374999999, 49.088257784724675], [-85.60546875, 49.43241258024849], [-77.6513671875, 44.5826428195842], [-77.6513671875, 44.58312107016949], [-74.718017578125, 47.96785877999251], [-68.323974609375, 50.28933925329178], [-64.456787109375, 50.812877010308966], [-60.10682961863857, 50.23817940658074], [-60.10620117187501, 50.23842221881728], [-92.7596645109115, 73.8466940910422], [-45.38352860179686, 73.88672728124854], [-45.3515625, 85.08136441846642], [104.58984375, 85.08136441846642], [103.18359375, 78.80197997387756], [103.88671875, 76.22690740640385], [93.33984375, 67.47492238478702], [90.3515625, 61.60639637138628], [81.03515625, 48.922499263758255], [62.2265625, 50.84757295365389], [52.55859375, 52.482780222078226], [37.08984375, 52.5897007687178], [35.463983978034065, 60.47831216682088], [23.37890625, 53.56641415275043], [11.68974616177156, 52.50956126468238], [11.689883579746366, 52.50945931288085], [11.766357421875, 48.122101028190805], [6.932373046875, 47.30903424774781], [0.60435278800226, 47.88702058242903], [0.791029537877729, 43.59642879875736], [0.790983576928416, 43.59639862527959], [0.791015625, 43.59630591596548], [9.49095272307949, 44.96630757267702], [9.4482421875, 44.99588261816546], [14.3701171875, 47.18971246448421], [19.2919921875, 43.83452678223682], [19.399214033366754, 43.803926747210355], [21.533203125, 45.98169518512228], [41.57222662048956, 49.610683752792404], [41.904555757584106, 44.149843230762855], [41.923828125, 41.409775832009565], [40.25390625, 39.436192999314095], [29.619140625, 38.89103282648846], [29.61067711737512, 38.89769462928316], [29.696044921875, 37.38761749978395], [37.320556640625, 37.483576550426996], [34.892578125, 31.297327991404266], [31.607666015624996, 29.954934549656144], [18.973388671874996, 29.439597566602902], [10.511718575192013, 32.7007239084551], [10.5029296875, 32.69486597787505], [8.3056640625, 35.06597313798418], [4.7900390625, 35.460669951495305], [-4.91679222758553, 34.525302214820385], [-4.909928108365797, 34.50198555141892], [-13.36760885999325, 21.95901786341347], [-10.837837289203115, 8.612753750748837], [-10.87538055442204, 8.581276238559253], [12.304740061404274, 7.667736629398771], [20.118145528512706, -28.46720859372586], [16.981161283552446, -29.13892821983417], [12.68543717360466, -29.264495673908943], [8.543648082987536, -29.372326973594273], [12.5244140625, -35.81781315869662], [19.511197231661868, -39.47031010715461]]]}}\r\n'\r\n```\r\n\r\n**Provide logs (if relevant)**:\r\n```\r\n{\r\n    \"error\": {\r\n        \"caused_by\": {\r\n            \"reason\": \"found non-noded intersection between LINESTRING ( -180.0 -78.56262183968872, -23.37890625 -80.76061470752452 ) and LINESTRING ( -65.56640625 -84.10695292268964, -94.72316693336734 -76.81771433666425 ) [ (-82.25677483863264, -79.93433306095552, NaN) ]\",\r\n            \"type\": \"topology_exception\"\r\n        },\r\n        \"reason\": \"failed to parse [geometry]\",\r\n        \"root_cause\": [\r\n            {\r\n                \"reason\": \"failed to parse [geometry]\",\r\n                \"type\": \"mapper_parsing_exception\"\r\n            }\r\n        ],\r\n        \"type\": \"mapper_parsing_exception\"\r\n    },\r\n    \"status\": 400\r\n}\r\n```\r\n\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}