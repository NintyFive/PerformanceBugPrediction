{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/5326","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5326/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5326/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/5326/events","html_url":"https://github.com/elastic/elasticsearch/issues/5326","id":28667746,"node_id":"MDU6SXNzdWUyODY2Nzc0Ng==","number":5326,"title":"NullPointerException in RamAccounntingTermsEnum","user":{"login":"justinuang","id":292519,"node_id":"MDQ6VXNlcjI5MjUxOQ==","avatar_url":"https://avatars3.githubusercontent.com/u/292519?v=4","gravatar_id":"","url":"https://api.github.com/users/justinuang","html_url":"https://github.com/justinuang","followers_url":"https://api.github.com/users/justinuang/followers","following_url":"https://api.github.com/users/justinuang/following{/other_user}","gists_url":"https://api.github.com/users/justinuang/gists{/gist_id}","starred_url":"https://api.github.com/users/justinuang/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/justinuang/subscriptions","organizations_url":"https://api.github.com/users/justinuang/orgs","repos_url":"https://api.github.com/users/justinuang/repos","events_url":"https://api.github.com/users/justinuang/events{/privacy}","received_events_url":"https://api.github.com/users/justinuang/received_events","type":"User","site_admin":false},"labels":[{"id":166507771,"node_id":"MDU6TGFiZWwxNjY1MDc3NzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Circuit%20Breakers","name":":Core/Infra/Circuit Breakers","color":"0e8a16","default":false,"description":"Track estimates of memory consumption to prevent overload"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":82340516,"node_id":"MDU6TGFiZWw4MjM0MDUxNg==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.0.2","name":"v1.0.2","color":"dddddd","default":false,"description":null},{"id":75962075,"node_id":"MDU6TGFiZWw3NTk2MjA3NQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.1.0","name":"v1.1.0","color":"DDDDDD","default":false,"description":null},{"id":76184120,"node_id":"MDU6TGFiZWw3NjE4NDEyMA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.0.0-beta1","name":"v2.0.0-beta1","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":8,"created_at":"2014-03-03T23:41:05Z","updated_at":"2015-06-07T22:47:25Z","closed_at":"2014-03-04T17:50:44Z","author_association":"NONE","active_lock_reason":null,"body":"In one of my custom scripts, I call:\n\n```\n(ScriptDocValues.Strings) doc().get(\"_uid\");\n```\n\nwhich then throws:\n\n```\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData$PagedBytesEstimator.bytesPerValue(PagedBytesIndexFieldData.java:147)\n    at org.elasticsearch.index.fielddata.RamAccountingTermsEnum.next(RamAccountingTermsEnum.java:84)\n    at org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData.loadDirect(PagedBytesIndexFieldData.java:99)\n    at org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData.loadDirect(PagedBytesIndexFieldData.java:41)\n    at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$1.call(IndicesFieldDataCache.java:139)\n    at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$1.call(IndicesFieldDataCache.java:135)\n    at org.elasticsearch.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4739)\n    at org.elasticsearch.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3524)\n    at org.elasticsearch.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2317)\n    at org.elasticsearch.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2280)\n    at org.elasticsearch.common.cache.LocalCache$Segment.get(LocalCache.java:2195)\n```\n\nIt looks like the offending code is in `org.elasticsearch.index.fielddata.RamAccountingTermsEnum`, which has logic like \n\n```\npublic BytesRef next() throws IOException {\n    BytesRef term = termsEnum.next();\n    if (term == null && this.flushBuffer != 0) {\n        // We have reached the end of the termsEnum, flush the buffer\n        flush();\n    } else {\n        this.flushBuffer += estimator.bytesPerValue(term);\n        if (this.flushBuffer >= FLUSH_BUFFER_SIZE) {\n            flush();\n        }\n    }\n    return term;\n}\n```\n\nWhat happens when `term == null` but `this.flushBuffer == 0`? Won't it throw an exception? Is there an invariant that I'm not aware of? Unfortunately, I can't find a way to repro this.\n\nI have attached the full stack trace below:\n\n```\n2014-03-01 11:31:28,820 +0000 ERROR [elasticsearch[Jacqueline Falsworth][search][T#17]] search.MyScript - Exception encountered while executing MyScript\norg.elasticsearch.ElasticsearchException: java.lang.NullPointerException\n    at org.elasticsearch.index.fielddata.AbstractIndexFieldData.load(AbstractIndexFieldData.java:75)\n    at org.elasticsearch.search.lookup.DocLookup.get(DocLookup.java:101)\n    at com.MyCompany.MyScript.getStringForField(MyScript.java:158) // hidden name\n    at com.MyCompany.MyScript.getIdentifierForDocument(MyScript.java:140)\n    at com.MyCompany.MyScript.run(MyScript.java:101)\n    at org.elasticsearch.index.query.ScriptFilterParser$ScriptFilter$ScriptDocSet.matchDoc(ScriptFilterParser.java:184)\n    at org.elasticsearch.common.lucene.docset.MatchDocIdSet.get(MatchDocIdSet.java:67)\n    at org.elasticsearch.common.lucene.docset.AndDocIdSet$AndBits.get(AndDocIdSet.java:106)\n    at org.elasticsearch.common.lucene.search.FilteredCollector.collect(FilteredCollector.java:60)\n    at org.apache.lucene.search.Scorer.score(Scorer.java:65)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n    at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:173)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:491)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:448)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:281)\n    at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:269)\n    at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:122)\n    at org.elasticsearch.search.SearchService.executeFetchPhase(SearchService.java:322)\n    at org.elasticsearch.search.action.SearchServiceTransportAction.sendExecuteFetch(SearchServiceTransportAction.java:304)\n    at org.elasticsearch.action.search.type.TransportSearchQueryAndFetchAction$AsyncAction.sendExecuteFirstPhase(TransportSearchQueryAndFetchAction.java:71)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:216)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction.performFirstPhase(TransportSearchTypeAction.java:203)\n    at org.elasticsearch.action.search.type.TransportSearchTypeAction$BaseAsyncAction$2.run(TransportSearchTypeAction.java:186)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n    at java.lang.Thread.run(Thread.java:722)\nCaused by: org.elasticsearch.common.util.concurrent.UncheckedExecutionException: java.lang.NullPointerException\n    at org.elasticsearch.common.cache.LocalCache$Segment.get(LocalCache.java:2201)\n    at org.elasticsearch.common.cache.LocalCache.get(LocalCache.java:3934)\n    at org.elasticsearch.common.cache.LocalCache$LocalManualCache.get(LocalCache.java:4736)\n    at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache.load(IndicesFieldDataCache.java:135)\n    at org.elasticsearch.index.fielddata.AbstractIndexFieldData.load(AbstractIndexFieldData.java:69)\n    ... 25 more\nCaused by: java.lang.NullPointerException\n    at org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData$PagedBytesEstimator.bytesPerValue(PagedBytesIndexFieldData.java:147)\n    at org.elasticsearch.index.fielddata.RamAccountingTermsEnum.next(RamAccountingTermsEnum.java:84)\n    at org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData.loadDirect(PagedBytesIndexFieldData.java:99)\n    at org.elasticsearch.index.fielddata.plain.PagedBytesIndexFieldData.loadDirect(PagedBytesIndexFieldData.java:41)\n    at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$1.call(IndicesFieldDataCache.java:139)\n    at org.elasticsearch.indices.fielddata.cache.IndicesFieldDataCache$IndexFieldCache$1.call(IndicesFieldDataCache.java:135)\n    at org.elasticsearch.common.cache.LocalCache$LocalManualCache$1.load(LocalCache.java:4739)\n    at org.elasticsearch.common.cache.LocalCache$LoadingValueReference.loadFuture(LocalCache.java:3524)\n    at org.elasticsearch.common.cache.LocalCache$Segment.loadSync(LocalCache.java:2317)\n    at org.elasticsearch.common.cache.LocalCache$Segment.lockedGetOrLoad(LocalCache.java:2280)\n    at org.elasticsearch.common.cache.LocalCache$Segment.get(LocalCache.java:2195)\n    ... 29 more\n```\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}