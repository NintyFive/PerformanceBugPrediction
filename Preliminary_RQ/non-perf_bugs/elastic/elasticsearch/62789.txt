{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/62789","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62789/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62789/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/62789/events","html_url":"https://github.com/elastic/elasticsearch/issues/62789","id":706659002,"node_id":"MDU6SXNzdWU3MDY2NTkwMDI=","number":62789,"title":"Simple query string with NEAR|PHRASE flags and nGrams","user":{"login":"alexlopespereira","id":6627726,"node_id":"MDQ6VXNlcjY2Mjc3MjY=","avatar_url":"https://avatars1.githubusercontent.com/u/6627726?v=4","gravatar_id":"","url":"https://api.github.com/users/alexlopespereira","html_url":"https://github.com/alexlopespereira","followers_url":"https://api.github.com/users/alexlopespereira/followers","following_url":"https://api.github.com/users/alexlopespereira/following{/other_user}","gists_url":"https://api.github.com/users/alexlopespereira/gists{/gist_id}","starred_url":"https://api.github.com/users/alexlopespereira/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/alexlopespereira/subscriptions","organizations_url":"https://api.github.com/users/alexlopespereira/orgs","repos_url":"https://api.github.com/users/alexlopespereira/repos","events_url":"https://api.github.com/users/alexlopespereira/events{/privacy}","received_events_url":"https://api.github.com/users/alexlopespereira/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null},{"id":1967498216,"node_id":"MDU6TGFiZWwxOTY3NDk4MjE2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Search","name":"Team:Search","color":"fef2c0","default":false,"description":"Meta label for search team"},{"id":2042400575,"node_id":"MDU6TGFiZWwyMDQyNDAwNTc1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/needs:triage","name":"needs:triage","color":"c5def5","default":false,"description":""}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2020-09-22T20:07:24Z","updated_at":"2020-09-29T14:28:11Z","closed_at":"2020-09-29T14:28:11Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 7.9\r\n\r\n**Description of the problem including expected versus actual behavior**: The NEAR flag does not work when the PHRASE flag is set.\r\n\r\n**Steps to reproduce**:\r\n\r\n 1.Create the index\r\n```\r\nPUT test/\r\n{\r\n    \"settings\": {\r\n        \"number_of_shards\": 1,\r\n        \"number_of_replicas\": 0,\r\n        \"max_ngram_diff\": \"50\",\r\n        \"analysis\": {\r\n            \"analyzer\": {\r\n                \"custom_ngram\": {\r\n                    \"type\": \"custom\",\r\n                    \"tokenizer\": \"ngram_tokenizer\"\r\n                }\r\n            },\r\n            \"tokenizer\": {\r\n                \"ngram_tokenizer\": {\r\n                    \"type\": \"ngram\",\r\n                    \"min_gram\": 2,\r\n                    \"max_gram\": 10,\r\n                    \"token_chars\": [\r\n                        \"letter\",\r\n                        \"digit\",\r\n                        \"punctuation\",\r\n                        \"symbol\"\r\n                    ]\r\n                }\r\n            }\r\n        }\r\n    },\r\n    \"mappings\": {\r\n        \"properties\": {\r\n            \"txtfield\": {\"type\": \"text\", \"analyzer\": \"custom_ngram\"}\r\n        }\r\n    }\r\n}\r\n```\r\n\r\n\r\n 2. Insert the document\r\n```\r\nPUT /test/_doc/1\r\n{\"txtfield\": \"this than those\"}\r\n```\r\n\r\n 3. The simple_query_string with the NEAR flag and without the PHRASE returns the record\r\n```\r\nGET test/_search\r\n{\r\n  \"query\": {\r\n    \"simple_query_string\": {\r\n      \"query\": \"\\\"this those\\\"~2\",\r\n      \"flags\": \"NEAR\",\r\n      \"fields\": [\r\n        \"txtfield\"\r\n      ]\r\n    }\r\n}}\r\n```\r\n\r\n 4. The simple_query_string with the NEAR flag and with the PHRASE does not return the record\r\n```\r\nGET test/_search\r\n{\r\n  \"query\": {\r\n    \"simple_query_string\": {\r\n      \"query\": \"\\\"this those\\\"~2\",\r\n      \"flags\": \"NEAR|PHRASE\",\r\n      \"fields\": [\r\n        \"txtfield\"\r\n      ]\r\n    }\r\n}}\r\n```\r\n\r\nIf this is a feature, the documentation should be updated. https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-simple-query-string-query.html\r\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}