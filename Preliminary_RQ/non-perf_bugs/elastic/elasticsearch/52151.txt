{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/52151","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52151/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52151/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/52151/events","html_url":"https://github.com/elastic/elasticsearch/issues/52151","id":562635326,"node_id":"MDU6SXNzdWU1NjI2MzUzMjY=","number":52151,"title":"[Transform] add support for filter aggregation","user":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"labels":[{"id":1272783040,"node_id":"MDU6TGFiZWwxMjcyNzgzMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml/Transform","name":":ml/Transform","color":"0e8a16","default":false,"description":"Transform"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-02-10T15:25:20Z","updated_at":"2020-02-21T12:06:19Z","closed_at":"2020-02-21T12:06:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"[Filter aggregation](https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-bucket-filter-aggregation.html#) cover some nice usecases.\r\n\r\nFor example to gather stats for response codes:\r\n```\r\n   \"aggregations\": {\r\n      \"404\": {\r\n        \"filter\": {\r\n          \"term\": {\r\n            \"response\": \"404\"\r\n          }\r\n        }\r\n      },\r\n      \"200\": {\r\n        \"filter\": {\r\n          \"term\": {\r\n            \"response\": \"200\"\r\n          }\r\n        }\r\n      },\r\n      \"503\": {\r\n        \"filter\": {\r\n          \"term\": {\r\n            \"response\": \"503\"\r\n          }\r\n        }\r\n      }\r\n```\r\n\r\nNote that `filter` supports sub aggregations which makes it hard to decide on the right structure in the transform destination index. For the simple example above the output structure could be:\r\n\r\n```\r\n   {\r\n      \"geo\" : {\r\n        \"src\" : \"CM\"\r\n      },\r\n      \"200\" : 41,\r\n      \"404\" : 2,\r\n      \"503\" : 0\r\n    },\r\n    {\r\n      \"geo\" : {\r\n        \"src\" : \"CN\"\r\n      },\r\n      \"200\" : 2415,\r\n      \"404\" : 138,\r\n      \"503\" : 89\r\n    },\r\n    {\r\n      \"geo\" : {\r\n        \"src\" : \"CO\"\r\n      },\r\n      \"200\" : 76,\r\n      \"404\" : 8,\r\n      \"503\" : 3\r\n    },\r\n```\r\n\r\nFor this the `doc_count` of the ouput is used as _flat_ result.\r\n\r\nIf you specify a sub-aggregation, we can not provide a flat result, because we need a nested object. For this case we could fallback to:\r\n\r\n```\r\n\"my_agg_field\": {\r\n    \"doc_count\": 42,\r\n    \"sub_agg_field\": {\r\n        # sub agg result  \r\n    }  \r\n}\r\n```\r\n\r\nIf a sub aggregation is used, the user probably does not care about the `doc_count` field, but we do not know. For getting rid of id, you can use a pipeline.\r\n\r\n## Discuss\r\n\r\n - Should we have flattened results if `filter` specifies no sub aggregation?\r\n - If a sub-agg is given, how should the result look like?","closed_by":{"login":"hendrikmuhs","id":7126422,"node_id":"MDQ6VXNlcjcxMjY0MjI=","avatar_url":"https://avatars3.githubusercontent.com/u/7126422?v=4","gravatar_id":"","url":"https://api.github.com/users/hendrikmuhs","html_url":"https://github.com/hendrikmuhs","followers_url":"https://api.github.com/users/hendrikmuhs/followers","following_url":"https://api.github.com/users/hendrikmuhs/following{/other_user}","gists_url":"https://api.github.com/users/hendrikmuhs/gists{/gist_id}","starred_url":"https://api.github.com/users/hendrikmuhs/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hendrikmuhs/subscriptions","organizations_url":"https://api.github.com/users/hendrikmuhs/orgs","repos_url":"https://api.github.com/users/hendrikmuhs/repos","events_url":"https://api.github.com/users/hendrikmuhs/events{/privacy}","received_events_url":"https://api.github.com/users/hendrikmuhs/received_events","type":"User","site_admin":false},"performed_via_github_app":null}