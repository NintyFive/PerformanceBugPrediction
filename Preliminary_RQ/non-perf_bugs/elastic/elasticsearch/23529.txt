{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/23529","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23529/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23529/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/23529/events","html_url":"https://github.com/elastic/elasticsearch/issues/23529","id":213225777,"node_id":"MDU6SXNzdWUyMTMyMjU3Nzc=","number":23529,"title":"Reading aggregation cache throw EOFException","user":{"login":"FrankXia","id":4430520,"node_id":"MDQ6VXNlcjQ0MzA1MjA=","avatar_url":"https://avatars2.githubusercontent.com/u/4430520?v=4","gravatar_id":"","url":"https://api.github.com/users/FrankXia","html_url":"https://github.com/FrankXia","followers_url":"https://api.github.com/users/FrankXia/followers","following_url":"https://api.github.com/users/FrankXia/following{/other_user}","gists_url":"https://api.github.com/users/FrankXia/gists{/gist_id}","starred_url":"https://api.github.com/users/FrankXia/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/FrankXia/subscriptions","organizations_url":"https://api.github.com/users/FrankXia/orgs","repos_url":"https://api.github.com/users/FrankXia/repos","events_url":"https://api.github.com/users/FrankXia/events{/privacy}","received_events_url":"https://api.github.com/users/FrankXia/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2017-03-10T02:32:08Z","updated_at":"2017-03-28T17:02:06Z","closed_at":"2017-03-28T17:02:06Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\nGitHub is reserved for bug reports and feature requests. The best place\r\nto ask a general question is at the Elastic Discourse forums at\r\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\r\na feature request, please include one and only one of the below blocks\r\nin your new issue. Note that whether you're filing a bug report or a\r\nfeature request, ensure that your submission is for an\r\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\r\nBug reports on an OS that we do not support or feature requests\r\nspecific to an OS that we do not support will be closed.\r\n-->\r\n\r\n<!--\r\nIf you are filing a bug report, please remove the below feature\r\nrequest block and provide responses for all of the below items.\r\n-->\r\n\r\n**Elasticsearch version**: \r\n5.1.2\r\n\r\n**Plugins installed**: [] \r\nCustom plugin for multi-buket aggregation\r\n\r\n**JVM version**:\r\n1.8.0_121\r\n\r\n**OS version**: \r\nMacOS 10.12.3\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen aggregation cache is turned on (\"size\":0), the intermediate multi-bucket aggregation results are written to cache via API call writeTo(StreamOutput out) but when the data was read back via Bucket(StreamInput in), the data didn't get read back correctly and the ES server throw an EOFException. \r\n\r\n    @Override\r\n    public void writeTo(StreamOutput out) throws IOException {\r\n      System.out.println();\r\n      System.out.println(\"out.squareCode =\" + squareCode);\r\n      System.out.println(\"out.docCount =\" + docCount);\r\n      System.out.println(\"out.precision =\" + precision);\r\n      out.writeVLong(squareCode);\r\n      out.writeVLong(docCount);\r\n      out.writeVInt(precision);\r\n      aggregations.writeTo(out);\r\n    }\r\n\r\n    /**\r\n     * Read from a stream.\r\n     */\r\n    private Bucket(StreamInput in) throws IOException {\r\n      System.out.println();\r\n      squareCode = in.readLong();\r\n      System.out.println(\"in.squareCode =\" + squareCode);\r\n      docCount = in.readVLong();\r\n      System.out.println(\"in.docCount =\" + docCount);\r\n      precision = in.readVInt();\r\n      System.out.println(\"in.precision =\" + precision);\r\n      aggregations = InternalAggregations.readAggregations(in);\r\n    }\r\n\r\nThese are sample output from above \"writeTo\" method, \r\nout.squareCode =61\r\nout.docCount =16\r\nout.precision =2\r\n\r\nout.squareCode =45\r\nout.docCount =11\r\nout.precision =2\r\n\r\nout.squareCode =61\r\nout.docCount =19\r\nout.precision =2\r\n\r\nThe following are the reading back data via Bucket(StreamInput in) before thrown EOFException, \r\nin.squareCode =4400863460650320384\r\nin.docCount =40\r\nin.precision =1\r\n\r\nin.squareCode =4400019035719926272\r\nin.docCount =0\r\nin.precision =0\r\n\r\nin.squareCode =3248223431288750592\r\nin.docCount =0\r\nin.precision =0\r\n\r\nWe expect to receive the same data that were written to the cache. \r\n\r\n**Steps to reproduce**:\r\n 1.\r\n 2.\r\n 3.\r\n\r\n**Provide logs (if relevant)**:\r\norg.elasticsearch.transport.RemoteTransportException: [lBmUdf8][127.0.0.1:9300][indices:data/read/search[phase/query]]\r\nCaused by: org.elasticsearch.ElasticsearchException: java.io.EOFException\r\n\tat org.elasticsearch.ExceptionsHelper.convertToRuntime(ExceptionsHelper.java:48) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:292) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:300) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:297) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:577) [elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:527) [elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-5.1.2.jar:5.1.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) [?:1.8.0_121]\r\nCaused by: java.io.EOFException\r\n\tat org.elasticsearch.common.bytes.BytesReferenceStreamInput.readByte(BytesReferenceStreamInput.java:51) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.bytes.BytesReference$MarkSupportingStreamInputWrapper.readByte(BytesReference.java:231) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.io.stream.FilterStreamInput.readByte(FilterStreamInput.java:40) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.io.stream.StreamInput.readInt(StreamInput.java:173) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.io.stream.StreamInput.readLong(StreamInput.java:212) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat com.esri.arcgis.bds.aggregation.bucket.squaregrid.LongInternalSquareGrid$Bucket.<init>(LongInternalSquareGrid.java:36) ~[?:?]\r\n\tat com.esri.arcgis.bds.aggregation.bucket.squaregrid.LongInternalSquareGrid$Bucket.<init>(LongInternalSquareGrid.java:17) ~[?:?]\r\n\tat com.esri.arcgis.bds.aggregation.bucket.squaregrid.LongInternalSquareGrid.lambda$new$4(LongInternalSquareGrid.java:113) ~[?:?]\r\n\tat org.elasticsearch.common.io.stream.StreamInput.readList(StreamInput.java:859) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat com.esri.arcgis.bds.aggregation.bucket.squaregrid.LongInternalSquareGrid.<init>(LongInternalSquareGrid.java:113) ~[?:?]\r\n\tat org.elasticsearch.common.io.stream.NamedWriteableAwareStreamInput.readNamedWriteable(NamedWriteableAwareStreamInput.java:40) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.lambda$readFrom$2(InternalAggregations.java:200) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.io.stream.StreamInput.readList(StreamInput.java:859) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.readFrom(InternalAggregations.java:200) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.readAggregations(InternalAggregations.java:190) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.bucket.InternalSingleBucketAggregation.<init>(InternalSingleBucketAggregation.java:61) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.bucket.filter.InternalFilter.<init>(InternalFilter.java:39) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.io.stream.NamedWriteableAwareStreamInput.readNamedWriteable(NamedWriteableAwareStreamInput.java:40) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.lambda$readFrom$2(InternalAggregations.java:200) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.io.stream.StreamInput.readList(StreamInput.java:859) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.readFrom(InternalAggregations.java:200) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.aggregations.InternalAggregations.readAggregations(InternalAggregations.java:190) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.query.QuerySearchResult.readFromWithId(QuerySearchResult.java:221) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.indices.IndicesService.loadIntoContext(IndicesService.java:1171) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:257) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:273) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:300) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.action.search.SearchTransportService$6.messageReceived(SearchTransportService.java:297) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:69) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.transport.TransportService$6.doRun(TransportService.java:577) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:527) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) ~[elasticsearch-5.1.2.jar:5.1.2]\r\n\tat java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) ~[?:1.8.0_121]\r\n\tat java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) ~[?:1.8.0_121]\r\n\tat java.lang.Thread.run(Thread.java:745) ~[?:1.8.0_121]\r\n<!--\r\nIf you are filing a feature request, please remove the above bug\r\nreport block and provide responses for all of the below items.\r\n-->\r\n","closed_by":{"login":"sherry-ger","id":11432120,"node_id":"MDQ6VXNlcjExNDMyMTIw","avatar_url":"https://avatars2.githubusercontent.com/u/11432120?v=4","gravatar_id":"","url":"https://api.github.com/users/sherry-ger","html_url":"https://github.com/sherry-ger","followers_url":"https://api.github.com/users/sherry-ger/followers","following_url":"https://api.github.com/users/sherry-ger/following{/other_user}","gists_url":"https://api.github.com/users/sherry-ger/gists{/gist_id}","starred_url":"https://api.github.com/users/sherry-ger/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sherry-ger/subscriptions","organizations_url":"https://api.github.com/users/sherry-ger/orgs","repos_url":"https://api.github.com/users/sherry-ger/repos","events_url":"https://api.github.com/users/sherry-ger/events{/privacy}","received_events_url":"https://api.github.com/users/sherry-ger/received_events","type":"User","site_admin":false},"performed_via_github_app":null}