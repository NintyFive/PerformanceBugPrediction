{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20401","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20401/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20401/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20401/events","html_url":"https://github.com/elastic/elasticsearch/issues/20401","id":176017410,"node_id":"MDU6SXNzdWUxNzYwMTc0MTA=","number":20401,"title":"CardinalityAggregation with _parent field and nested childs","user":{"login":"tchiotludo","id":2064609,"node_id":"MDQ6VXNlcjIwNjQ2MDk=","avatar_url":"https://avatars1.githubusercontent.com/u/2064609?v=4","gravatar_id":"","url":"https://api.github.com/users/tchiotludo","html_url":"https://github.com/tchiotludo","followers_url":"https://api.github.com/users/tchiotludo/followers","following_url":"https://api.github.com/users/tchiotludo/following{/other_user}","gists_url":"https://api.github.com/users/tchiotludo/gists{/gist_id}","starred_url":"https://api.github.com/users/tchiotludo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tchiotludo/subscriptions","organizations_url":"https://api.github.com/users/tchiotludo/orgs","repos_url":"https://api.github.com/users/tchiotludo/repos","events_url":"https://api.github.com/users/tchiotludo/events{/privacy}","received_events_url":"https://api.github.com/users/tchiotludo/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-09-09T14:02:41Z","updated_at":"2016-09-13T11:23:44Z","closed_at":"2016-09-13T11:23:44Z","author_association":"NONE","active_lock_reason":null,"body":"CardinalityAggregation with count on _parent field failed in this kind of case : \n- When you have : User is parent for Address : CardinalityAggregation for _parent fields works well and return count of parent \n- When you have : User is parent for Address that is also parent for address_child : CardinalityAggregation for _parent fields return the count of children, not the parent one.\n\nTested on ES 2.4 & 5.0.alpha5, same behavior.\n\nThis behavior doesn't need to have a document on address_child created, just declaring the mapping and result change.\n\nHere is the the reproduction scenario : \n\n```\nDELETE /my_test\n\nPUT /my_test\n\n# Just don't declare the child and result is fine\nPUT /my_test/address_child/_mapping\n{\n  \"address_child\": {\n    \"_parent\": {\n      \"type\": \"address\"\n    }\n  }\n}\n\n\nPUT /my_test/address/_mapping\n{\n   \"_parent\": {\n      \"type\": \"user\"\n   },\n   \"properties\": {\n      \"country\": {\n         \"type\": \"text\",\n         \"fielddata\": true\n      },\n      \"city\": {\n         \"type\": \"text\",\n         \"fielddata\": true\n      }\n   }\n}\n\nPUT /my_test/user/1\n{\n  \"user_id\": \"1\",\n  \"user_name\": \"John Smith\"\n}\n\n\nPUT /my_test/address/2?parent=1\n{\n  \"country\": \"france\",\n  \"city\": \"Lille\"\n}\n\nPUT /my_test/address/3?parent=1\n{\n  \"country\": \"france\",\n  \"city\": \"Paris\"\n}\n\nPUT /my_test/user/4\n{\n  \"user_id\": \"1\",\n  \"user_name\": \"Jane Smith\"\n}\n\nPUT /my_test/address/5?parent=4\n{\n  \"country\": \"belgium\",\n  \"city\": \"Bruxel\"\n}\n\nPUT /my_test/address/6?parent=4\n{\n  \"country\": \"belgium\",\n  \"city\": \"Mons\"\n}\n\nPOST /my_test/user/_search\n{\n   \"size\": 0,\n   \"aggregations\": {\n      \"parent_agg\": {\n         \"children\": {\n            \"type\": \"address\"\n         },\n         \"aggregations\": {\n            \"country\": {\n               \"terms\": {\n                  \"field\": \"country\"\n               },\n               \"aggregations\": {\n                  \"city\": {\n                     \"terms\": {\n                        \"field\": \"city\"\n                     },\n                     \"aggs\": {\n                        \"parents\": {\n                           \"cardinality\": {\n                              \"field\": \"_parent\"\n                           }\n                        }\n                     }\n                  }\n               }\n            }\n         }\n      }\n   }\n}\n```\n\nResult without declaring the address_child mapping : \n\n``` json\n{\n  \"key\": \"france\",\n  \"doc_count\": 2,\n  \"city\": {\n     \"doc_count_error_upper_bound\": 0,\n     \"sum_other_doc_count\": 0,\n     \"buckets\": [\n        {\n           \"key\": \"lille\",\n           \"doc_count\": 1,\n           \"parents\": {\n              \"value\": 1\n           }\n        },\n        {\n           \"key\": \"paris\",\n           \"doc_count\": 1,\n           \"parents\": {\n              \"value\": 1\n           }\n        }\n     ]\n  }\n}\n```\n\nAnd declaring the child : \n\n``` json\n{\n  \"key\": \"france\",\n  \"doc_count\": 2,\n  \"city\": {\n     \"doc_count_error_upper_bound\": 0,\n     \"sum_other_doc_count\": 0,\n     \"buckets\": [\n        {\n           \"key\": \"lille\",\n           \"doc_count\": 1,\n           \"parents\": {\n              \"value\": 2\n           }\n        },\n        {\n           \"key\": \"paris\",\n           \"doc_count\": 1,\n           \"parents\": {\n              \"value\": 2\n           }\n        }\n     ]\n  }\n}\n```\n\nNote the\"value\": 1  that change to \"value\": 2\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}