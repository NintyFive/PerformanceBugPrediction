{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/9491","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9491/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9491/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/9491/events","html_url":"https://github.com/elastic/elasticsearch/issues/9491","id":55969906,"node_id":"MDU6SXNzdWU1NTk2OTkwNg==","number":9491,"title":"date_histogram issue when using \"pre_zone_adjust_large_interval\" and a timezone with DST","user":{"login":"orenash","id":10764324,"node_id":"MDQ6VXNlcjEwNzY0MzI0","avatar_url":"https://avatars0.githubusercontent.com/u/10764324?v=4","gravatar_id":"","url":"https://api.github.com/users/orenash","html_url":"https://github.com/orenash","followers_url":"https://api.github.com/users/orenash/followers","following_url":"https://api.github.com/users/orenash/following{/other_user}","gists_url":"https://api.github.com/users/orenash/gists{/gist_id}","starred_url":"https://api.github.com/users/orenash/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/orenash/subscriptions","organizations_url":"https://api.github.com/users/orenash/orgs","repos_url":"https://api.github.com/users/orenash/repos","events_url":"https://api.github.com/users/orenash/events{/privacy}","received_events_url":"https://api.github.com/users/orenash/received_events","type":"User","site_admin":false},"labels":[{"id":141141324,"node_id":"MDU6TGFiZWwxNDExNDEzMjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Aggregations","name":":Analytics/Aggregations","color":"0e8a16","default":false,"description":"Aggregations"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":178610174,"node_id":"MDU6TGFiZWwxNzg2MTAxNzQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.4.5","name":"v1.4.5","color":"dddddd","default":false,"description":null},{"id":127700367,"node_id":"MDU6TGFiZWwxMjc3MDAzNjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v1.5.0","name":"v1.5.0","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"assignees":[{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2015-01-29T22:54:13Z","updated_at":"2015-03-18T22:38:15Z","closed_at":"2015-02-23T11:10:19Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hey there.\n\nSince we upgraded to version 1.3.7, we noticed that we sometimes get weird double buckets when running our date_histogram aggregations.\n\nAfter trying some things we figured out it only happens when we set `pre_zone_adjust_large_interval` to true, `pre_zone` to our local time zone (which uses DST), and `interval` is 'day' or bigger.\n\nIn the aggregration's result we see that we get two buckets corresponding to the same interval, but with an hour difference between their keys.\n\nHere is a simple example that should reproduce this issue:\n\n``` javascript\nPOST /test/t\n{\n    \"d\": \"2014-10-08T13:00:00Z\"\n}\n\nPOST /test/t\n{\n    \"d\": \"2014-11-08T13:00:00Z\"\n}\n\nGET /test/_search?size=0\n{\n   \"aggs\": {\n      \"test\": {\n         \"date_histogram\": {\n            \"field\": \"d\",\n            \"interval\": \"year\",\n            \"pre_zone\": \"Asia/Jerusalem\",\n            \"pre_zone_adjust_large_interval\": true\n         }\n      }\n   }\n}\n```\n\nAnd the result:\n\n``` javascript\n\"aggregations\": {\n      \"test\": {\n         \"buckets\": [\n            {\n               \"key_as_string\": \"2013-12-31T21:00:00.000Z\",\n               \"key\": 1388523600000,\n               \"doc_count\": 1\n            },\n            {\n               \"key_as_string\": \"2013-12-31T22:00:00.000Z\",\n               \"key\": 1388527200000,\n               \"doc_count\": 1\n            }\n         ]\n      }\n   }\n```\n\nAs you can see, although the two timestamps unarguably belong to the same year, they're put into different buckets. As we figured out, it happens because the timezone offset is different for the two timestamps as one of them occurs when DST is on and the other is not.\n\nWe use `Asia/Jerusalem` timezone but the same problem happens in every timezone with DST (eg CET), as long as `pre_zone_adjust_large_interval` is used (When it's not used both documents will go to the same bucket `\"2014-01-01T00:00:00.000Z\"`).\n\nThis problem never happened before we upgraded to 1.3.7. Moreover, while digging into the code we figured out that this bug is a direct result of the proposed fix for issue #8339. While that fix indeed solved the timezone problem in 'hour' intervals around DST switch, it caused the new problem with bigger intervals.\n\nThe problem is also in version 1.4.2.\n","closed_by":{"login":"cbuescher","id":10398885,"node_id":"MDQ6VXNlcjEwMzk4ODg1","avatar_url":"https://avatars0.githubusercontent.com/u/10398885?v=4","gravatar_id":"","url":"https://api.github.com/users/cbuescher","html_url":"https://github.com/cbuescher","followers_url":"https://api.github.com/users/cbuescher/followers","following_url":"https://api.github.com/users/cbuescher/following{/other_user}","gists_url":"https://api.github.com/users/cbuescher/gists{/gist_id}","starred_url":"https://api.github.com/users/cbuescher/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/cbuescher/subscriptions","organizations_url":"https://api.github.com/users/cbuescher/orgs","repos_url":"https://api.github.com/users/cbuescher/repos","events_url":"https://api.github.com/users/cbuescher/events{/privacy}","received_events_url":"https://api.github.com/users/cbuescher/received_events","type":"User","site_admin":false},"performed_via_github_app":null}