[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/89813161","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-89813161","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":89813161,"node_id":"MDEyOklzc3VlQ29tbWVudDg5ODEzMTYx","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2015-04-05T17:07:53Z","updated_at":"2015-04-05T17:07:53Z","author_association":"CONTRIBUTOR","body":"Hi @ianribas \n\nThanks for writing this up.  @mikemccand is there any way we could improve multi-word synonym queries with the TermAutomatonQuery? \n\nhttp://blog.mikemccandless.com/2014/08/a-new-proximity-query-for-lucene-using.html\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90055724","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90055724","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90055724,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMDU1NzI0","user":{"login":"ianribas","id":1250546,"node_id":"MDQ6VXNlcjEyNTA1NDY=","avatar_url":"https://avatars0.githubusercontent.com/u/1250546?v=4","gravatar_id":"","url":"https://api.github.com/users/ianribas","html_url":"https://github.com/ianribas","followers_url":"https://api.github.com/users/ianribas/followers","following_url":"https://api.github.com/users/ianribas/following{/other_user}","gists_url":"https://api.github.com/users/ianribas/gists{/gist_id}","starred_url":"https://api.github.com/users/ianribas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ianribas/subscriptions","organizations_url":"https://api.github.com/users/ianribas/orgs","repos_url":"https://api.github.com/users/ianribas/repos","events_url":"https://api.github.com/users/ianribas/events{/privacy}","received_events_url":"https://api.github.com/users/ianribas/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T13:08:14Z","updated_at":"2015-04-06T13:08:14Z","author_association":"NONE","body":"It seems the problem is the same stated on the \"Limitations\" sections of http://blog.mikemccandless.com/2012/04/lucenes-tokenstreams-are-actually.html (linked on the post referenced above): both the SynonymFilter and the QueryBuilder are not able to correctly handle the situation where the synonym and the original term have different lengths on \"AND\" queries.\n\nI think this issue in Lucene relates to this problem: [LUCENE-3843](https://issues.apache.org/jira/browse/LUCENE-3843).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90064567","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90064567","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90064567,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMDY0NTY3","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T13:28:06Z","updated_at":"2015-04-06T13:28:06Z","author_association":"CONTRIBUTOR","body":"Thanks for the reminder @ianribas , I had completely forgotten about this issue! As a start maybe we can fix QueryBuilder to make use of positionLength where available and formulate the queries better. The logic in that thing is kind of scary and hairy, but I will take a look.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90066940","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90066940","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90066940,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMDY2OTQw","user":{"login":"ianribas","id":1250546,"node_id":"MDQ6VXNlcjEyNTA1NDY=","avatar_url":"https://avatars0.githubusercontent.com/u/1250546?v=4","gravatar_id":"","url":"https://api.github.com/users/ianribas","html_url":"https://github.com/ianribas","followers_url":"https://api.github.com/users/ianribas/followers","following_url":"https://api.github.com/users/ianribas/following{/other_user}","gists_url":"https://api.github.com/users/ianribas/gists{/gist_id}","starred_url":"https://api.github.com/users/ianribas/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ianribas/subscriptions","organizations_url":"https://api.github.com/users/ianribas/orgs","repos_url":"https://api.github.com/users/ianribas/repos","events_url":"https://api.github.com/users/ianribas/events{/privacy}","received_events_url":"https://api.github.com/users/ianribas/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T13:34:33Z","updated_at":"2015-04-06T13:34:33Z","author_association":"NONE","body":"You're welcome, @rmuir. I looked around QueryBuilder a bit and the logic is really complex already. And I fear this situation will only add more special cases. Please let me know if I can be of any assistance. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90069809","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90069809","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90069809,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMDY5ODA5","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T13:42:13Z","updated_at":"2015-04-06T13:42:13Z","author_association":"CONTRIBUTOR","body":"You are correct @ianribas that the code is unapproachable. But we can't give up on it and just let it stagnate. \n\nA lot of the complexity is because the tokenstream api (used to consume the analysis chain) is awkward to use here (additional state must be kept because it can only be consumed \"forward-only'). \n\nWe could consider another approach, such as converting the tokenstream to an automaton (we have a TokenstreamToAutomaton somewhere), and then consuming that. Maybe it would simplify all the code around this thing.\n\nI just want to think about all cases involved first: its not just AND/OR but also impacts the phrase operator. If you have this same situation in quotes, I think we should be using something like @mikemccand 's TermAutomatonQuery. I am not sure what state its in, mike put it in the sandbox i am sure for good reasons, and i'm not sure it supports slop yet.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90101235","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90101235","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90101235,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMTAxMjM1","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T15:20:01Z","updated_at":"2015-04-06T15:20:01Z","author_association":"CONTRIBUTOR","body":"TermAutomatonQuery is in sandbox just because it's so new and likely quite slow (missing optos like https://issues.apache.org/jira/browse/LUCENE-6396 that @rmuir just opened), but it can run arbitrary token-level automata (each transition is a token), including ones with cycles I think (which our token streams cannot produce).\n\nBut I think the original issue here is not about positional querying but rather about consume the multiple tokens (\"spider\" and \"man\") created by the synonym filter yet not doing the right thing when the operator is \"and\", i.e. the query should effectively rewrite to +spider +man (except the impl in QueryBuilder.createFieldQuery seems to mix these cases)...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90103917","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90103917","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90103917,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMTAzOTE3","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-04-06T15:26:04Z","updated_at":"2015-04-06T15:26:04Z","author_association":"CONTRIBUTOR","body":"> except the impl in QueryBuilder.createFieldQuery seems to mix these cases\n\nThat is exactly what it makes it difficult, to fix the non-positional case (AND/OR) and still defer the proximity case until we have better solutions. I think its still possible, but not without adding another specialized case there (e.g. \"multiple positions and lengths\"). I will investigate this as an intermediate solution, maybe its not so bad.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/90320026","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-90320026","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":90320026,"node_id":"MDEyOklzc3VlQ29tbWVudDkwMzIwMDI2","user":{"login":"rmuir","id":504194,"node_id":"MDQ6VXNlcjUwNDE5NA==","avatar_url":"https://avatars1.githubusercontent.com/u/504194?v=4","gravatar_id":"","url":"https://api.github.com/users/rmuir","html_url":"https://github.com/rmuir","followers_url":"https://api.github.com/users/rmuir/followers","following_url":"https://api.github.com/users/rmuir/following{/other_user}","gists_url":"https://api.github.com/users/rmuir/gists{/gist_id}","starred_url":"https://api.github.com/users/rmuir/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rmuir/subscriptions","organizations_url":"https://api.github.com/users/rmuir/orgs","repos_url":"https://api.github.com/users/rmuir/repos","events_url":"https://api.github.com/users/rmuir/events{/privacy}","received_events_url":"https://api.github.com/users/rmuir/received_events","type":"User","site_admin":false},"created_at":"2015-04-07T02:24:17Z","updated_at":"2015-04-07T02:24:17Z","author_association":"CONTRIBUTOR","body":"Here is some progress:\n- https://issues.apache.org/jira/browse/LUCENE-6400 SolrSynonymParser (its the syntax used here by ES) doesn't really construct the map correctly. positionsLengths are really not even available today in your situation due to this.  \n- https://issues.apache.org/jira/browse/LUCENE-6401 Refactor the big method :)\n\nEven after these, there is more work for synonyms before it can do the right thing in all circumstances. And the position case needs some work on something like TermAutomatonQuery before things in double-quotes will work correctly.\n\nBefore changing the logic in QueryBuilder, we need to also consider CJK/shingle/n-grams/commongrams/kuromoji that are setting positionLength and make sure everything makes sense too.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/193145894","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-193145894","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":193145894,"node_id":"MDEyOklzc3VlQ29tbWVudDE5MzE0NTg5NA==","user":{"login":"atuljangra","id":1225250,"node_id":"MDQ6VXNlcjEyMjUyNTA=","avatar_url":"https://avatars2.githubusercontent.com/u/1225250?v=4","gravatar_id":"","url":"https://api.github.com/users/atuljangra","html_url":"https://github.com/atuljangra","followers_url":"https://api.github.com/users/atuljangra/followers","following_url":"https://api.github.com/users/atuljangra/following{/other_user}","gists_url":"https://api.github.com/users/atuljangra/gists{/gist_id}","starred_url":"https://api.github.com/users/atuljangra/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/atuljangra/subscriptions","organizations_url":"https://api.github.com/users/atuljangra/orgs","repos_url":"https://api.github.com/users/atuljangra/repos","events_url":"https://api.github.com/users/atuljangra/events{/privacy}","received_events_url":"https://api.github.com/users/atuljangra/received_events","type":"User","site_admin":false},"created_at":"2016-03-07T08:02:23Z","updated_at":"2016-03-07T08:02:23Z","author_association":"NONE","body":"Any update on this?\nI was using Solr 4.7.2, upgraded to 5.5.0. Faced the problem of having multiword synonyms and operators(AND OR etc). See http://stackoverflow.com/questions/35823263/complex-queries-using-multiword-synonyms-in-solr-lucene\n\nI thought I should move to ES because this is where the party is going on. But I'm not sure that multiword synonyms and operators would work well here too after seeing this bug.\nCan someone update me on this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/297360484","html_url":"https://github.com/elastic/elasticsearch/issues/10394#issuecomment-297360484","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10394","id":297360484,"node_id":"MDEyOklzc3VlQ29tbWVudDI5NzM2MDQ4NA==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2017-04-26T11:07:58Z","updated_at":"2017-04-26T11:07:58Z","author_association":"CONTRIBUTOR","body":"This now works correctly, if you switch from using the `synonym` token filter to the `synonym_graph` token filter (as a `search_analyzer` - to use `synonym_graph` as an index-time `analyzer`, you also need to add the [`flatten_graph` token filter](https://www.elastic.co/guide/en/elasticsearch/reference/5.3/analysis-flatten-graph-tokenfilter.html)\r\n\r\n```\r\n# delete old index if exists\r\nDELETE /multiwordsyns?pretty\r\n\r\n# create index with synonym analyzer and mapping\r\nPUT /multiwordsyns?pretty\r\n{\r\n  \"settings\": {\r\n    \"number_of_replicas\": 0,\r\n    \"number_of_shards\": 1,\r\n    \"index\": {\r\n      \"analysis\": {\r\n        \"analyzer\": {\r\n          \"index_time\": {\r\n            \"tokenizer\": \"standard\",\r\n            \"filter\": [\r\n              \"standard\",\r\n              \"lowercase\"\r\n            ]\r\n          },\r\n          \"synonym\": {\r\n            \"tokenizer\": \"standard\",\r\n            \"filter\": [\r\n              \"standard\",\r\n              \"lowercase\",\r\n              \"stop\",\r\n              \"synonym\"\r\n            ]\r\n          }\r\n        },\r\n        \"filter\": {\r\n          \"synonym\": {\r\n            \"type\": \"synonym_graph\",\r\n            \"synonyms\": [\r\n              \"spider man, spiderman\"\r\n            ]\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"mappings\": {\r\n    \"test\": {\r\n      \"properties\": {\r\n        \"text\": {\r\n          \"type\": \"text\",\r\n          \"analyzer\": \"index_time\",\r\n          \"search_analyzer\": \"synonym\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n# index the test documents\r\nPUT /multiwordsyns/test/1?pretty\r\n{\"text\": \"the adventures of spiderman\"}\r\n\r\nPUT /multiwordsyns/test/2?pretty\r\n{\"text\": \"what hath man wrought?\"}\r\n\r\nPUT /multiwordsyns/test/3?pretty\r\n{\"text\": \"that spider is the size of a man\"}\r\n\r\nPUT /multiwordsyns/test/4?pretty&refresh=true\r\n{\"text\": \"spiders eat insects\"}\r\n\r\n# Works - finds #1 & #3\r\nPOST /multiwordsyns/test/_search?pretty\r\n{\"query\": {\"match\": {\"text\": {\"query\": \"spiderman\", \"operator\": \"and\"}}}}\r\n\r\n# Works - finds #1 & #3\r\nPOST /multiwordsyns/test/_search?pretty\r\n{\"query\": {\"match\": {\"text\": {\"query\": \"spider man\", \"operator\": \"and\"}}}}\r\n```","performed_via_github_app":null}]