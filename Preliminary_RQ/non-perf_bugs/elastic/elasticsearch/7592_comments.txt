[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54471841","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54471841","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54471841,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NDcxODQx","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-04T13:06:55Z","updated_at":"2014-09-04T13:06:55Z","author_association":"NONE","body":"the other explaination would be a very important use of this structure (and no dead lock)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54720256","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54720256","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54720256,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzIwMjU2","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-09-06T16:50:11Z","updated_at":"2014-09-06T16:50:11Z","author_association":"CONTRIBUTOR","body":"@mikemccand what do you make of this one?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54720339","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54720339","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54720339,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzIwMzM5","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-09-06T16:52:28Z","updated_at":"2014-09-06T16:52:28Z","author_association":"CONTRIBUTOR","body":"@kamaradclimber are you using async indexing?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54742003","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54742003","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54742003,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQyMDAz","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T09:34:51Z","updated_at":"2014-09-07T09:34:51Z","author_association":"NONE","body":"@clintongormley yes I do.\n\nI have succeeded to ~solve this issue by using bulk indexing with higher bulk size. Of course it probably means the contention is lower and thus less visible\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54742668","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54742668","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54742668,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQyNjY4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T10:10:31Z","updated_at":"2014-09-07T10:10:31Z","author_association":"CONTRIBUTOR","body":"@kamaradclimber don't use async replication.  It stops Elasticsearch from exerting any back pressure on the application, which can lead to ES being overwhelmed. It doesn't make indexing any faster anyway.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54742743","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54742743","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54742743,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQyNzQz","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T10:14:07Z","updated_at":"2014-09-07T10:14:07Z","author_association":"CONTRIBUTOR","body":"I'm confused here: the bulk indexing thread pool is fixed size (number of processors) with a default queue size of 50, so when too many bulk requests arrive (async or not) you should see them being rejected?  Are you sure you're only issuing bulk requests?\n\nBut second off, I completely agree, unbounded thread pools are dangerous.  I think in this case the \"deadlock\" you were seeing is because CopyOnWriteArrayList is inefficient (O(N^2)) as it gets large...\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54742828","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54742828","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54742828,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQyODI4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T10:18:39Z","updated_at":"2014-09-07T10:18:39Z","author_association":"CONTRIBUTOR","body":"@mikemccand when bulk requests are sent to the replicas, they are never rejected (otherwise you'd end up with changes on the primary missing from the replicas).  So if the replica is struggling to keep up (eg heavy merge) it can grow unbounded. \n\nAsync replication doesn't wait for the replicas, so it allows users to get into this state.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54742952","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54742952","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54742952,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQyOTUy","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T10:26:15Z","updated_at":"2014-09-07T10:26:15Z","author_association":"CONTRIBUTOR","body":"@clintongormley Ahh, I see, so those request to the replicas must be using a different (unbounded) thread pool.  Shouldn't that thread pool be bounded, but have unbounded queue?\n\nSo the theory here is primary was plenty fast handling the bulk requests (so client never saw rejections), but a replica fell behind by ~28K requests?  I guess this can make sense, because of the O(N^2) cost of CopyOnWriteArrayList... once a replica starts slowing down, it \"quickly\" becomes slower and slower, so the situation just gets worse.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54744004","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54744004","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54744004,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQ0MDA0","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T11:23:44Z","updated_at":"2014-09-07T11:23:44Z","author_association":"MEMBER","body":"the thread dumps are part of the cluster state execution, where there is a single thread executing. I see a master related operation, trying to remove something from the cluster state. Can you attach a thread dump of all the threads you have?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54744068","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54744068","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54744068,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzQ0MDY4","user":{"login":"kimchy","id":41300,"node_id":"MDQ6VXNlcjQxMzAw","avatar_url":"https://avatars1.githubusercontent.com/u/41300?v=4","gravatar_id":"","url":"https://api.github.com/users/kimchy","html_url":"https://github.com/kimchy","followers_url":"https://api.github.com/users/kimchy/followers","following_url":"https://api.github.com/users/kimchy/following{/other_user}","gists_url":"https://api.github.com/users/kimchy/gists{/gist_id}","starred_url":"https://api.github.com/users/kimchy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kimchy/subscriptions","organizations_url":"https://api.github.com/users/kimchy/orgs","repos_url":"https://api.github.com/users/kimchy/repos","events_url":"https://api.github.com/users/kimchy/events{/privacy}","received_events_url":"https://api.github.com/users/kimchy/received_events","type":"User","site_admin":false},"created_at":"2014-09-07T11:26:42Z","updated_at":"2014-09-07T11:26:42Z","author_association":"MEMBER","body":"btw, I suspect async replication is not relevant as well here. can you post a sample code of the indexing you are doing? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54781945","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54781945","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54781945,"node_id":"MDEyOklzc3VlQ29tbWVudDU0NzgxOTQ1","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-08T06:47:20Z","updated_at":"2014-09-08T06:47:20Z","author_association":"NONE","body":"@kimchy here is the dump https://gist.github.com/24b78a761e63da0bca8c (it seems gist is limiting the size of files, so here is the full dump http://wikisend.com/download/636734/dump.txt)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54794525","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54794525","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54794525,"node_id":"MDEyOklzc3VlQ29tbWVudDU0Nzk0NTI1","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-08T09:26:19Z","updated_at":"2014-09-08T09:26:19Z","author_association":"NONE","body":"code sample: \n\n``` java\nprivate void sendBatch(Client client, ResponseListenerFactory listenerF) {\n        BulkRequest request = prepareRequestBatch(client);\n        client.bulk(request, listenerF.getActionListener(request));\n    }\n\nprivate BulkRequest prepareRequestBatch(Client client) {\n        BulkRequestBuilder bulk = client.prepareBulk();\n        bulk.setConsistencyLevel(WriteConsistencyLevel.ONE);\n        for (IndexRequest request : this.requestsBatch) {\n            bulk.add(request);\n        }\n        this.requestsBatch.clear();\n        return bulk.request();\n    }\n```\n\n`getActionListener` returns a ActionListener<BulkResponse>\n\nclient settings are:\n\n```\n{\n  \"cluster_name\" : \"kestrel\",\n  \"nodes\" : {\n    \"DdH0bfK6S5Gi2TGm1nTexQ\" : {\n      \"name\" : \"Argo\",\n      \"transport_address\" : \"inet[/10.22.150.10:9300]\",\n      \"host\" : \"2c-59-e5-4a-0b-f4\",\n      \"ip\" : \"10.22.150.10\",\n      \"version\" : \"1.1.1\",\n      \"build\" : \"f1585f0\",\n      \"http_address\" : \"inet[/10.22.150.10:9205]\",\n      \"attributes\" : {\n        \"client\" : \"true\",\n        \"data\" : \"false\"\n      },\n      \"settings\" : {\n        \"path\" : {\n          \"logs\" : \"/logs\"\n        },\n        \"threadpool\" : {\n          \"warmer\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"snapshot_data\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"get\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"search\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"snapshot\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"percolate\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"suggest\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          },\n          \"refresh\" : {\n            \"type\" : \"fixed\",\n            \"size\" : \"1\"\n          }\n        },\n        \"config\" : \"/usr/local/etc/es_pusher_embedded_node.yml\",\n        \"cluster\" : {\n          \"name\" : \"kestrel\"\n        },\n        \"node\" : {\n          \"client\" : \"true\"\n        },\n        \"http\" : {\n          \"port\" : \"9205-9210\"\n        },\n        \"discovery\" : {\n          \"zen\" : {\n            \"ping\" : {\n              \"unicast\" : {\n                \"hosts\" : \"localhost:9300\"\n              },\n              \"multicast\" : {\n                \"enabled\" : \"false\"\n              }\n            }\n          }\n        },\n        \"name\" : \"Argo\"\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54794683","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54794683","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54794683,"node_id":"MDEyOklzc3VlQ29tbWVudDU0Nzk0Njgz","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-08T09:28:00Z","updated_at":"2014-09-08T09:28:00Z","author_association":"NONE","body":"@mikemccand I am sure to do only bulk indexing (the above sample is the only interaction of this client with ES).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54799073","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54799073","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54799073,"node_id":"MDEyOklzc3VlQ29tbWVudDU0Nzk5MDcz","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2014-09-08T10:13:09Z","updated_at":"2014-09-08T10:13:09Z","author_association":"CONTRIBUTOR","body":"@kimchy @mikemccand I just looked at this briefly and it seems on the one hand we are not waiting for the bulks to come back which is one problem but the other is that we seem to register a ClusterStateListener in a retry operation for every indexing op and that seems to be maybe waiting for a shard to become active etc. I wonder if @bleskes can shed some light on that - i think he worked on the retry last time.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/54799793","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-54799793","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":54799793,"node_id":"MDEyOklzc3VlQ29tbWVudDU0Nzk5Nzkz","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-09-08T10:21:28Z","updated_at":"2014-09-08T10:21:28Z","author_association":"CONTRIBUTOR","body":"@kamaradclimber the comment from @s1monw aside, look at using the BulkProcessor instead of what you're currently doing: https://github.com/elasticsearch/elasticsearch/blob/master/src/main/java/org/elasticsearch/action/bulk/BulkProcessor.java\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55882267","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55882267","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55882267,"node_id":"MDEyOklzc3VlQ29tbWVudDU1ODgyMjY3","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T11:45:33Z","updated_at":"2014-09-17T11:45:33Z","author_association":"MEMBER","body":"@kamaradclimber I'm sorry for the late response. All the stack traces that fit into the gist are caused by  a master operation which can not proceed because the node has no master. I suspect these are auto create index calls. Is it true that you do not create an index in advance? \n\nI looked at your settings and I think the problems lies in the fact that your unicast discovery points to the address of the client and not the node you are trying to index to (localhost:9200). This means the client doesn't discover the cluster and doesn't have a master node. Therefore every indexing request waits for up to 1m before time out. If you have too many of those in flight, you will get the behavior you see.\n\nWhile it's definitely true we should use a better data structure for the \"waiting\" actions, I think this also implies your indexing request do not wait for an answer before issuing a new request. Is that the case?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55899380","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55899380","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55899380,"node_id":"MDEyOklzc3VlQ29tbWVudDU1ODk5Mzgw","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T14:14:47Z","updated_at":"2014-09-17T14:14:47Z","author_association":"NONE","body":"@clintongormley  we are now using BulkProcessor, behavior seems far better\n\n@bleskes:\n1) yes we have auto index creation (we are indexing logs and roll index every 6 hours)\n2) we were able to see the following pattern: threads count increases on all client (same servers as data nodes), the load increases and the data node stop being able to ping each other, the master is demoted, the cluster loose its master and is unable to have one, then the number of threads indeed explodes\n3) since we clients are on the same node, localhost:9200 is a valid endpoint for clients\n- we have moved since to a setup with 3 dedicated master so we will at some point point clients to those instead of localhost\n- usage of BulkProcessor (2 concurrent requests authorized) will fix the issue of millions of in flight requests\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55900190","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55900190","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55900190,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTAwMTkw","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T14:20:18Z","updated_at":"2014-09-17T14:20:18Z","author_association":"MEMBER","body":"> 3) since we clients are on the same node, localhost:9200 is a valid endpoint for clients\n\nSorry, I made a mistake, I meant the 9300 port. This piece in your settings / info `\"transport_address\" : \"inet[/10.22.150.10:9300]\",` suggest the client is bound to the 9300, not the node you are trying to call.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55900875","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55900875","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55900875,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTAwODc1","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T14:24:27Z","updated_at":"2014-09-17T14:24:27Z","author_association":"NONE","body":"made the same mistake but we understood each other :)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55901200","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55901200","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55901200,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTAxMjAw","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T14:26:39Z","updated_at":"2014-09-17T14:26:39Z","author_association":"MEMBER","body":"@kamaradclimber might be unneeded repetition, but your client is bound to port 9300 - I think this is the source of the problem.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55901688","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55901688","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55901688,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTAxNjg4","user":{"login":"kamaradclimber","id":503537,"node_id":"MDQ6VXNlcjUwMzUzNw==","avatar_url":"https://avatars1.githubusercontent.com/u/503537?v=4","gravatar_id":"","url":"https://api.github.com/users/kamaradclimber","html_url":"https://github.com/kamaradclimber","followers_url":"https://api.github.com/users/kamaradclimber/followers","following_url":"https://api.github.com/users/kamaradclimber/following{/other_user}","gists_url":"https://api.github.com/users/kamaradclimber/gists{/gist_id}","starred_url":"https://api.github.com/users/kamaradclimber/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kamaradclimber/subscriptions","organizations_url":"https://api.github.com/users/kamaradclimber/orgs","repos_url":"https://api.github.com/users/kamaradclimber/repos","events_url":"https://api.github.com/users/kamaradclimber/events{/privacy}","received_events_url":"https://api.github.com/users/kamaradclimber/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T14:29:46Z","updated_at":"2014-09-17T14:29:46Z","author_association":"NONE","body":"yes that is something we fixed a few days ago, clients are now on port 9305\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55902065","html_url":"https://github.com/elastic/elasticsearch/issues/7592#issuecomment-55902065","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7592","id":55902065,"node_id":"MDEyOklzc3VlQ29tbWVudDU1OTAyMDY1","user":{"login":"bleskes","id":1006375,"node_id":"MDQ6VXNlcjEwMDYzNzU=","avatar_url":"https://avatars1.githubusercontent.com/u/1006375?v=4","gravatar_id":"","url":"https://api.github.com/users/bleskes","html_url":"https://github.com/bleskes","followers_url":"https://api.github.com/users/bleskes/followers","following_url":"https://api.github.com/users/bleskes/following{/other_user}","gists_url":"https://api.github.com/users/bleskes/gists{/gist_id}","starred_url":"https://api.github.com/users/bleskes/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bleskes/subscriptions","organizations_url":"https://api.github.com/users/bleskes/orgs","repos_url":"https://api.github.com/users/bleskes/repos","events_url":"https://api.github.com/users/bleskes/events{/privacy}","received_events_url":"https://api.github.com/users/bleskes/received_events","type":"User","site_admin":false},"created_at":"2014-09-17T14:31:57Z","updated_at":"2014-09-17T14:31:57Z","author_association":"MEMBER","body":"OK. So I think we can close it now, as this seems to be the source of the problem - a combination of not being able to connect to the master + an unbound incoming request queue. The BulkProcessor will help you with the latter. If I missed anything, please feel free to reopen.\n","performed_via_github_app":null}]