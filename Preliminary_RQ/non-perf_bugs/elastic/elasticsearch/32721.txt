{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/32721","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32721/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32721/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/32721/events","html_url":"https://github.com/elastic/elasticsearch/issues/32721","id":348799483,"node_id":"MDU6SXNzdWUzNDg3OTk0ODM=","number":32721,"title":"Cluster routing allocation filtering by node can break with multiple exclusions","user":{"login":"inqueue","id":6099128,"node_id":"MDQ6VXNlcjYwOTkxMjg=","avatar_url":"https://avatars2.githubusercontent.com/u/6099128?v=4","gravatar_id":"","url":"https://api.github.com/users/inqueue","html_url":"https://github.com/inqueue","followers_url":"https://api.github.com/users/inqueue/followers","following_url":"https://api.github.com/users/inqueue/following{/other_user}","gists_url":"https://api.github.com/users/inqueue/gists{/gist_id}","starred_url":"https://api.github.com/users/inqueue/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/inqueue/subscriptions","organizations_url":"https://api.github.com/users/inqueue/orgs","repos_url":"https://api.github.com/users/inqueue/repos","events_url":"https://api.github.com/users/inqueue/events{/privacy}","received_events_url":"https://api.github.com/users/inqueue/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-08-08T16:25:19Z","updated_at":"2018-10-19T11:58:43Z","closed_at":"2018-10-19T11:58:43Z","author_association":"MEMBER","active_lock_reason":null,"body":"**Elasticsearch version** (`bin/elasticsearch --version`): 6.3.1\r\n\r\n**JVM version** (`java -version`): openjdk version \"1.8.0_171\"\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 16.04.2 LTS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nShard allocation exclusions appear to be broken after multiple exclusions have been applied for the same node, then one exclusion removed. \r\n\r\n**Steps to reproduce**:\r\nThe repro this is pretty straightforward. This may be a corner case, but it is enough to add confusion when managing a cluster. This repro excludes a single node by both IP and host in dynamic cluster settings, then removes the host exclusion. Once the condition is created, the IP exclusion is ignored. Full requests and responses have been posted to https://gist.github.com/inqueue/43fab958c708b485676f82b225090040.\r\n\r\n```\r\nGET _cluster/settings\r\n\r\nGET _cat/allocation?v&s=node\r\n\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"2\",\r\n    \"cluster.routing.allocation.exclude._ip\" : \"10.0.2.55\",\r\n    \"cluster.routing.allocation.exclude._host\" : \"json5x60-3.ip.es.io\"\r\n  }\r\n}\r\n\r\nGET _cat/allocation?v&s=node\r\n\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"2\",\r\n    \"cluster.routing.allocation.exclude._ip\" : \"10.0.2.55\",\r\n    \"cluster.routing.allocation.exclude._host\" : null\r\n  }\r\n}\r\n\r\nGET _cat/allocation?v&s=node\r\n\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"2\",\r\n    \"cluster.routing.allocation.exclude._ip\" : \"10.0.2.55\",\r\n    \"cluster.routing.allocation.exclude._host\" : null\r\n  }\r\n}\r\n\r\nGET _cat/allocation?v&s=node\r\n\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"2\",\r\n    \"cluster.routing.allocation.exclude._ip\" : \"10.0.2.55\",\r\n    \"cluster.routing.allocation.exclude._host\" : \"json5x60-3.ip.es.io\"\r\n  }\r\n}\r\n\r\nGET _cat/allocation?v&s=node\r\n```\r\n\r\nTo fix null out all exclusions and reapply if needed:\r\n```\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"2\",\r\n    \"cluster.routing.allocation.exclude._ip\" : null,\r\n    \"cluster.routing.allocation.exclude._host\" : null\r\n  }\r\n}\r\n\r\nGET _cat/allocation?v&s=node\r\n\r\nPUT _cluster/settings\r\n{\r\n  \"transient\" : {\r\n    \"cluster.routing.allocation.cluster_concurrent_rebalance\" : \"2\",\r\n    \"cluster.routing.allocation.exclude._ip\" : \"10.0.2.55\",\r\n    \"cluster.routing.allocation.exclude._host\" : null\r\n  }\r\n}\r\n\r\nGET _cat/allocation?v&s=node\r\n```\r\n\r\n","closed_by":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"performed_via_github_app":null}