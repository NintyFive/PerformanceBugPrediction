{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/11774","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11774/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11774/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/11774/events","html_url":"https://github.com/elastic/elasticsearch/issues/11774","id":89549151,"node_id":"MDU6SXNzdWU4OTU0OTE1MQ==","number":11774,"title":"GroovyScriptExecutionException: NumberFormatException[null]","user":{"login":"gkozyryatskyy","id":7124946,"node_id":"MDQ6VXNlcjcxMjQ5NDY=","avatar_url":"https://avatars3.githubusercontent.com/u/7124946?v=4","gravatar_id":"","url":"https://api.github.com/users/gkozyryatskyy","html_url":"https://github.com/gkozyryatskyy","followers_url":"https://api.github.com/users/gkozyryatskyy/followers","following_url":"https://api.github.com/users/gkozyryatskyy/following{/other_user}","gists_url":"https://api.github.com/users/gkozyryatskyy/gists{/gist_id}","starred_url":"https://api.github.com/users/gkozyryatskyy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gkozyryatskyy/subscriptions","organizations_url":"https://api.github.com/users/gkozyryatskyy/orgs","repos_url":"https://api.github.com/users/gkozyryatskyy/repos","events_url":"https://api.github.com/users/gkozyryatskyy/events{/privacy}","received_events_url":"https://api.github.com/users/gkozyryatskyy/received_events","type":"User","site_admin":false},"labels":[{"id":146834791,"node_id":"MDU6TGFiZWwxNDY4MzQ3OTE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Scripting","name":":Core/Infra/Scripting","color":"0e8a16","default":false,"description":"Scripting abstractions, Painless, and Mustache"},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2015-06-19T12:11:10Z","updated_at":"2016-01-18T20:41:16Z","closed_at":"2016-01-18T20:41:16Z","author_association":"NONE","active_lock_reason":null,"body":"Hello.\nI have a mapping like this.\n\n```\n{  \n    \"user\":{  \n       \"properties\":{  \n          \"mCount\":{  \n             \"type\":\"integer\",\n             \"store\":true,\n             \"doc_values\":true\n          }\n       }\n    },\n    \"media\":{  \n       \"_parent\":{  \n          \"type\":\"user\"\n       },\n       \"_routing\":{  \n          \"required\":true\n       },\n       \"properties\":{  \n          \"location\":{  \n             \"type\":\"geo_point\",\n             \"doc_values\":true,\n             \"lat_lon\":true,\n             \"geohash\":true,\n             \"geohash_prefix\":true\n          }\n       }\n    }\n }\n```\n\nI run this query \n\n```\n{\n    \"size\" : 10,\n    \"query\" : {\n      \"has_child\" : {\n        \"query\" : {\n          \"filtered\" : {\n            \"filter\" : {\n              \"geo_bbox\" : {\n                \"location\" : {\n                  \"top_left\" : [ -74.1, 41.73 ],\n                  \"bottom_right\" : [ -73.99, 40.717 ]\n                }\n              }\n            }\n          }\n        },\n        \"child_type\" : \"media\",\n        \"score_type\" : \"sum\"\n      }\n    },\n    \"fields\" : \"mCount\",\n    \"sort\" : [ {\n      \"_script\" : {\n        \"script\" : \"_score  / doc['mCount'].value\",\n        \"type\" : \"number\",\n        \"reverse\" : true\n      }\n    } ],\n    \"track_scores\" : true\n  }\n```\n\nand got \n\n```\nquery[filtered(ChildrenQuery[min(0) max(2147483647)of media/user](filtered(ConstantScore(GeoBoundingBoxFilter(location, [41.73, -74.1], [40.717, -73.99])))->cache(_type:media)))->cache(_type:user)],from[0],size[10],sort[<custom:\"_script\": org.elasticsearch.search.sort.ScriptSortParser$2@7144a535>!]: Query Failed [Failed to execute main query]\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:163)\n        at org.elasticsearch.search.SearchService.loadOrExecuteQueryPhase(SearchService.java:289)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:300)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:231)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$5.call(SearchServiceTransportAction.java:228)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$23.run(SearchServiceTransportAction.java:559)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n        at java.lang.Thread.run(Thread.java:745)\n    Caused by: org.elasticsearch.script.groovy.GroovyScriptExecutionException: NumberFormatException[null]\n        at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.run(GroovyScriptEngineService.java:278)\n        at org.elasticsearch.script.groovy.GroovyScriptEngineService$GroovyScript.runAsDouble(GroovyScriptEngineService.java:294)\n        at org.elasticsearch.search.sort.ScriptSortParser$2$1.get(ScriptSortParser.java:177)\n        at org.elasticsearch.index.fielddata.fieldcomparator.DoubleValuesComparatorSource$1$1.get(DoubleValuesComparatorSource.java:87)\n        at org.apache.lucene.search.FieldComparator$DoubleComparator.copy(FieldComparator.java:367)\n        at org.apache.lucene.search.TopFieldCollector$OutOfOrderOneComparatorScoringMaxScoreCollector.collect(TopFieldCollector.java:363)\n        at org.apache.lucene.search.Weight$DefaultBulkScorer.scoreAll(Weight.java:193)\n        at org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:163)\n        at org.apache.lucene.search.BulkScorer.score(BulkScorer.java:35)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:621)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:191)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:581)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:533)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:510)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:345)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:150)\n        ... 8 more\n```\n\nwhen i replace script in scriptsort to `\"script\" : \"_score  * (1 / doc['mCount'].value\")\"` Im also get `NumberFormatException[null]` , but when i replace script to `\"script\" : \"_score  * (1.0 / doc['mCount'].value\")\"` it is working fine. And i get \n\n```\n{\n    \"took\" : 2,\n    \"timed_out\" : false,\n    \"_shards\" : {\n      \"total\" : 5,\n      \"successful\" : 5,\n      \"failed\" : 0\n    },\n    \"hits\" : {\n      \"total\" : 14,\n      \"max_score\" : 317.0,\n      \"hits\" : [ {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"1433\",\n        \"_score\" : 317.0,\n        \"fields\" : {\n          \"mCount\" : [ 2562 ]\n        },\n        \"sort\" : [ 0.12373145979703357 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"1615\",\n        \"_score\" : 299.0,\n        \"fields\" : {\n          \"mCount\" : [ 6283 ]\n        },\n        \"sort\" : [ 0.04758873149769219 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"49\",\n        \"_score\" : 56.0,\n        \"fields\" : {\n          \"mCount\" : [ 1327 ]\n        },\n        \"sort\" : [ 0.042200452147701586 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"3264\",\n        \"_score\" : 64.0,\n        \"fields\" : {\n          \"mCount\" : [ 3210 ]\n        },\n        \"sort\" : [ 0.019937694704049845 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"2808\",\n        \"_score\" : 15.0,\n        \"fields\" : {\n          \"mCount\" : [ 911 ]\n        },\n        \"sort\" : [ 0.01646542261251372 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"1004\",\n        \"_score\" : 11.0,\n        \"fields\" : {\n          \"mCount\" : [ 760 ]\n        },\n        \"sort\" : [ 0.014473684210526316 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"3096\",\n        \"_score\" : 9.0,\n        \"fields\" : {\n          \"mCount\" : [ 638 ]\n        },\n        \"sort\" : [ 0.014106583072100312 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"6\",\n        \"_score\" : 7.0,\n        \"fields\" : {\n          \"mCount\" : [ 995 ]\n        },\n        \"sort\" : [ 0.007035175879396985 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"33\",\n        \"_score\" : 10.0,\n        \"fields\" : {\n          \"mCount\" : [ 1460 ]\n        },\n        \"sort\" : [ 0.00684931506849315 ]\n      }, {\n        \"_index\" : \"qwe\",\n        \"_type\" : \"user\",\n        \"_id\" : \"4695\",\n        \"_score\" : 5.0,\n        \"fields\" : {\n          \"mCount\" : [ 934 ]\n        },\n        \"sort\" : [ 0.005353319057815846 ]\n      } ]\n    }\n  }\n```\n\nWhy it is so? Why i can not use just `\"script\" : \"_score  / doc['mCount'].value\"` ?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}