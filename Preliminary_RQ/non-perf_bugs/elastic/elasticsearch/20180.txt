{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20180","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20180/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20180/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20180/events","html_url":"https://github.com/elastic/elasticsearch/issues/20180","id":173487417,"node_id":"MDU6SXNzdWUxNzM0ODc0MTc=","number":20180,"title":"function_score min_score sometimes doesn't work","user":{"login":"sfcgeorge","id":885003,"node_id":"MDQ6VXNlcjg4NTAwMw==","avatar_url":"https://avatars3.githubusercontent.com/u/885003?v=4","gravatar_id":"","url":"https://api.github.com/users/sfcgeorge","html_url":"https://github.com/sfcgeorge","followers_url":"https://api.github.com/users/sfcgeorge/followers","following_url":"https://api.github.com/users/sfcgeorge/following{/other_user}","gists_url":"https://api.github.com/users/sfcgeorge/gists{/gist_id}","starred_url":"https://api.github.com/users/sfcgeorge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfcgeorge/subscriptions","organizations_url":"https://api.github.com/users/sfcgeorge/orgs","repos_url":"https://api.github.com/users/sfcgeorge/repos","events_url":"https://api.github.com/users/sfcgeorge/events{/privacy}","received_events_url":"https://api.github.com/users/sfcgeorge/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null},{"id":338705198,"node_id":"MDU6TGFiZWwzMzg3MDUxOTg=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v2.2.2","name":"v2.2.2","color":"dddddd","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-08-26T16:02:58Z","updated_at":"2018-02-14T13:32:39Z","closed_at":"2016-08-30T12:55:09Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.2.2\n\n**Plugins installed**: []\n\n**JVM version**: \njava version \"1.8.0_25\"\nJava(TM) SE Runtime Environment (build 1.8.0_25-b17)\nJava HotSpot(TM) 64-Bit Server VM (build 25.25-b02, mixed mode)\n\n**OS version**:\nOS X 10.11.6\n\n**Description of the problem including expected versus actual behavior**:\nI'm trying to sum up date ranges and include only results where the availability is > 80% of a window. Using Expressions due to cloud hosting limitations. \n\nI got the method to work as detailed in [my post](https://www.sfcgeorge.co.uk/posts/2016/07/19/searching-discontinuous-dates-in-elasticsearch) with simple data.\n\nBut with my real data the results are all over the place. Sometimes correct, but sometimes results with a score of less than the 0.8 specified in the min_score are returned. So it appears that min_score, under certain circumstances, doesn't work.\n\nI can't figure out how to work around this, or what is causing it. I've spent hours bashing my head. The wrong results change depending on similarity type and number of nodes. So I wonder if it's a QueryNorm issue? Any thoughts welcome.\n\n**Steps to reproduce**:\n\n<details>\n\n```\n#!/bin/bash\nexport ELASTICSEARCH_ENDPOINT=\"http://localhost:9200\"\n\n# Delete indexes\ncurl -XDELETE \"$ELASTICSEARCH_ENDPOINT/play\"\n\n# Create indexes\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play?pretty\" -d '{\n    \"settings\": {\n      \"similarity.default.type\": \"BM25\"\n    },\n    \"mappings\":{\"candidate\":{\"dynamic\":\"false\",\"properties\":{\"active_participations_size\":{\"type\":\"integer\"},\"external_recruitments_size\":{\"type\":\"integer\"},\"internal_recruitments_size\":{\"type\":\"integer\"},\"preference\":{\"properties\":{\"accepts_expenses\":{\"type\":\"boolean\"},\"industries\":{\"properties\":{\"id\":{\"type\":\"integer\"},\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"job_description\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}},\"locations\":{\"properties\":{\"id\":{\"type\":\"integer\"},\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"time_periods\":{\"type\":\"nested\",\"properties\":{\"from\":{\"type\":\"date\",\"format\":\"strict_date_optional_time||epoch_millis\"},\"from_d\":{\"type\":\"integer\"},\"from_sec\":{\"type\":\"long\"},\"now\":{\"type\":\"boolean\"},\"now_i\":{\"type\":\"short\"},\"to\":{\"type\":\"date\",\"format\":\"strict_date_optional_time||epoch_millis\"},\"to_d\":{\"type\":\"integer\"},\"to_sec\":{\"type\":\"long\"}}},\"work_types\":{\"properties\":{\"id\":{\"type\":\"integer\"}}}}},\"profile\":{\"properties\":{\"computational_skills\":{\"type\":\"nested\",\"properties\":{\"available_computational_skill_id\":{\"type\":\"integer\"},\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}},\"numeric_level\":{\"type\":\"integer\"}}},\"degrees\":{\"type\":\"nested\",\"properties\":{\"course_qualification\":{\"properties\":{\"level\":{\"type\":\"integer\"},\"value\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"course_title\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}},\"grade\":{\"properties\":{\"precedence\":{\"type\":\"integer\"}}},\"graduate\":{\"type\":\"boolean\"},\"graduation_year\":{\"type\":\"date\",\"format\":\"strict_date_optional_time||epoch_millis\"},\"still_studying\":{\"type\":\"boolean\"},\"university\":{\"properties\":{\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"university_id\":{\"type\":\"integer\"},\"year_of_study\":{\"type\":\"integer\"}}},\"features\":{\"type\":\"nested\",\"properties\":{\"description\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}},\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"full_driving_licence?\":{\"type\":\"boolean\"},\"hidden\":{\"type\":\"boolean\"},\"languages\":{\"type\":\"nested\",\"properties\":{\"available_language_id\":{\"type\":\"integer\"},\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}},\"native\":{\"type\":\"boolean\"},\"numeric_spoken_proficiency\":{\"type\":\"integer\"},\"numeric_written_proficiency\":{\"type\":\"integer\"}}},\"score\":{\"type\":\"integer\"},\"still_studying?\":{\"type\":\"boolean\"},\"traits\":{\"properties\":{\"id\":{\"type\":\"integer\"},\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"verified_references\":{\"type\":\"integer\"},\"verified_scores_average\":{\"type\":\"integer\"},\"video?\":{\"type\":\"boolean\"},\"work_experiences\":{\"type\":\"nested\",\"properties\":{\"description\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}},\"key_skills\":{\"properties\":{\"name\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}},\"role\":{\"type\":\"string\",\"analyzer\":\"english\",\"fields\":{\"std\":{\"type\":\"string\",\"analyzer\":\"standard\"}}}}}}},\"recruitments\":{\"type\":\"nested\",\"properties\":{\"interested\":{\"type\":\"boolean\"},\"recommended\":{\"type\":\"boolean\"},\"search_position\":{\"type\":\"integer\"},\"status\":{\"type\":\"string\",\"index\":\"not_analyzed\"},\"viewed\":{\"type\":\"boolean\"}}},\"updated_at\":{\"type\":\"date\",\"format\":\"strict_date_optional_time||epoch_millis\"}}}}}\n}\n'\n\n# Index documents\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/1?pretty\" -d '\n{\n  \"id\": 1,\n  \"preference\": {\n    \"id\": 1,\n    \"time_periods\": [\n      {\n        \"id\": 2,\n        \"now_i\": 1,\n        \"from_sec\": null,\n        \"to_sec\": null,\n        \"from_d\": 0,\n        \"to_d\": 0\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/2?pretty\" -d '\n{\n  \"id\": 2,\n  \"preference\": {\n    \"id\": 2,\n    \"time_periods\": [\n      {\n        \"id\": 5,\n        \"now_i\": 0,\n        \"from_sec\": 1472598000,\n        \"to_sec\": 1473202800,\n        \"from_d\": 17043,\n        \"to_d\": 17050\n      },\n      {\n        \"id\": 4,\n        \"now_i\": 0,\n        \"from_sec\": 1472166000,\n        \"to_sec\": 1472425200,\n        \"from_d\": 17038,\n        \"to_d\": 17041\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/3?pretty\" -d '\n{\n  \"id\": 3,\n  \"preference\": {\n    \"id\": 3,\n    \"time_periods\": [\n      {\n        \"id\": 7,\n        \"now_i\": 0,\n        \"from_sec\": 1472425200,\n        \"to_sec\": 1473202800,\n        \"from_d\": 17041,\n        \"to_d\": 17050\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/4?pretty\" -d '\n{\n  \"id\": 4,\n  \"preference\": {\n    \"id\": 4,\n    \"time_periods\": [\n      {\n        \"id\": 9,\n        \"now_i\": 0,\n        \"from_sec\": 1472166000,\n        \"to_sec\": 1472943600,\n        \"from_d\": 17038,\n        \"to_d\": 17047\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/5?pretty\" -d '\n{\n  \"id\": 5,\n  \"preference\": {\n    \"id\": 5,\n    \"time_periods\": [\n      {\n        \"id\": 11,\n        \"now_i\": 0,\n        \"from_sec\": 1472338800,\n        \"to_sec\": 1473030000,\n        \"from_d\": 17040,\n        \"to_d\": 17048\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/6?pretty\" -d '\n{\n  \"id\": 6,\n  \"preference\": {\n    \"id\": 6,\n    \"time_periods\": [\n      {\n        \"id\": 15,\n        \"now_i\": 0,\n        \"from_sec\": 1472684400,\n        \"to_sec\": 1473116400,\n        \"from_d\": 17044,\n        \"to_d\": 17049\n      },\n      {\n        \"id\": 14,\n        \"now_i\": 0,\n        \"from_sec\": 1472511600,\n        \"to_sec\": 1472598000,\n        \"from_d\": 17042,\n        \"to_d\": 17043\n      },\n      {\n        \"id\": 13,\n        \"now_i\": 0,\n        \"from_sec\": 1472252400,\n        \"to_sec\": 1472425200,\n        \"from_d\": 17039,\n        \"to_d\": 17041\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/7?pretty\" -d '\n{\n  \"id\": 7,\n  \"preference\": {\n    \"id\": 7,\n    \"time_periods\": [\n      {\n        \"id\": 17,\n        \"now_i\": 0,\n        \"from_sec\": 1473202800,\n        \"to_sec\": 1473894000,\n        \"from_d\": 17050,\n        \"to_d\": 17058\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/8?pretty\" -d '\n{\n  \"id\": 8,\n  \"preference\": {\n    \"id\": 8,\n    \"time_periods\": [\n      {\n        \"id\": 19,\n        \"now_i\": 0,\n        \"from_sec\": 1474153200,\n        \"to_sec\": 1474844400,\n        \"from_d\": 17061,\n        \"to_d\": 17069\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/9?pretty\" -d '\n{\n  \"id\": 9,\n  \"preference\": {\n    \"id\": 9,\n    \"time_periods\": [\n      {\n        \"id\": 21,\n        \"now_i\": 0,\n        \"from_sec\": 1473807600,\n        \"to_sec\": 1474498800,\n        \"from_d\": 17057,\n        \"to_d\": 17065\n      }\n    ]\n  }\n}\n'\ncurl -XPUT \"$ELASTICSEARCH_ENDPOINT/play/candidate/10?pretty\" -d '\n{\n  \"id\": 10,\n  \"preference\": {\n    \"id\": 10,\n    \"time_periods\": [\n      {\n        \"id\": 23,\n        \"now_i\": 0,\n        \"from_sec\": 1473807600,\n        \"to_sec\": 1474066800,\n        \"from_d\": 17057,\n        \"to_d\": 17060\n      }\n    ]\n  }\n}\n'\n\n# Ensure docs are ready\ncurl -XPOST \"$ELASTICSEARCH_ENDPOINT/play/_refresh\"\n\n# Perform search\necho \"\\n\\n\\nRESULTS:\"\ncurl -XPOST \"$ELASTICSEARCH_ENDPOINT/play/candidate/_search?search_type=dfs_query_then_fetch&pretty\" -d '\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"function_score\": {\n            \"boost_mode\": \"replace\",\n            \"min_score\": 0.8,\n            \"query\": {\n              \"nested\": {\n                \"_name\": \"availability\",\n                \"path\": \"preference.time_periods\",\n                \"score_mode\": \"sum\",\n                \"query\": {\n                  \"function_score\": {\n                    \"script_score\": {\n                      \"script\": {\n                        \"lang\": \"expression\",\n                        \"inline\": \"doc[\\\"preference.time_periods.now_i\\\"].value ? 1 : max( min(finish, doc[\\\"preference.time_periods.to_d\\\"].value ? doc[\\\"preference.time_periods.to_d\\\"].value : future) - max(start, doc[\\\"preference.time_periods.from_d\\\"].value) , 0) / (finish - start) \",\n                        \"params\": {\n                          \"future\": 17769.660868055555,\n                          \"start\": 17049.958333333332,\n                          \"finish\": 17059.958333333332\n                        }\n                      }\n                    }\n                  }\n                }\n              }\n            }\n          }\n        }\n      ],\n      \"should\": [\n\n      ]\n    }\n  },\n  \"explain\": true\n}\n'\n```\n\n</details>\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}