{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20380","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20380/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20380/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20380/events","html_url":"https://github.com/elastic/elasticsearch/issues/20380","id":175661711,"node_id":"MDU6SXNzdWUxNzU2NjE3MTE=","number":20380,"title":"index.merge.scheduler.max_thread_count is not validated correctly, can break indexing","user":{"login":"rayward","id":1217111,"node_id":"MDQ6VXNlcjEyMTcxMTE=","avatar_url":"https://avatars1.githubusercontent.com/u/1217111?v=4","gravatar_id":"","url":"https://api.github.com/users/rayward","html_url":"https://github.com/rayward","followers_url":"https://api.github.com/users/rayward/followers","following_url":"https://api.github.com/users/rayward/following{/other_user}","gists_url":"https://api.github.com/users/rayward/gists{/gist_id}","starred_url":"https://api.github.com/users/rayward/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rayward/subscriptions","organizations_url":"https://api.github.com/users/rayward/orgs","repos_url":"https://api.github.com/users/rayward/repos","events_url":"https://api.github.com/users/rayward/events{/privacy}","received_events_url":"https://api.github.com/users/rayward/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2016-09-08T04:19:24Z","updated_at":"2016-09-08T23:15:52Z","closed_at":"2016-09-08T10:47:27Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.3.4 / 2.4.0\n\n**Plugins installed**: kopf\n\n**JVM version**:\n\nversion: \"1.8.0_102\",\nvm_name: \"OpenJDK 64-Bit Server VM\",\nvm_version: \"25.102-b14\"\",\nvm_vendor: \"Oracle Corporation\",\n\n**OS version**: \nDebian 8.5 \nLinux 8e884c0e66a2 4.4.15-moby # 1 SMP Thu Jul 28 22:03:07 UTC 2016 x86_64 GNU/Linux\n\n**Description of the problem including expected versus actual behavior**:\n\nES arbitrarily accepts any integer for `index.merge.scheduler.max_thread_count` even if it exceeds internal limits which then causes various scheduled tasks to throw exceptions and eventually break indexing.\n\n**Steps to reproduce**:\n\nWe experienced this on our production cluster but I was able to reproduce it using a couple of docker containers.\n1. Create an index:\n   \n   ```\n   POST /test_index\n   {\n   \"number_of_shards\": 4,\n   \"number_of_replicas\": 1\n   }\n   \n   {\n   \"acknowledged\": true\n   }\n   ```\n2. Update the max thread count:\n   \n   ```\n   PUT /test_index/_settings\n   {\n   \"index.merge.scheduler.max_thread_count\": 12\n   }\n   \n   {\n   \"acknowledged\": true\n   }\n   ```\n3. Alternate creating documents ...\n   \n   ```\n   POST /test_index/test_type\n   {\n   \"name\": \"bob\"\n   }\n   \n   {\n   \"_index\": \"test_index\",\n   \"_type\": \"test_type\",\n   \"_id\": \"AVcH80xPYp3inMh6kFUL\",\n   \"_version\": 1,\n   \"_shards\": {\n     \"total\": 2,\n     \"successful\": 2,\n     \"failed\": 0\n   },\n   \"created\": true\n   }\n   ```\n   \n   And optimizing the index (to force a flush):\n   \n   ```\n   GET /test_index/_optimize\n   ```\n4. This will shortly lead to translog failures:\n   \n   ```\n   POST /test_index/test_type\n   {\n   \"name\": \"bob\"\n   }\n   \n   {\n   \"error\": {\n     \"root_cause\": [\n       {\n         \"type\": \"create_failed_engine_exception\",\n         \"reason\": \"Create failed for [test_type#AVcH7buoYp3inMh6kFT4]\",\n         \"shard\": \"3\",\n         \"index\": \"test_index\"\n       }\n     ],\n     \"type\": \"create_failed_engine_exception\",\n     \"reason\": \"Create failed for [test_type#AVcH7buoYp3inMh6kFT4]\",\n     \"shard\": \"3\",\n     \"index\": \"test_index\",\n     \"caused_by\": {\n       \"type\": \"already_closed_exception\",\n       \"reason\": \"translog is already closed\"\n     }\n   },\n   \"status\": 500\n   }\n   ```\n   \n   ```\n   GET /test_index/_optimize\n   {\n   \"_shards\": {\n     \"total\": 8,\n     \"successful\": 2,\n     \"failed\": 6,\n     \"failures\": [\n       {\n         \"shard\": 3,\n         \"index\": \"test_index\",\n         \"status\": \"INTERNAL_SERVER_ERROR\",\n         \"reason\": {\n           \"type\": \"flush_failed_engine_exception\",\n           \"reason\": \"Flush failed\",\n           \"shard\": \"3\",\n           \"index\": \"test_index\",\n           \"caused_by\": {\n             \"type\": \"already_closed_exception\",\n             \"reason\": \"translog is already closed\"\n           }\n         }\n       }\n     ]\n   }\n   }\n   ```\n\n**Provide logs (if relevant)**:\n\nThe invalid `max_thread_count` causes all sorts of exceptions:\n\nUpdating the index settings:\n\n```\n[2016-09-08 03:50:48,676][INFO ][index.shard              ] [Abe Brown] [test_index][3] updating [index.merge.scheduler.max_thread_count] from [7] to [12]\n[2016-09-08 03:50:48,677][WARN ][index.settings           ] [Abe Brown] [test_index] failed to refresh settings for [org.elasticsearch.index.shard.IndexShard$ApplyRefreshSettings@27098528]\njava.lang.IllegalArgumentException: maxThreadCount should be <= maxMergeCount (= 7)\n    at org.apache.lucene.index.ConcurrentMergeScheduler.setMaxMergesAndThreads(ConcurrentMergeScheduler.java:154)\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.refreshConfig(ElasticsearchConcurrentMergeScheduler.java:176)\n    at org.elasticsearch.index.engine.InternalEngine.onSettingsChanged(InternalEngine.java:1268)\n    at org.elasticsearch.index.shard.IndexShard$ApplyRefreshSettings.onRefreshSettings(IndexShard.java:1325)\n    at org.elasticsearch.index.settings.IndexSettingsService.refreshSettings(IndexSettingsService.java:54)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.applySettings(IndicesClusterStateService.java:341)\n    at org.elasticsearch.indices.cluster.IndicesClusterStateService.clusterChanged(IndicesClusterStateService.java:180)\n    at org.elasticsearch.cluster.service.InternalClusterService.runTasksForExecutor(InternalClusterService.java:610)\n    at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:772)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.runAndClean(PrioritizedEsThreadPoolExecutor.java:231)\n    at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:194)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n```\n\nVarious errors seen while indexing and optimizing:\n\n```\n[2016-09-08 03:58:16,128][WARN ][index.shard              ] [Abe Brown] [test_index][3] Failed to perform scheduled engine refresh\njava.lang.IllegalArgumentException: maxThreadCount should be <= maxMergeCount (= 7)\n    at org.apache.lucene.index.ConcurrentMergeScheduler.setMaxMergesAndThreads(ConcurrentMergeScheduler.java:154)\n    at org.elasticsearch.index.engine.ElasticsearchConcurrentMergeScheduler.refreshConfig(ElasticsearchConcurrentMergeScheduler.java:176)\n    at org.elasticsearch.index.engine.InternalEngine.refresh(InternalEngine.java:685)\n    at org.elasticsearch.index.shard.IndexShard.refresh(IndexShard.java:661)\n    at org.elasticsearch.index.shard.IndexShard$EngineRefresher$1.run(IndexShard.java:1343)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n[2016-09-08 03:58:36,218][WARN ][indices.memory           ] [Abe Brown] failed to set shard [test_index][1] index buffer to [24.7mb]\norg.apache.lucene.store.AlreadyClosedException: translog [2] is already closed\n    at org.elasticsearch.index.translog.TranslogWriter.ensureOpen(TranslogWriter.java:329)\n    at org.elasticsearch.index.translog.BufferingTranslogWriter.updateBufferSize(BufferingTranslogWriter.java:143)\n    at org.elasticsearch.index.translog.Translog.updateBuffer(Translog.java:406)\n    at org.elasticsearch.index.shard.IndexShard.updateBufferSize(IndexShard.java:1164)\n    at org.elasticsearch.indices.memory.IndexingMemoryController.updateShardBuffers(IndexingMemoryController.java:232)\n    at org.elasticsearch.indices.memory.IndexingMemoryController$ShardsIndicesStatusChecker.run(IndexingMemoryController.java:286)\n    at org.elasticsearch.threadpool.ThreadPool$ReschedulingRunnable.doRun(ThreadPool.java:1057)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at org.elasticsearch.threadpool.ThreadPool$LoggingRunnable.run(ThreadPool.java:668)\n    at java.util.concurrent.Executors$RunnableAdapter.call(Executors.java:511)\n    at java.util.concurrent.FutureTask.run(FutureTask.java:266)\n    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.access$201(ScheduledThreadPoolExecutor.java:180)\n    at java.util.concurrent.ScheduledThreadPoolExecutor$ScheduledFutureTask.run(ScheduledThreadPoolExecutor.java:293)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\n```\n\n```\n[2016-09-08 03:53:05,512][DEBUG][action.admin.indices.forcemerge] [Abe Brown] [indices:admin/optimize] failed to execute operation for shard [[test_index][1], node[6jC3WEUrQWifFvTn-twoBw], [P], v[3], s[STARTED], a[id=Fa-2IEiESai0wk2csElq0Q]]\n[test_index][[test_index][1]] FlushFailedEngineException[Flush failed]; nested: IllegalStateException[already committing a translog with generation: 1];\n    at org.elasticsearch.index.engine.InternalEngine.flush(InternalEngine.java:762)\n    at org.elasticsearch.index.engine.InternalEngine.forceMerge(InternalEngine.java:863)\n    at org.elasticsearch.index.shard.IndexShard.forceMerge(IndexShard.java:793)\n    at org.elasticsearch.action.admin.indices.forcemerge.TransportForceMergeAction.shardOperation(TransportForceMergeAction.java:79)\n    at org.elasticsearch.action.admin.indices.forcemerge.TransportForceMergeAction.shardOperation(TransportForceMergeAction.java:46)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.onShardOperation(TransportBroadcastByNodeAction.java:436)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:415)\n    at org.elasticsearch.action.support.broadcast.node.TransportBroadcastByNodeAction$BroadcastByNodeTransportRequestHandler.messageReceived(TransportBroadcastByNodeAction.java:402)\n    at org.elasticsearch.transport.TransportRequestHandler.messageReceived(TransportRequestHandler.java:33)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:77)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: java.lang.IllegalStateException: already committing a translog with generation: 1\n    at org.elasticsearch.index.translog.Translog.prepareCommit(Translog.java:1785)\n    at org.elasticsearch.index.engine.InternalEngine.flush(InternalEngine.java:753)\n    ... 14 more\n```\n\n```\n[2016-09-08 03:59:27,335][WARN ][rest.suppressed          ] path: //test_index/test_type, params: {index=test_index, type=test_type}\nRemoteTransportException[[Abe Brown][172.19.0.2:9300][indices:data/write/index[p]]]; nested: CreateFailedEngineException[Create failed for [test_type#AVcH80pjYp3inMh6kFUK]]; nested: AlreadyClosedException[translog is already closed];\nCaused by: [test_index][[test_index][1]] CreateFailedEngineException[Create failed for [test_type#AVcH80pjYp3inMh6kFUK]]; nested: AlreadyClosedException[translog is already closed];\n    at org.elasticsearch.index.engine.InternalEngine.create(InternalEngine.java:351)\n    at org.elasticsearch.index.shard.IndexShard.create(IndexShard.java:545)\n    at org.elasticsearch.index.engine.Engine$Create.execute(Engine.java:810)\n    at org.elasticsearch.action.index.TransportIndexAction.executeIndexRequestOnPrimary(TransportIndexAction.java:236)\n    at org.elasticsearch.action.index.TransportIndexAction.shardOperationOnPrimary(TransportIndexAction.java:157)\n    at org.elasticsearch.action.index.TransportIndexAction.shardOperationOnPrimary(TransportIndexAction.java:66)\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryPhase.doRun(TransportReplicationAction.java:648)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:279)\n    at org.elasticsearch.action.support.replication.TransportReplicationAction$PrimaryOperationTransportHandler.messageReceived(TransportReplicationAction.java:271)\n    at org.elasticsearch.transport.RequestHandlerRegistry.processMessageReceived(RequestHandlerRegistry.java:77)\n    at org.elasticsearch.transport.TransportService$4.doRun(TransportService.java:376)\n    at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37)\n    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)\n    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)\n    at java.lang.Thread.run(Thread.java:745)\nCaused by: org.apache.lucene.store.AlreadyClosedException: translog is already closed\n    at org.elasticsearch.index.translog.Translog.ensureOpen(Translog.java:1888)\n    at org.elasticsearch.index.translog.Translog.add(Translog.java:544)\n    at org.elasticsearch.index.engine.InternalEngine.innerCreateNoLock(InternalEngine.java:437)\n    at org.elasticsearch.index.engine.InternalEngine.innerCreate(InternalEngine.java:375)\n    at org.elasticsearch.index.engine.InternalEngine.create(InternalEngine.java:346)\n    ... 15 more\n```\n\nInterestingly, closing and reopening the index will restore things to working order _with_ the configured thread count. \n\nReturning the `max_thread_count` to 1 shows that it has increased the thread count above what was previously set:\n\n```\nPUT /test_index/_settings\n{\n  \"index.merge.scheduler.max_thread_count\": 1\n}\n```\n\n```\n[2016-09-08 04:14:22,483][INFO ][index.shard              ] [Abe Brown] [test_index][1] updating [index.merge.scheduler.max_thread_count] from [17] to [1]\n[2016-09-08 04:14:22,484][INFO ][index.shard              ] [Abe Brown] [test_index][2] updating [index.merge.scheduler.max_thread_count] from [17] to [1]\n[2016-09-08 04:14:22,484][INFO ][index.shard              ] [Abe Brown] [test_index][3] updating [index.merge.scheduler.max_thread_count] from [17] to [1]\n[2016-09-08 04:14:22,484][INFO ][index.shard              ] [Abe Brown] [test_index][0] updating [index.merge.scheduler.max_thread_count] from [17] to [1]\n```\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}