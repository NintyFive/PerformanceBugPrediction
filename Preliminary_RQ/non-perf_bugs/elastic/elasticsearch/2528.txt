{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2528","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2528/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2528/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2528/events","html_url":"https://github.com/elastic/elasticsearch/issues/2528","id":9819834,"node_id":"MDU6SXNzdWU5ODE5ODM0","number":2528,"title":"Node doesn't fail gracefully on OOM","user":{"login":"jgagnon1","id":568924,"node_id":"MDQ6VXNlcjU2ODkyNA==","avatar_url":"https://avatars0.githubusercontent.com/u/568924?v=4","gravatar_id":"","url":"https://api.github.com/users/jgagnon1","html_url":"https://github.com/jgagnon1","followers_url":"https://api.github.com/users/jgagnon1/followers","following_url":"https://api.github.com/users/jgagnon1/following{/other_user}","gists_url":"https://api.github.com/users/jgagnon1/gists{/gist_id}","starred_url":"https://api.github.com/users/jgagnon1/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jgagnon1/subscriptions","organizations_url":"https://api.github.com/users/jgagnon1/orgs","repos_url":"https://api.github.com/users/jgagnon1/repos","events_url":"https://api.github.com/users/jgagnon1/events{/privacy}","received_events_url":"https://api.github.com/users/jgagnon1/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2013-01-09T20:29:55Z","updated_at":"2014-07-08T18:55:06Z","closed_at":"2014-07-08T18:55:06Z","author_association":"NONE","active_lock_reason":null,"body":"I think that when an node hit OOM it should at least be ejected from the cluster. I am running an index without any replicas, the node stays in the cluster but is in \"zombie\" state. Consequence; response time is abysmal (~800 secs) because the node that contains the shard doesn't answer the query but is still on the cluster. Ejecting the node would at least allow to maintain search active. \n\nAlso there is many more OOM in the following minutes by the fact that the node is not ejected and still receive queries.\n\nEven worse, I have to restart the whole cluster to get it working again as you will see in the log, restarting only the node will not help, because it wasn't able to rejoin the cluster.\n\nLogs\n\nFirst OOM\n\n```\n[2013-01-09 14:38:51,640][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [location] caused out of memory failure\njava.lang.OutOfMemoryError: Java heap space\n        at org.elasticsearch.index.field.data.support.FieldDataLoader.load(FieldDataLoader.java:45)\n        at org.elasticsearch.index.mapper.geo.GeoPointFieldData.load(GeoPointFieldData.java:168)\n        at org.elasticsearch.index.mapper.geo.GeoPointFieldDataType.load(GeoPointFieldDataType.java:55)\n        at org.elasticsearch.index.mapper.geo.GeoPointFieldDataType.load(GeoPointFieldDataType.java:34)\n        at org.elasticsearch.index.field.data.FieldData.load(FieldData.java:111)\n        at org.elasticsearch.index.cache.field.data.support.AbstractConcurrentMapFieldDataCache.cache(AbstractConcurrentMapFieldDataCache.java:130)\n        at org.elasticsearch.index.search.geo.GeoDistanceDataComparator.setNextReader(GeoDistanceDataComparator.java:131)\n        at org.apache.lucene.search.TopFieldCollector$OneComparatorNonScoringCollector.setNextReader(TopFieldCollector.java:95)\n        at org.apache.lucene.search.TimeLimitingCollector.setNextReader(TimeLimitingCollector.java:159)\n        at org.elasticsearch.common.lucene.MultiCollector.setNextReader(MultiCollector.java:65)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:576)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:190)\n        at org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:149)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:487)\n        at org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:400)\n        at org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:176)\n        at org.elasticsearch.search.SearchService.executeQueryPhase(SearchService.java:242)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:529)\n        at org.elasticsearch.search.action.SearchServiceTransportAction$SearchQueryTransportHandler.messageReceived(SearchServiceTransportAction.java:518)\n        at org.elasticsearch.transport.netty.MessageChannelHandler$RequestHandler.run(MessageChannelHandler.java:268)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n        at java.lang.Thread.run(Thread.java:722)\n```\n\nFollowing OOM\n\n```\n[2013-01-09 14:47:01,502][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [type] caused out of memory failure\njava.lang.OutOfMemoryError: Java heap space\n[2013-01-09 14:47:11,775][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [location] caused out of memory failure\njava.lang.OutOfMemoryError: Java heap space\n[2013-01-09 14:47:14,307][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [type] caused out of memory failure\njava.lang.OutOfMemoryError: Java heap space\n[2013-01-09 14:47:14,319][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [location] caused out of memory failure\njava.lang.OutOfMemoryError: Java heap space\n[2013-01-09 14:47:19,537][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [location] caused out of memory failure\njava.lang.OutOfMemoryError: Java heap space\n[2013-01-09 14:47:26,766][WARN ][index.cache.field.data.resident] [es37b] [index] loading field [location] caused out of memory failure\n```\n\nAfter restart\n\n```\njava.lang.OutOfMemoryError: Java heap space\n[2013-01-09 14:51:14,673][INFO ][node                     ] [es37b] {0.20.1}[26945]: stopping ...\n[2013-01-09 14:51:36,310][INFO ][node                     ] [es37b] {0.20.1}[28200]: initializing ...\n[2013-01-09 14:51:36,315][INFO ][plugins                  ] [es37b] loaded [], sites []\n[2013-01-09 14:51:38,440][INFO ][node                     ] [es37b] {0.20.1}[28200]: initialized\n[2013-01-09 14:51:38,440][INFO ][node                     ] [es37b] {0.20.1}[28200]: starting ...\n[2013-01-09 14:51:38,525][INFO ][transport                ] [es37b] bound_address {inet[/0:0:0:0:0:0:0:0:9300]}, publish_address {inet[/10.1.16.57:9300]}\n[2013-01-09 14:51:42,438][WARN ][discovery.zen.ping.unicast] [es37b] failed to send ping to [[#zen_unicast_15#][inet[es23b/10.1.16.103:9300]]]\norg.elasticsearch.transport.ReceiveTimeoutTransportException: [][inet[es23b/10.1.16.103:9300]][discovery/zen/unicast] request_id [12] timed out after [3750ms]\n        at org.elasticsearch.transport.TransportService$TimeoutHandler.run(TransportService.java:342)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)\n        at java.lang.Thread.run(Thread.java:722)\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}