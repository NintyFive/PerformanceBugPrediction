{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/57847","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57847/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57847/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/57847/events","html_url":"https://github.com/elastic/elasticsearch/issues/57847","id":634951101,"node_id":"MDU6SXNzdWU2MzQ5NTExMDE=","number":57847,"title":"ES crashes with OOM error when running fine-grained geotile_grid aggs on geo_shape","user":{"login":"thomasneirynck","id":1833023,"node_id":"MDQ6VXNlcjE4MzMwMjM=","avatar_url":"https://avatars2.githubusercontent.com/u/1833023?v=4","gravatar_id":"","url":"https://api.github.com/users/thomasneirynck","html_url":"https://github.com/thomasneirynck","followers_url":"https://api.github.com/users/thomasneirynck/followers","following_url":"https://api.github.com/users/thomasneirynck/following{/other_user}","gists_url":"https://api.github.com/users/thomasneirynck/gists{/gist_id}","starred_url":"https://api.github.com/users/thomasneirynck/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/thomasneirynck/subscriptions","organizations_url":"https://api.github.com/users/thomasneirynck/orgs","repos_url":"https://api.github.com/users/thomasneirynck/repos","events_url":"https://api.github.com/users/thomasneirynck/events{/privacy}","received_events_url":"https://api.github.com/users/thomasneirynck/received_events","type":"User","site_admin":false},"labels":[{"id":141079527,"node_id":"MDU6TGFiZWwxNDEwNzk1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Analytics/Geo","name":":Analytics/Geo","color":"0e8a16","default":false,"description":"Indexing, search aggregations of geo points and shapes"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967499105,"node_id":"MDU6TGFiZWwxOTY3NDk5MTA1","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Analytics","name":"Team:Analytics","color":"fef2c0","default":false,"description":"Meta label for analytics/geo team"}],"state":"closed","locked":false,"assignee":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"assignees":[{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false}],"milestone":null,"comments":1,"created_at":"2020-06-08T21:36:35Z","updated_at":"2020-07-16T23:14:35Z","closed_at":"2020-07-16T23:14:35Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch crashes when running a fine-grained geotile_grid-agg on a geo_shape.\r\n\r\nThis seems to occur when zooming in on an area _inside_ a large shape.\r\n\r\ne.g.\r\n1) Index the world-countries file from EMS: https://maps.elastic.co/v7.7/index.html#file/world_countries\r\n2) The mapping would be something like:\r\n```\r\n{\r\n   \"world_countries_v1\":{\r\n      \"mappings\":{\r\n         \"properties\":{\r\n            \"coordinates\":{\r\n               \"type\":\"geo_shape\"\r\n            },\r\n            \"iso2\":{\r\n               \"type\":\"text\",\r\n               \"fields\":{\r\n                  \"keyword\":{\r\n                     \"type\":\"keyword\",\r\n                     \"ignore_above\":256\r\n                  }\r\n               }\r\n            },\r\n            \"iso3\":{\r\n               \"type\":\"text\",\r\n               \"fields\":{\r\n                  \"keyword\":{\r\n                     \"type\":\"keyword\",\r\n                     \"ignore_above\":256\r\n                  }\r\n               }\r\n            },\r\n            \"name\":{\r\n               \"type\":\"text\",\r\n               \"fields\":{\r\n                  \"keyword\":{\r\n                     \"type\":\"keyword\",\r\n                     \"ignore_above\":256\r\n                  }\r\n               }\r\n            }\r\n         }\r\n      }\r\n   }\r\n}\r\n```\r\n\r\n\r\n3) Issue following query\r\n```\r\n{\r\n  \"size\": 0,\r\n  \"aggs\": {\r\n    \"gridSplit\": {\r\n      \"geotile_grid\": {\r\n        \"bounds\": {\r\n          \"top_left\": [\r\n            -117.514295,\r\n            44.54603\r\n          ],\r\n          \"bottom_right\": [\r\n            -91.48767500000002,\r\n            36.42819\r\n          ]\r\n        },\r\n        \"field\": \"coordinates\",\r\n        \"precision\": 11\r\n      },\r\n      \"aggs\": {\r\n        \"gridCentroid\": {\r\n          \"geo_centroid\": {\r\n            \"field\": \"coordinates\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  },\r\n  \"stored_fields\": [\r\n    \"*\"\r\n  ],\r\n  \"script_fields\": {},\r\n  \"docvalue_fields\": [],\r\n  \"_source\": {\r\n    \"excludes\": []\r\n  },\r\n  \"query\": {\r\n    \"bool\": {\r\n      \"must\": [],\r\n      \"filter\": [\r\n        {\r\n          \"match_all\": {}\r\n        },\r\n        {\r\n          \"geo_shape\": {\r\n            \"coordinates\": {\r\n              \"shape\": {\r\n                \"type\": \"Polygon\",\r\n                \"coordinates\": [\r\n                  [\r\n                    [\r\n                      -117.59766,\r\n                      44.59047\r\n                    ],\r\n                    [\r\n                      -117.59766,\r\n                      36.31513\r\n                    ],\r\n                    [\r\n                      -91.40625,\r\n                      36.31513\r\n                    ],\r\n                    [\r\n                      -91.40625,\r\n                      44.59047\r\n                    ],\r\n                    [\r\n                      -117.59766,\r\n                      44.59047\r\n                    ]\r\n                  ]\r\n                ]\r\n              },\r\n              \"relation\": \"INTERSECTS\"\r\n            }\r\n          }\r\n        }\r\n      ],\r\n      \"should\": [],\r\n      \"must_not\": []\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nElasticzearch crashes with:\r\n\r\n```\r\n[2020-06-08T17:33:47,532][ERROR][o.e.b.ElasticsearchUncaughtExceptionHandler] [Thomass-MBP.attlocal.net] fatal error in thread [elasticsearch[Thomass-MBP.attlocal.net][search][T#9]], exiting\r\njava.lang.OutOfMemoryError: Java heap space\r\n\tat org.apache.lucene.util.ArrayUtil.growExact(ArrayUtil.java:323) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.apache.lucene.util.ArrayUtil.grow(ArrayUtil.java:332) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.elasticsearch.index.fielddata.SortingNumericDocValues.resize(SortingNumericDocValues.java:62) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoShapeCellValues.resizeCell(GeoShapeCellValues.java:54) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:123) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValues(GeoTileGridTiler.java:69) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoShapeCellValues.advanceValue(GeoShapeCellValues.java:70) ~[?:?]\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoShapeCellValues.advanceExact(GeoShapeCellValues.java:34) ~[?:?]\r\n\tat org.elasticsearch.search.aggregations.bucket.geogrid.GeoGridAggregator$1.collect(GeoGridAggregator.java:78) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.aggregations.LeafBucketCollector.collect(LeafBucketCollector.java:107) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.apache.lucene.search.MultiCollector$MultiLeafCollector.collect(MultiCollector.java:188) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreRange(Weight.java:242) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:229) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.elasticsearch.search.internal.CancellableBulkScorer.score(CancellableBulkScorer.java:56) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.searchLeaf(ContextIndexSearcher.java:213) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:186) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:445) ~[lucene-core-8.6.0-snapshot-9d6c738ffce.jar:8.6.0-snapshot-9d6c738ffce 9d6c738ffce0c3164691f161ba8b92a615b1e062 - jenkins - 2020-05-20 09:52:47]\r\n\tat org.elasticsearch.search.query.QueryPhase.searchWithCollector(QueryPhase.java:348) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.query.QueryPhase.executeInternal(QueryPhase.java:299) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:151) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.indices.IndicesService.lambda$loadIntoContext$22(IndicesService.java:1382) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.indices.IndicesService$$Lambda$5361/0x0000000801b16840.accept(Unknown Source) ~[?:?]\r\n\tat org.elasticsearch.indices.IndicesService.lambda$cacheShardLevelResult$23(IndicesService.java:1434) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.indices.IndicesService$$Lambda$5363/0x0000000801b16040.get(Unknown Source) ~[?:?]\r\n\tat org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:178) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:161) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\n\tat org.elasticsearch.common.cache.Cache.computeIfAbsent(Cache.java:434) ~[elasticsearch-8.0.0-SNAPSHOT.jar:8.0.0-SNAPSHOT]\r\nfatal error in thread [elasticsearch[Thomass-MBP.attlocal.net][search][T#9]], exiting\r\njava.lang.OutOfMemoryError: Java heap space\r\n\tat org.apache.lucene.util.ArrayUtil.growExact(ArrayUtil.java:323)\r\n\tat org.apache.lucene.util.ArrayUtil.grow(ArrayUtil.java:332)\r\n\tat org.elasticsearch.index.fielddata.SortingNumericDocValues.resize(SortingNumericDocValues.java:62)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoShapeCellValues.resizeCell(GeoShapeCellValues.java:54)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:123)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValuesByRasterization(GeoTileGridTiler.java:131)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoTileGridTiler.setValues(GeoTileGridTiler.java:69)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoShapeCellValues.advanceValue(GeoShapeCellValues.java:70)\r\n\tat org.elasticsearch.xpack.spatial.search.aggregations.bucket.geogrid.GeoShapeCellValues.advanceExact(GeoShapeCellValues.java:34)\r\n\tat org.elasticsearch.search.aggregations.bucket.geogrid.GeoGridAggregator$1.collect(GeoGridAggregator.java:78)\r\n\tat org.elasticsearch.search.aggregations.LeafBucketCollector.collect(LeafBucketCollector.java:107)\r\n\tat org.apache.lucene.search.MultiCollector$MultiLeafCollector.collect(MultiCollector.java:188)\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.scoreRange(Weight.java:242)\r\n\tat org.apache.lucene.search.Weight$DefaultBulkScorer.score(Weight.java:229)\r\n\tat org.elasticsearch.search.internal.CancellableBulkScorer.score(CancellableBulkScorer.java:56)\r\n\tat org.apache.lucene.search.BulkScorer.score(BulkScorer.java:39)\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.searchLeaf(ContextIndexSearcher.java:213)\r\n\tat org.elasticsearch.search.internal.ContextIndexSearcher.search(ContextIndexSearcher.java:186)\r\n\tat org.apache.lucene.search.IndexSearcher.search(IndexSearcher.java:445)\r\n\tat org.elasticsearch.search.query.QueryPhase.searchWithCollector(QueryPhase.java:348)\r\n\tat org.elasticsearch.search.query.QueryPhase.executeInternal(QueryPhase.java:299)\r\n\tat org.elasticsearch.search.query.QueryPhase.execute(QueryPhase.java:151)\r\n\tat org.elasticsearch.indices.IndicesService.lambda$loadIntoContext$22(IndicesService.java:1382)\r\n\tat org.elasticsearch.indices.IndicesService$$Lambda$5361/0x0000000801b16840.accept(Unknown Source)\r\n\tat org.elasticsearch.indices.IndicesService.lambda$cacheShardLevelResult$23(IndicesService.java:1434)\r\n\tat org.elasticsearch.indices.IndicesService$$Lambda$5363/0x0000000801b16040.get(Unknown Source)\r\n\tat org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:178)\r\n\tat org.elasticsearch.indices.IndicesRequestCache$Loader.load(IndicesRequestCache.java:161)\r\n```\r\n\r\n\r\ncc @talevy @nknize \r\n","closed_by":{"login":"talevy","id":388837,"node_id":"MDQ6VXNlcjM4ODgzNw==","avatar_url":"https://avatars0.githubusercontent.com/u/388837?v=4","gravatar_id":"","url":"https://api.github.com/users/talevy","html_url":"https://github.com/talevy","followers_url":"https://api.github.com/users/talevy/followers","following_url":"https://api.github.com/users/talevy/following{/other_user}","gists_url":"https://api.github.com/users/talevy/gists{/gist_id}","starred_url":"https://api.github.com/users/talevy/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/talevy/subscriptions","organizations_url":"https://api.github.com/users/talevy/orgs","repos_url":"https://api.github.com/users/talevy/repos","events_url":"https://api.github.com/users/talevy/events{/privacy}","received_events_url":"https://api.github.com/users/talevy/received_events","type":"User","site_admin":false},"performed_via_github_app":null}