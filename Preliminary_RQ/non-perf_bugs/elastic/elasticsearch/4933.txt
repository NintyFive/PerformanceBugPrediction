{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/4933","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4933/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4933/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/4933/events","html_url":"https://github.com/elastic/elasticsearch/issues/4933","id":26481714,"node_id":"MDU6SXNzdWUyNjQ4MTcxNA==","number":4933,"title":"Node fails to shutdown cleanly","user":{"login":"djdaugherty612","id":3579432,"node_id":"MDQ6VXNlcjM1Nzk0MzI=","avatar_url":"https://avatars1.githubusercontent.com/u/3579432?v=4","gravatar_id":"","url":"https://api.github.com/users/djdaugherty612","html_url":"https://github.com/djdaugherty612","followers_url":"https://api.github.com/users/djdaugherty612/followers","following_url":"https://api.github.com/users/djdaugherty612/following{/other_user}","gists_url":"https://api.github.com/users/djdaugherty612/gists{/gist_id}","starred_url":"https://api.github.com/users/djdaugherty612/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/djdaugherty612/subscriptions","organizations_url":"https://api.github.com/users/djdaugherty612/orgs","repos_url":"https://api.github.com/users/djdaugherty612/repos","events_url":"https://api.github.com/users/djdaugherty612/events{/privacy}","received_events_url":"https://api.github.com/users/djdaugherty612/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2014-01-28T22:20:38Z","updated_at":"2014-02-03T17:29:25Z","closed_at":"2014-02-03T17:29:25Z","author_association":"NONE","active_lock_reason":null,"body":"Trying to shutdown two data nodes (search-05-a and -b) of 12 within our cluster resulted in the cluster going into a strange state.  The node stats api wouldn't work and nothing was being indexed despite the cluster status being yellow.  We are running 0.90.7.  Shutting down the cluster fixed the problem but I had to kill -9 search-05-a.  A and B nodes are on the same host but we have rack awareness set up so ES does not place both primary and replica shards on the same host. \n\n-drew\n\nFrom the master log:\n[2014-01-28 13:35:58,333][INFO ][action.admin.cluster.node.shutdown] [search-m00] [partial_cluster_shutdown]: requested, shutting down [[YBVVeR6MQIOlLVqr8B9rQg]] in [1s]\n[2014-01-28 13:35:59,338][INFO ][action.admin.cluster.node.shutdown] [search-m00] [partial_cluster_shutdown]: done shutting down [[YBVVeR6MQIOlLVqr8B9rQg]]\n[2014-01-28 13:36:01,967][ERROR][discovery.zen            ] [search-m00] unexpected failure during [zen-disco-node_left([search-05-a][YBVVeR6MQIOlLVqr8B9rQg][inet[/10.2.34.50:9300]]{host=search-05, master=\nfalse})]\njava.lang.UnsupportedOperationException\n        at org.elasticsearch.common.hppc.AbstractIterator.remove(AbstractIterator.java:58)\n        at org.elasticsearch.gateway.local.LocalGatewayAllocator.buildShardStates(LocalGatewayAllocator.java:373)\n        at org.elasticsearch.gateway.local.LocalGatewayAllocator.allocateUnassigned(LocalGatewayAllocator.java:124)\n        at org.elasticsearch.cluster.routing.allocation.allocator.ShardsAllocators.allocateUnassigned(ShardsAllocators.java:73)\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:204)\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:156)\n        at org.elasticsearch.discovery.zen.ZenDiscovery$3.execute(ZenDiscovery.java:382)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:298)\n        at org.elasticsearch.common.util.concurrent.PrioritizedEsThreadPoolExecutor$TieBreakingPrioritizedRunnable.run(PrioritizedEsThreadPoolExecutor.java:135)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:722)\n[2014-01-28 13:36:01,990][ERROR][discovery.zen            ] [search-m00] unexpected failure during [zen-disco-node_failed([search-05-a][YBVVeR6MQIOlLVqr8B9rQg][inet[10.2.34.50/10.2.34.50:9300]]{host=search-05, master=false}), reason transport disconnected (with verified connect)]\njava.lang.UnsupportedOperationException\n        at org.elasticsearch.common.hppc.AbstractIterator.remove(AbstractIterator.java:58)\n        at org.elasticsearch.gateway.local.LocalGatewayAllocator.buildShardStates(LocalGatewayAllocator.java:373)\n        at org.elasticsearch.gateway.local.LocalGatewayAllocator.allocateUnassigned(LocalGatewayAllocator.java:124)\n        at org.elasticsearch.cluster.routing.allocation.allocator.ShardsAllocators.allocateUnassigned(ShardsAllocators.java:73)\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:204)\n        at org.elasticsearch.cluster.routing.allocation.AllocationService.reroute(AllocationService.java:156)\n        at org.elasticsearch.discovery.zen.ZenDiscovery$4.execute(ZenDiscovery.java:417)\n        at org.elasticsearch.cluster.service.InternalClusterService$UpdateTask.run(InternalClusterService.java:298)\n\nFrom the search-05 log:\n\n[2014-01-28 14:36:17,556][WARN ][indices.cluster          ] [search-05-a] [messages_20140125][2] failed to start shard\norg.elasticsearch.index.gateway.IndexShardGatewayRecoveryException: [messages_20140125][2] failed to fetch index version after copying it over\n        at org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:136)\n        at org.elasticsearch.index.gateway.IndexShardGatewayService$1.run(IndexShardGatewayService.java:174)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:722)\nCaused by: org.elasticsearch.index.gateway.IndexShardGatewayRecoveryException: [messages_20140125][2] shard allocated for local recovery (post api), should exist, but doesn't, current files: [_44f.fdt, _49p_es090_0.doc, _3b9_es090_0.pay, _1vb_es090_0.pay, _3uz_es090_0.pos, _48l_8.del, _3eo.nvm, _3b9.nvd, _4bz.fnm, _41d.fnm, _4c7_es090_0.pos, _41d.fdx, _3rc.nvd, _3uz.nvm, _3uz.fdt, _3eo_es090_0.tim, segments_ah, _4aa.nvm, _48l.nvd, _44f_es090_0.doc, _3eo.fnm, _4c3.cfs, _44f_es090_0.pos, _3b9.fdt, _4bd.fdx, _44f_7.del, _3uz.nvd, _3o9.nvm, _3rc.fnm, _462_3.del, _4bd_es090_0.blm, _48l_es090_0.blm, _3eo_es090_0.pay, _44f.fdx, _4aa_es090_0.tim, _4bz_1.del, _462.cfs, _3uz_es090_0.tim, _4bz.nvd, _4bd_es090_0.doc, _4bh.cfe, _49p.fnm, _41d_es090_0.pos, _3rc.nvm, _4bh.si, _3o9_es090_0.doc, _3rc_es090_0.blm, _49p.nvd, _3b9_1d.del, _44f.nvm, segments.gen, _4bd_3.del, _4c7.nvd, _4b7.cfs, _3l5.si, _44f_es090_0.tip, _3b9_es090_0.tim, _3b9.fdx, _4c7_es090_0.pay, _3rc.fdx, _4c3.cfe, _3rc_es090_0.pay, _44f.fnm, _4c0_2.del, _4bz_es090_0.pay, _3l5_es090_0.doc, _3b9.fnm, _49p.nvm, _49p_es090_0.blm, _4c0.si, _41d.fdt, _1vb.nvm, _4bz_es090_0.tim, _4b7_2.del, _48l.si, _48l_es090_0.tim, _3l5_es090_0.pos, _4bz_es090_0.blm, _3l5.nvd, _4bd.nvm, _4au.si, _4au_3.del, _4aa_es090_0.doc, _4bh.cfs, _49p_2.del, _1vb_es090_0.blm, _3rc.si, _4bz_es090_0.tip, _4bz_es090_0.doc, _41d.nvm, _3b9_es090_0.tip, _3uz_es090_0.blm, _3l5.fdx, _4c7.nvm, _4ax_4.del, _1vb_es090_0.pos, _4ad.cfs, _4bd.fnm, _49p_es090_0.tim, _3l5_es090_0.tim, _48l.fdx, _3rc_es090_0.doc, _41d_es090_0.tip, _3uz_es090_0.tip, _4aa_es090_0.tip, _3rc_es090_0.tip, _4c7_es090_0.doc, _3o9_l.del, _4aa.si, _3eo.fdx, _3o9.fdx, _3eo_es090_0.doc, _48l.fdt, _49p.si, _46i.cfe, _4b7.si, _3o9_es090_0.pay, _4ad_4.del, _3rc_es090_0.pos, _41d_i.del, _44f.nvd, _1vb_21.del, _49p_es090_0.pos, _4bz.fdx, _4c0.cfe, _3uz_es090_0.pay, _3l5_es090_0.pay, _41d_es090_0.blm, _41d_es090_0.tim, _4aa.fdx, _4bz.nvm, _4bd_es090_0.tim, _4ad.si, _4bd_es090_0.pay, _3b9_es090_0.blm, _3l5.fnm, _4aa.nvd, _48l.fnm, _3rc.fdt, _48l_es090_0.pos, _3eo_es090_0.blm, _4bz.fdt, _3b9.nvm, _3b9_es090_0.doc, _4b7.cfe, _4aa_es090_0.pay, _4ax.cfs, _1vb.nvd, _4aa_5.del, _41d_es090_0.doc, _48l_es090_0.doc, _3o9_es090_0.blm, _3b9.si, _3rc_r.del, _41d.nvd, _3uz_c.del, _44f_es090_0.blm, _3uz.fdx, _41d.si, _4bd_es090_0.pos, _3eo_es090_0.pos, _3o9.fdt, _4aa.fdt, _46i.cfs, _4bz_es090_0.pos, _3eo.si, _48l.nvm, _44f_es090_0.pay, _3uz.si, _49p.fdt, _48l_es090_0.tip, _4c3.si, _46i.si, _3eo_es090_0.tip, _4aa.fnm, _4c7_es090_0.tip, _44f_es090_0.tim, _4bd.si, _4c0.cfs, _3eo_z.del, _1vb.fdt, _4c7.fdx, _3l5_es090_0.tip, _3o9.nvd, _3eo.nvd, _49p.fdx]\n        at org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:115)\n        ... 4 more\nCaused by: java.io.FileNotFoundException: _1vb.si\n        at org.elasticsearch.index.store.Store$StoreDirectory.openInput(Store.java:456)\n        at org.apache.lucene.codecs.lucene40.Lucene40SegmentInfoReader.read(Lucene40SegmentInfoReader.java:50)\n        at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:334)\n        at org.apache.lucene.index.SegmentInfos$1.doBody(SegmentInfos.java:380)\n        at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:812)\n        at org.apache.lucene.index.SegmentInfos$FindSegmentsFile.run(SegmentInfos.java:663)\n        at org.apache.lucene.index.SegmentInfos.read(SegmentInfos.java:376)\n        at org.elasticsearch.common.lucene.Lucene.readSegmentInfos(Lucene.java:111)\n        at org.elasticsearch.index.gateway.local.LocalIndexShardGateway.recover(LocalIndexShardGateway.java:106)\n        ... 4 more\n[2014-01-28 14:36:17,910][WARN ][cluster.action.shard     ] [search-05-a] [messages_20140125][2] sending failed shard for [messages_20140125][2], node[N-3a4USES9GRcRVtH1tTOA], [P], s[INITIALIZING], indexUUID [wR7FwxEFSnCc_75FfGa39Q], reason [Failed to start shard, message [IndexShardGatewayRecoveryException[[messages_20140125][2] failed to fetch index version after copying it over]; nested: IndexShardGatewayRecoveryException[[messages_20140125][2] shard allocated for local recovery (post api), should exist, but doesn't, current files: [_44f.fdt, _49p_es090_0.doc, _3b9_es090_0.pay, _1vb_es090_0.pay, _3uz_es090_0.pos, _48l_8.del, _3eo.nvm, _3b9.nvd, _4bz.fnm, _41d.fnm, _4c7_es090_0.pos, _41d.fdx, _3rc.nvd, _3uz.nvm, _3uz.fdt, _3eo_es090_0.tim, segments_ah, _4aa.nvm, _48l.nvd, _44f_es090_0.doc, _3eo.fnm, _4c3.cfs, _44f_es090_0.pos, _3b9.fdt, _4bd.fdx, _44f_7.del, _3uz.nvd, _3o9.nvm, _3rc.fnm, _462_3.del, _4bd_es090_0.blm, _48l_es090_0.blm, _3eo_es090_0.pay, _44f.fdx, _4aa_es090_0.tim, _4bz_1.del, _462.cfs, _3uz_es090_0.tim, _4bz.nvd, _4bd_es090_0.doc, _4bh.cfe, _49p.fnm, _41d_es090_0.pos, _3rc.nvm, _4bh.si, _3o9_es090_0.doc, _3rc_es090_0.blm, _49p.nvd, _3b9_1d.del, _44f.nvm, segments.gen, _4bd_3.del, _4c7.nvd, _4b7.cfs, _3l5.si, _44f_es090_0.tip, _3b9_es090_0.tim, _3b9.fdx, _4c7_es090_0.pay, _3rc.fdx, _4c3.cfe, _3rc_es090_0.pay, _44f.fnm, _4c0_2.del, _4bz_es090_0.pay, _3l5_es090_0.doc, _3b9.fnm, _49p.nvm, _49p_es090_0.blm, _4c0.si, _41d.fdt, _1vb.nvm, _4bz_es090_0.tim, _4b7_2.del, _48l.si, _48l_es090_0.tim, _3l5_es090_0.pos, _4bz_es090_0.blm, _3l5.nvd, _4bd.nvm, _4au.si, _4au_3.del, _4aa_es090_0.doc, _4bh.cfs, _49p_2.del, _1vb_es090_0.blm, _3rc.si, _4bz_es090_0.tip, _4bz_es090_0.doc, _41d.nvm, _3b9_es090_0.tip, _3uz_es090_0.blm, _3l5.fdx, _4c7.nvm, _4ax_4.del, _1vb_es090_0.pos, _4ad.cfs, _4bd.fnm, _49p_es090_0.tim, _3l5_es090_0.tim, _48l.fdx, _3rc_es090_0.doc, _41d_es090_0.tip, _3uz_es090_0.tip, _4aa_es090_0.tip, _3rc_es090_0.tip, _4c7_es090_0.doc, _3o9_l.del, _4aa.si, _3eo.fdx, _3o9.fdx, _3eo_es090_0.doc, _48l.fdt, _49p.si, _46i.cfe, _4b7.si, _3o9_es090_0.pay, _4ad_4.del, _3rc_es090_0.pos, _41d_i.del, _44f.nvd, _1vb_21.del, _49p_es090_0.pos, _4bz.fdx, _4c0.cfe, _3uz_es090_0.pay, _3l5_es090_0.pay, _41d_es090_0.blm, _41d_es090_0.tim, _4aa.fdx, _4bz.nvm, _4bd_es090_0.tim, _4ad.si, _4bd_es090_0.pay, _3b9_es090_0.blm, _3l5.fnm, _4aa.nvd, _48l.fnm, _3rc.fdt, _48l_es090_0.pos, _3eo_es090_0.blm, _4bz.fdt, _3b9.nvm, _3b9_es090_0.doc, _4b7.cfe, _4aa_es090_0.pay, _4ax.cfs, _1vb.nvd, _4aa_5.del, _41d_es090_0.doc, _48l_es090_0.doc, _3o9_es090_0.blm, _3b9.si, _3rc_r.del, _41d.nvd, _3uz_c.del, _44f_es090_0.blm, _3uz.fdx, _41d.si, _4bd_es090_0.pos, _3eo_es090_0.pos, _3o9.fdt, _4aa.fdt, _46i.cfs, _4bz_es090_0.pos, _3eo.si, _48l.nvm, _44f_es090_0.pay, _3uz.si, _49p.fdt, _48l_es090_0.tip, _4c3.si, _46i.si, _3eo_es090_0.tip, _4aa.fnm, _4c7_es090_0.tip, _44f_es090_0.tim, _4bd.si, _4c0.cfs, _3eo_z.del, _1vb.fdt, _4c7.fdx, _3l5_es090_0.tip, _3o9.nvd, _3eo.nvd, _49p.fdx]]; nested: FileNotFoundException[_1vb.si]; ]]\n","closed_by":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"performed_via_github_app":null}