[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/674128152","html_url":"https://github.com/elastic/elasticsearch/issues/61157#issuecomment-674128152","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157","id":674128152,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NDEyODE1Mg==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2020-08-14T15:24:56Z","updated_at":"2020-08-14T15:24:56Z","author_association":"COLLABORATOR","body":"Pinging @elastic/ml-core (:ml)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/674143895","html_url":"https://github.com/elastic/elasticsearch/issues/61157#issuecomment-674143895","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157","id":674143895,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NDE0Mzg5NQ==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-08-14T16:00:23Z","updated_at":"2020-08-14T16:02:27Z","author_association":"CONTRIBUTOR","body":"One way to insure against suffering this problem at all is to manually adjust the mappings that are required in 7.9.0 _before_ upgrading to 7.9.0 (it doesn't hurt to apply them to an earlier version):\r\n\r\n```\r\nPUT .ml-config/_mapping\r\n{\r\n  \"properties\": {\r\n    \"analysis_config\": {\r\n      \"properties\": {\r\n        \"per_partition_categorization\" : {\r\n          \"properties\" : {\r\n            \"enabled\" : {\r\n              \"type\" : \"boolean\"\r\n            },\r\n            \"stop_on_warn\" : {\r\n              \"type\" : \"boolean\"\r\n            }\r\n          }\r\n        }\r\n      }\r\n    },\r\n    \"max_num_threads\" : {\r\n      \"type\" : \"integer\"\r\n    },\r\n    \"model_plot_config\" : {\r\n      \"properties\" : {\r\n        \"annotations_enabled\" : {\r\n          \"type\" : \"boolean\"\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nYou'll need to be a `superuser` to do that - no other built in role lets you modify `.ml-config`.\r\n\r\nHowever, even this may fail, as the underlying problem has existed for a long time.  When upgrading to 7.8 it's possible that dynamic mappings were created that weren't catastrophically bad, but weren't what's in the ML template.  After that it will be impossible to ever apply the mappings from the ML template.  The only solution is reindexing, which I will describe in the next comment.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/674148880","html_url":"https://github.com/elastic/elasticsearch/issues/61157#issuecomment-674148880","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157","id":674148880,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NDE0ODg4MA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-08-14T16:11:30Z","updated_at":"2020-08-14T16:11:30Z","author_association":"CONTRIBUTOR","body":"If you end up with a `.ml-config` index that has the wrong mappings and is causing failures, the recovery process is to reindex.  However, because the ML code currently only works with a single concrete `.ml-config` index you need to reindex twice, once to a temporary index and then back to a recreated `.ml-config` index:\r\n\r\n1. Enable ML upgrade mode\r\n2. Create a new index, say `temp_ml_config` - it doesn't matter about settings or mappings for this index - defaults are fine\r\n3. Reindex `.ml-config` into `temp_ml_config`\r\n4. Delete the `.ml-config` index\r\n5. Recreate the `.ml-config` index with the setting `auto_expand_replicas: [0-1]` - the mappings will get picked up from the latest ML template, so don't set any mappings in the creation request\r\n6. Reindex `temp_ml_config` into `.ml-config`\r\n7. Disable ML upgrade mode\r\n8. Delete the `temp_ml_config` index\r\n\r\nYou'll need to be a `superuser` to do this - no other built in role lets you modify `.ml-config`.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/674212021","html_url":"https://github.com/elastic/elasticsearch/issues/61157#issuecomment-674212021","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157","id":674212021,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NDIxMjAyMQ==","user":{"login":"wwang500","id":47184485,"node_id":"MDQ6VXNlcjQ3MTg0NDg1","avatar_url":"https://avatars2.githubusercontent.com/u/47184485?v=4","gravatar_id":"","url":"https://api.github.com/users/wwang500","html_url":"https://github.com/wwang500","followers_url":"https://api.github.com/users/wwang500/followers","following_url":"https://api.github.com/users/wwang500/following{/other_user}","gists_url":"https://api.github.com/users/wwang500/gists{/gist_id}","starred_url":"https://api.github.com/users/wwang500/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/wwang500/subscriptions","organizations_url":"https://api.github.com/users/wwang500/orgs","repos_url":"https://api.github.com/users/wwang500/repos","events_url":"https://api.github.com/users/wwang500/events{/privacy}","received_events_url":"https://api.github.com/users/wwang500/received_events","type":"User","site_admin":false},"created_at":"2020-08-14T18:43:26Z","updated_at":"2020-08-14T18:43:26Z","author_association":"NONE","body":"> If you end up with a `.ml-config` index that has the wrong mappings and is causing failures, the recovery process is to reindex. However, because the ML code currently only works with a single concrete `.ml-config` index you need to reindex twice, once to a temporary index and then back to a recreated `.ml-config` index:\r\n> \r\n> 1. Enable ML upgrade mode\r\n> 2. Create a new index, say `temp_ml_config` - it doesn't matter about settings or mappings for this index - defaults are fine\r\n> 3. Reindex `.ml-config` into `temp_ml_config`\r\n> 4. Delete the `.ml-config` index\r\n> 5. Recreate the `.ml-config` index with the setting `auto_expand_replicas: [0-1]` - the mappings will get picked up from the latest ML template, so don't set any mappings in the creation request\r\n> 6. Reindex `temp_ml_config` into `.ml-config`\r\n> 7. Disable ML upgrade mode\r\n> 8. Delete the `temp_ml_config` index\r\n> \r\n> You'll need to be a `superuser` to do this - no other built in role lets you modify `.ml-config`.\r\n\r\nHere are the matching commands that can be executed in dev console:\r\n```\r\n#step 1\r\nPOST _ml/set_upgrade_mode?enabled=true&timeout=10m\r\n\r\n#step 2\r\nPUT temp_ml_config\r\n\r\n#step 3\r\nPOST _reindex\r\n{\r\n  \"source\": { \"index\": \".ml-config\" }, \r\n  \"dest\": { \"index\": \"temp_ml_config\" }\r\n}\r\n\r\n#step 4\r\nDELETE .ml-config\r\n\r\n#step 5\r\nPUT .ml-config\r\n{\r\n  \"settings\": { \"auto_expand_replicas\": \"0-1\"}\r\n}\r\n\r\n#step 6\r\nPOST _reindex\r\n{\r\n  \"source\": { \"index\": \"temp_ml_config\" }, \r\n  \"dest\": { \"index\": \".ml-config\" }\r\n}\r\n\r\n#step 7\r\nPOST _ml/set_upgrade_mode?enabled=false&timeout=10m\r\n\r\n#step 8\r\nDELETE temp_ml_config\r\n```\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/676227290","html_url":"https://github.com/elastic/elasticsearch/issues/61157#issuecomment-676227290","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/61157","id":676227290,"node_id":"MDEyOklzc3VlQ29tbWVudDY3NjIyNzI5MA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2020-08-19T11:57:34Z","updated_at":"2020-08-19T11:57:34Z","author_association":"CONTRIBUTOR","body":"The workarounds for 7.9.0 are now publicly documented in https://www.elastic.co/guide/en/machine-learning/7.9/ml-troubleshooting.html#ml-troubleshooting-mappings and anyone who skips 7.9.0 and upgrades to 7.9.1 or above should not suffer the issue due to #61064.","performed_via_github_app":null}]