{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7044","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7044/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7044/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7044/events","html_url":"https://github.com/elastic/elasticsearch/issues/7044","id":38767754,"node_id":"MDU6SXNzdWUzODc2Nzc1NA==","number":7044,"title":"elasticsearch can't resolve environment variables in elasticsearch.yml","user":{"login":"pgibler","id":119892,"node_id":"MDQ6VXNlcjExOTg5Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/119892?v=4","gravatar_id":"","url":"https://api.github.com/users/pgibler","html_url":"https://github.com/pgibler","followers_url":"https://api.github.com/users/pgibler/followers","following_url":"https://api.github.com/users/pgibler/following{/other_user}","gists_url":"https://api.github.com/users/pgibler/gists{/gist_id}","starred_url":"https://api.github.com/users/pgibler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgibler/subscriptions","organizations_url":"https://api.github.com/users/pgibler/orgs","repos_url":"https://api.github.com/users/pgibler/repos","events_url":"https://api.github.com/users/pgibler/events{/privacy}","received_events_url":"https://api.github.com/users/pgibler/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2014-07-25T20:35:27Z","updated_at":"2014-07-26T03:12:55Z","closed_at":"2014-07-26T03:12:55Z","author_association":"NONE","active_lock_reason":null,"body":"I have the following two settings in my elasticsearch.yml file. They are the only ones that pull from environment variables.\n\n```\ncloud.aws.access_key: ${AWS_ACCESS_KEY_ID}\ncloud.aws.secret_key: ${AWS_SECRET_KEY}\n```\n\nWhen I restart elasticsearch to load these from the environment, I get an error that it can't resolve them. I've tested it and it will not resolve either, so this error applies to both (it just fails on the bottom one first)\n\n```\n- IllegalArgumentException[Could not resolve placeholder 'AWS_SECRET_KEY']\n  java.lang.IllegalArgumentException: Could not resolve placeholder 'AWS_SECRET_KEY'\n  at org.elasticsearch.common.property.PropertyPlaceholder.parseStringValue(PropertyPlaceholder.java:124)\n  at org.elasticsearch.common.property.PropertyPlaceholder.replacePlaceholders(PropertyPlaceholder.java:81)\n  at org.elasticsearch.common.settings.ImmutableSettings$Builder.replacePropertyPlaceholders(ImmutableSettings.java:1060)\n  at org.elasticsearch.node.internal.InternalSettingsPreparer.prepareSettings(InternalSettingsPreparer.java:101)\n  at org.elasticsearch.bootstrap.Bootstrap.initialSettings(Bootstrap.java:106)\n  at org.elasticsearch.bootstrap.Bootstrap.main(Bootstrap.java:177)\n  at org.elasticsearch.bootstrap.Elasticsearch.main(Elasticsearch.java:32)\n\n```\n\nI did some investigating through elasticsearch's code repository on github and discovered this bit of code that pulls from the environment variables.\n\n[`ImmutableSettings.java#resolvePlaceholder` from elasticsearch@github](https://github.com/elasticsearch/elasticsearch/blob/04b412b5972a08a79989d82cc9d17842fe3c3e5a/src/main/java/org/elasticsearch/common/settings/ImmutableSettings.java#L1033-1047)\n\nNamely. the lines inside that function that _should_ be pulling from the environment variables are these one:\n\n[Code from `resolvePlaceholder` that pulls out environment variables](https://github.com/elasticsearch/elasticsearch/blob/04b412b5972a08a79989d82cc9d17842fe3c3e5a/src/main/java/org/elasticsearch/common/settings/ImmutableSettings.java#L1042-1045)\n\nHowever, after `resolvePlaceholder` is run from inside function [`PropertyPlaceholder#parseStringValue`](https://github.com/elasticsearch/elasticsearch/blob/master/src/main/java/org/elasticsearch/common/property/PropertyPlaceholder.java#L107-125), the `System.getenv` call must be returning null as that is the only way for that error to be thrown.\n\nI wrote a simple test program that is essentially a copy of `ImmutableSettings.java#resolvePlaceholder` to test that  `System.getenv` was pulling out the environment variables correctly on my system. This in fact returns the values I expect.\n\n```\npublic class TestingPlaceholders {\n  public static void main(String[] args) {\n    System.out.println(resolvePlaceholder(args[0]));\n  }\n  public static String resolvePlaceholder(String placeholderName) {\n    if (placeholderName.startsWith(\"env.\")) {\n      // explicit env var prefix\n      System.out.println(\"1: placeholderName.startsWith(\\\"env.\\\")\");\n      return System.getenv(placeholderName.substring(\"env.\".length()));\n    }\n    String value = System.getProperty(placeholderName);\n    if (value != null) {\n      System.out.println(\"2: System.getProperty\");\n      return value;\n    }\n    value = System.getenv(placeholderName);\n    if (value != null) {\n      System.out.println(\"3: System.getenv\");\n      return value;\n    }\n    return \"Map should've had it\";\n  }\n}\n```\n\nWhen run, this is the output, showing we are getting the set environment variables (keys hidden for obvious reasons):\n\n```\n[ec2-user@ip-172-31-34-195 ~]$ java TestingPlaceholders AWS_SECRET_KEY\n3: System.getenv\nXXXXXXXXXXXXXXXXXX\n[ec2-user@ip-172-31-34-195 ~]$ java TestingPlaceholders AWS_ACCESS_KEY_ID\n3: System.getenv\nXXXXXXXXXXXXXXXXXX\n```\n\nWhat is it about elasticsearch that isn't able to parse my environment variables from `elasticsearch.yml`? I've done quite a bit of digging at this point but I'm sure there is a simple solution around the corner. Any help would be very much appreciated.\n","closed_by":{"login":"pgibler","id":119892,"node_id":"MDQ6VXNlcjExOTg5Mg==","avatar_url":"https://avatars2.githubusercontent.com/u/119892?v=4","gravatar_id":"","url":"https://api.github.com/users/pgibler","html_url":"https://github.com/pgibler","followers_url":"https://api.github.com/users/pgibler/followers","following_url":"https://api.github.com/users/pgibler/following{/other_user}","gists_url":"https://api.github.com/users/pgibler/gists{/gist_id}","starred_url":"https://api.github.com/users/pgibler/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pgibler/subscriptions","organizations_url":"https://api.github.com/users/pgibler/orgs","repos_url":"https://api.github.com/users/pgibler/repos","events_url":"https://api.github.com/users/pgibler/events{/privacy}","received_events_url":"https://api.github.com/users/pgibler/received_events","type":"User","site_admin":false},"performed_via_github_app":null}