[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500759624","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-500759624","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":500759624,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDc1OTYyNA==","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"created_at":"2019-06-11T09:18:20Z","updated_at":"2019-06-11T09:18:20Z","author_association":"COLLABORATOR","body":"Pinging @elastic/es-distributed","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500764889","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-500764889","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":500764889,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDc2NDg4OQ==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-11T09:33:03Z","updated_at":"2019-06-11T09:33:03Z","author_association":"CONTRIBUTOR","body":"I increased test logging in c077f8c3c48","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/500841724","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-500841724","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":500841724,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMDg0MTcyNA==","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"created_at":"2019-06-11T13:30:21Z","updated_at":"2019-06-11T13:30:21Z","author_association":"CONTRIBUTOR","body":"A similar failure occurred in a 6.8 build: https://elasticsearch-ci.elastic.co/job/elastic+elasticsearch+6.8+multijob-unix-compatibility/os=fedora-29&&immutable/27/console\r\n\r\n```\r\njava.lang.AssertionError: \r\nExpected: <3>\r\n     but: was <0>\r\n\tat __randomizedtesting.SeedInfo.seed([9A7AF184FEA205C6:44B4F7CF3DDD1CC1]:0)\r\n\tat org.hamcrest.MatcherAssert.assertThat(MatcherAssert.java:20)\r\n\tat org.junit.Assert.assertThat(Assert.java:956)\r\n\tat org.junit.Assert.assertThat(Assert.java:923)\r\n\tat org.elasticsearch.indices.flush.FlushIT.testSyncedFlushSkipOutOfSyncReplicas(FlushIT.java:304)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)\r\n\tat sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:62)\r\n\tat sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:43)\r\n\tat java.lang.reflect.Method.invoke(Method.java:498)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.invoke(RandomizedRunner.java:1750)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$8.evaluate(RandomizedRunner.java:938)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$9.evaluate(RandomizedRunner.java:974)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$10.evaluate(RandomizedRunner.java:988)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat org.apache.lucene.util.TestRuleSetupTeardownChained$1.evaluate(TestRuleSetupTeardownChained.java:49)\r\n\tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\r\n\tat org.apache.lucene.util.TestRuleThreadAndTestName$1.evaluate(TestRuleThreadAndTestName.java:48)\r\n\tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\r\n\tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:368)\r\n\tat com.carrotsearch.randomizedtesting.ThreadLeakControl.forkTimeoutingTask(ThreadLeakControl.java:817)\r\n\tat com.carrotsearch.randomizedtesting.ThreadLeakControl$3.evaluate(ThreadLeakControl.java:468)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner.runSingleTest(RandomizedRunner.java:947)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$5.evaluate(RandomizedRunner.java:832)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$6.evaluate(RandomizedRunner.java:883)\r\n\tat com.carrotsearch.randomizedtesting.RandomizedRunner$7.evaluate(RandomizedRunner.java:894)\r\n\tat org.apache.lucene.util.AbstractBeforeAfterRule$1.evaluate(AbstractBeforeAfterRule.java:45)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat org.apache.lucene.util.TestRuleStoreClassName$1.evaluate(TestRuleStoreClassName.java:41)\r\n\tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\r\n\tat com.carrotsearch.randomizedtesting.rules.NoShadowingOrOverridesOnMethodsRule$1.evaluate(NoShadowingOrOverridesOnMethodsRule.java:40)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat org.apache.lucene.util.TestRuleAssertionsRequired$1.evaluate(TestRuleAssertionsRequired.java:53)\r\n\tat org.apache.lucene.util.TestRuleMarkFailure$1.evaluate(TestRuleMarkFailure.java:47)\r\n\tat org.apache.lucene.util.TestRuleIgnoreAfterMaxFailures$1.evaluate(TestRuleIgnoreAfterMaxFailures.java:64)\r\n\tat org.apache.lucene.util.TestRuleIgnoreTestSuites$1.evaluate(TestRuleIgnoreTestSuites.java:54)\r\n\tat com.carrotsearch.randomizedtesting.rules.StatementAdapter.evaluate(StatementAdapter.java:36)\r\n\tat com.carrotsearch.randomizedtesting.ThreadLeakControl$StatementRunner.run(ThreadLeakControl.java:368)\r\n\tat java.lang.Thread.run(Thread.java:748)\r\n```\r\n\r\nThe repro command was:\r\n\r\n```\r\n./gradlew :server:integTest -Dtests.seed=9A7AF184FEA205C6 -Dtests.class=org.elasticsearch.indices.flush.FlushIT -Dtests.method=\"testSyncedFlushSkipOutOfSyncReplicas\" -Dtests.security.manager=true -Dtests.locale=ar-LY -Dtests.timezone=America/Juneau -Dcompiler.java=12 -Druntime.java=8\r\n```\r\n\r\nThis didn't reproduce locally on my 6.8 branch.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501214375","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-501214375","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":501214375,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTIxNDM3NQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T10:28:34Z","updated_at":"2019-06-12T10:28:34Z","author_association":"MEMBER","body":"I can easily reproduce this on `master` in just a few runs (~10). ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501215430","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-501215430","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":501215430,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTIxNTQzMA==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T10:31:47Z","updated_at":"2019-06-12T10:31:47Z","author_association":"CONTRIBUTOR","body":"> I can easily reproduce this on master in just a few runs (~10).\r\n\r\nPlease do share your full TRACE logs then, I can't get this to reproduce on my machine.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501226184","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-501226184","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":501226184,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTIyNjE4NA==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T11:07:41Z","updated_at":"2019-06-12T11:07:41Z","author_association":"MEMBER","body":"Sorry the first one was truncated in the beginning ... this one is full.\r\n\r\n[failed 2.log](https://github.com/elastic/elasticsearch/files/3281025/failed.2.log)","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501234641","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-501234641","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":501234641,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTIzNDY0MQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T11:36:16Z","updated_at":"2019-06-12T11:36:25Z","author_association":"MEMBER","body":"This is the response that trips the assertion:\r\n\r\n![Screenshot 2019-06-12 at 13 34 28](https://user-images.githubusercontent.com/6490959/59348295-0211dc80-8d17-11e9-85e2-5a55568f9b04.png)\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501242362","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-501242362","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":501242362,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTI0MjM2Mg==","user":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T12:01:28Z","updated_at":"2019-06-12T12:01:28Z","author_association":"CONTRIBUTOR","body":"The  relevant lines in the logs are:\r\n\r\n```\r\n[2019-06-12T13:06:09,980][TRACE][o.e.i.f.SyncedFlushService] [testSyncedFlushSkipOutOfSyncReplicas] [test][0] sending pre-synced flush request to [test][0], node[UMMLhkSwQqiFUu8KhAM0lw], [P], s[STARTED], a[id=LLa-xLEKREC1cqC-f-Leow]\r\n[2019-06-12T13:06:09,980][TRACE][o.e.i.f.SyncedFlushService] [testSyncedFlushSkipOutOfSyncReplicas] [test][0] sending pre-synced flush request to [test][0], node[XsMvBzWmQDGSL-QtMgX1-g], [R], s[STARTED], a[id=9P1twPmTTXOZbnGF3c_R2w]\r\n[2019-06-12T13:06:09,980][TRACE][o.e.i.f.SyncedFlushService] [testSyncedFlushSkipOutOfSyncReplicas] [test][0] sending pre-synced flush request to [test][0], node[wroPpzqsSHqjJlZN2RU4Vg], [R], s[STARTED], a[id=76whqbi-TTui7RunQKLJnw]\r\n\r\n\r\n[2019-06-12T13:06:10,063][DEBUG][o.e.i.s.IndexShard       ] [node_t0] [test][0] shard is now inactive\r\n[2019-06-12T13:06:10,064][TRACE][o.e.i.f.SyncedFlushService] [node_t0] [test][0] sending pre-synced flush request to [test][0], node[UMMLhkSwQqiFUu8KhAM0lw], [P], s[STARTED], a[id=LLa-xLEKREC1cqC-f-Leow]\r\n[2019-06-12T13:06:10,064][TRACE][o.e.i.f.SyncedFlushService] [node_t0] [test][0] sending pre-synced flush request to [test][0], node[XsMvBzWmQDGSL-QtMgX1-g], [R], s[STARTED], a[id=9P1twPmTTXOZbnGF3c_R2w]\r\n[2019-06-12T13:06:10,064][TRACE][o.e.i.f.SyncedFlushService] [node_t0] [test][0] sending pre-synced flush request to [test][0], node[wroPpzqsSHqjJlZN2RU4Vg], [R], s[STARTED], a[id=76whqbi-TTui7RunQKLJnw]\r\n```\r\n\r\n\r\nThe problem seems to be that there are two concurrent synced flushes going on at the same time, which makes them fail. One is triggered by the test, the other is triggered by one of the nodes itself when it becomes inactive (see first line of second paragraph).\r\n\r\nI don't understand how the shard can become inactive, given that it has an inactive time of 5 minutes.\r\n\r\n```\r\n[2019-06-12T13:06:06,756][DEBUG][o.e.i.IndexingMemoryController] [testSyncedFlushSkipOutOfSyncReplicas] using indexing buffer size [409.5mb] with indices.memory.shard_inactive_time [5m], indices.memory.interval [5s]\r\n```","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/501248085","html_url":"https://github.com/elastic/elasticsearch/issues/43086#issuecomment-501248085","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/43086","id":501248085,"node_id":"MDEyOklzc3VlQ29tbWVudDUwMTI0ODA4NQ==","user":{"login":"original-brownbear","id":6490959,"node_id":"MDQ6VXNlcjY0OTA5NTk=","avatar_url":"https://avatars0.githubusercontent.com/u/6490959?v=4","gravatar_id":"","url":"https://api.github.com/users/original-brownbear","html_url":"https://github.com/original-brownbear","followers_url":"https://api.github.com/users/original-brownbear/followers","following_url":"https://api.github.com/users/original-brownbear/following{/other_user}","gists_url":"https://api.github.com/users/original-brownbear/gists{/gist_id}","starred_url":"https://api.github.com/users/original-brownbear/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/original-brownbear/subscriptions","organizations_url":"https://api.github.com/users/original-brownbear/orgs","repos_url":"https://api.github.com/users/original-brownbear/repos","events_url":"https://api.github.com/users/original-brownbear/events{/privacy}","received_events_url":"https://api.github.com/users/original-brownbear/received_events","type":"User","site_admin":false},"created_at":"2019-06-12T12:19:30Z","updated_at":"2019-06-12T12:19:30Z","author_association":"MEMBER","body":"@ywelsch thanks, that helped me find it :) We're mixing up ns and ms precision timestamps for the values we assign to `org.elasticsearch.index.engine.Engine#lastWriteNanos` so the conditional for the inactive timeout is incorrectly tripped. I'll open a PR shortly :)","performed_via_github_app":null}]