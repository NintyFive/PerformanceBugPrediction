[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/328159526","html_url":"https://github.com/elastic/elasticsearch/issues/26546#issuecomment-328159526","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26546","id":328159526,"node_id":"MDEyOklzc3VlQ29tbWVudDMyODE1OTUyNg==","user":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"created_at":"2017-09-08T17:02:14Z","updated_at":"2017-09-08T17:33:26Z","author_association":"MEMBER","body":"I can explain what is happening here. The elasticsearch-rest-client is indeed on the classpath and it turns out this is expected because core tests depend on test framework which has elasticsearch-rest-client as a dependency:\r\n\r\nFrom `gradle :core:dependencies -Dbuild.snapshot=false`\r\n\r\n```\r\ntestRuntimeClasspath - Runtime classpath of source set 'test'.\r\n+--- org.apache.lucene:lucene-core:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-analyzers-common:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-backward-codecs:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-grouping:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-highlighter:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-join:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-memory:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-misc:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-queries:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-queryparser:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-sandbox:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-spatial:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-spatial-extras:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-spatial3d:7.0.0-snapshot-d94a5f0\r\n+--- org.apache.lucene:lucene-suggest:7.0.0-snapshot-d94a5f0\r\n+--- org.elasticsearch:securesm:1.1\r\n+--- net.sf.jopt-simple:jopt-simple:5.0.2\r\n+--- com.carrotsearch:hppc:0.7.1\r\n+--- joda-time:joda-time:2.9.5\r\n+--- org.yaml:snakeyaml:1.15\r\n+--- com.fasterxml.jackson.core:jackson-core:2.8.6\r\n+--- com.fasterxml.jackson.dataformat:jackson-dataformat-smile:2.8.6\r\n+--- com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.8.6\r\n+--- com.fasterxml.jackson.dataformat:jackson-dataformat-cbor:2.8.6\r\n+--- com.tdunning:t-digest:3.0\r\n+--- org.hdrhistogram:HdrHistogram:2.1.9\r\n+--- org.locationtech.spatial4j:spatial4j:0.6\r\n+--- com.vividsolutions:jts:1.13\r\n+--- org.apache.logging.log4j:log4j-api:2.9.0\r\n+--- org.apache.logging.log4j:log4j-core:2.9.0\r\n+--- org.apache.logging.log4j:log4j-1.2-api:2.9.0\r\n+--- org.elasticsearch:jna:4.4.0-1\r\n+--- org.elasticsearch.test:framework:6.1.0 -> project :test:framework\r\n|    +--- org.elasticsearch.client:elasticsearch-rest-client:6.1.0 -> project :client:rest\r\n|    |    +--- org.apache.httpcomponents:httpclient:4.5.2\r\n|    |    +--- org.apache.httpcomponents:httpcore:4.4.5\r\n|    |    +--- org.apache.httpcomponents:httpasyncclient:4.1.2\r\n|    |    +--- org.apache.httpcomponents:httpcore-nio:4.4.5\r\n|    |    +--- commons-codec:commons-codec:1.10\r\n|    |    \\--- commons-logging:commons-logging:1.1.3\r\n|    +--- com.carrotsearch.randomizedtesting:randomizedtesting-runner:2.5.2\r\n|    +--- junit:junit:4.12\r\n|    +--- org.hamcrest:hamcrest-all:1.3\r\n|    +--- org.apache.lucene:lucene-test-framework:7.0.0-snapshot-d94a5f0\r\n|    +--- org.apache.lucene:lucene-codecs:7.0.0-snapshot-d94a5f0\r\n|    +--- org.apache.httpcomponents:httpclient:4.5.2\r\n|    +--- org.apache.httpcomponents:httpcore:4.4.5\r\n|    +--- commons-logging:commons-logging:1.1.3\r\n|    +--- commons-codec:commons-codec:1.10\r\n|    +--- org.elasticsearch:securemock:1.2\r\n|    \\--- org.elasticsearch:mocksocket:1.2\r\n+--- com.google.jimfs:jimfs:1.1\r\n\\--- com.google.guava:guava:18.0\r\n```\r\n\r\nThe next question is: why is the assertion tripping given that the JAR is there, we have `build.snapshot` set to `false`, and the version looks right in the dependency? This is because we use `Build#isSnapshot` to determine if we are a snapshot build or not. However, the logic that determines if we are snapshot are not is based on whether or not we are a JAR, and then whether or not a certain entry is in the JAR manifest. When we are running tests, we are not a JAR, we are simply running the classes on the classpath directly from the compiled classes on disk. When we are not a JAR, we assume we must be a snapshot. So: we are looking for -6.1.0-SNAPSHOT but only -6.1.0 is there. Thus, the assertion trips and tests explode.","performed_via_github_app":null}]