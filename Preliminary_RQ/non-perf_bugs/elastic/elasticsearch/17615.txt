{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/17615","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17615/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17615/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/17615/events","html_url":"https://github.com/elastic/elasticsearch/issues/17615","id":146882074,"node_id":"MDU6SXNzdWUxNDY4ODIwNzQ=","number":17615,"title":"java.security.AccessControlException in ESIntegTestCase when using Mockito","user":{"login":"tkaiser","id":8970774,"node_id":"MDQ6VXNlcjg5NzA3NzQ=","avatar_url":"https://avatars3.githubusercontent.com/u/8970774?v=4","gravatar_id":"","url":"https://api.github.com/users/tkaiser","html_url":"https://github.com/tkaiser","followers_url":"https://api.github.com/users/tkaiser/followers","following_url":"https://api.github.com/users/tkaiser/following{/other_user}","gists_url":"https://api.github.com/users/tkaiser/gists{/gist_id}","starred_url":"https://api.github.com/users/tkaiser/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/tkaiser/subscriptions","organizations_url":"https://api.github.com/users/tkaiser/orgs","repos_url":"https://api.github.com/users/tkaiser/repos","events_url":"https://api.github.com/users/tkaiser/events{/privacy}","received_events_url":"https://api.github.com/users/tkaiser/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-04-08T10:03:51Z","updated_at":"2016-04-08T10:08:34Z","closed_at":"2016-04-08T10:08:26Z","author_association":"NONE","active_lock_reason":null,"body":"May be related to #16459.\n\n**Elasticsearch version**: 2.3.1\n\n**JVM version**:\n\n```\njava version \"1.8.0_60\"\nJava(TM) SE Runtime Environment (build 1.8.0_60-b27)\nJava HotSpot(TM) 64-Bit Server VM (build 25.60-b23, mixed mode)\n```\n\n**OS version**:\nOS X 10.11.4\n\n**Description of the problem including expected versus actual behavior**:\nWhen initializing a Mockito mock inside a test class inhering from `ESIntegTestCase`, I get a AccessControlException. Running the test with `-Dtests.security.manager=false` prevents the exception.\n\n**Steps to reproduce**:\n\n```\nimport static org.mockito.Mockito.mock;\n\nimport java.util.List;\n\nimport org.elasticsearch.test.ESIntegTestCase;\nimport org.junit.Test;\n\npublic class SecurityManagerTest extends ESIntegTestCase {\n\n    @Test\n    public void test() throws Exception {\n        final List mock = mock(List.class);\n    }\n}\n\n```\n\n**Provide logs (if relevant)**:\n\n```\njava.lang.ExceptionInInitializerError\n    at __randomizedtesting.SeedInfo.seed([7DFCAB452E627517:F5A8949F809E18EF]:0)\n    at org.mockito.cglib.core.KeyFactory$Generator.generateClass(KeyFactory.java:167)\n    at org.mockito.cglib.core.DefaultGeneratorStrategy.generate(DefaultGeneratorStrategy.java:25)\n    at org.mockito.cglib.core.AbstractClassGenerator.create(AbstractClassGenerator.java:217)\n    at org.mockito.cglib.core.KeyFactory$Generator.create(KeyFactory.java:145)\n    at org.mockito.cglib.core.KeyFactory.create(KeyFactory.java:117)\n    at org.mockito.cglib.core.KeyFactory.create(KeyFactory.java:109)\n    at org.mockito.cglib.core.KeyFactory.create(KeyFactory.java:105)\n    at org.mockito.cglib.proxy.Enhancer.<clinit>(Enhancer.java:70)\n    at org.powermock.api.mockito.repackaged.ClassImposterizer.createProxyClass(ClassImposterizer.java:95)\n    at org.powermock.api.mockito.repackaged.ClassImposterizer.imposterise(ClassImposterizer.java:57)\n    at org.powermock.api.mockito.repackaged.ClassImposterizer.imposterise(ClassImposterizer.java:49)\n    at org.powermock.api.mockito.repackaged.CglibMockMaker.createMock(CglibMockMaker.java:24)\n    at org.powermock.api.mockito.internal.mockmaker.PowerMockMaker.createMock(PowerMockMaker.java:46)\n    at org.mockito.internal.util.MockUtil.createMock(MockUtil.java:33)\n    at org.mockito.internal.MockitoCore.mock(MockitoCore.java:59)\n    at org.mockito.Mockito.mock(Mockito.java:1285)\n    at org.mockito.Mockito.mock(Mockito.java:1163)\n    at com.compuware.apm.elasticsearch.util.SecurityManagerTest.test(SecurityManagerTest.java:14)\n\n...\n\nCaused by: java.security.AccessControlException: access denied (\"java.lang.reflect.ReflectPermission\" \"suppressAccessChecks\")\n    at java.security.AccessControlContext.checkPermission(AccessControlContext.java:472)\n    at java.security.AccessController.checkPermission(AccessController.java:884)\n    at java.lang.SecurityManager.checkPermission(SecurityManager.java:549)\n    at java.lang.reflect.AccessibleObject.setAccessible(AccessibleObject.java:128)\n    at org.mockito.cglib.core.ReflectUtils$2.run(ReflectUtils.java:57)\n    at java.security.AccessController.doPrivileged(Native Method)\n    at org.mockito.cglib.core.ReflectUtils.<clinit>(ReflectUtils.java:47)\n\n```\n","closed_by":{"login":"jasontedor","id":4744941,"node_id":"MDQ6VXNlcjQ3NDQ5NDE=","avatar_url":"https://avatars3.githubusercontent.com/u/4744941?v=4","gravatar_id":"","url":"https://api.github.com/users/jasontedor","html_url":"https://github.com/jasontedor","followers_url":"https://api.github.com/users/jasontedor/followers","following_url":"https://api.github.com/users/jasontedor/following{/other_user}","gists_url":"https://api.github.com/users/jasontedor/gists{/gist_id}","starred_url":"https://api.github.com/users/jasontedor/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jasontedor/subscriptions","organizations_url":"https://api.github.com/users/jasontedor/orgs","repos_url":"https://api.github.com/users/jasontedor/repos","events_url":"https://api.github.com/users/jasontedor/events{/privacy}","received_events_url":"https://api.github.com/users/jasontedor/received_events","type":"User","site_admin":false},"performed_via_github_app":null}