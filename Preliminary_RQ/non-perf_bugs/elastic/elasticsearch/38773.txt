{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/38773","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38773/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38773/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/38773/events","html_url":"https://github.com/elastic/elasticsearch/issues/38773","id":409262261,"node_id":"MDU6SXNzdWU0MDkyNjIyNjE=","number":38773,"title":"[ML] Creating a new job fails if it's using a reindexed results index","user":{"login":"droberts195","id":7405510,"node_id":"MDQ6VXNlcjc0MDU1MTA=","avatar_url":"https://avatars0.githubusercontent.com/u/7405510?v=4","gravatar_id":"","url":"https://api.github.com/users/droberts195","html_url":"https://github.com/droberts195","followers_url":"https://api.github.com/users/droberts195/followers","following_url":"https://api.github.com/users/droberts195/following{/other_user}","gists_url":"https://api.github.com/users/droberts195/gists{/gist_id}","starred_url":"https://api.github.com/users/droberts195/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/droberts195/subscriptions","organizations_url":"https://api.github.com/users/droberts195/orgs","repos_url":"https://api.github.com/users/droberts195/repos","events_url":"https://api.github.com/users/droberts195/events{/privacy}","received_events_url":"https://api.github.com/users/droberts195/received_events","type":"User","site_admin":false},"labels":[{"id":912833043,"node_id":"MDU6TGFiZWw5MTI4MzMwNDM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:ml","name":":ml","color":"0e8a16","default":false,"description":"Machine learning"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1163688906,"node_id":"MDU6TGFiZWwxMTYzNjg4OTA2","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v6.7.0","name":"v6.7.0","color":"dddddd","default":false,"description":""}],"state":"closed","locked":false,"assignee":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"assignees":[{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false}],"milestone":null,"comments":2,"created_at":"2019-02-12T11:56:50Z","updated_at":"2019-02-13T13:35:28Z","closed_at":"2019-02-13T13:35:28Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Steps to reproduce:\r\n\r\n1. Install ES 5.x\r\n2. Run a job\r\n3. Do a full cluster restart update to ES 6.7\r\n4. Install Kibana 6.7\r\n5. In the migration assistant reindex all the indices created in 5.x into the 6.x format\r\n6. Try to create a new job\r\n\r\nThe following error is the result:\r\n\r\n```\r\n{\r\n  \"error\" : {\r\n    \"root_cause\" : [\r\n      {\r\n        \"type\" : \"invalid_index_name_exception\",\r\n        \"reason\" : \"Invalid index name [.ml-anomalies-shared], already exists as alias\",\r\n        \"index_uuid\" : \"_na_\",\r\n        \"index\" : \".ml-anomalies-shared\"\r\n      }\r\n    ],\r\n    \"type\" : \"invalid_index_name_exception\",\r\n    \"reason\" : \"Invalid index name [.ml-anomalies-shared], already exists as alias\",\r\n    \"index_uuid\" : \"_na_\",\r\n    \"index\" : \".ml-anomalies-shared\"\r\n  },\r\n  \"status\" : 400\r\n}\r\n```\r\n\r\nAfter reindexing the output of `_cat/aliases` is this:\r\n\r\n```\r\nalias                          index                                    filter routing.index routing.search\r\n.kibana                        .kibana_1                                -      -             -\r\n.ml-state                      .reindexed-v6-ml-state                   -      -             -\r\n.ml-state-write                .reindexed-v6-ml-state                   -      -             -\r\n.security                      .security-6                              -      -             -\r\n.ml-anomalies-.write-farequote .reindexed-v6-ml-anomalies-shared        -      -             -\r\n.ml-anomalies-farequote        .reindexed-v6-ml-anomalies-shared        *      -             -\r\n.ml-anomalies-shared           .reindexed-v6-ml-anomalies-shared        -      -             -\r\n.ml-notifications              .reindexed-v6-ml-notifications           -      -             -\r\n.ml-annotations-read           .ml-annotations-6                        -      -             -\r\n.ml-annotations-write          .ml-annotations-6                        -      -             -\r\n```\r\n\r\nInstead of checking whether the required indices exist, our code needs to check whether the required name exists as an index _or_ alias.  It should tolerate opening a job when `.ml-anomalies-shared` is an alias rather than an index.\r\n\r\nIt is critical that we fix this before 6.7.0 GA.","closed_by":{"login":"benwtrent","id":4357155,"node_id":"MDQ6VXNlcjQzNTcxNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/4357155?v=4","gravatar_id":"","url":"https://api.github.com/users/benwtrent","html_url":"https://github.com/benwtrent","followers_url":"https://api.github.com/users/benwtrent/followers","following_url":"https://api.github.com/users/benwtrent/following{/other_user}","gists_url":"https://api.github.com/users/benwtrent/gists{/gist_id}","starred_url":"https://api.github.com/users/benwtrent/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/benwtrent/subscriptions","organizations_url":"https://api.github.com/users/benwtrent/orgs","repos_url":"https://api.github.com/users/benwtrent/repos","events_url":"https://api.github.com/users/benwtrent/events{/privacy}","received_events_url":"https://api.github.com/users/benwtrent/received_events","type":"User","site_admin":false},"performed_via_github_app":null}