{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/15194","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15194/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15194/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/15194/events","html_url":"https://github.com/elastic/elasticsearch/issues/15194","id":119988498,"node_id":"MDU6SXNzdWUxMTk5ODg0OTg=","number":15194,"title":"Request cache is not populated when using warmer API","user":{"login":"spinscale","id":667544,"node_id":"MDQ6VXNlcjY2NzU0NA==","avatar_url":"https://avatars2.githubusercontent.com/u/667544?v=4","gravatar_id":"","url":"https://api.github.com/users/spinscale","html_url":"https://github.com/spinscale","followers_url":"https://api.github.com/users/spinscale/followers","following_url":"https://api.github.com/users/spinscale/following{/other_user}","gists_url":"https://api.github.com/users/spinscale/gists{/gist_id}","starred_url":"https://api.github.com/users/spinscale/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/spinscale/subscriptions","organizations_url":"https://api.github.com/users/spinscale/orgs","repos_url":"https://api.github.com/users/spinscale/repos","events_url":"https://api.github.com/users/spinscale/events{/privacy}","received_events_url":"https://api.github.com/users/spinscale/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2015-12-02T17:00:34Z","updated_at":"2016-01-07T09:53:23Z","closed_at":"2016-01-07T09:53:23Z","author_association":"MEMBER","active_lock_reason":null,"body":"It looks as the request cache is not populated when registering a warmer and the index has configured `index.requests.cache.enable`.  Reproduce like this\n\n```\nPUT /test\n{\n  \"settings\": {\n    \"number_of_shards\": 1,\n    \"number_of_replicas\": 0,\n    \"index.requests.cache.enable\": true\n  },\n  \"warmers\": {\n    \"warmer\": {\n      \"source\": {\n        \"aggs\": {\n          \"aggs_1\": {\n            \"terms\": {\n              \"field\": \"field\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\n# Check stats, hit count should be 0\nGET /test/_stats/request_cache?filter_path=indices.test.total.request_cache\n\n# refresh runs the warmer\nPUT /test/test/1?refresh\n{\n  \"field\" : \"somevalue\"\n}\n\n# Check stats, hit count should be 0 again\nGET /test/_stats/request_cache?filter_path=indices.test.total.request_cache\n\n# Execute agg\nGET /test/_search?search_type=count\n{\n  \"aggs\": {\n    \"foo\": {\n      \"terms\": {\n        \"field\": \"field\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n# PROBLEM HERE: Check stats, hit count should be 1, but is 0, missing count is increased\nGET /test/_stats/request_cache?filter_path=indices.test.total.request_cache\n\n# Execute agg a second time\nGET /test/_search?search_type=count\n{\n  \"aggs\": {\n    \"foo\": {\n      \"terms\": {\n        \"field\": \"field\",\n        \"size\": 10\n      }\n    }\n  }\n}\n\n# Finally we have a cache hit but too late\nGET /test/_stats/request_cache?filter_path=indices.test.total.request_cache\n```\n\nThe issue seems particularly troubling to me, because this means, that the user will always get one slow query (and I do not see any external possibility to prevent this, like running the query manually and hoping it gets executed before the first user query hits). This means there will always be a slow agg, if I understood it correctly.\n\nThis also happens with the query shard cache in 1.7.\n","closed_by":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"performed_via_github_app":null}