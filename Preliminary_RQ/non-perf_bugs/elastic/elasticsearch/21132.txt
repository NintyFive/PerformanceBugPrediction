{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/21132","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21132/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21132/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/21132/events","html_url":"https://github.com/elastic/elasticsearch/issues/21132","id":185415389,"node_id":"MDU6SXNzdWUxODU0MTUzODk=","number":21132,"title":"Phrase match \"hits\" with no highlights","user":{"login":"sschneider1207","id":16026066,"node_id":"MDQ6VXNlcjE2MDI2MDY2","avatar_url":"https://avatars0.githubusercontent.com/u/16026066?v=4","gravatar_id":"","url":"https://api.github.com/users/sschneider1207","html_url":"https://github.com/sschneider1207","followers_url":"https://api.github.com/users/sschneider1207/followers","following_url":"https://api.github.com/users/sschneider1207/following{/other_user}","gists_url":"https://api.github.com/users/sschneider1207/gists{/gist_id}","starred_url":"https://api.github.com/users/sschneider1207/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sschneider1207/subscriptions","organizations_url":"https://api.github.com/users/sschneider1207/orgs","repos_url":"https://api.github.com/users/sschneider1207/repos","events_url":"https://api.github.com/users/sschneider1207/events{/privacy}","received_events_url":"https://api.github.com/users/sschneider1207/received_events","type":"User","site_admin":false},"labels":[{"id":111549183,"node_id":"MDU6TGFiZWwxMTE1NDkxODM=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Highlighting","name":":Search/Highlighting","color":"0e8a16","default":false,"description":"How a query matched a document"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2016-10-26T14:46:42Z","updated_at":"2016-11-25T15:37:29Z","closed_at":"2016-11-25T15:37:29Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\nGitHub is reserved for bug reports and feature requests. The best place\nto ask a general question is at the Elastic Discourse forums at\nhttps://discuss.elastic.co. If you are in fact posting a bug report or\na feature request, please include one and only one of the below blocks\nin your new issue. Note that whether you're filing a bug report or a\nfeature request, ensure that your submission is for an\n[OS that we support](https://www.elastic.co/support/matrix#show_os).\nBug reports on an OS that we do not support or feature requests\nspecific to an OS that we do not support will be closed.\n-->\n\n<!--\nIf you are filing a bug report, please remove the below feature\nrequest block and provide responses for all of the below items.\n-->\n\n**Elasticsearch version**: 2.3.5\n\n**Plugins installed**: [elasticsearch-head]\n\n**JVM version**: 7u111-2.6.7-0ubuntu0.14.04.3\n\n**OS version**: Ubuntu 14.04.5\n\n**Description of the problem including expected versus actual behavior**:\nWe are making a match phrase query inside the must clause of a bool query with highlights enabled on the field that is being matched.  We are getting documents that are supposedly matching the query but without any highlights returned.\n\n**Steps to reproduce**:\nThe index mapping being used:\n\n``` javascript\n{\n  \"settings\": {\n    \"analysis\": {\n      \"filter\": {\n        \"english_phrase_index_filter\": {\n          \"type\": \"common_grams\",\n          \"common_words\": \"_english_\"\n        },\n        \"english_phrase_search_filter\": {\n          \"type\": \"common_grams\",\n          \"common_words\": \"_english_\",\n          \"query_mode\": true\n        },\n        \"english_stop\": {\n          \"type\": \"stop\",\n          \"stopwords\": \"_english_\"\n        },\n        \"light_english_stemmer\": {\n          \"type\": \"stemmer\",\n          \"language\": \"light_english\"\n        },\n        \"english_stemmer\": {\n          \"type\": \"stemmer\",\n          \"language\": \"english\"\n        },\n        \"english_possessive_stemmer\": {\n          \"type\": \"stemmer\",\n          \"language\": \"possessive_english\"\n        }\n      },\n      \"analyzer\": {\n        \"english_phrase_index_analyzer\": {\n          \"tokenizer\": \"standard\",\n          \"char_filter\": [\n            \"html_strip\"\n          ],\n          \"filter\": [\n            \"english_possessive_stemmer\",\n            \"lowercase\",\n            \"english_phrase_index_filter\",\n            \"asciifolding\"\n          ]\n        },\n        \"english_phrase_search_analyzer\": {\n          \"tokenizer\": \"standard\",\n          \"char_filter\": [\n            \"html_strip\"\n          ],\n          \"filter\": [\n            \"english_possessive_stemmer\",\n            \"lowercase\",\n            \"english_phrase_search_filter\",\n            \"asciifolding\"\n          ]\n        },\n        \"english_keyword_analyzer\": {\n          \"tokenizer\": \"standard\",\n          \"char_filter\": [\n            \"html_strip\"\n          ],\n          \"filter\": [\n            \"english_possessive_stemmer\",\n            \"lowercase\",\n            \"light_english_stemmer\",\n            \"english_stop\",\n            \"asciifolding\"\n          ]\n        }\n      }\n    }\n  },\n  \"mappings\": {\n    \"volume\": {\n      \"properties\": {\n        \"buid\": {\n          \"type\": \"string\",\n          \"index\": \"no\"\n        },\n        \"contentReserveId\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"edition\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"publisherCatalogNumber\": {\n          \"type\": \"string\",\n          \"index\": \"not_analyzed\"\n        },\n        \"sections\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"title\": {\n              \"type\": \"string\",\n              \"index\": \"not_analyzed\"\n            },\n            \"odrDataLoc\": {\n              \"type\": \"integer\"\n            },\n            \"id\": {\n              \"type\": \"string\",\n              \"index\": \"not_analyzed\"\n            },\n            \"content\": {\n              \"type\": \"string\",\n              \"include_in_all\": false,\n              \"index\": \"no\",\n              \"fields\": {\n                \"phrase\": {\n                  \"type\": \"string\",\n                  \"index\": \"analyzed\",\n                  \"include_in_all\": false,\n                  \"analyzer\": \"english_phrase_index_analyzer\",\n                  \"search_analyzer\": \"english_phrase_search_analyzer\",\n                  \"term_vector\": \"with_positions_offsets\"\n                },\n                \"keyword\": {\n                  \"type\": \"string\",\n                  \"index\": \"analyzed\",\n                  \"include_in_all\": false,\n                  \"analyzer\": \"english_keyword_analyzer\",\n                  \"term_vector\": \"with_positions_offsets\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  },\n  \"aliases\": {\n    \"full-text\": {}\n  }\n}\n```\n\nThe query being used:\n\n``` javascript\n{\n  \"_source\": false,\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"nested\": {\n            \"path\": \"sections\",\n            \"query\": {\n              \"bool\": {\n                \"must\": [\n                  {\n                    \"match_phrase\": {\n                      \"sections.content.phrase\": {\n                        \"query\": \"theory legal\",\n                        \"slop\": 3\n                      }\n                    }\n                  }\n                ]\n              }\n            },\n            \"inner_hits\": {\n              \"highlight\": {\n                \"fields\": {\n                  \"sections.content.phrase\": {}\n                }\n              },\n              \"_source\": [\n                \"title\",\n                \"odrDataLoc\",\n                \"id\"\n              ]\n            }\n          }\n        }\n      ],\n      \"filter\": [\n        {\n          \"match\": {\n            \"publisherCatalogId\": \"00410\"\n          }\n        }\n      ]\n    }\n  },\n  \"fields\": [\n    \"contentReserveId\",\n    \"edition\",\n    \"publisherCatalogId\",\n    \"buid\"\n  ]\n}\n```\n\n When the slop value of this query is set to 1, we get a single hit with a correct highlight returned for said hit.  When the slop value is increased, we get more hits, but no highlights returned for any, not even for the original highlight from when the slop was 1.  From what I can tell based on the text in the documents being searched, it is matching on phrases where the text is reversed (e.g. query for \"theory legal\" is matching \"legal theory\"), but not highlighting said matches for some reason.\n\nI've also tried this out in the 5.0-rc after adjusting the index/query with anything that was changed with the same results (hits with no highlights).\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}