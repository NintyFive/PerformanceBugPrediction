{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/2536","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2536/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2536/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/2536/events","html_url":"https://github.com/elastic/elasticsearch/issues/2536","id":9871896,"node_id":"MDU6SXNzdWU5ODcxODk2","number":2536,"title":"NullPointerException during parent/child query (ES 0.20.2)","user":{"login":"mashudong","id":3242209,"node_id":"MDQ6VXNlcjMyNDIyMDk=","avatar_url":"https://avatars2.githubusercontent.com/u/3242209?v=4","gravatar_id":"","url":"https://api.github.com/users/mashudong","html_url":"https://github.com/mashudong","followers_url":"https://api.github.com/users/mashudong/followers","following_url":"https://api.github.com/users/mashudong/following{/other_user}","gists_url":"https://api.github.com/users/mashudong/gists{/gist_id}","starred_url":"https://api.github.com/users/mashudong/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mashudong/subscriptions","organizations_url":"https://api.github.com/users/mashudong/orgs","repos_url":"https://api.github.com/users/mashudong/repos","events_url":"https://api.github.com/users/mashudong/events{/privacy}","received_events_url":"https://api.github.com/users/mashudong/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":23258505,"node_id":"MDU6TGFiZWwyMzI1ODUwNQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.20.3","name":"v0.20.3","color":"DDDDDD","default":false,"description":null},{"id":17100279,"node_id":"MDU6TGFiZWwxNzEwMDI3OQ==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/v0.90.0.Beta1","name":"v0.90.0.Beta1","color":"DDDDDD","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2013-01-11T07:26:47Z","updated_at":"2013-01-18T08:49:47Z","closed_at":"2013-01-18T08:49:47Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"1. create mapping\n   curl -XPUT localhost:9200/index1/\n   curl localhost:9200/index1/Parent/_mapping?pretty -d '\n   {\n   \"Parent\" : {\n     \"_all\" : {\n       \"enabled\" : false\n     },\n     \"_source\" : {\n       \"compress\" : true\n     },\n     \"properties\" : {\n       \"_tenantid\" : {\n         \"type\" : \"long\",\n         \"store\" : \"yes\"\n       },\n       \"age\" : {\n         \"type\" : \"long\"\n       },\n       \"name\" : {\n         \"type\" : \"string\"\n       },\n       \"sex\" : {\n         \"type\" : \"string\"\n       }\n     }\n   }\n   }\n   '\n   curl localhost:9200/index1/Child/_mapping?pretty -d '\n   {\n   \"Child\" : {\n     \"_all\" : {\n       \"enabled\" : false\n     },\n     \"_parent\" : {\n       \"type\" : \"Parent\"\n     },\n     \"_routing\" : {\n       \"required\" : true\n     },\n     \"_source\" : {\n       \"compress\" : true\n     },\n     \"properties\" : {\n       \"_tenantid\" : {\n         \"type\" : \"long\",\n         \"store\" : \"yes\"\n       },\n       \"age\" : {\n         \"type\" : \"long\"\n       },\n       \"name\" : {\n         \"type\" : \"string\"\n       },\n       \"shangshi\" : {\n         \"type\" : \"boolean\"\n       }\n     }\n   }\n   }\n   '\n2. Query\n\ncurl localhost:9200/index1/Parent/_search?pretty -d '\n{ \"sort\" : [{ \"age\" : {\"order\" : \"desc\"} }],\"query\": { \"filtered\": { \"query\": { \"has_child\": { \"type\": \"Child\", \"query\": { \"query_string\": { \"query\": \"+_tenantid:100002 +(-age:20)\"} } } }, \n\"filter\": { \"fquery\": { \"query\": { \"query_string\": { \"query\": \"+_tenantid:100002 +(name:dog  OR age:[10 TO 2147483647])\" } }, \"_cache\": true } } } } }\n'\n\nOK, no result found, of course\n1. Index one doc in an irrelevant type\n\ncurl localhost:9200/index1/Type1/key0 -d '\n{\"_tenantid\": 100002, \"name\": \"lilei\", \"age\": -2, \"sex\": \"f\", \"marry\": false, \"weight\": 2.3, \"height\": 2.7E+23, \"grade\": 123, \"bill\": -120, \"fee\": 245, \"money\": 3453, \"number\": 65333, \n\"phone\": 4200000000, \"small\": 123.123456789123456789, \"birthday\": 20120306000000}\n'\n1. Exactly the same query again\n\ncurl localhost:9200/index1/Parent/_search?pretty -d '\n{ \"sort\" : [{ \"age\" : {\"order\" : \"desc\"} }],\"query\": { \"filtered\": { \"query\": { \"has_child\": { \"type\": \"Child\", \"query\": { \"query_string\": { \"query\": \"+_tenantid:100002 +(-age:20)\"} } } }, \n\"filter\": { \"fquery\": { \"query\": { \"query_string\": { \"query\": \"+_tenantid:100002 +(name:dog  OR age:[10 TO 2147483647])\" } }, \"_cache\": true } } } } }\n'\n\nNow, NullPointerException!\n\n\"reason\" : \"QueryPhaseExecutionException[[index1][2]: query[filtered(filtered(ConstantScore(child_filter[Child/Parent](+_tenantid:[100002 TO 100002] +%28-age:[20 TO 20] +ConstantScore%28NotDeleted%28*:*%29%29%29)))->cache(QueryWrapperFilter(+_tenantid:[100002 TO 100002] +(name:dog age:[10 TO 2147483647]))))->cache(_type:Parent)],from[0],size[10],sort[<custom:\\\"age\\\": org.elasticsearch.index.field.data.longs.LongFieldDataType$1@1663108>!]: Query Failed [Failed to execute child query [+_tenantid:[100002 TO 100002] +(-age:[20 TO 20] +ConstantScore(NotDeleted(_:_)))]]]; nested: NullPointerException; \"\n","closed_by":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"performed_via_github_app":null}