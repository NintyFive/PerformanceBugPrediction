{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/44658","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44658/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44658/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/44658/events","html_url":"https://github.com/elastic/elasticsearch/issues/44658","id":470764461,"node_id":"MDU6SXNzdWU0NzA3NjQ0NjE=","number":44658,"title":"Optimize logging pending task summary","user":{"login":"Bukhtawar","id":12809319,"node_id":"MDQ6VXNlcjEyODA5MzE5","avatar_url":"https://avatars0.githubusercontent.com/u/12809319?v=4","gravatar_id":"","url":"https://api.github.com/users/Bukhtawar","html_url":"https://github.com/Bukhtawar","followers_url":"https://api.github.com/users/Bukhtawar/followers","following_url":"https://api.github.com/users/Bukhtawar/following{/other_user}","gists_url":"https://api.github.com/users/Bukhtawar/gists{/gist_id}","starred_url":"https://api.github.com/users/Bukhtawar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Bukhtawar/subscriptions","organizations_url":"https://api.github.com/users/Bukhtawar/orgs","repos_url":"https://api.github.com/users/Bukhtawar/repos","events_url":"https://api.github.com/users/Bukhtawar/events{/privacy}","received_events_url":"https://api.github.com/users/Bukhtawar/received_events","type":"User","site_admin":false},"labels":[{"id":881394071,"node_id":"MDU6TGFiZWw4ODEzOTQwNzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Cluster%20Coordination","name":":Distributed/Cluster Coordination","color":"0e8a16","default":false,"description":"Cluster formation and cluster state publication, including cluster membership and fault detection."},{"id":73544,"node_id":"MDU6TGFiZWw3MzU0NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Enon-issue","name":">non-issue","color":"cfcfcf","default":false,"description":null},{"id":110815527,"node_id":"MDU6TGFiZWwxMTA4MTU1Mjc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/help%20wanted","name":"help wanted","color":"207de5","default":true,"description":"adoptme"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2019-07-21T10:04:15Z","updated_at":"2020-01-03T11:36:13Z","closed_at":"2020-01-03T11:36:13Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"The below allocation hotspot was observed in a 6.2 cluster where there was a flood of shard-failed events fixed in 6.4 as a part of #31313. Although this might not recur on higher versions for shard-failed specifically but still can if there are too many pending tasks but since the below code seems to be used only for logging task summary in debug mode or warning if it turned out to be a slow running task, it seems wasteful for most of the cases.\r\n\r\nI think it would make more sense to possibly defer this.\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/b33f3846e8f964a79eb07f7b36bae06703907e4b/server/src/main/java/org/elasticsearch/cluster/ClusterStateTaskExecutor.java#L60-L62\r\n\r\n```\r\n  [ 1] org.elasticsearch.cluster.ClusterStateTaskExecutor.lambda$describeTasks$0\r\n  [ 2] org.elasticsearch.cluster.ClusterStateTaskExecutor$$Lambda$1757.792151473.apply\r\n  [ 3] java.util.stream.ReduceOps$2ReducingSink.accept\r\n  [ 4] java.util.stream.ReferencePipeline$3$1.accept\r\n  [ 5] java.util.ArrayList$ArrayListSpliterator.forEachRemaining\r\n  [ 6] java.util.stream.AbstractPipeline.copyInto\r\n  [ 7] java.util.stream.AbstractPipeline.wrapAndCopyInto\r\n  [ 8] java.util.stream.ReduceOps$ReduceOp.evaluateSequential\r\n  [ 9] java.util.stream.AbstractPipeline.evaluate\r\n  [10] java.util.stream.ReferencePipeline.reduce\r\n  [11] org.elasticsearch.cluster.ClusterStateTaskExecutor.describeTasks\r\n  [12] org.elasticsearch.cluster.service.MasterService$Batcher$UpdateTask.describeTasks\r\n  [13] org.elasticsearch.cluster.service.TaskBatcher.lambda$runIfNotProcessed$6\r\n  [14] org.elasticsearch.cluster.service.TaskBatcher$$Lambda$1752.1418423337.apply\r\n  [15] java.util.stream.ReferencePipeline$3$1.accept\r\n  [16] java.util.HashMap$EntrySpliterator.forEachRemaining\r\n  [17] java.util.stream.AbstractPipeline.copyInto\r\n  [18] java.util.stream.AbstractPipeline.wrapAndCopyInto\r\n  [19] java.util.stream.ReduceOps$ReduceOp.evaluateSequential\r\n  [20] java.util.stream.AbstractPipeline.evaluate\r\n  [21] java.util.stream.ReferencePipeline.reduce\r\n  [22] org.elasticsearch.cluster.service.TaskBatcher.runIfNotProcessed\r\n  [23] org.elasticsearch.cluster.service.TaskBatcher$BatchedTask.run\r\n  [24] org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingRunnable.run\r\n```","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}