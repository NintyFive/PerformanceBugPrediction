{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/35917","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35917/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35917/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/35917/events","html_url":"https://github.com/elastic/elasticsearch/issues/35917","id":384485253,"node_id":"MDU6SXNzdWUzODQ0ODUyNTM=","number":35917,"title":"action.search.shard_count.limit no longer benefits from time-based index patterns","user":{"login":"pyro2927","id":39943,"node_id":"MDQ6VXNlcjM5OTQz","avatar_url":"https://avatars1.githubusercontent.com/u/39943?v=4","gravatar_id":"","url":"https://api.github.com/users/pyro2927","html_url":"https://github.com/pyro2927","followers_url":"https://api.github.com/users/pyro2927/followers","following_url":"https://api.github.com/users/pyro2927/following{/other_user}","gists_url":"https://api.github.com/users/pyro2927/gists{/gist_id}","starred_url":"https://api.github.com/users/pyro2927/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyro2927/subscriptions","organizations_url":"https://api.github.com/users/pyro2927/orgs","repos_url":"https://api.github.com/users/pyro2927/repos","events_url":"https://api.github.com/users/pyro2927/events{/privacy}","received_events_url":"https://api.github.com/users/pyro2927/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-11-26T19:53:11Z","updated_at":"2018-12-07T18:51:01Z","closed_at":"2018-12-07T18:51:01Z","author_association":"NONE","active_lock_reason":null,"body":"**Bug Report**:\r\n\r\nIn ES 5.x and prior, index names & templates could use [`YYYY.MM.DD`](https://www.elastic.co/guide/en/kibana/5.0/index-patterns.html#settings-create-pattern) to bucket datetimes such as `@timestamp`.  This enabled ES admins to limit the max timerange a user could query by setting `action.search.shard_count.limit` to `number_of_shards_per_day x max_days`.\r\n\r\nFor a more concrete example, we currently store 30 days of data, dropping older indexes via Curator.  Each day is ~4TB of data, split across 80 shards.  Users querying 30 days of data generally brings our cluster to a halt, and so we set `action.search.shard_count.limit` to `640` in order to give users a 7-day query limit (with tails on each side).\r\n\r\n[Starting in 6.0, time-based index patterns are no longer supported](https://www.elastic.co/guide/en/kibana/6.0/breaking-changes-6.0.html#_time_interval_based_index_patterns_are_no_longer_supported).  This in and of itself is not a problem, but it appears that `action.search.shard_count.limit` is being enforced _before_ the shards determine if they have data within a [Range Query](https://www.elastic.co/guide/en/elasticsearch/reference/current/query-dsl-range-query.html#ranges-on-dates).\r\n\r\nThe spirit of the setting feels like it should be applied _after_ shards determine whether or not a query should be executed against them.\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`):\r\n\r\nTested running via [sebp's Docker image](https://hub.docker.com/r/sebp/elk/), but have also experienced this on a production ES 6.4.1 cluster.\r\n\r\n```bash\r\nroot@aa0fc2c3283d:/# /opt/elasticsearch/bin/elasticsearch --version\r\nVersion: 6.4.2, Build: default/tar/04711c2/2018-09-26T13:34:09.098244Z, JVM: 1.8.0_181\r\n```\r\n\r\n**Plugins installed**: _none_\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\nroot@aa0fc2c3283d:/# java -version\r\nopenjdk version \"1.8.0_181\"\r\nOpenJDK Runtime Environment (build 1.8.0_181-8u181-b13-0ubuntu0.16.04.1-b13)\r\nOpenJDK 64-Bit Server VM (build 25.181-b13, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n```\r\nroot@aa0fc2c3283d:/# uname -a\r\nLinux aa0fc2c3283d 4.9.125-linuxkit #1 SMP Fri Sep 7 08:20:28 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\n*Actual*: When submitting a query that is limited to one day (index) using a `range` query, `action.search.shard_count.limit` prevents a search from executing.\r\n\r\n*Expected*: When submitting a query that is limited to one day, `action.search.shard_count.limit` should be applied _after_ determining which indexes to execute on.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n1.  Start Elasticsearch (for ease, use a Docker container: `docker run -p 5601:5601 -p 9200:9200 -p 5044:5044 -it sebp/elk:642`)\r\n2. Insert some data on two different days:\r\n  a. `curl -XPUT \"http://localhost:9200/logstash-2018.11.25/doc/1?pretty\" -H 'Content-Type: application/json' -d'{\"custom_timestamp\":\"2018-11-25T19:25:51+00:00\"}'`\r\n  b. `curl -XPUT \"http://localhost:9200/logstash-2018.11.26/doc/1?pretty\" -H 'Content-Type: application/json' -d'{\"custom_timestamp\":\"2018-11-26T19:25:51+00:00\"}'`\r\n3. Set query limit to `5` shards (default limit per index as of 6.4.2) (`curl -XPUT \"http://localhost:9200/_cluster/settings\" -H 'Content-Type: application/json' -d'\r\n{\"persistent\":{\"action.search.shard_count.limit\":\"5\"}}'`)\r\n4. Query a very small time range that should only hit one index (`curl -XGET \"http://localhost:9200/logstash-*/_search\" -H 'Content-Type: application/json' -d'\r\n{\"query\":{\"bool\":{\"must\":[{\"match_all\":{}},{\"range\":{\"custom_timestamp\":{\"gte\":1543259576210,\"lte\":1543260476210,\"format\":\"epoch_millis\"}}}]}}}'`)\r\n5. Observe `illegal_argument_exception`","closed_by":{"login":"pyro2927","id":39943,"node_id":"MDQ6VXNlcjM5OTQz","avatar_url":"https://avatars1.githubusercontent.com/u/39943?v=4","gravatar_id":"","url":"https://api.github.com/users/pyro2927","html_url":"https://github.com/pyro2927","followers_url":"https://api.github.com/users/pyro2927/followers","following_url":"https://api.github.com/users/pyro2927/following{/other_user}","gists_url":"https://api.github.com/users/pyro2927/gists{/gist_id}","starred_url":"https://api.github.com/users/pyro2927/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pyro2927/subscriptions","organizations_url":"https://api.github.com/users/pyro2927/orgs","repos_url":"https://api.github.com/users/pyro2927/repos","events_url":"https://api.github.com/users/pyro2927/events{/privacy}","received_events_url":"https://api.github.com/users/pyro2927/received_events","type":"User","site_admin":false},"performed_via_github_app":null}