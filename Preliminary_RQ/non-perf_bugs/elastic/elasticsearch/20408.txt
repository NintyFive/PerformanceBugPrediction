{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20408","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20408/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20408/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20408/events","html_url":"https://github.com/elastic/elasticsearch/issues/20408","id":176239841,"node_id":"MDU6SXNzdWUxNzYyMzk4NDE=","number":20408,"title":"NPE when fetching source from an index with _source disabled","user":{"login":"marfago","id":1191501,"node_id":"MDQ6VXNlcjExOTE1MDE=","avatar_url":"https://avatars3.githubusercontent.com/u/1191501?v=4","gravatar_id":"","url":"https://api.github.com/users/marfago","html_url":"https://github.com/marfago","followers_url":"https://api.github.com/users/marfago/followers","following_url":"https://api.github.com/users/marfago/following{/other_user}","gists_url":"https://api.github.com/users/marfago/gists{/gist_id}","starred_url":"https://api.github.com/users/marfago/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/marfago/subscriptions","organizations_url":"https://api.github.com/users/marfago/orgs","repos_url":"https://api.github.com/users/marfago/repos","events_url":"https://api.github.com/users/marfago/events{/privacy}","received_events_url":"https://api.github.com/users/marfago/received_events","type":"User","site_admin":false},"labels":[{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"assignees":[{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false}],"milestone":null,"comments":14,"created_at":"2016-09-11T11:41:35Z","updated_at":"2016-09-12T16:36:43Z","closed_at":"2016-09-12T16:36:43Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.4.0\n\n**Plugins installed**: [Marvel,Head,License,Delete-by-query]\n\n**JVM version**: 1.8.0_91\n\n**OS version**: linux ubuntu 14.04 - 4.5.7\n\n**Description of the problem including expected versus actual behavior**:\n\nI have 8 indexes, called url-0,url-1,...,url-8 with around 1B documents.\nThe template for each index is \n\n```\n{\n    \"template\" : \"url-*\",\n    \"settings\" : {            \n        \"number_of_shards\"   : \"1\",\n        \"number_of_replicas\" : \"0\",\n        \"refresh_interval\"   : \"180s\"\n    },\n    \"mappings\" : {\n        \"url\" : {\n            \"_all\" : {\"enabled\" : false},\n            \"_timestamp\" : {\"enabled\" : false},\n            \"_source\": {\"enabled\": false},\n            \"_ttl\" : { \"enabled\" : false },\n            \"properties\" : {\n                \"url\" : {\"type\" : \"string\", \"index\": \"not_analyzed\", \"store\" : true},\n                \"domain\" : {\"type\": \"string\", \"index\" : \"not_analyzed\", \"store\" : false},\n                \"scheme\" : {\"type\": \"string\", \"index\" : \"not_analyzed\", \"store\" : false},\n                \"parsedUrl\" : {\"type\": \"string\", \"index\": \"analyzed\", \"store\": false},\n                \"workerIndex\": {\"type\": \"integer\", \"store\" : false},\n                \"error\": {\"type\": \"boolean\", \"store\" : false},\n                \"banned\": {\"type\": \"boolean\", \"store\" : false},\n                \"timestamp\": {\"type\": \"date\", \"store\" : true},\n                \"depth\": {\"type\": \"integer\", \"store\" : true},\n                \"processed\": {\"type\": \"boolean\", \"store\" : false}\n\n            }\n        }\n    }\n```\n\nWhen I execute the query\n\n`curl -XPOST localhost:9200/url/url/_search?search_type=scan&scroll=5m&size=50&_source=url&preference=_shards:0;_prefer_node:XqfWWAGFRdCPo98qIeFfGg`\n\nI get\n\n```\n{\n\n    \"_scroll_id\": \"c2Nhbjs4OzMyNzUyNzpYcWZXV0FHRlJkQ1BvOThxSWVGZkdnOzQ3MTkzODplTDZZa3AxSlRVQ3lHd1FMTjR3T3NnOzgxMzY4ODpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzgxMzY4NzpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzgxMzY4NjpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzQ3MTkzOTplTDZZa3AxSlRVQ3lHd1FMTjR3T3NnOzMxNDc1NDpqbUdTWGRmWVRTdWFIT1FFSmZ1WVN3OzgxMzY4OTpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzE7dG90YWxfaGl0czoxMDEzOTAyNTk1Ow==\",\n    \"took\": 8221,\n    \"timed_out\": false,\n    \"_shards\": {\n        \"total\": 8,\n        \"successful\": 8,\n        \"failed\": 0\n    },\n    \"hits\": {\n        \"total\": 1013902595,\n        \"max_score\": 0,\n        \"hits\": [ ]\n    }\n}\n```\n\nbut\n\nIf I query for the scrollId I get an error and a NPE on the server.\n\n```\nculr -XPOST localhost:9200/_search/scroll?scroll=1m -d '\n{\n  \"scroll_id\": \"c2Nhbjs4OzMyNzUyNzpYcWZXV0FHRlJkQ1BvOThxSWVGZkdnOzQ3MTkzODplTDZZa3AxSlRVQ3lHd1FMTjR3T3NnOzgxMzY4ODpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzgxMzY4NzpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzgxMzY4NjpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzQ3MTkzOTplTDZZa3AxSlRVQ3lHd1FMTjR3T3NnOzMxNDc1NDpqbUdTWGRmWVRTdWFIT1FFSmZ1WVN3OzgxMzY4OTpwSHVGaVJRM1JSYTIwaWRxNTlFbXNBOzE7dG90YWxfaGl0czoxMDEzOTAyNTk1Ow\"\n}'\n```\n\nresult:\n\n```\n{\n\n    \"_scroll_id\": \"c2NhbjswOzE7dG90YWxfaGl0czoxMDEzOTAyNTk1Ow==\",\n    \"took\": 105,\n    \"timed_out\": false,\n    \"_shards\": {\n        \"total\": 8,\n        \"successful\": 0,\n        \"failed\": 8,\n        \"failures\": [\n            {\n                \"shard\": -1,\n                \"index\": null,\n                \"reason\": {\n                    \"type\": \"null_pointer_exception\",\n                    \"reason\": null\n                }\n            }\n        ]\n    },\n    \"hits\": {\n        \"total\": 1013902595,\n        \"max_score\": 0,\n        \"hits\": [ ]\n    }\n\n}\n```\n\nAnd in the logs:\n\n```\nRemoteTransportException[[es-1][][indices:data/read/search[phase/scan/scroll]]]; nested: NullPointerException;\nCaused by: java.lang.NullPointerException\n        at org.elasticsearch.search.fetch.source.FetchSourceSubPhase.hitExecute(FetchSourceSubPhase.java:79)\n        at org.elasticsearch.search.fetch.FetchPhase.execute(FetchPhase.java:188)\n        at org.elasticsearch.search.SearchService.executeScan(SearchService.java:342)\n```\n\nMaybe it is a problem related to the **_source** parameter in the query and the fact that the _source field is disabled in the mapping. If I remove the **_source** field from the query, it works fine.\n\nPS: The above query was originated by Spark with the elasticsearch-spark_2.11 (v.2.4.0) library.\n","closed_by":{"login":"javanna","id":832460,"node_id":"MDQ6VXNlcjgzMjQ2MA==","avatar_url":"https://avatars1.githubusercontent.com/u/832460?v=4","gravatar_id":"","url":"https://api.github.com/users/javanna","html_url":"https://github.com/javanna","followers_url":"https://api.github.com/users/javanna/followers","following_url":"https://api.github.com/users/javanna/following{/other_user}","gists_url":"https://api.github.com/users/javanna/gists{/gist_id}","starred_url":"https://api.github.com/users/javanna/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/javanna/subscriptions","organizations_url":"https://api.github.com/users/javanna/orgs","repos_url":"https://api.github.com/users/javanna/repos","events_url":"https://api.github.com/users/javanna/events{/privacy}","received_events_url":"https://api.github.com/users/javanna/received_events","type":"User","site_admin":false},"performed_via_github_app":null}