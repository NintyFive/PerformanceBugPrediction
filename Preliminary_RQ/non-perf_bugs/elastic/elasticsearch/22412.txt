{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/22412","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22412/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22412/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/22412/events","html_url":"https://github.com/elastic/elasticsearch/issues/22412","id":198438212,"node_id":"MDU6SXNzdWUxOTg0MzgyMTI=","number":22412,"title":"Date range query rewrite should rewrite INTERSECTS query case in UTC","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":111416437,"node_id":"MDU6TGFiZWwxMTE0MTY0Mzc=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/discuss","name":"discuss","color":"fbca04","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2017-01-03T09:42:34Z","updated_at":"2018-02-14T13:29:37Z","closed_at":"2017-01-06T10:20:48Z","author_association":"MEMBER","active_lock_reason":null,"body":"The rewrite for the date range query has three cases:\r\n1. DISJOINT - query is rewritten to a match none query\r\n2. WITHIN - query is rewritten as an unbounded (`[null TO null]`) date range query\r\n3. INTERSECTS - query is not rewritten and `this` is returned\r\n\r\nBecause we don't rewrite the query in the 3rd case above we miss the opportunity to have the query returned in a normalised (UTC milliseconds) form. This means the following cases (and possibly others I haven't thought of) will result in cache misses when the queries are actually the same:\r\n* Two users submit queries in different timezones which map to the same UTC time range. For example, user A searches for `[9pm TO 10pm]` GMT and user B searches for `[10pm TO 11pm]` CET, both queries actually map to `[9pm TO 10pm]` UTC when run on the shard.\r\n* Two users search for the same time range but with different valid date formats (because we allow multiple date formats to be used). For example, user A searches for `[2012-01-01 TO 2014-01-01]` and user B searches for `[01/01/2012 TO 01/01/2014]`.\r\n* One user searches for a date math expression using now that maps directly to another users exact search. For example, user A searches for `[2016-01-01 TO 2017-01-01]` and user B searches for `[now-1y/y TO now/y]`\r\n\r\nIn all of these cases we can use the same solution; in the INTERSECTS case we can rewrite the query so the timezone is UTC and the from and to values are in epoch milliseconds. Then the query we be more likely to cause a hit on the cache.","closed_by":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"performed_via_github_app":null}