{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/10291","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10291/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10291/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/10291/events","html_url":"https://github.com/elastic/elasticsearch/issues/10291","id":64717040,"node_id":"MDU6SXNzdWU2NDcxNzA0MA==","number":10291,"title":"ElasticSearch overload when handle many connections","user":{"login":"zolaahihi","id":3643184,"node_id":"MDQ6VXNlcjM2NDMxODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/3643184?v=4","gravatar_id":"","url":"https://api.github.com/users/zolaahihi","html_url":"https://github.com/zolaahihi","followers_url":"https://api.github.com/users/zolaahihi/followers","following_url":"https://api.github.com/users/zolaahihi/following{/other_user}","gists_url":"https://api.github.com/users/zolaahihi/gists{/gist_id}","starred_url":"https://api.github.com/users/zolaahihi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/zolaahihi/subscriptions","organizations_url":"https://api.github.com/users/zolaahihi/orgs","repos_url":"https://api.github.com/users/zolaahihi/repos","events_url":"https://api.github.com/users/zolaahihi/events{/privacy}","received_events_url":"https://api.github.com/users/zolaahihi/received_events","type":"User","site_admin":false},"labels":[{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":9,"created_at":"2015-03-27T08:07:39Z","updated_at":"2015-08-05T11:14:21Z","closed_at":"2015-04-05T12:44:45Z","author_association":"NONE","active_lock_reason":null,"body":"Hi all\n\nI have installed ElasticSearch (ES) version 1.5 in our server (only one server)\nI set ulimit ~ 64K (max open file).\nOur server: 4 virtual CPUs, 7.5 GB RAM (Amazon EC2)\n\nafter I start ES, many users can search with reponse respectively. But after 30 seconds to 1 minute, our ES can not response anymore connect ffrom client (PHP library, just implement curl command)\n\nI try to get PID of ES, and run command: ls /proc/ES_ID/fd | wc -l\nthe result is increase every second (~ 2 connect), and the CPU that ES process take about ~ 100%, RAM free about 60%\n\nI try to view log, here is some logs:\n_[2015-03-27 07:57:33,512][DEBUG][http.netty               ] [Impossible Man] Caught exception while handling client http traffic, closing connection [id: 0xbd4fa29e, /10.0.0.166:43963 :> /10.0.0.230:9200]\njava.nio.channels.ClosedChannelException\n        at org.elasticsearch.common.netty.channel.socket.nio.AbstractNioWorker.cleanUpWriteBuffer(AbstractNioWorker.java:433)\n        at org.elasticsearch.common.netty.channel.socket.nio.AbstractNioWorker.writeFromUserCode(AbstractNioWorker.java:128)\n        at org.elasticsearch.common.netty.channel.socket.nio.NioServerSocketPipelineSink.handleAcceptedSocket(NioServerSocketPipelineSink.java:99)\n        at org.elasticsearch.common.netty.channel.socket.nio.NioServerSocketPipelineSink.eventSunk(NioServerSocketPipelineSink.java:36)\n        at org.elasticsearch.common.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendDownstream(DefaultChannelPipeline.java:779)\n        at org.elasticsearch.common.netty.channel.Channels.write(Channels.java:725)\n        at org.elasticsearch.common.netty.handler.codec.oneone.OneToOneEncoder.doEncode(OneToOneEncoder.java:71)\n        at org.elasticsearch.common.netty.handler.codec.oneone.OneToOneEncoder.handleDownstream(OneToOneEncoder.java:59)\n        at org.elasticsearch.common.netty.channel.DefaultChannelPipeline.sendDownstream(DefaultChannelPipeline.java:591)\n        at org.elasticsearch.common.netty.channel.DefaultChannelPipeline$DefaultChannelHandlerContext.sendDownstream(DefaultChannelPipeline.java:784)\n        at org.elasticsearch.http.netty.pipelining.HttpPipeliningHandler.handleDownstream(HttpPipeliningHandler.java:87)\n        at org.elasticsearch.common.netty.channel.DefaultChannelPipeline.sendDownstream(DefaultChannelPipeline.java:591)\n        at org.elasticsearch.common.netty.channel.DefaultChannelPipeline.sendDownstream(DefaultChannelPipeline.java:582)\n        at org.elasticsearch.http.netty.NettyHttpChannel.sendResponse(NettyHttpChannel.java:199)\n        at org.elasticsearch.rest.action.support.RestResponseListener.processResponse(RestResponseListener.java:43)\n        at org.elasticsearch.rest.action.support.RestActionListener.onResponse(RestActionListener.java:49)\n        at org.elasticsearch.action.search.type.TransportSearchQueryThenFetchAction$AsyncAction$2.doRun(TransportSearchQueryThenFetchAction.java:149)\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:36)\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n        at java.lang.Thread.run(Thread.java:745)\n[2015-03-27 07:57:38,286][DEBUG][monitor.jvm              ] [Impossible Man] [gc][old][207][165] duration [2.7s], collections [1]/[2.8s], total [2.7s]/[5.1m], memory [811.9mb]->[836mb]/[990.7mb], all_pools {[young] [120.7mb]->[144.9mb]/[266.2mb]}{[survivor] [0b]->[0b]/[33.2mb]}{[old] [691.2mb]->[691.2mb]/[691.2mb]}_\n# \n\nHere is some configurations I added:\nscript.groovy.sandbox.enabled: true\n\nbootstrap.mlockall: true\n\nthreadpool.index.type: fixed\nthreadpool.index.size: 4\nthreadpool.index.queue_size: 400\nthreadpool.search.queue_size: 1000\nthreadpool.search.type: cached\nthreadpool.bulk.type: fixed\nthreadpool.bulk.size: 4                 # availableProcessors\nthreadpool.bulk.queue_size: 1000\n\nAnd the remaining configurations are default.\n\nWith those connections (many connections), when I use version 0.9x, everything still OK - work normally. I must upgrade because critical security of ES :(\n\nCould you help me solve that problem :( :(((((((((((((((((((((\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}