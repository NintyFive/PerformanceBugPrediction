{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/14382","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14382/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14382/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/14382/events","html_url":"https://github.com/elastic/elasticsearch/issues/14382","id":114258415,"node_id":"MDU6SXNzdWUxMTQyNTg0MTU=","number":14382,"title":"High heap memory consumption","user":{"login":"kiryam","id":146705,"node_id":"MDQ6VXNlcjE0NjcwNQ==","avatar_url":"https://avatars0.githubusercontent.com/u/146705?v=4","gravatar_id":"","url":"https://api.github.com/users/kiryam","html_url":"https://github.com/kiryam","followers_url":"https://api.github.com/users/kiryam/followers","following_url":"https://api.github.com/users/kiryam/following{/other_user}","gists_url":"https://api.github.com/users/kiryam/gists{/gist_id}","starred_url":"https://api.github.com/users/kiryam/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/kiryam/subscriptions","organizations_url":"https://api.github.com/users/kiryam/orgs","repos_url":"https://api.github.com/users/kiryam/repos","events_url":"https://api.github.com/users/kiryam/events{/privacy}","received_events_url":"https://api.github.com/users/kiryam/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2015-10-30T12:13:56Z","updated_at":"2015-10-30T13:45:16Z","closed_at":"2015-10-30T13:45:16Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Need help with memory consumption. \n\nThis is our cluster:\n![2015-10-30 17-00-36 kopf elasticsearch](https://cloud.githubusercontent.com/assets/146705/10845214/c656fa96-7f27-11e5-834f-65e440a94415.png)\n\nOn start (about 3 or more hours) we have green line (heap memory usage). After two or more houre we can see red line (heap memory usage)\n![2015-10-30 17-02-58](https://cloud.githubusercontent.com/assets/146705/10845270/45a76b46-7f28-11e5-8965-099fbdc7d664.png)\n\nAfter that node crased: \nGC prints messages in logs like this.\n\n```\n[2015-10-28 20:37:42,134][WARN ][monitor.jvm              ] [process8] [gc][old][1312][37] duration [21s], collections [1]/[21.7s], total [21s]/[7.3m], memory [19.4gb]->[18.1gb]/[19.9gb], all_pools {[young] [231.3mb]->[114.6mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [19.1gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:38:07,962][WARN ][monitor.jvm              ] [process8] [gc][old][1315][38] duration [23.2s], collections [1]/[23.7s], total [23.2s]/[7.7m], memory [19.2gb]->[18gb]/[19.9gb], all_pools {[young] [8.5mb]->[16.1mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [19.1gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:38:34,725][WARN ][monitor.jvm              ] [process8] [gc][old][1322][39] duration [20.6s], collections [1]/[20.7s], total [20.6s]/[8m], memory [19.7gb]->[18.1gb]/[19.9gb], all_pools {[young] [479.9mb]->[60.6mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [19.2gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:39:00,554][WARN ][monitor.jvm              ] [process8] [gc][old][1325][40] duration [23.1s], collections [1]/[23.8s], total [23.1s]/[8.4m], memory [19.4gb]->[18.1gb]/[19.9gb], all_pools {[young] [491.6mb]->[87.7mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [18.9gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:39:25,743][WARN ][monitor.jvm              ] [process8] [gc][old][1333][41] duration [18s], collections [1]/[18.1s], total [18s]/[8.7m], memory [19.5gb]->[18.1gb]/[19.9gb], all_pools {[young] [461.7mb]->[49.5mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [19gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:39:52,107][WARN ][monitor.jvm              ] [process8] [gc][old][1343][42] duration [16.9s], collections [1]/[17.3s], total [16.9s]/[9m], memory [19.4gb]->[18.1gb]/[19.9gb], all_pools {[young] [429.8mb]->[65.4mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [18.9gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:40:19,758][WARN ][monitor.jvm              ] [process8] [gc][old][1349][43] duration [22.3s], collections [1]/[22.6s], total [22.3s]/[9.4m], memory [19.2gb]->[18.1gb]/[19.9gb], all_pools {[young] [265.9mb]->[87.5mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [18.9gb]->[18gb]/[19.3gb]}\n[2015-10-28 20:40:44,749][WARN ][monitor.jvm              ] [process8] [gc][old][1352][44] duration [22.7s], collections [1]/[22.9s], total [22.7s]/[9.7m], memory [19.2gb]->[18gb]/[19.9gb], all_pools {[young] [284.5mb]->[5.2mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [18.9gb]->[18gb]/[19.3gb]}\n[2015-10-28 21:57:08,889][INFO ][monitor.jvm              ] [process8] [gc][old][5920][279] duration [15.1s], collections [2]/[15.7s], total [15.1s]/[10.3m], memory [19.3gb]->[18.5gb]/[19.9gb], all_pools {[young] [209.6mb]->[70.2mb]/[532.5mb]}{[survivor] [66.5mb]->[0b]/[66.5mb]}{[old] [19gb]->[18.4gb]/[19.3gb]}\n```\n\nWe have some custom settings in elasticsearch.yml\n\n```\nbootstrap.mlockall: true\nindex.query.bool.max_clause_count: 100000\nthreadpool.bulk.queue_size: 300\nhttp.max_content_length: 500mb\ntransport.tcp.compress: true\nindex.load_fixed_bitset_filters_eagerly: false\n```\n\nHere screenshot of dump analyzer (we have memory dump too 26GB )\n\n| Class Name | Shallow Heap | Retained Heap | Percentage |\n| --- | --- | --- | --- |\n| org.elasticsearch.common.cache.LocalCache$LocalManualCache @ 0xdee6ad78 | 16 | 11,148,875,400 | 42.23% |\n\n---\n\n![2015-10-30 16-56-06 eclipse memory analyzer](https://cloud.githubusercontent.com/assets/146705/10845143/3cb5a422-7f27-11e5-93de-2eb27524072c.png)\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}