{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/25424","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25424/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25424/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/25424/events","html_url":"https://github.com/elastic/elasticsearch/issues/25424","id":238795549,"node_id":"MDU6SXNzdWUyMzg3OTU1NDk=","number":25424,"title":"Issue on deleting ES Snapshot with Azure plugin","user":{"login":"etiennecarriere","id":29041215,"node_id":"MDQ6VXNlcjI5MDQxMjE1","avatar_url":"https://avatars0.githubusercontent.com/u/29041215?v=4","gravatar_id":"","url":"https://api.github.com/users/etiennecarriere","html_url":"https://github.com/etiennecarriere","followers_url":"https://api.github.com/users/etiennecarriere/followers","following_url":"https://api.github.com/users/etiennecarriere/following{/other_user}","gists_url":"https://api.github.com/users/etiennecarriere/gists{/gist_id}","starred_url":"https://api.github.com/users/etiennecarriere/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/etiennecarriere/subscriptions","organizations_url":"https://api.github.com/users/etiennecarriere/orgs","repos_url":"https://api.github.com/users/etiennecarriere/repos","events_url":"https://api.github.com/users/etiennecarriere/events{/privacy}","received_events_url":"https://api.github.com/users/etiennecarriere/received_events","type":"User","site_admin":false},"labels":[{"id":143077482,"node_id":"MDU6TGFiZWwxNDMwNzc0ODI=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Snapshot/Restore","name":":Distributed/Snapshot/Restore","color":"0e8a16","default":false,"description":"Anything directly related to the `_snapshot/*` APIs"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2017-06-27T09:49:56Z","updated_at":"2017-09-11T23:09:27Z","closed_at":"2017-09-11T23:09:27Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"Hi,\r\n\r\nI have issues to delete snapshot on a repository managed with Azure plugin : \r\n* Our configuration is the following : \r\n   = ElasticSearch version : 5.4.1 (via https://artifacts.elastic.co/packages/5.x/yum)\r\n   = Plugins installed : x-pack, repository-azure\r\n   = JVM version : Openjdk 1.8.0.121 (RPM : java-1.8.0-openjdk-1.8.0.121-0.b13.el7_3.x86_64)\r\n   = OS Version : Centos 7.3 / Linux xxx 3.10.0-514.10.2.el7.x86_64 #1 SMP Fri Mar 3 00:04:05 UTC 2017 x86_64 x86_64 x86_64 GNU/Linux\r\n   =  Point to note : We use the Azure plugin but we are not in the Azure infrastructure\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nExpected behaviour : \r\n* Possibility to delete more than one snapshot from Azure repository \r\nActual Behaviour: \r\n* The DELETE Request never ends up\r\n* When you ask the status of the Snapshot, you take a 404 snapshot_missing_exception\r\n* When you try to delete an other snapshot, you get a 503 concurrent_snapshot_execution_exception\r\n\r\n**Steps to reproduce**:\r\n\r\nI always achieve to reproduce it on my test environnement (happens first on production) : \r\n1)  curl -v -X DELETE http://X.Y.Z.T:9200/_snapshot/testbackups-azure/snapshot_XXX . The request hangs up\r\n2) In the same time, on the second terminal , curl -v http://X.Y.Z.T:9200/_snapshot/testbackups-azure/snapshot_XXX. You get \r\n{\"error\":{\"root_cause\":[{\"type\":\"snapshot_missing_exception\",\"reason\":\"[testbackups-azure:snapshot_XXX] is missing\"}],\"type\":\"snapshot_missing_exception\",\"reason\":\"[testbackups-azure:snapshot_XXX] is missing\"},\"status\":404}\r\n3) On the second terminal, ask for curl -v -X DELETE http://X.Y.Z.T:9200/_snapshot/testbackups-azure/snapshot_YYY (a different Snapshot this time).\r\n{\"error\":{\"root_cause\":[{\"type\":\"concurrent_snapshot_execution_exception\",\"reason\":\"[testbackups-azure:snapshot_YYY/ZZZ] cannot delete - another snapshot is currently being deleted\"}],\"type\":\"concurrent_snapshot_execution_exception\",\"reason\":\"[testbackups-azure:snapshot_YYY/ZZZ] cannot delete - another snapshot is currently being deleted\"},\"status\":503}\r\n\r\nWhen I do a rolling restart of the cluster ES, it come back to normal and the first snapshot (XXX in our case) is no more present and it is possible to delete an snapshot. \r\n\r\n","closed_by":{"login":"rjernst","id":289412,"node_id":"MDQ6VXNlcjI4OTQxMg==","avatar_url":"https://avatars3.githubusercontent.com/u/289412?v=4","gravatar_id":"","url":"https://api.github.com/users/rjernst","html_url":"https://github.com/rjernst","followers_url":"https://api.github.com/users/rjernst/followers","following_url":"https://api.github.com/users/rjernst/following{/other_user}","gists_url":"https://api.github.com/users/rjernst/gists{/gist_id}","starred_url":"https://api.github.com/users/rjernst/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rjernst/subscriptions","organizations_url":"https://api.github.com/users/rjernst/orgs","repos_url":"https://api.github.com/users/rjernst/repos","events_url":"https://api.github.com/users/rjernst/events{/privacy}","received_events_url":"https://api.github.com/users/rjernst/received_events","type":"User","site_admin":false},"performed_via_github_app":null}