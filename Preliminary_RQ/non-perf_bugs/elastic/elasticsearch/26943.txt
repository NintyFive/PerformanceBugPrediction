{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/26943","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26943/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26943/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/26943/events","html_url":"https://github.com/elastic/elasticsearch/issues/26943","id":264170454,"node_id":"MDU6SXNzdWUyNjQxNzA0NTQ=","number":26943,"title":"request limit breaker does not calculate estimated_size_in_bytes correctly, which causes all the aggregations failed ","user":{"login":"xzer","id":1311634,"node_id":"MDQ6VXNlcjEzMTE2MzQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1311634?v=4","gravatar_id":"","url":"https://api.github.com/users/xzer","html_url":"https://github.com/xzer","followers_url":"https://api.github.com/users/xzer/followers","following_url":"https://api.github.com/users/xzer/following{/other_user}","gists_url":"https://api.github.com/users/xzer/gists{/gist_id}","starred_url":"https://api.github.com/users/xzer/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/xzer/subscriptions","organizations_url":"https://api.github.com/users/xzer/orgs","repos_url":"https://api.github.com/users/xzer/repos","events_url":"https://api.github.com/users/xzer/events{/privacy}","received_events_url":"https://api.github.com/users/xzer/received_events","type":"User","site_admin":false},"labels":[{"id":166507771,"node_id":"MDU6TGFiZWwxNjY1MDc3NzE=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Infra/Circuit%20Breakers","name":":Core/Infra/Circuit Breakers","color":"0e8a16","default":false,"description":"Track estimates of memory consumption to prevent overload"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"assignees":[{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false}],"milestone":null,"comments":11,"created_at":"2017-10-10T10:08:02Z","updated_at":"2017-11-28T03:21:12Z","closed_at":"2017-11-27T17:41:32Z","author_association":"NONE","active_lock_reason":null,"body":"<!--\r\n\r\n** Please read the guidelines below. **\r\n\r\nIssues that do not follow these guidelines are likely to be closed.\r\n\r\n1.  GitHub is reserved for bug reports and feature requests. The best place to\r\n    ask a general question is at the Elastic [forums](https://discuss.elastic.co).\r\n    GitHub is not the place for general questions.\r\n\r\n2.  Is this bug report or feature request for a supported OS? If not, it\r\n    is likely to be closed.  See https://www.elastic.co/support/matrix#show_os\r\n\r\n3.  Please fill out EITHER the feature request block or the bug report block\r\n    below, and delete the other block.\r\n\r\n-->\r\n\r\n<!-- Feature request -->\r\n\r\n**Describe the feature**:\r\n\r\n<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 5.4.3\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.0_131\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Debian 3.16.43-2\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nwe have 6 nodes cluster and we noticed that the estimated_size_in_bytes of request breaker keep increasing, which causes all the aggregation failed when the estimated_size_in_bytes reach at the configured limit.\r\n\r\nwe have 31g heap size and 24g old gen congiured. we also configured the request limit as 2g, after we tripped by the limit breaker, if we increase the limit to 4g dynamically, of course, we got our queries revived. But, after we increased our limit to 4g, we also noticed that the increasing speed of estimated_size_in_bytes became extremely slowly, and almost keep at the original 2G level.\r\n\r\nAnother related information is that we also configured our request cache to 2g. At first, we suspected that the cached result does not count down the estimated size in request because the resource may not be release, but after we clear the request cache, the estimated size of request limit breaker remains without decreasing. after we clear cache, we increased limit dynamically, and then, as described above, the increasing of estimated_size_in_bytes became slowly.\r\n\r\n(additinal info: after 3 hours test, the estimated_size_in_bytes is increasing again, now it has been over 2.5g)\r\n\r\nthe following graph suggest how the counter is increasing and the cache increasing, query cache and request cache was not collected initially.\r\n\r\n![image](https://user-images.githubusercontent.com/1311634/31387158-5aabbc4c-ae04-11e7-98b6-0a6f8d4fa5db.png)\r\n\r\nWe found an old issue here with almost same symptom, according the description in the issue, there may be OOM, but we did not get OOM by check our log files.\r\n\r\nhttps://github.com/elastic/elasticsearch/issues/14065\r\n\r\nWe also did some source digging, by step by step debugging, we confirmed that at the following location:\r\n\r\nhttps://github.com/elastic/elasticsearch/blob/v5.4.3/core/src/main/java/org/elasticsearch/common/breaker/ChildMemoryCircuitBreaker.java#L155\r\n\r\nthe currentUsed is zero at the first time we stop at the breakpoint after we started the first query, and then, after the first query finished, we perform the second one, we noticed that the currentUsed is not zero at  the first time stopping after we performed the second query.\r\n\r\nAslo, even we highly suspect our discovery and believe that we must missing something in the source,   we noticed that the request limit breaker is retrieved from a global registry and it seems that it does not act per-request which is described in the document. \r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. keep running queries with aggregation\r\n 2. keep check [curl -XGET 'http://127.0.0.1:9200/_nodes/stats/breaker?pretty']\r\n 3. keeping increasing estimated_size_in_bytes can be observed.\r\n\r\n\r\n","closed_by":{"login":"dakrone","id":19060,"node_id":"MDQ6VXNlcjE5MDYw","avatar_url":"https://avatars3.githubusercontent.com/u/19060?v=4","gravatar_id":"","url":"https://api.github.com/users/dakrone","html_url":"https://github.com/dakrone","followers_url":"https://api.github.com/users/dakrone/followers","following_url":"https://api.github.com/users/dakrone/following{/other_user}","gists_url":"https://api.github.com/users/dakrone/gists{/gist_id}","starred_url":"https://api.github.com/users/dakrone/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dakrone/subscriptions","organizations_url":"https://api.github.com/users/dakrone/orgs","repos_url":"https://api.github.com/users/dakrone/repos","events_url":"https://api.github.com/users/dakrone/events{/privacy}","received_events_url":"https://api.github.com/users/dakrone/received_events","type":"User","site_admin":false},"performed_via_github_app":null}