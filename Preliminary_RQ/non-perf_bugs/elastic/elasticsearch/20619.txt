{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/20619/events","html_url":"https://github.com/elastic/elasticsearch/issues/20619","id":178418204,"node_id":"MDU6SXNzdWUxNzg0MTgyMDQ=","number":20619,"title":"parent/child relation not working correctly","user":{"login":"fesnault","id":261169,"node_id":"MDQ6VXNlcjI2MTE2OQ==","avatar_url":"https://avatars2.githubusercontent.com/u/261169?v=4","gravatar_id":"","url":"https://api.github.com/users/fesnault","html_url":"https://github.com/fesnault","followers_url":"https://api.github.com/users/fesnault/followers","following_url":"https://api.github.com/users/fesnault/following{/other_user}","gists_url":"https://api.github.com/users/fesnault/gists{/gist_id}","starred_url":"https://api.github.com/users/fesnault/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fesnault/subscriptions","organizations_url":"https://api.github.com/users/fesnault/orgs","repos_url":"https://api.github.com/users/fesnault/repos","events_url":"https://api.github.com/users/fesnault/events{/privacy}","received_events_url":"https://api.github.com/users/fesnault/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2016-09-21T17:54:35Z","updated_at":"2018-02-14T13:28:28Z","closed_at":"2016-09-23T15:16:01Z","author_association":"NONE","active_lock_reason":null,"body":"**Elasticsearch version**: 2.1.2\n\n**Plugins installed**: [kopf]\n\n**JVM version**: Oracle JDK 1.7\n\n**OS version**: Ubuntu 14 & OS X 10.11.6\n\n**Description of the problem including expected versus actual behavior**:\n\nIn an index with documents linked by a parent/child relationship, I have a strange behaviour while trying to get/filter documents on their parents or on their children.\n\nMy use case is I have some documents containing fields (subject, content, creator, creation_date, status (draft, reviewed,...) indexed in elasticsearch. For some fields of the documents (for example its status), I also have indexed the history of changes (for example the change from draft to review, the time spent in the oldest status, the person who changed the status, when,...). \n\nDocuments and History items are indexed in two different types (doc_mapping and doc_mapping_history) of the same index.\n\nI'm trying to get the number of status change in one document (simplified version of my real request). So I try to do like this :\n\n```\nGET myindex/doc_mapping/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"document_key\": \"MYDOC803\"\n          }\n        },\n        {\n          \"range\": {\n            \"created\": {\n              \"gte\": \"01/06/2016\",\n              \"lte\": \"30/06/2016\",\n              \"format\": \"dd/MM/yyyy\"\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nThis gives me my expected documents, no problem. But if I add this, i have no result **or only some results** (yes it's strange, some work, some do not) :\n\n```\nGET myindex/doc_mapping/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"document_key\": \"MYDOC803\"\n          }\n        },\n        {\n          \"range\": {\n            \"created\": {\n              \"gte\": \"01/06/2016\",\n              \"lte\": \"30/06/2016\",\n              \"format\": \"dd/MM/yyyy\"\n            }\n          }\n        },\n        {\n          \"has_child\": {\n            \"type\": \"doc_mapping_history\",\n            \"query\": {\n              \"match_all\": {}\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nThe strange thing is that the child documents **are** present in the index. I can see them if i execute this : \n\n```\nGET myindex/doc_mapping_history/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"document\": \"MYDOC803\"\n          }\n        },\n        {\n          \"term\": {\n            \"field\": \"status\"\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nI have the expected results. But if I had this, then no result comes back :\n\n```\nGET myindex/doc_mapping_history/_search\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"document\": \"MYDOC803\"\n          }\n        },\n        {\n          \"term\": {\n            \"field\": \"status\"\n          }\n        },\n        {\n          \"has_parent\": {\n            \"type\": \"doc_mapping\",\n            \"query\": {\n              \"match_all\": {}\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n```\n\nIs there a bug in ES 2.1.2 about child/parent management, which could lead to some documents being correctly processed/indexed/retrieved, or am I missing something ?\n\nI must add that I tried this on two environment : my dev environment and the production-ready environement. Problem is exactly the same, the same documents fail, the same documents work.\nI don't see any error in the logs during indexing or during querying, either in ES logs or in my app logs. Note that I now try my queries directly in kopf plugin, and the result is the same, so my app is not responsible. \n\nSo the problem either comes from my mapping, my indexing, my querying, or from ES itself.\nDo anyone have an idea?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}