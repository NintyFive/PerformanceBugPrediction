{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/31099","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31099/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31099/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/31099/events","html_url":"https://github.com/elastic/elasticsearch/issues/31099","id":329403103,"node_id":"MDU6SXNzdWUzMjk0MDMxMDM=","number":31099,"title":"Bulk index tasks stuck forever","user":{"login":"jeancornic","id":1595643,"node_id":"MDQ6VXNlcjE1OTU2NDM=","avatar_url":"https://avatars0.githubusercontent.com/u/1595643?v=4","gravatar_id":"","url":"https://api.github.com/users/jeancornic","html_url":"https://github.com/jeancornic","followers_url":"https://api.github.com/users/jeancornic/followers","following_url":"https://api.github.com/users/jeancornic/following{/other_user}","gists_url":"https://api.github.com/users/jeancornic/gists{/gist_id}","starred_url":"https://api.github.com/users/jeancornic/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jeancornic/subscriptions","organizations_url":"https://api.github.com/users/jeancornic/orgs","repos_url":"https://api.github.com/users/jeancornic/repos","events_url":"https://api.github.com/users/jeancornic/events{/privacy}","received_events_url":"https://api.github.com/users/jeancornic/received_events","type":"User","site_admin":false},"labels":[{"id":145572580,"node_id":"MDU6TGFiZWwxNDU1NzI1ODA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/CRUD","name":":Distributed/CRUD","color":"0e8a16","default":false,"description":"A catch all label for issues around indexing, updating and getting a doc by id. Not search."},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":16,"created_at":"2018-06-05T10:53:17Z","updated_at":"2020-03-30T20:03:50Z","closed_at":"2018-10-09T22:28:25Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 6.1.3\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`):\r\n\r\n```\r\njava version \"1.8.0_161\"\r\nJava(TM) SE Runtime Environment (build 1.8.0_161-b12)\r\nJava HotSpot(TM) 64-Bit Server VM (build 25.161-b12, mixed mode)\r\n```\r\n\r\n**OS version** (`uname -a` if on a Unix-like system):\r\n\r\n```\r\nLinux *** 4.4.0-1049-aws #58-Ubuntu SMP Fri Jan 12 23:17:09 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux\r\n```\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nSeeing a weird behaviour, with bulk index actions that never finish.\r\nThey are triggered by the Elasticsearch Java client (version 6.1.3), through a `BulkRequestBuilder`, with the default timeout (1m). Seems we never enter the `ActionListener` callbacks.\r\n\r\nI found out recently that it's linked with tasks running indefinitely. When checking the /_tasks api, I'm seeing tasks that have been running for several days (!)..\r\n\r\n```\r\n$ curl 'localhost:9200/_tasks?pretty&human&actions=indices:data/write/bulk&detailed'\r\n...\r\n    \"pd5MT4eUSEqsOy_oq_q-vw\" : {\r\n      \"name\" : \"***\",\r\n      \"transport_address\" : \"***\",\r\n      \"host\" : \"***\",\r\n      \"ip\" : \"***\",\r\n      \"roles\" : [\r\n        \"data\"\r\n      ],\r\n      \"attributes\" : {\r\n        \"availability_zone\" : \"us-east-1c\",\r\n        \"tag\" : \"fresh\"\r\n      },\r\n      \"tasks\" : {\r\n        \"pd5MT4eUSEqsOy_oq_q-vw:208477658\" : {\r\n          \"node\" : \"pd5MT4eUSEqsOy_oq_q-vw\",\r\n          \"id\" : 208477658,\r\n          \"type\" : \"netty\",\r\n          \"action\" : \"indices:data/write/bulk\",\r\n          \"start_time\" : \"2018-04-12T21:17:45.175Z\",\r\n          \"start_time_in_millis\" : 1523567865175,\r\n          \"running_time\" : \"53.4d\",\r\n          \"running_time_in_nanos\" : 4622108629250516,\r\n          \"cancellable\" : false\r\n        }\r\n      }\r\n    },\r\n...\r\n```\r\n\r\nI would expect the bulk action to run for 1min, and then timeout.\r\n\r\nI came across several issues / PRs on github:\r\n- https://github.com/elastic/elasticsearch/pull/28667: could it be related to the issue?\r\n- https://github.com/elastic/elasticsearch/issues/25863: seems like a similar issue, but we're running a newer version, and we have no rejection logs in ES, so I don't believe that's it.\r\n\r\n**Steps to reproduce**: I have no idea, it happens randomly, since we migrated from 5.6 to 6.1.3.\r\n\r\n**Provide logs (if relevant)**: found nothing relevant nor in ES, nor in the client logs.\r\n\r\n","closed_by":{"login":"ywelsch","id":3718355,"node_id":"MDQ6VXNlcjM3MTgzNTU=","avatar_url":"https://avatars3.githubusercontent.com/u/3718355?v=4","gravatar_id":"","url":"https://api.github.com/users/ywelsch","html_url":"https://github.com/ywelsch","followers_url":"https://api.github.com/users/ywelsch/followers","following_url":"https://api.github.com/users/ywelsch/following{/other_user}","gists_url":"https://api.github.com/users/ywelsch/gists{/gist_id}","starred_url":"https://api.github.com/users/ywelsch/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/ywelsch/subscriptions","organizations_url":"https://api.github.com/users/ywelsch/orgs","repos_url":"https://api.github.com/users/ywelsch/repos","events_url":"https://api.github.com/users/ywelsch/events{/privacy}","received_events_url":"https://api.github.com/users/ywelsch/received_events","type":"User","site_admin":false},"performed_via_github_app":null}