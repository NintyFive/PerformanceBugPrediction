[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222453942","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-222453942","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":222453942,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjQ1Mzk0Mg==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2016-05-30T09:37:26Z","updated_at":"2016-05-30T09:37:26Z","author_association":"MEMBER","body":"Thanks for reporting this.\nCould you check manually if you can see the file on S3 and what are its properties?\n\nIf you run again the same restore command does it fail exactly the same way?\n\nCc @imotov \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222454475","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-222454475","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":222454475,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjQ1NDQ3NQ==","user":{"login":"raags","id":697714,"node_id":"MDQ6VXNlcjY5NzcxNA==","avatar_url":"https://avatars1.githubusercontent.com/u/697714?v=4","gravatar_id":"","url":"https://api.github.com/users/raags","html_url":"https://github.com/raags","followers_url":"https://api.github.com/users/raags/followers","following_url":"https://api.github.com/users/raags/following{/other_user}","gists_url":"https://api.github.com/users/raags/gists{/gist_id}","starred_url":"https://api.github.com/users/raags/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raags/subscriptions","organizations_url":"https://api.github.com/users/raags/orgs","repos_url":"https://api.github.com/users/raags/repos","events_url":"https://api.github.com/users/raags/events{/privacy}","received_events_url":"https://api.github.com/users/raags/received_events","type":"User","site_admin":false},"created_at":"2016-05-30T09:40:13Z","updated_at":"2016-05-30T09:41:49Z","author_association":"NONE","body":"Yes, I did. I don't see the files on S3; and yes it fails for that particular snapshot. Its basically a corrupt snapshot. It fails on the same file. If I try a later snapshot it works. So its some intermittent failure.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222456548","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-222456548","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":222456548,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjQ1NjU0OA==","user":{"login":"dadoonet","id":274222,"node_id":"MDQ6VXNlcjI3NDIyMg==","avatar_url":"https://avatars3.githubusercontent.com/u/274222?v=4","gravatar_id":"","url":"https://api.github.com/users/dadoonet","html_url":"https://github.com/dadoonet","followers_url":"https://api.github.com/users/dadoonet/followers","following_url":"https://api.github.com/users/dadoonet/following{/other_user}","gists_url":"https://api.github.com/users/dadoonet/gists{/gist_id}","starred_url":"https://api.github.com/users/dadoonet/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/dadoonet/subscriptions","organizations_url":"https://api.github.com/users/dadoonet/orgs","repos_url":"https://api.github.com/users/dadoonet/repos","events_url":"https://api.github.com/users/dadoonet/events{/privacy}","received_events_url":"https://api.github.com/users/dadoonet/received_events","type":"User","site_admin":false},"created_at":"2016-05-30T09:51:13Z","updated_at":"2016-05-30T09:51:13Z","author_association":"MEMBER","body":"Thanks @raags.\n\nThe snapshot operation should have raised an exception in that case. \nSo I can see only 2 explanations:\n- Bug on AWS/S3 side: could be a bug in their SDK also which may be swallow an exception while running the snapshot.\n- Bug in AWS cloud plugin for elasticsearch which would swallow the exception while running the snapshot. I read again the code in https://github.com/elastic/elasticsearch-cloud-aws/blob/v2.7.1/src/main/java/org/elasticsearch/cloud/aws/blobstore/DefaultS3OutputStream.java and did not see anything obvious.\n\nWe are on the way of upgrading the SDK to 1.10.69 with this PR: https://github.com/elastic/elasticsearch-cloud-aws/pull/273 which might hopefully fix this behavior...\n\nWill be also merged for 2.x series with #18048 and for 5.0 with #17784.\n\nI'm unsure on how we can reproduce such an error though. Apart what we already do to simulate write or read errors: https://github.com/elastic/elasticsearch-cloud-aws/blob/v2.7.1/src/test/java/org/elasticsearch/cloud/aws/TestAmazonS3.java#L75\n\nI'm leaving it open until @imotov comments on it as well.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222745835","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-222745835","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":222745835,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjc0NTgzNQ==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-05-31T16:36:46Z","updated_at":"2016-05-31T16:36:46Z","author_association":"MEMBER","body":"@dadoonet the restore service is trying to restore these files, which means that snapshot service thought that these files were successfully written to S3. But it looks like they either were not written or they somehow disappeared afterwards. \n\n@raags was it a one time issue or you can reproduce it in your setup? \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/222925364","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-222925364","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":222925364,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMjkyNTM2NA==","user":{"login":"raags","id":697714,"node_id":"MDQ6VXNlcjY5NzcxNA==","avatar_url":"https://avatars1.githubusercontent.com/u/697714?v=4","gravatar_id":"","url":"https://api.github.com/users/raags","html_url":"https://github.com/raags","followers_url":"https://api.github.com/users/raags/followers","following_url":"https://api.github.com/users/raags/following{/other_user}","gists_url":"https://api.github.com/users/raags/gists{/gist_id}","starred_url":"https://api.github.com/users/raags/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raags/subscriptions","organizations_url":"https://api.github.com/users/raags/orgs","repos_url":"https://api.github.com/users/raags/repos","events_url":"https://api.github.com/users/raags/events{/privacy}","received_events_url":"https://api.github.com/users/raags/received_events","type":"User","site_admin":false},"created_at":"2016-06-01T08:23:18Z","updated_at":"2016-06-01T08:23:18Z","author_association":"NONE","body":"@imotov we have now correlated this occurrence with the snapshot clean up job that runs once a day. The snapshot that fails to restore happens during the cleanup. In cleanup we catch the ConcurrentExecution exception and wait/retry until the snapshot completes. Could this be causing removal of some snapshot files? Also, oddly this doesn't happen on other clusters that have the same setup (snapshot/cleanup schedules)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223099998","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-223099998","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":223099998,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzA5OTk5OA==","user":{"login":"imotov","id":655851,"node_id":"MDQ6VXNlcjY1NTg1MQ==","avatar_url":"https://avatars3.githubusercontent.com/u/655851?v=4","gravatar_id":"","url":"https://api.github.com/users/imotov","html_url":"https://github.com/imotov","followers_url":"https://api.github.com/users/imotov/followers","following_url":"https://api.github.com/users/imotov/following{/other_user}","gists_url":"https://api.github.com/users/imotov/gists{/gist_id}","starred_url":"https://api.github.com/users/imotov/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/imotov/subscriptions","organizations_url":"https://api.github.com/users/imotov/orgs","repos_url":"https://api.github.com/users/imotov/repos","events_url":"https://api.github.com/users/imotov/events{/privacy}","received_events_url":"https://api.github.com/users/imotov/received_events","type":"User","site_admin":false},"created_at":"2016-06-01T19:32:12Z","updated_at":"2016-06-01T19:32:12Z","author_association":"MEMBER","body":"@raags It looks like there is a tricky race condition in snapshot deletion. If a delete operation starts while a snapshot is being created, the delete operation indeed fails with ConcurrentSnapshotExecutionException. However, when a snapshot operation starts while a delete operation is in progress, the snapshot operation doesn't check for a running delete operation and as a result the delete operation and the snapshot operation can right simultaneously as long as a delete operation starts first . There are few more conditions that should take place sequence-wise for this condition to occur, but I can see how some files used by an in-progress snapshot might be deleted during a delete operation and cause the error that you've posted. I would guess, it might not be happening on other clusters because their cleanup and snapshot schedules are aligned slightly differently or because delete operations are slightly faster on these clusters for whatever reason and manage to finish before the next snapshot starts.\n\n@abeyad I know you are collecting possible race conditions for snapshot/restore operations. Did we capture this condition somewhere else already or should we use this issue to track it?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223132110","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-223132110","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":223132110,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzEzMjExMA==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-06-01T21:35:19Z","updated_at":"2016-06-01T21:35:19Z","author_association":"CONTRIBUTOR","body":"Yes, this is a race condition that we encountered amongst others in the past.  However, we should keep this issue open as I hadn't gotten around to capturing this one yet.  Another issue that also presents race conditions is found here: https://github.com/elastic/elasticsearch/issues/18551\n\nThough its not the same, it relates in the sense that it reveals race conditions as a result of a separation between using cluster state and the repository to maintain snapshots without added synchronization around constructs around those. \n\nAnother simple example is if we call the get snapshots API, first we look in the cluster state, get the current snapshot, then look in the repository for the rest of the snapshots. In between looking in the cluster state for running snapshots and looking in the repository, that running snapshot could have completed and gotten stored in the repository, so it would be counted twice.  This is a benign example but is a manifestation of this class of race conditions. \n\nWe have discussed these and been capturing them along the way and are in the process of formulating ideas to fix them. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/223253454","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-223253454","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":223253454,"node_id":"MDEyOklzc3VlQ29tbWVudDIyMzI1MzQ1NA==","user":{"login":"raags","id":697714,"node_id":"MDQ6VXNlcjY5NzcxNA==","avatar_url":"https://avatars1.githubusercontent.com/u/697714?v=4","gravatar_id":"","url":"https://api.github.com/users/raags","html_url":"https://github.com/raags","followers_url":"https://api.github.com/users/raags/followers","following_url":"https://api.github.com/users/raags/following{/other_user}","gists_url":"https://api.github.com/users/raags/gists{/gist_id}","starred_url":"https://api.github.com/users/raags/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/raags/subscriptions","organizations_url":"https://api.github.com/users/raags/orgs","repos_url":"https://api.github.com/users/raags/repos","events_url":"https://api.github.com/users/raags/events{/privacy}","received_events_url":"https://api.github.com/users/raags/received_events","type":"User","site_admin":false},"created_at":"2016-06-02T10:24:41Z","updated_at":"2016-06-02T10:24:41Z","author_association":"NONE","body":"Thanks for the quick turn around. The once a day clean up task used to take a long time, which is why the snapshot conflict happened. We have changed the cleanup interval to every other hour now, so its faster. \n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/239206525","html_url":"https://github.com/elastic/elasticsearch/issues/18632#issuecomment-239206525","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/18632","id":239206525,"node_id":"MDEyOklzc3VlQ29tbWVudDIzOTIwNjUyNQ==","user":{"login":"abeyad","id":1631297,"node_id":"MDQ6VXNlcjE2MzEyOTc=","avatar_url":"https://avatars2.githubusercontent.com/u/1631297?v=4","gravatar_id":"","url":"https://api.github.com/users/abeyad","html_url":"https://github.com/abeyad","followers_url":"https://api.github.com/users/abeyad/followers","following_url":"https://api.github.com/users/abeyad/following{/other_user}","gists_url":"https://api.github.com/users/abeyad/gists{/gist_id}","starred_url":"https://api.github.com/users/abeyad/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/abeyad/subscriptions","organizations_url":"https://api.github.com/users/abeyad/orgs","repos_url":"https://api.github.com/users/abeyad/repos","events_url":"https://api.github.com/users/abeyad/events{/privacy}","received_events_url":"https://api.github.com/users/abeyad/received_events","type":"User","site_admin":false},"created_at":"2016-08-11T16:00:14Z","updated_at":"2016-08-11T16:00:14Z","author_association":"CONTRIBUTOR","body":"The issue with restores mentioned in this issue will largely go away with the following fix: https://github.com/elastic/elasticsearch/pull/19853.  In this PR, we check if a restore is in progress before attempting to execute a snapshot deletion.\n\nThere is still a slight possibility for race conditions, which is a larger issue that needs to be tackled and I opened an issue for it: https://github.com/elastic/elasticsearch/issues/19957\n\nClosing this issue.\n","performed_via_github_app":null}]