{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/41597","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41597/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41597/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/41597/events","html_url":"https://github.com/elastic/elasticsearch/issues/41597","id":437779056,"node_id":"MDU6SXNzdWU0Mzc3NzkwNTY=","number":41597,"title":"SQL: impossible to apply a REPLACE function on a aggregated value","user":{"login":"fbaligand","id":3750300,"node_id":"MDQ6VXNlcjM3NTAzMDA=","avatar_url":"https://avatars1.githubusercontent.com/u/3750300?v=4","gravatar_id":"","url":"https://api.github.com/users/fbaligand","html_url":"https://github.com/fbaligand","followers_url":"https://api.github.com/users/fbaligand/followers","following_url":"https://api.github.com/users/fbaligand/following{/other_user}","gists_url":"https://api.github.com/users/fbaligand/gists{/gist_id}","starred_url":"https://api.github.com/users/fbaligand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/fbaligand/subscriptions","organizations_url":"https://api.github.com/users/fbaligand/orgs","repos_url":"https://api.github.com/users/fbaligand/repos","events_url":"https://api.github.com/users/fbaligand/events{/privacy}","received_events_url":"https://api.github.com/users/fbaligand/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"assignees":[{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false}],"milestone":null,"comments":6,"created_at":"2019-04-26T17:47:35Z","updated_at":"2020-04-16T13:11:10Z","closed_at":"2020-04-16T12:33:55Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version** (`bin/elasticsearch --version`): 7.0\r\n\r\n**JVM version** (`java -version`): Oracle JDK 1.8\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Windows 10\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nWhen I do a SQL query, and try to apply a REPLACE function on a aggregated function, it throws an exception : \r\n`{\r\n  \"error\": {\r\n    \"root_cause\": [\r\n      {\r\n        \"type\": \"sql_illegal_argument_exception\",\r\n        \"reason\": \"Unexpected value reference class org.elasticsearch.xpack.sql.querydsl.container.GroupByRef\"\r\n      }\r\n    ],\r\n    \"type\": \"sql_illegal_argument_exception\",\r\n    \"reason\": \"Unexpected value reference class org.elasticsearch.xpack.sql.querydsl.container.GroupByRef\"\r\n  },\r\n  \"status\": 500\r\n}`\r\n\r\nThe expected result is simply the SQL response.\r\n\r\n**Steps to reproduce**:\r\n\r\nPlease include a *minimal* but *complete* recreation of the problem, including\r\n(e.g.) index creation, mappings, settings, query etc.  The easier you make for\r\nus to reproduce it, the more likely that somebody will take the time to look at it.\r\n\r\n 1. install Kibana sample named \"Sample web logs\"\r\n 2. execute this SQL query in Kibana Dev Tools : \r\n```\r\nPOST _sql?format=csv\r\n{\r\n  \"query\": \"SELECT response, REPLACE(CONVERT(AVG(phpmemory), text), '.', ',') as phpmemory_avg FROM kibana_sample_data_logs WHERE phpmemory IS NOT NULL AND response IS NOT NULL GROUP BY response LIMIT 2\"\r\n}\r\n```\r\n 3. To give more context, if I do this SQL query, it works fine:\r\n```\r\nPOST _sql?format=csv\r\n{\r\n  \"query\": \"SELECT response, CONVERT(AVG(phpmemory), text) as phpmemory_avg FROM kibana_sample_data_logs WHERE phpmemory IS NOT NULL AND response IS NOT NULL GROUP BY response LIMIT 2\"\r\n}\r\n\r\n**Provide logs (if relevant)**:\r\nHere's the server log error:\r\n```\r\n[2019-04-26T19:43:43,768][WARN ][r.suppressed             ] [DWM1107442] path: /_sql, params: {pretty=, format=csv}\r\norg.elasticsearch.xpack.sql.SqlIllegalArgumentException: Unexpected value reference class org.elasticsearch.xpack.sql.querydsl.container.GroupByRef\r\n        at org.elasticsearch.xpack.sql.execution.search.Querier$ScrollActionListener.createExtractor(Querier.java:550) ~[x-pack-sql-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.xpack.sql.execution.search.Querier$ScrollActionListener.handleResponse(Querier.java:488) ~[x-pack-sql-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.xpack.sql.execution.search.Querier$BaseActionListener.onResponse(Querier.java:584) [x-pack-sql-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.xpack.sql.execution.search.Querier$BaseActionListener.onResponse(Querier.java:558) [x-pack-sql-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:68) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.support.TransportAction$1.onResponse(TransportAction.java:64) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onResponse(AbstractSearchAsyncAction.java:316) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.onResponse(AbstractSearchAsyncAction.java:51) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase$3.run(FetchSearchPhase.java:213) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.executePhase(AbstractSearchAsyncAction.java:166) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:159) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.ExpandSearchPhase.run(ExpandSearchPhase.java:120) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.executePhase(AbstractSearchAsyncAction.java:166) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.AbstractSearchAsyncAction.executeNextPhase(AbstractSearchAsyncAction.java:159) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase.moveToNextPhase(FetchSearchPhase.java:206) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase.lambda$innerRun$2(FetchSearchPhase.java:104) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase$$Lambda$3622/304215410.run(Unknown Source) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase.innerRun(FetchSearchPhase.java:110) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase.access$000(FetchSearchPhase.java:44) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.action.search.FetchSearchPhase$1.doRun(FetchSearchPhase.java:86) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.common.util.concurrent.TimedRunnable.doRun(TimedRunnable.java:41) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.common.util.concurrent.ThreadContext$ContextPreservingAbstractRunnable.doRun(ThreadContext.java:751) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at org.elasticsearch.common.util.concurrent.AbstractRunnable.run(AbstractRunnable.java:37) [elasticsearch-7.0.0.jar:7.0.0]\r\n        at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142) [?:1.8.0_25]\r\n        at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617) [?:1.8.0_25]\r\n        at java.lang.Thread.run(Thread.java:745) [?:1.8.0_25]\r\n```\r\n","closed_by":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"performed_via_github_app":null}