{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/8211","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8211/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8211/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8211/events","html_url":"https://github.com/elastic/elasticsearch/issues/8211","id":46640823,"node_id":"MDU6SXNzdWU0NjY0MDgyMw==","number":8211,"title":"using doc_count from one aggregation into another aggregation to calculate additional percentage","user":{"login":"rajeshetty","id":8227894,"node_id":"MDQ6VXNlcjgyMjc4OTQ=","avatar_url":"https://avatars3.githubusercontent.com/u/8227894?v=4","gravatar_id":"","url":"https://api.github.com/users/rajeshetty","html_url":"https://github.com/rajeshetty","followers_url":"https://api.github.com/users/rajeshetty/followers","following_url":"https://api.github.com/users/rajeshetty/following{/other_user}","gists_url":"https://api.github.com/users/rajeshetty/gists{/gist_id}","starred_url":"https://api.github.com/users/rajeshetty/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/rajeshetty/subscriptions","organizations_url":"https://api.github.com/users/rajeshetty/orgs","repos_url":"https://api.github.com/users/rajeshetty/repos","events_url":"https://api.github.com/users/rajeshetty/events{/privacy}","received_events_url":"https://api.github.com/users/rajeshetty/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":5,"created_at":"2014-10-23T15:49:10Z","updated_at":"2014-10-27T09:24:11Z","closed_at":"2014-10-24T13:55:12Z","author_association":"NONE","active_lock_reason":null,"body":"Lets say I have doc like this\n\n<pre>\n\n      {\n       user_id : \"12312321321\"\n       location_shared_with { [ ]},\n       location {location_name:.... \n                      location_verification[{} ]\n                } \n       }\n\n</pre>\n\nIn here location_verification is an array of all the friends who have verified the location and it will always be equal or less than location_shared_with array.\n\nmapping\n\n<pre>\n\n    { \n        \"user\" : \n            {\"properties\" : \n                 { \n                    \"locations\":\n                    {\n                        \"type\" : \"nested\",\n                        \"properties\" : \n                        {\n                            \"location_name\": { \"type\": \"string\", \"index\": \"not_analyzed\"},\n                            \"location_verification\":\n                            {\n                                \"type\" : \"nested\",\n                                \"properties\" : \n                                {\n                                    \"rating\": { \"type\": \"short\", \"store\":\"true\" }\n                                }\n                            }\n                        }\n                    },\n                    \"location_shared_with\":\n                    {\n                        \"type\" : \"nested\",\n                        \"properties\" : \n                        {\n                            \"status\": { \"type\": \"string\", \"store\":\"true\", \"index\": \"analyzed\"},\n                            \"friend_id\": { \"type\": \"string\", \"store\" : \"true\"}\n                        }\n                    }\n                 }\n            }\n    }'\n\n</pre>\n\n\nSo I need to calculate the % verified per location array . I have created right \"nested\" mapping between main doc (user) and location , location and location_verification.  I have terms aggregation that tells me \n\nwhen I execute\n\n```\n<pre>\nGET _search?search_type=count\n{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"term\": {\n            \"user_id\": \"1\"\n          }\n        }\n      ]\n    }\n  },  \n  \"aggs\": {\n    \"location_shared_with_count\":{\n      \"nested\": {\n        \"path\": \"location_shared_with\"\n      }\n     },\n    \"locations_count\": {\n      \"nested\": {\n        \"path\": \"locations\"\n      },\n      \"aggs\": {\n        \"locations_aggs\": {\n          \"terms\": {\n            \"field\": \"locations.location_name\"\n          },\n          \"aggs\": {\n              \"location_verification_count\": {\n                \"nested\": {\n                  \"path\": \"locations.location_verification\"\n                }\n\n              }\n            }          \n        }\n      }\n    }\n  },   \n    \"size\": 10\n} \n```\n\n</pre>\n\ni do get following\n\n<pre>\n\n    {\n       \"took\": 2,\n       \"timed_out\": false,\n       \"_shards\": {\n          \"total\": 5,\n          \"successful\": 5,\n          \"failed\": 0\n       },\n       \"hits\": {\n          \"total\": 1,\n          \"max_score\": 0,\n          \"hits\": []\n       },\n       \"aggregations\": {\n          \"location_shared_with_count\": {\n             \"doc_count\": 6\n          },\n          \"locations_count\": {\n             \"doc_count\": 2,\n             \"locations_aggs\": {\n                \"buckets\": [\n                   {\n                      \"key\": \"Boston\",\n                      \"doc_count\": 1,\n                      \"location_verification_count\": {\n                         \"doc_count\": 2\n                      }\n                   },\n                   {\n                      \"key\": \"Miami\",\n                      \"doc_count\": 1,\n                      \"location_verification_count\": {\n                         \"doc_count\": 0\n                      }\n                   }\n                ]\n             }\n          }\n       }\n    }\n\n</pre>\n\n- Location verification count (doc_count) per location - perfect . So I do get e.g. \"Boston\" location  was verified by 2 friends (doc_count) .\n\nWhat I want to do is calculate % verified per location . \nFormula = [ (location_verification_count -> doc_count / location_shared_with_count->doc_count) x 100 ].\n\nQuestion is \n- How can I get or use existing doc_count in another sub-aggregation to calculate above % \n- What kind of aggregation type I would use to perform above ?\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}