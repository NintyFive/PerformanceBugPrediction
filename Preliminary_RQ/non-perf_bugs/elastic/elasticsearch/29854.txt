{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/29854","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29854/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29854/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/29854/events","html_url":"https://github.com/elastic/elasticsearch/issues/29854","id":317448683,"node_id":"MDU6SXNzdWUzMTc0NDg2ODM=","number":29854,"title":"SQL: Reduce duplicate aggs during folding","user":{"login":"elasticmachine","id":15837671,"node_id":"MDQ6VXNlcjE1ODM3Njcx","avatar_url":"https://avatars3.githubusercontent.com/u/15837671?v=4","gravatar_id":"","url":"https://api.github.com/users/elasticmachine","html_url":"https://github.com/elasticmachine","followers_url":"https://api.github.com/users/elasticmachine/followers","following_url":"https://api.github.com/users/elasticmachine/following{/other_user}","gists_url":"https://api.github.com/users/elasticmachine/gists{/gist_id}","starred_url":"https://api.github.com/users/elasticmachine/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/elasticmachine/subscriptions","organizations_url":"https://api.github.com/users/elasticmachine/orgs","repos_url":"https://api.github.com/users/elasticmachine/repos","events_url":"https://api.github.com/users/elasticmachine/events{/privacy}","received_events_url":"https://api.github.com/users/elasticmachine/received_events","type":"User","site_admin":false},"labels":[{"id":912794284,"node_id":"MDU6TGFiZWw5MTI3OTQyODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Query%20Languages/SQL","name":":Query Languages/SQL","color":"0e8a16","default":false,"description":"SQL querying"},{"id":23174,"node_id":"MDU6TGFiZWwyMzE3NA==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Eenhancement","name":">enhancement","color":"4a4ea8","default":false,"description":null},{"id":1967501040,"node_id":"MDU6TGFiZWwxOTY3NTAxMDQw","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:QL","name":"Team:QL","color":"fef2c0","default":false,"description":"Meta label for query languages team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2018-01-10T15:30:04Z","updated_at":"2020-05-12T16:00:40Z","closed_at":"2020-05-12T16:00:39Z","author_association":"COLLABORATOR","active_lock_reason":null,"body":"*Original comment by @costin:*\n\nWhen the same (agg) function is used several times in the project, it can appear multiple times in the generated query. That's not ideal and similar to ScalarFunction we should reuse the same expression.\r\nWhile the optimizer easily removes the duplicates, the query folder needs to be improved when dealing with aggs to not add the same definition more than one time.\r\n\r\nFor example:\r\n```sql\r\nSELECT gender g, MIN(emp_no) m FROM \"test_emp\" GROUP BY g HAVING MIN(emp_no) > 10\r\n```\r\n\r\n`MIN(emp_no)` appears twice - once inside the `Aggregate`, hidden behind the `m` alias and once inside `HAVING`. This results in the following (correct) tree:\r\n```\r\nProject[[g{f}LINK REDACTED, m{a->17}LINK REDACTED]]\r\n\\_Filter[MIN(emp_no)LINK REDACTED > 10]\r\n  \\_Aggregate[[gender{f}LINK REDACTED],[gender{f}LINK REDACTED AS g#1, MIN(emp_no)LINK REDACTED AS m#4, MIN(emp_no)LINK REDACTED]]\r\n    \\_EsRelation[test_emp][birth_date{f}LINK REDACTED, emp_no{f}LINK REDACTED, first_name{f}LINK REDACTED, gen..]\r\n```\r\nand query:\r\n```json\r\n{\r\n  \"size\" : 0,\r\n  \"_source\" : false,\r\n  \"stored_fields\" : \"_none_\",\r\n  \"aggregations\" : {\r\n    \"11\" : {\r\n      \"terms\" : {\r\n        \"field\" : \"gender\",\r\n        \"size\" : 512,\r\n        \"min_doc_count\" : 1,\r\n        \"shard_min_doc_count\" : 0,\r\n        \"show_term_doc_count_error\" : false,\r\n        \"order\" : [\r\n          {\r\n            \"_count\" : \"desc\"\r\n          },\r\n          {\r\n            \"_key\" : \"asc\"\r\n          }\r\n        ]\r\n      },\r\n      \"aggregations\" : {\r\n        \"17\" : {\r\n          \"min\" : {\r\n            \"field\" : \"emp_no\"\r\n          }\r\n        },\r\n        \"23\" : {\r\n          \"min\" : {\r\n            \"field\" : \"emp_no\"\r\n          }\r\n        },\r\n        \"23\" : {\r\n          \"bucket_selector\" : {\r\n            \"buckets_path\" : {\r\n              \"a0\" : \"23\"\r\n            },\r\n            \"script\" : {\r\n              \"source\" : \"params.a0 > params.v0\",\r\n              \"lang\" : \"painless\",\r\n              \"params\" : {\r\n                \"v0\" : 10\r\n              }\r\n            },\r\n            \"gap_policy\" : \"skip\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\n\r\nAggs `17` and `23` are the same and there should be only one in there.\r\nEnabling `PruneDuplicateFunction` in the Optimizer, replaces `MIN(emp_no)LINK REDACTED` however it fails because the same agg is added twice to the query (appearing twice on the `Aggregate`). A `Set` or something similar would solve this.","closed_by":{"login":"matriv","id":5058131,"node_id":"MDQ6VXNlcjUwNTgxMzE=","avatar_url":"https://avatars1.githubusercontent.com/u/5058131?v=4","gravatar_id":"","url":"https://api.github.com/users/matriv","html_url":"https://github.com/matriv","followers_url":"https://api.github.com/users/matriv/followers","following_url":"https://api.github.com/users/matriv/following{/other_user}","gists_url":"https://api.github.com/users/matriv/gists{/gist_id}","starred_url":"https://api.github.com/users/matriv/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/matriv/subscriptions","organizations_url":"https://api.github.com/users/matriv/orgs","repos_url":"https://api.github.com/users/matriv/repos","events_url":"https://api.github.com/users/matriv/events{/privacy}","received_events_url":"https://api.github.com/users/matriv/received_events","type":"User","site_admin":false},"performed_via_github_app":null}