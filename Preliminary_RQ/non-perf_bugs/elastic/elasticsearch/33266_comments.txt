[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/417263076","html_url":"https://github.com/elastic/elasticsearch/issues/33266#issuecomment-417263076","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33266","id":417263076,"node_id":"MDEyOklzc3VlQ29tbWVudDQxNzI2MzA3Ng==","user":{"login":"romseygeek","id":1347065,"node_id":"MDQ6VXNlcjEzNDcwNjU=","avatar_url":"https://avatars0.githubusercontent.com/u/1347065?v=4","gravatar_id":"","url":"https://api.github.com/users/romseygeek","html_url":"https://github.com/romseygeek","followers_url":"https://api.github.com/users/romseygeek/followers","following_url":"https://api.github.com/users/romseygeek/following{/other_user}","gists_url":"https://api.github.com/users/romseygeek/gists{/gist_id}","starred_url":"https://api.github.com/users/romseygeek/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/romseygeek/subscriptions","organizations_url":"https://api.github.com/users/romseygeek/orgs","repos_url":"https://api.github.com/users/romseygeek/repos","events_url":"https://api.github.com/users/romseygeek/events{/privacy}","received_events_url":"https://api.github.com/users/romseygeek/received_events","type":"User","site_admin":false},"created_at":"2018-08-30T09:57:39Z","updated_at":"2018-08-30T09:57:39Z","author_association":"CONTRIBUTOR","body":"You should be able to get what you need by using a top_hits aggregation - see https://www.elastic.co/guide/en/elasticsearch/reference/current/search-aggregations-metrics-top-hits-aggregation.html#_field_collapse_example\r\n\r\nThis appears to be a user question, and we'd like to direct these kinds of things to the forums. If you can ask further questions there, we'd appreciate it. This allows us to use GitHub for verified bug reports, feature requests, and pull requests.\r\n\r\nThere's an active community in the forums that should be able to help get an answer to your question. As such, I hope you don't mind that I close this.","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/572595764","html_url":"https://github.com/elastic/elasticsearch/issues/33266#issuecomment-572595764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33266","id":572595764,"node_id":"MDEyOklzc3VlQ29tbWVudDU3MjU5NTc2NA==","user":{"login":"pumpadump","id":1479838,"node_id":"MDQ6VXNlcjE0Nzk4Mzg=","avatar_url":"https://avatars3.githubusercontent.com/u/1479838?v=4","gravatar_id":"","url":"https://api.github.com/users/pumpadump","html_url":"https://github.com/pumpadump","followers_url":"https://api.github.com/users/pumpadump/followers","following_url":"https://api.github.com/users/pumpadump/following{/other_user}","gists_url":"https://api.github.com/users/pumpadump/gists{/gist_id}","starred_url":"https://api.github.com/users/pumpadump/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pumpadump/subscriptions","organizations_url":"https://api.github.com/users/pumpadump/orgs","repos_url":"https://api.github.com/users/pumpadump/repos","events_url":"https://api.github.com/users/pumpadump/events{/privacy}","received_events_url":"https://api.github.com/users/pumpadump/received_events","type":"User","site_admin":false},"created_at":"2020-01-09T14:51:54Z","updated_at":"2020-01-09T14:51:54Z","author_association":"NONE","body":"@TheoVitkovskiy were you able to find a solution to your problem? We have the same issue.\r\n\r\n@romseygeek It is possible to emulate the collapse feature with a top_hits aggregation but I don't understand how you could apply new Aggregations to the set of documents that are made up by the top hit of each group. Is it even possible? @TheoVitkovskiy didn't receive any help in the forums: https://discuss.elastic.co/t/how-to-apply-aggregations-to-collapsed-grouped-results/146673\r\n\r\nWith top_hits you can apply aggregations to each group but not to the total set of groups considering only the top hit in each group, at least I didn't figure out a way to do this yet.\r\n\r\n\r\n\r\n\r\n\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/580800575","html_url":"https://github.com/elastic/elasticsearch/issues/33266#issuecomment-580800575","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33266","id":580800575,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MDgwMDU3NQ==","user":{"login":"jengel3","id":1993773,"node_id":"MDQ6VXNlcjE5OTM3NzM=","avatar_url":"https://avatars3.githubusercontent.com/u/1993773?v=4","gravatar_id":"","url":"https://api.github.com/users/jengel3","html_url":"https://github.com/jengel3","followers_url":"https://api.github.com/users/jengel3/followers","following_url":"https://api.github.com/users/jengel3/following{/other_user}","gists_url":"https://api.github.com/users/jengel3/gists{/gist_id}","starred_url":"https://api.github.com/users/jengel3/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jengel3/subscriptions","organizations_url":"https://api.github.com/users/jengel3/orgs","repos_url":"https://api.github.com/users/jengel3/repos","events_url":"https://api.github.com/users/jengel3/events{/privacy}","received_events_url":"https://api.github.com/users/jengel3/received_events","type":"User","site_admin":false},"created_at":"2020-01-31T16:18:51Z","updated_at":"2020-01-31T16:18:51Z","author_association":"NONE","body":"@pumpadump Any chance you've found a solution yourself? Dealing with the same issue. ","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/582963382","html_url":"https://github.com/elastic/elasticsearch/issues/33266#issuecomment-582963382","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33266","id":582963382,"node_id":"MDEyOklzc3VlQ29tbWVudDU4Mjk2MzM4Mg==","user":{"login":"pumpadump","id":1479838,"node_id":"MDQ6VXNlcjE0Nzk4Mzg=","avatar_url":"https://avatars3.githubusercontent.com/u/1479838?v=4","gravatar_id":"","url":"https://api.github.com/users/pumpadump","html_url":"https://github.com/pumpadump","followers_url":"https://api.github.com/users/pumpadump/followers","following_url":"https://api.github.com/users/pumpadump/following{/other_user}","gists_url":"https://api.github.com/users/pumpadump/gists{/gist_id}","starred_url":"https://api.github.com/users/pumpadump/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pumpadump/subscriptions","organizations_url":"https://api.github.com/users/pumpadump/orgs","repos_url":"https://api.github.com/users/pumpadump/repos","events_url":"https://api.github.com/users/pumpadump/events{/privacy}","received_events_url":"https://api.github.com/users/pumpadump/received_events","type":"User","site_admin":false},"created_at":"2020-02-06T15:37:49Z","updated_at":"2020-02-06T15:37:49Z","author_association":"NONE","body":"@jengel3 I got in contact with the original author, He didn't find a solution, I asked @spinscale an Elasticsearch expert at the find meetup in Munich he told me it's not possible. \r\n\r\nWhat you can do is get the total hits count after grouping through a cardinality aggregation on the collapse field and basically use it as an upper bound and approximate normalization factor for the other aggregation counts in your middleware.\r\n\r\nSomething like:\r\nMath.Min(cardinality count, ((original agg value) * (cardinality count / total count))\r\n\r\nThe results will be wrong, but if your aggregation buckets are evenly distributed over your search results the error might not be noticeable.\r\n\r\nWe will probably display both counts, the total count before field collapsing and the cardinality count (after field collapsing) to the user. So, you will see \"found x products from y articles in total\". And make it clear that the aggregation counts relate to the total article count and not the products count.\r\n\r\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/585111551","html_url":"https://github.com/elastic/elasticsearch/issues/33266#issuecomment-585111551","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/33266","id":585111551,"node_id":"MDEyOklzc3VlQ29tbWVudDU4NTExMTU1MQ==","user":{"login":"pumpadump","id":1479838,"node_id":"MDQ6VXNlcjE0Nzk4Mzg=","avatar_url":"https://avatars3.githubusercontent.com/u/1479838?v=4","gravatar_id":"","url":"https://api.github.com/users/pumpadump","html_url":"https://github.com/pumpadump","followers_url":"https://api.github.com/users/pumpadump/followers","following_url":"https://api.github.com/users/pumpadump/following{/other_user}","gists_url":"https://api.github.com/users/pumpadump/gists{/gist_id}","starred_url":"https://api.github.com/users/pumpadump/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/pumpadump/subscriptions","organizations_url":"https://api.github.com/users/pumpadump/orgs","repos_url":"https://api.github.com/users/pumpadump/repos","events_url":"https://api.github.com/users/pumpadump/events{/privacy}","received_events_url":"https://api.github.com/users/pumpadump/received_events","type":"User","site_admin":false},"created_at":"2020-02-12T09:24:58Z","updated_at":"2020-02-12T09:24:58Z","author_association":"NONE","body":"@jengel3 @TheoVitkovskiy \r\nWe actually found a better solution. It has the drawback that it works only on single shard indexes but for most e-commerce use-cases that should be ok. You can use the diversified_sampler aggregation. Here is an example that calculates the counts after field collapsing with the diversified_sampler aggregation on the kibana ecommerce example index:\r\n```JSON\r\nGET kibana_sample_data_ecommerce/_search\r\n{\r\n  \"query\": {\r\n    \"term\": {\r\n      \"products.manufacturer.keyword\": {\r\n        \"value\": \"Elitelligence\"\r\n      }\r\n    }\r\n  },\r\n  \"collapse\": {\r\n    \"field\": \"customer_id\"\r\n  },\r\n  \"aggs\": {\r\n    \"my_unbiased_sample\": {\r\n      \"diversified_sampler\": {\r\n       \"shard_size\":20000,\r\n        \"field\": \"customer_id\"\r\n      },\r\n      \"aggs\": {\r\n        \"type_count\": {\r\n          \"terms\": {\r\n            \"field\": \"products.manufacturer.keyword\"\r\n          }\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n```\r\nI'm not sure how much memory is consumed if you have to set the shard_size to very high values to calculate accurate results, so keep an eye on that.\r\n","performed_via_github_app":null}]