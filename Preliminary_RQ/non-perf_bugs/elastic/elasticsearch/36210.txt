{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/36210","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36210/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36210/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/36210/events","html_url":"https://github.com/elastic/elasticsearch/issues/36210","id":387231597,"node_id":"MDU6SXNzdWUzODcyMzE1OTc=","number":36210,"title":"Unexpected search results with index sorting","user":{"login":"Saluev","id":2435301,"node_id":"MDQ6VXNlcjI0MzUzMDE=","avatar_url":"https://avatars0.githubusercontent.com/u/2435301?v=4","gravatar_id":"","url":"https://api.github.com/users/Saluev","html_url":"https://github.com/Saluev","followers_url":"https://api.github.com/users/Saluev/followers","following_url":"https://api.github.com/users/Saluev/following{/other_user}","gists_url":"https://api.github.com/users/Saluev/gists{/gist_id}","starred_url":"https://api.github.com/users/Saluev/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Saluev/subscriptions","organizations_url":"https://api.github.com/users/Saluev/orgs","repos_url":"https://api.github.com/users/Saluev/repos","events_url":"https://api.github.com/users/Saluev/events{/privacy}","received_events_url":"https://api.github.com/users/Saluev/received_events","type":"User","site_admin":false},"labels":[{"id":146832564,"node_id":"MDU6TGFiZWwxNDY4MzI1NjQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Search/Search","name":":Search/Search","color":"0e8a16","default":false,"description":"Search-related issues that do not fall into other categories"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":3,"created_at":"2018-12-04T11:02:42Z","updated_at":"2019-04-05T08:55:50Z","closed_at":"2019-04-05T08:55:49Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**Elasticsearch version**: Version: 6.4.0, Build: default/tar/595516e/2018-08-17T23:18:47.308994Z\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version**: 10.0.2\r\n\r\n**OS version**: macOS Mojave, Ubuntu 16.04.5 LTS\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\n\r\nI created index with index sorting on two fields, `followersCnt` (long) and `created` (long). Then I filled it with documents; for a number of documents `followersCnt` field was not set. When running search with query\r\n```\r\n{\r\n  \"sort\": [{\"followersCnt\": \"desc\"}],\r\n  \"size\": 10\r\n}\r\n```\r\n, I expect to get top 10 documents by `followersCnt`, but instead I get one top element and a number of random documents (on my production database) or no documents with `followersCnt` at all (locally after steps described below), i.e. all hit documents are those documents without `followersCnt` field.\r\n\r\n**Steps to reproduce**:\r\n\r\n```\r\n// assuming Elasticsearch is on port 9202\r\n\r\ncurl -XPUT \"http://localhost:9202/repro\" -H 'Content-Type: application/json' -d'\r\n{\r\n    \"settings\" : {\r\n        \"index\" : {\r\n            \"number_of_shards\" : 5,\r\n            \"number_of_replicas\" : 1,\r\n            \"sort\" : {\r\n               \"order\" : [\r\n                  \"desc\",\r\n                  \"asc\"\r\n               ],\r\n               \"field\" : [\r\n                  \"followersCnt\",\r\n                  \"created\"\r\n               ]\r\n            }\r\n        }\r\n    },\r\n    \"mappings\" : {\r\n       \"doc\" : {\r\n          \"properties\" : {\r\n             \"name\" : {\r\n                \"type\" : \"text\"\r\n             },\r\n             \"followersCnt\" : {\r\n                \"type\" : \"long\"\r\n             },\r\n             \"created\" : {\r\n                \"type\" : \"long\"\r\n             }\r\n          }\r\n       }\r\n    }\r\n}'\r\n\r\ncurl -XPUT \"http://localhost:9202/repro/doc/0\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"name\": \"top user\",\r\n  \"followersCnt\": \"1000000\",\r\n  \"created\": 100\r\n}'\r\n\r\nfor i in {1..10}\r\ndo\r\n  curl -XPUT \"http://localhost:9202/repro/doc/$i\" -H 'Content-Type: application/json' -d\"\r\n  {\r\n   \\\"name\\\": \\\"cool user\\\",\r\n   \\\"followersCnt\\\": \\\"$((1000 + $RANDOM))\\\",\r\n   \\\"created\\\": $RANDOM\r\n  }\"\r\ndone\r\n\r\nfor i in {10001..11000}\r\ndo\r\n  curl -XPUT \"http://localhost:9202/repro/doc/$i\" -H 'Content-Type: application/json' -d\"\r\n  {\r\n   \\\"name\\\": \\\"lonely user\\\",\r\n   \\\"created\\\": $RANDOM\r\n }\"\r\ndone\r\n\r\ncurl -XPOST \"http://localhost:9202/repro/_refresh\"\r\n\r\ncurl -XPOST \"http://localhost:9202/repro/_search\" -H 'Content-Type: application/json' -d'\r\n{\r\n  \"sort\": [{\"followersCnt\": \"desc\"}],\r\n  \"size\": 10\r\n}' | json_pp | grep followersCnt\r\n\r\n// expected output: sequence of numbers from 30000 to 10000\r\n// real output: empty (none of the matched documents have `followersCnt` field)\r\n```\r\n","closed_by":{"login":"jimczi","id":15977469,"node_id":"MDQ6VXNlcjE1OTc3NDY5","avatar_url":"https://avatars0.githubusercontent.com/u/15977469?v=4","gravatar_id":"","url":"https://api.github.com/users/jimczi","html_url":"https://github.com/jimczi","followers_url":"https://api.github.com/users/jimczi/followers","following_url":"https://api.github.com/users/jimczi/following{/other_user}","gists_url":"https://api.github.com/users/jimczi/gists{/gist_id}","starred_url":"https://api.github.com/users/jimczi/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jimczi/subscriptions","organizations_url":"https://api.github.com/users/jimczi/orgs","repos_url":"https://api.github.com/users/jimczi/repos","events_url":"https://api.github.com/users/jimczi/events{/privacy}","received_events_url":"https://api.github.com/users/jimczi/received_events","type":"User","site_admin":false},"performed_via_github_app":null}