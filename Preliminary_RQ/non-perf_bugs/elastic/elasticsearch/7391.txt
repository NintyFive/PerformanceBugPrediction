{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7391","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7391/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7391/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7391/events","html_url":"https://github.com/elastic/elasticsearch/issues/7391","id":40881712,"node_id":"MDU6SXNzdWU0MDg4MTcxMg==","number":7391,"title":"token position problems of word_delimiter token filter","user":{"login":"hxuanji","id":4996057,"node_id":"MDQ6VXNlcjQ5OTYwNTc=","avatar_url":"https://avatars0.githubusercontent.com/u/4996057?v=4","gravatar_id":"","url":"https://api.github.com/users/hxuanji","html_url":"https://github.com/hxuanji","followers_url":"https://api.github.com/users/hxuanji/followers","following_url":"https://api.github.com/users/hxuanji/following{/other_user}","gists_url":"https://api.github.com/users/hxuanji/gists{/gist_id}","starred_url":"https://api.github.com/users/hxuanji/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/hxuanji/subscriptions","organizations_url":"https://api.github.com/users/hxuanji/orgs","repos_url":"https://api.github.com/users/hxuanji/repos","events_url":"https://api.github.com/users/hxuanji/events{/privacy}","received_events_url":"https://api.github.com/users/hxuanji/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":7,"created_at":"2014-08-22T06:11:09Z","updated_at":"2017-05-15T06:47:34Z","closed_at":"2014-08-22T14:58:59Z","author_association":"NONE","active_lock_reason":null,"body":"Hi, all\n\nI got the following index setting\n\n```\n{\n    \"settings\": {\n        \"index\": {\n            \"number_of_shards\": 5,\n            \"number_of_replicas\": 0,\n            \"analysis\": {   \n                \"analyzer\": {\n                    \"fielda_index\": {\n                         \"type\": \"custom\",\n                         \"tokenizer\": \"icu_tokenizer\",\n                         \"filter\": [ \"words_delimiter\", \"icu_normalizer\", \"icu_folding\"]\n                    },\n                    \"fielda_search\": {\n                         \"type\": \"custom\",\n                         \"tokenizer\": \"icu_tokenizer\",\n                         \"filter\": [\"dot_delimiter\", \"icu_normalizer\", \"icu_folding\"]\n                    }\n                },\n                \"filter\": {\n                    \"dot_delimiter\":\n                    {\n                        \"type\": \"word_delimiter\",\n                        \"generate_word_parts\": true,\n                        \"generate_number_parts\": true,\n                        \"split_on_case_change\": false,\n                        \"preserve_original\": true,\n                        \"split_on_numerics\": true\n                    },\n                    \"words_delimiter\":\n                    {\n                        \"type\": \"word_delimiter\",\n                        \"generate_word_parts\": true,\n                        \"generate_number_parts\": true,\n                        \"split_on_case_change\": true,\n                        \"preserve_original\": true,\n                        \"split_on_numerics\": true\n                    }\n\n                }\n            }\n        }\n    },\n    \"mappings\": {\n        \"main\": {\n            \"_source\": {\"enabled\": true},\n            \"dynamic_date_formats\": [\"basic_date_time_no_millis\"],\n            \"properties\": {\n                \"name\": { \"type\": \"string\", \"index\": \"analyzed\", \"index_analyzer\": \"fielda_index\", \"search_analyzer\": \"fielda_search\", \"include_in_all\": true}\n            }\n        }\n    }\n}\n```\n\nAnd I use the word \"PowerShot\" to run the two analyzers, here is the result:\n\n```\nfielda_index:   PowerShot(1) Power(1) Shot(2)\nfielda_search:  PowerShot(1)\n```\n\nThe number inside the paren is the token position. \nMy question is why the token position of \"Shot\" is 2. I think the positions of the tokens that are generated by the word_delimiter token filter should be all the same. Ideas?\n\nBecause of this, I encounter an problem when performing match_phrase query.\nWe know the match_phrase query not only match the token but also check the token positions.\n\nSo when I insert a document, \n\n```\n{\"name\": \"Canon PowerShot D500\"}\n```\n\nI cannot using the query \n\n```\n{\"from\": 0, \"size\": 100, \"query\":{\"match_phrase\": {\"name\":\"Canon PowerShot D500\"}}}\n```\n\nto find the document I just inserted, because the token position is not matched. \n\nThe tokens result of the two analyzers are:\n\n```\nfielda_index    Canon(1) PowerShot(2) Power(2) Shot(3) D500(4) D(4) 500(5)\nfielda_search   Canon(1) PowerShot(2) D500(3) D(3) 500(4)\n```\n\nObviously, the position 3 of fielda_search is \"D500\", but the \"D500\" token of fielda_index locates at position 4. So it cannot be found the desired document.\n\nThe reproducible gist script is https://gist.github.com/hxuanji/b94d9c3514d7b08005d2\n\nSo are there any reason why the token position of the tokens that generated by word_delimter filter behave like these? \nSince the extra tokens generated from word_delimiter are just \"extended\" cases of the original token, I think the position should remains to the original one. Do I misunderstand something or any other reasons?\n\nBest,\nIvan\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}