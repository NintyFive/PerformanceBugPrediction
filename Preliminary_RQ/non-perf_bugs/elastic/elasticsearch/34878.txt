{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/34878","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34878/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34878/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/34878/events","html_url":"https://github.com/elastic/elasticsearch/issues/34878","id":374096961,"node_id":"MDU6SXNzdWUzNzQwOTY5NjE=","number":34878,"title":"Shard Allocation Race Condition","user":{"login":"danielkasen","id":31549908,"node_id":"MDQ6VXNlcjMxNTQ5OTA4","avatar_url":"https://avatars1.githubusercontent.com/u/31549908?v=4","gravatar_id":"","url":"https://api.github.com/users/danielkasen","html_url":"https://github.com/danielkasen","followers_url":"https://api.github.com/users/danielkasen/followers","following_url":"https://api.github.com/users/danielkasen/following{/other_user}","gists_url":"https://api.github.com/users/danielkasen/gists{/gist_id}","starred_url":"https://api.github.com/users/danielkasen/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danielkasen/subscriptions","organizations_url":"https://api.github.com/users/danielkasen/orgs","repos_url":"https://api.github.com/users/danielkasen/repos","events_url":"https://api.github.com/users/danielkasen/events{/privacy}","received_events_url":"https://api.github.com/users/danielkasen/received_events","type":"User","site_admin":false},"labels":[{"id":837246479,"node_id":"MDU6TGFiZWw4MzcyNDY0Nzk=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Distributed/Allocation","name":":Distributed/Allocation","color":"0e8a16","default":false,"description":"All issues relating to the decision making around placing a shard (both master logic & on the nodes)"},{"id":111624690,"node_id":"MDU6TGFiZWwxMTE2MjQ2OTA=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/feedback_needed","name":"feedback_needed","color":"d4c5f9","default":false,"description":null}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2018-10-25T19:27:26Z","updated_at":"2018-10-26T15:29:44Z","closed_at":"2018-10-26T05:18:00Z","author_association":"NONE","active_lock_reason":null,"body":"<!-- Bug report -->\r\n\r\n**6.3.2** :\r\n\r\n**Plugins installed**: []\r\n\r\n**JVM version** (`java -version`): 1.8.72\r\n\r\n**OS version** (`uname -a` if on a Unix-like system): Ubuntu 14.04\r\n\r\n**Description of the problem including expected versus actual behavior**:\r\nNew Index Gets allocated into a yellow state vs. allocating to shards each available node when using a mixture of rack_awareness and shard_allocation_per_node = 1\r\n\r\n**Steps to reproduce**:\r\n\r\n 1. Create a 15 node Cluster that has 3 different racks\r\n 2. Create an index with 7 shards and 1 replica ( 14 total ) that can allocate only 1 shard per node\r\n 3. Randomly get a race condition where the index can't allocate one of the replicas becase it's primary is in the same rack.\r\n\r\nSo basically you can get into a condition where even though you still have 2 nodes without a shard it can't allocate to either of them because then the primary and relica would be in the same rack. To fix this you have to move the free up a node in a different rack by moving it's primary or replica to one of the unused nodes, then assign the original replica that couldn't be assigned to that new node (moving 2 shards at once).\r\n\r\n","closed_by":{"login":"DaveCTurner","id":5058284,"node_id":"MDQ6VXNlcjUwNTgyODQ=","avatar_url":"https://avatars3.githubusercontent.com/u/5058284?v=4","gravatar_id":"","url":"https://api.github.com/users/DaveCTurner","html_url":"https://github.com/DaveCTurner","followers_url":"https://api.github.com/users/DaveCTurner/followers","following_url":"https://api.github.com/users/DaveCTurner/following{/other_user}","gists_url":"https://api.github.com/users/DaveCTurner/gists{/gist_id}","starred_url":"https://api.github.com/users/DaveCTurner/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/DaveCTurner/subscriptions","organizations_url":"https://api.github.com/users/DaveCTurner/orgs","repos_url":"https://api.github.com/users/DaveCTurner/repos","events_url":"https://api.github.com/users/DaveCTurner/events{/privacy}","received_events_url":"https://api.github.com/users/DaveCTurner/received_events","type":"User","site_admin":false},"performed_via_github_app":null}