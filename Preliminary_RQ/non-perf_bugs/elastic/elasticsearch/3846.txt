{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/3846","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3846/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3846/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/3846/events","html_url":"https://github.com/elastic/elasticsearch/issues/3846","id":20670652,"node_id":"MDU6SXNzdWUyMDY3MDY1Mg==","number":3846,"title":"Root document filtering in nested statistical facets.","user":{"login":"JimminiKin","id":1327193,"node_id":"MDQ6VXNlcjEzMjcxOTM=","avatar_url":"https://avatars3.githubusercontent.com/u/1327193?v=4","gravatar_id":"","url":"https://api.github.com/users/JimminiKin","html_url":"https://github.com/JimminiKin","followers_url":"https://api.github.com/users/JimminiKin/followers","following_url":"https://api.github.com/users/JimminiKin/following{/other_user}","gists_url":"https://api.github.com/users/JimminiKin/gists{/gist_id}","starred_url":"https://api.github.com/users/JimminiKin/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/JimminiKin/subscriptions","organizations_url":"https://api.github.com/users/JimminiKin/orgs","repos_url":"https://api.github.com/users/JimminiKin/repos","events_url":"https://api.github.com/users/JimminiKin/events{/privacy}","received_events_url":"https://api.github.com/users/JimminiKin/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":4,"created_at":"2013-10-08T10:31:48Z","updated_at":"2014-03-13T16:54:32Z","closed_at":"2014-03-13T16:54:32Z","author_association":"NONE","active_lock_reason":null,"body":"I have to implement a statistical facet on a nested price field in order to get the min and max value for a slider. The problem is that facet_filter on nested facets seems to behave weirdly.\n\n``` sh\n#With this example mapping : \ncurl -XPOST localhost:9200/test_nested_statistical -d '{\n    \"settings\": {\"number_of_shards\": 1},\n    \"mappings\": {\n        \"object\": {\n            \"properties\": {\n                \"title\": {\"type\": \"string\"},\n                \"tags\": {\n                    \"type\": \"string\",\n                    \"index\": \"not_analyzed\"\n                },\n                \"prices\": {\"type\": \"nested\",\n                    \"properties\": {\n                        \"price\": {\"type\": \"float\"},\n                        \"type\": {\n                            \"type\": \"string\",\n                            \"index\": \"not_analyzed\"\n                        }\n                    }\n                }\n            }\n        }\n    }\n}'\n\n#Adding a few objects ...\ncurl -XPUT http://localhost:9200/test_nested_statistical/object/1 -d '{\n    \"title\" : \"Test One\",\n    \"tags\" : [\"one\", \"two\", \"three\"],\n    \"prices\" : [{\"price\" : 20,\"type\": \"TYPEONE\"},{\"price\" : 30,\"type\": \"TYPETWO\"}]\n}'\n\ncurl -XPUT 'http://localhost:9200/test_nested_statistical/object/2' -d '{\n    \"title\" : \"Test Two\",\n    \"tags\" : [\"one\", \"four\"],\n    \"prices\" : [{\"price\" : 10,\"type\": \"TYPEONE\"},{\"price\" : 15,\"type\": \"TYPETWO\"}]\n}'\n\n#When I just filter the nested doc with a nested query set with join false, everything goes as intented : \ncurl -XPOST \"http://localhost:9200/test_nested_statistical/object/_search\" -d'{\n    \"query\" : {\n                \"terms\" : {\"tags\":[\"one\"]}\n        },\n        \"facets\" : {\n                \"priceone\" : {\n                        \"statistical\" : {\n                                \"field\" : \"prices.price\"\n                        },\n                        \"global\" : true,\n                        \"facet_filter\" : {\n                                \"nested\" : {\n                                        \"path\" : \"prices\",\n                                        \"query\" : {\n                                                \"terms\" : {\n                                                        \"prices.type\" : [\"TYPEONE\"]\n                                                }\n                                        },\n                                        \"join\" : false\n                                }\n                        },\n                        \"nested\" : \"prices\"\n                }\n        }\n}'\n```\n\nThis query returns min : 10, max : 20, the right values for only the TYPEONE prices.\n\nThe issue comes up when I also try to filter the root documents used in for the facet. (Just in case : My use case prevents me from using global:false because I need the facet to have a wider context than my results but still be filtered some way, this example does not illustrate this difference in context, but you get the point)\n\n``` sh\ncurl -XPOST \"http://localhost:9200/test_nested_statistical/object/_search\" -d'{\n    \"query\" : {\n                \"terms\" : {\"tags\":[\"one\"]}\n        },\n        \"facets\" : {\n                \"priceone\" : {\n                        \"statistical\" : {\n                                \"field\" : \"prices.price\"\n                        },\n                        \"global\" : true,\n                        \"facet_filter\" : {\n                                \"and\" : [\n                                    {\n                                        \"nested\" : {\n                                            \"path\" : \"prices\",\n                                            \"query\" : {\n                                                    \"terms\" : {\n                                                            \"prices.type\" : [\"TYPEONE\"]\n                                                    }\n                                            },\n                                            \"join\" : false\n                                        }\n                                    },{\n                                        \"terms\" : {\n                                                \"tags\" : [\"one\"]\n                                        }\n                                    }\n                                ]\n\n                        },\n                        \"nested\" : \"prices\"\n                }\n        }\n}'\n```\n\nThis query return Infinity and -Infinity as min/max values. So, the filter seems to not really look in the root document.\n\nMaybe the boolean AND filter is not the right choice but with an Ids filter in the boolean, it seems to work : \n\n``` sh\ncurl -XPOST \"http://localhost:9200/test_nested_statistical/object/_search\" -d'{\n    \"query\" : {\n                \"terms\" : {\"tags\":[\"one\"]}\n        },\n        \"facets\" : {\n                \"priceone\" : {\n                        \"statistical\" : {\n                                \"field\" : \"prices.price\"\n                        },\n                        \"global\" : true,\n                        \"facet_filter\" : {\n                                \"and\" : [\n                                    {\n                                        \"nested\" : {\n                                            \"path\" : \"prices\",\n                                            \"query\" : {\n                                                    \"terms\" : {\n                                                            \"prices.type\" : [\"TYPEONE\"]\n                                                    }\n                                            },\n                                            \"join\" : false\n                                        }\n                                    },{\n                                        \"ids\" : {\n                                                \"type\" : \"object\",\n                                                \"values\" : [\"1\"]\n                                        }\n                                    }\n                                ]\n\n                        },\n                        \"nested\" : \"prices\"\n                }\n        }\n}'\n```\n\nHere, with the id filtering, min and max are set to 20, the value for the only root document matched by the Ids filter.\n\nCan someone confirm whether this is really a bug or if I'm missing something here?\n\nThanks for your time.\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}