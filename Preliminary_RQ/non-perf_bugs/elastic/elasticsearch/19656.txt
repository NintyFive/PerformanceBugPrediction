{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/19656","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19656/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19656/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19656/events","html_url":"https://github.com/elastic/elasticsearch/issues/19656","id":168104737,"node_id":"MDU6SXNzdWUxNjgxMDQ3Mzc=","number":19656,"title":"[1.7.3] Two identical ES clusters with identical data return different results","user":{"login":"Fizzadar","id":1026154,"node_id":"MDQ6VXNlcjEwMjYxNTQ=","avatar_url":"https://avatars1.githubusercontent.com/u/1026154?v=4","gravatar_id":"","url":"https://api.github.com/users/Fizzadar","html_url":"https://github.com/Fizzadar","followers_url":"https://api.github.com/users/Fizzadar/followers","following_url":"https://api.github.com/users/Fizzadar/following{/other_user}","gists_url":"https://api.github.com/users/Fizzadar/gists{/gist_id}","starred_url":"https://api.github.com/users/Fizzadar/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/Fizzadar/subscriptions","organizations_url":"https://api.github.com/users/Fizzadar/orgs","repos_url":"https://api.github.com/users/Fizzadar/repos","events_url":"https://api.github.com/users/Fizzadar/events{/privacy}","received_events_url":"https://api.github.com/users/Fizzadar/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":1,"created_at":"2016-07-28T14:08:45Z","updated_at":"2016-07-28T18:47:56Z","closed_at":"2016-07-28T18:47:56Z","author_association":"NONE","active_lock_reason":null,"body":"Hi Elastic! Yesterday we were migrating from an old cluster to a new one and experienced a really bizzare issue with a simple terms aggregation. We've got identical versions/ES-binaries (build hash is the same) and data in both clusters - yet one returns correct terms data for one query and the other does not.\n\nThe query in question:\n\n``` json\n{\n  \"aggregations\": {\n    \"colours\": {\n      \"aggregations\": {\n        \"offset__terms\": {\n          \"terms\": {\n            \"field\": \"offset\",\n            \"shard_size\": 0,\n            \"size\": 10\n          }\n        }\n      },\n      \"nested\": {\n        \"path\": \"colours\"\n      }\n    }\n  },\n  \"size\": 0,\n  \"timeout\": \"60s\"\n}\n```\n\nRun against docs:\n\n``` json\n{\n    \"colours\": [\n        {\n            \"offset\": 1,\n            \"basic_name\": \"black\"\n        }\n    ]\n}\n```\n\nOne cluster returns:\n\n``` json\n\"aggregations\": {\n    \"colours\": {\n        \"doc_count\": 1,\n        \"offset__terms\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n            ]\n        }\n    }\n}\n```\n\nAnd the other:\n\n``` json\n\"aggregations\": {\n    \"colours\": {\n        \"doc_count\": 1,\n        \"offset__terms\": {\n            \"doc_count_error_upper_bound\": 0,\n            \"sum_other_doc_count\": 0,\n            \"buckets\": [\n                {\n                    \"key\": 1,\n                    \"doc_count\": 1\n                }\n            ]\n        }\n    }\n}\n```\n\nWe fixed the issue by changing the nested field name from `offset` to `colours.offset` - however I'm still baffled as to why the two clusters would return different results. Additionally when using other fields nested under colours both the short and full path syntax work - this _only_ affects the `offset` key!\n## \n\nES version info (both clusters identical):\n\n``` json\n{\n  \"status\" : 200,\n  \"name\" : \"cluster-X-01\",\n  \"cluster_name\" : \"cluster-X\",\n  \"version\" : {\n    \"number\" : \"1.7.3\",\n    \"build_hash\" : \"05d4530971ef0ea46d0f4fa6ee64dbc8df659682\",\n    \"build_timestamp\" : \"2015-10-15T09:14:17Z\",\n    \"build_snapshot\" : false,\n    \"lucene_version\" : \"4.10.4\"\n  },\n  \"tagline\" : \"You Know, for Search\"\n}\n```\n","closed_by":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"performed_via_github_app":null}