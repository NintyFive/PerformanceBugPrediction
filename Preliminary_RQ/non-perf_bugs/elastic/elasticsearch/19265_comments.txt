[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230452261","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-230452261","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":230452261,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDQ1MjI2MQ==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-05T11:20:24Z","updated_at":"2016-07-05T11:20:24Z","author_association":"CONTRIBUTOR","body":"(Oooh `<details>` tags! 👍 )\n\nThis should have been fixed with https://issues.apache.org/jira/browse/LUCENE-5929 but apparently it is still not working, neither in 2.3 nor in master.\n\n@martijnvg could you take a look please?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230807409","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-230807409","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":230807409,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDgwNzQwOQ==","user":{"login":"gmoskovicz","id":1675411,"node_id":"MDQ6VXNlcjE2NzU0MTE=","avatar_url":"https://avatars3.githubusercontent.com/u/1675411?v=4","gravatar_id":"","url":"https://api.github.com/users/gmoskovicz","html_url":"https://github.com/gmoskovicz","followers_url":"https://api.github.com/users/gmoskovicz/followers","following_url":"https://api.github.com/users/gmoskovicz/following{/other_user}","gists_url":"https://api.github.com/users/gmoskovicz/gists{/gist_id}","starred_url":"https://api.github.com/users/gmoskovicz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/gmoskovicz/subscriptions","organizations_url":"https://api.github.com/users/gmoskovicz/orgs","repos_url":"https://api.github.com/users/gmoskovicz/repos","events_url":"https://api.github.com/users/gmoskovicz/events{/privacy}","received_events_url":"https://api.github.com/users/gmoskovicz/received_events","type":"User","site_admin":false},"created_at":"2016-07-06T15:26:37Z","updated_at":"2016-07-06T15:29:10Z","author_association":"CONTRIBUTOR","body":"@clintongormley @martijnvg i have a similar case. Looks like when position offset is set, the highlighting doesn't work as expected. I have a full repro case that can be used in SENSE:\n\n```\nDELETE test\nPUT test\n{\n  \"mappings\": {\n    \"test_type\": {\n      \"properties\": {\n        \"nested_field\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"text\": {\n              \"type\": \"string\",\n              \"term_vector\": \"with_positions_offsets\",\n              \"fields\": {\n                \"raw\": {\n                  \"type\": \"string\",\n                  \"term_vector\": \"with_positions_offsets\"\n                }\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n} \n\nPOST test/test_type\n{\n  \"nested_field\": [\n    {\n      \"text\": \"text field\"\n    }\n  ]\n}\n\nPOST test/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"query\": {\n        \"query_string\": {\n          \"query\": \"text\",\n          \"fields\": [\n            \"nested_field.text.raw\"\n          ]\n        }\n      },\n      \"path\": \"nested_field\"\n    }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"nested_field.text.raw\": {}\n    }\n  },\n  \"fielddata_fields\": [\"nested_field.text.raw\"]\n}\n```\n\nCan you please confirm that it's related to this bug?\n\nJust to clarify, it's not related to multi_field. If you just use the text property you will get the same behaviour.\n\nIndeed, if you remove `\"term_vector\": \"with_positions_offsets\"` then it starts working. Must be related to this.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230812362","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-230812362","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":230812362,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDgxMjM2Mg==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-06T15:42:17Z","updated_at":"2016-07-06T15:42:17Z","author_association":"CONTRIBUTOR","body":"> Indeed, if you remove \"term_vector\": \"with_positions_offsets\" then it starts working. Must be related to this.\n\n@gmoskovicz that's because it uses the plain highlighter if term offsets are disabled.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/230999255","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-230999255","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":230999255,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMDk5OTI1NQ==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-07-07T07:02:40Z","updated_at":"2016-07-07T07:02:40Z","author_association":"MEMBER","body":"@clintongormley @sfcgeorge @gmoskovicz I wonder if we should support highlighting on `nested`, `has_child` and `has_parent` query at all? This isn't the first problem that the highlighters have with these queries. I think instead we should promote the use of inner hits more. With inner hits highlighting the nested object work and on top of this it is more accurate too (since each nested object will be highlighted in isolation):\n\n``` json\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"nested1\",\n      \"query\": {\n        \"match\": {\n          \"nested1.field1\": \"hello\"\n        }\n      },\n      \"inner_hits\": {\n        \"highlight\": {\n          \"fields\": {\n            \"nested1.field1\": {\n              \"type\": \"fvh\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231023799","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-231023799","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":231023799,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTAyMzc5OQ==","user":{"login":"sfcgeorge","id":885003,"node_id":"MDQ6VXNlcjg4NTAwMw==","avatar_url":"https://avatars3.githubusercontent.com/u/885003?v=4","gravatar_id":"","url":"https://api.github.com/users/sfcgeorge","html_url":"https://github.com/sfcgeorge","followers_url":"https://api.github.com/users/sfcgeorge/followers","following_url":"https://api.github.com/users/sfcgeorge/following{/other_user}","gists_url":"https://api.github.com/users/sfcgeorge/gists{/gist_id}","starred_url":"https://api.github.com/users/sfcgeorge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfcgeorge/subscriptions","organizations_url":"https://api.github.com/users/sfcgeorge/orgs","repos_url":"https://api.github.com/users/sfcgeorge/repos","events_url":"https://api.github.com/users/sfcgeorge/events{/privacy}","received_events_url":"https://api.github.com/users/sfcgeorge/received_events","type":"User","site_admin":false},"created_at":"2016-07-07T09:06:18Z","updated_at":"2016-07-07T09:06:18Z","author_association":"NONE","body":"@martijnvg That feels like making the programmer do something the system should be doing. I get that the implementation is hard because Lucene etc etc but ideally I'd like nested fields to be more seamless and easy to use, not require even more effort.\n\nUsing the global highlights as I currently am makes mapping the match back to the original object in my ORM very difficult. Using `inner_hits` would make that much easier BUT it doesn't work with searching `_all`. I need to be able to search `_all` so can't use `inner_hits` unfortunately. It's not ideal, but I'm stuck with global highlight, no `fragment_size` and `plain` highlighter for now.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231027172","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-231027172","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":231027172,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTAyNzE3Mg==","user":{"login":"martijnvg","id":580421,"node_id":"MDQ6VXNlcjU4MDQyMQ==","avatar_url":"https://avatars3.githubusercontent.com/u/580421?v=4","gravatar_id":"","url":"https://api.github.com/users/martijnvg","html_url":"https://github.com/martijnvg","followers_url":"https://api.github.com/users/martijnvg/followers","following_url":"https://api.github.com/users/martijnvg/following{/other_user}","gists_url":"https://api.github.com/users/martijnvg/gists{/gist_id}","starred_url":"https://api.github.com/users/martijnvg/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/martijnvg/subscriptions","organizations_url":"https://api.github.com/users/martijnvg/orgs","repos_url":"https://api.github.com/users/martijnvg/repos","events_url":"https://api.github.com/users/martijnvg/events{/privacy}","received_events_url":"https://api.github.com/users/martijnvg/received_events","type":"User","site_admin":false},"created_at":"2016-07-07T09:20:42Z","updated_at":"2016-07-07T09:20:42Z","author_association":"MEMBER","body":"@sfcgeorge I see, if you just query the `_all` field than using highlighting via `inner_hits` for that isn't very straightforward. However I do think that if fields inside nested objects are queried specifically then using highlighting via inner_hits should be used.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231036993","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-231036993","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":231036993,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTAzNjk5Mw==","user":{"login":"sfcgeorge","id":885003,"node_id":"MDQ6VXNlcjg4NTAwMw==","avatar_url":"https://avatars3.githubusercontent.com/u/885003?v=4","gravatar_id":"","url":"https://api.github.com/users/sfcgeorge","html_url":"https://github.com/sfcgeorge","followers_url":"https://api.github.com/users/sfcgeorge/followers","following_url":"https://api.github.com/users/sfcgeorge/following{/other_user}","gists_url":"https://api.github.com/users/sfcgeorge/gists{/gist_id}","starred_url":"https://api.github.com/users/sfcgeorge/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sfcgeorge/subscriptions","organizations_url":"https://api.github.com/users/sfcgeorge/orgs","repos_url":"https://api.github.com/users/sfcgeorge/repos","events_url":"https://api.github.com/users/sfcgeorge/events{/privacy}","received_events_url":"https://api.github.com/users/sfcgeorge/received_events","type":"User","site_admin":false},"created_at":"2016-07-07T10:05:12Z","updated_at":"2016-07-07T10:05:12Z","author_association":"NONE","body":"@martijnvg We need a Google-like search box that searches and highlights `_all`, but also advanced search on specific fields and nested fields, at the same time. If `_all` could percolate highlighting to `inner_hits` that would be perfect and much easier, but I don't think it can work. \n\n<details>\n<summary>\n\nMy failed attempts:</summary>\n\n\nBoth return correct result but no highlighting. \n\nHere I guess the `match_all` is stopping the highlighting.\n\n``` sh\ncurl -XGET 'http://localhost:9200/nested_fvh/type1/_search?pretty' -d '{\n  \"query\": {\n    \"bool\": {\n      \"must\": [\n        {\n          \"simple_query_string\": {\n            \"query\": \"hello\"\n          }\n        },\n        {\n          \"nested\": {\n            \"path\": \"nested1\",\n            \"filter\": {\n              \"match_all\": {}\n            },\n            \"inner_hits\": {\n              \"highlight\": {\n                \"require_field_match\": false,\n                \"fields\": {\n                  \"nested1.field1\": {\n                    \"type\": \"plain\"\n                  }\n                }\n              }\n            }\n          }\n        }\n      ]\n    }\n  }\n}\n'\n```\n\nGlobal inner hits sounded promising, this seems like it would be a great use-case for it if it worked. \n\n``` sh\ncurl -XGET 'http://localhost:9200/nested_fvh/type1/_search?pretty' -d '{\n  \"query\": {\n    \"simple_query_string\": {\n      \"query\": \"hello\"\n    }\n  },\n  \"inner_hits\": {\n    \"inner_hits_name1\": {\n      \"path\": { \n        \"nested1\": {\n          \"highlight\": {\n            \"require_field_match\": false,\n            \"fields\": {\n              \"nested1.field1\": {\n                \"type\": \"plain\"\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n'\n```\n\n</details>\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/231042296","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-231042296","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":231042296,"node_id":"MDEyOklzc3VlQ29tbWVudDIzMTA0MjI5Ng==","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2016-07-07T10:32:20Z","updated_at":"2016-07-07T10:33:54Z","author_association":"CONTRIBUTOR","body":"The FVH requires positions and offsets to be indexed, but highlighting is performed at the top level document and the positions and offsets for nested documents are inside the nested documents, so highlighting can't access them.\n\nSecondly, highlighting nested documents at the top level will produce incorrect results, eg:\n\n<details>\n\n```\nPUT t\n{\n  \"mappings\": {\n    \"t\": {\n      \"properties\": {\n        \"foo\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"text\": {\n              \"type\": \"text\"\n            },\n            \"num\": {\n              \"type\": \"integer\"\n            }\n          }\n        }\n      }\n    }\n  }\n}\n\nPUT t/t/1\n{\n  \"foo\": [\n    {\n      \"text\": \"brown\",\n      \"num\": 1\n    },\n    {\n      \"text\": \"cow\",\n      \"num\": 2\n    }\n  ]\n}\n\nGET t/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"foo\",\n      \"query\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"match\": {\n                \"foo.text\": \"brown cow\"\n              }\n            },\n            {\n              \"match\": {\n                \"foo.num\": 1\n              }\n            }\n          ]\n        }\n      }\n    }\n  },\n  \"highlight\": {\n    \"fields\": {\n      \"foo.text\": {}\n    }\n  }\n}\n```\n\n</details>\n\nreturns highlight snippets `brown` and `cow`,  while `cow` shouldn't have been highlighted.  Highlighting with inner hits works correctly:\n\n<details>\n\n```\nGET t/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"foo\",\n      \"inner_hits\": {\n        \"_source\": false,\n        \"highlight\": {\n          \"fields\": {\n            \"foo.text\": {}\n          }\n        }\n      },\n      \"query\": {\n        \"bool\": {\n          \"must\": [\n            {\n              \"match\": {\n                \"foo.text\": \"brown cow\"\n              }\n            },\n            {\n              \"match\": {\n                \"foo.num\": 1\n              }\n            }\n          ]\n        }\n      }\n    }\n  }\n}\n```\n\n</details>\n\nThat said, if you want to be able to use the FVH on nested fields at the top level (with the incorrect results), then you should be able to use `copy_to` to copy the nested values into a top-level field and highlight on that:\n\n<details>\n\n```\nPUT t\n{\n  \"mappings\": {\n    \"t\": {\n      \"properties\": {\n        \"foo\": {\n          \"type\": \"nested\",\n          \"properties\": {\n            \"text\": {\n              \"type\": \"text\",\n              \"copy_to\": \"foo_text\"\n            }\n          }\n        },\n        \"foo_text\": {\n          \"type\": \"text\",\n          \"term_vector\": \"with_positions_offsets\",\n          \"store\": true\n        }\n      }\n    }\n  }\n}\n\nPUT t/t/1\n{\n  \"foo\": [\n    {\n      \"text\": \"brown\"\n    },\n    {\n      \"text\": \"cow\"\n    }\n  ]\n}\n\nGET t/_search\n{\n  \"query\": {\n    \"nested\": {\n      \"path\": \"foo\",\n      \"query\": {\n        \"match\": {\n          \"foo.text\": \"brown cow\"\n        }\n      }\n    }\n  },\n  \"highlight\": {\n    \"require_field_match\": false,\n    \"fields\": {\n      \"foo_text\": {\n        \"type\": \"fvh\"\n      }\n    }\n  }\n}\n```\n\n</details>\n\nUnfortunately, this doesn't work for some reason.  It works with the `plain` highlighter but not with `fvh`.  This IS a bug and @martijnvg is going to investigate.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/709056712","html_url":"https://github.com/elastic/elasticsearch/issues/19265#issuecomment-709056712","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/19265","id":709056712,"node_id":"MDEyOklzc3VlQ29tbWVudDcwOTA1NjcxMg==","user":{"login":"linwangolo","id":26855452,"node_id":"MDQ6VXNlcjI2ODU1NDUy","avatar_url":"https://avatars3.githubusercontent.com/u/26855452?v=4","gravatar_id":"","url":"https://api.github.com/users/linwangolo","html_url":"https://github.com/linwangolo","followers_url":"https://api.github.com/users/linwangolo/followers","following_url":"https://api.github.com/users/linwangolo/following{/other_user}","gists_url":"https://api.github.com/users/linwangolo/gists{/gist_id}","starred_url":"https://api.github.com/users/linwangolo/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/linwangolo/subscriptions","organizations_url":"https://api.github.com/users/linwangolo/orgs","repos_url":"https://api.github.com/users/linwangolo/repos","events_url":"https://api.github.com/users/linwangolo/events{/privacy}","received_events_url":"https://api.github.com/users/linwangolo/received_events","type":"User","site_admin":false},"created_at":"2020-10-15T09:53:12Z","updated_at":"2020-10-16T01:29:26Z","author_association":"NONE","body":"Hi @martijnvg,\r\n\r\nI know that this issue was solved at #19337, but I still have exactly the same problem as the first comment.\r\nHowever, I put highlight into nested inner_hits, it worked.\r\nDue to the need of multiple query for same nested path, it needs to give different names of inner_hits for each. It's quite inconvenient to extract all highlight results.\r\nI'm wondering if it can use under global highlight. I'm using version 7.6.1.\r\nHope someone can help. Thanks in advance.","performed_via_github_app":null}]