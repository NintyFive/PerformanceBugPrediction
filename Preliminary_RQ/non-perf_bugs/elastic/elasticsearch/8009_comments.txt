[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58167191","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58167191","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58167191,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTY3MTkx","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-10-07T10:53:21Z","updated_at":"2014-10-07T10:53:21Z","author_association":"CONTRIBUTOR","body":"@egueidan Thanks for reporting this issue.\n\n> One important note is that this part of the data is free-form (ie user input) and it is possible that some documents have conflicting types (one document having the field as string, the other as long); that's why the index has the setting index.mapping.ignore_malformed set to true.\n\nThis could indeed be the cause of the issue. Can you please provide us with all the mappings that you have on the `my_index` index?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58185823","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58185823","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58185823,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTg1ODIz","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-07T13:44:20Z","updated_at":"2014-10-07T13:44:20Z","author_association":"NONE","body":"Hi @jpountz,\n\nthanks for looking into this. Sadly I'm not at liberty to share the full mapping here as it contains sensitive data... Here is a dummied down and anonymized version which I hope will help you get going. \n\n```\n{\n  \"my_index\": {\n    \"mappings\": {\n      \"my_type\": {\n        \"dynamic_templates\": [\n          {\n            \"custom_message\": {\n              \"mapping\": {\n                \"include_in_all\": true,\n                \"analyzer\": \"simple\",\n                \"type\": \"string\"\n              },\n              \"path_match\": \"custom.message\"\n            }\n          },\n          {\n            \"subpart_bytes\": {\n              \"mapping\": {\n                \"index\": \"not_analyzed\",\n                \"include_in_all\": false,\n                \"doc_values\": true,\n                \"type\": \"byte\"\n              },\n              \"match_pattern\": \"regex\",\n              \"path_match\": \"subpart\\\\.(fieldbyte1|fieldbyte2)\"\n            }\n          },\n          {\n            \"subpart_short\": {\n              \"mapping\": {\n                \"index\": \"not_analyzed\",\n                \"include_in_all\": false,\n                \"doc_values\": true,\n                \"type\": \"short\"\n              },\n              \"match_pattern\": \"regex\",\n              \"path_match\": \"subpart\\\\.(fieldshort1|fieldshort2)\"\n            }\n          },\n          {\n            \"dyn_fields\": {\n              \"mapping\": {\n                \"index\": \"not_analyzed\",\n                \"include_in_all\": false,\n                \"doc_values\": true,\n                \"type\": \"{dynamic_type}\"\n              },\n              \"match\": \"*\"\n            }\n          }\n        ],\n        \"properties\": {\n          \"custom\": {\n            \"include_in_all\": false,\n            \"properties\": {\n              ... many many fields (hundreds), of all types, all inferred from the dyn_fields template ...\n              \"my_field\": {\n                \"type\": \"long\",\n                \"doc_values\": true,\n                \"include_in_all\": false\n              }\n            }\n          },\n          \"basic\": {\n            \"properties\": {\n              \"date\": {\n                \"type\": \"date\",\n                \"doc_values\": true,\n                \"format\": \"dateOptionalTime\",\n                \"include_in_all\": false\n              }\n            }\n          },\n          \"message\": {\n            \"type\": \"string\",\n            \"analyzer\": \"simple\",\n            \"include_in_all\": true\n          },\n          \"subpart\": {\n            \"include_in_all\": false,\n            \"properties\": {\n              ... a few fields (<10) like 'other' inferred via dyn_field as well ...\n              \"other\": {\n                \"type\": \"string\",\n                \"index\": \"not_analyzed\",\n                \"doc_values\": true,\n                \"include_in_all\": false\n              },\n              ... the subpart_bytes and subpart_short inferred fields ...\n              \"fieldbyte1\": {\n                \"type\": \"byte\",\n                \"doc_values\": true,\n                \"include_in_all\": false\n              },\n              \"fieldshort1\": {\n                \"type\": \"short\",\n                \"doc_values\": true,\n                \"include_in_all\": false\n              },\n              \"fieldbyte2\": {\n                \"type\": \"byte\",\n                \"doc_values\": true,\n                \"include_in_all\": false\n              },\n              \"fieldshort2\": {\n                \"type\": \"short\",\n                \"doc_values\": true,\n                \"include_in_all\": false\n              }\n            }\n          }\n        }\n      }\n    }\n  }\n}\n```\n\nCheers,\nEmmanuel\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58195587","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58195587","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58195587,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTk1NTg3","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-10-07T14:44:11Z","updated_at":"2014-10-07T14:44:11Z","author_association":"CONTRIBUTOR","body":"The thing I was looking for in your mappings is whether you have two types on the same index that have the `custom.my_field` field with doc values, but once as a string and once as a numeric? If it is the case, there is not much that can be done, I have plans to improve the situation in the future by failing mapping updates that introduce incompatible types, but that would only help discover the problem earlier, not solve it. The fix would be to index into several indices instead of several types, or to ensure at a higher level that two different types cannot get incompatible mappings (eg. by prefixing field names by the type name).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58197355","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58197355","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58197355,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MTk3MzU1","user":{"login":"jpountz","id":299848,"node_id":"MDQ6VXNlcjI5OTg0OA==","avatar_url":"https://avatars2.githubusercontent.com/u/299848?v=4","gravatar_id":"","url":"https://api.github.com/users/jpountz","html_url":"https://github.com/jpountz","followers_url":"https://api.github.com/users/jpountz/followers","following_url":"https://api.github.com/users/jpountz/following{/other_user}","gists_url":"https://api.github.com/users/jpountz/gists{/gist_id}","starred_url":"https://api.github.com/users/jpountz/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/jpountz/subscriptions","organizations_url":"https://api.github.com/users/jpountz/orgs","repos_url":"https://api.github.com/users/jpountz/repos","events_url":"https://api.github.com/users/jpountz/events{/privacy}","received_events_url":"https://api.github.com/users/jpountz/received_events","type":"User","site_admin":false},"created_at":"2014-10-07T14:54:29Z","updated_at":"2014-10-07T14:54:29Z","author_association":"CONTRIBUTOR","body":"Another question: do you know on which elasticsearch version the problematic index has been created?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58203749","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58203749","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58203749,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MjAzNzQ5","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-07T15:32:17Z","updated_at":"2014-10-07T15:32:17Z","author_association":"NONE","body":"Concerning your first question, no, we only have one type on those indices.\nConcerning your second question, this happened on indices created with 1.3.2 and indices created with 1.3.4.\nWe have many indices but it only happened on the largest indices (> 10 million docs) with active indexing (40/50k docs/min).\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58310370","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58310370","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58310370,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MzEwMzcw","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2014-10-08T05:07:30Z","updated_at":"2014-10-08T05:07:30Z","author_association":"CONTRIBUTOR","body":"would it be possilbe to get the `segments_N` and `*.si` files from this index / shard? Are you 100% sure you are not running any `1.4.0.Beta1` nodes or you downgraded somehow?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58319712","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58319712","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58319712,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MzE5NzEy","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-08T07:21:04Z","updated_at":"2014-10-08T07:21:04Z","author_association":"NONE","body":"Sorry but the index is gone now but I'll get the files if we run into the issue again. All the nodes are running 1.3.4 (build_hash a70f3ccb52200f8f2c87e9c370c6597448eb3e45) and we haven't started testing 1.4.0.Beta1 (yet!).\nIf my memory serves me correctly the first time it happened was when I upgraded from 1.3.2 to 1.3.4 (ie rolling restart). Then when I added a new machine to the cluster (from 4 to 5). The last time one of our nodes went rogue (cluster was split 4/1 and we restarted the node). That's why I mentioned it only happened after some node (re)start (ie some recovery/relocation happened). Bare in mind we use daily indices and the issue only happened on the current day index - which is the only one receiving index requests. Also we recreate the indices from scratch (reindexing everything) when the issue happens, so this never happened on an index more than a few hours old.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58324764","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58324764","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58324764,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MzI0NzY0","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-08T08:16:53Z","updated_at":"2014-10-08T08:16:53Z","author_association":"NONE","body":"Guys, as I was writing my last comment we had to restart one of our nodes... Immediately after we have started seing this exception again. At the moment, the cluster is green but we have lots of exceptions at indexation:\n\n```\njava.lang.IllegalArgumentException: cannot change DocValues type from SORTED_SET to BINARY for field \"custom.xxxxxxxxxx\"\n  at org.apache.lucene.index.FieldInfos$FieldNumbers.addOrGet(FieldInfos.java:198)\n  at org.apache.lucene.index.FieldInfos$Builder.addOrUpdateInternal(FieldInfos.java:304)\n  at org.apache.lucene.index.FieldInfos$Builder.addOrUpdate(FieldInfos.java:289)\n  at org.apache.lucene.index.DefaultIndexingChain.getOrAddField(DefaultIndexingChain.java:484)\n  at org.apache.lucene.index.DefaultIndexingChain.processField(DefaultIndexingChain.java:373)\n  at org.apache.lucene.index.DefaultIndexingChain.processDocument(DefaultIndexingChain.java:301)\n  at org.apache.lucene.index.DocumentsWriterPerThread.updateDocument(DocumentsWriterPerThread.java:241)\n  at org.apache.lucene.index.DocumentsWriter.updateDocument(DocumentsWriter.java:451)\n  at org.apache.lucene.index.IndexWriter.updateDocument(IndexWriter.java:1539)\n  at org.elasticsearch.index.engine.internal.InternalEngine.innerIndex(InternalEngine.java:572)\n  at org.elasticsearch.index.engine.internal.InternalEngine.index(InternalEngine.java:492)\n  at org.elasticsearch.index.shard.service.InternalIndexShard.index(InternalIndexShard.java:409)\n  at org.elasticsearch.action.bulk.TransportShardBulkAction.shardIndexOperation(TransportShardBulkAction.java:446)\n  at org.elasticsearch.action.bulk.TransportShardBulkAction.shardOperationOnPrimary(TransportShardBulkAction.java:157)\n  at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction.performOnPrimary(TransportShardReplicationOperationAction.java:535)\n  at org.elasticsearch.action.support.replication.TransportShardReplicationOperationAction$AsyncShardOperationAction$1.run(TransportShardReplicationOperationAction.java:434)\n  at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1145)\n  at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:615)\n  at java.lang.Thread.run(Thread.java:745)\n```\n\nThis happens for example on a field which has been discovered as double in the mapping yet we try to index a document with \"Infinity\" as value for that field.\n\nI have the segment\\* and *.si files from the shard/node reporting the exception, but for privacy reasons, I can't attach them on github. What would be the best way to share them privately with you?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58350991","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58350991","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58350991,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MzUwOTkx","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2014-10-08T12:40:59Z","updated_at":"2014-10-08T12:40:59Z","author_association":"CONTRIBUTOR","body":"This is actually a different exception. Your first exception (the original you opened the issue with) happens during IndexWriter creation so there somehow is a conflicting segment on that node and it might  be related to problems that we fixed in `1.3.4` where due to hash collisions on recovery we didn't transfer alll the files needed. \n\nYet, lemme ask a couple of more questions to get closer to the source of the problem. \n- do I understand your correctly that this problem occurred after recovery to the node that was taken out of the cluster and later rejoined?\n- where there nodes with version 1.3.2 in the cluster while this node joined\n- do you still know if you recovered from a node of version 1.3.2 or from a newer node? \n- the node that failed with the first exception did it run 1.3.4 or 1.3.2?\n\nThis second failure is due to the fact that you are trying to index the same field as string while it's a double which obviously doesn't work.  Are you using dynamic mappings for this?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/58380520","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-58380520","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":58380520,"node_id":"MDEyOklzc3VlQ29tbWVudDU4MzgwNTIw","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-08T15:54:17Z","updated_at":"2014-10-08T15:54:17Z","author_association":"NONE","body":"Yes, sorry, it is indeed a different exception. I mentioned it because it never happened before the restart of the machine this morning, although I know for a fact that there were similar messages (with string instead of a double) being inserted. Note that we are using `index.mapping.ignore_malformed: true` and the field mappings are discovered via dynamic templating.\n\nI had a gut feeling it could be related and funny thing is right now the index with those exceptions is yellow with one replica shard perpetually initializing with many exceptions like:\n\n```\n[2014-10-08 15:37:40,085][WARN ][cluster.action.shard     ] [Fafnir] [index_xxxxx][6] received shard failed for [index_xxxxx][6], node[pwGu7LZWQ5e1mHjmiWyeVw], [R], s[INITIALIZING], indexUUID [LZGZL-kKS66nVPU7pFRCtA], reason [Failed to start shard, message [RecoveryFailedException[[index_xxxxx][6]: Recovery failed from [Rocket Racer][PdxQHUbMSY2h7co9Zg0xUw][server-4][inet[/10.0.0.16:9300]] into [Squirrel Girl][pwGu7LZWQ5e1mHjmiWyeVw][server-1][inet[/10.0.0.13:9300]]]; nested: RemoteTransportException[[Rocket Racer][inet[/10.0.0.16:9300]][index/shard/recovery/startRecovery]]; nested: RecoveryEngineException[[index_xxxxx][6] Phase[2] Execution failed]; nested: RemoteTransportException[[Squirrel Girl][inet[/10.0.0.13:9300]][index/shard/recovery/prepareTranslog]]; nested: IllegalArgumentException[cannot change DocValues type from BINARY to SORTED_SET for field \"custom.field_xxx\"]; ]]\n```\n\nTo answer your questions this happens on a fully 1.3.4 cluster. The index was created on 1.3.4. There is no 1.3.2 node involved. To summarize what we see, it goes:\n1. No issue, No exception about doc_values (none at all)\n2. Restart of one machine\n3. Exceptions about doc_values start to come in (the second one I reported that happens at document insert), Cluster back to green\n4. After a few hours at least one shard cannot initialize (index red yesterday, index yellow right now)\n\nLet me know if you need more info.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/59236154","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-59236154","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":59236154,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjM2MTU0","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-10-15T16:41:53Z","updated_at":"2014-10-15T16:41:53Z","author_association":"CONTRIBUTOR","body":"Hi @egueidan \n\nAre the segment files small enough to email? In which case you can send them to: clinton dot gormley at elasticsearch dot com.\n\nthanks for the detailed info\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/59239469","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-59239469","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":59239469,"node_id":"MDEyOklzc3VlQ29tbWVudDU5MjM5NDY5","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-15T17:04:14Z","updated_at":"2014-10-15T17:04:14Z","author_association":"NONE","body":"Hi @clintongormley,\nActually it's tiny. It should be in your inbox. Let me know if it does not go through.\nThanks\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60077098","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60077098","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60077098,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMDc3MDk4","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-22T12:30:25Z","updated_at":"2014-10-22T12:30:25Z","author_association":"NONE","body":"Hi,\n  just to keep you updated, this issue keeps happening. We have just restarted a few servers and looking at the logs I have found this third variant of the exception:\n\n```\n[2014-10-22 12:12:28,525][WARN ][index.merge.scheduler    ] [Defensor] [some_index][1] failed to merge java.lang.IllegalArgumentException: cannot change DocValues type from SORTED_SET to BINARY for field \"custom.durationInMs\"\n       at org.apache.lucene.index.FieldInfos$FieldNumbers.addOrGet(FieldInfos.java:198)\n       at org.apache.lucene.index.FieldInfos$Builder.addOrUpdateInternal(FieldInfos.java:304)\n       at org.apache.lucene.index.FieldInfos$Builder.add(FieldInfos.java:332)\n       at org.apache.lucene.index.SegmentMerger.mergeFieldInfos(SegmentMerger.java:316)\n       at org.apache.lucene.index.SegmentMerger.merge(SegmentMerger.java:94)\n       at org.apache.lucene.index.IndexWriter.mergeMiddle(IndexWriter.java:4225)\n       at org.apache.lucene.index.IndexWriter.merge(IndexWriter.java:3820)\n       at org.apache.lucene.index.ConcurrentMergeScheduler.doMerge(ConcurrentMergeScheduler.java:405)\n       at org.apache.lucene.index.TrackingConcurrentMergeScheduler.doMerge(TrackingConcurrentMergeScheduler.java:106)\n       at org.apache.lucene.index.ConcurrentMergeScheduler$MergeThread.run(ConcurrentMergeScheduler.java:482)\n```\n\nThought it might be relevant.\n\nRegards,\nEmmanuel\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60112508","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60112508","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60112508,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMTEyNTA4","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-10-22T16:22:53Z","updated_at":"2014-10-22T16:22:53Z","author_association":"CONTRIBUTOR","body":"Hi @egueidan \n\n> To answer your questions this happens on a fully 1.3.4 cluster. The index was created on 1.3.4. There is no 1.3.2 node involved.\n\nWhen we look at the segment files that you sent, some of them are from Lucene 4.9 (1.3.2), not Lucene 4.9.1. So 1.3.2 is involved somewhere here - either you have mixed nodes in your cluster, or the index was originally created with 1.3.2.\n\nCan you clarify?\n\nthanks\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60130271","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60130271","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60130271,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMTMwMjcx","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-22T18:18:09Z","updated_at":"2014-10-22T18:18:09Z","author_association":"NONE","body":"Hi @clintongormley,\n  I've checked again all my nodes are running 1.3.4 (build hash a70f3ccb52200f8f2c87e9c370c6597448eb3e45). In the cluster there exists some indices created in 1.3.2. But the issue definitely happens on indices created with 1.3.4. Maybe I mixed up the files, I'm sending you another set (based on other indices).\nThanks\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60143250","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60143250","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60143250,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMTQzMjUw","user":{"login":"s1monw","id":973334,"node_id":"MDQ6VXNlcjk3MzMzNA==","avatar_url":"https://avatars0.githubusercontent.com/u/973334?v=4","gravatar_id":"","url":"https://api.github.com/users/s1monw","html_url":"https://github.com/s1monw","followers_url":"https://api.github.com/users/s1monw/followers","following_url":"https://api.github.com/users/s1monw/following{/other_user}","gists_url":"https://api.github.com/users/s1monw/gists{/gist_id}","starred_url":"https://api.github.com/users/s1monw/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/s1monw/subscriptions","organizations_url":"https://api.github.com/users/s1monw/orgs","repos_url":"https://api.github.com/users/s1monw/repos","events_url":"https://api.github.com/users/s1monw/events{/privacy}","received_events_url":"https://api.github.com/users/s1monw/received_events","type":"User","site_admin":false},"created_at":"2014-10-22T19:43:51Z","updated_at":"2014-10-22T19:43:51Z","author_association":"CONTRIBUTOR","body":"I opened a lucene issue for this https://issues.apache.org/jira/browse/LUCENE-6019\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60201198","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60201198","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60201198,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjAxMTk4","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-23T07:19:08Z","updated_at":"2014-10-23T07:19:08Z","author_association":"NONE","body":"@s1monw Glad you were able to pinpoint the issue and thanks a lot for taking the time. Any idea (even ballpark) of what version/when this will be integrated into elasticsearch? Regards.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60289940","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60289940","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60289940,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjg5OTQw","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-10-23T18:52:06Z","updated_at":"2014-10-23T18:52:06Z","author_association":"CONTRIBUTOR","body":"@egueidan the Lucene issue is fixed, and we're going to spin a new Lucene release with this fix.  This will prevent mis-use of Lucene's APIs from causing index corruption.\n\nBut we will also separately to fix Elasticsearch \"handle\" the same field name across types having different settings (since Elasticsearch currently stores multiple types in one Lucene index), likely by refusing mappings of the same field name across different types with different index settings (such as doc values type).\n\nNet/net, even once we've fixed Elasticsearch/Lucene to not corrupt the index on inconsistent doc values types, you'll still have to fix your usage of Elasticsearch to not allow the same field name across different types to have different mappings settings.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60299205","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60299205","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60299205,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMjk5MjA1","user":{"login":"egueidan","id":1777027,"node_id":"MDQ6VXNlcjE3NzcwMjc=","avatar_url":"https://avatars1.githubusercontent.com/u/1777027?v=4","gravatar_id":"","url":"https://api.github.com/users/egueidan","html_url":"https://github.com/egueidan","followers_url":"https://api.github.com/users/egueidan/followers","following_url":"https://api.github.com/users/egueidan/following{/other_user}","gists_url":"https://api.github.com/users/egueidan/gists{/gist_id}","starred_url":"https://api.github.com/users/egueidan/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/egueidan/subscriptions","organizations_url":"https://api.github.com/users/egueidan/orgs","repos_url":"https://api.github.com/users/egueidan/repos","events_url":"https://api.github.com/users/egueidan/events{/privacy}","received_events_url":"https://api.github.com/users/egueidan/received_events","type":"User","site_admin":false},"created_at":"2014-10-23T19:57:25Z","updated_at":"2014-10-23T19:57:25Z","author_association":"NONE","body":"Hi @mikemccand and thanks for the quick fix.\nTo be honest I'm a bit puzzled as we only have one type across all of our indices... Does this mean there might be more to the problem we are experiencing? Just to be more precise, we are in a situation where we index \"user\" data  into elasticsearch (ie we don't have full control over its content). We have dynamic templates so that the fields have doc_values enabled. Sometimes the data will be inconsistent (user submits conflicting field types). In case we receive a string after receiving a number for the same field, we have enabled `index.mapping.ignore_malformed`. When it's a string instead of an object or vice-versa then we get a mapper exception and deal with it. Anything wrong with that scenario?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/60311006","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-60311006","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":60311006,"node_id":"MDEyOklzc3VlQ29tbWVudDYwMzExMDA2","user":{"login":"mikemccand","id":796508,"node_id":"MDQ6VXNlcjc5NjUwOA==","avatar_url":"https://avatars0.githubusercontent.com/u/796508?v=4","gravatar_id":"","url":"https://api.github.com/users/mikemccand","html_url":"https://github.com/mikemccand","followers_url":"https://api.github.com/users/mikemccand/followers","following_url":"https://api.github.com/users/mikemccand/following{/other_user}","gists_url":"https://api.github.com/users/mikemccand/gists{/gist_id}","starred_url":"https://api.github.com/users/mikemccand/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/mikemccand/subscriptions","organizations_url":"https://api.github.com/users/mikemccand/orgs","repos_url":"https://api.github.com/users/mikemccand/repos","events_url":"https://api.github.com/users/mikemccand/events{/privacy}","received_events_url":"https://api.github.com/users/mikemccand/received_events","type":"User","site_admin":false},"created_at":"2014-10-23T21:18:45Z","updated_at":"2014-10-23T21:18:45Z","author_association":"CONTRIBUTOR","body":"Hi @egueidan I don't fully understand what {{index.mapping.ignore_malformed}} should do; maybe someone else can chime in here.  It sounds like a spooky setting: it seems dangerous to ignore serious errors like a type change.\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/68453887","html_url":"https://github.com/elastic/elasticsearch/issues/8009#issuecomment-68453887","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/8009","id":68453887,"node_id":"MDEyOklzc3VlQ29tbWVudDY4NDUzODg3","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-12-31T16:54:39Z","updated_at":"2014-12-31T16:54:39Z","author_association":"CONTRIBUTOR","body":"Closing this in favour of #8688\n","performed_via_github_app":null}]