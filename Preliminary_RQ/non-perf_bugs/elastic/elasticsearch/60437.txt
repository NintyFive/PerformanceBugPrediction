{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/60437","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60437/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60437/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/60437/events","html_url":"https://github.com/elastic/elasticsearch/issues/60437","id":668393946,"node_id":"MDU6SXNzdWU2NjgzOTM5NDY=","number":60437,"title":"Bug in bulk requests with mix of requests with and without pipelines","user":{"login":"sihtam23","id":64247940,"node_id":"MDQ6VXNlcjY0MjQ3OTQw","avatar_url":"https://avatars3.githubusercontent.com/u/64247940?v=4","gravatar_id":"","url":"https://api.github.com/users/sihtam23","html_url":"https://github.com/sihtam23","followers_url":"https://api.github.com/users/sihtam23/followers","following_url":"https://api.github.com/users/sihtam23/following{/other_user}","gists_url":"https://api.github.com/users/sihtam23/gists{/gist_id}","starred_url":"https://api.github.com/users/sihtam23/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/sihtam23/subscriptions","organizations_url":"https://api.github.com/users/sihtam23/orgs","repos_url":"https://api.github.com/users/sihtam23/repos","events_url":"https://api.github.com/users/sihtam23/events{/privacy}","received_events_url":"https://api.github.com/users/sihtam23/received_events","type":"User","site_admin":false},"labels":[{"id":268963484,"node_id":"MDU6TGFiZWwyNjg5NjM0ODQ=","url":"https://api.github.com/repos/elastic/elasticsearch/labels/:Core/Features/Ingest","name":":Core/Features/Ingest","color":"0e8a16","default":false,"description":"Execution or management of Ingest Pipelines"},{"id":23173,"node_id":"MDU6TGFiZWwyMzE3Mw==","url":"https://api.github.com/repos/elastic/elasticsearch/labels/%3Ebug","name":">bug","color":"b60205","default":false,"description":null},{"id":1967496097,"node_id":"MDU6TGFiZWwxOTY3NDk2MDk3","url":"https://api.github.com/repos/elastic/elasticsearch/labels/Team:Core/Features","name":"Team:Core/Features","color":"fef2c0","default":false,"description":"Meta label for core/features team"}],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":2,"created_at":"2020-07-30T05:51:57Z","updated_at":"2020-08-19T11:54:59Z","closed_at":"2020-08-19T11:54:59Z","author_association":"NONE","active_lock_reason":null,"body":"Elasticsearch version: 7.8\r\nPlugins: N/A\r\nOS: Red Hat 8\r\n\r\nPosted on discussion forums: https://discuss.elastic.co/t/bug-in-bulk-requests-with-mix-of-requests-with-and-without-pipelines/242973\r\n\r\nThis bug exists in Elasticsearch 7.8. I know it doesn't exist in 6.8 but I haven't looked at all the in-between versions.\r\n\r\nIf I put together a bulk request with a mix of indexing requests with some that call an ingest pipeline and some that don't then there exists a problem if either the pipeline fails or the pipeline contains a drop processor. The handling of the request plays around with the wrong \"slot\" number in the bulk request / response as it counts only requests with pipelines to figure out that \"slot\" for the callback in the \"executeBulkRequest\" method of \"IngestService\". This results in the wrong items being marked as failed or dropped. I haven't played with failures so much so that needs verifying but here are some steps to reproduce for the drop processor.\r\n\r\n```\r\n curl -s -XPUT -H Content-type:application/json localhost:9200/_ingest/pipeline/mypipeline -d '{ \"processors\": [ { \"drop\": { } } ] }'\r\n```\r\n\r\nMy bulk request...\r\n```\r\n{\"index\":{\"_index\":\"myindex\",\"_type\":\"_doc\",\"_id\":\"1\"}}\r\n{\"test\":\"1\"}\r\n{\"index\":{\"_index\":\"myindex\",\"_type\":\"_doc\",\"_id\":\"2\",\"pipeline\":\"mypipeline\"}}\r\n{\"test\":\"2\"}\r\n```\r\n```\r\ncurl -s -XPOST -H Content-type:application/json localhost:9200/_bulk --data-binary @bulk_request\r\n```\r\n\r\nThe response...\r\n\r\n```\r\n{\r\n  \"took\": 242,\r\n  \"ingest_took\": 11,\r\n  \"errors\": false,\r\n  \"items\": [\r\n    {\r\n      \"index\": {\r\n        \"_index\": \"myindex\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"1\",\r\n        \"_version\": -3,\r\n        \"result\": \"noop\",\r\n        \"_shards\": {\r\n          \"total\": 0,\r\n          \"successful\": 0,\r\n          \"failed\": 0\r\n        },\r\n        \"status\": 200\r\n      }\r\n    },\r\n    {\r\n      \"index\": {\r\n        \"_index\": \"myindex\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"2\",\r\n        \"_version\": 1,\r\n        \"result\": \"created\",\r\n        \"_shards\": {\r\n          \"total\": 2,\r\n          \"successful\": 1,\r\n          \"failed\": 0\r\n        },\r\n        \"_seq_no\": 0,\r\n        \"_primary_term\": 1,\r\n        \"status\": 201\r\n      }\r\n    }\r\n  ]\r\n}\r\n```\r\n\r\nAnd if you search the index it contains the wrong document...\r\n\r\n```\r\n{\r\n  \"took\": 55,\r\n  \"timed_out\": false,\r\n  \"_shards\": {\r\n    \"total\": 1,\r\n    \"successful\": 1,\r\n    \"skipped\": 0,\r\n    \"failed\": 0\r\n  },\r\n  \"hits\": {\r\n    \"total\": {\r\n      \"value\": 1,\r\n      \"relation\": \"eq\"\r\n    },\r\n    \"max_score\": 1,\r\n    \"hits\": [\r\n      {\r\n        \"_index\": \"myindex\",\r\n        \"_type\": \"_doc\",\r\n        \"_id\": \"2\",\r\n        \"_score\": 1,\r\n        \"_source\": {\r\n          \"test\": \"2\"\r\n        }\r\n      }\r\n    ]\r\n  }\r\n}\r\n```\r\n\r\nI believe the fix should be relatively simple in IngestService but maybe I'm missing something.","closed_by":{"login":"danhermann","id":22777892,"node_id":"MDQ6VXNlcjIyNzc3ODky","avatar_url":"https://avatars0.githubusercontent.com/u/22777892?v=4","gravatar_id":"","url":"https://api.github.com/users/danhermann","html_url":"https://github.com/danhermann","followers_url":"https://api.github.com/users/danhermann/followers","following_url":"https://api.github.com/users/danhermann/following{/other_user}","gists_url":"https://api.github.com/users/danhermann/gists{/gist_id}","starred_url":"https://api.github.com/users/danhermann/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/danhermann/subscriptions","organizations_url":"https://api.github.com/users/danhermann/orgs","repos_url":"https://api.github.com/users/danhermann/repos","events_url":"https://api.github.com/users/danhermann/events{/privacy}","received_events_url":"https://api.github.com/users/danhermann/received_events","type":"User","site_admin":false},"performed_via_github_app":null}