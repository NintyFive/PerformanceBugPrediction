{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/7820","repository_url":"https://api.github.com/repos/elastic/elasticsearch","labels_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7820/labels{/name}","comments_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7820/comments","events_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7820/events","html_url":"https://github.com/elastic/elasticsearch/issues/7820","id":43500149,"node_id":"MDU6SXNzdWU0MzUwMDE0OQ==","number":7820,"title":"Extra copy of index kept after upgrade","user":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"labels":[],"state":"closed","locked":false,"assignee":null,"assignees":[],"milestone":null,"comments":11,"created_at":"2014-09-22T15:14:55Z","updated_at":"2014-09-29T11:58:34Z","closed_at":"2014-09-29T11:34:46Z","author_association":"CONTRIBUTOR","active_lock_reason":null,"body":"I upgraded 4-node cluster from 1.0.1 to 1.3.2 today and added fifth node. All without disabling allocation, if that matters. After getting fifth node in sync (1.1Tb of data on disk) other nodes did not remove extra copies of data.\n\nOld nodes now keep 1.4Tb of data and new node keeps 1.1Tb.\n\nThis is how cluster looks like:\n\n```\n# curl -s http://web245:9200/_cat/nodes?v\nhost   ip            heap.percent ram.percent load node.role master name\nweb190 192.168.0.190           61          83 0.00 d         m      statistics01\nweb592 192.168.2.82            71          83 0.32 d         *      statistics02\nweb245 192.168.0.245           67          81 0.09 d         m      statistics03\nweb599 192.168.2.88            72          71 0.03 d         m      statistics05\nweb467 192.168.1.212           34          34 0.87 d         m      statistics04\n```\n\nThis is how one of problematic indices looks like:\n\n```\nweb245 ~ # curl -s http://web245:9200/_cat/indices/statistics-20131224?v\nhealth index               pri rep docs.count docs.deleted store.size pri.store.size\ngreen  statistics-20131224   1   1   65936782            0     14.3gb          7.1gb\n```\n\n```\n# curl -s http://web245:9200/_cat/segments/statistics-20131224?v\nindex               shard prirep ip            segment generation docs.count docs.deleted     size size.memory committed searchable version compound\nstatistics-20131224 0     r      192.168.2.88  _8z9         11637   11929743            0    1.3gb     3927560 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _12cy        49714   28962258            0    3.1gb     7287984 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _156s        53380    2341127            0  260.1mb      505544 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1988        58616    1968309            0  214.1mb      431872 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1c0q        62234    5057415            0  568.2mb     1087232 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1fph        67013    1524853            0  167.7mb      347360 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1j25        71357    4084535            0  453.1mb      822248 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1orl        78753    5784492            0  642.4mb     1426992 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1rnd        82489     671899            0   75.7mb      189648 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1tjx        84957      79005            0    8.7mb       45848 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1u29        85617      40704            0    4.8mb       40296 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1u48        85688      55771            0    6.4mb       42128 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1u9i        85878      51862            0    6.2mb       41776 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ub6        85938      35209            0    4.2mb       36264 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ubz        85967      23939            0    2.8mb       33016 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1uc8        85976    3248493            0  367.3mb      666376 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ud3        86007       6324            0  761.4kb       24264 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1udp        86029       9761            0      1mb       23760 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ue3        86043       7035            0  768.3kb       22848 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1uea        86050       8030            0  930.9kb       23472 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ueh        86057       8993            0 1021.1kb       23128 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1uex        86073       6096            0  693.1kb       21704 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1uf5        86081       7484            0    815kb       21888 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ufd        86089      10304            0    1.1mb       25840 true      true       4.4     false\nstatistics-20131224 0     r      192.168.2.88  _1ufi        86094      13141            0    1.5mb       27400 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _8z9         11637   11929743            0    1.3gb     3927560 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _12cy        49714   28962258            0    3.1gb     7287984 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _156s        53380    2341127            0  260.1mb      505544 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1988        58616    1968309            0  214.1mb      431872 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1c0q        62234    5057415            0  568.2mb     1087232 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1fph        67013    1524853            0  167.7mb      347360 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1j25        71357    4084535            0  453.1mb      822248 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1orl        78753    5784492            0  642.4mb     1426992 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1rnd        82489     671899            0   75.7mb      189648 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1tjx        84957      79005            0    8.7mb       45848 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1u29        85617      40704            0    4.8mb       40296 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1u48        85688      55771            0    6.4mb       42128 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1u9i        85878      51862            0    6.2mb       41776 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ub6        85938      35209            0    4.2mb       36264 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ubz        85967      23939            0    2.8mb       33016 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1uc8        85976    3248493            0  367.3mb      666376 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ud3        86007       6324            0  761.4kb       24264 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1udp        86029       9761            0      1mb       23760 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ue3        86043       7035            0  768.3kb       22848 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1uea        86050       8030            0  930.9kb       23472 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ueh        86057       8993            0 1021.1kb       23128 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1uex        86073       6096            0  693.1kb       21704 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1uf5        86081       7484            0    815kb       21888 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ufd        86089      10304            0    1.1mb       25840 true      true       4.4     false\nstatistics-20131224 0     p      192.168.0.245 _1ufi        86094      13141            0    1.5mb       27400 true      true       4.4     false\n```\n\nNotice that only `web245` and `web599` should have copies of this index.\n\nAnd this is how it looks on filesystem:\n\n```\n# for i in web190 web245 web467 web592 web599; do echo $i $(ssh root@$i -- du -ms /var/lib/elasticsearch/statistics/nodes/*/indices/statistics-20131224 2>/dev/null); done\nweb190 1 /var/lib/elasticsearch/statistics/nodes/0/indices/statistics-20131224\nweb245 7370 /var/lib/elasticsearch/statistics/nodes/0/indices/statistics-20131224\nweb467 7370 /var/lib/elasticsearch/statistics/nodes/0/indices/statistics-20131224\nweb592 1 /var/lib/elasticsearch/statistics/nodes/0/indices/statistics-20131224\nweb599 7370 /var/lib/elasticsearch/statistics/nodes/0/indices/statistics-20131224\n```\n\nExtra copy is on web467.\n\nI restarted the node that kept extra copy of index, waited for green cluster and finished relocations, but that didn't help, extra copies are still there.\n\n```\n# curl http://web245:9200/_cat/health?v\nepoch      timestamp cluster    status node.total node.data shards  pri relo init unassign\n1411398730 19:12:10  statistics green           5         5   3090 1545    0    0        0\n```\n\nHow can this be resolved? Is this a bug or some weird intended behavior?\n","closed_by":{"login":"bobrik","id":89186,"node_id":"MDQ6VXNlcjg5MTg2","avatar_url":"https://avatars0.githubusercontent.com/u/89186?v=4","gravatar_id":"","url":"https://api.github.com/users/bobrik","html_url":"https://github.com/bobrik","followers_url":"https://api.github.com/users/bobrik/followers","following_url":"https://api.github.com/users/bobrik/following{/other_user}","gists_url":"https://api.github.com/users/bobrik/gists{/gist_id}","starred_url":"https://api.github.com/users/bobrik/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/bobrik/subscriptions","organizations_url":"https://api.github.com/users/bobrik/orgs","repos_url":"https://api.github.com/users/bobrik/repos","events_url":"https://api.github.com/users/bobrik/events{/privacy}","received_events_url":"https://api.github.com/users/bobrik/received_events","type":"User","site_admin":false},"performed_via_github_app":null}