[{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/55083171","html_url":"https://github.com/elastic/elasticsearch/issues/7487#issuecomment-55083171","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7487","id":55083171,"node_id":"MDEyOklzc3VlQ29tbWVudDU1MDgzMTcx","user":{"login":"colings86","id":236731,"node_id":"MDQ6VXNlcjIzNjczMQ==","avatar_url":"https://avatars0.githubusercontent.com/u/236731?v=4","gravatar_id":"","url":"https://api.github.com/users/colings86","html_url":"https://github.com/colings86","followers_url":"https://api.github.com/users/colings86/followers","following_url":"https://api.github.com/users/colings86/following{/other_user}","gists_url":"https://api.github.com/users/colings86/gists{/gist_id}","starred_url":"https://api.github.com/users/colings86/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/colings86/subscriptions","organizations_url":"https://api.github.com/users/colings86/orgs","repos_url":"https://api.github.com/users/colings86/repos","events_url":"https://api.github.com/users/colings86/events{/privacy}","received_events_url":"https://api.github.com/users/colings86/received_events","type":"User","site_admin":false},"created_at":"2014-09-10T08:03:28Z","updated_at":"2014-09-10T08:03:28Z","author_association":"MEMBER","body":"So this is caused by the following: \n\nThe aggregation framework registers the agg script as scorer aware. When setScorer is called it eventually delegates down to DocLookup.setScorer(). DocLookup is global though so the agg script overwrites the original scorer (the one that the score script needs to use) and replaces it with the Score script. So now when the score script evaluates _score instead of using the original scorer it tries to use itself causing a recursive loop.\n\nThe solution should be to replace the global DocLookup with a DocLookup for each context (e.g. one for aggs, one for query_score, etc.)\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/56210595","html_url":"https://github.com/elastic/elasticsearch/issues/7487#issuecomment-56210595","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7487","id":56210595,"node_id":"MDEyOklzc3VlQ29tbWVudDU2MjEwNTk1","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2014-09-19T17:47:25Z","updated_at":"2014-09-19T17:47:25Z","author_association":"CONTRIBUTOR","body":"> The solution should be to replace the global DocLookup with a DocLookup for each context (e.g. one for aggs, one for query_score, etc.)\n\nI believe it might be sufficient to just remove the dependence of DocLookup and scorer. The scorer should be set for each script explicitly instead of having the script score set the scorer in DocLookup which is then in turn looked up by the script when it is executed. \nHere is what I mean: https://github.com/brwe/elasticsearch/commit/5e142fe0459d03a013d77554aa4c4a27090125d9\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/56812432","html_url":"https://github.com/elastic/elasticsearch/issues/7487#issuecomment-56812432","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7487","id":56812432,"node_id":"MDEyOklzc3VlQ29tbWVudDU2ODEyNDMy","user":{"login":"clintongormley","id":56599,"node_id":"MDQ6VXNlcjU2NTk5","avatar_url":"https://avatars0.githubusercontent.com/u/56599?v=4","gravatar_id":"","url":"https://api.github.com/users/clintongormley","html_url":"https://github.com/clintongormley","followers_url":"https://api.github.com/users/clintongormley/followers","following_url":"https://api.github.com/users/clintongormley/following{/other_user}","gists_url":"https://api.github.com/users/clintongormley/gists{/gist_id}","starred_url":"https://api.github.com/users/clintongormley/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/clintongormley/subscriptions","organizations_url":"https://api.github.com/users/clintongormley/orgs","repos_url":"https://api.github.com/users/clintongormley/repos","events_url":"https://api.github.com/users/clintongormley/events{/privacy}","received_events_url":"https://api.github.com/users/clintongormley/received_events","type":"User","site_admin":false},"created_at":"2014-09-25T12:40:00Z","updated_at":"2014-09-25T12:40:00Z","author_association":"CONTRIBUTOR","body":"@brwe @markharwood any progress on this one?\n","performed_via_github_app":null},{"url":"https://api.github.com/repos/elastic/elasticsearch/issues/comments/56813535","html_url":"https://github.com/elastic/elasticsearch/issues/7487#issuecomment-56813535","issue_url":"https://api.github.com/repos/elastic/elasticsearch/issues/7487","id":56813535,"node_id":"MDEyOklzc3VlQ29tbWVudDU2ODEzNTM1","user":{"login":"brwe","id":4320215,"node_id":"MDQ6VXNlcjQzMjAyMTU=","avatar_url":"https://avatars0.githubusercontent.com/u/4320215?v=4","gravatar_id":"","url":"https://api.github.com/users/brwe","html_url":"https://github.com/brwe","followers_url":"https://api.github.com/users/brwe/followers","following_url":"https://api.github.com/users/brwe/following{/other_user}","gists_url":"https://api.github.com/users/brwe/gists{/gist_id}","starred_url":"https://api.github.com/users/brwe/starred{/owner}{/repo}","subscriptions_url":"https://api.github.com/users/brwe/subscriptions","organizations_url":"https://api.github.com/users/brwe/orgs","repos_url":"https://api.github.com/users/brwe/repos","events_url":"https://api.github.com/users/brwe/events{/privacy}","received_events_url":"https://api.github.com/users/brwe/received_events","type":"User","site_admin":false},"created_at":"2014-09-25T12:49:54Z","updated_at":"2014-09-25T12:49:54Z","author_association":"CONTRIBUTOR","body":"@clintongormley See my PR above, needs a reviewer\n","performed_via_github_app":null}]